<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI統合システムテスト - 完全版</title>
    <style>
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            margin: 15px 0;
            border-radius: 10px;
            border-left: 5px solid #4CAF50;
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 200px;
        }
        .btn-primary { background: #2196F3; color: white; }
        .btn-success { background: #4CAF50; color: white; }
        .btn-warning { background: #FF9800; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-info { background: #00BCD4; color: white; }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        .log {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            border-left: 4px solid #2196F3;
        }
        .success { color: #4CAF50; font-weight: bold; }
        .warning { color: #FF9800; font-weight: bold; }
        .error { color: #f44336; font-weight: bold; }
        .info { color: #00BCD4; }
        
        .status-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .status-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .status-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #2196F3);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 HAQEI統合システムテスト</h1>
            <p>SimpleStorageManager + DataFlowMonitor + SimpleHooks 完全統合テスト</p>
        </div>

        <div class="test-section">
            <h2>📦 1. システム初期化テスト</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="initializeAllSystems()">全システム初期化</button>
                <button class="btn-info" onclick="checkSystemStatus()">システム状態確認</button>
                <button class="btn-warning" onclick="clearAllData()">全データクリア</button>
            </div>
        </div>

        <div class="test-section">
            <h2>💾 2. データ操作テスト</h2>
            <div class="button-group">
                <button class="btn-success" onclick="testDataSaveLoad()">保存・読み込みテスト</button>
                <button class="btn-success" onclick="testTripleOSData()">Triple OSデータテスト</button>
                <button class="btn-warning" onclick="simulateDataCorruption()">データ破損シミュレート</button>
                <button class="btn-info" onclick="testDataRecovery()">自動復旧テスト</button>
            </div>
        </div>

        <div class="test-section">
            <h2>🔍 3. 監視・Hooksテスト</h2>
            <div class="button-group">
                <button class="btn-primary" onclick="startMonitoring()">監視システム開始</button>
                <button class="btn-danger" onclick="stopMonitoring()">監視システム停止</button>
                <button class="btn-info" onclick="testHooksSystem()">Hooksシステムテスト</button>
                <button class="btn-warning" onclick="triggerPerformanceTest()">パフォーマンステスト</button>
            </div>
        </div>

        <div class="test-section">
            <h2>🧪 4. E2E統合テスト</h2>
            <div class="button-group">
                <button class="btn-success" onclick="runFullIntegrationTest()">完全統合テスト</button>
                <button class="btn-info" onclick="generateTestReport()">テストレポート生成</button>
                <button class="btn-primary" onclick="simulateUserFlow()">ユーザーフローシミュレート</button>
            </div>
        </div>

        <div class="status-panel">
            <div class="status-card">
                <h3>システム状態</h3>
                <div class="status-value" id="system-status">🟡 初期化中</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="system-progress" style="width: 0%"></div>
                </div>
            </div>
            <div class="status-card">
                <h3>データ操作</h3>
                <div class="status-value" id="data-operations">0</div>
                <p>実行された操作数</p>
            </div>
            <div class="status-card">
                <h3>エラー検出</h3>
                <div class="status-value" id="errors-detected">0</div>
                <p>検出・修復されたエラー数</p>
            </div>
            <div class="status-card">
                <h3>監視時間</h3>
                <div class="status-value" id="monitoring-time">0秒</div>
                <p>アクティブ監視時間</p>
            </div>
        </div>

        <div id="output" class="log"></div>
    </div>

    <!-- 必要なライブラリの読み込み -->
    <script src="./js/shared/core/SimpleStorageManager.js"></script>
    <script src="./js/shared/utils/DataFlowMonitor.js"></script>
    <script src="./js/shared/utils/SimpleHooks.js"></script>
    
    <script>
        // グローバル変数
        let simpleStorage = null;
        let dataMonitor = null;
        let hooksSystem = null;
        let testStartTime = Date.now();
        let statistics = {
            dataOperations: 0,
            errorsDetected: 0,
            testsRun: 0,
            successRate: 0
        };

        // ログ出力関数
        function log(message, type = 'info') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            
            div.className = `log-entry ${type}`;
            div.innerHTML = `<span style="opacity: 0.7">[${timestamp}]</span> ${message}`;
            
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            
            // 統計更新
            updateStatistics();
        }

        // 統計情報更新
        function updateStatistics() {
            document.getElementById('data-operations').textContent = statistics.dataOperations;
            document.getElementById('errors-detected').textContent = statistics.errorsDetected;
            
            const monitoringTime = Math.floor((Date.now() - testStartTime) / 1000);
            document.getElementById('monitoring-time').textContent = `${monitoringTime}秒`;
        }

        // システム初期化
        async function initializeAllSystems() {
            log('🚀 統合システム初期化開始...', 'info');
            
            try {
                // SimpleStorageManager初期化
                simpleStorage = new SimpleStorageManager();
                log('✅ SimpleStorageManager初期化完了', 'success');

                // DataFlowMonitor初期化
                dataMonitor = new DataFlowMonitor({
                    monitorInterval: 1000,
                    enableAutoFix: true,
                    enableConsoleLog: false // ページ内ログを使用
                });
                log('✅ DataFlowMonitor初期化完了', 'success');

                // SimpleHooks初期化
                hooksSystem = new SimpleHooks({
                    enableDataFlowHooks: true,
                    enablePerformanceHooks: true,
                    enableErrorHooks: true,
                    enableAutoRecovery: true,
                    logLevel: 'info'
                });
                
                // 標準フックの設定
                hooksSystem.setupStandardHooks();
                log('✅ SimpleHooks初期化・標準フック設定完了', 'success');

                // システム状態更新
                document.getElementById('system-status').textContent = '🟢 正常稼働';
                document.getElementById('system-progress').style.width = '100%';

                log('🎉 全システム初期化完了！', 'success');
                
            } catch (error) {
                log(`❌ システム初期化エラー: ${error.message}`, 'error');
                document.getElementById('system-status').textContent = '🔴 エラー';
                statistics.errorsDetected++;
            }
        }

        // システム状態確認
        function checkSystemStatus() {
            log('🔍 システム状態確認中...', 'info');
            
            const status = {
                simpleStorage: !!simpleStorage,
                dataMonitor: !!dataMonitor,
                hooksSystem: !!hooksSystem,
                localStorage: typeof(Storage) !== 'undefined'
            };

            log(`📊 システム状態:`, 'info');
            Object.entries(status).forEach(([key, value]) => {
                log(`  - ${key}: ${value ? '✅ OK' : '❌ NG'}`, value ? 'success' : 'error');
            });

            if (hooksSystem) {
                const hookStats = hooksSystem.getStatistics();
                log(`📈 Hooks統計: 実行${hookStats.hookExecutions}回, エラー${hookStats.errorsHandled}回`, 'info');
            }

            if (dataMonitor && dataMonitor.lastSnapshot) {
                const snapshot = dataMonitor.lastSnapshot;
                log(`📋 データ監視: キー${Object.keys(snapshot.keys).length}個, サイズ${snapshot.totalSize}バイト`, 'info');
            }
        }

        // データ保存・読み込みテスト
        async function testDataSaveLoad() {
            if (!simpleStorage) {
                log('❌ SimpleStorageManagerが初期化されていません', 'error');
                return;
            }

            log('💾 データ保存・読み込みテスト開始...', 'info');

            const testData = {
                engineOS: {
                    name: "価値観システム",
                    hexagram: { id: 1, name: "乾", symbol: "☰" },
                    score: 85,
                    confidence: 0.92
                },
                interfaceOS: {
                    name: "社会的システム",
                    hexagram: { id: 14, name: "大有", symbol: "☲" },
                    score: 72,
                    confidence: 0.88
                },
                safeModeOS: {
                    name: "防御システム",
                    hexagram: { id: 23, name: "剥", symbol: "☶" },
                    score: 68,
                    confidence: 0.85
                },
                timestamp: Date.now(),
                testFlag: true
            };

            try {
                // 保存テスト
                const saveResult = simpleStorage.saveAnalysisResult(testData);
                statistics.dataOperations++;
                
                if (saveResult) {
                    log('✅ データ保存成功', 'success');
                } else {
                    log('❌ データ保存失敗', 'error');
                    statistics.errorsDetected++;
                    return;
                }

                // 読み込みテスト
                const loadedData = simpleStorage.getAnalysisResult();
                statistics.dataOperations++;

                if (loadedData && loadedData.testFlag) {
                    log('✅ データ読み込み成功', 'success');
                    log(`📊 読み込みデータ: engineOS="${loadedData.engineOS?.name}", interfaceOS="${loadedData.interfaceOS?.name}", safeModeOS="${loadedData.safeModeOS?.name}"`, 'info');
                } else {
                    log('❌ データ読み込み失敗または不完全', 'error');
                    statistics.errorsDetected++;
                }

                // Triple OS構造検証
                if (loadedData && loadedData.engineOS && loadedData.interfaceOS && loadedData.safeModeOS) {
                    log('✅ Triple OS構造確認OK', 'success');
                } else {
                    log('⚠️ Triple OS構造不完全', 'warning');
                }

            } catch (error) {
                log(`❌ データテストエラー: ${error.message}`, 'error');
                statistics.errorsDetected++;
            }
        }

        // Triple OSデータ特化テスト
        async function testTripleOSData() {
            log('🧠 Triple OSデータ特化テスト開始...', 'info');

            const tripleOSTestCases = [
                {
                    name: "完全なTriple OSデータ",
                    data: {
                        engineOS: { name: "Engine", score: 90 },
                        interfaceOS: { name: "Interface", score: 80 },
                        safeModeOS: { name: "SafeMode", score: 70 }
                    }
                },
                {
                    name: "不完全なデータ（SafeModeOS欠如）",
                    data: {
                        engineOS: { name: "Engine", score: 90 },
                        interfaceOS: { name: "Interface", score: 80 }
                    }
                },
                {
                    name: "空のデータ",
                    data: {}
                }
            ];

            for (const testCase of tripleOSTestCases) {
                log(`🧪 テストケース: ${testCase.name}`, 'info');
                
                const saveResult = simpleStorage.saveAnalysisResult(testCase.data);
                const loadResult = simpleStorage.getAnalysisResult();
                
                const isValidTripleOS = loadResult && 
                    loadResult.engineOS && 
                    loadResult.interfaceOS && 
                    loadResult.safeModeOS;

                if (isValidTripleOS) {
                    log(`✅ ${testCase.name}: Triple OS構造正常`, 'success');
                } else {
                    log(`⚠️ ${testCase.name}: Triple OS構造異常（期待通り）`, 'warning');
                }

                statistics.dataOperations += 2;
            }
        }

        // 監視システム開始
        function startMonitoring() {
            if (!dataMonitor) {
                log('❌ DataFlowMonitorが初期化されていません', 'error');
                return;
            }

            log('🔍 データフロー監視開始...', 'info');
            
            const result = dataMonitor.startMonitoring();
            if (result) {
                log('✅ 監視システム開始成功', 'success');
                
                // 定期的な監視状態更新
                setInterval(() => {
                    if (dataMonitor.isMonitoring) {
                        const snapshot = dataMonitor.takeSnapshot();
                        log(`📊 監視中: ${Object.keys(snapshot.keys).length}キー, ${snapshot.totalSize}バイト`, 'info');
                    }
                }, 5000);
            } else {
                log('❌ 監視システム開始失敗', 'error');
                statistics.errorsDetected++;
            }
        }

        // 監視システム停止
        function stopMonitoring() {
            if (!dataMonitor || !dataMonitor.isMonitoring) {
                log('⚠️ 監視システムは稼働していません', 'warning');
                return;
            }

            log('🛑 データフロー監視停止...', 'info');
            dataMonitor.stopMonitoring();
            log('✅ 監視システム停止完了', 'success');
        }

        // Hooksシステムテスト
        async function testHooksSystem() {
            if (!hooksSystem) {
                log('❌ SimpleHooksが初期化されていません', 'error');
                return;
            }

            log('🔗 Hooksシステムテスト開始...', 'info');

            // テスト用フックの追加
            hooksSystem.addHook('beforeDataSave', async (context) => {
                log(`🔗 フック実行: データ保存前 (${context.method})`, 'info');
                return { hookExecuted: true };
            }, 50);

            hooksSystem.addHook('afterDataSave', async (context) => {
                log(`🔗 フック実行: データ保存後 (結果: ${context.result})`, 'info');
                return { hookExecuted: true };
            }, 50);

            // StorageManagerにフックを適用
            const instrumentedStorage = hooksSystem.instrumentStorageManager(simpleStorage);

            // フック付きでデータ操作
            const testData = {
                engineOS: { name: "Hooks Test Engine", score: 95 },
                interfaceOS: { name: "Hooks Test Interface", score: 85 },
                safeModeOS: { name: "Hooks Test SafeMode", score: 75 },
                hooksTest: true
            };

            try {
                await instrumentedStorage.saveAnalysisResult(testData);
                const result = await instrumentedStorage.getAnalysisResult();
                
                if (result && result.hooksTest) {
                    log('✅ Hooksシステムテスト成功', 'success');
                } else {
                    log('❌ Hooksシステムテスト失敗', 'error');
                    statistics.errorsDetected++;
                }

                // 統計確認
                const hookStats = hooksSystem.getStatistics();
                log(`📈 Hooks統計: 実行${hookStats.hookExecutions}回, エラー率${hookStats.errorRate}%`, 'info');

            } catch (error) {
                log(`❌ Hooksテストエラー: ${error.message}`, 'error');
                statistics.errorsDetected++;
            }
        }

        // データ破損シミュレート
        function simulateDataCorruption() {
            log('💥 データ破損シミュレート実行...', 'warning');

            // 不正なJSONデータを直接localStorage注入
            localStorage.setItem('haqei_analysis_result', '{"invalid": json data}');
            localStorage.setItem('haqei_emergency_result', 'completely broken data');

            log('💥 不正データ注入完了', 'warning');
            log('🔧 自動復旧機能が動作するかテストしてください', 'info');
            
            statistics.errorsDetected++;
        }

        // 自動復旧テスト
        async function testDataRecovery() {
            log('🚑 自動復旧テスト開始...', 'info');

            try {
                if (!simpleStorage) {
                    throw new Error('SimpleStorageManagerが利用できません');
                }

                // 正常なデータを一旦保存
                const backupData = {
                    engineOS: { name: "Recovery Test Engine", score: 88 },
                    interfaceOS: { name: "Recovery Test Interface", score: 78 },
                    safeModeOS: { name: "Recovery Test SafeMode", score: 68 },
                    recoveryTest: true
                };

                simpleStorage.saveAnalysisResult(backupData);
                log('📦 バックアップデータ保存完了', 'info');

                // データを意図的に破損
                localStorage.setItem('haqei_analysis_result', 'corrupted');
                log('💥 データ破損シミュレート完了', 'warning');

                // 復旧試行
                const recoveredData = simpleStorage.getAnalysisResult();

                if (recoveredData && recoveredData.recoveryTest) {
                    log('✅ 自動復旧成功！', 'success');
                    log(`📊 復旧データ: ${recoveredData.engineOS?.name}`, 'info');
                } else {
                    log('❌ 自動復旧失敗', 'error');
                    statistics.errorsDetected++;
                }

            } catch (error) {
                log(`❌ 復旧テストエラー: ${error.message}`, 'error');
                statistics.errorsDetected++;
            }
        }

        // 完全統合テスト
        async function runFullIntegrationTest() {
            log('🧪 完全統合テスト開始...', 'info');
            statistics.testsRun++;

            const testSequence = [
                { name: '初期化', func: initializeAllSystems },
                { name: 'データ操作', func: testDataSaveLoad },
                { name: 'Triple OS', func: testTripleOSData },
                { name: 'Hooks', func: testHooksSystem },
                { name: '復旧', func: testDataRecovery }
            ];

            let passed = 0;
            const startTime = Date.now();

            for (const test of testSequence) {
                try {
                    log(`🎯 実行中: ${test.name}テスト`, 'info');
                    await test.func();
                    passed++;
                    log(`✅ ${test.name}テスト完了`, 'success');
                } catch (error) {
                    log(`❌ ${test.name}テストエラー: ${error.message}`, 'error');
                    statistics.errorsDetected++;
                }

                // 少し待機
                await new Promise(resolve => setTimeout(resolve, 500));
            }

            const duration = Date.now() - startTime;
            const successRate = Math.round((passed / testSequence.length) * 100);
            statistics.successRate = successRate;

            log(`🎉 完全統合テスト完了！`, 'success');
            log(`📊 結果: ${passed}/${testSequence.length}成功 (${successRate}%), 実行時間: ${duration}ms`, 'info');

            if (successRate >= 80) {
                document.getElementById('system-status').textContent = '🟢 統合テスト合格';
            } else {
                document.getElementById('system-status').textContent = '🟡 部分的成功';
            }
        }

        // 全データクリア
        function clearAllData() {
            log('🧹 全データクリア実行...', 'warning');
            
            if (simpleStorage) {
                simpleStorage.clearAll();
                log('✅ SimpleStorageManager データクリア完了', 'success');
            }

            // 手動でも念のためクリア
            const keysToRemove = Object.keys(localStorage).filter(key => 
                key.includes('haqei') || key.includes('simple_storage')
            );
            
            keysToRemove.forEach(key => localStorage.removeItem(key));
            
            log(`🧹 ${keysToRemove.length}個のlocalStorageキーを削除`, 'info');
            log('✅ 全データクリア完了', 'success');
        }

        // テストレポート生成
        function generateTestReport() {
            log('📋 テストレポート生成中...', 'info');

            const report = {
                timestamp: new Date().toISOString(),
                testDuration: Date.now() - testStartTime,
                statistics: statistics,
                systemStatus: {
                    simpleStorage: !!simpleStorage,
                    dataMonitor: !!dataMonitor,
                    hooksSystem: !!hooksSystem
                }
            };

            if (hooksSystem) {
                report.hooksStatistics = hooksSystem.getStatistics();
            }

            if (dataMonitor) {
                report.dataIntegrity = dataMonitor.checkDataIntegrity();
            }

            log('📋 === HAQEI統合システム テストレポート ===', 'info');
            log(`⏱️ テスト期間: ${Math.round(report.testDuration / 1000)}秒`, 'info');
            log(`🔢 データ操作: ${report.statistics.dataOperations}回`, 'info');
            log(`❌ エラー検出: ${report.statistics.errorsDetected}回`, 'info');
            log(`🧪 実行テスト: ${report.statistics.testsRun}回`, 'info');
            log(`📈 成功率: ${report.statistics.successRate}%`, report.statistics.successRate >= 80 ? 'success' : 'warning');

            if (report.hooksStatistics) {
                log(`🔗 Hooks実行: ${report.hooksStatistics.hookExecutions}回`, 'info');
                log(`🔗 復旧率: ${report.hooksStatistics.recoveryRate}%`, 'info');
            }

            log('📋 === レポート終了 ===', 'info');

            // JSONとして保存も可能
            console.log('📋 詳細レポート:', report);
        }

        // ユーザーフローシミュレート
        async function simulateUserFlow() {
            log('👤 ユーザーフローシミュレート開始...', 'info');

            const userActions = [
                '診断開始',
                '設問回答 (1/30)',
                '設問回答 (15/30)',
                '設問回答 (30/30)',
                '分析実行',
                '結果表示',
                'データ保存',
                '結果ページ遷移',
                'データ読み込み',
                '表示完了'
            ];

            for (let i = 0; i < userActions.length; i++) {
                const action = userActions[i];
                log(`👤 ${action}...`, 'info');

                // 進捗更新
                const progress = Math.round(((i + 1) / userActions.length) * 100);
                document.getElementById('system-progress').style.width = `${progress}%`;

                // アクションに応じた処理
                if (action.includes('データ保存')) {
                    await testDataSaveLoad();
                } else if (action.includes('データ読み込み')) {
                    const result = simpleStorage?.getAnalysisResult();
                    if (result) {
                        log('✅ ユーザーデータ読み込み成功', 'success');
                    } else {
                        log('⚠️ ユーザーデータが見つかりません', 'warning');
                    }
                }

                await new Promise(resolve => setTimeout(resolve, 800));
            }

            log('🎉 ユーザーフローシミュレート完了！', 'success');
        }

        // ページ読み込み時の自動初期化
        window.addEventListener('DOMContentLoaded', () => {
            log('🚀 HAQEI統合システムテストページ読み込み完了', 'success');
            log('💡 "全システム初期化"ボタンをクリックして開始してください', 'info');
            
            // 定期的な統計更新
            setInterval(updateStatistics, 1000);
        });

    </script>
</body>
</html>