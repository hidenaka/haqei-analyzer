// ファイルパス: /netlify/functions/professional-ai.js (v3.1 JSON連携 安定版)
const { HAQEI_DATA } = require("../../assets/haqei_main_database.js"); const {
GoogleGenerativeAI } = require("@google/generative-ai"); const genAI = new
GoogleGenerativeAI(process.env.GEMINI_API_KEY); exports.handler = async (event)
=> { if (event.httpMethod !== "POST") { return { statusCode: 405, body: "Method
Not Allowed" }; } try { const requestData = JSON.parse(event.body); const {
analysis, context, profile } = requestData; if (!analysis ||
!analysis.hexagram_candidates || !analysis.trigram_profile || !context ||
!profile) { throw new Error("分析データまたはコンテキストが不完全です。"); }
const aiSectionsObject = await generateProfessionalReportSections(analysis,
context, profile); const fullReportHtml = assembleFullReportHtml(analysis,
context, aiSectionsObject); return { statusCode: 200, headers: { "Content-Type":
"application/json; charset=utf-8" }, body: JSON.stringify({ success: true,
report: fullReportHtml }), }; } catch (error) { console.error("Function Error:",
error); return { statusCode: 500, body: JSON.stringify({ success: false, error:
"AIレポートの生成中にエラーが発生しました: " + error.message, }), }; } }; async
function generateProfessionalReportSections(analysisResult, userContext,
userProfile) { const os1 = analysisResult.hexagram_candidates[0]; const os2 =
analysisResult.hexagram_candidates[1]; const os3 =
analysisResult.hexagram_candidates[2]; const trigram_profile =
analysisResult.trigram_profile; const os_manuals = HAQEI_DATA.os_manual || {};
const os1_manual = os_manuals[os1.hexagram_id] || {}; const os2_manual =
os_manuals[os2.hexagram_id] || {}; const os3_manual =
os_manuals[os3.hexagram_id] || {}; const format_os_manual = (os, manual, type)
=> { if (!manual || !manual.summary) return `【${type}】: ${os.name_jp}
(詳細データなし)`; return `【${type}】: ${os.name_jp} - 概要: ${manual.summary
|| "N/A"}, 暴走パターン: ${manual.debug_pattern || "N/A"}`.trim(); }; const
os_manual_details = `${format_os_manual(os1, os1_manual,
"エンジンOS")}\n${format_os_manual(os2, os2_manual,
"インターフェースOS")}\n${format_os_manual(os3, os3_manual, "セーフモードOS")}`;
const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash-latest" }); //
★★★ プロンプトをJSON出力形式に修正 ★★★ const prompt =
`あなたは、東洋哲学と心理学の叡智を統合した「HaQei
アナライザー」の最高専門家AIです。ユーザーの分析結果と個人的な状況を深く洞察し、ユーザーが「これは私のための戦略書だ」と感じ、次の一歩を踏み出したくなるような、希望に満ちた具体的なレポートを作成してください。
# 絶対的ルール - **出力は必ず、以下のキーを持つJSONオブジェクトのみ**とします:
\`{"dynamics": "...", "overview": "...", "action": "...", "next_steps": "..."}\`
- 各キーの値は、HTMLのpタグやulタグで構成される文字列とします。 -
hタグなどの見出しタグは**一切含めないでください**。 -
文章は、ユーザーに深く寄り添い、希望と具体的な気づきを与える、プロフェッショナルかつ温かいトーンで記述してください。
-
ユーザーの「課題」と「OSの力学」を具体的に結びつけ、単なる性格診断ではない、実践的な戦略を提示してください。
- 強調したいキーワードは\`<strong
  >\`タグで囲んでください。 - 箇条書きは\`
  <ul class="text-sm list-disc pl-5">
    <li>リスト項目</li>
  </ul>
  \`の形式を使用してください。 # ユーザー情報 - ユーザープロファイル:
  MBTI(${userProfile.mbti}), エニアグラム(${userProfile.enneagram.join(", ") ||
  "未入力"}) - ユーザーの状況: 年代(${userContext.age || "未入力"}),
  職業(${userContext.occupation || "未入力"}), 役割(${userContext.role ||
  "未入力"}), 課題(${userContext.issue || "特になし"}) # 分析結果サマリー -
  三位一体OSモデル: ${os_manual_details} - エネルギープロファイル:
  ${trigram_profile.map((p) => `${p.name_en}(${p.score})`).join(", ")} #
  生成すべきJSONの各キーの内容 ### 1. "dynamics" (OSの力学)
  あなたの3つのOSが、互いにどう作用し合っているかを解説してください。特に、ユーザーの「課題」が、このOSの力学によってどのように生み出されているのかを、具体的に、そして優しく指摘してください。
  ### 2. "overview" (総合所見)
  分析結果全体を統合し、ユーザーの「現在地」を物語的に表現してください。そして、このOS構造を活かすことで、どのような素晴らしい未来の可能性があるのか、希望に満ちた展望を提示してください。
  ### 3. "action" (Next Action)
  ユーザーが明日から実践できる、非常に具体的で小さな行動を2〜3個提案してください。各アクションが、OSのどの部分を最適化するのかを明確に示してください。（例：「エンジンOSの『雷』のエネルギーを健全に使うために、週に一度、5分だけ全力で部屋を掃除してみましょう」など）
  ### 4. "next_steps" (さらなる探求へ)
  今回の分析結果を手に、「未来分岐シミュレーター」を使うと、どのような気づきが得られるかを具体的に示唆してください。「あなたのエンジンOSである【${os1.name_jp}】を携えて、もし現在の課題に対して『進』のアクションを取ると、どのような未来が展開されるか見てみましょう」といった形で、次のツール利用へと自然に誘導してください。
  `; try { const result = await model.generateContent(prompt); const response =
  await result.response; const text = response.text().replace(/```json/g,
  '').replace(/```/g, '').trim(); // AIの返答をJSONとしてパース return
  JSON.parse(text); } catch (error) { console.error("Gemini API Error or JSON
  Parse Error:", error); throw new
  Error("AIの応答形式が不正か、APIとの通信に失敗しました。"); } } // ★★★
  HTML組み立て関数をJSONオブジェクトを受け取るように修正 ★★★ function
  assembleFullReportHtml(analysisResult, userContext, aiSectionsObject) { const
  os1 = analysisResult.hexagram_candidates[0]; const os2 =
  analysisResult.hexagram_candidates[1]; const os3 =
  analysisResult.hexagram_candidates[2]; const age = userContext.age || "";
  const occupation = userContext.occupation || ""; const role = userContext.role
  || ""; const issue = userContext.issue ||
  "特になし（現状のポテンシャル分析）"; // ユーザー状況のテキストを動的に生成
  let contextParts = []; if (age) contextParts.push(age); if (occupation)
  contextParts.push(occupation); if (role)
  contextParts.push(`${role}という役割`); const contextSummary =
  contextParts.length > 0 ? contextParts.join("、") + "で、" : ""; const header
  = `
  <h3
    class="text-2xl font-bold text-indigo-300 mb-8 text-center"
    style="font-family: 'Shippori Mincho', serif"
  >
    あなたの物語を読み解く<br />HaQei 統合分析レポート
  </h3>
  `; const contextText = `
  <div class="report-block">
    <h4>0. はじめに - あなたの現在地</h4>
    <p class="text-sm">
      ${contextSummary}「${issue}」という課題意識をお持ちなのですね。承知いたしました。その状況と、あなたが持つ素晴らしいOSの可能性を掛け合わせ、物語の次章へと進むための羅針盤をここに提示します。
    </p>
  </div>
  `; const trinityText = `
  <div class="report-block">
    <h4>1. あなたのOSアーキテクチャ - 三位一体モデルの構造</h4>
    <p class="text-sm">
      あなたのOS構造は、以下の3つのOSが連携して機能しています。それぞれの役割を理解することが、自己を乗りこなす第一歩です。
    </p>
    <ul class="text-sm list-none space-y-3 mt-4">
      <li class="p-4 bg-gray-900/50 rounded-lg border-l-4 border-yellow-400">
        <strong>【エンジンOS：${os1.name_jp}】</strong
        ><br />${HAQEI_DATA.os_manual[os1.hexagram_id]?.summary ||
        os1.description}
      </li>
      <li class="p-4 bg-gray-900/50 rounded-lg border-l-4 border-cyan-400">
        <strong>【インターフェースOS：${os2.name_jp}】</strong
        ><br />${HAQEI_DATA.os_manual[os2.hexagram_id]?.summary ||
        os2.description}
      </li>
      <li class="p-4 bg-gray-900/50 rounded-lg border-l-4 border-rose-400">
        <strong>【セーフモードOS：${os3.name_jp}】</strong
        ><br />${HAQEI_DATA.os_manual[os3.hexagram_id]?.summary ||
        os3.description}
      </li>
    </ul>
  </div>
  `; const section1 = `
  <div class="report-block">
    <h4>2. OSの力学 - ポテンシャルを最大化する鍵</h4>
    ${aiSectionsObject.dynamics || ''}
  </div>
  `; const section2 = `
  <div class="report-block">
    <h4>3. 総合所見 - あなたの物語の現在地と未来への羅針盤</h4>
    ${aiSectionsObject.overview || ''}
  </div>
  `; const section3 = `
  <div class="report-block">
    <h4>4. Next Action - 次の具体的な一歩</h4>
    ${aiSectionsObject.action || ''}
  </div>
  `; const section4 = `
  <div class="report-block">
    <h4>5. さらなる探求へ - 未来分岐シミュレーターの活用</h4>
    ${aiSectionsObject.next_steps || ''}
  </div>
  `; return header + contextText + trinityText + section1 + section2 + section3
  + section4; }</strong
>
