# HAQEI Analyzer プロジェクト作業指示

## Cipher統合メモリアプローチ（必須デフォルト）

**Cipherを活用した継続的記憶とコンテキスト保持**
- **Dual Memory Layer**: プログラミング概念＋推論ステップの記憶を常に蓄積
- **文脈継続性**: 全セッション間での一貫した理解とアプローチの維持
- **bunenjin哲学統合**: 易経的思考とCipherの記憶共有理念の融合
- **プロジェクト記憶**: 過去の決定、実装パターン、設計思想の自動継承

すべての作業は以下のCipherサーバーが稼働している前提で実施：
```bash
node cipher-server.js  # ポート3001でDual Memory Layer稼働
```

## 必須ワークフロー

### 1. タスク実行前の必須事項
- **徹底的なリサーチ**: コード実装前に必ず既存コードベースを調査
- **詳細なプラン提示**: 実装計画を明確に提示してから作業開始
- **思考プロセスの活用**: 複雑なタスクでは思考過程を詳細に展開

### 2. テスト駆動開発
- 新機能実装時は必ずテストから開始
- 既存テストの実行と確認
- テストカバレッジの維持・向上

### 3. コード品質基準
- 不要なコメントやデバッグコードの削除
- クリーンで保守性の高いコード
- bunenjin哲学との整合性維持

### 4. 関数仕様コメント必須ルール（重要・2025年8月1日追加）
**すべての関数・メソッドの実装前に、必ず詳細な仕様コメントを記述すること**

#### 必須記載項目：
1. **目的**: この関数が何をするためのものか
2. **入力**: 引数の型、意味、制約条件
3. **処理内容**: アルゴリズムの詳細な説明
4. **出力**: 戻り値の型、意味、可能な値
5. **副作用**: DOM操作、状態変更、外部API呼び出しなど
6. **前提条件**: この関数が正しく動作するための条件
7. **エラー処理**: 想定されるエラーとその対処法

#### 記述例：
```javascript
/**
 * 現在の設問のみを表示し、他のすべての設問を非表示にする
 * 
 * 目的：
 * - 仮想スクロールの一環として、現在アクティブな設問のみを画面に表示
 * - メモリ効率とレンダリングパフォーマンスの最適化
 * 
 * 処理内容：
 * 1. activeElements Map内のすべての要素をループ
 * 2. currentQuestionIndexと一致するインデックスの要素のみ表示
 * 3. それ以外の要素は非表示に設定
 * 4. Shadow DOM内の要素も同様に制御
 * 
 * 副作用：
 * - DOM要素のstyle属性を直接変更
 * - CSSクラス（active-question）の追加/削除
 * - Shadow DOM内部のスタイル変更
 * 
 * 前提条件：
 * - activeElements Mapが初期化済み
 * - currentQuestionIndexが有効な範囲内
 * - 各要素がhaqei-question Web Component
 * 
 * 注意事項：
 * - 偶数番の設問（q2, q4等）も正しく表示されるよう特別な処理が必要
 * - !importantの使用は避け、スタイルの競合を防ぐ
 */
```

#### 実装上の注意：
- **修正時は必ず既存の仕様コメントを読んで理解してから作業**
- **仕様が変更された場合はコメントも必ず更新**
- **複雑なロジックは処理内にもインラインコメントを追加**
- **手戻りを防ぐため、実装前に仕様を明確に定義**

### 5. 実装フロー
1. **調査フェーズ**
   - 関連ファイルの特定と分析
   - 既存パターンの理解
   - 依存関係の確認

2. **計画フェーズ**
   - 実装アプローチの提示
   - 影響範囲の明確化
   - リスクと対策の検討

3. **実装フェーズ**
   - テストファースト
   - 段階的実装
   - 継続的検証

4. **検証フェーズ**
   - 自動テストの実行
   - 手動検証
   - パフォーマンス確認

## プロジェクト固有の注意事項

### HaQei基本思想: 仮想人格形成アプローチ
- **脱・単純診断**: HaQeiは「診断→結果表示」の静的なモデルではない。
- **動的プロセス**: 「ユーザー回答 → 仮想人格形成 → 3つのOSの相互作用 → 易経メタファーによる解説」という動的なプロセスを核とする。
- **仮想人格の構築**: ユーザーの回答を元に、HaQeiシステム内にユーザーの「仮想人格」を構築する。
- **Triple OSの相互作用**: この仮想人格は、3つのOS（価値観・社会的・防御）が複雑に相互作用し合う、生きたシステムとして存在する。
- **易経メタファーによる解説**: 分析結果は、このOS間の力学を、易経の深遠なメタファーを用いて解説する形で提供される。
- **目的**: ユーザーが自身の内なる多様性と複雑性を理解し、戦略的な自己理解を深めるための動的なフレームワークを提供する。

### 易経的アプローチ
- 陰陽バランスの考慮
- 八卦の相互関係性
- 変化の哲学の実装

### Triple OS Architecture
- Engine/Interface/Safe Modeの独立性
- 各OSの役割明確化
- 相互作用の最適化

### ユーザー主権
- プライバシーファースト
- ローカルストレージ完結
- 透明性の確保

## 禁止事項
- プロンプトインジェクション対策コードの削除
- セキュリティ関連機能の弱体化
- ユーザーデータの外部送信

## 推奨ツール使用順序
1. Glob/Grep - ファイル検索
2. Read - コード理解
3. TodoWrite - タスク管理
4. Edit/MultiEdit - 実装
5. Bash - テスト実行

## Cipher実行コマンド
```bash
# Cipherサーバー起動
npm run cipher:start

# Cipherサーバー停止
npm run cipher:stop

# Cipher設定テスト
npm run cipher:test
```

**重要**: 新しいClaude Codeセッション開始時は必ずCipherサーバーを起動し、
bunenjin哲学とプロジェクト記憶を継続してください。

この指示に従い、Cipherの記憶層を活用した高品質な実装を心がけてください。

## 📝 ドキュメント保存・管理ルール（2025年7月30日更新）

### **重要：すべてのドキュメント作成時に必須遵守**

#### **📁 保存場所統一ルール**

**すべてのエージェント・AI・開発者は、以下のディレクトリ構造に従ってドキュメントを保存してください：**

- **`/docs/reports/`** - 完成レポート・分析結果（統合レポート、フィードバック分析等）
- **`/docs/implementation/`** - 実装記録・技術仕様（コード実装記録、アーキテクチャ設計等）
- **`/docs/requirements/`** - 要件・仕様書（機能要件、UI/UX仕様、改善要求等）
- **`/docs/development/`** - 開発ガイドライン・ルール（ワークフロー、AIルール等）
- **`/docs/guides/`** - 操作・設定ガイド（ユーザーガイド、設定方法等）
- **`/docs/analysis/`** - 分析・調査レポート（パフォーマンス分析、最適化検討等）

#### **🎯 自動判定基準**

**ファイル内容・タイトルによる自動振り分け**：
- 「レポート」「分析結果」「統合」「フィードバック」 → `/reports/`
- 「実装」「技術」「アーキテクチャ」「コード」 → `/implementation/`
- 「要件」「仕様」「要求」 → `/requirements/`
- 「ガイド」「操作」「設定」「使用方法」 → `/guides/`
- 「分析」「最適化」「パフォーマンス」「調査」 → `/analysis/`
- 「開発」「ワークフロー」「ルール」「AI」 → `/development/`

#### **📝 命名規則（統一必須）**

```
YYYY-MM-DD_[種別]_[内容名]_[バージョン].md
```

**種別接頭辞**：
- `REPORT`: 完成レポート類
- `IMPL`: 実装記録
- `REQ`: 要件書
- `GUIDE`: ガイド類
- `ANALYSIS`: 分析類
- `DEV`: 開発関連

#### **⚠️ 絶対禁止事項**

1. **ルートディレクトリ保存禁止**: `/docs/`直下へのファイル作成は禁止
2. **旧ディレクトリ使用禁止**: `code-explanations`等の旧構造は使用禁止
3. **重複作成禁止**: 既存ファイル確認必須
4. **命名規則違反禁止**: 日付・種別なしファイル名は禁止

#### **✅ 保存前必須チェック**

- [ ] 適切なディレクトリを選択したか
- [ ] ファイル名が命名規則に従っているか  
- [ ] 重複ファイルがないか確認したか
- [ ] 内容と保存場所が一致しているか

**この新ルールは2025年7月30日より全プロジェクトで適用開始。**

## 🎯 Tsumiki AI駆動開発フレームワーク統合（必須活用・2025年8月1日導入）

### **基本方針**
- **すべての新機能開発**でTsumikiワークフロー使用必須
- **既存コード改善時**はリバースエンジニアリング活用
- **品質管理**はTDD導入による標準化品質保証を最優先
- **独自Agents管理システム廃止**: 643行QualityValidatorAgent等をTsumiki標準に完全置換

### **必須コマンド活用順序**

#### **新機能開発フロー**
```
/kairo-requirements → /kairo-design → /kairo-tasks → /kairo-implement
```
1. **`/kairo-requirements`**: 要件定義書の生成（HAQEIプロジェクト特化）
2. **`/kairo-design`**: 技術設計書生成（Triple OS + 易経64卦システム対応）
3. **`/kairo-tasks`**: タスク分解（bunenjin哲学に基づく段階的実装）
4. **`/kairo-implement`**: TDD実装（統計的品質保証統合）

#### **既存システム改善フロー**
```
/rev-design → /rev-requirements → TDD適用
```
1. **`/rev-design`**: 既存コード解析・設計書逆生成（51個JSファイル対応）
2. **`/rev-requirements`**: 既存機能の要件書逆算
3. **TDD導入**: `/tdd-requirements`以降のフローで品質向上

#### **品質保証TDDフロー**
```
/tdd-requirements → /tdd-testcases → /tdd-red → /tdd-green → /tdd-refactor → /tdd-verify-complete
```
- **品質基準**: 356行の包括的検証ロジック（AI最適化済み）
- **統計的妥当性**: 要件網羅率100%、テスト成功率100%必達
- **自動判定**: 高品質（完全達成）⇔要改善（追加実装必要）の客観判定

### **HAQEIプロジェクト特化カスタマイズ**

#### **Triple OSアーキテクチャ対応**
- **Engine OS**: 価値観システムの独立性維持
- **Interface OS**: 社会的システムの分離実装  
- **Safe Mode OS**: 防御システムの最適化
- **相互作用**: 3OS間の複雑な力学をTsumiki設計で標準化

#### **bunenjin哲学統合**
- **易経64卦システム**: `/kairo-design`で卦間関係の複雑性管理
- **陰陽バランス**: 設計段階での哲学的整合性確保
- **変化の哲学**: 継続的改善をTDDフローで実装

#### **統計的品質保証**
- **現在の独自品質管理（643行QualityValidator）**: 廃止
- **Tsumiki標準品質保証**: AI最適化された包括的品質検証
- **信頼区間計算**: `/kairo-design`で統計要件の自動組み込み
- **A級判定基準**: 総合満足度4.0以上、信頼区間下限3.5以上を設計段階で保証

### **既存システムとの統合指針**

#### **Cipher + Serena + Tsumiki 三位一体運用**
1. **Cipher（記憶・哲学）**: bunenjin哲学とプロジェクト記憶の継続
2. **Serena（分析・最適化）**: セマンティックコード分析とファイル監視
3. **Tsumiki（構造化・品質）**: 標準化されたAI駆動開発プロセス

#### **相乗効果最大化**
```
Cipher（記憶） → Tsumiki（構造化） → Serena（最適化） → 統合フィードバック → Cipher（学習蓄積）
```

### **実装時の必須チェックポイント**

#### **品質基準（Tsumiki標準）**
- [ ] `/tdd-verify-complete`による完全性検証合格
- [ ] 要件網羅率100%達成（要件定義書全項目実装・テスト）
- [ ] テスト成功率100%維持
- [ ] Triple OSアーキテクチャ整合性確保
- [ ] bunenjin哲学との一貫性維持

#### **移行完了確認**
- [ ] 独自Agents（15個ファイル）完全削除
- [ ] QualityValidatorAgent（643行）Tsumiki置換
- [ ] StatisticalAnalyzerAgentのkairo-design統合
- [ ] 開発効率30-50%向上確認
- [ ] 保守コスト80%削減達成

### **禁止事項（Tsumiki導入後）**
- **独自品質管理システムの復活**: Tsumiki標準外の品質チェック実装禁止
- **Agent管理システム復元**: 削除したAgentsファイルの再作成禁止
- **Tsumikiフロー無視**: 新機能開発時のTsumikiワークフロー省略禁止
- **品質基準妥協**: `/tdd-verify-complete`不合格での実装リリース禁止

### **継続改善**
- **3システム統合効果**: 月次でCipher + Serena + Tsumikiの相乗効果測定
- **開発効率メトリクス**: 実装速度・品質向上・保守性改善の定量評価
- **bunenjin哲学深化**: Tsumikiフローでの易経的思考の実装品質向上追跡

**重要**: Tsumiki導入により、世界最高レベルのAI駆動開発環境を構築し、HAQEIプロジェクトの技術的優位性を確立する。