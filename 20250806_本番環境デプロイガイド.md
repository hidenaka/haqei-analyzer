# Future Simulator 本番環境デプロイガイド

作成日: 2025年08月06日  
対象: HAQEI Future Simulator  
デプロイ先: Cloudflare Pages  

## 📋 デプロイ前チェックリスト

### ✅ セキュリティ確認
- [ ] DOMPurify integrity有効（sha384ハッシュ確認）
- [ ] CSP設定適用済み
- [ ] セキュリティヘッダー11項目実装
- [ ] 全CDN依存関係除去完了
- [ ] SRI保護全適用

### ✅ パフォーマンス確認
- [ ] Tailwind CSSローカル化完了
- [ ] Chart.jsライブラリローカル化完了
- [ ] ml-matrix最適化完了
- [ ] 不要ファイル除去済み

### ✅ 機能確認
- [ ] H384_DATABASE正常動作
- [ ] 30問システム動作確認
- [ ] チャート描画機能確認
- [ ] エラーハンドリング確認

## 🚀 Cloudflare Pages デプロイ手順

### Step 1: リポジトリ準備

```bash
# 最新変更をコミット
git add .
git commit -m "feat: Phase 3最終最適化完了 - 本番環境準備完成"
git push origin main
```

### Step 2: Cloudflare Pages設定

1. **Cloudflare Dashboard**にログイン
2. **Pages** → **Create a project**
3. **Connect to Git**でリポジトリ選択
4. **Project settings**:
   ```
   Project name: haqei-future-simulator
   Production branch: main
   Build directory: public
   ```

### Step 3: 環境変数設定

#### 本番環境変数
```bash
# Cloudflare Pages Settings → Environment variables
NODE_ENV=production
HAQEI_ENV=production
```

#### セキュリティ設定
```bash
# Headers設定（_headers ファイル）
/*
  Strict-Transport-Security: max-age=31536000; includeSubDomains; preload
  X-Frame-Options: DENY
  X-Content-Type-Options: nosniff
  X-XSS-Protection: 1; mode=block
  Referrer-Policy: strict-origin-when-cross-origin
  Content-Security-Policy: default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:
```

### Step 4: ビルド設定

```yaml
# 必要に応じてpackage.jsonにビルドスクリプト追加
{
  "scripts": {
    "build": "npx tailwindcss -i ./public/css/input.css -o ./public/css/tailwind.css --minify",
    "build:production": "npm run build && echo 'Production build complete'"
  }
}
```

## 🔧 本番環境特有の設定

### セキュリティ強化設定

#### CSP（Content Security Policy）
```javascript
// 本番環境では厳格なCSP適用
const productionCSP = {
  'default-src': "'self'",
  'script-src': "'self' 'unsafe-inline'",
  'style-src': "'self' 'unsafe-inline'",
  'img-src': "'self' data: https:",
  'font-src': "'self'",
  'connect-src': "'self'",
  'media-src': "'self'",
  'object-src': "'none'",
  'frame-src': "'none'"
};
```

#### HTTPS強制リダイレクト
```javascript
// Cloudflare Pages設定で自動HTTPS有効化
Always Use HTTPS: ON
```

### パフォーマンス最適化

#### キャッシュ設定
```
# _headers ファイルに追加
/css/*
  Cache-Control: public, max-age=31536000, immutable

/js/*
  Cache-Control: public, max-age=31536000, immutable

/*.html
  Cache-Control: public, max-age=3600
```

#### 圧縮設定
```
# Cloudflare自動圧縮有効化
Brotli: ON
Gzip: ON
```

## 📊 本番環境監視

### 必須監視項目

#### パフォーマンス監視
- [ ] ページ読み込み時間 < 3秒
- [ ] First Contentful Paint < 1.5秒
- [ ] Largest Contentful Paint < 2.5秒
- [ ] Cumulative Layout Shift < 0.1

#### セキュリティ監視
- [ ] セキュリティヘッダー適用確認
- [ ] CSP違反ログ監視
- [ ] 不正アクセス検知

#### 機能監視
- [ ] H384_DATABASE初期化成功率
- [ ] エラー発生率 < 1%
- [ ] API応答時間監視

### 監視ツール設定

#### Google Analytics 4
```html
<!-- future_simulator.html に追加 -->
<script async src="https://www.googletagmanager.com/gtag/js?id=GA_MEASUREMENT_ID"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'GA_MEASUREMENT_ID');
</script>
```

#### Cloudflare Analytics
- Web Analytics有効化
- Real User Monitoring (RUM)設定

## 🚨 トラブルシューティング

### よくある問題と解決方法

#### 1. CSS読み込みエラー
```bash
# 解決方法: Tailwind CSS再ビルド
npx tailwindcss -i ./public/css/input.css -o ./public/css/tailwind.css --minify
```

#### 2. JavaScript エラー
```bash
# 解決方法: ライブラリファイル確認
ls -la public/js/lib/
# 必要に応じて再コピー
cp node_modules/chart.js/dist/chart.umd.min.js public/js/lib/chart.min.js
```

#### 3. H384_DATABASE初期化失敗
```javascript
// 解決方法: 初期化タイミング調整
window.addEventListener('DOMContentLoaded', function() {
  H384_DATABASE.initialize().then(() => {
    console.log('Database initialized successfully');
  });
});
```

## 📈 運用・保守

### 定期メンテナンス

#### 月次作業
- [ ] セキュリティ監査実施
- [ ] パフォーマンス分析
- [ ] エラーログ分析
- [ ] 依存関係脆弱性チェック

#### 四半期作業
- [ ] 依存関係アップデート
- [ ] セキュリティヘッダー見直し
- [ ] バックアップ検証

### アップデート手順

```bash
# 1. 開発環境でテスト
npm update
npm audit
npm run test

# 2. ステージング環境でテスト
git checkout staging
git merge main
# デプロイ・テスト

# 3. 本番環境デプロイ
git checkout main
git tag v1.x.x
git push origin v1.x.x
```

## 🎯 成功指標（KPI）

### パフォーマンス指標
- **ページ読み込み時間**: < 3秒
- **可用性**: > 99.9%
- **エラー率**: < 0.1%

### セキュリティ指標
- **セキュリティスコア**: A+（SSLLabs）
- **脆弱性**: 0件
- **CSP違反**: < 10件/日

### ユーザー体験指標
- **バウンス率**: < 30%
- **セッション時間**: > 5分
- **コンバージョン率**: > 10%

---

## 📞 サポート連絡先

**技術サポート**: HAQEI開発チーム  
**緊急対応**: 24時間監視体制  
**定期報告**: 月次レポート自動配信  

**デプロイ完了後、必ず全機能テストを実施してください。**