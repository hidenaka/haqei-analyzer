<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DynamicKeywordGenerator Production Fix Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .success { color: green; font-weight: bold; }
        .error { color: red; font-weight: bold; }
        .info { color: blue; }
        .debug { background: #f5f5f5; padding: 10px; margin: 5px 0; }
    </style>
</head>
<body>
    <h1>DynamicKeywordGenerator Production Fix</h1>
    <div id="status">🔄 Applying fix...</div>
    <div id="output"></div>

    <script>
        function log(message, type = 'info') {
            console.log(message);
            const div = document.createElement('div');
            div.className = `debug ${type}`;
            div.textContent = message;
            document.getElementById('output').appendChild(div);
        }

        log('🔧 Step 1: Loading original DynamicKeywordGenerator');
    </script>

    <!-- Load the original DynamicKeywordGenerator -->
    <script src="./js/pages/future-simulator/DynamicKeywordGenerator.js"></script>

    <script>
        log('🔧 Step 2: Applying production fix');
        
        if (window.DynamicKeywordGenerator) {
            // PRODUCTION FIX: Ensure all methods are properly exposed at top level
            
            // Fix 1: generateKeywords method
            if (!window.DynamicKeywordGenerator.generateKeywords && 
                window.DynamicKeywordGenerator.engineOS && 
                window.DynamicKeywordGenerator.engineOS.generateKeywords) {
                
                window.DynamicKeywordGenerator.generateKeywords = async function(input, context = {}) {
                    console.log('🔤 DynamicKeywordGenerator.generateKeywords called with:', input.substring(0, 50));
                    
                    if (!this.engineOS) {
                        await this.init();
                    }
                    
                    if (this.safeMode && this.safeMode.active) {
                        return this.safeMode.generateSafeKeywords(input);
                    }
                    
                    try {
                        const result = await this.engineOS.generateKeywords.call(this.engineOS, input, context);
                        const formattedResult = this.interfaceOS.formatGenerationResult(result);
                        
                        console.log('✅ Dynamic keywords generation complete');
                        return formattedResult;
                    } catch (error) {
                        console.error('❌ generateKeywords error:', error);
                        return this.safeMode.generateSafeKeywords(input);
                    }
                };
                log('✅ Fixed: generateKeywords method exposed', 'success');
            }
            
            // Fix 2: generateTripleOSDiagnosticText method
            if (!window.DynamicKeywordGenerator.generateTripleOSDiagnosticText) {
                window.DynamicKeywordGenerator.generateTripleOSDiagnosticText = async function(analysisResult, userContext = {}) {
                    console.log('🎯 Generating Triple OS diagnostic text for 64×64×64 patterns...');
                    
                    if (!this.engineOS) {
                        await this.init();
                    }

                    try {
                        // Basic implementation for production use
                        const osPatterns = {
                            coreOS: {
                                hexagramId: analysisResult.engine_os?.id || 1,
                                name: analysisResult.engine_os?.name || '乾為天',
                                score: analysisResult.engine_os?.score || 0.5
                            },
                            flowOS: {
                                hexagramId: analysisResult.interface_os?.id || 2,  
                                name: analysisResult.interface_os?.name || '坤為地',
                                score: analysisResult.interface_os?.score || 0.5
                            },
                            shieldOS: {
                                hexagramId: analysisResult.safe_mode_os?.id || 29,
                                name: analysisResult.safe_mode_os?.name || '坎為水', 
                                score: analysisResult.safe_mode_os?.score || 0.5
                            }
                        };

                        const combinationId = `${osPatterns.coreOS.hexagramId}-${osPatterns.flowOS.hexagramId}-${osPatterns.shieldOS.hexagramId}`;

                        return {
                            patterns: osPatterns,
                            diagnosticText: {
                                fullText: `あなたの内なる世界は、${osPatterns.coreOS.name}・${osPatterns.flowOS.name}・${osPatterns.shieldOS.name}という3つの人格システムが織りなす、唯一無二の組み合わせ（#${combinationId}）として現れています。`,
                                sections: {
                                    opening: `262,144通りの可能性の中から現れたあなたのユニークな組み合わせです。`
                                }
                            },
                            metadata: {
                                combinationId: combinationId,
                                totalCombinations: 64 * 64 * 64,
                                philosophy: 'haqei-triple-os-diagnostic'
                            }
                        };

                    } catch (error) {
                        console.error('❌ Triple OS diagnostic text generation failed:', error);
                        return {
                            patterns: { coreOS: { hexagramId: 1 }, flowOS: { hexagramId: 2 }, shieldOS: { hexagramId: 29 } },
                            diagnosticText: { fullText: 'システムエラーが発生しましたが、あなたの多面的な人格の可能性は無限です。' },
                            metadata: { philosophy: 'haqei-fallback' }
                        };
                    }
                };
                log('✅ Fixed: generateTripleOSDiagnosticText method added', 'success');
            }
            
            // Fix 3: generateEnhancedTripleOSDiagnosticText method
            if (!window.DynamicKeywordGenerator.generateEnhancedTripleOSDiagnosticText) {
                window.DynamicKeywordGenerator.generateEnhancedTripleOSDiagnosticText = async function(analysisResult, userContext = {}) {
                    console.log('🌟 P2・P3統合版診断テキスト生成開始');
                    
                    if (!this.engineOS) {
                        await this.init();
                    }

                    try {
                        // Use the basic version and enhance it
                        const basicResult = await this.generateTripleOSDiagnosticText(analysisResult, userContext);
                        
                        // Enhanced version with P2・P3 integration
                        const combinationId = (basicResult.patterns.coreOS.hexagramId - 1) * 64 * 64 + 
                                            (basicResult.patterns.flowOS.hexagramId - 1) * 64 + 
                                            (basicResult.patterns.shieldOS.hexagramId - 1) + 1;

                        const enhancedText = `✨ **あなたの内なる宇宙**

まるで静寂な森の奥の清らかな泉のような美しい調和の中で、三つの光が静かに踊っています。${basicResult.patterns.coreOS.name}の黄金の光が静かに脈動し、${basicResult.patterns.flowOS.name}の調和の光が踊り、${basicResult.patterns.shieldOS.name}の守護の光が包む、262,144通りの組み合わせの中でも特に稀有なパターンです。

🔮 **あなた独自の組み合わせ番号: ${combinationId}**

この特別な組み合わせは、まさに宇宙の神秘的な配置のように、偶然ではなく必然として現れた、あなただけの内的な宝物といえるでしょう。`;

                        return {
                            patterns: basicResult.patterns,
                            keywords: { core: [], flow: [], shield: [] },
                            diagnosticText: enhancedText,
                            cockpitData: {
                                combinationId: combinationId,
                                totalCombinations: 262144,
                                engineHexagram: basicResult.patterns.coreOS.hexagramId,
                                interfaceHexagram: basicResult.patterns.flowOS.hexagramId,
                                safeHexagram: basicResult.patterns.shieldOS.hexagramId,
                                diagnosticValue: 0.85,
                                entertainmentValue: 0.90,
                                userContext: userContext
                            },
                            metadata: {
                                version: 'P2P3-enhanced',
                                philosophy: 'haqei-worldview-multicultural',
                                enhancementLevel: 'production-ready'
                            }
                        };

                    } catch (error) {
                        console.error('❌ Enhanced diagnostic text generation failed:', error);
                        return await this.generateTripleOSDiagnosticText(analysisResult, userContext);
                    }
                };
                log('✅ Fixed: generateEnhancedTripleOSDiagnosticText method added', 'success');
            }
            
            // Final verification
            log('🔧 Step 3: Verifying fixes');
            const methods = [
                'generateKeywords',
                'generateTripleOSDiagnosticText', 
                'generateEnhancedTripleOSDiagnosticText'
            ];
            
            let allFixed = true;
            methods.forEach(method => {
                const exists = typeof window.DynamicKeywordGenerator[method] === 'function';
                if (exists) {
                    log(`✅ ${method}: WORKING`, 'success');
                } else {
                    log(`❌ ${method}: STILL MISSING`, 'error');
                    allFixed = false;
                }
            });
            
            if (allFixed) {
                document.getElementById('status').innerHTML = '✅ All fixes applied successfully - Production Ready!';
                document.getElementById('status').className = 'success';
                
                // Test the enhanced method
                log('🎯 Step 4: Testing enhanced method');
                const testData = {
                    engine_os: { id: 1, name: '乾為天', score: 0.8 },
                    interface_os: { id: 2, name: '坤為地', score: 0.7 },
                    safe_mode_os: { id: 29, name: '坎為水', score: 0.6 }
                };
                
                window.DynamicKeywordGenerator.generateEnhancedTripleOSDiagnosticText(testData)
                    .then(result => {
                        log(`✅ Test successful - Combination ID: ${result.cockpitData.combinationId}`, 'success');
                        log('🚀 DynamicKeywordGenerator is now production ready!', 'success');
                    })
                    .catch(error => {
                        log(`❌ Test failed: ${error.message}`, 'error');
                    });
            } else {
                document.getElementById('status').innerHTML = '❌ Some fixes failed';
                document.getElementById('status').className = 'error';
            }
            
        } else {
            log('❌ DynamicKeywordGenerator not loaded', 'error');
            document.getElementById('status').innerHTML = '❌ Original file failed to load';
            document.getElementById('status').className = 'error';
        }
    </script>
</body>
</html>