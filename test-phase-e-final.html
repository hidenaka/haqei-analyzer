<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>E-6～E-10: Phase E最終検証（300サンプル・13%目標）</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .success { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .error { color: #f48771; }
        .info { color: #9cdcfe; }
        .result-box {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .metric-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            margin: 10px 0;
        }
        .progress-bar {
            width: 100%;
            height: 25px;
            background: #2d2d30;
            border-radius: 12px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ec9b0, #569cd6);
            transition: width 0.3s ease;
        }
        .coverage-visual {
            display: grid;
            grid-template-columns: repeat(24, 1fr);
            gap: 2px;
            margin: 20px 0;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 5px;
        }
        .line-dot {
            width: 100%;
            aspect-ratio: 1;
            border-radius: 50%;
            background: #3e3e42;
        }
        .line-dot.used { background: #4ec9b0; }
        .line-dot.rare { background: #569cd6; }
        .line-dot.overused { background: #dcdcaa; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #3e3e42;
            padding: 8px;
            text-align: left;
        }
        th { background: #2d2d30; }
        .task-status { margin: 5px 0; }
        .task-complete { color: #4ec9b0; }
        .task-pending { color: #dcdcaa; }
    </style>
</head>
<body>
    <h1>🎯 E-6～E-10: Phase E 最終検証（300サンプル・カバー率13%目標）</h1>
    <div id="status">テスト準備中...</div>
    <div id="progress-container" style="display: none;">
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
        <span id="progress-text">0/300</span>
    </div>
    <div id="results"></div>

    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // E-6～E-10用の300サンプル生成
        function generatePhaseESamples() {
            const samples = [];
            
            // 多様なカテゴリーのテキスト
            const categories = {
                // 始まり系（1爻狙い）
                beginning: [
                    "新しい始まり", "初めての挑戦", "スタート地点", "第一歩",
                    "起動する", "創始", "開始", "着手", "始動", "立ち上げ"
                ],
                // 協力系（2爻狙い）
                cooperation: [
                    "協力関係", "チームワーク", "連携", "協調", "支援",
                    "パートナーシップ", "相互", "協働", "連帯", "共同"
                ],
                // 困難系（3爻狙い）
                challenge: [
                    "困難に直面", "試練", "挑戦", "問題解決", "壁",
                    "葛藤", "苦労", "障害", "逆境", "課題"
                ],
                // 変化系（4爻狙い）
                transition: [
                    "変化の時期", "転換点", "移行", "岐路", "転機",
                    "変更", "調整", "選択", "決断", "分岐"
                ],
                // 成熟系（5爻狙い）
                mature: [
                    "リーダーシップ", "成熟", "統率", "指導", "管理",
                    "権限", "中心", "主導", "統括", "決定"
                ],
                // 完成系（6爻狙い）
                completion: [
                    "完成", "終了", "結果", "最終", "完了",
                    "締結", "仕上げ", "極致", "完結", "成就"
                ],
                // 極限系（用九・用六狙い）
                extreme: [
                    "究極の選択", "極限状態", "最大限", "無限の可能性", "完全なる調和",
                    "絶対的な力", "全てを受け入れる", "静寂の中で", "空の境地", "超越する"
                ],
                // 中性系（バランステスト）
                neutral: [
                    "日常業務", "通常作業", "定例会議", "報告書", "データ分析",
                    "プレゼン", "メール", "資料", "スケジュール", "打ち合わせ",
                    "企画", "予算", "進捗", "品質", "顧客対応",
                    "市場調査", "競合分析", "戦略", "評価", "研修"
                ]
            };
            
            // 各カテゴリーから均等に選択（合計240個）
            Object.entries(categories).forEach(([category, texts]) => {
                texts.forEach(text => {
                    // 各テキストを3回ずつ、異なるコンテキストで使用
                    samples.push(text);
                    samples.push(`${text}について考える`);
                    samples.push(`${text}の段階に入る`);
                });
            });
            
            // ランダム性テスト用の追加テキスト（60個）
            const randomPhrases = [
                "今日の天気", "明日の予定", "来週の計画", "先月の振り返り", "年間目標",
                "四半期レビュー", "月次報告", "週次ミーティング", "日次確認", "時間管理",
                "プロジェクト", "タスク", "アクション", "フォローアップ", "レビュー"
            ];
            
            randomPhrases.forEach(phrase => {
                for (let i = 0; i < 4; i++) {
                    samples.push(`${phrase}${i + 1}`);
                }
            });
            
            // 配列をシャッフル（決定論的）
            for (let i = samples.length - 1; i > 0; i--) {
                const j = (i * 7) % (i + 1);
                [samples[i], samples[j]] = [samples[j], samples[i]];
            }
            
            return samples.slice(0, 300); // 正確に300サンプル
        }
        
        async function runPhaseETest() {
            const statusEl = document.getElementById('status');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const resultsEl = document.getElementById('results');
            
            try {
                statusEl.innerHTML = '<span class="warning">TextTo384LinesBridge初期化中...</span>';
                const bridge = new TextTo384LinesBridge();
                await bridge.initialize();
                
                // lineUsageCountをリセット
                bridge.lineUsageCount = {};
                
                statusEl.innerHTML = '<span class="info">E-6～E-10テスト実行中（300サンプル）...</span>';
                progressContainer.style.display = 'block';
                
                const samples = generatePhaseESamples();
                const results = {
                    uniqueLines: new Set(),
                    lineUsage: new Map(),
                    positionCount: [0, 0, 0, 0, 0, 0, 0], // 7は用九・用六
                    specialLines: { 385: 0, 386: 0 },
                    processingTimes: [],
                    totalSamples: samples.length
                };
                
                // テスト実行
                for (let i = 0; i < samples.length; i++) {
                    const text = samples[i];
                    const startTime = performance.now();
                    const result = await bridge.analyzeText(text);
                    const processingTime = performance.now() - startTime;
                    
                    results.processingTimes.push(processingTime);
                    
                    const lineId = result.line_384_id;
                    results.uniqueLines.add(lineId);
                    results.lineUsage.set(lineId, (results.lineUsage.get(lineId) || 0) + 1);
                    
                    // 位置別カウント
                    if (lineId === 385 || lineId === 386) {
                        results.positionCount[6]++;
                        results.specialLines[lineId]++;
                    } else {
                        const position = result.line_position;
                        if (position <= 6) {
                            results.positionCount[position - 1]++;
                        }
                    }
                    
                    // プログレスバー更新
                    if ((i + 1) % 10 === 0) {
                        const progress = ((i + 1) / samples.length * 100);
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${i + 1}/${samples.length}`;
                    }
                }
                
                // 結果分析
                const coverageRate = (results.uniqueLines.size / 384) * 100;
                const targetRate = 13; // E目標
                const success = coverageRate >= targetRate;
                
                let html = '';
                
                // メトリクスカード
                html += '<div class="metric-grid">';
                
                // E-6: カバー率
                html += `<div class="metric-card">
                    <div class="info">カバー率</div>
                    <div class="metric-value ${success ? 'success' : 'error'}">${coverageRate.toFixed(2)}%</div>
                    <div>${success ? '✅ 目標達成!' : `❌ あと${(targetRate - coverageRate).toFixed(2)}%`}</div>
                </div>`;
                
                // E-7: ユニーク爻数
                html += `<div class="metric-card">
                    <div class="info">ユニーク爻数</div>
                    <div class="metric-value ${results.uniqueLines.size >= 50 ? 'success' : 'warning'}">${results.uniqueLines.size}/384</div>
                    <div>目標: ≥50個</div>
                </div>`;
                
                // E-8: 平均処理時間
                const avgTime = results.processingTimes.reduce((a, b) => a + b, 0) / results.processingTimes.length;
                html += `<div class="metric-card">
                    <div class="info">平均処理時間</div>
                    <div class="metric-value ${avgTime < 50 ? 'success' : 'warning'}">${avgTime.toFixed(1)}ms</div>
                    <div>目標: <50ms</div>
                </div>`;
                
                // E-9: 用九・用六使用
                const specialUsage = results.specialLines[385] + results.specialLines[386];
                html += `<div class="metric-card">
                    <div class="info">特殊爻使用</div>
                    <div class="metric-value ${specialUsage > 0 ? 'success' : 'error'}">${specialUsage}回</div>
                    <div>用九:${results.specialLines[385]} 用六:${results.specialLines[386]}</div>
                </div>`;
                
                html += '</div>';
                
                // E-10: カバレッジビジュアル
                html += '<div class="result-box">';
                html += '<h3>📊 E-10: カバレッジビジュアル（384爻の使用状況）</h3>';
                html += '<div class="coverage-visual">';
                for (let i = 1; i <= 384; i++) {
                    const usage = results.lineUsage.get(i) || 0;
                    let className = 'line-dot';
                    if (usage === 0) className += '';
                    else if (usage === 1) className += ' rare';
                    else if (usage <= 3) className += ' used';
                    else className += ' overused';
                    html += `<div class="${className}" title="爻${i}: ${usage}回"></div>`;
                }
                html += '</div>';
                html += '<div style="margin-top: 10px;">';
                html += '<span class="info">● 未使用</span> ';
                html += '<span class="info" style="color: #569cd6;">● 1回</span> ';
                html += '<span class="success">● 2-3回</span> ';
                html += '<span class="warning">● 4回以上</span>';
                html += '</div></div>';
                
                // タスク達成状況
                html += '<div class="result-box">';
                html += '<h3>✅ E タスク達成状況</h3>';
                
                const tasks = [
                    { id: 'E-1', desc: '現状分析実施', done: true },
                    { id: 'E-2', desc: '未使用爻パターン特定', done: true },
                    { id: 'E-3', desc: '追加ノイズパラメータ設計', done: true },
                    { id: 'E-4', desc: '動的閾値調整実装', done: true },
                    { id: 'E-5', desc: '用九・用六条件緩和', done: true },
                    { id: 'E-6', desc: `カバー率測定（${coverageRate.toFixed(2)}%）`, done: success },
                    { id: 'E-7', desc: `ユニーク爻確認（${results.uniqueLines.size}個）`, done: results.uniqueLines.size >= 50 },
                    { id: 'E-8', desc: `処理速度確認（${avgTime.toFixed(1)}ms）`, done: avgTime < 50 },
                    { id: 'E-9', desc: `特殊爻使用確認（${specialUsage}回）`, done: specialUsage > 0 },
                    { id: 'E-10', desc: 'ビジュアル分析完了', done: true }
                ];
                
                tasks.forEach(task => {
                    const statusIcon = task.done ? '✅' : '❌';
                    const statusClass = task.done ? 'task-complete' : 'task-pending';
                    html += `<div class="task-status ${statusClass}">${statusIcon} ${task.id}: ${task.desc}</div>`;
                });
                
                const completedTasks = tasks.filter(t => t.done).length;
                const totalSuccess = completedTasks === tasks.length;
                
                html += `<div style="margin-top: 15px; font-size: 18px;">`;
                html += `完了: ${completedTasks}/10 タスク`;
                if (totalSuccess) {
                    html += '<span class="success"> - Phase E 完全達成！🎉</span>';
                } else if (success) {
                    html += '<span class="success"> - カバー率目標達成！</span>';
                } else {
                    html += '<span class="warning"> - 追加調整が必要</span>';
                }
                html += '</div></div>';
                
                // 詳細統計
                html += '<div class="result-box">';
                html += '<h3>📈 詳細統計</h3>';
                html += '<pre>';
                
                // 未使用・低使用・過使用の分析
                let unusedCount = 0;
                let rareCount = 0;
                let overusedCount = 0;
                
                for (let i = 1; i <= 384; i++) {
                    const usage = results.lineUsage.get(i) || 0;
                    if (usage === 0) unusedCount++;
                    else if (usage === 1) rareCount++;
                    else if (usage > 5) overusedCount++;
                }
                
                html += `未使用爻: ${unusedCount}個 (${(unusedCount/384*100).toFixed(1)}%)\n`;
                html += `低使用爻（1回）: ${rareCount}個 (${(rareCount/384*100).toFixed(1)}%)\n`;
                html += `過使用爻（6回以上）: ${overusedCount}個\n`;
                html += '\n位置別分布:\n';
                
                results.positionCount.slice(0, 6).forEach((count, idx) => {
                    const percentage = (count / results.totalSamples * 100).toFixed(1);
                    const bar = '█'.repeat(Math.round(percentage / 2));
                    html += `${idx + 1}爻: ${count.toString().padStart(3)}個 (${percentage.padStart(5)}%) ${bar}\n`;
                });
                
                if (specialUsage > 0) {
                    html += `特殊: ${specialUsage.toString().padStart(3)}個 (${(specialUsage / results.totalSamples * 100).toFixed(1)}%)\n`;
                }
                
                html += '</pre></div>';
                
                // 改善提案
                if (!totalSuccess) {
                    html += '<div class="result-box">';
                    html += '<h3>💡 改善提案</h3>';
                    html += '<pre>';
                    
                    const suggestions = [];
                    
                    if (coverageRate < targetRate) {
                        suggestions.push(`カバー率向上: 未使用爻ボーナスを0.15→0.20に増加`);
                        suggestions.push(`探索ノイズの範囲を0.2→0.25に拡大`);
                    }
                    
                    if (unusedCount > 300) {
                        suggestions.push(`未使用爻が多い: 動的閾値をより積極的に調整`);
                    }
                    
                    if (overusedCount > 5) {
                        suggestions.push(`過使用爻抑制: 4回目以降のペナルティをさらに強化`);
                    }
                    
                    if (avgTime > 50) {
                        suggestions.push(`処理速度改善: キャッシュサイズを50→100に増加`);
                    }
                    
                    suggestions.forEach((s, i) => {
                        html += `${i + 1}. ${s}\n`;
                    });
                    
                    html += '</pre></div>';
                }
                
                resultsEl.innerHTML = html;
                statusEl.innerHTML = totalSuccess ? 
                    '<span class="success">✅ Phase E 完全達成！</span>' :
                    '<span class="warning">⚠️ テスト完了（一部タスク未達成）</span>';
                progressContainer.style.display = 'none';
                
            } catch (error) {
                statusEl.innerHTML = `<span class="error">エラー: ${error.message}</span>`;
                console.error(error);
            }
        }
        
        runPhaseETest();
    </script>
</body>
</html>