<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>小規模バッチテスト - 修正検証</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff; 
        }
        .test-section { 
            margin: 20px 0; 
            padding: 15px; 
            border: 1px solid #444; 
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .valid { background-color: rgba(16, 185, 129, 0.2); }
        .invalid { background-color: rgba(239, 68, 68, 0.2); }
    </style>
</head>
<body>
    <h1>🔧 小規模バッチテスト - 修正版検証</h1>
    <p>修正されたvalidateCombinationメソッドの動作確認</p>

    <div class="test-section">
        <h3>単発テスト</h3>
        <button onclick="testSingle()">1-1-1 パターンテスト</button>
        <button onclick="testMultiple()">最初の10パターンテスト</button>
        <div id="single-results"></div>
    </div>

    <div class="test-section">
        <h3>小規模バッチテスト (100パターン)</h3>
        <button onclick="testSmallBatch()">100パターン検証実行</button>
        <div id="batch-results"></div>
    </div>

    <script src="./public/assets/H384H64database.js"></script>
    <script src="./public/js/core/TripleOSInteractionAnalyzer.js"></script>
    <script src="./complete-validation-system.js"></script>
    <script>
        let validator = new CompleteValidationSystem();
        
        function testSingle() {
            const results = document.getElementById('single-results');
            results.innerHTML = '<p>テスト実行中...</p>';
            
            try {
                validator.initialize();
                const result = validator.validateCombination(1, 1, 1);
                
                const className = result.isValid ? 'valid' : 'invalid';
                const status = result.isValid ? '✅ 正常' : '❌ 問題';
                
                results.innerHTML = `
                    <div class="result ${className}">
                        <h4>${status}: パターン 1-1-1 (乾為天×3)</h4>
                        <p>Total Synergy: ${result.totalSynergy}</p>
                        <p>Category: ${result.overallCategory}</p>
                        <p>Checks: ${JSON.stringify(result.checks, null, 2)}</p>
                        ${!result.isValid ? `<p>Error: ${result.error}</p>` : ''}
                    </div>
                `;
            } catch (error) {
                results.innerHTML = `<div class="result invalid">❌ エラー: ${error.message}</div>`;
            }
        }
        
        function testMultiple() {
            const results = document.getElementById('single-results');
            results.innerHTML = '<p>10パターンテスト実行中...</p>';
            
            try {
                validator.initialize();
                let html = '<h4>最初の10パターンテスト結果:</h4>';
                
                for (let i = 0; i < 10; i++) {
                    const engineId = Math.floor(i / (64 * 64)) + 1;
                    const interfaceId = Math.floor((i % (64 * 64)) / 64) + 1;
                    const safeModeId = (i % 64) + 1;
                    
                    const result = validator.validateCombination(engineId, interfaceId, safeModeId);
                    const className = result.isValid ? 'valid' : 'invalid';
                    const status = result.isValid ? '✅' : '❌';
                    
                    html += `
                        <div class="result ${className}" style="margin: 5px 0; padding: 5px;">
                            ${status} ${engineId}-${interfaceId}-${safeModeId}: 
                            ${result.overallCategory} (${result.totalSynergy?.toFixed(3) || 'ERROR'})
                        </div>
                    `;
                }
                
                results.innerHTML = html;
            } catch (error) {
                results.innerHTML = `<div class="result invalid">❌ エラー: ${error.message}</div>`;
            }
        }
        
        async function testSmallBatch() {
            const results = document.getElementById('batch-results');
            results.innerHTML = '<p>100パターンバッチテスト実行中...</p>';
            
            try {
                validator.initialize();
                const batchResults = await validator.validateBatch(0, 100);
                
                const validCount = batchResults.filter(r => r.isValid).length;
                const invalidCount = batchResults.filter(r => !r.isValid).length;
                
                let html = `
                    <h4>100パターンバッチテスト結果:</h4>
                    <p>✅ 正常: ${validCount}/100</p>
                    <p>❌ 問題: ${invalidCount}/100</p>
                    <p>成功率: ${(validCount/100*100).toFixed(1)}%</p>
                    <h5>詳細 (最初の20件):</h5>
                `;
                
                batchResults.slice(0, 20).forEach(result => {
                    const className = result.isValid ? 'valid' : 'invalid';
                    const status = result.isValid ? '✅' : '❌';
                    
                    html += `
                        <div class="result ${className}" style="margin: 2px 0; padding: 3px; font-size: 12px;">
                            ${status} ${result.combination}: 
                            ${result.overallCategory} (${result.totalSynergy?.toFixed(3) || 'ERROR'})
                        </div>
                    `;
                });
                
                if (batchResults.length > 20) {
                    html += `<p>... (他 ${batchResults.length - 20} 件)</p>`;
                }
                
                results.innerHTML = html;
            } catch (error) {
                results.innerHTML = `<div class="result invalid">❌ エラー: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>