import { readFile, writeFile } from 'fs/promises';

async function fixFinalShortTexts() {
  try {
    console.log('=== 最終的な短い説明文の修正 ===\n');
    
    // データベース読み込み
    let content = await readFile('./public/js/data/hexagram-human-traits-v3.js', 'utf-8');
    
    // バックアップ作成
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    await writeFile(`./public/js/data/hexagram-human-traits-v3.backup.final.${timestamp}.js`, content);
    console.log(`📁 バックアップ作成: hexagram-human-traits-v3.backup.final.${timestamp}.js\n`);
    
    // 64卦の名前（これらは絶対に変更しない）
    const hexagramNames = new Set([
      '乾為天', '坤為地', '水雷屯', '山水蒙', '水天需', '天水訟', '地水師', '水地比',
      '風天小畜', '天澤履', '地天泰', '天地否', '天火同人', '火天大有', '地山謙', '雷地豫',
      '澤雷随', '山風蠱', '地澤臨', '風地観', '火雷噬嗑', '山火賁', '山地剥', '地雷復',
      '天雷無妄', '山天大畜', '山雷頤', '澤風大過', '坎為水', '離為火', '澤山咸', '雷風恒',
      '天山遯', '雷天大壮', '火地晋', '地火明夷', '風火家人', '火澤睽', '水山蹇', '雷水解',
      '山澤損', '風雷益', '澤天夬', '天風姤', '澤地萃', '地風升', '澤水困', '水風井',
      '澤火革', '火風鼎', '震為雷', '艮為山', '風山漸', '雷澤帰妹', '雷火豊', '火山旅',
      '巽為風', '兌為澤', '風水渙', '水澤節', '風澤中孚', '雷山小過', '水火既済', '火水未済'
    ]);
    
    // 最終修正リスト
    const fixes = [
      // 残りの2文字
      { old: '"地火"', new: '"地と火が明夷する暗闇"' },
      { old: '"風澤"', new: '"風と澤が中孚する信頼"' },
      
      // 残りの3文字役割名
      { old: '"美化者"', new: '"美しく飾る美化者"' },
      { old: '"現実者"', new: '"現実を見据える実践者"' },
      { old: '"剥離者"', new: '"不要を剥離する変革者"' },
      { old: '"漸進者"', new: '"着実に漸進する前進者"' },
      { old: '"達成者"', new: '"目標を達成する実現者"' },
      { old: '"未完者"', new: '"未完を続ける探求者"' },
      { old: '"革新者"', new: '"新しく革新する創造者"' },
      { old: '"安定者"', new: '"安定を保つ維持者"' },
      { old: '"困窮者"', new: '"困窮を乗り越える挑戦者"' },
      { old: '"井戸人"', new: '"恵みを与える井戸人"' },
      { old: '"革命者"', new: '"変革を起こす革命者"' },
      { old: '"鼎立者"', new: '"調和を鼎立する創造者"' },
      { old: '"震動者"', new: '"震動を起こす変革者"' },
      { old: '"不動者"', new: '"不動の強さを持つ者"' },
      { old: '"巽風者"', new: '"巽風のように浸透する者"' },
      { old: '"兌澤者"', new: '"兌澤の喜びを分かつ者"' },
      
      // 残りの4文字
      { old: '"出会い人"', new: '"運命的な出会いを作る人"' },
      { old: '"縁切り型"', new: '"不要な縁を切る決断型"' },
      { old: '"提供者型"', new: '"資源を提供する支援型"' },
      { old: '"影響力型"', new: '"強い影響力を持つ型"' },
      { old: '"調整役型"', new: '"全体を調整する役割型"' },
      
      // 残りの5文字タイプ名
      { old: '"全体最適型"', new: '"全体最適を実現する調整型"' },
      { old: '"楽観逃避型"', new: '"楽観的に逃避する回避型"' },
      { old: '"流動回避型"', new: '"流動的に回避する柔軟型"' },
      { old: '"問題指摘型"', new: '"問題を指摘する分析型"' },
      { old: '"静観防御型"', new: '"静観して防御する慎重型"' },
      { old: '"高所回避型"', new: '"高所から回避する俯瞰型"' },
      { old: '"即断突破型"', new: '"即断で突破する決断型"' },
      { old: '"美化逃避型"', new: '"美化して逃避する防御型"' },
      { old: '"撤退縮小型"', new: '"撤退し縮小する防御型"' },
      { old: '"復活再起型"', new: '"復活し再起する回復型"' },
      { old: '"素直表現型"', new: '"素直に表現する率直型"' },
      { old: '"無垢防御型"', new: '"無垢で防御する純粋型"' },
      { old: '"知識提供型"', new: '"知識を提供する教育型"' },
      { old: '"知識武装型"', new: '"知識で武装する理論型"' },
      { old: '"挑発刺激型"', new: '"挑発し刺激する行動型"' },
      { old: '"賭け突破型"', new: '"賭けて突破する冒険型"' },
      { old: '"柔軟対応型"', new: '"柔軟に対応する適応型"' },
      { old: '"流体回避型"', new: '"流体のように回避する型"' },
      { old: '"熱血伝道型"', new: '"熱血で伝道する情熱型"' },
      { old: '"段階的指導型"', new: '"段階的に指導する教育型"' },
      { old: '"豊かさ分配型"', new: '"豊かさを分配する共有型"' },
      { old: '"可能性追求型"', new: '"可能性を追求する探求型"' },
      
      // 環境名の修正
      { old: '"冷めた環境"', new: '"情熱の冷めた停滞的な環境"' },
      { old: '"欠乏的な環境"', new: '"資源が欠乏した困窮的な環境"' },
      { old: '"束縛的な環境"', new: '"自由を束縛する制限的な環境"' },
      
      // エンジン名の追加修正
      { old: '"問題解決エンジン"', new: '"問題を解決する実践的な原動力"' },
      { old: '"全体俯瞰エンジン"', new: '"全体を俯瞰する戦略的な力"' },
      { old: '"即断即決エンジン"', new: '"即断即決で進める決断力"' },
      { old: '"美的創造エンジン"', new: '"美的に創造する芸術的な力"' },
      { old: '"復活再生エンジン"', new: '"復活し再生する回復の力"' },
      { old: '"純粋直感エンジン"', new: '"純粋な直感による洞察力"' },
      { old: '"健康維持エンジン"', new: '"健康を維持する生命力"' },
      { old: '"限界突破エンジン"', new: '"限界を突破する挑戦的な力"' },
      { old: '"流動適応エンジン"', new: '"流動的に適応する柔軟な力"' },
      { old: '"情熱燃焼エンジン"', new: '"情熱を燃焼させる熱い原動力"' },
      { old: '"感応共鳴エンジン"', new: '"感応し共鳴する感情的な力"' },
      { old: '"持続継続エンジン"', new: '"持続的に継続する恒久的な力"' },
      
      // 短い説明文の拡張
      { old: '"批判を受け流す"', new: '"批判を上手に受け流す柔軟性"' },
      { old: '"後退と見られる"', new: '"後退と見られるが戦略的な撤退"' },
      { old: '"関係改善の成功"', new: '"関係改善に成功する調整力"' },
      { old: '"支援を得やすい"', new: '"周囲から支援を得やすい人徳"' },
      { old: '"自立性に欠ける"', new: '"自立性に欠ける依存的な傾向"' },
      { old: '"関係修復と共に"', new: '"関係修復と共に成長する力"' },
      { old: '"関係性の再構築"', new: '"関係性を再構築する修復力"' },
      { old: '"種まきと土作り"', new: '"種まきと土作りから始める基礎力"' },
      { old: '"質も量も大切に"', new: '"質も量も大切にする完璧主義"' },
      { old: '"浪費的に見える"', new: '"浪費的に見えるが価値ある投資"' },
      { old: '"次の収穫を待つ"', new: '"次の収穫を待つ忍耐強さ"' },
      { old: '"定着、深い関係"', new: '"定着して深い関係を築く力"' },
      { old: '"新しい風を運ぶ"', new: '"新しい風を運ぶ革新的な力"' },
      { old: '"旅先での出会い"', new: '"旅先での出会いを大切にする心"' },
      { old: '"流れを読む時間"', new: '"流れを読む時間を持つ洞察力"' },
      { old: '"浸透できる隙間"', new: '"浸透できる隙間を見つける観察力"' },
      { old: '"影が薄いことも"', new: '"影が薄いこともあるが重要な存在"' }
    ];
    
    // 修正を適用
    let totalFixCount = 0;
    const appliedFixes = [];
    
    console.log('最終修正を適用中...\n');
    
    for (const fix of fixes) {
      // 卦名と完全一致する場合はスキップ
      const cleanText = fix.old.replace(/"/g, '');
      if (hexagramNames.has(cleanText)) {
        console.log(`⏭️ スキップ（卦名）: ${fix.old}`);
        continue;
      }
      
      const regex = new RegExp(fix.old.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      const matches = content.match(regex);
      if (matches) {
        content = content.replace(regex, fix.new);
        totalFixCount += matches.length;
        appliedFixes.push({
          old: fix.old,
          new: fix.new,
          count: matches.length
        });
        console.log(`✅ ${fix.old} → ${fix.new} (${matches.length}箇所)`);
      }
    }
    
    // ファイル保存
    await writeFile('./public/js/data/hexagram-human-traits-v3.js', content);
    
    console.log(`\n=== 修正完了 ===`);
    console.log(`総修正件数: ${totalFixCount}件`);
    console.log(`修正項目数: ${appliedFixes.length}種類`);
    
    console.log('\n📝 修正済みファイル: ./public/js/data/hexagram-human-traits-v3.js');
    console.log(`📁 バックアップ: hexagram-human-traits-v3.backup.final.${timestamp}.js`);
    
  } catch (error) {
    console.error('エラー:', error);
  }
}

fixFinalShortTexts();