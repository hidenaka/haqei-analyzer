'use strict';

const fs = require('fs');
const path = require('path');

function loadJSON(p) { return JSON.parse(fs.readFileSync(p, 'utf8')); }
function saveJSON(p, obj) { fs.writeFileSync(p, JSON.stringify(obj, null, 2), 'utf8'); }

function main() {
  const file = path.resolve(__dirname, '..', 'public', 'data', 'narratives_chain.v1.json');
  const db = loadJSON(file);
  
  // 乾為天 九四
  const baseKey = '乾為天 九四 | ';
  const updates = {
    JJJ: {
      chain_long:
        'まず、跳躍の直前で一度立ち止まります。タイミングを読み、風向きを確かめながら、力を内に蓄えます。' +
        '続いて、慎重に見極めを続けます。焦る気持ちを抑え、最適な瞬間を待ちながら、準備を整えます。' +
        '最後に、静かな確信が育ちます。飛ぶべき時が近づいているのを感じながら、最後の調整を行います。' +
        '突破口は、待つ勇気にあります。まずは判断基準を明確にし、機が熟すまで力を温存しましょう。',
      suitability: '大きな決断や転換を控え、タイミングを見極めたい場面',
      caution: '待ちすぎて機会を逸しないよう、期限を設定する',
      label: '一貫深化 （テーマ継続）'
    },
    JJH: {
      chain_long:
        'まず、飛躍への準備を進めます。必要な道具を揃え、手順を確認しながら、基盤を固めます。' +
        '続いて、もう一段準備を深めます。細部まで点検し、不安要素を一つずつ潰していきます。' +
        '最後に、視点を切り替えます。準備から実行へ、計画から行動へと意識をシフトさせます。' +
        '突破口は、準備完了後の決断にあります。まずは成功基準を定め、勇気を持って一歩を踏み出しましょう。',
      suitability: '十分な準備の後、実行に移すタイミングを計る場面',
      caution: '完璧を求めすぎて、行動が遅れないよう注意',
      label: '二段深化→視点切替 （構造転換）'
    },
    JHJ: {
      chain_long:
        'まず、跳躍の構えを作ります。体勢を低くし、エネルギーを溜めながら、方向を定めます。' +
        '次に、視点を切り替えます。内側から外側へ、自分から環境へと意識を広げます。' +
        '最後に、その視点で再び深めます。環境との調和を図りながら、最適な跳躍角度を見つけます。' +
        '突破口は、内と外の調和にあります。まずは環境を読み、自分の力と合わせて最適解を導きましょう。',
      suitability: '自己と環境のバランスを取りながら前進したい場面',
      caution: '環境に流されすぎて、自分の軸を失わないよう注意',
      label: '深化→視点切替→再深化 （構造転換）'
    },
    JHH: {
      chain_long:
        'まず、跳躍への助走を始めます。小さな一歩から始め、徐々にスピードを上げていきます。' +
        '続いて、視点を切り替えます。直線的な進路から、曲線的な軌道へと発想を変えます。' +
        '最後に、さらに視点を変えます。個人の跳躍から、全体の流れへと意識を広げます。' +
        '突破口は、柔軟な軌道修正にあります。まずは複数のシナリオを用意し、状況に応じて選択しましょう。',
      suitability: '状況の変化に応じて、柔軟に方向を調整したい場面',
      caution: '方向転換が多すぎて、エネルギーを消耗しないよう注意',
      label: '初動深化→連続切替 （再整流）'
    },
    HJJ: {
      chain_long:
        'まず、今までの跳び方を見直します。癖や偏りに気づき、新しいフォームを試みます。' +
        '続いて、新しい型で深めます。違和感が薄れ、自然な動きへと変わっていきます。' +
        '最後に、さらに磨きをかけます。無駄が削ぎ落とされ、美しい跳躍へと昇華します。' +
        '突破口は、型の再構築にあります。まずは基本に立ち返り、一から組み立て直してみましょう。',
      suitability: '従来の方法を見直し、より効果的な方法を確立したい場面',
      caution: '新しい型に固執しすぎて、状況適応力を失わないよう注意',
      label: '視点切替→二段深化 （構造転換）'
    },
    HJH: {
      chain_long:
        'まず、跳躍の概念を変えます。上への跳躍から、前への跳躍へと発想を転換します。' +
        '次に、その新しい視点で練習します。水平方向への推進力を高め、滑空の感覚を掴みます。' +
        '最後に、再び視点を変えます。個の跳躍から、連携の跳躍へと次元を上げます。' +
        '突破口は、次元の転換にあります。まずは固定観念を捨て、新しい可能性を探ってみましょう。',
      suitability: '従来の枠組みを超えて、新しい次元で考えたい場面',
      caution: '抽象的になりすぎて、実践可能性を失わないよう注意',
      label: '視点切替→深化→再切替 （構造転換）'
    },
    HHJ: {
      chain_long:
        'まず、跳び方を変えます。次に、着地点を変えます。二度の変更で、軌道が大きく変わります。' +
        '最後に、新しい軌道で深めます。予想外の景色が見え、新たな可能性が開けます。' +
        '突破口は、常識からの解放にあります。まずは「できない」という思い込みを外し、自由に発想しましょう。',
      suitability: '既成概念を打破し、革新的なアプローチを試したい場面',
      caution: 'リスクが高まるため、セーフティネットを用意する',
      label: '連続切替→深化 （再設計）'
    },
    HHH: {
      chain_long:
        'まず、跳躍を忘れます。続いて、地面を忘れます。最後に、重力を忘れます。' +
        '三度の忘却で、全く新しい移動の概念が生まれます。制約から自由になり、想像を現実に変えていきます。' +
        '突破口は、根本的な再定義にあります。まずは問題設定から見直し、全く違う解法を探しましょう。',
      suitability: 'パラダイムシフトや根本的な発想転換が必要な場面',
      caution: '現実離れしすぎないよう、実現可能性を常に検証する',
      label: '三段転換 （完全再設計）'
    }
  };

  for (const pat of Object.keys(updates)) {
    const k = baseKey + pat;
    if (!db[k]) {
      console.log(`Creating new entry: ${k}`);
      db[k] = {
        tone: 'story',
        start: { hex: '乾為天', pos: 4 },
        final: {}
      };
    }
    Object.assign(db[k], updates[pat], { updated_at: new Date().toISOString() });
  }

  // finalの計算（九四から3回の変化）
  // JJJ = 3回進爻 → pos 7は用九
  db['乾為天 九四 | JJJ'].final = { hex: '乾為天', pos: 7 };
  // JJH = 2回進爻、1回変爻 → pos 6で変爻
  db['乾為天 九四 | JJH'].final = { hex: '天風姤', pos: 6 };
  // JHJ = 進爻→変爻→進爻
  db['乾為天 九四 | JHJ'].final = { hex: '天火同人', pos: 6 };
  // JHH = 進爻→変爻→変爻
  db['乾為天 九四 | JHH'].final = { hex: '乾為天', pos: 5 };
  // HJJ = 変爻→進爻→進爻
  db['乾為天 九四 | HJJ'].final = { hex: '風天小畜', pos: 6 };
  // HJH = 変爻→進爻→変爻
  db['乾為天 九四 | HJH'].final = { hex: '天雷無妄', pos: 5 };
  // HHJ = 変爻→変爻→進爻
  db['乾為天 九四 | HHJ'].final = { hex: '風天小畜', pos: 5 };
  // HHH = 3回変爻
  db['乾為天 九四 | HHH'].final = { hex: '風天小畜', pos: 4 };

  saveJSON(file, db);
  console.log('Updated 乾為天 九四 (8 patterns)');
}

main();