'use strict';

const fs = require('fs');
const path = require('path');

function loadJSON(p) { return JSON.parse(fs.readFileSync(p, 'utf8')); }
function saveJSON(p, obj) { fs.writeFileSync(p, JSON.stringify(obj, null, 2), 'utf8'); }

function main() {
  const file = path.resolve(__dirname, '..', 'public', 'data', 'narratives_chain.v1.json');
  const db = loadJSON(file);
  
  // 乾為天 九三
  const baseKey = '乾為天 九三 | ';
  const updates = {
    JJJ: {
      chain_long:
        'まず、責任の重みを受け止めながら、一つずつ片付けていきます。朝から晩まで手を動かし、緊張感を保ちながら基礎を積み上げます。' +
        '続いて、同じリズムでもう一段深めます。判断の精度が上がり、迷いの時間が短くなっていきます。' +
        '最後に、蓄えた力がじわりと形を成します。慎重さを保ったまま、次の段への土台が確かになります。' +
        '突破口は、忙しさの中でも節度を保つことにあります。まずは優先順位を明確にし、一つずつ確実に仕上げていきましょう。',
      suitability: '責任が増え、実務の精度と速度を両立させたい場面',
      caution: '過労と判断ミスを避けるため、定期的な休息を組み込む',
      label: '一貫深化 （テーマ継続）'
    },
    JJH: {
      chain_long:
        'まず、朝から晩まで動き続けながら、手順を体に染み込ませます。反復するほど、無駄な動きが削られていきます。' +
        '続いて、もう一段、同じ型を磨きます。危うさが減り、安定感が増していきます。' +
        '最後に、視点を切り替えます。自分の手元から、チーム全体の流れへと意識を広げると、新しい改善点が見えてきます。' +
        '突破口は、深めた後の視野拡大にあります。まずは周囲との連携を確認し、全体最適の観点から調整しましょう。',
      suitability: '個人の熟練から組織の効率化へ移行したい場面',
      caution: '視点を広げる際、自分の基本業務を疎かにしない',
      label: '二段深化→視点切替 （構造転換）'
    },
    JHJ: {
      chain_long:
        'まず、緊張感を保ちながら基本を固めます。一つの失敗も許されない中で、慎重に手順を確認します。' +
        '次に、観点を切り替えます。守りの姿勢から、攻めの姿勢へ。リスクを取る覚悟を決めます。' +
        '最後に、その新しい視点で深めます。大胆さと慎重さのバランスを取りながら、確実に前進します。' +
        '突破口は、守りから攻めへの転換にあります。まずはリスクを明確にし、対策を準備してから動きましょう。',
      suitability: '守勢から攻勢へ転じる転換点にある場面',
      caution: '攻めに転じる際、基本的な守りを忘れない',
      label: '深化→視点切替→再深化 （構造転換）'
    },
    JHH: {
      chain_long:
        'まず、日々の実務をこなしながら、改善点を見つけていきます。小さな気づきを積み重ねます。' +
        '続いて、観点を切り替えます。作業から仕組みへ、実行から設計へと重心を移します。' +
        '最後に、さらに視点を変えます。短期から長期へ、部分から全体へと視野を広げます。' +
        '突破口は、段階的な視野拡大にあります。まずは目の前の課題を整理し、徐々に大きな絵を描いていきましょう。',
      suitability: '実務レベルから戦略レベルへ思考を広げたい場面',
      caution: '抽象度を上げすぎて、具体性を失わないよう注意',
      label: '初動深化→連続切替 （再整流）'
    },
    HJJ: {
      chain_long:
        'まず、今までのやり方を見直します。慣れた手順に疑問を持ち、別の可能性を探ります。' +
        '続いて、新しい視点で深めます。違和感が消え、新しい型が手に馴染んでいきます。' +
        '最後に、さらに深めます。繰り返すほどに精度が上がり、新しい標準が確立されます。' +
        '突破口は、最初の勇気ある見直しにあります。まずは小さな実験から始め、効果を確認してから展開しましょう。',
      suitability: '既存の方法を疑い、新しい標準を作りたい場面',
      caution: '変更の影響範囲を事前に確認し、段階的に導入する',
      label: '視点切替→二段深化 （構造転換）'
    },
    HJH: {
      chain_long:
        'まず、立ち位置を変えます。実行者から観察者へ、内側から外側へと視点を移します。' +
        '次に、その視点で掘り下げます。見えなかった問題が浮かび上がり、解決の糸口が見つかります。' +
        '最後に、再び視点を変えます。分析から統合へ、理解から実践へと軸を戻します。' +
        '突破口は、観察と実践の往復にあります。まずは一歩引いて全体を見渡し、要点を押さえてから動きましょう。',
      suitability: '分析と実行を交互に行いながら改善したい場面',
      caution: '観察に時間をかけすぎて、実行が遅れないよう注意',
      label: '視点切替→深化→再切替 （構造転換）'
    },
    HHJ: {
      chain_long:
        'まず、視点を変えます。次に、もう一度変えます。二度の転換で、固定観念から自由になります。' +
        '最後に、開かれた視野のまま深めます。多角的な理解が統合され、本質が見えてきます。' +
        '突破口は、思考の柔軟性にあります。まずは先入観を脇に置き、白紙から考え直してみましょう。',
      suitability: '固定観念を打破し、革新的な解決策を見つけたい場面',
      caution: '発散しすぎて収束できなくならないよう、期限を設定する',
      label: '連続切替→深化 （再設計）'
    },
    HHH: {
      chain_long:
        'まず、視点を変えます。続いて、また変えます。最後に、三度目の転換を行います。' +
        '完全に新しい地平が開け、今までの制約が意味を失います。自由な発想で、ゼロから構築し直します。' +
        '突破口は、徹底的な再構築にあります。まずは理想の姿を描き、現実との差分を埋める計画を立てましょう。',
      suitability: '根本的な変革や破壊的イノベーションが必要な場面',
      caution: '変化が大きすぎて関係者がついてこれない可能性があるため、丁寧な説明と段階的な移行を心がける',
      label: '三段転換 （完全再設計）'
    }
  };

  for (const pat of Object.keys(updates)) {
    const k = baseKey + pat;
    if (!db[k]) {
      console.log(`Creating new entry: ${k}`);
      db[k] = {
        tone: 'story',
        start: { hex: '乾為天', pos: 3 },
        final: {} // This will be calculated based on the pattern
      };
    }
    Object.assign(db[k], updates[pat], { updated_at: new Date().toISOString() });
  }

  // 計算してfinalを設定（パターンに基づく）
  // JJJ = 3回進爻 → pos 6
  db['乾為天 九三 | JJJ'].final = { hex: '乾為天', pos: 6 };
  // JJH = 2回進爻、1回変爻 → pos 5で変爻
  db['乾為天 九三 | JJH'].final = { hex: '天風姤', pos: 5 };
  // JHJ = 進爻→変爻→進爻
  db['乾為天 九三 | JHJ'].final = { hex: '天火同人', pos: 5 };
  // JHH = 進爻→変爻→変爻
  db['乾為天 九三 | JHH'].final = { hex: '乾為天', pos: 4 };
  // HJJ = 変爻→進爻→進爻
  db['乾為天 九三 | HJJ'].final = { hex: '天澤履', pos: 5 };
  // HJH = 変爻→進爻→変爻
  db['乾為天 九三 | HJH'].final = { hex: '天雷無妄', pos: 4 };
  // HHJ = 変爻→変爻→進爻
  db['乾為天 九三 | HHJ'].final = { hex: '乾為天', pos: 4 };
  // HHH = 3回変爻
  db['乾為天 九三 | HHH'].final = { hex: '天澤履', pos: 3 };

  saveJSON(file, db);
  console.log('Updated 乾為天 九三 (8 patterns)');
}

main();