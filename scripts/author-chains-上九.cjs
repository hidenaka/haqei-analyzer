'use strict';

const fs = require('fs');
const path = require('path');

function loadJSON(p) { return JSON.parse(fs.readFileSync(p, 'utf8')); }
function saveJSON(p, obj) { fs.writeFileSync(p, JSON.stringify(obj, null, 2), 'utf8'); }

function main() {
  const file = path.resolve(__dirname, '..', 'public', 'data', 'narratives_chain.v1.json');
  const db = loadJSON(file);
  
  // 乾為天 上九
  const baseKey = '乾為天 上九 | ';
  const updates = {
    JJJ: {
      chain_long:
        'まず、頂点に立った後の難しさを感じ始めます。これ以上登る場所がなく、維持することの重さが肩にのしかかります。' +
        '続いて、高すぎる位置の孤独と向き合います。周囲との距離が開き、本音で話せる相手が減っていきます。' +
        '最後に、降りる準備を始めます。執着を手放し、次の段階への移行を受け入れる心の準備を整えます。' +
        '突破口は、頂点からの優雅な退き方にあります。まずは後進に道を譲る時期を見極め、美しく身を引きましょう。',
      suitability: '絶頂期を過ぎ、次の段階への移行を考える場面',
      caution: '高慢になって墜落しないよう、謙虚さを保つ',
      label: '一貫深化 （テーマ継続）'
    },
    JJH: {
      chain_long:
        'まず、極限まで上り詰めた実感を噛みしめます。達成感と同時に、これ以上がない虚しさも感じます。' +
        '続いて、その感覚をさらに深く味わいます。頂点の景色を記憶に刻み、経験を内面化していきます。' +
        '最後に、視点を転換します。上から下へ、獲得から手放しへと意識を切り替え、新しい価値を見出します。' +
        '突破口は、頂点での気づきにあります。まずは執着を手放し、別の山を探す勇気を持ちましょう。',
      suitability: '成功の頂点で次の目標を見つけたい場面',
      caution: '過去の栄光にしがみつかず、新しい挑戦を受け入れる',
      label: '二段深化→視点切替 （構造転換）'
    },
    JHJ: {
      chain_long:
        'まず、高みでの立ち位置を確認します。風当たりの強さを感じながら、バランスを保つ努力をします。' +
        '次に、見方を変えます。孤高から連携へ、独走から協調へと方向性を修正します。' +
        '最後に、その新しい視点で安定を図ります。周囲との距離を縮め、孤立から脱却していきます。' +
        '突破口は、孤高からの脱却にあります。まずは謙虚に手を差し伸べ、仲間を作ることから始めましょう。',
      suitability: '頂点での孤立を解消し、協調路線に転じたい場面',
      caution: 'プライドが邪魔をして、素直になれない可能性に注意',
      label: '深化→視点切替→再深化 （構造転換）'
    },
    JHH: {
      chain_long:
        'まず、頂点での限界を認識します。これ以上の上昇は物理的に不可能だという現実を受け入れます。' +
        '続いて、方向を変えます。垂直から水平へ、高さから広さへと拡張の方向を転換します。' +
        '最後に、さらに次元を変えます。物理的な高さから、精神的な深さへと価値の軸を移動させます。' +
        '突破口は、次元の転換にあります。まずは成功の定義を見直し、新しい価値基準を設定しましょう。',
      suitability: '物理的限界を超えて、別次元の成長を目指したい場面',
      caution: '抽象的になりすぎて、具体的な成果を見失わないよう注意',
      label: '初動深化→連続切替 （再整流）'
    },
    HJJ: {
      chain_long:
        'まず、頂点という概念を疑います。本当にここが頂点なのか、別の山があるのではないかと問い直します。' +
        '続いて、新しい視座で世界を眺めます。今まで見えなかった可能性が、次々と見えてきます。' +
        '最後に、その視座をさらに研ぎ澄まします。真の頂点への道筋が、明確に見えてきます。' +
        '突破口は、既成概念の打破にあります。まずは「頂点」の定義から見直し、より高い目標を設定しましょう。',
      suitability: '現在の成功に満足せず、さらなる高みを目指したい場面',
      caution: '永遠に満足できない状態に陥らないよう、節目を大切に',
      label: '視点切替→二段深化 （構造転換）'
    },
    HJH: {
      chain_long:
        'まず、高みから世界を俯瞰します。全体の構造と流れが、手に取るように見えてきます。' +
        '次に、その理解を深めます。表面的な動きの裏にある、本質的な法則を読み取ります。' +
        '最後に、視点を反転させます。上から見る視点から、下から支える視点へと転換します。' +
        '突破口は、支配から奉仕への転換にあります。まずは権力を手放し、貢献する喜びを見出しましょう。',
      suitability: '権力的立場から奉仕的立場へ転換したい場面',
      caution: '急激な転換で周囲を混乱させないよう、段階的に移行',
      label: '視点切替→深化→再切替 （構造転換）'
    },
    HHJ: {
      chain_long:
        'まず、頂点を手放します。次に、中腹まで降ります。二度の降下で、見える景色が変わります。' +
        '最後に、新しい位置で力を蓄えます。謙虚な立場から、より大きな影響力を発揮する準備を整えます。' +
        '突破口は、戦略的な後退にあります。まずは一歩引いて、より大きな跳躍のための助走距離を取りましょう。',
      suitability: '一時的に後退して、より大きな前進を図りたい場面',
      caution: '後退が敗北と見られないよう、意図を明確に伝える',
      label: '連続切替→深化 （再設計）'
    },
    HHH: {
      chain_long:
        'まず、龍になります。続いて、龍を超えます。最後に、形を失います。' +
        '三度の変容で、究極の自由に到達します。形にとらわれず、時空を超えて、永遠の理想を体現します。' +
        '突破口は、完全な解放にあります。まずはすべての執着を手放し、無限の可能性に身を委ねましょう。',
      suitability: '究極の境地や悟りの状態を目指したい場面',
      caution: '現実世界との接点を完全に失わないよう注意',
      label: '三段転換 （完全再設計）'
    }
  };

  for (const pat of Object.keys(updates)) {
    const k = baseKey + pat;
    if (!db[k]) {
      console.log(`Creating new entry: ${k}`);
      db[k] = {
        tone: 'story',
        start: { hex: '乾為天', pos: 6 },
        final: {}
      };
    }
    Object.assign(db[k], updates[pat], { updated_at: new Date().toISOString() });
  }

  // finalの計算（上九から3回の変化）
  // 上九からの進爻は序卦伝に従って次の卦へ
  db['乾為天 上九 | JJJ'].final = { hex: '坤為地', pos: 3 };
  db['乾為天 上九 | JJH'].final = { hex: '天地否', pos: 2 };
  db['乾為天 上九 | JHJ'].final = { hex: '天地否', pos: 2 };
  db['乾為天 上九 | JHH'].final = { hex: '坤為地', pos: 1 };
  db['乾為天 上九 | HJJ'].final = { hex: '天地否', pos: 2 };
  db['乾為天 上九 | HJH'].final = { hex: '天地否', pos: 1 };
  db['乾為天 上九 | HHJ'].final = { hex: '天地否', pos: 1 };
  db['乾為天 上九 | HHH'].final = { hex: '天地否', pos: 6 };

  saveJSON(file, db);
  console.log('Updated 乾為天 上九 (8 patterns)');
}

main();