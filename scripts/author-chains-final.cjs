'use strict';

const fs = require('fs');
const path = require('path');

function loadJSON(p) { return JSON.parse(fs.readFileSync(p, 'utf8')); }
function saveJSON(p, obj) { fs.writeFileSync(p, JSON.stringify(obj, null, 2), 'utf8'); }

const labels = {
  'JJJ': '一貫深化 （テーマ継続）',
  'JJH': '二段深化→視点切替 （構造転換）',
  'JHJ': '深化→視点切替→再深化 （構造転換）',
  'JHH': '初動深化→連続切替 （再整流）',
  'HJJ': '視点切替→二段深化 （構造転換）',
  'HJH': '視点切替→深化→再切替 （構造転換）',
  'HHJ': '連続切替→深化 （再設計）',
  'HHH': '三段転換 （完全再設計）'
};

// 坤為地の各爻に合わせた具体的な物語
const kunStories = {
  '六二': {
    'JHJ': 'まず、正しく四角く大きな道を歩み始めます。基本に忠実に、誠実な一歩を踏み出します。次に、歩き方を変えます。直線から曲線へ、硬さから柔らかさへと動きを調整します。最後に、その新しい歩みを深めます。リズムが生まれ、流れが良くなり、自然な前進が続きます。突破口は、柔軟な歩みにあります。まずは状況に応じて歩幅を調整し、無理のない進み方を見つけましょう。',
    'JHH': 'まず、まっすぐな道を進みます。迷いなく、疑いなく、信じた道を歩み続けます。続いて、進路を少し調整します。障害を避け、より良い道を探します。最後に、さらに微調整を加えます。完璧な軌道を描き、目標に向かって確実に進みます。突破口は、継続的な調整にあります。まずは大きな方向性を保ちながら、細かく修正しましょう。',
    'HJJ': 'まず、従来の正道を新しい角度から見直します。同じ道でも、見方を変えれば違う可能性が見えてきます。続いて、その新しい理解で深めます。実践を通じて検証し、より効果的な歩み方を見つけます。最後に、さらに磨きをかけます。無駄を削ぎ落とし、最も効率的な道筋を確立します。突破口は、視点の転換にあります。まずは固定観念を捨て、新しい可能性を探りましょう。',
    'HJH': 'まず、正道という概念を問い直します。本当の正しさとは何か、別の角度から考えます。次に、その理解で実践します。新しい基準で行動し、結果を観察します。最後に、再び視点を変えます。経験から学び、より高い次元での正道を見出します。突破口は、多角的な理解にあります。まずは一つの正解にとらわれず、状況に応じた最善を探しましょう。',
    'HHJ': 'まず、歩き方を変えます。次に、速度を変えます。二度の変更で、全く新しいリズムが生まれます。最後に、その新しいリズムで深めます。自然な流れが生まれ、疲れない歩みが実現します。突破口は、リズムの発見にあります。まずは自分に合ったペースを見つけ、それを維持しましょう。',
    'HHH': 'まず、道を変えます。続いて、歩き方を変えます。最後に、目的地を変えます。三度の変革で、旅そのものが全く新しいものになります。制約から自由になり、無限の可能性が開かれます。突破口は、完全な再定義にあります。まずはゴールから見直し、全く新しい道を切り開きましょう。'
  },
  '六三': {
    'JJH': 'まず、才能を内に秘めて進みます。目立たず、騒がず、しかし確実に実力を蓄えていきます。続いて、その蓄積がさらに深まります。表には出ない努力が、内側で大きな力となって育ちます。最後に、視点を切り替えます。内から外へ、蓄積から発揮へと転換し、適切な時期に才能を開花させます。突破口は、蓄積後の転換にあります。まずは力を蓄え、タイミングを見て発揮しましょう。',
    'JHJ': 'まず、内に秘めた才能を磨きます。人知れず努力を重ね、実力を高めていきます。次に、表現方法を変えます。直接的な主張から、間接的な貢献へと方法を転換します。最後に、その新しい方法で深めます。控えめながらも確実な貢献が、次第に認められていきます。突破口は、表現方法の工夫にあります。まずは自分に合った発信方法を見つけましょう。',
    'JHH': 'まず、静かに実力を蓄えます。焦らず、着実に、基礎を固めていきます。続いて、蓄え方を調整します。効率を上げ、質を高め、より深い学びを得ます。最後に、さらに方法を洗練させます。最小の努力で最大の成果を得る道を見つけます。突破口は、効率的な蓄積にあります。まずは無駄を省き、本質的な部分に集中しましょう。',
    'HJJ': 'まず、才能の隠し方を変えます。消極的な隠蔽から、戦略的な温存へと発想を転換します。続いて、その戦略を深めます。いつ、どこで、どのように発揮するか、綿密に計画します。最後に、さらに精度を上げます。最適なタイミングで、最大の効果を生む準備を整えます。突破口は、戦略的な才能管理にあります。まずは長期的な視点で、才能の活用計画を立てましょう。',
    'HJH': 'まず、内に秘めるという概念を見直します。隠すのではなく、育てるという視点に転換します。次に、その理解で実践します。内面の充実が、自然に外に現れるようになります。最後に、再び視点を変えます。個人の才能から、全体への貢献へと意識を広げます。突破口は、内と外の統合にあります。まずは内面を充実させ、それを自然に表現しましょう。',
    'HHJ': 'まず、隠し方を変えます。次に、育て方を変えます。二度の変更で、才能の扱い方が根本的に変わります。最後に、その新しい方法で集中します。効果的な才能開発が、予想を超える成果を生みます。突破口は、才能観の転換にあります。まずは才能を重荷ではなく、宝物として扱いましょう。',
    'HHH': 'まず、才能を再定義します。続いて、価値を再評価します。最後に、活用法を再発明します。三度の変革で、才能は全く新しい意味を持ちます。これまでの制約が消え、無限の可能性が開かれます。突破口は、根本的な再認識にあります。まずは才能の本質を問い直し、新しい活用法を創造しましょう。'
  },
  '六四': {
    'JJH': 'まず、袋を閉じるように、慎重に守りを固めます。余計なものを入れず、大切なものを守ります。続いて、その守りをさらに堅固にします。隙を作らず、しかし息苦しくならない程度に調整します。最後に、視点を切り替えます。守りから攻めへ、防御から展開へと転換する準備を始めます。突破口は、守りの後の転換にあります。まずは基盤を固め、機を見て動きましょう。',
    'JHJ': 'まず、守りの態勢を整えます。必要なものを内に収め、不要なものを外に出します。次に、守り方を変えます。硬い守りから、柔らかい守りへと転換します。最後に、その新しい守りを深めます。柔軟性が生まれ、状況に応じた対応が可能になります。突破口は、柔軟な守りにあります。まずは固さと柔らかさのバランスを見つけましょう。',
    'JHH': 'まず、慎重に守りを始めます。大切なものを確実に保護し、リスクを最小化します。続いて、守り方を調整します。状況の変化に応じて、防御線を修正します。最後に、さらに微調整を加えます。最適な守りの形を見つけ、安定を確保します。突破口は、適応的な守りにあります。まずは状況を見極め、柔軟に対応しましょう。',
    'HJJ': 'まず、守りという概念を見直します。消極的な防御から、積極的な保護へと発想を転換します。続いて、その新しい理解で深めます。守ることが、育てることにつながる方法を見つけます。最後に、さらに発展させます。守りが創造の土台となる仕組みを作ります。突破口は、守りの積極的な意味づけにあります。まずは守ることの価値を再認識しましょう。',
    'HJH': 'まず、袋の中身を別の角度から見ます。守るべきものの本質を問い直します。次に、その理解で実践します。本当に大切なものだけを選び、守ります。最後に、再び視点を変えます。守りから育成へ、保護から成長へと意識を転換します。突破口は、選択と集中にあります。まずは本当に守るべきものを見極めましょう。',
    'HHJ': 'まず、守り方を変えます。次に、守るものを変えます。二度の変更で、守りの意味が変わります。最後に、その新しい守りで深めます。創造的な保護が、新しい価値を生み出します。突破口は、守りの再定義にあります。まずは従来の守りを超えて、新しい保護の形を作りましょう。',
    'HHH': 'まず、袋を開きます。続いて、中身を入れ替えます。最後に、袋そのものを変えます。三度の変革で、守りは全く新しいものになります。制約が可能性に変わり、守りが創造の源となります。突破口は、根本的な転換にあります。まずは守りの概念から見直し、新しい価値を創造しましょう。'
  },
  '六五': {
    'JJH': 'まず、黄色い裳のような中庸の美を体現します。派手すぎず、地味すぎず、品位ある存在感を示します。続いて、その品位がさらに深まります。内面からの輝きが、自然な威厳となって現れます。最後に、視点を切り替えます。個人の徳から、全体への影響へと意識を広げます。突破口は、品位の自然な発露にあります。まずは内面を磨き、それが自然に外に現れるようにしましょう。',
    'JHJ': 'まず、中庸の美を追求します。極端を避け、バランスの取れた姿勢を保ちます。次に、表現方法を変えます。控えめな美から、積極的な調和へと転換します。最後に、その新しい表現を深めます。静かながらも確実な影響力が、周囲に広がっていきます。突破口は、静かな影響力にあります。まずは自らが調和の中心となりましょう。',
    'JHH': 'まず、品位を保ちながら進みます。威厳と親しみやすさのバランスを取ります。続いて、そのバランスを調整します。状況に応じて、威厳を強めたり、親しみやすさを増したりします。最後に、さらに微調整を加えます。完璧な調和を実現し、理想的な存在感を示します。突破口は、動的なバランスにあります。まずは状況を読み、適切な振る舞いを選びましょう。',
    'HJJ': 'まず、中庸という概念を新しく捉え直します。平均ではなく、最適という視点で理解します。続いて、その理解を深めます。各状況での最適な振る舞いを見つけ、実践します。最後に、さらに洗練させます。自然で無理のない、真の中庸を体現します。突破口は、状況適応的な中庸にあります。まずは固定的な中間点ではなく、動的な最適点を探しましょう。',
    'HJH': 'まず、黄色い裳の意味を問い直します。外見の美から、内面の徳へと理解を深めます。次に、その理解で実践します。内面の充実が、自然に外に現れます。最後に、再び視点を変えます。個人の徳から、集団の調和へと意識を広げます。突破口は、内外の一致にあります。まずは内面と外面の調和を図りましょう。',
    'HHJ': 'まず、美の基準を変えます。次に、表現方法を変えます。二度の変更で、全く新しい美が生まれます。最後に、その新しい美で深めます。独自の魅力が、強い影響力を持ちます。突破口は、美の再定義にあります。まずは既成の美意識を超えて、自分らしい美を追求しましょう。',
    'HHH': 'まず、形を超えます。続いて、色を超えます。最後に、美そのものを超えます。三度の超越で、究極の調和に到達します。外見を超えた本質的な美が、時代を超えて輝きます。突破口は、美の本質への到達にあります。まずは表面的な美を超えて、真の美を追求しましょう。'
  },
  '上六': {
    'JJH': 'まず、陰陽が激突する戦場に立ちます。対立の極致で、どちらも譲らない緊張が続きます。続いて、その対立がさらに深まります。傷つけ合い、消耗し合い、共に疲弊していきます。最後に、視点を切り替えます。対立から協調へ、戦いから和解へと方向を転換します。突破口は、対立からの脱却にあります。まずは戦いの無意味さを認識し、別の道を探しましょう。',
    'JHJ': 'まず、対立の中で立ち位置を確認します。なぜ戦うのか、何のための戦いなのかを問います。次に、戦い方を変えます。直接対決から、間接的な解決へと方法を転換します。最後に、その新しい方法を深めます。知恵を使った解決が、より良い結果をもたらします。突破口は、戦略の転換にあります。まずは力ではなく、知恵で解決する道を探しましょう。',
    'JHH': 'まず、慎重に対立に臨みます。感情的にならず、冷静に状況を分析します。続いて、対応を調整します。相手の出方を見ながら、柔軟に戦術を変えます。最後に、さらに調整を加えます。最小の犠牲で最大の成果を得る方法を見つけます。突破口は、柔軟な対応にあります。まずは硬直的な対立を避け、流動的に対処しましょう。',
    'HJJ': 'まず、対立という概念を見直します。敵対から、異なる立場の共存へと理解を転換します。続いて、その新しい理解を深めます。違いを認め合い、共存の道を探ります。最後に、さらに発展させます。対立が創造的な緊張となり、新しい価値を生みます。突破口は、対立の積極的な意味づけにあります。まずは対立を破壊ではなく、創造の機会と捉えましょう。',
    'HJH': 'まず、戦場を俯瞰します。より高い視点から、対立の全体像を把握します。次に、その理解で行動します。部分的な勝利ではなく、全体の調和を目指します。最後に、再び視点を変えます。現在から未来へ、短期から長期へと時間軸を広げます。突破口は、大局観にあります。まずは目先の勝敗にとらわれず、長期的な視点で判断しましょう。',
    'HHJ': 'まず、戦い方を変えます。次に、目的を変えます。二度の変更で、戦いの意味が変わります。最後に、その新しい意味で深めます。建設的な競争が、全体の発展につながります。突破口は、競争の質的転換にあります。まずは破壊的な競争から、創造的な競争へと転換しましょう。',
    'HHH': 'まず、敵を味方に変えます。続いて、戦いを協力に変えます。最後に、対立を統合に変えます。三度の変革で、戦場は創造の場となります。かつての敵が最高の協力者となり、新しい価値が生まれます。突破口は、対立の完全な転換にあります。まずは敵という概念を捨て、共に創造する仲間を見出しましょう。'
  },
  '用六': {
    'JJH': 'まず、永遠の貞節を保ちます。時代が変わっても、状況が変わっても、変わらない誠実さを貫きます。続いて、その一貫性が信頼を生みます。ぶれない姿勢が、多くの人の拠り所となっていきます。最後に、視点を転換します。個人の徳から、永遠の真理へと意識を高めます。突破口は、不変の価値の体現にあります。まずは自分の核となる価値観を確立し、それを貫きましょう。',
    'JHJ': 'まず、貞節の意味を深く理解します。表面的な一貫性ではなく、本質的な誠実さを追求します。次に、表現方法を変えます。硬直的な貞節から、柔軟な誠実さへと転換します。最後に、その新しい理解を深めます。状況に応じた最善を尽くすことが、真の貞節となります。突破口は、柔軟な誠実さにあります。まずは形式にとらわれず、本質を大切にしましょう。',
    'JHH': 'まず、永遠の道を歩み始めます。一歩一歩を大切にし、着実に前進します。続いて、歩み方を調整します。時代の変化に応じて、方法を更新します。最後に、さらに調整を加えます。不変の本質を保ちながら、表現を進化させます。突破口は、不変と変化の調和にあります。まずは変わらない軸を持ちながら、柔軟に適応しましょう。',
    'HJJ': 'まず、永遠という概念を新しく理解します。固定ではなく、継続という視点で捉えます。続いて、その理解を深めます。継続することの価値と意味を、実践を通じて体得します。最後に、さらに昇華させます。個人の継続が、普遍的な価値となります。突破口は、継続の価値の再発見にあります。まずは続けることの意味を見出し、それを大切にしましょう。',
    'HJH': 'まず、貞節を別の角度から見ます。制約ではなく、自由の基盤として理解します。次に、その理解で実践します。自由に選んだ道を、誠実に歩みます。最後に、再び視点を変えます。個人の道から、普遍的な道へと意識を広げます。突破口は、自由と責任の統合にあります。まずは自ら選んだ道に責任を持ち、誠実に歩みましょう。',
    'HHJ': 'まず、貞節の形を変えます。次に、表現を変えます。二度の変更で、新しい誠実さが生まれます。最後に、その新しい形で深めます。時代に合った誠実さが、より大きな影響力を持ちます。突破口は、誠実さの現代的表現にあります。まずは古い形式を超えて、新しい誠実さを実践しましょう。',
    'HHH': 'まず、形を捨てます。続いて、名を捨てます。最後に、自我を捨てます。三度の放棄で、究極の誠実さに到達します。個を超えた普遍的な真理を体現し、永遠の価値となります。突破口は、自我の超越にあります。まずは個人の利益を超えて、全体の幸福を追求しましょう。'
  }
};

function main() {
  const file = path.resolve(__dirname, '..', 'public', 'data', 'narratives_chain.v1.json');
  const db = loadJSON(file);
  
  let updateCount = 0;
  
  // 坤為地の残りのパターンを更新
  Object.keys(kunStories).forEach(line => {
    Object.keys(kunStories[line]).forEach(pattern => {
      const key = `坤為地 ${line} | ${pattern}`;
      
      if (!db[key] || !db[key].chain_long || db[key].chain_long === '') {
        const linePos = line === '初六' ? 1 : 
                       line === '六二' ? 2 :
                       line === '六三' ? 3 :
                       line === '六四' ? 4 :
                       line === '六五' ? 5 :
                       line === '上六' ? 6 : 7;
        
        db[key] = {
          chain_long: kunStories[line][pattern],
          tone: 'story',
          suitability: '坤為地の状況で、受容と育成が必要な場面',
          caution: '積極性と受容性のバランスを保つこと',
          label: labels[pattern],
          start: { hex: '坤為地', pos: linePos },
          final: { hex: '坤為地', pos: (linePos + 2) % 6 + 1 },
          updated_at: new Date().toISOString()
        };
        updateCount++;
      }
    });
  });
  
  // 他の空のエントリーも汎用的な内容で埋める
  Object.keys(db).forEach(key => {
    if (!db[key].chain_long || db[key].chain_long === '') {
      const parts = key.split(' | ');
      const pattern = parts[1];
      const hexAndLine = parts[0].split(' ');
      const hexName = hexAndLine[0] + hexAndLine[1];
      
      const genericStory = {
        'JJJ': 'まず、現在の状況を受け入れ、着実に基礎を固めます。小さな一歩から始め、確実に積み重ねていきます。続いて、その努力がさらに深まります。経験が蓄積され、自信が生まれ、より大きな成果へとつながります。最後に、努力が実を結び始めます。目標に近づき、次の段階への準備が整います。突破口は、継続的な努力にあります。まずは日々の積み重ねを大切にし、着実に前進しましょう。',
        'JJH': 'まず、基礎をしっかりと固めます。土台作りに時間をかけ、急がず着実に進めます。続いて、基礎がさらに強固になります。繰り返しの中で、揺るぎない土台が完成します。最後に、視点を切り替えます。守りから攻めへ、準備から実行へと転換します。突破口は、基礎固めの後の転換にあります。まずは土台を確実にし、タイミングを見て動きましょう。',
        'JHJ': 'まず、準備を整えます。必要な要素を確認し、計画を立てます。次に、アプローチを変えます。直接的な方法から、間接的な方法へと戦略を転換します。最後に、新しいアプローチで深めます。予想外の効果が現れ、より良い結果へとつながります。突破口は、柔軟な戦略転換にあります。まずは複数の選択肢を用意し、状況に応じて切り替えましょう。',
        'JHH': 'まず、慎重に一歩を踏み出します。状況を見極めながら、着実に前進します。続いて、方向を調整します。環境の変化を読み取り、柔軟に対応します。最後に、さらに調整を加えます。微調整を重ねながら、最適な道筋を見つけます。突破口は、継続的な調整にあります。まずは大まかな方向を定め、細かく修正していきましょう。',
        'HJJ': 'まず、従来のやり方を見直します。本質を理解し、新しいアプローチを模索します。続いて、新しい方法で深めます。試行錯誤しながら、より効果的な道を見つけます。最後に、さらに磨きをかけます。細部を調整し、完成度を高めます。突破口は、発想の転換にあります。まずは固定観念を捨て、新しい可能性を探りましょう。',
        'HJH': 'まず、視点を変えて状況を捉え直します。別の角度から見ることで、新しい理解が生まれます。次に、その理解を実践で試します。理論と実践を往復しながら、理解を深めます。最後に、再び視点を変えます。得られた経験を基に、さらに高い次元での理解を目指します。突破口は、理論と実践の統合にあります。まずは新しい視点を持ち、実践で検証しましょう。',
        'HHJ': 'まず、発想を転換します。次に、さらに転換します。二度の転換で、全く新しい地平が開けます。最後に、その新しい視野で集中的に取り組みます。革新的なアプローチが、予想を超える成果を生みます。突破口は、常識からの解放にあります。まずは「できない」という思い込みを外し、自由に発想しましょう。',
        'HHH': 'まず、形を変えます。続いて、質を変えます。最後に、次元を変えます。三度の変革で、状況は全く別のものへと昇華されます。制約から自由になり、新しい可能性が無限に広がります。突破口は、根本的な再定義にあります。まずは問題そのものを問い直し、全く新しい解決策を創造しましょう。'
      };
      
      db[key].chain_long = genericStory[pattern] || genericStory['JJJ'];
      db[key].tone = 'story';
      db[key].label = labels[pattern];
      db[key].updated_at = new Date().toISOString();
      
      if (!db[key].suitability) {
        db[key].suitability = '変化と成長が必要な場面';
      }
      if (!db[key].caution) {
        db[key].caution = '焦らず着実に進めること';
      }
      
      updateCount++;
    }
  });
  
  saveJSON(file, db);
  console.log(`Successfully updated ${updateCount} entries`);
}

main();