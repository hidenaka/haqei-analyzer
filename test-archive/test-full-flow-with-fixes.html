<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI Full Flow Test - ä¿®æ­£ç‰ˆçµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress {
            background: #e2e8f0;
            height: 30px;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: linear-gradient(90deg, #667eea, #764ba2);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .log-container {
            background: #1a202c;
            color: #63b3ed;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        iframe {
            width: 100%;
            height: 700px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .results {
            background: #f0fff4;
            border: 2px solid #38a169;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .error {
            background: #fff5f5;
            border: 2px solid #e53e3e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .success {
            color: #68d391;
        }
        
        .warning {
            color: #f6e05e;
        }
        
        .danger {
            color: #fc8181;
        }
        
        .info {
            color: #63b3ed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ HAQEI Full Flow Test - å®Œå…¨è‡ªå‹•ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="status" id="status">
            <span>çŠ¶æ…‹: å¾…æ©Ÿä¸­...</span>
            <span id="timer">çµŒéæ™‚é–“: 0ç§’</span>
        </div>
        
        <div class="progress">
            <div class="progress-bar" id="progressBar">0%</div>
        </div>
        
        <div class="control-panel">
            <button onclick="startFullTest()">ğŸ¯ å®Œå…¨è‡ªå‹•ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button onclick="loadOSAnalyzer()">1ï¸âƒ£ OS Analyzerèª­ã¿è¾¼ã¿</button>
            <button onclick="applyFixes()">2ï¸âƒ£ ä¿®æ­£ãƒ‘ãƒƒãƒé©ç”¨</button>
            <button onclick="startQuestions()">3ï¸âƒ£ è³ªå•é–‹å§‹</button>
            <button onclick="autoAnswer()">4ï¸âƒ£ è‡ªå‹•å›ç­”ï¼ˆ1å•ï¼‰</button>
            <button onclick="autoComplete36()">5ï¸âƒ£ 36å•å®Œå…¨å›ç­”</button>
            <button onclick="checkResults()">6ï¸âƒ£ çµæœç¢ºèª</button>
            <button onclick="forceResults()">ğŸ”§ å¼·åˆ¶çµæœè¡¨ç¤º</button>
            <button onclick="clearAll()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div class="results" id="results">
            <h3>âœ… è¨ºæ–­çµæœ</h3>
            <div id="resultsContent"></div>
        </div>
        
        <div class="error" id="error">
            <h3>âŒ ã‚¨ãƒ©ãƒ¼</h3>
            <div id="errorContent"></div>
        </div>
        
        <iframe id="testFrame" src="about:blank"></iframe>
        
        <div class="log-container" id="log">
            <div class="info">ğŸ“ ãƒ†ã‚¹ãƒˆãƒ­ã‚°é–‹å§‹...</div>
        </div>
    </div>
    
    <script>
        let testFrame = null;
        let startTime = null;
        let timerInterval = null;
        let currentQuestion = 0;
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `[${timestamp}] ${message}`;
            entry.className = type;
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            document.querySelector('#status span').textContent = `çŠ¶æ…‹: ${message}`;
        }
        
        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = `${percentage}%`;
            progressBar.textContent = `${percentage}% (${current}/${total})`;
        }
        
        function startTimer() {
            startTime = Date.now();
            timerInterval = setInterval(() => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                document.getElementById('timer').textContent = `çµŒéæ™‚é–“: ${elapsed}ç§’`;
            }, 1000);
        }
        
        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }
        
        async function startFullTest() {
            log('ğŸš€ å®Œå…¨è‡ªå‹•ãƒ†ã‚¹ãƒˆé–‹å§‹', 'success');
            startTimer();
            
            try {
                // Step 1: Load OS Analyzer
                await loadOSAnalyzer();
                await delay(2000);
                
                // Step 2: Apply fixes
                await applyFixes();
                await delay(1000);
                
                // Step 3: Start questions
                await startQuestions();
                await delay(1000);
                
                // Step 4: Complete all 36 questions
                await autoComplete36();
                await delay(2000);
                
                // Step 5: Check results
                await checkResults();
                
                log('âœ… å®Œå…¨è‡ªå‹•ãƒ†ã‚¹ãƒˆå®Œäº†ï¼', 'success');
                stopTimer();
                
            } catch (error) {
                log(`âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'danger');
                showError(error);
                stopTimer();
            }
        }
        
        function loadOSAnalyzer() {
            return new Promise((resolve, reject) => {
                testFrame = document.getElementById('testFrame');
                testFrame.src = 'os_analyzer.html';
                log('ğŸ“„ OS Analyzerèª­ã¿è¾¼ã¿ä¸­...');
                
                testFrame.onload = () => {
                    log('âœ… OS Analyzerèª­ã¿è¾¼ã¿å®Œäº†', 'success');
                    checkLoadedModules();
                    resolve();
                };
                
                testFrame.onerror = reject;
            });
        }
        
        function checkLoadedModules() {
            try {
                const win = testFrame.contentWindow;
                const modules = {
                    'CriticalCSSAnalyzer': typeof win.criticalCSSAnalyzer !== 'undefined',
                    'H384_DATA': typeof win.H384_DATA !== 'undefined',
                    'H64_DATA': typeof win.H64_DATA !== 'undefined',
                    'TripleOSInteractionAnalyzer': typeof win.TripleOSInteractionAnalyzer !== 'undefined'
                };
                
                for (const [module, loaded] of Object.entries(modules)) {
                    if (loaded) {
                        log(`âœ… ${module} loaded`, 'success');
                    } else {
                        log(`âš ï¸ ${module} not loaded`, 'warning');
                    }
                }
            } catch (error) {
                log(`âŒ ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'danger');
            }
        }
        
        async function applyFixes() {
            log('ğŸ”§ ä¿®æ­£ãƒ‘ãƒƒãƒé©ç”¨ä¸­...');
            const win = testFrame.contentWindow;
            
            // fix-start-button.js ã®å†…å®¹ã‚’æ³¨å…¥
            const startButtonFix = await fetch('fix-start-button.js').then(r => r.text());
            win.eval(startButtonFix);
            log('âœ… Start button fix applied', 'success');
            
            // fix-results-display.js ã®å†…å®¹ã‚’æ³¨å…¥
            const resultsDisplayFix = await fetch('fix-results-display.js').then(r => r.text());
            win.eval(resultsDisplayFix);
            log('âœ… Results display fix applied', 'success');
            
            // auto-complete-questions.js ã®å†…å®¹ã‚’æ³¨å…¥
            const autoCompleteScript = await fetch('auto-complete-questions.js').then(r => r.text());
            win.eval(autoCompleteScript);
            log('âœ… Auto-complete script loaded', 'success');
        }
        
        function startQuestions() {
            return new Promise((resolve, reject) => {
                try {
                    const win = testFrame.contentWindow;
                    
                    // æ‰‹å‹•ã§startAnalysisã‚’å‘¼ã¶
                    if (win.criticalCSSAnalyzer && win.criticalCSSAnalyzer.startAnalysis) {
                        win.criticalCSSAnalyzer.startAnalysis();
                        log('âœ… è³ªå•ãƒ•ãƒ­ãƒ¼é–‹å§‹', 'success');
                        currentQuestion = 0;
                        resolve();
                    } else {
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                        const startBtn = win.document.getElementById('start-btn');
                        if (startBtn) {
                            startBtn.click();
                            log('âœ… Start button clicked', 'success');
                            resolve();
                        } else {
                            reject(new Error('Start button not found'));
                        }
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        async function autoAnswer() {
            const win = testFrame.contentWindow;
            
            // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’é¸æŠ
            const radios = win.document.querySelectorAll('input[type="radio"]:not(:checked)');
            if (radios.length > 0) {
                radios[0].click();
                log(`âœ… è³ªå• ${currentQuestion + 1} å›ç­”é¸æŠ`);
                
                await delay(100);
                
                // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
                const nextBtn = win.document.getElementById('next-btn');
                if (nextBtn && !nextBtn.disabled) {
                    nextBtn.click();
                    currentQuestion++;
                    log(`â¡ï¸ æ¬¡ã®è³ªå•ã¸`);
                }
            }
        }
        
        async function autoComplete36() {
            log('ğŸ¤– 36å•è‡ªå‹•å›ç­”é–‹å§‹...');
            const win = testFrame.contentWindow;
            
            if (win.autoComplete36Questions) {
                const result = await win.autoComplete36Questions();
                log(`âœ… è‡ªå‹•å›ç­”å®Œäº†: ${result.completedQuestions}å•`, 'success');
                updateProgress(result.completedQuestions, 36);
                return result;
            } else {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ‰‹å‹•ã§36å•å›ç­”
                for (let i = 0; i < 36; i++) {
                    await autoAnswer();
                    updateProgress(i + 1, 36);
                    await delay(50);
                }
            }
        }
        
        function checkResults() {
            const win = testFrame.contentWindow;
            
            // ç¾åœ¨ã®ç”»é¢ã‚’ç¢ºèª
            const activeScreen = win.document.querySelector('.screen.active');
            if (activeScreen) {
                log(`ğŸ“ ç¾åœ¨ã®ç”»é¢: ${activeScreen.id}`, 'info');
            }
            
            // çµæœè¦ç´ ã‚’æ¢ã™
            const resultsScreen = win.document.getElementById('results-screen');
            const isResultsVisible = resultsScreen && resultsScreen.classList.contains('active');
            
            if (isResultsVisible) {
                log('âœ… çµæœç”»é¢è¡¨ç¤ºæˆåŠŸï¼', 'success');
                extractAndShowResults(win);
            } else {
                log('âš ï¸ çµæœç”»é¢ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã›ã‚“', 'warning');
                
                // LocalStorageã‚’ç¢ºèª
                const stored = win.localStorage.getItem('haqei_analysis_results');
                if (stored) {
                    log('ğŸ’¾ LocalStorageã«ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š', 'success');
                    showResults(JSON.parse(stored));
                } else {
                    log('âŒ çµæœãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'danger');
                }
            }
        }
        
        function extractAndShowResults(win) {
            const results = {
                engineOS: null,
                interfaceOS: null,
                safeModeOS: null
            };
            
            // OSã‚«ãƒ¼ãƒ‰ã‚’æ¢ã™
            const osCards = win.document.querySelectorAll('.os-card, .persona-card, [id*="os-card"]');
            osCards.forEach(card => {
                const text = card.textContent;
                if (text.includes('Engine')) {
                    results.engineOS = text.substring(0, 200);
                } else if (text.includes('Interface')) {
                    results.interfaceOS = text.substring(0, 200);
                } else if (text.includes('Safe')) {
                    results.safeModeOS = text.substring(0, 200);
                }
            });
            
            showResults(results);
        }
        
        function showResults(results) {
            const resultsDiv = document.getElementById('results');
            const content = document.getElementById('resultsContent');
            
            content.innerHTML = `
                <div style="display: grid; gap: 15px;">
                    <div>
                        <h4>ğŸš€ Engine OS</h4>
                        <p>${results.engineOS || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</p>
                    </div>
                    <div>
                        <h4>ğŸŒ Interface OS</h4>
                        <p>${results.interfaceOS || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</p>
                    </div>
                    <div>
                        <h4>ğŸ›¡ï¸ Safe Mode OS</h4>
                        <p>${results.safeModeOS || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</p>
                    </div>
                </div>
            `;
            
            resultsDiv.style.display = 'block';
        }
        
        function forceResults() {
            const win = testFrame.contentWindow;
            if (win.forceShowResults) {
                win.forceShowResults();
                log('ğŸ”§ å¼·åˆ¶çµæœè¡¨ç¤ºå®Ÿè¡Œ', 'warning');
            } else {
                log('âŒ forceShowResultsé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'danger');
            }
        }
        
        function showError(error) {
            const errorDiv = document.getElementById('error');
            const content = document.getElementById('errorContent');
            
            content.innerHTML = `
                <p><strong>ã‚¨ãƒ©ãƒ¼:</strong> ${error.message}</p>
                <pre>${error.stack}</pre>
            `;
            
            errorDiv.style.display = 'block';
        }
        
        function clearAll() {
            testFrame.src = 'about:blank';
            document.getElementById('log').innerHTML = '<div class="info">ğŸ“ ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¯ãƒªã‚¢</div>';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.querySelector('#status span').textContent = 'çŠ¶æ…‹: å¾…æ©Ÿä¸­...';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressBar').textContent = '0%';
            stopTimer();
            currentQuestion = 0;
            log('ğŸ—‘ï¸ ã‚¯ãƒªã‚¢å®Œäº†', 'info');
        }
        
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
        
        // åˆæœŸåŒ–
        window.onload = () => {
            log('âœ… ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™å®Œäº†', 'success');
        };
    </script>
</body>
</html>