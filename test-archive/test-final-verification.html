<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>最終動作検証 - HaQei OS Analyzer</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            color: #58a6ff;
            margin-bottom: 40px;
            font-size: 36px;
        }
        .verification-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        .verification-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 10px;
            padding: 20px;
        }
        .card-title {
            font-size: 18px;
            font-weight: bold;
            color: #58a6ff;
            margin-bottom: 15px;
        }
        .test-btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        .test-btn:hover {
            background: #2ea043;
        }
        .danger-btn {
            background: #da3633;
        }
        .danger-btn:hover {
            background: #f85149;
        }
        .result-area {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success { color: #3fb950; }
        .error { color: #f85149; }
        .warning { color: #d29922; }
        .info { color: #58a6ff; }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        .badge-success { background: #238636; color: white; }
        .badge-error { background: #da3633; color: white; }
        .badge-warning { background: #9e6a03; color: white; }
        .badge-pending { background: #6e7681; color: white; }
        
        .code-block {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 10px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .main-test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            display: block;
            margin: 30px auto;
            transition: transform 0.2s;
        }
        .main-test-btn:hover {
            transform: translateY(-2px);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #30363d;
            padding: 8px;
            text-align: left;
        }
        th {
            background: #161b22;
            color: #58a6ff;
        }
        td {
            background: #0d1117;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 HaQei OS Analyzer 最終動作検証</h1>
        
        <div class="verification-grid">
            <!-- コード実装確認 -->
            <div class="verification-card">
                <div class="card-title">
                    📝 コード実装確認
                    <span class="status-badge badge-pending" id="code-status">未検証</span>
                </div>
                <button class="test-btn" onclick="verifyCodeImplementation()">実装確認</button>
                <div class="result-area" id="code-result">検証待機中...</div>
            </div>
            
            <!-- 質問分離ロジック -->
            <div class="verification-card">
                <div class="card-title">
                    🔀 質問分離ロジック
                    <span class="status-badge badge-pending" id="separation-status">未検証</span>
                </div>
                <button class="test-btn" onclick="verifySeparation()">分離確認</button>
                <div class="result-area" id="separation-result">検証待機中...</div>
            </div>
            
            <!-- Interface OS動作 -->
            <div class="verification-card">
                <div class="card-title">
                    💬 Interface OS動作
                    <span class="status-badge badge-pending" id="interface-status">未検証</span>
                </div>
                <button class="test-btn" onclick="verifyInterfaceOS()">動作確認</button>
                <div class="result-area" id="interface-result">検証待機中...</div>
            </div>
            
            <!-- Safe Mode OS動作 -->
            <div class="verification-card">
                <div class="card-title">
                    🛡️ Safe Mode OS動作
                    <span class="status-badge badge-pending" id="safemode-status">未検証</span>
                </div>
                <button class="test-btn" onclick="verifySafeModeOS()">動作確認</button>
                <div class="result-area" id="safemode-result">検証待機中...</div>
            </div>
        </div>
        
        <!-- 統合テスト -->
        <div class="verification-card" style="margin-bottom: 20px;">
            <div class="card-title">
                🚀 実際のサイト動作確認
                <span class="status-badge badge-pending" id="site-status">未検証</span>
            </div>
            <button class="main-test-btn" onclick="verifySiteOperation()">サイト動作を完全検証</button>
            <div class="result-area" id="site-result" style="min-height: 200px;">検証待機中...</div>
        </div>
        
        <!-- 詳細レポート -->
        <div class="verification-card">
            <div class="card-title">📊 検証レポート</div>
            <div id="report-area"></div>
        </div>
    </div>
    
    <iframe id="analyzer-frame" src="os_analyzer.html" style="display:none;"></iframe>
    
    <script>
        let analyzer = null;
        let verificationResults = {
            code: false,
            separation: false,
            interface: false,
            safemode: false,
            site: false
        };
        
        // iframe読み込み
        document.getElementById('analyzer-frame').onload = function() {
            const iframe = document.getElementById('analyzer-frame');
            const iframeWindow = iframe.contentWindow;
            if (iframeWindow.window.osAnalyzer) {
                analyzer = iframeWindow.window.osAnalyzer;
                console.log('✅ OS Analyzer loaded');
                updateReport();
            }
        };
        
        function updateStatus(id, status) {
            const badge = document.getElementById(id + '-status');
            badge.className = 'status-badge badge-' + status;
            badge.textContent = status === 'success' ? '✅ 正常' : 
                               status === 'error' ? '❌ 異常' :
                               status === 'warning' ? '⚠️ 警告' : '未検証';
        }
        
        function verifyCodeImplementation() {
            const resultDiv = document.getElementById('code-result');
            let result = '<span class="info">コード実装チェック開始...</span>\n\n';
            
            try {
                // separateAnswersのコード確認
                const separateCode = analyzer.separateAnswers.toString();
                const hasQ1to12 = separateCode.includes('questionNum >= 1 && questionNum <= 12');
                const hasQ13to24 = separateCode.includes('questionNum >= 13 && questionNum <= 24');
                const hasQ25to36 = separateCode.includes('questionNum >= 25 && questionNum <= 36');
                
                result += '1. separateAnswers メソッド:\n';
                result += `   Q1-12判定: ${hasQ1to12 ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n`;
                result += `   Q13-24判定: ${hasQ13to24 ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n`;
                result += `   Q25-36判定: ${hasQ25to36 ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n\n`;
                
                // analyzeSocialPatternsのコード確認
                const socialCode = analyzer.analyzeSocialPatterns.toString();
                const hasQ13Index = socialCode.includes('Q${13 + index}');
                const hasQ13Pattern = socialCode.includes('Q13_leadership');
                const hasQ24Pattern = socialCode.includes('Q24_adaptation');
                
                result += '2. analyzeSocialPatterns メソッド:\n';
                result += `   Q13開始: ${hasQ13Index ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n`;
                result += `   Q13パターン: ${hasQ13Pattern ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n`;
                result += `   Q24パターン: ${hasQ24Pattern ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n\n`;
                
                // extractDefensivePatternsのコード確認
                const defenseCode = analyzer.extractDefensivePatterns.toString();
                const hasDefenseAnswers = defenseCode.includes('defenseAnswers');
                const hasQ36Pattern = defenseCode.includes('Q36_resourceStress');
                
                result += '3. extractDefensivePatterns メソッド:\n';
                result += `   引数名: ${hasDefenseAnswers ? '<span class="success">✅ defenseAnswers</span>' : '<span class="error">❌</span>'}\n`;
                result += `   Q36パターン: ${hasQ36Pattern ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n`;
                
                const allCorrect = hasQ1to12 && hasQ13to24 && hasQ25to36 && 
                                  hasQ13Index && hasQ13Pattern && hasQ24Pattern &&
                                  hasDefenseAnswers && hasQ36Pattern;
                
                verificationResults.code = allCorrect;
                updateStatus('code', allCorrect ? 'success' : 'error');
                resultDiv.innerHTML = result;
                updateReport();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">エラー: ${error.message}</span>`;
                updateStatus('code', 'error');
            }
        }
        
        function verifySeparation() {
            const resultDiv = document.getElementById('separation-result');
            let result = '<span class="info">質問分離テスト実行中...</span>\n\n';
            
            try {
                // 36問の模擬データ作成
                const mockAnswers = [];
                for (let i = 1; i <= 36; i++) {
                    mockAnswers.push({
                        questionId: `q${i}`,
                        selectedOption: { value: 'A' }
                    });
                }
                
                // 分離実行
                const separated = analyzer.separateAnswers(mockAnswers);
                
                result += '質問分離結果:\n';
                result += `Engine OS: ${separated.worldviewAnswers.length}問 `;
                result += separated.worldviewAnswers.length === 12 ? '<span class="success">✅</span>\n' : '<span class="error">❌</span>\n';
                
                result += `Interface OS: ${separated.scenarioAnswers.length}問 `;
                result += separated.scenarioAnswers.length === 12 ? '<span class="success">✅</span>\n' : '<span class="error">❌</span>\n';
                
                result += `Safe Mode OS: ${separated.defenseAnswers.length}問 `;
                result += separated.defenseAnswers.length === 12 ? '<span class="success">✅</span>\n' : '<span class="error">❌</span>\n';
                
                result += '\n質問番号範囲:\n';
                const engineRange = `${separated.worldviewAnswers[0]?.questionId}-${separated.worldviewAnswers[11]?.questionId}`;
                const interfaceRange = `${separated.scenarioAnswers[0]?.questionId}-${separated.scenarioAnswers[11]?.questionId}`;
                const safemodeRange = `${separated.defenseAnswers[0]?.questionId}-${separated.defenseAnswers[11]?.questionId}`;
                
                result += `Engine: ${engineRange} ${engineRange === 'q1-q12' ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n`;
                result += `Interface: ${interfaceRange} ${interfaceRange === 'q13-q24' ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n`;
                result += `SafeMode: ${safemodeRange} ${safemodeRange === 'q25-q36' ? '<span class="success">✅</span>' : '<span class="error">❌</span>'}\n`;
                
                const allCorrect = separated.worldviewAnswers.length === 12 &&
                                  separated.scenarioAnswers.length === 12 &&
                                  separated.defenseAnswers.length === 12 &&
                                  engineRange === 'q1-q12' &&
                                  interfaceRange === 'q13-q24' &&
                                  safemodeRange === 'q25-q36';
                
                verificationResults.separation = allCorrect;
                updateStatus('separation', allCorrect ? 'success' : 'error');
                resultDiv.innerHTML = result;
                updateReport();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">エラー: ${error.message}</span>`;
                updateStatus('separation', 'error');
            }
        }
        
        function verifyInterfaceOS() {
            const resultDiv = document.getElementById('interface-result');
            let result = '<span class="info">Interface OS動作テスト...</span>\n\n';
            
            try {
                // Q13-Q24の模擬データ
                const interfaceAnswers = [];
                for (let i = 13; i <= 24; i++) {
                    interfaceAnswers.push({
                        questionId: `q${i}`,
                        selectedOption: { value: 'B' }
                    });
                }
                
                // パターン生成
                const patterns = analyzer.analyzeSocialPatterns(interfaceAnswers);
                
                result += 'パターン生成結果:\n';
                const expectedPatterns = [
                    'Q13_leadership', 'Q14_interpersonal', 'Q15_family',
                    'Q16_emergency', 'Q17_competition', 'Q18_community',
                    'Q19_social', 'Q20_conflict', 'Q21_trust',
                    'Q22_expression', 'Q23_cooperation', 'Q24_adaptation'
                ];
                
                let allPatternsExist = true;
                expectedPatterns.forEach(pattern => {
                    const exists = patterns[pattern] !== undefined;
                    result += `  ${pattern}: ${exists ? '<span class="success">✅</span>' : '<span class="error">❌ 未定義</span>'}\n`;
                    if (!exists) allPatternsExist = false;
                });
                
                // ベクトル構築
                result += '\nベクトル構築:\n';
                const vector = analyzer.buildInterfaceVector(patterns);
                let allVectorValid = true;
                Object.entries(vector).forEach(([key, value]) => {
                    const isValid = !isNaN(value) && value !== undefined;
                    if (!isValid) allVectorValid = false;
                    result += `  ${key}: ${isValid ? '<span class="success">✅</span>' : '<span class="error">❌ NaN</span>'}\n`;
                });
                
                verificationResults.interface = allPatternsExist && allVectorValid;
                updateStatus('interface', verificationResults.interface ? 'success' : 'error');
                resultDiv.innerHTML = result;
                updateReport();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">エラー: ${error.message}</span>`;
                updateStatus('interface', 'error');
            }
        }
        
        function verifySafeModeOS() {
            const resultDiv = document.getElementById('safemode-result');
            let result = '<span class="info">Safe Mode OS動作テスト...</span>\n\n';
            
            try {
                // Q25-Q36の模擬データ
                const defenseAnswers = [];
                for (let i = 25; i <= 36; i++) {
                    defenseAnswers.push({
                        questionId: `q${i}`,
                        selectedOption: { value: 'C' },
                        intensity: 0.7,
                        pattern: '回避'
                    });
                }
                
                // パターン生成
                const patterns = analyzer.extractDefensivePatterns(defenseAnswers);
                
                result += 'パターン生成結果:\n';
                const expectedPatterns = [
                    'Q25_leadershipStress', 'Q26_interpersonalStress', 'Q27_familyStress',
                    'Q28_emergencyStress', 'Q29_competitionStress', 'Q30_collaborationStress',
                    'Q31_socialStress', 'Q32_failureStress', 'Q33_changeStress',
                    'Q34_isolationStress', 'Q35_performanceStress', 'Q36_resourceStress'
                ];
                
                let allPatternsExist = true;
                expectedPatterns.forEach(pattern => {
                    const exists = patterns[pattern] !== undefined;
                    result += `  ${pattern}: ${exists ? '<span class="success">✅</span>' : '<span class="error">❌ 未定義</span>'}\n`;
                    if (!exists) allPatternsExist = false;
                });
                
                verificationResults.safemode = allPatternsExist;
                updateStatus('safemode', allPatternsExist ? 'success' : 'error');
                resultDiv.innerHTML = result;
                updateReport();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error">エラー: ${error.message}</span>`;
                updateStatus('safemode', 'error');
            }
        }
        
        async function verifySiteOperation() {
            const resultDiv = document.getElementById('site-result');
            let result = '<span class="info">🚀 実際のサイト動作を検証中...</span>\n\n';
            
            try {
                // 36問の完全な模擬回答
                const fullAnswers = [];
                for (let i = 1; i <= 36; i++) {
                    fullAnswers.push({
                        questionId: `q${i}`,
                        selectedOption: { 
                            value: i <= 12 ? 'A' : i <= 24 ? 'B' : 'C',
                            scoring: {
                                "乾_創造性": Math.random() * 3,
                                "兌_調和性": Math.random() * 3,
                                "離_表現性": Math.random() * 3,
                                "震_行動性": Math.random() * 3,
                                "巽_適応性": Math.random() * 3,
                                "坎_探求性": Math.random() * 3,
                                "艮_安定性": Math.random() * 3,
                                "坤_受容性": Math.random() * 3
                            }
                        }
                    });
                }
                
                result += '📝 36問の回答データ生成完了\n\n';
                
                // Triple OS分析実行
                result += '🔄 Triple OS分析を実行中...\n';
                const analysis = await analyzer.analyzeTripleOS(fullAnswers);
                
                result += '\n<span class="success">✅ 分析完了！</span>\n\n';
                result += '📊 分析結果:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n';
                
                // Engine OS結果
                result += '\n🎯 Engine OS (内なる価値観):\n';
                result += `  卦番号: #${analysis.engineOS.hexagramId || 'エラー'}\n`;
                result += `  卦名: ${analysis.engineOS.hexagramName || 'エラー'}\n`;
                result += `  上卦: ${analysis.engineOS.upperTrigram || 'エラー'}\n`;
                result += `  下卦: ${analysis.engineOS.lowerTrigram || 'エラー'}\n`;
                result += `  状態: ${analysis.engineOS.hexagramId ? '<span class="success">✅ 正常</span>' : '<span class="error">❌ 異常</span>'}\n`;
                
                // Interface OS結果
                result += '\n💬 Interface OS (対人関係):\n';
                result += `  卦番号: #${analysis.interfaceOS.hexagramId || 'エラー'}\n`;
                result += `  卦名: ${analysis.interfaceOS.hexagramName || 'エラー'}\n`;
                result += `  上卦: ${analysis.interfaceOS.upperTrigram || 'エラー'}\n`;
                result += `  下卦: ${analysis.interfaceOS.lowerTrigram || 'エラー'}\n`;
                result += `  状態: ${analysis.interfaceOS.hexagramId ? '<span class="success">✅ 正常</span>' : '<span class="error">❌ 異常</span>'}\n`;
                
                // Safe Mode OS結果
                result += '\n🛡️ Safe Mode OS (防御システム):\n';
                result += `  卦番号: #${analysis.safeModeOS.hexagramId || 'エラー'}\n`;
                result += `  卦名: ${analysis.safeModeOS.hexagramName || 'エラー'}\n`;
                result += `  防御タイプ: ${analysis.safeModeOS.defensiveType || 'エラー'}\n`;
                result += `  状態: ${analysis.safeModeOS.hexagramId ? '<span class="success">✅ 正常</span>' : '<span class="error">❌ 異常</span>'}\n`;
                
                // 統合スコア
                result += '\n📈 統合スコア:\n';
                result += `  一貫性: ${analysis.consistencyScore || 0}%\n`;
                result += `  バランス: ${analysis.balanceScore || 0}%\n`;
                result += `  統合度: ${analysis.HaQeiIntegration || 0}%\n`;
                
                result += '\n━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n';
                
                const allSuccess = analysis.engineOS.hexagramId && 
                                 analysis.interfaceOS.hexagramId && 
                                 analysis.safeModeOS.hexagramId;
                
                if (allSuccess) {
                    result += '<span class="success">🎉 全システム正常動作確認！</span>\n';
                    result += '<span class="success">修正は完全に成功しています。</span>';
                } else {
                    result += '<span class="error">⚠️ 一部システムに問題があります。</span>\n';
                    result += '<span class="error">追加の修正が必要です。</span>';
                }
                
                verificationResults.site = allSuccess;
                updateStatus('site', allSuccess ? 'success' : 'error');
                resultDiv.innerHTML = result;
                updateReport();
                
            } catch (error) {
                result += `<span class="error">エラー発生: ${error.message}</span>\n`;
                result += `<span class="error">スタック: ${error.stack}</span>`;
                resultDiv.innerHTML = result;
                updateStatus('site', 'error');
                verificationResults.site = false;
                updateReport();
            }
        }
        
        function updateReport() {
            const reportArea = document.getElementById('report-area');
            let html = '<table>';
            html += '<tr><th>検証項目</th><th>状態</th><th>詳細</th></tr>';
            
            html += '<tr>';
            html += '<td>コード実装</td>';
            html += `<td>${verificationResults.code ? '✅ 正常' : '❌ 異常'}</td>`;
            html += '<td>separateAnswers, analyzeSocialPatterns, extractDefensivePatterns</td>';
            html += '</tr>';
            
            html += '<tr>';
            html += '<td>質問分離</td>';
            html += `<td>${verificationResults.separation ? '✅ 正常' : '❌ 異常'}</td>`;
            html += '<td>Q1-12(Engine), Q13-24(Interface), Q25-36(SafeMode)</td>';
            html += '</tr>';
            
            html += '<tr>';
            html += '<td>Interface OS</td>';
            html += `<td>${verificationResults.interface ? '✅ 正常' : '❌ 異常'}</td>`;
            html += '<td>Q13-Q24パターン生成、ベクトル構築</td>';
            html += '</tr>';
            
            html += '<tr>';
            html += '<td>Safe Mode OS</td>';
            html += `<td>${verificationResults.safemode ? '✅ 正常' : '❌ 異常'}</td>`;
            html += '<td>Q25-Q36パターン生成</td>';
            html += '</tr>';
            
            html += '<tr>';
            html += '<td>サイト動作</td>';
            html += `<td>${verificationResults.site ? '✅ 正常' : '❌ 異常'}</td>`;
            html += '<td>Triple OS統合分析</td>';
            html += '</tr>';
            
            html += '</table>';
            
            const allSuccess = Object.values(verificationResults).every(v => v === true);
            if (allSuccess) {
                html += '<div style="margin-top: 20px; padding: 15px; background: #238636; border-radius: 6px;">';
                html += '<span style="font-size: 18px; font-weight: bold;">✅ 全検証項目合格 - 実装は完全に正しく動作しています</span>';
                html += '</div>';
            }
            
            reportArea.innerHTML = html;
        }
    </script>
</body>
</html>