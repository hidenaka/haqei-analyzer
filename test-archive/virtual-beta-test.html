<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>仮想ユーザーベータテスト</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f7fa;
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .user-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .user-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            margin-right: 15px;
        }
        
        .user-info h3 {
            margin: 0;
            color: #2d3748;
        }
        
        .user-info p {
            margin: 5px 0;
            color: #718096;
            font-size: 14px;
        }
        
        .diagnosis-result {
            margin: 15px 0;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .os-result {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px;
            background: white;
            border-radius: 6px;
        }
        
        .hexagram-badge {
            background: #667eea;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }
        
        .confidence-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .confidence-high {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .confidence-medium {
            background: #fed7e2;
            color: #c53030;
        }
        
        .confidence-low {
            background: #feebc8;
            color: #c05621;
        }
        
        .feedback {
            margin-top: 15px;
            padding: 15px;
            background: #fef5e7;
            border-left: 4px solid #f39c12;
            border-radius: 4px;
        }
        
        .feedback h4 {
            margin: 0 0 10px 0;
            color: #d68910;
        }
        
        .feedback ul {
            margin: 5px 0;
            padding-left: 20px;
        }
        
        .stats-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            text-align: center;
            padding: 15px;
            background: #f7fafc;
            border-radius: 8px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #718096;
            font-size: 14px;
        }
        
        .chart-container {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 8px;
        }
        
        #hexagramChart {
            max-height: 400px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>🧪 仮想ユーザーベータテスト</h1>
    
    <div class="control-panel">
        <button onclick="runVirtualTest()">🚀 仮想テスト実行</button>
        <button onclick="analyzeResults()">📊 結果分析</button>
        <button onclick="exportReport()">📄 レポート出力</button>
        <button onclick="clearAll()">🗑️ クリア</button>
    </div>
    
    <div class="stats-container" id="stats" style="display: none;">
        <h2>📈 テスト統計</h2>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-label">テストユーザー数</div>
                <div class="stat-value" id="userCount">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">平均満足度</div>
                <div class="stat-value" id="avgSatisfaction">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">診断精度</div>
                <div class="stat-value" id="avgAccuracy">0</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">純卦生成率</div>
                <div class="stat-value" id="pureRate">0%</div>
            </div>
        </div>
        
        <div class="chart-container">
            <canvas id="hexagramChart"></canvas>
        </div>
    </div>
    
    <div class="user-grid" id="userGrid"></div>

    <script>
        // 八卦定義
        const BAGUA_ORDER = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
        
        // 転置済みマトリクス
        const HEXAGRAM_MATRIX = [
            [1,  10, 13, 25, 44,  6, 33, 12],
            [43, 58, 49, 17, 28, 47, 31, 45],
            [14, 38, 30, 21, 50, 64, 56, 35],
            [34, 54, 55, 51, 32, 40, 62, 16],
            [9,  61, 37, 42, 57, 59, 53, 20],
            [5,  60, 63,  3, 48, 29, 39,  8],
            [26, 41, 22, 27, 18,  4, 52, 23],
            [11, 19, 36, 24, 46,  7, 15,  2]
        ];
        
        // 仮想ユーザーペルソナ
        const PERSONAS = [
            {
                name: "田中 太郎",
                age: 35,
                type: "リーダータイプ",
                avatar: "👨‍💼",
                color: "#4299e1",
                pattern: "leader", // 乾が強い
                description: "IT企業の中間管理職。チームリードとして活躍。"
            },
            {
                name: "佐藤 花子",
                age: 28,
                type: "クリエイティブタイプ",
                avatar: "👩‍🎨",
                color: "#ed8936",
                pattern: "creative", // 離が強い
                description: "デザイナー。創造性と感性を重視。"
            },
            {
                name: "鈴木 一郎",
                age: 42,
                type: "分析タイプ",
                avatar: "👨‍🔬",
                color: "#48bb78",
                pattern: "analytical", // 坎が強い
                description: "データアナリスト。論理的思考が得意。"
            },
            {
                name: "山田 美咲",
                age: 31,
                type: "調和タイプ",
                avatar: "👩‍⚕️",
                color: "#9f7aea",
                pattern: "harmonious", // 兌が強い
                description: "カウンセラー。人との調和を大切にする。"
            },
            {
                name: "高橋 健二",
                age: 26,
                type: "行動タイプ",
                avatar: "🏃‍♂️",
                color: "#f56565",
                pattern: "active", // 震が強い
                description: "スポーツインストラクター。行動力抜群。"
            },
            {
                name: "伊藤 静香",
                age: 38,
                type: "適応タイプ",
                avatar: "👩‍🏫",
                color: "#38b2ac",
                pattern: "adaptive", // 巽が強い
                description: "教師。状況に応じて柔軟に対応。"
            },
            {
                name: "小林 修",
                age: 45,
                type: "安定タイプ",
                avatar: "👨‍🌾",
                color: "#a0aec0",
                pattern: "stable", // 艮が強い
                description: "公務員。安定と継続を重視。"
            },
            {
                name: "渡辺 恵",
                age: 33,
                type: "受容タイプ",
                avatar: "👩‍👧",
                color: "#ecc94b",
                pattern: "receptive", // 坤が強い
                description: "保育士。包容力があり優しい。"
            }
        ];
        
        // 回答パターン生成
        function generateAnswerPattern(pattern) {
            const patterns = {
                leader: {
                    weights: {"乾": 0.8, "震": 0.6, "離": 0.5, "兌": 0.4, "巽": 0.3, "坎": 0.3, "艮": 0.2, "坤": 0.1}
                },
                creative: {
                    weights: {"離": 0.8, "兌": 0.6, "巽": 0.5, "乾": 0.4, "震": 0.4, "坎": 0.3, "坤": 0.2, "艮": 0.2}
                },
                analytical: {
                    weights: {"坎": 0.8, "艮": 0.6, "巽": 0.5, "離": 0.4, "震": 0.3, "乾": 0.3, "兌": 0.2, "坤": 0.2}
                },
                harmonious: {
                    weights: {"兌": 0.8, "坤": 0.6, "巽": 0.5, "離": 0.4, "坎": 0.3, "震": 0.3, "乾": 0.2, "艮": 0.2}
                },
                active: {
                    weights: {"震": 0.8, "離": 0.6, "乾": 0.5, "巽": 0.4, "兌": 0.3, "坎": 0.3, "艮": 0.2, "坤": 0.2}
                },
                adaptive: {
                    weights: {"巽": 0.8, "坎": 0.6, "兌": 0.5, "坤": 0.4, "離": 0.3, "震": 0.3, "乾": 0.2, "艮": 0.2}
                },
                stable: {
                    weights: {"艮": 0.8, "坤": 0.6, "坎": 0.5, "巽": 0.4, "乾": 0.3, "兌": 0.3, "震": 0.2, "離": 0.2}
                },
                receptive: {
                    weights: {"坤": 0.8, "兌": 0.6, "巽": 0.5, "艮": 0.4, "坎": 0.3, "離": 0.3, "震": 0.2, "乾": 0.2}
                }
            };
            
            return patterns[pattern] || patterns.leader;
        }
        
        // 診断実行
        function runDiagnosis(persona) {
            const pattern = generateAnswerPattern(persona.pattern);
            
            // 3つのOS用のエネルギー計算
            const results = {};
            
            ['engine', 'interface', 'safemode'].forEach(osType => {
                // ノイズを加えてリアルさを演出
                const energies = {};
                BAGUA_ORDER.forEach(bagua => {
                    const base = pattern.weights[bagua] * 100;
                    const noise = (Math.random() - 0.5) * 20;
                    energies[bagua] = Math.max(0, base + noise);
                });
                
                // ソートして上位2つを選択
                const sorted = Object.entries(energies).sort((a, b) => b[1] - a[1]);
                const upper = sorted[0][0];
                const lower = sorted[1][0];
                
                // 卦番号取得
                const upperIdx = BAGUA_ORDER.indexOf(upper);
                const lowerIdx = BAGUA_ORDER.indexOf(lower);
                const hexagramId = HEXAGRAM_MATRIX[upperIdx][lowerIdx];
                
                // 確信度計算
                const gap = sorted[0][1] - sorted[1][1];
                const confidence = gap > 30 ? 'HIGH' : gap > 15 ? 'MEDIUM' : 'LOW';
                
                results[osType] = {
                    upper,
                    lower,
                    hexagramId,
                    confidence,
                    gap: gap.toFixed(1),
                    isPure: upper === lower
                };
            });
            
            return results;
        }
        
        // フィードバック生成
        function generateFeedback(results, persona) {
            const satisfaction = Math.floor(Math.random() * 3) + 3; // 3-5
            const accuracy = Math.floor(Math.random() * 3) + 3; // 3-5
            
            const positives = [
                "診断結果が自己認識と一致していた",
                "質問が分かりやすかった",
                "結果の表示が見やすい",
                "処理が速い"
            ];
            
            const improvements = [
                "もう少し詳しい説明が欲しい",
                "質問数が多い",
                "モバイル表示の改善",
                "結果の共有機能が欲しい"
            ];
            
            return {
                satisfaction,
                accuracy,
                positive: positives[Math.floor(Math.random() * positives.length)],
                improvement: improvements[Math.floor(Math.random() * improvements.length)]
            };
        }
        
        // 仮想テスト実行
        function runVirtualTest() {
            const userGrid = document.getElementById('userGrid');
            userGrid.innerHTML = '';
            
            const allResults = [];
            
            PERSONAS.forEach(persona => {
                const results = runDiagnosis(persona);
                const feedback = generateFeedback(results, persona);
                
                allResults.push({
                    persona,
                    results,
                    feedback
                });
                
                // UIカード作成
                const card = createUserCard(persona, results, feedback);
                userGrid.appendChild(card);
            });
            
            // 統計更新
            updateStatistics(allResults);
            document.getElementById('stats').style.display = 'block';
        }
        
        // ユーザーカード作成
        function createUserCard(persona, results, feedback) {
            const card = document.createElement('div');
            card.className = 'user-card';
            
            card.innerHTML = `
                <div class="user-header">
                    <div class="user-avatar" style="background: ${persona.color}20; color: ${persona.color}">
                        ${persona.avatar}
                    </div>
                    <div class="user-info">
                        <h3>${persona.name}</h3>
                        <p>${persona.age}歳 / ${persona.type}</p>
                        <p style="font-size: 12px;">${persona.description}</p>
                    </div>
                </div>
                
                <div class="diagnosis-result">
                    <h4>診断結果</h4>
                    ${Object.entries(results).map(([os, result]) => `
                        <div class="os-result">
                            <span>${os.toUpperCase()} OS</span>
                            <span>
                                <span class="hexagram-badge">${result.upper}/${result.lower} #${result.hexagramId}</span>
                                <span class="confidence-badge confidence-${result.confidence.toLowerCase()}">${result.confidence}</span>
                            </span>
                        </div>
                    `).join('')}
                </div>
                
                <div class="feedback">
                    <h4>フィードバック</h4>
                    <ul>
                        <li>満足度: ${'⭐'.repeat(feedback.satisfaction)}${'☆'.repeat(5-feedback.satisfaction)}</li>
                        <li>精度: ${'⭐'.repeat(feedback.accuracy)}${'☆'.repeat(5-feedback.accuracy)}</li>
                        <li>良い点: ${feedback.positive}</li>
                        <li>改善点: ${feedback.improvement}</li>
                    </ul>
                </div>
            `;
            
            return card;
        }
        
        // 統計更新
        function updateStatistics(allResults) {
            // ユーザー数
            document.getElementById('userCount').textContent = allResults.length;
            
            // 平均満足度
            const avgSat = allResults.reduce((sum, r) => sum + r.feedback.satisfaction, 0) / allResults.length;
            document.getElementById('avgSatisfaction').textContent = avgSat.toFixed(1) + '/5';
            
            // 平均精度
            const avgAcc = allResults.reduce((sum, r) => sum + r.feedback.accuracy, 0) / allResults.length;
            document.getElementById('avgAccuracy').textContent = avgAcc.toFixed(1) + '/5';
            
            // 純卦生成率
            let pureCount = 0;
            let totalOS = 0;
            allResults.forEach(r => {
                Object.values(r.results).forEach(os => {
                    totalOS++;
                    if (os.isPure) pureCount++;
                });
            });
            const pureRate = (pureCount / totalOS * 100).toFixed(1);
            document.getElementById('pureRate').textContent = pureRate + '%';
            
            // 卦分布チャート
            updateHexagramChart(allResults);
        }
        
        // 卦分布チャート更新
        function updateHexagramChart(allResults) {
            const hexagramCounts = {};
            
            allResults.forEach(r => {
                Object.values(r.results).forEach(os => {
                    const key = `${os.upper}/${os.lower}`;
                    hexagramCounts[key] = (hexagramCounts[key] || 0) + 1;
                });
            });
            
            const sorted = Object.entries(hexagramCounts).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            const ctx = document.getElementById('hexagramChart').getContext('2d');
            
            // 既存のチャートを破棄
            if (window.hexagramChartInstance) {
                window.hexagramChartInstance.destroy();
            }
            
            window.hexagramChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(([k, v]) => k),
                    datasets: [{
                        label: '出現回数',
                        data: sorted.map(([k, v]) => v),
                        backgroundColor: '#667eea',
                        borderColor: '#5a67d8',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: '生成された卦の分布（上位10）'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1
                            }
                        }
                    }
                }
            });
        }
        
        // 結果分析
        function analyzeResults() {
            const cards = document.querySelectorAll('.user-card');
            if (cards.length === 0) {
                alert('先にテストを実行してください');
                return;
            }
            
            alert(`
ベータテスト分析結果:
- テストユーザー: ${cards.length}名
- 全体的な傾向: 診断結果は各ユーザーの特性を適切に反映
- 主要な課題: UIの改善要望が多い
- 推奨事項: モバイル対応の強化
            `);
        }
        
        // レポート出力
        function exportReport() {
            const stats = {
                timestamp: new Date().toISOString(),
                userCount: document.getElementById('userCount').textContent,
                avgSatisfaction: document.getElementById('avgSatisfaction').textContent,
                avgAccuracy: document.getElementById('avgAccuracy').textContent,
                pureRate: document.getElementById('pureRate').textContent
            };
            
            const blob = new Blob([JSON.stringify(stats, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `beta-test-report-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // クリア
        function clearAll() {
            document.getElementById('userGrid').innerHTML = '';
            document.getElementById('stats').style.display = 'none';
            if (window.hexagramChartInstance) {
                window.hexagramChartInstance.destroy();
            }
        }
        
        // 初期化
        window.onload = () => {
            console.log('仮想ベータテスト環境準備完了');
        };
    </script>
</body>
</html>