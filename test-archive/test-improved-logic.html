<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>改善診断ロジック検証</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .improvement-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            border-left: 4px solid #667eea;
        }
        .test-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .test-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
        }
        .test-title {
            font-size: 18px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
        }
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            transform: translateY(-2px);
        }
        .result-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        .info { color: #17a2b8; font-weight: bold; }
        
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }
        .comparison-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        .improved { background: #d4edda; }
        .issue { background: #f8d7da; }
        
        .pure-hexagram-badge {
            display: inline-block;
            background: #ffc107;
            color: #000;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-left: 5px;
        }
        
        .confidence-meter {
            display: inline-block;
            width: 100px;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-left: 10px;
        }
        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
            transition: width 0.3s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 改善診断ロジック検証ツール</h1>
        
        <div class="improvement-card">
            <h2>📊 主な改善点</h2>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>項目</th>
                        <th>改善前</th>
                        <th>改善後</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>用語</td>
                        <td class="issue">「三爻」（誤用）</td>
                        <td class="improved">「八卦」（正しい）</td>
                    </tr>
                    <tr>
                        <td>純卦の扱い</td>
                        <td class="issue">排除（8卦が出現不可）</td>
                        <td class="improved">許容（全64卦出現可能）</td>
                    </tr>
                    <tr>
                        <td>8次元統一</td>
                        <td class="issue">OS毎に異なる次元</td>
                        <td class="improved">全OS八卦次元に統一</td>
                    </tr>
                    <tr>
                        <td>正規化</td>
                        <td class="issue">不透明な処理</td>
                        <td class="improved">Z-score→ReLU→L1正規化</td>
                    </tr>
                    <tr>
                        <td>キーワード</td>
                        <td class="issue">価値判断あり</td>
                        <td class="improved">中立的カテゴリ</td>
                    </tr>
                    <tr>
                        <td>確信度</td>
                        <td class="issue">なし</td>
                        <td class="improved">3段階評価実装</td>
                    </tr>
                </tbody>
            </table>
        </div>
        
        <div class="test-section">
            <!-- 純卦テスト -->
            <div class="test-card">
                <div class="test-title">🎯 純卦出現テスト</div>
                <button onclick="testPureHexagrams()">純卦をテスト</button>
                <div id="pure-result" class="result-box">テスト待機中...</div>
            </div>
            
            <!-- 全64卦網羅性テスト -->
            <div class="test-card">
                <div class="test-title">📊 64卦網羅性テスト</div>
                <button onclick="testCoverage()">網羅性をテスト</button>
                <div id="coverage-result" class="result-box">テスト待機中...</div>
            </div>
            
            <!-- 八卦次元統一テスト -->
            <div class="test-card">
                <div class="test-title">🔄 八卦次元変換テスト</div>
                <button onclick="testDimensionConversion()">変換をテスト</button>
                <div id="dimension-result" class="result-box">テスト待機中...</div>
            </div>
            
            <!-- 正規化プロセステスト -->
            <div class="test-card">
                <div class="test-title">📈 正規化プロセステスト</div>
                <button onclick="testNormalization()">正規化をテスト</button>
                <div id="normalization-result" class="result-box">テスト待機中...</div>
            </div>
            
            <!-- 確信度テスト -->
            <div class="test-card">
                <div class="test-title">💯 確信度評価テスト</div>
                <button onclick="testConfidence()">確信度をテスト</button>
                <div id="confidence-result" class="result-box">テスト待機中...</div>
            </div>
            
            <!-- 一貫性テスト -->
            <div class="test-card">
                <div class="test-title">🔒 決定論的一貫性テスト</div>
                <button onclick="testConsistency()">一貫性をテスト</button>
                <div id="consistency-result" class="result-box">テスト待機中...</div>
            </div>
        </div>
        
        <div class="improvement-card">
            <h2>🚀 統合診断デモ</h2>
            <button onclick="runFullDiagnosis()" style="font-size: 16px; padding: 15px 40px;">
                完全診断を実行
            </button>
            <div id="diagnosis-result" class="result-box" style="min-height: 200px;">
                診断待機中...
            </div>
        </div>
    </div>
    
    <script src="improved-diagnosis-logic.js"></script>
    <script>
        // 改善ロジックのインスタンス化
        const logic = new ImprovedDiagnosisLogic();
        const validator = new DiagnosisValidator(logic);
        
        // 純卦テスト
        function testPureHexagrams() {
            const resultDiv = document.getElementById('pure-result');
            resultDiv.innerHTML = '<span class="info">純卦テスト実行中...</span>\n\n';
            
            const pureHexagrams = [
                { name: "乾為天", upper: "乾", lower: "乾", id: 1 },
                { name: "坤為地", upper: "坤", lower: "坤", id: 2 },
                { name: "坎為水", upper: "坎", lower: "坎", id: 29 },
                { name: "離為火", upper: "離", lower: "離", id: 30 },
                { name: "震為雷", upper: "震", lower: "震", id: 51 },
                { name: "艮為山", upper: "艮", lower: "艮", id: 52 },
                { name: "巽為風", upper: "巽", lower: "巽", id: 57 },
                { name: "兌為沢", upper: "兌", lower: "兌", id: 58 }
            ];
            
            let result = '純卦生成テスト:\n';
            result += '━━━━━━━━━━━━━━━━━━━━━━━━\n';
            
            pureHexagrams.forEach(pure => {
                const hexagram = logic.determineHexagram(pure.upper, pure.lower);
                const correct = hexagram.id === pure.id;
                result += `${pure.name} (#${pure.id}): `;
                result += correct ? 
                    `<span class="success">✅ 正常生成</span>\n` : 
                    `<span class="error">❌ エラー (got #${hexagram.id})</span>\n`;
            });
            
            // ランダムベクトルでの純卦出現テスト
            result += '\n純卦自然出現テスト (100回):\n';
            const pureAppeared = new Set();
            
            for (let i = 0; i < 100; i++) {
                // 一つの八卦を強くする
                const strongBagua = logic.BAGUA_ORDER[Math.floor(Math.random() * 8)];
                const vector = {};
                logic.BAGUA_ORDER.forEach(bagua => {
                    vector[bagua] = bagua === strongBagua ? 1.0 : Math.random() * 0.1;
                });
                
                const selection = logic.selectTopBagua(vector, true);
                if (selection.isPure) {
                    const hexagram = logic.determineHexagram(selection.upper, selection.lower);
                    pureAppeared.add(hexagram.id);
                }
            }
            
            result += `出現した純卦: ${pureAppeared.size}/8\n`;
            result += pureAppeared.size > 0 ? 
                '<span class="success">✅ 純卦が自然に出現</span>' : 
                '<span class="warning">⚠️ 純卦が出現しにくい</span>';
            
            resultDiv.innerHTML = result;
        }
        
        // 網羅性テスト
        function testCoverage() {
            const resultDiv = document.getElementById('coverage-result');
            resultDiv.innerHTML = '<span class="info">網羅性テスト実行中...</span>\n\n';
            
            const coverage = validator.testCoverage(1000);
            
            let result = '64卦網羅性テスト (1000回):\n';
            result += '━━━━━━━━━━━━━━━━━━━━━━━━\n';
            result += `出現卦数: ${coverage.totalAppeared}/64\n`;
            result += `カバー率: ${(coverage.coverage * 100).toFixed(1)}%\n`;
            result += `純卦カバー率: ${(coverage.pureHexagramsCoverage * 100).toFixed(1)}%\n\n`;
            
            if (coverage.missing.length > 0) {
                result += `<span class="warning">未出現の卦: ${coverage.missing.join(', ')}</span>\n`;
            } else {
                result += '<span class="success">✅ 全64卦が出現可能</span>\n';
            }
            
            result += '\n純卦出現状況:\n';
            coverage.pureHexagramsAppeared.forEach(id => {
                result += `  卦#${id}: ${coverage.distribution[id]}回\n`;
            });
            
            resultDiv.innerHTML = result;
        }
        
        // 次元変換テスト
        function testDimensionConversion() {
            const resultDiv = document.getElementById('dimension-result');
            resultDiv.innerHTML = '<span class="info">次元変換テスト実行中...</span>\n\n';
            
            // Interface OS変換テスト
            const interfaceVector = {
                "外向_主導性": 1.0,
                "外向_調和性": 0.8,
                "外向_表現性": 0.6,
                "外向_行動性": 0.4,
                "内向_適応性": 0.3,
                "内向_分析性": 0.5,
                "内向_安定性": 0.7,
                "内向_支援性": 0.9
            };
            
            const baguaVector = logic.convertInterfaceToBagua(interfaceVector);
            
            let result = 'Interface OS → 八卦変換:\n';
            result += '━━━━━━━━━━━━━━━━━━━━━━━━\n';
            Object.entries(baguaVector).forEach(([bagua, value]) => {
                result += `  ${bagua}: ${value.toFixed(3)}\n`;
            });
            
            // Safe Mode OS変換テスト
            const safemodeVector = {
                "防御_対抗性": 0.8,
                "防御_調和性": 0.6,
                "防御_変容性": 0.4,
                "防御_堅固性": 0.7,
                "防御_回避性": 0.5,
                "防御_持久性": 0.9,
                "防御_境界性": 0.3,
                "防御_撤退性": 0.2
            };
            
            const safeBaguaVector = logic.convertSafeModeToBagua(safemodeVector);
            
            result += '\nSafe Mode OS → 八卦変換:\n';
            result += '━━━━━━━━━━━━━━━━━━━━━━━━\n';
            Object.entries(safeBaguaVector).forEach(([bagua, value]) => {
                result += `  ${bagua}: ${value.toFixed(3)}\n`;
            });
            
            result += '\n<span class="success">✅ 全OSが八卦次元に統一</span>';
            
            resultDiv.innerHTML = result;
        }
        
        // 正規化テスト
        function testNormalization() {
            const resultDiv = document.getElementById('normalization-result');
            resultDiv.innerHTML = '<span class="info">正規化プロセステスト...</span>\n\n';
            
            const rawVector = {
                "乾": 10,
                "兌": 5,
                "離": 8,
                "震": 3,
                "巽": 6,
                "坎": 7,
                "艮": 4,
                "坤": 2
            };
            
            const normalized = logic.normalizeVector(rawVector, 'engine');
            
            let result = '正規化プロセス:\n';
            result += '━━━━━━━━━━━━━━━━━━━━━━━━\n';
            result += '入力ベクトル:\n';
            Object.entries(rawVector).forEach(([k, v]) => {
                result += `  ${k}: ${v}\n`;
            });
            
            result += '\n正規化後（Z-score→ReLU→L1）:\n';
            let sum = 0;
            Object.entries(normalized).forEach(([k, v]) => {
                result += `  ${k}: ${v.toFixed(3)}\n`;
                sum += v;
            });
            
            result += `\n合計: ${sum.toFixed(3)}`;
            result += Math.abs(sum - 1.0) < 0.001 ? 
                ' <span class="success">✅ 正規化成功</span>' :
                ' <span class="error">❌ 正規化エラー</span>';
            
            resultDiv.innerHTML = result;
        }
        
        // 確信度テスト
        function testConfidence() {
            const resultDiv = document.getElementById('confidence-result');
            resultDiv.innerHTML = '<span class="info">確信度評価テスト...</span>\n\n';
            
            const distribution = validator.testConfidenceDistribution(1000);
            
            let result = '確信度分布 (1000回):\n';
            result += '━━━━━━━━━━━━━━━━━━━━━━━━\n';
            result += `高確信度: ${(distribution.high * 100).toFixed(1)}%\n`;
            result += `中確信度: ${(distribution.medium * 100).toFixed(1)}%\n`;
            result += `低確信度: ${(distribution.low * 100).toFixed(1)}%\n\n`;
            
            // 具体例
            const examples = [
                { vector: {"乾": 1.0, "兌": 0.1, "離": 0.1, "震": 0.1, "巽": 0.1, "坎": 0.1, "艮": 0.1, "坤": 0.1}, label: "明確な傾向" },
                { vector: {"乾": 0.5, "兌": 0.4, "離": 0.3, "震": 0.2, "巽": 0.1, "坎": 0.1, "艮": 0.1, "坤": 0.1}, label: "やや明確" },
                { vector: {"乾": 0.3, "兌": 0.29, "離": 0.28, "震": 0.27, "巽": 0.26, "坎": 0.25, "艮": 0.24, "坤": 0.23}, label: "僅差" }
            ];
            
            result += '具体例:\n';
            examples.forEach(ex => {
                const normalized = logic.normalizeVector(ex.vector, 'engine');
                const selection = logic.selectTopBagua(normalized, true);
                result += `${ex.label}: ${selection.confidence.level} (${selection.confidence.score.toFixed(3)})\n`;
            });
            
            resultDiv.innerHTML = result;
        }
        
        // 一貫性テスト
        function testConsistency() {
            const resultDiv = document.getElementById('consistency-result');
            resultDiv.innerHTML = '<span class="info">一貫性テスト実行中...</span>\n\n';
            
            const consistency = validator.testConsistency(100);
            
            let result = '決定論的一貫性テスト:\n';
            result += '━━━━━━━━━━━━━━━━━━━━━━━━\n';
            result += `一貫性: ${(consistency.consistency * 100).toFixed(1)}%\n`;
            result += consistency.consistency === 1.0 ? 
                '<span class="success">✅ 完全な決定論的動作</span>' :
                '<span class="error">❌ 非決定論的な要素あり</span>';
            
            resultDiv.innerHTML = result;
        }
        
        // 統合診断デモ
        function runFullDiagnosis() {
            const resultDiv = document.getElementById('diagnosis-result');
            resultDiv.innerHTML = '<span class="info">完全診断実行中...</span>\n\n';
            
            let result = '🔍 改善ロジックによる診断結果\n';
            result += '━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
            
            // 3つのOSを診断
            ['engine', 'interface', 'safemode'].forEach(osType => {
                const diagnosis = logic.diagnoseOS([], osType);
                
                result += `📊 ${osType.toUpperCase()} OS:\n`;
                result += `  卦番号: #${diagnosis.hexagramId}\n`;
                result += `  上卦: ${diagnosis.upperBagua}\n`;
                result += `  下卦: ${diagnosis.lowerBagua}\n`;
                
                if (diagnosis.isPureHexagram) {
                    result += '  <span class="warning">純卦</span>\n';
                }
                
                result += `  確信度: ${diagnosis.confidence.level} (${diagnosis.confidence.score.toFixed(2)})\n`;
                result += `  ${diagnosis.confidence.description}\n\n`;
            });
            
            result += '<span class="success">✅ 診断完了</span>';
            
            resultDiv.innerHTML = result;
        }
    </script>
</body>
</html>