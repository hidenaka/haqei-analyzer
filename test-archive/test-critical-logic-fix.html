<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>重大ロジック修正検証 - HaQei OS Analyzer</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .test-title {
            font-size: 20px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
        }
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 2px solid #dee2e6;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            overflow-x: auto;
        }
        .status-good {
            color: #28a745;
            font-weight: bold;
        }
        .status-bad {
            color: #dc3545;
            font-weight: bold;
        }
        .status-warning {
            color: #ffc107;
            font-weight: bold;
        }
        .issue-fixed {
            background: #d4edda;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .issue-pending {
            background: #f8d7da;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 重大ロジック修正検証ツール</h1>
        
        <div class="test-section">
            <div class="test-title">📋 修正項目チェックリスト</div>
            <div id="checklist">
                <div class="issue-fixed">✅ Phase 1: Interface OS質問範囲をQ25-30からQ13-24に修正</div>
                <div class="issue-fixed">✅ Phase 2: キーワード重複加点防止（matchedフラグ確認）</div>
                <div class="issue-fixed">✅ Phase 3: 三爻重複時の処理（第3位使用）</div>
                <div class="issue-fixed">✅ Phase 4: 64卦マトリックス適用</div>
                <div class="issue-pending">⏳ Phase 5: 動作検証中...</div>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">🧪 テスト1: Interface OS質問範囲確認</div>
            <button class="test-button" onclick="testInterfaceQuestionRange()">質問範囲をテスト</button>
            <div id="test1-result" class="result-area">テスト結果がここに表示されます...</div>
        </div>

        <div class="test-section">
            <div class="test-title">🧪 テスト2: キーワード適合度計算</div>
            <button class="test-button" onclick="testKeywordFitness()">キーワード計算をテスト</button>
            <div id="test2-result" class="result-area">テスト結果がここに表示されます...</div>
        </div>

        <div class="test-section">
            <div class="test-title">🧪 テスト3: 三爻重複処理</div>
            <button class="test-button" onclick="testTrigramDuplication()">重複処理をテスト</button>
            <div id="test3-result" class="result-area">テスト結果がここに表示されます...</div>
        </div>

        <div class="test-section">
            <div class="test-title">🧪 テスト4: 64卦マトリックス使用確認</div>
            <button class="test-button" onclick="testHexagramMatrix()">マトリックス使用をテスト</button>
            <div id="test4-result" class="result-area">テスト結果がここに表示されます...</div>
        </div>

        <div class="test-section">
            <div class="test-title">🧪 テスト5: 総合動作確認（全OSタイプ）</div>
            <button class="test-button" onclick="testAllOSTypes()">全OSタイプをテスト</button>
            <div id="test5-result" class="result-area">テスト結果がここに表示されます...</div>
        </div>
    </div>

    <!-- os_analyzer.htmlを動的に読み込む -->
    <iframe id="analyzer-frame" src="os_analyzer.html" style="display:none;"></iframe>

    <script>
        let analyzer = null;

        // iframe読み込み完了後にanalyzerを取得
        document.getElementById('analyzer-frame').onload = function() {
            const iframe = document.getElementById('analyzer-frame');
            const iframeWindow = iframe.contentWindow;
            if (iframeWindow.window.osAnalyzer) {
                analyzer = iframeWindow.window.osAnalyzer;
                console.log('✅ OS Analyzer loaded successfully');
            }
        };

        // テスト1: Interface OS質問範囲確認
        function testInterfaceQuestionRange() {
            const resultDiv = document.getElementById('test1-result');
            resultDiv.innerHTML = 'テスト実行中...\n\n';
            
            try {
                // analyzeSocialPatternsメソッドのソースコードを確認
                const analyzerCode = analyzer.analyzeSocialPatterns.toString();
                
                // Q13-Q24が使われているか確認
                const hasQ13 = analyzerCode.includes('Q13');
                const hasQ14 = analyzerCode.includes('Q14');
                const hasQ24 = analyzerCode.includes('Q24');
                
                // Q25-Q30が残っていないか確認
                const hasQ25 = analyzerCode.includes('Q25');
                const hasQ26 = analyzerCode.includes('Q26');
                const hasQ30 = analyzerCode.includes('Q30');
                
                let result = '📊 analyzeSocialPatterns メソッドチェック:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                
                if (hasQ13 && hasQ14 && hasQ24) {
                    result += '<span class="status-good">✅ Q13-Q24の参照: 正常に修正されています</span>\n';
                } else {
                    result += '<span class="status-bad">❌ Q13-Q24の参照: 修正が不完全です</span>\n';
                }
                
                if (!hasQ25 && !hasQ26 && !hasQ30) {
                    result += '<span class="status-good">✅ Q25-Q30の除去: 完全に削除されています</span>\n';
                } else {
                    result += '<span class="status-warning">⚠️ Q25-Q30の参照: まだ残っている可能性があります</span>\n';
                }
                
                // buildInterfaceVectorも確認
                const vectorCode = analyzer.buildInterfaceVector.toString();
                const vectorHasQ13 = vectorCode.includes('Q13');
                const vectorHasQ25 = vectorCode.includes('Q25');
                
                result += '\n📊 buildInterfaceVector メソッドチェック:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                
                if (vectorHasQ13 && !vectorHasQ25) {
                    result += '<span class="status-good">✅ ベクトル構築: Q13-Q24を正しく使用</span>\n';
                } else {
                    result += '<span class="status-warning">⚠️ ベクトル構築: 確認が必要です</span>\n';
                }
                
                resultDiv.innerHTML = result;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-bad">エラー: ${error.message}</span>`;
            }
        }

        // テスト2: キーワード適合度計算
        function testKeywordFitness() {
            const resultDiv = document.getElementById('test2-result');
            resultDiv.innerHTML = 'テスト実行中...\n\n';
            
            try {
                const testKeywords = ['創造', '協力', '安定', '探求', '調和'];
                const osTypes = ['engine', 'interface', 'safemode'];
                
                let result = '📊 キーワード適合度計算テスト:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                
                osTypes.forEach(osType => {
                    const score = analyzer.calculateKeywordFitness(testKeywords, osType, []);
                    result += `${osType.toUpperCase()} OS: スコア = ${score.toFixed(2)}\n`;
                });
                
                result += '\n📝 matchedフラグの動作確認:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                
                // calculateKeywordFitnessのコードを確認
                const fitnessCode = analyzer.calculateKeywordFitness.toString();
                const hasMatchedFlag = fitnessCode.includes('let matched = false');
                const hasMatchedCheck = fitnessCode.includes('if (!matched)');
                
                if (hasMatchedFlag && hasMatchedCheck) {
                    result += '<span class="status-good">✅ 重複加点防止: matchedフラグが正しく実装されています</span>\n';
                } else {
                    result += '<span class="status-bad">❌ 重複加点防止: matchedフラグの実装に問題があります</span>\n';
                }
                
                resultDiv.innerHTML = result;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-bad">エラー: ${error.message}</span>`;
            }
        }

        // テスト3: 三爻重複処理
        function testTrigramDuplication() {
            const resultDiv = document.getElementById('test3-result');
            resultDiv.innerHTML = 'テスト実行中...\n\n';
            
            try {
                // 重複するエネルギーパターンを作成
                const duplicatedVector = {
                    "乾_創造性": 100,
                    "兌_調和性": 20,
                    "離_表現性": 15,
                    "震_行動性": 10,
                    "巽_適応性": 8,
                    "坎_探求性": 5,
                    "艮_安定性": 3,
                    "坤_受容性": 2
                };
                
                let result = '📊 三爻重複処理テスト:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                
                // mapTrigramsToHexagramのコードを確認
                const mapCode = analyzer.mapTrigramsToHexagram.toString();
                const hasDuplicationCheck = mapCode.includes('topTrigram1 === topTrigram2');
                const usesThirdTrigram = mapCode.includes('sortedTrigrams[2]');
                
                if (hasDuplicationCheck && usesThirdTrigram) {
                    result += '<span class="status-good">✅ 重複処理: 第3位の三爻を使用する処理が実装されています</span>\n\n';
                } else {
                    result += '<span class="status-warning">⚠️ 重複処理: 実装が不完全な可能性があります</span>\n\n';
                }
                
                result += '📝 エネルギー分布例（乾が圧倒的に強い場合）:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n';
                result += '乾_創造性: 100 (第1位)\n';
                result += '兌_調和性: 20 (第2位)\n';
                result += '離_表現性: 15 (第3位) ← 重複時はこれが使われる\n';
                result += '\n期待される動作:\n';
                result += '通常: 乾(上) + 兌(下) または 兌(上) + 乾(下)\n';
                result += '重複時: 乾(上) + 離(下) または 離(上) + 乾(下)\n';
                
                resultDiv.innerHTML = result;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-bad">エラー: ${error.message}</span>`;
            }
        }

        // テスト4: 64卦マトリックス使用確認
        function testHexagramMatrix() {
            const resultDiv = document.getElementById('test4-result');
            resultDiv.innerHTML = 'テスト実行中...\n\n';
            
            try {
                let result = '📊 64卦マトリックス使用確認:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                
                // mapTrigramsToHexagramのコードを確認
                const mapCode = analyzer.mapTrigramsToHexagram.toString();
                const hasMatrix = mapCode.includes('authenticHexagramMatrix');
                const usesMatrix = mapCode.includes('authenticHexagramMatrix[topTrigramId1 - 1][topTrigramId2 - 1]');
                
                if (hasMatrix && usesMatrix) {
                    result += '<span class="status-good">✅ マトリックス使用: 正統的64卦マトリックスが使用されています</span>\n\n';
                } else {
                    result += '<span class="status-bad">❌ マトリックス使用: 単純計算式が使われている可能性があります</span>\n\n';
                }
                
                // テスト計算
                result += '📝 マトリックス計算例:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n';
                result += '乾(1)上 + 坤(8)下 = 天地否(#12) [マトリックス値]\n';
                result += '坎(6)上 + 離(3)下 = 水火既済(#63) [マトリックス値]\n';
                result += '\n※単純計算では異なる値になる場合があります\n';
                
                resultDiv.innerHTML = result;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-bad">エラー: ${error.message}</span>`;
            }
        }

        // テスト5: 総合動作確認
        function testAllOSTypes() {
            const resultDiv = document.getElementById('test5-result');
            resultDiv.innerHTML = 'テスト実行中...\n\n';
            
            try {
                // 模擬回答データ（全A回答）
                const allAAnswers = Array(36).fill('A');
                const mockAnswers = {
                    values: allAAnswers.slice(0, 12),      // Q1-Q12: Engine OS
                    scenarios: allAAnswers.slice(12, 24),   // Q13-Q24: Interface OS
                    defensive: allAAnswers.slice(24, 36)    // Q25-Q36: Safe Mode OS
                };
                
                let result = '📊 総合動作確認（全A回答でテスト）:\n';
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n\n';
                
                // Engine OS分析
                const engineOS = analyzer.analyzeEngineOS(mockAnswers.values);
                result += `🎯 Engine OS:\n`;
                result += `  卦: ${engineOS.hexagramName || 'N/A'} (#${engineOS.hexagramId || 'N/A'})\n`;
                result += `  上卦: ${engineOS.upperTrigram || 'N/A'}\n`;
                result += `  下卦: ${engineOS.lowerTrigram || 'N/A'}\n\n`;
                
                // Interface OS分析
                const interfaceOS = analyzer.analyzeInterfaceOS(mockAnswers.scenarios, engineOS);
                result += `💬 Interface OS:\n`;
                result += `  卦: ${interfaceOS.hexagramName || 'N/A'} (#${interfaceOS.hexagramId || 'N/A'})\n`;
                result += `  上卦: ${interfaceOS.upperTrigram || 'N/A'}\n`;
                result += `  下卦: ${interfaceOS.lowerTrigram || 'N/A'}\n`;
                result += `  社会的スタイル: ${interfaceOS.socialStyle || 'N/A'}\n\n`;
                
                // Safe Mode OS分析
                const safeModeOS = analyzer.analyzeSafeModeOS(mockAnswers.defensive, engineOS);
                result += `🛡️ Safe Mode OS:\n`;
                result += `  卦: ${safeModeOS.hexagramName || 'N/A'} (#${safeModeOS.hexagramId || 'N/A'})\n`;
                result += `  防御タイプ: ${safeModeOS.defensiveType || 'N/A'}\n`;
                result += `  発動トリガー: ${safeModeOS.activationTrigger || 'N/A'}\n\n`;
                
                result += '━━━━━━━━━━━━━━━━━━━━━━━━━━\n';
                result += '<span class="status-good">✅ 全OSタイプが正常に計算されました</span>\n';
                
                resultDiv.innerHTML = result;
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="status-bad">エラー: ${error.message}\n\n${error.stack}</span>`;
            }
        }
    </script>
</body>
</html>