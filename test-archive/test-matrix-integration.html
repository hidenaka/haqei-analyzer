<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>マトリクス統合テスト</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1000px;
            margin: 20px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 1.2em;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 10px;
        }
        .test-result {
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <h1>🔬 os_analyzer.html マトリクス統合テスト</h1>
    
    <div style="text-align: center;">
        <button onclick="runAllTests()">全テスト実行</button>
        <button onclick="clearResults()">結果クリア</button>
    </div>

    <!-- テスト1: マトリクス定義確認 -->
    <div class="test-section">
        <div class="test-title">📋 テスト1: マトリクス定義確認</div>
        <div id="matrix-definition-test" class="test-result info">テスト待機中...</div>
    </div>

    <!-- テスト2: 専門家推奨アサーション -->
    <div class="test-section">
        <div class="test-title">✅ テスト2: 専門家推奨アサーション</div>
        <div id="assertion-test" class="test-result info">テスト待機中...</div>
    </div>

    <!-- テスト3: 純卦テスト -->
    <div class="test-section">
        <div class="test-title">☯ テスト3: 純卦（8つ）の生成確認</div>
        <div id="pure-hexagram-test" class="test-result info">テスト待機中...</div>
    </div>

    <!-- テスト4: 対称性テスト -->
    <div class="test-section">
        <div class="test-title">🔄 テスト4: 対称性確認</div>
        <div id="symmetry-test" class="test-result info">テスト待機中...</div>
    </div>

    <!-- テスト5: 実際の診断フロー -->
    <div class="test-section">
        <div class="test-title">⚡ テスト5: 実際の診断フローテスト</div>
        <div id="diagnosis-flow-test" class="test-result info">テスト待機中...</div>
    </div>

    <script>
        // マトリクス定義（os_analyzer.htmlと同じ）
        const authenticHexagramMatrix = [
            // 上卦: 乾（天）, 下卦: 乾,兌,離,震,巽,坎,艮,坤
            [1,  10, 13, 25, 44,  6, 33, 12],
            // 上卦: 兌（沢）
            [43, 58, 49, 17, 28, 47, 31, 45],
            // 上卦: 離（火）
            [14, 38, 30, 21, 50, 64, 56, 35],
            // 上卦: 震（雷）
            [34, 54, 55, 51, 32, 40, 62, 16],
            // 上卦: 巽（風）
            [9,  61, 37, 42, 57, 59, 53, 20],
            // 上卦: 坎（水）
            [5,  60, 63,  3, 48, 29, 39,  8],
            // 上卦: 艮（山）
            [26, 41, 22, 27, 18,  4, 52, 23],
            // 上卦: 坤（地）
            [11, 19, 36, 24, 46,  7, 15,  2]
        ];

        const BAGUA_ORDER = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
        
        function getHexagramId(upperBagua, lowerBagua) {
            const upperIndex = BAGUA_ORDER.indexOf(upperBagua);
            const lowerIndex = BAGUA_ORDER.indexOf(lowerBagua);
            
            if (upperIndex === -1 || lowerIndex === -1) {
                throw new Error(`Invalid bagua: upper=${upperBagua}, lower=${lowerBagua}`);
            }
            
            return authenticHexagramMatrix[upperIndex][lowerIndex];
        }

        // テスト1: マトリクス定義確認
        function testMatrixDefinition() {
            const element = document.getElementById('matrix-definition-test');
            let output = "";
            
            try {
                output += "マトリクスサイズ: " + authenticHexagramMatrix.length + "×" + authenticHexagramMatrix[0].length + "\n";
                
                // 全要素が1-64の範囲内か確認
                const allValues = new Set();
                for (let i = 0; i < 8; i++) {
                    for (let j = 0; j < 8; j++) {
                        const value = authenticHexagramMatrix[i][j];
                        if (value < 1 || value > 64) {
                            throw new Error(`Invalid value ${value} at [${i}][${j}]`);
                        }
                        allValues.add(value);
                    }
                }
                
                output += "カバー卦数: " + allValues.size + "/64\n";
                output += "範囲チェック: ✅ 全値が1-64の範囲内\n";
                
                element.className = "test-result success";
                element.textContent = output;
                return true;
            } catch (error) {
                output += "❌ エラー: " + error.message;
                element.className = "test-result error";
                element.textContent = output;
                return false;
            }
        }

        // テスト2: 専門家推奨アサーション
        function testAssertions() {
            const element = document.getElementById('assertion-test');
            let output = "";
            
            const assertions = [
                { upper: "乾", lower: "乾", expected: 1, name: "乾為天" },
                { upper: "乾", lower: "坎", expected: 6, name: "天水訟" },
                { upper: "坎", lower: "乾", expected: 5, name: "水天需" },
                { upper: "乾", lower: "離", expected: 13, name: "天火同人" },
                { upper: "離", lower: "乾", expected: 14, name: "火天大有" }
            ];
            
            let allPassed = true;
            
            assertions.forEach(test => {
                try {
                    const actual = getHexagramId(test.upper, test.lower);
                    const passed = actual === test.expected;
                    
                    if (passed) {
                        output += `✅ ${test.upper}/${test.lower} = #${actual} (${test.name})\n`;
                    } else {
                        output += `❌ ${test.upper}/${test.lower} = #${actual}, 期待値: #${test.expected} (${test.name})\n`;
                        allPassed = false;
                    }
                } catch (error) {
                    output += `❌ エラー: ${error.message}\n`;
                    allPassed = false;
                }
            });
            
            element.className = allPassed ? "test-result success" : "test-result error";
            element.textContent = output;
            return allPassed;
        }

        // テスト3: 純卦テスト
        function testPureHexagrams() {
            const element = document.getElementById('pure-hexagram-test');
            let output = "";
            
            const pureTests = [
                { bagua: "乾", expected: 1, name: "乾為天" },
                { bagua: "坤", expected: 2, name: "坤為地" },
                { bagua: "坎", expected: 29, name: "坎為水" },
                { bagua: "離", expected: 30, name: "離為火" },
                { bagua: "震", expected: 51, name: "震為雷" },
                { bagua: "艮", expected: 52, name: "艮為山" },
                { bagua: "巽", expected: 57, name: "巽為風" },
                { bagua: "兌", expected: 58, name: "兌為沢" }
            ];
            
            let allPassed = true;
            
            pureTests.forEach(test => {
                const actual = getHexagramId(test.bagua, test.bagua);
                const passed = actual === test.expected;
                
                if (passed) {
                    output += `✅ ${test.bagua}/${test.bagua} = #${actual} ${test.name}\n`;
                } else {
                    output += `❌ ${test.bagua}/${test.bagua} = #${actual}, 期待値: #${test.expected}\n`;
                    allPassed = false;
                }
            });
            
            element.className = allPassed ? "test-result success" : "test-result error";
            element.textContent = output;
            return allPassed;
        }

        // テスト4: 対称性テスト
        function testSymmetry() {
            const element = document.getElementById('symmetry-test');
            let output = "";
            
            const pairs = [
                ["乾", "坎"],
                ["乾", "離"],
                ["兌", "巽"],
                ["震", "艮"]
            ];
            
            pairs.forEach(([bagua1, bagua2]) => {
                const id1 = getHexagramId(bagua1, bagua2);
                const id2 = getHexagramId(bagua2, bagua1);
                
                output += `${bagua1}/${bagua2} = #${id1}\n`;
                output += `${bagua2}/${bagua1} = #${id2}\n`;
                output += `異なる卦: ${id1 !== id2 ? "✅" : "❌"}\n\n`;
            });
            
            element.className = "test-result success";
            element.textContent = output;
            return true;
        }

        // テスト5: 実際の診断フロー
        function testDiagnosisFlow() {
            const element = document.getElementById('diagnosis-flow-test');
            let output = "";
            
            try {
                // 模擬的な八卦エネルギー
                const baguaEnergies = {
                    "乾": 45,
                    "離": 30,
                    "兌": 15,
                    "震": 10,
                    "巽": 5,
                    "坎": 3,
                    "艮": 2,
                    "坤": 1
                };
                
                // ソート
                const sorted = Object.entries(baguaEnergies).sort((a, b) => b[1] - a[1]);
                const topBagua1 = sorted[0][0];
                const topBagua2 = sorted[1][0];
                
                output += `Top 2 八卦: ${topBagua1} (${sorted[0][1]}%), ${topBagua2} (${sorted[1][1]}%)\n`;
                
                // 両方向の卦を計算
                const hexagramId1 = getHexagramId(topBagua1, topBagua2);
                const hexagramId2 = getHexagramId(topBagua2, topBagua1);
                
                output += `候補1: ${topBagua1}/${topBagua2} = #${hexagramId1}\n`;
                output += `候補2: ${topBagua2}/${topBagua1} = #${hexagramId2}\n`;
                
                // 簡易的な選択（実際はキーワード適合度で判断）
                output += `\n選択: #${hexagramId1} (実際はキーワード適合度で決定)\n`;
                
                element.className = "test-result success";
                element.textContent = output;
                return true;
            } catch (error) {
                output += "❌ エラー: " + error.message;
                element.className = "test-result error";
                element.textContent = output;
                return false;
            }
        }

        // 全テスト実行
        function runAllTests() {
            console.log("=== マトリクス統合テスト開始 ===");
            
            const results = {
                matrixDefinition: testMatrixDefinition(),
                assertions: testAssertions(),
                pureHexagrams: testPureHexagrams(),
                symmetry: testSymmetry(),
                diagnosisFlow: testDiagnosisFlow()
            };
            
            const allPassed = Object.values(results).every(r => r);
            
            console.log("=== テスト結果 ===");
            console.log(results);
            console.log(`総合結果: ${allPassed ? "✅ 全テスト成功" : "❌ 失敗あり"}`);
            
            if (allPassed) {
                alert("✅ 全テスト成功！マトリクス統合は正常です。");
            } else {
                alert("❌ テストに失敗があります。詳細を確認してください。");
            }
        }

        // 結果クリア
        function clearResults() {
            const elements = document.querySelectorAll('.test-result');
            elements.forEach(el => {
                el.className = 'test-result info';
                el.textContent = 'テスト待機中...';
            });
        }

        // ページロード時に自動実行
        window.onload = () => {
            setTimeout(runAllTests, 500);
        };
    </script>
</body>
</html>