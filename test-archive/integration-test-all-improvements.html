<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaQei OS Analyzer - çµ±åˆæ”¹å–„ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2em;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            background: #f9f9f9;
        }
        .test-title {
            font-size: 1.3em;
            color: #667eea;
            margin-bottom: 15px;
            font-weight: bold;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #5a67d8;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .metric {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        .metric-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ HaQei OS Analyzer çµ±åˆæ”¹å–„ãƒ†ã‚¹ãƒˆ</h1>
        <p style="text-align: center; color: #666;">å°‚é–€å®¶ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã«åŸºã¥ãå…¨æ”¹å–„ã®çµ±åˆæ¤œè¨¼</p>
        
        <div style="text-align: center; margin: 20px 0;">
            <button onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
            <button onclick="exportResults()">ğŸ“Š çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ1: çµ±ä¸€è¨­å®šæ¤œè¨¼ -->
        <div class="test-section">
            <div class="test-title">ğŸ“‹ ãƒ†ã‚¹ãƒˆ1: çµ±ä¸€è¨­å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¤œè¨¼</div>
            <div id="config-test" class="test-result info">ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ2: 64å¦ãƒãƒˆãƒªã‚¯ã‚¹æ¤œè¨¼ -->
        <div class="test-section">
            <div class="test-title">ğŸ¯ ãƒ†ã‚¹ãƒˆ2: 64å¦ãƒãƒˆãƒªã‚¯ã‚¹æ­£ç¢ºæ€§</div>
            <div id="matrix-test" class="test-result info">ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ3: æ­£è¦åŒ–ã‚·ã‚¹ãƒ†ãƒ  -->
        <div class="test-section">
            <div class="test-title">ğŸ“Š ãƒ†ã‚¹ãƒˆ3: æ­£è¦åŒ–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆ3ãƒ¢ãƒ¼ãƒ‰ï¼‰</div>
            <div id="normalization-test" class="test-result info">ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ4: å‘ãé¸æŠãƒ­ã‚¸ãƒƒã‚¯ -->
        <div class="test-section">
            <div class="test-title">ğŸ”„ ãƒ†ã‚¹ãƒˆ4: ä¸Šä¸‹å¦ã®å‘ãé¸æŠ</div>
            <div id="direction-test" class="test-result info">ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ5: ç¢ºä¿¡åº¦ã‚·ã‚¹ãƒ†ãƒ  -->
        <div class="test-section">
            <div class="test-title">ğŸ’¯ ãƒ†ã‚¹ãƒˆ5: ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ç¢ºä¿¡åº¦</div>
            <div id="confidence-test" class="test-result info">ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ6: æ„Ÿåº¦åˆ†æ -->
        <div class="test-section">
            <div class="test-title">ğŸ” ãƒ†ã‚¹ãƒˆ6: æ„Ÿåº¦åˆ†æï¼ˆå®‰å®šæ€§ï¼‰</div>
            <div id="sensitivity-test" class="test-result info">ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...</div>
        </div>

        <!-- ãƒ†ã‚¹ãƒˆ7: å®Œå…¨çµ±åˆè¨ºæ–­ -->
        <div class="test-section">
            <div class="test-title">âš¡ ãƒ†ã‚¹ãƒˆ7: å®Œå…¨çµ±åˆè¨ºæ–­ãƒ•ãƒ­ãƒ¼</div>
            <div id="integration-test" class="test-result info">ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...</div>
        </div>

        <!-- ã‚µãƒãƒªãƒ¼ -->
        <div class="summary" id="summary" style="display: none;">
            <h2 style="text-align: center; margin-bottom: 20px;">ğŸ“ˆ ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h2>
            <div class="grid">
                <div class="metric">
                    <div class="metric-label">æˆåŠŸç‡</div>
                    <div class="metric-value" id="success-rate">0%</div>
                </div>
                <div class="metric">
                    <div class="metric-label">å®Ÿè¡Œæ™‚é–“</div>
                    <div class="metric-value" id="execution-time">0ms</div>
                </div>
                <div class="metric">
                    <div class="metric-label">ãƒ†ã‚¹ãƒˆæ•°</div>
                    <div class="metric-value" id="test-count">0/7</div>
                </div>
                <div class="metric">
                    <div class="metric-label">æ”¹å–„é …ç›®</div>
                    <div class="metric-value" id="improvement-count">6</div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ”¹å–„ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®èª­ã¿è¾¼ã¿ -->
    <script src="unified-configuration.js"></script>
    <script src="hexagram-matrix-fix.js"></script>
    <script src="normalization-softmax.js"></script>
    <script src="direction-selection-logic.js"></script>
    <script src="calibrated-confidence-system.js"></script>
    <script src="sensitivity-analysis.js"></script>

    <script>
        // ãƒ†ã‚¹ãƒˆçµæœè¨˜éŒ²
        const testResults = {
            passed: 0,
            failed: 0,
            total: 7,
            details: []
        };

        // å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runAllTests() {
            console.log("ğŸš€ çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹");
            const startTime = performance.now();
            
            testResults.passed = 0;
            testResults.failed = 0;
            testResults.details = [];

            // å„ãƒ†ã‚¹ãƒˆã‚’é †ç•ªã«å®Ÿè¡Œ
            await testUnifiedConfiguration();
            await testHexagramMatrix();
            await testNormalizationSystem();
            await testDirectionSelection();
            await testConfidenceSystem();
            await testSensitivityAnalysis();
            await testFullIntegration();

            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            const endTime = performance.now();
            showSummary(endTime - startTime);
        }

        // ãƒ†ã‚¹ãƒˆ1: çµ±ä¸€è¨­å®š
        async function testUnifiedConfiguration() {
            const element = document.getElementById('config-test');
            let output = "=== çµ±ä¸€è¨­å®šãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«æ¤œè¨¼ ===\n\n";
            
            try {
                // CONFIGå­˜åœ¨ç¢ºèª
                if (typeof CONFIG === 'undefined') {
                    throw new Error("CONFIG not defined");
                }

                // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
                output += `âœ… ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${CONFIG.CONFIG_VERSION}\n`;
                output += `âœ… æœ€çµ‚æ›´æ–°: ${CONFIG.LAST_UPDATED}\n\n`;

                // å…«å¦é †åºç¢ºèª
                output += "å…«å¦é †åº:\n";
                CONFIG.BAGUA_ORDER.forEach((bagua, idx) => {
                    output += `  ${idx + 1}. ${bagua}\n`;
                });
                output += "\n";

                // ãƒãƒƒãƒ”ãƒ³ã‚°è¡Œåˆ—æ¤œè¨¼
                const validation = CONFIG.validateMappingMatrices();
                if (validation.valid) {
                    output += "âœ… ãƒãƒƒãƒ”ãƒ³ã‚°è¡Œåˆ—: æ­£å‰‡æ€§ç¢ºèª\n";
                    output += "  - Interface OSè¡Œåˆ—: å„æ¬¡å…ƒåˆè¨ˆ=1.0\n";
                    output += "  - Safe Mode OSè¡Œåˆ—: å„æ¬¡å…ƒåˆè¨ˆ=1.0\n";
                } else {
                    throw new Error("Matrix validation failed: " + validation.errors.join(", "));
                }

                // æ­£è¦åŒ–è¨­å®šç¢ºèª
                output += `\næ­£è¦åŒ–è¨­å®š:\n`;
                output += `  ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ¢ãƒ¼ãƒ‰: ${CONFIG.NORMALIZATION_CONFIG.defaultMode}\n`;
                output += `  æ¸©åº¦ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: ${CONFIG.NORMALIZATION_CONFIG.softmax.temperature}\n`;
                output += `  å¹³å¦æ™‚å‡¦ç†: ${CONFIG.NORMALIZATION_CONFIG.flatness.preferUniformOnFlat ? "å‡ç­‰å‡ºåŠ›" : "é€šå¸¸å‡¦ç†"}\n`;

                element.className = "test-result success";
                testResults.passed++;
            } catch (error) {
                output += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                element.className = "test-result error";
                testResults.failed++;
            }
            
            element.textContent = output;
        }

        // ãƒ†ã‚¹ãƒˆ2: 64å¦ãƒãƒˆãƒªã‚¯ã‚¹
        async function testHexagramMatrix() {
            const element = document.getElementById('matrix-test');
            let output = "=== 64å¦ãƒãƒˆãƒªã‚¯ã‚¹æ¤œè¨¼ ===\n\n";
            
            try {
                const fixer = new HexagramMatrixFix();
                
                // æ—¢çŸ¥ãƒšã‚¢ãƒ†ã‚¹ãƒˆ
                output += "æ—¢çŸ¥ãƒšã‚¢ã®æ¤œè¨¼:\n";
                const knownPairs = [
                    { upper: "ä¹¾", lower: "ä¹¾", expected: 1, name: "ä¹¾ç‚ºå¤©" },
                    { upper: "å¤", lower: "å¤", expected: 2, name: "å¤ç‚ºåœ°" },
                    { upper: "å", lower: "ä¹¾", expected: 5, name: "æ°´å¤©éœ€" },
                    { upper: "ä¹¾", lower: "å", expected: 6, name: "å¤©æ°´è¨Ÿ" },
                    { upper: "ä¹¾", lower: "é›¢", expected: 13, name: "å¤©ç«åŒäºº" },
                    { upper: "é›¢", lower: "ä¹¾", expected: 14, name: "ç«å¤©å¤§æœ‰" },
                    { upper: "å…Œ", lower: "å·½", expected: 28, name: "æ²¢é¢¨å¤§é" }
                ];

                let allCorrect = true;
                for (const pair of knownPairs) {
                    const result = fixer.getHexagramId(pair.upper, pair.lower);
                    const status = result === pair.expected ? "âœ…" : "âŒ";
                    output += `  ${status} ${pair.upper}/${pair.lower} = #${result} ${pair.name}\n`;
                    if (result !== pair.expected) allCorrect = false;
                }

                if (!allCorrect) {
                    throw new Error("Some known pairs failed");
                }

                // ç¶²ç¾…æ€§ãƒ†ã‚¹ãƒˆ
                output += "\nç¶²ç¾…æ€§ãƒ†ã‚¹ãƒˆ:\n";
                const validation = fixer.validateMatrix();
                output += `  âœ… ã‚«ãƒãƒ¼å¦æ•°: ${validation.coverage.length}/64\n`;
                output += `  âœ… é‡è¤‡: ${validation.duplicates.length === 0 ? "ãªã—" : validation.duplicates.join(", ")}\n`;
                output += `  âœ… æ¬ è½: ${validation.missing.length === 0 ? "ãªã—" : validation.missing.join(", ")}\n`;

                // ç´”å¦ç¢ºèª
                output += "\nç´”å¦ç”Ÿæˆç¢ºèª:\n";
                const pureHexagrams = [
                    "ä¹¾", "å¤", "éœ‡", "å·½", "å", "é›¢", "è‰®", "å…Œ"
                ];
                for (const bagua of pureHexagrams) {
                    const id = fixer.getHexagramId(bagua, bagua);
                    output += `  âœ… ${bagua}/${bagua} = #${id}\n`;
                }

                element.className = "test-result success";
                testResults.passed++;
            } catch (error) {
                output += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                element.className = "test-result error";
                testResults.failed++;
            }
            
            element.textContent = output;
        }

        // ãƒ†ã‚¹ãƒˆ3: æ­£è¦åŒ–ã‚·ã‚¹ãƒ†ãƒ 
        async function testNormalizationSystem() {
            const element = document.getElementById('normalization-test');
            let output = "=== æ­£è¦åŒ–ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ ===\n\n";
            
            try {
                const normalizer = new ImprovedNormalizationSystem();
                
                // ãƒ†ã‚¹ãƒˆãƒ™ã‚¯ãƒˆãƒ«
                const testVector = {
                    "ä¹¾": 100, "å…Œ": 20, "é›¢": 10, "éœ‡": 5,
                    "å·½": 3, "å": 2, "è‰®": 1, "å¤": 1
                };

                // Softmaxæ­£è¦åŒ–
                output += "ã€Softmaxæ­£è¦åŒ– (Ï„=1.2)ã€‘\n";
                const softmaxResult = normalizer.softmaxNormalize(testVector, 1.2);
                for (const [key, value] of Object.entries(softmaxResult)) {
                    output += `  ${key}: ${(value * 100).toFixed(1)}%\n`;
                }
                
                // ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼è¨ˆç®—
                const entropy = normalizer.calculateEntropy(softmaxResult);
                output += `  ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼: ${entropy.toFixed(3)}\n\n`;

                // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¸å¤‰æ€§ãƒ†ã‚¹ãƒˆ
                output += "ã€ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¸å¤‰æ€§ãƒ†ã‚¹ãƒˆã€‘\n";
                const scaled = {};
                Object.entries(testVector).forEach(([k, v]) => {
                    scaled[k] = v * 10;
                });
                const scaledResult = normalizer.softmaxNormalize(scaled, 1.2);
                
                let maxDiff = 0;
                Object.keys(softmaxResult).forEach(key => {
                    const diff = Math.abs(softmaxResult[key] - scaledResult[key]);
                    maxDiff = Math.max(maxDiff, diff);
                });
                output += `  æœ€å¤§å·®åˆ†: ${(maxDiff * 100).toFixed(6)}%\n`;
                output += `  ${maxDiff < 0.0001 ? "âœ… ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¸å¤‰æ€§ç¢ºèª" : "âŒ ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¸å¤‰æ€§å¤±æ•—"}\n\n`;

                // å¹³å¦å…¥åŠ›ãƒ†ã‚¹ãƒˆ
                output += "ã€å¹³å¦å…¥åŠ›ãƒ†ã‚¹ãƒˆã€‘\n";
                const flatVector = {
                    "ä¹¾": 1, "å…Œ": 1, "é›¢": 1, "éœ‡": 1,
                    "å·½": 1, "å": 1, "è‰®": 1, "å¤": 1
                };
                const flatResult = normalizer.normalize(flatVector, 'engine', {
                    preferUniformOnFlat: true
                });
                const isUniform = Object.values(flatResult).every(v => 
                    Math.abs(v - 0.125) < 0.001
                );
                output += `  çµæœ: ${isUniform ? "âœ… å‡ç­‰åˆ†å¸ƒ (12.5% Ã— 8)" : "âŒ ä¸å‡ç­‰"}\n`;

                element.className = "test-result success";
                testResults.passed++;
            } catch (error) {
                output += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                element.className = "test-result error";
                testResults.failed++;
            }
            
            element.textContent = output;
        }

        // ãƒ†ã‚¹ãƒˆ4: å‘ãé¸æŠãƒ­ã‚¸ãƒƒã‚¯
        async function testDirectionSelection() {
            const element = document.getElementById('direction-test');
            let output = "=== ä¸Šä¸‹å¦ã®å‘ãé¸æŠãƒ†ã‚¹ãƒˆ ===\n\n";
            
            try {
                // ãƒ¢ãƒƒã‚¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚·ã‚¹ãƒ†ãƒ 
                const mockKeywordSystem = {
                    calculateNeutralFitness: (keywords, upper, lower, osType) => {
                        return { score: 0.5 + Math.random() * 0.3 };
                    }
                };
                
                const selector = new DirectionSelectionLogic(mockKeywordSystem, CONFIG);
                
                // ç´”å¦ãƒ†ã‚¹ãƒˆ
                output += "ã€ç´”å¦ã®å‡¦ç†ã€‘\n";
                const pureResult = selector.selectOptimalDirection("ä¹¾", "ä¹¾", "engine", null);
                output += `  çµæœ: ${pureResult.upper}/${pureResult.lower}\n`;
                output += `  ç´”å¦ãƒ•ãƒ©ã‚°: ${pureResult.isPureHexagram ? "âœ…" : "âŒ"}\n`;
                output += `  ç†ç”±: ${pureResult.selectionReason}\n\n`;

                // é€šå¸¸å¦ãƒ†ã‚¹ãƒˆ
                output += "ã€é€šå¸¸å¦ã®å‘ãé¸æŠã€‘\n";
                const normalResult = selector.selectOptimalDirection("é›¢", "å", "engine", null);
                output += `  å…¥åŠ›: é›¢ & å\n`;
                output += `  é¸æŠ: ${normalResult.upper}/${normalResult.lower}\n`;
                output += `  ã‚¹ã‚³ã‚¢: ${normalResult.score?.toFixed(3)}\n`;
                output += `  ä»£æ›¿ã‚¹ã‚³ã‚¢: ${normalResult.alternativeScore?.toFixed(3)}\n`;
                output += `  ç†ç”±: ${normalResult.selectionReason}\n\n`;

                // 100å›ãƒ©ãƒ³ãƒ€ãƒ ãƒ†ã‚¹ãƒˆ
                output += "ã€çµ±è¨ˆçš„æ¤œè¨¼ï¼ˆ100å›ï¼‰ã€‘\n";
                let reversalCount = 0;
                const baguaList = CONFIG.BAGUA_ORDER;
                
                for (let i = 0; i < 100; i++) {
                    const idx1 = Math.floor(Math.random() * 8);
                    const idx2 = Math.floor(Math.random() * 8);
                    
                    if (idx1 === idx2) continue;
                    
                    const bagua1 = baguaList[idx1];
                    const bagua2 = baguaList[idx2];
                    
                    const result = selector.selectOptimalDirection(bagua1, bagua2, "engine", null);
                    
                    if (result.upper === bagua2 && result.lower === bagua1) {
                        reversalCount++;
                    }
                }
                
                output += `  å…¥ã‚Œæ›¿ãˆç™ºç”Ÿç‡: ${reversalCount}%\n`;
                output += `  è©•ä¾¡: ${(reversalCount > 30 && reversalCount < 70) ? "âœ… é©åˆ‡ãªç¯„å›²" : "âš ï¸ åã‚Šã‚ã‚Š"}\n`;

                element.className = "test-result success";
                testResults.passed++;
            } catch (error) {
                output += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                element.className = "test-result error";
                testResults.failed++;
            }
            
            element.textContent = output;
        }

        // ãƒ†ã‚¹ãƒˆ5: ç¢ºä¿¡åº¦ã‚·ã‚¹ãƒ†ãƒ 
        async function testConfidenceSystem() {
            const element = document.getElementById('confidence-test');
            let output = "=== ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ¸ˆã¿ç¢ºä¿¡åº¦ãƒ†ã‚¹ãƒˆ ===\n\n";
            
            try {
                const system = new CalibratedConfidenceSystem(CONFIG);
                
                // é«˜ç¢ºä¿¡åº¦ã‚±ãƒ¼ã‚¹
                output += "ã€é«˜ç¢ºä¿¡åº¦ã‚±ãƒ¼ã‚¹ã€‘\n";
                const highConfidenceEnergies = {
                    "ä¹¾": 45, "å…Œ": 15, "é›¢": 10, "éœ‡": 8,
                    "å·½": 6, "å": 6, "è‰®": 5, "å¤": 5
                };
                
                const result1 = system.calculateCalibratedConfidence(highConfidenceEnergies);
                output += `  ã‚¹ã‚³ã‚¢: ${result1.score.toFixed(3)}\n`;
                output += `  ãƒ¬ãƒ™ãƒ«: ${result1.level}\n`;
                output += `  Gap: ${result1.metrics.gap.toFixed(3)}\n`;
                output += `  Entropy: ${result1.metrics.entropy.toFixed(3)}\n`;
                output += `  TopRatio: ${result1.metrics.topRatio.toFixed(2)}\n`;
                output += `  ç†ç”±: ${result1.details.reason}\n`;
                output += `  ä¿¡é ¼æ€§: ${result1.details.reliability}\n\n`;

                // ä½ç¢ºä¿¡åº¦ã‚±ãƒ¼ã‚¹
                output += "ã€ä½ç¢ºä¿¡åº¦ã‚±ãƒ¼ã‚¹ã€‘\n";
                const lowConfidenceEnergies = {
                    "ä¹¾": 14, "å…Œ": 13, "é›¢": 12.5, "éœ‡": 12,
                    "å·½": 12, "å": 12, "è‰®": 12, "å¤": 12.5
                };
                
                const result2 = system.calculateCalibratedConfidence(lowConfidenceEnergies);
                output += `  ã‚¹ã‚³ã‚¢: ${result2.score.toFixed(3)}\n`;
                output += `  ãƒ¬ãƒ™ãƒ«: ${result2.level}\n`;
                output += `  Gap: ${result2.metrics.gap.toFixed(3)}\n`;
                output += `  Entropy: ${result2.metrics.entropy.toFixed(3)}\n`;
                output += `  ç†ç”±: ${result2.details.reason}\n\n`;

                if (result2.alternatives) {
                    output += "  ä»£æ›¿å€™è£œ:\n";
                    result2.alternatives.forEach((alt, idx) => {
                        output += `    ${idx + 1}. ${alt.upper}/${alt.lower} (ç¢ºä¿¡åº¦: ${alt.confidence.toFixed(2)})\n`;
                    });
                }

                // å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ
                output += "\nã€å¢ƒç•Œå€¤ã®é€£ç¶šæ€§ã€‘\n";
                const testVectors = [
                    { "ä¹¾": 20, "å…Œ": 15, "é›¢": 12, "éœ‡": 11, "å·½": 11, "å": 11, "è‰®": 10, "å¤": 10 },
                    { "ä¹¾": 24, "å…Œ": 13, "é›¢": 11, "éœ‡": 11, "å·½": 10, "å": 11, "è‰®": 10, "å¤": 10 }
                ];
                
                testVectors.forEach((vector, idx) => {
                    const result = system.calculateCalibratedConfidence(vector);
                    output += `  ${idx + 1}. Gap=${result.metrics.gap.toFixed(3)} â†’ Score=${result.score.toFixed(3)} (${result.level})\n`;
                });

                element.className = "test-result success";
                testResults.passed++;
            } catch (error) {
                output += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                element.className = "test-result error";
                testResults.failed++;
            }
            
            element.textContent = output;
        }

        // ãƒ†ã‚¹ãƒˆ6: æ„Ÿåº¦åˆ†æ
        async function testSensitivityAnalysis() {
            const element = document.getElementById('sensitivity-test');
            let output = "=== æ„Ÿåº¦åˆ†æãƒ†ã‚¹ãƒˆ ===\n\n";
            
            try {
                const analyzer = new SensitivityAnalysis(null, CONFIG);
                
                // å®‰å®šçš„ãªã‚±ãƒ¼ã‚¹
                output += "ã€å®‰å®šçš„ãªã‚±ãƒ¼ã‚¹ã€‘\n";
                const stableVector = {
                    "ä¹¾": 100, "å…Œ": 20, "é›¢": 10, "éœ‡": 5,
                    "å·½": 3, "å": 2, "è‰®": 1, "å¤": 1
                };
                
                const stableReport = analyzer.runSensitivityAnalysis(stableVector, 'engine', {
                    iterations: 30,
                    perturbationSize: 1
                });
                
                output += `  å®‰å®šæ€§ã‚¹ã‚³ã‚¢: ${(stableReport.summary.stabilityScore * 100).toFixed(1)}%\n`;
                output += `  å®‰å®šæ€§ãƒ¬ãƒ™ãƒ«: ${stableReport.summary.stabilityLevel}\n`;
                output += `  å¤‰åŒ–ç‡: ${stableReport.changeStatistics.changeRate}\n\n`;

                // ä¸å®‰å®šãªã‚±ãƒ¼ã‚¹
                output += "ã€ä¸å®‰å®šãªã‚±ãƒ¼ã‚¹ã€‘\n";
                const unstableVector = {
                    "ä¹¾": 10, "å…Œ": 9, "é›¢": 8, "éœ‡": 7,
                    "å·½": 6, "å": 5, "è‰®": 4, "å¤": 3
                };
                
                const unstableReport = analyzer.runSensitivityAnalysis(unstableVector, 'interface', {
                    iterations: 30,
                    perturbationSize: 1
                });
                
                output += `  å®‰å®šæ€§ã‚¹ã‚³ã‚¢: ${(unstableReport.summary.stabilityScore * 100).toFixed(1)}%\n`;
                output += `  å®‰å®šæ€§ãƒ¬ãƒ™ãƒ«: ${unstableReport.summary.stabilityLevel}\n`;
                output += `  å¤‰åŒ–ç‡: ${unstableReport.changeStatistics.changeRate}\n`;
                output += `  è©•ä¾¡: ${unstableReport.assessment}\n`;

                element.className = "test-result success";
                testResults.passed++;
            } catch (error) {
                output += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                element.className = "test-result error";
                testResults.failed++;
            }
            
            element.textContent = output;
        }

        // ãƒ†ã‚¹ãƒˆ7: å®Œå…¨çµ±åˆè¨ºæ–­
        async function testFullIntegration() {
            const element = document.getElementById('integration-test');
            let output = "=== å®Œå…¨çµ±åˆè¨ºæ–­ãƒ•ãƒ­ãƒ¼ ===\n\n";
            
            try {
                // æ¨¡æ“¬çš„ãª36å•ã®å›ç­”ãƒ‡ãƒ¼ã‚¿
                const mockAnswers = [];
                
                // Q1-12: Engine OS
                for (let i = 1; i <= 12; i++) {
                    mockAnswers.push({
                        questionId: i,
                        score: Math.random() * 5 + 1
                    });
                }
                
                // Q13-24: Interface OS
                for (let i = 13; i <= 24; i++) {
                    mockAnswers.push({
                        questionId: i,
                        score: Math.random() * 5 + 1
                    });
                }
                
                // Q25-36: Safe Mode OS
                for (let i = 25; i <= 36; i++) {
                    mockAnswers.push({
                        questionId: i,
                        score: Math.random() * 5 + 1
                    });
                }

                output += "ã€å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã€‘\n";
                output += `  ç·è³ªå•æ•°: ${mockAnswers.length}\n`;
                output += `  Engine OS: Q1-12\n`;
                output += `  Interface OS: Q13-24\n`;
                output += `  Safe Mode OS: Q25-36\n\n`;

                // å›ç­”ã®åˆ†é›¢
                const engineAnswers = mockAnswers.filter(a => a.questionId >= 1 && a.questionId <= 12);
                const interfaceAnswers = mockAnswers.filter(a => a.questionId >= 13 && a.questionId <= 24);
                const safemodeAnswers = mockAnswers.filter(a => a.questionId >= 25 && a.questionId <= 36);

                output += "ã€è¨ºæ–­ãƒ—ãƒ­ã‚»ã‚¹ã€‘\n";

                // Engine OSè¨ºæ–­ï¼ˆç°¡æ˜“ç‰ˆï¼‰
                const engineVector = {};
                CONFIG.BAGUA_ORDER.forEach(bagua => {
                    engineVector[bagua] = Math.random() * 50 + 10;
                });
                
                const normalizer = new ImprovedNormalizationSystem();
                const engineNormalized = normalizer.softmaxNormalize(engineVector, 1.2);
                
                const engineSorted = Object.entries(engineNormalized).sort((a, b) => b[1] - a[1]);
                const engineUpper = engineSorted[0][0];
                const engineLower = engineSorted[1][0];
                
                output += `\nEngine OSè¨ºæ–­:\n`;
                output += `  ä¸Šå¦: ${engineUpper} (${(engineSorted[0][1] * 100).toFixed(1)}%)\n`;
                output += `  ä¸‹å¦: ${engineLower} (${(engineSorted[1][1] * 100).toFixed(1)}%)\n`;

                // Interface OSè¨ºæ–­ï¼ˆãƒãƒƒãƒ”ãƒ³ã‚°ä½¿ç”¨ï¼‰
                const interfaceRawVector = {
                    "å¤–å‘_ä¸»å°æ€§": Math.random() * 10,
                    "å¤–å‘_èª¿å’Œæ€§": Math.random() * 10,
                    "å†…å‘_é©å¿œæ€§": Math.random() * 10,
                    "å†…å‘_åˆ†ææ€§": Math.random() * 10
                };
                
                const interfaceBaguaVector = {};
                CONFIG.BAGUA_ORDER.forEach(bagua => {
                    interfaceBaguaVector[bagua] = 0;
                });
                
                // ãƒãƒƒãƒ”ãƒ³ã‚°é©ç”¨
                Object.entries(CONFIG.INTERFACE_TO_BAGUA).forEach(([dimension, mapping]) => {
                    const value = interfaceRawVector[dimension] || 0;
                    Object.entries(mapping).forEach(([bagua, weight]) => {
                        interfaceBaguaVector[bagua] += value * weight;
                    });
                });
                
                const interfaceNormalized = normalizer.softmaxNormalize(interfaceBaguaVector, 1.2);
                const interfaceSorted = Object.entries(interfaceNormalized).sort((a, b) => b[1] - a[1]);
                
                output += `\nInterface OSè¨ºæ–­:\n`;
                output += `  ä¸Šå¦: ${interfaceSorted[0][0]} (${(interfaceSorted[0][1] * 100).toFixed(1)}%)\n`;
                output += `  ä¸‹å¦: ${interfaceSorted[1][0]} (${(interfaceSorted[1][1] * 100).toFixed(1)}%)\n`;

                // ç¢ºä¿¡åº¦è©•ä¾¡
                const confidenceSystem = new CalibratedConfidenceSystem(CONFIG);
                const engineConfidence = confidenceSystem.calculateCalibratedConfidence(engineVector);
                
                output += `\nã€ç¢ºä¿¡åº¦è©•ä¾¡ã€‘\n`;
                output += `  Engine OS: ${engineConfidence.level} (${engineConfidence.score.toFixed(3)})\n`;
                output += `  ç†ç”±: ${engineConfidence.details.reason}\n`;

                // çµ±åˆæˆåŠŸåˆ¤å®š
                output += `\nã€çµ±åˆãƒ†ã‚¹ãƒˆçµæœã€‘\n`;
                output += `  âœ… å›ç­”åˆ†é›¢: æˆåŠŸ\n`;
                output += `  âœ… å…«å¦å¤‰æ›: æˆåŠŸ\n`;
                output += `  âœ… æ­£è¦åŒ–: æˆåŠŸ\n`;
                output += `  âœ… å¦é¸æŠ: æˆåŠŸ\n`;
                output += `  âœ… ç¢ºä¿¡åº¦è©•ä¾¡: æˆåŠŸ\n`;

                element.className = "test-result success";
                testResults.passed++;
            } catch (error) {
                output += `\nâŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                element.className = "test-result error";
                testResults.failed++;
            }
            
            element.textContent = output;
        }

        // çµæœã‚¯ãƒªã‚¢
        function clearResults() {
            const elements = document.querySelectorAll('.test-result');
            elements.forEach(el => {
                el.className = 'test-result info';
                el.textContent = 'ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...';
            });
            document.getElementById('summary').style.display = 'none';
        }

        // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
        function showSummary(executionTime) {
            const successRate = (testResults.passed / testResults.total * 100).toFixed(1);
            
            document.getElementById('success-rate').textContent = successRate + '%';
            document.getElementById('execution-time').textContent = executionTime.toFixed(0) + 'ms';
            document.getElementById('test-count').textContent = `${testResults.passed}/${testResults.total}`;
            
            document.getElementById('summary').style.display = 'block';
        }

        // çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        function exportResults() {
            const results = {
                timestamp: new Date().toISOString(),
                summary: {
                    passed: testResults.passed,
                    failed: testResults.failed,
                    total: testResults.total,
                    successRate: (testResults.passed / testResults.total * 100).toFixed(1) + '%'
                },
                details: []
            };

            // å„ãƒ†ã‚¹ãƒˆã®çµæœã‚’åé›†
            const testSections = document.querySelectorAll('.test-section');
            testSections.forEach(section => {
                const title = section.querySelector('.test-title').textContent;
                const result = section.querySelector('.test-result').textContent;
                const status = section.querySelector('.test-result').className.includes('success') ? 'PASSED' : 'FAILED';
                
                results.details.push({
                    test: title,
                    status: status,
                    output: result
                });
            });

            // JSONå½¢å¼ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([JSON.stringify(results, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `integration-test-results-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚
        window.onload = () => {
            console.log("ğŸ¯ HaQei OS Analyzer çµ±åˆãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†");
        };
    </script>
</body>
</html>