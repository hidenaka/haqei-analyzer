<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI Fast Test - 36å•é«˜é€Ÿå›ç­”ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
        }
        
        .control-panel {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        .status {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .log-container {
            background: #1a202c;
            color: #63b3ed;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .results {
            background: #f0fff4;
            border: 2px solid #38a169;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .error {
            background: #fff5f5;
            border: 2px solid #e53e3e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ HAQEI Fast Test - 36å•é«˜é€Ÿå›ç­”ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="control-panel">
            <h2>ãƒ†ã‚¹ãƒˆåˆ¶å¾¡ãƒ‘ãƒãƒ«</h2>
            <button onclick="loadOSAnalyzer()">1. OS Analyzerèª­ã¿è¾¼ã¿</button>
            <button onclick="startQuestions()">2. è³ªå•é–‹å§‹</button>
            <button onclick="autoCompleteQuestions()">3. 36å•è‡ªå‹•å›ç­”</button>
            <button onclick="checkResults()">4. çµæœç¢ºèª</button>
            <button onclick="clearAll()">ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div class="status" id="status">
            å¾…æ©Ÿä¸­...
        </div>
        
        <div class="results" id="results">
            <h3>è¨ºæ–­çµæœ</h3>
            <div id="resultsContent"></div>
        </div>
        
        <div class="error" id="error">
            <h3>ã‚¨ãƒ©ãƒ¼</h3>
            <div id="errorContent"></div>
        </div>
        
        <iframe id="testFrame" src="about:blank"></iframe>
        
        <div class="log-container" id="log">
            <div>ãƒ†ã‚¹ãƒˆãƒ­ã‚°é–‹å§‹...</div>
        </div>
    </div>
    
    <script>
        let testFrame = null;
        let questionCount = 0;
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            entry.style.color = type === 'error' ? '#fc8181' : 
                              type === 'success' ? '#68d391' : 
                              type === 'warning' ? '#f6e05e' : '#63b3ed';
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
            document.getElementById('status').textContent = message;
        }
        
        function loadOSAnalyzer() {
            testFrame = document.getElementById('testFrame');
            testFrame.src = 'os_analyzer.html';
            log('OS Analyzerèª­ã¿è¾¼ã¿ä¸­...');
            
            testFrame.onload = () => {
                log('OS Analyzerèª­ã¿è¾¼ã¿å®Œäº†', 'success');
                checkLoadedModules();
            };
        }
        
        function checkLoadedModules() {
            try {
                const win = testFrame.contentWindow;
                const modules = {
                    'H384_DATA': typeof win.H384_DATA !== 'undefined',
                    'H64_DATA': typeof win.H64_DATA !== 'undefined',
                    'TripleOSInteractionAnalyzer': typeof win.TripleOSInteractionAnalyzer !== 'undefined',
                    'VirtualPersonaEnhancer': typeof win.VirtualPersonaEnhancer !== 'undefined'
                };
                
                for (const [module, loaded] of Object.entries(modules)) {
                    log(`${module}: ${loaded ? 'âœ…' : 'âŒ'}`, loaded ? 'success' : 'error');
                }
            } catch (error) {
                log(`ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        function startQuestions() {
            try {
                const win = testFrame.contentWindow;
                const startBtn = win.document.querySelector('button[onclick*="startQuestions"]') ||
                               win.document.querySelector('button');
                
                if (startBtn) {
                    startBtn.click();
                    log('è³ªå•ãƒ•ãƒ­ãƒ¼é–‹å§‹', 'success');
                    questionCount = 0;
                } else {
                    log('é–‹å§‹ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                }
            } catch (error) {
                log(`è³ªå•é–‹å§‹ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        async function autoCompleteQuestions() {
            try {
                const win = testFrame.contentWindow;
                log('36å•è‡ªå‹•å›ç­”é–‹å§‹...');
                
                for (let i = 1; i <= 36; i++) {
                    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã‚’æ¢ã—ã¦é¸æŠ
                    const radios = win.document.querySelectorAll('input[type="radio"]:not(:checked)');
                    
                    if (radios.length > 0) {
                        // ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠ
                        const randomIndex = Math.floor(Math.random() * radios.length);
                        radios[randomIndex].click();
                        await new Promise(r => setTimeout(r, 50));
                        
                        // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚’æ¢ã—ã¦ã‚¯ãƒªãƒƒã‚¯
                        const buttons = win.document.querySelectorAll('button');
                        let clicked = false;
                        
                        for (const btn of buttons) {
                            if (btn.textContent.includes('æ¬¡') && !btn.disabled) {
                                btn.click();
                                questionCount++;
                                log(`è³ªå• ${i}/36 å›ç­”å®Œäº†`);
                                await new Promise(r => setTimeout(r, 100));
                                clicked = true;
                                break;
                            } else if ((btn.textContent.includes('åˆ†æ') || 
                                      btn.textContent.includes('å®Œäº†')) && 
                                      !btn.disabled) {
                                btn.click();
                                log('å…¨è³ªå•å›ç­”å®Œäº†ï¼åˆ†æé–‹å§‹', 'success');
                                await new Promise(r => setTimeout(r, 500));
                                checkResults();
                                return;
                            }
                        }
                        
                        if (!clicked) {
                            log(`è³ªå• ${i} ã§ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'warning');
                        }
                    } else {
                        log(`è³ªå• ${i} ã§é¸æŠè‚¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'warning');
                    }
                }
                
                log('36å•å›ç­”å®Œäº†', 'success');
                checkResults();
                
            } catch (error) {
                log(`è‡ªå‹•å›ç­”ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showError(error);
            }
        }
        
        function checkResults() {
            try {
                const win = testFrame.contentWindow;
                
                // çµæœè¦ç´ ã‚’æ¢ã™
                const resultElements = [
                    win.document.querySelector('.results-container'),
                    win.document.querySelector('.analysis-results'),
                    win.document.querySelector('#results-section'),
                    win.document.querySelector('[class*="result"]')
                ];
                
                const resultElement = resultElements.find(el => el !== null);
                
                if (resultElement) {
                    log('è¨ºæ–­çµæœã‚’æ¤œå‡º', 'success');
                    
                    // çµæœã‚’æŠ½å‡º
                    const results = extractResults(win);
                    showResults(results);
                    
                    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯
                    checkConsoleErrors(win);
                } else {
                    log('çµæœç”»é¢ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'warning');
                    
                    // localStorageç¢ºèª
                    const storageData = win.localStorage.getItem('haqei_analysis_results');
                    if (storageData) {
                        log('localStorageã«ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š', 'success');
                        showResults(JSON.parse(storageData));
                    }
                }
            } catch (error) {
                log(`çµæœç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                showError(error);
            }
        }
        
        function extractResults(win) {
            const results = {
                engineOS: null,
                interfaceOS: null,
                safeModeOS: null,
                errors: []
            };
            
            try {
                // å„OSã®çµæœã‚’æ¢ã™
                const osCards = win.document.querySelectorAll('.os-card, .persona-card, [class*="os-result"]');
                
                osCards.forEach(card => {
                    const text = card.textContent;
                    if (text.includes('Engine')) {
                        results.engineOS = text;
                    } else if (text.includes('Interface')) {
                        results.interfaceOS = text;
                    } else if (text.includes('Safe')) {
                        results.safeModeOS = text;
                    }
                });
                
                // TripleOSInteractionAnalyzerã®çµæœã‚’ç¢ºèª
                if (win.lastAnalysisResult) {
                    results.analysisData = win.lastAnalysisResult;
                }
                
            } catch (error) {
                results.errors.push(error.message);
            }
            
            return results;
        }
        
        function showResults(results) {
            const resultsDiv = document.getElementById('results');
            const content = document.getElementById('resultsContent');
            
            content.innerHTML = `
                <h4>Engine OS:</h4>
                <p>${results.engineOS || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</p>
                
                <h4>Interface OS:</h4>
                <p>${results.interfaceOS || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</p>
                
                <h4>Safe Mode OS:</h4>
                <p>${results.safeModeOS || 'ãƒ‡ãƒ¼ã‚¿ãªã—'}</p>
                
                ${results.analysisData ? `
                    <h4>åˆ†æãƒ‡ãƒ¼ã‚¿:</h4>
                    <pre>${JSON.stringify(results.analysisData, null, 2)}</pre>
                ` : ''}
                
                ${results.errors && results.errors.length > 0 ? `
                    <h4>ã‚¨ãƒ©ãƒ¼:</h4>
                    <ul>${results.errors.map(e => `<li>${e}</li>`).join('')}</ul>
                ` : ''}
            `;
            
            resultsDiv.style.display = 'block';
        }
        
        function showError(error) {
            const errorDiv = document.getElementById('error');
            const content = document.getElementById('errorContent');
            
            content.innerHTML = `
                <p><strong>ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸:</strong> ${error.message}</p>
                <p><strong>ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:</strong></p>
                <pre>${error.stack}</pre>
            `;
            
            errorDiv.style.display = 'block';
        }
        
        function checkConsoleErrors(win) {
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèªã™ã‚‹ç°¡æ˜“çš„ãªæ–¹æ³•
            const errors = win.console._errors || [];
            if (errors.length > 0) {
                log(`ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ${errors.length}ä»¶`, 'error');
                errors.forEach(err => {
                    log(`  - ${err}`, 'error');
                });
            } else {
                log('ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚¨ãƒ©ãƒ¼ãªã—', 'success');
            }
        }
        
        function clearAll() {
            document.getElementById('testFrame').src = 'about:blank';
            document.getElementById('log').innerHTML = '<div>ãƒ†ã‚¹ãƒˆãƒ­ã‚°ã‚¯ãƒªã‚¢</div>';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('status').textContent = 'å¾…æ©Ÿä¸­...';
            questionCount = 0;
            log('å…¨ã¦ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }
        
        // åˆæœŸåŒ–
        window.onload = () => {
            log('Fast Testç’°å¢ƒæº–å‚™å®Œäº†', 'success');
        };
    </script>
</body>
</html>