<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI Fast Test - 36問高速回答テスト</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
        }
        
        .control-panel {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #5a67d8;
        }
        
        .status {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .log-container {
            background: #1a202c;
            color: #63b3ed;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            max-height: 400px;
            overflow-y: auto;
            margin: 20px 0;
        }
        
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .results {
            background: #f0fff4;
            border: 2px solid #38a169;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
        
        .error {
            background: #fff5f5;
            border: 2px solid #e53e3e;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🚀 HAQEI Fast Test - 36問高速回答テスト</h1>
        
        <div class="control-panel">
            <h2>テスト制御パネル</h2>
            <button onclick="loadOSAnalyzer()">1. OS Analyzer読み込み</button>
            <button onclick="startQuestions()">2. 質問開始</button>
            <button onclick="autoCompleteQuestions()">3. 36問自動回答</button>
            <button onclick="checkResults()">4. 結果確認</button>
            <button onclick="clearAll()">クリア</button>
        </div>
        
        <div class="status" id="status">
            待機中...
        </div>
        
        <div class="results" id="results">
            <h3>診断結果</h3>
            <div id="resultsContent"></div>
        </div>
        
        <div class="error" id="error">
            <h3>エラー</h3>
            <div id="errorContent"></div>
        </div>
        
        <iframe id="testFrame" src="about:blank"></iframe>
        
        <div class="log-container" id="log">
            <div>テストログ開始...</div>
        </div>
    </div>
    
    <script>
        let testFrame = null;
        let questionCount = 0;
        
        function log(message, type = 'info') {
            const logContainer = document.getElementById('log');
            const entry = document.createElement('div');
            const timestamp = new Date().toLocaleTimeString();
            entry.innerHTML = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            entry.style.color = type === 'error' ? '#fc8181' : 
                              type === 'success' ? '#68d391' : 
                              type === 'warning' ? '#f6e05e' : '#63b3ed';
            logContainer.appendChild(entry);
            logContainer.scrollTop = logContainer.scrollHeight;
            
            // ステータス更新
            document.getElementById('status').textContent = message;
        }
        
        function loadOSAnalyzer() {
            testFrame = document.getElementById('testFrame');
            testFrame.src = 'os_analyzer.html';
            log('OS Analyzer読み込み中...');
            
            testFrame.onload = () => {
                log('OS Analyzer読み込み完了', 'success');
                checkLoadedModules();
            };
        }
        
        function checkLoadedModules() {
            try {
                const win = testFrame.contentWindow;
                const modules = {
                    'H384_DATA': typeof win.H384_DATA !== 'undefined',
                    'H64_DATA': typeof win.H64_DATA !== 'undefined',
                    'TripleOSInteractionAnalyzer': typeof win.TripleOSInteractionAnalyzer !== 'undefined',
                    'VirtualPersonaEnhancer': typeof win.VirtualPersonaEnhancer !== 'undefined'
                };
                
                for (const [module, loaded] of Object.entries(modules)) {
                    log(`${module}: ${loaded ? '✅' : '❌'}`, loaded ? 'success' : 'error');
                }
            } catch (error) {
                log(`モジュール確認エラー: ${error.message}`, 'error');
            }
        }
        
        function startQuestions() {
            try {
                const win = testFrame.contentWindow;
                const startBtn = win.document.querySelector('button[onclick*="startQuestions"]') ||
                               win.document.querySelector('button');
                
                if (startBtn) {
                    startBtn.click();
                    log('質問フロー開始', 'success');
                    questionCount = 0;
                } else {
                    log('開始ボタンが見つかりません', 'error');
                }
            } catch (error) {
                log(`質問開始エラー: ${error.message}`, 'error');
            }
        }
        
        async function autoCompleteQuestions() {
            try {
                const win = testFrame.contentWindow;
                log('36問自動回答開始...');
                
                for (let i = 1; i <= 36; i++) {
                    // ラジオボタンを探して選択
                    const radios = win.document.querySelectorAll('input[type="radio"]:not(:checked)');
                    
                    if (radios.length > 0) {
                        // ランダムに選択
                        const randomIndex = Math.floor(Math.random() * radios.length);
                        radios[randomIndex].click();
                        await new Promise(r => setTimeout(r, 50));
                        
                        // 次へボタンを探してクリック
                        const buttons = win.document.querySelectorAll('button');
                        let clicked = false;
                        
                        for (const btn of buttons) {
                            if (btn.textContent.includes('次') && !btn.disabled) {
                                btn.click();
                                questionCount++;
                                log(`質問 ${i}/36 回答完了`);
                                await new Promise(r => setTimeout(r, 100));
                                clicked = true;
                                break;
                            } else if ((btn.textContent.includes('分析') || 
                                      btn.textContent.includes('完了')) && 
                                      !btn.disabled) {
                                btn.click();
                                log('全質問回答完了！分析開始', 'success');
                                await new Promise(r => setTimeout(r, 500));
                                checkResults();
                                return;
                            }
                        }
                        
                        if (!clicked) {
                            log(`質問 ${i} でボタンが見つかりません`, 'warning');
                        }
                    } else {
                        log(`質問 ${i} で選択肢が見つかりません`, 'warning');
                    }
                }
                
                log('36問回答完了', 'success');
                checkResults();
                
            } catch (error) {
                log(`自動回答エラー: ${error.message}`, 'error');
                showError(error);
            }
        }
        
        function checkResults() {
            try {
                const win = testFrame.contentWindow;
                
                // 結果要素を探す
                const resultElements = [
                    win.document.querySelector('.results-container'),
                    win.document.querySelector('.analysis-results'),
                    win.document.querySelector('#results-section'),
                    win.document.querySelector('[class*="result"]')
                ];
                
                const resultElement = resultElements.find(el => el !== null);
                
                if (resultElement) {
                    log('診断結果を検出', 'success');
                    
                    // 結果を抽出
                    const results = extractResults(win);
                    showResults(results);
                    
                    // コンソールエラーチェック
                    checkConsoleErrors(win);
                } else {
                    log('結果画面が見つかりません', 'warning');
                    
                    // localStorage確認
                    const storageData = win.localStorage.getItem('haqei_analysis_results');
                    if (storageData) {
                        log('localStorageにデータあり', 'success');
                        showResults(JSON.parse(storageData));
                    }
                }
            } catch (error) {
                log(`結果確認エラー: ${error.message}`, 'error');
                showError(error);
            }
        }
        
        function extractResults(win) {
            const results = {
                engineOS: null,
                interfaceOS: null,
                safeModeOS: null,
                errors: []
            };
            
            try {
                // 各OSの結果を探す
                const osCards = win.document.querySelectorAll('.os-card, .persona-card, [class*="os-result"]');
                
                osCards.forEach(card => {
                    const text = card.textContent;
                    if (text.includes('Engine')) {
                        results.engineOS = text;
                    } else if (text.includes('Interface')) {
                        results.interfaceOS = text;
                    } else if (text.includes('Safe')) {
                        results.safeModeOS = text;
                    }
                });
                
                // TripleOSInteractionAnalyzerの結果を確認
                if (win.lastAnalysisResult) {
                    results.analysisData = win.lastAnalysisResult;
                }
                
            } catch (error) {
                results.errors.push(error.message);
            }
            
            return results;
        }
        
        function showResults(results) {
            const resultsDiv = document.getElementById('results');
            const content = document.getElementById('resultsContent');
            
            content.innerHTML = `
                <h4>Engine OS:</h4>
                <p>${results.engineOS || 'データなし'}</p>
                
                <h4>Interface OS:</h4>
                <p>${results.interfaceOS || 'データなし'}</p>
                
                <h4>Safe Mode OS:</h4>
                <p>${results.safeModeOS || 'データなし'}</p>
                
                ${results.analysisData ? `
                    <h4>分析データ:</h4>
                    <pre>${JSON.stringify(results.analysisData, null, 2)}</pre>
                ` : ''}
                
                ${results.errors && results.errors.length > 0 ? `
                    <h4>エラー:</h4>
                    <ul>${results.errors.map(e => `<li>${e}</li>`).join('')}</ul>
                ` : ''}
            `;
            
            resultsDiv.style.display = 'block';
        }
        
        function showError(error) {
            const errorDiv = document.getElementById('error');
            const content = document.getElementById('errorContent');
            
            content.innerHTML = `
                <p><strong>エラーメッセージ:</strong> ${error.message}</p>
                <p><strong>スタックトレース:</strong></p>
                <pre>${error.stack}</pre>
            `;
            
            errorDiv.style.display = 'block';
        }
        
        function checkConsoleErrors(win) {
            // コンソールエラーを確認する簡易的な方法
            const errors = win.console._errors || [];
            if (errors.length > 0) {
                log(`コンソールエラー検出: ${errors.length}件`, 'error');
                errors.forEach(err => {
                    log(`  - ${err}`, 'error');
                });
            } else {
                log('コンソールエラーなし', 'success');
            }
        }
        
        function clearAll() {
            document.getElementById('testFrame').src = 'about:blank';
            document.getElementById('log').innerHTML = '<div>テストログクリア</div>';
            document.getElementById('results').style.display = 'none';
            document.getElementById('error').style.display = 'none';
            document.getElementById('status').textContent = '待機中...';
            questionCount = 0;
            log('全てクリアしました');
        }
        
        // 初期化
        window.onload = () => {
            log('Fast Test環境準備完了', 'success');
        };
    </script>
</body>
</html>