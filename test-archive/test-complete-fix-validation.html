<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>完全修正検証 - HaQei OS Analyzer</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            margin: 0;
            padding: 20px;
            color: #fff;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: rgba(255,255,255,0.95);
            color: #333;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 {
            text-align: center;
            color: #2a5298;
            margin-bottom: 30px;
            font-size: 32px;
        }
        .test-group {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid #e9ecef;
        }
        .test-title {
            font-size: 20px;
            font-weight: bold;
            color: #495057;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }
        .status-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 10px;
            background: #6c757d;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-pending { background: #6c757d; }
        
        .test-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 5px;
            transition: transform 0.2s;
        }
        .test-button:hover {
            transform: translateY(-2px);
        }
        .test-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .result-box {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .success-msg {
            color: #28a745;
            font-weight: bold;
        }
        .error-msg {
            color: #dc3545;
            font-weight: bold;
        }
        .warning-msg {
            color: #ffc107;
            font-weight: bold;
        }
        .info-msg {
            color: #17a2b8;
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        th, td {
            border: 1px solid #dee2e6;
            padding: 10px;
            text-align: left;
        }
        th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .summary-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .summary-title {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 36px;
            font-weight: bold;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 HaQei OS Analyzer 完全修正検証</h1>
        
        <div class="summary-box">
            <div class="summary-title">修正状況サマリー</div>
            <div class="summary-stats">
                <div class="stat-item">
                    <div class="stat-value" id="total-fixes">0</div>
                    <div class="stat-label">総修正項目</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="completed-fixes">0</div>
                    <div class="stat-label">完了項目</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="test-passed">0</div>
                    <div class="stat-label">テスト合格</div>
                </div>
                <div class="stat-item">
                    <div class="stat-value" id="test-failed">0</div>
                    <div class="stat-label">テスト失敗</div>
                </div>
            </div>
        </div>

        <div class="test-group">
            <div class="test-title">
                <span class="status-indicator" id="test1-status"></span>
                テスト1: separateAnswers 質問分離ロジック
            </div>
            <button class="test-button" onclick="testSeparateAnswers()">テスト実行</button>
            <div class="result-box" id="test1-result">
                テスト待機中...
            </div>
        </div>

        <div class="test-group">
            <div class="test-title">
                <span class="status-indicator" id="test2-status"></span>
                テスト2: Interface OS 質問処理 (Q13-Q24)
            </div>
            <button class="test-button" onclick="testInterfaceProcessing()">テスト実行</button>
            <div class="result-box" id="test2-result">
                テスト待機中...
            </div>
        </div>

        <div class="test-group">
            <div class="test-title">
                <span class="status-indicator" id="test3-status"></span>
                テスト3: Safe Mode OS 質問処理 (Q25-Q36)
            </div>
            <button class="test-button" onclick="testSafeModeProcessing()">テスト実行</button>
            <div class="result-box" id="test3-result">
                テスト待機中...
            </div>
        </div>

        <div class="test-group">
            <div class="test-title">
                <span class="status-indicator" id="test4-status"></span>
                テスト4: 全OS統合動作テスト
            </div>
            <button class="test-button" onclick="testFullIntegration()">テスト実行</button>
            <div class="result-box" id="test4-result">
                テスト待機中...
            </div>
        </div>

        <div class="test-group">
            <div class="test-title">
                <span class="status-indicator" id="test5-status"></span>
                テスト5: データフロー整合性確認
            </div>
            <button class="test-button" onclick="testDataFlowIntegrity()">テスト実行</button>
            <div class="result-box" id="test5-result">
                テスト待機中...
            </div>
        </div>

        <div class="test-group">
            <div class="test-title">
                <span class="status-indicator" id="test-all-status"></span>
                統合テスト: 全テスト一括実行
            </div>
            <button class="test-button" onclick="runAllTests()">全テスト実行</button>
            <div class="result-box" id="test-all-result">
                全テスト待機中...
            </div>
        </div>
    </div>

    <iframe id="analyzer-frame" src="os_analyzer.html" style="display:none;"></iframe>

    <script>
        let analyzer = null;
        let testResults = {
            total: 7,
            completed: 0,
            passed: 0,
            failed: 0
        };

        // iframe読み込み完了後にanalyzerを取得
        document.getElementById('analyzer-frame').onload = function() {
            const iframe = document.getElementById('analyzer-frame');
            const iframeWindow = iframe.contentWindow;
            if (iframeWindow.window.osAnalyzer) {
                analyzer = iframeWindow.window.osAnalyzer;
                console.log('✅ OS Analyzer loaded successfully');
                updateSummary();
            }
        };

        function updateSummary() {
            document.getElementById('total-fixes').textContent = testResults.total;
            document.getElementById('completed-fixes').textContent = testResults.completed;
            document.getElementById('test-passed').textContent = testResults.passed;
            document.getElementById('test-failed').textContent = testResults.failed;
        }

        function setTestStatus(testId, status) {
            const statusElement = document.getElementById(`${testId}-status`);
            statusElement.className = `status-indicator status-${status}`;
        }

        // テスト1: separateAnswers
        function testSeparateAnswers() {
            const resultDiv = document.getElementById('test1-result');
            setTestStatus('test1', 'pending');
            
            try {
                // 模擬回答データ作成（全36問）
                const mockAnswers = [];
                for (let i = 1; i <= 36; i++) {
                    mockAnswers.push({
                        questionId: `q${i}`,
                        value: 'A'
                    });
                }
                
                // separateAnswersを実行
                const separated = analyzer.separateAnswers(mockAnswers);
                
                let html = '<span class="info-msg">📊 separateAnswers 実行結果:</span>\n\n';
                
                // 質問数チェック
                const engineCount = separated.worldviewAnswers.length;
                const interfaceCount = separated.scenarioAnswers.length;
                const safeModeCount = separated.defenseAnswers.length;
                
                html += `Engine OS: ${engineCount}問 (期待値: 12問) `;
                html += engineCount === 12 ? '<span class="success-msg">✅</span>\n' : '<span class="error-msg">❌</span>\n';
                
                html += `Interface OS: ${interfaceCount}問 (期待値: 12問) `;
                html += interfaceCount === 12 ? '<span class="success-msg">✅</span>\n' : '<span class="error-msg">❌</span>\n';
                
                html += `Safe Mode OS: ${safeModeCount}問 (期待値: 12問) `;
                html += safeModeCount === 12 ? '<span class="success-msg">✅</span>\n' : '<span class="error-msg">❌</span>\n';
                
                // 質問番号範囲チェック
                html += '\n<span class="info-msg">質問番号範囲チェック:</span>\n';
                
                const engineFirst = separated.worldviewAnswers[0]?.questionId;
                const engineLast = separated.worldviewAnswers[11]?.questionId;
                html += `Engine: ${engineFirst} - ${engineLast} `;
                html += (engineFirst === 'q1' && engineLast === 'q12') ? '<span class="success-msg">✅</span>\n' : '<span class="error-msg">❌</span>\n';
                
                const interfaceFirst = separated.scenarioAnswers[0]?.questionId;
                const interfaceLast = separated.scenarioAnswers[11]?.questionId;
                html += `Interface: ${interfaceFirst} - ${interfaceLast} `;
                html += (interfaceFirst === 'q13' && interfaceLast === 'q24') ? '<span class="success-msg">✅</span>\n' : '<span class="error-msg">❌</span>\n';
                
                const safeModeFirst = separated.defenseAnswers[0]?.questionId;
                const safeModeLast = separated.defenseAnswers[11]?.questionId;
                html += `SafeMode: ${safeModeFirst} - ${safeModeLast} `;
                html += (safeModeFirst === 'q25' && safeModeLast === 'q36') ? '<span class="success-msg">✅</span>\n' : '<span class="error-msg">❌</span>\n';
                
                resultDiv.innerHTML = html;
                
                // テスト結果判定
                if (engineCount === 12 && interfaceCount === 12 && safeModeCount === 12 &&
                    engineFirst === 'q1' && engineLast === 'q12' &&
                    interfaceFirst === 'q13' && interfaceLast === 'q24' &&
                    safeModeFirst === 'q25' && safeModeLast === 'q36') {
                    setTestStatus('test1', 'success');
                    testResults.passed++;
                } else {
                    setTestStatus('test1', 'error');
                    testResults.failed++;
                }
                testResults.completed++;
                updateSummary();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-msg">エラー: ${error.message}</span>`;
                setTestStatus('test1', 'error');
                testResults.failed++;
                testResults.completed++;
                updateSummary();
            }
        }

        // テスト2: Interface OS処理
        function testInterfaceProcessing() {
            const resultDiv = document.getElementById('test2-result');
            setTestStatus('test2', 'pending');
            
            try {
                // analyzeSocialPatternsのコードチェック
                const analyzeCode = analyzer.analyzeSocialPatterns.toString();
                
                let html = '<span class="info-msg">📊 Interface OS 質問処理チェック:</span>\n\n';
                
                // Q13-Q24の参照確認
                const hasQ13 = analyzeCode.includes('Q13');
                const hasQ24 = analyzeCode.includes('Q24');
                const hasQ25 = analyzeCode.includes('Q25');
                const hasQ30 = analyzeCode.includes('Q30');
                
                html += 'analyzeSocialPatterns メソッド:\n';
                html += `  Q13-Q24 参照: ${hasQ13 && hasQ24 ? '✅' : '❌'}\n`;
                html += `  Q25-Q30 参照: ${!hasQ25 && !hasQ30 ? '✅ 除去済み' : '❌ まだ残存'}\n`;
                
                // buildInterfaceVectorのコードチェック
                const vectorCode = analyzer.buildInterfaceVector.toString();
                const vectorHasQ13 = vectorCode.includes('Q13');
                const vectorHasQ24 = vectorCode.includes('Q24_adaptation');
                
                html += '\nbuildInterfaceVector メソッド:\n';
                html += `  Q13-Q24 パターン使用: ${vectorHasQ13 && vectorHasQ24 ? '✅' : '❌'}\n`;
                
                // 実際のパターン生成テスト
                const testAnswers = Array(12).fill({ selectedOption: { value: 'A' }});
                const patterns = analyzer.analyzeSocialPatterns(testAnswers);
                
                html += '\n<span class="info-msg">パターン生成テスト (12問):</span>\n';
                const patternKeys = Object.keys(patterns);
                html += `  生成されたパターン数: ${patternKeys.length}\n`;
                html += `  Q19-Q24 パターン存在: ${patterns.Q24_adaptation !== undefined ? '✅' : '❌'}\n`;
                
                resultDiv.innerHTML = html;
                
                // テスト結果判定
                if (hasQ13 && hasQ24 && !hasQ25 && !hasQ30 && 
                    vectorHasQ13 && vectorHasQ24 && 
                    patternKeys.length === 12 && patterns.Q24_adaptation !== undefined) {
                    setTestStatus('test2', 'success');
                    testResults.passed++;
                } else {
                    setTestStatus('test2', 'error');
                    testResults.failed++;
                }
                testResults.completed++;
                updateSummary();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-msg">エラー: ${error.message}</span>`;
                setTestStatus('test2', 'error');
                testResults.failed++;
                testResults.completed++;
                updateSummary();
            }
        }

        // テスト3: Safe Mode OS処理
        function testSafeModeProcessing() {
            const resultDiv = document.getElementById('test3-result');
            setTestStatus('test3', 'pending');
            
            try {
                // extractDefensivePatternsのコードチェック
                const extractCode = analyzer.extractDefensivePatterns.toString();
                
                let html = '<span class="info-msg">📊 Safe Mode OS 質問処理チェック:</span>\n\n';
                
                // Q25-Q36の参照確認
                const hasQ25 = extractCode.includes('Q25');
                const hasQ36 = extractCode.includes('Q36');
                const hasDefenseAnswers = extractCode.includes('defenseAnswers');
                
                html += 'extractDefensivePatterns メソッド:\n';
                html += `  引数名: ${hasDefenseAnswers ? '✅ defenseAnswers' : '❌ scenarioAnswers'}\n`;
                html += `  Q25-Q36 参照: ${hasQ25 && hasQ36 ? '✅' : '❌'}\n`;
                
                // analyzeSafeModeOSの引数チェック
                const analyzeCode = analyzer.analyzeSafeModeOS.toString();
                const hasCorrectParam = analyzeCode.includes('defenseAnswers');
                
                html += '\nanalyzeSafeModeOS メソッド:\n';
                html += `  引数名: ${hasCorrectParam ? '✅ defenseAnswers' : '❌ scenarioAnswers'}\n`;
                
                // 実際のパターン生成テスト
                const testAnswers = Array(12).fill({ 
                    selectedOption: { value: 'A' },
                    intensity: 0.8,
                    pattern: '対抗'
                });
                const patterns = analyzer.extractDefensivePatterns(testAnswers);
                
                html += '\n<span class="info-msg">パターン生成テスト (12問):</span>\n';
                const patternKeys = Object.keys(patterns);
                html += `  生成されたパターン数: ${patternKeys.length}\n`;
                html += `  Q31-Q36 パターン存在: ${patterns.Q36_resourceStress !== undefined ? '✅' : '❌'}\n`;
                
                resultDiv.innerHTML = html;
                
                // テスト結果判定
                if (hasDefenseAnswers && hasCorrectParam && hasQ25 && hasQ36 &&
                    patternKeys.length === 12 && patterns.Q36_resourceStress !== undefined) {
                    setTestStatus('test3', 'success');
                    testResults.passed++;
                } else {
                    setTestStatus('test3', 'error');
                    testResults.failed++;
                }
                testResults.completed++;
                updateSummary();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-msg">エラー: ${error.message}</span>`;
                setTestStatus('test3', 'error');
                testResults.failed++;
                testResults.completed++;
                updateSummary();
            }
        }

        // テスト4: 全OS統合動作
        async function testFullIntegration() {
            const resultDiv = document.getElementById('test4-result');
            setTestStatus('test4', 'pending');
            
            try {
                let html = '<span class="info-msg">📊 全OS統合動作テスト:</span>\n\n';
                
                // 36問の模擬回答作成
                const mockAnswers = [];
                for (let i = 1; i <= 36; i++) {
                    mockAnswers.push({
                        questionId: `q${i}`,
                        selectedOption: { value: 'A' }
                    });
                }
                
                // 質問分離
                const separated = analyzer.separateAnswers(mockAnswers);
                
                html += '1. 質問分離:\n';
                html += `   Engine: ${separated.worldviewAnswers.length}問\n`;
                html += `   Interface: ${separated.scenarioAnswers.length}問\n`;
                html += `   SafeMode: ${separated.defenseAnswers.length}問\n\n`;
                
                // Engine OS分析
                const engineOS = await analyzer.analyzeEngineOS(separated.worldviewAnswers);
                html += '2. Engine OS:\n';
                html += `   卦: ${engineOS.hexagramName || 'N/A'} (#${engineOS.hexagramId || 'N/A'})\n`;
                html += `   計算成功: ${engineOS.hexagramId ? '✅' : '❌'}\n\n`;
                
                // Interface OS分析
                const interfaceOS = await analyzer.analyzeInterfaceOS(separated.scenarioAnswers, engineOS);
                html += '3. Interface OS:\n';
                html += `   卦: ${interfaceOS.hexagramName || 'N/A'} (#${interfaceOS.hexagramId || 'N/A'})\n`;
                html += `   計算成功: ${interfaceOS.hexagramId ? '✅' : '❌'}\n\n`;
                
                // Safe Mode OS分析
                const safeModeOS = await analyzer.analyzeSafeModeOS(separated.defenseAnswers, engineOS);
                html += '4. Safe Mode OS:\n';
                html += `   卦: ${safeModeOS.hexagramName || 'N/A'} (#${safeModeOS.hexagramId || 'N/A'})\n`;
                html += `   計算成功: ${safeModeOS.hexagramId ? '✅' : '❌'}\n\n`;
                
                html += '<span class="info-msg">総合判定:</span>\n';
                const allSuccess = engineOS.hexagramId && interfaceOS.hexagramId && safeModeOS.hexagramId;
                html += allSuccess ? '<span class="success-msg">✅ 全OS正常動作</span>' : '<span class="error-msg">❌ 一部OSで問題発生</span>';
                
                resultDiv.innerHTML = html;
                
                // テスト結果判定
                if (allSuccess) {
                    setTestStatus('test4', 'success');
                    testResults.passed++;
                } else {
                    setTestStatus('test4', 'error');
                    testResults.failed++;
                }
                testResults.completed++;
                updateSummary();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-msg">エラー: ${error.message}\n${error.stack}</span>`;
                setTestStatus('test4', 'error');
                testResults.failed++;
                testResults.completed++;
                updateSummary();
            }
        }

        // テスト5: データフロー整合性
        function testDataFlowIntegrity() {
            const resultDiv = document.getElementById('test5-result');
            setTestStatus('test5', 'pending');
            
            try {
                let html = '<span class="info-msg">📊 データフロー整合性確認:</span>\n\n';
                
                // Q13-Q24のテストデータ作成
                const interfaceAnswers = [];
                for (let i = 13; i <= 24; i++) {
                    interfaceAnswers.push({
                        questionId: `q${i}`,
                        selectedOption: { value: 'B' }
                    });
                }
                
                // analyzeSocialPatterns実行
                const patterns = analyzer.analyzeSocialPatterns(interfaceAnswers);
                
                html += '1. Interface OS パターン生成:\n';
                let allPatternsValid = true;
                for (let i = 13; i <= 24; i++) {
                    const key = `Q${i}_${getPatternName(i)}`;
                    const hasPattern = patterns[key] !== undefined;
                    html += `   ${key}: ${hasPattern ? '✅' : '❌'}\n`;
                    if (!hasPattern) allPatternsValid = false;
                }
                
                // buildInterfaceVector実行
                const vector = analyzer.buildInterfaceVector(patterns);
                
                html += '\n2. Interface ベクトル構築:\n';
                let allVectorValid = true;
                Object.entries(vector).forEach(([key, value]) => {
                    const isValid = !isNaN(value) && value !== undefined;
                    html += `   ${key}: ${value.toFixed(2)} ${isValid ? '✅' : '❌'}\n`;
                    if (!isValid) allVectorValid = false;
                });
                
                html += '\n<span class="info-msg">総合判定:</span>\n';
                const allSuccess = allPatternsValid && allVectorValid;
                html += allSuccess ? '<span class="success-msg">✅ データフロー正常</span>' : '<span class="error-msg">❌ データフロー異常</span>';
                
                resultDiv.innerHTML = html;
                
                // テスト結果判定
                if (allSuccess) {
                    setTestStatus('test5', 'success');
                    testResults.passed++;
                } else {
                    setTestStatus('test5', 'error');
                    testResults.failed++;
                }
                testResults.completed++;
                updateSummary();
                
            } catch (error) {
                resultDiv.innerHTML = `<span class="error-msg">エラー: ${error.message}</span>`;
                setTestStatus('test5', 'error');
                testResults.failed++;
                testResults.completed++;
                updateSummary();
            }
        }

        function getPatternName(questionNum) {
            const patterns = {
                13: 'leadership',
                14: 'interpersonal',
                15: 'family',
                16: 'emergency',
                17: 'competition',
                18: 'community',
                19: 'social',
                20: 'conflict',
                21: 'trust',
                22: 'expression',
                23: 'cooperation',
                24: 'adaptation'
            };
            return patterns[questionNum] || 'unknown';
        }

        // 全テスト実行
        async function runAllTests() {
            const resultDiv = document.getElementById('test-all-result');
            setTestStatus('test-all', 'pending');
            
            // リセット
            testResults.completed = 0;
            testResults.passed = 0;
            testResults.failed = 0;
            
            resultDiv.innerHTML = '<span class="info-msg">全テスト実行中...</span>\n\n';
            
            // 各テストを順番に実行
            await new Promise(resolve => setTimeout(resolve, 100));
            testSeparateAnswers();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            testInterfaceProcessing();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            testSafeModeProcessing();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            await testFullIntegration();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            testDataFlowIntegrity();
            
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // 結果集計
            let html = '<span class="info-msg">📊 全テスト完了:</span>\n\n';
            html += `実行テスト数: ${testResults.completed}\n`;
            html += `合格: ${testResults.passed}\n`;
            html += `失敗: ${testResults.failed}\n`;
            html += `成功率: ${(testResults.passed / testResults.completed * 100).toFixed(1)}%\n\n`;
            
            if (testResults.failed === 0) {
                html += '<span class="success-msg">🎉 全テスト合格！修正は完全に成功しました。</span>';
                setTestStatus('test-all', 'success');
            } else {
                html += '<span class="error-msg">⚠️ 一部テストに失敗。追加修正が必要です。</span>';
                setTestStatus('test-all', 'error');
            }
            
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>