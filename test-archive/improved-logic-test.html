<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>改善診断ロジック検証</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #2d3748;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #718096;
            margin-bottom: 30px;
        }
        
        .control-panel {
            background: #f7fafc;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        button:hover {
            background: #5a67d8;
            transform: translateY(-2px);
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #f7fafc;
            border-radius: 12px;
        }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }
        
        .metric {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .metric:last-child {
            border-bottom: none;
        }
        
        .metric-label {
            color: #718096;
        }
        
        .metric-value {
            font-weight: 600;
            color: #2d3748;
        }
        
        .success {
            color: #38a169;
        }
        
        .warning {
            color: #e53e3e;
        }
        
        .info {
            color: #3182ce;
        }
        
        .chart-container {
            margin: 20px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }
        
        #comparisonChart, #distributionChart {
            max-height: 400px;
        }
        
        .explanation {
            background: #fef5e7;
            border-left: 4px solid #f39c12;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .pure-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }
        
        .pure-yes {
            background: #c6f6d5;
            color: #22543d;
        }
        
        .pure-no {
            background: #fed7e2;
            color: #c53030;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        
        th {
            background: #f7fafc;
            font-weight: 600;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="improved-diagnostic-logic.js"></script>
</head>
<body>
    <div class="container">
        <h1>🔬 改善診断ロジック検証</h1>
        <p class="subtitle">易経思想を反映した集中度連動型純卦制御</p>
        
        <div class="control-panel">
            <button onclick="runSingleTest()">単一テスト</button>
            <button onclick="runComparisonTest()">新旧比較テスト</button>
            <button onclick="runBatchTest(100)">100回バッチテスト</button>
            <button onclick="runBatchTest(1000)">1000回バッチテスト</button>
            <button onclick="runConcentrationTest()">集中度別テスト</button>
            <button onclick="clearResults()">クリア</button>
        </div>
        
        <!-- 単一テスト結果 -->
        <div class="test-section" id="singleTest" style="display: none;">
            <h2>📊 単一診断テスト</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>入力ベクトル</h3>
                    <div id="inputVector"></div>
                </div>
                <div class="test-card">
                    <h3>八卦エネルギー（Softmax後）</h3>
                    <div id="baguaEnergies"></div>
                </div>
                <div class="test-card">
                    <h3>診断結果</h3>
                    <div id="diagnosisResult"></div>
                </div>
                <div class="test-card">
                    <h3>集中度メトリクス</h3>
                    <div id="concentrationMetrics"></div>
                </div>
            </div>
            <div class="explanation" id="explanation"></div>
        </div>
        
        <!-- 新旧比較 -->
        <div class="test-section" id="comparisonTest" style="display: none;">
            <h2>📈 新旧ロジック比較</h2>
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
            <table id="comparisonTable">
                <thead>
                    <tr>
                        <th>項目</th>
                        <th>旧ロジック（ReLU付き）</th>
                        <th>新ロジック（Softmax一本化）</th>
                        <th>改善度</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        
        <!-- バッチテスト結果 -->
        <div class="test-section" id="batchTest" style="display: none;">
            <h2>📊 バッチテスト結果</h2>
            <div class="test-grid">
                <div class="test-card">
                    <h3>Engine OS</h3>
                    <div id="engineStats"></div>
                </div>
                <div class="test-card">
                    <h3>Interface OS</h3>
                    <div id="interfaceStats"></div>
                </div>
                <div class="test-card">
                    <h3>Safe Mode OS</h3>
                    <div id="safemodeStats"></div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="distributionChart"></canvas>
            </div>
        </div>
        
        <!-- 集中度別テスト -->
        <div class="test-section" id="concentrationTest" style="display: none;">
            <h2>🎯 集中度別純卦率分析</h2>
            <table id="concentrationTable">
                <thead>
                    <tr>
                        <th>集中度レベル</th>
                        <th>Herfindahl指数</th>
                        <th>エントロピー</th>
                        <th>純卦率（実測）</th>
                        <th>純卦率（期待）</th>
                        <th>説明</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        // 改善エンジンのインスタンス
        const engine = new ImprovedDiagnosticEngine();
        let comparisonChart = null;
        let distributionChart = null;
        
        // 単一テスト実行
        function runSingleTest() {
            // ランダムな入力ベクトル生成
            const userVector = {};
            const BAGUA = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
            
            // ランダムな集中度で生成
            const concentration = Math.random();
            if (concentration < 0.3) {
                // 分散型
                BAGUA.forEach(b => userVector[b] = 10 + Math.random() * 10);
            } else if (concentration < 0.7) {
                // 中間型
                BAGUA.forEach(b => userVector[b] = Math.random() * 50);
            } else {
                // 集中型
                const dominant = BAGUA[Math.floor(Math.random() * 8)];
                BAGUA.forEach(b => userVector[b] = b === dominant ? 80 + Math.random() * 20 : Math.random() * 20);
            }
            
            // 診断実行
            const result = engine.performDiagnosis(userVector, 'engine', 'probabilistic');
            
            // 結果表示
            document.getElementById('singleTest').style.display = 'block';
            
            // 入力ベクトル表示
            const inputDiv = document.getElementById('inputVector');
            inputDiv.innerHTML = Object.entries(userVector)
                .map(([k, v]) => `<div class="metric"><span class="metric-label">${k}</span><span class="metric-value">${v.toFixed(1)}</span></div>`)
                .join('');
            
            // 八卦エネルギー表示
            const energyDiv = document.getElementById('baguaEnergies');
            energyDiv.innerHTML = Object.entries(result.baguaEnergies)
                .map(([k, v]) => `<div class="metric"><span class="metric-label">${k}</span><span class="metric-value">${(v * 100).toFixed(1)}%</span></div>`)
                .join('');
            
            // 診断結果表示
            const resultDiv = document.getElementById('diagnosisResult');
            resultDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">上卦</span>
                    <span class="metric-value">${result.upperTrigram}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">下卦</span>
                    <span class="metric-value">${result.lowerTrigram}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">純卦判定</span>
                    <span class="metric-value">
                        ${result.isPure ? '純卦' : '混合卦'}
                        <span class="pure-indicator ${result.isPure ? 'pure-yes' : 'pure-no'}">
                            ${result.isPure ? '✓' : '✗'}
                        </span>
                    </span>
                </div>
            `;
            
            // 集中度メトリクス表示
            const metricsDiv = document.getElementById('concentrationMetrics');
            metricsDiv.innerHTML = `
                <div class="metric">
                    <span class="metric-label">Herfindahl指数</span>
                    <span class="metric-value">${result.metrics.herfindahl.toFixed(3)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">エントロピー</span>
                    <span class="metric-value">${result.metrics.entropy.toFixed(3)}</span>
                </div>
                <div class="metric">
                    <span class="metric-label">最大値比率</span>
                    <span class="metric-value">${(result.metrics.topRatio * 100).toFixed(1)}%</span>
                </div>
                <div class="metric">
                    <span class="metric-label">上位差</span>
                    <span class="metric-value">${(result.metrics.gap * 100).toFixed(1)}%</span>
                </div>
            `;
            
            // 説明表示
            document.getElementById('explanation').innerHTML = `
                <strong>診断説明:</strong> ${result.explanation}
            `;
        }
        
        // 新旧比較テスト
        function runComparisonTest() {
            const testCount = 1000;
            const oldResults = [];
            const newResults = [];
            
            // 旧ロジックのシミュレーション（ReLU付き）
            for (let i = 0; i < testCount; i++) {
                const result = simulateOldLogic();
                oldResults.push(result);
            }
            
            // 新ロジックのテスト
            for (let i = 0; i < testCount; i++) {
                const userVector = generateRandomVector();
                const result = engine.performDiagnosis(userVector, 'engine', 'probabilistic');
                newResults.push(result);
            }
            
            // 統計計算
            const oldPureRate = oldResults.filter(r => r.isPure).length / testCount;
            const newPureRate = newResults.filter(r => r.isPure).length / testCount;
            
            // 結果表示
            document.getElementById('comparisonTest').style.display = 'block';
            
            // テーブル更新
            const tbody = document.querySelector('#comparisonTable tbody');
            tbody.innerHTML = `
                <tr>
                    <td>純卦率</td>
                    <td class="${oldPureRate > 0.18 ? 'warning' : ''}">${(oldPureRate * 100).toFixed(1)}%</td>
                    <td class="${newPureRate > 0.18 ? 'warning' : 'success'}">${(newPureRate * 100).toFixed(1)}%</td>
                    <td>${((newPureRate - oldPureRate) * 100).toFixed(1)}%</td>
                </tr>
                <tr>
                    <td>理論値との乖離</td>
                    <td>${((oldPureRate - 0.125) * 100).toFixed(1)}%</td>
                    <td>${((newPureRate - 0.125) * 100).toFixed(1)}%</td>
                    <td>-</td>
                </tr>
            `;
            
            // グラフ更新
            updateComparisonChart(oldPureRate, newPureRate);
        }
        
        // バッチテスト
        function runBatchTest(count) {
            const results = {
                engine: [],
                interface: [],
                safemode: []
            };
            
            // 各OSタイプでテスト
            ['engine', 'interface', 'safemode'].forEach(osType => {
                for (let i = 0; i < count; i++) {
                    const userVector = generateRandomVector();
                    const result = engine.performDiagnosis(userVector, osType, 'probabilistic');
                    results[osType].push(result);
                }
            });
            
            // 結果表示
            document.getElementById('batchTest').style.display = 'block';
            
            // 各OSの統計表示
            ['engine', 'interface', 'safemode'].forEach(osType => {
                const osResults = results[osType];
                const pureCount = osResults.filter(r => r.isPure).length;
                const pureRate = pureCount / count;
                const avgHerfindahl = osResults.reduce((sum, r) => sum + r.metrics.herfindahl, 0) / count;
                
                const statsDiv = document.getElementById(`${osType}Stats`);
                statsDiv.innerHTML = `
                    <div class="metric">
                        <span class="metric-label">テスト数</span>
                        <span class="metric-value">${count}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">純卦数</span>
                        <span class="metric-value">${pureCount}</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">純卦率</span>
                        <span class="metric-value ${pureRate > 0.18 ? 'warning' : 'success'}">${(pureRate * 100).toFixed(2)}%</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">平均集中度</span>
                        <span class="metric-value">${(avgHerfindahl * 100).toFixed(1)}%</span>
                    </div>
                `;
            });
            
            // 分布グラフ更新
            updateDistributionChart(results);
        }
        
        // 集中度別テスト
        function runConcentrationTest() {
            const levels = [
                { name: '低集中', herfindahl: 0.125, variance: 0.01 },
                { name: '中低集中', herfindahl: 0.15, variance: 0.02 },
                { name: '中集中', herfindahl: 0.175, variance: 0.025 },
                { name: '中高集中', herfindahl: 0.2, variance: 0.03 },
                { name: '高集中', herfindahl: 0.25, variance: 0.04 }
            ];
            
            const tbody = document.querySelector('#concentrationTable tbody');
            tbody.innerHTML = '';
            
            levels.forEach(level => {
                const results = [];
                for (let i = 0; i < 200; i++) {
                    const userVector = generateVectorWithConcentration(level.herfindahl, level.variance);
                    const result = engine.performDiagnosis(userVector, 'engine', 'probabilistic');
                    results.push(result);
                }
                
                const pureCount = results.filter(r => r.isPure).length;
                const pureRate = pureCount / results.length;
                const avgHerfindahl = results.reduce((sum, r) => sum + r.metrics.herfindahl, 0) / results.length;
                const avgEntropy = results.reduce((sum, r) => sum + r.metrics.entropy, 0) / results.length;
                
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${level.name}</td>
                    <td>${avgHerfindahl.toFixed(3)}</td>
                    <td>${avgEntropy.toFixed(3)}</td>
                    <td class="${pureRate > 0.2 ? 'warning' : 'success'}">${(pureRate * 100).toFixed(1)}%</td>
                    <td>${(avgHerfindahl * 100).toFixed(1)}%</td>
                    <td>${avgHerfindahl > 0.2 ? '気が集中' : avgHerfindahl < 0.15 ? '気が分散' : 'バランス状態'}</td>
                `;
            });
            
            document.getElementById('concentrationTest').style.display = 'block';
        }
        
        // ヘルパー関数
        function generateRandomVector() {
            const vector = {};
            const BAGUA = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
            BAGUA.forEach(b => vector[b] = Math.random() * 100);
            return vector;
        }
        
        function generateVectorWithConcentration(targetHerfindahl, variance) {
            const BAGUA = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
            const vector = {};
            
            // 目標Herfindahl指数に基づいて分布を生成
            const probs = [];
            let remaining = 1;
            
            for (let i = 0; i < 7; i++) {
                const p = Math.random() * remaining * 0.3;
                probs.push(p);
                remaining -= p;
            }
            probs.push(remaining);
            
            // シャッフル
            probs.sort(() => Math.random() - 0.5);
            
            // ベクトルに変換
            BAGUA.forEach((b, i) => {
                vector[b] = probs[i] * 100 + (Math.random() - 0.5) * variance * 100;
            });
            
            return vector;
        }
        
        function simulateOldLogic() {
            // 旧ロジックのシミュレーション（ReLU下限値付き）
            const BAGUA = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
            const rawEnergies = BAGUA.map(() => Math.random() * 100);
            
            // Z-score標準化
            const mean = rawEnergies.reduce((a, b) => a + b, 0) / rawEnergies.length;
            const variance = rawEnergies.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / rawEnergies.length;
            const std = Math.sqrt(variance);
            
            const zScored = rawEnergies.map(v => std > 0 ? (v - mean) / std : 0);
            
            // ReLU活性化（問題のある実装）
            const activated = zScored.map(v => Math.max(0.01, v));
            
            // 正規化
            const sum = activated.reduce((a, b) => a + b, 0);
            const normalized = activated.map(v => v / sum);
            
            // 上位2つを選択
            const sorted = normalized.map((v, i) => ({ v, i })).sort((a, b) => b.v - a.v);
            
            return {
                isPure: sorted[0].i === sorted[1].i || Math.abs(sorted[0].v - sorted[1].v) < 0.001
            };
        }
        
        function updateComparisonChart(oldRate, newRate) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (comparisonChart) {
                comparisonChart.destroy();
            }
            
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['旧ロジック（ReLU）', '新ロジック（Softmax）', '理論値'],
                    datasets: [{
                        label: '純卦率 (%)',
                        data: [oldRate * 100, newRate * 100, 12.5],
                        backgroundColor: [
                            'rgba(229, 62, 62, 0.5)',
                            'rgba(102, 126, 234, 0.5)',
                            'rgba(56, 161, 105, 0.5)'
                        ],
                        borderColor: [
                            'rgba(229, 62, 62, 1)',
                            'rgba(102, 126, 234, 1)',
                            'rgba(56, 161, 105, 1)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 30,
                            title: {
                                display: true,
                                text: '純卦率 (%)'
                            }
                        }
                    }
                }
            });
        }
        
        function updateDistributionChart(results) {
            const ctx = document.getElementById('distributionChart').getContext('2d');
            
            if (distributionChart) {
                distributionChart.destroy();
            }
            
            const datasets = Object.entries(results).map(([osType, osResults]) => {
                const pureRate = osResults.filter(r => r.isPure).length / osResults.length;
                return {
                    label: osType.toUpperCase() + ' OS',
                    data: [pureRate * 100],
                    backgroundColor: {
                        engine: 'rgba(102, 126, 234, 0.5)',
                        interface: 'rgba(237, 137, 54, 0.5)',
                        safemode: 'rgba(72, 187, 120, 0.5)'
                    }[osType]
                };
            });
            
            distributionChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['純卦率'],
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 25,
                            title: {
                                display: true,
                                text: '純卦率 (%)'
                            }
                        }
                    },
                    plugins: {
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: 12.5,
                                    yMax: 12.5,
                                    borderColor: 'rgb(255, 99, 132)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: '理論値 12.5%',
                                        enabled: true
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function clearResults() {
            document.getElementById('singleTest').style.display = 'none';
            document.getElementById('comparisonTest').style.display = 'none';
            document.getElementById('batchTest').style.display = 'none';
            document.getElementById('concentrationTest').style.display = 'none';
        }
    </script>
</body>
</html>