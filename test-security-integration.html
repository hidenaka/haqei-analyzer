<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¼æ¥­ãƒ¬ãƒ™ãƒ«ï¼‰ -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-Frame-Options" content="DENY">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta name="csrf-token" content="">
  
  <title>HAQEIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ</title>
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆæœ€å„ªå…ˆèª­ã¿è¾¼ã¿ï¼‰ -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" 
          integrity="sha384-69eb1h/3FLKz1j3ChgOC6gH3+k0KvBfH7NrR+mOlKCl5vPnWRnNjB/LwEXxfKz0y" 
          crossorigin="anonymous"></script>
  
  <!-- TailwindCSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ  -->
  <script src="/js/security/SecurityHeaderManager.js"></script>
  <script src="/js/security/DOMPurifyIntegration.js"></script>
  <script src="/js/security/CSRFProtectionSystem.js"></script>
  <script src="/js/security/InputValidationSystem.js"></script>
  <script src="/js/security/SecurityIntegrationValidator.js"></script>
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£UI CSS -->
  <link rel="stylesheet" href="/css/security-ui.css">
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div id="securityStatus" class="security-status secure">
    ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ã‚¢
  </div>
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©³ç´°ãƒ‘ãƒãƒ« -->
  <div id="securityPanel" class="security-panel">
    <h3>ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h3>
    <div id="securityComponents"></div>
    <div id="securityStats" class="security-stats"></div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div class="container mx-auto px-4 py-8">
    <div class="max-w-4xl mx-auto">
      <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
      <header class="text-center mb-8">
        <h1 class="text-4xl font-bold text-gray-800 mb-4">
          ğŸ›¡ï¸ HAQEIã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ çµ±åˆãƒ†ã‚¹ãƒˆ
        </h1>
        <p class="text-lg text-gray-600">
          ä¼æ¥­ãƒ¬ãƒ™ãƒ«ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¿è­·ã‚·ã‚¹ãƒ†ãƒ ã®åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ
        </p>
      </header>

      <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹ -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“Š ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹</h2>
        <div id="securityMetrics" class="security-metrics">
          <!-- å‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
        </div>
      </section>

      <!-- å…¥åŠ›ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ” å…¥åŠ›æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <form id="testForm" class="space-y-4">
            <input type="hidden" name="_csrf" value="">
            
            <div>
              <label for="testText" class="block text-sm font-medium text-gray-700 mb-2">
                ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼ˆXSSæ”»æ’ƒãƒ†ã‚¹ãƒˆï¼‰
              </label>
              <input 
                type="text" 
                id="testText" 
                name="testText"
                data-validation-type="text"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="<script>alert('XSS')</script> ãªã©ã‚’å…¥åŠ›ã—ã¦ãƒ†ã‚¹ãƒˆ"
              >
              <div class="validation-errors" style="display: none;"></div>
            </div>

            <div>
              <label for="testEmail" class="block text-sm font-medium text-gray-700 mb-2">
                ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å…¥åŠ›
              </label>
              <input 
                type="email" 
                id="testEmail" 
                name="testEmail"
                data-validation-type="email"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="test@example.com"
              >
              <div class="validation-errors" style="display: none;"></div>
            </div>

            <div>
              <label for="testTextarea" class="block text-sm font-medium text-gray-700 mb-2">
                é•·æ–‡ãƒ†ã‚­ã‚¹ãƒˆï¼ˆSQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆï¼‰
              </label>
              <textarea 
                id="testTextarea" 
                name="testTextarea"
                data-validation-type="text"
                rows="4"
                class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                placeholder="'; DROP TABLE users; -- ãªã©ã‚’å…¥åŠ›ã—ã¦ãƒ†ã‚¹ãƒˆ"
              ></textarea>
              <div class="validation-errors" style="display: none;"></div>
            </div>

            <button 
              type="submit" 
              class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ¤œè¨¼å®Ÿè¡Œ
            </button>
          </form>
        </div>
      </section>

      <!-- XSSæ”»æ’ƒãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">âš¡ XSSæ”»æ’ƒä¿è­·ãƒ†ã‚¹ãƒˆ</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h3 class="text-lg font-semibold mb-2">ğŸ¯ æ”»æ’ƒãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ</h3>
              <div class="space-y-2">
                <button class="xss-test-btn w-full text-left px-3 py-2 bg-red-100 hover:bg-red-200 rounded border" 
                        data-payload='<script>alert("XSS")</script>'>
                  Script Tag Attack
                </button>
                <button class="xss-test-btn w-full text-left px-3 py-2 bg-red-100 hover:bg-red-200 rounded border" 
                        data-payload='<img src="x" onerror="alert(1)">'>
                  Image OnError Attack
                </button>
                <button class="xss-test-btn w-full text-left px-3 py-2 bg-red-100 hover:bg-red-200 rounded border" 
                        data-payload='javascript:alert(1)'>
                  JavaScript Protocol
                </button>
                <button class="xss-test-btn w-full text-left px-3 py-2 bg-red-100 hover:bg-red-200 rounded border" 
                        data-payload='<iframe src="javascript:alert(1)"></iframe>'>
                  IFrame JavaScript
                </button>
              </div>
            </div>
            <div>
              <h3 class="text-lg font-semibold mb-2">ğŸ›¡ï¸ ä¿è­·çµæœ</h3>
              <div id="xssTestResults" class="space-y-2 min-h-32">
                <p class="text-gray-500">ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ä¿è­·ã‚’ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„</p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- CSRFä¿è­·ãƒ†ã‚¹ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ”’ CSRFä¿è­·ãƒ†ã‚¹ãƒˆ</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <h3 class="text-lg font-semibold mb-2">ğŸ“‹ ç¾åœ¨ã®CSRFãƒˆãƒ¼ã‚¯ãƒ³</h3>
              <div class="bg-gray-100 p-3 rounded font-mono text-sm break-all" id="currentCSRFToken">
                èª­ã¿è¾¼ã¿ä¸­...
              </div>
              <button id="rotateTokenBtn" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
              </button>
            </div>
            <div>
              <h3 class="text-lg font-semibold mb-2">ğŸ“Š ä¿è­·çµ±è¨ˆ</h3>
              <div id="csrfStats" class="bg-gray-100 p-3 rounded text-sm">
                èª­ã¿è¾¼ã¿ä¸­...
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ãƒ†ã‚¹ãƒˆçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ˆ çµ±åˆãƒ†ã‚¹ãƒˆçµæœ</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <div id="integrationTestResults">
            <div class="text-center py-8">
              <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
              <p class="text-gray-600">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</p>
            </div>
          </div>
        </div>
      </section>

      <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <section class="mb-8">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">ğŸ“ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°</h2>
        <div class="bg-white p-6 rounded-lg shadow-md">
          <button id="toggleLogBtn" class="mb-4 bg-gray-600 text-white px-4 py-2 rounded hover:bg-gray-700">
            ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°è¡¨ç¤ºåˆ‡æ›¿
          </button>
          <div id="securityLogs" class="bg-gray-900 text-green-400 p-4 rounded font-mono text-sm h-64 overflow-y-auto hidden">
            <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
          </div>
        </div>
      </section>
    </div>
  </div>

  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå¿…è¦æ™‚ã«è¡¨ç¤ºï¼‰ -->
  <div id="securityAlert" class="security-alert" style="display: none;">
    <div class="security-alert-icon">ğŸš¨</div>
    <div class="security-alert-title">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è­¦å‘Š</div>
    <div class="security-alert-message" id="securityAlertMessage"></div>
    <div class="security-alert-actions">
      <button class="security-alert-button primary" onclick="closeSecurityAlert()">ç¢ºèª</button>
      <button class="security-alert-button secondary" onclick="closeSecurityAlert()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>

  <!-- ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
  <div id="securityOverlay" class="security-overlay"></div>

  <!-- ãƒ†ã‚¹ãƒˆã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
  <script>
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let securityLogs = [];
    let testResults = {};

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–é–‹å§‹');
      
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã‚’å¾…ã¤
      await waitForSecuritySystems();
      
      // UIåˆæœŸåŒ–
      initializeUI();
      
      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      setupEventListeners();
      
      // çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      await runIntegrationTests();
      
      console.log('âœ… ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
    });

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿å¾…æ©Ÿ
    async function waitForSecuritySystems() {
      const maxWaitTime = 5000; // 5ç§’
      const checkInterval = 100; // 100ms
      let waitTime = 0;

      return new Promise((resolve) => {
        const checkSystems = () => {
          const systems = [
            window.securityHeaders,
            window.domPurifyIntegration,
            window.csrfProtection,
            window.inputValidation,
            window.securityValidator
          ];

          const loadedSystems = systems.filter(system => system !== undefined).length;
          
          if (loadedSystems >= 3 || waitTime >= maxWaitTime) {
            console.log(`ğŸ“Š ${loadedSystems}/5 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ èª­ã¿è¾¼ã¿å®Œäº†`);
            resolve();
          } else {
            waitTime += checkInterval;
            setTimeout(checkSystems, checkInterval);
          }
        };

        checkSystems();
      });
    }

    // UIåˆæœŸåŒ–
    function initializeUI() {
      updateSecurityStatus();
      updateSecurityPanel();
      updateCSRFDisplay();
      updateSecurityMetrics();
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚¯ãƒªãƒƒã‚¯
      document.getElementById('securityStatus').addEventListener('click', toggleSecurityPanel);
      
      // XSSæ”»æ’ƒãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³
      document.querySelectorAll('.xss-test-btn').forEach(btn => {
        btn.addEventListener('click', (e) => testXSSProtection(e.target.dataset.payload));
      });
      
      // CSRFãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
      document.getElementById('rotateTokenBtn').addEventListener('click', rotateCSRFToken);
      
      // ãƒ­ã‚°è¡¨ç¤ºåˆ‡æ›¿
      document.getElementById('toggleLogBtn').addEventListener('click', toggleSecurityLogs);
      
      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
      document.getElementById('testForm').addEventListener('submit', handleFormSubmit);
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
    function updateSecurityStatus() {
      const statusElement = document.getElementById('securityStatus');
      
      if (window.securityValidator && window.securityValidator.integrationStatus === 'operational') {
        statusElement.className = 'security-status secure';
        statusElement.textContent = 'ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ã‚¢';
      } else if (window.securityValidator && window.securityValidator.integrationStatus === 'initializing') {
        statusElement.className = 'security-status warning';
        statusElement.textContent = 'âš ï¸ åˆæœŸåŒ–ä¸­';
      } else {
        statusElement.className = 'security-status error';
        statusElement.textContent = 'âŒ ã‚¨ãƒ©ãƒ¼';
      }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒãƒ«æ›´æ–°
    function updateSecurityPanel() {
      const componentsElement = document.getElementById('securityComponents');
      const components = [
        { name: 'SecurityHeaderManager', instance: window.securityHeaders },
        { name: 'DOMPurifyIntegration', instance: window.domPurifyIntegration },
        { name: 'CSRFProtectionSystem', instance: window.csrfProtection },
        { name: 'InputValidationSystem', instance: window.inputValidation },
        { name: 'SecurityIntegrationValidator', instance: window.securityValidator }
      ];

      componentsElement.innerHTML = components.map(comp => `
        <div class="security-component ${comp.instance ? 'active' : 'inactive'}">
          <div class="security-component-name">${comp.name}</div>
          <span class="security-component-status ${comp.instance ? 'active' : 'inactive'}">
            ${comp.instance ? 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–' : 'éã‚¢ã‚¯ãƒ†ã‚£ãƒ–'}
          </span>
        </div>
      `).join('');
    }

    // CSRFè¡¨ç¤ºæ›´æ–°
    function updateCSRFDisplay() {
      if (window.csrfProtection) {
        const token = window.csrfProtection.getCurrentToken();
        document.getElementById('currentCSRFToken').textContent = token || 'ãƒˆãƒ¼ã‚¯ãƒ³ãªã—';
        
        const stats = window.csrfProtection.getProtectionStats();
        document.getElementById('csrfStats').innerHTML = `
          <div><strong>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒˆãƒ¼ã‚¯ãƒ³:</strong> ${stats.activeTokens}</div>
          <div><strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³:</strong> ${stats.activeSessions}</div>
          <div><strong>ä¿è­·ãƒ•ã‚©ãƒ¼ãƒ :</strong> ${stats.protectedForms}</div>
          <div><strong>ãƒªãƒ•ã‚¡ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯:</strong> ${stats.config.refererCheckEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</div>
        `;
      }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
    function updateSecurityMetrics() {
      const metricsElement = document.getElementById('securityMetrics');
      
      const metrics = [
        {
          label: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ¬ãƒ¼ãƒ‰',
          value: calculateSecurityGrade(),
          description: 'ç·åˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è©•ä¾¡'
        },
        {
          label: 'ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä¿è­·',
          value: countActiveProtections(),
          description: 'æœ‰åŠ¹ãªä¿è­·æ©Ÿèƒ½æ•°'
        },
        {
          label: 'XSSä¿è­·ç‡',
          value: '100%',
          description: 'XSSæ”»æ’ƒã‹ã‚‰ã®ä¿è­·ç‡'
        },
        {
          label: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹',
          value: 'Good',
          description: 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‡¦ç†æ€§èƒ½'
        }
      ];

      metricsElement.innerHTML = metrics.map(metric => `
        <div class="security-metric">
          <div class="security-metric-value ${getMetricClass(metric.value)}">${metric.value}</div>
          <div class="security-metric-label">${metric.label}</div>
          <div class="security-metric-description">${metric.description}</div>
        </div>
      `).join('');
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ¬ãƒ¼ãƒ‰è¨ˆç®—
    function calculateSecurityGrade() {
      const activeComponents = countActiveProtections();
      if (activeComponents >= 4) return 'A';
      if (activeComponents >= 3) return 'B';
      if (activeComponents >= 2) return 'C';
      return 'F';
    }

    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä¿è­·æ•°ã‚«ã‚¦ãƒ³ãƒˆ
    function countActiveProtections() {
      const protections = [
        window.securityHeaders,
        window.domPurifyIntegration,
        window.csrfProtection,
        window.inputValidation
      ];
      return protections.filter(p => p !== undefined).length;
    }

    // ãƒ¡ãƒˆãƒªãƒƒã‚¯ã‚¯ãƒ©ã‚¹å–å¾—
    function getMetricClass(value) {
      if (value === 'A' || value === '100%' || value === 'Good' || value === 'Excellent') return 'good';
      if (value === 'B' || value === 'C' || value.includes('Warning')) return 'warning';
      return 'error';
    }

    // XSSä¿è­·ãƒ†ã‚¹ãƒˆ
    function testXSSProtection(payload) {
      const resultsElement = document.getElementById('xssTestResults');
      
      try {
        let sanitized = payload;
        let protectionMethod = 'ãªã—';
        
        if (window.domPurifyIntegration && window.domPurifyIntegration.isInitialized) {
          sanitized = window.domPurifyIntegration.sanitizeHTML(payload);
          protectionMethod = 'DOMPurify';
        }
        
        const isProtected = !sanitized.includes('<script>') && 
                          !sanitized.includes('javascript:') && 
                          !sanitized.includes('onerror=');
        
        const resultHtml = `
          <div class="p-3 rounded border ${isProtected ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300'}">
            <div class="font-semibold ${isProtected ? 'text-green-800' : 'text-red-800'}">
              ${isProtected ? 'âœ… ä¿è­·æˆåŠŸ' : 'âŒ ä¿è­·å¤±æ•—'}
            </div>
            <div class="text-sm mt-1">
              <div><strong>å…ƒã®å€¤:</strong> ${payload}</div>
              <div><strong>å‡¦ç†å¾Œ:</strong> ${sanitized}</div>
              <div><strong>ä¿è­·æ–¹æ³•:</strong> ${protectionMethod}</div>
            </div>
          </div>
        `;
        
        resultsElement.innerHTML = resultHtml + (resultsElement.innerHTML || '');
        
      } catch (error) {
        console.error('XSSä¿è­·ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        addSecurityLog('error', `XSSä¿è­·ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }

    // CSRFãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
    function rotateCSRFToken() {
      if (window.csrfProtection) {
        try {
          window.csrfProtection.rotateToken();
          updateCSRFDisplay();
          addSecurityLog('info', 'CSRFãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ‰‹å‹•æ›´æ–°ã—ã¾ã—ãŸ');
        } catch (error) {
          console.error('ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          addSecurityLog('error', `ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°ã‚¨ãƒ©ãƒ¼: ${error.message}`);
        }
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    function handleFormSubmit(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      
      addSecurityLog('info', 'ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ');
      
      // å„å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æ¤œè¨¼çµæœã‚’è¡¨ç¤º
      const inputs = form.querySelectorAll('input, textarea');
      inputs.forEach(input => {
        if (input.type !== 'hidden' && window.inputValidation) {
          const isValid = window.inputValidation.validateInput(input, true);
          addSecurityLog(isValid ? 'info' : 'warning', 
            `${input.name}: ${isValid ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'} - "${input.value}"`);
        }
      });
    }

    // çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    async function runIntegrationTests() {
      const resultsElement = document.getElementById('integrationTestResults');
      
      try {
        if (window.securityValidator) {
          addSecurityLog('info', 'çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹');
          
          // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
          const report = window.securityValidator.generateSecurityReport();
          
          const resultsHtml = `
            <div class="space-y-4">
              <div class="grid grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded">
                  <h4 class="font-semibold text-blue-800">çµ±åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹</h4>
                  <p class="text-2xl font-bold text-blue-600">${report.integrationStatus}</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded">
                  <h4 class="font-semibold text-yellow-800">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ</h4>
                  <p class="text-2xl font-bold text-yellow-600">${report.summary.activeComponents}/${report.summary.totalComponents}</p>
                </div>
              </div>
              
              <div class="bg-gray-50 p-4 rounded">
                <h4 class="font-semibold text-gray-800 mb-2">ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè©³ç´°</h4>
                <div class="space-y-2">
                  ${report.components.map(comp => `
                    <div class="flex justify-between items-center">
                      <span>${comp.name}</span>
                      <span class="px-2 py-1 rounded text-sm ${comp.available ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${comp.status}
                      </span>
                    </div>
                  `).join('')}
                </div>
              </div>
            </div>
          `;
          
          resultsElement.innerHTML = resultsHtml;
          addSecurityLog('info', 'çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†');
          
        } else {
          resultsElement.innerHTML = `
            <div class="text-center py-8 text-red-600">
              <p>ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±åˆãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“</p>
            </div>
          `;
          addSecurityLog('error', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çµ±åˆãƒãƒªãƒ‡ãƒ¼ã‚¿ãƒ¼æœªåˆ©ç”¨');
        }
        
      } catch (error) {
        console.error('çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
        resultsElement.innerHTML = `
          <div class="text-center py-8 text-red-600">
            <p>çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}</p>
          </div>
        `;
        addSecurityLog('error', `çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
      }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ‘ãƒãƒ«è¡¨ç¤ºåˆ‡æ›¿
    function toggleSecurityPanel() {
      const panel = document.getElementById('securityPanel');
      panel.classList.toggle('show');
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¡¨ç¤ºåˆ‡æ›¿
    function toggleSecurityLogs() {
      const logs = document.getElementById('securityLogs');
      logs.classList.toggle('hidden');
      
      if (!logs.classList.contains('hidden')) {
        updateSecurityLogsDisplay();
      }
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¿½åŠ 
    function addSecurityLog(level, message) {
      const timestamp = new Date().toISOString().substr(11, 8);
      securityLogs.push({ timestamp, level, message });
      
      // æœ€å¤§100ã‚¨ãƒ³ãƒˆãƒªã¾ã§ä¿æŒ
      if (securityLogs.length > 100) {
        securityLogs.shift();
      }
      
      updateSecurityLogsDisplay();
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ­ã‚°è¡¨ç¤ºæ›´æ–°
    function updateSecurityLogsDisplay() {
      const logsElement = document.getElementById('securityLogs');
      if (logsElement.classList.contains('hidden')) return;
      
      logsElement.innerHTML = securityLogs.map(log => `
        <div class="security-log-entry">
          <span class="security-log-timestamp">[${log.timestamp}]</span>
          <span class="security-log-level ${log.level}">${log.level.toUpperCase()}</span>
          <span class="security-log-message">${log.message}</span>
        </div>
      `).join('');
      
      logsElement.scrollTop = logsElement.scrollHeight;
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
    function showSecurityAlert(message) {
      document.getElementById('securityAlertMessage').textContent = message;
      document.getElementById('securityAlert').style.display = 'block';
      document.getElementById('securityOverlay').classList.add('show');
    }

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆé–‰ã˜ã‚‹
    function closeSecurityAlert() {
      document.getElementById('securityAlert').style.display = 'none';
      document.getElementById('securityOverlay').classList.remove('show');
    }

    // å®šæœŸçš„ãªæ›´æ–°
    setInterval(() => {
      updateSecurityStatus();
      updateSecurityMetrics();
    }, 5000);

    // åˆæœŸãƒ­ã‚°
    addSecurityLog('info', 'ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
  </script>
</body>
</html>