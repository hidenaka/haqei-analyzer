<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayeredResultsView çµ±åˆãƒ†ã‚¹ãƒˆ - HaQei Analyzer Phase 5.2</title>
    
    <!-- Existing stylesheets -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/user-friendly-display.css">
    
    <!-- Phase 5.2: New layered results stylesheet -->
    <link rel="stylesheet" href="css/layered-results.css">
    
    <style>
        /* ãƒ†ã‚¹ãƒˆç”¨è¿½åŠ ã‚¹ã‚¿ã‚¤ãƒ« */
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: #0f172a;
            border-radius: 1rem;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 0.5rem;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .test-header h1 {
            color: #10b981;
            font-size: 1.8rem;
            margin: 0 0 0.5rem 0;
        }
        
        .test-status {
            color: #cbd5e1;
            font-size: 1rem;
        }
        
        .test-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-btn-primary {
            background: linear-gradient(135deg, #10b981, #22d3ee);
            color: #0f172a;
        }
        
        .test-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .test-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 2rem;
            font-family: 'Courier New', monospace;
            color: #22d3ee;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(34, 211, 238, 0.3);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ—ï¸ LayeredResultsView çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
            <div class="test-status">Phase 5.2: UX/æƒ…å ±ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å†è¨­è¨ˆ - bunenjinå“²å­¦4éšå±¤æ§‹é€ ãƒ†ã‚¹ãƒˆ</div>
        </div>
        
        <div class="test-controls">
            <button id="generate-mock-data" class="test-btn test-btn-primary">
                ğŸ² ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
            </button>
            <button id="test-layered-view" class="test-btn test-btn-primary">
                ğŸš€ LayeredResultsView ãƒ†ã‚¹ãƒˆ
            </button>
            <button id="test-existing-view" class="test-btn test-btn-secondary">
                ğŸ“Š æ—¢å­˜TripleOSResultsView ãƒ†ã‚¹ãƒˆ
            </button>
            <button id="clear-test" class="test-btn test-btn-secondary">
                ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆã‚¯ãƒªã‚¢
            </button>
        </div>
        
        <div id="test-log" class="test-log">
            [ãƒ†ã‚¹ãƒˆãƒ­ã‚°] æº–å‚™å®Œäº†ã€‚ä¸Šã®ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚
        </div>
        
        <div id="error-container"></div>
        <div id="success-container"></div>
        
        <!-- Results display container -->
        <div id="results-container" style="margin-top: 2rem;">
            <!-- LayeredResultsView ã¾ãŸã¯ TripleOSResultsView ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
        </div>
    </div>

    <!-- Existing JavaScript dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Data files -->
    <script src="js/data/data_box.js"></script>
    <script src="js/shared/data/questions.js"></script>
    <script src="js/shared/data/vectors.js"></script>
    <script src="js/os-analyzer/data/hexagrams.js"></script>
    <script src="js/os-analyzer/data/hexagram_details.js"></script>
    
    <!-- Core libraries -->
    <script src="js/shared/core/BaseComponent.js"></script>
    <script src="js/shared/core/StorageManager.js"></script>
    <script src="js/shared/core/DataManager.js"></script>
    <script src="js/shared/core/ErrorHandler.js"></script>
    
    <!-- Phase 5.1: Statistical components -->
    <script src="js/os-analyzer/utils/ScientificFormatter.js"></script>
    <script src="js/os-analyzer/core/StatisticalEngine.js"></script>
    
    <!-- OS Analyzer components -->
    <script src="js/os-analyzer/core/Calculator.js"></script>
    <script src="js/os-analyzer/core/TripleOSEngine.js"></script>
    <script src="js/os-analyzer/engines/CompatibilityDataLoader.js"></script>
    
    <!-- Phase 5.2: New components -->
    <script src="js/os-analyzer/components/ExpandableSection.js"></script>
    <script src="js/os-analyzer/components/LayeredResultsView.js"></script>
    
    <!-- Existing comparison component -->
    <script src="js/components/TripleOSResultsView.js"></script>
    
    <script>
        // Test utility functions
        let testLog = [];
        let currentView = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logContainer = document.getElementById('test-log');
            logContainer.textContent = testLog.join('\n');
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(logEntry);
            
            // Show status message
            if (type === 'error') {
                showMessage(message, 'error');
            } else if (type === 'success') {
                showMessage(message, 'success');
            }
        }
        
        function showMessage(message, type) {
            const container = type === 'error' ? 
                document.getElementById('error-container') : 
                document.getElementById('success-container');
            
            container.innerHTML = `
                <div class="${type}-message">
                    ${type === 'error' ? 'âŒ' : 'âœ…'} ${message}
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        // Generate mock Triple OS data
        function generateMockTripleOSData() {
            return {
                analysisType: "tripleOS",
                engineOS: {
                    osId: 1,
                    osName: "ä¹¾ç‚ºå¤©",
                    hexagramInfo: {
                        id: 1,
                        name: "ä¹¾ç‚ºå¤©",
                        name_jp: "ã‘ã‚“ã„ã¦ã‚“",
                        reading: "ä¹¾ç‚ºå¤©",
                        description: "å‰µé€ çš„ãªåŠ›ã¨æŒ‡å°åŠ›ã‚’æŒã¤äººæ ¼",
                        catchphrase: "å¤©ã®åŠ›ã§æ–°ã—ã„é“ã‚’å‰µã‚‹",
                        upper_trigram_id: 1,
                        lower_trigram_id: 1
                    },
                    strength: 0.85,
                    matchPercentage: 0.85,
                    userVector: {
                        "ä¹¾_å‰µé€ æ€§": 18,
                        "éœ‡_è¡Œå‹•æ€§": 15,
                        "å_æ¢æ±‚æ€§": 12,
                        "è‰®_å®‰å®šæ€§": 8,
                        "å¤_å—å®¹æ€§": 10,
                        "å·½_é©å¿œæ€§": 11,
                        "é›¢_è¡¨ç¾æ€§": 14,
                        "å…Œ_èª¿å’Œæ€§": 12
                    }
                },
                interfaceOS: {
                    osId: 31,
                    osName: "æ²¢å±±å’¸",
                    hexagramInfo: {
                        id: 31,
                        name: "æ²¢å±±å’¸",
                        name_jp: "ãŸãã–ã‚“ã‹ã‚“",
                        reading: "æ²¢å±±å’¸",
                        description: "ä»–è€…ã¨ã®èª¿å’Œã¨å…±æ„Ÿã‚’é‡è¦–ã™ã‚‹äººæ ¼",
                        catchphrase: "å¿ƒã‚’é€šã‚ã›ã¦çµ†ã‚’æ·±ã‚ã‚‹",
                        upper_trigram_id: 2,
                        lower_trigram_id: 7
                    },
                    strength: 0.78,
                    matchPercentage: 0.78,
                    userVector: {
                        "ä¹¾_å‰µé€ æ€§": 10,
                        "éœ‡_è¡Œå‹•æ€§": 12,
                        "å_æ¢æ±‚æ€§": 8,
                        "è‰®_å®‰å®šæ€§": 16,
                        "å¤_å—å®¹æ€§": 18,
                        "å·½_é©å¿œæ€§": 15,
                        "é›¢_è¡¨ç¾æ€§": 11,
                        "å…Œ_èª¿å’Œæ€§": 19
                    }
                },
                safeModeOS: {
                    osId: 52,
                    osName: "è‰®ç‚ºå±±",
                    hexagramInfo: {
                        id: 52,
                        name: "è‰®ç‚ºå±±",
                        name_jp: "ã”ã‚“ã„ã–ã‚“",
                        reading: "è‰®ç‚ºå±±",
                        description: "æ…é‡ã§å®‰å®šã‚’é‡è¦–ã™ã‚‹å®ˆã‚Šã®äººæ ¼",
                        catchphrase: "å …å®ŸãªåŸºç›¤ã§ç¢ºå®Ÿã«é€²ã‚€",
                        upper_trigram_id: 7,
                        lower_trigram_id: 7
                    },
                    strength: 0.72,
                    matchPercentage: 0.72,
                    userVector: {
                        "ä¹¾_å‰µé€ æ€§": 8,
                        "éœ‡_è¡Œå‹•æ€§": 9,
                        "å_æ¢æ±‚æ€§": 13,
                        "è‰®_å®‰å®šæ€§": 20,
                        "å¤_å—å®¹æ€§": 14,
                        "å·½_é©å¿œæ€§": 10,
                        "é›¢_è¡¨ç¾æ€§": 7,
                        "å…Œ_èª¿å’Œæ€§": 12
                    }
                },
                eightDimensionVector: {
                    "ä¹¾_å‰µé€ æ€§": 15,
                    "éœ‡_è¡Œå‹•æ€§": 13,
                    "å_æ¢æ±‚æ€§": 11,
                    "è‰®_å®‰å®šæ€§": 14,
                    "å¤_å—å®¹æ€§": 14,
                    "å·½_é©å¿œæ€§": 12,
                    "é›¢_è¡¨ç¾æ€§": 11,
                    "å…Œ_èª¿å’Œæ€§": 14
                },
                timestamp: new Date().toISOString(),
                
                // çµ±è¨ˆå“è³ªãƒ‡ãƒ¼ã‚¿
                quality: {
                    grade: 'A',
                    ratio: 0.89,
                    description: 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹é«˜å“è³ªãªçµæœ'
                },
                
                // é€æ˜æ€§ãƒ¬ãƒãƒ¼ãƒˆ
                transparencyReport: {
                    methodology: {
                        algorithm: 'TripleOS Engine v2.1',
                        weighting: 'æ˜“çµŒ64å¦ãƒãƒƒãƒãƒ³ã‚° + çµ±è¨ˆçš„è£œæ­£'
                    },
                    dataQuality: {
                        confidenceLevel: '89%',
                        standardError: 'Â±3.2%'
                    },
                    limitations: [
                        'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã«ã‚ˆã‚‹æ¨¡æ“¬åˆ†æ',
                        'å®Ÿéš›ã®å›ç­”ã«åŸºã¥ã‹ãªã„çµæœ',
                        'çµ±è¨ˆçš„ç²¾åº¦ã¯å‚è€ƒå€¤'
                    ]
                }
            };
        }
        
        // Test LayeredResultsView
        async function testLayeredResultsView() {
            try {
                log('ğŸš€ LayeredResultsView ãƒ†ã‚¹ãƒˆé–‹å§‹...');
                
                // Clear existing content
                document.getElementById('results-container').innerHTML = '';
                
                // Generate mock data
                const mockData = generateMockTripleOSData();
                log('âœ… ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†');
                
                // Create LayeredResultsView instance
                currentView = new LayeredResultsView('results-container', {
                    enableProgressiveDisclosure: true,
                    trackLayerAnalytics: true,
                    mobileOptimized: true,
                    animationDuration: 300,
                    maxConcurrentLayers: 2,
                    autoCollapseInactive: true
                });
                
                log('âœ… LayeredResultsView ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆå®Œäº†');
                
                // Set data and render
                await currentView.setData(mockData, null);
                log('âœ… ãƒ‡ãƒ¼ã‚¿è¨­å®šãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†');
                
                // Test layer functionality
                setTimeout(() => {
                    log('ğŸ” éšå±¤æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹...');
                    testLayerFunctionality();
                }, 1000);
                
                log('ğŸ‰ LayeredResultsView ãƒ†ã‚¹ãƒˆæˆåŠŸï¼', 'success');
                
            } catch (error) {
                log(`âŒ LayeredResultsView ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('LayeredResultsView test error:', error);
            }
        }
        
        // Test existing TripleOSResultsView for comparison
        async function testExistingTripleOSView() {
            try {
                log('ğŸ“Š æ—¢å­˜TripleOSResultsView ãƒ†ã‚¹ãƒˆé–‹å§‹...');
                
                // Clear existing content
                document.getElementById('results-container').innerHTML = '';
                
                // Generate mock data
                const mockData = generateMockTripleOSData();
                log('âœ… ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†');
                
                // Initialize required components
                const dataManager = new DataManager();
                await dataManager.loadData();
                const compatibilityLoader = new CompatibilityDataLoader();
                
                // Create TripleOSResultsView instance
                currentView = new TripleOSResultsView('results-container', {
                    analysisResult: mockData,
                    insights: null,
                    compatibilityLoader: compatibilityLoader,
                    dataManager: dataManager,
                    enableSelfReflection: true,
                    showWisdomPreface: true
                });
                
                log('âœ… TripleOSResultsView ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ç”Ÿæˆå®Œäº†');
                
                // Initialize and render
                await currentView.init();
                log('âœ… åˆæœŸåŒ–ãƒ»ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†');
                
                log('ğŸ‰ æ—¢å­˜TripleOSResultsView ãƒ†ã‚¹ãƒˆæˆåŠŸï¼', 'success');
                
            } catch (error) {
                log(`âŒ TripleOSResultsView ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                console.error('TripleOSResultsView test error:', error);
            }
        }
        
        // Test layer functionality
        function testLayerFunctionality() {
            try {
                const layerToggleButtons = document.querySelectorAll('.layer-toggle');
                log(`ğŸ” éšå±¤ãƒœã‚¿ãƒ³ç™ºè¦‹: ${layerToggleButtons.length}å€‹`);
                
                if (layerToggleButtons.length > 0) {
                    // Test expanding Level 2
                    log('ğŸ“‚ Level 2å±•é–‹ãƒ†ã‚¹ãƒˆ...');
                    layerToggleButtons[0].click();
                    
                    setTimeout(() => {
                        // Test expanding Level 3
                        if (layerToggleButtons[1]) {
                            log('ğŸ“‚ Level 3å±•é–‹ãƒ†ã‚¹ãƒˆ...');
                            layerToggleButtons[1].click();
                        }
                        
                        setTimeout(() => {
                            // Test expanding Level 4
                            if (layerToggleButtons[2]) {
                                log('ğŸ“‚ Level 4å±•é–‹ãƒ†ã‚¹ãƒˆ...');
                                layerToggleButtons[2].click();
                            }
                            
                            log('âœ… éšå±¤æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                        }, 1000);
                    }, 1000);
                }
                
            } catch (error) {
                log(`âŒ éšå±¤æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }
        
        // Clear test
        function clearTest() {
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('error-container').innerHTML = '';
            document.getElementById('success-container').innerHTML = '';
            testLog = [];
            document.getElementById('test-log').textContent = '[ãƒ†ã‚¹ãƒˆãƒ­ã‚°] ãƒ†ã‚¹ãƒˆã‚¯ãƒªã‚¢å®Œäº†ã€‚';
            currentView = null;
            log('ğŸ—‘ï¸ ãƒ†ã‚¹ãƒˆã‚¯ãƒªã‚¢å®Œäº†');
        }
        
        // Generate mock data only
        function generateMockDataOnly() {
            try {
                const mockData = generateMockTripleOSData();
                log('ğŸ² ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆå®Œäº†');
                log(`ğŸ“Š ãƒ‡ãƒ¼ã‚¿æ§‹é€ : engineOS(${mockData.engineOS.osName}), interfaceOS(${mockData.interfaceOS.osName}), safeModeOS(${mockData.safeModeOS.osName})`);
                log('âœ… Triple OS Architecture ãƒ‡ãƒ¼ã‚¿ç”ŸæˆæˆåŠŸ', 'success');
                return mockData;
            } catch (error) {
                log(`âŒ ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                return null;
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            log('ğŸ¯ LayeredResultsView çµ±åˆãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸æº–å‚™å®Œäº†');
            log('ğŸ’¡ ä½¿ç”¨æ–¹æ³•: ä¸Šã®ãƒœã‚¿ãƒ³ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
            
            document.getElementById('generate-mock-data').addEventListener('click', generateMockDataOnly);
            document.getElementById('test-layered-view').addEventListener('click', testLayeredResultsView);
            document.getElementById('test-existing-view').addEventListener('click', testExistingTripleOSView);
            document.getElementById('clear-test').addEventListener('click', clearTest);
        });
        
        // Error handling
        window.addEventListener('error', (event) => {
            log(`ğŸš¨ Global Error: ${event.error.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            log(`ğŸš¨ Unhandled Promise Rejection: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>