<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LayeredResultsView 統合テスト - HaQei Analyzer Phase 5.2</title>
    
    <!-- Existing stylesheets -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/user-friendly-display.css">
    
    <!-- Phase 5.2: New layered results stylesheet -->
    <link rel="stylesheet" href="css/layered-results.css">
    
    <style>
        /* テスト用追加スタイル */
        .test-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: #0f172a;
            border-radius: 1rem;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1rem;
            background: rgba(16, 185, 129, 0.1);
            border-radius: 0.5rem;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .test-header h1 {
            color: #10b981;
            font-size: 1.8rem;
            margin: 0 0 0.5rem 0;
        }
        
        .test-status {
            color: #cbd5e1;
            font-size: 1rem;
        }
        
        .test-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .test-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .test-btn-primary {
            background: linear-gradient(135deg, #10b981, #22d3ee);
            color: #0f172a;
        }
        
        .test-btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #f1f5f9;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }
        
        .test-log {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 2rem;
            font-family: 'Courier New', monospace;
            color: #22d3ee;
            font-size: 0.9rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid rgba(34, 211, 238, 0.3);
        }
        
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .success-message {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            color: #10b981;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🏗️ LayeredResultsView 統合テスト</h1>
            <div class="test-status">Phase 5.2: UX/情報アーキテクチャ再設計 - bunenjin哲学4階層構造テスト</div>
        </div>
        
        <div class="test-controls">
            <button id="generate-mock-data" class="test-btn test-btn-primary">
                🎲 モックデータ生成
            </button>
            <button id="test-layered-view" class="test-btn test-btn-primary">
                🚀 LayeredResultsView テスト
            </button>
            <button id="test-existing-view" class="test-btn test-btn-secondary">
                📊 既存TripleOSResultsView テスト
            </button>
            <button id="clear-test" class="test-btn test-btn-secondary">
                🗑️ テストクリア
            </button>
        </div>
        
        <div id="test-log" class="test-log">
            [テストログ] 準備完了。上のボタンでテストを開始してください。
        </div>
        
        <div id="error-container"></div>
        <div id="success-container"></div>
        
        <!-- Results display container -->
        <div id="results-container" style="margin-top: 2rem;">
            <!-- LayeredResultsView または TripleOSResultsView がここに表示される -->
        </div>
    </div>

    <!-- Existing JavaScript dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- Data files -->
    <script src="js/data/data_box.js"></script>
    <script src="js/shared/data/questions.js"></script>
    <script src="js/shared/data/vectors.js"></script>
    <script src="js/os-analyzer/data/hexagrams.js"></script>
    <script src="js/os-analyzer/data/hexagram_details.js"></script>
    
    <!-- Core libraries -->
    <script src="js/shared/core/BaseComponent.js"></script>
    <script src="js/shared/core/StorageManager.js"></script>
    <script src="js/shared/core/DataManager.js"></script>
    <script src="js/shared/core/ErrorHandler.js"></script>
    
    <!-- Phase 5.1: Statistical components -->
    <script src="js/os-analyzer/utils/ScientificFormatter.js"></script>
    <script src="js/os-analyzer/core/StatisticalEngine.js"></script>
    
    <!-- OS Analyzer components -->
    <script src="js/os-analyzer/core/Calculator.js"></script>
    <script src="js/os-analyzer/core/TripleOSEngine.js"></script>
    <script src="js/os-analyzer/engines/CompatibilityDataLoader.js"></script>
    
    <!-- Phase 5.2: New components -->
    <script src="js/os-analyzer/components/ExpandableSection.js"></script>
    <script src="js/os-analyzer/components/LayeredResultsView.js"></script>
    
    <!-- Existing comparison component -->
    <script src="js/components/TripleOSResultsView.js"></script>
    
    <script>
        // Test utility functions
        let testLog = [];
        let currentView = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${message}`;
            testLog.push(logEntry);
            
            const logContainer = document.getElementById('test-log');
            logContainer.textContent = testLog.join('\n');
            logContainer.scrollTop = logContainer.scrollHeight;
            
            console.log(logEntry);
            
            // Show status message
            if (type === 'error') {
                showMessage(message, 'error');
            } else if (type === 'success') {
                showMessage(message, 'success');
            }
        }
        
        function showMessage(message, type) {
            const container = type === 'error' ? 
                document.getElementById('error-container') : 
                document.getElementById('success-container');
            
            container.innerHTML = `
                <div class="${type}-message">
                    ${type === 'error' ? '❌' : '✅'} ${message}
                </div>
            `;
            
            setTimeout(() => {
                container.innerHTML = '';
            }, 5000);
        }
        
        // Generate mock Triple OS data
        function generateMockTripleOSData() {
            return {
                analysisType: "tripleOS",
                engineOS: {
                    osId: 1,
                    osName: "乾為天",
                    hexagramInfo: {
                        id: 1,
                        name: "乾為天",
                        name_jp: "けんいてん",
                        reading: "乾為天",
                        description: "創造的な力と指導力を持つ人格",
                        catchphrase: "天の力で新しい道を創る",
                        upper_trigram_id: 1,
                        lower_trigram_id: 1
                    },
                    strength: 0.85,
                    matchPercentage: 0.85,
                    userVector: {
                        "乾_創造性": 18,
                        "震_行動性": 15,
                        "坎_探求性": 12,
                        "艮_安定性": 8,
                        "坤_受容性": 10,
                        "巽_適応性": 11,
                        "離_表現性": 14,
                        "兌_調和性": 12
                    }
                },
                interfaceOS: {
                    osId: 31,
                    osName: "沢山咸",
                    hexagramInfo: {
                        id: 31,
                        name: "沢山咸",
                        name_jp: "たくざんかん",
                        reading: "沢山咸",
                        description: "他者との調和と共感を重視する人格",
                        catchphrase: "心を通わせて絆を深める",
                        upper_trigram_id: 2,
                        lower_trigram_id: 7
                    },
                    strength: 0.78,
                    matchPercentage: 0.78,
                    userVector: {
                        "乾_創造性": 10,
                        "震_行動性": 12,
                        "坎_探求性": 8,
                        "艮_安定性": 16,
                        "坤_受容性": 18,
                        "巽_適応性": 15,
                        "離_表現性": 11,
                        "兌_調和性": 19
                    }
                },
                safeModeOS: {
                    osId: 52,
                    osName: "艮為山",
                    hexagramInfo: {
                        id: 52,
                        name: "艮為山",
                        name_jp: "ごんいざん",
                        reading: "艮為山",
                        description: "慎重で安定を重視する守りの人格",
                        catchphrase: "堅実な基盤で確実に進む",
                        upper_trigram_id: 7,
                        lower_trigram_id: 7
                    },
                    strength: 0.72,
                    matchPercentage: 0.72,
                    userVector: {
                        "乾_創造性": 8,
                        "震_行動性": 9,
                        "坎_探求性": 13,
                        "艮_安定性": 20,
                        "坤_受容性": 14,
                        "巽_適応性": 10,
                        "離_表現性": 7,
                        "兌_調和性": 12
                    }
                },
                eightDimensionVector: {
                    "乾_創造性": 15,
                    "震_行動性": 13,
                    "坎_探求性": 11,
                    "艮_安定性": 14,
                    "坤_受容性": 14,
                    "巽_適応性": 12,
                    "離_表現性": 11,
                    "兌_調和性": 14
                },
                timestamp: new Date().toISOString(),
                
                // 統計品質データ
                quality: {
                    grade: 'A',
                    ratio: 0.89,
                    description: 'テストデータによる高品質な結果'
                },
                
                // 透明性レポート
                transparencyReport: {
                    methodology: {
                        algorithm: 'TripleOS Engine v2.1',
                        weighting: '易経64卦マッチング + 統計的補正'
                    },
                    dataQuality: {
                        confidenceLevel: '89%',
                        standardError: '±3.2%'
                    },
                    limitations: [
                        'テストデータによる模擬分析',
                        '実際の回答に基づかない結果',
                        '統計的精度は参考値'
                    ]
                }
            };
        }
        
        // Test LayeredResultsView
        async function testLayeredResultsView() {
            try {
                log('🚀 LayeredResultsView テスト開始...');
                
                // Clear existing content
                document.getElementById('results-container').innerHTML = '';
                
                // Generate mock data
                const mockData = generateMockTripleOSData();
                log('✅ モックデータ生成完了');
                
                // Create LayeredResultsView instance
                currentView = new LayeredResultsView('results-container', {
                    enableProgressiveDisclosure: true,
                    trackLayerAnalytics: true,
                    mobileOptimized: true,
                    animationDuration: 300,
                    maxConcurrentLayers: 2,
                    autoCollapseInactive: true
                });
                
                log('✅ LayeredResultsView インスタンス生成完了');
                
                // Set data and render
                await currentView.setData(mockData, null);
                log('✅ データ設定・レンダリング完了');
                
                // Test layer functionality
                setTimeout(() => {
                    log('🔍 階層機能テスト開始...');
                    testLayerFunctionality();
                }, 1000);
                
                log('🎉 LayeredResultsView テスト成功！', 'success');
                
            } catch (error) {
                log(`❌ LayeredResultsView テストエラー: ${error.message}`, 'error');
                console.error('LayeredResultsView test error:', error);
            }
        }
        
        // Test existing TripleOSResultsView for comparison
        async function testExistingTripleOSView() {
            try {
                log('📊 既存TripleOSResultsView テスト開始...');
                
                // Clear existing content
                document.getElementById('results-container').innerHTML = '';
                
                // Generate mock data
                const mockData = generateMockTripleOSData();
                log('✅ モックデータ生成完了');
                
                // Initialize required components
                const dataManager = new DataManager();
                await dataManager.loadData();
                const compatibilityLoader = new CompatibilityDataLoader();
                
                // Create TripleOSResultsView instance
                currentView = new TripleOSResultsView('results-container', {
                    analysisResult: mockData,
                    insights: null,
                    compatibilityLoader: compatibilityLoader,
                    dataManager: dataManager,
                    enableSelfReflection: true,
                    showWisdomPreface: true
                });
                
                log('✅ TripleOSResultsView インスタンス生成完了');
                
                // Initialize and render
                await currentView.init();
                log('✅ 初期化・レンダリング完了');
                
                log('🎉 既存TripleOSResultsView テスト成功！', 'success');
                
            } catch (error) {
                log(`❌ TripleOSResultsView テストエラー: ${error.message}`, 'error');
                console.error('TripleOSResultsView test error:', error);
            }
        }
        
        // Test layer functionality
        function testLayerFunctionality() {
            try {
                const layerToggleButtons = document.querySelectorAll('.layer-toggle');
                log(`🔍 階層ボタン発見: ${layerToggleButtons.length}個`);
                
                if (layerToggleButtons.length > 0) {
                    // Test expanding Level 2
                    log('📂 Level 2展開テスト...');
                    layerToggleButtons[0].click();
                    
                    setTimeout(() => {
                        // Test expanding Level 3
                        if (layerToggleButtons[1]) {
                            log('📂 Level 3展開テスト...');
                            layerToggleButtons[1].click();
                        }
                        
                        setTimeout(() => {
                            // Test expanding Level 4
                            if (layerToggleButtons[2]) {
                                log('📂 Level 4展開テスト...');
                                layerToggleButtons[2].click();
                            }
                            
                            log('✅ 階層機能テスト完了', 'success');
                        }, 1000);
                    }, 1000);
                }
                
            } catch (error) {
                log(`❌ 階層機能テストエラー: ${error.message}`, 'error');
            }
        }
        
        // Clear test
        function clearTest() {
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('error-container').innerHTML = '';
            document.getElementById('success-container').innerHTML = '';
            testLog = [];
            document.getElementById('test-log').textContent = '[テストログ] テストクリア完了。';
            currentView = null;
            log('🗑️ テストクリア完了');
        }
        
        // Generate mock data only
        function generateMockDataOnly() {
            try {
                const mockData = generateMockTripleOSData();
                log('🎲 モックデータ生成完了');
                log(`📊 データ構造: engineOS(${mockData.engineOS.osName}), interfaceOS(${mockData.interfaceOS.osName}), safeModeOS(${mockData.safeModeOS.osName})`);
                log('✅ Triple OS Architecture データ生成成功', 'success');
                return mockData;
            } catch (error) {
                log(`❌ モックデータ生成エラー: ${error.message}`, 'error');
                return null;
            }
        }
        
        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            log('🎯 LayeredResultsView 統合テストページ準備完了');
            log('💡 使用方法: 上のボタンでテストを実行してください');
            
            document.getElementById('generate-mock-data').addEventListener('click', generateMockDataOnly);
            document.getElementById('test-layered-view').addEventListener('click', testLayeredResultsView);
            document.getElementById('test-existing-view').addEventListener('click', testExistingTripleOSView);
            document.getElementById('clear-test').addEventListener('click', clearTest);
        });
        
        // Error handling
        window.addEventListener('error', (event) => {
            log(`🚨 Global Error: ${event.error.message}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            log(`🚨 Unhandled Promise Rejection: ${event.reason}`, 'error');
        });
    </script>
</body>
</html>