<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Storage Debug Test</title>
    <style>
        body { font-family: monospace; padding: 20px; }
        .log { background: #f0f0f0; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffe6e6; color: #cc0000; }
        .success { background: #e6ffe6; color: #008800; }
        .warning { background: #fff3cd; color: #856404; }
        button { padding: 10px 20px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîç Storage Manager Debug Test</h1>
    
    <div>
        <button onclick="clearAllStorage()">Clear All Storage</button>
        <button onclick="testBasicStorage()">Test Basic Storage</button>
        <button onclick="testAnalysisStorage()">Test Analysis Storage</button>
        <button onclick="checkCurrentStorage()">Check Current Storage</button>
        <button onclick="simulateOSAnalyzerSave()">Simulate OS Analyzer Save</button>
        <button onclick="simulateResultsLoad()">Simulate Results Load</button>
        <br><br>
        <button onclick="testSimpleStorage()">Test Simple Storage Manager</button>
        <button onclick="compareStorageManagers()">Compare Storage Managers</button>
    </div>

    <div id="output"></div>

    <!-- StorageManagerË™≠„ÅøËæº„Åø -->
    <script src="./js/shared/core/StorageManager.js"></script>
    <script src="./js/shared/core/SimpleStorageManager.js"></script>
    
    <script>
        let storageManager;
        let simpleStorageManager;
        
        function log(message, type = 'log') {
            const output = document.getElementById('output');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            output.appendChild(div);
            output.scrollTop = output.scrollHeight;
            console.log(message);
        }

        function clearAllStorage() {
            localStorage.clear();
            sessionStorage.clear();
            log('‚úÖ All storage cleared', 'success');
        }

        function testBasicStorage() {
            try {
                storageManager = new StorageManager();
                log('‚úÖ StorageManager initialized successfully', 'success');
                
                // „ÉÜ„Çπ„Éà„Éá„Éº„Çø„ÅÆ‰øùÂ≠ò„ÉªÂèñÂæó
                const testData = { test: 'value', timestamp: Date.now() };
                storageManager.setItem('test_key', testData);
                const retrieved = storageManager.getItem('test_key');
                
                if (JSON.stringify(testData) === JSON.stringify(retrieved)) {
                    log('‚úÖ Basic storage operations working', 'success');
                } else {
                    log('‚ùå Basic storage operations failed', 'error');
                }
            } catch (error) {
                log(`‚ùå StorageManager initialization failed: ${error.message}`, 'error');
            }
        }

        function testAnalysisStorage() {
            if (!storageManager) {
                log('‚ùå StorageManager not initialized', 'error');
                return;
            }

            // ÂàÜÊûêÁµêÊûú„ÅÆ„É¢„ÉÉ„ÇØ„Éá„Éº„Çø
            const mockAnalysisResult = {
                engineOS: {
                    name: "Engine OS",
                    hexagram: { id: 1, name: "‰πæ", symbol: "‚ò∞", binary: "111111" },
                    score: 85,
                    confidence: 0.92,
                    description: "‰æ°ÂÄ§Ë¶≥„Ç∑„Çπ„ÉÜ„É†"
                },
                interfaceOS: {
                    name: "Interface OS", 
                    hexagram: { id: 2, name: "Âù§", symbol: "‚ò∑", binary: "000000" },
                    score: 72,
                    confidence: 0.88,
                    description: "Á§æ‰ºöÁöÑ„Ç∑„Çπ„ÉÜ„É†"
                },
                safeModeOS: {
                    name: "SafeMode OS",
                    hexagram: { id: 3, name: "Â±Ø", symbol: "‚òµ", binary: "010001" },
                    score: 68,
                    confidence: 0.85,
                    description: "Èò≤Âæ°„Ç∑„Çπ„ÉÜ„É†"
                },
                timestamp: Date.now(),
                version: "1.0"
            };

            try {
                // ÂàÜÊûêÁµêÊûú„ÅÆ‰øùÂ≠ò
                storageManager.saveAnalysisResult(mockAnalysisResult);
                log('‚úÖ Analysis result saved', 'success');

                // ÂàÜÊûêÁµêÊûú„ÅÆÂèñÂæó„ÉÜ„Çπ„Éà
                const retrieved = storageManager.getAnalysisResult();
                
                if (retrieved) {
                    log('‚úÖ Analysis result retrieved successfully', 'success');
                    log(`üìä Retrieved data keys: ${Object.keys(retrieved).join(', ')}`, 'log');
                    
                    // Triple OSÊßãÈÄ†„ÅÆÁ¢∫Ë™ç
                    if (retrieved.engineOS && retrieved.interfaceOS && retrieved.safeModeOS) {
                        log('‚úÖ Triple OS structure confirmed', 'success');
                    } else {
                        log('‚ö†Ô∏è Triple OS structure incomplete', 'warning');
                        log(`Missing: ${['engineOS', 'interfaceOS', 'safeModeOS'].filter(key => !retrieved[key]).join(', ')}`, 'warning');
                    }
                } else {
                    log('‚ùå Analysis result retrieval failed', 'error');
                }
            } catch (error) {
                log(`‚ùå Analysis storage test failed: ${error.message}`, 'error');
            }
        }

        function checkCurrentStorage() {
            log('=== Current Storage Status ===', 'log');
            
            // localStorage keys
            const localKeys = Object.keys(localStorage).filter(key => key.includes('haqei'));
            log(`üóÇÔ∏è LocalStorage HAQEI keys (${localKeys.length}): ${localKeys.join(', ')}`, 'log');
            
            localKeys.forEach(key => {
                try {
                    const value = localStorage.getItem(key);
                    const parsed = JSON.parse(value);
                    log(`üìã ${key}: ${typeof parsed} (${JSON.stringify(parsed).length} chars)`, 'log');
                } catch (e) {
                    log(`üìã ${key}: ${value ? value.substring(0, 100) + '...' : 'null'}`, 'log');
                }
            });

            // StorageManager getAnalysisResult test
            if (storageManager) {
                try {
                    const result = storageManager.getAnalysisResult();
                    if (result) {
                        log('‚úÖ getAnalysisResult() working', 'success');
                        log(`üìä Result keys: ${Object.keys(result).join(', ')}`, 'log');
                    } else {
                        log('‚ö†Ô∏è getAnalysisResult() returned null', 'warning');
                    }
                } catch (error) {
                    log(`‚ùå getAnalysisResult() error: ${error.message}`, 'error');
                }
            }
        }

        function simulateOSAnalyzerSave() {
            // os_analyzer.html„ÅåÂÆüÈöõ„Å´Ë°å„ÅÜ‰øùÂ≠òÂá¶ÁêÜ„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
            const analysisData = {
                engineOS: {
                    name: "‰æ°ÂÄ§Ë¶≥„Ç∑„Çπ„ÉÜ„É†",
                    hexagram: { id: 1, name: "‰πæ" },
                    score: 78,
                    matchScore: 0.89
                },
                interfaceOS: {
                    name: "Á§æ‰ºöÁöÑ„Ç∑„Çπ„ÉÜ„É†", 
                    hexagram: { id: 14, name: "Â§ßÊúâ" },
                    score: 65,
                    matchScore: 0.82
                },
                safeModeOS: {
                    name: "Èò≤Âæ°„Ç∑„Çπ„ÉÜ„É†",
                    hexagram: { id: 23, name: "Ââ•" },
                    score: 71,
                    matchScore: 0.85
                },
                metadata: {
                    timestamp: Date.now(),
                    version: "2.0",
                    source: "os_analyzer"
                }
            };

            // Ë§áÊï∞„ÅÆ‰øùÂ≠òÊñπÊ≥ï„Çí„ÉÜ„Çπ„Éà
            try {
                // ÊñπÊ≥ï1: Áõ¥Êé•localStorage
                localStorage.setItem('haqei_analysis_result', JSON.stringify(analysisData));
                log('‚úÖ Direct localStorage save completed', 'success');

                // ÊñπÊ≥ï2: StorageManagerÁµåÁî±
                if (storageManager) {
                    storageManager.saveAnalysisResult(analysisData);
                    log('‚úÖ StorageManager save completed', 'success');
                }

                // ÊñπÊ≥ï3: Á∑äÊÄ•„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó
                localStorage.setItem('haqei_emergency_result', JSON.stringify({
                    result: analysisData,
                    timestamp: Date.now(),
                    source: 'emergency_backup'
                }));
                log('‚úÖ Emergency backup save completed', 'success');

            } catch (error) {
                log(`‚ùå OS Analyzer save simulation failed: ${error.message}`, 'error');
            }
        }

        function simulateResultsLoad() {
            // results.html„ÅåÂÆüÈöõ„Å´Ë°å„ÅÜË™≠„ÅøËæº„ÅøÂá¶ÁêÜ„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
            log('=== Simulating Results Page Load ===', 'log');

            try {
                // ÊñπÊ≥ï1: StorageManagerÁµåÁî±
                if (storageManager) {
                    const result1 = storageManager.getAnalysisResult();
                    if (result1) {
                        log('‚úÖ StorageManager load: SUCCESS', 'success');
                        log(`üìä Data structure: ${Object.keys(result1).join(', ')}`, 'log');
                        
                        // Triple OS validation
                        const hasTripleOS = result1.engineOS && result1.interfaceOS && result1.safeModeOS;
                        if (hasTripleOS) {
                            log('‚úÖ Triple OS structure validated', 'success');
                        } else {
                            log('‚ùå Triple OS structure incomplete', 'error');
                        }
                    } else {
                        log('‚ùå StorageManager load: FAILED', 'error');
                    }
                }

                // ÊñπÊ≥ï2: Áõ¥Êé•localStorage
                const directResult = localStorage.getItem('haqei_analysis_result');
                if (directResult) {
                    try {
                        const parsed = JSON.parse(directResult);
                        log('‚úÖ Direct localStorage load: SUCCESS', 'success');
                    } catch (parseError) {
                        log('‚ùå Direct localStorage parse error', 'error');
                    }
                } else {
                    log('‚ùå Direct localStorage load: NO DATA', 'error');
                }

                // ÊñπÊ≥ï3: Á∑äÊÄ•„Éá„Éº„ÇøÁ¢∫Ë™ç
                const emergencyResult = localStorage.getItem('haqei_emergency_result');
                if (emergencyResult) {
                    try {
                        const parsed = JSON.parse(emergencyResult);
                        log('‚úÖ Emergency backup available', 'success');
                    } catch (parseError) {
                        log('‚ùå Emergency backup parse error', 'error');
                    }
                } else {
                    log('‚ö†Ô∏è No emergency backup found', 'warning');
                }

            } catch (error) {
                log(`‚ùå Results load simulation failed: ${error.message}`, 'error');
            }
        }

        function testSimpleStorage() {
            log('=== Testing Simple Storage Manager ===', 'log');
            
            try {
                simpleStorageManager = new SimpleStorageManager();
                log('‚úÖ SimpleStorageManager initialized', 'success');

                // „ÉÜ„Çπ„Éà„Éá„Éº„Çø‰ΩúÊàê
                const testAnalysisResult = {
                    engineOS: {
                        name: "‰æ°ÂÄ§Ë¶≥„Ç∑„Çπ„ÉÜ„É†",
                        hexagram: { id: 1, name: "‰πæ", symbol: "‚ò∞" },
                        score: 85,
                        confidence: 0.92,
                        description: "Ê†∏„Å®„Å™„Çã‰æ°ÂÄ§Ë¶≥„ÉªÈáçË¶Å„Å™Âà§Êñ≠Âü∫Ê∫ñ"
                    },
                    interfaceOS: {
                        name: "Á§æ‰ºöÁöÑ„Ç∑„Çπ„ÉÜ„É†", 
                        hexagram: { id: 14, name: "Â§ßÊúâ", symbol: "‚ò≤" },
                        score: 72,
                        confidence: 0.88,
                        description: "‰ªñËÄÖ„Å´Ë¶ã„Åõ„ÇãËá™ÂàÜ„ÉªÁ§æ‰ºöÁöÑË°®Áèæ"
                    },
                    safeModeOS: {
                        name: "Èò≤Âæ°„Ç∑„Çπ„ÉÜ„É†",
                        hexagram: { id: 23, name: "Ââ•", symbol: "‚ò∂" },
                        score: 68,
                        confidence: 0.85,
                        description: "ÂÜÖ„Å™„ÇãËá™ÂàÜ„ÅÆÈò≤Âæ°Ê©üÂà∂„Éª„Çπ„Éà„É¨„ÇπÂØæÂá¶"
                    },
                    timestamp: Date.now(),
                    version: "2.0"
                };

                // ‰øùÂ≠ò„ÉÜ„Çπ„Éà
                const saveResult = simpleStorageManager.saveAnalysisResult(testAnalysisResult);
                if (saveResult) {
                    log('‚úÖ Simple storage save: SUCCESS', 'success');
                } else {
                    log('‚ùå Simple storage save: FAILED', 'error');
                    return;
                }

                // ÂèñÂæó„ÉÜ„Çπ„Éà
                const retrieved = simpleStorageManager.getAnalysisResult();
                if (retrieved) {
                    log('‚úÖ Simple storage get: SUCCESS', 'success');
                    log(`üìä Retrieved keys: ${Object.keys(retrieved).join(', ')}`, 'log');
                    
                    // Triple OSÊ§úË®º
                    if (retrieved.engineOS && retrieved.interfaceOS && retrieved.safeModeOS) {
                        log('‚úÖ Triple OS structure validated', 'success');
                    } else {
                        log('‚ùå Triple OS structure incomplete', 'error');
                    }
                } else {
                    log('‚ùå Simple storage get: FAILED', 'error');
                }

                // „Ç§„É≥„Çµ„Ç§„Éà„ÉÜ„Çπ„Éà
                const testInsights = {
                    keyInsights: ["„ÉÜ„Çπ„ÉàÊ¥ûÂØü1", "„ÉÜ„Çπ„ÉàÊ¥ûÂØü2"],
                    recommendations: ["Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥1", "Êé®Â•®„Ç¢„ÇØ„Ç∑„Éß„É≥2"],
                    timestamp: Date.now()
                };

                simpleStorageManager.saveInsights(testInsights);
                const retrievedInsights = simpleStorageManager.getInsights();
                
                if (retrievedInsights) {
                    log('‚úÖ Simple insights: SUCCESS', 'success');
                } else {
                    log('‚ùå Simple insights: FAILED', 'error');
                }

            } catch (error) {
                log(`‚ùå Simple storage test error: ${error.message}`, 'error');
            }
        }

        function compareStorageManagers() {
            log('=== Comparing Storage Managers ===', 'log');
            
            if (!storageManager || !simpleStorageManager) {
                log('‚ùå Both storage managers need to be initialized first', 'error');
                return;
            }

            // Âêå„Åò„Éá„Éº„Çø„Åß‰∏°Êñπ„Çí„ÉÜ„Çπ„Éà
            const testData = {
                engineOS: {
                    name: "ÊØîËºÉ„ÉÜ„Çπ„ÉàÁî®",
                    hexagram: { id: 42, name: "Áõä" },
                    score: 77
                },
                interfaceOS: {
                    name: "ÊØîËºÉ„ÉÜ„Çπ„ÉàÁî®",
                    hexagram: { id: 43, name: "Â§¨" },
                    score: 83
                },
                safeModeOS: {
                    name: "ÊØîËºÉ„ÉÜ„Çπ„ÉàÁî®",
                    hexagram: { id: 44, name: "Âß§" },
                    score: 69
                }
            };

            try {
                // ÊóßStorageManager
                log('Testing legacy StorageManager...', 'log');
                storageManager.saveAnalysisResult(testData);
                const legacyResult = storageManager.getAnalysisResult();
                
                if (legacyResult) {
                    log('‚úÖ Legacy manager: SUCCESS', 'success');
                } else {
                    log('‚ùå Legacy manager: FAILED', 'error');
                }

                // SimpleStorageManager
                log('Testing SimpleStorageManager...', 'log');
                const simpleResult = simpleStorageManager.saveAnalysisResult(testData);
                const retrievedSimple = simpleStorageManager.getAnalysisResult();

                if (simpleResult && retrievedSimple) {
                    log('‚úÖ Simple manager: SUCCESS', 'success');
                } else {
                    log('‚ùå Simple manager: FAILED', 'error');
                }

                // Áõ∏‰∫íÈÅãÁî®ÊÄß„ÉÜ„Çπ„Éà
                log('Testing cross-compatibility...', 'log');
                
                // SimpleStorageManager„Åß‰øùÂ≠ò„Åó„Åü„Éá„Éº„Çø„ÇíÊóßStorageManager„ÅßË™≠„ÅøÂèñ„Çä
                const crossTest = storageManager.getAnalysisResult();
                if (crossTest) {
                    log('‚úÖ Cross-compatibility: Simple‚ÜíLegacy SUCCESS', 'success');
                } else {
                    log('‚ö†Ô∏è Cross-compatibility: Simple‚ÜíLegacy FAILED', 'warning');
                }

            } catch (error) {
                log(`‚ùå Comparison test error: ${error.message}`, 'error');
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        window.addEventListener('DOMContentLoaded', () => {
            log('üöÄ Storage Debug Test initialized', 'success');
            testBasicStorage();
        });
    </script>
</body>
</html>