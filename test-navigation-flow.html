<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Analyzer→Results 遷移テスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>🔍 OS Analyzer → Results 遷移問題診断</h1>
    <p>OS AnalyzerからResultsページへの遷移で発生している不安定な挙動を診断します。</p>
    
    <div class="test-container">
        <h2>📊 テスト実行</h2>
        <button onclick="testStorageSystem()">🗄️ ストレージシステムテスト</button>
        <button onclick="testDataTransfer()">📤 データ転送テスト</button>
        <button onclick="testNavigation()">🚀 ナビゲーションテスト</button>
        <button onclick="simulateUserFlow()">👤 ユーザーフロー模擬実行</button>
        <button onclick="clearAllData()">🧹 全データクリア</button>
        
        <div id="test-results"></div>
    </div>

    <!-- StorageManagerとBridgeStorageManagerを読み込み -->
    <script src="./js/shared/core/StorageManager.js"></script>
    <script src="./js/shared/core/BridgeStorageManager.js"></script>
    
    <script>
        let testResults = [];
        
        /**
         * テスト結果を表示エリアに追加
         */
        function addTestResult(type, title, message, details = null) {
            const result = {
                type: type,
                title: title,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            
            let content = `<strong>${title}</strong>: ${message}`;
            if (details) {
                content += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = content;
            resultsDiv.appendChild(resultDiv);
            
            // 自動スクロール
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * ストレージシステムテスト
         */
        function testStorageSystem() {
            console.log('🗄️ ストレージシステムテスト開始...');
            
            try {
                // StorageManagerインスタンス作成
                const storageManager = new StorageManager();
                addTestResult('success', 'StorageManager初期化', '✅ StorageManagerが正常に作成されました');
                
                // BridgeStorageManagerインスタンス作成
                const bridgeStorageManager = new BridgeStorageManager(storageManager);
                addTestResult('success', 'BridgeStorageManager初期化', '✅ BridgeStorageManagerが正常に作成されました');
                
                // 基本機能テスト
                const testData = {
                    engineOS: { score: 75, traits: ['創造性', '独立性'] },
                    interfaceOS: { score: 68, traits: ['協調性', '共感力'] },
                    safeModeOS: { score: 82, traits: ['慎重性', '分析力'] },
                    analysisType: 'triple_os',
                    timestamp: new Date().toISOString()
                };
                
                // データ保存テスト
                const saveSuccess = bridgeStorageManager.saveAnalysisResult(testData);
                if (saveSuccess) {
                    addTestResult('success', 'データ保存', '✅ 分析結果が正常に保存されました');
                } else {
                    addTestResult('error', 'データ保存', '❌ 分析結果の保存に失敗しました');
                }
                
                // データ読み込みテスト
                const retrievedData = bridgeStorageManager.getAnalysisResult();
                if (retrievedData && retrievedData.engineOS) {
                    addTestResult('success', 'データ読み込み', '✅ 分析結果が正常に読み込まれました', {
                        engineScore: retrievedData.engineOS.score,
                        interfaceScore: retrievedData.interfaceOS?.score,
                        safeModeScore: retrievedData.safeModeOS?.score
                    });
                } else {
                    addTestResult('error', 'データ読み込み', '❌ 分析結果の読み込みに失敗しました', retrievedData);
                }
                
                // インサイトテスト
                const testInsights = {
                    summary: 'テスト用インサイト',
                    recommendations: ['推奨事項1', '推奨事項2'],
                    timestamp: new Date().toISOString()
                };
                
                bridgeStorageManager.saveInsights(testInsights);
                const retrievedInsights = bridgeStorageManager.getInsights();
                
                if (retrievedInsights && retrievedInsights.summary) {
                    addTestResult('success', 'インサイト処理', '✅ インサイトが正常に処理されました');
                } else {
                    addTestResult('warning', 'インサイト処理', '⚠️ インサイトの処理で問題が発生しました', retrievedInsights);
                }
                
            } catch (error) {
                addTestResult('error', 'ストレージシステムエラー', `❌ エラーが発生しました: ${error.message}`, {
                    stack: error.stack
                });
            }
        }

        /**
         * データ転送テスト
         */
        function testDataTransfer() {
            console.log('📤 データ転送テスト開始...');
            
            try {
                // localStorage直接確認
                const keys = Object.keys(localStorage).filter(key => key.includes('haqei'));
                addTestResult('info', 'localStorage確認', `📊 HAQEIデータキー数: ${keys.length}個`, keys);
                
                // 各キーのデータサイズ確認
                keys.forEach(key => {
                    const data = localStorage.getItem(key);
                    const size = new Blob([data]).size;
                    
                    if (size > 1024) {
                        addTestResult('info', `データサイズ: ${key}`, `📏 ${(size / 1024).toFixed(2)}KB`);
                    }
                });
                
                // セッション情報確認
                const storageManager = new StorageManager();
                const session = storageManager.getSession();
                
                if (session) {
                    addTestResult('success', 'セッション情報', '✅ セッション情報が存在します', {
                        stage: session.stage,
                        sessionId: session.sessionId,
                        lastActivity: session.lastActivity
                    });
                } else {
                    addTestResult('warning', 'セッション情報', '⚠️ セッション情報が見つかりません');
                }
                
            } catch (error) {
                addTestResult('error', 'データ転送テストエラー', `❌ エラーが発生しました: ${error.message}`);
            }
        }

        /**
         * ナビゲーションテスト
         */
        function testNavigation() {
            console.log('🚀 ナビゲーションテスト開始...');
            
            // 現在のURL確認
            addTestResult('info', '現在のURL', `📍 ${window.location.href}`);
            
            // OS Analyzerへのアクセステスト
            fetch('/os_analyzer')
                .then(response => {
                    if (response.ok) {
                        addTestResult('success', 'OS Analyzerアクセス', '✅ OS Analyzerページにアクセス可能です');
                    } else {
                        addTestResult('error', 'OS Analyzerアクセス', `❌ HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    addTestResult('error', 'OS Analyzerアクセス', `❌ アクセスエラー: ${error.message}`);
                });
            
            // Resultsページへのアクセステスト
            fetch('/results')
                .then(response => {
                    if (response.ok) {
                        addTestResult('success', 'Resultsアクセス', '✅ Resultsページにアクセス可能です');
                    } else {
                        addTestResult('error', 'Resultsアクセス', `❌ HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    addTestResult('error', 'Resultsアクセス', `❌ アクセスエラー: ${error.message}`);
                });
        }

        /**
         * ユーザーフロー模擬実行
         */
        function simulateUserFlow() {
            console.log('👤 ユーザーフロー模擬実行開始...');
            
            try {
                // Step 1: 分析結果のシミュレーション
                const mockAnalysisResult = {
                    engineOS: {
                        score: 75,
                        traits: ['創造性', '独立性', '理想主義'],
                        description: 'エンジンOSテストデータ'
                    },
                    interfaceOS: {
                        score: 68,
                        traits: ['協調性', '共感力', '適応性'],
                        description: 'インターフェースOSテストデータ'
                    },
                    safeModeOS: {
                        score: 82,
                        traits: ['慎重性', '分析力', '防御性'],
                        description: 'セーフモードOSテストデータ'
                    },
                    analysisType: 'triple_os',
                    timestamp: new Date().toISOString(),
                    userFlow: 'simulated'
                };
                
                const mockInsights = {
                    summary: 'ユーザーフロー模擬実行で生成されたインサイト',
                    recommendations: [
                        '創造性を活かした活動に取り組む',
                        '他者との協調を大切にする',
                        '慎重な判断を心がける'
                    ],
                    timestamp: new Date().toISOString()
                };
                
                // Step 2: データ保存（OS Analyzerでの処理をシミュレート）
                const storageManager = new StorageManager();
                const bridgeStorageManager = new BridgeStorageManager(storageManager);
                
                bridgeStorageManager.saveAnalysisResult(mockAnalysisResult);
                bridgeStorageManager.saveInsights(mockInsights);
                bridgeStorageManager.updateSession({ stage: 'results' });
                
                addTestResult('success', 'ユーザーフロー Step 1-2', '✅ 分析結果とインサイトの保存が完了しました');
                
                // Step 3: データ検証（Resultsページでの処理をシミュレート）
                setTimeout(() => {
                    const retrievedResult = bridgeStorageManager.getAnalysisResult();
                    const retrievedInsights = bridgeStorageManager.getInsights();
                    
                    if (retrievedResult && retrievedResult.engineOS && 
                        retrievedInsights && retrievedInsights.summary) {
                        
                        addTestResult('success', 'ユーザーフロー Step 3', '✅ Resultsページでのデータ取得が成功しました', {
                            analysisDataPresent: true,
                            insightsDataPresent: true,
                            engineScore: retrievedResult.engineOS.score,
                            recommendationsCount: retrievedInsights.recommendations?.length || 0
                        });
                        
                        // Step 4: 遷移シミュレーション
                        setTimeout(() => {
                            addTestResult('info', 'ユーザーフロー完了', 
                                '🎯 模擬ユーザーフローが正常に完了しました。実際のresults.htmlへの遷移をテストしますか？');
                            
                            // 実際の遷移オプションを提供
                            const navigateBtn = document.createElement('button');
                            navigateBtn.textContent = '🚀 results.htmlに実際に遷移する';
                            navigateBtn.onclick = () => {
                                addTestResult('info', '遷移実行', 'results.htmlに遷移しています...');
                                setTimeout(() => {
                                    window.location.href = '/results';
                                }, 1000);
                            };
                            
                            document.getElementById('test-results').appendChild(navigateBtn);
                            
                        }, 1000);
                        
                    } else {
                        addTestResult('error', 'ユーザーフロー Step 3', '❌ Resultsページでのデータ取得に失敗しました', {
                            analysisResult: !!retrievedResult,
                            insights: !!retrievedInsights
                        });
                    }
                }, 500);
                
            } catch (error) {
                addTestResult('error', 'ユーザーフローエラー', `❌ エラーが発生しました: ${error.message}`);
            }
        }

        /**
         * 全データクリア
         */
        function clearAllData() {
            try {
                const keys = Object.keys(localStorage).filter(key => key.includes('haqei'));
                keys.forEach(key => localStorage.removeItem(key));
                
                // テスト結果もクリア
                document.getElementById('test-results').innerHTML = '';
                testResults = [];
                
                addTestResult('success', 'データクリア', `✅ ${keys.length}個のデータキーをクリアしました`);
            } catch (error) {
                addTestResult('error', 'データクリアエラー', `❌ エラーが発生しました: ${error.message}`);
            }
        }

        // ページ読み込み時の初期情報表示
        window.addEventListener('load', function() {
            addTestResult('info', 'テストページ読み込み完了', 
                'OS Analyzer → Results 遷移問題の診断を開始します');
        });
    </script>
</body>
</html>