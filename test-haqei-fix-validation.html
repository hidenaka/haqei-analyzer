<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI System Fix Validation Test</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        .test-header h1 {
            color: #4f46e5;
            margin-bottom: 10px;
        }
        .test-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            border-left: 4px solid #4f46e5;
        }
        .test-button {
            background: linear-gradient(45deg, #4f46e5, #7c3aed);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
            transition: all 0.2s;
        }
        .test-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(79, 70, 229, 0.3);
        }
        .test-results {
            background: #1f2937;
            color: #e5e7eb;
            padding: 20px;
            border-radius: 10px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            margin-top: 15px;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background: #10b981; }
        .status-fail { background: #ef4444; }
        .status-warning { background: #f59e0b; }
        .dependency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .dependency-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e5e7eb;
            transition: border-color 0.2s;
        }
        .dependency-card.loaded { border-color: #10b981; }
        .dependency-card.missing { border-color: #ef4444; }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸš€ HAQEI ã‚·ã‚¹ãƒ†ãƒ ä¿®æ­£æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
            <p>CacheManagerãƒ»PerformanceOptimizerãƒ»VirtualQuestionFlow findIndexä¿®æ­£ã®å®Œå…¨æ¤œè¨¼</p>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ 1. ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯</h2>
            <button class="test-button" onclick="checkDependencies()">ä¾å­˜é–¢ä¿‚ã‚’ç¢ºèª</button>
            <div id="dependency-results" class="test-results" style="display: none;"></div>
            
            <div id="dependency-grid" class="dependency-grid" style="display: none;">
                <div class="dependency-card" id="cache-manager-card">
                    <h3>CacheManager</h3>
                    <p id="cache-manager-status">æœªç¢ºèª</p>
                </div>
                <div class="dependency-card" id="performance-optimizer-card">
                    <h3>PerformanceOptimizer</h3>
                    <p id="performance-optimizer-status">æœªç¢ºèª</p>
                </div>
                <div class="dependency-card" id="virtual-question-flow-card">
                    <h3>VirtualQuestionFlow</h3>
                    <p id="virtual-question-flow-status">æœªç¢ºèª</p>
                </div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ”§ 2. VirtualQuestionFlow findIndexä¿®æ­£ãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="testFindIndexFix()">findIndexä¿®æ­£ã‚’ãƒ†ã‚¹ãƒˆ</button>
            <div id="findindex-results" class="test-results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>âš¡ 3. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="testPerformanceSystems()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ©Ÿèƒ½ã‚’ãƒ†ã‚¹ãƒˆ</button>
            <div id="performance-results" class="test-results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ§ª 4. çµ±åˆãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="runIntegrationTest()">å®Œå…¨çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
            <div id="integration-results" class="test-results" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ 5. å®Ÿãƒšãƒ¼ã‚¸ãƒ†ã‚¹ãƒˆ</h2>
            <button class="test-button" onclick="window.open('os_analyzer.html', '_blank')">os_analyzer.html ã‚’é–‹ã</button>
            <p>å®Ÿéš›ã®ãƒšãƒ¼ã‚¸ã§CacheManagerãƒ»PerformanceOptimizerãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¦ãã ã•ã„ã€‚</p>
        </div>
    </div>

    <script>
        function log(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.style.display = 'block';
            
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'ğŸ“';
            
            container.innerHTML += `[${timestamp}] ${prefix} ${message}\n`;
            container.scrollTop = container.scrollHeight;
        }

        function updateDependencyCard(cardId, status, statusText) {
            const card = document.getElementById(cardId);
            const statusElement = document.getElementById(cardId.replace('-card', '-status'));
            
            card.className = `dependency-card ${status}`;
            statusElement.textContent = statusText;
        }

        async function checkDependencies() {
            log('dependency-results', '=== ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===');
            document.getElementById('dependency-grid').style.display = 'grid';
            
            // CacheManager ãƒã‚§ãƒƒã‚¯
            try {
                if (typeof CacheManager !== 'undefined') {
                    const cacheManager = new CacheManager();
                    await cacheManager.init();
                    log('dependency-results', 'CacheManager: åˆ©ç”¨å¯èƒ½ âœ…', 'success');
                    updateDependencyCard('cache-manager-card', 'loaded', 'âœ… èª­ã¿è¾¼ã¿å®Œäº†ãƒ»åˆæœŸåŒ–æˆåŠŸ');
                } else {
                    log('dependency-results', 'CacheManager: æœªå®šç¾©', 'error');
                    updateDependencyCard('cache-manager-card', 'missing', 'âŒ CacheManagerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                log('dependency-results', `CacheManager ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateDependencyCard('cache-manager-card', 'missing', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }

            // PerformanceOptimizer ãƒã‚§ãƒƒã‚¯
            try {
                if (typeof PerformanceOptimizer !== 'undefined') {
                    const optimizer = new PerformanceOptimizer();
                    await optimizer.init();
                    log('dependency-results', 'PerformanceOptimizer: åˆ©ç”¨å¯èƒ½ âœ…', 'success');
                    updateDependencyCard('performance-optimizer-card', 'loaded', 'âœ… èª­ã¿è¾¼ã¿å®Œäº†ãƒ»åˆæœŸåŒ–æˆåŠŸ');
                } else {
                    log('dependency-results', 'PerformanceOptimizer: æœªå®šç¾©', 'error');
                    updateDependencyCard('performance-optimizer-card', 'missing', 'âŒ PerformanceOptimizerãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                log('dependency-results', `PerformanceOptimizer ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateDependencyCard('performance-optimizer-card', 'missing', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }

            // VirtualQuestionFlow ãƒã‚§ãƒƒã‚¯
            try {
                if (typeof VirtualQuestionFlow !== 'undefined') {
                    log('dependency-results', 'VirtualQuestionFlow: åˆ©ç”¨å¯èƒ½ âœ…', 'success');
                    updateDependencyCard('virtual-question-flow-card', 'loaded', 'âœ… ã‚¯ãƒ©ã‚¹å®šç¾©ç¢ºèª');
                } else {
                    log('dependency-results', 'VirtualQuestionFlow: æœªå®šç¾©', 'error');
                    updateDependencyCard('virtual-question-flow-card', 'missing', 'âŒ VirtualQuestionFlowãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
            } catch (error) {
                log('dependency-results', `VirtualQuestionFlow ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateDependencyCard('virtual-question-flow-card', 'missing', `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }

            log('dependency-results', '=== ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯å®Œäº† ===');
        }

        function testFindIndexFix() {
            log('findindex-results', '=== findIndexä¿®æ­£ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                if (typeof VirtualQuestionFlow === 'undefined') {
                    log('findindex-results', 'VirtualQuestionFlow ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                    return;
                }

                // Mockã®DOMã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                const mockContainer = document.createElement('div');
                mockContainer.id = 'test-container';
                document.body.appendChild(mockContainer);

                // VirtualQuestionFlowã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
                const questionFlow = new VirtualQuestionFlow('test-container');
                
                log('findindex-results', 'VirtualQuestionFlow ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ', 'success');

                // this.answersãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                if (Array.isArray(questionFlow.answers)) {
                    log('findindex-results', `this.answers ã¯é…åˆ—ã§ã™ (length: ${questionFlow.answers.length})`, 'success');
                } else {
                    log('findindex-results', `this.answers ãŒé…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“: ${typeof questionFlow.answers}`, 'error');
                }

                // å®‰å…¨ãªfindIndexãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ†ã‚¹ãƒˆ
                const testResult1 = questionFlow.findAnswerIndex('q1');
                log('findindex-results', `findAnswerIndex('q1'): ${testResult1} (æœŸå¾…å€¤: -1)`, testResult1 === -1 ? 'success' : 'warning');

                // å®‰å…¨ãªfindãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ†ã‚¹ãƒˆ
                const testResult2 = questionFlow.findAnswerByQuestionId('q1');
                log('findindex-results', `findAnswerByQuestionId('q1'): ${testResult2} (æœŸå¾…å€¤: null)`, testResult2 === null ? 'success' : 'warning');

                // getCompletedCountãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒ†ã‚¹ãƒˆ
                const completedCount = questionFlow.getCompletedCount();
                log('findindex-results', `getCompletedCount(): ${completedCount}`, 'success');

                // ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆï¼šthis.answersã‚’ä¸€æ™‚çš„ã«ç ´æã•ã›ã‚‹
                const originalAnswers = questionFlow.answers;
                questionFlow.answers = null;
                
                const safeResult1 = questionFlow.findAnswerIndex('q1');
                const safeResult2 = questionFlow.findAnswerByQuestionId('q1');
                const safeResult3 = questionFlow.getCompletedCount();

                log('findindex-results', `ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆ - findAnswerIndex: ${safeResult1}`, safeResult1 === -1 ? 'success' : 'error');
                log('findindex-results', `ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆ - findAnswerByQuestionId: ${safeResult2}`, safeResult2 === null ? 'success' : 'error');
                log('findindex-results', `ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆ - getCompletedCount: ${safeResult3}`, typeof safeResult3 === 'number' ? 'success' : 'error');

                // å¾©å…ƒ
                questionFlow.answers = originalAnswers;

                // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                document.body.removeChild(mockContainer);

                log('findindex-results', '=== findIndexä¿®æ­£ãƒ†ã‚¹ãƒˆå®Œäº† - å…¨ã¦æˆåŠŸï¼ ===', 'success');

            } catch (error) {
                log('findindex-results', `ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log('findindex-results', `ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`, 'error');
            }
        }

        async function testPerformanceSystems() {
            log('performance-results', '=== ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                // CacheManager ãƒ†ã‚¹ãƒˆ
                if (typeof CacheManager !== 'undefined') {
                    const cacheManager = new CacheManager();
                    await cacheManager.init();
                    
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ“ä½œãƒ†ã‚¹ãƒˆ
                    cacheManager.set('test_key', { data: 'test_value' });
                    const cached = cacheManager.get('test_key');
                    
                    if (cached && cached.data === 'test_value') {
                        log('performance-results', 'CacheManager åŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆ: æˆåŠŸ', 'success');
                    } else {
                        log('performance-results', 'CacheManager åŸºæœ¬å‹•ä½œãƒ†ã‚¹ãƒˆ: å¤±æ•—', 'error');
                    }

                    // çµ±è¨ˆå–å¾—ãƒ†ã‚¹ãƒˆ
                    const stats = cacheManager.getStats();
                    log('performance-results', `CacheManager çµ±è¨ˆ: ${JSON.stringify(stats)}`, 'success');
                } else {
                    log('performance-results', 'CacheManager ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                }

                // PerformanceOptimizer ãƒ†ã‚¹ãƒˆ
                if (typeof PerformanceOptimizer !== 'undefined') {
                    const optimizer = new PerformanceOptimizer();
                    await optimizer.init();
                    
                    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆå–å¾—ãƒ†ã‚¹ãƒˆ
                    const perfStats = optimizer.getStats();
                    log('performance-results', `PerformanceOptimizer çµ±è¨ˆ: åˆæœŸåŒ–å®Œäº†`, 'success');
                    
                    // æœ€é©åŒ–æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                    const testData = { hexagram: 1, originalTime: 100 };
                    const optimizationResult = await optimizer.optimizeHexagramCalculation(testData);
                    
                    if (optimizationResult && optimizationResult.success) {
                        log('performance-results', 'PerformanceOptimizer æœ€é©åŒ–ãƒ†ã‚¹ãƒˆ: æˆåŠŸ', 'success');
                    } else {
                        log('performance-results', 'PerformanceOptimizer æœ€é©åŒ–ãƒ†ã‚¹ãƒˆ: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œ', 'warning');
                    }
                } else {
                    log('performance-results', 'PerformanceOptimizer ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                }

                log('performance-results', '=== ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆå®Œäº† ===', 'success');

            } catch (error) {
                log('performance-results', `ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        async function runIntegrationTest() {
            log('integration-results', '=== çµ±åˆãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            try {
                // å…¨ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®çµ±åˆãƒ†ã‚¹ãƒˆ
                const mockContainer = document.createElement('div');
                mockContainer.id = 'integration-test-container';
                document.body.appendChild(mockContainer);

                // VirtualQuestionFlow with ä¾å­˜é–¢ä¿‚ ãƒ†ã‚¹ãƒˆ
                if (typeof VirtualQuestionFlow !== 'undefined') {
                    const questionFlow = new VirtualQuestionFlow('integration-test-container', {
                        onProgress: (progress) => {
                            log('integration-results', `ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°: ${progress}%`, 'success');
                        },
                        onComplete: (answers) => {
                            log('integration-results', `å®Œäº†ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯: ${answers.length} answers`, 'success');
                        }
                    });

                    // åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
                    questionFlow.init();
                    log('integration-results', 'VirtualQuestionFlow åˆæœŸåŒ–: æˆåŠŸ', 'success');

                    // CacheManagerãƒ»PerformanceOptimizerçµ±åˆç¢ºèª
                    if (questionFlow.cacheManager && typeof questionFlow.cacheManager.get === 'function') {
                        log('integration-results', 'CacheManager çµ±åˆ: æˆåŠŸ', 'success');
                    } else {
                        log('integration-results', 'CacheManager çµ±åˆ: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œ', 'warning');
                    }

                    if (questionFlow.performanceOptimizer && typeof questionFlow.performanceOptimizer.getMetrics === 'function') {
                        log('integration-results', 'PerformanceOptimizer çµ±åˆ: æˆåŠŸ', 'success');
                    } else {
                        log('integration-results', 'PerformanceOptimizer çµ±åˆ: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‹•ä½œ', 'warning');
                    }

                    // è¨­å•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
                    questionFlow.loadQuestions();
                    log('integration-results', `è¨­å•èª­ã¿è¾¼ã¿: ${questionFlow.questions.length} questions`, 'success');

                    // å›ç­”å‡¦ç†ãƒ†ã‚¹ãƒˆ
                    const testAnswer = {
                        questionId: 'q1',
                        value: 'A',
                        scoringTags: ['test'],
                        choiceType: null
                    };
                    
                    questionFlow.handleAnswerChange(testAnswer);
                    log('integration-results', 'å›ç­”å‡¦ç†ãƒ†ã‚¹ãƒˆ: æˆåŠŸ', 'success');

                    // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
                    questionFlow.cleanup();
                    document.body.removeChild(mockContainer);

                    log('integration-results', '=== çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº† - å…¨ã¦æˆåŠŸï¼ ===', 'success');
                } else {
                    log('integration-results', 'VirtualQuestionFlow ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“', 'error');
                }

            } catch (error) {
                log('integration-results', `çµ±åˆãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                log('integration-results', `ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹: ${error.stack}`, 'error');
            }
        }

        // å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å‹•çš„ã«èª­ã¿è¾¼ã¿
        async function loadRequiredScripts() {
            const scripts = [
                '/js/shared/core/BaseComponent.js',
                '/js/core/CacheManager.js',
                '/js/core/PerformanceOptimizer.js',
                '/js/os-analyzer/components/VirtualQuestionFlow.js'
            ];

            for (const src of scripts) {
                try {
                    await new Promise((resolve, reject) => {
                        const script = document.createElement('script');
                        script.src = src;
                        script.onload = resolve;
                        script.onerror = reject;
                        document.head.appendChild(script);
                    });
                    console.log(`âœ… Loaded: ${src}`);
                } catch (error) {
                    console.error(`âŒ Failed to load: ${src}`, error);
                }
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿
        window.addEventListener('load', loadRequiredScripts);
    </script>
</body>
</html>