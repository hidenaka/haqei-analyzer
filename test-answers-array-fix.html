<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VirtualQuestionFlow Answers Array Fix Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button.danger {
            background: #dc3545;
        }
        button.danger:hover {
            background: #c82333;
        }
        #console-output {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
        }
        .data-display {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>üîß VirtualQuestionFlow Answers Array Fix Test</h1>
        <p>This test verifies that the this.answers.findIndex error has been fixed.</p>
        
        <div id="test-results"></div>
        
        <div style="margin: 20px 0;">
            <h3>Test Actions:</h3>
            <button onclick="checkCurrentState()">Check Current State</button>
            <button onclick="simulateCorruptedData()" class="danger">Simulate Corrupted Data</button>
            <button onclick="testFindIndex()">Test findIndex Method</button>
            <button onclick="clearLocalStorage()" class="danger">Clear localStorage</button>
            <button onclick="createValidTestData()">Create Valid Test Data</button>
        </div>
        
        <div id="localStorage-display" class="data-display"></div>
        
        <div id="console-output"></div>
    </div>

    <!-- Load the same core dependencies -->
    <script src="/js/shared/core/BaseComponent.js"></script>
    <script src="/js/shared/core/MicroStorageManager.js"></script>
    <script src="/js/shared/core/BridgeStorageManager.js"></script>
    <script src="/js/shared/core/SimpleStorageManager.js"></script>
    <script src="/js/shared/core/MicroDataManager.js"></script>
    <script src="/js/shared/data/questions.js"></script>
    <script src="/js/os-analyzer/core/PrecompiledQuestions.js"></script>
    
    <!-- Performance dependencies (with stubs if needed) -->
    <script>
        // Emergency stubs if files don't exist
        if (typeof CacheManager === 'undefined') {
            window.CacheManager = class CacheManager {
                constructor(options = {}) {
                    this.cache = new Map();
                    console.warn('‚ö†Ô∏è Using CacheManager stub');
                }
                get(key) { return this.cache.get(key) || null; }
                set(key, value) { this.cache.set(key, value); }
                has(key) { return this.cache.has(key); }
                clear() { this.cache.clear(); }
                init() { return Promise.resolve(); }
            };
        }
        
        if (typeof PerformanceOptimizer === 'undefined') {
            window.PerformanceOptimizer = class PerformanceOptimizer {
                constructor(options = {}) {
                    console.warn('‚ö†Ô∏è Using PerformanceOptimizer stub');
                }
                optimize() {}
                monitor() {}
                getMetrics() { return {}; }
            };
        }
    </script>
    
    <!-- VirtualQuestionFlow component -->
    <script src="/js/os-analyzer/components/HaqeiQuestionElement.js"></script>
    <script src="/js/os-analyzer/components/VirtualQuestionFlow.js"></script>
    <script src="/js/os-analyzer/components/VirtualQuestionFlow-findIndex-fix.js"></script>

    <script>
        let consoleOutput = '';
        let questionFlow = null;
        
        // Capture console output
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function logToDisplay(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput += `[${timestamp}] ${level.toUpperCase()}: ${message}\n`;
            updateConsoleDisplay();
        }
        
        console.log = (...args) => {
            originalLog(...args);
            logToDisplay('log', ...args);
        };
        
        console.error = (...args) => {
            originalError(...args);
            logToDisplay('error', ...args);
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            logToDisplay('warn', ...args);
        };
        
        function updateConsoleDisplay() {
            const consoleDiv = document.getElementById('console-output');
            consoleDiv.textContent = consoleOutput;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function updateLocalStorageDisplay() {
            const display = document.getElementById('localStorage-display');
            const data = localStorage.getItem('haqei_answers');
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    display.textContent = 'localStorage haqei_answers:\n' + JSON.stringify(parsed, null, 2);
                } catch (e) {
                    display.textContent = 'localStorage haqei_answers (raw):\n' + data;
                }
            } else {
                display.textContent = 'localStorage haqei_answers: (empty)';
            }
        }
        
        function addResult(type, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.textContent = message;
            resultsDiv.appendChild(resultDiv);
        }
        
        function checkCurrentState() {
            console.log('üîç Checking current state...');
            updateLocalStorageDisplay();
            
            // Check localStorage
            const savedData = localStorage.getItem('haqei_answers');
            if (savedData) {
                try {
                    const parsed = JSON.parse(savedData);
                    addResult('info', `localStorage contains: ${Array.isArray(parsed) ? 'Array' : typeof parsed} with ${parsed.length || 'N/A'} items`);
                } catch (e) {
                    addResult('error', 'localStorage data is corrupted: ' + e.message);
                }
            } else {
                addResult('info', 'localStorage is empty');
            }
            
            // Check VirtualQuestionFlow instance
            if (questionFlow) {
                addResult('info', `questionFlow.answers is: ${Array.isArray(questionFlow.answers) ? 'Array' : typeof questionFlow.answers} with ${questionFlow.answers?.length || 'N/A'} items`);
            } else {
                addResult('warning', 'No VirtualQuestionFlow instance exists yet');
            }
        }
        
        function simulateCorruptedData() {
            console.log('üí• Simulating corrupted localStorage data...');
            
            // Test various corrupted data scenarios
            const corruptedData = [
                { scenario: 'String instead of array', data: '"not an array"' },
                { scenario: 'Object instead of array', data: '{"key": "value"}' },
                { scenario: 'Number instead of array', data: '42' },
                { scenario: 'Null', data: 'null' },
                { scenario: 'Invalid JSON', data: '{invalid json' }
            ];
            
            const randomCorruption = corruptedData[Math.floor(Math.random() * corruptedData.length)];
            
            localStorage.setItem('haqei_answers', randomCorruption.data);
            addResult('warning', `Set corrupted data: ${randomCorruption.scenario}`);
            updateLocalStorageDisplay();
            
            // Now try to create a VirtualQuestionFlow instance
            testVirtualQuestionFlow();
        }
        
        function testFindIndex() {
            console.log('üß™ Testing findIndex method...');
            
            if (!questionFlow) {
                // Create instance if it doesn't exist
                testVirtualQuestionFlow();
            }
            
            if (questionFlow) {
                try {
                    // Test findAnswerIndex
                    const index = questionFlow.findAnswerIndex('q1');
                    addResult('success', `‚úÖ findAnswerIndex worked! Result: ${index}`);
                    
                    // Test findAnswerByQuestionId
                    const answer = questionFlow.findAnswerByQuestionId('q1');
                    addResult('success', `‚úÖ findAnswerByQuestionId worked! Result: ${answer ? 'Found' : 'Not found'}`);
                    
                    // Test handleAnswerChange
                    questionFlow.handleAnswerChange({
                        questionId: 'q1',
                        value: 'A',
                        scoringTags: ['test'],
                        choiceType: 'single'
                    });
                    addResult('success', '‚úÖ handleAnswerChange worked!');
                    
                } catch (error) {
                    addResult('error', `‚ùå Error during testing: ${error.message}`);
                    console.error('Test error:', error);
                }
            } else {
                addResult('error', '‚ùå Could not create VirtualQuestionFlow instance');
            }
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('haqei_answers');
            addResult('info', 'üóëÔ∏è Cleared localStorage');
            updateLocalStorageDisplay();
        }
        
        function createValidTestData() {
            const validData = [
                {
                    questionId: 'q1',
                    selectedValue: 'A',
                    selectedChoice: 'q1a',
                    choiceText: 'Test answer A',
                    timestamp: new Date().toISOString()
                },
                {
                    questionId: 'q2',
                    selectedValue: 'B',
                    selectedChoice: 'q2b',
                    choiceText: 'Test answer B',
                    timestamp: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('haqei_answers', JSON.stringify(validData));
            addResult('success', '‚úÖ Created valid test data in localStorage');
            updateLocalStorageDisplay();
        }
        
        function testVirtualQuestionFlow() {
            try {
                console.log('üöÄ Creating VirtualQuestionFlow instance...');
                
                // Create container
                const container = document.createElement('div');
                container.id = 'test-question-container';
                document.body.appendChild(container);
                
                // Create instance
                questionFlow = new VirtualQuestionFlow({
                    container: container,
                    questions: window.questions || [],
                    onComplete: (answers) => {
                        console.log('‚úÖ onComplete called with:', answers);
                    }
                });
                
                questionFlow.init();
                addResult('success', '‚úÖ VirtualQuestionFlow instance created successfully');
                
                // Check answers array
                if (Array.isArray(questionFlow.answers)) {
                    addResult('success', `‚úÖ questionFlow.answers is an array with ${questionFlow.answers.length} items`);
                } else {
                    addResult('error', `‚ùå questionFlow.answers is not an array: ${typeof questionFlow.answers}`);
                }
                
            } catch (error) {
                addResult('error', `‚ùå Failed to create VirtualQuestionFlow: ${error.message}`);
                console.error('Creation error:', error);
            }
        }
        
        // Initialize on load
        window.addEventListener('load', () => {
            console.log('üîß VirtualQuestionFlow Answers Array Fix Test Started');
            updateLocalStorageDisplay();
            checkCurrentState();
        });
    </script>
</body>
</html>