import { readFile, writeFile } from 'fs/promises';

async function applyFinalFixes() {
  try {
    let content = await readFile('./public/js/data/hexagram-human-traits-v3.js', 'utf-8');
    
    // å…¨ã¦ã®æ®‹å­˜ã™ã‚‹ä¸é©åˆ‡è¡¨ç¾ã‚’ä¸€æ‹¬ä¿®æ­£
    const finalCorrections = {
      // æˆ¦ã†ãƒ»æˆ¦ã„é–¢é€£
      '"ä¸æ­£ã‚„çŸ›ç›¾ã¨æˆ¦ã†å¿…è¦ãŒã‚ã‚‹æ™‚"': '"ä¸æ­£ã‚„çŸ›ç›¾ã«ç«‹ã¡å‘ã‹ã†å¿…è¦ãŒã‚ã‚‹æ™‚"',
      '"å…¨åŠ›ã§æˆ¦ã†"': '"å…¨åŠ›ã§å¯¾å‡¦ã™ã‚‹"',
      '"æœ€å¾Œã¾ã§æˆ¦ã„æŠœã"': '"æœ€å¾Œã¾ã§é ‘å¼µã‚ŠæŠœã"',
      '"å…¨åŠ›ã§å›°é›£ã¨æˆ¦ã†"': '"å…¨åŠ›ã§å›°é›£ã«ç«‹ã¡å‘ã‹ã†"',
      '"å…±ã«æˆ¦ã†ä»²é–“"': '"å…±ã«é ‘å¼µã‚‹ä»²é–“"',
      
      // ç ´å£Šé–¢é€£
      '"ç ´å£Šå†ç”Ÿå‹"': '"å¤‰é©å†ç”Ÿå‹"',
      '"æ™‚ã«ç ´å£Šçš„ã™ãã‚‹"': '"æ™‚ã«å¤‰åŒ–ãŒæ€¥æ¿€ã™ãã‚‹"',
      '"æ—¢å­˜ã®æ çµ„ã¿ã‚’å£Šã™"': '"æ—¢å­˜ã®æ çµ„ã¿ã‚’å¤‰é©ã™ã‚‹"',
      '"ç ´å£Šçš„ã«ãªã‚‹"': '"æ¿€ã—ããªã‚Šã™ãã‚‹"',
      '"ç ´å£Šã ã‘ã«ãªã‚‰ãªã„"': '"å¤‰é©ã ã‘ã«ãªã‚‰ãªã„"',
      '"å‰µé€ çš„ãªç ´å£Šã‚’"': '"å‰µé€ çš„ãªå¤‰é©ã‚’"',
      
      // è¡çªé–¢é€£
      '"è¬™è™šã•ã§è¡çªã‚’é¿ã‘ã‚‹"': '"è¬™è™šã•ã§å¯¾ç«‹ã‚’é¿ã‘ã‚‹"',
      '"è¡çªã‚’é¿ã‘ã‚‹æŸ”è»Ÿæ€§"': '"å¯¾ç«‹ã‚’é¿ã‘ã‚‹æŸ”è»Ÿæ€§"',
      
      // æ­»é–¢é€£
      '"ä¸æ­»é³¥ã®ã‚ˆã†ãªå†ç”ŸåŠ›"': '"ãƒ•ã‚§ãƒ‹ãƒƒã‚¯ã‚¹ã®ã‚ˆã†ãªå†ç”ŸåŠ›"',
      '"ğŸ”‹ğŸ”‹ğŸ”‹ğŸ”‹ğŸ”‹ (95%) - ä¸æ­»é³¥ãƒ¢ãƒ¼ãƒ‰"': '"ğŸ”‹ğŸ”‹ğŸ”‹ğŸ”‹ğŸ”‹ (95%) - å†ç”Ÿãƒ¢ãƒ¼ãƒ‰"',
      
      // çˆ†ç™ºé–¢é€£
      '"æ¿€æƒ…çˆ†ç™ºå‹"': '"æ„Ÿæƒ…è¡¨å‡ºå‹"',
      '"æ¬¡ã®çˆ†ç™ºã«å‚™ãˆã‚‹"': '"æ¬¡ã®å¤§ããªæ´»å‹•ã«å‚™ãˆã‚‹"',
      
      // æ­¦å™¨é–¢é€£
      '"å®Ÿç¸¾ã¨ã„ã†æ­¦å™¨"': '"å®Ÿç¸¾ã¨ã„ã†å¼·ã¿"',
      
      // æ–¬é–¢é€£
      '"æ–¬ã‚Œå‘³é‹­ã„åˆ€"': '"æ˜ç¢ºãªåˆ¤æ–­åŠ›"',
      
      // æ•µé–¢é€£ï¼ˆç´ æ•µã®èª¤æ¤œå‡ºã‚’é¿ã‘ã‚‹ï¼‰
      '"ç´ æ•µãªå‡ºä¼šã„"': '"ç´ æ•µãªå‡ºä¼šã„"', // ã“ã‚Œã¯å•é¡Œãªã—ã€ãã®ã¾ã¾
      
      // ã¶ã¤ã‹ã‚‹é–¢é€£
      '"å£ã«æ­£é¢ã‹ã‚‰ã¶ã¤ã‹ã‚‹"': '"å›°é›£ã«æ­£é¢ã‹ã‚‰å‘ãåˆã†"',
      
      // ãã®ä»–ã®æ”»æ’ƒçš„è¡¨ç¾
      'æ”»æ’ƒ': 'æ‰¹åˆ¤',
      'åæ’ƒ': 'å¯¾å¿œ',
      'æ•µ': 'å›°é›£',
      'é›·æ’ƒ': 'å¼·ã„åå¿œ',
      'é›»æ’ƒ': 'ç¬ç™ºçš„',
      'æ„Ÿé›»': 'å¼·ã„åå¿œ',
      'æ”¾é›»': 'ã‚¨ãƒãƒ«ã‚®ãƒ¼æ”¾å‡º',
      'æš´ç™º': 'è¡å‹•çš„ãªè¡Œå‹•',
      'ç‡ƒã‚„ã—å°½ãã™': 'æƒ…ç†±ã‚’å‡ºã—åˆ‡ã‚‹',
      'ç„¼ãå°½ãã™': 'æƒ…ç†±ã‚’æ³¨ã',
      'æ®ºã™': 'æ­¢ã‚ã‚‹',
      'æ­»ã¬': 'çµ‚ã‚ã‚‹',
      'æš´åŠ›': 'å¼·ã„åŠ›',
      'å¼¾': 'åŠ›',
      'ç ²': 'å¤§ããªåŠ›',
      'åˆƒ': 'é‹­ã•',
      'åˆ‡ã‚Šè£‚ã': 'åˆ†ã‘ã‚‹',
      'å£Šã‚Œã‚‹': 'å¤‰ã‚ã‚‹',
      'æ½°ã‚Œã‚‹': 'å¤‰å½¢ã™ã‚‹',
      'å©ã': 'è§¦ã‚Œã‚‹',
      'æ®´ã‚‹': 'å¼·ãè§¦ã‚Œã‚‹',
      'è¹´ã‚‹': 'æŠ¼ã™',
      'æ’ƒã¤': 'æ”¾ã¤',
      'å°„ã‚‹': 'å‘ã‘ã‚‹',
      'æ¿€çª': 'æ¥è§¦',
      'ã¶ã¤ã‘ã‚‹': 'å‘ã‘ã‚‹',
      'æ¿€ã—ãå½“ãŸã‚‹': 'å¼·ãæ¥ã™ã‚‹'
    };
    
    // ä¿®æ­£ã‚’é©ç”¨
    Object.entries(finalCorrections).forEach(([old, newText]) => {
      // å®Œå…¨ä¸€è‡´ã§ç½®æ›
      content = content.replace(new RegExp(old, 'g'), newText);
    });
    
    // è¿½åŠ ã®ä¸€èˆ¬çš„ãªç½®æ›
    content = content
      .replace(/æˆ¦[ã†ã„]/g, 'é ‘å¼µã‚‹')
      .replace(/ç ´å£Š/g, 'å¤‰é©')
      .replace(/è¡çª/g, 'å¯¾ç«‹')
      .replace(/ä¸æ­»/g, 'å†ç”Ÿ')
      .replace(/çˆ†ç™º/g, 'å¤§ããªæ´»å‹•')
      .replace(/æ­¦å™¨/g, 'å¼·ã¿')
      .replace(/æ–¬ã‚‹/g, 'åˆ†ã‘ã‚‹')
      .replace(/æ–¬ã‚Š/g, 'åˆ†ã‘')
      .replace(/ã¶ã¤ã‹/g, 'å‘ãåˆ')
      .replace(/çˆ†/g, 'å¤§ããª');
    
    // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ä»˜ããƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    await writeFile(`./public/js/data/hexagram-human-traits-v3.backup.final.${timestamp}.js`, 
                   await readFile('./public/js/data/hexagram-human-traits-v3.js', 'utf-8'));
    
    // ä¿®æ­£ç‰ˆã‚’ä¿å­˜
    await writeFile('./public/js/data/hexagram-human-traits-v3.js', content);
    
    console.log('âœ… æœ€çµ‚ä¿®æ­£ã‚’é©ç”¨ã—ã¾ã—ãŸ');
    console.log(`ğŸ“ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: hexagram-human-traits-v3.backup.final.${timestamp}.js`);
    
    // å†ãƒã‚§ãƒƒã‚¯
    const window = {};
    eval(content);
    const v3Data = window.HexagramHumanTraitsV3;
    
    // å³æ ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å†ãƒã‚§ãƒƒã‚¯
    const severePatterns = [
      /æ”»æ’ƒ/g, /åæ’ƒ/g, /æ•µ(?!.*ç´ æ•µ)/g, /é›·æ’ƒ/g, /é›»æ’ƒ/g, /æ„Ÿé›»/g,
      /çˆ†ç™º/g, /ç ´å£Š/g, /ç‡ƒã‚„ã—å°½ãã™/g, /ç„¼ãå°½ãã™/g,
      /æ®º/g, /æ­»(?!.*ä¸æ­»é³¥)/g, /æš´åŠ›/g, /æš´ç™º/g, /æ”¾é›»/g,
      /æˆ¦[ã†ã„]/g, /æ­¦å™¨/g, /å¼¾/g, /ç ²/g, /åˆƒ/g, /æ–¬/g,
      /åˆ‡ã‚Šè£‚ã/g, /å£Šã™/g, /æ½°ã™/g, /å©ã/g, /æ®´/g, /è¹´/g,
      /æ’ƒ[ã¤ã¡]/g, /å°„/g, /çˆ†(?!.*æƒ…)/g, /æ¿€çª/g, /è¡çª/g,
      /ã¶ã¤ã‹/g, /ã¶ã¤ã‘/g, /æ¿€ã—ãå½“ãŸã‚‹/g
    ];
    
    let remainingProblems = 0;
    Object.entries(v3Data).forEach(([hexName, hex]) => {
      const checkText = (text) => {
        if (!text || typeof text !== 'string') return;
        severePatterns.forEach(pattern => {
          if (pattern.test(text)) {
            remainingProblems++;
            console.log(`âš ï¸ æ®‹å­˜: ${hexName} - "${text}"`);
          }
        });
      };
      
      const checkObject = (obj) => {
        if (!obj) return;
        Object.values(obj).forEach(value => {
          if (typeof value === 'string') checkText(value);
          else if (typeof value === 'object') checkObject(value);
        });
      };
      
      checkObject(hex);
    });
    
    if (remainingProblems === 0) {
      console.log('\nâœ… å…¨ã¦ã®ä¸é©åˆ‡è¡¨ç¾ã‚’ä¿®æ­£å®Œäº†ã—ã¾ã—ãŸï¼');
    } else {
      console.log(`\nâš ï¸ ã¾ã  ${remainingProblems} ä»¶ã®å•é¡ŒãŒæ®‹ã£ã¦ã„ã¾ã™`);
    }
    
  } catch (error) {
    console.error('ã‚¨ãƒ©ãƒ¼:', error);
  }
}

applyFinalFixes();