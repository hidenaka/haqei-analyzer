# OSアナライザー エラー修正手順書

**作成日**: 2025年8月18日  
**対象**: TRAE AI実装担当  
**優先度**: 🔴 最優先

## 🐛 発見された問題

### 問題1: TypeError - Cannot read properties of undefined
```
TypeError: Cannot read properties of undefined (reading 'text')
    at QuestionManager.displayQuestion (QuestionManager.js:188:50)
```

### 問題2: 回答済みでも「質問を回答してください」ポップアップ
- 質問に回答しているのにアラートが表示される
- 次へボタンのイベントリスナーが重複登録されている

## 📌 根本原因

### 1. 引数の型不一致
- `CriticalCSSAnalyzer.showQuestion()`が**オブジェクト**を渡している
- `QuestionManager.displayQuestion()`は**数値インデックス**を期待

### 2. イベントリスナーの重複
- 複数のJSファイルで同じボタンにイベントリスナーを登録
- app.js と os-analyzer-main.js の両方で処理が実行される

## 🔧 修正手順

### ステップ1: os-analyzer-main.js の修正

#### 1-1. showQuestion関数の修正（4211行目付近）

**現在のコード（問題あり）**:
```javascript
showQuestion(index) {
    // QuestionManagerに処理を委譲 
    if (window.QuestionManager && typeof window.QuestionManager.displayQuestion === 'function') {
        console.log(`🔄 Delegating to QuestionManager.displayQuestion for Q${index + 1}`);
        window.QuestionManager.displayQuestion(this.state.questions[index]); // ❌ オブジェクトを渡している
        return;
    }
}
```

**修正後のコード**:
```javascript
showQuestion(index) {
    // QuestionManagerに処理を委譲 - インデックスを渡す
    if (window.QuestionManager && typeof window.QuestionManager.displayQuestion === 'function') {
        console.log(`🔄 Delegating to QuestionManager.displayQuestion for Q${index + 1}`);
        window.QuestionManager.displayQuestion(index); // ✅ インデックスを渡す
        return;
    }
}
```

### ステップ2: QuestionManager.js の修正

#### 2-1. displayQuestion関数の防御的コーディング（162行目付近）

**現在のコード**:
```javascript
displayQuestion(index) {
    console.log(`📋 Displaying question ${index + 1}/${this.questions.length}`);
    
    // インデックス範囲チェック
    if (index < 0 || index >= this.questions.length) {
        console.error('Invalid question index:', index);
        return;
    }
    
    const question = this.questions[index];
```

**修正後のコード**:
```javascript
displayQuestion(index) {
    // 引数の型チェックと変換
    let questionIndex = index;
    
    // オブジェクトが渡された場合の対処
    if (typeof index === 'object' && index !== null) {
        console.warn('⚠️ Object passed to displayQuestion, attempting to extract index');
        
        // オブジェクトからインデックスを取得する試み
        if (typeof index.index === 'number') {
            questionIndex = index.index;
        } else if (typeof index.id === 'string' && index.id.startsWith('q')) {
            // 'q1', 'q2' のような形式からインデックスを抽出
            questionIndex = parseInt(index.id.substring(1)) - 1;
        } else {
            console.error('❌ Cannot extract index from object:', index);
            return;
        }
    }
    
    // 数値型確認
    if (typeof questionIndex !== 'number') {
        console.error('❌ Invalid index type:', typeof questionIndex, questionIndex);
        return;
    }
    
    console.log(`📋 Displaying question ${questionIndex + 1}/${this.questions.length}`);
    
    // インデックス範囲チェック
    if (questionIndex < 0 || questionIndex >= this.questions.length) {
        console.error('Invalid question index:', questionIndex);
        return;
    }
    
    const question = this.questions[questionIndex];
    this.currentQuestionIndex = questionIndex;
```

### ステップ3: app.js の重複イベントリスナー削除

#### 3-1. handleNextButtonClick の重複チェック（612行目付近）

**修正箇所**:
```javascript
// Next button handler
if (nextBtn) {
    // 既存のリスナーがあるかチェック
    if (!nextBtn.hasAttribute('data-questionnaire-handler')) {
        nextBtn.setAttribute('data-questionnaire-handler', 'true');
        
        nextBtn.addEventListener('click', () => {
            // QuestionManagerを優先使用
            if (window.QuestionManager && window.QuestionManager.handleNextButtonClick) {
                window.QuestionManager.handleNextButtonClick();
            } else {
                // フォールバック処理
                if (questionIndex + 1 < window.QUESTIONS.length) {
                    displayQuestion(questionIndex + 1);
                } else {
                    startAnalysis();
                }
            }
        });
    }
}
```

### ステップ4: 回答チェックの修正

#### 4-1. handleNextButtonClick の修正（QuestionManager.js 298行目付近）

**現在のコード**:
```javascript
handleNextButtonClick() {
    // 現在の回答を確認
    const selectedOption = document.querySelector('input[name="question"]:checked');
    
    if (!selectedOption) {
        alert('この質問に回答してから次に進んでください。');
        return;
    }
```

**修正後のコード**:
```javascript
handleNextButtonClick() {
    // 現在の回答を確認（複数の方法でチェック）
    const selectedOption = document.querySelector('input[name="question"]:checked') ||
                          document.querySelector(`input[name="q${this.currentQuestionIndex}"]:checked`) ||
                          document.querySelector('.option-label.selected input[type="radio"]');
    
    // すでに保存された回答があるかもチェック
    const savedAnswer = this.answers[`q${this.currentQuestionIndex + 1}`];
    
    if (!selectedOption && !savedAnswer) {
        alert('この質問に回答してから次に進んでください。');
        return;
    }
```

## ✅ 動作確認手順

### 1. サーバー起動
```bash
npx wrangler dev --assets=public
```

### 2. ブラウザテスト
1. http://localhost:8788/os_analyzer.html にアクセス
2. 「分析を開始」をクリック
3. **コンソールにTypeErrorが出ないことを確認**
4. Q1で選択肢を選択
5. 「次へ」をクリック
6. **アラートが表示されずにQ2に進むことを確認**
7. Q2でも選択肢が選択できることを確認

### 3. コンソール確認
正常な場合のログ:
```
📋 Displaying question 1/36
📋 Question 1 displayed with 5 options
💾 Answer saved for q1: 2
📋 Moving to question 2/36
📋 Displaying question 2/36  // エラーなし
```

## 🚨 重要な注意事項

### やってはいけないこと
1. ❌ QuestionManager.displayQuestion() の引数の型を変更しない（数値インデックスを維持）
2. ❌ イベントリスナーを完全に削除しない（条件付き登録に変更）
3. ❌ 質問データの構造を変更しない

### 必ず確認すること
1. ✅ TypeError が発生しないこと
2. ✅ 回答済みでアラートが出ないこと
3. ✅ すべての質問でナビゲーションが正常動作すること
4. ✅ 最後の質問（Q36）まで到達できること

## 📝 テストケース

| ケース | 期待結果 | 確認方法 |
|--------|---------|----------|
| 初回起動 | エラーなし | コンソールでTypeError確認 |
| Q1→Q2遷移 | アラートなし | 回答後「次へ」クリック |
| Q2表示 | ラジオボタン表示 | DOM要素確認 |
| Q36到達 | 分析開始 | 最後まで進める |
| 前へボタン | 選択保持 | 戻って確認 |

## 🔍 デバッグヒント

エラーが続く場合：

1. **引数の型を確認**
   ```javascript
   // displayQuestion内で追加
   console.log('Received argument type:', typeof index, index);
   ```

2. **イベントリスナーの登録状況確認**
   ```javascript
   // コンソールで実行
   getEventListeners(document.getElementById('next-btn'))
   ```

3. **保存された回答の確認**
   ```javascript
   console.log('Saved answers:', window.QuestionManager.answers);
   ```

## 💡 5WHY分析

1. **Why**: なぜTypeErrorが発生？
   → displayQuestionに質問オブジェクトが渡されている

2. **Why**: なぜオブジェクトが渡される？
   → CriticalCSSAnalyzerがthis.state.questions[index]を渡している

3. **Why**: なぜ配列要素を渡す？
   → 質問データ自体が必要と誤解

4. **Why**: なぜ誤解が生じた？
   → 関数のインターフェース仕様が不明確

5. **Why**: なぜ仕様が不明確？
   → JSDocコメントやTypeScriptの型定義がない

**対策**: 
- 短期: 引数の型チェックと変換を追加
- 長期: JSDocコメントで関数の仕様を明確化

---

**実装完了後、このドキュメントを`.serena/memories/`に保存してください**