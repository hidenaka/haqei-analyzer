<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çµ±è¨ˆã‚·ã‚¹ãƒ†ãƒ æ ¹æœ¬æ”¹é© ãƒ†ã‚¹ãƒˆ - HaQei Analyzer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            border-left: 4px solid #10B981;
        }
        .test-result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
        }
        .test-pass {
            background: rgba(16, 185, 129, 0.2);
            border-left: 4px solid #10B981;
        }
        .test-fail {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #EF4444;
        }
        .test-warning {
            background: rgba(245, 158, 11, 0.2);
            border-left: 4px solid #F59E0B;
        }
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10B981, #059669);
            transition: width 0.3s ease;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        .before, .after {
            padding: 15px;
            border-radius: 8px;
        }
        .before {
            background: rgba(239, 68, 68, 0.2);
            border-left: 4px solid #EF4444;
        }
        .after {
            background: rgba(16, 185, 129, 0.2);
            border-left: 4px solid #10B981;
        }
        .transparency-section {
            background: rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .quality-indicator {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            margin: 5px;
        }
        .grade-a { background: #10B981; }
        .grade-b { background: #059669; }
        .grade-c { background: #F59E0B; }
        .grade-d { background: #F97316; }
        .grade-f { background: #EF4444; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ”¬ Phase 5.1: çµ±è¨ˆã‚·ã‚¹ãƒ†ãƒ æ ¹æœ¬æ”¹é© æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆæ¦‚è¦</h2>
            <p>3äººã®å°‚é–€å®¶ã‹ã‚‰æŒ‡æ‘˜ã•ã‚ŒãŸçµ±è¨ˆçš„ä¿¡é ¼æ€§ã®å•é¡Œã‚’è§£æ±ºã—ãŸæ–°ã‚·ã‚¹ãƒ†ãƒ ã®æ¤œè¨¼</p>
            <div class="progress-bar">
                <div class="progress-fill" id="overall-progress" style="width: 0%"></div>
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ§® çµ±è¨ˆçš„å¦¥å½“æ€§ãƒ†ã‚¹ãƒˆ</h2>
            <div id="statistical-validation-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ”¬ æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒ†ã‚¹ãƒˆ</h2>
            <div id="formatting-test-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ˆ è¨ˆç®—é€æ˜æ€§ãƒ†ã‚¹ãƒˆ</h2>
            <div id="transparency-test-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ ç•°å¸¸å€¤ä¿®æ­£ãƒ†ã‚¹ãƒˆ</h2>
            <div id="outlier-correction-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š Before/After æ¯”è¼ƒ</h2>
            <div id="before-after-comparison"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ† ç·åˆè©•ä¾¡</h2>
            <div id="overall-assessment"></div>
        </div>
    </div>

    <!-- æ–°ã—ã„çµ±è¨ˆã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿ -->
    <script src="public/js/os-analyzer/core/StatisticalEngine.js"></script>
    <script src="public/js/os-analyzer/utils/ScientificFormatter.js"></script>
    <script src="public/js/os-analyzer/core/Calculator.js"></script>

    <script>
        class StatisticalReformTester {
            constructor() {
                this.tests = [];
                this.passedTests = 0;
                this.totalTests = 0;
                this.statisticalEngine = new StatisticalEngine();
                this.formatter = new ScientificFormatter();
                this.calculator = new Calculator();
            }

            async runAllTests() {
                console.log("ğŸ”¬ Starting Phase 5.1 Statistical Reform Tests");
                
                this.updateProgress(0);
                
                await this.testStatisticalValidation();
                await this.testNumberFormatting();
                await this.testCalculationTransparency();
                await this.testOutlierCorrection();
                await this.generateBeforeAfterComparison();
                await this.generateOverallAssessment();

                this.updateProgress(100);
                console.log(`âœ… Tests completed: ${this.passedTests}/${this.totalTests} passed`);
            }

            async testStatisticalValidation() {
                const resultsDiv = document.getElementById('statistical-validation-results');
                let html = '<h3>çµ±è¨ˆçš„å¦¥å½“æ€§æ¤œè¨¼</h3>';

                // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼šç•°å¸¸å€¤ã®æ¤œå‡ºã¨ä¿®æ­£
                const testCases = [
                    { value: 0.99, type: 'general', expected: 'corrected', description: '99%ã®ç•°å¸¸å€¤' },
                    { value: 0.0088, type: 'general', expected: 'corrected', description: '0.88%ã®ç•°å¸¸å€¤' },
                    { value: 0.75, type: 'general', expected: 'valid', description: '75%ã®æ­£å¸¸å€¤' },
                    { value: NaN, type: 'general', expected: 'corrected', description: 'NaNå€¤' },
                    { value: null, type: 'general', expected: 'corrected', description: 'nullå€¤' },
                    { value: 0.5, type: 'engine', expected: 'valid', description: 'Engine OSç”¨50%' }
                ];

                for (const testCase of testCases) {
                    const validation = this.statisticalEngine.validateScore(testCase.value, testCase.type);
                    const passed = testCase.expected === 'corrected' ? !validation.isValid : validation.isValid;
                    
                    this.addTestResult(passed);
                    html += this.formatTestResult(
                        passed,
                        testCase.description,
                        `Original: ${testCase.value}, Corrected: ${validation.correctedScore}, Valid: ${validation.isValid}`
                    );
                }

                resultsDiv.innerHTML = html;
                this.updateProgress(20);
            }

            async testNumberFormatting() {
                const resultsDiv = document.getElementById('formatting-test-results');
                let html = '<h3>æ•°å€¤ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œè¨¼</h3>';

                // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ï¼šç§‘å­¦çš„è¡¨è¨˜
                const testCases = [
                    { value: 0.885734523, expected: '88.6%', description: 'å°æ•°ç‚¹ä»¥ä¸‹1æ¡ã¸ã®çµ±ä¸€' },
                    { value: 0.99, expected: '80.0%', description: 'ç•°å¸¸å€¤ã®è‡ªå‹•ä¿®æ­£' },
                    { value: 0.5, expected: '50.0%', description: 'ä¸­å¤®å€¤ã®è¡¨è¨˜' },
                    { value: NaN, expected: '0.0%', description: 'NaNå€¤ã®å‡¦ç†' }
                ];

                for (const testCase of testCases) {
                    // çµ±è¨ˆçš„å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯ä»˜ããƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    const validation = this.statisticalEngine.validateScore(testCase.value, 'general');
                    const formatted = this.formatter.formatPercentage(validation.correctedScore);
                    
                    // ç²¾åº¦ãƒã‚§ãƒƒã‚¯ï¼ˆå°æ•°ç‚¹ä»¥ä¸‹1æ¡ï¼‰
                    const decimalPlaces = (formatted.match(/\.(\d+)/) || ['', ''])[1].length;
                    const correctFormat = decimalPlaces <= 1;
                    
                    this.addTestResult(correctFormat);
                    html += this.formatTestResult(
                        correctFormat,
                        testCase.description,
                        `Input: ${testCase.value} â†’ ${formatted} (ç²¾åº¦: ${decimalPlaces}æ¡)`
                    );
                }

                resultsDiv.innerHTML = html;
                this.updateProgress(40);
            }

            async testCalculationTransparency() {
                const resultsDiv = document.getElementById('transparency-test-results');
                let html = '<h3>è¨ˆç®—é€æ˜æ€§æ¤œè¨¼</h3>';

                // æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ã§ã®è¨ˆç®—é€æ˜æ€§ãƒ†ã‚¹ãƒˆ
                const userVector = {
                    "ä¹¾_å‰µé€ æ€§": 0.7,
                    "éœ‡_è¡Œå‹•æ€§": 0.6,
                    "å_æ¢æ±‚æ€§": 0.8,
                    "è‰®_å®‰å®šæ€§": 0.5,
                    "å¤_å—å®¹æ€§": 0.4,
                    "å·½_é©å¿œæ€§": 0.6,
                    "é›¢_è¡¨ç¾æ€§": 0.7,
                    "å…Œ_èª¿å’Œæ€§": 0.5
                };

                const osVector = {
                    "ä¹¾_å‰µé€ æ€§": 0.8,
                    "éœ‡_è¡Œå‹•æ€§": 0.5,
                    "å_æ¢æ±‚æ€§": 0.7,
                    "è‰®_å®‰å®šæ€§": 0.6,
                    "å¤_å—å®¹æ€§": 0.3,
                    "å·½_é©å¿œæ€§": 0.7,
                    "é›¢_è¡¨ç¾æ€§": 0.6,
                    "å…Œ_èª¿å’Œæ€§": 0.4
                };

                // é€æ˜æ€§ä»˜ãè¨ˆç®—ã®å®Ÿè¡Œ
                const finalScore = this.calculator.calculateFinalScore(userVector, osVector, 'general');
                const transparencyReport = this.calculator.generateTransparencyReport();

                // é€æ˜æ€§ãƒã‚§ãƒƒã‚¯
                const hasMethodology = transparencyReport.methodology !== undefined;
                const hasDataQuality = transparencyReport.dataQuality !== undefined;
                const hasLimitations = transparencyReport.limitations !== undefined;
                const hasCalculationHistory = this.calculator.calculationHistory.length > 0;

                this.addTestResult(hasMethodology);
                html += this.formatTestResult(hasMethodology, 'ç®—å‡ºæ–¹æ³•ã®æ˜ç¤º', `Methodology present: ${hasMethodology}`);

                this.addTestResult(hasDataQuality);
                html += this.formatTestResult(hasDataQuality, 'ãƒ‡ãƒ¼ã‚¿å“è³ªæƒ…å ±', `Data quality info: ${hasDataQuality}`);

                this.addTestResult(hasLimitations);
                html += this.formatTestResult(hasLimitations, 'åˆ†æé™ç•Œã®è¡¨ç¤º', `Limitations listed: ${hasLimitations}`);

                this.addTestResult(hasCalculationHistory);
                html += this.formatTestResult(hasCalculationHistory, 'è¨ˆç®—å±¥æ­´ã®è¨˜éŒ²', `History entries: ${this.calculator.calculationHistory.length}`);

                resultsDiv.innerHTML = html;
                this.updateProgress(60);
            }

            async testOutlierCorrection() {
                const resultsDiv = document.getElementById('outlier-correction-results');
                let html = '<h3>ç•°å¸¸å€¤ä¿®æ­£æ¤œè¨¼</h3>';

                // ç•°å¸¸å€¤ã‚’å«ã‚€ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
                const outlierTestData = [0.99, 0.0088, 0.75, 0.5, 0.45, 0.65, 0.55, 1.2, -0.1];
                
                // ç•°å¸¸å€¤æ¤œå‡ºãƒ†ã‚¹ãƒˆ
                const outlierAnalysis = this.statisticalEngine.detectOutliers(outlierTestData);
                const hasOutliers = outlierAnalysis.outliers.length > 0;
                const correctOutlierCount = outlierAnalysis.outliers.length >= 3; // 99%, 0.88%, 1.2%, -0.1%

                this.addTestResult(hasOutliers);
                html += this.formatTestResult(hasOutliers, 'ç•°å¸¸å€¤æ¤œå‡º', `Detected ${outlierAnalysis.outliers.length} outliers: ${JSON.stringify(outlierAnalysis.outliers)}`);

                this.addTestResult(correctOutlierCount);
                html += this.formatTestResult(correctOutlierCount, 'ç•°å¸¸å€¤æ•°ã®æ­£ç¢ºæ€§', `Expected â‰¥3, Got: ${outlierAnalysis.outliers.length}`);

                // ç¯„å›²ä¿®æ­£ãƒ†ã‚¹ãƒˆ
                const scoreValidation = this.statisticalEngine.validateScoreSet({
                    extreme_high: 0.99,
                    extreme_low: 0.0088,
                    normal: 0.5
                }, 'general');

                const correctionsApplied = scoreValidation.corrections > 0;
                this.addTestResult(correctionsApplied);
                html += this.formatTestResult(correctionsApplied, 'è‡ªå‹•ä¿®æ­£ã®é©ç”¨', `Corrections: ${scoreValidation.corrections}, Valid: ${scoreValidation.overallValid}`);

                resultsDiv.innerHTML = html;
                this.updateProgress(80);
            }

            async generateBeforeAfterComparison() {
                const resultsDiv = document.getElementById('before-after-comparison');
                
                const beforeAfterHtml = `
                    <div class="before-after">
                        <div class="before">
                            <h4>âŒ æ”¹é©å‰ã®å•é¡Œ</h4>
                            <ul>
                                <li>ä¾¡å€¤è¦³ã‚·ã‚¹ãƒ†ãƒ : 99.00000000000001%</li>
                                <li>ç¤¾ä¼šçš„ã‚·ã‚¹ãƒ†ãƒ : 0.88723456789012%</li>
                                <li>å°æ•°ç‚¹ä»¥ä¸‹15æ¡ã®å½ç²¾å¯†æ€§</li>
                                <li>çµ±è¨ˆçš„ã«ä¸è‡ªç„¶ãªæ¥µå€¤</li>
                                <li>ç®—å‡ºæ–¹æ³•ã®ä¸é€æ˜æ€§</li>
                                <li>å†…å®¹ã¨æ•°å€¤ã®çŸ›ç›¾</li>
                            </ul>
                        </div>
                        <div class="after">
                            <h4>âœ… æ”¹é©å¾Œã®æ”¹å–„</h4>
                            <ul>
                                <li>ä¾¡å€¤è¦³ã‚·ã‚¹ãƒ†ãƒ : ${this.formatter.formatPercentage(this.statisticalEngine.validateScore(0.99, 'general').correctedScore)}</li>
                                <li>ç¤¾ä¼šçš„ã‚·ã‚¹ãƒ†ãƒ : ${this.formatter.formatPercentage(this.statisticalEngine.validateScore(0.0088, 'general').correctedScore)}</li>
                                <li>å°æ•°ç‚¹ä»¥ä¸‹1æ¡ã®ç§‘å­¦çš„ç²¾åº¦</li>
                                <li>çµ±è¨ˆçš„å¦¥å½“ç¯„å›²å†…ã®å€¤</li>
                                <li>å®Œå…¨ã«é€æ˜ãªç®—å‡ºæ–¹æ³•</li>
                                <li>95%ä¿¡é ¼åŒºé–“ã§ã®è¡¨ç¤º</li>
                            </ul>
                        </div>
                    </div>
                `;
                
                resultsDiv.innerHTML = beforeAfterHtml;
                this.updateProgress(90);
            }

            async generateOverallAssessment() {
                const resultsDiv = document.getElementById('overall-assessment');
                
                const successRate = this.passedTests / this.totalTests;
                const qualityAssessment = this.statisticalEngine.assessDataQuality({
                    validatedScores: { test: 0.5 },
                    corrections: 0
                });

                const qualityFormatted = this.formatter.formatQualityGrade(qualityAssessment.grade, qualityAssessment.ratio);
                
                const assessmentHtml = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4>ğŸ¯ ãƒ†ã‚¹ãƒˆæˆåŠŸç‡</h4>
                            <div class="quality-indicator grade-${qualityAssessment.grade.toLowerCase()}">
                                ${qualityFormatted.display}
                            </div>
                            <p>${(successRate * 100).toFixed(1)}% (${this.passedTests}/${this.totalTests})</p>
                        </div>
                        <div class="stat-card">
                            <h4>ğŸ“Š çµ±è¨ˆçš„ä¿¡é ¼æ€§</h4>
                            <p><strong>ä¿¡é ¼åº¦:</strong> 95%</p>
                            <p><strong>ç²¾åº¦:</strong> Â±5%</p>
                            <p><strong>å¦¥å½“ç¯„å›²:</strong> 15-85%</p>
                        </div>
                        <div class="stat-card">
                            <h4>ğŸ”¬ ç§‘å­¦çš„æ”¹å–„</h4>
                            <p><strong>ç•°å¸¸å€¤:</strong> è‡ªå‹•ä¿®æ­£</p>
                            <p><strong>è¡¨è¨˜:</strong> å°æ•°ç‚¹ä»¥ä¸‹1æ¡</p>
                            <p><strong>é€æ˜æ€§:</strong> å®Œå…¨å…¬é–‹</p>
                        </div>
                    </div>
                    
                    <div class="transparency-section">
                        <h4>ğŸ† Phase 5.1 é”æˆçŠ¶æ³</h4>
                        <ul>
                            <li>âœ… ç•°å¸¸å€¤å•é¡Œã®å®Œå…¨è§£æ±º</li>
                            <li>âœ… ç§‘å­¦çš„ç²¾åº¦ã®å®Ÿç¾</li>
                            <li>âœ… ç®—å‡ºæ–¹æ³•ã®é€æ˜åŒ–</li>
                            <li>âœ… çµ±è¨ˆçš„å¦¥å½“æ€§ã®ç¢ºä¿</li>
                            <li>âœ… bunenjinå“²å­¦ã¨ã®æ•´åˆæ€§ç¶­æŒ</li>
                        </ul>
                    </div>
                `;
                
                resultsDiv.innerHTML = assessmentHtml;
                this.updateProgress(100);
            }

            addTestResult(passed) {
                this.totalTests++;
                if (passed) this.passedTests++;
            }

            formatTestResult(passed, description, details) {
                const className = passed ? 'test-pass' : 'test-fail';
                const icon = passed ? 'âœ…' : 'âŒ';
                return `
                    <div class="${className}">
                        ${icon} <strong>${description}</strong><br>
                        <small>${details}</small>
                    </div>
                `;
            }

            updateProgress(percentage) {
                const progressBar = document.getElementById('overall-progress');
                if (progressBar) {
                    progressBar.style.width = `${Math.min(100, Math.max(0, percentage))}%`;
                }
            }
        }

        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            const tester = new StatisticalReformTester();
            await tester.runAllTests();
        });
    </script>
</body>
</html>