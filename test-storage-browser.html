<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>StorageManager ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä¿®å¾©ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        #log {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: #fff;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª StorageManager ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä¿®å¾©ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <h2>ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h2>
        <button onclick="runAllTests()">ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="testNormalSession()">ğŸ“ æ­£å¸¸ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testCorruptedSession()">ğŸ”§ ç ´æã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿®å¾©ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testBackupFeature()">ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testRecovery()">ğŸ”„ å¾©æ—§æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearStorage()">ğŸ§¹ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢</button>
    </div>
    
    <div class="test-container">
        <h2>ãƒ†ã‚¹ãƒˆçµæœ</h2>
        <div id="log"></div>
    </div>
    
    <div class="test-container">
        <h2>ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸çŠ¶æ³</h2>
        <div id="storage-status"></div>
    </div>

    <script src="public/js/shared/core/StorageManager.js"></script>
    <script>
        let storage;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'success' ? 'success' : 
                           type === 'error' ? 'error' : 
                           type === 'warning' ? 'warning' : 'info';
            logDiv.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStorageStatus() {
            const statusDiv = document.getElementById('storage-status');
            const keys = Object.keys(localStorage).filter(key => key.startsWith('haqei_analyzer_'));
            
            statusDiv.innerHTML = `
                <p><strong>ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é …ç›®:</strong> ${keys.length}å€‹</p>
                <ul>${keys.map(key => `<li>${key.replace('haqei_analyzer_', '')}</li>`).join('')}</ul>
            `;
        }
        
        function initStorage() {
            if (!storage) {
                storage = new StorageManager();
                log('âœ… StorageManageråˆæœŸåŒ–å®Œäº†', 'success');
            }
        }
        
        function testNormalSession() {
            log('ğŸ§ª æ­£å¸¸ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆé–‹å§‹');
            initStorage();
            
            try {
                const normalSession = {
                    sessionId: 'test_normal_' + Date.now(),
                    startTime: Date.now(),
                    lastActivity: Date.now(),
                    stage: 'questions',
                    userProgress: 75,
                    testData: 'normal_session'
                };
                
                const saveResult = storage.saveSession(normalSession);
                log(`ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜: ${saveResult ? 'æˆåŠŸ' : 'å¤±æ•—'}`, saveResult ? 'success' : 'error');
                
                const retrievedSession = storage.getSession();
                if (retrievedSession && retrievedSession.sessionId === normalSession.sessionId) {
                    log(`âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—æˆåŠŸ: ${retrievedSession.sessionId}`, 'success');
                    log(`   - ã‚¹ãƒ†ãƒ¼ã‚¸: ${retrievedSession.stage}`, 'info');
                    log(`   - é€²æ—: ${retrievedSession.userProgress}%`, 'info');
                } else {
                    log('âŒ ã‚»ãƒƒã‚·ãƒ§ãƒ³å–å¾—å¤±æ•—', 'error');
                }
                
            } catch (error) {
                log(`âŒ æ­£å¸¸ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
            
            updateStorageStatus();
        }
        
        function testCorruptedSession() {
            log('ğŸ”§ ç ´æã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿®å¾©ãƒ†ã‚¹ãƒˆé–‹å§‹');
            initStorage();
            
            try {
                // æ–‡å­—åˆ—å½¢å¼ã®ç ´æã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                const corruptedString = JSON.stringify({
                    sessionId: 'corrupted_test',
                    startTime: Date.now() - 10000,
                    stage: 'analysis',
                    corruptedFlag: true
                });
                
                // ç›´æ¥localStorageã«æ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ï¼ˆç ´æçŠ¶æ…‹ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
                localStorage.setItem('haqei_analyzer_session', JSON.stringify({
                    value: corruptedString,
                    timestamp: Date.now(),
                    version: '1.0.0'
                }));
                
                log('âš ï¸ ç ´æã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã«è¨­å®š', 'warning');
                
                // ä¿®å¾©ã‚’è©¦è¡Œ
                const repairedSession = storage.getSession();
                if (repairedSession) {
                    log(`âœ… è‡ªå‹•ä¿®å¾©æˆåŠŸ: ${repairedSession.sessionId}`, 'success');
                    log(`   - ã‚¹ãƒ†ãƒ¼ã‚¸: ${repairedSession.stage}`, 'info');
                    log(`   - ç ´æãƒ•ãƒ©ã‚°: ${repairedSession.corruptedFlag}`, 'info');
                } else {
                    log('âš ï¸ ä¿®å¾©ä¸å¯ã€nullã‚’è¿”å´', 'warning');
                }
                
            } catch (error) {
                log(`âŒ ç ´æã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿®å¾©ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
            
            updateStorageStatus();
        }
        
        function testBackupFeature() {
            log('ğŸ’¾ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹');
            initStorage();
            
            try {
                // åˆæœŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
                const initialSession = {
                    sessionId: 'backup_test',
                    startTime: Date.now(),
                    testData: 'initial_data',
                    version: 1
                };
                
                storage.saveSession(initialSession);
                log('ğŸ“ åˆæœŸã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜å®Œäº†', 'success');
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’æ›´æ–°ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒä½œæˆã•ã‚Œã‚‹ã¯ãšï¼‰
                const updatedSession = {
                    sessionId: 'backup_test',
                    startTime: Date.now(),
                    testData: 'updated_data',
                    version: 2,
                    newFeature: 'added'
                };
                
                storage.saveSession(updatedSession);
                log('ğŸ“ ã‚»ãƒƒã‚·ãƒ§ãƒ³æ›´æ–°å®Œäº†ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆï¼‰', 'success');
                
                // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å­˜åœ¨ç¢ºèª
                const backupData = storage.getBackupData('session');
                if (backupData) {
                    log(`âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ç¢ºèªæˆåŠŸ: ${backupData.testData}`, 'success');
                    log(`   - ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${backupData.version}`, 'info');
                } else {
                    log('âš ï¸ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒè¦‹ã¤ã‹ã‚‰ãªã„', 'warning');
                }
                
            } catch (error) {
                log(`âŒ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
            
            updateStorageStatus();
        }
        
        function testRecovery() {
            log('ğŸ”„ å¾©æ—§æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹');
            initStorage();
            
            try {
                // å®Œå…¨ã«ç ´æã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                localStorage.setItem('haqei_analyzer_session', 'invalid_json_data{corrupt}');
                log('âš ï¸ å®Œå…¨ç ´æãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š', 'warning');
                
                // ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
                storage.setItem('analysis_result', { type: 'test_analysis' });
                storage.setItem('insights', { type: 'test_insights' });
                storage.setItem('settings', { theme: 'dark', language: 'ja' });
                log('ğŸ“‹ å¾©æ—§ç”¨ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆæº–å‚™å®Œäº†', 'info');
                
                // å¾©æ—§ã‚’è©¦è¡Œ
                const recoveredSession = storage.getSession();
                if (recoveredSession) {
                    log(`âœ… ãƒ•ãƒ©ã‚°ãƒ¡ãƒ³ãƒˆå¾©æ—§æˆåŠŸ: ${recoveredSession.sessionId}`, 'success');
                    log(`   - å¾©æ—§ãƒ•ãƒ©ã‚°: ${recoveredSession.recovered}`, 'info');
                    log(`   - åˆ†æçµæœ: ${!!recoveredSession.lastAnalysisResult}`, 'info');
                    log(`   - ã‚¤ãƒ³ã‚µã‚¤ãƒˆ: ${!!recoveredSession.lastInsights}`, 'info');
                    log(`   - è¨­å®š: ${!!recoveredSession.userSettings}`, 'info');
                } else {
                    log('âš ï¸ å¾©æ—§ä¸å¯ã€ã‚»ãƒƒã‚·ãƒ§ãƒ³å‰Šé™¤', 'warning');
                }
                
            } catch (error) {
                log(`âŒ å¾©æ—§æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
            }
            
            updateStorageStatus();
        }
        
        function clearStorage() {
            const keys = Object.keys(localStorage).filter(key => key.startsWith('haqei_analyzer_'));
            keys.forEach(key => localStorage.removeItem(key));
            log(`ğŸ§¹ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢å®Œäº†: ${keys.length}å€‹ã®é …ç›®ã‚’å‰Šé™¤`, 'success');
            updateStorageStatus();
        }
        
        function runAllTests() {
            log('ğŸš€ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹', 'info');
            log('='.repeat(50), 'info');
            
            clearStorage();
            
            setTimeout(() => testNormalSession(), 500);
            setTimeout(() => testCorruptedSession(), 1500);
            setTimeout(() => testBackupFeature(), 2500);
            setTimeout(() => testRecovery(), 3500);
            setTimeout(() => {
                log('='.repeat(50), 'info');
                log('ğŸ‰ å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå®Œäº†', 'success');
            }, 4500);
        }
        
        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸ”§ StorageManager ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ä¿®å¾©ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 'success');
            updateStorageStatus();
        });
    </script>
</body>
</html>