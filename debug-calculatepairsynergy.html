<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>calculatePairSynergy デバッグ</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff; 
            line-height: 1.6;
        }
        .test-result { 
            margin: 10px 0; 
            padding: 15px; 
            border-radius: 8px; 
            background: rgba(0,0,0,0.3);
        }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔧 calculatePairSynergy デバッグテスト</h1>
    <p>NaN問題の根本原因を特定します</p>
    
    <button onclick="runDebugTest()">🎯 デバッグテスト実行</button>
    
    <div id="results"></div>

    <script src="./public/assets/H384H64database.js"></script>
    <script src="./public/js/core/TripleOSInteractionAnalyzer.js"></script>
    <script>
        function runDebugTest() {
            const results = document.getElementById('results');
            results.innerHTML = '<div class="test-result">🔄 デバッグテスト実行中...</div>';
            
            try {
                const analyzer = new TripleOSInteractionAnalyzer();
                
                // テストケース: 抜き打ちチェックで問題のあったパターン
                const testCases = [
                    { e: 1, iface: 1, s: 1, name: "乾為天 同一パターン" },
                    { e: 2, iface: 2, s: 2, name: "坤為地 同一パターン" },
                    { e: 1, iface: 2, s: 3, name: "異なる卦の組み合わせ" },
                    { e: 29, iface: 30, s: 51, name: "坎為水×離為火×震為雷" },
                    { e: 63, iface: 64, s: 1, name: "既済×未済×乾" }
                ];
                
                let html = '<h2>🔍 詳細デバッグ結果</h2>';
                
                testCases.forEach((testCase, index) => {
                    try {
                        const engineOS = { hexagramId: testCase.e, name: `第${testCase.e}卦`, score: 0.5 };
                        const interfaceOS = { hexagramId: testCase.iface, name: `第${testCase.iface}卦`, score: 0.5 };
                        const safeModeOS = { hexagramId: testCase.s, name: `第${testCase.s}卦`, score: 0.5 };
                        
                        console.log(`テストケース ${index + 1}: ${testCase.name}`);
                        console.log('Engine OS:', engineOS);
                        console.log('Interface OS:', interfaceOS);
                        console.log('SafeMode OS:', safeModeOS);
                        
                        // 個別計算をステップバイステップで確認
                        console.log('=== calculatePairSynergy 呼び出し開始 ===');
                        
                        const engineInterfaceSynergy = analyzer.calculatePairSynergy(engineOS, interfaceOS, 'engine-interface');
                        console.log('engineInterfaceSynergy:', engineInterfaceSynergy, typeof engineInterfaceSynergy);
                        
                        const engineSafeSynergy = analyzer.calculatePairSynergy(engineOS, safeModeOS, 'engine-safe');
                        console.log('engineSafeSynergy:', engineSafeSynergy, typeof engineSafeSynergy);
                        
                        const interfaceSafeSynergy = analyzer.calculatePairSynergy(interfaceOS, safeModeOS, 'interface-safe');
                        console.log('interfaceSafeSynergy:', interfaceSafeSynergy, typeof interfaceSafeSynergy);
                        
                        // 総合計算
                        const totalSynergy = (engineInterfaceSynergy + engineSafeSynergy + interfaceSafeSynergy) / 3;
                        console.log('totalSynergy計算:', `(${engineInterfaceSynergy} + ${engineSafeSynergy} + ${interfaceSafeSynergy}) / 3 = ${totalSynergy}`);
                        
                        // analyzePair メソッドも確認
                        const eiAnalysis = analyzer.analyzePair('engine-interface', engineOS, interfaceOS);
                        const esAnalysis = analyzer.analyzePair('engine-safe', engineOS, safeModeOS);
                        const isAnalysis = analyzer.analyzePair('interface-safe', interfaceOS, safeModeOS);
                        
                        console.log('analyzePair結果:');
                        console.log('EI Analysis:', eiAnalysis);
                        console.log('ES Analysis:', esAnalysis);
                        console.log('IS Analysis:', isAnalysis);
                        
                        // データベース確認
                        console.log('データベース確認:');
                        const char1 = analyzer.getHexagramCharacteristics(testCase.e);
                        const char2 = analyzer.getHexagramCharacteristics(testCase.iface);
                        const char3 = analyzer.getHexagramCharacteristics(testCase.s);
                        console.log('Engine特徴:', char1);
                        console.log('Interface特徴:', char2);
                        console.log('SafeMode特徴:', char3);
                        
                        let resultClass = 'success';
                        let diagnostics = '';
                        
                        if (isNaN(totalSynergy) || totalSynergy === undefined || totalSynergy === null) {
                            resultClass = 'error';
                            diagnostics = `❌ 総合シナジー計算エラー: ${totalSynergy} (${typeof totalSynergy})`;
                        } else if (typeof totalSynergy !== 'number') {
                            resultClass = 'error';
                            diagnostics = `⚠️ 型エラー: ${typeof totalSynergy}, 値: ${totalSynergy}`;
                        } else if (totalSynergy < -3.0 || totalSynergy > 3.0) {
                            resultClass = 'error';
                            diagnostics = `⚠️ 範囲外: ${totalSynergy}`;
                        } else {
                            diagnostics = `✅ 正常: ${totalSynergy.toFixed(3)}`;
                        }
                        
                        html += `
                            <div class="test-result ${resultClass}">
                                <h4>テストケース ${index + 1}: ${testCase.name}</h4>
                                <p><strong>組み合わせ:</strong> Engine(${testCase.e}) × Interface(${testCase.iface}) × SafeMode(${testCase.s})</p>
                                
                                <p><strong>個別シナジー値:</strong></p>
                                <ul>
                                    <li>Engine-Interface: ${engineInterfaceSynergy} (${typeof engineInterfaceSynergy})</li>
                                    <li>Engine-Safe: ${engineSafeSynergy} (${typeof engineSafeSynergy})</li>
                                    <li>Interface-Safe: ${interfaceSafeSynergy} (${typeof interfaceSafeSynergy})</li>
                                </ul>
                                
                                <p><strong>総合シナジー:</strong> ${totalSynergy} (${typeof totalSynergy})</p>
                                
                                <p><strong>analyzePair結果:</strong></p>
                                <ul>
                                    <li>EI: ${eiAnalysis.category} (score: ${eiAnalysis.score}, synergy: ${eiAnalysis.synergy})</li>
                                    <li>ES: ${esAnalysis.category} (score: ${esAnalysis.score}, synergy: ${esAnalysis.synergy})</li>
                                    <li>IS: ${isAnalysis.category} (score: ${isAnalysis.score}, synergy: ${isAnalysis.synergy})</li>
                                </ul>
                                
                                <p><strong>診断:</strong> ${diagnostics}</p>
                            </div>
                        `;
                        
                    } catch (error) {
                        console.error(`テストケース ${index + 1} でエラー:`, error);
                        html += `
                            <div class="test-result error">
                                <h4>テストケース ${index + 1}: ${testCase.name}</h4>
                                <p>❌ 実行エラー: ${error.message}</p>
                                <p>スタック: ${error.stack}</p>
                            </div>
                        `;
                    }
                });
                
                results.innerHTML = html;
                
            } catch (error) {
                results.innerHTML = `
                    <div class="test-result error">
                        <h4>❌ システムエラー</h4>
                        <p>${error.message}</p>
                    </div>
                `;
                console.error('システムエラー:', error);
            }
        }
    </script>
</body>
</html>