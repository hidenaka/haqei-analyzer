<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® Emergency Fix Test - HAQEI</title>
</head>
<body>
    <h1>üö® HAQEI Emergency Diagnosis Fix Test</h1>
    
    <div id="test-status">
        <h2>Test Status</h2>
        <div id="error-log"></div>
        <div id="success-log"></div>
    </div>
    
    <!-- Test buttons -->
    <div style="margin: 20px 0;">
        <button onclick="testDirectAccess()">Test Direct Access to CriticalCSSAnalyzer</button>
        <button onclick="testStartButton()">Test Start Button Click</button>
        <button onclick="testConsoleErrors()">Check Console Errors</button>
    </div>
    
    <!-- Iframe to load actual os_analyzer.html -->
    <div style="margin: 20px 0;">
        <h3>Loading os_analyzer.html in iframe:</h3>
        <iframe id="test-iframe" src="http://localhost:8788/os_analyzer.html" width="100%" height="400" style="border: 1px solid #ccc;"></iframe>
    </div>
    
    <script>
        let errorLog = [];
        let successLog = [];
        
        // Capture all console errors
        window.addEventListener('error', (e) => {
            errorLog.push(`Global Error: ${e.message} at ${e.filename}:${e.lineno}`);
            updateLogs();
        });
        
        function testDirectAccess() {
            try {
                const iframe = document.getElementById('test-iframe');
                const iframeWindow = iframe.contentWindow;
                
                successLog.push('Iframe access successful');
                
                if (iframeWindow.criticalCSSAnalyzer) {
                    successLog.push('‚úÖ CriticalCSSAnalyzer instance found');
                    
                    if (typeof iframeWindow.criticalCSSAnalyzer.startAnalysis === 'function') {
                        successLog.push('‚úÖ startAnalysis method exists');
                        
                        // Try to call it
                        iframeWindow.criticalCSSAnalyzer.startAnalysis();
                        successLog.push('‚úÖ startAnalysis called successfully');
                    } else {
                        errorLog.push('‚ùå startAnalysis method not found');
                    }
                } else {
                    errorLog.push('‚ùå CriticalCSSAnalyzer instance not found');
                }
            } catch (e) {
                errorLog.push(`‚ùå Direct access test failed: ${e.message}`);
            }
            updateLogs();
        }
        
        function testStartButton() {
            try {
                const iframe = document.getElementById('test-iframe');
                const iframeDocument = iframe.contentDocument;
                const startBtn = iframeDocument.getElementById('start-btn');
                
                if (startBtn) {
                    successLog.push('‚úÖ Start button found in iframe');
                    
                    // Simulate click
                    startBtn.click();
                    successLog.push('‚úÖ Start button clicked');
                    
                    // Check if question screen is now visible
                    setTimeout(() => {
                        const questionScreen = iframeDocument.getElementById('question-screen');
                        if (questionScreen && questionScreen.classList.contains('active')) {
                            successLog.push('‚úÖ Question screen is now active');
                        } else {
                            errorLog.push('‚ùå Question screen not activated');
                        }
                        updateLogs();
                    }, 500);
                } else {
                    errorLog.push('‚ùå Start button not found in iframe');
                }
            } catch (e) {
                errorLog.push(`‚ùå Start button test failed: ${e.message}`);
            }
            updateLogs();
        }
        
        function testConsoleErrors() {
            const iframe = document.getElementById('test-iframe');
            const iframeWindow = iframe.contentWindow;
            
            // Override console.error in iframe to capture errors
            iframeWindow.console.error = function(...args) {
                errorLog.push(`Iframe Console Error: ${args.join(' ')}`);
                updateLogs();
            };
            
            successLog.push('Console error monitoring started');
            updateLogs();
        }
        
        function updateLogs() {
            const errorDiv = document.getElementById('error-log');
            const successDiv = document.getElementById('success-log');
            
            errorDiv.innerHTML = '<h3>Errors:</h3>' + errorLog.map(e => `<p style="color: red;">${e}</p>`).join('');
            successDiv.innerHTML = '<h3>Success:</h3>' + successLog.map(s => `<p style="color: green;">${s}</p>`).join('');
        }
        
        // Wait for iframe to load
        window.addEventListener('load', () => {
            setTimeout(() => {
                successLog.push('Page loaded - ready for testing');
                updateLogs();
            }, 2000);
        });
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }
        
        button {
            padding: 10px 15px;
            margin: 5px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background: #c0392b;
        }
        
        #test-status {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 5px solid #e74c3c;
        }
    </style>
</body>
</html>