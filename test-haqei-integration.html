<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI System Integration Test - çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .result {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }
        button.danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }
        button.success {
            background: linear-gradient(45deg, #28a745, #1e7e34);
        }
        #console-output {
            background: #1e1e1e;
            color: #f8f8f2;
            padding: 20px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 15px;
            border: 2px solid #444;
        }
        .data-display {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-success { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
        .status-info { background: #17a2b8; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ HAQEI System Integration Test</h1>
        <p><strong>å¯¾è±¡ãƒšãƒ¼ã‚¸:</strong> os_analyzer.html ã®ä¿®æ­£æ¤œè¨¼</p>
        <p>HAQEIã‚·ã‚¹ãƒ†ãƒ ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã€ã™ã¹ã¦ã®ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
        
        <div id="test-results"></div>
        
        <div class="test-section">
            <h3>ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
            <button onclick="runAllTests()" class="success">å…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="testDependencies()">ä¾å­˜é–¢ä¿‚ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testVirtualQuestionFlow()">VirtualQuestionFlow ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testFindIndexFix()">findIndexä¿®æ­£ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testPerformanceOptimizer()">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="clearAndReset()" class="danger">ãƒªã‚»ãƒƒãƒˆ</button>
        </div>
        
        <div class="test-section">
            <h3>ğŸ’¾ localStorage çŠ¶æ…‹</h3>
            <button onclick="showLocalStorageState()">localStorageç¢ºèª</button>
            <button onclick="createTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ</button>
            <button onclick="clearLocalStorage()" class="danger">localStorageå‰Šé™¤</button>
            <div id="localStorage-display" class="data-display"></div>
        </div>
        
        <div id="console-output"></div>
    </div>

    <!-- Core Dependencies -->
    <script src="/js/shared/core/BaseComponent.js"></script>
    <script src="/js/shared/core/MicroStorageManager.js"></script>
    <script src="/js/shared/core/BridgeStorageManager.js"></script>
    <script src="/js/shared/core/SimpleStorageManager.js"></script>
    <script src="/js/shared/core/MicroDataManager.js"></script>
    <script src="/js/shared/data/questions.js"></script>
    <script src="/js/os-analyzer/core/PrecompiledQuestions.js"></script>
    
    <!-- Performance Dependencies -->
    <script src="/js/core/CacheManager.js"></script>
    <script src="/js/core/PerformanceOptimizer.js"></script>
    
    <!-- VirtualQuestionFlow -->
    <script src="/js/os-analyzer/components/HaqeiQuestionElement.js"></script>
    <script src="/js/os-analyzer/components/VirtualQuestionFlow.js"></script>

    <script>
        let consoleOutput = '';
        let testResults = [];
        let questionFlow = null;
        
        // Console capture
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function logToDisplay(level, ...args) {
            const timestamp = new Date().toLocaleTimeString();
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput += `[${timestamp}] ${level.toUpperCase()}: ${message}\n`;
            updateConsoleDisplay();
        }
        
        console.log = (...args) => {
            originalLog(...args);
            logToDisplay('log', ...args);
        };
        
        console.error = (...args) => {
            originalError(...args);
            logToDisplay('error', ...args);
        };
        
        console.warn = (...args) => {
            originalWarn(...args);
            logToDisplay('warn', ...args);
        };
        
        function updateConsoleDisplay() {
            const consoleDiv = document.getElementById('console-output');
            consoleDiv.textContent = consoleOutput;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        function addResult(type, title, message, details = null) {
            const statusClass = `status-${type}`;
            const result = {
                type,
                title,
                message,
                details,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <span class="status-indicator ${statusClass}"></span>
                <div>
                    <strong>${title}</strong><br>
                    ${message}
                    ${details ? `<br><small>${details}</small>` : ''}
                </div>
            `;
            resultsDiv.appendChild(resultDiv);
            
            // Auto-scroll to latest result
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Test Functions
        async function testDependencies() {
            console.log('ğŸ§ª Testing dependencies...');
            
            const dependencies = [
                { name: 'BaseComponent', obj: window.BaseComponent },
                { name: 'CacheManager', obj: window.CacheManager },
                { name: 'PerformanceOptimizer', obj: window.PerformanceOptimizer },
                { name: 'VirtualQuestionFlow', obj: window.VirtualQuestionFlow },
                { name: 'questions', obj: window.questions }
            ];
            
            let passed = 0;
            
            for (const dep of dependencies) {
                if (dep.obj && typeof dep.obj === 'function') {
                    addResult('success', `âœ… ${dep.name}`, 'æ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã™');
                    passed++;
                } else if (dep.obj) {
                    addResult('warning', `âš ï¸ ${dep.name}`, 'ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã—ã¦å­˜åœ¨ã—ã¾ã™ãŒã€é–¢æ•°ã§ã¯ã‚ã‚Šã¾ã›ã‚“');
                } else {
                    addResult('error', `âŒ ${dep.name}`, 'èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
            }
            
            if (passed === dependencies.length) {
                addResult('success', 'ä¾å­˜é–¢ä¿‚ãƒ†ã‚¹ãƒˆ', 'ã™ã¹ã¦ã®ä¾å­˜é–¢ä¿‚ãŒæ­£å¸¸ã§ã™');
            } else {
                addResult('warning', 'ä¾å­˜é–¢ä¿‚ãƒ†ã‚¹ãƒˆ', `${passed}/${dependencies.length} ã®ä¾å­˜é–¢ä¿‚ãŒæ­£å¸¸ã§ã™`);
            }
        }
        
        async function testVirtualQuestionFlow() {
            console.log('ğŸ§ª Testing VirtualQuestionFlow...');
            
            try {
                // Create test container
                let container = document.getElementById('test-container');
                if (!container) {
                    container = document.createElement('div');
                    container.id = 'test-container';
                    container.style.display = 'none';
                    document.body.appendChild(container);
                }
                
                // Create VirtualQuestionFlow instance
                const startTime = performance.now();
                questionFlow = new VirtualQuestionFlow({
                    container: container,
                    questions: window.questions || [],
                    onComplete: (answers) => {
                        console.log('VirtualQuestionFlow onComplete called with:', answers);
                    }
                });
                
                await questionFlow.init();
                const initTime = performance.now() - startTime;
                
                addResult('success', 'VirtualQuestionFlow ä½œæˆ', `ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ (${initTime.toFixed(2)}ms)`);
                
                // Test answers array
                if (Array.isArray(questionFlow.answers)) {
                    addResult('success', 'answers é…åˆ—', `æ­£å¸¸ãªé…åˆ—ã§ã™ (${questionFlow.answers.length} é …ç›®)`);
                } else {
                    addResult('error', 'answers é…åˆ—', `é…åˆ—ã§ã¯ã‚ã‚Šã¾ã›ã‚“: ${typeof questionFlow.answers}`);
                }
                
            } catch (error) {
                addResult('error', 'VirtualQuestionFlow ã‚¨ãƒ©ãƒ¼', error.message, error.stack);
            }
        }
        
        async function testFindIndexFix() {
            console.log('ğŸ§ª Testing findIndex fix...');
            
            if (!questionFlow) {
                await testVirtualQuestionFlow();
            }
            
            if (!questionFlow) {
                addResult('error', 'findIndex ãƒ†ã‚¹ãƒˆ', 'VirtualQuestionFlow ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒä½œæˆã§ãã¾ã›ã‚“ã§ã—ãŸ');
                return;
            }
            
            try {
                // Test findAnswerIndex
                const index1 = questionFlow.findAnswerIndex('q1');
                addResult('success', 'findAnswerIndex', `æ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ (result: ${index1})`);
                
                // Test findAnswerByQuestionId
                const answer1 = questionFlow.findAnswerByQuestionId('q1');
                addResult('success', 'findAnswerByQuestionId', `æ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ (result: ${answer1 ? 'Found' : 'Not found'})`);
                
                // Test with corrupted data simulation
                const originalAnswers = questionFlow.answers;
                questionFlow.answers = "not an array"; // Intentionally corrupt
                
                const index2 = questionFlow.findAnswerIndex('q1');
                const answer2 = questionFlow.findAnswerByQuestionId('q1');
                
                if (Array.isArray(questionFlow.answers)) {
                    addResult('success', 'ç ´æãƒ‡ãƒ¼ã‚¿å¯¾å¿œ', 'é…åˆ—ã§ãªã„ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œå‡ºã—ã€è‡ªå‹•ä¿®å¾©ã•ã‚Œã¾ã—ãŸ');
                } else {
                    addResult('error', 'ç ´æãƒ‡ãƒ¼ã‚¿å¯¾å¿œ', 'é…åˆ—ã§ãªã„ãƒ‡ãƒ¼ã‚¿ãŒä¿®å¾©ã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ');
                }
                
                // Test handleAnswerChange
                questionFlow.handleAnswerChange({
                    questionId: 'test-q1',
                    value: 'A',
                    scoringTags: ['test'],
                    choiceType: 'single'
                });
                
                addResult('success', 'handleAnswerChange', 'å›ç­”å¤‰æ›´å‡¦ç†ãŒæ­£å¸¸ã«å®Ÿè¡Œã•ã‚Œã¾ã—ãŸ');
                
            } catch (error) {
                addResult('error', 'findIndex ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', error.message, error.stack);
            }
        }
        
        async function testPerformanceOptimizer() {
            console.log('ğŸ§ª Testing PerformanceOptimizer...');
            
            try {
                const cacheManager = new CacheManager();
                const perfOptimizer = new PerformanceOptimizer();
                
                await cacheManager.init();
                
                // Test caching
                const testKey = 'test-key';
                const testValue = { data: 'test-data', timestamp: Date.now() };
                
                cacheManager.set(testKey, testValue);
                const cachedValue = cacheManager.get(testKey);
                
                if (cachedValue && cachedValue.data === testValue.data) {
                    addResult('success', 'CacheManager', 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®èª­ã¿æ›¸ããŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                } else {
                    addResult('error', 'CacheManager', 'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®èª­ã¿æ›¸ãã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                }
                
                // Test performance optimization
                const metrics = perfOptimizer.getMetrics();
                addResult('success', 'PerformanceOptimizer', 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™');
                
            } catch (error) {
                addResult('error', 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', error.message, error.stack);
            }
        }
        
        function showLocalStorageState() {
            const display = document.getElementById('localStorage-display');
            const data = localStorage.getItem('haqei_answers');
            
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    display.textContent = 'haqei_answers:\n' + JSON.stringify(parsed, null, 2);
                    addResult('info', 'localStorage', `ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™ (${Array.isArray(parsed) ? 'Array' : typeof parsed})`);
                } catch (e) {
                    display.textContent = 'haqei_answers (ç ´æãƒ‡ãƒ¼ã‚¿):\n' + data;
                    addResult('warning', 'localStorage', 'ç ´æã—ãŸJSONãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™');
                }
            } else {
                display.textContent = 'haqei_answers: (empty)';
                addResult('info', 'localStorage', 'ãƒ‡ãƒ¼ã‚¿ã¯å­˜åœ¨ã—ã¾ã›ã‚“');
            }
        }
        
        function createTestData() {
            const testData = [
                {
                    questionId: 'q1',
                    selectedValue: 'A',
                    selectedChoice: 'q1a',
                    choiceText: 'ãƒ†ã‚¹ãƒˆå›ç­”A',
                    timestamp: new Date().toISOString()
                },
                {
                    questionId: 'q2',
                    selectedValue: 'B',
                    selectedChoice: 'q2b',
                    choiceText: 'ãƒ†ã‚¹ãƒˆå›ç­”B',
                    timestamp: new Date().toISOString()
                }
            ];
            
            localStorage.setItem('haqei_answers', JSON.stringify(testData));
            addResult('success', 'ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ', 'æœ‰åŠ¹ãªãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ãŒä½œæˆã•ã‚Œã¾ã—ãŸ');
            showLocalStorageState();
        }
        
        function clearLocalStorage() {
            localStorage.removeItem('haqei_answers');
            addResult('info', 'localStorageå‰Šé™¤', 'localStorage ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
            showLocalStorageState();
        }
        
        function clearAndReset() {
            testResults = [];
            consoleOutput = '';
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('console-output').textContent = '';
            document.getElementById('localStorage-display').textContent = '';
            addResult('info', 'ãƒªã‚»ãƒƒãƒˆå®Œäº†', 'ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆçµæœãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ');
        }
        
        async function runAllTests() {
            console.log('ğŸš€ Running all integration tests...');
            addResult('info', 'ãƒ†ã‚¹ãƒˆé–‹å§‹', 'çµ±åˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™');
            
            const startTime = performance.now();
            
            await testDependencies();
            await testVirtualQuestionFlow();
            await testFindIndexFix();
            await testPerformanceOptimizer();
            
            const totalTime = performance.now() - startTime;
            
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            
            if (errorCount === 0) {
                addResult('success', 'çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†', 
                    `ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸ (${totalTime.toFixed(2)}ms)`, 
                    `æˆåŠŸ: ${successCount}, è­¦å‘Š: ${warningCount}, ã‚¨ãƒ©ãƒ¼: ${errorCount}`);
            } else {
                addResult('warning', 'çµ±åˆãƒ†ã‚¹ãƒˆå®Œäº†', 
                    `ãƒ†ã‚¹ãƒˆãŒå®Œäº†ã—ã¾ã—ãŸãŒã€ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ (${totalTime.toFixed(2)}ms)`, 
                    `æˆåŠŸ: ${successCount}, è­¦å‘Š: ${warningCount}, ã‚¨ãƒ©ãƒ¼: ${errorCount}`);
            }
        }
        
        // Initialize
        window.addEventListener('load', () => {
            console.log('ğŸ”¬ HAQEI System Integration Test initialized');
            addResult('info', 'ãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ é–‹å§‹', 'HAQEIçµ±åˆãƒ†ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ ãŒé–‹å§‹ã•ã‚Œã¾ã—ãŸ');
            showLocalStorageState();
        });
    </script>
</body>
</html>