<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Quick Triple OS Test</title>
    <style>
        body { background: #222; color: #fff; font-family: monospace; padding: 20px; }
        button { background: #444; color: #fff; border: 1px solid #666; padding: 10px 20px; margin: 5px; cursor: pointer; }
        pre { background: #111; padding: 10px; border: 1px solid #444; overflow: auto; max-height: 400px; }
        .success { color: #0f0; }
        .error { color: #f00; }
    </style>
</head>
<body>
    <h1>🔬 Quick Triple OS Test</h1>
    <button onclick="testTripleOS()">Triple OS テスト実行</button>
    <button onclick="checkStorage()">LocalStorage確認</button>
    <pre id="output"></pre>

    <script>
        function log(msg, type = 'info') {
            const output = document.getElementById('output');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            output.innerHTML += `<span class="${className}">${msg}</span>\n`;
        }

        async function testTripleOS() {
            document.getElementById('output').innerHTML = '';
            log('🚀 Triple OS テスト開始...');
            
            try {
                // 必要なスクリプトを動的に読み込み
                await loadScript('js/shared/core/SimpleStorageManager.js');
                await loadScript('js/shared/core/DataManager.js');
                await loadScript('js/os-analyzer/core/TripleOSEngine.js');
                
                log('✅ スクリプト読み込み完了');
                
                // テスト実行
                const dataManager = new DataManager();
                await dataManager.loadAllData();
                log('✅ DataManager初期化完了');
                
                const tripleOSEngine = new TripleOSEngine(dataManager);
                log('✅ TripleOSEngine初期化完了');
                
                // テスト回答
                const answers = [];
                for (let i = 1; i <= 30; i++) {
                    answers.push({
                        questionId: `q${i}`,
                        selectedChoice: `q${i}a`,
                        choiceText: 'テスト選択肢',
                        selectedValue: 'A'
                    });
                }
                
                log('🔄 分析実行中...');
                const result = await tripleOSEngine.analyzeUser(answers);
                
                log('✅ 分析完了!', 'success');
                log(`Engine OS: ${result?.engineOS ? '✅' : '❌'}`, result?.engineOS ? 'success' : 'error');
                log(`Interface OS: ${result?.interfaceOS ? '✅' : '❌'}`, result?.interfaceOS ? 'success' : 'error');
                log(`SafeMode OS: ${result?.safeModeOS ? '✅' : '❌'}`, result?.safeModeOS ? 'success' : 'error');
                
                // 保存テスト
                const storage = new SimpleStorageManager();
                const saved = storage.saveAnalysisResult(result);
                log(`保存: ${saved ? '✅' : '❌'}`, saved ? 'success' : 'error');
                
            } catch (error) {
                log(`❌ エラー: ${error.message}`, 'error');
            }
        }

        function checkStorage() {
            document.getElementById('output').innerHTML = '';
            log('💾 LocalStorage確認中...');
            
            const keys = ['haqei_analysis_result', 'haqei_simple_analysis_result'];
            
            keys.forEach(key => {
                const data = localStorage.getItem(key);
                if (data) {
                    try {
                        const parsed = JSON.parse(data);
                        log(`✅ ${key}: あり`, 'success');
                        log(`  - Engine OS: ${parsed.engineOS ? '✅' : '❌'}`);
                        log(`  - Interface OS: ${parsed.interfaceOS ? '✅' : '❌'}`);
                        log(`  - SafeMode OS: ${parsed.safeModeOS ? '✅' : '❌'}`);
                    } catch (e) {
                        log(`⚠️ ${key}: JSONパースエラー`);
                    }
                } else {
                    log(`❌ ${key}: なし`, 'error');
                }
            });
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>