<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>あなたのための未来予測レポート - HaQei</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>易</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #fde047, #f97316);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .prose-custom {
        color: #d1d5db;
        line-height: 1.8;
      }
      .prose-custom p {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      .prose-custom strong {
        color: #fde047;
      }
      .scenario-card {
        background: rgba(17, 24, 39, 0.5);
        border: 1px solid rgba(55, 65, 81, 0.5);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        padding: 1.5rem 2rem;
      }
      .rank-badge {
        font-weight: bold;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 1.25rem;
      }
      .rank-s {
        border: 2px solid #34d399;
        color: #6ee7b7;
        text-shadow: 0 0 10px #34d399;
      }
      .rank-a {
        border: 2px solid #2dd4bf;
        color: #5eead4;
      }
      .rank-b {
        border: 2px solid #60a5fa;
        color: #93c5fd;
      }
      .rank-c {
        border: 2px solid #a5b4fc;
        color: #c4b5fd;
      }
      .rank-d {
        border: 2px solid #fcd34d;
        color: #fde047;
      }
      .rank-e {
        border: 2px solid #fb923c;
        color: #fdba74;
      }
      .rank-f {
        border: 2px solid #f87171;
        color: #fca5a5;
      }
      .rank-h {
        border: 2px solid #ef4444;
        color: #fda4af;
      }
      .step-card {
        background-color: #1f2937;
        border: 1px solid #374151;
        border-radius: 0.5rem;
        padding: 1.25rem;
        flex-shrink: 0;
        width: 320px;
        display: flex;
        flex-direction: column;
      }
      .transition-card {
        flex-shrink: 0;
        text-align: center;
        padding: 0.5rem;
        margin: 0.5rem 0;
      }
      @media (min-width: 640px) {
        .transition-card {
          margin: 0 0.5rem;
        }
      }
      .transition-shin {
        color: #5eead4;
        background-color: rgba(20, 184, 166, 0.1);
        border: 1px solid rgba(20, 184, 166, 0.3);
        border-radius: 0.5rem;
      }
      .transition-hen {
        color: #c4b5fd;
        background-color: rgba(139, 92, 246, 0.1);
        border: 1px solid rgba(139, 92, 246, 0.3);
        border-radius: 0.5rem;
      }
      .toggle-label {
        cursor: pointer;
        display: flex;
        align-items: center;
        padding: 8px 12px;
        border-radius: 8px;
        border: 1px solid #374151;
        background-color: #1f2937;
        transition: all 0.2s ease-in-out;
      }
      .toggle-label:hover,
      .toggle-label.highlighted {
        transform: translateY(-2px);
        border-color: #a5b4fc;
        background-color: #312e81;
      }
      .toggle-legend {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        margin-right: 8px;
        flex-shrink: 0;
      }
      .eval-label {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 10px;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-8">
    <div class="max-w-7xl mx-auto mb-4">
      <a href="future_simulator.html" id="resetAndGoBack" class="inline-flex items-center gap-1 text-sm text-gray-400 hover:text-white transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
        </svg>
        最初の分析画面に戻る
      </a>
    </div>
    <div class="max-w-7xl mx-auto">
    <div class="max-w-7xl mx-auto">
      <header class="text-center mb-10">
        <a
          href="future_simulator.html"
          id="resetAndGoBack"
          class="inline-block"
        >
          <h1 class="text-4xl sm:text-5xl font-bold brand-text tracking-wider">
          HaQei
        </h1>
        <p class="text-gray-400 mt-2 text-xl">あなたのための未来予測レポート</p>

        <div class="mt-6">
          <a
            href="future_simulator.html"
            class="inline-flex items-center gap-2 px-4 py-2 text-sm font-medium text-indigo-300 bg-indigo-900/50 border border-indigo-700 rounded-lg hover:bg-indigo-800/50 transition-colors"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              class="h-5 w-5"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z"
                clip-rule="evenodd"
              />
            </svg>
            分析画面に戻って内容を確認する
          </a>
        </div>
      </header>

      <div
        id="worryDisplay"
        class="bg-gray-800/50 p-6 rounded-xl mb-10 border-l-4 border-indigo-500"
      ></div>

      <div id="initialAnalysisArea" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start mb-12">
          <div id="summaryContainer" class="lg:col-span-1">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              分析サマリー
            </h2>
            <div
              class="p-4 rounded-lg border border-gray-600/50 bg-gray-900/30"
            >
              <div
                class="bg-yellow-400/10 border-l-4 border-yellow-400 p-3 rounded-md"
              >
                <h4
                  id="currentTitle"
                  class="text-lg font-semibold text-yellow-300"
                ></h4>
                <p
                  id="currentKeywords"
                  class="text-sm text-yellow-200 mt-1"
                ></p>
                <p id="currentSummary" class="text-gray-300 mt-2 text-sm"></p>
              </div>
              <div class="mt-4 pt-4 border-t border-gray-700/50">
                <h4 class="font-bold text-gray-300">現在地の総合評価</h4>
                <div class="flex items-baseline">
                  <p id="currentScore" class="text-3xl font-bold"></p>
                  <span id="currentScoreLabel"></span>
                </div>
                <p id="currentScoreDesc" class="text-xs"></p>
              </div>
              <div class="mt-4 pt-4 border-t border-gray-700/50">
                <h4 class="font-bold text-gray-300">
                  今回の変化のしやすさ (移行コスト)
                </h4>
                <div class="flex items-baseline">
                  <p id="transitionCost" class="text-3xl font-bold"></p>
                  <span id="transitionCostLabel"></span>
                </div>
                <p id="transitionCostDesc" class="text-xs"></p>
              </div>
              <div class="mt-4 pt-4 border-t border-gray-700/50">
                <div class="flex items-center justify-between mb-2">
                  <h4 class="font-bold text-gray-300">現在地のグラフ</h4>
                  <button
                    id="paramHelpBtn"
                    class="text-yellow-400 hover:text-yellow-300 text-xl cursor-pointer"
                    title="パラメータの見方"
                  >
                    <span>⭐️</span>
                  </button>
                </div>
                <div class="relative" style="height: 150px; padding-left: 5px">
                  <canvas id="currentStateBarChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="lg:col-span-2 bg-gray-900/50 p-6 rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              未来分岐グラフ
            </h2>
            <div class="relative" style="height: 400px">
              <canvas id="summaryChart"></canvas>
            </div>
            <div
              id="chartToggles"
              class="grid grid-cols-1 md:grid-cols-2 gap-3 mt-6"
            ></div>
          </div>
        </div>
      </div>

      <div id="loadingIndicator" class="text-center py-20">
        <div role="status" class="flex flex-col items-center justify-center">
          <svg
            aria-hidden="true"
            class="w-10 h-10 text-gray-600 animate-spin fill-orange-400"
            viewBox="0 0 100 101"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z"
              fill="currentColor"
            />
            <path
              d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0491C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5424 39.6781 93.9676 39.0409Z"
              fill="currentFill"
            />
          </svg>
          <span class="mt-4 text-gray-400"
            >AIがあなたの未来を分析し、戦略を構築しています...</span
          >
        </div>
      </div>
      <div id="reportContainer" class="hidden space-y-8"></div>
      <div
        id="errorIndicator"
        class="hidden text-center py-20 bg-red-900/20 border border-red-800 rounded-lg"
      ></div>
    </div>
    <script type="module">
      let HAQEI_DATA = null;
      let summaryChartInstance = null;

      function updateChartAppearance(activeScenarioIndex = -1) {
        if (!summaryChartInstance) return;

        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];

        summaryChartInstance.data.datasets.forEach((dataset, index) => {
          if (activeScenarioIndex === -1 || index === activeScenarioIndex) {
            const color =
              index < 4 ? topColors[index] : bottomColors[index - 4];
            dataset.borderColor = color;
            dataset.pointBackgroundColor = "white";
            dataset.borderWidth = index < 4 ? 3.5 : 1.5;
          } else {
            dataset.borderColor = "rgba(107, 114, 128, 0.3)";
            dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.3)";
            dataset.borderWidth = 1;
          }
        });
        summaryChartInstance.update("none");
      }

      function resetChartAppearance() {
        updateChartAppearance(-1);
      }

      function renderSummaryChart(sortedPaths) {
        if (summaryChartInstance) summaryChartInstance.destroy();
        const ctx = document.getElementById("summaryChart").getContext("2d");
        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];
        const currentScore = sortedPaths[0][0].S7_総合評価スコア;

        const datasets = sortedPaths.map((path, index) => {
          const isTop = index < 4;
          const color = isTop ? topColors[index] : bottomColors[index - 4];
          return {
            label: `シナリオ ${index + 1}`,
            data: path.map((p) => p.S7_総合評価スコア),
            borderColor: color,
            borderWidth: isTop ? 3.5 : 1.5,
            tension: 0.1,
            pointRadius: 4,
            pointBackgroundColor: "white",
            pointHoverRadius: 6,
          };
        });

        summaryChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: ["現在地", "フェーズ1", "フェーズ2", "フェーズ3"],
            datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: "index",
              intersect: false,
            },
            scales: {
              y: {
                min: 0,
                max: 100,
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(255, 255, 255, 0.1)" },
              },
              x: {
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(255, 255, 255, 0.1)" },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
              tooltip: { mode: "index", intersect: false },
              annotation: {
                annotations: {
                  currentScoreLine: {
                    type: "line",
                    yMin: currentScore,
                    yMax: currentScore,
                    borderColor: "rgb(253, 224, 71)",
                    borderWidth: 2,
                    borderDash: [6, 6],
                    label: {
                      content: "現在地のスコア",
                      enabled: true,
                      position: "end",
                      backgroundColor: "rgba(253, 224, 71, 0.8)",
                      color: "black",
                      font: { size: 10 },
                    },
                  },
                },
              },
            },
          },
        });
      }

      function getSituationText(score) {
        if (score >= 80)
          return {
            text: "非常に安定し、望ましい状況です。",
            color: "text-green-300",
          };
        if (score >= 60)
          return {
            text: "物事が順調に進んでいる、好ましい状況です。",
            color: "text-emerald-300",
          };
        if (score >= 40)
          return {
            text: "良くも悪くもない、平均的な状況です。",
            color: "text-yellow-300",
          };
        if (score >= 20)
          return {
            text: "注意が必要な、やや困難な状況です。",
            color: "text-orange-400",
          };
        return {
          text: "極めて困難で、リスクの高い状況です。",
          color: "text-red-400",
        };
      }

      function getHexagramInfo(hexNum) {
        if (!HAQEI_DATA) return { name: "不明", catchphrase: "情報なし" };
        const hexData = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id === hexNum
        );
        return hexData || { name: "不明", catchphrase: "情報なし" };
      }

      // ▼▼▼ この関数を丸ごと置き換え ▼▼▼
      function renderSummaryCard(startState) {
        // データをグローバルに保存してモーダルから参照できるようにする
        currentAnalysisData.startState = startState;

        // --- 各要素にデータを設定 ---
        document.getElementById(
          "currentTitle"
        ).innerText = `現在地: ${startState["親となる卦"]} ${startState.爻}`;
        document.getElementById("currentKeywords").innerText = `テーマ: ${
          startState.キーワード || ""
        }`;
        document.getElementById("currentSummary").innerText =
          startState.現代解釈の要約;

        const scoreEval = getScoreEvaluation(startState.S7_総合評価スコア);
        document.getElementById(
          "currentScore"
        ).innerText = `${startState.S7_総合評価スコア} 点`;
        const scoreLabel = document.getElementById("currentScoreLabel");
        scoreLabel.innerText = scoreEval.label;
        scoreLabel.className = `eval-label ${scoreEval.colorClass}`;
        document.getElementById(
          "currentScoreDesc"
        ).innerText = `※ ${scoreEval.desc}`;

        const transitionCost = 100 - (startState.S6_変動性スコア || 50);
        const costEval = getTransitionCostEvaluation(transitionCost);
        document.getElementById(
          "transitionCost"
        ).innerText = `${transitionCost} 点`;
        const costLabel = document.getElementById("transitionCostLabel");
        costLabel.innerText = costEval.label;
        costLabel.className = `eval-label ${costEval.colorClass}`;
        document.getElementById(
          "transitionCostDesc"
        ).innerText = `※ ${costEval.desc}`;

        // --- グラフを描画 ---
        renderCurrentStateBarChart(startState);

        document
          .getElementById("initialAnalysisArea")
          .classList.remove("hidden");
      }

      function calculateDifficulty(path) {
        const startScore = path[0].S7_総合評価スコア;
        const finalScore = path[3].S7_総合評価スコア;

        const growth = finalScore - startScore;
        let trendScore;
        if (growth >= 30) trendScore = 10;
        else if (growth >= 10) trendScore = 30;
        else if (growth > -5) trendScore = 50;
        else trendScore = 70;

        const startDifficulty = 100 - startScore;
        const avgRisk =
          path.slice(1).reduce((acc, s) => acc + s.S4_リスク, 0) / 3;
        const finalDifficulty =
          trendScore * 0.3 + startDifficulty * 0.4 + avgRisk * 0.3;

        if (finalDifficulty >= 75)
          return { text: "極高", color: "text-red-400" };
        if (finalDifficulty >= 60)
          return { text: "高", color: "text-orange-400" };
        if (finalDifficulty >= 45)
          return { text: "中", color: "text-yellow-400" };
        return { text: "低", color: "text-green-400" };
      }

      function renderChartToggles(sortedPaths, narratives) {
        const container = document.getElementById("chartToggles");
        container.innerHTML = "";
        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];

        sortedPaths.forEach((path, index) => {
          const color = index < 4 ? topColors[index] : bottomColors[index - 4];
          const finalScore = path[3].S7_総合評価スコア;
          const narrative = narratives[index] || {};

          const label = document.createElement("label");
          label.className = "toggle-label";
          label.dataset.index = index;

          label.addEventListener("mouseover", () =>
            updateChartAppearance(index)
          );
          label.addEventListener("mouseout", resetChartAppearance);

          label.innerHTML = `
            <span class="toggle-legend" style="background-color: ${color};"></span>
            <div class="flex-grow">
              <span class="font-bold text-gray-200 text-sm">シナリオ ${
                index + 1
              } (${finalScore}点)</span>
              <p class="text-gray-400 text-[11px] leading-tight">${
                narrative.scenario_summary || "要約の生成に失敗しました。"
              }</p>
            </div>
          `;
          container.appendChild(label);
          // ▼▼▼ ここから追加 ▼▼▼
          label.addEventListener("click", function () {
            const scenarioIndex = this.dataset.scenarioIndex;
            const scenarioElement = document.getElementById(
              `scenario-${scenarioIndex}`
            );
            if (scenarioElement) {
              scenarioElement.scrollIntoView({
                behavior: "smooth",
                block: "start",
              });
            }
          });
          // ▲▲▲ ここまで追加 ▲▲▲
        });
      }
      function renderMiniBarChart(canvasId, state) {
        const ctx = document.getElementById(canvasId)?.getContext("2d");
        if (!ctx || !state) return;

        const data = [
          state.S1_基本スコア,
          state.S2_ポテンシャル,
          state.S3_安定性スコア,
          Math.abs(state.S4_リスク),
          state.S6_変動性スコア,
        ];
        const colors = [
          "rgba(96, 165, 250, 0.7)",
          "rgba(52, 211, 153, 0.7)",
          "rgba(167, 139, 250, 0.7)",
          "rgba(248, 113, 113, 0.7)",
          "rgba(251, 191, 36, 0.7)",
        ];

        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["基本", "潜在力", "安定性", "リスク", "変動性"],
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderWidth: 0,
                barPercentage: 0.8,
                categoryPercentage: 0.9,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            scales: {
              x: { display: false, min: 0, max: 100 },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: "#d1d5db", font: { size: 12 } },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
          },
        });
      }

      function renderAllScenarioCharts(paths) {
        paths.forEach((path, index) => {
          const finalState = path[path.length - 1];
          renderMiniBarChart(`scenarioChart-${index}`, finalState);
        });
      }
      // ▼▼▼ この関数群を DOMContentLoaded の前に追加 ▼▼▼
      let currentStateBarChartInstance = null;
      let currentAnalysisData = {}; // モーダルで使うために定義

      function getScoreEvaluation(score) {
        if (score >= 80)
          return {
            label: "Excellent",
            colorClass: "bg-green-500 text-white",
            desc: "非常に良い状況です。",
          };
        if (score >= 60)
          return {
            label: "Good",
            colorClass: "bg-emerald-500 text-white",
            desc: "良い状況です。チャンスを活かしましょう。",
          };
        if (score >= 40)
          return {
            label: "Average",
            colorClass: "bg-yellow-500 text-white",
            desc: "平均的な状況。油断は禁物です。",
          };
        if (score >= 20)
          return {
            label: "Poor",
            colorClass: "bg-orange-500 text-white",
            desc: "厳しい状況。慎重な判断が必要です。",
          };
        return {
          label: "Critical",
          colorClass: "bg-red-600 text-white",
          desc: "極めて危険な状況。抜本的な対策が必要です。",
        };
      }

      function getTransitionCostEvaluation(cost) {
        if (cost <= 20)
          return {
            label: "絶好機",
            colorClass: "bg-sky-500 text-white",
            desc: "極めて変化しやすい絶好のチャンス期間です。",
          };
        if (cost <= 40)
          return {
            label: "好機",
            colorClass: "bg-teal-500 text-white",
            desc: "変化を起こしやすい好機です。",
          };
        if (cost <= 60)
          return {
            label: "普通",
            colorClass: "bg-gray-500 text-white",
            desc: "変化には相応のエネルギーが必要です。",
          };
        if (cost <= 80)
          return {
            label: "困難",
            colorClass: "bg-rose-500 text-white",
            desc: "変化は困難。現状維持も視野に。",
          };
        return {
          label: "膠着",
          colorClass: "bg-zinc-700 text-white",
          desc: "変化は極めて困難。今は動くべき時ではありません。",
        };
      }

      function renderCurrentStateBarChart(state) {
        if (currentStateBarChartInstance) {
          currentStateBarChartInstance.destroy();
        }
        const ctx = document
          .getElementById("currentStateBarChart")
          ?.getContext("2d");
        if (!ctx) return;
        const data = [
          state.S1_基本スコア,
          state.S2_ポテンシャル,
          state.S3_安定性スコア,
          Math.abs(state.S4_リスク),
          state.S6_変動性スコア,
        ];
        const colors = [
          "rgba(96, 165, 250, 0.8)",
          "rgba(52, 211, 153, 0.8)",
          "rgba(167, 139, 250, 0.8)",
          "rgba(248, 113, 113, 0.8)",
          "rgba(251, 191, 36, 0.8)",
        ];
        currentStateBarChartInstance = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["基本", "潜在力", "安定性", "リスク", "変動性"],
            datasets: [
              {
                data,
                backgroundColor: colors,
                borderWidth: 0,
                barPercentage: 0.8,
                categoryPercentage: 0.9,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            scales: {
              x: {
                display: true,
                min: 0,
                max: 100,
                grid: { color: "rgba(255, 255, 255, 0.1)" },
                ticks: { color: "#9ca3af", font: { size: 10 } },
              },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: "#e5e7eb", font: { size: 12, weight: "500" } },
              },
            },
            plugins: { legend: { display: false }, tooltip: { enabled: true } },
          },
        });
      }

      function showModal(content) {
        document.getElementById("modalBody").innerHTML = content;
        const modalContainer = document.getElementById("modalContainer");
        modalContainer.classList.remove("hidden");
        setTimeout(() => {
          document.getElementById("modalOverlay").classList.remove("opacity-0");
          document.getElementById("modalContent").classList.remove("scale-95");
        }, 10);
      }

      function hideModal() {
        const modalContainer = document.getElementById("modalContainer");
        document.getElementById("modalOverlay").classList.add("opacity-0");
        document.getElementById("modalContent").classList.add("scale-95");
        setTimeout(() => {
          modalContainer.classList.add("hidden");
        }, 300);
      }

      function showParameterHelpModal() {
        // 保存された現在地のデータを取得
        const state = currentAnalysisData.startState;
        // データがない場合はモーダルを開かない
        if (!state) {
          alert("先に「予測実行」ボタンを押して、分析を完了させてください。");
          return;
        }

        // --- 各スコアに対応する解説文を生成する ---
        const getDesc = (score, type) => {
          let highThreshold = 60;
          let lowThreshold = 40;

          // スコアのレベルを判定（リスクのみ評価が逆転）
          const getLevel = (currentScore, isReversed = false) => {
            if (currentScore >= highThreshold)
              return isReversed ? "low" : "high";
            if (currentScore <= lowThreshold)
              return isReversed ? "high" : "low";
            return "medium";
          };

          let explanation = "";
          const level = getLevel(score, type === "risk");

          switch (type) {
            case "kihon":
              if (level === "high")
                explanation = `状況の根本的なエネルギーが<strong class="text-green-300">充実している</strong>ことを示します。物事を推進するための力強い基盤がある状態です。`;
              else if (level === "low")
                explanation = `状況の根本的なエネルギーが<strong class="text-red-300">不足している</strong>ことを示します。物事を進める上での土台が弱く、苦労を伴う可能性があります。`;
              else
                explanation = `状況の根本的なエネルギーは<strong class="text-yellow-300">標準的</strong>です。安定はしていますが、エネルギーに大きな余裕があるわけではありません。`;
              break;
            case "potential":
              if (level === "high")
                explanation = `将来的な<strong class="text-green-300">成長の伸びしろが大きい</strong>ことを示します。現状を超えて大きく飛躍する可能性を秘めています。`;
              else if (level === "low")
                explanation = `将来的な<strong class="text-red-300">成長の伸びしろが限定的</strong>であることを示します。大きな飛躍よりも、現状の維持や改善がテーマとなります。`;
              else
                explanation = `将来的な<strong class="text-yellow-300">成長の伸びしろは標準的</strong>です。着実な前進は期待できますが、ブレークスルーには更なる要素が必要です。`;
              break;
            case "antei":
              if (level === "high")
                explanation = `状況が<strong class="text-green-300">非常に安定的</strong>であることを示します。外部からの影響を受けにくく、計画通りに物事を進めやすい状態です。`;
              else if (level === "low")
                explanation = `状況が<strong class="text-red-300">非常に不安定</strong>であることを示します。予期せぬ変化が起こりやすく、臨機応変な対応が求められます。`;
              else
                explanation = `状況の<strong class="text-yellow-300">安定性は標準的</strong>です。大きな動揺はありませんが、不測の事態への備えは必要です。`;
              break;
            case "risk":
              // リスクの説明ではlevelのhigh/lowが直感と合うように表示
              if (level === "high")
                explanation = `内在する<strong class="text-red-300">リスクが非常に高い</strong>ことを示します。重大な問題や困難が潜んでいるため、極めて慎重な判断が求められます。`;
              else if (level === "low")
                explanation = `内在する<strong class="text-green-300">リスクは低い</strong>状態です。目に見える障害は少なく、比較的安全に行動できます。`;
              else
                explanation = `内在する<strong class="text-yellow-300">リスクは標準的</strong>です。注意すべき点はありますが、過度に警戒する必要はありません。`;
              break;
            case "hendou":
              if (level === "high")
                explanation = `状況の<strong class="text-green-300">変動性が高い</strong>ことを示します。あなたの働きかけが結果に直結しやすく、状況をコントロールしやすい局面です。`;
              else if (level === "low")
                explanation = `状況の<strong class="text-red-300">変動性が低い</strong>ことを示します。状況が膠着しており、個人の力で変化を起こすのは困難かもしれません。`;
              else
                explanation = `状況の<strong class="text-yellow-300">変動性は標準的</strong>です。あなたの行動は影響を与えますが、結果が表れるまでには時間がかかる可能性があります。`;
              break;
          }
          return `<p class="text-sm mt-1">${explanation}</p>`;
        };

        const getShutaiDesc = (type) => {
          if (type === "能動") {
            return `この状況では<strong class="text-yellow-200">「能動的」</strong>なスタンスが有効とされます。あなた自身の意思決定と行動が、今後の展開を左右する重要な鍵となります。`;
          }
          return `この状況では<strong class="text-yellow-200">「受動的」</strong>なスタンスが有効とされます。自ら流れを作ろうとするより、環境やタイミングを見極めて対応することが求められます。`;
        };

        const helpContent = `
      <h2 class="text-2xl font-bold text-indigo-300 mb-6">パラメータの見方</h2>
      <div class="space-y-5 text-left">

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #93c5fd;">■ 基本スコア ${
                state.S1_基本スコア
              }点</h3>
              ${getDesc(state.S1_基本スコア, "kihon")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #6ee7b7;">■ 潜在力 (ポテンシャル) ${
                state.S2_ポテンシャル
              }点</h3>
              ${getDesc(state.S2_ポテンシャル, "potential")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #c4b5fd;">■ 安定性スコア ${
                state.S3_安定性スコア
              }点</h3>
              ${getDesc(state.S3_安定性スコア, "antei")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #fca5a5;">■ リスク ${
                state.S4_リスク
              }点</h3>
               ${getDesc(state.S4_リスク, "risk")}
          </div>

           <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #fde047;">■ 変動性スコア ${
                state.S6_変動性スコア
              }点</h3>
               ${getDesc(state.S6_変動性スコア, "hendou")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #e5e7eb;">■ 主体性</h3>
              <p class="text-sm mt-1">${getShutaiDesc(state.S5_主体性)}</p>
          </div>

      </div>
  `;
        showModal(helpContent);
      }
      // ▲▲▲ ここまで追加 ▲▲▲
      document.addEventListener("DOMContentLoaded", async () => {
        const loadingIndicator = document.getElementById("loadingIndicator");
        const reportContainer = document.getElementById("reportContainer");
        const errorIndicator = document.getElementById("errorIndicator");
        const resetButton = document.getElementById("resetAndGoBack");
        if (resetButton) {
          resetButton.addEventListener("click", (event) => {
            // デフォルトのリンク遷移を一旦停止
            event.preventDefault();

            // データを削除
            localStorage.removeItem("proFutureReportData");

            // リンク先に手動で遷移
            window.location.href = resetButton.href;
          });
        }
        // ▲▲▲ ここまで追加 ▲▲▲
        // 【追加】モーダル用のイベントリスナー
        document
          .getElementById("modalOverlay")
          .addEventListener("click", hideModal);
        document
          .getElementById("modalCloseBtn")
          .addEventListener("click", hideModal);
        document.body.addEventListener("click", function (event) {
          if (event.target.closest("#paramHelpBtn")) {
            showParameterHelpModal();
          }
        });
        try {
          const dbResponse = await fetch("/api/data");
          if (!dbResponse.ok)
            throw new Error("データベースの読み込みに失敗しました。");
          const apiData = await dbResponse.json();
          HAQEI_DATA = apiData.HAQEI_DATA;
        } catch (e) {
          errorIndicator.textContent =
            "データベースの読み込みに失敗しました。ページをリロードしてください。";
          loadingIndicator.classList.add("hidden");
          errorIndicator.classList.remove("hidden");
          return;
        }

        // ▼▼▼ ここから修正 ▼▼▼
        // localStorageからデータを正しく取得する処理
        const dataString = localStorage.getItem("proFutureReportData");
        if (!dataString) {
          errorIndicator.textContent =
            "レポートデータを取得できませんでした。前のページから再度お試しください。";
          loadingIndicator.classList.add("hidden");
          errorIndicator.classList.remove("hidden");
          return;
        }

        const reportData = JSON.parse(dataString);
        // ▲▲▲ ここまで修正 ▲▲▲

        worryDisplay.innerHTML = `<h3 class="font-bold text-indigo-300 mb-2">あなたの相談内容</h3><p class="text-gray-300 whitespace-pre-wrap text-lg leading-relaxed">${
          reportData.worry || "（相談内容がありません）"
        }</p>`;

        const startScore = reportData.paths[0][0].S7_総合評価スコア;
        const sortedPaths = reportData.paths.sort((a, b) => {
          const finalScoreA = a[3].S7_総合評価スコア,
            finalScoreB = b[3].S7_総合評価スコア;
          const growthScoreA = finalScoreA - startScore,
            growthScoreB = finalScoreB - startScore;
          const rankScoreA = finalScoreA * 0.7 + growthScoreA * 0.3;
          const rankScoreB = finalScoreB * 0.7 + growthScoreB * 0.3;
          return rankScoreB - rankScoreA;
        });

        renderSummaryCard(sortedPaths[0][0]);
        renderSummaryChart(sortedPaths);

        loadingIndicator.classList.remove("hidden");

        try {
          const response = await fetch("/api/pro-future-ai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              worry: reportData.worry,
              paths: sortedPaths,
            }),
          });
          if (!response.ok) {
            const errorJson = await response.json().catch(() => ({
              error: "サーバーから不明なエラーが返されました。",
            }));
            throw new Error(
              errorJson.error || `サーバーエラー: ${response.status}`
            );
          }
          const narratives = await response.json();

          renderChartToggles(sortedPaths, narratives);

          const rankLabels = ["S", "A", "B", "C", "D", "E", "F", "H"];
          let html = "";
          sortedPaths.slice(0, 8).forEach((path, index) => {
            const narrative = narratives?.[index] || {};
            const step_summaries = narrative.step_summaries || [];
            const transitions = narrative.transitions || [];

            const rankLabel = rankLabels?.[index] || "不明";
            const rankClass = `rank-${rankLabel?.toLowerCase()}`;
            const difficulty = calculateDifficulty(path);

            const stepCards = path.map((step, stepIndex) => {
              const hexInfo = getHexagramInfo(step.卦番号);
              const stepSummary =
                step_summaries[stepIndex] || "要約を生成できませんでした。";

              return `
                  <div class="step-card">
                      <div class="flex-grow">
                          <p class="text-sm font-semibold text-gray-400">${
                            ["現在地", "フェーズ1", "フェーズ2", "フェーズ3"][
                              stepIndex
                            ]
                          }</p>
                          <p class="font-bold text-xl text-indigo-300 mt-1">${
                            step["親となる卦"]
                          } ${step.爻}</p>
                          <div class="mt-4">
                              <h5 class="font-bold text-sm text-yellow-300">このフェーズでのあなたの状況</h5>
                              <p class="text-xs mt-1 p-2 bg-black/20 rounded-md text-gray-300">${stepSummary}</p>
                          </div>
                          <div class="mt-4">
                              <h5 class="font-bold text-sm text-yellow-300">この爻が示す普遍的な教訓</h5>
                              <p class="text-xs mt-1 text-gray-400">${
                                step.現代解釈の要約
                              }</p>
                          </div>
                      </div>
                      <div class="mt-4 pt-2 border-t border-gray-700/50">
                          <p class="text-xs text-cyan-400 font-semibold">テーマ: ${
                            step.キーワード || "情報なし"
                          }</p>
                      </div>
                  </div>
              `;
            });

            const transitionCards = path.slice(1).map((step, i) => {
              const isChange = step.choice === "change";
              const cardClass = isChange ? "transition-hen" : "transition-shin";
              const choiceTitle = isChange ? "【変】" : "【進】";
              const choiceDesc = isChange ? "状況を転換" : "テーマを深化";
              const guidelineText =
                transitions[i] || "行動指針を生成できませんでした。";

              return `
                  <div class="transition-card ${cardClass} w-48 self-center">
                      <div class="font-bold text-sm">${choiceTitle}</div>
                      <div class="hidden sm:block text-5xl text-gray-500 my-2">→</div>
                      <div class="sm:hidden text-2xl my-1">↓</div>
                      <p class="text-xs">${choiceDesc}</p>
                      <p class="text-xs mt-2 border-t border-current/30 pt-2">${guidelineText}</p>
                  </div>
              `;
            });

            let pathStepsHtml = "";
            for (let i = 0; i < stepCards.length; i++) {
              pathStepsHtml += stepCards[i];
              if (i < transitionCards.length)
                pathStepsHtml += transitionCards[i];
            }

            html += `
                  <div class="scenario-card" id="scenario-${index}">
                      <div class="flex items-start sm:items-center justify-between mb-4 flex-col sm:flex-row gap-4">
                          <h3 class="font-bold text-2xl text-cyan-300">
                              <span class="text-indigo-400">シナリオ ${
                                index + 1
                              }:</span>
                              ${narrative.scenario_title || "無題のシナリオ"}
                          </h3>
                          <div class="flex items-center gap-4">
                              <div class="text-right">
                                  <p class="text-xs text-gray-400">困難度</p>
                                  <p class="font-bold text-lg ${
                                    difficulty.color
                                  }">${difficulty.text}</p>
                              </div>
                              
                              <span class="rank-badge ${`rank-${rankLabels?.[
                                index
                              ]?.toLowerCase()}`}">${
              rankLabels?.[index] || "不明"
            }</span>
                          </div>
                      </div>
                      
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        <div class="prose-custom max-w-none">${
                          narrative.narrative || "概要の生成に失敗しました。"
                        }</div>

                        <div>
                          <h4 class="font-bold text-lg text-yellow-300 mb-2 flex items-center justify-between">
                            フェーズ3の状態
                            <button
                              class="text-yellow-400 hover:text-yellow-300 text-xl cursor-pointer focus:outline-none"
                              title="最終スコア解説"
                              data-scenario-index="${index}"
                              id="score-info-btn-${index}"
                            >
                              <span>⭐️</span>
                            </button>
                          </h4>
                          <div style="height: 160px;">
                            <canvas id="scenarioChart-${index}"></canvas>
                          </div>
                        </div>
                      </div>


                      <div class="mt-6 pt-4 border-t border-gray-700/50">
                          <h4 class="font-bold text-lg text-yellow-300">この未来での心構え</h4>
                          <p class="text-gray-400 mt-2">${
                            narrative.advice ||
                            "アドバイスの生成に失敗しました。"
                          }</p>
                      </div>

                      <div class="mt-8 pt-6 border-t border-gray-700/50">
                          <h4 class="font-bold text-lg text-indigo-300 mb-4">この未来に至るステップ</h4>
                          <div class="relative">
                              <div class="flex flex-row items-stretch gap-2 sm:gap-4 overflow-x-auto pb-4 pr-8">
                                  ${pathStepsHtml}
                              </div>
                              <div class="absolute top-1/2 right-0 -translate-y-1/2 bg-gradient-to-l from-gray-900 via-gray-900 to-transparent h-full w-20 pointer-events-none sm:flex items-center justify-end pr-4 hidden">
                                  <svg class="w-8 h-8 text-gray-400 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                              </div>
                          </div>
                      </div>
                  </div>
                  `;
          });
          reportContainer.innerHTML = html;
          reportContainer.classList.remove("hidden");

          renderAllScenarioCharts(sortedPaths);
          // ▼▼▼ ここから追加 ▼▼▼
          const scoreInfoButtons = document.querySelectorAll(
            '[id^="score-info-btn-"]'
          );
          scoreInfoButtons.forEach((button) => {
            button.addEventListener("click", function () {
              const scenarioIndex = this.dataset.scenarioIndex;
              const path = sortedPaths?.[scenarioIndex];
              if (path) {
                const finalState = path?.[3];
                const finalScore = finalState?.S7_総合評価スコア;
                const scoreEval = getScoreEvaluation(finalScore);
                const scenarioTitle =
                  narratives?.[scenarioIndex]?.scenario_title ||
                  `シナリオ ${parseInt(scenarioIndex) + 1}`;
                const modalContent = `
                  <h2 class="text-xl font-bold text-indigo-300 mb-4">${scenarioTitle} - 最終スコア解説</h2>
                  <p class="text-lg font-semibold text-yellow-300">最終スコア: <span class="${scoreEval.colorClass} px-2 py-1 rounded-md text-white">${finalScore}点 - ${scoreEval.label}</span></p>
                  <p class="text-gray-300 mt-4">${scoreEval.desc}</p>
                  <p class="text-sm text-gray-400 mt-2">詳細なパラメータは以下の通りです。</p>
                  <ul class="list-disc list-inside text-sm text-gray-400 mt-2">
                    <li>基本スコア: ${finalState?.S1_基本スコア}</li>
                    <li>潜在力: ${finalState?.S2_ポテンシャル}</li>
                    <li>安定性スコア: ${finalState?.S3_安定性スコア}</li>
                    <li>リスク: ${finalState?.S4_リスク}</li>
                    <li>変動性スコア: ${finalState?.S6_変動性スコア}</li>
                  </ul>
                `;
                showModal(modalContent);
              }
            });
          });
        } catch (err) {
          errorIndicator.textContent =
            "レポート生成エラー: " + (err.message || "不明なエラーです。");
          errorIndicator.classList.remove("hidden");
          console.error("レポート生成エラー:", err);
        } finally {
          loadingIndicator.classList.add("hidden");
        }
      });
    </script>
    <div
      id="modalContainer"
      class="fixed inset-0 z-50 flex items-center justify-center hidden"
    >
      <div
        id="modalOverlay"
        class="absolute inset-0 bg-black/70 opacity-0 transition-opacity duration-300"
      ></div>
      <div
        id="modalContent"
        class="bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-8 relative transform scale-95 transition-transform duration-300"
      >
        <button
          id="modalCloseBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <div id="modalBody"></div>
      </div>
    </div>
  </body>
</html>
