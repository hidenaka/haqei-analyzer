/**
 * User Error Manager - „É¶„Éº„Ç∂„Éº„Éï„É¨„É≥„Éâ„É™„Éº„Å™„Ç®„É©„ÉºÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†
 * bunenjinÂì≤Â≠¶: „Ç®„É©„Éº„ÇíÂ≠¶Áøí„Å®ÊàêÈï∑„ÅÆÊ©ü‰ºö„Å´Â§â„Åà„Çã
 */

class UserErrorManager {
  constructor() {
    this.errorHistory = [];
    this.errorTemplates = this.initializeErrorTemplates();
    this.recoveryStrategies = this.initializeRecoveryStrategies();
    this.userContext = {
      language: 'ja',
      experience: 'beginner', // beginner, intermediate, advanced
      preferences: {}
    };
    
    this.initializeErrorUI();
  }

  /**
   * „Ç®„É©„Éº„ÉÜ„É≥„Éó„É¨„Éº„Éà„ÅÆÂàùÊúüÂåñ
   */
  initializeErrorTemplates() {
    return {
      network: {
        title: '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„Ç®„É©„Éº',
        icon: 'üåê',
        severity: 'warning',
        categories: {
          offline: {
            message: '„Ç§„É≥„Çø„Éº„Éç„ÉÉ„ÉàÊé•Á∂ö„ÅåÂàáÊñ≠„Åï„Çå„Å¶„ÅÑ„Åæ„Åô',
            suggestion: '„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØÊé•Á∂ö„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
            actions: ['retry', 'offline_mode']
          },
          timeout: {
            message: 'ÈÄö‰ø°„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü',
            suggestion: 'ÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ',
            actions: ['retry', 'reduce_load']
          },
          server_error: {
            message: '„Çµ„Éº„Éê„Éº„Å´‰∏ÄÊôÇÁöÑ„Å™ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Åæ„Åô',
            suggestion: '„Åó„Å∞„Çâ„ÅèÊôÇÈñì„Çí„Åä„ÅÑ„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ',
            actions: ['retry', 'contact_support']
          }
        }
      },
      
      data: {
        title: '„Éá„Éº„Çø„Ç®„É©„Éº',
        icon: 'üìä',
        severity: 'error',
        categories: {
          invalid_input: {
            message: 'ÂÖ•Âäõ„Éá„Éº„Çø„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô',
            suggestion: 'ÂÖ•ÂäõÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„Åó„Å¶‰øÆÊ≠£„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
            actions: ['fix_input', 'reset_form']
          },
          missing_data: {
            message: 'ÂøÖË¶Å„Å™„Éá„Éº„Çø„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô',
            suggestion: '„Åô„Åπ„Å¶„ÅÆÂøÖÈ†àÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
            actions: ['complete_form', 'load_sample']
          },
          corrupted_data: {
            message: '„Éá„Éº„Çø„ÅåÁ†¥Êêç„Åó„Å¶„ÅÑ„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çä„Åæ„Åô',
            suggestion: 'ÂàùÊúüÁä∂ÊÖã„Å´Êàª„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ',
            actions: ['reset_data', 'contact_support']
          }
        }
      },
      
      analysis: {
        title: 'ÂàÜÊûê„Ç®„É©„Éº',
        icon: 'üîç',
        severity: 'warning',
        categories: {
          insufficient_answers: {
            message: 'ÂõûÁ≠îÊï∞„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô',
            suggestion: '„Çà„ÇäÂ§ö„Åè„ÅÆË≥™Âïè„Å´ÂõûÁ≠î„Åô„Çã„Åì„Å®„Åß„ÄÅ„Çà„ÇäÊ≠£Á¢∫„Å™ÂàÜÊûê„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„Åô',
            actions: ['continue_answering', 'partial_analysis']
          },
          conflicting_data: {
            message: 'ÁüõÁõæ„Åô„ÇãÂõûÁ≠î„ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü',
            suggestion: '‰∏ÄË≤´ÊÄß„ÅÆ„ÅÇ„ÇãÂõûÁ≠î„Çí„ÅäÈ°ò„ÅÑ„Åó„Åæ„Åô',
            actions: ['review_answers', 'guided_review']
          },
          calculation_error: {
            message: 'ÂàÜÊûêË®àÁÆó„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü',
            suggestion: '‰∏ÄÂ∫¶„É™„Çª„ÉÉ„Éà„Åó„Å¶ÂÜçÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ',
            actions: ['retry_analysis', 'reset_session']
          }
        }
      },
      
      ui: {
        title: '„Ç§„É≥„Çø„Éº„Éï„Çß„Éº„Çπ„Ç®„É©„Éº',
        icon: 'üñºÔ∏è',
        severity: 'info',
        categories: {
          render_error: {
            message: 'ÁîªÈù¢Ë°®Á§∫„Å´ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü',
            suggestion: '„Éö„Éº„Ç∏„ÇíÊõ¥Êñ∞„Åô„Çã„Åã„ÄÅ„Éñ„É©„Ç¶„Ç∂„ÇíÂ§âÊõ¥„Åó„Å¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ',
            actions: ['refresh_page', 'switch_browser']
          },
          interaction_error: {
            message: 'Êìç‰Ωú„ÅåÊ≠£Â∏∏„Å´ÂÆüË°å„Åï„Çå„Åæ„Åõ„Çì„Åß„Åó„Åü',
            suggestion: '„ÇÇ„ÅÜ‰∏ÄÂ∫¶Êìç‰Ωú„Çí„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ',
            actions: ['retry_action', 'alternative_method']
          }
        }
      }
    };
  }

  /**
   * ÂõûÂæ©Êà¶Áï•„ÅÆÂàùÊúüÂåñ
   */
  initializeRecoveryStrategies() {
    return {
      retry: {
        label: 'ÂÜçË©¶Ë°å',
        icon: 'üîÑ',
        action: (context) => {
          if (context.retryCallback) {
            context.retryCallback();
          }
        }
      },
      
      offline_mode: {
        label: '„Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„Å´Âàá„ÇäÊõø„Åà',
        icon: 'üì±',
        action: (context) => {
          this.enableOfflineMode();
        }
      },
      
      reset_data: {
        label: '„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà',
        icon: 'üîÑ',
        action: (context) => {
          if (confirm('„Éá„Éº„Çø„Çí„É™„Çª„ÉÉ„Éà„Åó„Å¶„ÇÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')) {
            localStorage.clear();
            location.reload();
          }
        }
      },
      
      contact_support: {
        label: '„Çµ„Éù„Éº„Éà„Å´ÈÄ£Áµ°',
        icon: 'üí¨',
        action: (context) => {
          this.showSupportModal(context.error);
        }
      },
      
      guided_review: {
        label: '„Ç¨„Ç§„Éâ‰ªò„ÅçË¶ãÁõ¥„Åó',
        icon: 'üß≠',
        action: (context) => {
          this.startGuidedReview();
        }
      }
    };
  }

  /**
   * „Ç®„É©„ÉºUIË¶ÅÁ¥†„ÅÆÂàùÊúüÂåñ
   */
  initializeErrorUI() {
    if (!document.getElementById('error-notification-styles')) {
      const style = document.createElement('style');
      style.id = 'error-notification-styles';
      style.textContent = `
        .error-notification {
          position: fixed;
          top: 20px;
          right: 20px;
          max-width: 400px;
          background: rgba(15, 23, 42, 0.95);
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
          backdrop-filter: blur(20px);
          z-index: 9999;
          animation: slideInRight 0.3s ease-out;
          border-left: 4px solid;
        }
        
        .error-notification.severity-error {
          border-left-color: #ef4444;
        }
        
        .error-notification.severity-warning {
          border-left-color: #f59e0b;
        }
        
        .error-notification.severity-info {
          border-left-color: #3b82f6;
        }
        
        .error-header {
          display: flex;
          align-items: center;
          gap: 8px;
          padding: 16px 16px 8px 16px;
          font-weight: 600;
          color: #f1f5f9;
        }
        
        .error-icon {
          font-size: 1.25rem;
        }
        
        .error-content {
          padding: 0 16px 16px 16px;
        }
        
        .error-message {
          color: #cbd5e1;
          margin-bottom: 8px;
          line-height: 1.5;
        }
        
        .error-suggestion {
          color: #94a3b8;
          font-size: 0.875rem;
          margin-bottom: 12px;
          font-style: italic;
        }
        
        .error-actions {
          display: flex;
          gap: 8px;
          flex-wrap: wrap;
        }
        
        .error-action-btn {
          padding: 6px 12px;
          border: 1px solid rgba(99, 102, 241, 0.3);
          border-radius: 6px;
          background: rgba(99, 102, 241, 0.1);
          color: #a5b4fc;
          font-size: 0.75rem;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          gap: 4px;
        }
        
        .error-action-btn:hover {
          background: rgba(99, 102, 241, 0.2);
          border-color: rgba(99, 102, 241, 0.5);
        }
        
        .error-close {
          position: absolute;
          top: 12px;
          right: 12px;
          background: none;
          border: none;
          color: #64748b;
          cursor: pointer;
          font-size: 1.125rem;
          transition: color 0.2s ease;
        }
        
        .error-close:hover {
          color: #f1f5f9;
        }
        
        @keyframes slideInRight {
          from {
            transform: translateX(100%);
            opacity: 0;
          }
          to {
            transform: translateX(0);
            opacity: 1;
          }
        }
        
        @media (max-width: 768px) {
          .error-notification {
            top: 10px;
            right: 10px;
            left: 10px;
            max-width: none;
          }
        }
        
        .support-modal {
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.8);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
        }
        
        .support-modal-content {
          background: linear-gradient(135deg, #1e293b, #334155);
          border-radius: 12px;
          padding: 24px;
          max-width: 500px;
          width: 90%;
          color: #f1f5f9;
        }
      `;
      document.head.appendChild(style);
    }
  }

  /**
   * „Ç®„É©„ÉºË°®Á§∫
   */
  displayError(error, options = {}) {
    const errorInfo = this.categorizeError(error);
    const notification = this.createErrorNotification(errorInfo, options);
    
    document.body.appendChild(notification);
    
    // „Ç®„É©„ÉºÂ±•Ê≠¥„Å´ËøΩÂä†
    this.errorHistory.push({
      timestamp: new Date().toISOString(),
      error: errorInfo,
      userAction: null
    });
    
    // Ëá™ÂãïÂâäÈô§„Çø„Ç§„Éû„Éº
    const autoRemoveDelay = this.getSeverityTimeout(errorInfo.severity);
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, autoRemoveDelay);
    
    return notification;
  }

  /**
   * „Ç®„É©„Éº„ÅÆÂàÜÈ°û
   */
  categorizeError(error) {
    let category = 'ui';
    let subcategory = 'render_error';
    
    if (error.name === 'NetworkError' || error.message?.includes('fetch')) {
      category = 'network';
      if (error.message?.includes('timeout')) {
        subcategory = 'timeout';
      } else if (!navigator.onLine) {
        subcategory = 'offline';
      } else {
        subcategory = 'server_error';
      }
    } else if (error.name === 'TypeError' || error.message?.includes('data')) {
      category = 'data';
      if (error.message?.includes('invalid')) {
        subcategory = 'invalid_input';
      } else if (error.message?.includes('missing')) {
        subcategory = 'missing_data';
      } else {
        subcategory = 'corrupted_data';
      }
    } else if (error.message?.includes('analysis') || error.message?.includes('calculation')) {
      category = 'analysis';
      subcategory = 'calculation_error';
    }
    
    const template = this.errorTemplates[category];
    const details = template.categories[subcategory];
    
    return {
      category,
      subcategory,
      title: template.title,
      icon: template.icon,
      severity: template.severity,
      message: details.message,
      suggestion: details.suggestion,
      actions: details.actions,
      originalError: error
    };
  }

  /**
   * „Ç®„É©„ÉºÈÄöÁü•„ÅÆ‰ΩúÊàê
   */
  createErrorNotification(errorInfo, options) {
    const notification = document.createElement('div');
    notification.className = `error-notification severity-${errorInfo.severity}`;
    
    const actionsHTML = errorInfo.actions.map(actionId => {
      const strategy = this.recoveryStrategies[actionId];
      if (!strategy) return '';
      
      return `
        <button class="error-action-btn" data-action="${actionId}">
          <span>${strategy.icon}</span>
          <span>${strategy.label}</span>
        </button>
      `;
    }).join('');
    
    notification.innerHTML = `
      <button class="error-close" aria-label="„Ç®„É©„Éº„ÇíÈñâ„Åò„Çã">√ó</button>
      <div class="error-header">
        <span class="error-icon">${errorInfo.icon}</span>
        <span class="error-title">${errorInfo.title}</span>
      </div>
      <div class="error-content">
        <div class="error-message">${errorInfo.message}</div>
        <div class="error-suggestion">${errorInfo.suggestion}</div>
        <div class="error-actions">
          ${actionsHTML}
        </div>
      </div>
    `;
    
    // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
    this.setupNotificationEvents(notification, errorInfo, options);
    
    return notification;
  }

  /**
   * ÈÄöÁü•„Ç§„Éô„É≥„Éà„ÅÆË®≠ÂÆö
   */
  setupNotificationEvents(notification, errorInfo, options) {
    // Èñâ„Åò„Çã„Éú„Çø„É≥
    const closeBtn = notification.querySelector('.error-close');
    closeBtn.addEventListener('click', () => {
      notification.remove();
    });
    
    // „Ç¢„ÇØ„Ç∑„Éß„É≥„Éú„Çø„É≥
    const actionBtns = notification.querySelectorAll('.error-action-btn');
    actionBtns.forEach(btn => {
      btn.addEventListener('click', (e) => {
        const actionId = e.currentTarget.dataset.action;
        const strategy = this.recoveryStrategies[actionId];
        
        if (strategy) {
          strategy.action({
            error: errorInfo,
            retryCallback: options.retryCallback,
            context: options.context
          });
          
          // „É¶„Éº„Ç∂„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥„ÇíÂ±•Ê≠¥„Å´Ë®òÈå≤
          const lastError = this.errorHistory[this.errorHistory.length - 1];
          if (lastError) {
            lastError.userAction = actionId;
          }
          
          notification.remove();
        }
      });
    });
  }

  /**
   * ÈáçË¶ÅÂ∫¶Âà•„ÅÆ„Çø„Ç§„É†„Ç¢„Ç¶„ÉàÊôÇÈñìÂèñÂæó
   */
  getSeverityTimeout(severity) {
    const timeouts = {
      error: 10000,    // 10Áßí
      warning: 7000,   // 7Áßí
      info: 5000       // 5Áßí
    };
    return timeouts[severity] || 5000;
  }

  /**
   * „Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„ÅÆÊúâÂäπÂåñ
   */
  enableOfflineMode() {
    console.log('„Ç™„Éï„É©„Ç§„É≥„É¢„Éº„Éâ„ÇíÊúâÂäπÂåñ„Åó„Åæ„Åó„Åü');
    // „Ç™„Éï„É©„Ç§„É≥Ê©üËÉΩ„ÅÆÂÆüË£Ö
  }

  /**
   * „Çµ„Éù„Éº„Éà„É¢„Éº„ÉÄ„É´„ÅÆË°®Á§∫
   */
  showSupportModal(errorInfo) {
    const modal = document.createElement('div');
    modal.className = 'support-modal';
    
    modal.innerHTML = `
      <div class="support-modal-content">
        <h3>„Çµ„Éù„Éº„Éà„Å´„ÅäÂïè„ÅÑÂêà„Çè„Åõ</h3>
        <p>‰ª•‰∏ã„ÅÆÊÉÖÂ†±„Åå„Çµ„Éù„Éº„Éà„ÉÅ„Éº„É†„Å´ÈÄÅ‰ø°„Åï„Çå„Åæ„ÅôÔºö</p>
        <ul>
          <li>„Ç®„É©„Éº„ÅÆÁ®ÆÈ°û: ${errorInfo.title}</li>
          <li>Áô∫ÁîüÊôÇÂàª: ${new Date().toLocaleString('ja-JP')}</li>
          <li>„Éñ„É©„Ç¶„Ç∂: ${navigator.userAgent}</li>
        </ul>
        <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
          <button class="btn btn-secondary" onclick="this.closest('.support-modal').remove()">
            „Ç≠„É£„É≥„Çª„É´
          </button>
          <button class="btn" onclick="alert('„Çµ„Éù„Éº„Éà„Å´ÈÄ£Áµ°„Åó„Åæ„Åó„Åü'); this.closest('.support-modal').remove()">
            ÈÄÅ‰ø°
          </button>
        </div>
      </div>
    `;
    
    document.body.appendChild(modal);
  }

  /**
   * „Ç¨„Ç§„Éâ‰ªò„Åç„É¨„Éì„É•„Éº„ÅÆÈñãÂßã
   */
  startGuidedReview() {
    console.log('„Ç¨„Ç§„Éâ‰ªò„Åç„É¨„Éì„É•„Éº„ÇíÈñãÂßã„Åó„Åæ„Åô');
    // „Ç¨„Ç§„ÉâÊ©üËÉΩ„ÅÆÂÆüË£Ö
  }

  /**
   * „Ç®„É©„ÉºÂ±•Ê≠¥„ÅÆÂèñÂæó
   */
  getErrorHistory() {
    return this.errorHistory;
  }

  /**
   * „Ç®„É©„ÉºÁµ±Ë®à„ÅÆÂèñÂæó
   */
  getErrorStatistics() {
    const stats = {
      total: this.errorHistory.length,
      byCategory: {},
      bySeverity: {},
      resolved: 0
    };
    
    this.errorHistory.forEach(entry => {
      const category = entry.error.category;
      const severity = entry.error.severity;
      
      stats.byCategory[category] = (stats.byCategory[category] || 0) + 1;
      stats.bySeverity[severity] = (stats.bySeverity[severity] || 0) + 1;
      
      if (entry.userAction) {
        stats.resolved++;
      }
    });
    
    return stats;
  }
}

// „Ç∞„É≠„Éº„Éê„É´Âà©Áî®„ÅÆ„Åü„ÇÅ„ÅÆ„Ç®„ÇØ„Çπ„Éù„Éº„Éà
window.UserErrorManager = UserErrorManager;

// „Éá„Éï„Ç©„É´„Éà„ÅÆ„Ç∞„É≠„Éº„Éê„É´„Ç®„É©„Éº„Éè„É≥„Éâ„É©„Éº„Å®„Åó„Å¶Ë®≠ÂÆö
const globalErrorManager = new UserErrorManager();

window.addEventListener('error', (event) => {
  globalErrorManager.displayError(event.error || new Error(event.message));
});

window.addEventListener('unhandledrejection', (event) => {
  globalErrorManager.displayError(new Error(`PromiseÊãíÂê¶: ${event.reason}`));
});