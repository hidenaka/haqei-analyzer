/**
 * Critical Layout Fix CSS - 最重要レイアウト修正
 * 見切れ問題の完全解決とクロスブラウザ対応
 */

/* ========================================
   最優先修正: ビューポート基本設定
   ======================================== */

/* ブラウザ間の差異を完全に統一 */
* {
  box-sizing: border-box !important;
}

html {
  /* ビューポート確定 */
  width: 100%;
  height: 100%;
  /* 水平スクロール完全禁止 */
  overflow-x: hidden !important;
  /* iOS Safari 対応 */
  -webkit-text-size-adjust: 100%;
  -ms-text-size-adjust: 100%;
}

body {
  /* 基本サイズ確定 */
  width: 100vw;
  max-width: 100% !important;
  min-height: 100vh;
  /* Safari 100vh バグ対応 */
  min-height: -webkit-fill-available;
  
  /* マージン・パディング完全リセット */
  margin: 0 !important;
  padding: 0 !important;
  
  /* 水平スクロール禁止 */
  overflow-x: hidden !important;
  overflow-y: auto;
  
  /* レイアウト基盤 */
  position: relative;
}

/* ========================================
   最重要: アプリケーションコンテナ
   ======================================== */

.app-container {
  /* 確実な全画面占有 */
  width: 100vw;
  max-width: 100% !important;
  min-height: 100vh;
  min-height: -webkit-fill-available;
  
  /* 配置とマージン */
  position: relative;
  margin: 0 !important;
  padding: 0 !important;
  
  /* 子要素制御 */
  overflow-x: hidden !important;
  overflow-y: auto;
  
  /* iOS Safe Area 対応 */
  padding-top: env(safe-area-inset-top);
  padding-bottom: env(safe-area-inset-bottom);
  padding-left: env(safe-area-inset-left);
  padding-right: env(safe-area-inset-right);
}

/* ========================================
   画面コンテナの統一設定
   ======================================== */

.screen-container {
  /* 基本サイズ */
  width: 100% !important;
  max-width: 100vw !important;
  min-height: calc(100vh - env(safe-area-inset-top) - env(safe-area-inset-bottom));
  
  /* レイアウト */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  
  /* 内側スペース（安全マージン） */
  padding: clamp(0.5rem, 2vw, 1.5rem);
  
  /* ボックスモデル */
  margin: 0 !important;
  box-sizing: border-box !important;
  overflow-x: hidden !important;
  
  /* 配置 */
  position: relative;
}

/* 非表示状態の確実な制御 */
.screen-container:not(.visible):not(.active) {
  display: none !important;
}

.screen-container.visible,
.screen-container.active {
  display: flex !important;
  opacity: 1 !important;
}

/* ========================================
   進捗バーの確実な配置
   ======================================== */

.global-progress {
  /* 最上部固定 */
  position: fixed !important;
  top: 0;
  left: 0;
  right: 0;
  
  /* iOS Safe Area 対応 */
  top: env(safe-area-inset-top);
  
  /* 幅と高さ */
  width: 100% !important;
  max-width: 100vw !important; 
  height: 6px;
  
  /* 最前面 */
  z-index: 1000;
  
  /* 背景 */
  background: rgba(0, 0, 0, 0.1);
  
  /* ボックスモデル */
  margin: 0 !important;
  padding: 0 !important;
  box-sizing: border-box !important;
}

.progress-bar {
  height: 100%;
  max-width: 100% !important;
  background: linear-gradient(90deg, #007bff 0%, #0056b3 100%);
  transition: width 0.3s ease;
  border-radius: 0;
}

/* ========================================
   メインコンテンツエリア
   ======================================== */

#welcome-container,
#questions-container,
#analysis-container,
#results-container,
#insights-container {
  /* 進捗バー分のマージン */
  margin-top: calc(6px + env(safe-area-inset-top)) !important;
  
  /* 基本レイアウト */
  width: 100% !important;
  max-width: 100vw !important;
  min-height: calc(100vh - 6px - env(safe-area-inset-top) - env(safe-area-inset-bottom)) !important;
  
  /* 内側スペース */
  padding: clamp(1rem, 4vw, 2rem) !important;
  
  /* ボックスモデル */
  box-sizing: border-box !important;
  overflow-x: hidden !important;
  
  /* フレックス設定 */
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
}

/* ========================================
   質問表示エリアの修正
   ======================================== */

.question-container {
  /* 最大幅の安全設定 */
  width: 100%;
  max-width: min(800px, calc(100vw - 2rem)) !important;
  
  /* 内側レイアウト */
  padding: clamp(1rem, 4vw, 2rem);
  margin: 0 auto clamp(1rem, 4vw, 2rem) auto;
  
  /* ボックスモデル */
  box-sizing: border-box !important;
  
  /* 背景と装飾 */
  background: rgba(255, 255, 255, 0.95);
  border-radius: clamp(0.5rem, 2vw, 1rem);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
  backdrop-filter: blur(10px);
  
  /* 見切れ防止 */
  overflow: visible;
  position: relative;
}

/* ========================================
   質問タイトルの修正
   ======================================== */

.question-title {
  /* サイズ */
  width: 100%;
  max-width: 100% !important;
  
  /* テキスト */
  font-size: clamp(1.125rem, 4vw, 1.75rem);
  line-height: 1.4;
  text-align: center;
  
  /* スペース */
  margin: 0 0 clamp(1rem, 4vw, 1.5rem) 0 !important;
  padding: 0 !important;
  
  /* テキスト制御 */
  word-wrap: break-word;
  overflow-wrap: break-word;
  hyphens: auto;
}

/* ========================================
   選択肢コンテナの修正
   ======================================== */

.question-options-container {
  /* レイアウト */
  width: 100% !important;
  max-width: 100% !important;
  
  /* フレックス */
  display: flex;
  flex-direction: column;
  gap: clamp(0.5rem, 2vw, 0.75rem);
  
  /* スペース */
  margin: clamp(1rem, 3vw, 1.5rem) 0 !important;
  padding: 0 !important;
  
  /* ボックスモデル */
  box-sizing: border-box !important;
}

.question-option {
  /* サイズ */
  width: 100% !important;
  max-width: 100% !important;
  min-height: 44px;
  
  /* 内側スペース */
  padding: clamp(0.75rem, 3vw, 1rem) clamp(1rem, 4vw, 1.25rem) !important;
  
  /* ボックスモデル */
  box-sizing: border-box !important;
  
  /* テキスト制御 */
  word-wrap: break-word;
  overflow-wrap: break-word;
  white-space: normal;
  
  /* 見た目 */
  background: #ffffff;
  border: 2px solid #e9ecef;
  border-radius: clamp(0.375rem, 1.5vw, 0.5rem);
  
  /* テキスト */
  font-size: clamp(0.875rem, 3vw, 1rem);
  line-height: 1.5;
  text-align: left;
  
  /* インタラクション */
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
}

.question-option:hover {
  border-color: #007bff;
  box-shadow: 0 2px 8px rgba(0, 123, 255, 0.15);
  transform: translateY(-1px);
}

.question-option.selected {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
  border-color: #0056b3;
  box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
}

/* ========================================
   ナビゲーションボタンの修正
   ======================================== */

.navigation-buttons {
  /* サイズ */
  width: 100% !important;
  max-width: min(500px, calc(100vw - 2rem)) !important;
  
  /* レイアウト */
  display: flex;
  gap: clamp(0.5rem, 2vw, 1rem);
  
  /* スペース */
  margin: clamp(1.5rem, 4vw, 2rem) auto 0 auto !important;
  padding: 0 0 env(safe-area-inset-bottom) 0 !important;
  
  /* ボックスモデル */
  box-sizing: border-box !important;
}

.navigation-buttons .btn {
  /* サイズ */
  flex: 1;
  min-height: 44px;
  max-height: 52px;
  
  /* 内側スペース */
  padding: clamp(0.75rem, 3vw, 1rem) clamp(1rem, 4vw, 1.25rem) !important;
  
  /* ボックスモデル */
  box-sizing: border-box !important;
  
  /* テキスト */
  font-size: clamp(0.875rem, 3vw, 1rem);
  font-weight: 600;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  
  /* 見た目 */
  border: none;
  border-radius: clamp(0.375rem, 2vw, 1rem);
  
  /* インタラクション */
  cursor: pointer;
  transition: all 0.2s ease;
  user-select: none;
}

.btn-primary {
  background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
  color: white;
}

.btn-secondary {
  background: #ffffff;
  color: #6c757d;
  border: 2px solid #6c757d !important;
}

.btn:hover {
  transform: translateY(-1px);
}

.btn:active {
  transform: translateY(0);
}

/* ========================================
   超小型画面対応 (iPhone SE等)
   ======================================== */

@media (max-width: 375px) {
  .question-container {
    max-width: calc(100vw - 1rem) !important;
    padding: 0.75rem !important;
    margin: 0 0.5rem 1rem 0.5rem !important;
  }
  
  .question-title {
    font-size: 1rem !important;
    margin-bottom: 0.75rem !important;
  }
  
  .question-option {
    padding: 0.625rem 0.75rem !important;
    font-size: 0.8125rem !important;
  }
  
  .navigation-buttons {
    flex-direction: column;
    gap: 0.5rem !important;
    max-width: calc(100vw - 1rem) !important;
  }
  
  .navigation-buttons .btn {
    min-height: 40px !important;
    font-size: 0.8125rem !important;
  }
}

/* ========================================
   ランドスケープ対応（小画面）
   ======================================== */

@media (orientation: landscape) and (max-height: 500px) {
  .screen-container {
    justify-content: flex-start !important;
    padding-top: 0.5rem !important;
  }
  
  .question-container {
    margin: 0.5rem auto !important;
    padding: 1rem !important;
  }
  
  .question-title {
    font-size: 1rem !important;
    margin-bottom: 0.75rem !important;
  }
  
  .navigation-buttons {
    margin-top: 1rem !important;
  }
}

/* ========================================
   iPad Safari 特別対応
   ======================================== */

@media (min-width: 768px) and (max-width: 1024px) {
  .question-container {
    max-width: 700px !important;
    padding: 2rem !important;
  }
  
  .question-title {
    font-size: 1.5rem !important;
  }
  
  .question-option {
    padding: 1rem 1.25rem !important;
    font-size: 1rem !important;
  }
  
  .navigation-buttons {
    max-width: 400px !important;
  }
}

/* ========================================
   デバッグモード（開発時）
   ======================================== */

.debug-layout {
  /* 境界線表示 */
  .app-container { outline: 3px solid red !important; }
  .screen-container { outline: 2px solid blue !important; }
  .question-container { outline: 2px solid green !important; }
  .question-option { outline: 1px solid orange !important; }
  .navigation-buttons { outline: 1px solid purple !important; }
  
  /* サイズ情報表示 */
  *::before {
    content: attr(class);
    position: absolute;
    top: 0;
    left: 0;
    background: rgba(0, 0, 0, 0.8);
    color: white;
    font-size: 10px;
    padding: 2px 4px;
    z-index: 9999;
    pointer-events: none;
  }
}