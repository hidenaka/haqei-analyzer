<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker ãƒ†ã‚¹ãƒˆ - Tsumiki TDDå“è³ªä¿è¨¼</title>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            max-width: 800px; 
            margin: 0 auto; 
            padding: 20px;
            line-height: 1.6;
        }
        .test-container { 
            border: 2px solid #e1e5e9; 
            border-radius: 12px; 
            padding: 24px; 
            margin: 20px 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        }
        .success { border-color: #10b981; background: linear-gradient(135deg, #ecfdf5 0%, #f0fdf4 100%); }
        .error { border-color: #ef4444; background: linear-gradient(135deg, #fef2f2 0%, #fefef2 100%); }
        .test-log { 
            background: #1e293b; 
            color: #e2e8f0; 
            padding: 16px; 
            border-radius: 8px; 
            font-family: 'Monaco', monospace; 
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background-color: #10b981; }
        .status-error { background-color: #ef4444; }
        .status-pending { background-color: #f59e0b; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin: 20px 0;
        }
        .metric-card {
            padding: 16px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .metric-value {
            font-size: 24px;
            font-weight: 700;
            color: #1e293b;
        }
        .metric-label {
            font-size: 14px;
            color: #64748b;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ HAQEI Service Worker - Tsumikiå“è³ªä¿è¨¼ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <h2>ğŸ“Š çµ±è¨ˆçš„å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹</h2>
        <div class="metrics-grid">
            <div class="metric-card">
                <div class="metric-value" id="coverage-rate">--%</div>
                <div class="metric-label">è¦ä»¶ç¶²ç¾…ç‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="success-rate">--%</div>
                <div class="metric-label">ãƒ†ã‚¹ãƒˆæˆåŠŸç‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="error-rate">--%</div>
                <div class="metric-label">ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿç‡</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="confidence-level">--</div>
                <div class="metric-label">ä¿¡é ¼åŒºé–“ä¸‹é™</div>
            </div>
        </div>
    </div>

    <div class="test-container" id="sw-registration">
        <h2>
            <span class="status-indicator status-pending" id="sw-status"></span>
            Service Worker ç™»éŒ²ãƒ†ã‚¹ãƒˆ
        </h2>
        <div id="sw-result">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>
    </div>

    <div class="test-container" id="resource-test">
        <h2>
            <span class="status-indicator status-pending" id="resource-status"></span>
            Critical Resources ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
        </h2>
        <div id="resource-result">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>
    </div>

    <div class="test-container" id="cache-test">
        <h2>
            <span class="status-indicator status-pending" id="cache-status"></span>
            Triple OS Cacheãƒ†ã‚¹ãƒˆ
        </h2>
        <div id="cache-result">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>
    </div>

    <div class="test-container">
        <h2>ğŸ” è©³ç´°ãƒ­ã‚°</h2>
        <div class="test-log" id="test-log"></div>
    </div>

    <script>
        // bunenjinå“²å­¦çµ±åˆãƒ†ã‚¹ãƒˆãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯
        class TsumikiServiceWorkerTester {
            constructor() {
                this.testResults = [];
                this.totalTests = 0;
                this.passedTests = 0;
                this.log = document.getElementById('test-log');
                this.startTime = Date.now();
            }

            logMessage(message, type = 'info') {
                const timestamp = new Date().toISOString();
                const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
                this.log.textContent += logEntry;
                this.log.scrollTop = this.log.scrollHeight;
                
                console.log(`%c${logEntry}`, 
                    type === 'error' ? 'color: #ef4444' :
                    type === 'success' ? 'color: #10b981' :
                    type === 'warning' ? 'color: #f59e0b' : 'color: #64748b'
                );
            }

            updateStatus(elementId, success, message) {
                const container = document.getElementById(elementId);
                const statusIndicator = container.querySelector('.status-indicator');
                const resultDiv = container.querySelector('div:last-child');
                
                if (success) {
                    container.classList.add('success');
                    statusIndicator.className = 'status-indicator status-success';
                    this.passedTests++;
                } else {
                    container.classList.add('error');
                    statusIndicator.className = 'status-indicator status-error';
                }
                
                resultDiv.innerHTML = message;
                this.totalTests++;
                this.updateMetrics();
            }

            updateMetrics() {
                const successRate = this.totalTests > 0 ? (this.passedTests / this.totalTests * 100) : 0;
                const errorRate = 100 - successRate;
                const coverageRate = Math.min(this.totalTests / 3 * 100, 100); // 3 = å¿…é ˆãƒ†ã‚¹ãƒˆæ•°
                const confidenceLevel = successRate >= 95 ? (3.5 + (successRate - 95) * 0.1) : (successRate / 95 * 3.5);

                document.getElementById('coverage-rate').textContent = `${coverageRate.toFixed(1)}%`;
                document.getElementById('success-rate').textContent = `${successRate.toFixed(1)}%`;
                document.getElementById('error-rate').textContent = `${errorRate.toFixed(1)}%`;
                document.getElementById('confidence-level').textContent = confidenceLevel.toFixed(2);
            }

            async runAllTests() {
                this.logMessage('ğŸš€ Tsumiki Service Workerå“è³ªä¿è¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                this.logMessage('bunenjinå“²å­¦çµ±åˆ - Triple OS Architectureå¯¾å¿œ', 'info');
                
                await this.testServiceWorkerRegistration();
                await this.testCriticalResources();
                await this.testTripleOSCache();
                
                this.logMessage(`âœ… å…¨ãƒ†ã‚¹ãƒˆå®Œäº† - å®Ÿè¡Œæ™‚é–“: ${Date.now() - this.startTime}ms`, 'success');
                this.generateFinalReport();
            }

            async testServiceWorkerRegistration() {
                this.logMessage('Phase 1: Service Workerç™»éŒ²ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                try {
                    if (!('serviceWorker' in navigator)) {
                        throw new Error('Service Worker not supported');
                    }

                    const registration = await navigator.serviceWorker.register('/haqei-sw.js');
                    this.logMessage(`Service Workerç™»éŒ²æˆåŠŸ: ${registration.scope}`, 'success');
                    
                    // ã‚¢ã‚¯ãƒ†ã‚£ãƒ™ãƒ¼ã‚·ãƒ§ãƒ³å¾…æ©Ÿ
                    await new Promise((resolve) => {
                        if (registration.active) {
                            resolve();
                        } else {
                            registration.addEventListener('statechange', () => {
                                if (registration.active) resolve();
                            });
                        }
                    });

                    this.updateStatus('sw-registration', true, 
                        `âœ… ç™»éŒ²æˆåŠŸ<br>Scope: ${registration.scope}<br>State: ${registration.active?.state || 'activating'}`);
                    
                } catch (error) {
                    this.logMessage(`Service Workerç™»éŒ²å¤±æ•—: ${error.message}`, 'error');
                    this.updateStatus('sw-registration', false, 
                        `âŒ ç™»éŒ²å¤±æ•—<br>Error: ${error.message}`);
                }
            }

            async testCriticalResources() {
                this.logMessage('Phase 2: Critical Resources ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                const criticalResources = [
                    '/js/shared/core/BaseComponent.js',
                    '/js/shared/core/MicroStorageManager.js',
                    '/js/shared/core/MicroDataManager.js',
                    '/js/shared/data/questions.js'
                ];

                let successCount = 0;
                const results = [];

                for (const resource of criticalResources) {
                    try {
                        const response = await fetch(resource);
                        if (response.ok) {
                            successCount++;
                            results.push(`âœ… ${resource}`);
                            this.logMessage(`Resource accessible: ${resource}`, 'success');
                        } else {
                            results.push(`âŒ ${resource} (${response.status})`);
                            this.logMessage(`Resource failed: ${resource} - ${response.status}`, 'error');
                        }
                    } catch (error) {
                        results.push(`âŒ ${resource} (${error.message})`);
                        this.logMessage(`Resource error: ${resource} - ${error.message}`, 'error');
                    }
                }

                const success = successCount === criticalResources.length;
                this.updateStatus('resource-test', success,
                    `${successCount}/${criticalResources.length} ãƒªã‚½ãƒ¼ã‚¹æˆåŠŸ<br><br>${results.join('<br>')}`);
            }

            async testTripleOSCache() {
                this.logMessage('Phase 3: Triple OS Cacheæˆ¦ç•¥ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
                
                try {
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
                    const cacheNames = await caches.keys();
                    this.logMessage(`Cache storages found: ${cacheNames.length}`, 'info');
                    
                    let haqeiCache = null;
                    for (const cacheName of cacheNames) {
                        if (cacheName.includes('haqei')) {
                            haqeiCache = await caches.open(cacheName);
                            break;
                        }
                    }

                    if (haqeiCache) {
                        const cachedRequests = await haqeiCache.keys();
                        this.logMessage(`Cached resources: ${cachedRequests.length}`, 'success');
                        
                        this.updateStatus('cache-test', true,
                            `âœ… Cacheå‹•ä½œç¢ºèª<br>Cacheå: ${haqeiCache}<br>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒªã‚½ãƒ¼ã‚¹: ${cachedRequests.length}å€‹`);
                    } else {
                        this.updateStatus('cache-test', false,
                            'âŒ HAQEIã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    }
                    
                } catch (error) {
                    this.logMessage(`Cache test failed: ${error.message}`, 'error');
                    this.updateStatus('cache-test', false,
                        `âŒ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆå¤±æ•—<br>Error: ${error.message}`);
                }
            }

            generateFinalReport() {
                const successRate = this.totalTests > 0 ? (this.passedTests / this.totalTests * 100) : 0;
                const qualityGrade = successRate >= 95 ? 'Aç´šï¼ˆå®Œå…¨é”æˆï¼‰' : 
                                  successRate >= 80 ? 'Bç´šï¼ˆè‰¯å¥½ï¼‰' : 
                                  successRate >= 60 ? 'Cç´šï¼ˆè¦æ”¹å–„ï¼‰' : 'Dç´šï¼ˆè¦å†å®Ÿè£…ï¼‰';

                this.logMessage('ğŸ“‹ === Tsumikiå“è³ªä¿è¨¼ãƒ¬ãƒãƒ¼ãƒˆ ===', 'info');
                this.logMessage(`ãƒ†ã‚¹ãƒˆæˆåŠŸç‡: ${successRate.toFixed(1)}%`, 'info');
                this.logMessage(`å“è³ªã‚°ãƒ¬ãƒ¼ãƒ‰: ${qualityGrade}`, 'info');
                this.logMessage(`bunenjinå“²å­¦é©åˆæ€§: ${successRate >= 90 ? 'é©åˆ' : 'è¦èª¿æ•´'}`, 'info');
                this.logMessage(`Triple OSå¯¾å¿œ: ${this.passedTests >= 2 ? 'å¯¾å¿œæ¸ˆã¿' : 'æœªå¯¾å¿œ'}`, 'info');
                this.logMessage('=================================', 'info');
            }
        }

        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', () => {
            const tester = new TsumikiServiceWorkerTester();
            setTimeout(() => tester.runAllTests(), 1000);
        });
    </script>
</body>
</html>