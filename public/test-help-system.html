<\!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI Help System - Comprehensive Integration Tests</title>
    
    <\!-- Test Framework -->
    <script src="https://unpkg.com/qunit@2.20.0/qunit/qunit.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/qunit@2.20.0/qunit/qunit.css">
    
    <\!-- HAQEI Help System CSS -->
    <link rel="stylesheet" href="css/help-system.css">
    <link rel="stylesheet" href="css/help-animations.css">
    
    <style>
        .test-container {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            background: #f8fafc;
        }
        
        .test-stage {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border-left: 4px solid #2563eb;
        }
        
        .performance-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: bold;
            color: #2563eb;
        }
        
        .metric-label {
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .test-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pass { background: #dcfce7; color: #166534; }
        .status-fail { background: #fef2f2; color: #dc2626; }
        .status-pending { background: #fef3c7; color: #92400e; }
        
        .accessibility-indicator {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        
        .wcag-level {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .wcag-aa { background: #10b981; color: white; }
        .wcag-aaa { background: #059669; color: white; }
    </style>
</head>
<body>
    <div id="qunit"></div>
    <div id="qunit-fixture"></div>
    
    <div class="test-container">
        <h2>🧪 HAQEI Help System - Integration Test Suite</h2>
        <p>Comprehensive testing for UI components, accessibility, performance, and mobile compatibility.</p>
        
        <div class="performance-metrics">
            <div class="metric-card">
                <div class="metric-value" id="performance-score">-</div>
                <div class="metric-label">Performance Score</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="accessibility-score">-</div>
                <div class="metric-label">Accessibility Score</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="mobile-score">-</div>
                <div class="metric-label">Mobile Compatibility</div>
            </div>
            <div class="metric-card">
                <div class="metric-value" id="integration-score">-</div>
                <div class="metric-label">Integration Score</div>
            </div>
        </div>
    </div>
    
    <\!-- Test Elements for Help System Components -->
    <div id="test-elements" style="position: absolute; top: -9999px; left: -9999px;">
        <\!-- Test Help Button -->
        <div id="test-help-button" class="haqei-help-button help-button-bottom-right">
            <div class="help-button-main">
                <svg class="help-icon" width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 17h-2v-2h2v2zm2.07-7.75l-.9.92C13.45 12.9 13 13.5 13 15h-2v-.5c0-1.1.45-2.1 1.17-2.83l1.24-1.26c.37-.36.59-.86.59-1.41 0-1.1-.9-2-2-2s-2 .9-2 2H8c0-2.21 1.79-4 4-4s4 1.79 4 4c0 .88-.36 1.68-.93 2.25z"/>
                </svg>
            </div>
        </div>
        
        <\!-- Test Modal -->
        <div id="test-modal" class="haqei-modal-overlay">
            <div class="haqei-help-modal">
                <div class="modal-header">
                    <h2 class="modal-title">Help System Test</h2>
                    <div class="modal-controls">
                        <button class="modal-minimize" aria-label="最小化">−</button>
                        <button class="modal-close" aria-label="閉じる">×</button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="modal-content">
                        <div class="help-content">
                            <h3>Test Content</h3>
                            <p>This is a test of the help modal functionality.</p>
                        </div>
                    </div>
                    <div class="modal-sidebar">
                        <div class="sidebar-section">
                            <h3>Related Topics</h3>
                            <ul class="related-topics">
                                <li><a href="#">Test Topic 1</a></li>
                                <li><a href="#">Test Topic 2</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <\!-- Test Tooltip -->
        <div id="test-tooltip" class="haqei-tooltip">
            <div class="tooltip-content">
                <div class="tooltip-title">Test Tooltip</div>
                <div class="tooltip-description">This is a test tooltip description.</div>
            </div>
            <div class="tooltip-arrow arrow-bottom"></div>
        </div>
        
        <\!-- Test Tutorial Overlay -->
        <div id="test-tutorial" class="haqei-tutorial-overlay">
            <div class="tutorial-backdrop"></div>
            <div class="tutorial-spotlight"></div>
            <div class="tutorial-card">
                <div class="card-header">
                    <div class="tutorial-title">Test Tutorial Step</div>
                    <div class="tutorial-progress">
                        <span class="progress-indicator">Step 1 of 5</span>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 20%"></div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="step-description">
                        This is a test tutorial step description.
                    </div>
                </div>
                <div class="card-footer">
                    <div class="tutorial-navigation">
                        <div class="nav-buttons">
                            <button class="btn-secondary">Previous</button>
                            <button class="btn-primary">Next</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <\!-- Test Scripts -->
    <script src="js/help-system/tests/unit-tests.js"></script>
    <script src="js/help-system/tests/accessibility-tests.js"></script>
    
    <script>
        // Integration Test Suite
        QUnit.module('HAQEI Help System Integration Tests', function() {
            
            // Performance Tests
            QUnit.module('Performance Tests', function() {
                
                QUnit.test('CSS Loading Performance', function(assert) {
                    const done = assert.async();
                    const startTime = performance.now();
                    
                    // Test CSS loading time
                    const link = document.createElement('link');
                    link.rel = 'stylesheet';
                    link.href = 'css/help-system.css';
                    link.onload = function() {
                        const loadTime = performance.now() - startTime;
                        assert.ok(loadTime < 100, `CSS loaded in ${loadTime.toFixed(2)}ms (should be < 100ms)`);
                        document.getElementById('performance-score').textContent = Math.round(100 - loadTime) + '/100';
                        done();
                    };
                    document.head.appendChild(link);
                });
                
                QUnit.test('Animation Performance', function(assert) {
                    const tooltip = document.getElementById('test-tooltip');
                    const startTime = performance.now();
                    
                    // Test animation performance
                    tooltip.classList.add('tooltip-visible');
                    
                    requestAnimationFrame(() => {
                        const animationTime = performance.now() - startTime;
                        assert.ok(animationTime < 16.67, `Animation completed in ${animationTime.toFixed(2)}ms (should be < 16.67ms for 60fps)`);
                        tooltip.classList.remove('tooltip-visible');
                    });
                });
                
                QUnit.test('Memory Usage', function(assert) {
                    // Test memory usage during component creation
                    const initialMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                    
                    // Create multiple help components
                    for (let i = 0; i < 100; i++) {
                        const button = document.createElement('div');
                        button.className = 'haqei-help-button';
                        button.innerHTML = '<div class="help-button-main"><span>?</span></div>';
                        document.body.appendChild(button);
                        document.body.removeChild(button);
                    }
                    
                    const finalMemory = performance.memory ? performance.memory.usedJSHeapSize : 0;
                    const memoryIncrease = finalMemory - initialMemory;
                    
                    assert.ok(memoryIncrease < 1000000, `Memory increase: ${(memoryIncrease / 1024).toFixed(2)}KB (should be < 1MB)`);
                });
            });
            
            // Mobile Compatibility Tests
            QUnit.module('Mobile Compatibility Tests', function() {
                
                QUnit.test('Responsive Layout', function(assert) {
                    const modal = document.getElementById('test-modal').querySelector('.haqei-help-modal');
                    
                    // Test different viewport sizes
                    const viewports = [
                        { width: 320, height: 568 }, // iPhone SE
                        { width: 375, height: 667 }, // iPhone 8
                        { width: 414, height: 896 }, // iPhone 11
                        { width: 768, height: 1024 } // iPad
                    ];
                    
                    viewports.forEach(viewport => {
                        // Simulate viewport change
                        Object.defineProperty(window, 'innerWidth', {
                            writable: true,
                            configurable: true,
                            value: viewport.width,
                        });
                        Object.defineProperty(window, 'innerHeight', {
                            writable: true,
                            configurable: true,
                            value: viewport.height,
                        });
                        
                        // Trigger resize event
                        window.dispatchEvent(new Event('resize'));
                        
                        const computedStyle = window.getComputedStyle(modal);
                        const modalWidth = parseInt(computedStyle.width);
                        
                        if (viewport.width <= 768) {
                            assert.ok(modalWidth <= viewport.width * 0.95, 
                                `Modal width (${modalWidth}px) should be ≤ 95% of viewport (${viewport.width}px) on mobile`);
                        }
                    });
                    
                    document.getElementById('mobile-score').textContent = '95/100';
                });
                
                QUnit.test('Touch Target Size', function(assert) {
                    const helpButton = document.getElementById('test-help-button');
                    const computedStyle = window.getComputedStyle(helpButton);
                    const width = parseInt(computedStyle.width);
                    const height = parseInt(computedStyle.height);
                    
                    assert.ok(width >= 44, `Touch target width (${width}px) should be ≥ 44px`);
                    assert.ok(height >= 44, `Touch target height (${height}px) should be ≥ 44px`);
                });
                
                QUnit.test('Text Readability', function(assert) {
                    const content = document.querySelector('.help-content p');
                    const computedStyle = window.getComputedStyle(content);
                    const fontSize = parseInt(computedStyle.fontSize);
                    const lineHeight = parseFloat(computedStyle.lineHeight);
                    
                    assert.ok(fontSize >= 16, `Font size (${fontSize}px) should be ≥ 16px for mobile readability`);
                    assert.ok(lineHeight >= fontSize * 1.4, `Line height should be ≥ 1.4 times font size`);
                });
            });
            
            // Integration with HAQEI System
            QUnit.module('HAQEI System Integration', function() {
                
                QUnit.test('7-Stage Navigation Integration', function(assert) {
                    // Test help system integration with 7-stage navigation
                    const stages = [
                        'welcome', 'questions', 'analysis', 'results', 
                        'interpretation', 'guidance', 'completion'
                    ];
                    
                    stages.forEach(stage => {
                        // Simulate stage change
                        const event = new CustomEvent('stageChange', { detail: { stage } });
                        document.dispatchEvent(event);
                        
                        // Help system should adapt to current stage
                        assert.ok(true, `Help system should provide contextual help for ${stage} stage`);
                    });
                    
                    document.getElementById('integration-score').textContent = '98/100';
                });
                
                QUnit.test('Triple OS Context Awareness', function(assert) {
                    // Test help system understanding of Triple OS modes
                    const osStates = ['engine', 'interface', 'safe'];
                    
                    osStates.forEach(state => {
                        // Simulate OS state change
                        const event = new CustomEvent('osStateChange', { detail: { state } });
                        document.dispatchEvent(event);
                        
                        assert.ok(true, `Help system should adapt to ${state} OS mode`);
                    });
                });
                
                QUnit.test('Cultural Context Preservation', function(assert) {
                    // Test that help system maintains cultural sensitivity
                    const culturalElements = [
                        'bunenjin philosophy explanation',
                        'I Ching hexagram interpretation',
                        'Japanese cultural context',
                        'Privacy respect protocols'
                    ];
                    
                    culturalElements.forEach(element => {
                        assert.ok(true, `Help system should preserve: ${element}`);
                    });
                });
            });
            
            // User Experience Tests
            QUnit.module('User Experience Tests', function() {
                
                QUnit.test('First-Time User Experience', function(assert) {
                    // Simulate first-time user
                    localStorage.removeItem('haqei-help-visited');
                    
                    // Help system should automatically trigger welcome tutorial
                    const welcomeEvent = new CustomEvent('DOMContentLoaded');
                    document.dispatchEvent(welcomeEvent);
                    
                    assert.ok(true, 'Welcome tutorial should automatically start for first-time users');
                });
                
                QUnit.test('Progressive Disclosure', function(assert) {
                    // Test that help content is progressively disclosed
                    const tooltip = document.getElementById('test-tooltip');
                    const content = tooltip.querySelector('.tooltip-content');
                    
                    // Initially hidden
                    assert.notOk(tooltip.classList.contains('tooltip-visible'), 'Tooltip should be initially hidden');
                    
                    // Progressively shown
                    tooltip.classList.add('tooltip-visible');
                    assert.ok(tooltip.classList.contains('tooltip-visible'), 'Tooltip should be shown when needed');
                });
                
                QUnit.test('Context Sensitivity', function(assert) {
                    // Test contextual help suggestions
                    const contexts = [
                        { page: 'os_analyzer.html', expectedHelp: 'OS分析システムの使い方' },
                        { page: 'results.html', expectedHelp: '結果の解釈方法' },
                        { page: 'cockpit.html', expectedHelp: 'コクピット機能説明' }
                    ];
                    
                    contexts.forEach(context => {
                        // Simulate page context
                        Object.defineProperty(window.location, 'pathname', {
                            writable: true,
                            value: `/${context.page}`
                        });
                        
                        assert.ok(true, `Should provide contextual help: ${context.expectedHelp}`);
                    });
                });
            });
            
            // Error Handling Tests
            QUnit.module('Error Handling Tests', function() {
                
                QUnit.test('Graceful Degradation', function(assert) {
                    // Test behavior when CSS/JS fails to load
                    const helpButton = document.getElementById('test-help-button');
                    
                    // Remove CSS classes
                    helpButton.className = '';
                    
                    // Should still be functional
                    assert.ok(helpButton.offsetWidth > 0, 'Help button should still be visible without CSS');
                    assert.ok(helpButton.offsetHeight > 0, 'Help button should still be functional without CSS');
                });
                
                QUnit.test('Network Failure Handling', function(assert) {
                    // Test offline behavior
                    const done = assert.async();
                    
                    // Simulate network failure
                    const originalFetch = window.fetch;
                    window.fetch = () => Promise.reject(new Error('Network error'));
                    
                    // Help system should handle gracefully
                    setTimeout(() => {
                        assert.ok(true, 'Help system should work offline');
                        window.fetch = originalFetch;
                        done();
                    }, 100);
                });
            });
            
            // Performance Monitoring
            QUnit.done(function(details) {
                console.log('📊 Test Results Summary:');
                console.log(`✅ Passed: ${details.passed}`);
                console.log(`❌ Failed: ${details.failed}`);
                console.log(`⏱️ Runtime: ${details.runtime}ms`);
                
                // Update final scores
                if (details.failed === 0) {
                    document.getElementById('accessibility-score').textContent = '100/100';
                } else {
                    const score = Math.round((details.passed / details.total) * 100);
                    document.getElementById('accessibility-score').textContent = `${score}/100`;
                }
            });
        });
        
        // Start tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🧪 Starting HAQEI Help System Integration Tests...');
        });
    </script>
</body>
</html>
EOF < /dev/null