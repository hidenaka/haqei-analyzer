<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>æ˜“</text></svg>"
    />
    <!-- Preload critical resources -->
    <link rel="preload" href="https://cdn.tailwindcss.com" as="script">
    <link rel="preload" href="https://cdn.jsdelivr.net/npm/chart.js" as="script">
    
    <!-- Load critical path scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Defer non-critical scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js" defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      
      /* Progressive Loading Styles */
      .skeleton {
        background: linear-gradient(90deg, rgba(55, 65, 81, 0.1) 25%, rgba(75, 85, 99, 0.2) 37%, rgba(55, 65, 81, 0.1) 63%);
        background-size: 400% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
      }
      
      @keyframes skeleton-loading {
        0% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .skeleton-text {
        height: 1em;
        border-radius: 4px;
        margin: 0.5em 0;
      }
      
      .skeleton-button {
        height: 3em;
        border-radius: 8px;
        width: 100%;
      }
      
      .skeleton-card {
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .skeleton-chart {
        height: 300px;
        border-radius: 8px;
      }
      
      .fade-in {
        animation: fadeIn 0.6s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(17, 24, 39, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: opacity 0.3s ease;
      }
      
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(165, 180, 252, 0.3);
        border-left: 4px solid #a5b4fc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .module-loading {
        opacity: 0.6;
        pointer-events: none;
      }
      
      .content-ready {
        opacity: 1;
        pointer-events: auto;
        transition: opacity 0.4s ease;
      }
      
      .progressive-load {
        opacity: 0;
        transform: translateY(30px);
        transition: all 0.6s ease;
      }
      
      .progressive-load.loaded {
        opacity: 1;
        transform: translateY(0);
      }
      
      /* Lazy loading images */
      img.lazy {
        opacity: 0;
        transition: opacity 0.3s;
      }
      
      img.lazy.loaded {
        opacity: 1;
      }
      
      /* Performance optimizations */
      .will-change-transform {
        will-change: transform;
      }
      
      .will-change-opacity {
        will-change: opacity;
      }
      
      /* Loading states for buttons */
      .btn-loading {
        position: relative;
        pointer-events: none;
      }
      
      .btn-loading::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        width: 20px;
        height: 20px;
        margin: -10px 0 0 -10px;
        border: 2px solid transparent;
        border-top: 2px solid currentColor;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      .card:hover,
      .card.highlighted {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      .rank-badge {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 9999px;
        line-height: 1;
      }
      .rank-s,
      .rank-a,
      .rank-b,
      .rank-c {
        background-color: rgba(74, 222, 128, 0.2);
        color: #86efac;
        border: 1px solid #4ade80;
      }
      .rank-d,
      .rank-e,
      .rank-f,
      .rank-g {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .rank-h {
        background-color: rgba(185, 28, 28, 0.2);
        color: #fca5a5;
        border: 1px solid #dc2626;
      }
      .toggle-label {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid transparent;
        transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
      }
      .toggle-label:hover,
      .toggle-label.highlighted {
        transform: scale(1.1);
      }
      .toggle-legend {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 6px;
      }
      .modal-overlay {
        transition: opacity 0.3s ease;
      }
      .modal-content {
        transition: transform 0.3s ease;
      }
      .eval-label {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 10px;
      }
      .trend-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 6px;
        width: 100%;
        text-align: center;
      }
      .trend-up {
        background-color: rgba(52, 211, 153, 0.2);
        color: #6ee7b7;
        border: 1px solid #34d399;
      }
      .trend-invest {
        background-color: rgba(96, 165, 250, 0.2);
        color: #93c5fd;
        border: 1px solid #60a5fa;
      }
      .trend-stable {
        background-color: rgba(209, 213, 219, 0.2);
        color: #d1d5db;
        border: 1px solid #9ca3af;
      }
      .trend-stagnate {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #fbbf24;
      }
      .trend-down {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .trend-risk-mgmt {
        background-color: rgba(167, 139, 250, 0.2);
        color: #c4b5fd;
        border: 1px solid #a78bfa;
      }
      .trend-recovery {
        background-color: rgba(34, 197, 94, 0.2);
        color: #86efac;
        border: 1px solid #4ade80;
      }
      .yong-yao-step {
        background: linear-gradient(
          145deg,
          rgba(55, 48, 163, 0.2),
          rgba(129, 140, 248, 0.1)
        );
        border: 1px solid #a5b4fc;
        border-radius: 0.75rem;
        box-shadow: 0 0 20px rgba(165, 180, 252, 0.2);
        margin-top: 1rem;
        margin-bottom: 1rem;
      }
      .yong-yao-transition {
        background-color: rgba(253, 224, 71, 0.1);
        border: 1px solid rgba(253, 224, 71, 0.4);
        color: #fde047;
      }
      .yong-yao-title-icon {
        color: #fde047;
        font-size: 1.1em;
        margin-left: 0.5rem;
        text-shadow: 0 0 10px #facc15;
      }
      .diff-up {
        color: #6ee7b7;
      }
      .diff-down {
        color: #fca5a5;
      }
      .diff-zero {
        color: #9ca3af;
      }
      .full-text {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
      }
      #aiReasoningContainer {
        border-left: 3px solid #a5b4fc;
        background: rgba(165, 180, 252, 0.05);
      }
      .deep-dive-btn {
        background: linear-gradient(
          145deg,
          rgba(253, 224, 71, 0.8),
          rgba(251, 146, 60, 0.8)
        );
        color: #111827;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(253, 224, 71, 0.2);
      }
      .deep-dive-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(253, 191, 36, 0.4);
      }
      .future-contents-reveal {
        opacity: 1 !important;
      }
      .ai-recommended {
        transform: scale(1.03);
        box-shadow: 0 0 35px rgba(74, 222, 128, 0.5),
          0 0 0 3px rgba(74, 222, 128, 0.6);
        border-color: rgba(74, 222, 128, 0.6) !important;
      }
      .dimmed-by-choice {
        opacity: 0.4;
        transform: scale(0.98);
      }

      /* ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹åˆ†æUI */
      .evidence-based-analysis {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 16px;
        margin: 8px 0;
      }

      .analysis-evidence {
        background: rgba(31, 41, 55, 0.8);
        backdrop-filter: blur(8px);
        border: 1px solid rgba(75, 85, 99, 0.5);
      }

      .evidence-item {
        padding: 8px;
        background: rgba(55, 65, 81, 0.3);
        border-radius: 6px;
        border-left: 3px solid rgba(99, 102, 241, 0.5);
      }

      .evidence-item:hover {
        background: rgba(55, 65, 81, 0.5);
        transform: translateX(2px);
        transition: all 0.2s ease;
      }

      #detailed-evidence {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(55, 65, 81, 0.5);
        border-radius: 6px;
      }

      #detailed-evidence pre {
        max-height: 200px;
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: rgba(99, 102, 241, 0.5) rgba(31, 41, 55, 0.3);
      }

      #detailed-evidence pre::-webkit-scrollbar {
        width: 6px;
      }

      #detailed-evidence pre::-webkit-scrollbar-track {
        background: rgba(31, 41, 55, 0.3);
        border-radius: 3px;
      }

      #detailed-evidence pre::-webkit-scrollbar-thumb {
        background: rgba(99, 102, 241, 0.5);
        border-radius: 3px;
      }

      /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ */
      .evidence-based-analysis {
        animation: fadeInUp 0.5s ease-out;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      /* ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†è¡¨ç¤º */
      .processing-status {
        background: rgba(59, 130, 246, 0.1);
        border: 1px solid rgba(59, 130, 246, 0.3);
        border-radius: 8px;
        padding: 12px;
        margin: 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .processing-spinner {
        width: 16px;
        height: 16px;
        border: 2px solid rgba(59, 130, 246, 0.3);
        border-top: 2px solid rgba(59, 130, 246, 1);
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
    <script src="./js/koudo_shishin_database.js"></script>
    <script src="./js/ai_theme_database.js"></script>
    <script src="./js/sns_worry_patterns.js"></script>
    <script src="./assets/H384H64database.js"></script>
    <script>
        /**
         * H384_DATAèª­ã¿è¾¼ã¿é †åºä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ 
         * 
         * ç›®çš„ï¼š
         * - H384H64database.jsãŒç¢ºå®Ÿã«ä»–ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚ˆã‚Šå…ˆã«å®Ÿè¡Œã•ã‚Œã‚‹
         * - bunenjinå“²å­¦ã«åŸºã¥ãæ®µéšçš„åˆæœŸåŒ–ã®ä¿è¨¼
         * - Triple OSçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã§ã®ä¾å­˜é–¢ä¿‚ç®¡ç†
         * 
         * å‡¦ç†å†…å®¹ï¼š
         * 1. H384_DATAå¤‰æ•°ã®å­˜åœ¨ç¢ºèª
         * 2. èª­ã¿è¾¼ã¿å¤±æ•—æ™‚ã®ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°å‡ºåŠ›
         * 3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®å‘¼ã³å‡ºã—
         * 4. å¾Œç¶šã‚¹ã‚¯ãƒªãƒ—ãƒˆã¸ã®å®‰å…¨ãªå¼•ãç¶™ã
         * 
         * æ¤œè¨¼é …ç›®ï¼š
         * - window.H384_DATA ã®å­˜åœ¨
         * - 386ã‚¨ãƒ³ãƒˆãƒªã®å®Œå…¨æ€§
         * - ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã®ç¢ºèª
         * 
         * ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼š
         * - èª­ã¿è¾¼ã¿å¤±æ•—: ensureH384Data()ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
         * - ä¸å®Œå…¨ãƒ‡ãƒ¼ã‚¿: è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›
         * - è‡´å‘½çš„ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é©åˆ‡ãªé€šçŸ¥
         */
        
        // å³åº§å®Ÿè¡Œé–¢æ•°ã«ã‚ˆã‚‹ç¢ºå®Ÿãªæ¤œè¨¼
        (function() {
            console.log('ğŸ” H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèªã‚’é–‹å§‹...');
            
            // H384_DATAã®åŸºæœ¬çš„ãªå­˜åœ¨ç¢ºèª
            if (typeof H384_DATA === 'undefined') {
                console.error('âŒ H384_DATAèª­ã¿è¾¼ã¿å¤±æ•—: å¤‰æ•°ãŒæœªå®šç¾©ã§ã™');
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’è©¦è¡Œ
                if (typeof window.ensureH384Data === 'function') {
                    console.warn('ğŸ”§ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’é–‹å§‹...');
                    try {
                        window.ensureH384Data();
                        console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†å®Œäº†');
                    } catch (error) {
                        console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚‚å¤±æ•—:', error);
                    }
                } else {
                    console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚‚åˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            } else {
                console.log('âœ… H384_DATAå¤‰æ•°ã®å­˜åœ¨ç¢ºèª: æˆåŠŸ');
                
                // window.H384_DATAã¸ã®ä»£å…¥ç¢ºèª
                if (typeof window.H384_DATA === 'undefined') {
                    console.warn('âš ï¸  window.H384_DATAãŒæœªè¨­å®š - è‡ªå‹•è¨­å®šã‚’è©¦è¡Œ');
                    try {
                        window.H384_DATA = H384_DATA;
                        console.log('âœ… window.H384_DATAè‡ªå‹•è¨­å®š: æˆåŠŸ');
                    } catch (error) {
                        console.error('âŒ window.H384_DATAè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ã®åŸºæœ¬ç¢ºèª
                if (Array.isArray(window.H384_DATA) && window.H384_DATA.length === 386) {
                    console.log('âœ… H384_DATAãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ç¢ºèª: æˆåŠŸ (386ã‚¨ãƒ³ãƒˆãƒª)');
                    
                    // ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã®ç¢ºèª
                    const youkuu = window.H384_DATA.find(item => item['é€šã—ç•ªå·'] === 7);
                    const yourikuu = window.H384_DATA.find(item => item['é€šã—ç•ªå·'] === 14);
                    
                    if (youkuu && yourikuu) {
                        console.log('âœ… ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªç¢ºèª: æˆåŠŸ');
                        console.log(`   - ç”¨ä¹: ${youkuu['å¦å']} (${youkuu['çˆ»']})`);
                        console.log(`   - ç”¨å…­: ${yourikuu['å¦å']} (${yourikuu['çˆ»']})`);
                    } else {
                        console.warn('âš ï¸  ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                    }
                } else {
                    console.error('âŒ H384_DATAãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼:', {
                        isArray: Array.isArray(window.H384_DATA),
                        length: window.H384_DATA?.length
                    });
                }
            }
            
            console.log('ğŸ H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèªå®Œäº†');
        })();
    </script>
    <script src="./js/keyword_expansion_engine.js"></script>
    <script src="./js/ml-integration.js" async defer></script>
    <!-- Offline-First Dictionary System -->
    <script src="./js/core/DictionaryManager.js" defer></script>
    <script src="./js/core/OfflineDetector.js" defer></script>
    <script src="./js/core/OfflineKuromojiInitializer.js" defer></script>
    <script src="./js/core/offline-kuromoji-integration.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js" defer></script>
    <!-- Advanced Analysis Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/ml-matrix@6.10.4/lib/ml-matrix.min.js"></script>
    <!-- Dynamic Analysis Components -->
    <script src="./js/pages/future-simulator/DynamicKeywordGenerator.js"></script>
    <script src="./js/pages/future-simulator/IntegratedAnalysisEngine.js"></script>
    <script src="./js/pages/future-simulator/MultiDimensionalContextAnalyzer.js"></script>
    <script src="./js/pages/future-simulator/SituationalContextEngine.js"></script>
    <script src="./js/pages/future-simulator/HexagramMappingEngine.js"></script>
    <script src="./js/pages/future-simulator/MetaphorGenerationEngine.js"></script>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6">
    <!-- Initial Loading Screen -->
    <div id="initial-loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
      <div class="text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h1 class="text-2xl font-bold brand-text mb-2">HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</h1>
        <p class="text-gray-400">ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...</p>
        <div class="mt-4 w-64 bg-gray-700 rounded-full h-2">
          <div id="loading-progress" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>
    
    <div
      class="w-full max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8 opacity-0"
      id="main-container"
    >
      <header class="text-center mb-8 relative">
        <a href="./" class="inline-block">
          <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
            HaQei
          </h1>
          <p class="text-gray-400 mt-2 text-lg">ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</p>
        </a>
        <button
          id="helpBtn"
          class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.25l-2.536 2.39c-.832.786-1.464 1.49-1.464 2.36h.001M12 18h.01"
            />
          </svg>
        </button>
      </header>

      <!-- Input Section with Skeleton -->\n      <div class="bg-gray-900/50 p-6 rounded-xl mb-4 relative progressive-load" id="input-section">
        <!-- Skeleton for Input Section -->
        <div class="skeleton-input" id="input-skeleton">
          <div class="skeleton skeleton-text" style="width: 60%; height: 1.5rem; margin-bottom: 1rem;"></div>
          <div class="skeleton skeleton-card">
            <div class="skeleton skeleton-text" style="width: 100%; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text" style="width: 80%; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text" style="width: 90%;"></div>
          </div>
          <div class="skeleton skeleton-text" style="width: 100%; height: 4rem; margin: 1rem 0;"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        
        <!-- Actual Input Content -->
        <div class="input-content" id="input-content" style="display: none;">
          <h2 class="text-lg font-bold text-indigo-300 mb-3">
            1. AIã«ã‚ˆã‚‹çŠ¶æ³æ¨æ¸¬
          </h2>
        <div
          class="border border-gray-700 rounded-lg p-4 mb-4 text-sm text-gray-300 space-y-3"
        >
          <p class="text-base font-bold text-center text-indigo-300">
            AIã¸ã®æœ€é«˜ã®ã€Œå‘ªæ–‡ã€ã¯ã€ã‚ãªãŸã®ã€Œã‚ã‚Šã®ã¾ã¾ã®è¨€è‘‰ã€ã§ã™
          </p>
          <p class="text-xs text-center text-gray-400">
            æœªæ¥åˆ†å²å›³ã®ç²¾åº¦ã‚’é«˜ã‚ã‚‹ã€ãŸã£ãŸä¸€ã¤ã®ç§˜è¨£
          </p>
          <p>
            ã“ã‚Œã‹ã‚‰ã€ã‚ãªãŸã®ç¾çŠ¶ã¨èª²é¡Œã‚’AIã«å…¥åŠ›ã—ã¦ã„ãŸã ãã¾ã™ã€‚ãã®éš›ã€ã©ã†ã‹<strong>ã€Œä¸Šæ‰‹ãªæ–‡ç« ã‚’æ›¸ã“ã†ã€ã¨ã—ãªã„ã§ãã ã•ã„ã€‚</strong>AIã¯ã€æ•´ãˆã‚‰ã‚ŒãŸæ–‡ç« ã‚ˆã‚Šã‚‚ã€ã‚ãªãŸã®<strong>ã€Œç”Ÿã®è¨€è‘‰ã€</strong>ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚
          </p>
          <p>
            ç®‡æ¡æ›¸ãã§ã‚‚ã€å¿ƒã®ã¤ã¶ã‚„ãã§ã‚‚ã€èª°ã‹ã«æ„šç—´ã‚’ã“ã¼ã™ã‚ˆã†ãªè¨€è‘‰ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ä»–äººã«è¦‹ã›ã‚‹ãŸã‚ã®æ–‡ç« ã§ã¯ãªãã€<strong>ã‚ãªãŸè‡ªèº«ã®ãŸã‚ã®ã€Œæ€è€ƒã®ãƒ¡ãƒ¢ã€</strong>ã¨ã—ã¦ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
          </p>
          <p>
            ãªãœãªã‚‰ã€AIã¯ã‚ãªãŸãŒé¸ã¶ä¸€ã¤ä¸€ã¤ã®å˜èªã€è¡¨ç¾ã®æºã‚Œã€æ„Ÿæƒ…ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‹ã‚‰ã€ã‚ãªãŸã ã‘ã®ã€Œæ€è€ƒã®ã‚¯ã‚»ã€ã‚„ã€Œå¿ƒã®å‹•ãã€ã‚’èª­ã¿å–ã‚‹ã‹ã‚‰ã§ã™ã€‚
          </p>
          <div class="pt-2">
            <p class="font-bold text-gray-200">ã€å…¥åŠ›ã®ãƒ’ãƒ³ãƒˆã€‘</p>
            <div
              class="mt-2 p-3 rounded-lg bg-red-900/20 border border-red-800/50"
            >
              <p class="font-bold">æ‚ªã„ä¾‹ âŒ</p>
              <p class="text-xs italic mt-1">
                ã€Œæ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã«ãŠã„ã¦ã€äººçš„ãƒªã‚½ãƒ¼ã‚¹ã®ä¸è¶³ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãªã‚Šã€è¨ˆç”»ã«é…å»¶ãŒç”Ÿã˜ã¦ã„ã¾ã™ã€‚ã€
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ï¼ˆã“ã‚Œã§ã¯ã€AIã¯ä¸€èˆ¬çš„ãªãƒ“ã‚¸ãƒã‚¹èª²é¡Œã¨ã—ã¦ã—ã‹åˆ†æã§ãã¾ã›ã‚“ï¼‰
              </p>
            </div>
            <div
              class="mt-2 p-3 rounded-lg bg-emerald-900/20 border border-emerald-800/50"
            >
              <p class="font-bold">è‰¯ã„ä¾‹ â­•</p>
              <p class="text-xs italic mt-1">
                ã€Œæ–°ã—ã„ä»•äº‹ã€ãƒã‚¸ã§äººè¶³ã‚Šã¦ãªã„ï¼Aã•ã‚“ã¯é ‘å¼µã£ã¦ãã‚Œã¦ã‚‹ã‘ã©ã€Bã•ã‚“ã¯å…¨ç„¶ã‚„ã‚‹æ°—ãªã„ã—â€¦ã€‚ã“ã®ã¾ã¾ã ã¨çµ¶å¯¾é–“ã«åˆã‚ãªã„ã€‚ã©ã†ã™ã‚Šã‚ƒã„ã„ã‚“ã â€¦ã€‚ç„¦ã‚‹ã€‚ã€
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ï¼ˆã“ã®æ–¹ãŒã€ã‚ãªãŸã®æ„Ÿæƒ…ã€äººé–“é–¢ä¿‚ã¸ã®èªè­˜ã€åˆ‡è¿«æ„ŸãŒä¼ã‚ã‚Šã€ã‚ˆã‚Šãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸåˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼‰
              </p>
            </div>
          </div>
          <p class="font-bold text-center pt-2">
            ã‚ãªãŸã®ã€Œã‚ã‚Šã®ã¾ã¾ã®è¨€è‘‰ã€ã“ããŒã€ã‚ãªãŸã ã‘ã®æœªæ¥ã‚’èª­ã¿è§£ãã€æœ€ã‚‚å¼·åŠ›ãªéµã¨ãªã‚Šã¾ã™ã€‚<br />ã©ã†ãã€ã‚ãªãŸã®å¿ƒã‚’ãã®ã¾ã¾ã€AIã«ã¶ã¤ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚
          </p>
        </div>
        <textarea
          id="worryInput"
          class="bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 mb-4"
          rows="4"
          placeholder="ã“ã“ã«ã‚ãªãŸã®ã€Œç”Ÿã®è¨€è‘‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
        ></textarea>
        <button
            id="aiGuessBtn"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 flex items-center justify-center gap-2"
          >
            <svg class="animate-spin h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg
              id="originalIcon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                clip-rule="evenodd"
              />
            </svg>
            <span id="buttonText">AIã«çŠ¶æ³ã‚’æ¨æ¸¬ã•ã›ã‚‹</span>
          </button>
        </div>
      </div>

      <div class="bg-gray-900/50 p-6 rounded-xl mb-8 space-y-4">
    
    <details class="group">
        <summary class="text-sm text-center text-indigo-400 hover:text-indigo-300 cursor-pointer transition-colors">
            ã¾ãŸã¯ã€çŠ¶æ³å¦ã¨çˆ»ã‚’æ‰‹å‹•ã§æŒ‡å®šã—ã¦äºˆæ¸¬ã™ã‚‹
        </summary>
        <div class="mt-4 pt-4 border-t border-gray-700 flex flex-col sm:flex-row items-center justify-center gap-4">
            <div>
                <label for="hexagramInput" class="block text-sm font-medium text-gray-300 mb-1">çŠ¶æ³å¦ï¼ˆç•ªå·ã¾ãŸã¯åå‰ï¼‰</label>
                <input type="text" id="hexagramInput" list="hexagram-names" class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 text-center" placeholder="ä¾‹: 3">
            </div>
            <div>
                <label for="lineInput" class="block text-sm font-medium text-gray-300 mb-1">ç¾åœ¨ã®çˆ»ï¼ˆ1ï½6ï¼‰</label>
                <input type="number" id="lineInput" min="1" max="6" class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 text-center" placeholder="ä¾‹: 1">
            </div>
            <button id="manualAnalyzeBtn" class="w-full sm:w-auto mt-4 sm:mt-0 sm:self-end bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                äºˆæ¸¬å®Ÿè¡Œ
            </button>
        </div>
    </details>

    <div class="pt-4 border-t border-gray-700 text-center">
        <label class="flex items-center justify-center cursor-pointer">
            <input type="checkbox" id="agreementCheckbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
            <span class="ml-2 text-sm text-gray-400">
                <a href="/terms.html" target="_blank" class="underline hover:text-white">åˆ©ç”¨è¦ç´„</a>ãŠã‚ˆã³<a href="/privacy.html" target="_blank" class="underline hover:text-white">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ã¾ã™
            </span>
        </label>
    </div>
</div>

      <!-- Results Section with Progressive Loading -->
      <div id="resultArea" class="hidden relative">
        <!-- Loading Overlay for Results -->
        <div id="results-loading" class="loading-overlay" style="display: none;">
          <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-300">åˆ†æçµæœã‚’ç”Ÿæˆä¸­...</p>
          </div>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start mb-12">
          <div class="lg:col-span-1">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              åˆ†æã‚µãƒãƒªãƒ¼
            </h2>
            <div class="space-y-4">
              <!-- Summary Card with Skeleton -->
              <div
                id="summaryCard"
                class="p-4 rounded-lg border border-gray-600/50 bg-gray-900/30 relative"
              >
                <!-- Skeleton for Summary Card -->
                <div class="summary-skeleton" id="summary-skeleton">
                  <div class="skeleton skeleton-text" style="width: 70%; height: 1.5rem; margin-bottom: 1rem;"></div>
                  <div class="skeleton skeleton-text" style="width: 50%; margin-bottom: 0.5rem;"></div>
                  <div class="skeleton skeleton-text" style="width: 90%; margin-bottom: 1rem;"></div>
                  <div class="flex gap-4">
                    <div class="skeleton skeleton-text" style="width: 40%; height: 4rem;"></div>
                    <div class="skeleton skeleton-text" style="width: 40%; height: 4rem;"></div>
                  </div>
                </div>
                
                <!-- Actual Summary Content -->
                <div class="summary-content" id="summary-content" style="display: none;">
                <div
                  class="bg-yellow-400/10 border-l-4 border-yellow-400 p-3 rounded-md"
                >
                  <h4
                    id="currentTitle"
                    class="text-lg font-semibold text-yellow-300"
                  ></h4>
                  <p
                    id="currentKeywords"
                    class="text-sm text-yellow-200 mt-1"
                  ></p>
                  <p id="currentSummary" class="text-gray-300 mt-2 text-sm"></p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <h4 class="font-bold text-gray-300">ç¾åœ¨åœ°ã®ç·åˆè©•ä¾¡</h4>
                  <div class="flex items-baseline">
                    <p id="currentScore" class="text-3xl font-bold"></p>
                    <span id="currentScoreLabel"></span>
                  </div>
                  <p id="currentScoreDesc" class="text-xs"></p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <h4 class="font-bold text-gray-300">
                    ä»Šå›ã®å¤‰åŒ–ã®ã—ã‚„ã™ã• (ç§»è¡Œã‚³ã‚¹ãƒˆ)
                  </h4>
                  <div class="flex items-baseline">
                    <p id="transitionCost" class="text-3xl font-bold"></p>
                    <span id="transitionCostLabel"></span>
                  </div>
                  <p id="transitionCostDesc" class="text-xs"></p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="font-bold text-gray-300">ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•</h4>
                    <button
                      id="paramHelpBtn"
                      class="text-yellow-400 hover:text-yellow-300 text-xl cursor-pointer"
                      title="ã‚°ãƒ©ãƒ•ã®è¦‹æ–¹"
                    >
                      <span
                        style="
                          display: inline-block;
                          transform: translateY(-2px);
                        "
                      >
                        â­ï¸
                      </span>
                    </button>
                  </div>
                  <div
                    class="relative"
                    style="height: 150px; padding-left: 5px"
                  >
                    <!-- Chart Container with Skeleton -->
                    <div class="chart-container relative">
                      <div class="chart-skeleton" id="chart-skeleton">
                        <div class="skeleton skeleton-chart"></div>
                      </div>
                      <canvas id="currentStateBarChart" class="chart-content" style="display: none;"></canvas>
                    </div>
                  </div>
                </div>
                <div id="firstActionContainer" class="mt-4"></div>
                </div>
              </div>
            </div>
          </div>
          <div class="lg:col-span-2 bg-gray-900/50 p-6 rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              æœªæ¥åˆ†å²ã‚°ãƒ©ãƒ•ï¼šç·åˆè©•ä¾¡ã®æ¨ç§»
            </h2>
            <div
              id="aiReasoningContainer"
              class="mb-4 p-4 rounded-lg hidden"
            ></div>
            <!-- Summary Chart with Skeleton -->
            <div class="relative" style="height: 400px">
              <div class="summary-chart-skeleton" id="summary-chart-skeleton">
                <div class="skeleton skeleton-chart" style="height: 400px;"></div>
                <div class="skeleton skeleton-text" style="width: 60%; margin-top: 1rem;"></div>
              </div>
              <canvas id="summaryChart" class="chart-content" style="display: none;"></canvas>
            </div>
            <div
              id="chartToggles"
              class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4"
            ></div>
          </div>
        </div>

        <div id="revealButtonContainer" class="text-center mt-8 hidden">
          <button
            id="revealButton"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105 shadow-lg"
          >
            æœªæ¥ã¸ã®é¸æŠè‚¢ã¨ã€8ã¤ã®å…¨ã‚·ãƒŠãƒªã‚ªã‚’è¦‹ã‚‹
          </button>
        </div>

        <div
          id="futureContentsWrapper"
          class="hidden opacity-0 transition-opacity duration-1000"
        >
          <div id="futureChoiceContainer" class="my-12">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-300">
              æœ€åˆã®é¸æŠï¼šã‚ãªãŸã¯ã©ã¡ã‚‰ã®é“ã‚’é¸ã¶ã‹ï¼Ÿ
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div id="choiceCardShin" data-choice="stagnate" class="card p-6 rounded-xl border-2 border-transparent transition-all duration-300 bg-gray-900/50 hover:border-teal-500 hover:shadow-lg hover:shadow-teal-500/10"></div>
              <div id="choiceCardHen" data-choice="change" class="card p-6 rounded-xl border-2 border-transparent transition-all duration-300 bg-gray-900/50 hover:border-purple-500 hover:shadow-lg hover:shadow-purple-500/10"></div>
              ></div>
            </div>
          </div>

          <div>
            <h2 class="text-2xl font-bold mb-2 text-center text-indigo-300">
              8ã¤ã®æœªæ¥ã‚·ãƒŠãƒªã‚ª
            </h2>
            <p
              id="aiRecommendationMessage"
              class="text-center text-amber-300 mb-6 hidden"
            ></p>
            <div
              id="detailCardsContainer"
              class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6"
            ></div>
          </div>
        </div>
      </div>

      <div id="initialMessage" class="text-center py-12">
        <p class="text-xl text-gray-500">
          ã¾ãšã¯ã€ã‚ãªãŸã®ã€Œã‚ã‚Šã®ã¾ã¾ã®è¨€è‘‰ã€ã‚’ã€<br />ä¸Šã®ãƒ†ã‚­ã‚¹ãƒˆãƒœãƒƒã‚¯ã‚¹ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
        </p>
      </div>
    </div>

    <div
      id="modalContainer"
      class="fixed inset-0 z-50 flex items-center justify-center hidden"
    >
      <div
        id="modalOverlay"
        class="absolute inset-0 bg-black/70 modal-overlay opacity-0"
      ></div>
      <div
        id="modalContent"
        class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-8 relative transform scale-95"
      >
        <button
          id="modalCloseBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <div id="modalBody"></div>
      </div>
    </div>

    <datalist id="hexagram-names"></datalist>

    
    <script type="module">
      // æœ¬ç•ªç’°å¢ƒæ¤œå‡ºã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
      const isProductionEnvironment = () => {
        return location.hostname !== 'localhost' && 
               location.hostname !== '127.0.0.1' && 
               !location.hostname.includes('dev') &&
               location.protocol === 'https:';
      };

      // æœ¬ç•ªç’°å¢ƒè­¦å‘Šã®æŠ‘åˆ¶ï¼ˆCDNé–¢é€£ï¼‰
      if (isProductionEnvironment()) {
        // Consoleè­¦å‘Šã‚’é™éŸ³åŒ–ï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ä¸è¦ï¼‰
        const originalWarn = console.warn;
        console.warn = function(...args) {
          const message = args.join(' ');
          // Tailwind CDNè­¦å‘Šã‚„é–‹ç™ºå‘ã‘è­¦å‘Šã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
          if (message.includes('tailwindcss.com should not be used in production') ||
              message.includes('development') ||
              message.includes('CDN') ||
              message.includes('should not be used in production')) {
            return; // æœ¬ç•ªç’°å¢ƒã§ã¯è­¦å‘Šã‚’éè¡¨ç¤º
          }
          originalWarn.apply(console, args);
        };

        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®ãŸã‚ã®ãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æŒ‡ç¤º
        const addPreloadHints = () => {
          const criticalResources = [
            './js/koudo_shishin_database.js',
            './js/ai_theme_database.js',
            './js/sns_worry_patterns.js',
            './js/keyword_expansion_engine.js',
            './js/ml-integration.js'
          ];
          
          criticalResources.forEach(src => {
            const link = document.createElement('link');
            link.rel = 'preload';
            link.as = 'script';
            link.href = src;
            document.head.appendChild(link);
          });
        };
        
        addPreloadHints();
        console.log('ğŸš€ æœ¬ç•ªç’°å¢ƒå‘ã‘æœ€é©åŒ–ãŒé©ç”¨ã•ã‚Œã¾ã—ãŸ');
      }

      // === åŒ…æ‹¬çš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  ===
      class ComprehensiveErrorHandler {
        constructor() {
          this.errorLog = [];
          this.maxLogSize = 100;
          this.retryAttempts = new Map();
          this.maxRetries = 3;
          this.userNotifications = new Set();
          this.setupErrorHandling();
        }

        setupErrorHandling() {
          // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
          window.addEventListener('error', (event) => this.handleGlobalError(event));
          window.addEventListener('unhandledrejection', (event) => this.handleUnhandledRejection(event));
          
          // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ç›£è¦–
          window.addEventListener('online', () => this.handleNetworkRestore());
          window.addEventListener('offline', () => this.handleNetworkLoss());
        }

        handleGlobalError(event) {
          // Chromeæ‹¡å¼µæ©Ÿèƒ½ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
          const chromeExtensionPatterns = [
            'chrome-extension://', 'moz-extension://', 'safari-extension://',
            'extension:', 'content.js', 'background.js', 'popup.js', 'inject.js'
          ];
          
          const isExtensionError = chromeExtensionPatterns.some(pattern => 
            (event.filename?.includes(pattern)) ||
            (event.message?.includes(pattern))
          );
          
          if (isExtensionError) {
            event.preventDefault();
            return true;
          }

          // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ã®å‡¦ç†
          this.logError({
            type: 'javascript',
            message: event.message,
            filename: event.filename,
            lineno: event.lineno,
            error: event.error,
            timestamp: new Date().toISOString()
          });

          this.handleApplicationError(event.error || new Error(event.message));
        }

        handleUnhandledRejection(event) {
          // æ‹¡å¼µæ©Ÿèƒ½é–¢é€£ã®Promiseã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
          const extensionPatterns = [
            'chrome-extension', 'moz-extension', 'safari-extension',
            'Extension context', 'port closed', 'context invalidated'
          ];
          
          if (event.reason?.message && extensionPatterns.some(pattern => 
              event.reason.message.includes(pattern))) {
            event.preventDefault();
            return true;
          }

          this.logError({
            type: 'promise_rejection',
            reason: event.reason,
            timestamp: new Date().toISOString()
          });

          this.handleApplicationError(event.reason);
        }

        handleApplicationError(error) {
          const errorType = this.categorizeError(error);
          
          switch (errorType) {
            case 'kuromoji':
              this.handleKuromojiError(error);
              break;
            case 'network':
              this.handleNetworkError(error);
              break;
            case 'data_loading':
              this.handleDataLoadingError(error);
              break;
            case 'analysis':
              this.handleAnalysisError(error);
              break;
            case 'input_validation':
              this.handleInputValidationError(error);
              break;
            default:
              this.handleGenericError(error);
          }
        }

        categorizeError(error) {
          const message = error?.message?.toLowerCase() || '';
          const stack = error?.stack?.toLowerCase() || '';
          
          if (message.includes('kuromoji') || stack.includes('kuromoji')) return 'kuromoji';
          if (message.includes('network') || message.includes('fetch') || message.includes('load')) return 'network';
          if (message.includes('h384_data') || message.includes('data')) return 'data_loading';
          if (message.includes('analysis') || message.includes('tokenize')) return 'analysis';
          if (message.includes('å…¥åŠ›') || message.includes('validation') || message.includes('insufficient')) return 'input_validation';
          
          return 'generic';
        }

        handleKuromojiError(error) {
          console.warn('ğŸ”¥ Kuromoji ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º:', error.message);
          
          if (!this.hasNotified('kuromoji')) {
            this.showUserFriendlyError(
              'è¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³ã®å•é¡Œ',
              'AI ã«ã‚ˆã‚‹é«˜ç²¾åº¦ãªè¨€èªè§£æã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ãŒã€åŸºæœ¬çš„ãªè§£ææ©Ÿèƒ½ã¯åˆ©ç”¨å¯èƒ½ã§ã™ã€‚',
              {
                action: 'ç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ',
                callback: () => this.enableFallbackMode()
              }
            );
            this.markAsNotified('kuromoji');
          }
          
          // è‡ªå‹•å¾©æ—§ã‚’è©¦è¡Œ
          this.attemptKuromojiRecovery();
        }

        handleNetworkError(error) {
          console.warn('ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º:', error.message);
          
          if (!this.hasNotified('network')) {
            this.showUserFriendlyError(
              'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã®å•é¡Œ',
              'å¤–éƒ¨ãƒªã‚½ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã¾ã™ãŒã€ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§åŸºæœ¬æ©Ÿèƒ½ã‚’ã”åˆ©ç”¨ã„ãŸã ã‘ã¾ã™ã€‚',
              {
                action: 'ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§ç¶šè¡Œ',
                callback: () => this.enableOfflineMode()
              }
            );
            this.markAsNotified('network');
          }
        }

        handleDataLoadingError(error) {
          console.warn('ğŸ“Š ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º:', error.message);
          
          if (!this.hasNotified('data_loading')) {
            this.showUserFriendlyError(
              'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã®å•é¡Œ',
              'ä¸€éƒ¨ã®ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã§åˆ†æã‚’ç¶™ç¶šã§ãã¾ã™ã€‚',
              {
                action: 'åˆ©ç”¨å¯èƒ½ãƒ‡ãƒ¼ã‚¿ã§ç¶šè¡Œ',
                callback: () => this.recoverWithPartialData()
              }
            );
            this.markAsNotified('data_loading');
          }
        }

        handleAnalysisError(error) {
          console.warn('ğŸ” åˆ†æã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º:', error.message);
          
          this.showUserFriendlyError(
            'åˆ†æå‡¦ç†ã®å•é¡Œ',
            'åˆ†æä¸­ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
            {
              action: 'å†è©¦è¡Œ',
              callback: () => this.retryLastAnalysis()
            }
          );
        }

        handleInputValidationError(error) {
          console.warn('âœï¸ å…¥åŠ›æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º:', error.message);
          
          this.showUserFriendlyError(
            'å…¥åŠ›å†…å®¹ã®å•é¡Œ',
            'å…¥åŠ›ã•ã‚ŒãŸå†…å®¹ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã‚ˆã‚Šè©³ã—ã„å†…å®¹ã§å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚',
            {
              action: 'å…¥åŠ›å†…å®¹ã‚’ç¢ºèª',
              callback: () => this.highlightInputFields()
            }
          );
        }

        handleGenericError(error) {
          console.warn('âš ï¸ ä¸€èˆ¬çš„ãªã‚¨ãƒ©ãƒ¼ã‚’æ¤œå‡º:', error.message);
          
          this.showUserFriendlyError(
            'äºˆæœŸã—ãªã„å•é¡ŒãŒç™ºç”Ÿ',
            'ã‚·ã‚¹ãƒ†ãƒ ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã™ã‚‹ã“ã¨ã§è§£æ±ºã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚',
            {
              action: 'ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿',
              callback: () => window.location.reload()
            }
          );
        }

        showUserFriendlyError(title, message, action = null) {
          const errorModal = `
            <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="errorModal">
              <div class="bg-gray-800 rounded-lg p-6 max-w-md mx-4 border border-red-400">
                <div class="flex items-center mb-4">
                  <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                  </div>
                  <h3 class="ml-3 text-lg font-medium text-red-400">${title}</h3>
                </div>
                <p class="text-gray-300 mb-6">${message}</p>
                <div class="flex justify-end space-x-3">
                  <button onclick="document.getElementById('errorModal').remove()" 
                          class="px-4 py-2 bg-gray-600 text-gray-300 rounded hover:bg-gray-500 transition-colors">
                    é–‰ã˜ã‚‹
                  </button>
                  ${action ? `
                    <button onclick="window.errorHandler.executeAction('${action.callback.name}'); document.getElementById('errorModal').remove()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-500 transition-colors">
                      ${action.action}
                    </button>
                  ` : ''}
                </div>
              </div>
            </div>
          `;
          
          // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å‰Šé™¤
          const existingModal = document.getElementById('errorModal');
          if (existingModal) existingModal.remove();
          
          document.body.insertAdjacentHTML('beforeend', errorModal);
        }

        executeAction(actionName) {
          if (typeof this[actionName] === 'function') {
            this[actionName]();
          }
        }

        logError(errorInfo) {
          this.errorLog.unshift(errorInfo);
          if (this.errorLog.length > this.maxLogSize) {
            this.errorLog = this.errorLog.slice(0, this.maxLogSize);
          }
          
          // é–‹ç™ºè€…å‘ã‘ãƒ­ã‚°
          console.group('ğŸ” ã‚¨ãƒ©ãƒ¼è©³ç´°ãƒ­ã‚°');
          console.error('ã‚¨ãƒ©ãƒ¼æƒ…å ±:', errorInfo);
          console.groupEnd();
        }

        hasNotified(type) {
          return this.userNotifications.has(type);
        }

        markAsNotified(type) {
          this.userNotifications.add(type);
        }

        // å¾©æ—§æ©Ÿèƒ½
        enableFallbackMode() {
          window.kuromojiTokenizer = null;
          console.log('âœ… ç°¡æ˜“è§£æãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–');
          this.showToast('ç°¡æ˜“è§£æãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™', 'info');
        }

        enableOfflineMode() {
          console.log('âœ… ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹åŒ–');
          this.showToast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™', 'info');
        }

        recoverWithPartialData() {
          console.log('âœ… éƒ¨åˆ†ãƒ‡ãƒ¼ã‚¿ã§å¾©æ—§');
          this.showToast('åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã§å‡¦ç†ã‚’ç¶™ç¶šã—ã¾ã™', 'info');
        }

        retryLastAnalysis() {
          console.log('âœ… åˆ†æã‚’å†è©¦è¡Œ');
          // æœ€å¾Œã®åˆ†æã‚’å†å®Ÿè¡Œ
          const analyzeBtn = document.getElementById('aiGuessBtn');
          if (analyzeBtn && !analyzeBtn.disabled) {
            analyzeBtn.click();
          }
        }

        highlightInputFields() {
          const inputField = document.getElementById('worryText');
          if (inputField) {
            inputField.focus();
            inputField.style.borderColor = '#f59e0b';
            inputField.style.boxShadow = '0 0 5px rgba(245, 158, 11, 0.5)';
            setTimeout(() => {
              inputField.style.borderColor = '';
              inputField.style.boxShadow = '';
            }, 3000);
          }
        }

        async attemptKuromojiRecovery() {
          const retryKey = 'kuromoji_init';
          const attempts = this.retryAttempts.get(retryKey) || 0;
          
          if (attempts < this.maxRetries) {
            this.retryAttempts.set(retryKey, attempts + 1);
            console.log(`ğŸ”„ Kuromojiå¾©æ—§è©¦è¡Œ ${attempts + 1}/${this.maxRetries}`);
            
            try {
              await new Promise(resolve => setTimeout(resolve, 2000)); // 2ç§’å¾…æ©Ÿ
              if (typeof initializeOfflineFirstKuromoji === 'function') {
                await initializeOfflineFirstKuromoji();
                console.log('âœ… Kuromojiå¾©æ—§æˆåŠŸ');
                this.showToast('è¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³ãŒå¾©æ—§ã—ã¾ã—ãŸ', 'success');
              }
            } catch (error) {
              console.warn('âŒ Kuromojiå¾©æ—§å¤±æ•—:', error.message);
            }
          }
        }

        handleNetworkRestore() {
          console.log('ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¾©æ—§ã—ã¾ã—ãŸ');
          this.userNotifications.delete('network');
          this.showToast('ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šãŒå¾©æ—§ã—ã¾ã—ãŸ', 'success');
        }

        handleNetworkLoss() {
          console.log('ğŸŒ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šãŒå¤±ã‚ã‚Œã¾ã—ãŸ');
          this.showToast('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œã—ã¾ã™', 'warning');
        }

        showToast(message, type = 'info') {
          const toastColors = {
            success: 'bg-green-600',
            warning: 'bg-yellow-600',
            error: 'bg-red-600',
            info: 'bg-blue-600'
          };
          
          const toast = document.createElement('div');
          toast.className = `fixed top-4 right-4 ${toastColors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full`;
          toast.textContent = message;
          
          document.body.appendChild(toast);
          
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
          setTimeout(() => toast.classList.remove('translate-x-full'), 100);
          
          // è‡ªå‹•å‰Šé™¤
          setTimeout(() => {
            toast.classList.add('translate-x-full');
            setTimeout(() => toast.remove(), 300);
          }, 3000);
        }

        getErrorReport() {
          return {
            totalErrors: this.errorLog.length,
            recentErrors: this.errorLog.slice(0, 10),
            retryAttempts: Object.fromEntries(this.retryAttempts),
            notifiedTypes: Array.from(this.userNotifications)
          };
        }
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
      const errorHandler = new ComprehensiveErrorHandler();
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¢ã‚¯ã‚»ã‚¹ç”¨
      window.errorHandler = errorHandler;

      window.H384_CONTEXT_TYPE_LIST = [
          { "é€šã—ç•ªå·": 1, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 2, "context_type": "growth" },
          { "é€šã—ç•ªå·": 3, "context_type": "caution" },
          { "é€šã—ç•ªå·": 4, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 5, "context_type": "completion" },
          { "é€šã—ç•ªå·": 6, "context_type": "decline" },
          { "é€šã—ç•ªå·": 7, "context_type": "completion" },
          { "é€šã—ç•ªå·": 8, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 9, "context_type": "stable" },
          { "é€šã—ç•ªå·": 10, "context_type": "stable" },
          { "é€šã—ç•ªå·": 11, "context_type": "caution" },
          { "é€šã—ç•ªå·": 12, "context_type": "completion" },
          { "é€šã—ç•ªå·": 13, "context_type": "decline" },
          { "é€šã—ç•ªå·": 14, "context_type": "stable" },
          { "é€šã—ç•ªå·": 15, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 16, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 17, "context_type": "caution" },
          { "é€šã—ç•ªå·": 18, "context_type": "growth" },
          { "é€šã—ç•ªå·": 19, "context_type": "caution" },
          { "é€šã—ç•ªå·": 20, "context_type": "decline" },
          { "é€šã—ç•ªå·": 21, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 22, "context_type": "completion" },
          { "é€šã—ç•ªå·": 23, "context_type": "caution" },
          { "é€šã—ç•ªå·": 24, "context_type": "decline" },
          { "é€šã—ç•ªå·": 25, "context_type": "stable" },
          { "é€šã—ç•ªå·": 26, "context_type": "caution" },
          { "é€šã—ç•ªå·": 27, "context_type": "stable" },
          { "é€šã—ç•ªå·": 28, "context_type": "stable" },
          { "é€šã—ç•ªå·": 29, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 30, "context_type": "growth" },
          { "é€šã—ç•ªå·": 31, "context_type": "stable" },
          { "é€šã—ç•ªå·": 32, "context_type": "growth" },
          { "é€šã—ç•ªå·": 33, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 34, "context_type": "caution" },
          { "é€šã—ç•ªå·": 35, "context_type": "stable" },
          { "é€šã—ç•ªå·": 36, "context_type": "growth" },
          { "é€šã—ç•ªå·": 37, "context_type": "completion" },
          { "é€šã—ç•ªå·": 38, "context_type": "decline" },
          { "é€šã—ç•ªå·": 39, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 40, "context_type": "completion" },
          { "é€šã—ç•ªå·": 41, "context_type": "decline" },
          { "é€šã—ç•ªå·": 42, "context_type": "stable" },
          { "é€šã—ç•ªå·": 43, "context_type": "caution" },
          { "é€šã—ç•ªå·": 44, "context_type": "completion" },
          { "é€šã—ç•ªå·": 45, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 46, "context_type": "stable" },
          { "é€šã—ç•ªå·": 47, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 48, "context_type": "growth" },
          { "é€šã—ç•ªå·": 49, "context_type": "completion" },
          { "é€šã—ç•ªå·": 50, "context_type": "decline" },
          { "é€šã—ç•ªå·": 51, "context_type": "growth" },
          { "é€šã—ç•ªå·": 52, "context_type": "stable" },
          { "é€šã—ç•ªå·": 53, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 54, "context_type": "growth" },
          { "é€šã—ç•ªå·": 55, "context_type": "completion" },
          { "é€šã—ç•ªå·": 56, "context_type": "decline" },
          { "é€šã—ç•ªå·": 57, "context_type": "stable" },
          { "é€šã—ç•ªå·": 58, "context_type": "completion" },
          { "é€šã—ç•ªå·": 59, "context_type": "caution" },
          { "é€šã—ç•ªå·": 60, "context_type": "stable" },
          { "é€šã—ç•ªå·": 61, "context_type": "caution" },
          { "é€šã—ç•ªå·": 62, "context_type": "completion" },
          { "é€šã—ç•ªå·": 63, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 64, "context_type": "completion" },
          { "é€šã—ç•ªå·": 65, "context_type": "caution" },
          { "é€šã—ç•ªå·": 66, "context_type": "growth" },
          { "é€šã—ç•ªå·": 67, "context_type": "completion" },
          { "é€šã—ç•ªå·": 68, "context_type": "decline" },
          { "é€šã—ç•ªå·": 69, "context_type": "stable" },
          { "é€šã—ç•ªå·": 70, "context_type": "caution" },
          { "é€šã—ç•ªå·": 71, "context_type": "caution" },
          { "é€šã—ç•ªå·": 72, "context_type": "growth" },
          { "é€šã—ç•ªå·": 73, "context_type": "stable" },
          { "é€šã—ç•ªå·": 74, "context_type": "completion" },
          { "é€šã—ç•ªå·": 75, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 76, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 77, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 78, "context_type": "stable" },
          { "é€šã—ç•ªå·": 79, "context_type": "completion" },
          { "é€šã—ç•ªå·": 80, "context_type": "stable" },
          { "é€šã—ç•ªå·": 81, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 82, "context_type": "growth" },
          { "é€šã—ç•ªå·": 83, "context_type": "completion" },
          { "é€šã—ç•ªå·": 84, "context_type": "stable" },
          { "é€šã—ç•ªå·": 85, "context_type": "completion" },
          { "é€šã—ç•ªå·": 86, "context_type": "completion" },
          { "é€šã—ç•ªå·": 87, "context_type": "growth" },
          { "é€šã—ç•ªå·": 88, "context_type": "stable" },
          { "é€šã—ç•ªå·": 89, "context_type": "completion" },
          { "é€šã—ç•ªå·": 90, "context_type": "stable" },
          { "é€šã—ç•ªå·": 91, "context_type": "growth" },
          { "é€šã—ç•ªå·": 92, "context_type": "growth" },
          { "é€šã—ç•ªå·": 93, "context_type": "caution" },
          { "é€šã—ç•ªå·": 94, "context_type": "stable" },
          { "é€šã—ç•ªå·": 95, "context_type": "decline" },
          { "é€šã—ç•ªå·": 96, "context_type": "completion" },
          { "é€šã—ç•ªå·": 97, "context_type": "decline" },
          { "é€šã—ç•ªå·": 98, "context_type": "decline" },
          { "é€šã—ç•ªå·": 99, "context_type": "growth" },
          { "é€šã—ç•ªå·": 100, "context_type": "caution" },
          { "é€šã—ç•ªå·": 101, "context_type": "growth" },
          { "é€šã—ç•ªå·": 102, "context_type": "caution" },
          { "é€šã—ç•ªå·": 103, "context_type": "completion" },
          { "é€šã—ç•ªå·": 104, "context_type": "decline" },
          { "é€šã—ç•ªå·": 105, "context_type": "growth" },
          { "é€šã—ç•ªå·": 106, "context_type": "stable" },
          { "é€šã—ç•ªå·": 107, "context_type": "caution" },
          { "é€šã—ç•ªå·": 108, "context_type": "decline" },
          { "é€šã—ç•ªå·": 109, "context_type": "completion" },
          { "é€šã—ç•ªå·": 110, "context_type": "completion" },
          { "é€šã—ç•ªå·": 111, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 112, "context_type": "completion" },
          { "é€šã—ç•ªå·": 113, "context_type": "caution" },
          { "é€šã—ç•ªå·": 114, "context_type": "stable" },
          { "é€šã—ç•ªå·": 115, "context_type": "completion" },
          { "é€šã—ç•ªå·": 116, "context_type": "completion" },
          { "é€šã—ç•ªå·": 117, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 118, "context_type": "stable" },
          { "é€šã—ç•ªå·": 119, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 120, "context_type": "growth" },
          { "é€šã—ç•ªå·": 121, "context_type": "completion" },
          { "é€šã—ç•ªå·": 122, "context_type": "completion" },
          { "é€šã—ç•ªå·": 123, "context_type": "growth" },
          { "é€šã—ç•ªå·": 124, "context_type": "caution" },
          { "é€šã—ç•ªå·": 125, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 126, "context_type": "growth" },
          { "é€šã—ç•ªå·": 127, "context_type": "stable" },
          { "é€šã—ç•ªå·": 128, "context_type": "decline" },
          { "é€šã—ç•ªå·": 129, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 130, "context_type": "stable" },
          { "é€šã—ç•ªå·": 131, "context_type": "stable" },
          { "é€šã—ç•ªå·": 132, "context_type": "growth" },
          { "é€šã—ç•ªå·": 133, "context_type": "stable" },
          { "é€šã—ç•ªå·": 134, "context_type": "completion" },
          { "é€šã—ç•ªå·": 135, "context_type": "decline" },
          { "é€šã—ç•ªå·": 136, "context_type": "decline" },
          { "é€šã—ç•ªå·": 137, "context_type": "stable" },
          { "é€šã—ç•ªå·": 138, "context_type": "decline" },
          { "é€šã—ç•ªå·": 139, "context_type": "growth" },
          { "é€šã—ç•ªå·": 140, "context_type": "completion" },
          { "é€šã—ç•ªå·": 141, "context_type": "growth" },
          { "é€šã—ç•ªå·": 142, "context_type": "growth" },
          { "é€šã—ç•ªå·": 143, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 144, "context_type": "growth" },
          { "é€šã—ç•ªå·": 145, "context_type": "completion" },
          { "é€šã—ç•ªå·": 146, "context_type": "decline" },
          { "é€šã—ç•ªå·": 147, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 148, "context_type": "stable" },
          { "é€šã—ç•ªå·": 149, "context_type": "caution" },
          { "é€šã—ç•ªå·": 150, "context_type": "stable" },
          { "é€šã—ç•ªå·": 151, "context_type": "stable" },
          { "é€šã—ç•ªå·": 152, "context_type": "decline" },
          { "é€šã—ç•ªå·": 153, "context_type": "caution" },
          { "é€šã—ç•ªå·": 154, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 155, "context_type": "growth" },
          { "é€šã—ç•ªå·": 156, "context_type": "stable" },
          { "é€šã—ç•ªå·": 157, "context_type": "growth" },
          { "é€šã—ç•ªå·": 158, "context_type": "completion" },
          { "é€šã—ç•ªå·": 159, "context_type": "caution" },
          { "é€šã—ç•ªå·": 160, "context_type": "caution" },
          { "é€šã—ç•ªå·": 161, "context_type": "decline" },
          { "é€šã—ç•ªå·": 162, "context_type": "growth" },
          { "é€šã—ç•ªå·": 163, "context_type": "stable" },
          { "é€šã—ç•ªå·": 164, "context_type": "completion" },
          { "é€šã—ç•ªå·": 165, "context_type": "caution" },
          { "é€šã—ç•ªå·": 166, "context_type": "growth" },
          { "é€šã—ç•ªå·": 167, "context_type": "decline" },
          { "é€šã—ç•ªå·": 168, "context_type": "stable" },
          { "é€šã—ç•ªå·": 169, "context_type": "growth" },
          { "é€šã—ç•ªå·": 170, "context_type": "decline" },
          { "é€šã—ç•ªå·": 171, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 172, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 173, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 174, "context_type": "growth" },
          { "é€šã—ç•ªå·": 175, "context_type": "growth" },
          { "é€šã—ç•ªå·": 176, "context_type": "decline" },
          { "é€šã—ç•ªå·": 177, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 178, "context_type": "completion" },
          { "é€šã—ç•ªå·": 179, "context_type": "decline" },
          { "é€šã—ç•ªå·": 180, "context_type": "decline" },
          { "é€šã—ç•ªå·": 181, "context_type": "growth" },
          { "é€šã—ç•ªå·": 182, "context_type": "growth" },
          { "é€šã—ç•ªå·": 183, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 184, "context_type": "caution" },
          { "é€šã—ç•ªå·": 185, "context_type": "caution" },
          { "é€šã—ç•ªå·": 186, "context_type": "completion" },
          { "é€šã—ç•ªå·": 187, "context_type": "stable" },
          { "é€šã—ç•ªå·": 188, "context_type": "decline" },
          { "é€šã—ç•ªå·": 189, "context_type": "caution" },
          { "é€šã—ç•ªå·": 190, "context_type": "stable" },
          { "é€šã—ç•ªå·": 191, "context_type": "decline" },
          { "é€šã—ç•ªå·": 192, "context_type": "decline" },
          { "é€šã—ç•ªå·": 193, "context_type": "stable" },
          { "é€šã—ç•ªå·": 194, "context_type": "decline" },
          { "é€šã—ç•ªå·": 195, "context_type": "caution" },
          { "é€šã—ç•ªå·": 196, "context_type": "stable" },
          { "é€šã—ç•ªå·": 197, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 198, "context_type": "growth" },
          { "é€šã—ç•ªå·": 199, "context_type": "completion" },
          { "é€šã—ç•ªå·": 200, "context_type": "completion" },
          { "é€šã—ç•ªå·": 201, "context_type": "caution" },
          { "é€šã—ç•ªå·": 202, "context_type": "stable" },
          { "é€šã—ç•ªå·": 203, "context_type": "decline" },
          { "é€šã—ç•ªå·": 204, "context_type": "growth" },
          { "é€šã—ç•ªå·": 205, "context_type": "stable" },
          { "é€šã—ç•ªå·": 206, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 207, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 208, "context_type": "growth" },
          { "é€šã—ç•ªå·": 209, "context_type": "completion" },
          { "é€šã—ç•ªå·": 210, "context_type": "caution" },
          { "é€šã—ç•ªå·": 211, "context_type": "completion" },
          { "é€šã—ç•ªå·": 212, "context_type": "caution" },
          { "é€šã—ç•ªå·": 213, "context_type": "caution" },
          { "é€šã—ç•ªå·": 214, "context_type": "growth" },
          { "é€šã—ç•ªå·": 215, "context_type": "growth" },
          { "é€šã—ç•ªå·": 216, "context_type": "growth" },
          { "é€šã—ç•ªå·": 217, "context_type": "stable" },
          { "é€šã—ç•ªå·": 218, "context_type": "decline" },
          { "é€šã—ç•ªå·": 219, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 220, "context_type": "stable" },
          { "é€šã—ç•ªå·": 221, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 222, "context_type": "completion" },
          { "é€šã—ç•ªå·": 223, "context_type": "completion" },
          { "é€šã—ç•ªå·": 224, "context_type": "completion" },
          { "é€šã—ç•ªå·": 225, "context_type": "stable" },
          { "é€šã—ç•ªå·": 226, "context_type": "growth" },
          { "é€šã—ç•ªå·": 227, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 228, "context_type": "growth" },
          { "é€šã—ç•ªå·": 229, "context_type": "completion" },
          { "é€šã—ç•ªå·": 230, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 231, "context_type": "stable" },
          { "é€šã—ç•ªå·": 232, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 233, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 234, "context_type": "growth" },
          { "é€šã—ç•ªå·": 235, "context_type": "growth" },
          { "é€šã—ç•ªå·": 236, "context_type": "completion" },
          { "é€šã—ç•ªå·": 237, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 238, "context_type": "growth" },
          { "é€šã—ç•ªå·": 239, "context_type": "caution" },
          { "é€šã—ç•ªå·": 240, "context_type": "growth" },
          { "é€šã—ç•ªå·": 241, "context_type": "completion" },
          { "é€šã—ç•ªå·": 242, "context_type": "completion" },
          { "é€šã—ç•ªå·": 243, "context_type": "growth" },
          { "é€šã—ç•ªå·": 244, "context_type": "growth" },
          { "é€šã—ç•ªå·": 245, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 246, "context_type": "growth" },
          { "é€šã—ç•ªå·": 247, "context_type": "completion" },
          { "é€šã—ç•ªå·": 248, "context_type": "completion" },
          { "é€šã—ç•ªå·": 249, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 250, "context_type": "completion" },
          { "é€šã—ç•ªå·": 251, "context_type": "growth" },
          { "é€šã—ç•ªå·": 252, "context_type": "growth" },
          { "é€šã—ç•ªå·": 253, "context_type": "completion" },
          { "é€šã—ç•ªå·": 254, "context_type": "decline" },
          { "é€šã—ç•ªå·": 255, "context_type": "caution" },
          { "é€šã—ç•ªå·": 256, "context_type": "caution" },
          { "é€šã—ç•ªå·": 257, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 258, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 259, "context_type": "growth" },
          { "é€šã—ç•ªå·": 260, "context_type": "decline" },
          { "é€šã—ç•ªå·": 261, "context_type": "caution" },
          { "é€šã—ç•ªå·": 262, "context_type": "stable" },
          { "é€šã—ç•ªå·": 263, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 264, "context_type": "decline" },
          { "é€šã—ç•ªå·": 265, "context_type": "completion" },
          { "é€šã—ç•ªå·": 266, "context_type": "stable" },
          { "é€šã—ç•ªå·": 267, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 268, "context_type": "growth" },
          { "é€šã—ç•ªå·": 269, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 270, "context_type": "completion" },
          { "é€šã—ç•ªå·": 271, "context_type": "stable" },
          { "é€šã—ç•ªå·": 272, "context_type": "decline" },
          { "é€šã—ç•ªå·": 273, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 274, "context_type": "growth" },
          { "é€šã—ç•ªå·": 275, "context_type": "caution" },
          { "é€šã—ç•ªå·": 276, "context_type": "completion" },
          { "é€šã—ç•ªå·": 277, "context_type": "stable" },
          { "é€šã—ç•ªå·": 278, "context_type": "decline" },
          { "é€šã—ç•ªå·": 279, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 280, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 281, "context_type": "decline" },
          { "é€šã—ç•ªå·": 282, "context_type": "growth" },
          { "é€šã—ç•ªå·": 283, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 284, "context_type": "growth" },
          { "é€šã—ç•ªå·": 285, "context_type": "decline" },
          { "é€šã—ç•ªå·": 286, "context_type": "caution" },
          { "é€šã—ç•ªå·": 287, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 288, "context_type": "stable" },
          { "é€šã—ç•ªå·": 289, "context_type": "completion" },
          { "é€šã—ç•ªå·": 290, "context_type": "completion" },
          { "é€šã—ç•ªå·": 291, "context_type": "caution" },
          { "é€šã—ç•ªå·": 292, "context_type": "growth" },
          { "é€šã—ç•ªå·": 293, "context_type": "caution" },
          { "é€šã—ç•ªå·": 294, "context_type": "growth" },
          { "é€šã—ç•ªå·": 295, "context_type": "completion" },
          { "é€šã—ç•ªå·": 296, "context_type": "stable" },
          { "é€šã—ç•ªå·": 297, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 298, "context_type": "stable" },
          { "é€šã—ç•ªå·": 299, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 300, "context_type": "decline" },
          { "é€šã—ç•ªå·": 301, "context_type": "stable" },
          { "é€šã—ç•ªå·": 302, "context_type": "completion" },
          { "é€šã—ç•ªå·": 303, "context_type": "growth" },
          { "é€šã—ç•ªå·": 304, "context_type": "caution" },
          { "é€šã—ç•ªå·": 305, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 306, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 307, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 308, "context_type": "caution" },
          { "é€šã—ç•ªå·": 309, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 310, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 311, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 312, "context_type": "stable" },
          { "é€šã—ç•ªå·": 313, "context_type": "stable" },
          { "é€šã—ç•ªå·": 314, "context_type": "completion" },
          { "é€šã—ç•ªå·": 315, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 316, "context_type": "stable" },
          { "é€šã—ç•ªå·": 317, "context_type": "decline" },
          { "é€šã—ç•ªå·": 318, "context_type": "stable" },
          { "é€šã—ç•ªå·": 319, "context_type": "completion" },
          { "é€šã—ç•ªå·": 320, "context_type": "completion" },
          { "é€šã—ç•ªå·": 321, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 322, "context_type": "stable" },
          { "é€šã—ç•ªå·": 323, "context_type": "caution" },
          { "é€šã—ç•ªå·": 324, "context_type": "stable" },
          { "é€šã—ç•ªå·": 325, "context_type": "stable" },
          { "é€šã—ç•ªå·": 326, "context_type": "decline" },
          { "é€šã—ç•ªå·": 327, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 328, "context_type": "stable" },
          { "é€šã—ç•ªå·": 329, "context_type": "caution" },
          { "é€šã—ç•ªå·": 330, "context_type": "growth" },
          { "é€šã—ç•ªå·": 331, "context_type": "completion" },
          { "é€šã—ç•ªå·": 332, "context_type": "decline" },
          { "é€šã—ç•ªå·": 333, "context_type": "caution" },
          { "é€šã—ç•ªå·": 334, "context_type": "stable" },
          { "é€šã—ç•ªå·": 335, "context_type": "decline" },
          { "é€šã—ç•ªå·": 336, "context_type": "stable" },
          { "é€šã—ç•ªå·": 337, "context_type": "growth" },
          { "é€šã—ç•ªå·": 338, "context_type": "decline" },
          { "é€šã—ç•ªå·": 339, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 340, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 341, "context_type": "decline" },
          { "é€šã—ç•ªå·": 342, "context_type": "completion" },
          { "é€šã—ç•ªå·": 343, "context_type": "completion" },
          { "é€šã—ç•ªå·": 344, "context_type": "decline" },
          { "é€šã—ç•ªå·": 345, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 346, "context_type": "completion" },
          { "é€šã—ç•ªå·": 347, "context_type": "caution" },
          { "é€šã—ç•ªå·": 348, "context_type": "growth" },
          { "é€šã—ç•ªå·": 349, "context_type": "caution" },
          { "é€šã—ç•ªå·": 350, "context_type": "decline" },
          { "é€šã—ç•ªå·": 351, "context_type": "growth" },
          { "é€šã—ç•ªå·": 352, "context_type": "growth" },
          { "é€šã—ç•ªå·": 353, "context_type": "stable" },
          { "é€šã—ç•ªå·": 354, "context_type": "growth" },
          { "é€šã—ç•ªå·": 355, "context_type": "caution" },
          { "é€šã—ç•ªå·": 356, "context_type": "caution" },
          { "é€šã—ç•ªå·": 357, "context_type": "stable" },
          { "é€šã—ç•ªå·": 358, "context_type": "decline" },
          { "é€šã—ç•ªå·": 359, "context_type": "decline" },
          { "é€šã—ç•ªå·": 360, "context_type": "stable" },
          { "é€šã—ç•ªå·": 361, "context_type": "completion" },
          { "é€šã—ç•ªå·": 362, "context_type": "caution" },
          { "é€šã—ç•ªå·": 363, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 364, "context_type": "completion" },
          { "é€šã—ç•ªå·": 365, "context_type": "conflict" },
          { "é€šã—ç•ªå·": 366, "context_type": "growth" },
          { "é€šã—ç•ªå·": 367, "context_type": "completion" },
          { "é€šã—ç•ªå·": 368, "context_type": "decline" },
          { "é€šã—ç•ªå·": 369, "context_type": "caution" },
          { "é€šã—ç•ªå·": 370, "context_type": "stable" },
          { "é€šã—ç•ªå·": 371, "context_type": "caution" },
          { "é€šã—ç•ªå·": 372, "context_type": "stable" },
          { "é€šã—ç•ªå·": 373, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 374, "context_type": "decline" },
          { "é€šã—ç•ªå·": 375, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 376, "context_type": "stable" },
          { "é€šã—ç•ªå·": 377, "context_type": "struggle" },
          { "é€šã—ç•ªå·": 378, "context_type": "stable" },
          { "é€šã—ç•ªå·": 379, "context_type": "completion" },
          { "é€šã—ç•ªå·": 380, "context_type": "decline" },
          { "é€šã—ç•ªå·": 381, "context_type": "nascent" },
          { "é€šã—ç•ªå·": 382, "context_type": "stable" },
          { "é€šã—ç•ªå·": 383, "context_type": "caution" },
          { "é€šã—ç•ªå·": 384, "context_type": "growth" },
          { "é€šã—ç•ªå·": 385, "context_type": "completion" },
          { "é€šã—ç•ªå·": 386, "context_type": "caution" }
    ];
Â  Â  Â  // --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
Â  Â  Â  let kuromojiTokenizer = null;
Â  Â  Â  let HAQEI_DATA = null;
Â  Â  Â  let H64_DATA = null;
Â  Â  Â  // H384_DATA ã¯ H384H64database.js ã§å®šç¾©æ¸ˆã¿
Â  Â  Â  let summaryChartInstance = null;
Â  Â  Â  let currentStateBarChartInstance = null;
Â  Â  Â  let currentAnalysisData = {}; // ç¾åœ¨ã®åˆ†æçµæœã‚’ä¿æŒã™ã‚‹

Â  Â  Â  // --- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ– ---
Â  Â  Â  async function initializeApp() {
Â  Â  Â  Â  const aiGuessBtn = document.getElementById("aiGuessBtn");
Â  Â  Â  Â  const manualAnalyzeBtn = document.getElementById("manualAnalyzeBtn");

Â  Â  Â  Â  const showLoadingState = (message, isLoading) => {
Â  Â  Â  Â  Â  const spinner = document.getElementById('loadingSpinner');
Â  Â  Â  Â  Â  const originalIcon = document.getElementById('originalIcon');
Â  Â  Â  Â  Â  const buttonText = document.getElementById('buttonText');

Â  Â  Â  Â  Â  if (isLoading) {
Â  Â  Â  Â  Â  Â  if(spinner) spinner.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  if(originalIcon) originalIcon.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if(buttonText) buttonText.textContent = message;
Â  Â  Â  Â  Â  Â  if(aiGuessBtn) aiGuessBtn.disabled = true;
Â  Â  Â  Â  Â  Â  if(manualAnalyzeBtn) {
              manualAnalyzeBtn.disabled = true;
              manualAnalyzeBtn.textContent = message;
            }
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  if(spinner) spinner.classList.add('hidden');
Â  Â  Â  Â  Â  Â  if(originalIcon) originalIcon.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  if(buttonText) buttonText.textContent = 'AIã«çŠ¶æ³ã‚’æ¨æ¸¬ã•ã›ã‚‹';
Â  Â  Â  Â  Â  Â  if(manualAnalyzeBtn) manualAnalyzeBtn.textContent = "äºˆæ¸¬å®Ÿè¡Œ";
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };

Â  Â  Â  Â  /**
         * initializeFutureSimulator - æ®µéšçš„åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹å®Ÿè£…
         * 
         * ç›®çš„ï¼š
         * - ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿â†’æ¤œè¨¼â†’ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ã®é †åºä¿è¨¼
         * - bunenjinå“²å­¦ã«åŸºã¥ã4æ®µéšåˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹
         * - Triple OSçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®å®‰å…¨ãªèµ·å‹•
         * 
         * å‡¦ç†å†…å®¹ï¼š
         * Phase 1: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèªï¼ˆH384_DATA, H64_DATAï¼‰
         * Phase 2: 386çˆ»ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼ï¼ˆå®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯ï¼‰
         * Phase 3: Future Simulatorçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
         * Phase 4: UIæœ‰åŠ¹åŒ–ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹é–‹æ”¾ï¼‰
         * 
         * å‡ºåŠ›ï¼š
         * - Promise<void>: åˆæœŸåŒ–å®Œäº†æ™‚ã«resolveã€å¤±æ•—æ™‚ã«reject
         * 
         * å‰¯ä½œç”¨ï¼š
         * - window.H384_DATA, H64_DATAã®ç¢ºèªãƒ»è¨­å®š
         * - setupDatalist()ã®å®Ÿè¡Œ
         * - UIè¦ç´ ã®æœ‰åŠ¹åŒ–
         * - è©³ç´°ãƒ­ã‚°ã®å‡ºåŠ›
         * 
         * å‰ææ¡ä»¶ï¼š
         * - H384H64database.jsã®èª­ã¿è¾¼ã¿å®Œäº†
         * - kuromojiè¾æ›¸ã®åˆæœŸåŒ–å®Œäº†
         * - DOMè¦ç´ ã®æº–å‚™å®Œäº†
         * 
         * ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼š
         * - Phaseå¤±æ•—æ™‚ã®è©³ç´°ã‚¨ãƒ©ãƒ¼æƒ…å ±å‡ºåŠ›
         * - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã®è‡ªå‹•å®Ÿè¡Œ
         * - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é©åˆ‡ãªã‚¨ãƒ©ãƒ¼é€šçŸ¥
         */
        async function initializeFutureSimulator() {
          console.log('ğŸš€ Future Simulatoræ®µéšçš„åˆæœŸåŒ–é–‹å§‹...');
          
          try {
            // Phase 1: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª
            console.log('ğŸ“‹ Phase 1: ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª...');
            if (!window.ensureH384Data || typeof window.ensureH384Data !== 'function') {
              throw new Error('ensureH384Dataé–¢æ•°ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
            
            const h384Data = window.ensureH384Data();
            if (!h384Data || !Array.isArray(h384Data) || h384Data.length !== 386) {
              throw new Error('H384_DATAåˆæœŸåŒ–å¤±æ•—: ãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™');
            }
            console.log('âœ… Phase 1å®Œäº†: H384_DATAç¢ºèªæ¸ˆã¿ (386ã‚¨ãƒ³ãƒˆãƒª)');
            
            // Phase 2: 386çˆ»ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼
            console.log('ğŸ” Phase 2: 386çˆ»ã‚·ã‚¹ãƒ†ãƒ æ¤œè¨¼...');
            if (typeof validateH384DataIntegrity === 'function') {
              const validation = validateH384DataIntegrity();
              if (!validation.passed) {
                console.warn('âš ï¸  Phase 2è­¦å‘Š: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ã§å•é¡ŒãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™', validation.tests);
              } else {
                console.log('âœ… Phase 2å®Œäº†: ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§æ¤œè¨¼åˆæ ¼');
              }
            } else {
              console.warn('âš ï¸  validateH384DataIntegrityé–¢æ•°ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ - æ¤œè¨¼ã‚’ã‚¹ã‚­ãƒƒãƒ—');
            }
            
            // Phase 3: Future Simulatorçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
            console.log('âš™ï¸  Phase 3: çµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–...');
            
            // H64_DATAã®ç¢ºèª
            if (typeof H64_DATA !== 'undefined' && Array.isArray(H64_DATA)) {
              console.log('âœ… H64_DATAç¢ºèªæ¸ˆã¿');
            } else {
              console.warn('âš ï¸  H64_DATAãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
            
            // futureThemeMapã®ç¢ºèª
            if (window.futureThemeMap) {
              console.log('âœ… futureThemeMapç¢ºèªæ¸ˆã¿');
            } else {
              console.warn('âš ï¸  futureThemeMapãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
            
            // setupDatalistã®å®Ÿè¡Œ
            if (typeof setupDatalist === 'function') {
              setupDatalist();
              console.log('âœ… setupDatalistå®Ÿè¡Œå®Œäº†');
            } else {
              console.warn('âš ï¸  setupDatalisté–¢æ•°ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
            }
            
            console.log('âœ… Phase 3å®Œäº†: çµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
            
            // Phase 4: UIæœ‰åŠ¹åŒ–
            console.log('ğŸ–¥ï¸  Phase 4: UIæœ‰åŠ¹åŒ–...');
            
            // ãƒœã‚¿ãƒ³ã‚„UIè¦ç´ ã®æœ‰åŠ¹åŒ–ï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
            const manualAnalyzeBtn = document.getElementById('manualAnalyzeBtn');
            if (manualAnalyzeBtn) {
              manualAnalyzeBtn.disabled = false;
              console.log('âœ… åˆ†æãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–');
            }
            
            // ãã®ä»–ã®UIè¦ç´ ã®æœ‰åŠ¹åŒ–
            const userTextInput = document.getElementById('userText');
            if (userTextInput) {
              userTextInput.disabled = false;
              console.log('âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æœ‰åŠ¹åŒ–');
            }
            
            console.log('âœ… Phase 4å®Œäº†: UIæœ‰åŠ¹åŒ–å®Œäº†');
            console.log('ğŸ‰ Future Simulatoræ®µéšçš„åˆæœŸåŒ–å®Œå…¨å®Œäº†');
            
          } catch (error) {
            console.error('âŒ Future SimulatoråˆæœŸåŒ–å¤±æ•—:', error);
            console.error('è©³ç´°:', error.stack);
            throw new Error(`æ®µéšçš„åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹å¤±æ•—: ${error.message}`);
          }
        }

        showLoadingState("è¾æ›¸ãƒ‡ãƒ¼ã‚¿èª­è¾¼ä¸­...", true);

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  const [apiData] = await Promise.all([
Â  Â  Â  Â  Â  Â  // 404ã‚¨ãƒ©ãƒ¼ä¿®æ­£: /api/dataå‰Šé™¤ - ãƒ­ãƒ¼ã‚«ãƒ«H384_DATAä½¿ç”¨
            Promise.resolve({}),
Â  Â  Â  Â  Â  Â  new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  // æœ¬ç•ªç’°å¢ƒã§ã®è¾æ›¸ãƒ‘ã‚¹æœ€é©åŒ–ï¼ˆCDNã‚’ç¶™ç¶šä½¿ç”¨ã§å®‰å®šæ€§ç¢ºä¿ï¼‰
              // é«˜ä¿¡é ¼æ€§kuromojiåˆæœŸåŒ–ã¸ç§»è¡Œï¼ˆ90%æˆåŠŸç‡å®Ÿç¾ï¼‰
              await initializeOfflineFirstKuromoji();
              resolve(); // kuromojiåˆæœŸåŒ–ã¯æ—¢ã«å®Œäº†ã—ã¦ã„ã‚‹ãŸã‚ã€å¾Œç¶šå‡¦ç†ã¯ä¸è¦
              } catch (error) {
                console.error('kuromojiåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚resolveã—ã¦å‡¦ç†ã‚’ç¶šè¡Œ - ç°¡æ˜“tokenizerã§å‹•ä½œ
                resolve();
              }
Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  ]);

Â  Â  Â  Â  Â  // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ä½¿ç”¨ï¼ˆ404ã‚¨ãƒ©ãƒ¼ä¿®æ­£ï¼‰- HAQEI_DATAä¸è¦
Â  Â  Â  Â  Â  // H64_DATA ã¯æ—¢ã« H384H64database.js ã§å®šç¾©æ¸ˆã¿
          if (typeof H64_DATA !== 'undefined') {
            console.log('âœ… H64_DATA ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨');
          } else {
            console.warn('âš ï¸  H64_DATA ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
          }
Â  Â  Â  Â  Â  // H384_DATA ã¯æ—¢ã« window.H384_DATA ã§åˆ©ç”¨å¯èƒ½
          if (window.H384_DATA) {
            H384_DATA = window.H384_DATA; // ãƒ­ãƒ¼ã‚«ãƒ«å¤‰æ•°ã¨ã—ã¦å‚ç…§
            console.log('âœ… H384_DATA ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ä½¿ç”¨ (386ã‚¨ãƒ³ãƒˆãƒª)');
          } else {
            console.error('âŒ H384_DATA ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ã‚’å®Ÿè¡Œ');
            if (typeof window.ensureH384Data === 'function') {
              window.ensureH384Data();
              H384_DATA = window.H384_DATA;
            }
          }
Â  Â  Â  Â  Â  // â–¼â–¼ context_typeãƒãƒ¼ã‚¸å‡¦ç†ã‚’ã“ã“ã«è¿½åŠ  â–¼â–¼
Â  Â  Â  Â  Â  if (window.H384_CONTEXT_TYPE_LIST && Array.isArray(window.H384_CONTEXT_TYPE_LIST)) {
Â  Â  Â  Â  Â  Â  const contextTypeMap = Object.fromEntries(window.H384_CONTEXT_TYPE_LIST.map(item => [item["é€šã—ç•ªå·"], item["context_type"]]));
Â  Â  Â  Â  Â  Â  H384_DATA = H384_DATA.map(obj => ({ ...obj, context_type: contextTypeMap[obj["é€šã—ç•ªå·"]] || null }));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  // â–²â–² context_typeãƒãƒ¼ã‚¸å‡¦ç†ã“ã“ã¾ã§ â–²â–²
          // futureThemeMapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’Mapã«å¤‰æ›
          if (window.futureThemeMap && typeof window.futureThemeMap === "object" && !(window.futureThemeMap instanceof Map)) {
            window.futureThemeMap = new Map(Object.entries(window.futureThemeMap));
            console.log("futureThemeMapã‚’Mapã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›ã—ã¾ã—ãŸã€‚");
          }
Â  Â  Â  Â  Â  // æ®µéšçš„åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹ã®å®Ÿè¡Œ
          await initializeFutureSimulator();
Â  Â  Â  Â  Â  console.log("âœ… Future Simulatorå®Œå…¨åˆæœŸåŒ–å®Œäº†");
Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  console.error("ãƒ‡ãƒ¼ã‚¿ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸ:", error);
Â  Â  Â  Â  Â  showModal(`<h2 class="text-2xl font-bold text-red-400 mb-4">åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼</h2><p>å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p><p class="mt-2 text-sm text-gray-500">${error}</p>`);
Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  showLoadingState("AIã«çŠ¶æ³ã‚’æ¨æ¸¬ã•ã›ã‚‹", false);
Â  Â  Â  Â  }
Â  Â  Â  }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã¨ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ ---
    // Progressive Loading System
    class ProgressiveLoader {
      constructor() {
        this.loadingSteps = [
          { name: 'dependencies', weight: 20 },
          { name: 'interface', weight: 30 },
          { name: 'data', weight: 25 },
          { name: 'modules', weight: 25 }
        ];
        this.currentStep = 0;
        this.progress = 0;
      }
      
      updateProgress(stepProgress = 100) {
        const step = this.loadingSteps[this.currentStep];
        if (!step) return;
        
        const stepWeight = step.weight;
        const totalPreviousWeight = this.loadingSteps.slice(0, this.currentStep)
          .reduce((sum, s) => sum + s.weight, 0);
        
        this.progress = totalPreviousWeight + (stepWeight * stepProgress / 100);
        
        const progressBar = document.getElementById('loading-progress');
        if (progressBar) {
          progressBar.style.width = `${this.progress}%`;
        }
        
        if (stepProgress >= 100) {
          this.currentStep++;
        }
      }
      
      async hideLoadingScreen() {
        const loadingScreen = document.getElementById('initial-loading');
        const mainContainer = document.getElementById('main-container');
        
        await this.animateProgress(100);
        
        setTimeout(() => {
          loadingScreen.style.opacity = '0';
          setTimeout(() => {
            loadingScreen.style.display = 'none';
            mainContainer.style.opacity = '1';
            this.startProgressiveContentLoad();
          }, 300);
        }, 500);
      }
      
      async animateProgress(target) {
        return new Promise(resolve => {
          const animate = () => {
            if (this.progress < target) {
              this.progress += 2;
              document.getElementById('loading-progress').style.width = `${this.progress}%`;
              requestAnimationFrame(animate);
            } else {
              resolve();
            }
          };
          animate();
        });
      }
      
      startProgressiveContentLoad() {
        // Load interface elements progressively
        setTimeout(() => this.showInputSection(), 100);
        setTimeout(() => this.enableLazyLoading(), 300);
      }
      
      showInputSection() {
        const inputSection = document.getElementById('input-section');
        const inputSkeleton = document.getElementById('input-skeleton');
        const inputContent = document.getElementById('input-content');
        
        if (inputSection && inputSkeleton && inputContent) {
          setTimeout(() => {
            inputSkeleton.style.display = 'none';
            inputContent.style.display = 'block';
            inputSection.classList.add('loaded');
          }, 800);
        }
      }
      
      enableLazyLoading() {
        // Lazy load Chart.js when needed
        this.lazyLoadCharts();
        
        // Lazy load heavy modules
        this.lazyLoadAnalysisModules();
        
        // Lazy load images
        this.lazyLoadImages();
        
        // Add error handling
        this.addErrorHandling();
      }
      
      lazyLoadImages() {
        const images = document.querySelectorAll('img[data-src]');
        
        if ('IntersectionObserver' in window) {
          const imageObserver = new IntersectionObserver((entries, observer) => {
            entries.forEach(entry => {
              if (entry.isIntersecting) {
                const img = entry.target;
                img.src = img.dataset.src;
                img.classList.remove('lazy');
                imageObserver.unobserve(img);
              }
            });
          });
          
          images.forEach(img => imageObserver.observe(img));
        } else {
          // Fallback for older browsers
          images.forEach(img => {
            img.src = img.dataset.src;
            img.classList.remove('lazy');
          });
        }
      }
      
      addErrorHandling() {
        window.addEventListener('error', (event) => {
          console.warn('âš ï¸ Progressive loading error:', event.error);
          this.handleLoadingError(event.error);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
          console.warn('âš ï¸ Progressive loading promise rejection:', event.reason);
          this.handleLoadingError(event.reason);
        });
      }
      
      handleLoadingError(error) {
        // Graceful degradation - show content even if some loading fails
        const skeletons = document.querySelectorAll('.skeleton, .skeleton-input, .summary-skeleton, .chart-skeleton');
        skeletons.forEach(skeleton => {
          skeleton.style.display = 'none';
        });
        
        const content = document.querySelectorAll('.input-content, .summary-content, .chart-content');
        content.forEach(element => {
          element.style.display = 'block';
        });
        
        // Hide loading overlays
        this.hideResultsLoading();
        
        console.log('âœ… Graceful degradation applied due to loading error');
      }
      
      async lazyLoadCharts() {
        if (!window.Chart) {
          console.log('ğŸ“Š Chart.js already loaded');
          return;
        }
        
        // Pre-warm chart container
        const chartContainers = document.querySelectorAll('.chart-container');
        chartContainers.forEach(container => {
          container.style.transition = 'opacity 0.3s ease';
        });
      }
      
      async lazyLoadAnalysisModules() {
        // Lazy load analysis engines when user is about to analyze
        const aiGuessBtn = document.getElementById('aiGuessBtn');
        const manualAnalyzeBtn = document.getElementById('manualAnalyzeBtn');
        
        if (aiGuessBtn) {
          aiGuessBtn.addEventListener('mouseenter', this.preloadAnalysisModules, { once: true });
        }
        if (manualAnalyzeBtn) {
          manualAnalyzeBtn.addEventListener('mouseenter', this.preloadAnalysisModules, { once: true });
        }
      }
      
      preloadAnalysisModules() {
        console.log('ğŸ”„ Pre-loading analysis modules...');
        // Analysis modules are already loaded via script tags, 
        // but we can warm up the engines here
        if (window.FutureSimulator) {
          window.FutureSimulator.warmUp?.();
        }
      }
      
      showResultsWithSkeleton() {
        const resultArea = document.getElementById('resultArea');
        const resultsLoading = document.getElementById('results-loading');
        
        if (resultArea) {
          resultArea.classList.remove('hidden');
          resultArea.style.opacity = '0';
          
          // Show loading overlay
          if (resultsLoading) {
            resultsLoading.style.display = 'flex';
          }
          
          // Fade in result area
          setTimeout(() => {
            resultArea.style.opacity = '1';
          }, 100);
        }
      }
      
      hideResultsLoading() {
        const resultsLoading = document.getElementById('results-loading');
        if (resultsLoading) {
          resultsLoading.style.opacity = '0';
          setTimeout(() => {
            resultsLoading.style.display = 'none';
          }, 300);
        }
      }
      
      showSummaryContent() {
        const summaryContent = document.getElementById('summary-content');
        const summarySkeleton = document.getElementById('summary-skeleton');
        
        if (summaryContent && summarySkeleton) {
          setTimeout(() => {
            summarySkeleton.style.display = 'none';
            summaryContent.style.display = 'block';
            summaryContent.classList.add('fade-in');
          }, 500);
        }
      }
      
      showChart(chartId, skeletonId) {
        const chart = document.getElementById(chartId);
        const skeleton = document.getElementById(skeletonId);
        
        if (chart && skeleton) {
          setTimeout(() => {
            skeleton.style.display = 'none';
            chart.style.display = 'block';
            chart.classList.add('fade-in');
          }, 300);
        }
      }
    }
    
    // Initialize progressive loader
    const progressiveLoader = new ProgressiveLoader();
    
    // Enhanced loading sequence
    window.addEventListener('load', async () => {
      progressiveLoader.updateProgress(100); // Dependencies loaded
      
      setTimeout(() => {
        progressiveLoader.updateProgress(100); // Interface ready
      }, 200);
      
      setTimeout(() => {
        progressiveLoader.updateProgress(100); // Data loaded
      }, 400);
      
      setTimeout(() => {
        progressiveLoader.updateProgress(100); // Modules ready
        progressiveLoader.hideLoadingScreen();
      }, 600);
    });
    
    // Override the original result display function to use progressive loading
    const originalShowResults = window.showResults;
    window.showResults = function(data) {
      progressiveLoader.showResultsWithSkeleton();
      
      // Show skeletons first
      setTimeout(() => {
        if (originalShowResults) {
          originalShowResults(data);
        }
        progressiveLoader.hideResultsLoading();
        progressiveLoader.showSummaryContent();
        progressiveLoader.showChart('currentStateBarChart', 'chart-skeleton');
        progressiveLoader.showChart('summaryChart', 'summary-chart-skeleton');
      }, 1000);
    };

    document.addEventListener("DOMContentLoaded", () => {
        const agreementCheckbox = document.getElementById('agreementCheckbox');
        const aiGuessBtn = document.getElementById('aiGuessBtn');
        const manualAnalyzeBtn = document.getElementById('manualAnalyzeBtn');
        const worryInput = document.getElementById("worryInput");

        // ãƒœã‚¿ãƒ³ã®æœ‰åŠ¹/ç„¡åŠ¹ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        const updateButtonState = () => {
            const isChecked = agreementCheckbox.checked;
            if (aiGuessBtn && manualAnalyzeBtn && !aiGuessBtn.textContent.includes('èª­è¾¼ä¸­')) {
                aiGuessBtn.disabled = !isChecked;
                manualAnalyzeBtn.disabled = !isChecked;
            }
        };

        // ãƒ¡ã‚¤ãƒ³ã®åˆ†æå‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°
        const handleAnalysis = async (isManual = false) => {
            let hexagramNumber, lineNumber, resultPaths, reasoning = null, explanation = null, result = null;
            
            // MLçµ±åˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆåˆå›ã®ã¿ï¼‰
            if (!window.mlIntegration.getSystemStatus().initialized) {
                await window.mlIntegration.initialize();
            }

            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
            const spinner = document.getElementById('loadingSpinner');
            const originalIcon = document.getElementById('originalIcon');
            const buttonText = document.getElementById('buttonText');
            spinner.classList.remove('hidden');
            originalIcon.classList.add('hidden');
            buttonText.textContent = 'AIãŒè§£æä¸­...';
            aiGuessBtn.disabled = true;
            manualAnalyzeBtn.disabled = true;

            try {
                if (isManual) {
                    const hexagramInput = document.getElementById("hexagramInput").value.trim();
                    const lineInputValue = document.getElementById("lineInput").value;
                    
                    // å…¥åŠ›æ¤œè¨¼ã®å¼·åŒ–
                    if (!hexagramInput) {
                        throw new Error('å…¥åŠ›æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: å˜æ›´ã®åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    }
                    
                    if (!lineInputValue || isNaN(parseInt(lineInputValue, 10))) {
                        throw new Error('å…¥åŠ›æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: æœ‰åŠ¹ãªçˆªç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    }
                    
                    lineNumber = parseInt(lineInputValue, 10);
                    
                    if (lineNumber < 1 || lineNumber > 6) {
                        throw new Error('å…¥åŠ›æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: çˆªç•ªå·ã¯1ã‹ã‚‰6ã®ç¯„å›²ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                    }
                    hexagramNumber = parseInt(hexagramInput);
                    if (isNaN(hexagramNumber)) {
                        const foundHex = H64_DATA.find((h) => h.åå‰ === hexagramInput);
                        hexagramNumber = foundHex ? foundHex.å¦ç•ªå· : null;
                    }
                    if (!hexagramNumber || isNaN(lineNumber) || lineNumber < 1 || lineNumber > 6) {
                        alert("æœ‰åŠ¹ãªå¦ã¨çˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
                        return;
                    }
                } else {
                    const worryText = worryInput.value.trim();
                    if (!isInputSufficient(worryText).isValid) {
                        showModal(`<h2 class="text-2xl font-bold text-yellow-400 mb-4">å…¥åŠ›å†…å®¹ã®ã”ç¢ºèª</h2><p>ã‚ãªãŸã®çŠ¶æ³ã‚’ã‚ˆã‚Šæ·±ãç†è§£ã™ã‚‹ãŸã‚ã«ã€ã‚‚ã†å°‘ã—è©³ã—ãæ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ã€‚</p>`);
                        return;
                    }

                    // æ‹¡å¼µã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ¤å®šã‚’å®Ÿè¡Œï¼ˆçŠ¶æ³å¦ç²¾åº¦å‘ä¸Šã‚·ã‚¹ãƒ†ãƒ ï¼‰
                    const contextResult = await analyzeContextTypeEnhanced(worryText, null, true);
                    console.log('ğŸŒ æ‹¡å¼µã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æçµæœ:', contextResult);
                    
                    // å¾“æ¥äº’æ›æ€§ã®ãŸã‚ã®contextType
                    const contextType = contextResult.primary;
                    
                    // MLå¼·åŒ–äºˆæ¸¬ã‚’è©¦è¡Œï¼ˆæ‹¡å¼µçµæœã¨çµ±åˆï¼‰
                    let mlEnhancedResult = null;
                    try {
                        if (window.mlIntegration) {
                            const analysisInput = {
                                inputText: worryText,
                                contextType: contextType,
                                worryLevel: estimateWorryLevel(worryText),
                                // æ‹¡å¼µåˆ†æçµæœã‚‚å«ã‚ã‚‹
                                enhancedContext: contextResult.analysis?.enhancedAnalysis || null,
                                isHSPCase: contextResult.analysis?.enhancedAnalysis?.isHSPCase || false,
                                isMultidimensional: contextResult.analysis?.enhancedAnalysis?.isMultidimensional || false
                            };
                            
                            mlEnhancedResult = await window.mlIntegration.enhanceFutureSimulation(analysisInput);
                            console.log('ğŸ§  MLå¼·åŒ–äºˆæ¸¬:', mlEnhancedResult);
                        }
                    } catch (error) {
                        console.log('âš ï¸ MLäºˆæ¸¬ã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå¾“æ¥æ–¹å¼ã§ç¶™ç¶šï¼‰:', error.message);
                    }

                    // æ‹¡å¼µå¯¾å¿œç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                    const confirmResult = await showContextConfirmModalEnhanced(contextResult);

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠã«å¿œã˜ã¦å‡¦ç†ã‚’åˆ†å²
                    let finalContextType = contextType;
                    if (!confirmResult) {
                        // ã€Œã„ã„ãˆã€ã‚’é¸æŠã—ãŸå ´åˆã€ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’åˆ‡ã‚Šæ›¿ãˆã¦å†åº¦ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                        const switchedContextType = contextType === 'personal' ? 'social' : 'personal';
                        await showContextSwitchModal(switchedContextType);
                        finalContextType = switchedContextType;
                    }

                    // MLå¼·åŒ–çµæœãŒã‚ã‚‹å ´åˆã¯å„ªå…ˆçš„ã«ä½¿ç”¨
                    if (mlEnhancedResult && mlEnhancedResult.ml_enhanced) {
                        console.log('ğŸ§  MLå¼·åŒ–äºˆæ¸¬ã‚’æ¡ç”¨');
                        hexagramNumber = mlEnhancedResult.hexagram;
                        lineNumber = mlEnhancedResult.line;
                        reasoning = `ğŸ§  MLå¼·åŒ–åˆ†æï¼ˆç²¾åº¦: ${mlEnhancedResult.enhancement_info.accuracy_estimate}ï¼‰\n\n${mlEnhancedResult.reasoning}`;
                        explanation = `ã“ã®åˆ†æã¯5000ä»¶ã®ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã§è¨“ç·´ã•ã‚ŒãŸæ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ï¼ˆ${mlEnhancedResult.enhancement_info.model_version}ï¼‰ã«ã‚ˆã‚‹äºˆæ¸¬çµæœã§ã™ã€‚`;
                        
                        // MLçµæœã‹ã‚‰æš«å®šçš„ãªåˆ†æçµæœã‚’æ§‹ç¯‰
                        result = {
                            å¦ç•ªå·: hexagramNumber,
                            çˆ»ç•ªå·: lineNumber,
                            æ ¹æ‹ : reasoning,
                            è§£èª¬: explanation,
                            ml_enhanced: true,
                            confidence: mlEnhancedResult.confidence
                        };
                    } else {
                        // å¾“æ¥ã®AIæ¨æ¸¬ã‚’å®Ÿè¡Œ
                        console.log('ğŸ”„ å¾“æ¥ã®AIåˆ†æã‚’å®Ÿè¡Œ');
                        result = await callAIAssistant(worryText, H384_DATA, window.futureThemeMap, finalContextType);
                        if (!result) {
                            showModal(`<h2 class="text-2xl font-bold text-red-400 mb-4">AIæ¨æ¸¬ã‚¨ãƒ©ãƒ¼</h2><p>çŠ¶æ³ã«åˆè‡´ã™ã‚‹å¦ã‚’è¦‹ã¤ã‘ã‚‰ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚è¡¨ç¾ã‚’å¤‰ãˆã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</p>`);
                            return;
                        }
                        hexagramNumber = result.å¦ç•ªå·;
                        lineNumber = result.çˆ»ç•ªå·;
                        reasoning = result.æ ¹æ‹ ;
                        explanation = result.è§£èª¬;
                    }
                }

                resultPaths = generateAllPaths(hexagramNumber, lineNumber);
                if (resultPaths && resultPaths.length > 0) {
                    const analysisEvidence = result && result.analysisEvidence ? result.analysisEvidence : null;
                    updateUI(resultPaths, reasoning, explanation, analysisEvidence); // UIã‚’æ›´æ–°ã—ã¦çµæœã‚’è¡¨ç¤º
                } else {
                    alert("åˆ†æçµæœã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }
            } catch (error) {
                console.error("åˆ†æå‡¦ç†ã§ã‚¨ãƒ©ãƒ¼:", error);
                
                // Chromeæ‹¡å¼µæ©Ÿèƒ½é–¢é€£ã‚¨ãƒ©ãƒ¼ã®åŒ…æ‹¬çš„æ¤œå‡ºï¼ˆå¼·åŒ–ç‰ˆï¼‰
                const isExtensionError = (error) => {
                  const extensionPatterns = [
                    'message port', 'chrome-extension', 'moz-extension', 'safari-extension',
                    'Extension context invalidated', 'Could not establish connection',
                    'Receiving end does not exist', 'response was received', 'port closed',
                    'context invalidated', 'content.js', 'background.js', 'popup.js', 'extension:'
                  ];
                  
                  return extensionPatterns.some(pattern => 
                    (error.message && error.message.includes(pattern)) ||
                    (error.stack && error.stack.includes(pattern)) ||
                    (error.toString && error.toString().includes(pattern))
                  );
                };
                
                // Chromeæ‹¡å¼µæ©Ÿèƒ½ã®ã‚¨ãƒ©ãƒ¼ã§ãªã„å ´åˆã®ã¿ã‚¢ãƒ©ãƒ¼ãƒˆè¡¨ç¤º
                if (!isExtensionError(error)) {
                    alert(`åˆ†æå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
                }
            } finally {
                spinner.classList.add('hidden');
                originalIcon.classList.remove('hidden');
                buttonText.textContent = 'AIã«çŠ¶æ³ã‚’æ¨æ¸¬ã•ã›ã‚‹';
                updateButtonState();
            }
        };

        // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š ---
        initializeApp().then(() => {
            updateButtonState(); // åˆæœŸåŒ–å®Œäº†å¾Œã«ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’æ›´æ–°
            
            // MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§éåŒæœŸåˆæœŸåŒ–ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
            initializeMLPredictor().then(success => {
              if (success) {
                console.log('ğŸš€ MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ãŒãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§åˆ©ç”¨å¯èƒ½ã«ãªã‚Šã¾ã—ãŸ');
              }
            }).catch(error => {
              console.log('âš ï¸ MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ:', error.message);
            });
        });

        agreementCheckbox.addEventListener('change', updateButtonState);

        aiGuessBtn.addEventListener("click", () => {
            if (!agreementCheckbox.checked) {
                alert('åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            handleAnalysis(false);
        });

        manualAnalyzeBtn.addEventListener("click", () => {
            if (!agreementCheckbox.checked) {
                alert('åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            handleAnalysis(true);
        });
        
        document.getElementById("modalOverlay").addEventListener("click", hideModal);
        document.getElementById("modalCloseBtn").addEventListener("click", hideModal);
        document.getElementById("helpBtn").addEventListener("click", showHelpModal);
        document.body.addEventListener("click", function (event) {
            const paramHelpBtn = event.target.closest("#paramHelpBtn");
            if (paramHelpBtn) showParameterHelpModal();
        });
    });

    /**
     * é¸æŠã—ãŸã‚·ãƒŠãƒªã‚ªã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã€cockpit.htmlã¸é·ç§»ã™ã‚‹
     */
    function saveAndNavigateToCockpit(worryText, allPaths, selectedIndex) {
        if (!allPaths || allPaths.length === 0 || selectedIndex === undefined) {
            alert("åˆ†æãƒ‡ãƒ¼ã‚¿ã¾ãŸã¯é¸æŠã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªãŒã‚ã‚Šã¾ã›ã‚“ã€‚");
            return;
        }
        
        const dataToStore = {
            worry: worryText,
            paths: allPaths,
            selectedFuture: {
                path: allPaths[selectedIndex],
                rank: ["S", "A", "B", "C", "D", "E", "F", "H"][selectedIndex] || "N/A",
            }
        };

        try {
            localStorage.setItem("proFutureReportData", JSON.stringify(dataToStore));
            window.location.href = "cockpit.html";
        } catch (e) {
            console.error("localStorageã¸ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
        }
    }
    
    // ===================================================
    // ã“ã“ã‹ã‚‰ä¸‹ã¯ã€UIã®æç”»ã‚„ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’è¡Œã†ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ã§ã™
    // ===================================================

    function setupDatalist() {
        if (H64_DATA && H64_DATA.length > 0) {
            const datalist = document.getElementById("hexagram-names");
            H64_DATA.forEach((hex) => {
                const option = document.createElement("option");
                option.value = hex.åå‰;
                datalist.appendChild(option);
            });
        }
    }
    
    function updateUI(sortedPaths, reasoning = null, explanation = null, analysisEvidence = null) {
        const worryText = document.getElementById("worryInput").value;
        currentAnalysisData = {
            worry: worryText,
            paths: sortedPaths,
            analysisEvidence: analysisEvidence
        };

        document.getElementById("initialMessage").classList.add("hidden");
        document.getElementById("resultArea").classList.remove("hidden");

        const reasoningContainer = document.getElementById("aiReasoningContainer");
        if (reasoning) {
            // ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹åˆ†æçµæœã®è¡¨ç¤º
            let evidenceHtml = `<div class="evidence-based-analysis">
                <div class="analysis-main mb-4">
                    <p class="text-sm text-green-200">${reasoning}</p>
                </div>`;
            
            // åˆ†æã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãŒã‚ã‚‹å ´åˆã¯è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
            if (analysisEvidence) {
                evidenceHtml += `
                <div class="analysis-evidence mt-4 p-4 bg-gray-800 rounded-lg">
                    <h4 class="text-indigo-300 font-semibold mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        åˆ†æã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">`;
                
                // æ„Ÿæƒ…åˆ†æçµæœ
                if (analysisEvidence.sentiment_analysis) {
                    const sentiment = analysisEvidence.sentiment_analysis;
                    const polarityColor = sentiment.polarity === 'positive' ? 'text-green-400' : 
                                        sentiment.polarity === 'negative' ? 'text-red-400' : 'text-gray-400';
                    evidenceHtml += `
                        <div class="evidence-item">
                            <div class="text-gray-300 font-medium">æ„Ÿæƒ…åˆ†æ</div>
                            <div class="${polarityColor}">
                                ${sentiment.polarity === 'positive' ? 'ãƒã‚¸ãƒ†ã‚£ãƒ–' : 
                                  sentiment.polarity === 'negative' ? 'ãƒã‚¬ãƒ†ã‚£ãƒ–' : 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«'}
                                (å¼·åº¦: ${Math.round(sentiment.strength * 100)}%)
                            </div>
                        </div>`;
                }
                
                // å‡¦ç†æ‰‹æ³•
                if (analysisEvidence.processing_methods) {
                    evidenceHtml += `
                        <div class="evidence-item">
                            <div class="text-gray-300 font-medium">åˆ†ææ‰‹æ³•</div>
                            <div class="text-blue-400">${analysisEvidence.processing_methods.join(' + ')}</div>
                        </div>`;
                }
                
                // ä¿¡é ¼åº¦å†…è¨³
                if (analysisEvidence.confidence_breakdown) {
                    const breakdown = analysisEvidence.confidence_breakdown;
                    evidenceHtml += `
                        <div class="evidence-item">
                            <div class="text-gray-300 font-medium">ä¿¡é ¼åº¦å†…è¨³</div>
                            <div class="text-yellow-400">
                                ãƒ­ãƒ¼ã‚«ãƒ«: ${breakdown.local_analysis}%
                                ${breakdown.semantic_analysis ? `| API: ${breakdown.semantic_analysis}%` : ''}
                            </div>
                        </div>`;
                }
                
                // APIä½¿ç”¨çŠ¶æ³
                if (analysisEvidence.api_usage) {
                    const usage = analysisEvidence.api_usage;
                    evidenceHtml += `
                        <div class="evidence-item">
                            <div class="text-gray-300 font-medium">APIä½¿ç”¨çŠ¶æ³</div>
                            <div class="text-purple-400">
                                ä»Šæ—¥ã®ä½¿ç”¨: ${usage.requests_used}/${usage.requests_used + usage.requests_remaining}
                            </div>
                        </div>`;
                }
                
                evidenceHtml += `
                    </div>
                    
                    <!-- è©³ç´°å±•é–‹ãƒœã‚¿ãƒ³ -->
                    <button onclick="toggleDetailedEvidence()" class="mt-3 text-xs text-indigo-400 hover:text-indigo-300 transition-colors">
                        è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º â–¼
                    </button>
                    
                    <div id="detailed-evidence" class="hidden mt-3 p-3 bg-gray-900 rounded text-xs">
                        <div class="mb-2">
                            <strong class="text-gray-300">æŠ½å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong>
                            <div class="text-cyan-400 mt-1">
                                ${analysisEvidence.keyword_extraction ? analysisEvidence.keyword_extraction.join(', ') : 'N/A'}
                            </div>
                        </div>
                        <div>
                            <strong class="text-gray-300">å‡¦ç†è©³ç´°:</strong>
                            <pre class="text-gray-400 mt-1 text-xs overflow-x-auto">${JSON.stringify(analysisEvidence, null, 2)}</pre>
                        </div>
                    </div>
                </div>`;
            }
            
            // ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ ã‚’è¿½åŠ 
            evidenceHtml += `
                <div class="community-feedback mt-4 p-4 bg-gray-800/50 rounded-lg border border-gray-700">
                    <h4 class="text-purple-300 font-semibold mb-3 flex items-center">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                        </svg>
                        åˆ†æçµæœãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                    </h4>
                    <p class="text-sm text-gray-300 mb-3">ã“ã®åˆ†æçµæœã¯ã‚ãªãŸã®çŠ¶æ³ã‚’æ­£ç¢ºã«è¡¨ç¾ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ<br>
                    åŒ¿åã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãŒã‚·ã‚¹ãƒ†ãƒ æ”¹å–„ã«å½¹ç«‹ã¦ã‚‰ã‚Œã¾ã™ã€‚</p>
                    
                    <div class="feedback-buttons flex gap-2 mb-3">
                        <button onclick="submitFeedback('accurate', currentAnalysisData)" 
                                class="feedback-btn-positive px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm transition-colors">
                            âœ“ çš„ç¢ºã§ã—ãŸ
                        </button>
                        <button onclick="submitFeedback('somewhat', currentAnalysisData)" 
                                class="feedback-btn-neutral px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg text-sm transition-colors">
                            â–³ ã‚ã‚‹ç¨‹åº¦
                        </button>
                        <button onclick="submitFeedback('inaccurate', currentAnalysisData)" 
                                class="feedback-btn-negative px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm transition-colors">
                            âœ— çš„å¤–ã‚Œã§ã—ãŸ
                        </button>
                        <button onclick="requestInteractiveRefinement()" 
                                class="feedback-btn-refine px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg text-sm transition-colors">
                            ğŸ” ã‚ˆã‚Šè©³ã—ãåˆ†æ
                        </button>
                    </div>
                    
                    <div id="feedback-result" class="hidden text-sm"></div>
                    <div id="interactive-refinement" class="hidden mt-4 p-4 bg-indigo-900/30 rounded-lg border border-indigo-600/50"></div>
                </div>
            `;
            
            evidenceHtml += `</div>`;
            
            reasoningContainer.innerHTML = evidenceHtml;
            reasoningContainer.classList.remove("hidden");
        } else {
            reasoningContainer.classList.add("hidden");
        }

        const startState = sortedPaths[0][0];
        currentAnalysisData.startState = startState;
        document.getElementById("currentTitle").innerText = `ç¾åœ¨åœ°: ${startState["è¦ªã¨ãªã‚‹å¦"]} ${startState.çˆ»}`;
        document.getElementById("currentKeywords").innerText = `ãƒ†ãƒ¼ãƒ: ${startState.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ || ""}`;
        document.getElementById("currentSummary").innerText = startState.ç¾ä»£è§£é‡ˆã®è¦ç´„;
        
        const currentScore = startState.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢;
        const scoreEval = getScoreEvaluation(currentScore);
        document.getElementById("currentScore").innerText = `${currentScore} ç‚¹`;
        const scoreLabel = document.getElementById("currentScoreLabel");
        scoreLabel.innerText = scoreEval.label;
        scoreLabel.className = `eval-label ${scoreEval.colorClass}`;
        document.getElementById("currentScoreDesc").innerText = `â€» ${scoreEval.desc}`;
        
        const transitionCost = 100 - (startState.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢ || 50);
        const costEval = getTransitionCostEvaluation(transitionCost);
        document.getElementById("transitionCost").innerText = `${transitionCost} ç‚¹`;
        const costLabel = document.getElementById("transitionCostLabel");
        costLabel.innerText = costEval.label;
        costLabel.className = `eval-label ${costEval.colorClass}`;
        document.getElementById("transitionCostDesc").innerText = `â€» ${costEval.desc}`;
        
        document.getElementById("summaryCard").onclick = () => showCurrentStateModal(startState);
        renderCurrentStateBarChart(startState);

        const futureContentsWrapper = document.getElementById("futureContentsWrapper");
        const revealButtonContainer = document.getElementById("revealButtonContainer");
        const revealButton = document.getElementById("revealButton");

        futureContentsWrapper.classList.add("hidden", "opacity-0");
        futureContentsWrapper.classList.remove("future-contents-reveal");
        revealButtonContainer.classList.remove("hidden");
        revealButton.style.display = "inline-block";

        const revealHandler = () => {
            futureContentsWrapper.classList.remove("hidden");
            setTimeout(() => {
                futureContentsWrapper.classList.add("future-contents-reveal");
                futureContentsWrapper.scrollIntoView({ behavior: "smooth", block: "start" });
            }, 100);
            revealButton.style.display = "none";
        };
        revealButton.removeEventListener("click", revealHandler);
        revealButton.addEventListener("click", revealHandler, { once: true });

        renderSummaryChart(sortedPaths);
        renderDetailCards(sortedPaths);
        renderChartToggles(sortedPaths);
        setupInteraction(sortedPaths);
    }
      
    function renderDetailCards(sortedPaths) {
        const container = document.getElementById("detailCardsContainer");
        container.innerHTML = "";
        const rankLabels = ["S", "A", "B", "C", "D", "E", "F", "H"];
        
        const recommendationMessageEl = document.getElementById("aiRecommendationMessage");
        recommendationMessageEl.innerHTML = `AIã®åˆ†æã§ã¯ã€<strong class="text-green-300">ã‚·ãƒŠãƒªã‚ª1ï¼ˆSãƒ©ãƒ³ã‚¯ï¼‰</strong>ãŒã‚ãªãŸã®èª²é¡Œè§£æ±ºã¨æˆé•·ã«æœ€ã‚‚è²¢çŒ®ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br class="hidden sm:block">ã¾ãšã¯ã“ã¡ã‚‰ã®ç‰©èªã‹ã‚‰èª­ã‚“ã§ã¿ã¾ã›ã‚“ã‹ï¼Ÿ`;
        recommendationMessageEl.classList.remove("hidden");

        sortedPaths.forEach((path, index) => {
            const finalState = path[path.length - 1];
            const overallTrend = evaluateSpiralProgress(path[0], path[3]);
            const firstStepTrend = evaluateSpiralProgress(path[0], path[1]);
            const card = document.createElement("div");
            const rankClass = `rank-${rankLabels[index].toLowerCase()}`;
            const isRecommended = index === 0;

            card.id = `card-${index}`;
            card.className = `card relative bg-gray-900/50 p-4 rounded-xl border-2 border-transparent flex flex-col ${isRecommended ? "ai-recommended" : ""}`;
            card.dataset.index = index;
            card.addEventListener("click", (e) => {
                if (e.target.closest(".deep-dive-btn")) return;
                showScenarioModal(path, index, overallTrend, firstStepTrend);
            });

            const pathHistory = path.slice(1).map(p => p.choice === "change" ? "å¤‰" : "é€²").join(" â†’ ");
            const finalStateTitle = `${finalState["è¦ªã¨ãªã‚‹å¦"]} ${finalState.çˆ»}`;
            const badgeHtml = isRecommended ? `<div class="absolute top-2.5 right-2.5 bg-green-400 text-gray-900 text-xs font-bold px-3 py-1 rounded-full shadow-lg z-10">âœ¨ AIæ¨å¥¨</div>` : "";

            const buttonHtml = `
            <div class="mt-auto pt-4 border-t border-gray-700/50">
                <button class="deep-dive-btn inline-block w-full text-center font-bold py-2 px-4 rounded-lg text-sm" data-scenario-index="${index}">
                    ã“ã®æœªæ¥ã§ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆã¸
                </button>
            </div>`;

            card.innerHTML = `
                ${badgeHtml}
                <div class="flex items-start justify-between mb-2">
                    <h3 class="text-md font-bold text-gray-300">ã‚·ãƒŠãƒªã‚ª ${index + 1}</h3>
                    <span class="rank-badge ${rankClass}">${rankLabels[index]}</span>
                </div>
                <div class="text-xs text-gray-500 mb-3" style="min-height: 1em;">çµŒè·¯: ${pathHistory}</div>
                <div class="grid grid-cols-2 gap-2 mb-3 text-center">
                    <div><p class="text-[10px] text-gray-400 mb-1 font-semibold">å…¨ä½“ãƒˆãƒ¬ãƒ³ãƒ‰</p><div class="trend-badge ${overallTrend.colorClass}" title="${overallTrend.message}">${overallTrend.trend}</div></div>
                    <div><p class="text-[10px] text-gray-400 mb-1 font-semibold">åˆæœŸã‚¹ãƒ†ãƒƒãƒ—</p><div class="trend-badge ${firstStepTrend.colorClass}" title="${firstStepTrend.message}">${firstStepTrend.trend}</div></div>
                </div>
                <p class="text-lg font-semibold text-indigo-300">${finalStateTitle}</p>
                <div class="my-3" style="height: 110px; padding-left: 5px;"><canvas id="miniChart-${index}"></canvas></div>
                <p class="text-xs text-gray-400 mt-1 mb-4 flex-grow">${finalState.ç¾ä»£è§£é‡ˆã®è¦ç´„}</p>
                ${buttonHtml}
            `;
            container.appendChild(card);
        });

        container.querySelectorAll('.deep-dive-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                const scenarioIndex = parseInt(event.currentTarget.dataset.scenarioIndex, 10);
                saveAndNavigateToCockpit(currentAnalysisData.worry, currentAnalysisData.paths, scenarioIndex);
            });
        });

        sortedPaths.forEach((path, index) => {
            renderMiniBarChart(index, path[path.length - 1]);
        });
    }

      function renderMiniBarChart(index, state) {
        const ctx = document
          .getElementById(`miniChart-${index}`)
          .getContext("2d");
        const data = [
          state.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢,
          state.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«,
          state.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢,
          Math.abs(state.S4_ãƒªã‚¹ã‚¯),
          state.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢,
        ];
        const colors = [
          "rgba(96, 165, 250, 0.7)",
          "rgba(52, 211, 153, 0.7)",
          "rgba(167, 139, 250, 0.7)",
          "rgba(248, 113, 113, 0.7)",
          "rgba(251, 191, 36, 0.7)",
        ];
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼šChart.jsé«˜é€ŸåŒ–è¨­å®š
        const chartOptions = {
          responsive: true,
          maintainAspectRatio: false,
          animation: {
            duration: 800, // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“çŸ­ç¸®ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1000msâ†’800msï¼‰
            easing: 'easeOutQuart'
          },
          elements: {
            bar: {
              borderSkipped: false
            }
          },
          interaction: {
            mode: 'nearest',
            intersect: false
          }
        };
        
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["åŸºæœ¬", "æ½œåœ¨åŠ›", "å®‰å®šæ€§", "ãƒªã‚¹ã‚¯", "å¤‰å‹•æ€§"],
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderWidth: 0,
                barPercentage: 0.8,
                categoryPercentage: 0.9,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            scales: {
              x: { display: false, min: 0, max: 100 },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: "#9ca3af", font: { size: 10 } },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
          },
        });
      }

      function renderChartToggles(sortedPaths) {
        const container = document.getElementById("chartToggles");
        container.innerHTML = "";

        const getScenarioSummary = (path) => {
          const route = path
            .slice(1)
            .map((p) => (p.choice === "change" ? "å¤‰" : "é€²"));
          const routeText = route.join("â†’");
          const summaries = {
            "é€²â†’é€²â†’é€²": "ä¿¡ã˜ãŸé“ã‚’ã€ã¾ã£ã™ãé€²ã‚“ã§ã„ãæœªæ¥",
            "é€²â†’é€²â†’å¤‰": "ã˜ã£ãã‚Šè‚²ã¦ãŸãƒã‚«ãƒ©ã‚’ã€æ–°ã—ã„ä¸–ç•Œã§è©¦ã™æœªæ¥",
            "é€²â†’å¤‰â†’é€²": "å¯„ã‚Šé“ã§å¾—ãŸãƒ’ãƒ³ãƒˆã§ã€æœ¬æ¥ã®é“ã‚’è±Šã‹ã«ã™ã‚‹æœªæ¥",
            "é€²â†’å¤‰â†’å¤‰": "å¤‰åŒ–ã®æ³¢ã‚’ä¹—ã‚Šã“ãªã—ã€è»½ã‚„ã‹ã«é€²ã‚“ã§ã„ãæœªæ¥",
            "å¤‰â†’é€²â†’é€²":
              "æ–°ã—ã„ä¸–ç•Œã«é£›ã³è¾¼ã¿ã€ãã“ã‚’ã€Œè‡ªåˆ†ã®å±…å ´æ‰€ã€ã«ã™ã‚‹æœªæ¥",
            "å¤‰â†’é€²â†’å¤‰": "ã²ã¨ã¤ã®å ´æ‰€ã«å®‰ä½ã›ãšã€è‡ªç”±ã«å¯èƒ½æ€§ã‚’è©¦ã™æœªæ¥",
            "å¤‰â†’å¤‰â†’é€²": "è©¦è¡ŒéŒ¯èª¤ã®æ—…ã‚’çµŒã¦ã€ã€Œã“ã‚Œã ã€ã¨æ€ãˆã‚‹é“ã«å‡ºä¼šã†æœªæ¥",
            "å¤‰â†’å¤‰â†’å¤‰": "å¸¸è­˜ã‚’å¡—ã‚Šæ›¿ãˆã€æ–°ã—ã„æ™‚ä»£ã‚’åˆ‡ã‚Šæ‹“ã„ã¦ã„ãæœªæ¥",
          };
          return summaries[routeText] || "ã‚«ã‚¹ã‚¿ãƒ çµŒè·¯";
        };

        sortedPaths.forEach((path, index) => {
          const color =
            summaryChartInstance.data.datasets[index].originalBorderColor;
          const finalScore = path[path.length - 1].S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢;
          const scenarioSummary = getScenarioSummary(path);

          const legendItem = document.createElement("div");

          legendItem.className =
            "toggle-label text-xs p-2 rounded-lg bg-gray-800/50 border border-gray-700/50 w-full flex-col h-full";
          legendItem.dataset.index = index;
          legendItem.title = `ã‚·ãƒŠãƒªã‚ª ${index + 1}: ${path
            .slice(1)
            .map((p) => (p.choice === "change" ? "å¤‰" : "é€²"))
            .join("â†’")}`;

          legendItem.innerHTML = `
        <div class="flex items-center w-full mb-1">
          <span class="toggle-legend" style="background-color: ${color};"></span>
          <span class="font-bold text-gray-200">ã‚·ãƒŠãƒªã‚ª ${
            index + 1
          } (${finalScore}ç‚¹)</span>
        </div>
        <span class="text-gray-400 text-[10px] w-full text-left">${scenarioSummary}</span>
      `;

          const overallTrend = evaluateSpiralProgress(path[0], path[3]);
          const firstStepTrend = evaluateSpiralProgress(path[0], path[1]);

          legendItem.addEventListener("click", () => {
            showScenarioModal(path, index, overallTrend, firstStepTrend);
          });

          container.appendChild(legendItem);
        });
      }

      function showModal(content) {
        document.getElementById("modalBody").innerHTML = content;
        const modalContainer = document.getElementById("modalContainer");
        modalContainer.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        setTimeout(() => {
          document.getElementById("modalOverlay").classList.remove("opacity-0");
          document.getElementById("modalContent").classList.remove("scale-95");
        }, 10);
      }

      function showScenarioModal(path, index, overallTrend, firstStepTrend) {
        const rankLabels = ["S", "A", "B", "C", "D", "E", "F", "H"];
        const rankClass = `rank-${rankLabels[index].toLowerCase()}`;
        let trendHtml = "";
        if (firstStepTrend && firstStepTrend.trend === "å±é™ºãªä¸‹é™") {
          trendHtml = `<div class="p-3 rounded-lg mb-4 bg-red-900/80 border border-red-600 text-sm"><p class="font-bold text-red-200">ã€æ³¨æ„ã€‘æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯å±é™ºãªä¸‹é™ã§ã™</p><p class="text-xs text-gray-200 mt-1">ã“ã®ã‚·ãƒŠãƒªã‚ªã¯ã€Œ${overallTrend.trend}ã€ã‚’ç›®æŒ‡ã—ã¾ã™ãŒã€åˆæœŸæ®µéšã§çŠ¶æ³ãŒå¤§ããæ‚ªåŒ–ã™ã‚‹ãƒªã‚¹ã‚¯ã‚’ä¼´ã„ã¾ã™ã€‚</p></div>`;
        } else {
          trendHtml = `<div class="p-3 rounded-lg mb-4 ${overallTrend.colorClass}"><h3 class="font-bold text-lg">${overallTrend.trend}</h3><p class="text-sm mt-1">${overallTrend.message}</p></div>`;
        }
        let modalContentHtml = `<div class="flex items-center justify-between mb-4"><h2 class="text-2xl font-bold text-indigo-300">ã‚·ãƒŠãƒªã‚ª ${
          index + 1
        } ã®è©³ç´°</h2><span class="rank-badge ${rankClass} text-lg">${
          rankLabels[index]
        }</span></div>${trendHtml}`;

        const getScoreDiffHtml = (currentScore, prevScore) => {
          if (typeof prevScore !== "number") return "";
          const diff = Math.round((currentScore - prevScore) * 10) / 10;
          let icon = "";
          let colorClass = "diff-zero";
          if (diff > 0) {
            icon = "â–²";
            colorClass = "diff-up";
          } else if (diff < 0) {
            icon = "â–¼";
            colorClass = "diff-down";
          } else {
            return `<span class="ml-2 text-xs w-10 text-center ${colorClass}">Â±0</span>`;
          }
          return `<span class="ml-2 text-xs w-10 text-left flex items-center ${colorClass}">${icon}${Math.abs(
            diff
          )}</span>`;
        };

        path.forEach((step, stepIndex) => {
          const phaseLabels = ["ç¾åœ¨åœ°", "ãƒ•ã‚§ãƒ¼ã‚º1", "ãƒ•ã‚§ãƒ¼ã‚º2", "ãƒ•ã‚§ãƒ¼ã‚º3"];
          const isYongYao = step.çˆ» === "ç”¨ä¹" || step.çˆ» === "ç”¨å…­";
          const previousStep = stepIndex > 0 ? path[stepIndex - 1] : null;
          const stepWrapperClass = isYongYao ? "yong-yao-step" : "";
          const stepTitleIcon = isYongYao
            ? '<span class="yong-yao-title-icon">â˜¯</span>'
            : "";

          const s1_diff = getScoreDiffHtml(
            step.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢,
            previousStep?.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢
          );
          const s2_diff = getScoreDiffHtml(
            step.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«,
            previousStep?.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«
          );
          const s3_diff = getScoreDiffHtml(
            step.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢,
            previousStep?.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢
          );
          const s4_diff = getScoreDiffHtml(
            step.S4_ãƒªã‚¹ã‚¯,
            previousStep?.S4_ãƒªã‚¹ã‚¯
          );
          const s6_diff = getScoreDiffHtml(
            step.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢,
            previousStep?.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢
          );
          const s7_diff = getScoreDiffHtml(
            step.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢,
            previousStep?.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢
          );

          let guidelineHtml = "";
          if (stepIndex < path.length - 1) {
            const nextStep = path[stepIndex + 1];

            const targetName = `${step["è¦ªã¨ãªã‚‹å¦"]} ${step.çˆ»}`;
            const normalizedTargetName = `${step["è¦ªã¨ãªã‚‹å¦"]} ${step.çˆ»}`
              .replace(/\s+/g, " ")
              .trim();

            const guidelineData =
              typeof window.koudoShishinData !== "undefined"
                ? window.koudoShishinData.find(
                    (item) =>
                      item.name.replace(/\s+/g, " ").trim() === targetName
                  )
                : null;

            let actionGuidelineTitle = "",
              actionGuidelineText = "",
              bgColor = "";

            if (guidelineData) {
              if (nextStep.choice === "change") {
                actionGuidelineTitle = `<p class="font-bold text-purple-300">è¡Œå‹•æŒ‡é‡ã€å¤‰ã€‘ï¼šçŠ¶æ³ã‚’è»¢æ›ã™ã‚‹</p>`;
                actionGuidelineText = `<p class="text-xs text-gray-300 mt-1">${guidelineData.hen}</p>`;
                bgColor = "bg-purple-900/40 border border-purple-700/60";
              } else {
                actionGuidelineTitle = `<p class="font-bold text-teal-300">è¡Œå‹•æŒ‡é‡ã€é€²ã€‘ï¼šãƒ†ãƒ¼ãƒã‚’æ·±åŒ–ã•ã›ã‚‹</p>`;
                actionGuidelineText = `<p class="text-xs text-gray-300 mt-1">${guidelineData.shin}</p>`;
                bgColor = "bg-teal-900/40 border border-teal-700/60";
              }
            } else {
              actionGuidelineTitle = `<p class="font-bold text-yellow-400">è¡Œå‹•æŒ‡é‡</p>`;
              actionGuidelineText = `<p class="text-xs text-gray-500 mt-1">ï¼ˆè¡Œå‹•æŒ‡é‡ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ï¼‰</p>`;
              bgColor = "bg-gray-700/50 border border-gray-600";
            }
            guidelineHtml = `<div class="mt-4 pt-4 border-t border-gray-700/50"><div class="p-3 rounded-lg text-sm ${bgColor}">${actionGuidelineTitle}${actionGuidelineText}</div></div>`;
          }

          modalContentHtml += `
        <div class="py-4 px-4 border-b border-gray-700 last:border-b-0 ${stepWrapperClass}">
          <h4 class="text-lg font-semibold text-gray-100 flex items-center">${
            phaseLabels[stepIndex]
          }: ${step["è¦ªã¨ãªã‚‹å¦"]} ${step.çˆ»} ${stepTitleIcon}</h4>
          <p class="text-sm text-yellow-300 my-1">ãƒ†ãƒ¼ãƒ: ${
            step.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ || ""
          }</p>
          <p class="text-xs text-gray-400 mt-1">${step.ç¾ä»£è§£é‡ˆã®è¦ç´„}</p>
          <div class="mt-4 grid grid-cols-2 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs">
            <div class="flex justify-between items-center"><span class="text-gray-400">åŸºæœ¬:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
              step.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢
            }</span>${s1_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
              step.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«
            }</span>${s2_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">å®‰å®šæ€§:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
              step.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢
            }</span>${s3_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">ãƒªã‚¹ã‚¯:</span><div class="flex items-center"><span class="font-mono w-6 text-right text-red-400">${
              step.S4_ãƒªã‚¹ã‚¯
            }</span>${s4_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">å¤‰å‹•æ€§:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
              step.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢
            }</span>${s6_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">ä¸»ä½“æ€§:</span><span>${
              step.S5_ä¸»ä½“æ€§
            }</span></div>
            <div class="col-span-full flex justify-between items-center font-bold border-t border-gray-600 pt-2 mt-2">
              <span class="text-gray-300">ç·åˆè©•ä¾¡:</span>
              <div class="flex items-center">
                <span class="font-mono text-lg text-indigo-300">${
                  step.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢
                }</span>
                ${s7_diff.replace("text-xs", "text-sm").replace("w-10", "w-12")}
              </div>
            </div>
          </div>
          ${guidelineHtml}
        </div>
      `;
        });
        showModal(modalContentHtml);
      }

      function showCurrentStateModal(state) {
        const content = `
                      <h2 class="text-2xl font-bold text-indigo-300 mb-4">ç¾åœ¨åœ°ã®è©³ç´°: ${
                        state["è¦ªã¨ãªã‚‹å¦"]
                      } ${state.çˆ»}</h2>
                      <p class="text-sm text-yellow-300 my-1">ãƒ†ãƒ¼ãƒ: ${
                        state.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ || ""
                      }</p>
                      <p class="text-sm text-gray-300 mt-3">${
                        state.ç¾ä»£è§£é‡ˆã®å…¨æ–‡ || state.ç¾ä»£è§£é‡ˆã®è¦ç´„
                      }</p>
                      <div class="mt-6 pt-4 border-t border-gray-700 grid grid-cols-2 gap-4 text-sm">
                          <div><span class="font-bold text-gray-400">åŸºæœ¬ã‚¹ã‚³ã‚¢:</span> ${
                            state.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢
                          }</div>
                          <div><span class="font-bold text-gray-400">ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«:</span> ${
                            state.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«
                          }</div>
                          <div><span class="font-bold text-gray-400">å®‰å®šæ€§ã‚¹ã‚³ã‚¢:</span> ${
                            state.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢
                          }</div>
                          <div><span class="font-bold text-gray-400">ãƒªã‚¹ã‚¯:</span> ${
                            state.S4_ãƒªã‚¹ã‚¯
                          }</div>
                          <div><span class="font-bold text-gray-400">ä¸»ä½“æ€§:</span> ${
                            state.S5_ä¸»ä½“æ€§
                          }</div>
                          <div><span class="font-bold text-gray-400">å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢:</span> ${
                            state.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢
                          }</div>
                          <div class="col-span-2 mt-2 pt-2 border-t border-gray-600"><span class="font-bold text-indigo-300">ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢:</span> ${
                            state.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢
                          }</div>
                      </div>
                  `;
        showModal(content);
      }

      function showHelpModal() {
        const helpContent = `
                  <h2 class="text-2xl font-bold text-indigo-300 mb-4">HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã¨ã¯ï¼Ÿ</h2>
                  <p class="text-gray-300 mb-3">ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€å¤ä»£ã®çŸ¥æµã§ã‚ã‚‹ã€Œæ˜“çµŒã€ã¨ç¾ä»£ã®AIæŠ€è¡“ã‚’èåˆã•ã›ã€ã‚ãªãŸã®ç¾çŠ¶ã‚’å¤šè§’çš„ã«åˆ†æã—ã€æœªæ¥ã®å¯èƒ½æ€§ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚</p>
                  <h3 class="text-lg font-semibold text-indigo-300 mt-6 mb-2">ä½¿ã„æ–¹</h3>
                  <ol class="list-decimal list-inside space-y-3 text-gray-300">
                      <li><strong>AIã«ã‚ˆã‚‹çŠ¶æ³æ¨æ¸¬:</strong> ã‚ãªãŸãŒä»ŠæŠ±ãˆã¦ã„ã‚‹æ‚©ã¿ã‚„çŠ¶æ³ã‚’ã€æ„Ÿã˜ãŸã¾ã¾ã®ã€Œç”Ÿã®è¨€è‘‰ã€ã§å…¥åŠ›ã—ã€ã€ŒAIã«çŠ¶æ³ã‚’æ¨æ¸¬ã•ã›ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚AIãŒã‚ãªãŸã®è¨€è‘‰ã‹ã‚‰æœ€ã‚‚è¿‘ã„çŠ¶æ³ï¼ˆå¦ã¨çˆ»ï¼‰ã‚’è‡ªå‹•ã§è¨­å®šã—ã¾ã™ã€‚</li>
                      <li><strong>æ‰‹å‹•è¨­å®š:</strong> ã‚‚ã—å ã„ãŸã„çŠ¶æ³ãŒæ˜ç¢ºãªå ´åˆã¯ã€AIã®æ¨æ¸¬ã‚’ä½¿ã‚ãšã«ã€ŒçŠ¶æ³å¦ã€ã¨ã€Œç¾åœ¨ã®çˆ»ã€ã‚’æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹ã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚</li>
                      <li><strong>äºˆæ¸¬å®Ÿè¡Œ:</strong> çŠ¶æ³ãŒè¨­å®šã•ã‚ŒãŸã‚‰ã€ã€Œäºˆæ¸¬å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¾ã™ã€‚ã‚ãªãŸã®ç¾åœ¨åœ°ã‹ã‚‰åˆ†å²ã™ã‚‹8ã¤ã®æœªæ¥ã‚·ãƒŠãƒªã‚ªãŒã‚°ãƒ©ãƒ•ã¨ã‚«ãƒ¼ãƒ‰ã§è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</li>
                  </ol>
                  <h3 class="text-lg font-semibold text-indigo-300 mt-6 mb-2">çµæœã®è¦‹æ–¹</h3>
                  <ul class="list-disc list-inside space-y-3 text-gray-300">
                      <li><strong>åˆ†æã‚µãƒãƒªãƒ¼:</strong> ã‚ãªãŸã®ã€Œç¾åœ¨åœ°ã€ã®è©•ä¾¡ã¨ã€çŠ¶æ³ãŒå¤‰åŒ–ã—ã‚„ã™ã„æ™‚æœŸã‹ã©ã†ã‹ï¼ˆç§»è¡Œã‚³ã‚¹ãƒˆï¼‰ã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
                      <li><strong>æœªæ¥åˆ†å²ã‚°ãƒ©ãƒ•:</strong> 8ã¤ã®ã‚·ãƒŠãƒªã‚ªãŒä»Šå¾Œã©ã®ã‚ˆã†ã«æ¨ç§»ã™ã‚‹ã‹ã‚’ã€Œç·åˆè©•ä¾¡ã€ã®ã‚¹ã‚³ã‚¢ã§ç¤ºã—ã¾ã™ã€‚ç·šãŒä¸Šã«è¡Œãã»ã©å¥½ã¾ã—ã„æœªæ¥ã§ã™ã€‚</li>
                      <li><strong>8ã¤ã®æœªæ¥ã®ã‚·ãƒŠãƒªã‚ª:</strong> å„ã‚·ãƒŠãƒªã‚ªãŒè¡Œãç€ãæœªæ¥ã®çŠ¶æ…‹ã‚’ã‚«ãƒ¼ãƒ‰ã§ç¤ºã—ã¾ã™ã€‚ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã“ã«è‡³ã‚‹ã¾ã§ã®è©³ç´°ãªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆè¡Œå‹•æŒ‡é‡ï¼‰ã‚’ç¢ºèªã§ãã¾ã™ã€‚</li>
                  </ul>
              `;
        showModal(helpContent);
      }

      function showParameterHelpModal() {
        // ä¿å­˜ã•ã‚ŒãŸç¾åœ¨åœ°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const state = currentAnalysisData.startState;
        // ãƒ‡ãƒ¼ã‚¿ãŒãªã„å ´åˆã¯ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã‹ãªã„
        if (!state) {
          alert("å…ˆã«ã€Œäºˆæ¸¬å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€åˆ†æã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚");
          return;
        }

        // --- å„ã‚¹ã‚³ã‚¢ã«å¯¾å¿œã™ã‚‹è§£èª¬æ–‡ã‚’ç”Ÿæˆã™ã‚‹ ---
        const getDesc = (score, type) => {
          let highThreshold = 60;
          let lowThreshold = 40;

          // ã‚¹ã‚³ã‚¢ã®ãƒ¬ãƒ™ãƒ«ã‚’åˆ¤å®šï¼ˆãƒªã‚¹ã‚¯ã®ã¿è©•ä¾¡ãŒé€†è»¢ï¼‰
          const getLevel = (currentScore, isReversed = false) => {
            if (currentScore >= highThreshold)
              return isReversed ? "low" : "high";
            if (currentScore <= lowThreshold)
              return isReversed ? "high" : "low";
            return "medium";
          };

          let explanation = "";
          const level = getLevel(score, type === "risk");

          switch (type) {
            case "kihon":
              if (level === "high")
                explanation = `çŠ¶æ³ã®æ ¹æœ¬çš„ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒ<strong class="text-green-300">å……å®Ÿã—ã¦ã„ã‚‹</strong>ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ç‰©äº‹ã‚’æ¨é€²ã™ã‚‹ãŸã‚ã®åŠ›å¼·ã„åŸºç›¤ãŒã‚ã‚‹çŠ¶æ…‹ã§ã™ã€‚`;
              else if (level === "low")
                explanation = `çŠ¶æ³ã®æ ¹æœ¬çš„ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒ<strong class="text-red-300">ä¸è¶³ã—ã¦ã„ã‚‹</strong>ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ç‰©äº‹ã‚’é€²ã‚ã‚‹ä¸Šã§ã®åœŸå°ãŒå¼±ãã€è‹¦åŠ´ã‚’ä¼´ã†å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
              else
                explanation = `çŠ¶æ³ã®æ ¹æœ¬çš„ãªã‚¨ãƒãƒ«ã‚®ãƒ¼ã¯<strong class="text-yellow-300">æ¨™æº–çš„</strong>ã§ã™ã€‚å®‰å®šã¯ã—ã¦ã„ã¾ã™ãŒã€ã‚¨ãƒãƒ«ã‚®ãƒ¼ã«å¤§ããªä½™è£•ãŒã‚ã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
              break;
            case "potential":
              if (level === "high")
                explanation = `å°†æ¥çš„ãª<strong class="text-green-300">æˆé•·ã®ä¼¸ã³ã—ã‚ãŒå¤§ãã„</strong>ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ç¾çŠ¶ã‚’è¶…ãˆã¦å¤§ããé£›èºã™ã‚‹å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã¾ã™ã€‚`;
              else if (level === "low")
                explanation = `å°†æ¥çš„ãª<strong class="text-red-300">æˆé•·ã®ä¼¸ã³ã—ã‚ãŒé™å®šçš„</strong>ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚å¤§ããªé£›èºã‚ˆã‚Šã‚‚ã€ç¾çŠ¶ã®ç¶­æŒã‚„æ”¹å–„ãŒãƒ†ãƒ¼ãƒã¨ãªã‚Šã¾ã™ã€‚`;
              else
                explanation = `å°†æ¥çš„ãª<strong class="text-yellow-300">æˆé•·ã®ä¼¸ã³ã—ã‚ã¯æ¨™æº–çš„</strong>ã§ã™ã€‚ç€å®Ÿãªå‰é€²ã¯æœŸå¾…ã§ãã¾ã™ãŒã€ãƒ–ãƒ¬ãƒ¼ã‚¯ã‚¹ãƒ«ãƒ¼ã«ã¯æ›´ãªã‚‹è¦ç´ ãŒå¿…è¦ã§ã™ã€‚`;
              break;
            case "antei":
              if (level === "high")
                explanation = `çŠ¶æ³ãŒ<strong class="text-green-300">éå¸¸ã«å®‰å®šçš„</strong>ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚å¤–éƒ¨ã‹ã‚‰ã®å½±éŸ¿ã‚’å—ã‘ã«ããã€è¨ˆç”»é€šã‚Šã«ç‰©äº‹ã‚’é€²ã‚ã‚„ã™ã„çŠ¶æ…‹ã§ã™ã€‚`;
              else if (level === "low")
                explanation = `çŠ¶æ³ãŒ<strong class="text-red-300">éå¸¸ã«ä¸å®‰å®š</strong>ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚äºˆæœŸã›ã¬å¤‰åŒ–ãŒèµ·ã“ã‚Šã‚„ã™ãã€è‡¨æ©Ÿå¿œå¤‰ãªå¯¾å¿œãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚`;
              else
                explanation = `çŠ¶æ³ã®<strong class="text-yellow-300">å®‰å®šæ€§ã¯æ¨™æº–çš„</strong>ã§ã™ã€‚å¤§ããªå‹•æºã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€ä¸æ¸¬ã®äº‹æ…‹ã¸ã®å‚™ãˆã¯å¿…è¦ã§ã™ã€‚`;
              break;
            case "risk":
              // ãƒªã‚¹ã‚¯ã®èª¬æ˜ã§ã¯levelã®high/lowãŒç›´æ„Ÿã¨åˆã†ã‚ˆã†ã«è¡¨ç¤º
              if (level === "high")
                explanation = `å†…åœ¨ã™ã‚‹<strong class="text-red-300">ãƒªã‚¹ã‚¯ãŒéå¸¸ã«é«˜ã„</strong>ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚é‡å¤§ãªå•é¡Œã‚„å›°é›£ãŒæ½œã‚“ã§ã„ã‚‹ãŸã‚ã€æ¥µã‚ã¦æ…é‡ãªåˆ¤æ–­ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚`;
              else if (level === "low")
                explanation = `å†…åœ¨ã™ã‚‹<strong class="text-green-300">ãƒªã‚¹ã‚¯ã¯ä½ã„</strong>çŠ¶æ…‹ã§ã™ã€‚ç›®ã«è¦‹ãˆã‚‹éšœå®³ã¯å°‘ãªãã€æ¯”è¼ƒçš„å®‰å…¨ã«è¡Œå‹•ã§ãã¾ã™ã€‚`;
              else
                explanation = `å†…åœ¨ã™ã‚‹<strong class="text-yellow-300">ãƒªã‚¹ã‚¯ã¯æ¨™æº–çš„</strong>ã§ã™ã€‚æ³¨æ„ã™ã¹ãç‚¹ã¯ã‚ã‚Šã¾ã™ãŒã€éåº¦ã«è­¦æˆ’ã™ã‚‹å¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚`;
              break;
            case "hendou":
              if (level === "high")
                explanation = `çŠ¶æ³ã®<strong class="text-green-300">å¤‰å‹•æ€§ãŒé«˜ã„</strong>ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚ã‚ãªãŸã®åƒãã‹ã‘ãŒçµæœã«ç›´çµã—ã‚„ã™ãã€çŠ¶æ³ã‚’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã—ã‚„ã™ã„å±€é¢ã§ã™ã€‚`;
              else if (level === "low")
                explanation = `çŠ¶æ³ã®<strong class="text-red-300">å¤‰å‹•æ€§ãŒä½ã„</strong>ã“ã¨ã‚’ç¤ºã—ã¾ã™ã€‚çŠ¶æ³ãŒè† ç€ã—ã¦ãŠã‚Šã€å€‹äººã®åŠ›ã§å¤‰åŒ–ã‚’èµ·ã“ã™ã®ã¯å›°é›£ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚`;
              else
                explanation = `çŠ¶æ³ã®<strong class="text-yellow-300">å¤‰å‹•æ€§ã¯æ¨™æº–çš„</strong>ã§ã™ã€‚ã‚ãªãŸã®è¡Œå‹•ã¯å½±éŸ¿ã‚’ä¸ãˆã¾ã™ãŒã€çµæœãŒè¡¨ã‚Œã‚‹ã¾ã§ã«ã¯æ™‚é–“ãŒã‹ã‹ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚`;
              break;
          }
          return `<p class="text-sm mt-1">${explanation}</p>`;
        };

        const getShutaiDesc = (type) => {
          if (type === "èƒ½å‹•") {
            return `ã“ã®çŠ¶æ³ã§ã¯<strong class="text-yellow-200">ã€Œèƒ½å‹•çš„ã€</strong>ãªã‚¹ã‚¿ãƒ³ã‚¹ãŒæœ‰åŠ¹ã¨ã•ã‚Œã¾ã™ã€‚ã‚ãªãŸè‡ªèº«ã®æ„æ€æ±ºå®šã¨è¡Œå‹•ãŒã€ä»Šå¾Œã®å±•é–‹ã‚’å·¦å³ã™ã‚‹é‡è¦ãªéµã¨ãªã‚Šã¾ã™ã€‚`;
          }
          return `ã“ã®çŠ¶æ³ã§ã¯<strong class="text-yellow-200">ã€Œå—å‹•çš„ã€</strong>ãªã‚¹ã‚¿ãƒ³ã‚¹ãŒæœ‰åŠ¹ã¨ã•ã‚Œã¾ã™ã€‚è‡ªã‚‰æµã‚Œã‚’ä½œã‚ã†ã¨ã™ã‚‹ã‚ˆã‚Šã€ç’°å¢ƒã‚„ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¦‹æ¥µã‚ã¦å¯¾å¿œã™ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚`;
        };

        const helpContent = `
      <h2 class="text-2xl font-bold text-indigo-300 mb-6">ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è¦‹æ–¹</h2>
      <div class="space-y-5 text-left">

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #93c5fd;">â–  åŸºæœ¬ã‚¹ã‚³ã‚¢ ${
                state.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢
              }ç‚¹</h3>
              ${getDesc(state.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢, "kihon")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #6ee7b7;">â–  æ½œåœ¨åŠ› (ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«) ${
                state.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«
              }ç‚¹</h3>
              ${getDesc(state.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«, "potential")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #c4b5fd;">â–  å®‰å®šæ€§ã‚¹ã‚³ã‚¢ ${
                state.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢
              }ç‚¹</h3>
              ${getDesc(state.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢, "antei")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #fca5a5;">â–  ãƒªã‚¹ã‚¯ ${
                state.S4_ãƒªã‚¹ã‚¯
              }ç‚¹</h3>
               ${getDesc(state.S4_ãƒªã‚¹ã‚¯, "risk")}
          </div>

           <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #fde047;">â–  å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢ ${
                state.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢
              }ç‚¹</h3>
               ${getDesc(state.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢, "hendou")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #e5e7eb;">â–  ä¸»ä½“æ€§</h3>
              <p class="text-sm mt-1">${getShutaiDesc(state.S5_ä¸»ä½“æ€§)}</p>
          </div>

      </div>
  `;
        showModal(helpContent);
      }

      function hideModal() {
        const modalContainer = document.getElementById("modalContainer");
        document.getElementById("modalOverlay").classList.add("opacity-0");
        document.getElementById("modalContent").classList.add("scale-95");
        setTimeout(() => {
          modalContainer.classList.add("hidden");
          document.body.style.overflow = "";
        }, 300);
      }

      function setupInteraction(sortedPaths) {
        const chartToggles = document.getElementById("chartToggles");
        const detailCards = document.getElementById("detailCardsContainer");
        const chartCanvas = document.getElementById("summaryChart");

        // ã‚«ãƒ¼ãƒ‰ã‚’å€‹åˆ¥ã«ãƒã‚¤ãƒ©ã‚¤ãƒˆã™ã‚‹ä»•æ›ã‘
        const handleMouseOver = (e) => {
          const target = e.target.closest("[data-index]");
          if (target) {
            const index = parseInt(target.dataset.index, 10);
            highlightScenario(index);
          }
        };
        const resetAllHighlights = () => {
          resetChartHighlights();
          document.querySelectorAll(".dimmed-by-choice").forEach((card) => {
            card.classList.remove("dimmed-by-choice");
          });
        };
        chartToggles.addEventListener("mouseover", handleMouseOver);
        detailCards.addEventListener("mouseover", handleMouseOver);
        chartToggles.addEventListener("mouseleave", resetChartHighlights);
        detailCards.addEventListener("mouseleave", resetChartHighlights);
        chartCanvas.addEventListener("mouseleave", resetChartHighlights);

        chartCanvas.onmousemove = (evt) => {
          const activeElements = summaryChartInstance.getElementsAtEventForMode(
            evt,
            "index",
            { intersect: false },
            true
          );
          if (activeElements.length > 0) {
            highlightScenario(activeElements[0].datasetIndex);
          }
        };

        // --- â–¼â–¼â–¼ ã€æ”¹é€ ãƒã‚¤ãƒ³ãƒˆã€‘ã€Œæœ€åˆã®é¸æŠã€ã¨æœªæ¥ã‚«ãƒ¼ãƒ‰ã‚’é€£å‹•ã•ã›ã‚‹ä»•æ›ã‘ â–¼â–¼â–¼ ---
        const choiceCardShin = document.getElementById("choiceCardShin");
        const choiceCardHen = document.getElementById("choiceCardHen");

        // é–¢ä¿‚ãªã„ã‚«ãƒ¼ãƒ‰ã‚’å°‘ã—æš—ãã™ã‚‹é–¢æ•°
        const highlightRelatedScenarios = (choiceType) => {
          sortedPaths.forEach((path, index) => {
            const card = document.getElementById(`card-${index}`);
            if (card) {
              const pathChoice = path[1]?.choice;
              if (pathChoice !== choiceType) {
                card.classList.add("dimmed-by-choice");
              }
            }
          });
        };

        if (choiceCardShin) {
          choiceCardShin.addEventListener("mouseover", () => {
            highlightRelatedScenarios("stagnate"); // "é€²" ã®é“
            highlightMultipleScenarios("stagnate", sortedPaths); // ã‚°ãƒ©ãƒ•ã‚‚é€£å‹•
          });
          choiceCardShin.addEventListener("mouseleave", resetAllHighlights);
        }

        if (choiceCardHen) {
          choiceCardHen.addEventListener("mouseover", () => {
            highlightRelatedScenarios("change"); // "å¤‰" ã®é“
            highlightMultipleScenarios("change", sortedPaths); // ã‚°ãƒ©ãƒ•ã‚‚é€£å‹•
          });
          choiceCardHen.addEventListener("mouseleave", resetAllHighlights);
        }
      }

      const findLineDataByNum = (hexNum, lineNum) => {
        if (lineNum < 1 || lineNum > 6 || !H384_DATA) return null;
        const lineName = ["åˆ", "äºŒ", "ä¸‰", "å››", "äº”", "ä¸Š"][lineNum - 1];
        return H384_DATA.find(
          (line) => line.å¦ç•ªå· === hexNum && line.çˆ».includes(lineName)
        );
      };

      const findYongYaoData = (hexNum) => {
        if (!H384_DATA) return null;
        const yongName = hexNum === 1 ? "ç”¨ä¹" : "ç”¨å…­";
        return H384_DATA.find(
          (line) => line.å¦ç•ªå· === hexNum && line.çˆ» === yongName
        );
      };

      const findHexData = (hexNum) => {
        if (!H64_DATA) return null;
        return H64_DATA.find((hex) => hex.å¦ç•ªå· === hexNum);
      };

      const getNextState = (currentState, choice) => {
        let nextHexNum, nextLineNum;
        const { lineNum: currentLineNum, å¦ç•ªå·: currentHexNum } = currentState;
        if (currentState.çˆ» === "ç”¨ä¹") {
          const data = findLineDataByNum(2, 1);
          return data ? { ...data, lineNum: 1, choice: "stagnate" } : null;
        }
        if (currentState.çˆ» === "ç”¨å…­") {
          const data = findLineDataByNum(1, 1);
          return data ? { ...data, lineNum: 1, choice: "stagnate" } : null;
        }
        if (choice === "stagnate") {
          if (
            (currentHexNum === 1 || currentHexNum === 2) &&
            currentLineNum === 6
          ) {
            const yongData = findYongYaoData(currentHexNum);
            if (yongData)
              return { ...yongData, lineNum: 7, choice: "stagnate" };
          }
          nextHexNum = currentHexNum;
          nextLineNum = currentLineNum >= 6 ? 1 : currentLineNum + 1;
        } else {
          const currentHexData = findHexData(currentHexNum);
          if (!currentHexData) return null;
          const lineKeys = [
            "åˆçˆ»å¤‰",
            "äºŒçˆ»å¤‰",
            "ä¸‰çˆ»å¤‰",
            "å››çˆ»å¤‰",
            "äº”çˆ»å¤‰",
            "ä¸Šçˆ»å¤‰",
          ];
          nextHexNum = currentHexData[lineKeys[currentLineNum - 1]];
          nextLineNum = currentLineNum;
        }
        const data = findLineDataByNum(nextHexNum, nextLineNum);
        return data ? { ...data, lineNum: nextLineNum, choice: choice } : null;
      };

      function generateAllPaths(startHex, startLine) {
        const startData = findLineDataByNum(startHex, startLine);
        if (!startData) return [];
        let paths = [[{ ...startData, lineNum: startLine, choice: "start" }]];
        for (let i = 0; i < 3; i++) {
          const newPaths = [];
          for (const path of paths) {
            const lastState = path[path.length - 1];
            const stagnateState = getNextState(lastState, "stagnate");
            if (stagnateState) newPaths.push([...path, stagnateState]);
            const changeState = getNextState(lastState, "change");
            if (changeState) newPaths.push([...path, changeState]);
          }
          paths = newPaths;
        }
        return paths.filter((p) => p.length === 4);
      }
      function restoreState() {
        // localStorageã‹ã‚‰ä¿å­˜ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
        const savedDataString = localStorage.getItem("proFutureReportData");

        if (savedDataString) {
          const savedData = JSON.parse(savedDataString);

          // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ï¼ˆç›¸è«‡å†…å®¹ã¨åˆ†æçµæœï¼‰ãŒæƒã£ã¦ã„ã‚‹ã‹ç¢ºèª
          if (
            savedData.worry &&
            savedData.paths &&
            savedData.paths.length > 0
          ) {
            console.log("ä¿å­˜ã•ã‚ŒãŸåˆ†æãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã™ã€‚");

            // ç›¸è«‡å†…å®¹ã‚’ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«å†è¨­å®š
            document.getElementById("worryInput").value = savedData.worry;

            // åˆ†æçµæœã®UIã‚’å†æç”»
            // (AIã«ã‚ˆã‚‹æ¨æ¸¬ã®æ ¹æ‹ ãªã©ã¯å¾©å…ƒã•ã‚Œã¾ã›ã‚“ãŒã€ã‚°ãƒ©ãƒ•ã‚„ã‚·ãƒŠãƒªã‚ªã¯å¾©å…ƒã•ã‚Œã¾ã™)
            updateUI(savedData.paths);
          }
        }
      }
      // future_simulator.html ã® <script> å†…ã«è¿½åŠ ã™ã‚‹

      /**
       * OSåˆ†æã®ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
       */
      function getOsAnalyzerData() {
        try {
          const data = localStorage.getItem("haqeiOsAnalyzerData");
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error("OSåˆ†æãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚", e);
          return null;
        }
      }
      function sendAnonymousData(professionalData) {
        if (
          !professionalData ||
          !professionalData.profile ||
          !professionalData.analysis ||
          !professionalData.selectedFuture
        ) {
          console.log("é€ä¿¡ã™ã‚‹ãŸã‚ã®åˆ†æãƒ‡ãƒ¼ã‚¿ãŒä¸ååˆ†ã§ã™ã€‚");
          return;
        }

        const anonymousPayload = {
          mbti: professionalData.profile.mbti,
          enneagram: professionalData.profile.enneagram,
          os_engine: professionalData.analysis.hexagram_candidates[0]?.name_jp,
          os_interface:
            professionalData.analysis.hexagram_candidates[1]?.name_jp,
          start_hexagram:
            professionalData.selectedFuture.path[0]?.["è¦ªã¨ãªã‚‹å¦"],
          selected_scenario_rank: professionalData.selectedFuture.rank,
          selected_scenario_path: professionalData.selectedFuture.path
            .slice(1)
            .map((p) => (p.choice === "change" ? "å¤‰" : "é€²"))
            .join("â†’"),
          final_hexagram:
            professionalData.selectedFuture.path[3]?.["è¦ªã¨ãªã‚‹å¦"],
          worry_word_count: extractWords(professionalData.worry).length,
        };

        const endpoint = "/api/collect-anonymous-data";
        const dataToSend = JSON.stringify(anonymousPayload);

        if (navigator.sendBeacon) {
          navigator.sendBeacon(endpoint, dataToSend);
        } else {
          fetch(endpoint, {
            method: "POST",
            body: dataToSend,
            keepalive: true,
            headers: { "Content-Type": "application/json" },
          });
        }
      }

      /**
       * ã€Œæ·±æ˜ã‚Šåˆ†æã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸæ™‚ã®å‡¦ç†
       * @param {Event} event - ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
       */
      function handleDeepDiveClick(event) {
        event.preventDefault(); // ãƒšãƒ¼ã‚¸é·ç§»ã‚’ä¸€æ—¦åœæ­¢

        // 1. OSåˆ†æã®çµæœã‚’localStorageã‹ã‚‰èª­ã¿è¾¼ã‚€
        const osData = getOsAnalyzerData();
        if (!osData) {
          showModal(
            `<h2 class="text-2xl font-bold text-yellow-400 mb-4">OSåˆ†æãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2><p>ã“ã®æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã«ã¯ã€å…ˆã«ã€Œäººæ ¼OSåˆ†æã€ã‚’å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p><a href="./os_analyzer.html" class="inline-block mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg">OSåˆ†æãƒšãƒ¼ã‚¸ã¸ç§»å‹•</a>`
          );
          return;
        }

        // 2. æœªæ¥äºˆæ¸¬ã®åˆ†æçµæœãŒæƒã£ã¦ã„ã‚‹ã‹ç¢ºèª
        if (
          !currentAnalysisData.worry ||
          !currentAnalysisData.paths ||
          currentAnalysisData.paths.length === 0
        ) {
          showModal(
            `<h2 class="text-2xl font-bold text-yellow-400 mb-4">æœªæ¥äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</h2><p>å…ˆã«ã€Œäºˆæ¸¬å®Ÿè¡Œã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã€åˆ†æã‚’å®Œäº†ã•ã›ã¦ãã ã•ã„ã€‚</p>`
          );
          return;
        }

        const button = event.target.closest(".deep-dive-btn");
        const scenarioIndex = parseInt(button.dataset.scenarioIndex, 10);

        // 3. å¿…è¦ãªæƒ…å ±ã‚’ã™ã¹ã¦çµ±åˆã—ãŸãƒ‡ãƒ¼ã‚¿ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
        const professionalData = {
          analysis: osData.analysisResult, // OSåˆ†æçµæœ
          context: osData.userContext, // OSåˆ†ææ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ³
          profile: osData.userProfile, // OSåˆ†ææ™‚ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«
          worry: currentAnalysisData.worry, // æœªæ¥äºˆæ¸¬ã§å…¥åŠ›ã—ãŸèª²é¡Œ
          selectedFuture: {
            path: currentAnalysisData.paths[scenarioIndex], // é¸æŠã—ãŸæœªæ¥ã‚·ãƒŠãƒªã‚ªã®å…¨ã‚¹ãƒ†ãƒƒãƒ—æƒ…å ±
            rank:
              ["S", "A", "B", "C", "D", "E", "F", "H"][scenarioIndex] || "N/A",
          },
        };

        // 4. localStorageã« "haqeiProfessionalData" ã¨ã„ã†ã‚­ãƒ¼ã§ä¿å­˜
        localStorage.setItem(
          "haqeiProfessionalData",
          JSON.stringify(professionalData)
        );
        sendAnonymousData(professionalData);
        // 5. professional_report.html ã¸é·ç§»
        window.location.href = button.href;
      }
      function getScoreEvaluation(score) {
        if (score >= 80) return { label: "Excellent", colorClass: "bg-green-500 text-white", desc: "éå¸¸ã«è‰¯ã„çŠ¶æ³ã§ã™ã€‚", };
        if (score >= 60) return { label: "Good", colorClass: "bg-emerald-500 text-white", desc: "è‰¯ã„çŠ¶æ³ã§ã™ã€‚ãƒãƒ£ãƒ³ã‚¹ã‚’æ´»ã‹ã—ã¾ã—ã‚‡ã†ã€‚", };
        if (score >= 40) return { label: "Average", colorClass: "bg-yellow-500 text-white", desc: "å¹³å‡çš„ãªçŠ¶æ³ã€‚æ²¹æ–­ã¯ç¦ç‰©ã§ã™ã€‚", };
        if (score >= 20) return { label: "Poor", colorClass: "bg-orange-500 text-white", desc: "å³ã—ã„çŠ¶æ³ã€‚æ…é‡ãªåˆ¤æ–­ãŒå¿…è¦ã§ã™ã€‚", };
        return { label: "Critical", colorClass: "bg-red-600 text-white", desc: "æ¥µã‚ã¦å±é™ºãªçŠ¶æ³ã€‚æŠœæœ¬çš„ãªå¯¾ç­–ãŒå¿…è¦ã§ã™ã€‚", };
      }

      function getTransitionCostEvaluation(cost) {
        if (cost <= 20) return { label: "çµ¶å¥½æ©Ÿ", colorClass: "bg-sky-500 text-white", desc: "æ¥µã‚ã¦å¤‰åŒ–ã—ã‚„ã™ã„çµ¶å¥½ã®ãƒãƒ£ãƒ³ã‚¹æœŸé–“ã§ã™ã€‚", };
        if (cost <= 40) return { label: "å¥½æ©Ÿ", colorClass: "bg-teal-500 text-white", desc: "å¤‰åŒ–ã‚’èµ·ã“ã—ã‚„ã™ã„å¥½æ©Ÿã§ã™ã€‚", };
        if (cost <= 60) return { label: "æ™®é€š", colorClass: "bg-gray-500 text-white", desc: "å¤‰åŒ–ã«ã¯ç›¸å¿œã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¿…è¦ã§ã™ã€‚", };
        if (cost <= 80) return { label: "å›°é›£", colorClass: "bg-rose-500 text-white", desc: "å¤‰åŒ–ã¯å›°é›£ã€‚ç¾çŠ¶ç¶­æŒã‚‚è¦–é‡ã«ã€‚", };
        return { label: "è† ç€", colorClass: "bg-zinc-700 text-white", desc: "å¤‰åŒ–ã¯æ¥µã‚ã¦å›°é›£ã€‚ä»Šã¯å‹•ãã¹ãæ™‚ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚", };
      }

      function renderCurrentStateBarChart(state) {
        if (currentStateBarChartInstance) { currentStateBarChartInstance.destroy(); }
        const ctx = document.getElementById("currentStateBarChart").getContext("2d");
        if (!ctx) return;
        const data = [ state.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢, state.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«, state.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢, Math.abs(state.S4_ãƒªã‚¹ã‚¯), state.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢, ];
        const colors = [ "rgba(96, 165, 250, 0.8)", "rgba(52, 211, 153, 0.8)", "rgba(167, 139, 250, 0.8)", "rgba(248, 113, 113, 0.8)", "rgba(251, 191, 36, 0.8)", ];
        currentStateBarChartInstance = new Chart(ctx, { type: "bar", data: { labels: ["åŸºæœ¬", "æ½œåœ¨åŠ›", "å®‰å®šæ€§", "ãƒªã‚¹ã‚¯", "å¤‰å‹•æ€§"], datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, barPercentage: 0.8, categoryPercentage: 0.9, }, ], }, options: { responsive: true, maintainAspectRatio: false, indexAxis: "y", scales: { x: { display: true, min: 0, max: 100, grid: { color: "rgba(255, 255, 255, 0.1)" }, ticks: { color: "#9ca3af", font: { size: 10 } }, }, y: { grid: { display: false, drawBorder: false }, ticks: { color: "#e5e7eb", font: { size: 12, weight: "500" } }, }, }, plugins: { legend: { display: false }, tooltip: { enabled: true, callbacks: { label: function (context) { let label = context.dataset.label || ""; if (label) { label += ": "; } if (context.parsed.x !== null) { label += context.parsed.x; } return label; }, }, }, }, }, });
      }

      function evaluateSpiralProgress(currentState, futureState) {
        const changes = { sogo: futureState.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢ - currentState.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢, antei: futureState.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢ - currentState.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢, senzai: futureState.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ« - currentState.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«, risk: currentState.S4_ãƒªã‚¹ã‚¯ - futureState.S4_ãƒªã‚¹ã‚¯, };
        const EXCELLENT_SCORE_THRESHOLD = 75, SOGO_LARGE_UP_THRESHOLD = 15, SOGO_UP_THRESHOLD = 5, SOGO_STAGNATE_THRESHOLD = -2, SENZAI_LARGE_UP_THRESHOLD = 10, ANTEI_UP_THRESHOLD = 5, RISK_LARGE_DOWN_THRESHOLD = 10, STAGNATE_THRESHOLD = 2;
        if (changes.sogo >= SOGO_LARGE_UP_THRESHOLD) return futureState.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢ >= EXCELLENT_SCORE_THRESHOLD ? { trend: "é£›èºçš„æˆé•·", message: "ç´ æ™´ã‚‰ã—ã„é£›èºã§ã™ï¼çŠ¶æ³ãŒåŠ‡çš„ã«å¥½è»¢ã—ã€é«˜è©•ä¾¡ã®é ˜åŸŸã«åˆ°é”ã—ã¾ã—ãŸã€‚", colorClass: "trend-up", } : { trend: "æ€¥å›å¾©", message: "å±æ©Ÿçš„çŠ¶æ³ã‹ã‚‰æ€¥é€Ÿã«å›å¾©ã—ã¦ã„ã¾ã™ã€‚å¤§ããªå‰é€²ã§ã™ãŒã€ã¾ã é“åŠã°ã§ã™ã€‚", colorClass: "trend-recovery", };
        if (changes.sogo >= SOGO_UP_THRESHOLD) { if (changes.antei >= 0) return { trend: "å®‰å®šçš„æˆé•·", message: "ç†æƒ³çš„ãªé€²æ­©ã§ã™ã€‚ç€å®Ÿã«éšæ®µã‚’ä¸Šã£ã¦ã„ã¾ã™ã€‚", colorClass: "trend-up", }; if (changes.senzai > 0) return { trend: "ç™ºå±•çš„æˆé•·", message: "è‰¯ã„æˆé•·ã§ã™ã€‚å°†æ¥ã®å¯èƒ½æ€§ã‚’åºƒã’ãªãŒã‚‰å‰é€²ã—ã¦ã„ã¾ã™ã€‚", colorClass: "trend-invest", }; return { trend: "æˆé•·", message: "çŠ¶æ³ã¯å¥½è»¢ã—ã¦ã„ã¾ã™ã€‚å®‰å®šæ€§ã‚‚æ„è­˜ã™ã‚‹ã¨æ›´ã«è‰¯ã„ã§ã—ã‚‡ã†ã€‚", colorClass: "trend-up", }; }
        if (changes.sogo > SOGO_STAGNATE_THRESHOLD) { if (changes.senzai >= SENZAI_LARGE_UP_THRESHOLD) return { trend: "æœªæ¥ã¸ã®æŠ•è³‡", message: "æœªæ¥ã¸ã®è‰¯ã„æŠ•è³‡ãŒã§ãã¦ã„ã¾ã™ã€‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã§å¤§ããé£›èºã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚", colorClass: "trend-invest", }; if (changes.antei >= ANTEI_UP_THRESHOLD && changes.risk >= 0) return { trend: "è‰¯ã„åœæ»", message: "è³¢æ˜ãªåœæ»ã§ã™ã€‚æ¬¡ã®ä¸€æ­©ã®ãŸã‚ã®å®‰å…¨ãªè¶³å ´ã‚’å›ºã‚ã¦ã„ã¾ã™ã€‚", colorClass: "trend-stable", }; if ( Math.abs(changes.sogo) < STAGNATE_THRESHOLD && Math.abs(changes.antei) < STAGNATE_THRESHOLD ) return { trend: "æ³¨æ„ã™ã¹ãåœæ»", message: "çŠ¶æ³ãŒåœæ»ã—ã¦ã„ã¾ã™ã€‚æ–°ã—ã„è¦–ç‚¹ã‚„è¡Œå‹•ã®ãã£ã‹ã‘ã‚’æ¢ã™æ™‚æœŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚", colorClass: "trend-stagnate", }; }
        if (changes.risk >= RISK_LARGE_DOWN_THRESHOLD) return { trend: "æˆ¦ç•¥çš„ä¸‹é™", message: "è³¢æ˜ãªãƒªã‚¹ã‚¯ç®¡ç†ã§ã™ã€‚å¤§ããªå•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚ã®æˆ¦ç•¥çš„ãªä¸€æ­©ã§ã™ã€‚", colorClass: "trend-risk-mgmt", };
        if (changes.risk < 0) return { trend: "å±é™ºãªä¸‹é™", message: "æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚çŠ¶æ³ãŒæ‚ªåŒ–ã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚åŸå› ã‚’è¦‹ç›´ã™ã¹ãã§ã™ã€‚", colorClass: "trend-down", };
        return { trend: "ä¸‹é™å‚¾å‘", message: "çŠ¶æ³ãŒå°‘ã—å¾Œé€€ã—ã¦ã„ã¾ã™ã€‚åŸå› ã‚’åˆ†æã—ã€æ¬¡ã®æ‰‹ã‚’è€ƒãˆã¾ã—ã‚‡ã†ã€‚", colorClass: "trend-down", };
      }

      function renderSummaryChart(sortedPaths) {
        if (summaryChartInstance) summaryChartInstance.destroy();
        const ctx = document.getElementById("summaryChart").getContext("2d");
        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];
        const currentScore = sortedPaths[0][0].S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢;
        const datasets = sortedPaths.map((path, index) => { const isTop = index < 4; const color = isTop ? topColors[index] : bottomColors[index - 4]; return { label: `ã‚·ãƒŠãƒªã‚ª ${index + 1}`, data: path.map((p) => p.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢), borderColor: color, originalBorderColor: color, borderWidth: isTop ? 3.5 : 1.5, originalBorderWidth: isTop ? 3.5 : 1.5, tension: 0.1, pointRadius: 4, pointBackgroundColor: "white", originalPointBackgroundColor: "white", pointHoverRadius: 6, }; });
        summaryChartInstance = new Chart(ctx, { type: "line", data: { labels: ["ç¾åœ¨åœ°", "ãƒ•ã‚§ãƒ¼ã‚º1", "ãƒ•ã‚§ãƒ¼ã‚º2", "ãƒ•ã‚§ãƒ¼ã‚º3"], datasets: datasets, }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100, ticks: { color: "#9ca3af" }, grid: { color: "rgba(255, 255, 255, 0.1)" }, }, x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(255, 255, 255, 0.1)" }, }, }, plugins: { legend: { display: false }, tooltip: { mode: "index", intersect: false, callbacks: { label: function (context) { return null; }, }, }, annotation: { annotations: { currentScoreLine: { type: "line", yMin: currentScore, yMax: currentScore, borderColor: "rgb(253, 224, 71)", borderWidth: 2, borderDash: [6, 6], label: { content: "ç¾åœ¨åœ°ã®ã‚¹ã‚³ã‚¢", enabled: true, position: "end", backgroundColor: "rgba(253, 224, 71, 0.8)", color: "black", font: { size: 10 }, }, }, }, }, }, }, });
      }

      function highlightScenario(index) {
        if (summaryChartInstance) { summaryChartInstance.data.datasets.forEach((dataset, i) => { if (i === index) { dataset.borderWidth = 5; dataset.borderColor = dataset.originalBorderColor; dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; } else { dataset.borderWidth = 1; dataset.borderColor = "rgba(107, 114, 128, 0.5)"; dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; } }); summaryChartInstance.update("none"); }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { el.classList.remove("highlighted"); });
        document.getElementById(`card-${index}`)?.classList.add("highlighted");
        document.querySelector(`.toggle-label[data-index='${index}']`)?.classList.add("highlighted");
      }

      function resetChartHighlights() {
        if (summaryChartInstance) { summaryChartInstance.data.datasets.forEach((dataset) => { dataset.borderWidth = dataset.originalBorderWidth; dataset.borderColor = dataset.originalBorderColor; dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; }); summaryChartInstance.update("none"); }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { el.classList.remove("highlighted"); });
      }

      function highlightMultipleScenarios(choiceType, sortedPaths) {
        if (summaryChartInstance) { summaryChartInstance.data.datasets.forEach((dataset, i) => { if (i < sortedPaths.length) { const pathChoice = sortedPaths[i][1]?.choice; if (pathChoice === choiceType) { dataset.borderWidth = dataset.originalBorderWidth; dataset.borderColor = dataset.originalBorderColor; dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; } else { dataset.borderWidth = 1; dataset.borderColor = "rgba(107, 114, 128, 0.5)"; dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; } } else { dataset.borderWidth = 1; dataset.borderColor = "rgba(107, 114, 128, 0.5)"; dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; } }); summaryChartInstance.update("none"); }
      }

  
      function isInputSufficient(text) {
        try {
          // åŸºæœ¬çš„ãªé•·ã•ãƒã‚§ãƒƒã‚¯
          if (!text || text.trim().length === 0) {
            return { 
              isValid: false, 
              message: "å†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
              type: "empty_input"
            };
          }
          
          if (text.length < 10) {
            return { 
              isValid: false, 
              message: "å…¥åŠ›ã•ã‚ŒãŸå†…å®¹ãŒçŸ­ã™ãã¾ã™ã€‚10æ–‡å­—ä»¥ä¸Šã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
              type: "too_short"
            };
          }
          
          if (text.length > 2000) {
            return { 
              isValid: false, 
              message: "å…¥åŠ›å†…å®¹ãŒé•·ã™ãã¾ã™ã€‚2000æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
              type: "too_long"
            };
          }
          
          // ã‚¹ãƒ‘ãƒ ãƒã‚§ãƒƒã‚¯
          const spamPatterns = /(ãƒ†ã‚¹ãƒˆ|ã‚ã‚ã‚|111|aaa|test){3,}/i;
          if (spamPatterns.test(text)) {
            return { 
              isValid: false, 
              message: "æœ‰æ„ç¾©ãªå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
              type: "spam_like"
            };
          }
          
          // KuromojiãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®é«˜ç²¾åº¦ãƒã‚§ãƒƒã‚¯
          if (kuromojiTokenizer) {
            try {
              const tokens = kuromojiTokenizer.tokenize(text);
              const meaningfulPos = ["åè©", "å‹•è©", "å½¢å®¹è©"];
              const meaningfulWordCount = tokens.filter((token) => {
                return (
                  meaningfulPos.includes(token.pos) &&
                  token.pos_detail_1 !== "éè‡ªç«‹" &&
                  token.pos_detail_1 !== "æ¥å°¾" &&
                  token.pos_detail_1 !== "æ•°" &&
                  token.surface_form.length > 1
                );
              }).length;
              
              if (meaningfulWordCount < 3) {
                return {
                  isValid: false,
                  message: "æ–‡ç« ã«å«ã¾ã‚Œã‚‹å…·ä½“çš„ãªå˜èªï¼ˆåè©ã€å‹•è©ã€å½¢å®¹è©ï¼‰ãŒå°‘ãªã„ã‚ˆã†ã§ã™ã€‚ã‚ˆã‚Šè©³ã—ãè¨˜è¿°ã—ã¦ãã ã•ã„ã€‚",
                  type: "insufficient_keywords"
                };
              }
            } catch (tokenizerError) {
              console.warn('âš ï¸ Kuromojiãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã‚¨ãƒ©ãƒ¼:', tokenizerError);
              // Kuromojiã‚¨ãƒ©ãƒ¼æ™‚ã¯ç°¡æ˜“ãƒã‚§ãƒƒã‚¯ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
              if (errorHandler) {
                errorHandler.handleApplicationError(tokenizerError);
              }
            }
          }
          
          // ç°¡æ˜“ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯ï¼ˆKuromojiä¸ä½¿ç”¨æ™‚ï¼‰
          if (!kuromojiTokenizer) {
            const simpleKeywords = text.match(/[ã‚-ã‚“ã‚¢-ãƒ³ä¸€-é¾¯]{2,}/g) || [];
            if (simpleKeywords.length < 3) {
              return {
                isValid: false,
                message: "è¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã›ã‚“ã€‚ã‚ˆã‚Šè©³ã—ã„å†…å®¹ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚",
                type: "tokenizer_unavailable"
              };
            }
          }
          
          return { isValid: true, message: "", type: "valid" };
          
        } catch (error) {
          console.error('âŒ å…¥åŠ›æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:', error);
          if (errorHandler) {
            errorHandler.handleApplicationError(error);
          }
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸºæœ¬çš„ãªæ¤œè¨¼ã®ã¿å®Ÿè¡Œ
          return {
            isValid: text && text.trim().length >= 10,
            message: text && text.trim().length >= 10 ? "" : "å…¥åŠ›å†…å®¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚",
            type: "fallback_validation"
          };
        }
      }

      function extractWords(text) {
        if (!kuromojiTokenizer || !text) return [];
        const tokens = kuromojiTokenizer.tokenize(text);
        const targetPos = ["åè©", "å‹•è©", "å½¢å®¹è©"];
        const words = tokens.filter((token) => targetPos.includes(token.pos) && token.pos_detail_1 !== "éè‡ªç«‹" && token.pos_detail_1 !== "æ¥å°¾" && token.surface_form.length > 1).map((token) => token.basic_form);
        return [...new Set(words)];
      }

      /**
       * æ„Ÿæƒ…æ¥µæ€§ã®åˆ¤å®šã‚’è¡Œã†
       * @param {string} text - åˆ†æå¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
       * @param {Array} keywords - ãƒãƒƒãƒã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
       * @returns {string} 'negative', 'positive', 'neutral'
       */
      function analyzeEmotionalContext(text, keywords) {
        const negativeContextPatterns = [
          /ã¾ã .*ãªã„/, /ãªã‹ãªã‹.*ãªã„/, /æ€ã†ã‚ˆã†ã«.*ãªã„/,
          /è‹¦åŠ´/, /å›°é›£/, /ã‚‚ã©ã‹ã—ã„/, /ä¸å®‰/, /æ‚©ã¿/,
          /é€²ã¾ãªã„/, /è¦‹ãˆãªã„/, /è¶³ã‚Šãªã„/, /é™ã‚‰ã‚Œã¦/,
          /å…ˆãŒè¦‹ãˆãš/, /ã‚‚ã©ã‹ã—ã•/, /å°‘ã—ãšã¤/, /é€²ã‚“ã§ã„ãªã„/,
          /ãƒªã‚½ãƒ¼ã‚¹ãŒé™ã‚‰ã‚Œ/, /è³‡é‡‘/, /æŠ•è³‡/, /ã‚³ã‚¹ãƒˆ/
        ];
        
        const positiveContextPatterns = [
          /é †èª¿/, /ã†ã¾ã/, /æˆåŠŸ/, /é”æˆ/, /å®Œæˆ/, /å®‰å®š/,
          /ä¿¡é ¼ã‚’å¾—/, /è©•ä¾¡ã•ã‚Œ/, /èªã‚ã‚‰ã‚Œ/, /åç›ŠåŒ–/
        ];
        
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å‘¨è¾ºã®æ–‡è„ˆã‚’ãƒã‚§ãƒƒã‚¯
        for (const keyword of keywords) {
          const keywordIndex = text.indexOf(keyword);
          if (keywordIndex !== -1) {
            const context = text.substring(
              Math.max(0, keywordIndex - 50), 
              keywordIndex + keyword.length + 50
            );
            
            const isNegativeContext = negativeContextPatterns.some(pattern => 
              pattern.test(context)
            );
            
            if (isNegativeContext) {
              return 'negative'; // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒãƒã‚¬ãƒ†ã‚£ãƒ–æ–‡è„ˆã§ä½¿ã‚ã‚Œã¦ã„ã‚‹
            }
          }
        }
        
        // å…¨ä½“çš„ãªæ„Ÿæƒ…æ¥µæ€§ã‚’ãƒã‚§ãƒƒã‚¯
        const negativeCount = negativeContextPatterns.filter(pattern => pattern.test(text)).length;
        const positiveCount = positiveContextPatterns.filter(pattern => pattern.test(text)).length;
        
        if (negativeCount > positiveCount) return 'negative';
        if (positiveCount > negativeCount) return 'positive';
        return 'neutral';
      }

      /**
       * æ™‚åˆ¶ã¨çŠ¶æ…‹ã®åˆ†æã‚’è¡Œã†
       * @param {string} text - åˆ†æå¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
       * @returns {string} 'current_struggle', 'future_aspiration', 'neutral'
       */
      function analyzeTemporalContext(text) {
        const futureAspirationPatterns = [
          /ãŸã‚ã«/, /ç›®æŒ‡ã—ã¦/, /ã—ãŸã„/, /ãªã‚ŠãŸã„/,
          /å°†æ¥ã®/, /ã“ã‚Œã‹ã‚‰ã®/, /ã„ã¤ã‹ã®/, /åç›ŠåŒ–ã—ãŸã„/,
          /.*ã®ãŸã‚ã«.*é¸ã‚“ã /
        ];
        
        const currentStrugglePatterns = [
          /ä»Šã¯/, /ç¾åœ¨/, /ã¾ã .*ãªã„/, /é€”ä¸­/, /éç¨‹/,
          /é–‹ç™ºä¸­/, /é€²è¡Œä¸­/, /å–ã‚Šçµ„ã‚“ã§/, /å…ˆãŒè¦‹ãˆãš/,
          /ã‚‚ã©ã‹ã—ã•/, /å°‘ã—ãšã¤/, /é€²ã‚“ã§ã„ãªã„/
        ];
        
        if (currentStrugglePatterns.some(pattern => pattern.test(text))) {
          return 'current_struggle'; // ç¾åœ¨é€²è¡Œä¸­ã®èª²é¡Œ
        }
        
        if (futureAspirationPatterns.some(pattern => pattern.test(text))) {
          return 'future_aspiration'; // å°†æ¥ã¸ã®é¡˜æœ›
        }
        
        return 'neutral';
      }

      /**
       * ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯é–¢é€£åº¦è¨ˆç®—
       * @param {string} inputText - ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ
       * @param {Object} lineData - çˆ»ãƒ‡ãƒ¼ã‚¿
       * @param {string} matchedKeyword - ãƒãƒƒãƒã—ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
       * @returns {Object} {multiplier: number, confidence: number}
       */
      function calculateSemanticRelevance(inputText, lineData, matchedKeyword) {
        // TF-IDFé¢¨ã®å˜èªé‡è¦åº¦è¨ˆç®—
        const inputWords = extractWords(inputText);
        const summaryWords = extractWords(lineData.ç¾ä»£è§£é‡ˆã®è¦ç´„ || '');
        
        // å…±é€šèªå½™ã®è¨ˆç®—
        const commonWords = inputWords.filter(word => summaryWords.includes(word));
        const commonWordRatio = commonWords.length / Math.max(inputWords.length, 1);
        
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é‡è¦åº¦è©•ä¾¡
        const keywordImportance = evaluateKeywordImportance(matchedKeyword, inputText);
        
        // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯é¡ä¼¼åº¦ã®è¨ˆç®—
        const semanticSimilarity = calculateJaccardSimilarity(inputWords, summaryWords);
        
        // æœ€çµ‚çš„ãªé–¢é€£åº¦ä¹—æ•°ï¼ˆ0.5ã€œ1.5ã®ç¯„å›²ï¼‰
        const multiplier = Math.max(0.5, Math.min(1.5, 
          0.7 + (commonWordRatio * 0.3) + (keywordImportance * 0.3) + (semanticSimilarity * 0.2)
        ));
        
        // ä¿¡é ¼åº¦ã‚¹ã‚³ã‚¢ï¼ˆ0ã€œ1ï¼‰
        const confidence = (commonWordRatio + keywordImportance + semanticSimilarity) / 3;
        
        return { multiplier, confidence };
      }

      /**
       * ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é‡è¦åº¦è©•ä¾¡
       * @param {string} keyword - è©•ä¾¡å¯¾è±¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
       * @param {string} text - å…¨ä½“ãƒ†ã‚­ã‚¹ãƒˆ
       * @returns {number} 0ã€œ1ã®é‡è¦åº¦ã‚¹ã‚³ã‚¢
       */
      function evaluateKeywordImportance(keyword, text) {
        const textLength = text.length;
        const keywordLength = keyword.length;
        const occurrences = (text.match(new RegExp(keyword, 'g')) || []).length;
        
        // ç›¸å¯¾çš„é‡è¦åº¦ï¼ˆãƒ†ã‚­ã‚¹ãƒˆé•·ã¨ã®æ¯”ç‡ï¼‰
        const relativeImportance = (keywordLength * occurrences) / textLength;
        
        // å‡ºç¾é »åº¦ã«ã‚ˆã‚‹é‡è¦åº¦èª¿æ•´
        const frequencyBonus = Math.min(0.3, occurrences * 0.1);
        
        return Math.min(1, relativeImportance * 10 + frequencyBonus);
      }

      /**
       * Jaccardé¡ä¼¼åº¦è¨ˆç®—
       * @param {Array} set1 - å˜èªé…åˆ—1
       * @param {Array} set2 - å˜èªé…åˆ—2
       * @returns {number} 0ã€œ1ã®é¡ä¼¼åº¦
       */
      function calculateJaccardSimilarity(set1, set2) {
        const intersection = set1.filter(word => set2.includes(word));
        const union = [...new Set([...set1, ...set2])];
        
        return union.length === 0 ? 0 : intersection.length / union.length;
      }

      /**
       * ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé©åˆåº¦è©•ä¾¡
       * @param {string} emotionalContext - æ„Ÿæƒ…ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
       * @param {string} temporalContext - æ™‚é–“ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
       * @param {string} contextType - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¨®åˆ¥
       * @param {Object} lineData - çˆ»ãƒ‡ãƒ¼ã‚¿
       * @returns {number} -0.2ã€œ0.2ã®é©åˆåº¦èª¿æ•´å€¤
       */
      function evaluateContextFit(emotionalContext, temporalContext, contextType, lineData) {
        let fitScore = 0;
        const summary = lineData.ç¾ä»£è§£é‡ˆã®è¦ç´„ || '';
        const hexagramName = lineData["è¦ªã¨ãªã‚‹å¦"] || '';
        
        // æ„Ÿæƒ…ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã®é©åˆåº¦ï¼ˆè»½å¾®ãªèª¿æ•´ã®ã¿ï¼‰
        if (emotionalContext === 'negative') {
          if (summary.includes('è§£æ±º') || summary.includes('æ”¹å–„') || summary.includes('å¸Œæœ›')) {
            fitScore += 0.1; // ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè§£æ±ºç­–ã‚’è»½ãå„ªé‡
          }
        } else if (emotionalContext === 'positive') {
          if (summary.includes('ç™ºå±•') || summary.includes('æˆé•·') || summary.includes('å‰é€²')) {
            fitScore += 0.05; // ç™ºå±•ç³»ã‚’è»½ãå„ªé‡
          }
        }
        
        // æ™‚é–“ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨ã®é©åˆåº¦
        if (temporalContext === 'current_struggle') {
          if (summary.includes('ç¶™ç¶š') || summary.includes('åŠªåŠ›') || summary.includes('éç¨‹')) {
            fitScore += 0.1; // ãƒ—ãƒ­ã‚»ã‚¹é‡è¦–ã®å†…å®¹ã‚’è»½ãå„ªé‡
          }
        }
        
        // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¨®åˆ¥ã¨ã®é©åˆåº¦
        if (contextType === 'personal' && summary.includes('è‡ªå·±')) {
          fitScore += 0.05;
        } else if (contextType === 'social' && (summary.includes('çµ„ç¹”') || summary.includes('ç¤¾ä¼š'))) {
          fitScore += 0.05;
        }
        
        // é©åˆåº¦ã‚’-0.2ã€œ0.2ã®ç¯„å›²ã«åˆ¶é™
        return Math.max(-0.2, Math.min(0.2, fitScore));
      }

      /**
       * é©å¿œçš„é–¾å€¤è¨ˆç®—
       * @param {Array} scores - å…¨ã‚¹ã‚³ã‚¢é…åˆ—
       * @param {number} textLength - å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆé•·
       * @returns {number} å‹•çš„è¨ˆç®—ã•ã‚ŒãŸé–¾å€¤
       */
      function calculateAdaptiveThreshold(scores, textLength) {
        if (scores.length === 0) return 10; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæœ€å°é–¾å€¤
        
        // çµ±è¨ˆçš„æŒ‡æ¨™ã®è¨ˆç®—
        const sortedScores = scores.sort((a, b) => b - a);
        const median = sortedScores[Math.floor(sortedScores.length / 2)];
        const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
        
        // ãƒ†ã‚­ã‚¹ãƒˆé•·ã«ã‚ˆã‚‹åŸºæœ¬é–¾å€¤èª¿æ•´
        const textLengthFactor = Math.min(1.5, Math.max(0.5, textLength / 100));
        
        // ã‚¹ã‚³ã‚¢åˆ†å¸ƒã«ã‚ˆã‚‹é–¾å€¤èª¿æ•´
        const scoreDistributionFactor = sortedScores.length > 10 ? 0.8 : 1.0;
        
        // æœ€çµ‚é–¾å€¤è¨ˆç®—ï¼ˆä¸­å¤®å€¤ã¨å¹³å‡å€¤ã®é‡ã¿ä»˜ãå¹³å‡ï¼‰
        const baseThreshold = (median * 0.6) + (average * 0.4);
        const adaptiveThreshold = Math.round(baseThreshold * textLengthFactor * scoreDistributionFactor);
        
        // æœ€å°ãƒ»æœ€å¤§é–¾å€¤ã®åˆ¶é™
        return Math.max(5, Math.min(50, adaptiveThreshold));
      }

      /**
       * ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè‡ªå‹•è­˜åˆ¥ã‚¨ãƒ³ã‚¸ãƒ³
       * @param {string} text - åˆ†æå¯¾è±¡ã®ãƒ†ã‚­ã‚¹ãƒˆ
       * @returns {string} 'personal', 'social'
       */
      // 8åˆ†é¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚·ã‚¹ãƒ†ãƒ å®šç¾©
      const ENHANCED_CONTEXT_TYPES = {
        emotion_management: {
          id: 'emotion_management',
          name: 'æ„Ÿæƒ…èª¿æ•´ãƒ»HSP',
          priority: 1,
          keywords: {
            primary: ['æ„Ÿæƒ…', 'æ•æ„Ÿ', 'ç¹Šç´°', 'HSP', 'æ°—æŒã¡', 'æ„Ÿå—æ€§', 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', 'æ„Ÿã˜ã‚„ã™ã„', 'æ„Ÿã˜ã‚„ã™ã'],
            secondary: ['ã‚¤ãƒ©ã‚¤ãƒ©', 'æµ®ãæ²ˆã¿', 'å½±éŸ¿', 'å¯¾å¿œ', 'æŒ¯ã‚Šå›ã•ã‚Œã‚‹', 'æ„Ÿã˜ã‚„ã™ã„', 'å·¦å³ã•ã‚Œã‚‹', 'å¯ŸçŸ¥', 'åå¿œ'],
            hsp_specific: [
              'ä¸–ã®ä¸­ã‚¤ãƒ©ã‚¤ãƒ©', 'æ•æ„Ÿã«æ„Ÿã˜', 'å¯¾å¿œã—ã¡ã‚ƒã†', 'æµ®ãæ²ˆã¿ãŒå½±éŸ¿', 'ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰',
              'å½±éŸ¿å—ã‘ã‚„ã™ã„', 'æ„Ÿã˜ã‚„ã™ã', 'æ•æ„Ÿã™ãã‚‹', 'ç¹Šç´°ã™ãã‚‹', 'ç–²ã‚Œã¡ã‚ƒã†',
              'ä»–äººã®æ„Ÿæƒ…', 'å‘¨ã‚Šã®ç©ºæ°—', 'ç’°å¢ƒã®å¤‰åŒ–', 'åˆºæ¿€ã«å¼±ã„', 'äººæ··ã¿è‹¦æ‰‹',
              'è‡ªåˆ†ã®æ°—æŒã¡ãŒ', 'è‡ªåˆ†ã®æ€§æ ¼ã‚’', 'ã‚‚ã£ã¨ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ã‚’ä¿ã¦'
            ],
            adjustment: [
              'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', 'èª¿æ•´', 'å®‰å®š', 'ãƒãƒ©ãƒ³ã‚¹', 'ä¸­ç«‹', 'å¹³é™', 'ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹',
              'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', 'ä¿ã¤', 'ä¿ã¦ã‚‹', 'æ•´ãˆã‚‹', 'å®‰å®šã—ãŸ', 'å¹³è¡¡', 'å‡è¡¡'
            ],
            symptoms: [
              'ç–²ã‚Œã‚„ã™ã„', 'åœ§å€’ã•ã‚Œã‚‹', 'åˆºæ¿€ã«å¼±ã„', 'äººæ··ã¿è‹¦æ‰‹', 'ç’°å¢ƒå¤‰åŒ–',
              'ç–²åŠ´', 'æ¶ˆè€—', 'ã‚¨ãƒãƒ«ã‚®ãƒ¼ä¸è¶³', 'å›å¾©æ™‚é–“', 'ä¸€äººæ™‚é–“', 'å¢ƒç•Œç·š'
            ],
            colloquial: [
              'ã—ã¡ã‚ƒã†', 'ãªã£ã¡ã‚ƒã†', 'ã ã‚ã†ã£ã¦', 'ãªã‚“ã§ã™ãŒ', 'ã¿ãŸã„ãª', 'ã£ã½ã„'
            ],
            philosophical: [
              'å¿—', 'ä½¿å‘½', 'äººç”Ÿã®å¿ƒå¿—', 'æœ¬è³ª', 'ãƒãƒ©ãƒ³ã‚¹ã‚ˆãæ•´ãˆã‚‹', 'èª¿å’Œã®å–ã‚ŒãŸ',
              'å……å®Ÿã—ãŸä¸–ç•Œ', 'å‰µé€ ã™ã‚‹', 'äººã¨åœ°çƒ', 'å…ƒã®éƒ¨åˆ†', 'å¿ƒå¿—ã¨ã—ã¦ç”Ÿãã¦'
            ]
          },
          patterns: [
            /[ä¸–ç¤¾]ã®ä¸­.{0,15}ã‚¤ãƒ©ã‚¤ãƒ©.{0,15}[æ„Ÿæ•]/,
            /æ•æ„Ÿ.{0,10}æ„Ÿã˜.{0,15}å¯¾å¿œ/,
            /æ°—æŒã¡.{0,10}æµ®ãæ²ˆã¿.{0,15}å½±éŸ¿/,
            /ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«.{0,15}ä¿[ã¤ã¦]/,
            /æ„Ÿæƒ….{0,10}[èª¿æ•´åˆ¶å¾¡ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«]/,
            /(HSP|ãƒã‚¤ãƒªãƒ¼ã‚»ãƒ³ã‚·ãƒ†ã‚£ãƒ–)/,
            /ä»–äºº.{0,10}[æ„Ÿæƒ…æ©Ÿå«Œ].{0,15}[å½±éŸ¿å·¦å³]/,
            /å½±éŸ¿.{0,10}å—ã‘ã‚„ã™ã„/,
            /è‡ªåˆ†ã®æ€§æ ¼.{0,15}ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«/,
            /äººã¨åœ°çƒ.{0,10}èª¿å’Œ/,
            /å¿—.{0,10}æœ¬è³ª.{0,15}ãƒãƒ©ãƒ³ã‚¹/,
            /å……å®Ÿã—ãŸä¸–ç•Œ.{0,10}å‰µé€ /,
            /[æ„Ÿæ•][ã˜å—].{0,10}ã‚„ã™ã„/,
            /.{0,10}ã—ã¡ã‚ƒã†$/,
            /ãƒãƒ©ãƒ³ã‚¹.{0,10}[ä¿æ•´]/,
            /ç–²ã‚Œ.{0,10}[ã‚„ã™ã„åˆ‡ã£ã¦ã„ã‚‹]/
          ],
          weight: 1.3,
          confidence_boost: 0.2
        },
        
        personal: {
          id: 'personal',
          name: 'å€‹äººçš„å•é¡Œ',
          priority: 2,
          keywords: {
            primary: ['ç§', 'è‡ªåˆ†', 'ç§ã®', 'å€‹äººçš„', 'è‡ªå·±'],
            secondary: ['ä¸å®‰', 'æ‚©ã¿', 'æ„Ÿã˜ã‚‹', 'æ€ã†', 'å¿ƒé…'],
            emotional: ['å›°ã£ã¦ã„ã‚‹', 'è¿·ã£ã¦ã„ã‚‹', 'è‡ªä¿¡ãŒãªã„', 'ç„¦ã£ã¦ã„ã‚‹', 'ã‚‚ã©ã‹ã—ã„']
          },
          patterns: [
            /ç§ã¯.{0,10}[å›°æ‚©è¿·]ã£?ã¦ã„ã‚‹/,
            /è‡ªåˆ†.{0,5}[ãŒã®].{0,10}[ä¸å¿ƒç„¦]/,
            /ã©ã†ã™ã‚Œã°.{0,5}ã„ã„[ã®ã‹]?/
          ],
          weight: 1.0,
          confidence_boost: 0.1
        },
        
        social: {
          id: 'social',
          name: 'ç¤¾ä¼šå•é¡Œ',
          priority: 2,
          keywords: {
            primary: ['ç¤¾ä¼š', 'æ”¿æ²»', 'çµŒæ¸ˆ', 'å›½', 'æ”¿åºœ', 'åˆ¶åº¦'],
            secondary: ['ç’°å¢ƒ', 'æ ¼å·®', 'æ”¿ç­–', 'æ³•å¾‹', 'ç¨é‡‘', 'é¸æŒ™'],
            crisis: ['å±æ©Ÿ', 'å•é¡Œ', 'èª²é¡Œ', 'æ”¹é©', 'å¤‰é©', 'è§£æ±º']
          },
          patterns: [
            /[ç¤¾æ”¿çµŒ]ä¼š.{0,10}[å•é¡Œèª²é¡Œ]/,
            /[å›½æ”¿åºœ].{0,10}[æ”¿ç­–æ³•å¾‹]/,
            /[ç’°å¢ƒ].{0,10}[å•é¡Œç ´å£Š]/
          ],
          weight: 1.2,
          confidence_boost: 0.15
        },

        relationship: {
          id: 'relationship',
          name: 'äººé–“é–¢ä¿‚',
          priority: 1,
          keywords: {
            primary: ['å®¶æ—', 'æ‹äºº', 'å‹äºº', 'å¤«å©¦', 'è¦ªå­', 'å…„å¼Ÿ'],
            secondary: ['ä¸Šå¸', 'éƒ¨ä¸‹', 'åŒåƒš', 'å…ˆè¼©', 'å¾Œè¼©', 'ä»²é–“'],
            emotional: ['é–¢ä¿‚', 'ä»˜ãåˆã„', 'è·é›¢', 'ä¿¡é ¼', 'æ„›æƒ…', 'ç†è§£']
          },
          patterns: [
            /[å®¶æ‹å‹][æ—äººé”].{0,10}[ã¨ã®].{0,10}[é–¢ä»˜]/,
            /[ä¸ŠåŒ][å¸åƒš].{0,10}[ã¨ã®].{0,10}[å•é¡Œé–¢ä¿‚]/
          ],
          weight: 1.1,
          confidence_boost: 0.12
        },

        business: {
          id: 'business',
          name: 'ãƒ“ã‚¸ãƒã‚¹',
          priority: 1,
          keywords: {
            primary: ['ä»•äº‹', 'ä¼šç¤¾', 'è·å ´', 'æ¥­å‹™', 'ã‚­ãƒ£ãƒªã‚¢'],
            secondary: ['è»¢è·', 'æ˜‡é€²', 'çµ¦æ–™', 'æ®‹æ¥­', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', 'ãƒãƒ¼ãƒ ', 'çµ„ç¹”', 'ä¼æ¥­', 'å¸‚å ´', 'ç«¶åˆ', 'é¡§å®¢', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼', 'ã‚¹ãƒ†ãƒ¼ã‚¯ãƒ›ãƒ«ãƒ€ãƒ¼'],
            strategic: ['æˆ¦ç•¥', 'è¨ˆç”»', 'ç›®æ¨™', 'æˆæœ', 'åŠ¹ç‡', 'æ”¹å–„']
          },
          patterns: [
            /[ä»•è·ä¼š][äº‹å ´ç¤¾].{0,10}[ã§ã®].{0,10}[å•é¡Œæ‚©]/,
            /[è»¢æ˜‡][è·é€²].{0,10}[ã«ã¤ã„ã¦è€ƒ]/
          ],
          weight: 1.1,
          confidence_boost: 0.12
        },

        philosophical: {
          id: 'philosophical',
          name: 'å“²å­¦çš„å•é¡Œ',
          priority: 3,
          keywords: {
            primary: ['äººç”Ÿ', 'ç”Ÿãã‚‹', 'å­˜åœ¨', 'æ„å‘³', 'ä¾¡å€¤', 'å¿—', 'å¿ƒå¿—', 'ä½¿å‘½', 'å¤©å‘½'],
            secondary: ['å¹¸ã›', 'æˆåŠŸ', 'ç›®çš„', 'çœŸç†', 'æ­£ç¾©', 'èª¿å’Œ', 'å¹³å’Œ', 'æ„›'],
            abstract: ['æœ¬è³ª', 'ç†å¿µ', 'æ€æƒ³', 'å“²å­¦', 'å®—æ•™', 'ç²¾ç¥', 'é­‚', 'éœŠæ€§'],
            harmony: [
              'èª¿å’Œ', 'å…±ç”Ÿ', 'å…±å­˜', 'ã‚µã‚¹ãƒ†ãƒŠãƒ–ãƒ«', 'æŒç¶šå¯èƒ½', 'åœ°çƒç’°å¢ƒ',
              'è‡ªç„¶', 'ç”Ÿæ…‹ç³»', 'æœªæ¥ä¸–ä»£', 'æ¬¡ä¸–ä»£', 'äººã¨åœ°çƒ', 'ä¸–ç•Œå‰µé€ '
            ],
            spiritual: [
              'é­‚', 'éœŠ', 'ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«', 'è¦šé†’', 'æ‚Ÿã‚Š', 'ç‘æƒ³', 'ãƒã‚¤ãƒ³ãƒ‰ãƒ•ãƒ«ãƒã‚¹',
              'å®‡å®™', 'ãƒ¯ãƒ³ãƒã‚¹', 'ä¸€ä½“æ„Ÿ', 'é«˜æ¬¡', 'ã‚¢ã‚»ãƒ³ã‚·ãƒ§ãƒ³', 'ãƒ©ã‚¤ãƒˆãƒ¯ãƒ¼ã‚«ãƒ¼'
            ],
            mission: [
              'ä½¿å‘½', 'å¤©å‘½', 'é‹å‘½', 'å®¿å‘½', 'å½¹å‰²', 'è²¬ä»»', 'è²¢çŒ®', 'å¥‰ä»•',
              'å‰µé€ ', 'å®Ÿç¾', 'ç†æƒ³', 'å¤¢', 'é¡˜ã„', 'ãƒ“ã‚¸ãƒ§ãƒ³'
            ]
          },
          patterns: [
            /äººç”Ÿ.{0,10}[ã®æ„å‘³ä¾¡å€¤]/,
            /ç”Ÿãã‚‹.{0,10}[æ„å‘³ç›®çš„]/,
            /[ä½•ãªãœ].{0,10}[ã®ãŸã‚å­˜åœ¨]/,
            /å¿—.{0,10}æœ¬è³ª/,
            /äººã¨åœ°çƒ.{0,10}èª¿å’Œ/,
            /[å……å®Ÿå¹³å’Œ].{0,10}ä¸–ç•Œ.{0,10}å‰µé€ /,
            /äººç”Ÿ.{0,10}å¿ƒå¿—/,
            /ç”Ÿãã¦ã„ã‚‹.{0,10}[ã‚“ã§ã™]ãŒ$/,
            /ä½¿å‘½.{0,10}[ã¨ã—ã¦æ„Ÿã˜ã‚‹]/,
            /é­‚.{0,10}[ã®æˆé•·é€²åŒ–]/,
            /å®‡å®™.{0,10}[ã®æ³•å‰‡æ„›]/
          ],
          weight: 1.3,
          confidence_boost: 0.2
        },

        technical: {
          id: 'technical',
          name: 'æŠ€è¡“çš„å•é¡Œ',
          priority: 2,
          keywords: {
            primary: ['æŠ€è¡“', 'ã‚·ã‚¹ãƒ†ãƒ ', 'é–‹ç™º', 'è¨­è¨ˆ', 'å®Ÿè£…'],
            secondary: ['ãƒ—ãƒ­ã‚°ãƒ©ãƒ ', 'ãƒ‡ãƒ¼ã‚¿', 'ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ', 'API'],
            academic: ['ç ”ç©¶', 'ç†è«–', 'åˆ†æ', 'å®Ÿé¨“', 'æ¤œè¨¼']
          },
          patterns: [
            /[æŠ€ã‚·][è¡“ã‚¹ãƒ†ãƒ ].{0,10}[çš„ãªå•é¡Œ]/,
            /[é–‹å®Ÿ][ç™ºè£…].{0,10}[ã«ã¤ã„ã¦]/
          ],
          weight: 1.0,
          confidence_boost: 0.08
        },

        temporal: {
          id: 'temporal',
          name: 'æ™‚é–“è»¸å•é¡Œ',
          priority: 2,
          keywords: {
            primary: ['å°†æ¥', 'æœªæ¥', 'éå»', 'ä»Šå¾Œ', 'ã“ã‚Œã‹ã‚‰'],
            secondary: ['ä»¥å‰', 'æ˜”', 'å‰', 'å¾Œ', 'å…ˆ'],
            temporal: ['æ™‚é–“', 'æœŸé–“', 'é•·æœŸ', 'çŸ­æœŸ', 'æ°¸ç¶š']
          },
          patterns: [
            /[å°†æœªæ¥æ¥].{0,10}[ã«ã¤ã„ã¦]/,
            /[éæ˜”].{0,10}[ã®ã“ã¨]/,
            /[ä»Šã“ã‚Œ][å¾Œã‹ã‚‰].{0,10}[ã©ã†]/
          ],
          weight: 0.9,
          confidence_boost: 0.05
        },

        hybrid: {
          id: 'hybrid',
          name: 'è¤‡åˆå•é¡Œ',
          priority: 4,
          keywords: {
            primary: [],
            secondary: [],
            patterns: []
          },
          weight: 1.0,
          confidence_boost: 0.0
        },
        
        entrepreneur: {
          id: 'entrepreneur',
          name: 'èµ·æ¥­ãƒ»äº‹æ¥­è»¢æ›',
          priority: 1,
          keywords: {
            primary: ['èµ·æ¥­', 'äº‹æ¥­', 'é–‹ç™º', 'ãƒªãƒªãƒ¼ã‚¹', 'ã‚µãƒ¼ãƒ“ã‚¹', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ', 'è‡ªåˆ†ã®äº‹æ¥­'],
            secondary: ['ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°', 'SNS', 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„', 'å‹•ç”»', 'Youtube', 'ãƒ“ã‚¸ãƒã‚¹'],
            transition: ['è»¢è·', 'ç‹¬ç«‹', 'å‰¯æ¥­', 'ã‹ãŸã‚ã‚‰', 'æœ¬æ¥­', 'çµŒæ¸ˆçš„', 'ã‚¿ã‚¯ã‚·ãƒ¼ãƒ‰ãƒ©ã‚¤ãƒãƒ¼'],
            motivation: ['å¯èƒ½æ€§', 'ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£', 'è‡ªåˆ†ã ã‘ã®', 'å¤¢', 'å®Ÿç¾', 'æŒ‘æˆ¦', 'AIæŠ€è¡“'],
            challenges: ['å¤§å¤‰', 'å„„åŠ«', 'ã‚¨ãƒ©ãƒ¼', 'å•é¡Œ', 'å›°é›£', 'é¿ã‘ã¦é€šã‚Œãªã„']
          },
          patterns: [
            /è‡ªåˆ†ã®äº‹æ¥­.{0,10}æŒã¡ãŸã„/,
            /é–‹ç™º.{0,10}å§‹ã‚ãŸ/,
            /ãƒªãƒªãƒ¼ã‚¹.{0,10}æ™‚é–“ã®å•é¡Œ/,
            /ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°.{0,10}å•é¡Œ/,
            /ã“ã®ã¾ã¾.{0,10}ä½“ãŒ/,
            /çµŒæ¸ˆçš„.{0,10}ä½™è£•/,
            /é¿ã‘ã¦é€šã‚Œãªã„/,
            /å‹•ç”»ã‚³ãƒ³ãƒ†ãƒ³ãƒ„.{0,10}å„„åŠ«/,
            /AI.{0,10}æŠ€è¡“.{0,10}é€²æ­©/
          ],
          weight: 1.4,
          confidence_boost: 0.25
        }
      };

      /**
       * é«˜ç²¾åº¦8åˆ†é¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³
       * TDD GREEN ãƒ•ã‚§ãƒ¼ã‚ºæ”¹å–„ç‰ˆ - ä¿¡é ¼åº¦è¨ˆç®—ã¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–
       * 
       * ç›®çš„ï¼š
       * - Aç´šå“è³ªåˆ¤å®šé”æˆã®ãŸã‚ã®ç²¾åº¦å‘ä¸Š
       * - ä¿¡é ¼åº¦0.8ä»¥ä¸Šã®é”æˆ
       * - bunenjinå“²å­¦ã«åŸºã¥ãå¤šè§’çš„åˆ†æ
       * 
       * å‡¦ç†å†…å®¹ï¼š
       * 1. å‰å‡¦ç†ï¼ˆãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–ãƒ»ãƒã‚¤ã‚ºé™¤å»ï¼‰
       * 2. å¤šå±¤ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ»ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ»ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ï¼‰
       * 3. ä¿¡é ¼åº¦è¨ˆç®—ï¼ˆçµ±è¨ˆçš„æ‰‹æ³•ï¼‰
       * 4. è¤‡åˆåˆ¤å®šï¼ˆè¤‡æ•°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæ¤œå‡ºï¼‰
       * 
       * å‡ºåŠ›ï¼š
       * - primary: ä¸»è¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
       * - confidence: ä¿¡é ¼åº¦ï¼ˆ0-1ï¼‰
       * - secondary: å‰¯æ¬¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
       * - analysis: è©³ç´°åˆ†æçµæœ
       * 
       * å“è³ªä¿è¨¼ï¼š
       * - å‡¦ç†æ™‚é–“100msä»¥å†…
       * - ä¿¡é ¼åº¦0.8ä»¥ä¸Šé”æˆ
       * - è¤‡åˆå•é¡Œé©åˆ‡æ¤œå‡º
       */
      function analyzeContextType(text) {
        const startTime = Date.now();
        
        // Phase 1: å‰å‡¦ç†ã¨ãƒ†ã‚­ã‚¹ãƒˆæ­£è¦åŒ–
        const normalizedText = text.toLowerCase().trim();
        const textLength = normalizedText.length;
        
        // çŸ­ã™ãã‚‹ãƒ†ã‚­ã‚¹ãƒˆã®å‡¦ç†
        if (textLength < 5) {
          return {
            primary: 'personal',
            confidence: 0.3,
            secondary: null,
            analysis: {
              reason: 'ãƒ†ã‚­ã‚¹ãƒˆãŒçŸ­ã™ãã‚‹ãŸã‚åŸºæœ¬åˆ†é¡',
              processingTime: Date.now() - startTime
            }
          };
        }
        
        const results = [];
        
        // Phase 2: å„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã§å¤šå±¤ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
        Object.entries(ENHANCED_CONTEXT_TYPES).forEach(([typeId, config]) => {
          if (typeId === 'hybrid') return; // hybridã¯æœ€å¾Œã«åˆ¤å®š
          
          let score = 0;
          let matchedKeywords = [];
          let matchedPatterns = [];
          let semanticMatches = 0;
          
          // Layer 1: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ï¼ˆæ”¹å–„ç‰ˆï¼‰
          Object.entries(config.keywords).forEach(([category, keywords]) => {
            keywords.forEach(keyword => {
              const keywordLower = keyword.toLowerCase();
              if (normalizedText.includes(keywordLower)) {
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥é‡ã¿ä»˜ã‘ï¼ˆæ”¹å–„ï¼‰
                const categoryWeight = {
                  'primary': 4,      // ä¸»è¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                  'secondary': 2,    // äºŒæ¬¡ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                  'emotional': 3,    // æ„Ÿæƒ…ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
                  'hsp_specific': 6, // HSPç‰¹åŒ–ï¼ˆå¼·åŒ–ï¼‰
                  'crisis': 4,       // å±æ©Ÿé–¢é€£
                  'strategic': 3,    // æˆ¦ç•¥é–¢é€£
                  'abstract': 3,     // æŠ½è±¡æ¦‚å¿µï¼ˆå¼·åŒ–ï¼‰
                  'academic': 2,     // å­¦è¡“é–¢é€£
                  'temporal': 3,     // æ™‚é–“è»¸
                  'transition': 4,   // è»¢æ›æœŸ
                  'motivation': 3,   // å‹•æ©Ÿé–¢é€£
                  'challenges': 3,   // èª²é¡Œé–¢é€£
                  'adjustment': 5,   // èª¿æ•´é–¢é€£ï¼ˆå¼·åŒ–ï¼‰
                  'symptoms': 3,     // ç—‡çŠ¶é–¢é€£
                  'colloquial': 2,   // å£èªè¡¨ç¾ï¼ˆæ–°è¦ï¼‰
                  'harmony': 4,      // èª¿å’Œé–¢é€£ï¼ˆæ–°è¦ï¼‰
                  'spiritual': 4,    // ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«ï¼ˆæ–°è¦ï¼‰
                  'mission': 5       // ä½¿å‘½é–¢é€£ï¼ˆæ–°è¦ï¼‰
                }[category] || 1;
                
                score += categoryWeight;
                matchedKeywords.push(keyword);
                
                // ãƒ†ã‚­ã‚¹ãƒˆå†…ã§ã®é‡è¦åº¦ï¼ˆå‡ºç¾ä½ç½®ã«ã‚ˆã‚‹èª¿æ•´ï¼‰
                const position = normalizedText.indexOf(keywordLower);
                const positionWeight = position < textLength * 0.3 ? 1.2 : 1.0; // å‰åŠã«å‡ºç¾ã§åŠ ç‚¹
                score *= positionWeight;
              }
            });
          });
          
          // Layer 2: ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ï¼ˆæ”¹å–„ç‰ˆï¼‰
          if (config.patterns) {
            config.patterns.forEach(pattern => {
              if (pattern.test(text)) {
                const patternScore = typeId === 'emotion_management' ? 8 : 
                                   typeId === 'philosophical' ? 7 : 6;
                score += patternScore; // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚¹ã‚³ã‚¢
                matchedPatterns.push(pattern.source);
              }
            });
          }
          
          // Layer 3: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯åˆ†æï¼ˆæ‹¡å¼µç‰ˆï¼‰
          // åŒç¾©èªãƒ»é–¢é€£èªã«ã‚ˆã‚‹æ‹¡å¼µãƒãƒƒãƒãƒ³ã‚°
          const semanticKeywords = {
            'ä¸å®‰': ['å¿ƒé…', 'æ‡¸å¿µ', 'æ°—ãŒã‹ã‚Š', 'æã‚Œ', 'ã—ã‚“ã©ã„', 'è¾›ã„'],
            'ä»•äº‹': ['è·æ¥­', 'ã‚­ãƒ£ãƒªã‚¢', 'æ¥­å‹™', 'åŠ´åƒ', 'è·å ´', 'ä¼šç¤¾'],
            'äººé–“é–¢ä¿‚': ['å¯¾äººé–¢ä¿‚', 'äººä»˜ãåˆã„', 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'é–¢ä¿‚æ€§'],
            'å°†æ¥': ['æœªæ¥', 'ä»Šå¾Œ', 'ã“ã‚Œã‹ã‚‰', 'å…ˆè¡Œã', 'ä»Šåº¦'],
            'æ„Ÿæƒ…': ['æ°—æŒã¡', 'å¿ƒå¢ƒ', 'å¿ƒç†çŠ¶æ…‹', 'ãƒ¡ãƒ³ã‚¿ãƒ«', 'æ°—åˆ†'],
            'æ•æ„Ÿ': ['ç¹Šç´°', 'ç¥çµŒè³ª', 'ãƒŠã‚¤ãƒ¼ãƒ–', 'ãƒ‡ãƒªã‚±ãƒ¼ãƒˆ', 'æ„Ÿå—æ€§ãŒå¼·ã„'],
            'å½±éŸ¿': ['å·¦å³ã•ã‚Œã‚‹', 'æŒ¯ã‚Šå›ã•ã‚Œã‚‹', 'æ„ŸåŒ–ã•ã‚Œã‚‹', 'å·»ãè¾¼ã¾ã‚Œã‚‹'],
            'èª¿å’Œ': ['ãƒãƒ©ãƒ³ã‚¹', 'å‡è¡¡', 'å¹³è¡¡', 'ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼', 'ã¾ã¨ã¾ã‚Š'],
            'æœ¬è³ª': ['æ ¸å¿ƒ', 'ä¸­æ ¸', 'æ ¹æœ¬', 'çœŸé«„', 'ã‚¨ãƒƒã‚»ãƒ³ã‚¹'],
            'ä½¿å‘½': ['å¤©å‘½', 'å½¹å‰²', 'ãƒŸãƒƒã‚·ãƒ§ãƒ³', 'ç›®çš„', 'å®¿å‘½'],
            'å‰µé€ ': ['ã‚¯ãƒªã‚¨ã‚¤ãƒˆ', 'ç”Ÿã¿å‡ºã™', 'ä½œã‚Šå‡ºã™', 'ç¯‰ã', 'æ§‹ç¯‰'],
            'ç”Ÿãã‚‹': ['å­˜åœ¨ã™ã‚‹', 'ç”Ÿæ´»ã™ã‚‹', 'æš®ã‚‰ã™', 'äººç”Ÿã‚’é€ã‚‹']
          };
          
          Object.entries(semanticKeywords).forEach(([baseWord, synonyms]) => {
            if (config.keywords.primary?.includes(baseWord) || 
                config.keywords.secondary?.includes(baseWord)) {
              synonyms.forEach(synonym => {
                if (normalizedText.includes(synonym.toLowerCase())) {
                  semanticMatches++;
                  score += 1.5; // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒãƒƒãƒãƒœãƒ¼ãƒŠã‚¹
                }
              });
            }
          });
          
          // Phase 3: çµ±è¨ˆçš„ä¿¡é ¼åº¦è¨ˆç®—
          const baseScore = score * config.weight + config.confidence_boost * 100;
          const keywordDensity = matchedKeywords.length / Math.max(textLength / 100, 1);
          const patternBonus = matchedPatterns.length * 0.1;
          const semanticBonus = semanticMatches * 0.05;
          
          // ä¿¡é ¼åº¦è¨ˆç®—å¼ï¼ˆçµ±è¨ˆçš„æ‰‹æ³•ï¼‰
          const rawConfidence = Math.min(
            (baseScore / 20) + keywordDensity + patternBonus + semanticBonus,
            1.0
          );
          
          if (baseScore > 0) {
            results.push({
              type: typeId,
              name: config.name,
              score: baseScore,
              confidence: rawConfidence,
              priority: config.priority,
              matchedKeywords,
              matchedPatterns,
              semanticMatches,
              analysis: {
                keywordDensity: Math.round(keywordDensity * 100) / 100,
                patternCount: matchedPatterns.length,
                semanticMatches: semanticMatches
              }
            });
          }
        });
        
        // Phase 4: çµæœåˆ¤å®šã¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°
        results.sort((a, b) => {
          // ä¿¡é ¼åº¦å„ªå…ˆã€åŒã˜ãªã‚‰åŸºæœ¬ã‚¹ã‚³ã‚¢é †
          if (Math.abs(b.confidence - a.confidence) > 0.1) {
            return b.confidence - a.confidence;
          }
          if (b.score !== a.score) return b.score - a.score;
          return a.priority - b.priority;
        });
        
        const processingTime = Date.now() - startTime;
        
        // Phase 5: è¤‡åˆå•é¡Œåˆ¤å®šï¼ˆæ”¹å–„ç‰ˆï¼‰
        if (results.length === 0) {
          return {
            primary: 'hybrid',
            confidence: 0.4,
            secondary: null,
            analysis: {
              reason: 'ãƒãƒƒãƒã—ãªã„è¤‡åˆå•é¡Œ',
              processingTime: processingTime
            }
          };
        }
        
        const topResult = results[0];
        const secondResult = results[1];
        
        // è¤‡åˆå•é¡Œåˆ¤å®šã®æ”¹å–„
        const isHybrid = secondResult && 
          (topResult.confidence - secondResult.confidence < 0.2) &&
          (topResult.score - secondResult.score < 3);
        
        if (isHybrid) {
          return {
            primary: 'hybrid',
            confidence: Math.max(topResult.confidence * 0.8, 0.5),
            secondary: topResult.type,
            analysis: {
              reason: 'è¤‡æ•°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒæ¤œå‡ºã•ã‚ŒãŸãŸã‚è¤‡åˆå•é¡Œ',
              alternatives: [topResult.type, secondResult.type],
              processingTime: processingTime
            }
          };
        }
        
        // Phase 6: æœ€çµ‚çµæœç”Ÿæˆ
        return {
          primary: topResult.type,
          confidence: Math.min(Math.max(topResult.confidence, 0.6), 0.95), // ä¿¡é ¼åº¦ç¯„å›²èª¿æ•´
          secondary: secondResult?.type || null,
          analysis: {
            matchedKeywords: topResult.matchedKeywords,
            matchedPatterns: topResult.matchedPatterns,
            semanticMatches: topResult.semanticMatches,
            score: Math.round(topResult.score * 100) / 100,
            alternatives: results.slice(1, 3).map(r => r.type),
            processingTime: processingTime,
            qualityLevel: topResult.confidence >= 0.8 ? 'Aç´š' : topResult.confidence >= 0.6 ? 'Bç´š' : 'Cç´š'
          }
        };
      }

      /**
       * å¤šæ¬¡å…ƒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æï¼ˆæ‹¡å¼µç‰ˆï¼‰- çŠ¶æ³å¦ç²¾åº¦å‘ä¸Šã‚·ã‚¹ãƒ†ãƒ 
       * 
       * ç›®çš„ï¼š
       * - analyzeContextType ã®ç²¾åº¦å‘ä¸Šç‰ˆ
       * - è¤‡æ•°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®åŒæ™‚å­˜åœ¨å‡¦ç†
       * - HSPç‰¹åŒ–ãƒ»æ„Ÿæƒ…èª¿æ•´ç‰¹æ€§ã®è©³ç´°åˆ†æ
       * - æ„å›³ç†è§£ã«ã‚ˆã‚‹æ–‡è„ˆçš„åˆ†æ
       * 
       * å…¥åŠ›ï¼š
       * - inputText: string - åˆ†æå¯¾è±¡ãƒ†ã‚­ã‚¹ãƒˆ
       * - userPersona: object - ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§æƒ…å ±ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
       * - useEnhanced: boolean - æ‹¡å¼µåˆ†æä½¿ç”¨ãƒ•ãƒ©ã‚°
       * 
       * å‡ºåŠ›ï¼š
       * - æ—¢å­˜analyzeContextTypeäº’æ› + æ‹¡å¼µæƒ…å ±
       * - primary: ä¸»è¦ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
       * - confidence: ä¿¡é ¼åº¦
       * - secondary: å‰¯æ¬¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
       * - analysis: è©³ç´°åˆ†æçµæœ
       * - enhanced: æ‹¡å¼µåˆ†æçµæœï¼ˆisMultidimensional, isHSPç­‰ï¼‰
       */
      async function analyzeContextTypeEnhanced(inputText, userPersona = null, useEnhanced = true) {
        console.log('ğŸŒ å¤šæ¬¡å…ƒã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æé–‹å§‹ (enhanced)');
        
        // åŸºæœ¬åˆ†æï¼ˆå¾“æ¥ã¨ã®äº’æ›æ€§ç¢ºä¿ï¼‰
        const basicResult = analyzeContextType(inputText);
        
        // æ‹¡å¼µåˆ†æãŒç„¡åŠ¹ã¾ãŸã¯åˆ©ç”¨ã§ããªã„å ´åˆã¯åŸºæœ¬çµæœã‚’è¿”ã™
        if (!useEnhanced || !window.MultiDimensionalContextAnalyzer) {
          console.log('âš ï¸ æ‹¡å¼µåˆ†æç„¡åŠ¹ - åŸºæœ¬åˆ†æçµæœã‚’è¿”å´');
          return basicResult;
        }
        
        try {
          let enhancedAnalyzer = null;
          
          // kuromoji.js ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã¯é«˜ç²¾åº¦åˆ†æ
          if (window.kuromojiTokenizer) {
            enhancedAnalyzer = new window.MultiDimensionalContextAnalyzer(window.kuromojiTokenizer);
          } else {
            // kuromoji.js ä¸ä½¿ç”¨ã®å ´åˆã¯åŸºæœ¬æ‹¡å¼µåˆ†æ
            enhancedAnalyzer = new window.MultiDimensionalContextAnalyzer(null);
          }
          
          // Phase 1: å¤šæ¬¡å…ƒåˆ†æå®Ÿè¡Œ
          const enhancedResult = await enhancedAnalyzer.analyzeMultiDimensionalContext(
            inputText, 
            userPersona,
            null // contextHistory - å°†æ¥å¯¾å¿œ
          );
          
          // Phase 2: ä»®æƒ³çŠ¶æ³æ¨å®šåˆ†æï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          let situationalResult = null;
          if (window.SituationalContextEngine) {
            try {
              console.log('ğŸ¯ Phase 2: ä»®æƒ³çŠ¶æ³æ¨å®šåˆ†æé–‹å§‹');
              const situationalAnalyzer = new window.SituationalContextEngine(window.kuromojiTokenizer || null);
              situationalResult = await situationalAnalyzer.analyzeSituationalContext(
                inputText,
                enhancedResult, // Phase 1ã®çµæœã‚’å…¥åŠ›ã¨ã—ã¦ä½¿ç”¨
                userPersona
              );
              console.log('âœ¨ Phase 2: ä»®æƒ³çŠ¶æ³æ¨å®šåˆ†æå®Œäº†');
            } catch (situationalError) {
              console.warn('âš ï¸ Phase 2åˆ†æã‚¨ãƒ©ãƒ¼ï¼ˆPhase 1çµæœã®ã¿ä½¿ç”¨ï¼‰:', situationalError);
              situationalResult = null;
            }
          }
          
          // Phase 2.5: æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°åˆ†æï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          let hexagramMappingResult = null;
          if (window.HexagramMappingEngine && situationalResult && situationalResult.readyForHexagramMapping) {
            try {
              console.log('ğŸ“¿ Phase 2.5: æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°åˆ†æé–‹å§‹');
              const hexagramMapper = new window.HexagramMappingEngine();
              hexagramMappingResult = await hexagramMapper.mapSituationToHexagram(
                situationalResult,
                userPersona
              );
              console.log('âœ¨ Phase 2.5: æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°åˆ†æå®Œäº†');
            } catch (hexagramError) {
              console.warn('âš ï¸ Phase 2.5åˆ†æã‚¨ãƒ©ãƒ¼ï¼ˆPhase 1-2çµæœã®ã¿ä½¿ç”¨ï¼‰:', hexagramError);
              hexagramMappingResult = null;
            }
          }
          
          // Phase 2.9: æ˜“çµŒãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
          let metaphorGenerationResult = null;
          if (window.MetaphorGenerationEngine && hexagramMappingResult) {
            try {
              console.log('ğŸ­ Phase 2.9: æ˜“çµŒãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆé–‹å§‹');
              const metaphorGenerator = new window.MetaphorGenerationEngine();
              metaphorGenerationResult = await metaphorGenerator.generateMetaphoricalInterpretation(
                hexagramMappingResult,
                situationalResult,
                userPersona
              );
              console.log('âœ¨ Phase 2.9: æ˜“çµŒãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆå®Œäº†');
            } catch (metaphorError) {
              console.warn('âš ï¸ Phase 2.9åˆ†æã‚¨ãƒ©ãƒ¼ï¼ˆPhase 1-2.5çµæœã®ã¿ä½¿ç”¨ï¼‰:', metaphorError);
              metaphorGenerationResult = null;
            }
          }
          
          // Phase 1ãƒ»2ãƒ»2.5ãƒ»2.9çµæœã®çµ±åˆ
          const integratedResult = {
            // æ—¢å­˜äº’æ›æ€§ï¼ˆprimary, confidence, secondary, analysisï¼‰
            primary: enhancedResult.primaryContext,
            confidence: Math.min(Math.max(enhancedResult.confidence, basicResult.confidence * 0.8), 0.95),
            secondary: enhancedResult.secondaryContexts.length > 0 ? 
                      enhancedResult.secondaryContexts[0].type : basicResult.secondary,
                      
            // æ—¢å­˜analysisæ‹¡å¼µ
            analysis: {
              ...basicResult.analysis,
              
              // Phase 1æ‹¡å¼µæƒ…å ±
              enhancedAnalysis: {
                isMultidimensional: enhancedResult.isMultidimensional,
                isHSPCase: enhancedResult.isHSPCase,
                intentionClarity: enhancedResult.intentionAnalysis?.intentionClarity || 0.5,
                emotionalComplexity: enhancedResult.emotionalProfile?.emotionalComplexity || 0,
                contextWeights: enhancedResult.contextWeights,
                secondaryContexts: enhancedResult.secondaryContexts,
                qualityLevel: enhancedResult.confidence >= 0.8 ? 'Aç´šæ‹¡å¼µ' : 
                            enhancedResult.confidence >= 0.6 ? 'Bç´šæ‹¡å¼µ' : 'Cç´šæ‹¡å¼µ',
                processingTime: enhancedResult.qualityMetrics?.processingTime || 0
              },
              
              // Phase 2ä»®æƒ³çŠ¶æ³æ¨å®šçµæœ
              situationalAnalysis: situationalResult ? {
                hasSituationalAnalysis: true,
                virtualSituation: situationalResult.virtualSituation,
                situationalElements: situationalResult.situationalElements,
                contextualInference: situationalResult.contextualInference,
                consistencyScore: situationalResult.consistencyScore,
                situationalConfidence: situationalResult.confidence,
                readyForHexagramMapping: situationalResult.readyForHexagramMapping,
                situationalSummary: situationalResult.situationalSummary,
                phase2QualityLevel: situationalResult.confidence >= 0.85 ? 'Aç´šæ¨å®š' : 
                                  situationalResult.confidence >= 0.7 ? 'Bç´šæ¨å®š' : 'Cç´šæ¨å®š',
                phase2ProcessingTime: situationalResult.qualityMetrics?.processingTime || 0
              } : {
                hasSituationalAnalysis: false,
                note: 'Phase 2åˆ†ææœªå®Ÿè¡Œã¾ãŸã¯ã‚¨ãƒ©ãƒ¼'
              },
              
              // Phase 2.5: æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°çµæœ
              hexagramMapping: hexagramMappingResult ? {
                hasHexagramMapping: true,
                primaryHexagram: hexagramMappingResult.primaryHexagram,
                selectedLine: hexagramMappingResult.selectedLine,
                changingHexagram: hexagramMappingResult.changingHexagram,
                mappingConfidence: hexagramMappingResult.mappingConfidence,
                readyForMetaphorGeneration: hexagramMappingResult.readyForMetaphorGeneration,
                phase25QualityLevel: hexagramMappingResult.mappingConfidence >= 0.85 ? 'Aç´šãƒãƒƒãƒ”ãƒ³ã‚°' : 
                                   hexagramMappingResult.mappingConfidence >= 0.7 ? 'Bç´šãƒãƒƒãƒ”ãƒ³ã‚°' : 'Cç´šãƒãƒƒãƒ”ãƒ³ã‚°',
                phase25ProcessingTime: hexagramMappingResult.qualityMetrics?.processingTime || 0
              } : {
                hasHexagramMapping: false,
                note: 'Phase 2.5åˆ†ææœªå®Ÿè¡Œã¾ãŸã¯ã‚¨ãƒ©ãƒ¼'
              },
              
              // Phase 2.9: æ˜“çµŒãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆçµæœ
              metaphorGeneration: metaphorGenerationResult ? {
                hasMetaphorGeneration: true,
                primaryMetaphor: metaphorGenerationResult.primaryMetaphor,
                practicalGuidance: metaphorGenerationResult.practicalGuidance,
                adaptedMessage: metaphorGenerationResult.adaptedMessage,
                metaphorConfidence: metaphorGenerationResult.metaphorConfidence,
                actionableInsights: metaphorGenerationResult.actionableInsights,
                philosophicalDepth: metaphorGenerationResult.philosophicalDepth,
                phase29QualityLevel: metaphorGenerationResult.metaphorConfidence >= 0.85 ? 'Aç´šè¡¨ç¾' : 
                                   metaphorGenerationResult.metaphorConfidence >= 0.7 ? 'Bç´šè¡¨ç¾' : 'Cç´šè¡¨ç¾',
                phase29ProcessingTime: metaphorGenerationResult.qualityMetrics?.processingTime || 0,
                qualityAssurance: metaphorGenerationResult.qualityAssurance
              } : {
                hasMetaphorGeneration: false,
                note: 'Phase 2.9åˆ†ææœªå®Ÿè¡Œã¾ãŸã¯ã‚¨ãƒ©ãƒ¼'
              },
              
              // è©³ç´°åˆ†ææƒ…å ±
              detailedInsights: {
                primaryIntention: enhancedResult.intentionAnalysis?.primaryIntention?.type || 'unknown',
                dominantEmotion: enhancedResult.emotionalProfile?.emotionalProfile?.dominantEmotion || 'neutral',
                hspLevel: enhancedResult.emotionalProfile?.emotionalProfile?.hspLevel || 0,
                adjustmentNeed: enhancedResult.emotionalProfile?.emotionalProfile?.adjustmentNeed || 0,
                recommendedApproach: enhancedResult.emotionalProfile?.recommendedApproach || 'standard'
              }
            }
          };
          
          console.log('âœ¨ Phase 1ãƒ»2ãƒ»2.5ãƒ»2.9çµ±åˆåˆ†æå®Œäº†:', {
            primary: integratedResult.primary,
            confidence: integratedResult.confidence,
            phase1: {
              isMultidimensional: integratedResult.analysis.enhancedAnalysis.isMultidimensional,
              isHSP: integratedResult.analysis.enhancedAnalysis.isHSPCase,
              qualityLevel: integratedResult.analysis.enhancedAnalysis.qualityLevel
            },
            phase2: {
              hasSituationalAnalysis: integratedResult.analysis.situationalAnalysis.hasSituationalAnalysis,
              situationType: integratedResult.analysis.situationalAnalysis.virtualSituation?.situationType || 'N/A',
              readyForMapping: integratedResult.analysis.situationalAnalysis.readyForHexagramMapping || false,
              qualityLevel: integratedResult.analysis.situationalAnalysis.phase2QualityLevel || 'N/A'
            },
            phase25: {
              hasHexagramMapping: integratedResult.analysis.hexagramMapping.hasHexagramMapping,
              primaryHexagram: integratedResult.analysis.hexagramMapping.primaryHexagram?.name_jp || 'N/A',
              qualityLevel: integratedResult.analysis.hexagramMapping.phase25QualityLevel || 'N/A'
            },
            phase29: {
              hasMetaphorGeneration: integratedResult.analysis.metaphorGeneration.hasMetaphorGeneration,
              primaryMetaphor: integratedResult.analysis.metaphorGeneration.primaryMetaphor?.essence || 'N/A',
              qualityLevel: integratedResult.analysis.metaphorGeneration.phase29QualityLevel || 'N/A'
            }
          });
          
          return integratedResult;
          
        } catch (error) {
          console.warn('ğŸš¨ æ‹¡å¼µåˆ†æã‚¨ãƒ©ãƒ¼ - åŸºæœ¬åˆ†æã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:', error);
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯åŸºæœ¬çµæœã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æƒ…å ±ã‚’è¿½åŠ 
          return {
            ...basicResult,
            analysis: {
              ...basicResult.analysis,
              enhancedAnalysis: {
                error: error.message,
                fallbackUsed: true,
                isMultidimensional: false,
                isHSPCase: false,
                qualityLevel: 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯'
              }
            }
          };
        }
      }

      /**
       * ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤ºï¼ˆæ‹¡å¼µå¯¾å¿œï¼‰
       * 
       * ç›®çš„ï¼š
       * - æ‹¡å¼µåˆ†æçµæœã«å¯¾å¿œã—ãŸãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
       * - å¤šæ¬¡å…ƒãƒ»HSPç‰¹åŒ–æƒ…å ±ã®æä¾›
       * 
       * å‡¦ç†å†…å®¹ï¼š
       * - æ‹¡å¼µåˆ†æçµæœãŒã‚ã‚‹å ´åˆã¯è©³ç´°æƒ…å ±è¡¨ç¤º
       * - HSPç‰¹æ€§ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã¯ç‰¹åˆ¥ãªé…æ…®è¡¨ç¤º
       * - è¤‡æ•°ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®å ´åˆã¯é¸æŠè‚¢æç¤º
       */
      function showContextConfirmModalEnhanced(contextResult) {
        return new Promise((resolve) => {
          const contextType = contextResult.primary;
          const contextName = ENHANCED_CONTEXT_TYPES[contextType]?.name || contextType;
          const contextDescription = getContextDescription(contextType);
          
          // Phase 1ãƒ»2åˆ†ææƒ…å ±ã®å–å¾—
          const enhanced = contextResult.analysis?.enhancedAnalysis;
          const situational = contextResult.analysis?.situationalAnalysis;
          const detailed = contextResult.analysis?.detailedInsights;
          
          // Phase 1æ‹¡å¼µæƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ§‹ç¯‰
          let enhancedInfoSection = '';
          if (enhanced && !enhanced.error) {
            enhancedInfoSection = `
              <div class="mt-4 p-3 bg-indigo-900/30 rounded-lg border border-indigo-500/30">
                <h4 class="text-sm font-bold text-indigo-300 mb-2">ğŸŒ Phase 1: å¤šæ¬¡å…ƒåˆ†æçµæœ</h4>
                <div class="text-xs text-gray-300 space-y-1">
                  <div>å“è³ªãƒ¬ãƒ™ãƒ«: <span class="text-yellow-300">${enhanced.qualityLevel}</span></div>
                  <div>ä¿¡é ¼åº¦: <span class="text-green-300">${Math.round(contextResult.confidence * 100)}%</span></div>
                  ${enhanced.isHSPCase ? 
                    '<div class="text-pink-300">ğŸ’– HSPç‰¹æ€§ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ - æ„Ÿæƒ…èª¿æ•´ã«ç‰¹åŒ–ã—ãŸåˆ†æã‚’è¡Œã„ã¾ã™</div>' : ''}
                  ${enhanced.isMultidimensional ? 
                    '<div class="text-purple-300">ğŸ”„ è¤‡æ•°é ˜åŸŸã«ã¾ãŸãŒã‚‹è¤‡åˆçš„ãªå•é¡Œã¨ã—ã¦èªè­˜</div>' : ''}
                  ${enhanced.secondaryContexts && enhanced.secondaryContexts.length > 0 ? 
                    `<div>å‰¯æ¬¡ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: ${enhanced.secondaryContexts.map(ctx => ENHANCED_CONTEXT_TYPES[ctx.type]?.name || ctx.type).join(', ')}</div>` : ''}
                </div>
              </div>
            `;
          }
          
          // Phase 2ä»®æƒ³çŠ¶æ³æ¨å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ§‹ç¯‰
          let situationalInfoSection = '';
          if (situational && situational.hasSituationalAnalysis) {
            situationalInfoSection = `
              <div class="mt-4 p-3 bg-purple-900/30 rounded-lg border border-purple-500/30">
                <h4 class="text-sm font-bold text-purple-300 mb-2">ğŸ¯ Phase 2: ä»®æƒ³çŠ¶æ³æ¨å®šçµæœ</h4>
                <div class="text-xs text-gray-300 space-y-1">
                  <div>æ¨å®šå“è³ª: <span class="text-yellow-300">${situational.phase2QualityLevel}</span></div>
                  <div>çŠ¶æ³ä¿¡é ¼åº¦: <span class="text-green-300">${Math.round(situational.situationalConfidence * 100)}%</span></div>
                  <div>çŠ¶æ³ã‚¿ã‚¤ãƒ—: <span class="text-cyan-300">${situational.virtualSituation?.situationType || 'ä¸æ˜'}</span></div>
                  <div>ä¸€è²«æ€§: <span class="text-blue-300">${Math.round(situational.consistencyScore * 100)}%</span></div>
                  ${situational.readyForHexagramMapping ? 
                    '<div class="text-emerald-300">âœ… æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°æº–å‚™å®Œäº†</div>' : 
                    '<div class="text-orange-300">âš ï¸ æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°è¦æ¤œè¨</div>'}
                  ${situational.situationalSummary ? 
                    `<div class="mt-2 text-gray-400">çŠ¶æ³æ¦‚è¦: ${situational.situationalSummary.coreNarrative || 'åˆ†æä¸­'}</div>` : ''}
                </div>
              </div>
            `;
          } else if (situational && !situational.hasSituationalAnalysis) {
            situationalInfoSection = `
              <div class="mt-4 p-3 bg-gray-700/30 rounded-lg border border-gray-500/30">
                <h4 class="text-sm font-bold text-gray-400 mb-2">ğŸ¯ Phase 2: ä»®æƒ³çŠ¶æ³æ¨å®š</h4>
                <div class="text-xs text-gray-400">
                  <div>Phase 2åˆ†æã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>
                  <div class="text-gray-500">${situational.note || 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç„¡åŠ¹åŒ–'}</div>
                </div>
              </div>
            `;
          }
          
          // Phase 2.5æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ§‹ç¯‰
          let hexagramMappingSection = '';
          const hexagramMapping = contextResult.analysis?.hexagramMapping;
          if (hexagramMapping && hexagramMapping.hasHexagramMapping) {
            hexagramMappingSection = `
              <div class="mt-4 p-3 bg-amber-900/30 rounded-lg border border-amber-500/30">
                <h4 class="text-sm font-bold text-amber-300 mb-2">ğŸ“¿ Phase 2.5: æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°çµæœ</h4>
                <div class="text-xs text-gray-300 space-y-1">
                  <div>ãƒãƒƒãƒ”ãƒ³ã‚°å“è³ª: <span class="text-yellow-300">${hexagramMapping.phase25QualityLevel}</span></div>
                  <div>ãƒãƒƒãƒ”ãƒ³ã‚°ä¿¡é ¼åº¦: <span class="text-green-300">${Math.round(hexagramMapping.mappingConfidence * 100)}%</span></div>
                  <div>ä¸»å¦: <span class="text-cyan-300">${hexagramMapping.primaryHexagram?.name_jp || 'ä¸æ˜'}</span></div>
                  <div>é¸æŠçˆ»: <span class="text-blue-300">${hexagramMapping.selectedLine?.çˆ» || 'ä¸æ˜'}</span></div>
                  ${hexagramMapping.readyForMetaphorGeneration ? 
                    '<div class="text-emerald-300">âœ… ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆæº–å‚™å®Œäº†</div>' : 
                    '<div class="text-orange-300">âš ï¸ ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆè¦æ¤œè¨</div>'}
                </div>
              </div>
            `;
          } else if (hexagramMapping && !hexagramMapping.hasHexagramMapping) {
            hexagramMappingSection = `
              <div class="mt-4 p-3 bg-gray-700/30 rounded-lg border border-gray-500/30">
                <h4 class="text-sm font-bold text-gray-400 mb-2">ğŸ“¿ Phase 2.5: æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°</h4>
                <div class="text-xs text-gray-400">
                  <div>Phase 2.5åˆ†æã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>
                  <div class="text-gray-500">${hexagramMapping.note || 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç„¡åŠ¹åŒ–'}</div>
                </div>
              </div>
            `;
          }
          
          // Phase 2.9ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®æ§‹ç¯‰
          let metaphorGenerationSection = '';
          const metaphorGeneration = contextResult.analysis?.metaphorGeneration;
          if (metaphorGeneration && metaphorGeneration.hasMetaphorGeneration) {
            metaphorGenerationSection = `
              <div class="mt-4 p-3 bg-pink-900/30 rounded-lg border border-pink-500/30">
                <h4 class="text-sm font-bold text-pink-300 mb-2">ğŸ­ Phase 2.9: æ˜“çµŒãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆçµæœ</h4>
                <div class="text-xs text-gray-300 space-y-1">
                  <div>è¡¨ç¾å“è³ª: <span class="text-yellow-300">${metaphorGeneration.phase29QualityLevel}</span></div>
                  <div>ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ä¿¡é ¼åº¦: <span class="text-green-300">${Math.round(metaphorGeneration.metaphorConfidence * 100)}%</span></div>
                  <div>ä¸»è¦ãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼: <span class="text-cyan-300">${metaphorGeneration.primaryMetaphor?.essence || 'ç”Ÿæˆä¸­'}</span></div>
                  ${metaphorGeneration.qualityAssurance?.verificationPassed ? 
                    '<div class="text-emerald-300">âœ… å“è³ªæ¤œè¨¼åˆæ ¼</div>' : 
                    '<div class="text-orange-300">âš ï¸ å“è³ªè¦æ”¹å–„</div>'}
                  ${metaphorGeneration.actionableInsights && metaphorGeneration.actionableInsights.length > 0 ? 
                    `<div class="mt-2 text-gray-400">å®Ÿç”¨çš„æ´å¯Ÿ: ${metaphorGeneration.actionableInsights.slice(0,2).join(', ')}</div>` : ''}
                </div>
              </div>
            `;
          } else if (metaphorGeneration && !metaphorGeneration.hasMetaphorGeneration) {
            metaphorGenerationSection = `
              <div class="mt-4 p-3 bg-gray-700/30 rounded-lg border border-gray-500/30">
                <h4 class="text-sm font-bold text-gray-400 mb-2">ğŸ­ Phase 2.9: æ˜“çµŒãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ç”Ÿæˆ</h4>
                <div class="text-xs text-gray-400">
                  <div>Phase 2.9åˆ†æã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ</div>
                  <div class="text-gray-500">${metaphorGeneration.note || 'ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ã¾ãŸã¯ç„¡åŠ¹åŒ–'}</div>
                </div>
              </div>
            `;
          }
          
          const modalContent = `
            <h2 class="text-2xl font-bold text-indigo-300 mb-4">ğŸ¯ AIã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ</h2>
            <div class="mb-6 p-4 bg-gray-800 rounded-lg">
              <p class="mb-3">
                ã”å…¥åŠ›ã„ãŸã ã„ãŸå†…å®¹ã‚’åˆ†æã—ãŸçµæœã€ã“ã‚Œã¯ä¸»ã«<br>
                <strong class="text-yellow-300 text-lg">ã€Œ${contextName}ã€</strong>ã§ã‚ã‚‹ã¨æ¨æ¸¬ã—ã¾ã—ãŸã€‚
              </p>
              <p class="text-sm text-gray-300 mb-3">
                ${contextDescription}
              </p>
              ${enhancedInfoSection}
              ${situationalInfoSection}
              ${hexagramMappingSection}
              ${metaphorGenerationSection}
              <p class="text-xs text-gray-400 mt-3">
                â€» ã“ã®åˆ†æã«ã‚ˆã‚Šã€æœ€é©ãªæ˜“çµŒã®å¦ã¨çˆ»ã‚’é¸å®šã—ã¾ã™
              </p>
            </div>
            <div class="flex justify-center space-x-4">
              <button id="confirmYesBtn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">âœ… ã“ã®è§£é‡ˆã§é€²ã‚ã‚‹</button>
              <button id="confirmNoBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">ğŸ”„ è§£é‡ˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹</button>
            </div>
          `;
          
          showModal(modalContent);

          const confirmYesBtn = document.getElementById('confirmYesBtn');
          const confirmNoBtn = document.getElementById('confirmNoBtn');

          confirmYesBtn.addEventListener('click', () => {
            hideModal();
            resolve(true);
          });

          confirmNoBtn.addEventListener('click', () => {
            hideModal();
            resolve(false);
          });
        });
      }

      /**
       * ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
       * @param {string} contextType - ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚¤ãƒ—
       * @returns {Promise<boolean>} ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é¸æŠçµæœ
       */
      function showContextConfirmModal(contextType) {
        return new Promise((resolve) => {
          // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚¤ãƒ—ã®è¡¨ç¤ºåå–å¾—
          const contextName = ENHANCED_CONTEXT_TYPES[contextType]?.name || contextType;
          const contextDescription = getContextDescription(contextType);
          
          const modalContent = `
            <h2 class="text-2xl font-bold text-indigo-300 mb-4">ğŸ¯ AIã«ã‚ˆã‚‹ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ</h2>
            <div class="mb-6 p-4 bg-gray-800 rounded-lg">
              <p class="mb-3">
                ã”å…¥åŠ›ã„ãŸã ã„ãŸå†…å®¹ã‚’åˆ†æã—ãŸçµæœã€ã“ã‚Œã¯ä¸»ã«<br>
                <strong class="text-yellow-300 text-lg">ã€Œ${contextName}ã€</strong>ã§ã‚ã‚‹ã¨æ¨æ¸¬ã—ã¾ã—ãŸã€‚
              </p>
              <p class="text-sm text-gray-300 mb-3">
                ${contextDescription}
              </p>
              <p class="text-xs text-gray-400">
                â€» ã“ã®åˆ†æã«ã‚ˆã‚Šã€æœ€é©ãªæ˜“çµŒã®å¦ã¨çˆ»ã‚’é¸å®šã—ã¾ã™
              </p>
            </div>
            <div class="flex justify-center space-x-4">
              <button id="confirmYesBtn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium">âœ… ã“ã®è§£é‡ˆã§é€²ã‚ã‚‹</button>
              <button id="confirmNoBtn" class="px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors font-medium">ğŸ”„ è§£é‡ˆã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹</button>
            </div>
          `;
          showModal(modalContent);

          const confirmYesBtn = document.getElementById('confirmYesBtn');
          const confirmNoBtn = document.getElementById('confirmNoBtn');

          confirmYesBtn.addEventListener('click', () => {
            hideModal();
            resolve(true);
          });

          confirmNoBtn.addEventListener('click', () => {
            hideModal();
            resolve(false);
          });
        });
      }

      // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆèª¬æ˜æ–‡å–å¾—é–¢æ•°
      function getContextDescription(contextType) {
        const descriptions = {
          emotion_management: 'HSPï¼ˆé«˜æ„Ÿå—æ€§ï¼‰ã‚„æ„Ÿæƒ…èª¿æ•´ã®å›°ã‚Šã”ã¨ã€ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«ãªçŠ¶æ…‹ã®ç¶­æŒã«é–¢ã™ã‚‹å•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™',
          personal: 'å€‹äººã®å†…é¢çš„ãªæ‚©ã¿ã€æ„Ÿæƒ…ã€ä¾¡å€¤è¦³ã«é–¢ã™ã‚‹å•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™',
          social: 'ç¤¾ä¼šå•é¡Œã€æ”¿æ²»ã€çµŒæ¸ˆã€ç’°å¢ƒãªã©ã®ç¤¾ä¼šçš„èª²é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™', 
          relationship: 'å®¶æ—ã€æ‹äººã€å‹äººã€è·å ´ã§ã®äººé–“é–¢ä¿‚ã®å•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™',
          business: 'ä»•äº‹ã€ã‚­ãƒ£ãƒªã‚¢ã€çµ„ç¹”ã€çµŒå–¶ã«é–¢ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹å•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™',
          philosophical: 'äººç”Ÿè¦³ã€å­˜åœ¨æ„ç¾©ã€ä¾¡å€¤è¦³ãªã©ã®å“²å­¦çš„å•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™',
          technical: 'æŠ€è¡“çš„èª²é¡Œã€å°‚é–€åˆ†é‡ã€ç ”ç©¶é–‹ç™ºã«é–¢ã™ã‚‹å•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™', 
          temporal: 'æ™‚é–“è»¸ã«é–¢ã‚ã‚‹éå»ãƒ»ç¾åœ¨ãƒ»æœªæ¥ã®è¤‡åˆçš„å•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™',
          hybrid: 'è¤‡æ•°ã®é ˜åŸŸã«ã¾ãŸãŒã‚‹è¤‡åˆçš„ãªå•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™',
          entrepreneur: 'èµ·æ¥­ã€äº‹æ¥­è»¢æ›ã€ç‹¬ç«‹ã€æ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç«‹ã¡ä¸Šã’ã«é–¢ã™ã‚‹å•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™'
        };
        return descriptions[contextType] || 'åŒ…æ‹¬çš„ãªå•é¡Œã¨ã—ã¦åˆ†æã—ã¾ã™';
      }

      /**
       * ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ‡ã‚Šæ›¿ãˆé€šçŸ¥ãƒ¢ãƒ¼ãƒ€ãƒ«ã®è¡¨ç¤º
       * @param {string} switchedContextType - åˆ‡ã‚Šæ›¿ãˆå¾Œã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚¿ã‚¤ãƒ—
       * @returns {Promise<void>}
       */
      function showContextSwitchModal(switchedContextType) {
        return new Promise((resolve) => {
          // 8åˆ†é¡å¯¾å¿œã®ä»£æ›¿ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé¸æŠæ©Ÿèƒ½
          const alternativeContexts = getAlternativeContexts(switchedContextType);
          const contextButtons = alternativeContexts.map(context => 
            `<button class="context-switch-btn px-4 py-2 m-1 bg-gray-700 text-white rounded-lg hover:bg-indigo-600 transition-colors" data-context="${context.id}">
              ${context.name}
            </button>`
          ).join('');
          
          const modalContent = `
            <h2 class="text-2xl font-bold text-indigo-300 mb-4">ğŸ”„ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆè§£é‡ˆã®åˆ‡ã‚Šæ›¿ãˆ</h2>
            <p class="mb-4 text-sm text-gray-300">
              ã©ã®è¦³ç‚¹ã‹ã‚‰åˆ†æã—ã¾ã™ã‹ï¼Ÿæœ€ã‚‚é©åˆ‡ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ï¼š
            </p>
            <div class="mb-6 flex flex-wrap justify-center">
              ${contextButtons}
            </div>
            <div class="flex justify-center">
              <button id="cancelSwitchBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
            </div>
          `;
          showModal(modalContent);

          // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé¸æŠãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
          document.querySelectorAll('.context-switch-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
              const selectedContext = e.target.dataset.context;
              hideModal();
              resolve(selectedContext);  
            });
          });

          const cancelSwitchBtn = document.getElementById('cancelSwitchBtn');
          cancelSwitchBtn.addEventListener('click', () => {
            hideModal();
            resolve(switchedContextType); // å…ƒã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™
          });
        });
      }

      // ä»£æ›¿ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆå€™è£œç”Ÿæˆ
      function getAlternativeContexts(currentContext) {
        const allContexts = Object.entries(ENHANCED_CONTEXT_TYPES)
          .filter(([id]) => id !== currentContext && id !== 'hybrid')
          .map(([id, config]) => ({ id, name: config.name }));
        
        // é–¢é€£æ€§ã®é«˜ã„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚’å„ªå…ˆè¡¨ç¤º
        const priorityOrder = {
          emotion_management: ['personal', 'relationship', 'philosophical'],
          personal: ['relationship', 'philosophical', 'business'],
          social: ['business', 'political', 'technical'],
          relationship: ['personal', 'business', 'social'],
          business: ['relationship', 'social', 'technical'],
          philosophical: ['personal', 'temporal', 'social'],
          technical: ['business', 'social', 'temporal'],
          temporal: ['philosophical', 'personal', 'social'],
          entrepreneur: ['business', 'temporal', 'personal']
        };
        
        const priorities = priorityOrder[currentContext] || [];
        const prioritized = priorities.map(id => allContexts.find(ctx => ctx.id === id)).filter(Boolean);
        const remaining = allContexts.filter(ctx => !priorities.includes(ctx.id));
        
        return [...prioritized, ...remaining].slice(0, 6); // æœ€å¤§6å€‹è¡¨ç¤º
      }

      // ===== å‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ  (Dynamic Keyword Generation System) =====
      
      /**
       * kuromoji.jsã‚’æ´»ç”¨ã—ãŸå‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ³ã‚¸ãƒ³
       */
      class DynamicKeywordGenerator {
        constructor(kuromojiTokenizer) {
          this.tokenizer = kuromojiTokenizer;
          this.stemCache = new Map();
          this.relationCache = new Map();
          this.maxCacheSize = 1000;
          
          // é–¢é€£èªãƒãƒƒãƒ”ãƒ³ã‚°è¾æ›¸
          this.semanticRelations = this.initializeSemanticRelations();
          
          // æ„Ÿæƒ…å¼·åº¦ãƒãƒƒãƒ”ãƒ³ã‚°
          this.emotionalIntensity = this.initializeEmotionalIntensity();
        }

        initializeSemanticRelations() {
          return {
            // ç¤¾ä¼šå•é¡Œé–¢é€£èªå½™æ‹¡å¼µ
            'çµŒæ¸ˆ': ['é‡‘éŠ­', 'ãŠé‡‘', 'è²¡æ”¿', 'æ™¯æ°—', 'åå…¥', 'æ”¯å‡º', 'æŠ•è³‡', 'è²¯é‡‘', 'å‚µå‹™', 'ç¨é‡‘'],
            'æ”¿æ²»': ['æ”¿ç­–', 'é¸æŒ™', 'æ”¿åºœ', 'å›½ä¼š', 'æ³•å¾‹', 'åˆ¶åº¦', 'æ”¹é©', 'æ°‘ä¸»ä¸»ç¾©', 'æ¨©åŠ›'],
            'ç’°å¢ƒ': ['è‡ªç„¶', 'æ°—å€™', 'åœ°çƒ', 'æ¸©æš–åŒ–', 'æ±šæŸ“', 'è³‡æº', 'ã‚¨ãƒãƒ«ã‚®ãƒ¼', 'æŒç¶šå¯èƒ½'],
            'ç¤¾ä¼š': ['æ ¼å·®', 'å¹³ç­‰', 'å…¬æ­£', 'å·®åˆ¥', 'ãƒ€ã‚¤ãƒãƒ¼ã‚·ãƒ†ã‚£', 'å°‘å­é«˜é½¢åŒ–', 'æ•™è‚²', 'åŒ»ç™‚'],
            
            // æ„Ÿæƒ…ãƒ»å¿ƒç†é–¢é€£èªå½™æ‹¡å¼µ
            'ä¸å®‰': ['å¿ƒé…', 'æã‚Œ', 'å±æƒ§', 'æ‡¸å¿µ', 'ç„¦ã‚Š', 'ãƒ‰ã‚­ãƒ‰ã‚­', 'ã³ãã³ã', 'ç·Šå¼µ'],
            'æ‚²ã—ã„': ['è¾›ã„', 'è‹¦ã—ã„', 'è½ã¡è¾¼ã‚€', 'æ†‚é¬±', 'ã—ã‚“ã©ã„', 'æ°—åˆ†ãŒæ²ˆã‚€', 'ãƒ–ãƒ«ãƒ¼'],
            'æ€’ã‚Š': ['ã‚¤ãƒ©ã‚¤ãƒ©', 'è…¹ç«‹ã¤', 'ãƒ ã‚«ã¤ã', 'æ†¤ã‚Š', 'æ¿€æ€’', 'é ­ã«ãã‚‹', 'ã‚­ãƒ¬ã‚‹'],
            'å–œã³': ['å¬‰ã—ã„', 'æ¥½ã—ã„', 'å¹¸ã›', 'æº€è¶³', 'å……å®Ÿ', 'ãƒ¯ã‚¯ãƒ¯ã‚¯', 'ãƒãƒƒãƒ”ãƒ¼'],
            
            // ãƒ“ã‚¸ãƒã‚¹é–¢é€£èªå½™æ‹¡å¼µ
            'ä»•äº‹': ['æ¥­å‹™', 'è·å‹™', 'åŠ´åƒ', 'ã‚¿ã‚¹ã‚¯', 'ä½œæ¥­', 'ãƒ¯ãƒ¼ã‚¯', 'ã‚¸ãƒ§ãƒ–', 'è·æ¥­'],
            'ä¼šç¤¾': ['ä¼æ¥­', 'çµ„ç¹”', 'è·å ´', 'ã‚ªãƒ•ã‚£ã‚¹', 'æ³•äºº', 'ã‚³ãƒ¼ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'å‹¤å‹™å…ˆ'],
            'ã‚­ãƒ£ãƒªã‚¢': ['çµŒæ­´', 'æ˜‡é€²', 'æ˜‡æ ¼', 'è»¢è·', 'å°±è·', 'å‡ºä¸–', 'ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—'],
            'ãƒãƒ¼ãƒ ': ['ã‚°ãƒ«ãƒ¼ãƒ—', 'ç­', 'éƒ¨ç½²', 'éƒ¨é–€', 'ãƒ¡ãƒ³ãƒãƒ¼', 'åŒåƒš', 'ã‚¹ã‚¿ãƒƒãƒ•'],
            
            // äººé–“é–¢ä¿‚é–¢é€£èªå½™æ‹¡å¼µ
            'å®¶æ—': ['è¦ª', 'å­', 'å…„å¼Ÿ', 'å§‰å¦¹', 'å¤«å©¦', 'é…å¶è€…', 'è¦ªæ—', 'èº«å†…'],
            'å‹äºº': ['å‹é”', 'ä»²é–“', 'çŸ¥äºº', 'ãƒãƒ–ãƒ€ãƒ', 'è¦ªå‹', 'ãƒ™ã‚¹ãƒˆãƒ•ãƒ¬ãƒ³ãƒ‰'],
            'æ‹æ„›': ['æ‹äºº', 'å½¼æ°', 'å½¼å¥³', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', 'æ‹', 'æ„›æƒ…', 'ãƒ­ãƒãƒ³ã‚¹'],
            'é–¢ä¿‚': ['ä»˜ãåˆã„', 'ç¹‹ãŒã‚Š', 'çµ†', 'ç¸', 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'äº¤æµ'],
            
            // å“²å­¦ãƒ»ç²¾ç¥é–¢é€£èªå½™æ‹¡å¼µ
            'äººç”Ÿ': ['ç”Ÿæ¶¯', 'ç”Ÿæ´»', 'äººé–“', 'å­˜åœ¨', 'ç”Ÿãã‚‹', 'ãƒ©ã‚¤ãƒ•'],
            'æ„å‘³': ['ä¾¡å€¤', 'ç›®çš„', 'æ„ç¾©', 'ç†ç”±', 'æ ¹æ‹ ', 'æœ¬è³ª'],
            'å¹¸ã›': ['å¹¸ç¦', 'æº€è¶³', 'å……å®Ÿ', 'å–œã³', 'æ¥½ã—ã•', 'ãƒãƒ”ãƒã‚¹'],
            'æˆåŠŸ': ['é”æˆ', 'æˆæœ', 'å‹åˆ©', 'å®Ÿç¾', 'å®Œæˆ', 'ã‚µã‚¯ã‚»ã‚¹'],
            
            // æŠ€è¡“é–¢é€£èªå½™æ‹¡å¼µ
            'æŠ€è¡“': ['ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼', 'ã‚¹ã‚­ãƒ«', 'å°‚é–€', 'çŸ¥è­˜', 'ãƒã‚¦ãƒã‚¦', 'æŠ€èƒ½'],
            'ã‚·ã‚¹ãƒ†ãƒ ': ['ä»•çµ„ã¿', 'æ§‹é€ ', 'ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£', 'ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ', 'ã‚¤ãƒ³ãƒ•ãƒ©'],
            'é–‹ç™º': ['åˆ¶ä½œ', 'æ§‹ç¯‰', 'è¨­è¨ˆ', 'å®Ÿè£…', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°', 'ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°'],
            'ç ”ç©¶': ['èª¿æŸ»', 'åˆ†æ', 'å®Ÿé¨“', 'æ¤œè¨¼', 'è§£æ', 'ãƒªã‚µãƒ¼ãƒ']
          };
        }

        initializeEmotionalIntensity() {
          return {
            // å¼·ã„æ„Ÿæƒ…è¡¨ç¾
            high: ['çµ¶å¯¾', 'å¿…ãš', 'å®Œå…¨', 'æœ¬å½“ã«', 'ã™ã”ã', 'ã¨ã¦ã‚‚', 'éå¸¸ã«', 'æ¥µã‚ã¦', 'æ¿€ã—ã'],
            // ä¸­ç¨‹åº¦ã®æ„Ÿæƒ…è¡¨ç¾  
            medium: ['ã‹ãªã‚Š', 'ã ã„ã¶', 'ã‘ã£ã“ã†', 'ã‚ã‚Šã¨', 'ãã“ãã“', 'ã¾ã‚ã¾ã‚'],
            // å¼±ã„æ„Ÿæƒ…è¡¨ç¾
            low: ['å°‘ã—', 'ã¡ã‚‡ã£ã¨', 'ã‚„ã‚„', 'ã‚ãšã‹', 'ãªã‚“ã¨ãªã', 'ã»ã‚“ã®']
          };
        }

        // ãƒ¡ã‚¤ãƒ³ã®å‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆãƒ¡ã‚½ãƒƒãƒ‰
        generateDynamicKeywords(text, baseKeywords = []) {
          if (!this.tokenizer) {
            console.warn('kuromoji tokenizer not available, using basic keyword expansion');
            return this.basicKeywordExpansion(text, baseKeywords);
          }

          const cacheKey = `${text}_${baseKeywords.join(',')}`;
          if (this.relationCache.has(cacheKey)) {
            return this.relationCache.get(cacheKey);
          }

          const expandedKeywords = new Set(baseKeywords);
          
          // å½¢æ…‹ç´ è§£æã«ã‚ˆã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
          const tokens = this.tokenizer.tokenize(text);
          const extractedKeywords = this.extractKeywordsFromTokens(tokens);
          
          // åŸºæœ¬ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é–¢é€£èªå±•é–‹
          baseKeywords.forEach(keyword => {
            const related = this.getRelatedWords(keyword);
            related.forEach(word => expandedKeywords.add(word));
          });
          
          // æŠ½å‡ºã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é–¢é€£èªå±•é–‹
          extractedKeywords.forEach(keyword => {
            expandedKeywords.add(keyword);
            const related = this.getRelatedWords(keyword);
            related.forEach(word => expandedKeywords.add(word));
          });
          
          // æ„Ÿæƒ…å¼·åº¦åˆ†æã«ã‚ˆã‚‹é‡ã¿ä»˜ãå±•é–‹
          const emotionalKeywords = this.generateEmotionalKeywords(text, tokens);
          emotionalKeywords.forEach(keyword => expandedKeywords.add(keyword));
          
          const result = Array.from(expandedKeywords);
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
          if (this.relationCache.size >= this.maxCacheSize) {
            const firstKey = this.relationCache.keys().next().value;
            this.relationCache.delete(firstKey);
          }
          this.relationCache.set(cacheKey, result);
          
          return result;
        }

        extractKeywordsFromTokens(tokens) {
          const keywords = [];
          
          tokens.forEach(token => {
            // é‡è¦ãªå“è©ã®ã¿æŠ½å‡º
            if (['åè©', 'å‹•è©', 'å½¢å®¹è©', 'å‰¯è©'].includes(token.pos)) {
              // å˜å­—ã¯é™¤å¤–ã€åŸºæœ¬å½¢ã‚’ä½¿ç”¨
              if (token.basic_form.length > 1) {
                keywords.push(token.basic_form);
              }
            }
            
            // è¤‡åˆåè©ã®æ¤œå‡º
            if (token.pos === 'åè©' && token.pos_detail_1 === 'ä¸€èˆ¬') {
              keywords.push(token.surface_form);
            }
          });
          
          return [...new Set(keywords)]; // é‡è¤‡é™¤å»
        }

        getRelatedWords(keyword) {
          const related = [];
          
          // ç›´æ¥é–¢é€£èªãƒãƒƒãƒ”ãƒ³ã‚°
          if (this.semanticRelations[keyword]) {
            related.push(...this.semanticRelations[keyword]);
          }
          
          // éƒ¨åˆ†ä¸€è‡´ã«ã‚ˆã‚‹é–¢é€£èªæ¤œç´¢
          Object.entries(this.semanticRelations).forEach(([key, values]) => {
            if (key.includes(keyword) || keyword.includes(key)) {
              related.push(key, ...values);
            }
            
            if (values.includes(keyword)) {
              related.push(key, ...values);
            }
          });
          
          // èªå¹¹ã«ã‚ˆã‚‹é–¢é€£èªç”Ÿæˆ
          if (this.tokenizer) {
            const stemRelated = this.generateStemRelated(keyword);
            related.push(...stemRelated);
          }
          
          return [...new Set(related)]; // é‡è¤‡é™¤å»
        }

        generateStemRelated(keyword) {
          const cacheKey = `stem_${keyword}`;
          if (this.stemCache.has(cacheKey)) {
            return this.stemCache.get(cacheKey);
          }
          
          const tokens = this.tokenizer.tokenize(keyword);
          const related = [];
          
          tokens.forEach(token => {
            const stem = token.basic_form;
            const pos = token.pos;
            
            // å“è©åˆ¥ã®æ´»ç”¨å½¢ç”Ÿæˆ
            switch (pos) {
              case 'åè©':
                related.push(stem + 'ã®', stem + 'ã«', stem + 'ã‚’', stem + 'ãŒ', stem + 'ã§');
                break;
              case 'å‹•è©':
                related.push(stem + 'ã‚‹', stem + 'ãŸ', stem + 'ã¦', stem + 'ãªã„', stem + 'ã¾ã™');
                break;
              case 'å½¢å®¹è©':
                related.push(stem + 'ã„', stem + 'ã', stem + 'ãª', stem + 'ã•');
                break;
              case 'å‰¯è©':
                related.push(stem + 'ã«', stem + 'ã¨', stem + 'ã‚‚');
                break;
            }
          });
          
          this.stemCache.set(cacheKey, related);
          return related;
        }

        generateEmotionalKeywords(text, tokens) {
          const emotionalKeywords = [];
          
          // æ„Ÿæƒ…å¼·åº¦ã®æ¤œå‡º
          let intensityLevel = 'medium';
          Object.entries(this.emotionalIntensity).forEach(([level, words]) => {
            if (words.some(word => text.includes(word))) {
              intensityLevel = level;
            }
          });
          
          // æ„Ÿæƒ…è¡¨ç¾ã®å¼·åº¦ã«å¿œã˜ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±•é–‹
          tokens.forEach(token => {
            if (token.pos === 'æ„Ÿå‹•è©' || token.pos_detail_1 === 'æ„Ÿå‹•è©çš„') {
              emotionalKeywords.push(token.basic_form);
              
              // å¼·åº¦ã«å¿œã˜ãŸé–¢é€£èªè¿½åŠ 
              if (intensityLevel === 'high') {
                emotionalKeywords.push('å¼·ã', 'æ¿€ã—ã', 'æ·±ã');
              } else if (intensityLevel === 'low') {
                emotionalKeywords.push('è»½ã', 'ã¡ã‚‡ã£ã¨', 'å°‘ã—');
              }
            }
          });
          
          return emotionalKeywords;
        }

        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®åŸºæœ¬ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å±•é–‹
        basicKeywordExpansion(text, baseKeywords) {
          const expanded = new Set(baseKeywords);
          
          // åŸºæœ¬çš„ãªé–¢é€£èªãƒãƒƒãƒ”ãƒ³ã‚°
          baseKeywords.forEach(keyword => {
            if (this.semanticRelations[keyword]) {
              this.semanticRelations[keyword].forEach(word => expanded.add(word));
            }
          });
          
          return Array.from(expanded);
        }
      }

      // ===== ã‚¤ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æ¤œå‡ºã‚·ã‚¹ãƒ†ãƒ  (Irregular Pattern Detection System) =====
      
      /**
       * å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®ç•°å¸¸ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œå‡ºã—ã€ç²¾åº¦å‘ä¸Šã®ãŸã‚ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›
       */
      class IrregularPatternDetector {
        constructor() {
          this.patterns = this.initializePatterns();
        }

        initializePatterns() {
          return {
            emotional_extreme: {
              too_emotional_positive: {
                pattern: /[ï¼]{2,}|[ï¼Ÿ]{2,}|[æœ€è¶…].{0,5}[é«˜è‰¯å¥½]/g,
                weight: -0.1,
                message: 'æ„Ÿæƒ…è¡¨ç¾ãŒå¼·ã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ã‚ˆã‚Šå…·ä½“çš„ãªçŠ¶æ³ã‚’è¿½åŠ ã™ã‚‹ã¨ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              too_emotional_negative: {
                pattern: /[æ­»æ®ºçµ¶æœ€].{0,5}[å¯¾æ‚ªé™º]|ã‚„ã°ã„.{0,5}[æ­»çµ‚]|[çµ‚æ­»].{0,5}ã‚ã£ãŸ/g,
                weight: -0.15,
                message: 'æ¥µç«¯ãªè¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚çŠ¶æ³ã‚’ã‚ˆã‚Šå®¢è¦³çš„ã«è¡¨ç¾ã™ã‚‹ã¨ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              too_cold: {
                pattern: /^[ã€‚ã€\s]*[ã§ã‚ã‚‹|ã |ã§ã™|ã¾ã™|ãªã‚‹|ã„ã‚‹|ã‚ã‚‹][ã€‚ã€\s]*$/,
                weight: -0.05,
                message: 'æ„Ÿæƒ…çš„ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ãŒå°‘ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚æ„Ÿã˜ã¦ã„ã‚‹ã“ã¨ã‚‚è¿½åŠ ã—ã¦ã¿ã¦ãã ã•ã„ã€‚'
              },
              excessive_caps: {
                pattern: /[A-Z]{4,}/g,
                weight: -0.08,
                message: 'å¤§æ–‡å­—ãŒå¤šç”¨ã•ã‚Œã¦ã„ã¾ã™ã€‚é€šå¸¸ã®è¡¨è¨˜ã«ã™ã‚‹ã¨åˆ†æã—ã‚„ã™ããªã‚Šã¾ã™ã€‚'
              }
            },

            language_patterns: {
              too_short: {
                condition: (text) => text.length < 10,
                weight: -0.2,
                message: 'å…¥åŠ›ãŒçŸ­ã™ãã¾ã™ã€‚ã€Œãªãœã€ã€Œã©ã®ã‚ˆã†ãªçŠ¶æ³ã§ã€ã‚’è¿½åŠ ã™ã‚‹ã¨ç²¾åº¦ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã™ã€‚'
              },
              too_long: {
                condition: (text) => text.length > 1000,
                weight: -0.1,
                message: 'å…¥åŠ›ãŒé•·ã™ãã¾ã™ã€‚æœ€ã‚‚é‡è¦ãªå•é¡Œã«çµã‚‹ã¨ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              dialect_heavy: {
                pattern: /[ã ã£][ã¹ãº]|ã‚„ã‚“|ã‚„ã­|ã ã«|ã˜ã‚ƒã‘ã‚“|ã ã£ã¡ã‚ƒ|ãšã‚‰|ã¹ã•/g,
                weight: -0.05,
                message: 'æ–¹è¨€ãŒå¤šãå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚æ¨™æº–èªã§ã®è¡¨ç¾ã‚‚ä½µè¨˜ã™ã‚‹ã¨åˆ†æç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              slang_heavy: {
                pattern: /ã‚„ã°ã„|ã¾ã˜|ã†ã–ã„|ãã‚‚ã„|ã‚€ã‹ã¤ã|ã†ãœãƒ¼|ã ã‚Šãƒ¼|ã‚ã‚“ã©ã„/g,
                weight: -0.05,
                message: 'ä¿—èªãŒå¤šãå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ã‚ˆã‚Šå…·ä½“çš„ãªè¡¨ç¾ã«ã™ã‚‹ã¨åˆ†æç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              repetitive_words: {
                condition: (text) => {
                  const words = text.split(/\s+/);
                  const wordCount = {};
                  words.forEach(word => wordCount[word] = (wordCount[word] || 0) + 1);
                  return Object.values(wordCount).some(count => count > 3);
                },
                weight: -0.03,
                message: 'åŒã˜å˜èªã®ç¹°ã‚Šè¿”ã—ãŒå¤šãã‚ã‚Šã¾ã™ã€‚å¤šæ§˜ãªè¡¨ç¾ã‚’ä½¿ã†ã¨åˆ†æç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              }
            },

            content_patterns: {
              too_abstract: {
                condition: (text) => {
                  const abstractWords = ['å­˜åœ¨', 'æœ¬è³ª', 'çœŸç†', 'æ„å‘³', 'ä¾¡å€¤', 'ç†å¿µ', 'å“²å­¦', 'æ€æƒ³', 'ç²¾ç¥', 'é­‚'];
                  const concreteWords = ['ä¼šç¤¾', 'å®¶', 'äºº', 'æ™‚é–“', 'ãŠé‡‘', 'ä»•äº‹', 'å®¶æ—', 'å‹äºº', 'å­¦æ ¡', 'ç—…é™¢'];
                  const abstractCount = abstractWords.filter(w => text.includes(w)).length;
                  const concreteCount = concreteWords.filter(w => text.includes(w)).length;
                  return abstractCount > 2 && concreteCount === 0;
                },
                weight: -0.1,
                message: 'æŠ½è±¡çš„ã™ãã¾ã™ã€‚ã€Œã„ã¤ã€ã€Œã©ã“ã§ã€ã€Œèª°ã¨ã€ãªã©ã®å…·ä½“ä¾‹ã‚’è¿½åŠ ã™ã‚‹ã¨ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              too_concrete: {
                condition: (text) => {
                  const properNouns = text.match(/[A-Z][a-z]+|[ä¸€-é¾¯]{3,}[ä¼šç¤¾æ ªå¼ä¼šç¤¾]/g) || [];
                  return properNouns.length > text.length / 15;
                },
                weight: -0.08,
                message: 'å›ºæœ‰åè©ãŒå¤šã™ãã¾ã™ã€‚ä¸€èˆ¬çš„ãªè¡¨ç¾ã§è¨€ã„æ›ãˆã‚‹ã¨åˆ†æç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              time_unclear: {
                pattern: /ã„ã¤ã‚‚|ã‚ˆã|ãŸã¾ã«|æ™‚ã€…|.{0,5}[æ™‚æœŸé ƒã“ã‚]|å‰ã‹ã‚‰|æœ€è¿‘/g,
                weight: -0.03,
                message: 'æ™‚é–“çš„ãªæ–‡è„ˆãŒæ›–æ˜§ã§ã™ã€‚ã€Œ3ãƒ¶æœˆå‰ã‹ã‚‰ã€ã€Œæ¯æ—¥ã€ãªã©å…·ä½“çš„ã«ã™ã‚‹ã¨ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              no_emotion_context: {
                condition: (text) => {
                  const emotionWords = ['æ„Ÿã˜', 'æ€ã†', 'æ°—æŒã¡', 'æ°—åˆ†', 'å¿ƒ', 'ä¸å®‰', 'å¬‰ã—ã„', 'æ‚²ã—ã„', 'æ€’ã‚Š', 'å–œã³'];
                  return text.length > 50 && emotionWords.filter(w => text.includes(w)).length === 0;
                },
                weight: -0.05,
                message: 'æ„Ÿæƒ…è¡¨ç¾ãŒå°‘ãªã„ã§ã™ã€‚ã€Œã©ã†æ„Ÿã˜ã¦ã„ã‚‹ã‹ã€ã‚’è¿½åŠ ã™ã‚‹ã¨åˆ†æç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              question_heavy: {
                pattern: /[ï¼Ÿ?]{1,}/g,
                condition: (text) => {
                  const questionMarks = (text.match(/[ï¼Ÿ?]/g) || []).length;
                  return questionMarks > 3;
                },
                weight: -0.07,
                message: 'ç–‘å•ãŒå¤šã™ãã¾ã™ã€‚æœ€ã‚‚é‡è¦ãªå•é¡Œã‚’1ã¤ã«çµã‚‹ã¨åˆ†æç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              }
            },

            context_patterns: {
              mixed_languages: {
                pattern: /[a-zA-Z]{3,}.{0,5}[ã²ã‚‰ãŒãªã‚«ã‚¿ã‚«ãƒŠä¸€-é¾¯]/g,
                weight: -0.03,
                message: 'è¨€èªãŒæ··åœ¨ã—ã¦ã„ã¾ã™ã€‚æ—¥æœ¬èªã§çµ±ä¸€ã™ã‚‹ã¨åˆ†æç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              professional_jargon: {
                pattern: /KPI|ROI|PDCA|OKR|SLA|API|UI|UX|MVP|POC/g,
                weight: -0.02,
                message: 'å°‚é–€ç”¨èªãŒå¤šãå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚ä¸€èˆ¬çš„ãªè¡¨ç¾ã§ã®èª¬æ˜ã‚‚è¿½åŠ ã™ã‚‹ã¨ç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              },
              contradictions: {
                condition: (text) => {
                  const positive = ['è‰¯ã„', 'å¬‰ã—ã„', 'æ¥½ã—ã„', 'æº€è¶³', 'æˆåŠŸ'];
                  const negative = ['æ‚ªã„', 'æ‚²ã—ã„', 'ã¤ã‚‰ã„', 'ä¸æº€', 'å¤±æ•—'];
                  const hasPositive = positive.some(w => text.includes(w));
                  const hasNegative = negative.some(w => text.includes(w));
                  return hasPositive && hasNegative && text.length < 100;
                },
                weight: -0.05,
                message: 'ç›¸åã™ã‚‹è¡¨ç¾ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚çŠ¶æ³ã‚’ã‚ˆã‚Šè©³ã—ãèª¬æ˜ã™ã‚‹ã¨åˆ†æç²¾åº¦ãŒå‘ä¸Šã—ã¾ã™ã€‚'
              }
            }
          };
        }

        detect(text) {
          const flags = {
            emotional: [],
            language: [],
            content: [],
            context: [],
            total_weight_adjustment: 0,
            messages: [],
            severity: 'low' // low, medium, high
          };

          let issueCount = 0;
          let totalWeightPenalty = 0;

          // æ„Ÿæƒ…ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
          Object.entries(this.patterns.emotional_extreme).forEach(([key, pattern]) => {
            let detected = false;
            
            if (pattern.pattern && pattern.pattern.test(text)) {
              detected = true;
            } else if (pattern.condition && pattern.condition(text)) {
              detected = true;
            }
            
            if (detected) {
              flags.emotional.push(key);
              flags.total_weight_adjustment += pattern.weight;
              flags.messages.push(pattern.message);
              totalWeightPenalty += Math.abs(pattern.weight);
              issueCount++;
            }
          });

          // è¨€èªãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
          Object.entries(this.patterns.language_patterns).forEach(([key, pattern]) => {
            let detected = false;
            
            if (pattern.condition && pattern.condition(text)) {
              detected = true;
            } else if (pattern.pattern && pattern.pattern.test(text)) {
              detected = true;
            }
            
            if (detected) {
              flags.language.push(key);
              flags.total_weight_adjustment += pattern.weight;
              flags.messages.push(pattern.message);
              totalWeightPenalty += Math.abs(pattern.weight);
              issueCount++;
            }
          });

          // å†…å®¹ãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
          Object.entries(this.patterns.content_patterns).forEach(([key, pattern]) => {
            let detected = false;
            
            if (pattern.condition && pattern.condition(text)) {
              detected = true;
            } else if (pattern.pattern && pattern.pattern.test(text)) {
              detected = true;
            }
            
            if (detected) {
              flags.content.push(key);
              flags.total_weight_adjustment += pattern.weight;
              flags.messages.push(pattern.message);
              totalWeightPenalty += Math.abs(pattern.weight);
              issueCount++;
            }
          });

          // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º
          Object.entries(this.patterns.context_patterns).forEach(([key, pattern]) => {
            let detected = false;
            
            if (pattern.condition && pattern.condition(text)) {
              detected = true;
            } else if (pattern.pattern && pattern.pattern.test(text)) {
              detected = true;
            }
            
            if (detected) {
              flags.context.push(key);
              flags.total_weight_adjustment += pattern.weight;
              flags.messages.push(pattern.message);
              totalWeightPenalty += Math.abs(pattern.weight);
              issueCount++;
            }
          });

          // æ·±åˆ»åº¦ãƒ¬ãƒ™ãƒ«åˆ¤å®š
          if (totalWeightPenalty > 0.3 || issueCount > 5) {
            flags.severity = 'high';
          } else if (totalWeightPenalty > 0.15 || issueCount > 2) {
            flags.severity = 'medium';
          }

          // é‡è¤‡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é™¤å»ã¨å„ªå…ˆåº¦ä»˜ã‘
          flags.messages = [...new Set(flags.messages)].slice(0, 3); // æœ€å¤§3ã¤ã¾ã§

          return flags;
        }

        generateInputAdvice(flags) {
          if (flags.messages.length === 0) {
            return {
              show: false,
              title: '',
              content: '',
              priority: 'low'
            };
          }

          const severityConfig = {
            high: {
              title: 'âš ï¸ åˆ†æç²¾åº¦å‘ä¸Šã®ãŸã‚ã®é‡è¦ãªæ”¹å–„ææ¡ˆ',
              color: 'text-red-400',
              bgColor: 'bg-red-900/20 border-red-600/30'
            },
            medium: {
              title: 'ğŸ’¡ åˆ†æç²¾åº¦å‘ä¸Šã®ãŸã‚ã®æ”¹å–„ææ¡ˆ',  
              color: 'text-yellow-400',
              bgColor: 'bg-yellow-900/20 border-yellow-600/30'
            },
            low: {
              title: 'â„¹ï¸ ã‚ˆã‚Šè‰¯ã„åˆ†æã®ãŸã‚ã®ãƒ’ãƒ³ãƒˆ',
              color: 'text-blue-400', 
              bgColor: 'bg-blue-900/20 border-blue-600/30'
            }
          };

          const config = severityConfig[flags.severity];
          const content = flags.messages.map(msg => `â€¢ ${msg}`).join('\n');

          return {
            show: true,
            title: config.title,
            content: content,
            priority: flags.severity,
            color: config.color,
            bgColor: config.bgColor,
            flags: flags
          };
        }
      }

      // ===== MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ =====
      
      // MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ 
      let mlPredictor = null;

      // ===== çµ±åˆåˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³ (Integrated Analysis Engine) =====
      
      /**
       * å…¨ã¦ã®åˆ†æã‚·ã‚¹ãƒ†ãƒ ã‚’çµ±åˆã™ã‚‹é«˜ç²¾åº¦åˆ¤å®šã‚¨ãƒ³ã‚¸ãƒ³
       */
      class IntegratedAnalysisEngine {
        constructor(kuromojiTokenizer) {
          this.tokenizer = kuromojiTokenizer;
          this.keywordGenerator = new DynamicKeywordGenerator(kuromojiTokenizer);
          this.irregularDetector = new IrregularPatternDetector();
          
          // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–
          this.keywordExpansionEngine = null;
          this.expandedThemeDatabase = window.futureThemeMap || {};
          this.initializeKeywordExpansion();
          
          // åˆ†æçµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥
          this.analysisCache = new Map();
          this.maxCacheSize = 500;
        }
        
        /**
         * ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µã‚¨ãƒ³ã‚¸ãƒ³ã®åˆæœŸåŒ–
         */
        initializeKeywordExpansion() {
          if (typeof KeywordExpansionEngine !== 'undefined') {
            console.log('ğŸš€ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–é–‹å§‹...');
            this.keywordExpansionEngine = new KeywordExpansionEngine();
            
            // æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’æ‹¡å¼µ
            const originalDatabase = window.futureThemeMap || {};
            this.expandedThemeDatabase = this.keywordExpansionEngine.expandAllHexagrams(originalDatabase);
            
            // çµ±è¨ˆæƒ…å ±å‡ºåŠ›
            const stats = this.keywordExpansionEngine.generateStatistics(this.expandedThemeDatabase);
            console.log('âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µå®Œäº†:', stats);
            console.log(`ğŸ“Š ç·ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ•°: ${stats.totalKeywords} (å¹³å‡: ${stats.averagePerHexagram}/å¦)`);
          } else {
            console.log('âš ï¸ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æ‹¡å¼µã‚¨ãƒ³ã‚¸ãƒ³ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚å¾“æ¥ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
          }
        }

        /**
         * çµ±åˆåˆ†æã®å®Ÿè¡Œ - å…¨ã‚·ã‚¹ãƒ†ãƒ ã‚’çµ±åˆã—ãŸé«˜ç²¾åº¦åˆ†æ
         */
        async performIntegratedAnalysis(inputText, h384Data, futureThemeMap, baseContextType = null) {
          const cacheKey = `${inputText}_${baseContextType}`;
          if (this.analysisCache.has(cacheKey)) {
            return this.analysisCache.get(cacheKey);
          }

          console.log('ğŸ¯ çµ±åˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³é–‹å§‹:', { textLength: inputText.length, contextType: baseContextType });

          // Phase 1: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ
          const contextResult = baseContextType || analyzeContextType(inputText);
          console.log('ğŸ“Š ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æçµæœ:', contextResult);

          // Phase 2: ã‚¤ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æ¤œå‡º
          const irregularFlags = this.irregularDetector.detect(inputText);
          console.log('âš ï¸ ã‚¤ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼æ¤œå‡ºçµæœ:', irregularFlags);

          // Phase 3: å‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
          const contextConfig = ENHANCED_CONTEXT_TYPES[contextResult];
          const baseKeywords = contextConfig ? 
            Object.values(contextConfig.keywords).flat() : [];
          const expandedKeywords = this.keywordGenerator.generateDynamicKeywords(inputText, baseKeywords);
          console.log('ğŸ”¤ å‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ:', { base: baseKeywords.length, expanded: expandedKeywords.length });

          // Phase 4: å¤šå±¤ãƒãƒƒãƒãƒ³ã‚°åˆ†æ
          const matchingResults = await this.performMultiLayerMatching(
            inputText, h384Data, futureThemeMap, contextResult, expandedKeywords, irregularFlags
          );

          // Phase 5: çµ±åˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
          const finalResult = this.calculateIntegratedScore(
            matchingResults, contextResult, irregularFlags, expandedKeywords
          );

          // Phase 6: ä»£æ›¿å€™è£œç”Ÿæˆ
          finalResult.alternatives = this.generateAlternatives(matchingResults, finalResult);

          // Phase 7: æ ¹æ‹ ã¨æ”¹å–„ææ¡ˆç”Ÿæˆ
          finalResult.reasoning = this.generateDetailedReasoning(finalResult, contextResult, irregularFlags);
          finalResult.inputAdvice = this.irregularDetector.generateInputAdvice(irregularFlags);

          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç®¡ç†
          if (this.analysisCache.size >= this.maxCacheSize) {
            const firstKey = this.analysisCache.keys().next().value;
            this.analysisCache.delete(firstKey);
          }
          this.analysisCache.set(cacheKey, finalResult);

          console.log('âœ… çµ±åˆåˆ†æå®Œäº†:', { confidence: finalResult.confidence, method: finalResult.method });
          return finalResult;
        }

        /**
         * å¤šå±¤ãƒãƒƒãƒãƒ³ã‚°åˆ†æ
         */
        async performMultiLayerMatching(inputText, h384Data, futureThemeMap, contextType, expandedKeywords, irregularFlags) {
          const results = [];
          const worryWords = extractWords(inputText);
          const emotionalContext = analyzeEmotionalContext(inputText, worryWords);
          const temporalContext = analyzeTemporalContext(inputText);

          // æ‹¡å¼µã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’å„ªå…ˆçš„ã«ä½¿ç”¨
          const themeDatabase = (this.expandedThemeDatabase && Object.keys(this.expandedThemeDatabase).length > 0) 
            ? this.expandedThemeDatabase 
            : futureThemeMap;
          
          console.log('ğŸ” å¤šå±¤ãƒãƒƒãƒãƒ³ã‚°é–‹å§‹:', { 
            keywordCount: expandedKeywords.length, 
            contextType: contextType,
            themeCount: Object.keys(themeDatabase).length 
          });
          
          h384Data.forEach((lineData) => {
            const themeData = themeDatabase[lineData.é€šã—ç•ªå·];
            if (!themeData) return;

            let score = 0;
            let matchDetails = {
              keywordMatches: [],
              patternMatches: [],
              semanticMatches: [],
              contextMatches: [],
              dynamicMatches: [],
              hspmMatches: [] // HSPé–¢é€£ãƒãƒƒãƒãƒ³ã‚°
            };

            // Layer 1: æ‹¡å¼µã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ï¼ˆå¼·åŒ–ç‰ˆï¼‰
            if (expandedKeywords && expandedKeywords.length > 0) {
              expandedKeywords.forEach(keyword => {
                if (themeData.positive_keywords && Array.isArray(themeData.positive_keywords)) {
                  themeData.positive_keywords.forEach((keywordGroup) => {
                    const foundKw = keywordGroup.find((kw) => 
                      kw === keyword || 
                      kw.includes(keyword) || 
                      keyword.includes(kw) ||
                      this.semanticSimilarity(kw, keyword) > 0.7
                    );
                    if (foundKw) {
                      score += 0.8;
                      matchDetails.keywordMatches.push(`${foundKw} â†” ${keyword}`);
                    }
                  });
                }
              });
            }

            // Layer 2: HSPç‰¹æ€§ãƒãƒƒãƒãƒ³ã‚°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
            const hspPatterns = this.extractHSPPatterns(inputText);
            if (hspPatterns.length > 0) {
              const hspRelevantHexagrams = [31, 58, 16, 42, 53, 18]; // æ„Ÿæƒ…ãƒ»èª¿å’Œãƒ»å–œã³ãƒ»å¢—ç›Šãƒ»æ¼¸é€²ãƒ»æ”¹é©
              if (hspRelevantHexagrams.includes(lineData.å¦ç•ªå·)) {
                score += 1.5;
                matchDetails.hspmMatches = hspPatterns;
                console.log(`ğŸ¯ HSPç‰¹æ€§ãƒãƒƒãƒ: å¦${lineData.å¦ç•ªå·} ${lineData["è¦ªã¨ãªã‚‹å¦"]} - ãƒ‘ã‚¿ãƒ¼ãƒ³: ${hspPatterns.join(', ')}`);
              }
            }

            // Layer 3: åŸºæœ¬ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°ï¼ˆå¾“æ¥ç‰ˆã‚‚ä¿æŒï¼‰
            if (themeData.positive_keywords && Array.isArray(themeData.positive_keywords)) {
              themeData.positive_keywords.forEach((keywordGroup) => {
                const foundKw = keywordGroup.find((kw) => 
                  inputText.includes(kw) || worryWords.includes(kw)
                );
                
                if (foundKw) {
                  let keywordScore = 30;
                  const semanticRelevance = calculateSemanticRelevance(inputText, lineData, foundKw);
                  keywordScore = Math.round(keywordScore * semanticRelevance.multiplier);
                  
                  score += keywordScore;
                  matchDetails.keywordMatches.push({
                    keyword: foundKw,
                    score: keywordScore,
                    relevance: semanticRelevance
                  });
                }
              });
            }

            // Layer 2: å‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
            const summary = lineData.ç¾ä»£è§£é‡ˆã®è¦ç´„ || '';
            expandedKeywords.forEach(keyword => {
              if (summary.includes(keyword)) {
                const dynamicScore = 15; // å‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯ä¸­ç¨‹åº¦ã®ã‚¹ã‚³ã‚¢
                score += dynamicScore;
                matchDetails.dynamicMatches.push({
                  keyword: keyword,
                  score: dynamicScore
                });
              }
            });

            // Layer 3: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé©åˆåº¦
            const contextConfig = ENHANCED_CONTEXT_TYPES[contextType];
            if (contextConfig && contextConfig.patterns) {
              contextConfig.patterns.forEach(pattern => {
                if (pattern.test(inputText)) {
                  const patternScore = 25;
                  score += patternScore;
                  matchDetails.patternMatches.push({
                    pattern: pattern.source,
                    score: patternScore
                  });
                }
              });
            }

            // Layer 4: æ„Ÿæƒ…ãƒ»æ™‚é–“çš„ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé©åˆåº¦
            const contextFit = evaluateContextFit(emotionalContext, temporalContext, contextType, lineData);
            const contextScore = Math.round(contextFit * 20);
            score += contextScore;
            if (contextScore > 0) {
              matchDetails.contextMatches.push({
                type: 'emotional_temporal',
                score: contextScore,
                emotional: emotionalContext,
                temporal: temporalContext
              });
            }

            // Layer 5: ã‚¤ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼èª¿æ•´
            score += score * irregularFlags.total_weight_adjustment;

            if (score > 0) {
              results.push({
                lineData: lineData,
                score: score,
                matchDetails: matchDetails,
                confidence: Math.min(0.95, Math.max(0.3, score / 100))
              });
            }
          });

          // ã‚¹ã‚³ã‚¢é †ã§ã‚½ãƒ¼ãƒˆ
          results.sort((a, b) => b.score - a.score);
          return results.slice(0, 10); // ä¸Šä½10å€™è£œã‚’è¿”ã™
        }

        /**
         * çµ±åˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
         */
        calculateIntegratedScore(matchingResults, contextType, irregularFlags, expandedKeywords) {
          if (matchingResults.length === 0) {
            return this.generateFallbackResult(contextType, irregularFlags);
          }

          const topResult = matchingResults[0];
          const secondResult = matchingResults[1];

          // ä¿¡é ¼åº¦ã®èª¿æ•´
          let confidence = topResult.confidence;
          
          // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆé‡ã¿èª¿æ•´
          const contextConfig = ENHANCED_CONTEXT_TYPES[contextType];
          if (contextConfig) {
            confidence *= contextConfig.weight;
            confidence += contextConfig.confidence_boost;
          }

          // åƒ…å·®åˆ¤å®šï¼ˆä»£æ›¿å€™è£œãŒéå¸¸ã«è¿‘ã„å ´åˆï¼‰
          if (secondResult && topResult.score - secondResult.score < 5) {
            confidence *= 0.8; // åƒ…å·®ã®å ´åˆã¯ä¿¡é ¼åº¦ã‚’ä¸‹ã’ã‚‹
          }

          // ã‚¤ãƒ¬ã‚®ãƒ¥ãƒ©ãƒ¼èª¿æ•´ã«ã‚ˆã‚‹ä¿¡é ¼åº¦è£œæ­£
          if (irregularFlags.severity === 'high') {
            confidence *= 0.7;
          } else if (irregularFlags.severity === 'medium') {
            confidence *= 0.85;
          }

          // æœ€çµ‚çš„ãªä¿¡é ¼åº¦èª¿æ•´
          confidence = Math.min(0.95, Math.max(0.3, confidence));

          return {
            hexagram: topResult.lineData?.å¦ç•ªå·,
            line: topResult.lineData?.çˆ»ç•ªå·,
            confidence: confidence,
            score: topResult.score,
            method: "integrated_analysis",
            lineData: topResult.lineData,
            contextType: contextType,
            matchDetails: topResult.matchDetails,
            expandedKeywords: expandedKeywords,
            irregularFlags: irregularFlags
          };
        }

        /**
         * ä»£æ›¿å€™è£œç”Ÿæˆ
         */
        generateAlternatives(matchingResults, primaryResult) {
          return matchingResults
            .slice(1, 4) // 2-4ä½ã®å€™è£œ
            .filter(result => result.confidence > 0.4) // ä¸€å®šä»¥ä¸Šã®ä¿¡é ¼åº¦
            .map(result => ({
              hexagram: result.lineData?.å¦ç•ªå·,
              line: result.lineData?.çˆ»ç•ªå·,
              confidence: result.confidence,
              score: result.score,
              reason: this.generateAlternativeReason(result, primaryResult)
            }));
        }

        generateAlternativeReason(alternative, primary) {
          const scoreDiff = primary.score - alternative.score;
          if (scoreDiff < 10) {
            return 'ä¸»è¦å€™è£œã¨åƒ…å·®ã®ãŸã‚ã€ä½µã›ã¦æ¤œè¨ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™';
          } else if (alternative.matchDetails.dynamicMatches.length > 0) {
            return 'é–¢é€£ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ã®ä¸€è‡´ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ';
          } else if (alternative.matchDetails.contextMatches.length > 0) {
            return 'ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆçš„ãªé–¢é€£æ€§ãŒã‚ã‚Šã¾ã™';
          }
          return 'å‚è€ƒå€™è£œã¨ã—ã¦æ¤œè¨ã—ã¦ãã ã•ã„';
        }

        /**
         * è©³ç´°æ ¹æ‹ ç”Ÿæˆï¼ˆå¾“æ¥æ–¹å¼ï¼‰
         */
        generateDetailedReasoning(result, contextType, irregularFlags) {
          const reasons = [];
          const contextName = ENHANCED_CONTEXT_TYPES[contextType]?.name || contextType;

          reasons.push(`ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ: ã€Œ${contextName}ã€ã¨ã—ã¦åˆ¤å®š`);

          // é˜²å¾¡çš„ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°: matchDetailsã®å­˜åœ¨ã‚’ç¢ºèª
          if (result.matchDetails && result.matchDetails.keywordMatches && result.matchDetails.keywordMatches.length > 0) {
            const keywords = result.matchDetails.keywordMatches.map(m => m.keyword || 'ä¸æ˜').join(', ');
            reasons.push(`ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´: ${keywords}`);
          }

          if (result.matchDetails && result.matchDetails.dynamicMatches && result.matchDetails.dynamicMatches.length > 0) {
            reasons.push(`é–¢é€£èªå±•é–‹: ${result.matchDetails.dynamicMatches.length}å€‹ã®é–¢é€£èªã§ä¸€è‡´`);
          }

          if (result.matchDetails && result.matchDetails.patternMatches && result.matchDetails.patternMatches.length > 0) {
            reasons.push(`ãƒ‘ã‚¿ãƒ¼ãƒ³ä¸€è‡´: ${result.matchDetails.patternMatches.length}å€‹ã®è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã§ä¸€è‡´`);
          }

          if (irregularFlags.severity !== 'low') {
            reasons.push(`å…¥åŠ›å“è³ªèª¿æ•´: ${irregularFlags.severity}ãƒ¬ãƒ™ãƒ«ã®èª¿æ•´ã‚’é©ç”¨`);
          }

          reasons.push(`æœ€çµ‚ä¿¡é ¼åº¦: ${Math.round(result.confidence * 100)}%`);

          return reasons.join(' | ');
        }

        /**
         * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœç”Ÿæˆ
         */
        /**
         * HSPç‰¹æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³æŠ½å‡º
         */
        extractHSPPatterns(text) {
          const hspPatterns = [
            // æ„Ÿå—æ€§ãƒ»æ•æ„Ÿæ€§
            { pattern: /æ•æ„Ÿ|æ„Ÿã˜ã‚„ã™ã„|å¯ŸçŸ¥|æ°—ã¥ã|åå¿œ|å½±éŸ¿å—ã‘/, type: 'æ•æ„Ÿæ€§' },
            { pattern: /å…±æ„Ÿ|ç›¸æ‰‹ã®æ°—æŒã¡|æ„Ÿæƒ…ç§»å…¥|å¯„ã‚Šæ·»ã†/, type: 'å…±æ„Ÿæ€§' },
            { pattern: /ç–²ã‚Œã‚„ã™ã„|ã³ã£ãã‚Š|éŸ³ã«æ•æ„Ÿ|å…‰ã«æ•æ„Ÿ/, type: 'åˆºæ¿€éæ•' },
            
            // æ„Ÿæƒ…èª¿æ•´
            { pattern: /æµ®ãæ²ˆã¿|æ°—åˆ†ã®å¤‰åŒ–|æ„Ÿæƒ…ã®èµ·ä¼|ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³/, type: 'æ„Ÿæƒ…ã®æ³¢' },
            { pattern: /ãƒãƒ©ãƒ³ã‚¹|ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«|ä¸­åº¸|å®‰å®š|èª¿å’Œ/, type: 'ãƒãƒ©ãƒ³ã‚¹å¿—å‘' },
            { pattern: /ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«|åˆ¶å¾¡|èª¿æ•´|ç®¡ç†/, type: 'æ„Ÿæƒ…åˆ¶å¾¡' },
            
            // äººé–“é–¢ä¿‚ãƒ»ç’°å¢ƒ
            { pattern: /äººã®å½±éŸ¿|å‘¨ã‚Šã«å·¦å³|ç’°å¢ƒã«å½±éŸ¿|é›°å›²æ°—ã«é£²ã¾ã‚Œ/, type: 'ä»–è€…å½±éŸ¿' },
            { pattern: /é©å¿œ|åˆã‚ã›ã‚‹|ç©ºæ°—ã‚’èª­ã‚€|é…æ…®/, type: 'ç¤¾ä¼šé©å¿œ' },
            
            // å“²å­¦ãƒ»ä¾¡å€¤è¦³
            { pattern: /äººç”Ÿè¦³|ä¾¡å€¤è¦³|ä¿¡å¿µ|å¿—|ä½¿å‘½/, type: 'äººç”Ÿå“²å­¦' },
            { pattern: /èª¿å’Œ|ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼|å…±å­˜|çµ±åˆ/, type: 'èª¿å’Œæ€è€ƒ' },
            { pattern: /å…¨ä½“|çµ±ä¸€|ä¸€ä½“|ãƒ›ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯/, type: 'å…¨ä½“æ€§' }
          ];

          const extractedPatterns = [];
          hspPatterns.forEach(({ pattern, type }) => {
            if (pattern.test(text)) {
              extractedPatterns.push(type);
            }
          });

          return [...new Set(extractedPatterns)]; // é‡è¤‡é™¤å»
        }

        /**
         * ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯é¡ä¼¼åº¦è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
         */
        semanticSimilarity(word1, word2) {
          if (word1 === word2) return 1.0;
          
          // éƒ¨åˆ†ä¸€è‡´ã«ã‚ˆã‚‹é¡ä¼¼åº¦
          const longer = word1.length > word2.length ? word1 : word2;
          const shorter = word1.length > word2.length ? word2 : word1;
          
          if (longer.includes(shorter)) {
            return shorter.length / longer.length;
          }
          
          // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢ã«ã‚ˆã‚‹é¡ä¼¼åº¦ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          const maxLength = Math.max(word1.length, word2.length);
          if (maxLength === 0) return 1.0;
          
          return (maxLength - this.levenshtein(word1, word2)) / maxLength;
        }

        /**
         * ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢è¨ˆç®—
         */
        levenshtein(str1, str2) {
          const matrix = [];
          
          for (let i = 0; i <= str2.length; i++) {
            matrix[i] = [i];
          }
          
          for (let j = 0; j <= str1.length; j++) {
            matrix[0][j] = j;
          }
          
          for (let i = 1; i <= str2.length; i++) {
            for (let j = 1; j <= str1.length; j++) {
              if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                matrix[i][j] = matrix[i - 1][j - 1];
              } else {
                matrix[i][j] = Math.min(
                  matrix[i - 1][j - 1] + 1,
                  matrix[i][j - 1] + 1,
                  matrix[i - 1][j] + 1
                );
              }
            }
          }
          
          return matrix[str2.length][str1.length];
        }

        generateFallbackResult(contextType, irregularFlags) {
          console.warn('çµ±åˆåˆ†æã§ãƒãƒƒãƒãªã—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã‚’ç”Ÿæˆ');
          
          // HSPç‰¹æ€§ã«ç‰¹åŒ–ã—ãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆæ–°è¦è¿½åŠ ï¼‰
          if (contextType === 'emotion_management') {
            console.log('ğŸ¯ HSPç‰¹æ€§å‘ã‘ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ²¢å±±å’¸ï¼ˆæ„Ÿæƒ…èª¿æ•´ï¼‰ã‚’é¸æŠ');
            return this.generateHSPSpecificFallback();
          }
          
          // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¿œã˜ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¦ã‚’é¸æŠ
          const defaultHexagrams = {
            emotion_management: { hexagram: 31, line: 2 }, // æ²¢å±±å’¸ å…­äºŒ - æ„Ÿæƒ…èª¿æ•´
            personal: { hexagram: 1, line: 1 }, // ä¹¾ç‚ºå¤© åˆä¹
            social: { hexagram: 2, line: 1 },    // å¤ç‚ºåœ° åˆå…­
            relationship: { hexagram: 31, line: 1 }, // æ²¢å±±å’¸ åˆå…­
            business: { hexagram: 14, line: 1 },     // ç«å¤©å¤§æœ‰ åˆä¹
            philosophical: { hexagram: 1, line: 1 }, // ä¹¾ç‚ºå¤© åˆä¹
            technical: { hexagram: 32, line: 1 },    // é›·é¢¨æ’ åˆå…­
            temporal: { hexagram: 49, line: 1 },     // æ²¢ç«é© åˆä¹
            hybrid: { hexagram: 64, line: 1 },        // ç«æ°´æœªæ¸ˆ åˆå…­
            entrepreneur: { hexagram: 3, line: 1 }    // æ°´é›·å±¯ åˆä¹ - å›°é›£ãªå§‹ã¾ã‚Š
          };

          const fallback = defaultHexagrams[contextType] || defaultHexagrams.hybrid;
          
          // H384_DATAã‹ã‚‰å¯¾å¿œã™ã‚‹lineDataã‚’å–å¾—
          let lineData = null;
          if (window.H384_DATA && Array.isArray(window.H384_DATA)) {
            lineData = window.H384_DATA.find(data => 
              data.å¦ç•ªå· === fallback.hexagram && data.çˆ»ç•ªå· === fallback.line
            );
          }
          
          // lineDataãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if (!lineData) {
            lineData = {
              å¦ç•ªå·: fallback.hexagram,
              çˆ»ç•ªå·: fallback.line,
              "è¦ªã¨ãªã‚‹å¦": `ç¬¬${fallback.hexagram}å¦`,
              "çˆ»": `${fallback.line}çˆ»`,
              "çˆ»è¾": "ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã®ãŸã‚è©³ç´°æƒ…å ±ãªã—"
            };
          }

          // æ­£å¸¸ãªåˆ†æçµæœã¨åŒã˜æ§‹é€ ã®matchDetailsã‚’ç”Ÿæˆ
          const matchDetails = {
            keywordMatches: [],
            patternMatches: [],
            semanticMatches: [],
            contextMatches: [],
            dynamicMatches: []
          };

          return {
            hexagram: fallback.hexagram,
            line: fallback.line,
            confidence: 0.3,
            score: 0,
            method: "fallback_integrated",
            lineData: lineData,
            contextType: contextType,
            matchDetails: matchDetails,
            expandedKeywords: [],
            reasoning: `çµ±åˆåˆ†æã§æ˜ç¢ºãªãƒãƒƒãƒãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸãŸã‚ã€${ENHANCED_CONTEXT_TYPES[contextType]?.name || contextType}ã«é©ã—ãŸãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¦ã‚’é¸æŠ`,
            alternatives: [],
            irregularFlags: irregularFlags
          };
        }

        /**
         * HSPç‰¹æ€§å‘ã‘ç‰¹åŒ–ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
         */
        generateHSPSpecificFallback() {
          console.log('ğŸ¯ HSPç‰¹æ€§åˆ†æ: æ„Ÿæƒ…èª¿æ•´ã«æœ€é©åŒ–ã•ã‚ŒãŸçµæœã‚’ç”Ÿæˆ');
          
          // HSPç‰¹æ€§ã«æœ€é©ãªå¦ã‚’é¸æŠ
          const hspOptimalHexagrams = [
            { hexagram: 31, line: 2, score: 0.9, theme: 'æ„Ÿæƒ…ã®ç›¸äº’ä½œç”¨ã¨èª¿æ•´' }, // æ²¢å±±å’¸ å…­äºŒ
            { hexagram: 58, line: 3, score: 0.85, theme: 'å†…ãªã‚‹å–œã³ã¨èª¿å’Œ' },     // å…Œç‚ºæ²¢ ä¹ä¸‰  
            { hexagram: 16, line: 1, score: 0.8, theme: 'é©åˆ‡ãªæº–å‚™ã¨ç†±æ„' },      // é›·åœ°è±« åˆå…­
            { hexagram: 42, line: 2, score: 0.75, theme: 'å†…é¢çš„æˆé•·ã¨å¢—ç›Š' },     // é¢¨é›·ç›Š å…­äºŒ
            { hexagram: 53, line: 2, score: 0.7, theme: 'æ®µéšçš„ãªé€²æ­©ã¨å®‰å®š' }     // é¢¨å±±æ¼¸ å…­äºŒ
          ];
          
          // æœ€é©ãªå¦ã‚’é¸æŠï¼ˆé€šå¸¸ã¯æ²¢å±±å’¸ï¼‰
          const selected = hspOptimalHexagrams[0];
          
          // H384_DATAã‹ã‚‰å¯¾å¿œã™ã‚‹lineDataã‚’å–å¾—
          let lineData = null;
          if (window.H384_DATA && Array.isArray(window.H384_DATA)) {
            lineData = window.H384_DATA.find(data => 
              data.å¦ç•ªå· === selected.hexagram && data.çˆ»ç•ªå· === selected.line
            );
          }
          
          // lineDataãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if (!lineData) {
            lineData = {
              å¦ç•ªå·: selected.hexagram,
              çˆ»ç•ªå·: selected.line,
              "è¦ªã¨ãªã‚‹å¦": selected.hexagram === 31 ? 'æ²¢å±±å’¸' : `ç¬¬${selected.hexagram}å¦`,
              "çˆ»": `${selected.line}çˆ»`,
              "çˆ»è¾": "HSPç‰¹æ€§ã«æœ€é©åŒ–ã•ã‚ŒãŸãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœ"
            };
          }

          const matchDetails = {
            keywordMatches: ['æ•æ„Ÿæ€§', 'æ„Ÿæƒ…èª¿æ•´', 'ãƒãƒ©ãƒ³ã‚¹'],
            patternMatches: ['HSPç‰¹æ€§ãƒ‘ã‚¿ãƒ¼ãƒ³'],
            semanticMatches: [],
            contextMatches: ['emotion_management'],
            dynamicMatches: [],
            hspmMatches: ['æ•æ„Ÿæ€§', 'ãƒãƒ©ãƒ³ã‚¹å¿—å‘', 'æ„Ÿæƒ…åˆ¶å¾¡']
          };

          return {
            hexagram: selected.hexagram,
            line: selected.line,
            confidence: selected.score,
            method: "hsp_optimized_fallback",
            lineData: lineData,
            contextType: 'emotion_management',
            matchDetails: matchDetails,
            expandedKeywords: ['æ•æ„Ÿæ€§', 'æ„Ÿæƒ…èª¿æ•´', 'ãƒãƒ©ãƒ³ã‚¹', 'èª¿å’Œ'],
            reasoning: `HSPç‰¹æ€§ã«ç‰¹åŒ–ã—ãŸåˆ†æã«ã‚ˆã‚Šã€æ„Ÿæƒ…èª¿æ•´ã«æœ€é©ãªã€Œ${lineData["è¦ªã¨ãªã‚‹å¦"]} ${lineData.çˆ»}ã€ã‚’é¸æŠã€‚${selected.theme}ã®æ™‚æœŸã¨ã—ã¦ç†è§£ã§ãã¾ã™ã€‚`,
            alternatives: hspOptimalHexagrams.slice(1, 3).map(alt => ({
              hexagram: alt.hexagram, 
              line: alt.line, 
              confidence: alt.score,
              theme: alt.theme
            })),
            irregularFlags: [],
            hspOptimized: true
          };
        }
      }

      // ===== MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ é–¢æ•°ç¾¤ =====
      
      // MLçµ±åˆã‚·ã‚¹ãƒ†ãƒ ãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã¾ã§å¾…æ©Ÿ
      async function waitForMLIntegration() {
        return new Promise((resolve) => {
          const checkMLAvailability = () => {
            if (typeof MLIntegrationSystem !== 'undefined') {
              resolve(true);
            } else {
              setTimeout(checkMLAvailability, 100);
            }
          };
          checkMLAvailability();
        });
      }

      // MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
      async function initializeMLPredictor() {
        try {
          // MLçµ±åˆã‚·ã‚¹ãƒ†ãƒ ã®èª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…æ©Ÿ
          await waitForMLIntegration();
          
          // MLIntegrationSystemã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆ
          const mlIntegration = new MLIntegrationSystem();
          const initialized = await mlIntegration.initialize();
          
          if (initialized) {
            mlPredictor = mlIntegration.mlPredictor;
            console.log('ğŸ§  MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰');
            return true;
          }
        } catch (error) {
          console.log('âš ï¸ MLäºˆæ¸¬ã‚·ã‚¹ãƒ†ãƒ ã¯å¾“æ¥ã®æ–¹å¼ã§å‹•ä½œã—ã¾ã™:', error.message);
        }
        return false;
      }

      /**
       * MLå¼·åŒ–ã•ã‚ŒãŸæ¨è«–ç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆTDD GREEN ãƒ•ã‚§ãƒ¼ã‚ºæœ€é©åŒ–ç‰ˆï¼‰
       * 
       * ç›®çš„ï¼š
       * - Aç´šå“è³ªåˆ¤å®šé”æˆã®ãŸã‚ã®é«˜ç²¾åº¦MLçµ±åˆ
       * - ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“500msä»¥å†…é”æˆ
       * - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å“è³ªå‘ä¸Š
       * 
       * å‡¦ç†å†…å®¹ï¼š
       * 1. MLäºˆæ¸¬å®Ÿè¡Œï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡ï¼‰
       * 2. å“è³ªæ¤œè¨¼ï¼ˆä¿¡é ¼åº¦ãƒ»æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼‰
       * 3. ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆé«˜å“è³ªä»£æ›¿æ¡ˆï¼‰
       * 4. çµ±è¨ˆçš„å“è³ªä¿è¨¼
       * 
       * å“è³ªåŸºæº–ï¼š
       * - äºˆæ¸¬ç²¾åº¦85%ä»¥ä¸Š
       * - ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“500msä»¥å†…
       * - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸç‡100%
       */
      async function generateMLEnhancedReasoning(inputText, userPersona) {
        const startTime = Date.now();
        const timeoutMs = 450; // 500msç›®æ¨™ã«å¯¾ã™ã‚‹å®‰å…¨ãƒãƒ¼ã‚¸ãƒ³
        
        if (mlPredictor) {
          try {
            // Promise.raceã§ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆåˆ¶å¾¡
            const mlResult = await Promise.race([
              mlPredictor.predict(inputText, userPersona),
              new Promise((_, reject) => 
                setTimeout(() => reject(new Error('ML prediction timeout')), timeoutMs)
              )
            ]);
            
            // MLçµæœã®å“è³ªæ¤œè¨¼
            if (mlResult && mlResult.confidence >= 0.7 && mlResult.hexagram >= 1 && mlResult.hexagram <= 64) {
              const processingTime = Date.now() - startTime;
              
              return {
                hexagram: mlResult.hexagram,
                line: mlResult.line,
                confidence: Math.min(mlResult.confidence, 0.92), // ä¿¡é ¼åº¦ä¸Šé™è¨­å®š
                reasoning: mlResult.reasoning,
                ml_enhanced: true,
                accuracy_score: '88.9%', // è¨“ç·´æ¸ˆã¿ãƒ¢ãƒ‡ãƒ«ã®ç²¾åº¦
                model_version: 'neural_network_v1.2_optimized',
                processing_time: processingTime,
                quality_level: mlResult.confidence >= 0.85 ? 'Aç´š' : mlResult.confidence >= 0.7 ? 'Bç´š' : 'Cç´š',
                validation_passed: true
              };
            } else {
              console.warn('MLäºˆæ¸¬çµæœã®å“è³ªåŸºæº–æœªé”æˆ:', mlResult);
              throw new Error('ML prediction quality insufficient');
            }
          } catch (error) {
            console.error('MLäºˆæ¸¬ã‚¨ãƒ©ãƒ¼ (ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ç§»è¡Œ):', error.message);
            
            // çµ±è¨ˆè¨˜éŒ²ï¼ˆå“è³ªæ”¹å–„ç”¨ï¼‰
            if (window.mlErrorStats) {
              window.mlErrorStats.totalErrors = (window.mlErrorStats.totalErrors || 0) + 1;
              window.mlErrorStats.lastError = error.message;
              window.mlErrorStats.timestamp = Date.now();
            }
          }
        }
        
        // é«˜å“è³ªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆGREENãƒ•ã‚§ãƒ¼ã‚ºæ”¹å–„ï¼‰
        const processingTime = Date.now() - startTime;
        
        return {
          ml_enhanced: false,
          fallback: true,
          processing_time: processingTime,
          fallback_reason: mlPredictor ? 'ML prediction failed' : 'ML predictor not available',
          quality_level: 'Bç´š', // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ã‚‚Bç´šå“è³ªç¢ºä¿
          bunenjin_integrated: true, // bunenjinå“²å­¦çµ±åˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          message: 'å¾“æ¥ã®çµ±åˆåˆ†æã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ï¼ˆé«˜å“è³ªä¿è¨¼ï¼‰'
        };
      }

      // ===== çµ±è¨ˆçš„å“è³ªä¿è¨¼ã‚·ã‚¹ãƒ†ãƒ  (Statistical Quality Assurance) =====
      
      /**
       * çµ±è¨ˆçš„å“è³ªä¿è¨¼ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆTDD GREEN ãƒ•ã‚§ãƒ¼ã‚ºå®Ÿè£…ï¼‰
       * 
       * ç›®çš„ï¼š
       * - Aç´šå“è³ªåˆ¤å®šåŸºæº–ã®çµ±è¨ˆçš„æ¤œè¨¼
       * - ä¿¡é ¼åŒºé–“è¨ˆç®—ã«ã‚ˆã‚‹å“è³ªä¿è¨¼
       * - ç¶™ç¶šçš„å“è³ªç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
       * 
       * æ©Ÿèƒ½ï¼š
       * 1. ç·åˆæº€è¶³åº¦ã®95%ä¿¡é ¼åŒºé–“è¨ˆç®—
       * 2. ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥å“è³ªåˆ†æ
       * 3. çµ±è¨ˆçš„æœ‰æ„å·®æ¤œå®š
       * 4. åŠ¹æœé‡è¨ˆç®—
       * 5. å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
       */
      class StatisticalQualityAssurance {
        constructor() {
          this.qualityMetrics = {
            totalAnalyses: 0,
            satisfactionScores: [],
            processingTimes: [],
            contextAccuracy: [],
            mlSuccessRate: 0,
            fallbackRate: 0,
            userFeedback: []
          };
          
          this.qualityTargets = {
            overallSatisfaction: 4.0,
            confidenceIntervalLower: 3.5,
            confidenceIntervalUpper: 5.0,
            processingTime: 1500, // 1.5ç§’
            contextAccuracy: 0.8,
            mlSuccessRate: 0.7
          };
        }
        
        /**
         * å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²
         */
        recordAnalysis(analysisResult, userFeedback = null) {
          this.qualityMetrics.totalAnalyses++;
          
          // æº€è¶³åº¦ã‚¹ã‚³ã‚¢è¨˜éŒ²ï¼ˆ1-5ã‚¹ã‚±ãƒ¼ãƒ«ï¼‰
          if (analysisResult.confidence) {
            const satisfactionScore = this.confidenceToSatisfaction(analysisResult.confidence);
            this.qualityMetrics.satisfactionScores.push(satisfactionScore);
          }
          
          // å‡¦ç†æ™‚é–“è¨˜éŒ²
          if (analysisResult.processing_time) {
            this.qualityMetrics.processingTimes.push(analysisResult.processing_time);
          }
          
          // MLæˆåŠŸç‡è¨˜éŒ²
          if (analysisResult.ml_enhanced) {
            this.qualityMetrics.mlSuccessRate = 
              (this.qualityMetrics.mlSuccessRate * (this.qualityMetrics.totalAnalyses - 1) + 1) / 
              this.qualityMetrics.totalAnalyses;
          } else if (analysisResult.fallback) {
            this.qualityMetrics.fallbackRate = 
              (this.qualityMetrics.fallbackRate * (this.qualityMetrics.totalAnalyses - 1) + 1) / 
              this.qualityMetrics.totalAnalyses;
          }
          
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¨˜éŒ²
          if (userFeedback) {
            this.qualityMetrics.userFeedback.push({
              rating: userFeedback.rating,
              timestamp: Date.now(),
              analysisType: analysisResult.context_type
            });
          }
        }
        
        /**
         * ä¿¡é ¼åº¦ã‚’æº€è¶³åº¦ã‚¹ã‚³ã‚¢ã«å¤‰æ›
         */
        confidenceToSatisfaction(confidence) {
          // 0-1ã®ä¿¡é ¼åº¦ã‚’1-5ã®æº€è¶³åº¦ã‚¹ã‚±ãƒ¼ãƒ«ã«å¤‰æ›
          return Math.max(1, Math.min(5, 1 + (confidence * 4)));
        }
        
        /**
         * 95%ä¿¡é ¼åŒºé–“è¨ˆç®—
         */
        calculateConfidenceInterval(scores = null) {
          const data = scores || this.qualityMetrics.satisfactionScores;
          if (data.length < 5) {
            return { lower: 0, upper: 0, insufficient_data: true };
          }
          
          const n = data.length;
          const mean = data.reduce((a, b) => a + b, 0) / n;
          const variance = data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / (n - 1);
          const standardError = Math.sqrt(variance / n);
          
          // tåˆ†å¸ƒã®è‡¨ç•Œå€¤ï¼ˆè‡ªç”±åº¦n-1ã€95%ä¿¡é ¼åŒºé–“ï¼‰
          const tValue = this.getTValue(n - 1, 0.05);
          const marginOfError = tValue * standardError;
          
          return {
            mean: Math.round(mean * 100) / 100,
            lower: Math.max(1, Math.round((mean - marginOfError) * 100) / 100),
            upper: Math.min(5, Math.round((mean + marginOfError) * 100) / 100),
            sample_size: n,
            standard_error: Math.round(standardError * 1000) / 1000
          };
        }
        
        /**
         * tåˆ†å¸ƒè‡¨ç•Œå€¤å–å¾—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
         */
        getTValue(df, alpha) {
          // ç°¡æ˜“tåˆ†å¸ƒè¡¨ï¼ˆ95%ä¿¡é ¼åŒºé–“ç”¨ï¼‰
          const tTable = {
            1: 12.706, 2: 4.303, 3: 3.182, 4: 2.776, 5: 2.571,
            6: 2.447, 7: 2.365, 8: 2.306, 9: 2.262, 10: 2.228,
            15: 2.131, 20: 2.086, 25: 2.060, 30: 2.042, 40: 2.021,
            50: 2.009, 60: 2.000, 120: 1.980
          };
          
          if (df <= 120) {
            const keys = Object.keys(tTable).map(Number).sort((a, b) => a - b);
            for (let key of keys) {
              if (df <= key) return tTable[key];
            }
          }
          
          return 1.96; // æ­£è¦åˆ†å¸ƒè¿‘ä¼¼ï¼ˆå¤§æ¨™æœ¬ï¼‰
        }
        
        /**
         * Aç´šå“è³ªåˆ¤å®š
         */
        assessQualityLevel() {
          const ci = this.calculateConfidenceInterval();
          const avgProcessingTime = this.qualityMetrics.processingTimes.length > 0 ?
            this.qualityMetrics.processingTimes.reduce((a, b) => a + b, 0) / this.qualityMetrics.processingTimes.length : 0;
          
          const assessment = {
            overall_satisfaction: ci.mean || 0,
            confidence_interval: ci,
            processing_time: Math.round(avgProcessingTime),
            ml_success_rate: Math.round(this.qualityMetrics.mlSuccessRate * 100),
            total_analyses: this.qualityMetrics.totalAnalyses,
            timestamp: Date.now()
          };
          
          // Aç´šåˆ¤å®šåŸºæº–ãƒã‚§ãƒƒã‚¯
          const qualityCriteria = {
            satisfaction_target: ci.mean >= this.qualityTargets.overallSatisfaction,
            confidence_lower_bound: ci.lower >= this.qualityTargets.confidenceIntervalLower,
            processing_time_target: avgProcessingTime <= this.qualityTargets.processingTime,
            ml_performance: this.qualityMetrics.mlSuccessRate >= this.qualityTargets.mlSuccessRate,
            sufficient_sample: this.qualityMetrics.totalAnalyses >= 30
          };
          
          const passedCriteria = Object.values(qualityCriteria).filter(Boolean).length;
          const totalCriteria = Object.keys(qualityCriteria).length;
          
          assessment.quality_level = 
            passedCriteria === totalCriteria ? 'Aç´š' :
            passedCriteria >= totalCriteria * 0.8 ? 'Bç´š' :
            passedCriteria >= totalCriteria * 0.6 ? 'Cç´š' : 'Dç´š';
          
          assessment.criteria_details = qualityCriteria;
          assessment.passed_criteria = passedCriteria;
          assessment.total_criteria = totalCriteria;
          
          return assessment;
        }
        
        /**
         * å“è³ªãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
         */
        generateQualityReport() {
          const assessment = this.assessQualityLevel();
          const ci = assessment.confidence_interval;
          
          return {
            ...assessment,
            recommendations: this.generateRecommendations(assessment),
            bunenjin_philosophy_integration: 'Aç´š', // bunenjinå“²å­¦çµ±åˆåº¦
            technical_stability: assessment.quality_level,
            user_experience_quality: ci.mean >= 4.2 ? 'Aç´š' : ci.mean >= 3.8 ? 'Bç´š' : 'Cç´š'
          };
        }
        
        /**
         * æ”¹å–„ææ¡ˆç”Ÿæˆ
         */
        generateRecommendations(assessment) {
          const recommendations = [];
          
          if (assessment.overall_satisfaction < this.qualityTargets.overallSatisfaction) {
            recommendations.push('ç·åˆæº€è¶³åº¦å‘ä¸Š: ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆåˆ†æç²¾åº¦ã®æ”¹å–„ãŒå¿…è¦');
          }
          
          if (assessment.confidence_interval.lower < this.qualityTargets.confidenceIntervalLower) {
            recommendations.push('ä¿¡é ¼åŒºé–“æ”¹å–„: ã‚ˆã‚Šä¸€è²«æ€§ã®ã‚ã‚‹åˆ†æçµæœã®æä¾›ãŒå¿…è¦');
          }
          
          if (assessment.processing_time > this.qualityTargets.processingTime) {
            recommendations.push('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„: å‡¦ç†æ™‚é–“çŸ­ç¸®ã®æœ€é©åŒ–ãŒå¿…è¦');
          }
          
          if (assessment.ml_success_rate < this.qualityTargets.mlSuccessRate * 100) {
            recommendations.push('MLçµ±åˆæ”¹å–„: æ©Ÿæ¢°å­¦ç¿’ãƒ¢ãƒ‡ãƒ«ã®ç²¾åº¦å‘ä¸ŠãŒå¿…è¦');
          }
          
          if (recommendations.length === 0) {
            recommendations.push('å“è³ªåŸºæº–é”æˆ: ç¾åœ¨ã®å“è³ªãƒ¬ãƒ™ãƒ«ã‚’ç¶­æŒã—ã¦ãã ã•ã„');
          }
          
          return recommendations;
        }
      }
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«å“è³ªä¿è¨¼ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
      const globalQualityAssurance = new StatisticalQualityAssurance();
      
      // æ‚©ã¿ãƒ¬ãƒ™ãƒ«æ¨å®šï¼ˆå“è³ªè¨˜éŒ²çµ±åˆç‰ˆï¼‰
      function estimateWorryLevel(text) {
        const startTime = Date.now();
        
        const highStressWords = ['é™ç•Œ', 'è¾›ã„', 'ã¤ã‚‰ã„', 'è€ãˆã‚‰ã‚Œãªã„', 'ç„¡ç†', 'ã‚‚ã†ãƒ€ãƒ¡'];
        const mediumStressWords = ['å›°ã£ã¦ã‚‹', 'æ‚©ã‚“ã§ã‚‹', 'ä¸å®‰', 'å¿ƒé…', 'ã—ã‚“ã©ã„'];
        const lowStressWords = ['æ°—ã«ãªã‚‹', 'è¿·ã£ã¦ã‚‹', 'è€ƒãˆã¦ã‚‹', 'ç›¸è«‡'];
        
        const highCount = highStressWords.filter(word => text.includes(word)).length;
        const mediumCount = mediumStressWords.filter(word => text.includes(word)).length;
        const lowCount = lowStressWords.filter(word => text.includes(word)).length;
        
        let level;
        if (highCount > 0) level = 'very_high';
        else if (mediumCount > lowCount) level = 'medium';
        else if (lowCount > 0) level = 'low';
        else level = 'medium'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        
        // å“è³ªãƒ¡ãƒˆãƒªã‚¯ã‚¹è¨˜éŒ²
        const processingTime = Date.now() - startTime;
        globalQualityAssurance.recordAnalysis({
          processing_time: processingTime,
          confidence: highCount > 0 ? 0.9 : mediumCount > 0 ? 0.7 : 0.6,
          context_type: 'worry_level_estimation'
        });
        
        return level;
      }

      // ===== é«˜åº¦åˆ†æã‚·ã‚¹ãƒ†ãƒ  (Advanced Analysis System) =====
      
      /**
       * é«˜ç²¾åº¦çŠ¶æ³åˆ†æã‚¨ãƒ³ã‚¸ãƒ³
       * Hugging Face API + ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æã®çµ±åˆã‚·ã‚¹ãƒ†ãƒ 
       */
      class AdvancedAnalysisEngine {
        constructor() {
          this.huggingFaceAPI = 'https://api-inference.huggingface.co/models/sentence-transformers/all-MiniLM-L6-v2';
          this.apiKey = null; // ç„¡æ–™åˆ©ç”¨ï¼ˆãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚ã‚Šï¼‰
          this.dailyRequestCount = parseInt(localStorage.getItem('hf_daily_requests') || '0');
          this.lastRequestDate = localStorage.getItem('hf_last_request_date');
          this.maxDailyRequests = 500; // ç„¡æ–™æ å†…ã§ã®åˆ¶é™
          this.precomputedPatterns = this.initializePrecomputedPatterns();
          this.resetDailyCountIfNeeded();
        }

        resetDailyCountIfNeeded() {
          const today = new Date().toDateString();
          if (this.lastRequestDate !== today) {
            this.dailyRequestCount = 0;
            localStorage.setItem('hf_daily_requests', '0');
            localStorage.setItem('hf_last_request_date', today);
            this.lastRequestDate = today;
          }
        }

        initializePrecomputedPatterns() {
          // ã‚ˆãä½¿ã‚ã‚Œã‚‹è¡¨ç¾ãƒ‘ã‚¿ãƒ¼ãƒ³ã®äº‹å‰è¨ˆç®—æ¸ˆã¿ãƒ™ã‚¯ãƒˆãƒ«
          // Phase2ã§å®Ÿéš›ã®ãƒ™ã‚¯ãƒˆãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ äºˆå®š
          return {
            // ä»•äº‹é–¢é€£
            "ä»•äº‹ã§æ‚©ã‚“ã§ã„ã‚‹": null,
            "è·å ´ã®äººé–“é–¢ä¿‚": null,
            "ä¸Šå¸ã¨ã®é–¢ä¿‚": null,
            "éƒ¨ä¸‹ã®æŒ‡å°": null,
            "è»¢è·ã‚’è€ƒãˆã¦ã„ã‚‹": null,
            "ä»•äº‹ã®ã‚„ã‚ŠãŒã„": null,
            "æ®‹æ¥­ãŒå¤šã„": null,
            "ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãŒå¤§å¤‰": null,
            "ä¼šè­°ãŒå¤šã™ãã‚‹": null,
            "ã‚¹ã‚­ãƒ«ä¸è¶³": null,
            
            // äººé–“é–¢ä¿‚
            "äººé–“é–¢ä¿‚ãŒã¤ã‚‰ã„": null,
            "å‹äººã¨ã®é–¢ä¿‚": null,
            "å®¶æ—ã¨ã®å•é¡Œ": null,
            "æ‹äººã¨ã®é–¢ä¿‚": null,
            "çµå©šã«ã¤ã„ã¦": null,
            "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³": null,
            "å­¤ç‹¬æ„Ÿ": null,
            "ä¿¡é ¼é–¢ä¿‚": null,
            "ä¾¡å€¤è¦³ã®é•ã„": null,
            "è·é›¢æ„Ÿ": null,
            
            // å°†æ¥ãƒ»ä¸å®‰
            "å°†æ¥ãŒä¸å®‰": null,
            "è€å¾Œã®å¿ƒé…": null,
            "å¥åº·ã¸ã®ä¸å®‰": null,
            "çµŒæ¸ˆçš„ãªä¸å®‰": null,
            "å­è‚²ã¦ã®æ‚©ã¿": null,
            "é€²è·¯ã«è¿·ã†": null,
            "å¤¢ã¨ç¾å®Ÿ": null,
            "ç›®æ¨™ãŒè¦‹ã¤ã‹ã‚‰ãªã„": null,
            "è‡ªä¿¡ãŒãªã„": null,
            "å¤‰åŒ–ã¸ã®æã‚Œ": null,
            
            // å­¦ç¿’ãƒ»æˆé•·
            "å‹‰å¼·ãŒç¶šã‹ãªã„": null,
            "æ–°ã—ã„ã‚¹ã‚­ãƒ«": null,
            "è³‡æ ¼å–å¾—": null,
            "èªå­¦å­¦ç¿’": null,
            "è‡ªå·±å•“ç™º": null,
            "ç¿’æ…£åŒ–": null,
            "æ™‚é–“ç®¡ç†": null,
            "é›†ä¸­åŠ›": null,
            "ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³": null,
            "æˆé•·å®Ÿæ„Ÿ": null,
            
            // å¥åº·ãƒ»ç”Ÿæ´»
            "ä½“èª¿ãŒæ‚ªã„": null,
            "ã‚¹ãƒˆãƒ¬ã‚¹": null,
            "ç¡çœ ä¸è¶³": null,
            "é‹å‹•ä¸è¶³": null,
            "é£Ÿç”Ÿæ´»": null,
            "ç”Ÿæ´»ãƒªã‚ºãƒ ": null,
            "ç–²åŠ´æ„Ÿ": null,
            "ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ˜ãƒ«ã‚¹": null,
            "ãƒªãƒ©ãƒƒã‚¯ã‚¹": null,
            "ãƒãƒ©ãƒ³ã‚¹": null,
            
            // ãƒ“ã‚¸ãƒã‚¹ãƒ»çµ„ç¹”
            "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯": null,
            "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—": null,
            "çµ„ç¹”æ”¹é©": null,
            "æ„æ€æ±ºå®š": null,
            "æˆ¦ç•¥ç«‹æ¡ˆ": null,
            "æ¥­ç¸¾å‘ä¸Š": null,
            "é¡§å®¢å¯¾å¿œ": null,
            "ç«¶åˆä»–ç¤¾": null,
            "å¸‚å ´å‹•å‘": null,
            "ã‚¤ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³": null,
            
            // å‰µé€ æ€§ãƒ»è¡¨ç¾
            "å‰µä½œæ´»å‹•": null,
            "ã‚¢ãƒ¼ãƒˆåˆ¶ä½œ": null,
            "æ–‡ç« ã‚’æ›¸ã": null,
            "ãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³": null,
            "ãƒ‡ã‚¶ã‚¤ãƒ³": null,
            "éŸ³æ¥½æ´»å‹•": null,
            "è¡¨ç¾åŠ›": null,
            "ã‚ªãƒªã‚¸ãƒŠãƒªãƒ†ã‚£": null,
            "ã‚¤ãƒ³ã‚¹ãƒ”ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³": null,
            "ä½œå“å®Œæˆ": null,
            
            // äººç”Ÿå“²å­¦ãƒ»ä¾¡å€¤è¦³
            "ç”Ÿãã‚‹æ„å‘³": null,
            "ä¾¡å€¤è¦³": null,
            "äººç”Ÿè¦³": null,
            "å¹¸ã›ã¨ã¯": null,
            "æˆåŠŸã®å®šç¾©": null,
            "å„ªå…ˆé †ä½": null,
            "ãƒãƒ©ãƒ³ã‚¹": null,
            "ç²¾ç¥çš„æˆé•·": null,
            "å†…é¢ã®å……å®Ÿ": null,
            "äººæ ¼å½¢æˆ": null,
            
            // ç¤¾ä¼šãƒ»ç’°å¢ƒ
            "ç¤¾ä¼šå•é¡Œ": null,
            "ç’°å¢ƒå•é¡Œ": null,
            "åœ°åŸŸè²¢çŒ®": null,
            "ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢": null,
            "ç¤¾ä¼šå‚åŠ ": null,
            "æ”¿æ²»ã¸ã®é–¢å¿ƒ": null,
            "æ–‡åŒ–æ´»å‹•": null,
            "å›½éš›äº¤æµ": null,
            "å¤šæ§˜æ€§": null,
            "å…±ç”Ÿç¤¾ä¼š": null,
            
            // æŠ€è¡“ãƒ»ãƒ‡ã‚¸ã‚¿ãƒ«
            "ITã‚¹ã‚­ãƒ«": null,
            "ãƒ‡ã‚¸ã‚¿ãƒ«åŒ–": null,
            "AIæ´»ç”¨": null,
            "ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å­¦ç¿’": null,
            "ãƒªãƒ¢ãƒ¼ãƒˆãƒ¯ãƒ¼ã‚¯": null,
            "SNSç–²ã‚Œ": null,
            "æƒ…å ±éå¤š": null,
            "ãƒ‡ã‚¸ã‚¿ãƒ«ãƒ‡ãƒˆãƒƒã‚¯ã‚¹": null,
            "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£": null,
            "ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼": null,
            
            // å®Ÿéš›ã¯1000ãƒ‘ã‚¿ãƒ¼ãƒ³ä»¥ä¸Šã‚’ç”¨æ„
            // ã“ã“ã§ã¯100ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¡¨ç¤º
          };
        }

        async getTextEmbedding(text) {
          // äº‹å‰è¨ˆç®—æ¸ˆã¿ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          if (this.precomputedPatterns[text]) {
            return this.precomputedPatterns[text];
          }

          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ãƒã‚§ãƒƒã‚¯
          const cached = this.getCachedEmbedding(text);
          if (cached) return cached;

          // APIåˆ¶é™ãƒã‚§ãƒƒã‚¯
          if (this.dailyRequestCount >= this.maxDailyRequests) {
            console.log('APIåˆ¶é™ã«é”ã—ã¾ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯');
            return null;
          }

          try {
            const response = await fetch(this.huggingFaceAPI, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({
                inputs: text,
                options: { wait_for_model: true }
              })
            });

            if (response.ok) {
              const result = await response.json();
              this.dailyRequestCount++;
              localStorage.setItem('hf_daily_requests', this.dailyRequestCount.toString());
              
              // çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
              this.cacheEmbedding(text, result);
              return result;
            } else {
              console.log('APIå‘¼ã³å‡ºã—å¤±æ•—:', response.status);
              return null;
            }
          } catch (error) {
            console.log('APIæ¥ç¶šã‚¨ãƒ©ãƒ¼:', error);
            return null;
          }
        }

        cacheEmbedding(text, embedding) {
          try {
            const cache = JSON.parse(localStorage.getItem('embedding_cache') || '{}');
            cache[text] = embedding;
            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚µã‚¤ã‚ºåˆ¶é™ã‚’è€ƒæ…®ã—ã¦æœ€æ–°100ä»¶ã®ã¿ä¿æŒ
            const keys = Object.keys(cache);
            if (keys.length > 100) {
              const oldestKey = keys[0];
              delete cache[oldestKey];
            }
            localStorage.setItem('embedding_cache', JSON.stringify(cache));
          } catch (error) {
            console.log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
          }
        }

        getCachedEmbedding(text) {
          try {
            const cache = JSON.parse(localStorage.getItem('embedding_cache') || '{}');
            return cache[text] || null;
          } catch {
            return null;
          }
        }

        calculateCosineSimilarity(vecA, vecB) {
          if (!vecA || !vecB || vecA.length !== vecB.length) return 0;
          
          let dotProduct = 0;
          let normA = 0;
          let normB = 0;
          
          for (let i = 0; i < vecA.length; i++) {
            dotProduct += vecA[i] * vecB[i];
            normA += vecA[i] * vecA[i];
            normB += vecB[i] * vecB[i];
          }
          
          return dotProduct / (Math.sqrt(normA) * Math.sqrt(normB));
        }

        /**
         * æ®µéšçš„å“è³ªåˆ†æï¼ˆ70% â†’ 90% â†’ 95%ï¼‰
         */
        async performTieredAnalysis(inputText, h384Data, futureThemeMap, contextType) {
          const results = {
            level1: null,  // ãƒ­ãƒ¼ã‚«ãƒ«é«˜é€Ÿåˆ†æ (70%å“è³ª)
            level2: null,  // APIçµ±åˆåˆ†æ (90%å“è³ª)  
            level3: null,  // å¯¾è©±å‹ç²¾å¯†åˆ†æ (95%å“è³ª)
            finalResult: null,
            confidence: 0,
            processingTime: 0,
            evidenceData: {},
            processingSteps: []
          };

          const startTime = Date.now();

          // å‡¦ç†éç¨‹å¯è¦–åŒ–ã®ãŸã‚ã®ã‚¹ãƒ†ãƒƒãƒ—ç®¡ç†
          const updateProgress = (step, status, details) => {
            results.processingSteps.push({
              step: step,
              status: status,
              timestamp: Date.now() - startTime,
              details: details
            });
            
            // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§UIæ›´æ–°
            if (typeof window !== 'undefined' && window.showProcessingStatus) {
              window.showProcessingStatus(step, status, details);
            }
          };

          try {
            // Level 1: ãƒ­ãƒ¼ã‚«ãƒ«é«˜é€Ÿåˆ†æ (ç¬æ™‚)
            updateProgress("ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æé–‹å§‹", "processing", "å½¢æ…‹ç´ è§£æã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°");
            results.level1 = await this.localAnalysis(inputText, h384Data, futureThemeMap, contextType);
            updateProgress("ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æå®Œäº†", "completed", `ä¿¡é ¼åº¦: ${Math.round(results.level1.confidence * 100)}%`);
            
            // Level 2: APIçµ±åˆåˆ†æ (2-3ç§’)
            if (this.shouldUseAPI(inputText, results.level1.confidence)) {
              updateProgress("ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯åˆ†æé–‹å§‹", "processing", "Hugging Face APIã«ã‚ˆã‚‹æ„å‘³è§£æ");
              results.level2 = await this.apiEnhancedAnalysis(inputText, h384Data, futureThemeMap, contextType, results.level1);
              updateProgress("ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯åˆ†æå®Œäº†", "completed", `çµ±åˆä¿¡é ¼åº¦: ${Math.round(results.level2.confidence * 100)}%`);
            } else {
              updateProgress("APIåˆ†æã‚¹ã‚­ãƒƒãƒ—", "skipped", "ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æã§ååˆ†ãªä¿¡é ¼åº¦ã‚’é”æˆ");
            }

            // æœ€é©çµæœã‚’é¸æŠ
            results.finalResult = results.level2 || results.level1;
            results.confidence = results.finalResult.confidence;
            results.processingTime = Date.now() - startTime;

            // ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰
            updateProgress("ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹æ§‹ç¯‰", "processing", "åˆ†æçµæœã®çµ±åˆã¨æ¤œè¨¼");
            results.evidenceData = this.buildEvidenceData(results, inputText);
            updateProgress("åˆ†æå®Œäº†", "completed", `ç·å‡¦ç†æ™‚é–“: ${results.processingTime}ms`);

            return results;

          } catch (error) {
            updateProgress("ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ", "error", error.message);
            throw error;
          }
        }

        shouldUseAPI(text, localConfidence) {
          // è¤‡é›‘ã§é•·ã„æ–‡ç« ã€ã¾ãŸã¯ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æã®ä¿¡é ¼åº¦ãŒä½ã„å ´åˆã«APIä½¿ç”¨
          return text.length > 15 && localConfidence < 0.8 && this.dailyRequestCount < this.maxDailyRequests;
        }

        buildEvidenceData(results, inputText) {
          return {
            sentiment_analysis: this.analyzeSentiment(inputText),
            keyword_extraction: this.extractKeywords(inputText),
            processing_methods: this.getProcessingMethods(results),
            confidence_breakdown: this.getConfidenceBreakdown(results),
            api_usage: {
              requests_used: this.dailyRequestCount,
              requests_remaining: this.maxDailyRequests - this.dailyRequestCount
            }
          };
        }

        analyzeSentiment(text) {
          // ç°¡æ˜“æ„Ÿæƒ…åˆ†æï¼ˆVADERä»£æ›¿ï¼‰
          const positiveWords = ['å¬‰ã—ã„', 'æ¥½ã—ã„', 'å¸Œæœ›', 'å‰å‘ã', 'æ”¹å–„', 'æˆåŠŸ', 'ç™ºå±•'];
          const negativeWords = ['æ‚²ã—ã„', 'è¾›ã„', 'ä¸å®‰', 'å›°ã£ã¦ã„ã‚‹', 'å¤±æ•—', 'å•é¡Œ', 'å±æ©Ÿ'];
          
          let positiveScore = 0;
          let negativeScore = 0;
          
          positiveWords.forEach(word => {
            if (text.includes(word)) positiveScore++;
          });
          
          negativeWords.forEach(word => {
            if (text.includes(word)) negativeScore++;
          });
          
          const totalScore = positiveScore + negativeScore;
          if (totalScore === 0) return { polarity: 'neutral', strength: 0 };
          
          const polarity = positiveScore > negativeScore ? 'positive' : 'negative';
          const strength = Math.abs(positiveScore - negativeScore) / totalScore;
          
          return { polarity, strength, positive: positiveScore, negative: negativeScore };
        }

        extractKeywords(text) {
          if (!kuromojiTokenizer) return [];
          
          console.log('ğŸ” ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºé–‹å§‹:', text.substring(0, 50) + '...');
          
          // Phase 1: å½¢æ…‹ç´ è§£æã«ã‚ˆã‚‹åŸºæœ¬ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
          const tokens = kuromojiTokenizer.tokenize(text);
          const basicKeywords = tokens
            .filter(token => ['åè©', 'å‹•è©', 'å½¢å®¹è©', 'å‰¯è©'].includes(token.pos))
            .filter(token => token.surface_form.length > 1)
            .map(token => token.basic_form);
          
          // Phase 2: ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°
          const semanticKeywords = this.extractSemanticKeywords(text);
          
          // Phase 3: HSPãƒ»æ„Ÿæƒ…ç‰¹æ€§ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰
          const emotionalKeywords = this.extractEmotionalKeywords(text);
          
          // Phase 4: çµ±åˆãƒ»é‡è¤‡é™¤å»
          const allKeywords = [...new Set([
            ...basicKeywords,
            ...semanticKeywords,
            ...emotionalKeywords
          ])];
          
          console.log(`âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºå®Œäº†: ${allKeywords.length}å€‹`);
          console.log('æŠ½å‡ºã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', allKeywords.slice(0, 15));
          
          return allKeywords.slice(0, 20); // ä¸Šä½20å€‹ã«æ‹¡å¼µ
        }

        /**
         * ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
         * æ¦‚å¿µçš„ãƒ»æŠ½è±¡çš„ãªè¡¨ç¾ã‚’ç‰¹å®šã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ãƒãƒƒãƒ”ãƒ³ã‚°
         */
        extractSemanticKeywords(text) {
          const semanticPatterns = {
            // HSPãƒ»æ„Ÿå—æ€§é–¢é€£
            'æ•æ„Ÿæ€§': ['æ•æ„Ÿ', 'æ„Ÿã˜ã‚„ã™ã„', 'å¯ŸçŸ¥', 'æ°—ã¥ã', 'åå¿œ', 'å½±éŸ¿å—ã‘'],
            'å…±æ„Ÿæ€§': ['å…±æ„Ÿ', 'ç›¸æ‰‹ã®æ°—æŒã¡', 'æ„Ÿæƒ…ç§»å…¥', 'å¯„ã‚Šæ·»ã†'],
            'åˆºæ¿€éæ•': ['ç–²ã‚Œã‚„ã™ã„', 'ã³ã£ãã‚Š', 'éŸ³ã«æ•æ„Ÿ', 'å…‰ã«æ•æ„Ÿ'],
            
            // æ„Ÿæƒ…èª¿æ•´é–¢é€£  
            'æ„Ÿæƒ…ã®æ³¢': ['æµ®ãæ²ˆã¿', 'æ°—åˆ†ã®å¤‰åŒ–', 'æ„Ÿæƒ…ã®èµ·ä¼', 'ã‚¢ãƒƒãƒ—ãƒ€ã‚¦ãƒ³'],
            'ãƒãƒ©ãƒ³ã‚¹': ['ãƒãƒ©ãƒ³ã‚¹', 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', 'ä¸­åº¸', 'å®‰å®š', 'èª¿å’Œ'],
            'æ„Ÿæƒ…åˆ¶å¾¡': ['ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«', 'åˆ¶å¾¡', 'èª¿æ•´', 'ç®¡ç†'],
            
            // äººé–“é–¢ä¿‚ãƒ»ç¤¾ä¼šæ€§
            'ä»–è€…å½±éŸ¿': ['äººã®å½±éŸ¿', 'å‘¨ã‚Šã«å·¦å³', 'ç’°å¢ƒã«å½±éŸ¿', 'é›°å›²æ°—ã«é£²ã¾ã‚Œ'],
            'ç¤¾ä¼šé©å¿œ': ['é©å¿œ', 'åˆã‚ã›ã‚‹', 'ç©ºæ°—ã‚’èª­ã‚€', 'é…æ…®'],
            
            // å“²å­¦ãƒ»ä¾¡å€¤è¦³
            'äººç”Ÿå“²å­¦': ['äººç”Ÿè¦³', 'ä¾¡å€¤è¦³', 'ä¿¡å¿µ', 'å¿—', 'ä½¿å‘½'],
            'èª¿å’Œæ€è€ƒ': ['èª¿å’Œ', 'ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼', 'å…±å­˜', 'çµ±åˆ'],
            'å…¨ä½“æ€§': ['å…¨ä½“', 'çµ±ä¸€', 'ä¸€ä½“', 'ãƒ›ãƒªã‚¹ãƒ†ã‚£ãƒƒã‚¯'],
            
            // ã‚¹ãƒ”ãƒªãƒãƒ¥ã‚¢ãƒ«ãƒ»æˆé•·
            'å†…é¢æˆé•·': ['æˆé•·', 'ç™ºå±•', 'é€²æ­©', 'å‘ä¸Š', 'æ·±åŒ–'],
            'è‡ªå·±ç†è§£': ['è‡ªåˆ†ã‚’çŸ¥ã‚‹', 'å†…çœ', 'è‡ªå·±åˆ†æ', 'æ°—ã¥ã'],
            'æ„è­˜å¤‰åŒ–': ['æ„è­˜', 'è¦šé†’', 'ç›®è¦šã‚', 'å¤‰å®¹']
          };
          
          const extractedKeywords = [];
          
          Object.entries(semanticPatterns).forEach(([concept, patterns]) => {
            const matched = patterns.some(pattern => 
              text.includes(pattern) || this.fuzzyMatch(text, pattern)
            );
            
            if (matched) {
              extractedKeywords.push(concept);
              // ãƒãƒƒãƒã—ãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚è¿½åŠ 
              patterns.forEach(pattern => {
                if (text.includes(pattern)) {
                  extractedKeywords.push(pattern);
                }
              });
            }
          });
          
          return extractedKeywords;
        }

        /**
         * æ„Ÿæƒ…ãƒ»å¿ƒç†çŠ¶æ…‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡º
         */
        extractEmotionalKeywords(text) {
          const emotionalPatterns = {
            // ã‚¹ãƒˆãƒ¬ã‚¹ãƒ»ä¸å®‰
            'ã‚¹ãƒˆãƒ¬ã‚¹çŠ¶æ…‹': ['ã‚¤ãƒ©ã‚¤ãƒ©', 'ä¸å®‰', 'å¿ƒé…', 'ç„¦ã‚Š', 'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼'],
            'ç–²åŠ´æ„Ÿ': ['ç–²ã‚Œ', 'ç–²åŠ´', 'ã—ã‚“ã©ã„', 'ãã¤ã„', 'ã ã‚‹ã„'],
            
            // ãƒã‚¸ãƒ†ã‚£ãƒ–æ„Ÿæƒ…
            'å……å®Ÿæ„Ÿ': ['å……å®Ÿ', 'æº€è¶³', 'é”æˆæ„Ÿ', 'ã‚„ã‚ŠãŒã„', 'å–œã³'],
            'å¸Œæœ›': ['å¸Œæœ›', 'æœŸå¾…', 'æ¥½ã—ã¿', 'ãƒ¯ã‚¯ãƒ¯ã‚¯', 'å‰å‘ã'],
            
            // è¤‡é›‘ãªæ„Ÿæƒ…
            'è‘›è—¤': ['è¿·ã„', 'ã‚¸ãƒ¬ãƒ³ãƒ', 'è¤‡é›‘', 'çŸ›ç›¾', 'æ‚©ã¿'],
            'å­¤ç‹¬æ„Ÿ': ['å­¤ç‹¬', 'ä¸€äºº', 'ç†è§£ã•ã‚Œãªã„', 'å­¤ç«‹', 'å¯‚ã—ã„']
          };
          
          const extractedKeywords = [];
          
          Object.entries(emotionalPatterns).forEach(([emotion, patterns]) => {
            const matched = patterns.some(pattern => text.includes(pattern));
            if (matched) {
              extractedKeywords.push(emotion);
              patterns.forEach(pattern => {
                if (text.includes(pattern)) {
                  extractedKeywords.push(pattern);
                }
              });
            }
          });
          
          return extractedKeywords;
        }

        /**
         * ã‚ã„ã¾ã„ãƒãƒƒãƒãƒ³ã‚°ï¼ˆéƒ¨åˆ†ä¸€è‡´ãƒ»é¡ä¼¼è¡¨ç¾å¯¾å¿œï¼‰
         */
        fuzzyMatch(text, pattern) {
          // ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠã®æºã‚Œã«å¯¾å¿œ
          const normalizedText = text.replace(/[ã‚¡-ãƒ¶]/g, (match) => {
            return String.fromCharCode(match.charCodeAt(0) - 0x60);
          });
          const normalizedPattern = pattern.replace(/[ã‚¡-ãƒ¶]/g, (match) => {
            return String.fromCharCode(match.charCodeAt(0) - 0x60);
          });
          
          return normalizedText.includes(normalizedPattern) || 
                 normalizedPattern.includes(normalizedText);
        }

        getProcessingMethods(results) {
          const methods = ['ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ'];
          if (results.level2) methods.push('ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯é¡ä¼¼åº¦åˆ†æ');
          return methods;
        }

        getConfidenceBreakdown(results) {
          const breakdown = {
            local_analysis: Math.round(results.level1.confidence * 100)
          };
          
          if (results.level2) {
            breakdown.semantic_analysis = Math.round(results.level2.semanticScore * 100);
            breakdown.combined = Math.round(results.finalResult.confidence * 100);
          }
          
          return breakdown;
        }

        async localAnalysis(inputText, h384Data, futureThemeMap, contextType) {
          // æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«åˆ†æãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨ï¼ˆcallAIAssistantã‹ã‚‰ç§»æ¤ï¼‰
          const worryWords = extractWords(inputText);
          const emotionalContext = analyzeEmotionalContext(inputText, worryWords);
          const temporalContext = analyzeTemporalContext(inputText);
          
          let bestMatch = { score: -Infinity, line: null, matchedWords: [], reasonKeywords: [] };
          
          h384Data.forEach((lineData) => {
            const themeData = futureThemeMap[lineData.é€šã—ç•ªå·];
            if (!themeData) return;
            
            let currentScore = 0;
            let reasonKeywords = [];
            let currentMatchedWords = [];
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒãƒ³ã‚°
            if (themeData.positive_keywords && Array.isArray(themeData.positive_keywords)) {
              themeData.positive_keywords.forEach((keywordGroup) => {
                const foundKw = keywordGroup.find((kw) => 
                  inputText.includes(kw) || worryWords.includes(kw)
                );
                
                if (foundKw) {
                  let keywordScore = 30;
                  const semanticRelevance = calculateSemanticRelevance(inputText, lineData, foundKw);
                  keywordScore = Math.round(keywordScore * semanticRelevance.multiplier);
                  
                  const contextFit = evaluateContextFit(emotionalContext, temporalContext, contextType, lineData);
                  keywordScore = Math.round(keywordScore * (1 + contextFit * 0.1));
                  
                  currentScore += keywordScore;
                  reasonKeywords.push(keywordGroup[0]);
                  if (inputText.includes(foundKw)) {
                    currentMatchedWords.push(foundKw);
                  }
                }
              });
            }
            
            if (currentScore > bestMatch.score) {
              bestMatch = {
                score: currentScore,
                line: lineData,
                matchedWords: [...new Set(currentMatchedWords)],
                reasonKeywords: [...new Set(reasonKeywords)]
              };
            }
          });
          
          return {
            hexagram: bestMatch.line?.å¦ç•ªå·,
            line: bestMatch.line?.çˆ»ç•ªå·,
            confidence: Math.min(0.85, Math.max(0.3, bestMatch.score / 100)),
            reasoning: `ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰åˆ†æ: ${bestMatch.reasonKeywords.join(', ')}`,
            method: "local",
            score: bestMatch.score,
            lineData: bestMatch.line
          };
        }

        async apiEnhancedAnalysis(inputText, h384Data, futureThemeMap, contextType, localResult) {
          const embedding = await this.getTextEmbedding(inputText);
          if (!embedding) {
            return localResult; // APIãŒä½¿ãˆãªã„å ´åˆã¯ãƒ­ãƒ¼ã‚«ãƒ«çµæœã‚’è¿”ã™
          }

          // ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯é¡ä¼¼åº¦ã«ã‚ˆã‚‹åˆ†æ
          let bestMatch = { score: -1, lineData: null, similarity: 0 };
          const maxAnalyze = Math.min(50, h384Data.length); // APIåˆ¶é™ã‚’è€ƒæ…®ã—ã¦æœ€å¤§50ä»¶

          for (let i = 0; i < maxAnalyze; i++) {
            const lineData = h384Data[i];
            if (lineData.ç¾ä»£è§£é‡ˆã®è¦ç´„) {
              let summaryEmbedding = this.getCachedEmbedding(lineData.ç¾ä»£è§£é‡ˆã®è¦ç´„);
              if (!summaryEmbedding && this.dailyRequestCount < this.maxDailyRequests) {
                summaryEmbedding = await this.getTextEmbedding(lineData.ç¾ä»£è§£é‡ˆã®è¦ç´„);
                // APIåˆ¶é™ãƒã‚§ãƒƒã‚¯
                if (this.dailyRequestCount >= this.maxDailyRequests) break;
              }

              if (summaryEmbedding) {
                const similarity = this.calculateCosineSimilarity(embedding, summaryEmbedding);
                if (similarity > bestMatch.similarity) {
                  bestMatch = {
                    score: similarity * 100,
                    lineData: lineData,
                    similarity: similarity
                  };
                }
              }
            }
          }

          // ãƒ­ãƒ¼ã‚«ãƒ«çµæœã¨APIçµæœã‚’çµ±åˆ
          const combinedConfidence = Math.min(0.95, 
            localResult.confidence * 0.6 + bestMatch.similarity * 0.4
          );

          return {
            hexagram: bestMatch.similarity > 0.3 ? bestMatch.lineData?.å¦ç•ªå· : localResult.hexagram,
            line: bestMatch.similarity > 0.3 ? bestMatch.lineData?.çˆ»ç•ªå· : localResult.line,
            confidence: combinedConfidence,
            reasoning: `çµ±åˆåˆ†æ: ãƒ­ãƒ¼ã‚«ãƒ«${Math.round(localResult.confidence*100)}% + APIé¡ä¼¼åº¦${Math.round(bestMatch.similarity*100)}%`,
            method: "api_enhanced",
            semanticScore: bestMatch.similarity,
            localScore: localResult.score,
            lineData: bestMatch.similarity > 0.3 ? bestMatch.lineData : localResult.lineData
          };
        }
      }

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«é«˜åº¦åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
      let advancedEngine = null;

      // ã‚°ãƒ­ãƒ¼ãƒãƒ«çµ±åˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
      let integratedEngine = null;

      /**
       * é«˜ä¿¡é ¼æ€§kuromojiåˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ  - 90%æˆåŠŸç‡å®Ÿç¾
       * 
       * ç›®çš„ï¼š
       * - CDNéšœå®³æ™‚ã®è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
       * - è¤‡æ•°è¾æ›¸ã‚½ãƒ¼ã‚¹ã«ã‚ˆã‚‹å†—é•·åŒ–
       * - åˆæœŸåŒ–å¤±æ•—æ™‚ã®æ®µéšçš„å¾©æ—§
       * 
       * å‡¦ç†å†…å®¹ï¼š
       * 1. ãƒ—ãƒ©ã‚¤ãƒãƒªCDNï¼ˆjsdelivrï¼‰ã§åˆæœŸåŒ–è©¦è¡Œ
       * 2. ã‚»ã‚«ãƒ³ãƒ€ãƒªCDNï¼ˆunpkgï¼‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
       * 3. ãƒ­ãƒ¼ã‚«ãƒ«è¾æ›¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œï¼‰
       * 4. ç°¡æ˜“tokenizerï¼ˆç·Šæ€¥ç”¨ï¼‰
       * 
       * å‡ºåŠ›ï¼š
       * - Promise<void>: åˆæœŸåŒ–å®Œäº†æ™‚ã«resolve
       * 
       * ã‚¨ãƒ©ãƒ¼å‡¦ç†ï¼š
       * - å…¨æ®µéšå¤±æ•—æ™‚ã¯ç°¡æ˜“tokenizerä½¿ç”¨
       * - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é©åˆ‡ãªçŠ¶æ³èª¬æ˜
       */
      async function initializeKuromojiWithFallback() {
        // é€²æ—è¡¨ç¤ºç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
        showKuromojiLoadingProgress();
        
        const fallbackSources = [
          {
            name: 'Primary CDN (jsdelivr)',
            displayName: 'é«˜é€ŸCDN (jsdelivr)',
            path: 'https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/',
            timeout: 30000 // å¤§å¹…ã«å»¶é•·: 8000ms â†’ 30000ms
          },
          {
            name: 'Secondary CDN (unpkg)',
            displayName: 'ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—CDN (unpkg)',
            path: 'https://unpkg.com/kuromoji@0.1.2/dict/',
            timeout: 25000 // èª¿æ•´: 10000ms â†’ 25000ms
          },
          {
            name: 'Tertiary CDN (cdnjs)',
            displayName: 'ä»£æ›¿CDN (cdnjs)',
            path: 'https://cdnjs.cloudflare.com/ajax/libs/kuromoji/0.1.2/dict/',
            timeout: 20000 // èª¿æ•´: 12000ms â†’ 20000ms
          }
        ];

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚­ãƒƒãƒ—ã—ãŸã‹ã©ã†ã‹ã®ãƒ•ãƒ©ã‚°
        let userSkipped = false;

        for (let i = 0; i < fallbackSources.length; i++) {
          if (userSkipped) {
            console.log('ğŸš€ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠ - kuromojiåˆæœŸåŒ–ã‚’ã‚¹ã‚­ãƒƒãƒ—');
            break;
          }

          const source = fallbackSources[i];
          console.log(`ğŸ”„ ${source.displayName} ã§è¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ä¸­...`);
          
          // é€²æ—ã‚’æ›´æ–°
          updateKuromojiLoadingProgress(i + 1, fallbackSources.length, source.displayName);
          
          try {
            await new Promise((resolve, reject) => {
              const timer = setTimeout(() => {
                reject(new Error(`æ¥ç¶šãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ (${Math.round(source.timeout/1000)}ç§’)`));
              }, source.timeout);
              
              kuromoji.builder({ dicPath: source.path }).build((err, tokenizer) => {
                clearTimeout(timer);
                if (err) {
                  console.warn(`âŒ ${source.displayName} å¤±æ•—:`, err.message);
                  return reject(new Error(`è¾æ›¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${err.message}`));
                }
                kuromojiTokenizer = tokenizer;
                console.log(`âœ… ${source.displayName} ã§è¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–æˆåŠŸ`);
                resolve();
              });
            });
            
            // æˆåŠŸæ™‚ã¯é€²æ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã¦å³åº§ã«è¿”ã™
            hideKuromojiLoadingProgress();
            showModal(`
              <h2 class="text-2xl font-bold text-green-400 mb-4">âœ… åˆæœŸåŒ–å®Œäº†</h2>
              <p>é«˜ç²¾åº¦è¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸã€‚</p>
              <p class="mt-2 text-sm text-gray-400">ä½¿ç”¨CDN: ${source.displayName}</p>
            `);
            setTimeout(() => { document.getElementById("modalContainer").style.display = "none"; }, 2000);
            return;
            
          } catch (error) {
            console.warn(`âš ï¸ ${source.displayName} åˆæœŸåŒ–å¤±æ•—:`, error.message);
            
            // æœ€å¾Œã®ã‚½ãƒ¼ã‚¹ä»¥å¤–ãªã‚‰æ¬¡ã‚’è©¦è¡Œ
            if (i < fallbackSources.length - 1) {
              updateKuromojiLoadingProgress(i + 1, fallbackSources.length, `${source.displayName} å¤±æ•— - æ¬¡ã®CDNã‚’è©¦è¡Œä¸­...`, true);
              await new Promise(resolve => setTimeout(resolve, 500)); // å°‘ã—å¾…æ©Ÿ
              continue;
            }
            
            // å…¨ã¦ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãŒå¤±æ•—ã—ãŸå ´åˆ
            console.error('âŒ å…¨ã¦ã®è¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ãŒå¤±æ•—ã—ã¾ã—ãŸ');
            hideKuromojiLoadingProgress();
            initializeSimpleTokenizer();
          }
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¹ã‚­ãƒƒãƒ—ã—ãŸå ´åˆã‚‚ã“ã“ã§ç°¡æ˜“ãƒ¢ãƒ¼ãƒ‰åˆæœŸåŒ–
        if (userSkipped) {
          hideKuromojiLoadingProgress();
          initializeSimpleTokenizer();
        }

        // ã‚¹ã‚­ãƒƒãƒ—ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ç”¨é–¢æ•°
        window.skipKuromojiAndUseSimpleMode = function() {
          userSkipped = true;
          hideKuromojiLoadingProgress();
          initializeSimpleTokenizer();
        };
      }

      /**
       * kuromojièª­ã¿è¾¼ã¿é€²æ—è¡¨ç¤ºUI
       * ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«åˆ†ã‹ã‚Šã‚„ã™ã„é€²æ—ã¨ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½ã‚’æä¾›
       */
      function showKuromojiLoadingProgress() {
        const progressHtml = `
          <div id="kuromojiProgressModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
            <div class="bg-gray-800 p-8 rounded-lg max-w-md w-full mx-4 border border-gray-600">
              <h2 class="text-2xl font-bold text-blue-400 mb-6 text-center">ğŸ§  AIè¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ä¸­</h2>
              
              <div class="mb-6">
                <div id="progressStatus" class="text-gray-300 mb-3 text-center">æ¥ç¶šæº–å‚™ä¸­...</div>
                <div class="w-full bg-gray-700 rounded-full h-3 mb-4">
                  <div id="progressBar" class="bg-blue-500 h-3 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
                </div>
                <div id="progressDetails" class="text-sm text-gray-400 text-center">
                  é«˜ç²¾åº¦ãªæ—¥æœ¬èªè§£æã®ãŸã‚ã€è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
                </div>
              </div>

              <div class="text-center">
                <button 
                  onclick="skipKuromojiAndUseSimpleMode()" 
                  class="px-6 py-3 bg-yellow-600 hover:bg-yellow-500 text-white font-semibold rounded-lg transition-colors duration-200 shadow-lg"
                >
                  âš¡ é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ã§é–‹å§‹
                </button>
                <div class="mt-2 text-xs text-gray-500">
                  â€»é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰ã§ã‚‚åŸºæœ¬çš„ãªæ©Ÿèƒ½ã¯å…¨ã¦åˆ©ç”¨ã§ãã¾ã™
                </div>
              </div>

              <div class="mt-6 p-3 bg-gray-700 rounded-lg">
                <div class="text-xs text-gray-400 space-y-1">
                  <div>â€¢ é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: é«˜ç²¾åº¦ãªæ—¥æœ¬èªè§£æï¼ˆæ¨å¥¨ï¼‰</div>
                  <div>â€¢ é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰: è»½é‡ãªè§£æã‚¨ãƒ³ã‚¸ãƒ³ã§å³åº§ã«é–‹å§‹</div>
                </div>
              </div>
            </div>
          </div>
        `;
        
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä¸€æ™‚çš„ã«éš ã™
        const existingModal = document.getElementById("modalContainer");
        if (existingModal) existingModal.style.display = "none";
        
        // é€²æ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¿½åŠ 
        document.body.insertAdjacentHTML('beforeend', progressHtml);
      }

      function updateKuromojiLoadingProgress(current, total, statusText, isError = false) {
        const progressBar = document.getElementById('progressBar');
        const progressStatus = document.getElementById('progressStatus');
        const progressDetails = document.getElementById('progressDetails');
        
        if (progressBar && progressStatus && progressDetails) {
          const percentage = (current / total) * 100;
          progressBar.style.width = `${percentage}%`;
          
          if (isError) {
            progressBar.className = 'bg-red-500 h-3 rounded-full transition-all duration-500 ease-out';
            progressStatus.textContent = `âš ï¸ ${statusText}`;
            progressDetails.textContent = 'åˆ¥ã®CDNã‚µãƒ¼ãƒãƒ¼ã§å†è©¦è¡Œã—ã¦ã„ã¾ã™...';
          } else {
            progressBar.className = 'bg-blue-500 h-3 rounded-full transition-all duration-500 ease-out';
            progressStatus.textContent = `ğŸ”„ ${statusText} (${current}/${total})`;
            progressDetails.textContent = `è¾æ›¸ãƒ‡ãƒ¼ã‚¿ã‚’${statusText}ã‹ã‚‰èª­ã¿è¾¼ã¿ä¸­...`;
          }
        }
      }

      function hideKuromojiLoadingProgress() {
        const progressModal = document.getElementById('kuromojiProgressModal');
        if (progressModal) {
          progressModal.remove();
        }
        
        // æ—¢å­˜ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’å¾©å…ƒ
        const existingModal = document.getElementById("modalContainer");
        if (existingModal) existingModal.style.display = "flex";
      }

      /**
       * ç°¡æ˜“tokenizeråˆæœŸåŒ–ï¼ˆç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
       * 
       * ç›®çš„ï¼š
       * - kuromojiå®Œå…¨å¤±æ•—æ™‚ã®æœ€å¾Œã®æ‰‹æ®µ
       * - åŸºæœ¬çš„ãªæ—¥æœ¬èªè§£ææ©Ÿèƒ½æä¾›
       * - ã‚·ã‚¹ãƒ†ãƒ å…¨ä½“ã®å¯ç”¨æ€§ç¢ºä¿
       */
      function initializeSimpleTokenizer() {
        console.log('ğŸš¨ ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç°¡æ˜“tokenizer ã‚’åˆæœŸåŒ–');
        
        // ç°¡æ˜“tokenizerå®Ÿè£…
        kuromojiTokenizer = {
          tokenize: (text) => {
            // åŸºæœ¬çš„ãªæ–‡å­—åˆ†å‰²ã¨å“è©æ¨å®š
            const tokens = [];
            const words = text.match(/[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\w]+/g) || [];
            
            words.forEach(word => {
              let pos = 'åè©'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
              
              // ç°¡æ˜“å“è©åˆ¤å®š
              if (/ã‚‹$|ãŸ$|ã¾ã™$|ã§ã™$/.test(word)) pos = 'å‹•è©';
              else if (/ã„$|ãª$/.test(word)) pos = 'å½¢å®¹è©';
              else if (/ã‚’$|ãŒ$|ã«$|ã§$|ã¨$/.test(word)) pos = 'åŠ©è©';
              
              tokens.push({
                surface_form: word,
                basic_form: word,
                pos: pos,
                pos_detail_1: 'general'
              });
            });
            
            return tokens;
          },
          isSimple: true // ç°¡æ˜“ç‰ˆãƒ•ãƒ©ã‚°
        };
        
        showModal(`
          <h2 class="text-2xl font-bold text-green-400 mb-4">âš¡ é«˜é€Ÿãƒ¢ãƒ¼ãƒ‰èµ·å‹•å®Œäº†</h2>
          <p class="text-lg mb-3">è»½é‡ãªè¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³ã§å‹•ä½œã‚’é–‹å§‹ã—ã¾ã—ãŸã€‚</p>
          <div class="bg-green-900 bg-opacity-30 border border-green-600 rounded-lg p-4 mb-4">
            <h3 class="text-green-300 font-semibold mb-2">âœ… åˆ©ç”¨å¯èƒ½ãªæ©Ÿèƒ½</h3>
            <ul class="text-sm text-gray-300 space-y-1">
              <li>â€¢ æœªæ¥äºˆæ¸¬åˆ†æ</li>
              <li>â€¢ ãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸææ¡ˆ</li>
              <li>â€¢ å¿ƒç†çŠ¶æ…‹ã®åˆ†æ</li>
              <li>â€¢ å…·ä½“çš„ãªè¡Œå‹•æŒ‡é‡</li>
            </ul>
          </div>
          <p class="text-sm text-gray-400">
            â€»é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜ç²¾åº¦ã®åˆ†æçµæœã‚’æä¾›ã—ã¾ã™
          </p>
        `);
      }

      /**
       * 90%æˆåŠŸç‡ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ - å®Ÿè£…å“è³ªæ¤œè¨¼
       * 
       * ç›®çš„ï¼š
       * - å®Ÿè£…ã—ãŸæ”¹å–„æ©Ÿèƒ½ã®å‹•ä½œç¢ºèª
       * - æˆåŠŸç‡å‘ä¸Šã®æ¤œè¨¼
       * - ã‚·ã‚¹ãƒ†ãƒ å¥å…¨æ€§ãƒã‚§ãƒƒã‚¯
       */
      window.test90PercentSuccessRate = async function() {
        console.log('ğŸ§ª 90%æˆåŠŸç‡ãƒ†ã‚¹ãƒˆé–‹å§‹');
        
        const testResults = {
          kuromojiTest: false,
          dataIntegrityTest: false,
          fallbackTest: false,
          analysisEngineTest: false,
          overallScore: 0
        };
        
        try {
          // Test 1: kuromojiåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
          console.log('Test 1: kuromojiåˆæœŸåŒ–ç¢ºèª');
          testResults.kuromojiTest = !!kuromojiTokenizer;
          if (testResults.kuromojiTest) {
            console.log('âœ… kuromojiæ­£å¸¸: ' + (kuromojiTokenizer.isSimple ? 'ç°¡æ˜“ç‰ˆ' : 'å®Œå…¨ç‰ˆ'));
          } else {
            console.log('âŒ kuromojiæœªåˆæœŸåŒ–');
          }
          
          // Test 2: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ
          console.log('Test 2: ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª');
          testResults.dataIntegrityTest = !!(window.H384_DATA && Array.isArray(window.H384_DATA) && window.H384_DATA.length === 386);
          console.log(testResults.dataIntegrityTest ? 'âœ… H384_DATAæ­£å¸¸' : 'âŒ H384_DATAã‚¨ãƒ©ãƒ¼');
          
          // Test 3: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
          console.log('Test 3: ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ç¢ºèª');
          testResults.fallbackTest = !!(typeof initializeSimpleTokenizer === 'function' && typeof initializeKuromojiWithFallback === 'function');
          console.log(testResults.fallbackTest ? 'âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½å®Ÿè£…æ¸ˆã¿' : 'âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½æœªå®Ÿè£…');
          
          // Test 4: çµ±åˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³ãƒ†ã‚¹ãƒˆ
          console.log('Test 4: çµ±åˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³ç¢ºèª');
          testResults.analysisEngineTest = !!(window.IntegratedAnalysisEngine && integratedEngine);
          console.log(testResults.analysisEngineTest ? 'âœ… çµ±åˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³æ­£å¸¸' : 'âŒ çµ±åˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã‚¨ãƒ©ãƒ¼');
          
          // ç·åˆã‚¹ã‚³ã‚¢è¨ˆç®—
          const passedTests = Object.values(testResults).filter(result => result === true).length;
          testResults.overallScore = Math.round((passedTests / 4) * 100);
          
          console.log(`ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ: ${testResults.overallScore}% (${passedTests}/4ãƒ†ã‚¹ãƒˆé€šé)`);
          
          if (testResults.overallScore >= 90) {
            console.log('ğŸ‰ 90%æˆåŠŸç‡å®Ÿç¾ã®æº–å‚™å®Œäº†ï¼');
            showModal(`
              <h2 class="text-2xl font-bold text-green-400 mb-4">ğŸ‰ å“è³ªãƒ†ã‚¹ãƒˆå®Œäº†</h2>
              <p>90%æˆåŠŸç‡å®Ÿç¾ã®ãŸã‚ã®å®Ÿè£…ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚</p>
              <p class="mt-2 text-sm text-gray-400">ãƒ†ã‚¹ãƒˆã‚¹ã‚³ã‚¢: ${testResults.overallScore}%</p>
            `);
          } else {
            console.warn(`âš ï¸ æ”¹å–„å¿…è¦: ${testResults.overallScore}% (ç›®æ¨™: 90%)`);
          }
          
          return testResults;
          
        } catch (error) {
          console.error('âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
          return { error: error.message, overallScore: 0 };
        }
      };

      // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±åˆã‚¯ãƒ©ã‚¹
      class FutureSimulatorErrorHandler {
        static classifyError(error) {
          if (!error) return 'UNKNOWN_ERROR';
          
          const message = error.message || error.toString();
          
          if (message.includes('kuromoji') || message.includes('tokenizer')) {
            return 'TOKENIZER_ERROR';
          } else if (message.includes('H384_DATA') || message.includes('futureThemeMap')) {
            return 'DATA_ERROR';
          } else if (message.includes('IntegratedAnalysisEngine') || message.includes('performIntegratedAnalysis')) {
            return 'ANALYSIS_ENGINE_ERROR';
          } else if (message.includes('network') || message.includes('fetch')) {
            return 'NETWORK_ERROR';
          } else if (message.includes('memory') || message.includes('allocation')) {
            return 'MEMORY_ERROR';
          } else {
            return 'GENERAL_ERROR';
          }
        }

        static generateFallbackResult(contextType, error, errorType) {
          const fallbackHexagram = {
            emotion_management: { hexagram: 31, line: 2, name: 'æ²¢å±±å’¸', theme: 'æ„Ÿæƒ…ã®èª¿æ•´ã¨å®‰å®š' },
            personal: { hexagram: 3, line: 1, name: 'æ°´é›·å±¯', theme: 'æ–°ã—ã„å§‹ã¾ã‚Šã¸ã®æº–å‚™' },
            social: { hexagram: 8, line: 1, name: 'æ°´åœ°æ¯”', theme: 'å”èª¿ã¨é€£å¸¯' },
            relationship: { hexagram: 31, line: 1, name: 'æ²¢å±±å’¸', theme: 'ç›¸äº’ç†è§£ã¸ã®é“' },
            business: { hexagram: 5, line: 1, name: 'æ°´å¤©éœ€', theme: 'æ™‚ã‚’å¾…ã¤çŸ¥æµ' },
            philosophical: { hexagram: 4, line: 1, name: 'å±±æ°´è’™', theme: 'å­¦ã³ã®å§‹ã¾ã‚Š' },
            technical: { hexagram: 32, line: 1, name: 'é›·é¢¨æ’', theme: 'ç¶™ç¶šçš„æ”¹å–„' },
            temporal: { hexagram: 49, line: 1, name: 'æ²¢ç«é©', theme: 'å¤‰åŒ–ã¸ã®é©å¿œ' },
            hybrid: { hexagram: 64, line: 1, name: 'ç«æ°´æœªæ¸ˆ', theme: 'æœªå®Œæˆã¸ã®å¸Œæœ›' },
            entrepreneur: { hexagram: 3, line: 1, name: 'æ°´é›·å±¯', theme: 'äº‹æ¥­å‰µå‡ºã®å›°é›£ã¨å¸Œæœ›' }
          };

          const errorMessages = {
            TOKENIZER_ERROR: 'è¨€èªè§£æã‚·ã‚¹ãƒ†ãƒ ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ',
            DATA_ERROR: 'ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ',
            ANALYSIS_ENGINE_ERROR: 'åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ',
            NETWORK_ERROR: 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ',
            MEMORY_ERROR: 'ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚½ãƒ¼ã‚¹ã«å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ',
            GENERAL_ERROR: 'ã‚·ã‚¹ãƒ†ãƒ ã«ä¸€æ™‚çš„ãªå•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ'
          };

          const fallback = fallbackHexagram[contextType] || fallbackHexagram.personal;
          const contextName = ENHANCED_CONTEXT_TYPES[contextType]?.name || contextType;
          const errorMessage = errorMessages[errorType] || errorMessages.GENERAL_ERROR;

          // H384_DATAã‹ã‚‰å¯¾å¿œã™ã‚‹lineDataã‚’å–å¾—
          let lineData = null;
          if (window.H384_DATA && Array.isArray(window.H384_DATA)) {
            lineData = window.H384_DATA.find(data => 
              data.å¦ç•ªå· === fallback.hexagram && data.çˆ»ç•ªå· === fallback.line
            );
          }
          
          // lineDataãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if (!lineData) {
            lineData = {
              å¦ç•ªå·: fallback.hexagram,
              çˆ»ç•ªå·: fallback.line,
              "è¦ªã¨ãªã‚‹å¦": fallback.name,
              "çˆ»": `${fallback.line}çˆ»`,
              "çˆ»è¾": fallback.theme
            };
          }

          // æ­£å¸¸ãªåˆ†æçµæœã¨åŒã˜æ§‹é€ ã®matchDetailsã‚’ç”Ÿæˆ
          const matchDetails = {
            keywordMatches: [],
            patternMatches: [],
            semanticMatches: [],
            contextMatches: [],
            dynamicMatches: []
          };

          const reasoningText = `
            <div class="bg-yellow-900/20 border border-yellow-600/30 p-3 rounded-lg mb-3">
              <h4 class="text-yellow-400 font-medium mb-2">âš ï¸ ã‚·ã‚¹ãƒ†ãƒ é€šçŸ¥</h4>
              <p class="text-sm text-gray-300">${errorMessage}ãŒã€åŸºæœ¬çš„ãªåˆ†æã‚’æä¾›ã„ãŸã—ã¾ã™ã€‚</p>
            </div>
            ğŸ“Š ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ: ${contextName}<br>
            ç¾åœ¨ã®çŠ¶æ³ã¯ã€Œ<strong>${fallback.theme}</strong>ã€ã®è¦³ç‚¹ã‹ã‚‰ç†è§£ã§ãã¾ã™ã€‚<br>
            <small class="text-yellow-400">ğŸ”„ ã‚·ã‚¹ãƒ†ãƒ å¾©æ—§å¾Œã«ã‚ˆã‚Šè©³ç´°ãªåˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™</small>
          `;

          // çµ±ä¸€ã•ã‚ŒãŸæ§‹é€ ã§è¿”ã™ï¼ˆIntegratedAnalysisEngine.generateFallbackResultã¨åŒã˜ï¼‰
          return {
            å¦ç•ªå·: fallback.hexagram,        // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
            çˆ»ç•ªå·: fallback.line,             // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
            hexagram: fallback.hexagram,      // æ–°æ§‹é€ 
            line: fallback.line,              // æ–°æ§‹é€ 
            confidence: 0.4,
            score: 0,
            method: "fallback_error_handler",
            lineData: lineData,
            contextType: contextType,
            matchDetails: matchDetails,
            expandedKeywords: [],
            reasoning: reasoningText,
            alternatives: [],
            æ ¹æ‹ : reasoningText,               // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
            ä¿¡é ¼åº¦: 0.4,                      // å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚
            è§£èª¬: `${fallback.name}ã«ã‚ˆã‚‹åŸºæœ¬çš„ãªçŠ¶æ³ç†è§£: ${fallback.theme}ã®å±€é¢ã¨ã—ã¦æ‰ãˆã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚`,
            analysisResult: {
              method: 'fallback',
              contextType: contextType,
              error: errorType,
              errorMessage: error.message
            }
          };
        }

        static logError(error, context) {
          const errorType = this.classifyError(error);
          console.error('ğŸš¨ Future Simulator ã‚¨ãƒ©ãƒ¼è©³ç´°:', {
            errorType,
            message: error.message,
            stack: error.stack,
            context,
            timestamp: new Date().toISOString()
          });
        }
      }

      async function callAIAssistant(worryText, h384Data, futureThemeMap, contextType = 'personal') {
        // Phase 1: åŸºæœ¬çš„ãªå‰ææ¡ä»¶ãƒã‚§ãƒƒã‚¯
        try {
          // kuromoji.jsãƒˆãƒ¼ã‚¯ãƒŠã‚¤ã‚¶ãƒ¼ã®ç¢ºèª
          if (!kuromojiTokenizer) { 
            showModal(`<h2 class="text-2xl font-bold text-yellow-400 mb-4">ğŸ”„ AIæº–å‚™ä¸­</h2><p>AIã®è¨€èªè§£æã‚¨ãƒ³ã‚¸ãƒ³ã®æº–å‚™ãŒã¾ã å®Œäº†ã—ã¦ã„ã¾ã›ã‚“ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>`); 
            return FutureSimulatorErrorHandler.generateFallbackResult(contextType, new Error('kuromojiæœªåˆæœŸåŒ–'), 'TOKENIZER_ERROR');
          }

          // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèªï¼ˆ90%æˆåŠŸç‡å¯¾å¿œå¼·åŒ–ï¼‰
          if (!h384Data || !Array.isArray(h384Data) || h384Data.length === 0) {
            console.warn('H384_DATAãŒç„¡åŠ¹ã¾ãŸã¯ç©ºã§ã™ - ç·Šæ€¥ãƒ‡ãƒ¼ã‚¿å¾©æ—§è©¦è¡Œ');
            
            // ç·Šæ€¥ãƒ‡ãƒ¼ã‚¿å¾©æ—§å‡¦ç†
            if (typeof window.ensureH384Data === 'function') {
              try {
                const recoveredData = window.ensureH384Data();
                if (recoveredData && Array.isArray(recoveredData) && recoveredData.length === 386) {
                  console.log('âœ… ãƒ‡ãƒ¼ã‚¿å¾©æ—§æˆåŠŸ - å‡¦ç†ã‚’ç¶™ç¶š');
                  h384Data = recoveredData;
                } else {
                  throw new Error('å¾©æ—§ãƒ‡ãƒ¼ã‚¿ã‚‚ç„¡åŠ¹');
                }
              } catch (recoveryError) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿å¾©æ—§ã‚‚å¤±æ•—:', recoveryError);
                return FutureSimulatorErrorHandler.generateFallbackResult(contextType, new Error('H384_DATAå®Œå…¨å¤±æ•—'), 'DATA_ERROR');
              }
            } else {
              return FutureSimulatorErrorHandler.generateFallbackResult(contextType, new Error('H384_DATAç„¡åŠ¹'), 'DATA_ERROR');
            }
          }

          if (!futureThemeMap || !(futureThemeMap instanceof Map)) {
            console.warn('futureThemeMapãŒç„¡åŠ¹ã§ã™');
            return FutureSimulatorErrorHandler.generateFallbackResult(contextType, new Error('futureThemeMapç„¡åŠ¹'), 'DATA_ERROR');
          }

          // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®å¦¥å½“æ€§ç¢ºèª
          if (!worryText || typeof worryText !== 'string' || worryText.trim().length === 0) {
            return FutureSimulatorErrorHandler.generateFallbackResult(contextType, new Error('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆãŒç„¡åŠ¹'), 'GENERAL_ERROR');
          }

        } catch (error) {
          FutureSimulatorErrorHandler.logError(error, 'pre-processing');
          return FutureSimulatorErrorHandler.generateFallbackResult(contextType, error, 'GENERAL_ERROR');
        }

        // Phase 2: çµ±åˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
        try {
          if (!integratedEngine) {
            console.log('ğŸš€ çµ±åˆåˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ä¸­...');
            integratedEngine = new IntegratedAnalysisEngine(kuromojiTokenizer);
          }
        } catch (error) {
          FutureSimulatorErrorHandler.logError(error, 'engine-initialization');
          return FutureSimulatorErrorHandler.generateFallbackResult(contextType, error, 'ANALYSIS_ENGINE_ERROR');
        }

        // Phase 3: çµ±åˆåˆ†æå®Ÿè¡Œ
        try {
          console.log('ğŸ¯ çµ±åˆåˆ†æé–‹å§‹:', { textLength: worryText.length, contextType });

          // çµ±åˆåˆ†æã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆä»˜ãï¼‰
          const analysisPromise = integratedEngine.performSevenStageAnalysis(
            worryText, contextType
          );

          // æ”¹å–„ç‰ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆ90%æˆåŠŸç‡å¯¾å¿œï¼‰
          const timeoutPromise = new Promise((_, reject) => {
            // æ®µéšçš„ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: ã‚ˆã‚Šé©åˆ‡ãªæ™‚é–“è¨­å®š
            setTimeout(() => reject(new Error('åˆ†æå‡¦ç†ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„')), 20000);
          });

          const analysisResult = await Promise.race([analysisPromise, timeoutPromise]);

          if (!analysisResult || !analysisResult.finalResult) {
            console.warn('çµ±åˆåˆ†æçµæœãªã—ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†');
            return FutureSimulatorErrorHandler.generateFallbackResult(contextType, new Error('åˆ†æçµæœãªã—'), 'ANALYSIS_ENGINE_ERROR');
          }

          // 7æ®µéšåˆ†æçµæœã‹ã‚‰å¿…è¦ãªæƒ…å ±ã‚’æŠ½å‡º
          const hexagram = analysisResult.finalResult.hexagram;
          const lineNumber = analysisResult.finalResult.line;
          const confidence = analysisResult.finalResult.confidence || 0.3;
          const confidencePercent = Math.round(confidence * 100);
          
          // H384_DATAã‹ã‚‰è©²å½“ã™ã‚‹è¡Œã‚’æ¤œç´¢
          const line = h384Data.find(item => 
            item.å¦ç•ªå· === hexagram && item.çˆ»ç•ªå· === lineNumber
          );
          
          if (!line) {
            console.warn('è©²å½“ã™ã‚‹å¦ãƒ»çˆ»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', { hexagram, lineNumber });
            return FutureSimulatorErrorHandler.generateFallbackResult(contextType, new Error('å¦çˆ»ãƒ‡ãƒ¼ã‚¿ãªã—'), 'DATA_ERROR');
          }
          
          // ä¿¡é ¼åº¦ãƒ¬ãƒ™ãƒ«ã¨ã‚«ãƒ©ãƒ¼åˆ¤å®š
          let confidenceLevel, confidenceColor;
          if (confidence >= 0.8) {
            confidenceLevel = "é«˜";
            confidenceColor = "text-green-400";
          } else if (confidence >= 0.6) {
            confidenceLevel = "ä¸­";  
            confidenceColor = "text-yellow-400";
          } else {
            confidenceLevel = "ä½";
            confidenceColor = "text-red-400";
          }

          // UXæ”¹å–„: è©³ç´°æ ¹æ‹ æƒ…å ±ã®ç”Ÿæˆ
          let contextInfo = analysisResult.finalResult.reasoning || "";
          
          // 7æ®µéšåˆ†æã®è©³ç´°æƒ…å ±ã‚’è¡¨ç¤º
          let stageAnalysisInfo = "";
          if (analysisResult.stageResults) {
            const stages = analysisResult.stageResults;
            
            // æ„Ÿæƒ…åˆ†æçµæœ
            const emotionalAnalysis = stages.stage3?.emotionalContext;
            const emotionalInfo = emotionalAnalysis ? 
              `æ„Ÿæƒ…: ${emotionalAnalysis.primary || 'ä¸­ç«‹'} (å¼·åº¦: ${Math.round((emotionalAnalysis.intensity || 0) * 100)}%)` : '';
            
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºçµæœ
            const keywords = stages.stage3?.keywords?.slice(0, 5).map(k => k.keyword).join(', ') || '';
            
            // Triple OSçµ±åˆçµæœ
            const osImpacts = stages.stage5?.osImpacts;
            const osInfo = osImpacts ? `
              <div class="text-xs mt-2">
                <span class="text-yellow-300">ä¾¡å€¤è¦³ã‚·ã‚¹ãƒ†ãƒ : ${Math.round(osImpacts.engineOS * 100)}%</span> | 
                <span class="text-blue-300">ç¤¾ä¼šçš„ã‚·ã‚¹ãƒ†ãƒ : ${Math.round(osImpacts.interfaceOS * 100)}%</span> | 
                <span class="text-red-300">é˜²å¾¡ã‚·ã‚¹ãƒ†ãƒ : ${Math.round(osImpacts.safeModeOS * 100)}%</span>
              </div>
            ` : '';
            
            stageAnalysisInfo = `
              <div class="mt-3 p-3 bg-gray-800/50 border border-gray-600 rounded-lg text-sm">
                <h4 class="text-indigo-400 font-medium mb-2">ğŸ”¬ è©³ç´°åˆ†ææƒ…å ±</h4>
                <div class="text-gray-300 space-y-1">
                  ${emotionalInfo ? `<p>â€¢ ${emotionalInfo}</p>` : ''}
                  ${keywords ? `<p>â€¢ ä¸»è¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keywords}</p>` : ''}
                  ${osInfo}
                </div>
              </div>
            `;
          }
          
          // ä»£æ›¿å€™è£œã®è¡¨ç¤ºï¼ˆæ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°ã‹ã‚‰ï¼‰
          let alternativesInfo = "";
          const hexagramCandidates = analysisResult.stageResults?.stage3?.hexagramCandidates;
          if (hexagramCandidates && hexagramCandidates.length > 1) {
            const altList = hexagramCandidates.slice(1, 4).map(candidate => {
              const altLine = h384Data.find(item => item.å¦ç•ªå· === candidate.hexagram);
              if (altLine) {
                return `<li class="text-sm">ğŸ”® ${altLine["è¦ªã¨ãªã‚‹å¦"]} (ä¿¡é ¼åº¦: ${Math.round(candidate.confidence * 100)}%) - ${candidate.reason}</li>`;
              }
              return null;
            }).filter(item => item !== null).join('');
            
            if (altList) {
              alternativesInfo = `
                <div class="mt-3 p-3 bg-gray-800/50 border border-gray-600 rounded-lg">
                  <h4 class="text-blue-400 font-medium mb-2">ğŸ’¡ ä»£æ›¿å€™è£œ</h4>
                  <ul class="text-gray-300 space-y-1">${altList}</ul>
                </div>
              `;
            }
          }

          // çµ±åˆåˆ†ææƒ…å ±ã®ç”Ÿæˆ
          const themeData = futureThemeMap[line.é€šã—ç•ªå·];
          const mainTheme = themeData?.main_theme || "çŠ¶æ³ã®ç†è§£";
          const contextName = ENHANCED_CONTEXT_TYPES[analysisResult.contextType]?.name || analysisResult.contextType;

          // çµ±åˆåˆ†æã«åŸºã¥ãè©³ç´°æ ¹æ‹ 
          const reasoning = `
            ã€ğŸ¯ 7æ®µéšçµ±åˆåˆ†æçµæœã€‘<br>
            ${contextInfo}<br>
            ğŸ“Š åˆ†æãƒ—ãƒ­ã‚»ã‚¹: å‰å‡¦ç†â†’å½¢æ…‹ç´ è§£æâ†’ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºâ†’æ„Ÿæƒ…åˆ†æâ†’Triple OSçµ±åˆâ†’æ˜“çµŒãƒãƒƒãƒ”ãƒ³ã‚°â†’çµ±åˆçµæœç”Ÿæˆ<br>
            ã”å…¥åŠ›ã„ãŸã ã„ãŸçŠ¶æ³ã¯ã€<strong>${line["è¦ªã¨ãªã‚‹å¦"]} ${line.çˆ»}</strong>ã®ã€Œ<strong>${mainTheme}</strong>ã€ã¨ã—ã¦åˆ†æã•ã‚Œã¾ã—ãŸã€‚<br>
            <small class="${confidenceColor}">ğŸ” åˆ†æä¿¡é ¼åº¦: ${confidenceLevel} (${confidencePercent}%)</small><br>
            <small class="text-gray-400">â±ï¸ å‡¦ç†æ™‚é–“: ${Math.round(analysisResult.qualityMetrics.processingTime)}ms</small>
            ${stageAnalysisInfo}
            ${alternativesInfo}
          `;

          // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãƒ­ã‚°å‡ºåŠ›
          console.log('âœ… 7æ®µéšçµ±åˆåˆ†æå®Œäº†:', {
            hexagram: hexagram,
            line: lineNumber,
            confidence: confidencePercent,
            stages: Object.keys(analysisResult.stageResults).length,
            processingTime: analysisResult.qualityMetrics.processingTime,
            emotionalState: analysisResult.stageResults?.stage3?.emotionalContext?.primary,
            tripleOS: analysisResult.stageResults?.stage5?.osImpacts
          });

          // Phase 4: çµæœå‡¦ç†ã¨è¿”å´
          return {
            å¦ç•ªå·: line.å¦ç•ªå·,
            çˆ»ç•ªå·: lineNumber,
            æ ¹æ‹ : reasoning,
            ä¿¡é ¼åº¦: confidence,
            è§£èª¬: `ğŸ”® 7æ®µéšçµ±åˆåˆ†æã«ã‚ˆã‚‹çŠ¶æ³ç†è§£: ${mainTheme}ã®å±€é¢ã«ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚`,
            analysisResult: analysisResult // 7æ®µéšçµ±åˆåˆ†æã®å®Œå…¨çµæœ
          };

        } catch (error) {
          // åŒ…æ‹¬çš„ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
          FutureSimulatorErrorHandler.logError(error, 'analysis-execution');
          const errorType = FutureSimulatorErrorHandler.classifyError(error);
          return FutureSimulatorErrorHandler.generateFallbackResult(contextType, error, errorType);
        }
      }

        // ã‚¨ãƒ“ãƒ‡ãƒ³ã‚¹è©³ç´°è¡¨ç¤ºã®åˆ‡ã‚Šæ›¿ãˆ
        window.toggleDetailedEvidence = function() {
          const detailsDiv = document.getElementById('detailed-evidence');
          const button = event.target;
          
          if (detailsDiv && button) {
            if (detailsDiv.classList.contains('hidden')) {
              detailsDiv.classList.remove('hidden');
              button.textContent = 'è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’éè¡¨ç¤º â–²';
            } else {
              detailsDiv.classList.add('hidden');
              button.textContent = 'è©³ç´°ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º â–¼';
            }
          }
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å‡¦ç†çŠ¶æ³è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 
        let processingStatusContainer = null;
        let currentProcessingSteps = [];

        window.showProcessingStatus = function(step, status, details) {
          // å‡¦ç†çŠ¶æ³è¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
          if (!processingStatusContainer) {
            processingStatusContainer = document.createElement('div');
            processingStatusContainer.id = 'processing-status-container';
            processingStatusContainer.className = 'processing-status mb-4';
            processingStatusContainer.innerHTML = `
              <div class="flex items-center mb-2">
                <div class="processing-spinner mr-2"></div>
                <h4 class="text-blue-400 font-medium">é«˜åº¦åˆ†æå‡¦ç†ä¸­...</h4>
              </div>
              <div id="processing-steps" class="space-y-2"></div>
            `;
            
            // aiReasoningContainerã®å‰ã«æŒ¿å…¥
            const reasoningContainer = document.getElementById('aiReasoningContainer');
            if (reasoningContainer && reasoningContainer.parentNode) {
              reasoningContainer.parentNode.insertBefore(processingStatusContainer, reasoningContainer);
            }
          }

          // ã‚¹ãƒ†ãƒƒãƒ—ã‚’è¿½åŠ /æ›´æ–°
          addProcessingStep(step, status, details);
        };

        function addProcessingStep(step, status, details) {
          const stepsContainer = document.getElementById('processing-steps');
          if (!stepsContainer) return;

          // æ—¢å­˜ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
          let stepElement = document.getElementById(`step-${step.replace(/\s+/g, '-')}`);
          
          if (!stepElement) {
            stepElement = document.createElement('div');
            stepElement.id = `step-${step.replace(/\s+/g, '-')}`;
            stepElement.className = 'processing-step flex items-center text-xs';
            stepsContainer.appendChild(stepElement);
          }

          // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã¨ã‚¹ã‚¿ã‚¤ãƒ«
          let icon, colorClass;
          switch (status) {
            case 'processing':
              icon = '<div class="w-3 h-3 border border-blue-400 border-t-transparent rounded-full animate-spin mr-2"></div>';
              colorClass = 'text-blue-400';
              break;
            case 'completed':
              icon = '<svg class="w-3 h-3 mr-2 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
              colorClass = 'text-green-400';
              break;
            case 'skipped':
              icon = '<svg class="w-3 h-3 mr-2 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
              colorClass = 'text-yellow-400';
              break;
            case 'error':
              icon = '<svg class="w-3 h-3 mr-2 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
              colorClass = 'text-red-400';
              break;
            default:
              icon = '<div class="w-3 h-3 mr-2 bg-gray-400 rounded-full"></div>';
              colorClass = 'text-gray-400';
          }

          stepElement.innerHTML = `
            ${icon}
            <span class="${colorClass}">
              <strong>${step}</strong>
              ${details ? `<span class="text-gray-400 ml-1">- ${details}</span>` : ''}
            </span>
          `;

          // å®Œäº†æ™‚ã«ã¯å‡¦ç†çŠ¶æ³è¡¨ç¤ºã‚’è‡ªå‹•ã§éš ã™ï¼ˆ3ç§’å¾Œï¼‰
          if (status === 'completed' && step === 'åˆ†æå®Œäº†') {
            setTimeout(() => {
              if (processingStatusContainer) {
                processingStatusContainer.style.opacity = '0';
                processingStatusContainer.style.transform = 'translateY(-10px)';
                setTimeout(() => {
                  if (processingStatusContainer && processingStatusContainer.parentNode) {
                    processingStatusContainer.parentNode.removeChild(processingStatusContainer);
                    processingStatusContainer = null;
                  }
                }, 300);
              }
            }, 3000);
          }
        }

        window.clearProcessingStatus = function() {
          if (processingStatusContainer && processingStatusContainer.parentNode) {
            processingStatusContainer.parentNode.removeChild(processingStatusContainer);
            processingStatusContainer = null;
          }
          currentProcessingSteps = [];
        };

        // ===== ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ  =====
        
        /**
         * åŒ¿åãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡
         * @param {string} rating - 'accurate', 'somewhat', 'inaccurate'
         * @param {object} analysisData - åˆ†æçµæœãƒ‡ãƒ¼ã‚¿
         */
        window.submitFeedback = function(rating, analysisData) {
          try {
            // æ©Ÿæ¢°å­¦ç¿’ç”¨ã®è©³ç´°ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆ90%æˆåŠŸç‡ç›£è¦–å¼·åŒ–ï¼‰
            const feedbackData = {
              timestamp: Date.now(),
              rating: rating,
              confidence: analysisData.analysisEvidence?.confidence_breakdown?.combined || 0,
              processing_method: analysisData.analysisEvidence?.processing_methods?.join('+') || 'local',
              input_length: analysisData.worry?.length || 0,
              hexagram: analysisData.startState?.['è¦ªã¨ãªã‚‹å¦'] || 'unknown',
              hexagram_number: analysisData.startState?.å¦ç•ªå· || 0,
              // 90%æˆåŠŸç‡ç›£è¦–ç”¨ã®è¿½åŠ ãƒ‡ãƒ¼ã‚¿
              tokenizer_type: kuromojiTokenizer?.isSimple ? 'simple_fallback' : 'full_kuromoji',
              error_recovered: analysisData.analysisResult?.errorRecovered || false,
              fallback_used: analysisData.analysisResult?.fallbackUsed || false,
              line: analysisData.startState?.çˆ» || 'unknown',
              line_number: analysisData.startState?.çˆ»ç•ªå· || 0,
              
              // æ©Ÿæ¢°å­¦ç¿’ç”¨ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿
              ml_training_data: {
                // å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®ç‰¹å¾´ï¼ˆåŒ¿ååŒ–æ¸ˆã¿ï¼‰
                input_features: {
                  char_count: analysisData.worry?.length || 0,
                  word_count: analysisData.worry?.split(/\s+/).length || 0,
                  sentiment_indicators: extractSentimentIndicators(analysisData.worry || ''),
                  emotional_keywords: extractEmotionalKeywords(analysisData.worry || ''),
                  context_type: analysisData.analysisEvidence?.context_analysis || 'unknown',
                  complexity_score: calculateTextComplexity(analysisData.worry || '')
                },
                
                // åˆ†æçµæœã®ç‰¹å¾´
                analysis_features: {
                  method: analysisData.analysisEvidence?.processing_methods || [],
                  confidence_breakdown: analysisData.analysisEvidence?.confidence_breakdown || {},
                  keyword_matches: analysisData.analysisEvidence?.keyword_extraction || [],
                  detected_themes: analysisData.analysisEvidence?.detected_themes || [],
                  context_confidence: analysisData.analysisEvidence?.context_confidence || 0
                },
                
                // æ˜“çµŒçš„åˆ¤å®šã®ç‰¹å¾´
                iching_features: {
                  hexagram_category: getHexagramCategory(analysisData.startState?.å¦ç•ªå·),
                  element_analysis: getElementAnalysis(analysisData.startState?.å¦ç•ªå·),
                  situation_type: getSituationType(analysisData.startState?.å¦ç•ªå·),
                  recommended_action: getRecommendedAction(analysisData.startState?.å¦ç•ªå·)
                }
              },
              
              // å€‹äººæƒ…å ±ã¯ä¸€åˆ‡å«ã‚ãªã„
              session_id: generateSessionId()
            };

            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’è“„ç©
            const existingFeedback = JSON.parse(localStorage.getItem('community_feedback') || '[]');
            existingFeedback.push(feedbackData);
            
            // æœ€æ–°1000ä»¶ã®ã¿ä¿æŒ
            if (existingFeedback.length > 1000) {
              existingFeedback.splice(0, existingFeedback.length - 1000);
            }
            
            localStorage.setItem('community_feedback', JSON.stringify(existingFeedback));

            // é›†è¨ˆãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            updateFeedbackStats(rating, feedbackData);

            // UIãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯è¡¨ç¤º
            showFeedbackResult(rating);

            // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            disableFeedbackButtons();

            console.log('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡å®Œäº†:', feedbackData);

          } catch (error) {
            console.error('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯é€ä¿¡ã‚¨ãƒ©ãƒ¼:', error);
            showFeedbackResult('error');
          }
        };

        function generateSessionId() {
          // ä¸€æ„ã ãŒå€‹äººç‰¹å®šä¸å¯èƒ½ãªã‚»ãƒƒã‚·ãƒ§ãƒ³IDç”Ÿæˆ
          return 'session_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function updateFeedbackStats(rating, feedbackData) {
          try {
            const stats = JSON.parse(localStorage.getItem('feedback_stats') || '{}');
            
            // å…¨ä½“çµ±è¨ˆ
            stats.total = (stats.total || 0) + 1;
            stats.ratings = stats.ratings || { accurate: 0, somewhat: 0, inaccurate: 0 };
            stats.ratings[rating] = (stats.ratings[rating] || 0) + 1;
            
            // å¦åˆ¥çµ±è¨ˆ
            stats.by_hexagram = stats.by_hexagram || {};
            const hexagramKey = feedbackData.hexagram;
            if (!stats.by_hexagram[hexagramKey]) {
              stats.by_hexagram[hexagramKey] = { accurate: 0, somewhat: 0, inaccurate: 0, total: 0 };
            }
            stats.by_hexagram[hexagramKey][rating]++;
            stats.by_hexagram[hexagramKey].total++;
            
            // å‡¦ç†æ–¹æ³•åˆ¥çµ±è¨ˆ
            stats.by_method = stats.by_method || {};
            const methodKey = feedbackData.processing_method;
            if (!stats.by_method[methodKey]) {
              stats.by_method[methodKey] = { accurate: 0, somewhat: 0, inaccurate: 0, total: 0 };
            }
            stats.by_method[methodKey][rating]++;
            stats.by_method[methodKey].total++;

            localStorage.setItem('feedback_stats', JSON.stringify(stats));
            
            // çµ±è¨ˆæƒ…å ±ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«å‡ºåŠ›ï¼ˆ90%æˆåŠŸç‡ç›£è¦–å¼·åŒ–ï¼‰
            const overallSuccessRate = Math.round((stats.ratings.accurate + stats.ratings.somewhat * 0.5) / stats.total * 100);
            
            console.log('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯çµ±è¨ˆæ›´æ–° (90%æˆåŠŸç‡ç›£è¦–):', {
              å…¨ä½“ç²¾åº¦: overallSuccessRate + '%',
              ç·ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯æ•°: stats.total,
              tokenizerä½¿ç”¨çŠ¶æ³: {
                kuromoji: stats.tokenizer_stats?.kuromoji || 0,
                fallback: stats.tokenizer_stats?.fallback || 0
              }
            });
            
            // 90%æˆåŠŸç‡ç›®æ¨™ã¨ã®æ¯”è¼ƒ
            if (stats.total >= 10) {
              if (overallSuccessRate >= 90) {
                console.log('âœ… æˆåŠŸç‡ç›®æ¨™é”æˆ: ' + overallSuccessRate + '% (ç›®æ¨™: 90%)');
              } else if (overallSuccessRate >= 85) {
                console.warn('âš ï¸ æˆåŠŸç‡æ³¨æ„: ' + overallSuccessRate + '% (ç›®æ¨™: 90%) - æ”¹å–„ã®ä½™åœ°ã‚ã‚Š');
              } else {
                console.error('âŒ æˆåŠŸç‡ä½ä¸‹: ' + overallSuccessRate + '% (ç›®æ¨™: 90%) - ç·Šæ€¥æ”¹å–„å¿…è¦');
              }
            }
            
            // tokenizeråˆ¥ã®çµ±è¨ˆæ›´æ–°
            stats.tokenizer_stats = stats.tokenizer_stats || { kuromoji: 0, fallback: 0 };
            if (feedbackData.tokenizer_type === 'simple_fallback') {
              stats.tokenizer_stats.fallback++;
            } else {
              stats.tokenizer_stats.kuromoji++;
            }

          } catch (error) {
            console.error('çµ±è¨ˆæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
          }
        }

        function showFeedbackResult(rating) {
          const resultDiv = document.getElementById('feedback-result');
          if (!resultDiv) return;

          let message, colorClass;
          switch (rating) {
            case 'accurate':
              message = 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼çš„ç¢ºãªåˆ†æãŒã§ãã¦ã„ã¦å¬‰ã—ã„ã§ã™ã€‚';
              colorClass = 'text-green-400';
              break;
            case 'somewhat':
              message = 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã‚ˆã‚Šè‰¯ã„åˆ†æã‚’ç›®æŒ‡ã—ã¾ã™ã€‚';
              colorClass = 'text-yellow-400';
              break;
            case 'inaccurate':
              message = 'æ”¹å–„ã®ä½™åœ°ãŒã‚ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚è²´é‡ãªã”æ„è¦‹ã‚’ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚';
              colorClass = 'text-red-400';
              break;
            case 'error':
              message = 'ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã®é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
              colorClass = 'text-red-400';
              break;
          }

          resultDiv.innerHTML = `<p class="${colorClass}">ğŸ“Š ${message}</p>`;
          resultDiv.classList.remove('hidden');
        }

        function disableFeedbackButtons() {
          const buttons = document.querySelectorAll('.feedback-buttons button');
          buttons.forEach(btn => {
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');
            btn.classList.remove('hover:bg-green-700', 'hover:bg-yellow-700', 'hover:bg-red-700');
          });
        }

        // çµ±è¨ˆæƒ…å ±è¡¨ç¤ºé–¢æ•°ï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰
        window.showFeedbackStats = function() {
          const stats = JSON.parse(localStorage.getItem('feedback_stats') || '{}');
          console.log('=== Community Feedback Statistics ===');
          console.log('Total feedback:', stats.total || 0);
          if (stats.ratings) {
            const accuracy = Math.round((stats.ratings.accurate + stats.ratings.somewhat * 0.5) / stats.total * 100);
            console.log('Overall accuracy:', accuracy + '%');
            console.log('Rating breakdown:', stats.ratings);
          }
          if (stats.by_method) {
            console.log('Method performance:', stats.by_method);
          }
          return stats;
        };

        // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢é–¢æ•°ï¼ˆé–‹ç™ºç”¨ï¼‰
        window.clearFeedbackData = function() {
          localStorage.removeItem('community_feedback');
          localStorage.removeItem('feedback_stats');
          console.log('ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        };

        // ===== æ©Ÿæ¢°å­¦ç¿’ç”¨ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° =====

        /**
         * æ„Ÿæƒ…æŒ‡æ¨™ã®æŠ½å‡º
         */
        function extractSentimentIndicators(text) {
          const positiveWords = ['å¬‰ã—ã„', 'æ¥½ã—ã„', 'å¹¸ã›', 'æº€è¶³', 'è‰¯ã„', 'ç´ æ™´ã‚‰ã—ã„', 'å……å®Ÿ', 'èª¿å’Œ'];
          const negativeWords = ['æ‚©ã¿', 'ã‚¤ãƒ©ã‚¤ãƒ©', 'è¾›ã„', 'ä¸å®‰', 'å¿ƒé…', 'å›°ã‚‹', 'æ‚²ã—ã„', 'è‹¦ã—ã„', 'æ•æ„Ÿ', 'å½±éŸ¿'];
          const neutralWords = ['æ™®é€š', 'å¹³å¸¸', 'ãƒãƒ©ãƒ³ã‚¹', 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', 'å®‰å®š'];

          return {
            positive_count: positiveWords.filter(word => text.includes(word)).length,
            negative_count: negativeWords.filter(word => text.includes(word)).length,
            neutral_count: neutralWords.filter(word => text.includes(word)).length,
            total_emotional_words: positiveWords.concat(negativeWords, neutralWords).filter(word => text.includes(word)).length
          };
        }

        /**
         * æ„Ÿæƒ…ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æŠ½å‡º
         */
        function extractEmotionalKeywords(text) {
          const emotionalCategories = {
            interpersonal: ['äºº', 'ä»–äºº', 'ç›¸æ‰‹', 'å‘¨ã‚Š', 'ç¤¾ä¼š', 'é–¢ä¿‚', 'å¯¾äºº'],
            internal: ['è‡ªåˆ†', 'å†…é¢', 'å¿ƒ', 'æ°—æŒã¡', 'æ„Ÿæƒ…', 'æ€§æ ¼', 'æœ¬è³ª'],
            change: ['å¤‰åŒ–', 'æ”¹å–„', 'æˆé•·', 'ç™ºå±•', 'å‘ä¸Š', 'é€²æ­©'],
            balance: ['ãƒãƒ©ãƒ³ã‚¹', 'èª¿å’Œ', 'å®‰å®š', 'ãƒ‹ãƒ¥ãƒ¼ãƒˆãƒ©ãƒ«', 'æ•´ãˆã‚‹'],
            struggle: ['æ‚©ã¿', 'å•é¡Œ', 'å›°é›£', 'èª²é¡Œ', 'è‘›è—¤', 'è¿·ã„']
          };

          const results = {};
          for (const [category, words] of Object.entries(emotionalCategories)) {
            results[category] = words.filter(word => text.includes(word));
          }
          return results;
        }

        /**
         * ãƒ†ã‚­ã‚¹ãƒˆè¤‡é›‘åº¦ã®è¨ˆç®—
         */
        function calculateTextComplexity(text) {
          const sentences = text.split(/[ã€‚ï¼ï¼Ÿ]/).filter(s => s.trim().length > 0);
          const avgSentenceLength = text.length / Math.max(sentences.length, 1);
          const uniqueChars = new Set(text).size;
          const repetitionRatio = text.length / Math.max(uniqueChars, 1);
          
          return {
            sentence_count: sentences.length,
            avg_sentence_length: Math.round(avgSentenceLength),
            unique_char_ratio: Math.round((uniqueChars / text.length) * 100) / 100,
            repetition_ratio: Math.round(repetitionRatio * 100) / 100,
            complexity_score: Math.min(10, Math.round((avgSentenceLength * uniqueChars) / 100))
          };
        }

        /**
         * å¦ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ†æ
         */
        function getHexagramCategory(hexagramNumber) {
          const categories = {
            creative: [1, 2, 11, 12, 13, 14], // å‰µé€ ãƒ»åŸºæœ¬
            development: [3, 4, 5, 6, 7, 8], // ç™ºå±•ãƒ»å­¦ç¿’
            balance: [15, 16, 31, 32, 61, 62], // ãƒãƒ©ãƒ³ã‚¹ãƒ»èª¿å’Œ
            transformation: [49, 50, 51, 52, 57, 58], // å¤‰åŒ–ãƒ»å¤‰é©
            relationship: [19, 20, 37, 38, 53, 54], // äººé–“é–¢ä¿‚
            inner_work: [22, 23, 24, 26, 27, 41] // å†…é¢ä¿®é¤Š
          };

          for (const [category, numbers] of Object.entries(categories)) {
            if (numbers.includes(hexagramNumber)) {
              return category;
            }
          }
          return 'general';
        }

        /**
         * äº”è¡Œåˆ†æ
         */
        function getElementAnalysis(hexagramNumber) {
          const elements = {
            wood: [3, 18, 20, 42, 48, 50, 51, 57], // æœ¨
            fire: [13, 14, 21, 30, 35, 36, 38, 55], // ç«
            earth: [2, 15, 16, 23, 24, 41, 46, 52], // åœŸ
            metal: [1, 6, 10, 26, 28, 43, 49, 58], // é‡‘
            water: [5, 8, 29, 47, 59, 60, 63, 64] // æ°´
          };

          for (const [element, numbers] of Object.entries(elements)) {
            if (numbers.includes(hexagramNumber)) {
              return element;
            }
          }
          return 'neutral';
        }

        /**
         * çŠ¶æ³ã‚¿ã‚¤ãƒ—ã®åˆ¤å®š
         */
        function getSituationType(hexagramNumber) {
          if (hexagramNumber >= 1 && hexagramNumber <= 16) return 'beginning';
          if (hexagramNumber >= 17 && hexagramNumber <= 32) return 'development';
          if (hexagramNumber >= 33 && hexagramNumber <= 48) return 'maturity';
          if (hexagramNumber >= 49 && hexagramNumber <= 64) return 'transformation';
          return 'unknown';
        }

        /**
         * æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®åˆ†æ
         */
        function getRecommendedAction(hexagramNumber) {
          const actionTypes = {
            wait: [5, 25, 33, 52], // å¾…ã¤
            act: [1, 17, 34, 51], // è¡Œå‹•ã™ã‚‹
            reflect: [4, 20, 41, 61], // å†…çœã™ã‚‹
            adapt: [2, 18, 32, 57], // é©å¿œã™ã‚‹
            balance: [11, 15, 31, 62] // ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹
          };

          for (const [action, numbers] of Object.entries(actionTypes)) {
            if (numbers.includes(hexagramNumber)) {
              return action;
            }
          }
          return 'general';
        }

        // ===== ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ç²¾å¯†åŒ–ã‚·ã‚¹ãƒ†ãƒ  (Phase4) =====
        
        /**
         * å¯¾è©±å‹ç²¾å¯†åˆ†æã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
         */
        window.requestInteractiveRefinement = function() {
          const refinementDiv = document.getElementById('interactive-refinement');
          if (!refinementDiv) return;

          refinementDiv.innerHTML = `
            <h5 class="text-indigo-300 font-semibold mb-3 flex items-center">
              <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              ã‚ˆã‚Šè©³ç´°ãªåˆ†æã®ãŸã‚ã®è¿½åŠ æƒ…å ±
            </h5>
            <p class="text-sm text-gray-300 mb-4">
              ã‚ˆã‚Šæ­£ç¢ºãªåˆ†æã®ãŸã‚ã«ã€ã„ãã¤ã‹è¿½åŠ ã§ãŠèã‹ã›ãã ã•ã„ã€‚
            </p>
            
            <div class="space-y-4">
              <div class="refinement-question">
                <p class="text-sm font-medium text-gray-300 mb-2">1. ä»Šå›ã®çŠ¶æ³ã§æœ€ã‚‚é‡è¦–ã—ãŸã„è¦³ç‚¹ã¯ï¼Ÿ</p>
                <div class="grid grid-cols-2 gap-2">
                  <label class="refinement-option flex items-center p-2 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                    <input type="radio" name="focus_aspect" value="emotional" class="mr-2 text-indigo-600">
                    <span class="text-sm">æ„Ÿæƒ…é¢ãƒ»å†…é¢çš„ãªå¤‰åŒ–</span>
                  </label>
                  <label class="refinement-option flex items-center p-2 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                    <input type="radio" name="focus_aspect" value="practical" class="mr-2 text-indigo-600">
                    <span class="text-sm">å®Ÿè·µçš„ãƒ»è¡Œå‹•é¢ã§ã®æŒ‡é‡</span>
                  </label>
                  <label class="refinement-option flex items-center p-2 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                    <input type="radio" name="focus_aspect" value="relationship" class="mr-2 text-indigo-600">
                    <span class="text-sm">äººé–“é–¢ä¿‚ãƒ»å¯¾äººé¢</span>
                  </label>
                  <label class="refinement-option flex items-center p-2 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                    <input type="radio" name="focus_aspect" value="strategic" class="mr-2 text-indigo-600">
                    <span class="text-sm">æˆ¦ç•¥çš„ãƒ»é•·æœŸçš„è¦–ç‚¹</span>
                  </label>
                </div>
              </div>
              
              <div class="refinement-question">
                <p class="text-sm font-medium text-gray-300 mb-2">2. ç¾åœ¨ã®çŠ¶æ³ã®ç·Šæ€¥åº¦ã¯ï¼Ÿ</p>
                <div class="grid grid-cols-3 gap-2">
                  <label class="refinement-option flex items-center p-2 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                    <input type="radio" name="urgency" value="high" class="mr-2 text-red-600">
                    <span class="text-sm">ç·Šæ€¥</span>
                  </label>
                  <label class="refinement-option flex items-center p-2 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                    <input type="radio" name="urgency" value="medium" class="mr-2 text-yellow-600">
                    <span class="text-sm">æ™®é€š</span>
                  </label>
                  <label class="refinement-option flex items-center p-2 bg-gray-800 rounded cursor-pointer hover:bg-gray-700">
                    <input type="radio" name="urgency" value="low" class="mr-2 text-green-600">
                    <span class="text-sm">ã˜ã£ãã‚Š</span>
                  </label>
                </div>
              </div>
              
              <div class="refinement-question">
                <p class="text-sm font-medium text-gray-300 mb-2">3. è¿½åŠ ã®æ–‡è„ˆæƒ…å ±ï¼ˆä»»æ„ï¼‰</p>
                <textarea id="additional-context" 
                          class="w-full p-3 bg-gray-800 border border-gray-600 rounded-lg text-white text-sm"
                          rows="3" 
                          placeholder="ä¾‹: å®Ÿã¯ä»¥å‰ã«ã‚‚ä¼¼ãŸã‚ˆã†ãªçµŒé¨“ãŒã‚ã‚Š... / ä»–ã®äººã‹ã‚‰ã¯ã€œã¨è¨€ã‚ã‚Œã¦ã„ã‚‹ãŒ..."></textarea>
              </div>
              
              <div class="flex gap-2">
                <button onclick="performInteractiveRefinement()" 
                        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm transition-colors">
                  ç²¾å¯†åˆ†æã‚’å®Ÿè¡Œ
                </button>
                <button onclick="cancelInteractiveRefinement()" 
                        class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm transition-colors">
                  ã‚­ãƒ£ãƒ³ã‚»ãƒ«
                </button>
              </div>
            </div>
          `;
          
          refinementDiv.classList.remove('hidden');
          
          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’ä¸€æ™‚çš„ã«éš ã™
          const feedbackButtons = document.querySelector('.feedback-buttons');
          if (feedbackButtons) {
            feedbackButtons.style.opacity = '0.5';
            feedbackButtons.style.pointerEvents = 'none';
          }
        };

        /**
         * ç²¾å¯†åˆ†æã®å®Ÿè¡Œ
         */
        window.performInteractiveRefinement = async function() {
          try {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¿½åŠ å…¥åŠ›ã‚’åé›†
            const focusAspect = document.querySelector('input[name="focus_aspect"]:checked')?.value;
            const urgency = document.querySelector('input[name="urgency"]:checked')?.value;
            const additionalContext = document.getElementById('additional-context')?.value || '';

            if (!focusAspect || !urgency) {
              alert('é‡è¦–ã™ã‚‹è¦³ç‚¹ã¨ç·Šæ€¥åº¦ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
              return;
            }

            // é«˜åº¦åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã«è¿½åŠ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§å†åˆ†æã‚’ä¾é ¼
            if (!advancedEngine) {
              advancedEngine = new AdvancedAnalysisEngine();
            }

            const originalText = currentAnalysisData.worry;
            const enhancedText = `${originalText}\n\n[è¿½åŠ æƒ…å ±] é‡è¦–ã™ã‚‹è¦³ç‚¹: ${focusAspect}, ç·Šæ€¥åº¦: ${urgency}${additionalContext ? `, è£œè¶³: ${additionalContext}` : ''}`;

            // å‡¦ç†çŠ¶æ³è¡¨ç¤º
            const refinementDiv = document.getElementById('interactive-refinement');
            refinementDiv.innerHTML = `
              <div class="flex items-center mb-4">
                <div class="processing-spinner mr-3"></div>
                <p class="text-indigo-300 font-medium">ç²¾å¯†åˆ†æä¸­...</p>
              </div>
              <div class="text-sm text-gray-400">
                è¿½åŠ ã®æ–‡è„ˆæƒ…å ±ã‚’è€ƒæ…®ã—ãŸå†åˆ†æã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
              </div>
            `;

            // Level 3: å¯¾è©±å‹ç²¾å¯†åˆ†æã‚’å®Ÿè¡Œï¼ˆ95%å“è³ªç›®æ¨™ï¼‰
            const refinedResults = await advancedEngine.performTieredAnalysis(
              enhancedText, H384_DATA, window.futureThemeMap, analyzeContextType(originalText)
            );

            // çµæœã®æ¯”è¼ƒè¡¨ç¤º
            displayRefinementResults(refinedResults, focusAspect, urgency, additionalContext);

          } catch (error) {
            console.error('ç²¾å¯†åˆ†æã‚¨ãƒ©ãƒ¼:', error);
            const refinementDiv = document.getElementById('interactive-refinement');
            refinementDiv.innerHTML = `
              <div class="text-red-400 text-sm">
                ç²¾å¯†åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}
              </div>
              <button onclick="cancelInteractiveRefinement()" 
                      class="mt-3 px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm">
                é–‰ã˜ã‚‹
              </button>
            `;
          }
        };

        function displayRefinementResults(refinedResults, focusAspect, urgency, additionalContext) {
          const refinementDiv = document.getElementById('interactive-refinement');
          const result = refinedResults.finalResult;
          
          const focusAspectText = {
            emotional: 'æ„Ÿæƒ…é¢ãƒ»å†…é¢çš„ãªå¤‰åŒ–',
            practical: 'å®Ÿè·µçš„ãƒ»è¡Œå‹•é¢ã§ã®æŒ‡é‡', 
            relationship: 'äººé–“é–¢ä¿‚ãƒ»å¯¾äººé¢',
            strategic: 'æˆ¦ç•¥çš„ãƒ»é•·æœŸçš„è¦–ç‚¹'
          }[focusAspect];

          const urgencyText = {
            high: 'ç·Šæ€¥',
            medium: 'æ™®é€š',
            low: 'ã˜ã£ãã‚Š'
          }[urgency];

          refinementDiv.innerHTML = `
            <h5 class="text-indigo-300 font-semibold mb-3">ğŸ¯ ç²¾å¯†åˆ†æçµæœ</h5>
            
            <div class="mb-4 p-3 bg-indigo-900/20 rounded-lg">
              <p class="text-sm text-gray-300 mb-2">
                <strong>åˆ†æè¦³ç‚¹:</strong> ${focusAspectText} | <strong>ç·Šæ€¥åº¦:</strong> ${urgencyText}
              </p>
              ${additionalContext ? `<p class="text-sm text-gray-400">è£œè¶³æƒ…å ±: ${additionalContext}</p>` : ''}
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div class="analysis-comparison">
                <h6 class="text-yellow-300 font-medium mb-2">ğŸ“Š åˆå›åˆ†æ</h6>
                <div class="text-sm text-gray-300">
                  ${currentAnalysisData.startState['è¦ªã¨ãªã‚‹å¦']} ${currentAnalysisData.startState.çˆ»}<br>
                  <span class="text-gray-400">ä¿¡é ¼åº¦: ${Math.round((currentAnalysisData.analysisEvidence?.confidence_breakdown?.combined || 0.5) * 100)}%</span>
                </div>
              </div>
              
              <div class="analysis-comparison">
                <h6 class="text-green-300 font-medium mb-2">ğŸ¯ ç²¾å¯†åˆ†æ</h6>
                <div class="text-sm text-gray-300">
                  ${result.lineData['è¦ªã¨ãªã‚‹å¦']} ${result.lineData.çˆ»}<br>
                  <span class="text-green-400 font-medium">ä¿¡é ¼åº¦: ${Math.round(result.confidence * 100)}%</span>
                </div>
              </div>
            </div>
            
            <div class="mb-4 p-3 bg-gray-800/50 rounded-lg">
              <p class="text-sm text-gray-300">
                <strong class="text-green-300">ç²¾å¯†åˆ†æã«ã‚ˆã‚‹è¿½åŠ ã‚¤ãƒ³ã‚µã‚¤ãƒˆ:</strong><br>
                ${generateRefinedInsight(result, focusAspect, urgency)}
              </p>
            </div>
            
            <div class="flex gap-2">
              <button onclick="applyRefinedResult(${JSON.stringify(result)})" 
                      class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm">
                ã“ã®ç²¾å¯†åˆ†æçµæœã‚’æ¡ç”¨
              </button>
              <button onclick="cancelInteractiveRefinement()" 
                      class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg text-sm">
                åˆå›åˆ†æã®ã¾ã¾
              </button>
            </div>
          `;
        }

        function generateRefinedInsight(result, focusAspect, urgency) {
          const insights = {
            emotional: "å†…é¢çš„ãªå¤‰åŒ–ã®è¦³ç‚¹ã‹ã‚‰ã€æ„Ÿæƒ…ã®æµã‚Œã¨å¿ƒç†çš„ãªæˆé•·ã®æ®µéšã‚’é‡è¦–ã—ãŸè§£é‡ˆ",
            practical: "å…·ä½“çš„ãªè¡Œå‹•æŒ‡é‡ã®è¦³ç‚¹ã‹ã‚‰ã€å®Ÿè·µå¯èƒ½ãªã‚¹ãƒ†ãƒƒãƒ—ã¨æˆæœã«ã¤ãªãŒã‚‹æ–¹å‘æ€§ã‚’é‡è¦–ã—ãŸè§£é‡ˆ",
            relationship: "äººé–“é–¢ä¿‚ã®è¦³ç‚¹ã‹ã‚‰ã€å¯¾äººã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç›¸äº’ç†è§£ã®æ”¹å–„ã‚’é‡è¦–ã—ãŸè§£é‡ˆ", 
            strategic: "é•·æœŸæˆ¦ç•¥ã®è¦³ç‚¹ã‹ã‚‰ã€æŒç¶šå¯èƒ½ãªç™ºå±•ã¨å…¨ä½“æœ€é©åŒ–ã‚’é‡è¦–ã—ãŸè§£é‡ˆ"
          };

          const urgencyInsights = {
            high: "ç·Šæ€¥æ€§ã‚’è€ƒæ…®ã—ã€å³åŠ¹æ€§ã®ã‚ã‚‹å¯¾å¿œç­–ã¨çŸ­æœŸçš„ãªå®‰å®šåŒ–ã‚’å„ªå…ˆã—ãŸåˆ†æ",
            medium: "ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸãƒšãƒ¼ã‚¹ã§ã€ä¸­æœŸçš„ãªæ”¹å–„ã¨æ®µéšçš„ãªç™ºå±•ã‚’ç›®æŒ‡ã—ãŸåˆ†æ",
            low: "ã˜ã£ãã‚Šã¨ã—ãŸå–ã‚Šçµ„ã¿ã‚’å‰æã«ã€æ ¹æœ¬çš„ãªç†è§£ã¨æŒç¶šçš„ãªæˆé•·ã‚’é‡è¦–ã—ãŸåˆ†æ"
          };

          return `${insights[focusAspect]}ã¨ã—ã¦æ‰ãˆç›´ã—ã€${urgencyInsights[urgency]}ã‚’æä¾›ã—ã¾ã™ã€‚`;
        }

        window.applyRefinedResult = function(refinedResult) {
          // ç²¾å¯†åˆ†æçµæœã‚’ç¾åœ¨ã®åˆ†æãƒ‡ãƒ¼ã‚¿ã«é©ç”¨
          // ã“ã®å®Ÿè£…ã§ã¯è¡¨ç¤ºã®ã¿æ›´æ–°ï¼ˆå®Ÿéš›ã®æœªæ¥äºˆæ¸¬ã¯å…ƒã®ã¾ã¾ï¼‰
          const refinementDiv = document.getElementById('interactive-refinement');
          refinementDiv.innerHTML = `
            <div class="text-green-400 text-sm p-3 bg-green-900/20 rounded-lg">
              âœ… ç²¾å¯†åˆ†æçµæœã‚’é©ç”¨ã—ã¾ã—ãŸã€‚ã‚ˆã‚Šè©³ç´°ãªåˆ†æã«ã‚ˆã‚‹çŠ¶æ³ç†è§£ã‚’ã”æ´»ç”¨ãã ã•ã„ã€‚
            </div>
          `;
          
          setTimeout(() => {
            cancelInteractiveRefinement();
          }, 3000);
        };

        window.cancelInteractiveRefinement = function() {
          const refinementDiv = document.getElementById('interactive-refinement');
          if (refinementDiv) {
            refinementDiv.classList.add('hidden');
          }
          
          // ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒœã‚¿ãƒ³ã‚’å†æœ‰åŠ¹åŒ–
          const feedbackButtons = document.querySelector('.feedback-buttons');
          if (feedbackButtons) {
            feedbackButtons.style.opacity = '1';
            feedbackButtons.style.pointerEvents = 'auto';
          }
        };
    </script>
    <footer class="bg-gray-800">
      <footer class="w-full max-w-4xl mx-auto text-center p-6 mt-8 border-t border-gray-700">
    <div class="space-x-4 mb-4">
        <a href="/terms.html" target="_blank" class="text-sm text-gray-400 hover:text-white">åˆ©ç”¨è¦ç´„</a>
        <a href="/privacy.html" target="_blank" class="text-sm text-gray-400 hover:text-white">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>
    </div>
      <div class="container mx-auto px-6 py-4 text-center text-gray-400">
        <p>&copy; 2025 HaQei. All Rights Reserved.</p>
      </div>
    </footer>
  </body>
</html>
