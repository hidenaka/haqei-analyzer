<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>H384„Ç≠„Éº„ÉØ„Éº„Éâ„Éô„Éº„ÇπÈÄ≤Áàª„ÉªÂ§âÁàª„Ç∑„Çπ„ÉÜ„É†</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Hiragino Sans', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            margin: 0;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        /* H384„Éá„Éº„ÇøË°®Á§∫„Ç®„É™„Ç¢ */
        .h384-display {
            background: linear-gradient(135deg, #f0f4ff, #e8ecff);
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 2px solid #667eea;
        }
        
        .hex-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .hex-number {
            font-size: 48px;
            font-weight: bold;
            color: #667eea;
        }
        
        .hex-name {
            font-size: 32px;
            color: #333;
        }
        
        .line-info {
            font-size: 24px;
            color: #666;
        }
        
        .keywords-section {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .keywords-title {
            font-size: 16px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .keywords-list {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .keyword-tag {
            background: #667eea;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 18px;
            font-weight: bold;
        }
        
        .interpretation {
            background: #fffbf0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #f39c12;
            margin-bottom: 20px;
        }
        
        .interpretation-title {
            font-weight: bold;
            color: #f39c12;
            margin-bottom: 10px;
        }
        
        /* ÈÅ∏ÊäûËÇ¢Ë°®Á§∫ */
        .choices-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .choice-card {
            border: 3px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .choice-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .choice-card.jin {
            background: linear-gradient(to bottom, #e8f5e9, white);
            border-color: #4CAF50;
        }
        
        .choice-card.heng {
            background: linear-gradient(to bottom, #fff3e0, white);
            border-color: #FF9800;
        }
        
        .choice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .choice-type-badge {
            background: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 16px;
            border: 2px solid;
        }
        
        .jin .choice-type-badge {
            color: #4CAF50;
            border-color: #4CAF50;
        }
        
        .heng .choice-type-badge {
            color: #FF9800;
            border-color: #FF9800;
        }
        
        .choice-action {
            font-size: 20px;
            font-weight: bold;
        }
        
        /* „Ç≠„Éº„ÉØ„Éº„ÉâÊØîËºÉ„Çª„ÇØ„Ç∑„Éß„É≥ */
        .keyword-comparison {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .keyword-comparison-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .current-keywords {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .current-keyword {
            background: #e0e0e0;
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
        }
        
        .arrow {
            font-size: 24px;
            color: #666;
            text-align: center;
            margin: 15px 0;
        }
        
        .next-keywords {
            display: flex;
            gap: 10px;
        }
        
        .next-keyword {
            padding: 5px 15px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }
        
        .jin .next-keyword {
            background: #c8e6c9;
            color: #2E7D32;
        }
        
        .heng .next-keyword {
            background: #ffe0b2;
            color: #E65100;
        }
        
        /* Ë™¨Êòé„Çª„ÇØ„Ç∑„Éß„É≥ */
        .explanation-box {
            background: white;
            border: 1px solid #e0e0e0;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .explanation-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .explanation-content {
            color: #666;
            line-height: 1.6;
        }
        
        /* Ê¨°„ÅÆÁä∂ÊÖãË°®Á§∫ */
        .next-state-display {
            background: white;
            border: 2px solid #e0e0e0;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .next-state-header {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
            text-transform: uppercase;
        }
        
        .next-state-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .next-hex-line {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        .next-hex-name {
            font-size: 18px;
            color: #666;
        }
        
        /* „Çπ„Ç≥„Ç¢Ë°®Á§∫ */
        .scores-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .score-item {
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }
        
        .score-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* ÁµêÊûúË°®Á§∫ */
        .results-container {
            margin-top: 30px;
        }
        
        .path-display {
            background: #f0f4ff;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .path-item {
            display: inline-block;
            margin: 5px;
            padding: 10px 20px;
            background: white;
            border-radius: 10px;
            border: 2px solid #667eea;
        }
        
        .path-arrow {
            display: inline-block;
            margin: 0 10px;
            color: #667eea;
            font-size: 20px;
        }
        
        .eight-patterns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .pattern-card {
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 20px;
            background: white;
        }
        
        .pattern-header {
            font-size: 18px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .pattern-keywords {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
        
        .pattern-final {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîÆ H384„Ç≠„Éº„ÉØ„Éº„Éâ„Éô„Éº„ÇπÈÄ≤Áàª„ÉªÂ§âÁàª„Ç∑„Çπ„ÉÜ„É†</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">
            384ÂÄã„ÅÆÁàªÔºà64Âç¶√ó6ÁàªÔºâ„Åù„Çå„Åû„Çå„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„Å´Âü∫„Å•„ÅÑ„ÅüÈÅ∏Êäû„Ç∑„Çπ„ÉÜ„É†
        </p>
        
        <!-- ÂàùÊúüÂÖ•Âäõ -->
        <div id="initialScreen">
            <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-bottom: 30px;">
                <h2>ÊÇ©„Åø„ÇÑÁä∂Ê≥Å„ÇíÂÖ•Âäõ</h2>
                <textarea id="worryInput" style="width: 100%; min-height: 120px; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px;" placeholder="ÁèæÂú®„ÅÆÊÇ©„Åø„ÇÑÁä∂Ê≥Å„ÇíË©≥„Åó„ÅèÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ..."></textarea>
                <div style="margin-top: 20px; display: flex; gap: 15px;">
                    <button onclick="startSystem()" style="padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">ÂàÜÊûêÈñãÂßã</button>
                    <button onclick="showAllPatterns()" style="padding: 12px 30px; background: #FF9800; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer;">8„Éë„Çø„Éº„É≥‰∏ÄË¶ß</button>
                </div>
            </div>
        </div>
        
        <!-- ÈÅ∏ÊäûÁîªÈù¢ -->
        <div id="choiceScreen" style="display: none;">
            <!-- ÁèæÂú®„ÅÆÁàª„Éá„Éº„ÇøË°®Á§∫ -->
            <div class="h384-display">
                <div class="hex-info">
                    <div>
                        <span class="hex-number" id="hexNumber">-</span>
                        <span class="hex-name" id="hexName">-</span>
                    </div>
                    <div class="line-info" id="lineInfo">-</div>
                </div>
                
                <div class="keywords-section">
                    <div class="keywords-title">384Áàª„Éá„Éº„Çø„Éô„Éº„Çπ „Ç≠„Éº„ÉØ„Éº„Éâ</div>
                    <div class="keywords-list" id="keywordsList">
                        <!-- „Ç≠„Éº„ÉØ„Éº„Éâ„ÅåË°®Á§∫„Åï„Çå„Çã -->
                    </div>
                </div>
                
                <div class="interpretation">
                    <div class="interpretation-title">Áèæ‰ª£Ëß£Èáà</div>
                    <div id="interpretationText">-</div>
                </div>
                
                <div class="scores-display">
                    <div class="score-item">
                        <div class="score-value" id="scoreBasic">-</div>
                        <div class="score-label">Âü∫Êú¨„Çπ„Ç≥„Ç¢</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="scorePotential">-</div>
                        <div class="score-label">„Éù„ÉÜ„É≥„Ç∑„É£„É´</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="scoreStability">-</div>
                        <div class="score-label">ÂÆâÂÆöÊÄß</div>
                    </div>
                    <div class="score-item">
                        <div class="score-value" id="scoreRisk">-</div>
                        <div class="score-label">„É™„Çπ„ÇØ</div>
                    </div>
                </div>
            </div>
            
            <!-- ÈÅ∏ÊäûËÇ¢ -->
            <div class="choices-container">
                <!-- ÈÄ≤ÁàªÈÅ∏Êäû -->
                <div class="choice-card jin" onclick="makeChoice('jin')">
                    <div class="choice-header">
                        <div class="choice-type-badge">ÈÄ≤Áàª</div>
                        <div class="choice-action">„Ç≠„Éº„ÉØ„Éº„Éâ„Å´Ê≤ø„Å£„Å¶ÈÄ≤„ÇÄ</div>
                    </div>
                    
                    <div class="keyword-comparison">
                        <div class="keyword-comparison-title">ÁèæÂú®„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ</div>
                        <div class="current-keywords" id="jinCurrentKeywords">
                            <!-- ÁèæÂú®„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ -->
                        </div>
                        <div class="arrow">‚Üì</div>
                        <div class="keyword-comparison-title">Ê¨°„ÅÆ„Ç≠„Éº„ÉØ„Éº„ÉâÔºàÂêå„ÅòÂç¶„ÉªÁàª‰Ωç+1Ôºâ</div>
                        <div class="next-keywords" id="jinNextKeywords">
                            <!-- Ê¨°„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ -->
                        </div>
                    </div>
                    
                    <div class="explanation-box">
                        <div class="explanation-title">„Å™„ÅúÈÄ≤Áàª„ÇíÈÅ∏„Å∂„Åã</div>
                        <div class="explanation-content" id="jinExplanation">
                            ÁèæÂú®„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÉÜ„Éº„Éû„ÇíÊ∑±„ÇÅ„ÄÅÂêå„ÅòÂç¶ÂÜÖ„ÅßÊàêÁÜü„ÉªÁô∫Â±ï„Åï„Åõ„Åü„ÅÑÂ†¥Âêà„ÅÆÈÅ∏Êäû„Åß„Åô„ÄÇ
                        </div>
                    </div>
                    
                    <div class="next-state-display">
                        <div class="next-state-header">Ê¨°„ÅÆÁä∂ÊÖã</div>
                        <div class="next-state-content">
                            <div>
                                <div class="next-hex-line" id="jinNextState">-</div>
                                <div class="next-hex-name" id="jinNextName">-</div>
                            </div>
                            <div id="jinNextInterpretation" style="font-size: 14px; color: #666; max-width: 200px;">-</div>
                        </div>
                    </div>
                </div>
                
                <!-- Â§âÁàªÈÅ∏Êäû -->
                <div class="choice-card heng" onclick="makeChoice('heng')">
                    <div class="choice-header">
                        <div class="choice-type-badge">Â§âÁàª</div>
                        <div class="choice-action">Êñ∞„Åó„ÅÑ„ÉÜ„Éº„Éû„Å∏Ëª¢Êèõ</div>
                    </div>
                    
                    <div class="keyword-comparison">
                        <div class="keyword-comparison-title">ÁèæÂú®„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ</div>
                        <div class="current-keywords" id="hengCurrentKeywords">
                            <!-- ÁèæÂú®„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ -->
                        </div>
                        <div class="arrow">‚Üì</div>
                        <div class="keyword-comparison-title">Ê¨°„ÅÆ„Ç≠„Éº„ÉØ„Éº„ÉâÔºàÂà•„ÅÆÂç¶„ÉªÂêå„ÅòÁàª‰ΩçÔºâ</div>
                        <div class="next-keywords" id="hengNextKeywords">
                            <!-- Ê¨°„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ -->
                        </div>
                    </div>
                    
                    <div class="explanation-box">
                        <div class="explanation-title">„Å™„ÅúÂ§âÁàª„ÇíÈÅ∏„Å∂„Åã</div>
                        <div class="explanation-content" id="hengExplanation">
                            ÁèæÂú®„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ„ÉÜ„Éº„Éû„Åã„ÇâÈõ¢„Çå„ÄÅÂÖ®„ÅèÊñ∞„Åó„ÅÑË¶ñÁÇπ„ÇÑÊñπÂêëÊÄß„ÇíÊé¢„Çä„Åü„ÅÑÂ†¥Âêà„ÅÆÈÅ∏Êäû„Åß„Åô„ÄÇ
                        </div>
                    </div>
                    
                    <div class="next-state-display">
                        <div class="next-state-header">Ê¨°„ÅÆÁä∂ÊÖã</div>
                        <div class="next-state-content">
                            <div>
                                <div class="next-hex-line" id="hengNextState">-</div>
                                <div class="next-hex-name" id="hengNextName">-</div>
                            </div>
                            <div id="hengNextInterpretation" style="font-size: 14px; color: #666; max-width: 200px;">-</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ÁµêÊûúÁîªÈù¢ -->
        <div id="resultsScreen" style="display: none;">
            <div class="results-container">
                <h2>ÂàÜÊûêÁµêÊûú</h2>
                <div class="path-display" id="pathDisplay">
                    <!-- „Éë„Çπ„ÅåË°®Á§∫„Åï„Çå„Çã -->
                </div>
                
                <h3>8„Å§„ÅÆÂèØËÉΩÊÄß„Éë„Çø„Éº„É≥Ôºà384Áàª„Ç≠„Éº„ÉØ„Éº„Éâ„Éô„Éº„ÇπÔºâ</h3>
                <div class="eight-patterns-grid" id="patternsGrid">
                    <!-- 8„Éë„Çø„Éº„É≥„ÅåË°®Á§∫„Åï„Çå„Çã -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- H384„Éá„Éº„Çø„Éô„Éº„Çπ -->
    <script src="assets/H384H64database.js"></script>
    <!-- 3„Éï„Çß„Éº„Ç∫„Ç∑„Çπ„ÉÜ„É† -->
    <script src="js/ThreePhaseSystem.js"></script>
    
    <script>
        let threePhaseSystem = null;
        let currentPhase = 0;
        let decisionHistory = [];
        
        // H384„Éá„Éº„Çø„Åã„ÇâÁàªÊÉÖÂ†±„ÇíÂèñÂæó
        function getH384Data(hexNum, lineNum) {
            const index = (hexNum - 1) * 6 + lineNum - 1;
            return H384_DATA[index] || null;
        }
        
        // „Ç∑„Çπ„ÉÜ„É†ÈñãÂßã
        function startSystem() {
            const worryText = document.getElementById('worryInput').value;
            if (!worryText) {
                alert('ÊÇ©„Åø„ÇÑÁä∂Ê≥Å„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
                return;
            }
            
            // ÂàùÊúüÂç¶„ÉªÁàª„ÇíÊ±∫ÂÆöÔºàÁ∞°ÊòìÂà§ÂÆöÔºâ
            let initialHex = 1;
            let initialLine = 1;
            
            if (worryText.includes('‰ªï‰∫ã') || worryText.includes('„Ç≠„É£„É™„Ç¢')) {
                initialHex = 11; // Ê≥∞
                initialLine = 1;
            } else if (worryText.includes('‰∫∫ÈñìÈñ¢‰øÇ')) {
                initialHex = 13; // Âêå‰∫∫
                initialLine = 1;
            } else if (worryText.includes('Ê±∫Êñ≠') || worryText.includes('Ëø∑')) {
                initialHex = 3; // Â±Ø
                initialLine = 1;
            }
            
            // „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
            threePhaseSystem = window.initThreePhaseSystem(initialHex, initialLine);
            currentPhase = 0;
            decisionHistory = [];
            
            // UIÂàá„ÇäÊõø„Åà
            document.getElementById('initialScreen').style.display = 'none';
            document.getElementById('choiceScreen').style.display = 'block';
            document.getElementById('resultsScreen').style.display = 'none';
            
            // ÈÅ∏ÊäûËÇ¢Ë°®Á§∫
            displayChoices();
        }
        
        // ÈÅ∏ÊäûËÇ¢Ë°®Á§∫ÔºàH384„Éá„Éº„Çø„Éô„Éº„Çπ„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ‰ΩøÁî®Ôºâ
        function displayChoices() {
            const state = threePhaseSystem.manager.getCurrentState();
            const currentData = getH384Data(state.hex, state.line);
            
            if (!currentData) return;
            
            // ÁèæÂú®„ÅÆÁàªÊÉÖÂ†±Ë°®Á§∫
            document.getElementById('hexNumber').textContent = `Âç¶${currentData['Âç¶Áï™Âè∑']}`;
            document.getElementById('hexName').textContent = currentData['Âç¶Âêç'];
            document.getElementById('lineInfo').textContent = currentData['Áàª'];
            
            // „Ç≠„Éº„ÉØ„Éº„ÉâË°®Á§∫
            const keywordsList = document.getElementById('keywordsList');
            keywordsList.innerHTML = currentData['„Ç≠„Éº„ÉØ„Éº„Éâ'].map(kw => 
                `<span class="keyword-tag">${kw}</span>`
            ).join('');
            
            // Ëß£ÈáàË°®Á§∫
            document.getElementById('interpretationText').textContent = currentData['Áèæ‰ª£Ëß£Èáà„ÅÆË¶ÅÁ¥Ñ'];
            
            // „Çπ„Ç≥„Ç¢Ë°®Á§∫
            document.getElementById('scoreBasic').textContent = currentData['S1_Âü∫Êú¨„Çπ„Ç≥„Ç¢'];
            document.getElementById('scorePotential').textContent = currentData['S2_„Éù„ÉÜ„É≥„Ç∑„É£„É´'];
            document.getElementById('scoreStability').textContent = currentData['S3_ÂÆâÂÆöÊÄß„Çπ„Ç≥„Ç¢'];
            document.getElementById('scoreRisk').textContent = currentData['S4_„É™„Çπ„ÇØ'];
            
            // ÈÄ≤Áàª„ÅÆÊÉÖÂ†±
            const jinNext = threePhaseSystem.manager.advanceLine(state.hex, state.line);
            const jinData = getH384Data(jinNext.hex, jinNext.line);
            
            if (jinData) {
                // ÁèæÂú®„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ
                document.getElementById('jinCurrentKeywords').innerHTML = 
                    currentData['„Ç≠„Éº„ÉØ„Éº„Éâ'].map(kw => 
                        `<span class="current-keyword">${kw}</span>`
                    ).join('');
                
                // Ê¨°„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ
                document.getElementById('jinNextKeywords').innerHTML = 
                    jinData['„Ç≠„Éº„ÉØ„Éº„Éâ'].map(kw => 
                        `<span class="next-keyword">${kw}</span>`
                    ).join('');
                
                // Ë™¨Êòé
                const jinKeywords = currentData['„Ç≠„Éº„ÉØ„Éº„Éâ'].join('„Éª');
                document.getElementById('jinExplanation').textContent = 
                    `ÁèæÂú®„ÅÆ„Äå${jinKeywords}„Äç„ÅÆ„ÉÜ„Éº„Éû„ÇíÊ∑±Âåñ„Åï„Åõ„ÄÅ${jinData['„Ç≠„Éº„ÉØ„Éº„Éâ'][0]}„Å∏„Å®Áô∫Â±ï„Åï„Åõ„Åæ„Åô„ÄÇÂêå„Åò${currentData['Âç¶Âêç']}Âç¶ÂÜÖ„Åß„ÅÆÊàêÁÜü„Éó„É≠„Çª„Çπ„Åß„Åô„ÄÇ`;
                
                // Ê¨°„ÅÆÁä∂ÊÖã
                document.getElementById('jinNextState').textContent = 
                    `Âç¶${jinData['Âç¶Áï™Âè∑']}„Éª${jinData['Áàª']}`;
                document.getElementById('jinNextName').textContent = jinData['Âç¶Âêç'];
                document.getElementById('jinNextInterpretation').textContent = 
                    jinData['Áèæ‰ª£Ëß£Èáà„ÅÆË¶ÅÁ¥Ñ'].substring(0, 50) + '...';
            }
            
            // Â§âÁàª„ÅÆÊÉÖÂ†±
            const hengNext = threePhaseSystem.manager.changeHexagram(state.hex, state.line);
            const hengData = getH384Data(hengNext.hex, hengNext.line);
            
            if (hengData) {
                // ÁèæÂú®„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ
                document.getElementById('hengCurrentKeywords').innerHTML = 
                    currentData['„Ç≠„Éº„ÉØ„Éº„Éâ'].map(kw => 
                        `<span class="current-keyword">${kw}</span>`
                    ).join('');
                
                // Ê¨°„ÅÆ„Ç≠„Éº„ÉØ„Éº„Éâ
                document.getElementById('hengNextKeywords').innerHTML = 
                    hengData['„Ç≠„Éº„ÉØ„Éº„Éâ'].map(kw => 
                        `<span class="next-keyword">${kw}</span>`
                    ).join('');
                
                // Ë™¨Êòé
                const currentKeywords = currentData['„Ç≠„Éº„ÉØ„Éº„Éâ'].join('„Éª');
                const nextKeywords = hengData['„Ç≠„Éº„ÉØ„Éº„Éâ'].join('„Éª');
                document.getElementById('hengExplanation').textContent = 
                    `ÁèæÂú®„ÅÆ„Äå${currentKeywords}„Äç„Åã„ÇâÈõ¢„Çå„ÄÅ„Äå${nextKeywords}„Äç„Å®„ÅÑ„ÅÜÂÖ®„ÅèÊñ∞„Åó„ÅÑ„ÉÜ„Éº„Éû„Å∏Ëª¢Êèõ„Åó„Åæ„Åô„ÄÇ${currentData['Âç¶Âêç']}„Åã„Çâ${hengData['Âç¶Âêç']}„Å∏„ÅÆÂ§âÂåñ„Åß„Åô„ÄÇ`;
                
                // Ê¨°„ÅÆÁä∂ÊÖã
                document.getElementById('hengNextState').textContent = 
                    `Âç¶${hengData['Âç¶Áï™Âè∑']}„Éª${hengData['Áàª']}`;
                document.getElementById('hengNextName').textContent = hengData['Âç¶Âêç'];
                document.getElementById('hengNextInterpretation').textContent = 
                    hengData['Áèæ‰ª£Ëß£Èáà„ÅÆË¶ÅÁ¥Ñ'].substring(0, 50) + '...';
            }
        }
        
        // ÈÅ∏ÊäûÂÆüË°å
        function makeChoice(choice) {
            const success = threePhaseSystem.makeChoice(choice);
            
            if (success) {
                decisionHistory.push(choice === 'jin' ? 'ÈÄ≤' : 'Â§â');
                currentPhase++;
                
                if (currentPhase >= 3) {
                    showResults();
                } else {
                    displayChoices();
                }
            }
        }
        
        // ÁµêÊûúË°®Á§∫
        function showResults() {
            document.getElementById('choiceScreen').style.display = 'none';
            document.getElementById('resultsScreen').style.display = 'block';
            
            // „Éë„ÇπË°®Á§∫
            const states = threePhaseSystem.manager.states;
            const pathDisplay = document.getElementById('pathDisplay');
            
            let pathHTML = '<h3>„ÅÇ„Å™„Åü„ÅÆÈÅ∏Êäû„Éë„Çπ</h3><div>';
            states.forEach((state, i) => {
                const data = getH384Data(state.hex, state.line);
                if (data) {
                    const keywords = data['„Ç≠„Éº„ÉØ„Éº„Éâ'].join('„Éª');
                    pathHTML += `<span class="path-item">Âç¶${data['Âç¶Áï™Âè∑']}${data['Áàª']}<br><strong>${keywords}</strong></span>`;
                    
                    if (i < states.length - 1) {
                        const action = decisionHistory[i] === 'ÈÄ≤' ? 'ÈÄ≤Áàª' : 'Â§âÁàª';
                        pathHTML += `<span class="path-arrow">‚Üí${action}‚Üí</span>`;
                    }
                }
            });
            pathHTML += '</div>';
            pathDisplay.innerHTML = pathHTML;
            
            // 8„Éë„Çø„Éº„É≥Ë°®Á§∫
            showAllPatterns(true);
        }
        
        // 8„Éë„Çø„Éº„É≥ÂÖ®Ë°®Á§∫
        function showAllPatterns(fromResult = false) {
            if (!fromResult) {
                const worryText = document.getElementById('worryInput').value || 'Áä∂Ê≥Å';
                let initialHex = 1;
                let initialLine = 1;
                
                if (worryText.includes('‰ªï‰∫ã')) initialHex = 11;
                else if (worryText.includes('‰∫∫ÈñìÈñ¢‰øÇ')) initialHex = 13;
                else if (worryText.includes('Ê±∫Êñ≠')) initialHex = 3;
                
                threePhaseSystem = window.initThreePhaseSystem(initialHex, initialLine);
                document.getElementById('resultsScreen').style.display = 'block';
            }
            
            const allPaths = threePhaseSystem.manager.getAllPaths();
            const grid = document.getElementById('patternsGrid');
            
            grid.innerHTML = allPaths.map((path, i) => {
                const finalState = path.finalState;
                const finalData = getH384Data(finalState.hex, finalState.line);
                
                // ÂêÑÊÆµÈöé„ÅÆ„Ç≠„Éº„ÉØ„Éº„ÉâÂèñÂæó
                let keywordPath = path.path.map(state => {
                    const data = getH384Data(state.hex, state.line);
                    return data ? data['„Ç≠„Éº„ÉØ„Éº„Éâ'][0] : '-';
                });
                
                return `
                    <div class="pattern-card">
                        <div class="pattern-header">
                            „Éë„Çø„Éº„É≥${i+1}: ${path.pattern} (${path.patternDisplay})
                        </div>
                        <div class="pattern-keywords">
                            <strong>„Ç≠„Éº„ÉØ„Éº„ÉâÂ§âÈÅ∑:</strong><br>
                            ${keywordPath.join(' ‚Üí ')}
                        </div>
                        <div class="pattern-final">
                            <strong>ÊúÄÁµÇÁä∂ÊÖã:</strong><br>
                            Âç¶${finalData['Âç¶Áï™Âè∑']}„Éª${finalData['Áàª']}<br>
                            <strong>„Ç≠„Éº„ÉØ„Éº„Éâ:</strong> ${finalData['„Ç≠„Éº„ÉØ„Éº„Éâ'].join('„Éª')}<br>
                            <strong>„Çπ„Ç≥„Ç¢:</strong> ${finalData['S7_Á∑èÂêàË©ï‰æ°„Çπ„Ç≥„Ç¢']}
                        </div>
                    </div>
                `;
            }).join('');
        }
    </script>
</body>
</html>