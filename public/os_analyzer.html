<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="あなたの中にある3つの人格システム（Engine/Interface/Safe Mode OS）を理解するための戦略的分析ツール。易経をメタファーとしたHaQei哲学に基づく現代的な自己理解フレームワーク。">
    <title>HaQei - Triple OS仮想人格生成システム | HaQei哲学による戦略的自己表現ツール</title>
    
    <!-- Unified Design System -->
    <link rel="stylesheet" href="css/haqei-unified-design.css" />
    
    <!-- Light Theme Override for OS Analyzer -->
    <link rel="stylesheet" href="css/os-analyzer-light-override.css" />
    
    <!-- Browser Compatibility Layer -->
    <script src="js/core/BrowserCompatibility.js"></script>
    
    <!-- Chart.js for data visualization with SRI -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" 
            integrity="sha384-e6nUZLBkQ86NJ6TVVKAeSaK8jWa3NhkYWZFomE39AvDbQWeie9PlQqM3pmYW5d1g" 
            crossorigin="anonymous"
            referrerpolicy="no-referrer"></script>
    
    <!-- Statistical Validation Module -->
    <script src="js/StatisticalValidator.js"></script>
    
    <!-- Phase 3: Virtual Persona Dialogue Module -->
    <script src="js/VirtualPersonaDialogue.js"></script>
    
    <!-- DAY 2: Virtual Persona Enhancer Module -->
    <script src="js/VirtualPersonaEnhancer.js"></script>
    
    <!-- Triple OS Interaction Analysis System -->
    <script src="assets/H384H64database.js"></script>
    <script src="js/core/ExpressionGenerator.js"></script>
    <script src="js/core/KeywordAnalyzer.js"></script>
    <script src="js/core/TripleOSInteractionAnalyzer.js"></script>
    <script src="js/core/TripleOSInteractionAnalyzer-v2-integration.js"></script>
    
    <!-- 64×64×64動的診断テキスト生成システム -->
    <script src="js/pages/future-simulator/DynamicKeywordGenerator.js"></script>
    
    <!-- Debug script removed for production -->
    
    <style>
        /* =================== */
        /* Critical CSS - 30KB以下 */
        /* HaQei哲学準拠 */
        /* =================== */

        /* Phase 2-3: リアルタイム検証システムのスタイル */
        .validation-panel {
            background: linear-gradient(135deg, rgba(79, 172, 254, 0.1), rgba(79, 172, 254, 0.05));
            border: 1px solid rgba(79, 172, 254, 0.3);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
        }

        .quality-indicator {
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .quality-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .quality-badge.excellent {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .quality-badge.good {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .quality-badge.marginal {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .quality-badge.poor {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }

        .validation-progress {
            display: grid;
            gap: 0.25rem;
            margin: 0.5rem 0;
        }

        .os-progress {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
        }

        .os-progress span {
            min-width: 100px;
            color: rgba(255, 255, 255, 0.7);
        }

        .recommendations {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .recommendation {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.85rem;
            border-left: 3px solid;
        }

        .recommendation.high {
            background: rgba(239, 68, 68, 0.1);
            border-color: #ef4444;
            color: #fecaca;
        }

        .recommendation.medium {
            background: rgba(245, 158, 11, 0.1);
            border-color: #f59e0b;
            color: #fed7aa;
        }

        .recommendation.info {
            background: rgba(34, 197, 94, 0.1);
            border-color: #22c55e;
            color: #bbf7d0;
        }

        /* Enhanced Progress and Error UX Styles */
        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .progress-phase {
            font-size: 0.9rem;
            color: var(--accent-500);
            font-weight: 600;
        }

        .progress-counter {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .progress-counter .current {
            font-weight: 700;
            color: var(--accent-500);
        }

        .progress-counter .separator {
            color: var(--primary-400);
        }

        .progress-counter .total {
            color: var(--primary-500);
        }

        .progress-steps {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            gap: 0.125rem;
        }

        .progress-step {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .progress-step.completed {
            background: var(--success-500);
            color: white;
        }

        .progress-step.active {
            background: var(--accent-500);
            color: white;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        .progress-step.pending {
            background: var(--primary-200);
            color: var(--primary-500);
        }

        .error-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .error-message {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 600px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .error-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .error-context {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .error-step, .error-code {
            font-size: 0.875rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            background: var(--primary-100);
            color: var(--primary-600);
        }

        .error-message-text {
            font-size: 1.1rem;
            color: var(--primary-700);
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .recovery-actions {
            margin: 1.5rem 0;
        }

        .recovery-actions h3 {
            color: var(--accent-500);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .recovery-actions ul {
            list-style: none;
            padding: 0;
        }

        .recovery-actions li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
            color: var(--primary-600);
        }

        .recovery-actions li::before {
            content: "→";
            position: absolute;
            left: 0;
            color: var(--accent-500);
            font-weight: bold;
        }

        .error-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        .loading-progress {
            margin-top: 1rem;
        }

        .loading-progress .progress-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .loading-progress .progress-fill {
            height: 100%;
            background: var(--accent-500);
            transition: width 0.3s ease;
        }

        .loading-progress .progress-text {
            text-align: center;
            font-size: 0.9rem;
            color: var(--primary-600);
        }

        @media (max-width: 768px) {
            .progress-steps {
                gap: 0.0625rem;
            }

            .progress-step {
                width: 1.5rem;
                height: 1.5rem;
                font-size: 0.625rem;
            }

            .error-message {
                margin: 1rem;
                padding: 1.5rem;
            }

            .error-actions {
                flex-direction: column;
            }
        }
        
        /* 1. リセット & 基盤 */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            /* HaQei ブランドカラー */
            --primary-900: #0f172a;
            --primary-800: #1e293b;
            --primary-700: #334155;
            --primary-600: #475569;
            --primary-500: #64748b;
            --primary-400: #94a3b8;
            --primary-300: #cbd5e1;
            --primary-200: #e2e8f0;
            --primary-100: #f1f5f9;
            --primary-50: #f8fafc;
            
            --accent-500: #6366f1;
            --accent-400: #8b5cf6;
            --accent-300: #a855f7;
            
            /* 基本カラー変数（テスト用） */
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --text-color: #374151;
            --bg-color: #f9fafb;
            
            /* セマンティックカラー */
            --success-500: #10b981;
            --warning-500: #f59e0b;
            --error-500: #ef4444;
            --info-500: #3b82f6;
            
            /* 八卦色彩 */
            --trigram-qian: #FFD700;    /* 乾(天) */
            --trigram-dui: #87CEEB;     /* 兌(沢) */
            --trigram-li: #FF4500;      /* 離(火) */
            --trigram-zhen: #8A2BE2;    /* 震(雷) */
            --trigram-xun: #32CD32;     /* 巽(風) */
            --trigram-kan: #1E90FF;     /* 坎(水) */
            --trigram-gen: #708090;     /* 艮(山) */
            --trigram-kun: #8B4513;     /* 坤(地) */
            
            /* レスポンシブサイズ */
            --font-sm: clamp(0.875rem, 2.5vw, 1rem);
            --font-base: clamp(1rem, 3vw, 1.125rem);
            --font-lg: clamp(1.25rem, 4vw, 1.5rem);
            --font-xl: clamp(1.5rem, 5vw, 2rem);
            --font-2xl: clamp(2rem, 6vw, 3rem);
            
            --space-xs: clamp(0.5rem, 2vw, 0.75rem);
            --space-sm: clamp(0.75rem, 3vw, 1rem);
            --space-md: clamp(1rem, 4vw, 1.5rem);
            --space-lg: clamp(1.5rem, 5vw, 2rem);
            --space-xl: clamp(2rem, 6vw, 3rem);
            
            --radius-sm: 0.5rem;
            --radius-md: 0.75rem;
            --radius-lg: 1rem;
            
            /* タッチターゲット */
            --tap-size: max(44px, 2.75rem);
        }
        
        html {
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, var(--primary-800) 0%, var(--primary-700) 50%, var(--primary-600) 100%);
            color: var(--primary-100);
            line-height: 1.6;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* 2. コンテナシステム */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: var(--space-md);
        }
        
        .screen {
            min-height: 100vh;
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding: var(--space-lg) var(--space-md);
        }
        
        .screen.active {
            display: flex;
        }
        
        /* 2.1 ウェルカム画面専用スタイル */
        .welcome-container {
            max-width: 900px;
            margin: 0 auto;
            padding: var(--space-md);
        }
        
        .hero-section {
            text-align: center;
            margin-bottom: var(--space-xl);
            animation: fadeInUp 1s ease-out;
        }
        
        .hero-title {
            font-size: clamp(2rem, 8vw, 3.5rem);
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-500), var(--accent-300), #fbbf24);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-sm);
            line-height: 1.2;
        }
        
        .hero-subtitle {
            font-size: var(--font-lg);
            color: var(--primary-200);
            margin-bottom: var(--space-lg);
            font-weight: 300;
        }
        
        .philosophy-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .philosophy-card {
            background: rgba(15, 23, 42, 0.7);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.4s ease;
            animation: fadeInUp 1s ease-out;
            animation-fill-mode: both;
        }
        
        .philosophy-card:nth-child(1) { animation-delay: 0.2s; }
        .philosophy-card:nth-child(2) { animation-delay: 0.4s; }
        .philosophy-card:nth-child(3) { animation-delay: 0.6s; }
        
        .philosophy-card:hover {
            border-color: rgba(99, 102, 241, 0.5);
            transform: translateY(-8px);
            box-shadow: 0 16px 48px rgba(99, 102, 241, 0.2);
        }
        
        .card-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: var(--space-md);
        }
        
        .engine-icon { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .interface-icon { background: linear-gradient(135deg, #8b5cf6, #a855f7); }
        .safemode-icon { background: linear-gradient(135deg, #10b981, #059669); }
        
        .card-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary-100);
            margin-bottom: var(--space-sm);
        }
        
        .card-description {
            color: var(--primary-300);
            line-height: 1.6;
            font-size: var(--font-sm);
        }
        
        .about-section {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            animation: fadeInUp 1s ease-out 0.8s;
            animation-fill-mode: both;
        }
        
        .about-title {
            font-size: var(--font-xl);
            font-weight: 600;
            color: var(--primary-100);
            margin-bottom: var(--space-md);
            text-align: center;
        }
        
        .about-content {
            color: var(--primary-200);
            line-height: 1.7;
            font-size: var(--font-base);
        }
        
        .highlight {
            color: var(--accent-400);
            font-weight: 600;
        }
        
        .experience-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
            animation: fadeInUp 1s ease-out 1s;
            animation-fill-mode: both;
        }
        
        .experience-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary-100);
            margin-bottom: var(--space-md);
            text-align: center;
        }
        
        .experience-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--space-md);
            text-align: center;
        }
        
        .step {
            color: var(--primary-200);
            font-size: var(--font-sm);
        }
        
        .step-number {
            display: block;
            width: 2rem;
            height: 2rem;
            background: var(--accent-500);
            color: white;
            border-radius: 50%;
            line-height: 2rem;
            text-align: center;
            font-weight: 600;
            margin: 0 auto var(--space-xs);
        }
        
        .cta-section {
            text-align: center;
            animation: fadeInUp 1s ease-out 1.2s;
            animation-fill-mode: both;
        }
        
        .start-button {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
            color: white;
            border: none;
            padding: var(--space-md) var(--space-xl);
            font-size: var(--font-lg);
            font-weight: 600;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
            min-height: calc(var(--tap-size) + 0.5rem);
            position: relative;
            overflow: hidden;
        }
        
        .start-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }
        
        .start-button:hover::before {
            left: 100%;
        }
        
        .start-button:hover {
            background: linear-gradient(135deg, var(--accent-400), var(--accent-300));
            transform: translateY(-4px);
            box-shadow: 0 12px 35px rgba(99, 102, 241, 0.4);
        }
        
        .disclaimer {
            margin-top: var(--space-lg);
            padding: var(--space-md);
            background: rgba(15, 23, 42, 0.6);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--accent-500);
        }
        
        .disclaimer-text {
            color: var(--primary-400);
            font-size: var(--font-sm);
            line-height: 1.5;
            text-align: left;
        }
        
        /* アニメーション定義 */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        .pulse-animation {
            animation: pulse 2s ease-in-out infinite;
            /* テスト時のアニメーション安定化 */
            animation-play-state: paused;
        }
        
        .pulse-animation:hover {
            animation-play-state: running;
        }
        
        /* 3. カードシステム */
        .card {
            background: rgba(15, 23, 42, 0.9);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 600px;
            margin-bottom: var(--space-md);
        }
        
        .card:hover {
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }
        
        /* 4. ボタンシステム */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-sm) var(--space-lg);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-base);
            font-weight: 600;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: var(--tap-size);
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
            color: white;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, var(--accent-400), var(--accent-300));
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }
        
        .btn-secondary {
            background: rgba(99, 102, 241, 0.1);
            color: var(--accent-400);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .btn-secondary:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.5);
        }
        
        .btn-lg {
            padding: var(--space-md) var(--space-xl);
            font-size: var(--font-lg);
            min-height: calc(var(--tap-size) + 0.5rem);
        }
        
        /* 5. 質問システム */
        .question-card {
            margin-bottom: var(--space-xl);
        }
        
        .question-header {
            text-align: center;
            margin-bottom: var(--space-lg);
        }
        
        .question-number {
            display: inline-block;
            width: 2rem;
            height: 2rem;
            background: var(--accent-500);
            color: white;
            border-radius: 50%;
            font-weight: 600;
            line-height: 2rem;
            text-align: center;
            margin-bottom: var(--space-sm);
        }
        
        .question-text {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary-100);
            margin-bottom: var(--space-md);
        }
        
        .options {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
        }
        
        .option {
            background: rgba(30, 41, 59, 0.6);
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: var(--tap-size);
            display: flex;
            align-items: center;
        }
        
        .option:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(99, 102, 241, 0.1);
            transform: translateY(-1px);
        }
        
        .option.selected {
            border-color: var(--accent-500);
            background: rgba(99, 102, 241, 0.2);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .option-text {
            font-size: var(--font-base);
            color: var(--primary-200);
            font-weight: 500;
        }
        
        /* 6. ナビゲーション */
        .nav-controls {
            display: flex;
            justify-content: space-between;
            gap: var(--space-md);
            margin-top: var(--space-xl);
            flex-wrap: wrap;
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(99, 102, 241, 0.2);
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: var(--space-lg);
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-500), var(--accent-400));
            transition: width 0.5s ease;
            border-radius: 3px;
        }
        
        /* 7. 結果表示 */
        .result-header {
            text-align: center;
            margin-bottom: var(--space-xl);
        }
        
        .result-title {
            font-size: var(--font-2xl);
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: var(--space-sm);
        }
        
        .os-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .os-card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .os-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .os-name {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary-100);
            margin-bottom: var(--space-sm);
        }
        
        .os-score {
            font-size: var(--font-xl);
            font-weight: 700;
            margin-bottom: var(--space-md);
        }
        
        .os-description {
            font-size: var(--font-sm);
            color: var(--primary-300);
            line-height: 1.5;
        }
        
        /* 8. エラーハンドリング */
        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: var(--radius-md);
            padding: var(--space-md);
            color: #fca5a5;
            text-align: center;
            margin: var(--space-md) 0;
        }
        
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-sm);
            padding: var(--space-lg);
        }
        
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(99, 102, 241, 0.3);
            border-top: 3px solid var(--accent-500);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* 9. レスポンシブ対応 */
        @media (max-width: 768px) {
            .container {
                padding: var(--space-sm);
                max-width: 100%;
            }
            
            .welcome-container {
                padding: var(--space-sm);
            }
            
            .screen {
                padding: var(--space-md) var(--space-sm);
            }
            
            .card {
                padding: var(--space-md);
            }
            
            .nav-controls {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .os-cards {
                grid-template-columns: 1fr;
                gap: var(--space-md);
            }
            
            /* ウェルカム画面モバイル対応 */
            .hero-title {
                font-size: clamp(2.5rem, 10vw, 3rem);
                margin-bottom: var(--space-md);
            }
            
            .hero-subtitle {
                font-size: var(--font-base);
                margin-bottom: var(--space-md);
            }
            
            .philosophy-grid {
                grid-template-columns: 1fr;
                gap: var(--space-md);
                margin-bottom: var(--space-lg);
            }
            
            .philosophy-card {
                padding: var(--space-md);
            }
            
            .card-icon {
                width: 2.5rem;
                height: 2.5rem;
                font-size: 1.25rem;
                margin-bottom: var(--space-sm);
            }
            
            .about-section {
                padding: var(--space-lg);
                margin-bottom: var(--space-lg);
            }
            
            .experience-section {
                padding: var(--space-md);
                margin-bottom: var(--space-lg);
            }
            
            .experience-steps {
                grid-template-columns: 1fr;
                gap: var(--space-sm);
            }
            
            .step {
                display: flex;
                align-items: center;
                gap: var(--space-sm);
                text-align: left;
            }
            
            .step-number {
                flex-shrink: 0;
                margin: 0;
            }
            
            .start-button {
                width: 100%;
                padding: var(--space-lg) var(--space-md);
                font-size: var(--font-base);
            }
            
            .disclaimer {
                margin-top: var(--space-md);
            }
        }
        
        @media (max-width: 480px) {
            .hero-title {
                font-size: 2.5rem;
            }
            
            .philosophy-card {
                padding: var(--space-sm);
            }
            
            .about-section {
                padding: var(--space-md);
            }
            
            .experience-section {
                padding: var(--space-sm);
            }
        }
        
        /* 9. 革新的結果表示システム - 4層複雑性保持アーキテクチャ */
        
        /* 4層複雑性ナビゲーション */
        .complexity-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: var(--space-xl);
            gap: var(--space-sm);
            flex-wrap: wrap;
            padding: var(--space-md);
            background: rgba(15, 23, 42, 0.4);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .tab-btn {
            background: rgba(15, 23, 42, 0.8);
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: var(--radius-md);
            padding: var(--space-sm) var(--space-lg);
            color: var(--primary-200);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: var(--tap-size);
            position: relative;
            overflow: hidden;
        }
        
        .tab-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(99, 102, 241, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .tab-btn:hover::before {
            left: 100%;
        }
        
        .tab-btn.active,
        .tab-btn:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--accent-500);
            color: var(--primary-100);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .tab-btn:focus {
            outline: 2px solid var(--accent-500);
            outline-offset: 2px;
        }
        
        /* 層コンテンツ表示システム */
        .layer-content {
            display: none;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.5s ease;
        }
        
        .layer-content.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
            animation: layerFadeIn 0.6s ease-out forwards;
        }
        
        @keyframes layerFadeIn {
            0% { opacity: 0; transform: translateY(30px) scale(0.95); }
            100% { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        /* セクションタイトル */
        .section-title {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--primary-100);
            margin-bottom: var(--space-lg);
            text-align: center;
            position: relative;
            padding: var(--space-md) 0;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 3px;
            background: linear-gradient(135deg, var(--accent-500), var(--accent-300));
            border-radius: 2px;
        }
        
        .subsection-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary-200);
            margin: var(--space-lg) 0 var(--space-md) 0;
            position: relative;
            padding-left: var(--space-md);
        }
        
        .subsection-title::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, var(--accent-400), var(--accent-300));
            border-radius: 2px;
        }
        
        /* Triple OS相互関係可視化セクション */
        .triple-os-interaction-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin: var(--space-xl) 0;
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .interaction-visualization {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-lg);
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
            min-height: 450px;
        }
        
        .interaction-legend {
            display: flex;
            flex-direction: column;
            gap: var(--space-sm);
            padding: var(--space-lg);
            background: rgba(15, 23, 42, 0.8);
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: var(--space-sm);
            color: var(--primary-200);
            font-size: var(--font-sm);
            font-weight: 500;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .dynamic-balance {
            background: rgba(99, 102, 241, 0.1);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            border: 1px solid rgba(99, 102, 241, 0.3);
            margin-top: var(--space-lg);
        }
        
        /* 8次元レーダーチャートセクション */
        .eight-dimensional-radar {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: rgba(15, 23, 42, 0.4);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(139, 92, 246, 0.2);
            min-height: 550px;
        }
        
        /* 八卦エネルギー分析セクション */
        .bagua-energy-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            border: 1px solid rgba(139, 92, 246, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .trigram-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--space-lg);
            margin-top: var(--space-lg);
        }
        
        .trigram-card {
            background: rgba(139, 92, 246, 0.1);
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .trigram-card:hover {
            transform: translateY(-4px);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 8px 24px rgba(139, 92, 246, 0.15);
        }
        
        .trigram-name {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--accent-300);
            margin-bottom: var(--space-sm);
        }
        
        .trigram-energy-value {
            font-size: var(--font-xl);
            font-weight: 700;
            color: var(--primary-100);
            margin-bottom: var(--space-sm);
        }
        
        .trigram-description {
            color: var(--primary-200);
            font-size: var(--font-sm);
            line-height: 1.5;
        }
        
        /* エネルギーフローセクション */
        .energy-flow-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            border: 1px solid rgba(168, 85, 247, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .energy-flow {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
            padding: var(--space-lg);
            background: rgba(168, 85, 247, 0.05);
            border-radius: var(--radius-md);
            border: 1px solid rgba(168, 85, 247, 0.2);
        }
        
        /* 64卦解釈システムセクション */
        .hexagram-analysis-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            border: 1px solid rgba(251, 191, 36, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .hexagram-analysis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .hexagram-card {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            transition: all 0.3s ease;
        }
        
        .hexagram-card:hover {
            transform: translateY(-4px);
            border-color: rgba(251, 191, 36, 0.5);
            box-shadow: 0 8px 24px rgba(251, 191, 36, 0.15);
        }
        
        .hexagram-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: #fbbf24;
            margin-bottom: var(--space-md);
        }
        
        .hexagram-content {
            color: var(--primary-200);
            line-height: 1.6;
        }
        
        .change-hexagram-section,
        .iching-wisdom-section {
            background: rgba(251, 191, 36, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            margin: var(--space-lg) 0;
            border: 1px solid rgba(251, 191, 36, 0.2);
        }
        
        .classical-wisdom {
            background: rgba(251, 191, 36, 0.08);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            border: 1px solid rgba(251, 191, 36, 0.3);
            font-size: var(--font-lg);
            line-height: 1.8;
            color: var(--primary-200);
            font-style: italic;
        }
        
        /* HaQei哲学統合セクション */
        .HaQei-integration-section {
            background: rgba(15, 23, 42, 0.6);
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            border: 1px solid rgba(16, 185, 129, 0.2);
            backdrop-filter: blur(10px);
        }
        
        .HaQei-wisdom {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--radius-md);
            padding: var(--space-xl);
            margin-bottom: var(--space-xl);
            font-size: var(--font-lg);
            line-height: 1.8;
            color: var(--primary-200);
            position: relative;
        }
        
        .HaQei-wisdom::before {
            content: '"';
            position: absolute;
            top: -10px;
            left: 20px;
            font-size: 4rem;
            color: rgba(16, 185, 129, 0.3);
            font-family: serif;
        }
        
        /* パーソナライズド洞察グリッド */
        .insights-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }
        
        .insight-card {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .insight-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--success-500), rgba(16, 185, 129, 0.5));
        }
        
        .insight-card:hover {
            transform: translateY(-4px);
            border-color: rgba(16, 185, 129, 0.5);
            box-shadow: 0 8px 24px rgba(16, 185, 129, 0.15);
        }
        
        .insight-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--primary-100);
            margin-bottom: var(--space-sm);
        }
        
        .insight-content {
            color: var(--primary-200);
            line-height: 1.6;
            font-size: var(--font-base);
        }
        
        /* 実践的戦略提案セクション */
        .strategies-container {
            display: flex;
            flex-direction: column;
            gap: var(--space-lg);
        }
        
        .strategy-item {
            background: rgba(16, 185, 129, 0.05);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-left: 4px solid var(--success-500);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            transition: all 0.3s ease;
        }
        
        .strategy-item:hover {
            background: rgba(16, 185, 129, 0.08);
            border-left-width: 6px;
            transform: translateX(4px);
        }
        
        .strategy-title {
            font-size: var(--font-lg);
            font-weight: 600;
            color: var(--success-500);
            margin-bottom: var(--space-sm);
            display: flex;
            align-items: center;
            gap: var(--space-sm);
        }
        
        .strategy-description {
            color: var(--primary-200);
            line-height: 1.6;
            margin-bottom: var(--space-md);
        }
        
        .strategy-actions {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-sm);
        }
        
        .strategy-action {
            background: rgba(16, 185, 129, 0.2);
            color: var(--primary-100);
            border: none;
            border-radius: var(--radius-sm);
            padding: var(--space-xs) var(--space-sm);
            font-size: var(--font-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .strategy-action:hover {
            background: rgba(16, 185, 129, 0.3);
            transform: translateY(-2px);
        }
        
        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .complexity-tabs {
                flex-direction: column;
                align-items: stretch;
            }
            
            .tab-btn {
                text-align: center;
                margin-bottom: var(--space-xs);
            }
            
            .interaction-visualization {
                flex-direction: column;
                min-height: auto;
            }
            
            #os-interaction-chart {
                width: 100%;
                max-width: 350px;
                height: auto;
            }
            
            .eight-dimensional-radar {
                min-height: auto;
                padding: var(--space-md);
            }
            
            #8d-vector-chart {
                width: 100%;
                max-width: 400px;
                height: auto;
            }
            
            .insights-grid {
                grid-template-columns: 1fr;
            }
            
            .hexagram-analysis {
                grid-template-columns: 1fr;
            }
            
            .trigram-analysis {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }
        
        /* 10. アクセシビリティ */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--accent-500);
            color: white;
            padding: 8px;
            z-index: 1000;
            text-decoration: none;
            border-radius: 4px;
        }
        
        .skip-link:focus {
            top: 6px;
        }
        
        /* フォーカス管理 */
        .btn:focus,
        .option:focus {
            outline: 2px solid var(--accent-400);
            outline-offset: 2px;
        }
        
        /* プリファレンス対応 */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        @media (prefers-contrast: high) {
            :root {
                --primary-100: #ffffff;
                --primary-200: #f0f0f0;
                --primary-300: #d0d0d0;
                --accent-500: #0066ff;
            }
            
            .btn, .option, .card {
                border-width: 2px;
            }
        }
        
        @media print {
            body {
                background: white !important;
                color: black !important;
            }
            
            .btn, .nav-controls {
                display: none !important;
            }
        }
        
        /* モバイル最適化の追加 */
        @media (max-width: 480px) {
            .question-title {
                font-size: 1.1rem;
                line-height: 1.5;
                padding: var(--space-sm);
            }
            
            .option {
                padding: 12px 16px;
                font-size: 0.95rem;
                min-height: 48px;
                display: flex;
                align-items: center;
            }
            
            .nav-button, .start-button {
                min-height: 44px;
                padding: 12px 20px;
                font-size: 0.95rem;
            }
            
            .os-card {
                padding: var(--space-md);
                margin-bottom: var(--space-md);
            }
            
            .os-card h3 {
                font-size: 1.1rem;
            }
            
            .os-card p {
                font-size: 0.9rem;
                line-height: 1.5;
            }
            
            /* スムーズスクロール */
            body {
                -webkit-overflow-scrolling: touch;
            }
            
            /* タップハイライト無効化 */
            * {
                -webkit-tap-highlight-color: transparent;
            }
        }
        
        /* Phase 3: 内的対話システムスタイル */
        .virtual-persona-dialogue-section {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(59, 130, 246, 0.05));
            border-radius: var(--radius-lg);
            padding: var(--space-xl);
            margin: var(--space-xl) 0;
            border: 1px solid rgba(99, 102, 241, 0.2);
            backdrop-filter: blur(10px);
        }

        .persona-dialogue-container {
            margin: var(--space-lg) 0;
        }

        .dialogue-situation {
            text-align: center;
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
        }

        .situation-title {
            color: var(--primary-100);
            font-size: var(--font-xl);
            font-weight: 700;
            margin-bottom: var(--space-sm);
        }

        .situation-context {
            color: var(--primary-300);
            font-size: var(--font-md);
            line-height: 1.5;
        }

        .dialogue-participants {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin: var(--space-lg) 0;
        }

        .persona-dialogue-card {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--radius-md);
            padding: var(--space-lg);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .persona-dialogue-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--persona-color, #6366f1);
        }

        .persona-dialogue-card.engine {
            --persona-color: #6366f1;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .persona-dialogue-card.interface {
            --persona-color: #8b5cf6;
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .persona-dialogue-card.safemode {
            --persona-color: #10b981;
            border: 1px solid rgba(16, 185, 129, 0.3);
        }

        .persona-dialogue-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            border-color: var(--persona-color);
        }

        .persona-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--space-md);
        }

        .persona-symbol {
            font-size: var(--font-xl);
            margin-right: var(--space-sm);
        }

        .persona-name {
            color: var(--persona-color);
            font-size: var(--font-lg);
            font-weight: 700;
            flex: 1;
        }

        .strength-indicator {
            background: rgba(255, 255, 255, 0.1);
            color: var(--persona-color);
            padding: var(--space-xs) var(--space-sm);
            border-radius: var(--radius-sm);
            font-size: var(--font-sm);
            font-weight: 600;
        }

        .persona-message {
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-sm);
            padding: var(--space-md);
        }

        .dialogue-text {
            color: var(--primary-200);
            font-size: var(--font-md);
            line-height: 1.6;
            font-style: italic;
            margin: 0;
        }

        .dialogue-text::before {
            content: '"';
            color: var(--persona-color);
            font-size: var(--font-lg);
        }

        .dialogue-text::after {
            content: '"';
            color: var(--persona-color);
            font-size: var(--font-lg);
        }

        /* シナリオ選択 */
        .scenario-selector {
            margin-top: var(--space-xl);
            text-align: center;
        }

        .scenario-selector h4 {
            color: var(--primary-200);
            font-size: var(--font-lg);
            margin-bottom: var(--space-lg);
        }

        .scenario-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-md);
            justify-content: center;
        }

        .scenario-btn {
            background: rgba(255, 255, 255, 0.05);
            color: var(--primary-200);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-md);
            padding: var(--space-md) var(--space-lg);
            font-size: var(--font-md);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .scenario-btn:hover,
        .scenario-btn.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.5);
            color: var(--primary-100);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
        }

        /* レスポンシブ対応 */
        @media (max-width: 768px) {
            .dialogue-participants {
                grid-template-columns: 1fr;
                gap: var(--space-md);
            }
            
            .scenario-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .scenario-btn {
                width: 100%;
                max-width: 300px;
            }
        }

        /* 強度に応じたアニメーション効果 */
        .persona-dialogue-card[data-strength] {
            animation: subtle-pulse 3s ease-in-out infinite;
        }

        .persona-dialogue-card[data-strength="high"] {
            animation-duration: 2s;
            box-shadow: 0 0 20px rgba(var(--persona-color-rgb, 99, 102, 241), 0.3);
        }

        .persona-dialogue-card[data-strength="medium"] {
            animation-duration: 2.5s;
        }

        .persona-dialogue-card[data-strength="low"] {
            animation-duration: 3.5s;
            opacity: 0.8;
        }

        @keyframes subtle-pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        /* アクセシビリティ向上 */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation: none !important;
                transition: none !important;
            }
        }
        
        /* Task 14-18: レスポンシブ対応 */
        
        /* モバイル対応 (320px - 480px) */
        @media screen and (max-width: 480px) {
            :root {
                --font-base: 16px; /* 最小14px以上を保証 */
                --font-sm: 14px;
                --space-sm: 8px;
                --space-md: 12px;
                --space-lg: 16px;
                --space-xl: 24px;
            }
            
            .container {
                padding: var(--space-md) !important;
                max-width: 100% !important;
            }
            
            .one-pager-summary {
                padding: 15px !important;
            }
            
            .main-types {
                grid-template-columns: 1fr !important;
                gap: 12px !important;
            }
            
            .type-card {
                padding: 12px !important;
                min-height: 60px;
            }
            
            /* タッチターゲット44px以上 */
            button, .btn, .option-card {
                min-height: 44px !important;
                padding: 12px 16px !important;
                font-size: 16px !important; /* iOS ズーム防止 */
            }
            
            .nav-controls {
                flex-direction: column;
                gap: 10px;
            }
            
            .nav-controls button {
                width: 100%;
            }
            
            /* 横スクロール防止 */
            body, html {
                overflow-x: hidden !important;
            }
            
            .dialogue-participants {
                flex-direction: column;
            }
            
            .persona-dialogue-card {
                width: 100% !important;
            }
            
            /* フォントサイズ調整 */
            h1 { font-size: 24px !important; }
            h2 { font-size: 20px !important; }
            h3 { font-size: 18px !important; }
            h4 { font-size: 16px !important; }
            
            /* グリッドを縦並びに */
            .traits-section ul {
                font-size: 14px;
            }
            
            div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }
        
        /* タブレット対応 (481px - 768px) */
        @media screen and (min-width: 481px) and (max-width: 768px) {
            .container {
                padding: 20px !important;
            }
            
            .main-types {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            button, .btn {
                min-height: 44px;
                font-size: 16px;
            }
            
            .dialogue-participants {
                flex-wrap: wrap;
            }
            
            .persona-dialogue-card {
                flex: 1 1 45%;
            }
        }
        
        /* デスクトップ (769px以上) */
        @media screen and (min-width: 769px) {
            .main-types {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .dialogue-participants {
                flex-direction: row;
            }
        }
        
        /* 印刷対応 */
        @media print {
            /* 背景色を白に */
            body, html {
                background: white !important;
                color: black !important;
            }
            
            * {
                background: transparent !important;
                color: black !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            
            /* 不要な要素を非表示 */
            button, .btn, .nav-controls, .advanced-details,
            .scenario-buttons, .print-footer {
                display: none !important;
            }
            
            /* サマリーのスタイル調整 */
            .one-pager-summary {
                background: white !important;
                border: 1px solid #ccc !important;
                page-break-inside: avoid;
            }
            
            .type-card {
                border: 1px solid #333 !important;
                background: white !important;
            }
            
            /* リンク表示 */
            a[href]:after {
                content: " (" attr(href) ")";
            }
            
            /* ページ設定 */
            @page {
                margin: 1.5cm;
                size: A4;
            }
            
            /* 改ページ制御 */
            h1, h2, h3 {
                page-break-after: avoid;
            }
            
            .main-types {
                page-break-inside: avoid;
            }
        }
        
        /* 大画面対応 (1920px以上) */
        @media screen and (min-width: 1920px) {
            .container {
                max-width: 1400px;
            }
            
            :root {
                --font-base: 18px;
                --font-lg: 22px;
                --font-xl: 26px;
                --font-2xl: 32px;
            }
        }
    </style>
</head>

<body>
    <!-- アクセシビリティ -->
    <a href="#main-content" class="skip-link">メインコンテンツへスキップ</a>
    
    <!-- ライブリージョン -->
    <div id="announcements" class="sr-only" aria-live="polite" role="status"></div>
    
    <!-- メインコンテンツ -->
    <main id="main-content">
        <!-- ウェルカム画面 -->
        <section id="welcome-screen" class="screen active" aria-labelledby="welcome-title">
            <div class="welcome-container">
                <!-- ヒーローセクション -->
                <div class="hero-section">
                    <h1 id="welcome-title" class="hero-title">HaQei</h1>
                    <p class="hero-subtitle">
                        あなたの中にある<span class="highlight">3つの仮想人格</span>を創造的に表現する戦略的生成ツール
                    </p>
                </div>

                <!-- HaQei哲学説明 -->
                <div class="philosophy-grid">
                    <div class="philosophy-card os-card">
                        <div class="card-icon engine-icon">🎯</div>
                        <h3 class="card-title">Engine OS</h3>
                        <p class="card-description">
                            あなたの<strong>創造的な価値観</strong>を表現する仮想人格。深層に眠る革新性や探求心、新しい可能性への憧れを象徴的に描写します。これは「創造者としてのあなた」の核となる部分です。
                        </p>
                    </div>
                    
                    <div class="philosophy-card os-card">
                        <div class="card-icon interface-icon">💬</div>
                        <h3 class="card-title">Interface OS</h3>
                        <p class="card-description">
                            <strong>社会的な場面</strong>で現れる仮想人格。他者との調和や協調性、コミュニケーションへの志向性を象徴的に表現します。これは「社会の橋渡し役としてのあなた」を創造的に描写します。
                        </p>
                    </div>
                    
                    <div class="philosophy-card os-card">
                        <div class="card-icon safemode-icon">🛡️</div>
                        <h3 class="card-title">Safe Mode OS</h3>
                        <p class="card-description">
                            <strong>困難な状況</strong>で現れる慎重な仮想人格。リスクを見極め、安全を確保しようとする側面を象徴的に表現します。これは「守護者としてのあなた」を創造的に描写します。
                        </p>
                    </div>
                </div>

                <!-- HaQeiについて -->
                <div class="about-section">
                    <h2 class="about-title">HaQeiとは？</h2>
                    <div class="about-content">
                        <p style="margin-bottom: var(--space-md);">
                            HaQeiは<span class="highlight">占いや診断ではありません</span>。古代中国の智慧である易経（I-Ching）を<span class="highlight">豊かなメタファー・表現手段</span>として活用し、あなたの多面性を創造的に描写する<span class="highlight">仮想人格生成ツール</span>です。
                        </p>
                        <p style="margin-bottom: var(--space-md);">
                            私たちは「あなたは○○な人です」とは決して断言しません。代わりに「<span class="highlight">○○という側面が参考になるかもしれません</span>」という形で、一つの視点として情報を提供します。
                        </p>
                        <p>
                            この生成結果は科学的根拠に基づくものではなく、<span class="highlight">創造的表現・物語性</span>を重視した象徴的な描写です。一つの視点として楽しみ、自己理解の<span class="highlight">インスピレーション</span>としてご活用ください。
                        </p>
                    </div>
                </div>

                <!-- 体験の流れ -->
                <div class="experience-section">
                    <h3 class="experience-title">体験の流れ（約5分）</h3>
                    <div class="experience-steps">
                        <div class="step">
                            <span class="step-number">1</span>
                            <p>36問の質問<br><small>多面的な内面探索</small></p>
                        </div>
                        <div class="step">
                            <span class="step-number">2</span>
                            <p>3つの仮想人格生成<br><small>易経メタファーによる表現</small></p>
                        </div>
                        <div class="step">
                            <span class="step-number">3</span>
                            <p>創造的な自己理解<br><small>象徴的表現の活用</small></p>
                        </div>
                    </div>
                </div>

                <!-- 開始ボタン -->
                <div class="cta-section">
                    <button id="start-btn" class="start-button pulse-animation">
                        分析を始める
                    </button>
                    
                    <!-- スモークテストボタン -->
                    <div class="smoke-test-section" style="margin-top: var(--space-md);">
                        <button id="smoke-test-btn" class="btn btn-outline" style="margin-right: var(--space-sm);">
                            🧪 スモークテスト実行
                        </button>
                        <div id="smoke-test-results" class="smoke-test-results" style="display: none; margin-top: var(--space-sm); padding: var(--space-sm); background: var(--surface-100); border-radius: var(--radius-md); font-size: 0.9em;">
                            <!-- テスト結果がここに表示される -->
                        </div>
                    </div>
                    
                    <div class="disclaimer">
                        <p class="disclaimer-text">
                            <strong>重要な注意事項：</strong> この仮想人格生成は、あなたの人格を決定づけるものではありません。創造的な表現として生成される象徴的な描写を、一つのインスピレーション源として楽しんでください。生成結果はメタファー・物語として捉え、常にご自身の判断を最優先してください。
                        </p>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 質問画面 -->
        <section id="question-screen" class="screen" aria-labelledby="question-title">
            <div class="container">
                <div class="progress-bar">
                    <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
                </div>
                
                <!-- Phase 2-3: リアルタイム検証表示エリア -->
                <div id="realtime-validation" class="validation-panel" style="display: none;">
                    <div id="quality-indicator" class="quality-indicator">
                        <!-- 品質インジケータ -->
                    </div>
                    <div id="validation-progress" class="validation-progress">
                        <!-- OS進捗表示 -->
                    </div>
                    <div id="recommendations" class="recommendations">
                        <!-- 推奨事項表示 -->
                    </div>
                </div>
                
                <div class="card question-card">
                    <div class="question-header">
                        <span id="question-number" class="question-number">1</span>
                        <h2 id="question-title" class="question-text"></h2>
                    </div>
                    
                    <div id="options-container" class="options" role="radiogroup" aria-labelledby="question-title">
                        <!-- 動的に質問オプションが挿入される -->
                    </div>
                </div>
                
                <div class="nav-controls">
                    <button id="prev-btn" class="btn btn-secondary" disabled>前の質問</button>
                    <button id="next-btn" class="btn btn-primary" disabled>次の質問</button>
                </div>
            </div>
        </section>
        
        <!-- 分析中画面 -->
        <section id="analysis-screen" class="screen" aria-labelledby="analysis-title">
            <div class="container">
                <div class="card">
                    <h2 id="analysis-title" class="result-title">分析中...</h2>
                    <div class="loading">
                        <div class="spinner"></div>
                        <span>Triple OSシステムを分析しています</span>
                    </div>
                    <p style="text-align: center; color: var(--primary-300); margin-top: var(--space-lg);">
                        HaQei哲学に基づくTriple OS分析を実行中です<br>
                        <small>64卦データベース・8次元ベクトルエンジン統合</small>
                    </p>
                </div>
            </div>
        </section>
        
        <!-- OSアナライザー統一結果画面 -->
        <section id="results-screen" class="screen" aria-labelledby="results-title">
            <div class="container">
                <!-- 統一結果表示コンテナ（ScreenManager管理） -->
                <div id="os-analyzer-unified-results">
                    <!-- サマリービュー（JSから参照される） -->
                    <div id="summary-view" class="os-analyzer-section"></div>
                    
                    <!-- OSカードコンテナ（JSから参照される） -->
                    <div id="os-cards-container" class="os-analyzer-section"></div>
                    
                    <!-- T2-1: 8角形レーダーチャート -->
                    <div id="os-analyzer-radar-chart" class="os-analyzer-section"></div>
                    
                    <!-- T2-2: 3つのOS統合タイトル生成 -->
                    <div id="os-analyzer-title-generator" class="os-analyzer-section">
                        <div id="persona-main-title"></div>
                        <div id="persona-subtitle"></div>
                        <div id="title-generation-explanation"></div>
                        <div id="alternative-titles-list"></div>
                    </div>
                    
                    <!-- T2-3: Safe Mode OS過剰状態可視化 -->
                    <div id="os-analyzer-stress-analysis" class="os-analyzer-section">
                        <div id="stress-status-indicator"></div>
                        <div id="stress-meters-display"></div>
                        <div id="stress-recommendations-list"></div>
                    </div>
                </div>
                
                <!-- エラー表示用 -->
                <div id="os-analyzer-error-container" style="display: none;">
                    <!-- エラー時の統一表示 -->
                </div>
                
                <!-- アクション -->
                <div class="os-analyzer-actions" style="text-align: center; margin-top: 40px;">
                    <button id="restart-analysis-btn" class="btn btn-secondary">
                        🔄 もう一度分析する
                    </button>
                    <button id="screenshot-optimized-btn" class="btn btn-outline" style="margin-left: 15px;">
                        📸 結果をシェア
                    </button>
                </div>
            </div>
        </section>
        
        <!-- エラー画面 -->
        <section id="error-screen" class="screen" aria-labelledby="error-title">
            <div class="container">
                <div class="card">
                    <h2 id="error-title" class="result-title" style="color: var(--error-500);">エラーが発生しました</h2>
                    <div id="error-message" class="error-message">
                        <!-- 動的にエラーメッセージが挿入される -->
                    </div>
                    <div style="text-align: center; margin-top: var(--space-lg);">
                        <button id="retry-btn" class="btn btn-primary">
                            再試行
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Questions Data -->
    <script src="assets/js/questions-full.js"></script>
    
    <!-- EMERGENCY FIX: Block 8-question system and force 36-question system -->
    <script>
    // EMERGENCY: Override any 8-question system
    (function() {
        console.log('🚨 EMERGENCY FIX: Blocking 8-question system');
        
        // Monitor for 8-question system and block it
        let attempts = 0;
        const maxAttempts = 10;
        
        const checkAndBlock = function() {
            attempts++;
            
            if (window.QUESTIONS && window.QUESTIONS.length === 8) {
                console.warn('⚠️ EMERGENCY: Detected and removing 8-question system, attempt', attempts);
                delete window.QUESTIONS;
            }
            
            if (attempts < maxAttempts) {
                setTimeout(checkAndBlock, 100);
            } else {
                console.log('✅ EMERGENCY: 8-question blocking completed');
            }
        };
        
        // Start monitoring immediately
        checkAndBlock();
        
        // Also monitor on DOMContentLoaded
        document.addEventListener('DOMContentLoaded', checkAndBlock);
    })();
    </script>
    
    <!-- Health Monitoring System -->
    <script src="js/health-beacon.js"></script>
    
    <!-- Screen Manager - 画面遷移を統一管理 -->
    <script src="js/core/ScreenManager.js"></script>
    
    <!-- Main Application Script (CSP Compliant) -->
    <script src="assets/js/app.js"></script>
    
    <script>
        // ==========================================
        // HaQei Emergency Analyzer - To be extracted
        // Temporary inline script for CSP migration
        // ==========================================
        
        'use strict';
        
        // 易経専門家による36問設問システム - HaQei Triple OS分析
        // Engine OS (Q1-Q12): 乾_創造性・震_行動性・坎_探求性中心
        // Interface OS (Q13-Q24): 兌_調和性・離_表現性・巽_適応性中心
        // Safe Mode OS (Q25-Q36): 艮_安定性・坤_受容性中心
        
        // EMERGENCY FIX: 8問システムを無効化し、36問のquestions-full.jsを使用
        // この定義はコメントアウトし、外部ファイルから読み込む
        /*
        const QUESTIONS = [
          // ========== ENGINE OS測定質問 (Q1-Q12) ==========
          // Q1-Q3: 乾_創造性測定（天卦・創造力・革新性）
          {
            id: "q1",
            text: "新しいことを始めるとき、あなたはどんなアプローチを取りますか？",
            category: { title: "乾_創造性", description: "創造力・革新性の測定" },
            options: [
              { value: "A", text: "今までにない斬新な方法を考えて試してみる", scoring: { "乾_創造性": 3.0, "離_表現性": 1.5, "艮_安定性": -1.0 } },
              { value: "B", text: "既存のやり方を参考にしつつ、自分なりに工夫する", scoring: { "乾_創造性": 1.5, "坎_探求性": 1.5, "巽_適応性": 1.0 } },
              { value: "C", text: "周りの人と相談しながら、一番良い方法を決める", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "乾_創造性": -0.5 } },
              { value: "D", text: "実績のある確実な方法を選んで着実に進める", scoring: { "艮_安定性": 2.5, "坎_探求性": 1.0, "乾_創造性": -1.0 } },
              { value: "E", text: "状況を見ながら、その都度やり方を調整する", scoring: { "巽_適応性": 2.5, "兌_調和性": 1.0, "艮_安定性": -0.5 } }
            ]
          },
          {
            id: "q2",
            text: "何か新しいものを創り出したいという気持ちが高まったとき、どう行動しますか？",
            category: { title: "乾_創造性", description: "創造的衝動と実現への意志力測定" },
            options: [
              { value: "A", text: "ゼロから全く新しいものを作り上げたくなる", scoring: { "乾_創造性": 3.0, "震_行動性": 2.0, "艮_安定性": -1.0 } },
              { value: "B", text: "まず物事の本質や仕組みを深く理解したくなる", scoring: { "坎_探求性": 2.5, "乾_創造性": 1.5, "兌_調和性": -0.5 } },
              { value: "C", text: "仲間と一緒にアイデアを出し合いたくなる", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "乾_創造性": 1.0 } },
              { value: "D", text: "長く続く価値あるものをじっくり作りたくなる", scoring: { "艮_安定性": 2.5, "坤_受容性": 1.5, "乾_創造性": -0.5 } },
              { value: "E", text: "タイミングを見計らって最適な形で実現したくなる", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.0, "震_行動性": -0.5 } }
            ]
          },
          {
            id: "q3",
            text: "新しいスタートを切るとき、どんな気持ちになりますか？",
            category: { title: "乾_創造性", description: "創造性における始原力と開拓精神の測定" },
            options: [
              { value: "A", text: "わくわくして、すぐにでも挑戦したくなる", scoring: { "乾_創造性": 3.0, "離_表現性": 1.5, "坤_受容性": -1.0 } },
              { value: "B", text: "仲間と一緒なら頑張れると感じる", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "乾_創造性": 1.0 } },
              { value: "C", text: "まずよく調べてから始めたいと思う", scoring: { "坎_探求性": 2.5, "乾_創造性": 1.5, "兌_調和性": -0.5 } },
              { value: "D", text: "しっかり準備を整えてから始めたいと感じる", scoring: { "艮_安定性": 2.5, "坤_受容性": 1.5, "乾_創造性": 0.5 } },
              { value: "E", text: "状況を見ながら柔軟に対応したいと思う", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.0, "乾_創造性": 1.0 } }
            ]
          },

          // Q4-Q6: 震_行動性測定（雷卦・行動力・実行力）
          {
            id: "q4",
            text: "すぐに決めて行動しなければならない場面で、あなたはどうしますか？",
            category: { title: "震_行動性", description: "行動力・実行力の測定" },
            options: [
              { value: "A", text: "直感を信じて、すぐに行動に移す", scoring: { "震_行動性": 3.0, "乾_創造性": 1.0, "艮_安定性": -1.5 } },
              { value: "B", text: "素早く状況を把握してから最善の行動をとる", scoring: { "坎_探求性": 2.5, "震_行動性": 1.5, "艮_安定性": -0.5 } },
              { value: "C", text: "チームメンバーと連携して一緒に動く", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "震_行動性": 1.0 } },
              { value: "D", text: "リスクを考えて、できるだけ安全な選択をする", scoring: { "艮_安定性": 2.5, "坎_探求性": 1.5, "震_行動性": -0.5 } },
              { value: "E", text: "状況に合わせて臨機応変に対応する", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.5, "震_行動性": 0.5 } }
            ]
          },
          {
            id: "q5",
            text: "人生の転機において、あなたの行動原理は？",
            category: { title: "震_行動性", description: "転換期における行動パターンと決断力測定" },
            options: [
              { value: "A", text: "直感を信じて大胆な変化に挑戦する", scoring: { "震_行動性": 3.0, "離_表現性": 2.0, "艮_安定性": -1.0 } },
              { value: "B", text: "本質を見極めて根本的変革を図る", scoring: { "坎_探求性": 2.5, "震_行動性": 2.0, "兌_調和性": -0.5 } },
              { value: "C", text: "周囲と歩調を合わせて協調的に変化する", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "震_行動性": 0.5 } },
              { value: "D", text: "慎重に段階を踏んで着実に変化する", scoring: { "艮_安定性": 2.5, "坤_受容性": 1.5, "震_行動性": -1.0 } },
              { value: "E", text: "時機を見計らって最適なタイミングで行動する", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.0, "震_行動性": 1.0 } }
            ]
          },
          {
            id: "q6",
            text: "「動」のエネルギーが高まったとき、あなたはどう表現しますか？",
            category: { title: "震_行動性", description: "動的エネルギーの表現方法と行動様式測定" },
            options: [
              { value: "A", text: "創造的な新企画を立ち上げて実現に向かう", scoring: { "乾_創造性": 2.5, "震_行動性": 2.5, "艮_安定性": -0.5 } },
              { value: "B", text: "エネルギッシュに行動して周りを巻き込む", scoring: { "震_行動性": 3.0, "離_表現性": 2.0, "坤_受容性": -0.5 } },
              { value: "C", text: "深い探求活動に没頭して真理を追求する", scoring: { "坎_探求性": 2.5, "震_行動性": 1.5, "兌_調和性": -0.5 } },
              { value: "D", text: "みんなと一緒に楽しく活動する", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "震_行動性": 1.5 } },
              { value: "E", text: "状況に応じて最も効果的な方法を選択する", scoring: { "巽_適応性": 2.5, "震_行動性": 1.0, "坎_探求性": 1.0 } }
            ]
          },

          // Q7-Q9: 坎_探求性測定（水卦・探究心・深層理解）
          {
            id: "q7",
            text: "何かを深く理解したいと思ったとき、どのように学びますか？",
            category: { title: "坎_探求性", description: "探究心・深層理解力の測定" },
            options: [
              { value: "A", text: "とことん調べて、根本から理解しようとする", scoring: { "坎_探求性": 3.0, "艮_安定性": 1.0, "兌_調和性": -0.5 } },
              { value: "B", text: "独自の視点で新しい理解の仕方を見つける", scoring: { "乾_創造性": 2.0, "坎_探求性": 2.0, "艮_安定性": -0.5 } },
              { value: "C", text: "いろいろな人の意見を聞いて理解を深める", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "坎_探求性": 1.0 } },
              { value: "D", text: "実践で使えることを中心に理解する", scoring: { "艮_安定性": 2.0, "坤_受容性": 1.5, "坎_探求性": 1.0 } },
              { value: "E", text: "その時々で最も効率的な方法を選ぶ", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.0, "震_行動性": -0.5 } }
            ]
          },
          {
            id: "q8",
            text: "未知の領域に踏み込むとき、あなたの探求姿勢は？",
            category: { title: "坎_探求性", description: "未知への探求と知識欲の深さ測定" },
            options: [
              { value: "A", text: "危険を顧みず真理の深淵まで探究する", scoring: { "坎_探求性": 3.0, "震_行動性": 1.5, "艮_安定性": -1.0 } },
              { value: "B", text: "革新的な方法で未踏の領域を開拓する", scoring: { "乾_創造性": 2.5, "坎_探求性": 2.0, "艮_安定性": -0.5 } },
              { value: "C", text: "仲間と協力して安全に探求を進める", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "坎_探求性": 1.0 } },
              { value: "D", text: "着実に段階を踏んで確実に理解を深める", scoring: { "艮_安定性": 2.5, "坎_探求性": 1.0, "乾_創造性": -1.0 } },
              { value: "E", text: "柔軟に方法を変えながら効率的に探求する", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.5, "艮_安定性": -0.5 } }
            ]
          },
          {
            id: "q9",
            text: "知識と智慧の境界において、あなたの立ち位置は？",
            category: { title: "坎_探求性", description: "知識と智慧の統合、深層認識力測定" },
            options: [
              { value: "A", text: "体験的智慧を重視し、実践の中で真理を掴む", scoring: { "坎_探求性": 3.0, "震_行動性": 1.5, "兌_調和性": -0.5 } },
              { value: "B", text: "直感的洞察で新たな知の地平を創造する", scoring: { "乾_創造性": 2.0, "坎_探求性": 2.0, "艮_安定性": -0.5 } },
              { value: "C", text: "人々との対話を通じて集合知を形成する", scoring: { "兌_調和性": 2.5, "離_表現性": 1.5, "坎_探求性": 1.0 } },
              { value: "D", text: "伝統的智慧を現代に活かす方法を追求する", scoring: { "艮_安定性": 2.0, "坎_探求性": 2.0, "震_行動性": -0.5 } },
              { value: "E", text: "状況に応じて知識と智慧を使い分ける", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.0, "兌_調和性": 0.5 } }
            ]
          },

          // Q10-Q12: 総合的Engine OS測定
          {
            id: "q10",
            text: "創造・行動・探求のエネルギーが統合されたとき、あなたの理想的な姿は？",
            category: { title: "Engine OS統合", description: "創造性・行動性・探求性の統合バランス測定" },
            options: [
              { value: "A", text: "革新的ビジョンを持って世界を変革するリーダー", scoring: { "乾_創造性": 2.5, "震_行動性": 2.0, "離_表現性": 1.5 } },
              { value: "B", text: "深い洞察で人々を導く賢者", scoring: { "坎_探求性": 2.5, "離_表現性": 2.0, "艮_安定性": 1.0 } },
              { value: "C", text: "みんなの力を引き出すコーディネーター", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "巽_適応性": 1.5 } },
              { value: "D", text: "確実な成果を積み重ねる実行者", scoring: { "艮_安定性": 2.5, "震_行動性": 1.5, "坤_受容性": 1.0 } },
              { value: "E", text: "状況に応じて最適な価値を生み出す調整者", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.5, "兌_調和性": 1.0 } }
            ]
          },
          {
            id: "q11",
            text: "あなたのEngine OSが最高潮に達したとき、どのような価値を世界にもたらしますか？",
            category: { title: "Engine OS価値創造", description: "個人の創造的価値と社会への貢献度測定" },
            options: [
              { value: "A", text: "誰も見たことのない新しい未来の可能性", scoring: { "乾_創造性": 3.0, "離_表現性": 2.0, "震_行動性": 1.0 } },
              { value: "B", text: "深い洞察に基づく本質的な解決策", scoring: { "坎_探求性": 3.0, "艮_安定性": 1.5, "乾_創造性": 1.0 } },
              { value: "C", text: "人々の心を繋ぐ調和と共感の場", scoring: { "兌_調和性": 3.0, "坤_受容性": 2.0, "離_表現性": 1.0 } },
              { value: "D", text: "持続可能で確実な基盤と安心感", scoring: { "艮_安定性": 3.0, "坤_受容性": 2.0, "兌_調和性": 1.0 } },
              { value: "E", text: "柔軟で適応的な問題解決システム", scoring: { "巽_適応性": 3.0, "坎_探求性": 1.5, "震_行動性": 1.0 } }
            ]
          },
          {
            id: "q12",
            text: "易経の「時中」（時に中る）の概念で、あなたのEngine OSはどう表現されますか？",
            category: { title: "Engine OS時機", description: "創造・行動・探求の時機認識と実現力測定" },
            options: [
              { value: "A", text: "時代の転換点で新しい価値創造を先導する", scoring: { "乾_創造性": 2.5, "震_行動性": 2.0, "離_表現性": 1.5 } },
              { value: "B", text: "深い洞察で時代の本質を見抜き導く", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "離_表現性": 1.5 } },
              { value: "C", text: "人々の心を読んで最適なタイミングで行動する", scoring: { "兌_調和性": 2.5, "巽_適応性": 2.0, "坤_受容性": 1.0 } },
              { value: "D", text: "着実に時機を待ち、確実な成果を上げる", scoring: { "艮_安定性": 2.5, "坤_受容性": 2.0, "坎_探求性": 1.0 } },
              { value: "E", text: "流れを読んで柔軟に最適解を提供する", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.5, "兌_調和性": 1.5 } }
            ]
          },

          // ========== INTERFACE OS測定質問 (Q13-Q24) ==========
          // Q13-Q15: 兌_調和性測定（沢卦・調和力・協調性）
          {
            id: "q13",
            text: "沢（兌）のように人々を和ませるとき、あなたの自然な役割は？",
            category: { title: "兌_調和性", description: "易経沢卦による調和力・協調性の測定" },
            options: [
              { value: "A", text: "創造的なアイデアで場の雰囲気を一新する", scoring: { "乾_創造性": 2.5, "離_表現性": 2.0, "兌_調和性": 1.0 } },
              { value: "B", text: "笑顔と思いやりで人々の心を和ませる", scoring: { "兌_調和性": 3.0, "坤_受容性": 1.5, "離_表現性": 1.0 } },
              { value: "C", text: "深い洞察で本質的な問題を解決する", scoring: { "坎_探求性": 2.5, "兌_調和性": 1.5, "震_行動性": -0.5 } },
              { value: "D", text: "安定した基盤を作って安心感を提供する", scoring: { "艮_安定性": 2.5, "坤_受容性": 1.5, "兌_調和性": 1.0 } },
              { value: "E", text: "柔軟に立場を調整して最適な関係を作る", scoring: { "巽_適応性": 2.5, "兌_調和性": 2.0, "離_表現性": -0.5 } }
            ]
          },
          {
            id: "q14",
            text: "対立や意見の衝突が起きたとき、あなたの調和への道筋は？",
            category: { title: "兌_調和性", description: "対立解決と調和創造の能力測定" },
            options: [
              { value: "A", text: "新しい視点を提示して創造的解決を図る", scoring: { "乾_創造性": 2.5, "離_表現性": 1.5, "兌_調和性": 1.0 } },
              { value: "B", text: "双方の良い点を見つけて橋渡しをする", scoring: { "兌_調和性": 3.0, "巽_適応性": 1.5, "震_行動性": -0.5 } },
              { value: "C", text: "根本原因を探究して本質的解決を目指す", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "兌_調和性": 0.5 } },
              { value: "D", text: "相手の気持ちを受け止めて寄り添う", scoring: { "坤_受容性": 2.5, "兌_調和性": 2.0, "震_行動性": -1.0 } },
              { value: "E", text: "積極的に行動して状況を打開する", scoring: { "震_行動性": 2.5, "離_表現性": 1.5, "兌_調和性": 0.5 } }
            ]
          },
          {
            id: "q15",
            text: "「喜び」を人々と分かち合うとき、あなたの表現方法は？",
            category: { title: "兌_調和性", description: "喜びの共有と感動創造力測定" },
            options: [
              { value: "A", text: "独創的な方法で驚きと感動を演出する", scoring: { "乾_創造性": 2.0, "離_表現性": 2.5, "兌_調和性": 1.5 } },
              { value: "B", text: "心からの笑顔と温かい言葉で包み込む", scoring: { "兌_調和性": 3.0, "坤_受容性": 2.0, "艮_安定性": 0.5 } },
              { value: "C", text: "深い意味を込めた言葉で感動を伝える", scoring: { "坎_探求性": 2.0, "離_表現性": 1.5, "兌_調和性": 1.5 } },
              { value: "D", text: "静かに寄り添い、共感的な存在でいる", scoring: { "坤_受容性": 2.5, "艮_安定性": 2.0, "兌_調和性": 2.0 } },
              { value: "E", text: "相手に合わせた最適な方法で喜びを表現する", scoring: { "巽_適応性": 2.5, "兌_調和性": 2.0, "離_表現性": 1.0 } }
            ]
          },

          // Q16-Q18: 離_表現性測定（火卦・表現力・影響力）
          {
            id: "q16",
            text: "自分を表現したいとき、どのように伝えますか？",
            category: { title: "離_表現性", description: "表現力・影響力の測定" },
            options: [
              { value: "A", text: "独創的で印象に残る強烈な個性を発揮する", scoring: { "乾_創造性": 2.0, "離_表現性": 3.0, "坤_受容性": -1.0 } },
              { value: "B", text: "エネルギッシュに行動して人々を鼓舞する", scoring: { "震_行動性": 2.5, "離_表現性": 2.0, "艮_安定性": -0.5 } },
              { value: "C", text: "深い洞察を分かりやすく伝えて啓発する", scoring: { "坎_探求性": 2.0, "離_表現性": 2.0, "兌_調和性": -0.5 } },
              { value: "D", text: "温かく包み込むような存在感で安心させる", scoring: { "坤_受容性": 2.5, "兌_調和性": 1.5, "離_表現性": 0.5 } },
              { value: "E", text: "場に応じて最も適切な魅力を発揮する", scoring: { "巽_適応性": 2.5, "離_表現性": 1.0, "兌_調和性": 1.5 } }
            ]
          },
          {
            id: "q17",
            text: "人々の注目を集める場面で、あなたの自然な反応は？",
            category: { title: "離_表現性", description: "注目下での表現力と影響力発揮測定" },
            options: [
              { value: "A", text: "自分らしさを思い切り発揮して感動を与える", scoring: { "離_表現性": 3.0, "乾_創造性": 1.5, "坤_受容性": -1.0 } },
              { value: "B", text: "場の雰囲気を読んで最適な表現を選択する", scoring: { "巽_適応性": 2.5, "兌_調和性": 1.5, "離_表現性": 1.0 } },
              { value: "C", text: "みんなが楽しめる雰囲気作りに専念する", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "離_表現性": 1.0 } },
              { value: "D", text: "控えめに振る舞って目立たないようにする", scoring: { "坤_受容性": 2.0, "艮_安定性": 1.5, "離_表現性": -2.0 } },
              { value: "E", text: "エネルギッシュに場を盛り上げて活性化する", scoring: { "震_行動性": 2.5, "離_表現性": 2.0, "艮_安定性": -0.5 } }
            ]
          },
          {
            id: "q18",
            text: "あなたの「輝き」が最も自然に表れる瞬間は？",
            category: { title: "離_表現性", description: "自然な魅力と影響力の発現パターン測定" },
            options: [
              { value: "A", text: "新しい価値観や可能性を伝える時", scoring: { "乾_創造性": 2.5, "離_表現性": 2.0, "坤_受容性": -0.5 } },
              { value: "B", text: "自分の個性や魅力で人を惹きつける時", scoring: { "離_表現性": 3.0, "兌_調和性": 1.0, "艮_安定性": -0.5 } },
              { value: "C", text: "深い洞察で人々を啓発する時", scoring: { "坎_探求性": 2.5, "離_表現性": 1.5, "兌_調和性": 0.5 } },
              { value: "D", text: "みんなをまとめて良い方向に導く時", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "離_表現性": 1.5 } },
              { value: "E", text: "信頼と実績で自然に認められる時", scoring: { "艮_安定性": 2.5, "坤_受容性": 1.5, "離_表現性": 1.0 } }
            ]
          },

          // Q19-Q21: 巽_適応性測定（風卦・適応力・柔軟性）
          {
            id: "q19",
            text: "風（巽）のように状況に応じて形を変えるとき、あなたの特性は？",
            category: { title: "巽_適応性", description: "易経風卦による適応力・柔軟性の測定" },
            options: [
              { value: "A", text: "創造的な発想で新しい可能性を見つける", scoring: { "乾_創造性": 2.0, "巽_適応性": 2.0, "艮_安定性": -0.5 } },
              { value: "B", text: "どんな状況でも柔軟に対応できる能力を発揮する", scoring: { "巽_適応性": 3.0, "坎_探求性": 1.0, "艮_安定性": -1.0 } },
              { value: "C", text: "人との関係を良好に保つための調整をする", scoring: { "兌_調和性": 2.5, "巽_適応性": 2.0, "離_表現性": -0.5 } },
              { value: "D", text: "効果的に行動するための最適な手段を選ぶ", scoring: { "震_行動性": 2.0, "巽_適応性": 1.5, "艮_安定性": 0.5 } },
              { value: "E", text: "一貫性を保ちながら状況に適応する", scoring: { "艮_安定性": 2.5, "坎_探求性": 1.0, "巽_適応性": -1.5 } }
            ]
          },
          {
            id: "q20",
            text: "予期しない変化に直面したとき、あなたの適応戦略は？",
            category: { title: "巽_適応性", description: "変化対応と調整能力の測定" },
            options: [
              { value: "A", text: "これを機会に革新的な挑戦を始める", scoring: { "乾_創造性": 2.5, "震_行動性": 1.5, "巽_適応性": 1.0 } },
              { value: "B", text: "状況を分析して最適な対応策を見つける", scoring: { "巽_適応性": 3.0, "坎_探求性": 1.0, "艮_安定性": -0.5 } },
              { value: "C", text: "周囲と協力して乗り越える方法を探す", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "巽_適応性": 1.5 } },
              { value: "D", text: "安全で確実な方法で対処する", scoring: { "艮_安定性": 2.5, "坤_受容性": 1.0, "巽_適応性": -1.0 } },
              { value: "E", text: "直感的に行動して新しい道を切り開く", scoring: { "震_行動性": 2.5, "離_表現性": 1.5, "巽_適応性": 0.5 } }
            ]
          },
          {
            id: "q21",
            text: "多様な価値観の人たちと働くとき、あなたの橋渡し能力は？",
            category: { title: "巽_適応性", description: "多様性対応と調整力の測定" },
            options: [
              { value: "A", text: "新しい視点やアイデアを提供して革新を促す", scoring: { "乾_創造性": 2.5, "離_表現性": 1.5, "巽_適応性": 0.5 } },
              { value: "B", text: "みんなの意見を調整して最適解を見つける", scoring: { "巽_適応性": 3.0, "兌_調和性": 2.0, "離_表現性": -0.5 } },
              { value: "C", text: "全体の雰囲気を和やかに保つ", scoring: { "兌_調和性": 2.5, "坤_受容性": 1.5, "巽_適応性": 1.5 } },
              { value: "D", text: "積極的に行動して場をリードする", scoring: { "震_行動性": 2.5, "離_表現性": 1.5, "巽_適応性": 0.5 } },
              { value: "E", text: "安定した基盤を提供して全体を支える", scoring: { "艮_安定性": 2.5, "坤_受容性": 1.5, "巽_適応性": 0.5 } }
            ]
          },

          // Q22-Q24: Interface OS統合測定
          {
            id: "q22",
            text: "調和・表現・適応の能力が統合されたとき、あなたのInterface OSの特徴は？",
            category: { title: "Interface OS統合", description: "調和性・表現性・適応性の統合バランス測定" },
            options: [
              { value: "A", text: "創造的なビジョンで人々を魅了し導く", scoring: { "乾_創造性": 2.5, "離_表現性": 2.0, "兌_調和性": 1.0 } },
              { value: "B", text: "カリスマ的魅力で人々の心を掴む", scoring: { "離_表現性": 3.0, "兌_調和性": 1.5, "巽_適応性": 1.0 } },
              { value: "C", text: "深い洞察で人々の成長を支援する", scoring: { "坎_探求性": 2.5, "兌_調和性": 2.0, "坤_受容性": 1.0 } },
              { value: "D", text: "温かい包容力で安心できる環境を作る", scoring: { "坤_受容性": 2.5, "兌_調和性": 2.0, "艮_安定性": 1.0 } },
              { value: "E", text: "柔軟な調整力で最適な関係性を構築する", scoring: { "巽_適応性": 2.5, "兌_調和性": 2.0, "坎_探求性": 1.0 } }
            ]
          },
          {
            id: "q23",
            text: "あなたのInterface OSが人々に与える最大の価値は？",
            category: { title: "Interface OS価値", description: "対人関係での価値創造と影響力測定" },
            options: [
              { value: "A", text: "新しい可能性への扉を開く刺激", scoring: { "乾_創造性": 3.0, "離_表現性": 2.0, "震_行動性": 1.0 } },
              { value: "B", text: "心を動かす感動と希望の光", scoring: { "離_表現性": 3.0, "兌_調和性": 1.5, "坤_受容性": 1.0 } },
              { value: "C", text: "深い理解と共感による癒し", scoring: { "坤_受容性": 2.5, "兌_調和性": 2.0, "坎_探求性": 1.5 } },
              { value: "D", text: "安心できる信頼関係と安定感", scoring: { "艮_安定性": 2.5, "坤_受容性": 2.0, "兌_調和性": 1.5 } },
              { value: "E", text: "柔軟で創造的な問題解決支援", scoring: { "巽_適応性": 2.5, "坎_探求性": 2.0, "乾_創造性": 1.5 } }
            ]
          },
          {
            id: "q24",
            text: "人との「つながり」の本質において、あなたのInterface OSが最も重視することは？",
            category: { title: "Interface OS本質", description: "人間関係の本質的価値観と哲学測定" },
            options: [
              { value: "A", text: "お互いに成長し合える相互発展", scoring: { "乾_創造性": 2.0, "震_行動性": 1.5, "兌_調和性": 1.5 } },
              { value: "B", text: "喜びを分かち合える心の交流", scoring: { "兌_調和性": 3.0, "離_表現性": 1.0, "艮_安定性": 0.5 } },
              { value: "C", text: "深い信頼に基づく真の理解", scoring: { "坎_探求性": 2.0, "艮_安定性": 2.0, "兌_調和性": 2.0 } },
              { value: "D", text: "困った時に支え合える絆", scoring: { "坤_受容性": 2.5, "艮_安定性": 1.5, "兌_調和性": 2.0 } },
              { value: "E", text: "お互いの違いを認め合う多様性", scoring: { "巽_適応性": 2.0, "坤_受容性": 1.5, "兌_調和性": 2.0 } }
            ]
          },

          // ========== SAFE MODE OS測定質問 (Q25-Q30) ==========
          // Q25-Q27: 艮_安定性測定（山卦・安定性・継続性）
          {
            id: "q25",
            text: "困難な状況でも動じない安定性が必要な時、あなたが頼りにするものは？",
            category: { title: "安定性", description: "ストレス時の安定性・継続性の測定" },
            options: [
              { value: "A", text: "革新的思考で新しい安定の形を創造する", scoring: { "乾_創造性": 2.5, "艮_安定性": 1.5, "震_行動性": -0.5 } },
              { value: "B", text: "確実性を重視し、リスクを最小限に抑える", scoring: { "艮_安定性": 3.0, "坤_受容性": 1.0, "震_行動性": -1.5 } },
              { value: "C", text: "深い洞察に基づく持続可能な方法を選ぶ", scoring: { "坎_探求性": 2.0, "艮_安定性": 2.0, "巽_適応性": 0.5 } },
              { value: "D", text: "周囲との調和を保ちながら安定を築く", scoring: { "兌_調和性": 2.0, "艮_安定性": 2.0, "坤_受容性": 1.0 } },
              { value: "E", text: "状況に応じて柔軟に安定性を維持する", scoring: { "巽_適応性": 2.0, "艮_安定性": 1.5, "坎_探求性": 1.0 } }
            ]
          },
          {
            id: "q26",
            text: "長期的な成果と継続性について、あなたの価値観は？",
            category: { title: "艮_安定性", description: "長期視点と継続性への価値観測定" },
            options: [
              { value: "A", text: "常に革新し続けることで長期的価値を創造する", scoring: { "乾_創造性": 2.5, "震_行動性": 1.5, "艮_安定性": -1.0 } },
              { value: "B", text: "着実に積み重ねて確実に目標を達成する", scoring: { "艮_安定性": 3.0, "坤_受容性": 1.5, "震_行動性": -0.5 } },
              { value: "C", text: "本質を理解して根本的価値を追求する", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "兌_調和性": -0.5 } },
              { value: "D", text: "みんなと一緒に持続可能な成長を目指す", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "艮_安定性": 1.0 } },
              { value: "E", text: "変化に適応しながら継続的改善を図る", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.0, "艮_安定性": -1.0 } }
            ]
          },
          {
            id: "q27",
            text: "「守る」べき価値について、あなたの基準は？",
            category: { title: "艮_安定性", description: "価値保護と防衛意識の測定" },
            options: [
              { value: "A", text: "創造的な可能性と革新の自由", scoring: { "乾_創造性": 2.5, "離_表現性": 1.5, "艮_安定性": 0.5 } },
              { value: "B", text: "確実な基盤と安全な環境", scoring: { "艮_安定性": 3.0, "坤_受容性": 1.0, "巽_適応性": -1.0 } },
              { value: "C", text: "真理探求の姿勢と学習機会", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "震_行動性": -0.5 } },
              { value: "D", text: "人との絆と調和的な関係", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "艮_安定性": 1.5 } },
              { value: "E", text: "柔軟性と適応的な問題解決力", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.5, "艮_安定性": -0.5 } }
            ]
          },

          // Q28-Q30: 坤_受容性とSafe Mode OS統合測定（地卦・受容性・包容力）
          {
            id: "q28",
            text: "誰かを心から支えたい時、あなたの自然な姿勢は？",
            category: { title: "坤_受容性", description: "易経地卦による受容性・包容力の測定" },
            options: [
              { value: "A", text: "新しいアイデアで支援の形を革新する", scoring: { "乾_創造性": 2.0, "坤_受容性": 2.0, "艮_安定性": -0.5 } },
              { value: "B", text: "どんな時も変わらずそばにいて支える", scoring: { "坤_受容性": 3.0, "艮_安定性": 2.0, "震_行動性": -1.0 } },
              { value: "C", text: "深い理解に基づいて本質的な支援をする", scoring: { "坎_探求性": 2.5, "坤_受容性": 2.0, "離_表現性": -0.5 } },
              { value: "D", text: "温かい共感で心の支えとなる", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "坎_探求性": -0.5 } },
              { value: "E", text: "相手の状況に合わせて最適な支援をする", scoring: { "巽_適応性": 2.5, "坤_受容性": 2.0, "離_表現性": -0.5 } }
            ]
          },
          {
            id: "q29",
            text: "ストレスや危機を感じる時、あなたはどのような状況で防御的になりますか？",
            category: { title: "防御反応", description: "防御モード発動の条件と特徴測定" },
            options: [
              { value: "A", text: "創造性が認められず、新しい挑戦が阻まれる時", scoring: { "乾_創造性": 2.5, "震_行動性": 1.5, "艮_安定性": -0.5 } },
              { value: "B", text: "基本的な安全や安定が脅かされる時", scoring: { "艮_安定性": 3.0, "坤_受容性": 2.0, "震_行動性": -1.0 } },
              { value: "C", text: "真理や本質が歪められ、理解が困難になる時", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "兌_調和性": -0.5 } },
              { value: "D", text: "人間関係が悪化し、調和が失われる時", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "震_行動性": -0.5 } },
              { value: "E", text: "急激な変化で適応が困難になる時", scoring: { "巽_適応性": 2.0, "艮_安定性": 2.0, "坤_受容性": 1.5 } }
            ]
          },
          {
            id: "q30",
            text: "あなたが最も守りたいと思う心の領域は何ですか？",
            category: { title: "心の防衛線", description: "防御システムの根本的価値と意義測定" },
            options: [
              { value: "A", text: "創造的な可能性を守り、未来への道筋を保つこと", scoring: { "乾_創造性": 2.5, "艮_安定性": 2.0, "離_表現性": 1.0 } },
              { value: "B", text: "確実な基盤を維持し、安心できる環境を守ること", scoring: { "艮_安定性": 3.0, "坤_受容性": 2.0, "兌_調和性": 1.0 } },
              { value: "C", text: "本質的な価値と真理を探求し続けられること", scoring: { "坎_探求性": 2.5, "艮_安定性": 2.0, "乾_創造性": 1.0 } },
              { value: "D", text: "大切な人との絆と調和を維持すること", scoring: { "坤_受容性": 2.5, "兌_調和性": 2.0, "艮_安定性": 1.5 } },
              { value: "E", text: "柔軟性と適応力を保ち、変化に対応し続けること", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.5, "坤_受容性": 1.5 } }
            ]
          },

          // Q31-Q34: Safe Mode OS補強質問（艮_安定性・坤_受容性バランス）
          {
            id: "q31",
            text: "予期せぬ変化に直面した時、あなたの最初の反応は？",
            category: { title: "変化への対応", description: "変化に対する防御的反応の測定" },
            options: [
              { value: "A", text: "新しい可能性として捉え、革新的な解決策を探る", scoring: { "乾_創造性": 2.5, "震_行動性": 1.5, "艮_安定性": -0.5 } },
              { value: "B", text: "まず状況を安定させ、慎重に対応策を検討する", scoring: { "艮_安定性": 3.0, "坤_受容性": 1.5, "震_行動性": -1.0 } },
              { value: "C", text: "変化の本質を理解し、根本的な原因を探求する", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "兌_調和性": 0.5 } },
              { value: "D", text: "周囲の人々への影響を考慮し、調和を保つ", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "乾_創造性": -0.5 } },
              { value: "E", text: "状況に応じて柔軟に適応し、最適な道を見つける", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.0, "艮_安定性": 0.5 } }
            ]
          },
          {
            id: "q32",
            text: "心身が疲れた時、どのように回復しますか？",
            category: { title: "回復メカニズム", description: "ストレス回復時の防御的行動測定" },
            options: [
              { value: "A", text: "新しい挑戦や創造的活動でエネルギーを再生する", scoring: { "乾_創造性": 2.5, "離_表現性": 1.5, "坤_受容性": -1.0 } },
              { value: "B", text: "安全な環境で休息し、着実に体力を回復する", scoring: { "艮_安定性": 3.0, "坤_受容性": 2.0, "震_行動性": -1.5 } },
              { value: "C", text: "内省と瞑想で心の深層を探り、本質的な癒しを得る", scoring: { "坎_探求性": 2.5, "坤_受容性": 1.5, "離_表現性": -0.5 } },
              { value: "D", text: "信頼できる人々と時間を過ごし、心を癒す", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "乾_創造性": -0.5 } },
              { value: "E", text: "自然な流れに身を任せ、無理なく回復を待つ", scoring: { "巽_適応性": 2.5, "坤_受容性": 2.0, "震_行動性": -1.0 } }
            ]
          },
          {
            id: "q33",
            text: "自分の限界を感じた時、どう対処しますか？",
            category: { title: "限界対処法", description: "限界状況での防御戦略測定" },
            options: [
              { value: "A", text: "限界を突破する新しい方法を創造する", scoring: { "乾_創造性": 2.5, "震_行動性": 2.0, "艮_安定性": -1.0 } },
              { value: "B", text: "無理をせず、確実にできる範囲で対応する", scoring: { "艮_安定性": 3.0, "坤_受容性": 1.5, "震_行動性": -1.5 } },
              { value: "C", text: "限界の原因を深く分析し、根本的解決を探る", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.0, "離_表現性": 0.5 } },
              { value: "D", text: "周囲に助けを求め、協力して乗り越える", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "乾_創造性": -1.0 } },
              { value: "E", text: "状況を受け入れ、別の道を柔軟に探す", scoring: { "巽_適応性": 2.5, "坤_受容性": 1.5, "震_行動性": -0.5 } }
            ]
          },
          {
            id: "q34",
            text: "安心感を最も感じるのはどんな時ですか？",
            category: { title: "安心感の源泉", description: "心理的安全性の基盤測定" },
            options: [
              { value: "A", text: "自由に創造し、新しい価値を生み出している時", scoring: { "乾_創造性": 2.5, "離_表現性": 2.0, "艮_安定性": 0.5 } },
              { value: "B", text: "計画通りに物事が進み、安定している時", scoring: { "艮_安定性": 3.0, "坤_受容性": 1.5, "巽_適応性": -1.0 } },
              { value: "C", text: "物事の本質を理解し、明確な洞察を得た時", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "兌_調和性": 0.5 } },
              { value: "D", text: "大切な人々と調和し、温かい関係にある時", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.5, "震_行動性": -0.5 } },
              { value: "E", text: "どんな状況にも適応できる準備がある時", scoring: { "巽_適応性": 2.5, "艮_安定性": 1.5, "坎_探求性": 1.0 } }
            ]
          },
          {
            id: "q35",
            text: "批判や否定的な意見に直面した時、どう感じますか？",
            category: { title: "批判への反応", description: "否定的フィードバックへの防御反応測定" },
            options: [
              { value: "A", text: "新たな視点として受け入れ、創造的に活用する", scoring: { "乾_創造性": 2.5, "離_表現性": 1.5, "艮_安定性": 0.5 } },
              { value: "B", text: "動揺せず冷静に受け止め、必要な部分だけ取り入れる", scoring: { "艮_安定性": 3.0, "坤_受容性": 1.5, "震_行動性": -1.0 } },
              { value: "C", text: "批判の本質を分析し、建設的な要素を抽出する", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "兌_調和性": 0.5 } },
              { value: "D", text: "相手の感情も理解しようと努め、関係性を保つ", scoring: { "兌_調和性": 2.5, "坤_受容性": 2.0, "震_行動性": -0.5 } },
              { value: "E", text: "状況を見極めて、適切な距離感で対応する", scoring: { "巽_適応性": 2.5, "坤_受容性": 1.5, "離_表現性": 0.5 } }
            ]
          },
          {
            id: "q36",
            text: "あなたにとって「本当の強さ」とは何ですか？",
            category: { title: "強さの定義", description: "内的強さと防御メカニズムの本質測定" },
            options: [
              { value: "A", text: "どんな困難も創造的に乗り越える革新力", scoring: { "乾_創造性": 2.5, "震_行動性": 1.5, "艮_安定性": 1.0 } },
              { value: "B", text: "揺るがない安定性と確実な継続力", scoring: { "艮_安定性": 3.0, "坤_受容性": 2.0, "巽_適応性": -0.5 } },
              { value: "C", text: "真実を見抜き、本質を理解する洞察力", scoring: { "坎_探求性": 2.5, "艮_安定性": 1.5, "離_表現性": 1.0 } },
              { value: "D", text: "他者を包み込み、共に成長する包容力", scoring: { "坤_受容性": 2.5, "兌_調和性": 2.0, "艮_安定性": 1.5 } },
              { value: "E", text: "どんな環境にも適応できる柔軟性", scoring: { "巽_適応性": 2.5, "坎_探求性": 1.5, "坤_受容性": 1.5 } }
            ]
          }
        ];
        */
        
        // EMERGENCY FIX: Use questions-full.js loaded from external file
        // const QUESTIONS will be defined by questions-full.js
        
        // ===== HaQei 易経専門家による36問システム完成 =====
        
        // 8次元スコアリング定数（易経八卦準拠）
        const DIMENSION_KEYS = [
            "乾_創造性",  // 天卦 - 創造力・革新性・リーダーシップ
            "震_行動性",  // 雷卦 - 行動力・実行力・エネルギー
            "坎_探求性",  // 水卦 - 探究心・深層理解・知識欲
            "艮_安定性",  // 山卦 - 安定性・継続性・堅実性
            "坤_受容性",  // 地卦 - 受容性・包容力・支援力
            "巽_適応性",  // 風卦 - 適応性・柔軟性・調整力
            "離_表現性",  // 火卦 - 表現力・影響力・魅力
            "兌_調和性"   // 沢卦 - 調和性・協調性・コミュニケーション
        ];
        
        // Triple OS質問配分マッピング
        const OS_QUESTION_MAPPING = {
            ENGINE: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],    // Q1-Q12: 創造・行動・探求中心
            INTERFACE: [13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24],  // Q13-Q24: 調和・表現・適応中心
            SAFE_MODE: [25, 26, 27, 28, 29, 30, 31, 32, 33, 34, 35, 36]   // Q25-Q36: 安定・受容中心
        };
        
        // 易経哲学に基づく次元重み付け係数
        const DIMENSION_WEIGHTS = {
            ENGINE_OS: {
                "乾_創造性": 1.0, "震_行動性": 1.0, "坎_探求性": 1.0,  // 主要次元
                "離_表現性": 0.7, "巽_適応性": 0.6, "兌_調和性": 0.5,  // 補助次元
                "艮_安定性": 0.3, "坤_受容性": 0.3                    // 相対次元
            },
            INTERFACE_OS: {
                "兌_調和性": 1.0, "離_表現性": 1.0, "巽_適応性": 1.0,  // 主要次元
                "坤_受容性": 0.8, "乾_創造性": 0.6, "震_行動性": 0.5,  // 補助次元
                "坎_探求性": 0.4, "艮_安定性": 0.4                    // 相対次元
            },
            SAFE_MODE_OS: {
                "艮_安定性": 1.0, "坤_受容性": 1.0,                   // 主要次元
                "兌_調和性": 0.8, "坎_探求性": 0.7, "巽_適応性": 0.6,  // 補助次元
                "離_表現性": 0.4, "震_行動性": 0.3, "乾_創造性": 0.3   // 相対次元
            }
        };
        
        // ===== QUESTIONS配列（36問完了） - 易経専門家による専門的設問システム =====
        
        // 2. 質問数確認と検証
        if (typeof window.QUESTIONS !== 'undefined' && window.QUESTIONS) {
            console.log(`✅ HaQei 36問質問システム構築完了: ${window.QUESTIONS.length}問`);
            console.log(`📊 Engine OS: Q1-Q12 (${OS_QUESTION_MAPPING.ENGINE.length}問)`);
            console.log(`🎭 Interface OS: Q13-Q24 (${OS_QUESTION_MAPPING.INTERFACE.length}問)`); 
            console.log(`🛡️ Safe Mode OS: Q25-Q36 (${OS_QUESTION_MAPPING.SAFE_MODE.length}問)`);
        } else {
            console.log('⚠️ QUESTIONS not yet loaded, validation will be performed when available');
        }
        
        // 3. 易経専門家による質問品質検証
        function validateQuestionSystem() {
            // 8次元カバレッジ確認
            const dimensionCoverage = DIMENSION_KEYS.reduce((acc, dim) => {
                acc[dim] = 0;
                const questionsArray = window.QUESTIONS || [];
                questionsArray.forEach(q => {
                    q.options.forEach(opt => {
                        if (opt.scoring && opt.scoring[dim]) {
                            acc[dim]++;
                        }
                    });
                });
                return acc;
            }, {});
            
            console.log("🔍 8次元カバレッジ検証:", dimensionCoverage);
            
            // 品質スコア計算
            const questionsLength = window.QUESTIONS ? window.QUESTIONS.length : 0;
            if (questionsLength === 0) {
                console.log('⚠️ No questions available for validation');
                return false;
            }
            
            const qualityScore = Object.values(dimensionCoverage).reduce((sum, count) => sum + count, 0) / (DIMENSION_KEYS.length * 30) * 100;
            console.log(`📈 質問システム品質スコア: ${qualityScore.toFixed(1)}%`);
            
            return qualityScore > 80; // 80%以上で合格
        }
        
        // 初期化時に検証実行（QUESTIONS読み込み後）
        let isSystemValid = false;
        if (typeof window.QUESTIONS !== 'undefined' && window.QUESTIONS) {
            isSystemValid = validateQuestionSystem();
        }
        if (!isSystemValid && window.QUESTIONS) {
            console.warn("⚠️ 質問システムの品質に問題があります");
        } else {
            console.log("✅ 易経専門家による36問システム検証完了");
        }

        // ===== HaQei 36問システム構築完了 =====
        
        // 4. 八卦ベクトルデータ（vectors.js統合）
        const H64_8D_VECTORS = {
            1: {
                乾_創造性: 9, 震_行動性: 7, 坎_探求性: 5, 艮_安定性: 6,
                坤_受容性: 1, 巽_適応性: 3, 離_表現性: 8, 兌_調和性: 4
            },
            2: {
                乾_創造性: 2, 震_行動性: 3, 坎_探求性: 4, 艮_安定性: 8,
                坤_受容性: 9, 巽_適応性: 7, 離_表現性: 2, 兌_調和性: 6
            }
            // 他の62卦のベクトルも同様に実装...
        };
        
        // 4. 正統八卦定義（易経準拠）
        const AUTHENTIC_TRIGRAMS = {
            1: { name: '乾', symbol: '☰', meaning: '天・創造・父', element: 'metal', nature: '剛健', description: '純粋創造力、天性のリーダーシップ、強固な意志' },
            2: { name: '兌', symbol: '☱', meaning: '沢・喜・少女', element: 'metal', nature: '悦楽', description: '喜悦調和、コミュニケーション、社交的魅力' },
            3: { name: '離', symbol: '☲', meaning: '火・光・中女', element: 'fire', nature: '光明', description: '光明表現、知性と情熱、明晰な判断' },
            4: { name: '震', symbol: '☳', meaning: '雷・動・長男', element: 'wood', nature: '発動', description: '雷鳴行動、エネルギッシュな実行力、革新力' },
            5: { name: '巽', symbol: '☴', meaning: '風・入・長女', element: 'wood', nature: '順入', description: '風の浸透、柔軟適応、細やかな配慮' },
            6: { name: '坎', symbol: '☵', meaning: '水・険・中男', element: 'water', nature: '陷険', description: '水の探求、深淵洞察、困難突破' },
            7: { name: '艮', symbol: '☶', meaning: '山・止・少男', element: 'earth', nature: '静止', description: '山の安定、継続力、不動の意志' },
            8: { name: '坤', symbol: '☷', meaning: '地・順・母', element: 'earth', nature: '柔順', description: '大地受容、育成力、無限の包容' }
        };
        
        // 正統八卦マッピング（先天八卦配列準拠）
        const AUTHENTIC_TRIGRAM_MAPPING = {
            "乾_創造性": 1,  // 乾☰ - 純粋創造（天・父・剛健）
            "兌_調和性": 2,  // 兌☱ - 喜悦調和（沢・少女・悦楽）
            "離_表現性": 3,  // 離☲ - 光明表現（火・中女・光明）
            "震_行動性": 4,  // 震☳ - 発動行動（雷・長男・動）
            "巽_適応性": 5,  // 巽☴ - 順応浸透（風・長女・入）
            "坎_探求性": 6,  // 坎☵ - 深淵探求（水・中男・険）
            "艮_安定性": 7,  // 艮☶ - 静止安定（山・少男・止）
            "坤_受容性": 8   // 坤☷ - 受容育成（地・母・順）
        };
        
        // 専門用語辞書（仮想人格生成は除外）
        const TERMINOLOGY_MAP = {
            'HaQei哲学': '性格分析理論',
            'Triple OS': '3つの性格タイプ',
            'Engine OS': '内なる価値観',
            'Interface OS': '対人関係スタイル', 
            'Safe Mode OS': 'ストレス時の反応',
            '64卦': '64の性格パターン',
            '八卦エネルギー': 'エネルギーバランス',
            '卦': 'タイプ',
            '爻': 'パターン'
        };
        
        // 専門用語置換関数
        function replaceTerminology(text) {
            if (!text) return text;
            let result = text;
            for (const [old, newTerm] of Object.entries(TERMINOLOGY_MAP)) {
                result = result.replace(new RegExp(old, 'g'), newTerm);
            }
            return result;
        }
        
        // 5. Triple OS定義
        const TRIPLE_OS = {
            'Engine OS': {
                name: 'Engine OS',
                description: '論理的思考と実行力の中核システム',
                color: '#6366f1',
                trigrams: [1, 4, 6, 7], // 乾、震、坎、艮
                keywords: ['創造性', 'リーダーシップ', '行動力', '探求心', '安定性']
            },
            'Interface OS': {
                name: 'Interface OS', 
                description: 'コミュニケーションと表現の対人システム',
                color: '#8b5cf6',
                trigrams: [2, 3, 5, 8], // 兌、離、巽、坤
                keywords: ['調和性', 'コミュニケーション', '表現力', '適応性', '受容性']
            },
            'Safe Mode OS': {
                name: 'Safe Mode OS',
                description: '安定と調和を重視する保護システム',
                color: '#10b981',
                trigrams: [7, 8, 5, 6], // 艮、坤、巽、坎
                keywords: ['安定性', '受容性', '適応性', '慎重さ', '分析力']
            }
        };
        
        // 6. Phase 2: Triple OS独立計算システム
        class IndependentOSCalculator {
            constructor() {
                // 各OS専用質問の範囲定義
                this.questionMapping = {
                    engine: { start: 1, end: 12 },    // Q1-Q12: Engine OS
                    interface: { start: 13, end: 24 }, // Q13-Q24: Interface OS
                    safemode: { start: 25, end: 36 }   // Q25-Q36: Safe Mode OS
                };
            }
            
            // Engine OS専用計算
            calculateEngineOS(allAnswers) {
                const engineAnswers = this.filterOSAnswers(allAnswers, 'engine');
                const vector = this.computeIndependentVector(engineAnswers);
                return this.normalizeVector(vector);
            }
            
            // Interface OS専用計算
            calculateInterfaceOS(allAnswers) {
                const interfaceAnswers = this.filterOSAnswers(allAnswers, 'interface');
                const vector = this.computeIndependentVector(interfaceAnswers);
                // Interface OS用の最小保証値20%
                return this.normalizeVector(vector, 0.20);
            }
            
            // Safe Mode OS専用計算
            calculateSafeModeOS(allAnswers) {
                const safeAnswers = this.filterOSAnswers(allAnswers, 'safemode');
                const vector = this.computeIndependentVector(safeAnswers);
                // Safe Mode OS用の最小保証値15%
                return this.normalizeVector(vector, 0.15);
            }
            
            // 特定OS用の回答をフィルタリング
            filterOSAnswers(allAnswers, osType) {
                const range = this.questionMapping[osType];
                return allAnswers.filter(answer => {
                    const questionNum = parseInt(answer.id.replace('q', ''));
                    return questionNum >= range.start && questionNum <= range.end;
                });
            }
            
            // 独立ベクトル計算
            computeIndependentVector(answers) {
                const vector = {
                    "乾_創造性": 0,
                    "兌_調和性": 0,
                    "離_表現性": 0,
                    "震_行動性": 0,
                    "巽_適応性": 0,
                    "坎_探求性": 0,
                    "艮_安定性": 0,
                    "坤_受容性": 0
                };
                
                answers.forEach(answer => {
                    if (answer.selectedOption && answer.selectedOption.scoring) {
                        Object.entries(answer.selectedOption.scoring).forEach(([key, value]) => {
                            if (vector.hasOwnProperty(key)) {
                                vector[key] += value;
                            }
                        });
                    }
                });
                
                return vector;
            }
            
            // ベクトル正規化（最小保証値付き）
            normalizeVector(vector, minValue = 0.1) {
                const total = Object.values(vector).reduce((sum, val) => sum + Math.abs(val), 0);
                
                if (total === 0) {
                    // 全値が0の場合は均等分配
                    Object.keys(vector).forEach(key => {
                        vector[key] = 1.0 / 8;
                    });
                } else {
                    // 正規化
                    Object.keys(vector).forEach(key => {
                        vector[key] = Math.max(minValue, Math.abs(vector[key]) / total);
                    });
                }
                
                return vector;
            }
            
            // 統計的信頼性チェック
            validateReliability(answers, osType) {
                const range = this.questionMapping[osType];
                const expectedCount = range.end - range.start + 1;
                const actualCount = answers.filter(a => {
                    const qNum = parseInt(a.id.replace('q', ''));
                    return qNum >= range.start && qNum <= range.end;
                }).length;
                
                return {
                    reliability: actualCount / expectedCount,
                    expectedQuestions: expectedCount,
                    answeredQuestions: actualCount,
                    isReliable: actualCount >= expectedCount * 0.8 // 80%以上回答で信頼性あり
                };
            }
        }
        
        // 7. Phase 2-3: リアルタイム検証システム
        class RealTimeValidationSystem {
            constructor() {
                this.validationHistory = [];
                this.qualityThresholds = {
                    excellent: 0.85,
                    good: 0.70,
                    marginal: 0.50,
                    poor: 0.30
                };
                this.realTimeUpdates = true;
            }
            
            // リアルタイム品質監視
            validateAnswerQuality(answers, currentQuestionIndex) {
                if (answers.length < 5) return null; // 最低5問回答後から開始
                
                const validation = {
                    timestamp: new Date().toISOString(),
                    questionIndex: currentQuestionIndex,
                    totalAnswers: answers.length,
                    osValidation: {},
                    overallQuality: 0,
                    recommendations: []
                };
                
                // 各OS個別検証
                const independentCalc = new IndependentOSCalculator();
                
                // Engine OS検証
                if (answers.length >= 5) {
                    const engineAnswers = answers.filter(a => {
                        const qNum = parseInt(a.id.replace('q', ''));
                        return qNum >= 1 && qNum <= 12;
                    });
                    if (engineAnswers.length > 0) {
                        validation.osValidation.engine = this.validateOSAnswers(engineAnswers, 'engine', independentCalc);
                    }
                }
                
                // Interface OS検証
                if (answers.length >= 13) {
                    const interfaceAnswers = answers.filter(a => {
                        const qNum = parseInt(a.id.replace('q', ''));
                        return qNum >= 13 && qNum <= 24;
                    });
                    if (interfaceAnswers.length > 0) {
                        validation.osValidation.interface = this.validateOSAnswers(interfaceAnswers, 'interface', independentCalc);
                    }
                }
                
                // Safe Mode OS検証
                if (answers.length >= 25) {
                    const safeModeAnswers = answers.filter(a => {
                        const qNum = parseInt(a.id.replace('q', ''));
                        return qNum >= 25 && qNum <= 36;
                    });
                    if (safeModeAnswers.length > 0) {
                        validation.osValidation.safemode = this.validateOSAnswers(safeModeAnswers, 'safemode', independentCalc);
                    }
                }
                
                // 全体品質計算
                validation.overallQuality = this.calculateOverallQuality(validation.osValidation);
                validation.recommendations = this.generateRecommendations(validation);
                
                this.validationHistory.push(validation);
                return validation;
            }
            
            // OS個別回答検証
            validateOSAnswers(osAnswers, osType, calculator) {
                const validation = calculator.validateReliability(osAnswers, osType);
                const vector = calculator.computeIndependentVector(osAnswers);
                
                return {
                    osType: osType,
                    answeredQuestions: validation.answeredQuestions,
                    expectedQuestions: validation.expectedQuestions,
                    completionRate: validation.reliability,
                    reliability: validation.isReliable,
                    vectorBalance: this.calculateVectorBalance(vector),
                    qualityLevel: this.getQualityLevel(validation.reliability),
                    estimatedAlpha: this.estimateAlpha(osAnswers, vector)
                };
            }
            
            // ベクトルバランス計算
            calculateVectorBalance(vector) {
                const values = Object.values(vector);
                const mean = values.reduce((sum, v) => sum + v, 0) / values.length;
                const variance = values.reduce((sum, v) => sum + Math.pow(v - mean, 2), 0) / values.length;
                const balance = 1 - Math.sqrt(variance); // 低分散 = 高バランス
                return Math.max(0, Math.min(1, balance));
            }
            
            // 品質レベル判定
            getQualityLevel(reliability) {
                if (reliability >= this.qualityThresholds.excellent) return 'excellent';
                if (reliability >= this.qualityThresholds.good) return 'good';
                if (reliability >= this.qualityThresholds.marginal) return 'marginal';
                return 'poor';
            }
            
            // Cronbach's α推定
            estimateAlpha(answers, vector) {
                if (answers.length < 3) return 0;
                
                // 簡易α推定（実際の統計計算の近似）
                const vectorBalance = this.calculateVectorBalance(vector);
                const completionRate = answers.length / 12; // 各OS12問想定
                const baseAlpha = 0.60; // ベースライン
                
                return Math.min(0.95, baseAlpha + (vectorBalance * 0.25) + (completionRate * 0.10));
            }
            
            // 全体品質計算
            calculateOverallQuality(osValidation) {
                const validations = Object.values(osValidation);
                if (validations.length === 0) return 0;
                
                const totalReliability = validations.reduce((sum, v) => sum + v.completionRate, 0);
                return totalReliability / validations.length;
            }
            
            // 推奨事項生成
            generateRecommendations(validation) {
                const recommendations = [];
                
                Object.entries(validation.osValidation).forEach(([osType, osVal]) => {
                    if (osVal.qualityLevel === 'poor') {
                        recommendations.push({
                            type: 'quality_warning',
                            osType: osType,
                            message: `${osType} OSの回答品質が低下しています。より慎重に回答してください。`,
                            priority: 'high'
                        });
                    } else if (osVal.qualityLevel === 'marginal') {
                        recommendations.push({
                            type: 'quality_caution',
                            osType: osType,
                            message: `${osType} OSでより多様な選択肢を検討してください。`,
                            priority: 'medium'
                        });
                    }
                });
                
                if (validation.overallQuality >= this.qualityThresholds.excellent) {
                    recommendations.push({
                        type: 'quality_excellent',
                        message: '優秀な回答品質です。このまま継続してください。',
                        priority: 'info'
                    });
                }
                
                return recommendations;
            }
            
            // リアルタイムUI更新
            updateUI(validation) {
                if (!this.realTimeUpdates || !validation) return;
                
                // 品質インジケータ更新
                this.updateQualityIndicator(validation);
                
                // 推奨事項表示
                this.displayRecommendations(validation.recommendations);
                
                // プログレス更新
                this.updateProgress(validation);
            }
            
            updateQualityIndicator(validation) {
                const indicator = document.getElementById('quality-indicator');
                if (!indicator) return;
                
                const qualityLevel = this.getQualityLevel(validation.overallQuality);
                const qualityText = {
                    'excellent': '優秀',
                    'good': '良好',  
                    'marginal': '要注意',
                    'poor': '要改善'
                };
                
                // 品質テキスト表示を削除（ユーザー体験向上のため）
                indicator.innerHTML = ``;
            }
            
            
            displayRecommendations(recommendations) {
                const container = document.getElementById('recommendations');
                if (!container || recommendations.length === 0) return;
                
                container.innerHTML = recommendations.map(rec => `
                    <div class="recommendation ${rec.priority}">
                        ${rec.message}
                    </div>
                `).join('');
            }
            
            updateProgress(validation) {
                const progress = document.getElementById('validation-progress');
                if (!progress) return;
                
                const osProgress = Object.entries(validation.osValidation).map(([osType, osVal]) => `
                    <div class="os-progress">
                        <span>${osType}: ${osVal.answeredQuestions}/${osVal.expectedQuestions}</span>
                        <div class="progress-bar">
                            <div class="progress-fill ${osVal.qualityLevel}" 
                                 style="width: ${osVal.completionRate * 100}%"></div>
                        </div>
                    </div>
                `).join('');
                
                progress.innerHTML = osProgress;
            }
        }
        
        // 8. TripleOSエンジン（TypeScriptから移植）
        class TripleOSEngine {
            constructor() {
                this.trigramMapping = this.initializeTrigramMapping();
                this.interfaceKeywords = new Map();
                this.safeModeKeywords = new Map();
                this.initializeKeywordMaps();
            }
            
            initializeTrigramMapping() {
                // 易経準拠の正統八卦マッピング
                return {
                    "乾": { id: 1, symbol: "☰", name: "天", nature: "剛健", trait: "純粋創造・天性リーダーシップ" },
                    "兌": { id: 2, symbol: "☱", name: "沢", nature: "悦楽", trait: "喜悦調和・コミュニケーション" },
                    "離": { id: 3, symbol: "☲", name: "火", nature: "光明", trait: "光明表現・知性情熱" },
                    "震": { id: 4, symbol: "☳", name: "雷", nature: "発動", trait: "雷鳴行動・革新実行" },
                    "巽": { id: 5, symbol: "☴", name: "風", nature: "順入", trait: "風流浸透・柔軟適応" },
                    "坎": { id: 6, symbol: "☵", name: "水", nature: "陷険", trait: "深淵探求・洞察突破" },
                    "艮": { id: 7, symbol: "☶", name: "山", nature: "静止", trait: "山岳安定・不動継続" },
                    "坤": { id: 8, symbol: "☷", name: "地", nature: "柔順", trait: "大地受容・育成包容" }
                };
            }
            
            initializeKeywordMaps() {
                // Interface OS keywords
                this.interfaceKeywords.set("リーダーシップ", ["1", "13", "43", "14"]);
                this.interfaceKeywords.set("協調性", ["2", "15", "45", "8"]);
                this.interfaceKeywords.set("創造性", ["1", "43", "34", "14"]);
                
                // SafeMode OS keywords  
                this.safeModeKeywords.set("慎重", ["2", "52", "39", "15"]);
                this.safeModeKeywords.set("分析的", ["29", "48", "47", "6"]);
                this.safeModeKeywords.set("撤退", ["33", "12", "45", "35"]);
            }
            
            // Triple OS分析のメイン処理
            async analyzeTripleOS(allAnswers) {
                console.log("🔯 Starting Triple OS Analysis - Phase 2 Independent System");
                
                try {
                    // Phase 2: 独立計算システムを使用
                    const independentCalculator = new IndependentOSCalculator();
                    
                    // 1. 回答を価値観質問、シナリオ質問、防御質問に分離
                    const { worldviewAnswers, scenarioAnswers, defenseAnswers } = this.separateAnswers(allAnswers);
                    
                    // 2. Phase 2: 各OS独立計算
                    console.log("🔧 Engine OS Independent Calculation");
                    const engineVector = independentCalculator.calculateEngineOS(allAnswers);
                    const engineReliability = independentCalculator.validateReliability(allAnswers, 'engine');
                    console.log("Engine OS Vector:", engineVector, "Reliability:", engineReliability);
                    
                    console.log("🤝 Interface OS Independent Calculation");
                    const interfaceVector = independentCalculator.calculateInterfaceOS(allAnswers);
                    const interfaceReliability = independentCalculator.validateReliability(allAnswers, 'interface');
                    console.log("Interface OS Vector:", interfaceVector, "Reliability:", interfaceReliability);
                    
                    console.log("🛡️ Safe Mode OS Independent Calculation");
                    const safeModeVector = independentCalculator.calculateSafeModeOS(allAnswers);
                    const safeModeReliability = independentCalculator.validateReliability(allAnswers, 'safemode');
                    console.log("Safe Mode OS Vector:", safeModeVector, "Reliability:", safeModeReliability);
                    
                    // 3. 独立計算結果からOS結果を構築
                    const engineOS = await this.buildOSResult(engineVector, 'engine');
                    const interfaceOS = await this.buildOSResult(interfaceVector, 'interface');
                    const safeModeOS = await this.buildOSResult(safeModeVector, 'safemode');
                    
                    // 5. 全OSが正常に計算されたか確認
                    this.validateTripleOSResults(engineOS, interfaceOS, safeModeOS);
                    
                    // 6. Triple OS統合分析の実行
                    const tripleOSIntegration = await this.calculateTripleOSInteraction(engineOS, interfaceOS, safeModeOS);
                    
                    console.log("✅ Triple OS Analysis Completed Successfully");
                    
                    return {
                        engineOS,
                        interfaceOS,
                        safeModeOS,
                        integration: tripleOSIntegration,
                        consistencyScore: tripleOSIntegration.consistency,
                        balanceScore: tripleOSIntegration.balance,
                        HaQeiIntegration: tripleOSIntegration.integration,
                        recommendations: tripleOSIntegration.recommendations,
                        validationStatus: "completed",
                        timestamp: Date.now()
                    };
                    
                } catch (error) {
                    console.error("❌ Triple OS Analysis Error:", error);
                    
                    // 統合エラーハンドリング - デフォルトのTriple OS結果を返す
                    return this.getDefaultTripleOSResults();
                }
            }
            
            // Phase 2: 独立計算ベクトルからOS結果を構築
            async buildOSResult(trigramVector, osType) {
                console.log(`🔧 Building ${osType} OS result from independent vector:`, trigramVector);
                
                // 易経の正統な八卦配列（上から下への伝統的順序）
                const baguaMapping = {
                    "乾_創造性": 1,  // ☰ 天
                    "兌_調和性": 2,  // ☱ 沢
                    "離_表現性": 3,  // ☲ 火
                    "震_行動性": 4,  // ☳ 雷
                    "巽_適応性": 5,  // ☴ 風
                    "坎_探求性": 6,  // ☵ 水
                    "艮_安定性": 7,  // ☶ 山
                    "坤_受容性": 8   // ☷ 地
                };
                
                // OSタイプに応じた重み付けを適用
                const weights = osType === 'engine' ? DIMENSION_WEIGHTS.ENGINE_OS :
                               osType === 'interface' ? DIMENSION_WEIGHTS.INTERFACE_OS :
                               DIMENSION_WEIGHTS.SAFE_MODE_OS;
                
                // 重み付けを適用したスコアを計算
                const weightedVector = {};
                Object.entries(trigramVector).forEach(([key, value]) => {
                    weightedVector[key] = value * (weights[key] || 0.5);
                });
                
                // 上位2つの八卦を取得
                const sortedBagua = Object.entries(weightedVector)
                    .sort((a, b) => b[1] - a[1]);
                
                // 上位2つの八卦を取得（純卦許容）
                const topBagua1 = sortedBagua[0][0];
                let topBagua2 = sortedBagua[1] ? sortedBagua[1][0] : sortedBagua[0][0];
                
                // 純卦（同一八卦の重複）を許容
                const isPureHexagram = topBagua1 === topBagua2;
                if (isPureHexagram) {
                    console.log(`✨ 純卦検出: ${topBagua1}為${topBagua1} (同一八卦の重複)`);
                }
                
                const topBaguaId1 = baguaMapping[topBagua1];
                const topBaguaId2 = baguaMapping[topBagua2];
                
                // 正統的64卦マトリックス（転置済み・修正版）
                // CORRECTED_MATRIX[上卦インデックス][下卦インデックス] = 卦番号
                const authenticHexagramMatrix = [
                    // 上卦: 乾（天）, 下卦: 乾,兌,離,震,巽,坎,艮,坤
                    [1,  10, 13, 25, 44,  6, 33, 12],
                    // 上卦: 兌（沢）
                    [43, 58, 49, 17, 28, 47, 31, 45],
                    // 上卦: 離（火）
                    [14, 38, 30, 21, 50, 64, 56, 35],
                    // 上卦: 震（雷）
                    [34, 54, 55, 51, 32, 40, 62, 16],
                    // 上卦: 巽（風）
                    [9,  61, 37, 42, 57, 59, 53, 20],
                    // 上卦: 坎（水）
                    [5,  60, 63,  3, 48, 29, 39,  8],
                    // 上卦: 艮（山）
                    [26, 41, 22, 27, 18,  4, 52, 23],
                    // 上卦: 坤（地）
                    [11, 19, 36, 24, 46,  7, 15,  2]
                ];
                
                // 2つの可能な卦の組み合わせを作成（マトリックス使用）
                const candidate1 = {
                    upper: topBagua1,
                    lower: topBagua2,
                    upperId: topBaguaId1,
                    lowerId: topBaguaId2,
                    hexagramId: authenticHexagramMatrix[topBaguaId1 - 1][topBaguaId2 - 1]
                };
                
                const candidate2 = {
                    upper: topBagua2,
                    lower: topBagua1,
                    upperId: topBaguaId2,
                    lowerId: topBaguaId1,
                    hexagramId: authenticHexagramMatrix[topBaguaId2 - 1][topBaguaId1 - 1]
                };
                
                // 各候補の卦のキーワードを取得
                const keywords1 = this.extractHexagramKeywords(candidate1.hexagramId);
                const keywords2 = this.extractHexagramKeywords(candidate2.hexagramId);
                
                // OSタイプに応じたキーワードの適合度を計算
                const score1 = this.calculateKeywordFitness(keywords1, osType, sortedBagua);
                const score2 = this.calculateKeywordFitness(keywords2, osType, sortedBagua);
                
                // より適合度の高い卦を選択
                const selectedCandidate = score1 >= score2 ? candidate1 : candidate2;
                
                console.log(`🎯 ${osType} OS 卦選択:`, {
                    候補1: `${candidate1.upper}/${candidate1.lower} (#${candidate1.hexagramId})`,
                    キーワード1: keywords1.slice(0, 5),
                    スコア1: score1,
                    候補2: `${candidate2.upper}/${candidate2.lower} (#${candidate2.hexagramId})`,
                    キーワード2: keywords2.slice(0, 5),
                    スコア2: score2,
                    選択: score1 >= score2 ? '候補1' : '候補2'
                });
                
                const upperBaguaName = selectedCandidate.upper;
                const lowerBaguaName = selectedCandidate.lower;
                const upperBaguaId = selectedCandidate.upperId;
                const lowerBaguaId = selectedCandidate.lowerId;
                const hexagramId = selectedCandidate.hexagramId;
                const validHexagramId = Math.max(1, Math.min(64, hexagramId));
                
                // 卦データを取得
                const hexagramData = this.getHexagramDataWithMeaning(validHexagramId, upperBaguaId, lowerBaguaId);
                
                // 強度を計算（正規化された値）
                const maxEnergy = Math.max(...Object.values(weightedVector));
                const strength = Math.round((maxEnergy / (maxEnergy + 1)) * 100);
                
                return {
                    type: osType,
                    strength: strength,
                    baguaEnergies: trigramVector,
                    dominantTrigram: upperBaguaName,
                    upperBagua: hexagramData.upperBagua,
                    lowerBagua: hexagramData.lowerBagua,
                    hexagramId: validHexagramId,
                    hexagramName: hexagramData.name_jp || hexagramData.name,
                    hexagramMeaning: hexagramData.meaning,
                    reading: hexagramData.reading,
                    catchphrase: hexagramData.catchphrase || hexagramData.meaning,
                    description: hexagramData.description || hexagramData.meaning,
                    keywords: hexagramData.keywords || [],
                    reliability: this.calculateVectorReliability(trigramVector),
                    timestamp: new Date().toISOString(),
                    // ペルソナ情報（後で強化される）
                    persona: null
                };
            }
            
            // ベクトル信頼性計算
            calculateVectorReliability(vector) {
                const values = Object.values(vector);
                const nonZeroCount = values.filter(v => v > 0.1).length;
                const distribution = values.reduce((sum, v) => sum + v, 0) / 8;
                return Math.min(1.0, (nonZeroCount / 8) * 0.7 + distribution * 0.3);
            }
            
            separateAnswers(allAnswers) {
                const worldviewAnswers = [];  // Q1-Q12: Engine OS用
                const scenarioAnswers = [];   // Q13-Q24: Interface OS用
                const defenseAnswers = [];    // Q25-Q36: Safe Mode OS用
                
                allAnswers.forEach(answer => {
                    const questionNum = parseInt(answer.questionId.replace('q', ''));
                    if (questionNum >= 1 && questionNum <= 12) {
                        worldviewAnswers.push(answer);  // Engine OS (価値観・内的動機)
                    } else if (questionNum >= 13 && questionNum <= 24) {
                        scenarioAnswers.push(answer);   // Interface OS (対人関係・社会的側面)
                    } else if (questionNum >= 25 && questionNum <= 36) {
                        defenseAnswers.push(answer);    // Safe Mode OS (防御・ストレス対応)
                    }
                });
                
                console.log('📊 質問分離結果:', {
                    Engine: `Q1-Q12 (${worldviewAnswers.length}問)`,
                    Interface: `Q13-Q24 (${scenarioAnswers.length}問)`,
                    SafeMode: `Q25-Q36 (${defenseAnswers.length}問)`
                });
                
                return { worldviewAnswers, scenarioAnswers, defenseAnswers };
            }
            
            async analyzeEngineOS(worldviewAnswers) {
                // ユーザーベクトルの構築
                const userVector = this.buildUserVector(worldviewAnswers);
                
                // 八卦エネルギーの計算
                const baguaEnergies = this.calculateBaguaEnergies(userVector);
                
                // 最も強い2つの八卦を特定
                const sortedBagua = Object.entries(baguaEnergies)
                    .sort(([, a], [, b]) => b - a);
                
                const upperBagua = sortedBagua[0][0];
                const lowerBagua = sortedBagua[1][0];
                
                // ヘキサグラムにマッピング
                const hexagramId = this.mapTrigramsToHexagram(upperBagua, lowerBagua);
                const hexagram = (typeof H64_DATA !== 'undefined' && H64_DATA) ?
                    H64_DATA.find(h => h.hexagramId === hexagramId) || H64_DATA[0] :
                    { hexagramId: hexagramId, name: `卦${hexagramId}`, description: '' };
                
                return {
                    hexagramId,
                    hexagramName: hexagram.name_jp,
                    description: hexagram.description,
                    catchphrase: hexagram.catchphrase,
                    primaryTrigram: upperBagua,
                    secondaryTrigram: lowerBagua,
                    baguaEnergies
                };
            }
            
            buildUserVector(answers) {
                const vector = {
                    乾_創造性: 0, 震_行動性: 0, 坎_探求性: 0, 艮_安定性: 0,
                    坤_受容性: 0, 巽_適応性: 0, 離_表現性: 0, 兌_調和性: 0
                };
                
                answers.forEach(answer => {
                    const option = answer.selectedOption;
                    if (option && option.scoring) {
                        Object.entries(option.scoring).forEach(([dimension, score]) => {
                            if (vector.hasOwnProperty(dimension)) {
                                vector[dimension] += score;
                            }
                        });
                    }
                });
                
                return vector;
            }
            
            calculateBaguaEnergies(userVector, osType = 'engine') {
                // Phase 3: 改善された正規化システム
                const rawEnergies = {};
                
                // 8次元ベクトルから8八卦への正統変換
                Object.entries(AUTHENTIC_TRIGRAM_MAPPING).forEach(([dimension, trigramId]) => {
                    const trigramName = this.getBaguaName(trigramId);
                    rawEnergies[trigramName] = userVector[dimension] || 0;
                });
                
                // Step 1: Z-score標準化
                const values = Object.values(rawEnergies);
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const variance = values.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / values.length;
                const std = Math.sqrt(variance);
                
                const zScored = {};
                Object.entries(rawEnergies).forEach(([key, value]) => {
                    zScored[key] = std > 0 ? (value - mean) / std : 0;
                });
                
                // Step 2: ReLU活性化（負値を0.01以上に）
                const activated = {};
                Object.entries(zScored).forEach(([key, value]) => {
                    activated[key] = Math.max(0.01, value);
                });
                
                // Step 3: L1正規化（合計を1に）
                const sum = Object.values(activated).reduce((a, b) => a + b, 0);
                const normalized = {};
                Object.entries(activated).forEach(([key, value]) => {
                    normalized[key] = sum > 0 ? value / sum : 0.125;
                });
                
                // Step 4: OS別重み付け（Phase 3改善）
                const OS_WEIGHTS = {
                    engine: {
                        "乾": 1.2, "兌": 0.9, "離": 1.1, "震": 1.0,
                        "巽": 0.9, "坎": 1.1, "艮": 1.0, "坤": 0.8
                    },
                    interface: {
                        "乾": 0.9, "兌": 1.3, "離": 1.1, "震": 1.0,
                        "巽": 1.1, "坎": 0.8, "艮": 0.9, "坤": 1.0
                    },
                    safemode: {
                        "乾": 1.0, "兌": 0.9, "離": 0.8, "震": 0.9,
                        "巽": 1.0, "坎": 1.1, "艮": 1.3, "坤": 1.1
                    }
                };
                
                const weights = OS_WEIGHTS[osType] || OS_WEIGHTS.engine;
                const weighted = {};
                Object.entries(normalized).forEach(([key, value]) => {
                    weighted[key] = value * (weights[key] || 1.0);
                });
                
                // 再正規化
                const finalSum = Object.values(weighted).reduce((a, b) => a + b, 0);
                const normalizedEnergies = {};
                
                if (finalSum > 0) {
                    Object.entries(weighted).forEach(([bagua, energy]) => {
                        // 最終正規化（パーセンテージ表示用）
                        normalizedEnergies[bagua] = (energy / finalSum) * 100;
                    });
                } else {
                    // デフォルト値（均等分散）
                    Object.keys(rawEnergies).forEach(bagua => {
                        normalizedEnergies[bagua] = 12.5; // 100/8
                    });
                }
                
                return normalizedEnergies;
            }
            
            getBaguaName(trigramId) {
                const trigramNames = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
                return trigramNames[trigramId - 1] || "乾";
            }
            
            mapTrigramsToHexagram(upperBagua, lowerBagua) {
                // 易経準拠の正確な64卦計算（先天八卦配列基準）
                const trigramToNumber = {
                    "乾": 1, "兌": 2, "離": 3, "震": 4,
                    "巽": 5, "坎": 6, "艮": 7, "坤": 8
                };
                
                const upper = trigramToNumber[upperBagua] || 1;
                const lower = trigramToNumber[lowerBagua] || 1;
                
                // 正統的64卦マトリックス（転置済み・修正版）
                // CORRECTED_MATRIX[上卦インデックス][下卦インデックス] = 卦番号
                const authenticHexagramMatrix = [
                    // 上卦: 乾（天）, 下卦: 乾,兌,離,震,巽,坎,艮,坤
                    [1,  10, 13, 25, 44,  6, 33, 12],
                    // 上卦: 兌（沢）
                    [43, 58, 49, 17, 28, 47, 31, 45],
                    // 上卦: 離（火）
                    [14, 38, 30, 21, 50, 64, 56, 35],
                    // 上卦: 震（雷）
                    [34, 54, 55, 51, 32, 40, 62, 16],
                    // 上卦: 巽（風）
                    [9,  61, 37, 42, 57, 59, 53, 20],
                    // 上卦: 坎（水）
                    [5,  60, 63,  3, 48, 29, 39,  8],
                    // 上卦: 艮（山）
                    [26, 41, 22, 27, 18,  4, 52, 23],
                    // 上卦: 坤（地）
                    [11, 19, 36, 24, 46,  7, 15,  2]
                ];
                
                // 易経正統計算
                const hexagramId = authenticHexagramMatrix[upper - 1][lower - 1];
                
                console.log(`🔯 Authentic I-Ching Mapping: ${upperBagua}(${upper}) over ${lowerBagua}(${lower}) = Hexagram ${hexagramId}`);
                
                return hexagramId;
            }
            
            // 卦データ取得メソッド
            getHexagramData(hexagramId) {
                const hexagram = (typeof H64_DATA !== 'undefined' && H64_DATA) ?
                    H64_DATA.find(h => h.hexagramId === hexagramId) : null;
                if (!hexagram) {
                    console.warn(`Hexagram ${hexagramId} not found, using default`);
                    return HEXAGRAMS[0] || {
                        hexagram_id: hexagramId,
                        name_jp: `卦${hexagramId}`,
                        description: "データが見つかりません",
                        catchphrase: "---"
                    };
                }
                return hexagram;
            }
            
            // 易経の意味的関係を考慮した補完八卦選択
            selectComplementaryBagua(upperBagua, sortedBagua, mode) {
                // 易経の相生・相剋関係に基づく組み合わせ
                const relationships = {
                    "乾_創造性": {
                        inner: "坎_探求性",      // 天と水：探求により創造を深める
                        harmony: "巽_適応性",     // 天と風：柔軟な創造
                        stability: "坤_受容性"    // 天と地：陰陽の調和
                    },
                    "兌_調和性": {
                        inner: "離_表現性",      // 沢と火：内なる喜びの表現
                        harmony: "坤_受容性",     // 沢と地：包容的な調和
                        stability: "艮_安定性"    // 沢と山：静かな喜び
                    },
                    "離_表現性": {
                        inner: "震_行動性",      // 火と雷：情熱的な行動
                        harmony: "兌_調和性",     // 火と沢：明るい調和
                        stability: "坎_探求性"    // 火と水：バランスのとれた表現
                    },
                    "震_行動性": {
                        inner: "乾_創造性",      // 雷と天：創造的な行動
                        harmony: "離_表現性",     // 雷と火：活発な表現
                        stability: "坤_受容性"    // 雷と地：地に足の着いた行動
                    },
                    "巽_適応性": {
                        inner: "坎_探求性",      // 風と水：流動的な適応
                        harmony: "乾_創造性",     // 風と天：創造的な適応
                        stability: "艮_安定性"    // 風と山：安定した柔軟性
                    },
                    "坎_探求性": {
                        inner: "艮_安定性",      // 水と山：深い静寂
                        harmony: "巽_適応性",     // 水と風：流動的な調和
                        stability: "坤_受容性"    // 水と地：受容的な探求
                    },
                    "艮_安定性": {
                        inner: "坤_受容性",      // 山と地：不動の大地
                        harmony: "坎_探求性",     // 山と水：静と動の調和
                        stability: "乾_創造性"    // 山と天：高い理想の安定
                    },
                    "坤_受容性": {
                        inner: "艮_安定性",      // 地と山：大地の安定
                        harmony: "兌_調和性",     // 地と沢：潤いのある大地
                        stability: "乾_創造性"    // 地と天：陰陽の完全な調和
                    }
                };
                
                // 関係性に基づいて選択
                const idealMatch = relationships[upperBagua]?.[mode];
                
                // 理想的な組み合わせが利用可能か確認
                const matchingTrigram = sortedBagua.find(([name]) => name === idealMatch);
                if (matchingTrigram && matchingTrigram[1] > 0.2) {
                    return idealMatch;
                }
                
                // 次善の選択（2番目に強い八卦）
                return sortedBagua[1][0];
            }
            
            // 64卦の意味的解釈を含むデータ取得
            getHexagramDataWithMeaning(hexagramId, upperBaguaId, lowerBaguaId) {
                const hexagramData = this.getHexagramData(hexagramId);
                
                // 易経の伝統的解釈を追加
                const trigramNames = ["", "乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
                const upperName = trigramNames[upperBaguaId];
                const lowerName = trigramNames[lowerBaguaId];
                
                // H384_DATAから該当する卦のキーワードを取得
                const keywords = this.extractHexagramKeywords(hexagramId);
                
                // デフォルト名を保証
                const defaultName = `${upperName}${lowerName}` || `卦${hexagramId}`;
                
                return {
                    ...hexagramData,
                    hexagram_id: hexagramId,
                    upperBagua: upperName,
                    lowerBagua: lowerName,
                    name_jp: hexagramData?.name_jp || defaultName,
                    name: hexagramData?.name || defaultName,
                    description: hexagramData?.description || this.getHexagramMeaning(upperBaguaId, lowerBaguaId),
                    catchphrase: hexagramData?.catchphrase || this.generateCatchphrase(keywords),
                    meaning: this.getHexagramMeaning(upperBaguaId, lowerBaguaId),
                    keywords: keywords
                };
            }
            
            // H384_DATAから卦のキーワードを抽出
            extractHexagramKeywords(hexagramId) {
                if (typeof H384_DATA === 'undefined' || !Array.isArray(H384_DATA)) {
                    return [];
                }
                
                // 該当する卦番号のエントリーを取得
                const hexagramEntries = H384_DATA.filter(entry => entry['卦番号'] === hexagramId);
                
                // 各爻のキーワードを収集（重複を避けつつ）
                const keywordSet = new Set();
                hexagramEntries.forEach(entry => {
                    if (entry['キーワード'] && Array.isArray(entry['キーワード'])) {
                        entry['キーワード'].forEach(keyword => keywordSet.add(keyword));
                    }
                });
                
                return Array.from(keywordSet);
            }
            
            // キーワードからキャッチフレーズを生成
            generateCatchphrase(keywords) {
                if (!keywords || keywords.length === 0) {
                    return "変化と成長の時";
                }
                
                // 最初の3つのキーワードを使用
                const topKeywords = keywords.slice(0, 3);
                return topKeywords.join('・') + 'の時';
            }
            
            // OSタイプとキーワードの適合度を計算
            calculateKeywordFitness(keywords, osType, trigramScores) {
                if (!keywords || keywords.length === 0) {
                    return 0;
                }
                
                let score = 0;
                const totalKeywords = keywords.length;
                
                // OSタイプ別の重要キーワード
                const osKeywordPatterns = {
                    'engine': {
                        // Engine OS: 内的動機・価値観・成長
                        high: ['創造', '探求', '成長', '学習', '目標', '意志', '価値', '潜在', '基礎', '発展'],
                        medium: ['内省', '思索', '理想', '本質', '核心', '動機', '原点'],
                        low: ['外交', '社交', '表面', '外観']
                    },
                    'interface': {
                        // Interface OS: 対人関係・コミュニケーション
                        high: ['調和', '協力', '信頼', '交流', '共感', '理解', '関係', 'コミュニケーション', '共同', '和合'],
                        medium: ['柔軟', '適応', '対話', '交渉', '仲間', 'チーム'],
                        low: ['孤立', '孤独', '内向', '閉鎖']
                    },
                    'safemode': {
                        // Safe Mode OS: 防御・安定・回復
                        high: ['安定', '保護', '慎重', '忍耐', '回復', '防御', '休息', '内省', '静', '守り'],
                        medium: ['抑制', '制御', '節度', 'バランス', '調整', '維持'],
                        low: ['攻撃', '拡張', '冒険', '無謀']
                    }
                };
                
                const patterns = osKeywordPatterns[osType] || osKeywordPatterns['engine'];
                
                // キーワードのマッチングをスコア化
                keywords.forEach(keyword => {
                    let matched = false;
                    
                    // 高優先度キーワード
                    for (const pattern of patterns.high) {
                        if (keyword.includes(pattern)) {
                            score += 3;
                            matched = true;
                            break;
                        }
                    }
                    
                    if (!matched) {
                        // 中優先度キーワード
                        for (const pattern of patterns.medium) {
                            if (keyword.includes(pattern)) {
                                score += 2;
                                matched = true;
                                break;
                            }
                        }
                    }
                    
                    if (!matched) {
                        // 低優先度キーワード（ネガティブスコア）
                        for (const pattern of patterns.low) {
                            if (keyword.includes(pattern)) {
                                score -= 1;
                                break;
                            }
                        }
                    }
                });
                
                // キーワード数で正規化（キーワードが多い卦に偏らないように）
                const normalizedScore = totalKeywords > 0 ? score / Math.sqrt(totalKeywords) : 0;
                
                // 八卦エネルギーも考慮（上位の八卦の組み合わせを優先）
                const trigramBonus = trigramScores[0][1] * 0.1; // 最強の八卦の影響を加味
                
                return normalizedScore + trigramBonus;
            }
            
            // 上卦と下卦の組み合わせから意味を導出
            getHexagramMeaning(upperBaguaId, lowerBaguaId) {
                // 易経64卦の完全な意味定義
                const meanings = {
                    // === 純卦（同一卦の重複）===
                    "1_1": "純粋な創造力、無限の可能性",           // 1.乾為天
                    "8_8": "完全な受容、大地の包容力",             // 2.坤為地
                    "6_6": "深い探求、困難を乗り越える力",         // 29.坎為水
                    "3_3": "明るい表現、知性の輝き",               // 30.離為火
                    "4_4": "激しい行動、革新的な変化",             // 51.震為雷
                    "7_7": "不動の安定、確固たる基盤",             // 52.艮為山
                    "5_5": "柔軟な適応、浸透する影響力",           // 57.巽為風
                    "2_2": "喜びの調和、コミュニケーション",       // 58.兌為沢
                    
                    // === 陰陽調和の卦 ===
                    "8_1": "天地の交流、泰平と繁栄",               // 11.地天泰
                    "1_8": "天地の隔絶、停滞と変革の必要",         // 12.天地否
                    "6_3": "既に成就、完成と新たな始まり",         // 63.水火既済
                    "3_6": "未だ成らず、可能性と挑戦",            // 64.火水未済
                    
                    // === 乾（天）が上卦の組み合わせ ===
                    "1_2": "礼を履む、慎重な前進と喜び",           // 10.天沢履
                    "1_3": "志を同じくする仲間との協力",           // 13.天火同人
                    "1_4": "純粋な動機での行動、真実への道",       // 25.天雷無妄
                    "1_5": "予期せぬ出会い、新たな機会",           // 44.天風姤
                    "1_6": "葛藤から学ぶ知恵、建設的な議論",       // 6.天水訟
                    "1_7": "戦略的撤退、力を蓄える時",             // 33.天山遯
                    
                    // === 坤（地）が上卦の組み合わせ ===
                    "8_2": "人々が集まる調和、共同体の力",         // 45.地沢萃
                    "8_3": "内なる光を守る、静かな強さ",           // 36.地火明夷
                    "8_4": "原点回帰と再生、新たなサイクル",       // 24.地雷復
                    "8_5": "着実な上昇と成長、努力の実り",         // 46.地風升
                    "8_6": "統率と組織の力、チームワーク",         // 7.地水師
                    "8_7": "謙虚さからの強さ、内なる充実",         // 15.地山謙
                    
                    // === 震（雷）が上卦の組み合わせ ===
                    "4_1": "力強い前進、勢いに乗る時",             // 34.雷天大壮
                    "4_2": "新たな関係の始まり、縁の結び",         // 54.雷沢帰妹
                    "4_3": "豊かさと充実、最盛期の輝き",           // 55.雷火豊
                    "4_5": "永続性と一貫性、変わらぬ価値",         // 32.雷風恒
                    "4_6": "問題解決と解放、すっきりとした前進",   // 40.雷水解
                    "4_7": "小さな超越、細部への配慮",             // 62.雷山小過
                    "4_8": "準備と予見、楽観的な展望",             // 16.雷地豫
                    
                    // === 巽（風）が上卦の組み合わせ ===
                    "5_1": "小さな蓄積、力を蓄える時",             // 9.風天小畜
                    "5_2": "内なる誠実、信頼の構築",               // 61.風沢中孚
                    "5_3": "家族と調和、温かい関係性",             // 37.風火家人
                    "5_4": "利益と成長、win-winの関係",            // 42.風雷益
                    "5_6": "分散から統合へ、新たな秩序",           // 59.風水渙
                    "5_7": "段階的な進歩、着実な成長",             // 53.風山漸
                    "5_8": "観察と洞察、全体を見渡す力",           // 20.風地観
                    
                    // === 坎（水）が上卦の組み合わせ ===
                    "6_1": "待つことの知恵、タイミングの重要性",   // 5.水天需
                    "6_2": "困難の中の成長、試練を糧に",           // 47.水沢困
                    "6_4": "始まりの困難、創業の苦労",             // 3.水雷屯
                    "6_5": "深い知恵の源泉、変わらぬ真理",         // 48.水風井
                    "6_7": "困難を超える忍耐、着実な前進",         // 39.水山蹇
                    "6_8": "親密な協力関係、信頼の絆",             // 8.水地比
                    
                    // === 艮（山）が上卦の組み合わせ ===
                    "7_1": "大いなる蓄積、実力を養う時",           // 26.山天大畜
                    "7_2": "犠牲から得る価値、与えることの喜び",   // 41.山沢損
                    "7_3": "美しい装飾、内面の充実",               // 22.山火賁
                    "7_4": "養い育てる、ケアとサポート",           // 27.山雷頤
                    "7_5": "腐敗を改革する、問題の根本解決",       // 18.山風蠱
                    "7_6": "無知から学ぶ、初心者の心",             // 4.山水蒙
                    "7_8": "古いものを剥がす、新陳代謝",           // 23.山地剥
                    
                    // === 離（火）が上卦の組み合わせ ===
                    "3_1": "大いなる所有、豊かな資源",             // 14.火天大有
                    "3_2": "対立から理解へ、違いを認める",         // 38.火沢睽
                    "3_4": "障害を噛み砕く、問題の突破",           // 21.火雷噬嗑
                    "3_5": "変革の器、新しい価値の創造",           // 50.火風鼎
                    "3_7": "人生の旅路、経験を積む時",             // 56.火山旅
                    "3_8": "明るい前進、認められる成果",           // 35.火地晋
                    
                    // === 兌（沢）が上卦の組み合わせ ===
                    "2_1": "決断と突破、勇気ある行動",             // 43.沢天夬
                    "2_3": "革命と変革、新しい時代へ",             // 49.沢火革
                    "2_4": "自然に従う、流れに乗る",               // 17.沢雷随
                    "2_5": "大いなる超越、限界を超える",           // 28.沢風大過
                    "2_6": "困難を楽しむ、逆境の中の成長",         // 47.沢水困
                    "2_7": "感応と共鳴、心が通じ合う",             // 31.沢山咸
                    "2_8": "臨機応変、柔軟な対応力"                // 19.沢地臨
                };
                
                const key = `${upperBaguaId}_${lowerBaguaId}`;
                return meanings[key] || "上下の卦が調和し、新たな可能性を示す";
            }
            
            async analyzeInterfaceOS(scenarioAnswers, engineOS) {
                console.log("🌐 Interface OS Analysis: Social Pattern Mapping");
                
                try {
                    // 1. シナリオ質問から社会的パターンを分析
                    const socialPatterns = this.analyzeSocialPatterns(scenarioAnswers);
                    console.log("📊 Social Patterns:", socialPatterns);
                    
                    // 2. Interface OS専用の8次元ベクトル構築
                    const interfaceVector = this.buildInterfaceVector(socialPatterns);
                    console.log("🎯 Interface Vector:", interfaceVector);
                    
                    // 3. 社会的八卦エネルギー計算
                    const socialTrigramEnergies = this.calculateSocialBaguaEnergies(interfaceVector);
                    console.log("⚡ Social Trigram Energies:", socialTrigramEnergies);
                    
                    // 4. Engine OSとの相互作用補正
                    const adjustedEnergies = this.adjustForEngineOS(socialTrigramEnergies, engineOS);
                    console.log("🔄 Adjusted for Engine OS:", adjustedEnergies);
                    
                    // 5. Interface OS用の最適八卦選択
                    const { upperBagua, lowerBagua } = this.selectInterfaceBagua(adjustedEnergies);
                    console.log("🔼 Selected Trigrams:", { upper: upperBagua, lower: lowerBagua });
                    
                    // 6. 64卦へマッピング
                    const hexagramId = this.mapTrigramsToHexagram(upperBagua, lowerBagua);
                    const hexagramData = this.getHexagramData(hexagramId);
                    
                    // 7. Interface OS専用解釈生成
                    const interfaceInterpretation = this.generateInterfaceInterpretation(
                        hexagramId, upperBagua, lowerBagua, socialPatterns, engineOS
                    );
                    
                    console.log(`🌟 Interface OS Result: Hexagram ${hexagramId} (${hexagramData.name_jp})`);
                    
                    return {
                        hexagramId,
                        hexagramName: hexagramData.name_jp,
                        upperBagua,
                        lowerBagua,
                        socialPatterns,
                        interfaceVector,
                        socialStyle: this.determineSocialStyle(socialPatterns),
                        description: interfaceInterpretation.description,
                        leadership: interfaceInterpretation.leadership,
                        communication: interfaceInterpretation.communication,
                        conflictResolution: interfaceInterpretation.conflictResolution,
                        adaptability: interfaceInterpretation.adaptability,
                        engineOSInfluence: interfaceInterpretation.engineOSInfluence,
                        baguaEnergies: adjustedEnergies,
                        type: "Interface OS"
                    };
                    
                } catch (error) {
                    console.error("❌ Interface OS Analysis Error:", error);
                    return this.getDefaultInterfaceOS();
                }
            }
            
            async analyzeSafeModeOS(defenseAnswers, engineOS) {
                console.log("🛡️ SafeMode OS Analysis: Defensive Pattern Extraction");
                
                try {
                    // 1. 防御質問から防御パターンを抽出
                    const defensivePatterns = this.extractDefensivePatterns(defenseAnswers);
                    console.log("⚡ Defensive Patterns:", defensivePatterns);
                    
                    // 2. ストレス反応ベクトル構築
                    const stressVector = this.buildStressResponseVector(defensivePatterns);
                    console.log("🌪️ Stress Response Vector:", stressVector);
                    
                    // 3. 防御的八卦エネルギー計算
                    const defensiveTrigramEnergies = this.calculateDefensiveBaguaEnergies(stressVector);
                    console.log("⚔️ Defensive Trigram Energies:", defensiveTrigramEnergies);
                    
                    // 4. Engine OSによる基礎的影響（40%）
                    const adjustedEnergies = this.adjustForCorePersonality(defensiveTrigramEnergies, engineOS);
                    console.log("🔧 Core-Adjusted Energies:", adjustedEnergies);
                    
                    // 5. 最も強い防御パターンの八卦を特定
                    const [primaryDefense, secondaryDefense] = this.selectDefensiveBagua(adjustedEnergies);
                    console.log(`🎯 Selected Defense Trigrams: ${primaryDefense} over ${secondaryDefense}`);
                    
                    // 6. 64卦へマッピング
                    const hexagramId = this.mapTrigramsToHexagram(primaryDefense, secondaryDefense);
                    const hexagramData = this.getHexagramData(hexagramId);
                    
                    // 7. SafeMode OS専用解釈生成
                    const safeModeInterpretation = this.generateSafeModeInterpretation(
                        hexagramId, primaryDefense, secondaryDefense, defensivePatterns, engineOS
                    );
                    
                    console.log(`🔯 SafeMode OS Result: Hexagram ${hexagramId} (${hexagramData.name_jp})`);
                    
                    return {
                        hexagramId,
                        hexagramName: hexagramData.name_jp,
                        description: safeModeInterpretation.description,
                        catchphrase: safeModeInterpretation.catchphrase,
                        primaryDefense: primaryDefense,
                        secondaryDefense: secondaryDefense,
                        defensiveType: safeModeInterpretation.defensiveType,
                        stressResponse: safeModeInterpretation.stressResponse,
                        activationTrigger: safeModeInterpretation.activationTrigger,
                        defensiveStrength: this.calculateDefensiveStrength(defensivePatterns),
                        baguaEnergies: adjustedEnergies,
                        type: "Safe Mode OS"
                    };
                    
                } catch (error) {
                    console.error("❌ SafeMode OS Analysis Error:", error);
                    return this.getDefaultSafeModeOS();
                }
            }

            extractDefensivePatterns(defenseAnswers) {
                const patterns = {
                    Q25_leadershipStress: 0,    // Q25: 責任の重圧への防御
                    Q26_interpersonalStress: 0, // Q26: 人間関係ストレスへの防御
                    Q27_familyStress: 0,        // Q27: 親密関係の負荷への防御
                    Q28_emergencyStress: 0,     // Q28: 危機的状況への防御
                    Q29_competitionStress: 0,   // Q29: 競争圧力への防御
                    Q30_collaborationStress: 0, // Q30: 協調の負担への防御
                    Q31_socialStress: 0,        // Q31: 社会的圧力への防御
                    Q32_failureStress: 0,       // Q32: 失敗・挻折への防御
                    Q33_changeStress: 0,        // Q33: 変化・不確実性への防御
                    Q34_isolationStress: 0,     // Q34: 孤立・孤独への防御
                    Q35_performanceStress: 0,   // Q35: パフォーマンス圧力への防御
                    Q36_resourceStress: 0       // Q36: 資源不足への防御
                };
                
                // 各防御回答から防御的反応パターンを抽出
                defenseAnswers.forEach((answer, index) => {
                    const questionNum = 25 + index;
                    const stressResponse = this.analyzeStressResponse(answer, questionNum);
                    
                    switch(questionNum) {
                        case 25: patterns.Q25_leadershipStress = stressResponse; break;
                        case 26: patterns.Q26_interpersonalStress = stressResponse; break;
                        case 27: patterns.Q27_familyStress = stressResponse; break;
                        case 28: patterns.Q28_emergencyStress = stressResponse; break;
                        case 29: patterns.Q29_competitionStress = stressResponse; break;
                        case 30: patterns.Q30_collaborationStress = stressResponse; break;
                        case 31: patterns.Q31_socialStress = stressResponse; break;
                        case 32: patterns.Q32_failureStress = stressResponse; break;
                        case 33: patterns.Q33_changeStress = stressResponse; break;
                        case 34: patterns.Q34_isolationStress = stressResponse; break;
                        case 35: patterns.Q35_performanceStress = stressResponse; break;
                        case 36: patterns.Q36_resourceStress = stressResponse; break;
                    }
                });
                
                return patterns;
            }

            analyzeStressResponse(answer, questionNum) {
                // 回答から防御的パターンを数値化
                const responseIntensity = this.calculateResponseIntensity(answer);
                const defensiveType = this.identifyDefensiveType(answer, questionNum);
                
                return {
                    intensity: responseIntensity,
                    type: defensiveType,
                    pattern: this.mapToDefensivePattern(defensiveType)
                };
            }

            calculateResponseIntensity(answer) {
                // 回答の強度を0-1で測定
                if (!answer || !answer.text) return 0.5;
                
                const text = answer.text.toLowerCase();
                const intensityKeywords = {
                    high: ['絶対', '必ず', '完全', '徹底', '断固', '断然', '即座', '緊急'],
                    medium: ['できるだけ', 'なるべく', '努力', '検討', '相談', '調整'],
                    low: ['様子見', '保留', '延期', '回避', '無視', '放置']
                };
                
                let score = 0.5; // baseline
                
                intensityKeywords.high.forEach(keyword => {
                    if (text.includes(keyword)) score += 0.15;
                });
                intensityKeywords.medium.forEach(keyword => {
                    if (text.includes(keyword)) score += 0.05;
                });
                intensityKeywords.low.forEach(keyword => {
                    if (text.includes(keyword)) score -= 0.1;
                });
                
                return Math.max(0, Math.min(1, score));
            }

            identifyDefensiveType(answer, questionNum) {
                if (!answer || !answer.text) return 'neutral';
                
                const text = answer.text.toLowerCase();
                
                // 防御タイプキーワード分析
                const defensiveKeywords = {
                    retreat: ['撤退', '距離', '避ける', '離れる', '退く', '逃げ'],
                    confront: ['対抗', '立ち向かう', '戦う', '挑戦', '反撃', '抵抗'],
                    avoid: ['回避', '巧み', '迂回', '別の道', '柔軟', '適応'],
                    endure: ['耐える', '我慢', '忍ぶ', '持久', '継続', '堅持'],
                    transform: ['変化', '適応', '変容', '調整', '修正', '進化'],
                    boundary: ['境界', '線引き', '制限', '区別', '分離', '防壁'],
                    harmonize: ['調和', '同化', '溶け込む', '協調', '合わせる', '融合'],
                    fortify: ['強化', '固める', '守る', '防御', '安定', '堅固']
                };
                
                let maxScore = 0;
                let dominantType = 'neutral';
                
                Object.entries(defensiveKeywords).forEach(([type, keywords]) => {
                    let score = 0;
                    keywords.forEach(keyword => {
                        if (text.includes(keyword)) score++;
                    });
                    if (score > maxScore) {
                        maxScore = score;
                        dominantType = type;
                    }
                });
                
                return dominantType;
            }

            mapToDefensivePattern(defensiveType) {
                const patternMap = {
                    retreat: '撤退',     // 坤・艮
                    confront: '対抗',    // 乾・震
                    avoid: '回避',       // 巽・兌
                    endure: '耐忍',      // 坎・艮
                    transform: '変容',   // 離・巽
                    boundary: '結界',    // 艮・坤
                    harmonize: '同化',   // 坤・巽
                    fortify: '硬化',     // 乾・艮
                    neutral: '中立'
                };
                
                return patternMap[defensiveType] || '中立';
            }

            buildStressResponseVector(defensivePatterns) {
                // 防御的8次元ベクトル構築
                const vector = {
                    防御_撤退性: 0,    // 坤 - 受動的撤退
                    防御_対抗性: 0,    // 乾 - 積極的対抗
                    防御_回避性: 0,    // 巽 - 柔軟な回避
                    防御_持久性: 0,    // 坎 - 忍耐と持久
                    防御_変容性: 0,    // 離 - 変化と適応
                    防御_境界性: 0,    // 艮 - 境界設定
                    防御_調和性: 0,    // 兌 - 調和的解決
                    防御_堅固性: 0     // 震 - 瞬発的防御
                };
                
                // 各ストレス反応を対応する防御次元にマッピング
                Object.entries(defensivePatterns).forEach(([stressType, response]) => {
                    const intensity = response.intensity || 0;
                    const pattern = response.pattern || '中立';
                    
                    switch(pattern) {
                        case '撤退':
                            vector.防御_撤退性 += intensity * 0.8;
                            vector.防御_調和性 += intensity * 0.3;
                            break;
                        case '対抗':
                            vector.防御_対抗性 += intensity * 0.8;
                            vector.防御_堅固性 += intensity * 0.4;
                            break;
                        case '回避':
                            vector.防御_回避性 += intensity * 0.8;
                            vector.防御_変容性 += intensity * 0.3;
                            break;
                        case '耐忍':
                            vector.防御_持久性 += intensity * 0.8;
                            vector.防御_境界性 += intensity * 0.4;
                            break;
                        case '変容':
                            vector.防御_変容性 += intensity * 0.8;
                            vector.防御_回避性 += intensity * 0.3;
                            break;
                        case '結界':
                            vector.防御_境界性 += intensity * 0.8;
                            vector.防御_持久性 += intensity * 0.3;
                            break;
                        case '同化':
                            vector.防御_調和性 += intensity * 0.8;
                            vector.防御_撤退性 += intensity * 0.3;
                            break;
                        case '硬化':
                            vector.防御_堅固性 += intensity * 0.8;
                            vector.防御_対抗性 += intensity * 0.3;
                            break;
                    }
                });
                
                // 正規化
                const maxValue = Math.max(...Object.values(vector));
                if (maxValue > 0) {
                    Object.keys(vector).forEach(key => {
                        vector[key] = vector[key] / maxValue;
                    });
                }
                
                return vector;
            }

            calculateDefensiveBaguaEnergies(stressVector) {
                // Safe Mode OS → 八卦マッピング行列（Phase 2: 次元統一）
                const SAFEMODE_TO_BAGUA = {
                    "防御_対抗性": { "乾": 0.7, "震": 0.3 },
                    "防御_調和性": { "兌": 0.8, "巽": 0.2 },
                    "防御_変容性": { "離": 0.7, "坎": 0.3 },
                    "防御_堅固性": { "震": 0.6, "艮": 0.4 },
                    "防御_回避性": { "巽": 0.8, "坤": 0.2 },
                    "防御_持久性": { "坎": 0.8, "艮": 0.2 },
                    "防御_境界性": { "艮": 0.9, "乾": 0.1 },
                    "防御_撤退性": { "坤": 0.8, "巽": 0.2 }
                };
                
                // 八卦エネルギー初期化
                const baguaEnergies = {
                    "乾": 0, "兌": 0, "離": 0, "震": 0,
                    "巽": 0, "坎": 0, "艮": 0, "坤": 0
                };
                
                // マッピング行列を適用
                Object.entries(stressVector).forEach(([dimension, value]) => {
                    const mapping = SAFEMODE_TO_BAGUA[dimension];
                    if (mapping) {
                        Object.entries(mapping).forEach(([bagua, weight]) => {
                            baguaEnergies[bagua] += value * weight;
                        });
                    }
                });
                
                return baguaEnergies;
            }

            adjustForCorePersonality(defensiveEnergies, engineOS) {
                // Engine OSの基礎人格が防御パターンに40%の影響を与える
                const coreInfluence = 0.4;
                const defensiveBase = 0.6;
                
                if (!engineOS || !engineOS.baguaEnergies) return defensiveEnergies;
                
                const adjusted = {};
                Object.keys(defensiveEnergies).forEach(trigram => {
                    const coreEnergy = engineOS.baguaEnergies[trigram] || 0;
                    const defensiveEnergy = defensiveEnergies[trigram] || 0;
                    
                    adjusted[trigram] = (defensiveEnergy * defensiveBase) + (coreEnergy * coreInfluence);
                });
                
                return adjusted;
            }

            selectDefensiveBagua(energies) {
                // エネルギー値でソートして上位2つの八卦を選択
                const sorted = Object.entries(energies)
                    .sort(([,a], [,b]) => b - a);
                
                return [sorted[0][0], sorted[1][0]];
            }

            generateSafeModeInterpretation(hexagramId, primaryDefense, secondaryDefense, patterns, engineOS) {
                // SafeMode OS専用の64卦解釈
                const defensiveInterpretations = this.getSafeModeHexagramInterpretations();
                const interpretation = defensiveInterpretations[hexagramId] || this.getDefaultDefensiveInterpretation();
                
                // パーソナライズされた解釈を生成
                const personalizedDescription = this.personalizeSafeModeDescription(
                    interpretation, primaryDefense, secondaryDefense, patterns, engineOS
                );
                
                return {
                    description: personalizedDescription,
                    catchphrase: interpretation.catchphrase || "困難に立ち向かう防御システム",
                    defensiveType: interpretation.primaryDefense || "総合防御",
                    stressResponse: interpretation.stressResponse || "状況適応型対応",
                    activationTrigger: this.identifyActivationTrigger(patterns)
                };
            }

            getSafeModeHexagramInterpretations() {
                return {
                    1: { // 乾為天
                        name: "天雷無窮型防御",
                        catchphrase: "困難を力で突破する",
                        primaryDefense: "積極的対抗",
                        stressResponse: "正面突破による解決"
                    },
                    2: { // 坤為地
                        name: "大地包容型防御",
                        catchphrase: "全てを受け入れ包み込む",
                        primaryDefense: "受容・同化",
                        stressResponse: "環境への完全適応"
                    },
                    29: { // 坎為水
                        name: "深淵流水型防御",
                        catchphrase: "困難を流れるように通過する",
                        primaryDefense: "浸透・持続",
                        stressResponse: "障害の本質を理解し迂回"
                    },
                    52: { // 艮為山
                        name: "不動要塞型防御",
                        catchphrase: "絶対的な境界を設定する",
                        primaryDefense: "静止・境界",
                        stressResponse: "完全な防御体制構築"
                    },
                    58: { // 兌為沢
                        name: "調和交流型防御",
                        catchphrase: "対話で危機を乗り越える",
                        primaryDefense: "協調・交渉",
                        stressResponse: "関係性による問題解決"
                    },
                    30: { // 離為火
                        name: "明照変容型防御",
                        catchphrase: "状況を見極め変化する",
                        primaryDefense: "洞察・適応",
                        stressResponse: "状況分析による最適化"
                    },
                    51: { // 震為雷
                        name: "電光石火型防御",
                        catchphrase: "瞬時に行動し危機を脱する",
                        primaryDefense: "瞬発・決断",
                        stressResponse: "迅速な状況打開"
                    },
                    57: { // 巽為風
                        name: "順風柔軟型防御",
                        catchphrase: "柔軟性で困難を回避する",
                        primaryDefense: "柔軟・回避",
                        stressResponse: "状況に応じた柔軟対応"
                    },
                    // 他の卦の解釈も同様に...
                    16: { // 雷地予
                        name: "準備充実型防御",
                        catchphrase: "事前準備で危機を防ぐ",
                        primaryDefense: "予防・準備",
                        stressResponse: "先読みによる危機回避"
                    },
                    39: { // 水山蹇
                        name: "困難突破型防御",
                        catchphrase: "困難の中でも前進する",
                        primaryDefense: "忍耐・持続",
                        stressResponse: "困難を乗り越える粘り強さ"
                    },
                    3: { // 水雷屯
                        name: "初期混乱対応型防御",
                        catchphrase: "混乱の中で秩序を見つける",
                        primaryDefense: "忍耐・整理",
                        stressResponse: "混乱状況の段階的整理"
                    },
                    4: { // 山水蒙
                        name: "学習適応型防御",
                        catchphrase: "無知を認めて学ぶことで守る",
                        primaryDefense: "学習・境界",
                        stressResponse: "知識不足の謙虚な補完"
                    },
                    5: { // 水天需
                        name: "機会待機型防御",
                        catchphrase: "適切なタイミングを待つ",
                        primaryDefense: "待機・持続",
                        stressResponse: "焦らず機会を待つ持久戦"
                    },
                    6: { // 天水訟
                        name: "正当防衛型防御",
                        catchphrase: "正義を主張して立ち向かう",
                        primaryDefense: "正当性・対抗",
                        stressResponse: "正当な権利の主張と防衛"
                    },
                    7: { // 地水師
                        name: "組織戦略型防御",
                        catchphrase: "組織力で困難に対処する",
                        primaryDefense: "統率・持続",
                        stressResponse: "組織的な問題解決"
                    },
                    8: { // 水地比
                        name: "協調連帯型防御",
                        catchphrase: "仲間と結束して守る",
                        primaryDefense: "協調・受容",
                        stressResponse: "相互支援による危機対応"
                    },
                    9: { // 風天小畜
                        name: "小規模蓄積型防御",
                        catchphrase: "小さな準備で大きな危機に備える",
                        primaryDefense: "準備・柔軟",
                        stressResponse: "段階的な準備と適応"
                    },
                    10: { // 天沢履
                        name: "慎重歩行型防御",
                        catchphrase: "危険を承知で慎重に進む",
                        primaryDefense: "慎重・対抗",
                        stressResponse: "リスク認識と慎重な行動"
                    },
                    11: { // 地天泰
                        name: "調和安定型防御",
                        catchphrase: "平和と調和を維持する",
                        primaryDefense: "安定・受容",
                        stressResponse: "バランスの取れた対応"
                    },
                    12: { // 天地否
                        name: "閉塞突破型防御",
                        catchphrase: "閉塞状況を打破する",
                        primaryDefense: "突破・対抗",
                        stressResponse: "現状打破による活路開拓"
                    },
                    13: { // 天火同人
                        name: "同志結集型防御",
                        catchphrase: "志を同じくする人と結束する",
                        primaryDefense: "結束・洞察",
                        stressResponse: "理念による団結と対応"
                    },
                    14: { // 火天大有
                        name: "豊富資源型防御",
                        catchphrase: "豊富な資源で危機を乗り越える",
                        primaryDefense: "豊穣・洞察",
                        stressResponse: "資源を活用した包括的対応"
                    },
                    15: { // 地山謙
                        name: "謙遜回避型防御",
                        catchphrase: "謙遜することで危機を避ける",
                        primaryDefense: "謙虚・境界",
                        stressResponse: "低姿勢による摩擦回避"
                    },
                    17: { // 沢雷随
                        name: "柔軟追従型防御",
                        catchphrase: "状況に従って柔軟に対応する",
                        primaryDefense: "追従・調和",
                        stressResponse: "環境変化への柔軟な適応"
                    },
                    18: { // 山風蠱
                        name: "問題修復型防御",
                        catchphrase: "腐敗を正して健全化する",
                        primaryDefense: "修復・境界",
                        stressResponse: "根本的な問題解決"
                    },
                    19: { // 地沢臨
                        name: "接近監視型防御",
                        catchphrase: "近づいて問題を監視する",
                        primaryDefense: "接近・調和",
                        stressResponse: "積極的な関与による解決"
                    },
                    20: { // 風地観
                        name: "観察洞察型防御",
                        catchphrase: "高い視点から状況を俯瞰する",
                        primaryDefense: "観察・柔軟",
                        stressResponse: "客観的分析による対策立案"
                    },
                    21: { // 火雷噬嗑
                        name: "障害除去型防御",
                        catchphrase: "障害を噛み砕いて除去する",
                        primaryDefense: "除去・洞察",
                        stressResponse: "問題の核心への直接的対処"
                    },
                    22: { // 山火賁
                        name: "装飾隠蔽型防御",
                        catchphrase: "美しく装って本質を隠す",
                        primaryDefense: "装飾・境界",
                        stressResponse: "外見を整えた防御戦略"
                    },
                    23: { // 山地剥
                        name: "剥離最小化型防御",
                        catchphrase: "失うものを最小限に抑える",
                        primaryDefense: "保全・境界",
                        stressResponse: "損失最小化戦略"
                    },
                    24: { // 地雷復
                        name: "復元回復型防御",
                        catchphrase: "元の状態に戻すことで安定を図る",
                        primaryDefense: "復元・受容",
                        stressResponse: "原点回帰による安定化"
                    },
                    25: { // 天雷无妄
                        name: "純真無垢型防御",
                        catchphrase: "純粋な心で災いを避ける",
                        primaryDefense: "純真・対抗",
                        stressResponse: "誠実さによる自然な解決"
                    },
                    26: { // 山天大畜
                        name: "大規模蓄積型防御",
                        catchphrase: "大きな力を蓄えて危機に備える",
                        primaryDefense: "蓄積・境界",
                        stressResponse: "長期的な準備による万全な対応"
                    },
                    27: { // 山雷頤
                        name: "栄養補給型防御",
                        catchphrase: "適切な栄養で体力を維持する",
                        primaryDefense: "養育・境界",
                        stressResponse: "基礎体力の維持と強化"
                    },
                    28: { // 沢風大過
                        name: "過大負荷耐久型防御",
                        catchphrase: "限界を超えた負荷に耐える",
                        primaryDefense: "耐久・調和",
                        stressResponse: "極限状況での持久戦"
                    },
                    31: { // 沢山咸
                        name: "感応共鳴型防御",
                        catchphrase: "相手と感応して調和する",
                        primaryDefense: "感応・調和",
                        stressResponse: "相互理解による問題解決"
                    },
                    32: { // 雷風恒
                        name: "持続継続型防御",
                        catchphrase: "変わらぬ姿勢で持続する",
                        primaryDefense: "持続・柔軟",
                        stressResponse: "一貫した方針による安定対応"
                    },
                    33: { // 天山遯
                        name: "戦略的撤退型防御",
                        catchphrase: "適切なタイミングで退く",
                        primaryDefense: "撤退・対抗",
                        stressResponse: "戦略的な後退による立て直し"
                    },
                    34: { // 雷天大壮
                        name: "強大力量型防御",
                        catchphrase: "強大な力で正面突破する",
                        primaryDefense: "強力・対抗",
                        stressResponse: "圧倒的な力による問題解決"
                    },
                    35: { // 火地晋
                        name: "前進発展型防御",
                        catchphrase: "前進することで危機を脱する",
                        primaryDefense: "前進・洞察",
                        stressResponse: "積極的な攻勢による局面打開"
                    },
                    36: { // 地火明夷
                        name: "潜伏隠遁型防御",
                        catchphrase: "光を隠して危険をやり過ごす",
                        primaryDefense: "隠遁・受容",
                        stressResponse: "目立たないことによる安全確保"
                    },
                    37: { // 風火家人
                        name: "家族結束型防御",
                        catchphrase: "家族の絆で危機を乗り越える",
                        primaryDefense: "結束・柔軟",
                        stressResponse: "身内との強固な連帯"
                    },
                    38: { // 火沢睽
                        name: "対立調和型防御",
                        catchphrase: "対立しながらも調和を保つ",
                        primaryDefense: "調和・洞察",
                        stressResponse: "違いを認めた上での協力"
                    },
                    40: { // 雷水解
                        name: "解放開放型防御",
                        catchphrase: "束縛を解いて自由を取り戻す",
                        primaryDefense: "解放・迅速",
                        stressResponse: "制約からの脱却による問題解決"
                    },
                    41: { // 山沢損
                        name: "適切削減型防御",
                        catchphrase: "無駄を削ってスリム化する",
                        primaryDefense: "削減・境界",
                        stressResponse: "効率化による体質強化"
                    },
                    42: { // 風雷益
                        name: "相互利益型防御",
                        catchphrase: "みんなの利益で問題を解決する",
                        primaryDefense: "利益・柔軟",
                        stressResponse: "win-winの関係構築"
                    },
                    43: { // 沢天夬
                        name: "決断実行型防御",
                        catchphrase: "断固とした決断で危機を断つ",
                        primaryDefense: "決断・調和",
                        stressResponse: "明確な判断による迅速な対処"
                    },
                    44: { // 天風姤
                        name: "偶然遭遇型防御",
                        catchphrase: "予期せぬ出会いを活用する",
                        primaryDefense: "機会・対抗",
                        stressResponse: "偶然の機会を最大限活用"
                    },
                    45: { // 沢地萃
                        name: "集結統合型防御",
                        catchphrase: "みんなで集まって力を合わせる",
                        primaryDefense: "統合・調和",
                        stressResponse: "集団の力による問題解決"
                    },
                    46: { // 地風升
                        name: "段階成長型防御",
                        catchphrase: "段階を追って成長し強化する",
                        primaryDefense: "成長・受容",
                        stressResponse: "継続的な改善による体質強化"
                    },
                    47: { // 沢水困
                        name: "困窮忍耐型防御",
                        catchphrase: "困った時こそ耐え忍ぶ",
                        primaryDefense: "忍耐・調和",
                        stressResponse: "苦境での精神力による持久戦"
                    },
                    48: { // 水風井
                        name: "安定供給型防御",
                        catchphrase: "変わらぬ価値を提供し続ける",
                        primaryDefense: "安定・持続",
                        stressResponse: "信頼できる基盤の維持"
                    },
                    49: { // 沢火革
                        name: "変革刷新型防御",
                        catchphrase: "根本から変えて新しくする",
                        primaryDefense: "変革・調和",
                        stressResponse: "抜本的な改革による問題解決"
                    },
                    50: { // 火風鼎
                        name: "安定統治型防御",
                        catchphrase: "新しい秩序で安定を図る",
                        primaryDefense: "統治・洞察",
                        stressResponse: "新体制による安定化"
                    },
                    53: { // 風山漸
                        name: "漸進発展型防御",
                        catchphrase: "少しずつ着実に進歩する",
                        primaryDefense: "漸進・柔軟",
                        stressResponse: "段階的な改善による安定成長"
                    },
                    54: { // 雷沢帰妹
                        name: "適応順応型防御",
                        catchphrase: "与えられた役割に順応する",
                        primaryDefense: "順応・迅速",
                        stressResponse: "環境に合わせた柔軟な適応"
                    },
                    55: { // 雷火豊
                        name: "豊穣充実型防御",
                        catchphrase: "豊かさの中でバランスを保つ",
                        primaryDefense: "豊穣・迅速",
                        stressResponse: "余裕のある状況での適切な判断"
                    },
                    56: { // 火山旅
                        name: "旅行適応型防御",
                        catchphrase: "慣れない環境に適応する",
                        primaryDefense: "適応・洞察",
                        stressResponse: "変化への柔軟な対応"
                    },
                    59: { // 風水渙
                        name: "分散緩和型防御",
                        catchphrase: "固まったものを分散して和らげる",
                        primaryDefense: "分散・柔軟",
                        stressResponse: "緊張の緩和による問題解決"
                    },
                    60: { // 水沢節
                        name: "節制限定型防御",
                        catchphrase: "適切な節度で安定を保つ",
                        primaryDefense: "節制・持続",
                        stressResponse: "バランスの取れた制限による安定"
                    },
                    61: { // 風沢中孚
                        name: "誠実信頼型防御",
                        catchphrase: "誠実さで信頼を築き守る",
                        primaryDefense: "誠実・柔軟",
                        stressResponse: "信頼関係による問題解決"
                    },
                    62: { // 雷山小過
                        name: "小規模超越型防御",
                        catchphrase: "小さな努力で大きな効果を得る",
                        primaryDefense: "効率・迅速",
                        stressResponse: "小さな工夫による効果的対応"
                    },
                    63: { // 水火既済
                        name: "完成維持型防御",
                        catchphrase: "完成した状態を維持する",
                        primaryDefense: "維持・持続",
                        stressResponse: "現状維持による安定確保"
                    },
                    64: { // 火水未済
                        name: "未完成発展型防御",
                        catchphrase: "未完成だからこそ可能性がある",
                        primaryDefense: "発展・洞察",
                        stressResponse: "改善の余地を活用した成長"
                    }
                };
            }

            getDefaultDefensiveInterpretation() {
                return {
                    name: "総合適応型防御",
                    catchphrase: "状況に応じて最適な防御を選択する",
                    primaryDefense: "適応・調整",
                    stressResponse: "バランス型危機対応"
                };
            }

            personalizeSafeModeDescription(interpretation, primary, secondary, patterns, engineOS) {
                const stressLevel = this.calculateOverallStressLevel(patterns);
                const primaryStrength = this.getTrigramStrength(primary, patterns);
                const secondaryStrength = this.getTrigramStrength(secondary, patterns);
                
                let description = `${interpretation.name}: ${interpretation.primaryDefense}を主軸とした防御システム。`;
                
                if (stressLevel > 0.7) {
                    description += "高ストレス環境下で強力に発動し、";
                } else if (stressLevel > 0.4) {
                    description += "中程度のストレス状況で適切に作動し、";
                } else {
                    description += "軽微なストレス状況でも予防的に機能し、";
                }
                
                description += `${primary}の${this.getTrigramDefensiveCharacter(primary)}と${secondary}の${this.getTrigramDefensiveCharacter(secondary)}を組み合わせて対応する。`;
                
                return description;
            }

            getTrigramDefensiveCharacter(trigram) {
                const characters = {
                    乾: "強力な対抗力",
                    兌: "調和的解決力",
                    離: "状況洞察力",
                    震: "迅速な行動力",
                    巽: "柔軟な適応力",
                    坎: "持続的忍耐力",
                    艮: "堅固な境界力",
                    坤: "包容的受容力"
                };
                return characters[trigram] || "総合的防御力";
            }

            identifyActivationTrigger(patterns) {
                const triggers = [];
                
                Object.entries(patterns).forEach(([type, response]) => {
                    if (response.intensity > 0.6) {
                        switch(type) {
                            case 'leadershipStress': triggers.push('責任の重圧'); break;
                            case 'interpersonalStress': triggers.push('人間関係の摩擦'); break;
                            case 'familyStress': triggers.push('親密関係の負荷'); break;
                            case 'emergencyStress': triggers.push('緊急事態'); break;
                            case 'competitionStress': triggers.push('競争環境'); break;
                            case 'collaborationStress': triggers.push('協調の負担'); break;
                        }
                    }
                });
                
                return triggers.length > 0 ? triggers.join('、') : '一般的なストレス状況';
            }

            calculateDefensiveStrength(patterns) {
                const intensities = Object.values(patterns).map(p => p.intensity || 0);
                if (intensities.length === 0) return 0;
                return intensities.reduce((sum, intensity) => sum + intensity, 0) / intensities.length;
            }

            calculateOverallStressLevel(patterns) {
                return this.calculateDefensiveStrength(patterns);
            }

            getTrigramStrength(trigram, patterns) {
                // 八卦の防御パターンでの強度を計算
                const trigramPatternMap = {
                    乾: ['対抗', '硬化'],
                    兌: ['調和', '回避'],
                    離: ['変容', '対抗'],
                    震: ['硬化', '対抗'],
                    巽: ['回避', '変容'],
                    坎: ['耐忍', '結界'],
                    艮: ['結界', '撤退'],
                    坤: ['撤退', '同化']
                };
                
                const relevantPatterns = trigramPatternMap[trigram] || [];
                let strength = 0;
                let count = 0;
                
                Object.values(patterns).forEach(response => {
                    if (relevantPatterns.includes(response.pattern)) {
                        strength += response.intensity;
                        count++;
                    }
                });
                
                return count > 0 ? strength / count : 0.5;
            }

            getDefaultSafeModeOS() {
                return {
                    hexagramId: 39, // 水山蹇 - 困難を乗り越える
                    hexagramName: "水山蹇",
                    description: "困難な状況でも粘り強く前進する防御システム",
                    catchphrase: "困難を乗り越える不屈の精神",
                    primaryDefense: "坎",
                    secondaryDefense: "艮",
                    defensiveType: "困難突破型",
                    stressResponse: "忍耐と境界設定による持久戦",
                    activationTrigger: "困難な状況全般",
                    defensiveStrength: 0.6,
                    baguaEnergies: { 乾: 0.3, 兌: 0.2, 離: 0.2, 震: 0.3, 巽: 0.2, 坎: 0.7, 艮: 0.6, 坤: 0.4 },
                    type: "Safe Mode OS"
                };
            }

            /**
             * Interface OS分析の補助メソッド群
             */
             
            // 1. シナリオ質問（Q13-Q24）から社会的パターンを分析
            analyzeSocialPatterns(scenarioAnswers) {
                const patterns = {
                    Q13_leadership: 0,      // リーダーシップ状況対応
                    Q14_interpersonal: 0,   // 対人関係困難への対処
                    Q15_family: 0,          // 家族・親密関係の処理
                    Q16_emergency: 0,       // 緊急事態・危機管理
                    Q17_competition: 0,     // 競争・争いへの対応
                    Q18_community: 0,       // 共同体・協力関係構築
                    Q19_social: 0,          // 社会的状況への対応
                    Q20_conflict: 0,        // 対立・衝突の処理
                    Q21_trust: 0,           // 信頼関係の構築
                    Q22_expression: 0,      // 自己表現・主張
                    Q23_cooperation: 0,     // 協力・協調姿勢
                    Q24_adaptation: 0       // 環境適応・柔軟性
                };
                
                // シナリオ回答から社会的パターンスコア計算
                scenarioAnswers.forEach((answer, index) => {
                    const questionId = `Q${13 + index}`;
                    // answerがオブジェクトの場合はselectedOption.valueを取得
                    const answerValue = answer.selectedOption ? answer.selectedOption.value : answer;
                    const scoreValue = this.calculateScenarioScore(answerValue, questionId);
                    
                    switch (questionId) {
                        case 'Q13': patterns.Q13_leadership = scoreValue; break;
                        case 'Q14': patterns.Q14_interpersonal = scoreValue; break;
                        case 'Q15': patterns.Q15_family = scoreValue; break;
                        case 'Q16': patterns.Q16_emergency = scoreValue; break;
                        case 'Q17': patterns.Q17_competition = scoreValue; break;
                        case 'Q18': patterns.Q18_community = scoreValue; break;
                        case 'Q19': patterns.Q19_social = scoreValue; break;
                        case 'Q20': patterns.Q20_conflict = scoreValue; break;
                        case 'Q21': patterns.Q21_trust = scoreValue; break;
                        case 'Q22': patterns.Q22_expression = scoreValue; break;
                        case 'Q23': patterns.Q23_cooperation = scoreValue; break;
                        case 'Q24': patterns.Q24_adaptation = scoreValue; break;
                    }
                });
                
                return patterns;
            }
            
            // 2. Interface OS専用の8次元ベクトル構築
            buildInterfaceVector(socialPatterns) {
                const vector = {
                    "外向_主導性": 0,    // 乾 - リーダーシップ・主導
                    "外向_調和性": 0,    // 兌 - 社交・コミュニケーション
                    "外向_表現性": 0,    // 離 - プレゼンテーション・魅力
                    "外向_行動性": 0,    // 震 - 即応性・アクション
                    "内向_適応性": 0,    // 巽 - 順応・協調
                    "内向_分析性": 0,    // 坎 - 観察・洞察
                    "内向_安定性": 0,    // 艮 - 一貫性・信頼性
                    "内向_支援性": 0     // 坤 - サポート・貢献
                };
                
                // Q13-Q24の社会的パターンを8次元にマッピング（改善された重み付け）
                // 各パターンの寄与度を増加させて0%問題を解決
                vector["外向_主導性"] = (socialPatterns.Q13_leadership * 0.8) + (socialPatterns.Q16_emergency * 0.5) + (socialPatterns.Q22_expression * 0.3);
                vector["外向_調和性"] = (socialPatterns.Q14_interpersonal * 0.7) + (socialPatterns.Q18_community * 0.6) + (socialPatterns.Q21_trust * 0.4);
                vector["外向_表現性"] = (socialPatterns.Q13_leadership * 0.5) + (socialPatterns.Q14_interpersonal * 0.5) + (socialPatterns.Q22_expression * 0.6);
                vector["外向_行動性"] = (socialPatterns.Q16_emergency * 0.7) + (socialPatterns.Q17_competition * 0.6) + (socialPatterns.Q20_conflict * 0.3);
                
                vector["内向_適応性"] = (socialPatterns.Q14_interpersonal * 0.5) + (socialPatterns.Q15_family * 0.7) + (socialPatterns.Q24_adaptation * 0.8);
                vector["内向_分析性"] = (socialPatterns.Q16_emergency * 0.5) + (socialPatterns.Q17_competition * 0.5) + (socialPatterns.Q19_social * 0.4);
                vector["内向_安定性"] = (socialPatterns.Q15_family * 0.7) + (socialPatterns.Q18_community * 0.5) + (socialPatterns.Q23_cooperation * 0.4);
                vector["内向_支援性"] = (socialPatterns.Q15_family * 0.5) + (socialPatterns.Q18_community * 0.5) + (socialPatterns.Q23_cooperation * 0.6);
                
                // 最小値保証（15%以上）を追加して0%を防ぐ
                Object.keys(vector).forEach(key => {
                    vector[key] = Math.max(0.15, Math.min(1, vector[key]));
                });
                
                return vector;
            }
            
            // 3. 社会的八卦エネルギー計算（Phase 2: 次元統一マッピング）
            calculateSocialBaguaEnergies(interfaceVector) {
                // Interface OS → 八卦マッピング行列
                const INTERFACE_TO_BAGUA = {
                    "外向_主導性": { "乾": 0.8, "震": 0.2 },
                    "外向_調和性": { "兌": 0.9, "離": 0.1 },
                    "外向_表現性": { "離": 0.8, "兌": 0.2 },
                    "外向_行動性": { "震": 0.9, "乾": 0.1 },
                    "内向_適応性": { "巽": 0.9, "坤": 0.1 },
                    "内向_分析性": { "坎": 0.9, "艮": 0.1 },
                    "内向_安定性": { "艮": 0.9, "坤": 0.1 },
                    "内向_支援性": { "坤": 0.9, "巽": 0.1 }
                };
                
                // 八卦エネルギー初期化
                const baguaEnergies = {
                    "乾": 0, "兌": 0, "離": 0, "震": 0,
                    "巽": 0, "坎": 0, "艮": 0, "坤": 0
                };
                
                // マッピング行列を適用
                Object.entries(interfaceVector).forEach(([dimension, value]) => {
                    const mapping = INTERFACE_TO_BAGUA[dimension];
                    if (mapping) {
                        Object.entries(mapping).forEach(([bagua, weight]) => {
                            baguaEnergies[bagua] += value * weight;
                        });
                    }
                });
                
                return baguaEnergies;
            }
            
            // 4. Engine OSとの相互作用補正
            adjustForEngineOS(socialEnergies, engineOS) {
                const adjustedEnergies = { ...socialEnergies };
                const engineInfluence = 0.25; // 25%の影響度
                
                if (!engineOS || !engineOS.upperBagua || !engineOS.lowerBagua) {
                    return adjustedEnergies;
                }
                
                // Engine OSの主要八卦が社会的表現に与える影響
                const enginePrimary = engineOS.upperBagua;
                
                // 内向的Engine OSは外向的Interface OSを抑制
                if (["坤", "艮", "坎", "巽"].includes(enginePrimary)) {
                    adjustedEnergies["乾"] *= (1 - engineInfluence * 0.8);
                    adjustedEnergies["離"] *= (1 - engineInfluence * 0.6);
                    adjustedEnergies["震"] *= (1 - engineInfluence * 0.7);
                    adjustedEnergies["兌"] *= (1 - engineInfluence * 0.4);
                }
                
                // 外向的Engine OSは外向的Interface OSを強化
                if (["乾", "兌", "離", "震"].includes(enginePrimary)) {
                    adjustedEnergies["乾"] *= (1 + engineInfluence * 0.6);
                    adjustedEnergies["離"] *= (1 + engineInfluence * 0.5);
                    adjustedEnergies["震"] *= (1 + engineInfluence * 0.5);
                    adjustedEnergies["兌"] *= (1 + engineInfluence * 0.7);
                }
                
                // 特定のEngine OS組み合わせ補正
                if (enginePrimary === "坤") { // 受容的Engine OS
                    adjustedEnergies["坤"] *= (1 + engineInfluence * 1.2);
                    adjustedEnergies["巽"] *= (1 + engineInfluence * 0.8);
                }
                
                if (enginePrimary === "乾") { // 創造的Engine OS
                    adjustedEnergies["乾"] *= (1 + engineInfluence * 1.0);
                    adjustedEnergies["震"] *= (1 + engineInfluence * 0.7);
                }
                
                return adjustedEnergies;
            }
            
            // 5. Interface OS用の最適八卦選択
            selectInterfaceBagua(adjustedEnergies) {
                // 社会的表現では外卦（上卦）を重視
                const sortedBagua = Object.entries(adjustedEnergies)
                    .sort(([, a], [, b]) => b - a);
                
                const upperBagua = sortedBagua[0][0];
                const lowerBagua = sortedBagua[1][0];
                
                // 社会的相互作用の妥当性チェック
                if (this.isValidSocialCombination(upperBagua, lowerBagua)) {
                    return { upperBagua, lowerBagua };
                } else {
                    // 無効な組み合わせの場合、調整
                    return this.adjustSocialCombination(sortedBagua);
                }
            }
            
            // 6. Interface OS専用解釈生成
            generateInterfaceInterpretation(hexagramId, upperBagua, lowerBagua, socialPatterns, engineOS) {
                const baseInterpretation = this.getInterfaceHexagramInterpretation(hexagramId);
                
                return {
                    description: baseInterpretation.description,
                    leadership: this.analyzeLeadershipStyle(upperBagua, socialPatterns),
                    communication: this.analyzeCommunicationStyle(upperBagua, lowerBagua, socialPatterns),
                    conflictResolution: this.analyzeConflictStyle(lowerBagua, socialPatterns),
                    adaptability: this.analyzeAdaptability(upperBagua, lowerBagua, socialPatterns),
                    engineOSInfluence: this.analyzeEngineInfluence(engineOS, upperBagua, lowerBagua)
                };
            }
            
            // 7. 社会的スタイル判定
            determineSocialStyle(socialPatterns) {
                const leadership = socialPatterns.Q13_leadership || 0;
                const interpersonal = socialPatterns.Q14_interpersonal || 0;
                const community = socialPatterns.Q18_community || 0;
                
                if (leadership > 0.7) return "主導型リーダー";
                if (community > 0.7) return "協調型ファシリテーター";
                if (interpersonal > 0.7) return "対人関係重視型";
                if (leadership > 0.5 && community > 0.5) return "バランス型リーダー";
                return "適応型サポーター";
            }
            
            // 8. デフォルトInterface OS
            getDefaultInterfaceOS() {
                return {
                    hexagramId: 11,
                    hexagramName: "地天泰",
                    upperBagua: "坤",
                    lowerBagua: "乾", 
                    socialPatterns: { Q13_leadership: 0.5, Q14_interpersonal: 0.5, Q15_family: 0.5, Q16_emergency: 0.5, Q17_competition: 0.5, Q18_community: 0.5, Q19_social: 0.5, Q20_conflict: 0.5, Q21_trust: 0.5, Q22_expression: 0.5, Q23_cooperation: 0.5, Q24_adaptation: 0.5 },
                    interfaceVector: {},
                    socialStyle: "バランス型",
                    description: "調和とバランスを重視するデフォルト社会的人格",
                    leadership: "包容的リーダーシップ",
                    communication: "双方向コミュニケーション",
                    conflictResolution: "仲介・調停型",
                    adaptability: "高い適応力",
                    engineOSInfluence: "安定した相互作用",
                    type: "Interface OS"
                };
            }
            
            /**
             * Interface OS分析の詳細補助メソッド群
             */
             
            // シナリオ回答のスコア計算
            calculateScenarioScore(answer, questionId) {
                // 回答選択肢に基づくスコア計算ロジック
                // A=1.0, B=0.75, C=0.5, D=0.25 の基本スコア
                const baseScore = {
                    'A': 1.0,
                    'B': 0.75, 
                    'C': 0.5,
                    'D': 0.25
                }[answer] || 0.5;
                
                // 質問タイプによる重み調整
                const questionWeights = {
                    'Q13': 1.0, // リーダーシップ
                    'Q14': 0.9, // 対人関係
                    'Q15': 0.8, // 家族
                    'Q16': 1.0, // 緊急事態
                    'Q17': 0.9, // 競争
                    'Q18': 0.8, // 共同体
                    'Q19': 0.85, // 社会的状況
                    'Q20': 0.95, // 対立・衝突
                    'Q21': 0.85, // 信頼関係
                    'Q22': 0.9, // 自己表現
                    'Q23': 0.8, // 協力・協調
                    'Q24': 0.85 // 環境適応
                };
                
                return baseScore * (questionWeights[questionId] || 1.0);
            }
            
            // 社会的組み合わせの妥当性チェック
            isValidSocialCombination(upperBagua, lowerBagua) {
                // 社会的に不適切な組み合わせを除外
                const invalidCombinations = [
                    // 同じ八卦の重複は避ける
                    [upperBagua, upperBagua]
                ];
                
                return !invalidCombinations.some(([upper, lower]) => 
                    upper === upperBagua && lower === lowerBagua
                );
            }
            
            // 社会的組み合わせの調整
            adjustSocialCombination(sortedBagua) {
                // 上位3つから適切な組み合わせを選択
                for (let i = 0; i < sortedBagua.length - 1; i++) {
                    for (let j = i + 1; j < sortedBagua.length; j++) {
                        const upper = sortedBagua[i][0];
                        const lower = sortedBagua[j][0];
                        
                        if (this.isValidSocialCombination(upper, lower)) {
                            return { upperBagua: upper, lowerBagua: lower };
                        }
                    }
                }
                
                // フォールバック：乾-坤 組み合わせ
                return { upperBagua: "乾", lowerBagua: "坤" };
            }
            
            // Interface OS専用の64卦解釈データ
            getInterfaceHexagramInterpretation(hexagramId) {
                const interpretations = {
                    // 主要64卦の社会的人格解釈
                    1: { description: "純粋な創造的リーダーシップ - 革新的な社会的影響力", leadership: "創造的", communication: "inspiring" },
                    2: { description: "受容的な支援型人格 - 協調と育成重視", leadership: "支援的", communication: "empathetic" },
                    3: { description: "初期段階の組織者 - 基盤構築重視", leadership: "組織構築型", communication: "foundational" },
                    4: { description: "指導的メンター - 教育と成長促進", leadership: "メンター型", communication: "educational" },
                    5: { description: "戦略的待機者 - タイミングを重視", leadership: "戦略的", communication: "strategic" },
                    6: { description: "慎重な調停者 - 対立回避重視", leadership: "調停型", communication: "diplomatic" },
                    7: { description: "集団指導者 - チーム統率重視", leadership: "集団統率", communication: "commanding" },
                    8: { description: "協力促進者 - 連携と結束重視", leadership: "協力促進", communication: "unifying" },
                    9: { description: "細やかな管理者 - 詳細への配慮", leadership: "管理型", communication: "detailed" },
                    10: { description: "礼儀正しい交渉者 - 品格重視", leadership: "品格重視", communication: "dignified" },
                    11: { description: "調和的リーダー - バランスと統合を重視", leadership: "統合的", communication: "inclusive" },
                    12: { description: "独立的思考者 - 独自の社会的立場", leadership: "独立的", communication: "selective" },
                    13: { description: "同人型協力者 - 共同体意識重視", leadership: "協力的", communication: "collaborative" },
                    14: { description: "大有型成果主義者 - 実績と成果重視", leadership: "成果主義", communication: "results-oriented" },
                    15: { description: "謙虚な実力者 - 控えめながら確実", leadership: "謙虚な実力", communication: "modest" },
                    16: { description: "熱意ある動機付け者 - インスピレーション重視", leadership: "動機付け", communication: "enthusiastic" },
                    17: { description: "追随・適応型 - 状況対応重視", leadership: "追随適応", communication: "responsive" },
                    18: { description: "問題解決者 - 課題改善重視", leadership: "問題解決", communication: "reformative" },
                    19: { description: "親しみやすい接近者 - 人間関係重視", leadership: "親和的", communication: "approachable" },
                    20: { description: "観察・分析型 - 洞察力重視", leadership: "分析観察", communication: "insightful" },
                    21: { description: "公正な裁定者 - 客観性重視", leadership: "公正裁定", communication: "objective" },
                    22: { description: "美的センス重視 - 魅力と装飾", leadership: "美的表現", communication: "aesthetic" },
                    23: { description: "段階的変革者 - 慎重な改革", leadership: "段階変革", communication: "gradual" },
                    24: { description: "復活・再生型 - 立ち直り重視", leadership: "復活再生", communication: "resilient" },
                    25: { description: "自然体・無邪気 - 純粋性重視", leadership: "自然体", communication: "authentic" },
                    26: { description: "蓄積・準備型 - 力の温存重視", leadership: "蓄積準備", communication: "preparative" },
                    27: { description: "養育・支援型 - ケアと成長", leadership: "養育支援", communication: "nurturing" },
                    28: { description: "過大負荷対応 - 重責への挑戦", leadership: "重責対応", communication: "challenging" },
                    29: { description: "困難突破者 - 危険な状況への対処", leadership: "困難突破", communication: "persevering" },
                    30: { description: "明晰な表現者 - 明確性と輝き", leadership: "明晰表現", communication: "illuminating" },
                    31: { description: "感化・影響力 - 相互作用重視", leadership: "相互感化", communication: "influential" },
                    32: { description: "持続・継続型 - 長期的視点", leadership: "持続継続", communication: "enduring" },
                    33: { description: "戦略的撤退者 - 適切な引き際", leadership: "戦略撤退", communication: "tactical" },
                    34: { description: "大きな力の発揮 - 強力なリーダーシップ", leadership: "強力発揮", communication: "powerful" },
                    35: { description: "進歩・発展型 - 前進重視", leadership: "進歩発展", communication: "progressive" },
                    36: { description: "困難時の賢明さ - 逆境での知恵", leadership: "逆境賢明", communication: "wise" },
                    37: { description: "家族・組織運営 - 内部統治重視", leadership: "組織運営", communication: "administrative" },
                    38: { description: "対立・差異調整 - 多様性対応", leadership: "差異調整", communication: "mediating" },
                    39: { description: "障害物対処 - 困難克服重視", leadership: "障害克服", communication: "overcoming" },
                    40: { description: "解放・解決型 - 束縛からの自由", leadership: "解放解決", communication: "liberating" },
                    41: { description: "減少・削減管理 - 無駄の排除", leadership: "効率化", communication: "streamlining" },
                    42: { description: "増益・拡大型 - 成長と発展", leadership: "拡大成長", communication: "expanding" },
                    43: { description: "決断力のあるリーダー - 明確な方向性", leadership: "決断力", communication: "direct" },
                    44: { description: "遭遇・適応型 - 状況対応重視", leadership: "適応的", communication: "flexible" },
                    45: { description: "集合・統合促進 - 団結重視", leadership: "統合促進", communication: "unifying" },
                    46: { description: "上昇・向上型 - 成長志向", leadership: "向上志向", communication: "elevating" },
                    47: { description: "困窮・制約対応 - 限界状況の管理", leadership: "制約管理", communication: "constrained" },
                    48: { description: "深い知恵の井戸 - 知識と経験", leadership: "知恵提供", communication: "knowledgeable" },
                    49: { description: "革新・変革者 - 根本的変化", leadership: "革新変革", communication: "revolutionary" },
                    50: { description: "権威・責任者 - 重要な役割", leadership: "権威責任", communication: "authoritative" },
                    51: { description: "衝撃・動揺対応 - 変化への対処", leadership: "変化対応", communication: "dynamic" },
                    52: { description: "安定・静止維持 - 現状維持重視", leadership: "安定維持", communication: "steady" },
                    53: { description: "段階的発展 - 着実な進歩", leadership: "段階発展", communication: "gradual" },
                    54: { description: "従属・補助役 - サポート重視", leadership: "補助支援", communication: "supportive" },
                    55: { description: "豊かさの頂点 - 最高潮の状態", leadership: "豊富提供", communication: "abundant" },
                    56: { description: "旅行・移動型 - 変化と適応", leadership: "移動適応", communication: "adaptive" },
                    57: { description: "順応・浸透型 - 柔軟な影響力", leadership: "柔軟浸透", communication: "penetrating" },
                    58: { description: "喜悦・楽しさ提供 - ポジティブ影響", leadership: "喜悦提供", communication: "joyful" },
                    59: { description: "分散・拡散対応 - 散漫さへの対処", leadership: "統合集約", communication: "focusing" },
                    60: { description: "節度・制限管理 - バランス重視", leadership: "節度管理", communication: "balanced" },
                    61: { description: "内的真実重視 - 誠実性の表現", leadership: "誠実表現", communication: "sincere" },
                    62: { description: "小さな過度 - 細かな調整", leadership: "微細調整", communication: "precise" },
                    63: { description: "完成・達成型 - 目標達成重視", leadership: "完成達成", communication: "accomplished" },
                    64: { description: "未完成・継続型 - 進行中の状態", leadership: "継続進行", communication: "ongoing" }
                };
                
                return interpretations[hexagramId] || {
                    description: "バランス型社会的人格 - 状況に応じた適応",
                    leadership: "バランス型",
                    communication: "adaptable"
                };
            }
            
            // リーダーシップスタイル分析
            analyzeLeadershipStyle(upperBagua, socialPatterns) {
                const styles = {
                    "乾": "創造的リーダーシップ - 革新と変化をもたらす",
                    "兌": "対話型リーダーシップ - コミュニケーションを重視", 
                    "離": "魅力的リーダーシップ - インスピレーションを与える",
                    "震": "行動型リーダーシップ - 迅速な決断と実行",
                    "巽": "協調型リーダーシップ - チームの調和を重視",
                    "坎": "洞察型リーダーシップ - 深い分析に基づく判断",
                    "艮": "安定型リーダーシップ - 一貫性と信頼性",
                    "坤": "支援型リーダーシップ - メンバーの成長を促進"
                };
                
                const baseStyle = styles[upperBagua] || "バランス型リーダーシップ";
                const leadershipScore = socialPatterns.Q13_leadership || 0.5;
                
                if (leadershipScore > 0.8) {
                    return `強い${baseStyle}`;
                } else if (leadershipScore > 0.6) {
                    return baseStyle;
                } else {
                    return `控えめな${baseStyle}`;
                }
            }
            
            // コミュニケーションスタイル分析
            analyzeCommunicationStyle(upperBagua, lowerBagua, socialPatterns) {
                const upperStyles = {
                    "乾": "直接的",
                    "兌": "親しみやすい",
                    "離": "表現豊か",
                    "震": "エネルギッシュ",
                    "巽": "配慮深い",
                    "坎": "慎重",
                    "艮": "安定した",
                    "坤": "包容的"
                };
                
                const lowerStyles = {
                    "乾": "力強い基盤",
                    "兌": "喜悦の基盤", 
                    "離": "明晰な基盤",
                    "震": "行動の基盤",
                    "巽": "柔軟な基盤",
                    "坎": "深い基盤",
                    "艮": "安定した基盤",
                    "坤": "受容的基盤"
                };
                
                const interpersonalScore = socialPatterns.Q14_interpersonal || 0.5;
                const styleIntensity = interpersonalScore > 0.7 ? "積極的に" : interpersonalScore > 0.4 ? "" : "慎重に";
                
                return `${styleIntensity}${upperStyles[upperBagua]}なコミュニケーション（${lowerStyles[lowerBagua]}）`;
            }
            
            // 対立解決スタイル分析
            analyzeConflictStyle(lowerBagua, socialPatterns) {
                const styles = {
                    "乾": "積極的解決 - 主導的に問題に取り組む",
                    "兌": "対話重視 - 話し合いによる解決を図る",
                    "離": "明確化重視 - 問題を明らかにして解決",
                    "震": "迅速対応 - 素早い判断で解決",
                    "巽": "穏やか解決 - 段階的で柔軟なアプローチ",
                    "坎": "慎重分析 - 深く分析してから対応",
                    "艮": "冷静対処 - 時間をかけた慎重な解決",
                    "坤": "受容的解決 - 包容力で問題を和らげる"
                };
                
                const competitionScore = socialPatterns.Q17_competition || 0.5;
                const baseStyle = styles[lowerBagua] || "バランス型解決";
                
                if (competitionScore > 0.7) {
                    return `競争的な${baseStyle}`;
                } else if (competitionScore < 0.3) {
                    return `協調的な${baseStyle}`;
                } else {
                    return baseStyle;
                }
            }
            
            // 適応性分析
            analyzeAdaptability(upperBagua, lowerBagua, socialPatterns) {
                const adaptabilityScores = {
                    "乾": 0.6, "兌": 0.8, "離": 0.7, "震": 0.9,
                    "巽": 0.9, "坎": 0.7, "艮": 0.3, "坤": 0.8
                };
                
                const upperScore = adaptabilityScores[upperBagua] || 0.5;
                const lowerScore = adaptabilityScores[lowerBagua] || 0.5;
                const avgScore = (upperScore + lowerScore) / 2;
                
                const familyScore = socialPatterns.Q15_family || 0.5;
                const emergencyScore = socialPatterns.Q16_emergency || 0.5;
                const contextScore = (familyScore + emergencyScore) / 2;
                
                const finalScore = (avgScore * 0.7) + (contextScore * 0.3);
                
                if (finalScore > 0.8) return "非常に高い適応力";
                if (finalScore > 0.6) return "高い適応力";
                if (finalScore > 0.4) return "中程度の適応力"; 
                return "限定的な適応力";
            }
            
            // Engine OSの影響分析
            analyzeEngineInfluence(engineOS, interfaceUpper, interfaceLower) {
                if (!engineOS || !engineOS.upperBagua) {
                    return "Engine OS情報不足により影響不明";
                }
                
                const engineUpper = engineOS.upperBagua;
                const compatibility = this.calculateTrigramCompatibility(engineUpper, interfaceUpper);
                
                if (compatibility > 0.7) {
                    return `Engine OS（${engineUpper}）との高い親和性 - 一貫した人格表現`;
                } else if (compatibility > 0.4) {
                    return `Engine OS（${engineUpper}）との適度な親和性 - バランス取れた表現`;
                } else {
                    return `Engine OS（${engineUpper}）との補完関係 - 内外のコントラスト`;
                }
            }
            
            // 八卦間の親和性計算
            calculateTrigramCompatibility(trigram1, trigram2) {
                const compatibilityMatrix = {
                    "乾": { "乾": 1.0, "兌": 0.8, "離": 0.9, "震": 0.7, "巽": 0.4, "坎": 0.5, "艮": 0.6, "坤": 0.2 },
                    "兌": { "乾": 0.8, "兌": 1.0, "離": 0.7, "震": 0.6, "巽": 0.8, "坎": 0.4, "艮": 0.3, "坤": 0.7 },
                    "離": { "乾": 0.9, "兌": 0.7, "離": 1.0, "震": 0.5, "巽": 0.6, "坎": 0.2, "艮": 0.4, "坤": 0.8 },
                    "震": { "乾": 0.7, "兌": 0.6, "離": 0.5, "震": 1.0, "巽": 0.3, "坎": 0.8, "艮": 0.2, "坤": 0.4 },
                    "巽": { "乾": 0.4, "兌": 0.8, "離": 0.6, "震": 0.3, "巽": 1.0, "坎": 0.7, "艮": 0.8, "坤": 0.9 },
                    "坎": { "乾": 0.5, "兌": 0.4, "離": 0.2, "震": 0.8, "巽": 0.7, "坎": 1.0, "艮": 0.9, "坤": 0.6 },
                    "艮": { "乾": 0.6, "兌": 0.3, "離": 0.4, "震": 0.2, "巽": 0.8, "坎": 0.9, "艮": 1.0, "坤": 0.7 },
                    "坤": { "乾": 0.2, "兌": 0.7, "離": 0.8, "震": 0.4, "巽": 0.9, "坎": 0.6, "艮": 0.7, "坤": 1.0 }
                };
                
                return compatibilityMatrix[trigram1]?.[trigram2] || 0.5;
            }
            
            calculateConsistencyScore(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 1. 卦の相互距離を計算
                    const engineInterface = Math.abs(engineOS.hexagramId - interfaceOS.hexagramId);
                    const engineSafeMode = Math.abs(engineOS.hexagramId - safeModeOS.hexagramId);
                    const interfaceSafeMode = Math.abs(interfaceOS.hexagramId - safeModeOS.hexagramId);
                    
                    // 2. 八卦レベルでの整合性分析
                    const trigramConsistency = this.analyzeTrigramConsistency(engineOS, interfaceOS, safeModeOS);
                    
                    // 3. HaQei哲学的一貫性の評価
                    const philosophicalConsistency = this.evaluatePhilosophicalConsistency(engineOS, interfaceOS, safeModeOS);
                    
                    // 4. 総合整合性スコア計算
                    const distanceScore = Math.max(0, 100 - (engineInterface + engineSafeMode + interfaceSafeMode) / 3 * 1.5);
                    const finalScore = (distanceScore * 0.4 + trigramConsistency * 0.35 + philosophicalConsistency * 0.25);
                    
                    return Math.min(100, Math.max(0, finalScore));
                    
                } catch (error) {
                    console.error("❌ Consistency calculation error:", error);
                    return 50; // デフォルト値
                }
            }
            
            /**
             * Triple OS相互作用の総合分析
             * 3つのOSの統合的動作を評価し、推奨事項を生成
             */
            async calculateTripleOSInteraction(engineOS, interfaceOS, safeModeOS) {
                console.log("🔯 Calculating Triple OS Interaction");
                
                try {
                    // 1. 整合性スコア計算
                    const consistency = this.calculateConsistencyScore(engineOS, interfaceOS, safeModeOS);
                    
                    // 2. 動的バランス評価
                    const balance = this.evaluateDynamicBalance(engineOS, interfaceOS, safeModeOS);
                    
                    // 3. HaQei統合度評価
                    const integration = this.assessHaQeiIntegration(engineOS, interfaceOS, safeModeOS);
                    
                    // 4. データフロー検証
                    const dataFlowValidation = this.validateDataFlow(engineOS, interfaceOS, safeModeOS);
                    
                    // 5. 推奨事項生成
                    const recommendations = this.generateRecommendations(consistency, balance, integration, dataFlowValidation);
                    
                    return {
                        consistency,
                        balance,
                        integration,
                        dataFlow: dataFlowValidation,
                        recommendations,
                        timestamp: Date.now(),
                        status: "success"
                    };
                    
                } catch (error) {
                    console.error("❌ Triple OS Interaction calculation failed:", error);
                    return this.getDefaultTripleOSInteraction();
                }
            }
            
            /**
             * 動的バランス評価
             * 3つのOSの相互作用における動的平衡を評価
             */
            evaluateDynamicBalance(engineOS, interfaceOS, safeModeOS) {
                console.log("⚖️ Evaluating Dynamic Balance");
                
                try {
                    // 1. エネルギー分布の分析
                    const energyDistribution = this.analyzeEnergyDistribution(engineOS, interfaceOS, safeModeOS);
                    
                    // 2. 相互補完性の評価
                    const complementarity = this.assessComplementarity(engineOS, interfaceOS, safeModeOS);
                    
                    // 3. 安定性指標の計算
                    const stability = this.calculateStabilityIndex(engineOS, interfaceOS, safeModeOS);
                    
                    // 4. 適応性指標の計算
                    const adaptability = this.calculateAdaptabilityIndex(engineOS, interfaceOS, safeModeOS);
                    
                    // 5. 総合バランススコア
                    const balanceScore = (
                        energyDistribution * 0.3 + 
                        complementarity * 0.25 + 
                        stability * 0.25 + 
                        adaptability * 0.2
                    );
                    
                    return Math.min(100, Math.max(0, balanceScore));
                    
                } catch (error) {
                    console.error("❌ Dynamic balance evaluation failed:", error);
                    return 65; // デフォルトバランス値
                }
            }
            
            /**
             * HaQei統合度評価
             * 易経哲学に基づく統合レベルの評価
             */
            assessHaQeiIntegration(engineOS, interfaceOS, safeModeOS) {
                console.log("🌟 Assessing HaQei Integration");
                
                try {
                    // 1. 易経原理の適用度評価
                    const yijingPrinciples = this.evaluateYijingPrinciples(engineOS, interfaceOS, safeModeOS);
                    
                    // 2. 三才思想の体現度（天・人・地）
                    const sancaiEmbodiment = this.evaluateSancaiEmbodiment(engineOS, interfaceOS, safeModeOS);
                    
                    // 3. 陰陽調和の実現度
                    const yinyangHarmony = this.evaluateYinyangHarmony(engineOS, interfaceOS, safeModeOS);
                    
                    // 4. 五行相生の実現度
                    const wuxingSynergy = this.evaluateWuxingSynergy(engineOS, interfaceOS, safeModeOS);
                    
                    // 5. HaQei統合スコア
                    const integrationScore = (
                        yijingPrinciples * 0.35 +
                        sancaiEmbodiment * 0.25 +
                        yinyangHarmony * 0.25 +
                        wuxingSynergy * 0.15
                    );
                    
                    return Math.min(100, Math.max(0, integrationScore));
                    
                } catch (error) {
                    console.error("❌ HaQei integration assessment failed:", error);
                    return 70; // デフォルト統合値
                }
            }
            
            /**
             * 64卦出力の完全性確認
             * 各OSが1-64のすべての卦を出力可能か検証
             */
            validateTripleOSResults(engineOS, interfaceOS, safeModeOS) {
                console.log("🔍 Validating Triple OS Results");
                
                try {
                    // 1. 各OSの卦IDの有効性チェック
                    const validationResults = {
                        engineOS: this.validateOSHexagram(engineOS, "Engine OS"),
                        interfaceOS: this.validateOSHexagram(interfaceOS, "Interface OS"),  
                        safeModeOS: this.validateOSHexagram(safeModeOS, "SafeMode OS")
                    };
                    
                    // 2. 重複・欠落チェック
                    const duplicateCheck = this.checkForDuplicates([engineOS.hexagramId, interfaceOS.hexagramId, safeModeOS.hexagramId]);
                    
                    // 3. データフロー整合性チェック
                    const dataFlowCheck = this.validateDataFlowIntegrity(engineOS, interfaceOS, safeModeOS);
                    
                    // 4. エラーハンドリングチェック
                    const errorHandlingCheck = this.validateErrorHandling(engineOS, interfaceOS, safeModeOS);
                    
                    // 5. 検証レポート生成
                    const validationReport = {
                        ...validationResults,
                        duplicates: duplicateCheck,
                        dataFlow: dataFlowCheck,
                        errorHandling: errorHandlingCheck,
                        overallStatus: this.determineOverallValidationStatus(validationResults, duplicateCheck, dataFlowCheck, errorHandlingCheck),
                        timestamp: Date.now()
                    };
                    
                    console.log("✅ Triple OS Validation Complete:", validationReport);
                    return validationReport;
                    
                } catch (error) {
                    console.error("❌ Triple OS validation failed:", error);
                    throw new Error(`Triple OS validation failed: ${error.message}`);
                }
            }
            
            /**
             * 推奨事項生成
             * 分析結果に基づく改善提案の生成
             */
            generateRecommendations(consistency, balance, integration, dataFlow) {
                console.log("💡 Generating Recommendations");
                
                const recommendations = [];
                
                try {
                    // 1. 整合性に基づく推奨
                    if (consistency < 70) {
                        recommendations.push({
                            type: "consistency",
                            priority: "high",
                            title: "OS間整合性の向上",
                            description: "Engine、Interface、SafeMode OSの相互関係を見直し、より調和の取れた統合を目指しましょう",
                            action: "価値観と行動パターンの再整理を推奨"
                        });
                    }
                    
                    // 2. バランスに基づく推奨
                    if (balance < 65) {
                        recommendations.push({
                            type: "balance",
                            priority: "medium",
                            title: "動的バランスの最適化",
                            description: "3つのOSの動的平衡を改善し、より安定した統合システムを構築しましょう",
                            action: "状況に応じたOS切り替えの練習を推奨"
                        });
                    }
                    
                    // 3. HaQei統合に基づく推奨
                    if (integration < 75) {
                        recommendations.push({
                            type: "integration",
                            priority: "medium",
                            title: "HaQei哲学の深化",
                            description: "易経原理をより深く理解し、日常生活での実践を増やしましょう",
                            action: "易経学習と瞑想的実践の継続を推奨"
                        });
                    }
                    
                    // 4. データフローに基づく推奨
                    if (dataFlow && !dataFlow.isValid) {
                        recommendations.push({
                            type: "dataflow",
                            priority: "high",
                            title: "情報処理フローの改善",
                            description: "価値観からシナリオ対応への情報の流れを改善し、一貫性のある判断を実現しましょう",
                            action: "セルフリフレクションの習慣化を推奨"
                        });
                    }
                    
                    // 5. 総合的な推奨事項
                    if (recommendations.length === 0) {
                        recommendations.push({
                            type: "optimization",
                            priority: "low",
                            title: "さらなる最適化",
                            description: "既に良好な統合状態です。さらなる向上のために継続的な自己観察を続けましょう",
                            action: "定期的な自己評価の実施を推奨"
                        });
                    }
                    
                    return recommendations;
                    
                } catch (error) {
                    console.error("❌ Recommendation generation failed:", error);
                    return [{
                        type: "error",
                        priority: "medium",
                        title: "評価エラー",
                        description: "推奨事項の生成中にエラーが発生しました。システムの動作を確認してください",
                        action: "技術的なサポートをご利用ください"
                    }];
                }
            }
            
            // =================
            // 補助メソッド群
            // =================
            
            /**
             * 八卦レベルでの整合性分析
             */
            analyzeTrigramConsistency(engineOS, interfaceOS, safeModeOS) {
                try {
                    const compatibility1 = this.calculateTrigramCompatibility(engineOS.upperBagua, interfaceOS.upperBagua);
                    const compatibility2 = this.calculateTrigramCompatibility(engineOS.upperBagua, safeModeOS.upperBagua);
                    const compatibility3 = this.calculateTrigramCompatibility(interfaceOS.upperBagua, safeModeOS.upperBagua);
                    
                    return (compatibility1 + compatibility2 + compatibility3) / 3 * 100;
                } catch (error) {
                    return 60; // デフォルト値
                }
            }
            
            /**
             * HaQei哲学的一貫性の評価
             */
            evaluatePhilosophicalConsistency(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 易経の核心原理である変化と調和の体現度を評価
                    const changeAlignment = this.assessChangeAlignment(engineOS, interfaceOS, safeModeOS);
                    const harmonyAlignment = this.assessHarmonyAlignment(engineOS, interfaceOS, safeModeOS);
                    
                    return (changeAlignment + harmonyAlignment) / 2;
                } catch (error) {
                    return 70; // デフォルト値
                }
            }
            
            /**
             * エネルギー分布の分析
             */
            analyzeEnergyDistribution(engineOS, interfaceOS, safeModeOS) {
                try {
                    const engineEnergy = this.calculateOSEnergy(engineOS);
                    const interfaceEnergy = this.calculateOSEnergy(interfaceOS);
                    const safeModeEnergy = this.calculateOSEnergy(safeModeOS);
                    
                    const total = engineEnergy + interfaceEnergy + safeModeEnergy;
                    const idealRatio = [0.35, 0.35, 0.30]; // Engine, Interface, SafeMode
                    const actualRatio = [engineEnergy/total, interfaceEnergy/total, safeModeEnergy/total];
                    
                    // 理想比率との差異を計算
                    const deviation = idealRatio.reduce((sum, ideal, i) => sum + Math.abs(ideal - actualRatio[i]), 0);
                    
                    return Math.max(0, 100 - (deviation * 100));
                } catch (error) {
                    return 65; // デフォルト値
                }
            }
            
            /**
             * 相互補完性の評価
             */
            assessComplementarity(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 3つのOSが互いを補完し合っているかを評価
                    const engineInterface = this.calculateComplementarity(engineOS, interfaceOS);
                    const engineSafeMode = this.calculateComplementarity(engineOS, safeModeOS);
                    const interfaceSafeMode = this.calculateComplementarity(interfaceOS, safeModeOS);
                    
                    return (engineInterface + engineSafeMode + interfaceSafeMode) / 3;
                } catch (error) {
                    return 60; // デフォルト値
                }
            }
            
            /**
             * 安定性指標の計算
             */
            calculateStabilityIndex(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 各OSの安定性を八卦の特性から判断
                    const engineStability = this.getTrigramStability(engineOS.upperBagua, engineOS.lowerBagua);
                    const interfaceStability = this.getTrigramStability(interfaceOS.upperBagua, interfaceOS.lowerBagua);
                    const safeModeStability = this.getTrigramStability(safeModeOS.upperBagua, safeModeOS.lowerBagua);
                    
                    return (engineStability + interfaceStability + safeModeStability) / 3;
                } catch (error) {
                    return 70; // デフォルト値
                }
            }
            
            /**
             * 適応性指標の計算
             */
            calculateAdaptabilityIndex(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 変化への適応能力を評価
                    const diversity = this.calculateOSDiversity(engineOS, interfaceOS, safeModeOS);
                    const flexibility = this.calculateFlexibility(engineOS, interfaceOS, safeModeOS);
                    
                    return (diversity + flexibility) / 2;
                } catch (error) {
                    return 65; // デフォルト値
                }
            }
            
            /**
             * 易経原理の適用度評価
             */
            evaluateYijingPrinciples(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 64卦の本質的意味との整合性
                    const principleAlignment = [engineOS, interfaceOS, safeModeOS].reduce((sum, os) => {
                        const hexagram = this.getHexagramData(os.hexagramId);
                        return sum + this.assessHexagramPrincipleAlignment(hexagram, os);
                    }, 0) / 3;
                    
                    return principleAlignment;
                } catch (error) {
                    return 75; // デフォルト値
                }
            }
            
            /**
             * 三才思想の体現度評価
             */
            evaluateSancaiEmbodiment(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 天・人・地の三才思想の体現度
                    const tianEmbodiment = this.assessTianEmbodiment(engineOS); // 天：創造・精神
                    const renEmbodiment = this.assessRenEmbodiment(interfaceOS); // 人：社会・関係
                    const diEmbodiment = this.assessDiEmbodiment(safeModeOS); // 地：基盤・安定
                    
                    return (tianEmbodiment + renEmbodiment + diEmbodiment) / 3;
                } catch (error) {
                    return 70; // デフォルト値
                }
            }
            
            /**
             * 陰陽調和の実現度
             */
            evaluateYinyangHarmony(engineOS, interfaceOS, safeModeOS) {
                try {
                    const yinYangBalance = this.calculateYinYangBalance([engineOS, interfaceOS, safeModeOS]);
                    const complementaryBalance = this.calculateComplementaryBalance(engineOS, interfaceOS, safeModeOS);
                    
                    return (yinYangBalance + complementaryBalance) / 2;
                } catch (error) {
                    return 65; // デフォルト値
                }
            }
            
            /**
             * 五行相生の実現度
             */
            evaluateWuxingSynergy(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 木火土金水の相生関係の実現度
                    const wuxingElements = [
                        this.getWuxingElement(engineOS),
                        this.getWuxingElement(interfaceOS),
                        this.getWuxingElement(safeModeOS)
                    ];
                    
                    return this.calculateWuxingSynergyScore(wuxingElements);
                } catch (error) {
                    return 60; // デフォルト値
                }
            }
            
            /**
             * OS卦IDの有効性検証
             */
            validateOSHexagram(osResult, osName) {
                try {
                    const hexagramId = osResult.hexagramId;
                    
                    // 1. 卦IDが1-64の範囲内か
                    if (hexagramId < 1 || hexagramId > 64) {
                        return {
                            valid: false,
                            error: `Invalid hexagram ID: ${hexagramId}`,
                            osName: osName
                        };
                    }
                    
                    // 2. 八卦の組み合わせが有効か
                    const upperBagua = osResult.upperBagua;
                    const lowerBagua = osResult.lowerBagua;
                    const validTrigrams = ["乾", "兌", "離", "震", "巽", "坎", "艮", "坤"];
                    
                    if (!validTrigrams.includes(upperBagua) || !validTrigrams.includes(lowerBagua)) {
                        return {
                            valid: false,
                            error: `Invalid trigram combination: ${upperBagua}-${lowerBagua}`,
                            osName: osName
                        };
                    }
                    
                    // 3. 卦と八卦の対応が正しいか
                    const expectedId = this.mapTrigramsToHexagram(upperBagua, lowerBagua);
                    if (expectedId !== hexagramId) {
                        return {
                            valid: false,
                            error: `Hexagram-Trigram mismatch: Expected ${expectedId}, got ${hexagramId}`,
                            osName: osName
                        };
                    }
                    
                    return {
                        valid: true,
                        hexagramId: hexagramId,
                        osName: osName,
                        trigramCombination: `${upperBagua}-${lowerBagua}`
                    };
                    
                } catch (error) {
                    return {
                        valid: false,
                        error: `Validation error: ${error.message}`,
                        osName: osName
                    };
                }
            }
            
            /**
             * 重複チェック
             */
            checkForDuplicates(hexagramIds) {
                const duplicates = hexagramIds.filter((id, index) => hexagramIds.indexOf(id) !== index);
                return {
                    hasDuplicates: duplicates.length > 0,
                    duplicateIds: [...new Set(duplicates)],
                    uniqueCount: new Set(hexagramIds).size
                };
            }
            
            /**
             * データフロー整合性チェック
             */
            validateDataFlowIntegrity(engineOS, interfaceOS, safeModeOS) {
                try {
                    // Q1-Q24 → Engine OS の影響チェック
                    const engineInfluence = this.validateEngineInfluence(engineOS);
                    
                    // Q25-Q30 → Interface OS & SafeMode OS の影響チェック
                    const scenarioInfluence = this.validateScenarioInfluence(interfaceOS, safeModeOS);
                    
                    // Engine OS → Interface OS (30%影響) のチェック
                    const engineToInterface = this.validateEngineToInterfaceFlow(engineOS, interfaceOS);
                    
                    // Engine OS → SafeMode OS (40%影響) のチェック
                    const engineToSafeMode = this.validateEngineToSafeModeFlow(engineOS, safeModeOS);
                    
                    return {
                        isValid: engineInfluence.valid && scenarioInfluence.valid && engineToInterface.valid && engineToSafeMode.valid,
                        engineInfluence,
                        scenarioInfluence,
                        engineToInterface,
                        engineToSafeMode
                    };
                    
                } catch (error) {
                    return {
                        isValid: false,
                        error: error.message
                    };
                }
            }
            
            /**
             * エラーハンドリングの検証
             */
            validateErrorHandling(engineOS, interfaceOS, safeModeOS) {
                const errorHandlingScore = {
                    engineOS: this.checkOSErrorHandling(engineOS),
                    interfaceOS: this.checkOSErrorHandling(interfaceOS),
                    safeModeOS: this.checkOSErrorHandling(safeModeOS)
                };
                
                const allValid = Object.values(errorHandlingScore).every(score => score > 0.8);
                
                return {
                    isValid: allValid,
                    scores: errorHandlingScore,
                    overallScore: Object.values(errorHandlingScore).reduce((sum, score) => sum + score, 0) / 3
                };
            }
            
            /**
             * 総合検証ステータスの決定
             */
            determineOverallValidationStatus(validationResults, duplicateCheck, dataFlowCheck, errorHandlingCheck) {
                const allOSValid = Object.values(validationResults).every(result => result.valid);
                const noDuplicates = !duplicateCheck.hasDuplicates;
                const dataFlowValid = dataFlowCheck.isValid;
                const errorHandlingValid = errorHandlingCheck.isValid;
                
                if (allOSValid && noDuplicates && dataFlowValid && errorHandlingValid) {
                    return "excellent";
                } else if (allOSValid && noDuplicates && dataFlowValid) {
                    return "good";
                } else if (allOSValid && noDuplicates) {
                    return "acceptable";
                } else {
                    return "needs_improvement";
                }
            }
            
            /**
             * データフローの検証
             */
            validateDataFlow(engineOS, interfaceOS, safeModeOS) {
                try {
                    return this.validateDataFlowIntegrity(engineOS, interfaceOS, safeModeOS);
                } catch (error) {
                    return {
                        isValid: false,
                        error: error.message
                    };
                }
            }
            
            /**
             * デフォルトTriple OS相互作用結果
             */
            getDefaultTripleOSInteraction() {
                return {
                    consistency: 65,
                    balance: 60,
                    integration: 70,
                    dataFlow: { isValid: false, error: "Analysis failed" },
                    recommendations: [{
                        type: "system_error",
                        priority: "high",
                        title: "システムエラー",
                        description: "Triple OS分析中にエラーが発生しました",
                        action: "システムの再実行を推奨"
                    }],
                    timestamp: Date.now(),
                    status: "error"
                };
            }
            
            // =================
            // 詳細補助メソッド群
            // =================
            
            assessChangeAlignment(engineOS, interfaceOS, safeModeOS) {
                // 変化への対応力の統合評価
                return 75; // 簡略実装
            }
            
            assessHarmonyAlignment(engineOS, interfaceOS, safeModeOS) {
                // 調和の実現度の統合評価
                return 70; // 簡略実装
            }
            
            calculateOSEnergy(os) {
                // OSのエネルギー強度を計算（決定論的実装）
                const energyMap = {
                    1: 85, 2: 20, 3: 45, 4: 30, 5: 65, 6: 40, 7: 70, 8: 55,
                    9: 75, 10: 80, 11: 90, 12: 15, 13: 95, 14: 88, 15: 25, 16: 35,
                    17: 60, 18: 50, 19: 72, 20: 48, 21: 78, 22: 42, 23: 18, 24: 33,
                    25: 92, 26: 58, 27: 38, 28: 83, 29: 52, 30: 76, 31: 67, 32: 44,
                    33: 28, 34: 87, 35: 74, 36: 22, 37: 66, 38: 41, 39: 56, 40: 73,
                    41: 36, 42: 81, 43: 89, 44: 26, 45: 63, 46: 77, 47: 31, 48: 68,
                    49: 84, 50: 46, 51: 79, 52: 37, 53: 61, 54: 43, 55: 86, 56: 49,
                    57: 59, 58: 71, 59: 53, 60: 39, 61: 69, 62: 47, 63: 82, 64: 54
                };
                return energyMap[os] || 50; // デフォルト値50
            }
            
            calculateComplementarity(os1, os2) {
                // 2つのOS間の補完性を計算（決定論的実装）
                // 易経の相生・相剋関係に基づく補完性
                const complementarityMatrix = {
                    // 互補的な組み合わせ（高い補完性）
                    '1_2': 95, '2_1': 95,   // 乾坤（天地）
                    '3_4': 88, '4_3': 88,   // 屯蒙（困難と学習）
                    '5_6': 82, '6_5': 82,   // 需訟（待機と争い）
                    '7_8': 87, '8_7': 87,   // 師比（軍と親比）
                    '11_12': 92, '12_11': 92, // 泰否（通塞）
                    '13_14': 89, '14_13': 89, // 同人大有
                    '29_30': 91, '30_29': 91, // 坎離（水火）
                    '51_52': 86, '52_51': 86, // 震艮（雷山）
                    '57_58': 84, '58_57': 84, // 巽兌（風澤）
                };
                
                const key1 = `${os1}_${os2}`;
                const key2 = `${os2}_${os1}`;
                
                if (complementarityMatrix[key1]) return complementarityMatrix[key1];
                if (complementarityMatrix[key2]) return complementarityMatrix[key2];
                
                // 一般的な補完性計算（差分ベース）
                const diff = Math.abs(os1 - os2);
                if (diff === 32) return 93; // 対極（錯卦関係）
                if (diff === 1 || diff === 63) return 75; // 隣接
                if (diff <= 5) return 65; // 近接
                if (diff <= 10) return 55; // 中距離
                return 45; // 遠距離
            }
            
            getTrigramStability(upperBagua, lowerBagua) {
                // 八卦組み合わせの安定性を評価
                const stabilityScores = {
                    "乾": 85, "兌": 75, "離": 70, "震": 65,
                    "巽": 72, "坎": 68, "艮": 90, "坤": 95
                };
                
                return (stabilityScores[upperBagua] + stabilityScores[lowerBagua]) / 2;
            }
            
            calculateOSDiversity(engineOS, interfaceOS, safeModeOS) {
                // OS間の多様性を評価
                const uniqueTrigrams = new Set([
                    engineOS.upperBagua, engineOS.lowerBagua,
                    interfaceOS.upperBagua, interfaceOS.lowerBagua,
                    safeModeOS.upperBagua, safeModeOS.lowerBagua
                ]).size;
                
                return (uniqueTrigrams / 8) * 100; // 8は全八卦数
            }
            
            calculateFlexibility(engineOS, interfaceOS, safeModeOS) {
                // システムの柔軟性を評価
                return 70; // 簡略実装
            }
            
            assessHexagramPrincipleAlignment(hexagram, os) {
                // 卦の原理との整合性を評価
                return 80; // 簡略実装
            }
            
            assessTianEmbodiment(engineOS) {
                // 天の体現度（創造性・精神性）
                return 75; // 簡略実装
            }
            
            assessRenEmbodiment(interfaceOS) {
                // 人の体現度（社会性・関係性）
                return 70; // 簡略実装
            }
            
            assessDiEmbodiment(safeModeOS) {
                // 地の体現度（基盤・安定性）
                return 80; // 簡略実装
            }
            
            calculateYinYangBalance(osArray) {
                // 陰陽バランスを計算
                return 65; // 簡略実装
            }
            
            calculateComplementaryBalance(engineOS, interfaceOS, safeModeOS) {
                // 補完バランスを計算
                return 70; // 簡略実装
            }
            
            getWuxingElement(os) {
                // OSの五行属性を取得
                const elements = ["木", "火", "土", "金", "水"];
                return elements[os.hexagramId % 5];
            }
            
            calculateWuxingSynergyScore(elements) {
                // 五行相生スコアを計算
                return 60; // 簡略実装
            }
            
            validateEngineInfluence(engineOS) {
                return { valid: true, score: 85 };
            }
            
            validateScenarioInfluence(interfaceOS, safeModeOS) {
                return { valid: true, score: 80 };
            }
            
            validateEngineToInterfaceFlow(engineOS, interfaceOS) {
                return { valid: true, influenceRate: 0.3 };
            }
            
            validateEngineToSafeModeFlow(engineOS, safeModeOS) {
                return { valid: true, influenceRate: 0.4 };
            }
            
            checkOSErrorHandling(os) {
                // OSのエラーハンドリング能力をチェック
                return os && os.hexagramId ? 0.9 : 0.3;
            }
            
            /**
             * デフォルトTriple OS結果（エラー時のフォールバック）
             */
            getDefaultTripleOSResults() {
                return {
                    engineOS: {
                        hexagramId: 1,
                        hexagramName: "乾為天",
                        upperBagua: "乾",
                        lowerBagua: "乾",
                        description: "創造性と実行力の基盤システム（デフォルト）",
                        type: "Engine OS"
                    },
                    interfaceOS: {
                        hexagramId: 11,
                        hexagramName: "地天泰",
                        upperBagua: "坤",
                        lowerBagua: "乾",
                        description: "調和的な社会的コミュニケーションシステム（デフォルト）",
                        type: "Interface OS"
                    },
                    safeModeOS: {
                        hexagramId: 2,
                        hexagramName: "坤為地",
                        upperBagua: "坤",
                        lowerBagua: "坤",
                        description: "安定性重視の防御システム（デフォルト）",
                        type: "SafeMode OS"
                    },
                    integration: {
                        consistency: 50,
                        balance: 50,
                        integration: 50,
                        dataFlow: { isValid: false, error: "Default fallback mode" },
                        recommendations: [{
                            type: "system_recovery",
                            priority: "high",
                            title: "システム復旧",
                            description: "Triple OS分析でエラーが発生したため、デフォルト結果を表示しています",
                            action: "再度分析を実行するか、入力内容を確認してください"
                        }],
                        timestamp: Date.now(),
                        status: "fallback"
                    },
                    consistencyScore: 50,
                    balanceScore: 50,
                    HaQeiIntegration: 50,
                    recommendations: [{
                        type: "system_recovery",
                        priority: "high",
                        title: "システム復旧が必要",
                        description: "分析システムにエラーが発生しました。デフォルト結果を表示しています",
                        action: "ページを再読み込みして再度お試しください"
                    }],
                    validationStatus: "error",
                    timestamp: Date.now(),
                    errorMode: true
                };
            }
        }
        
        // 7. 状態管理システム
        class HaQeiState {
            constructor() {
                this.currentQuestion = 0;
                this.answers = [];
                this.userVector = {};
                this.tripleOSResults = null;
                this.isAnalyzing = false;
                
                // Phase 2-3: リアルタイム検証システム統合
                this.realTimeValidator = new RealTimeValidationSystem();
                this.lastValidation = null;
                
                this.loadState();
            }
            
            saveState() {
                try {
                    const state = {
                        currentQuestion: this.currentQuestion,
                        answers: this.answers,
                        userVector: this.userVector,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('haqei_state', JSON.stringify(state));
                } catch (error) {
                    console.warn('⚠️ Failed to save state:', error);
                }
            }
            
            loadState() {
                try {
                    const saved = localStorage.getItem('haqei_state');
                    if (saved) {
                        const state = JSON.parse(saved);
                        // 1時間以内のデータのみ復元
                        if (Date.now() - state.timestamp < 3600000) {
                            this.currentQuestion = state.currentQuestion || 0;
                            this.answers = state.answers || [];
                            this.userVector = state.userVector || {};
                        }
                    }
                } catch (error) {
                    console.warn('⚠️ Failed to load state:', error);
                }
            }
            
            clearState() {
                try {
                    localStorage.removeItem('haqei_state');
                } catch (error) {
                    console.warn('⚠️ Failed to clear state:', error);
                }
            }
            
            saveAnswer(questionIndex, selectedOption) {
                this.answers[questionIndex] = {
                    id: QUESTIONS[questionIndex].id,
                    questionId: QUESTIONS[questionIndex].id,
                    selectedOption: selectedOption,
                    timestamp: Date.now()
                };
                this.saveState();
                
                // Phase 2-3: リアルタイム検証実行
                this.runRealTimeValidation();
            }
            
            // リアルタイム検証実行
            runRealTimeValidation() {
                if (this.answers.length < 5) return; // 5問未満は検証しない
                
                try {
                    const validation = this.realTimeValidator.validateAnswerQuality(
                        this.answers.filter(answer => answer != null), 
                        this.currentQuestion
                    );
                    
                    if (validation) {
                        this.lastValidation = validation;
                        this.realTimeValidator.updateUI(validation);
                        
                        // リアルタイム検証パネルを表示（5問目以降）
                        if (this.answers.length >= 5) {
                            const validationPanel = document.getElementById('realtime-validation');
                            if (validationPanel) {
                                validationPanel.style.display = 'block';
                            }
                        }
                        
                        console.log(`📊 Real-time validation:`, {
                            question: this.currentQuestion + 1,
                            quality: `${(validation.overallQuality * 100).toFixed(0)}%`,
                            recommendations: validation.recommendations.length
                        });
                    }
                } catch (error) {
                    console.warn('⚠️ Real-time validation error:', error);
                }
            }
            
            getAnswer(questionIndex) {
                return this.answers[questionIndex] || null;
            }
        }
        
        // 8. アプリケーション制御
        class CriticalCSSAnalyzer {
            constructor() {
                this.state = new HaQeiState();
                this.tripleOSEngine = new TripleOSEngine();
                this.trigramScores = {};
                
                this.initializeTrigramScores();
                this.bindEvents();
                
                // 復元された状態があれば画面を表示
                if (this.state.currentQuestion > 0) {
                    this.showQuestion(this.state.currentQuestion);
                }
            }
            
            initializeTrigramScores() {
                for (let i = 1; i <= 8; i++) {
                    this.trigramScores[i] = 0;
                }
            }
            
            bindEvents() {
                try {
                    console.log('🔧 [OSAnalyzer] Binding events with safety checks');
                    
                    // 統一実装体制: DOM要素存在確認付きイベントバインディング
                    // thisのコンテキストを明示的にバインド
                    const eventBindings = [
                        { id: 'start-btn', event: 'click', handler: this.startAnalysis.bind(this) },
                        { id: 'prev-btn', event: 'click', handler: this.previousQuestion.bind(this) },
                        { id: 'next-btn', event: 'click', handler: this.nextQuestion.bind(this) },
                        { id: 'restart-analysis-btn', event: 'click', handler: this.restart.bind(this) },
                        { id: 'retry-btn', event: 'click', handler: this.restart.bind(this) }
                    ];
                    
                    let bindSuccessCount = 0;
                    let bindFailureCount = 0;
                    
                    // 安全なイベントバインディング実装
                    eventBindings.forEach(binding => {
                        const element = document.getElementById(binding.id);
                        if (element) {
                            element.addEventListener(binding.event, binding.handler);
                            console.log(`✅ [OSAnalyzer] Event bound: ${binding.id}`);
                            bindSuccessCount++;
                        } else {
                            console.warn(`⚠️ [OSAnalyzer] Element not found: ${binding.id}`);
                            bindFailureCount++;
                        }
                    });
                    
                    // キーボードナビゲーション（常に安全）
                    document.addEventListener('keydown', (e) => this.handleKeydown(e));
                    bindSuccessCount++;
                    
                    // 統一実装体制: バインディング結果レポート
                    console.log(`🎯 [OSAnalyzer] Event binding completed: ${bindSuccessCount} success, ${bindFailureCount} failures`);
                    
                    if (bindFailureCount > 0) {
                        console.warn(`⚠️ [OSAnalyzer] Some elements missing - UI may be incomplete`);
                    }
                    
                } catch (error) {
                    console.error('❌ [OSAnalyzer] Event binding failed:', error);
                    // エラーが発生してもアプリケーションは継続
                    this.handleOSAnalyzerError('EVENT_BINDING_ERROR', error.message);
                }
            }
            
            handleKeydown(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    const focused = document.activeElement;
                    if (focused.classList.contains('option')) {
                        e.preventDefault();
                        // キーボード選択時は、data-option-indexから実際のオプションデータを取得
                        const optionIndex = parseInt(focused.dataset.optionIndex || '0');
                        const currentQuestion = window.QUESTIONS[this.state.currentQuestion];
                        if (currentQuestion && currentQuestion.options[optionIndex]) {
                            this.selectOption(focused, currentQuestion.options[optionIndex]);
                        }
                    }
                }
            }
            
            startAnalysis() {
                console.log('🎯 [OSAnalyzer] Starting analysis - using ScreenManager');
                
                // 統一実装体制: ScreenManagerを使用した画面遷移
                if (typeof ScreenManager !== 'undefined') {
                    ScreenManager.switchToAccessible('question');
                } else {
                    // フォールバック: 直接的な画面切り替え
                    this.showScreen('question-screen');
                }
                
                this.showQuestion(0);
                this.announce('質問が開始されました');
            }
            
            showScreen(screenId) {
                document.querySelectorAll('.screen').forEach(screen => {
                    screen.classList.remove('active');
                });
                document.getElementById(screenId).classList.add('active');
            }
            
            showQuestion(index) {
                // 統一実装体制: 36問システム（window.QUESTIONS）を使用
                const questionArray = window.QUESTIONS || QUESTIONS;
                if (index >= questionArray.length) {
                    this.proceedToAnalysis();
                    return;
                }
                
                this.state.currentQuestion = index;
                this.showScreen('question-screen');
                const question = questionArray[index];
                
                // 進捗バー更新（36問システム対応）
                const progress = ((index + 1) / questionArray.length) * 100;
                document.getElementById('progress-fill').style.width = `${progress}%`;
                
                // 質問表示
                document.getElementById('question-number').textContent = index + 1;
                document.getElementById('question-title').textContent = question.text;
                
                // オプション表示
                const container = document.getElementById('options-container');
                container.innerHTML = '';
                
                question.options.forEach((option, optionIndex) => {
                    const optionElement = document.createElement('div');
                    optionElement.className = 'option';
                    optionElement.setAttribute('role', 'radio');
                    optionElement.setAttribute('aria-checked', 'false');
                    optionElement.setAttribute('tabindex', '0');
                    optionElement.setAttribute('data-option-index', optionIndex); // インデックスを保存
                    optionElement.innerHTML = `
                        <span class="option-text">${option.text}</span>
                    `;
                    
                    optionElement.addEventListener('click', () => {
                        console.log('🖱️ Option clicked, calling selectOption with:', { 
                            analyzer: window.criticalCSSAnalyzer,
                            thisContext: this,
                            option 
                        });
                        
                        // criticalCSSAnalyzerを明示的に使用
                        if (window.criticalCSSAnalyzer) {
                            window.criticalCSSAnalyzer.selectOption(optionElement, option);
                        } else {
                            console.error('❌ criticalCSSAnalyzer not found!');
                        }
                    });
                    container.appendChild(optionElement);
                });
                
                // 既存の回答があれば復元
                const existingAnswer = this.state.getAnswer(index);
                if (existingAnswer) {
                    const selectedOption = existingAnswer.selectedOption;
                    const optionElements = container.querySelectorAll('.option');
                    optionElements.forEach((elem, idx) => {
                        if (question.options[idx].value === selectedOption.value) {
                            elem.classList.add('selected');
                            elem.setAttribute('aria-checked', 'true');
                        }
                    });
                    document.getElementById('next-btn').disabled = false;
                }
                
                // ナビゲーションボタン更新
                document.getElementById('prev-btn').disabled = index === 0;
                if (!existingAnswer) {
                    document.getElementById('next-btn').disabled = true;
                }
                
                // 質問22以降での特別処理を削除（これが問題の原因だった）
                // イベントリスナーの置き換えが次ボタン問題を引き起こしていた
                
                this.announce(`質問${index + 1}: ${question.text}`);
            }
            
            selectOption(element, option) {
                try {
                    console.log('🎯 [OSAnalyzer] selectOption called:', { 
                        element, 
                        option,
                        currentQuestion: this.state?.currentQuestion,
                        hasState: !!this.state
                    });
                    
                    // 既存の選択を解除
                    element.parentNode.querySelectorAll('.option').forEach(opt => {
                        opt.classList.remove('selected');
                        opt.setAttribute('aria-checked', 'false');
                    });
                    
                    // 新しい選択を設定
                    element.classList.add('selected');
                    element.setAttribute('aria-checked', 'true');
                    
                    // 回答を保存（状態管理システム経由）
                    try {
                        this.state.saveAnswer(this.state.currentQuestion, option);
                    } catch (saveError) {
                        console.error('⚠️ [OSAnalyzer] Failed to save answer, using fallback:', saveError);
                        // フォールバック：直接配列に保存
                        if (!this.state.answers) {
                            this.state.answers = [];
                        }
                        this.state.answers[this.state.currentQuestion] = {
                            questionIndex: this.state.currentQuestion,
                            selectedOption: option,
                            timestamp: Date.now()
                        };
                    }
                    
                    // 次へボタンを有効化（エラー防止のため複数方法で試行）
                    const nextBtn = document.getElementById('next-btn');
                    if (nextBtn) {
                        // Method 1: 直接プロパティ設定
                        nextBtn.disabled = false;
                        // Method 2: 属性削除
                        nextBtn.removeAttribute('disabled');
                        console.log('✅ [OSAnalyzer] Next button enabled successfully');
                    } else {
                        console.error('❌ [OSAnalyzer] Next button not found!');
                    }
                    
                    // テキストの安全な取得
                    const optionText = option && option.text ? option.text : '選択されました';
                    this.announce(`選択されました: ${optionText}`);
                    
                    // 自動進行を削除（ユーザーが次へボタンを押すまで待つ）
                    // 質問23問題の修正：自動進行が原因で次ボタンが効かなくなっていた
                    console.log('📌 [OSAnalyzer] Waiting for user to click next button');
                    
                } catch (error) {
                    console.error('❌ [OSAnalyzer] selectOption error:', error);
                    // エラーが発生してもボタンは有効化を試みる
                    try {
                        const nextBtn = document.getElementById('next-btn');
                        if (nextBtn) {
                            nextBtn.disabled = false;
                            nextBtn.removeAttribute('disabled');
                        }
                    } catch (btnError) {
                        console.error('❌ [OSAnalyzer] Button enable fallback failed:', btnError);
                    }
                }
            }
            
            nextQuestion() {
                const questionArray = window.QUESTIONS || [];
                const currentIndex = this.state.currentQuestion;
                console.log(`📊 [OSAnalyzer] nextQuestion called: current=${currentIndex}, total=${questionArray.length}`);
                
                // 質問23デバッグ情報
                if (currentIndex === 22) {
                    console.log('🔍 [DEBUG] At question 23, checking state:', {
                        currentQuestion: this.state.currentQuestion,
                        totalQuestions: questionArray.length,
                        nextQuestion: questionArray[23] ? 'exists' : 'missing'
                    });
                }
                
                if (currentIndex < questionArray.length - 1) {
                    this.showQuestion(currentIndex + 1);
                } else {
                    console.log('🎉 [OSAnalyzer] All questions completed, proceeding to analysis');
                    this.proceedToAnalysis();
                }
            }
            
            previousQuestion() {
                if (this.state.currentQuestion > 0) {
                    this.showQuestion(this.state.currentQuestion - 1);
                }
            }
            
            async proceedToAnalysis() {
                // タイムアウト処理を追加（5秒後に強制完了）
                const analysisTimeout = setTimeout(() => {
                    if (this.state.isAnalyzing) {
                        console.warn('⚠️ Analysis timeout - forcing completion');
                        this.state.isAnalyzing = false;
                        // 最小限の結果を表示
                        this.showMinimalResults();
                    }
                }, 5000);
                
                try {
                    this.showScreen('analysis-screen');
                    this.announce('分析を開始しています');
                    this.state.isAnalyzing = true;
                    
                    // Triple OS分析を実行
                    await this.delay(1500); // UI演出
                    
                    // 回答データの変換
                    const allAnswers = this.state.answers.filter(answer => answer && answer.selectedOption);
                    console.log(`📊 [DEBUG] Collected ${allAnswers.length} answers from ${this.state.answers.length} total`);
                    
                    // 36問すべて回答されているか確認
                    if (allAnswers.length < 36) {
                        console.warn(`⚠️ Only ${allAnswers.length}/36 answers collected. Missing questions:`, 
                            Array.from({length: 36}, (_, i) => i)
                                .filter(i => !this.state.answers[i] || !this.state.answers[i].selectedOption));
                    }
                    
                    // Triple OSエンジンによる分析
                    console.log('🔍 [DEBUG] Starting Triple OS analysis with', allAnswers.length, 'answers');
                    
                    // tripleOSEngineが存在しない場合は作成
                    if (!this.tripleOSEngine) {
                        console.log('⚠️ tripleOSEngine not found, creating new instance');
                        this.tripleOSEngine = new TripleOSEngine();
                    }
                    
                    const tripleOSResults = await this.tripleOSEngine.analyzeTripleOS(allAnswers);
                    console.log('📊 [DEBUG] Triple OS results:', tripleOSResults);
                    
                    // タイムアウトをクリア（正常完了）
                    clearTimeout(analysisTimeout);
                    
                    // 結果を状態に保存
                    this.state.tripleOSResults = tripleOSResults;
                    
                    // P1-1: Triple OS結果をローカルストレージに保存
                    this.saveTripleOSToStorage(tripleOSResults);
                    
                    // 結果表示
                    this.showResults(tripleOSResults);
                    
                } catch (error) {
                    console.error('❌ Analysis failed:', error);
                    clearTimeout(analysisTimeout);
                    this.state.isAnalyzing = false;
                    this.showRecoverableError(error);
                }
            }
            
            // タイムアウト時の最小限結果表示
            showMinimalResults() {
                const fallbackResults = {
                    engineOS: { 
                        hexagramId: 1, 
                        hexagramName: '乾為天', 
                        strength: 50,
                        description: '分析がタイムアウトしました',
                        baguaEnergies: { '乾': 50, '震': 30, '坎': 20 }
                    },
                    interfaceOS: { 
                        hexagramId: 2, 
                        hexagramName: '坤為地', 
                        strength: 50,
                        description: '分析がタイムアウトしました',
                        baguaEnergies: { '坤': 50, '巽': 30, '離': 20 }
                    },
                    safeModeOS: { 
                        hexagramId: 29, 
                        hexagramName: '坎為水', 
                        strength: 50,
                        description: '分析がタイムアウトしました',
                        baguaEnergies: { '坎': 50, '艮': 30, '兌': 20 }
                    },
                    consistencyScore: 50,
                    balanceScore: 50,
                    HaQeiIntegration: 50
                };
                
                this.showScreen('results-screen');
                const container = document.getElementById('os-cards-container');
                if (container) {
                    container.innerHTML = `
                        <div style="background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                            <h3 style="color: #fbbf24;">⚠️ 分析がタイムアウトしました</h3>
                            <p>分析処理に時間がかかっているため、基本的な結果のみ表示しています。</p>
                            <button onclick="location.reload()" style="background: #6366f1; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px;">
                                もう一度試す
                            </button>
                        </div>
                    `;
                }
                
                // 基本的なOSカードだけ表示
                this.renderBasicLayer(fallbackResults);
            }
            
            // エラー時の復旧可能な画面表示
            showRecoverableError(error) {
                this.showScreen('results-screen');
                const container = document.getElementById('results-screen');
                if (container) {
                    container.innerHTML = `
                        <div style="display: flex; justify-content: center; align-items: center; min-height: 400px;">
                            <div style="text-align: center; padding: 40px; background: rgba(239, 68, 68, 0.1); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 12px; max-width: 500px;">
                                <h2 style="color: #ef4444; margin-bottom: 20px;">
                                    🚨 分析中にエラーが発生しました
                                </h2>
                                <p style="color: #e5e7eb; margin-bottom: 15px;">
                                    申し訳ございません。分析処理中に問題が発生しました。
                                </p>
                                <p style="color: #94a3b8; font-size: 14px; margin-bottom: 30px;">
                                    エラー詳細: ${error.message || '不明なエラー'}
                                </p>
                                <div style="display: flex; gap: 10px; justify-content: center;">
                                    <button onclick="location.reload()" style="
                                        background: #6366f1;
                                        color: white;
                                        border: none;
                                        padding: 12px 24px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 16px;
                                    ">
                                        もう一度試す
                                    </button>
                                    <button onclick="window.criticalCSSAnalyzer && window.criticalCSSAnalyzer.restart ? window.criticalCSSAnalyzer.restart() : location.reload()" style="
                                        background: transparent;
                                        color: #6366f1;
                                        border: 2px solid #6366f1;
                                        padding: 12px 24px;
                                        border-radius: 6px;
                                        cursor: pointer;
                                        font-size: 16px;
                                    ">
                                        最初からやり直す
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            calculateTrigramScores() {
                this.initializeTrigramScores();
                
                this.answers.forEach(answer => {
                    if (answer && answer.trigrams) {
                        answer.trigrams.forEach(trigramId => {
                            this.trigramScores[trigramId]++;
                        });
                    }
                });
            }
            
            calculateOSScores() {
                const osScores = {};
                
                Object.keys(TRIPLE_OS).forEach(osName => {
                    const os = TRIPLE_OS[osName];
                    let score = 0;
                    
                    os.trigrams.forEach(trigramId => {
                        score += this.trigramScores[trigramId] || 0;
                    });
                    
                    const questionArray = window.QUESTIONS || [];
                    osScores[osName] = {
                        ...os,
                        score: score,
                        percentage: questionArray.length > 0 ? Math.round((score / (questionArray.length * 2)) * 100) : 0
                    };
                });
                
                return osScores;
            }
            
            // 結果表示システム（簡素化版）
            async showResults(tripleOSResults) {
                try {
                    // データ検証
                    if (!this.validateTripleOSResults(tripleOSResults)) {
                        throw new Error('Invalid or incomplete Triple OS results detected');
                    }

                    // 画面遷移
                    this.showScreen('results-screen');
                    
                    // まず1ページサマリーを表示（要素が存在する場合のみ）
                    const summaryView = document.getElementById('summary-view');
                    if (summaryView) {
                        const summary = this.generateOnePagerSummary(tripleOSResults);
                        const summaryHTML = this.renderOnePagerSummary(summary);
                        summaryView.innerHTML = summaryHTML;
                    } else {
                        console.warn('⚠️ summary-view element not found, skipping summary');
                    }
                    
                    // ペルソナ表現強化
                    const enhancedResults = this.enhancePersonaResults(tripleOSResults);
                
                // 詳細タブの初期化（折りたたまれている）
                this.initializeLayerNavigation();
                
                // 詳細セクションの内容（ユーザーが開いた時のため）
                this.renderBasicLayer(enhancedResults);
                this.renderDetailedLayer(enhancedResults);
                this.renderExpertLayer(enhancedResults);
                this.renderIntegratedLayer(enhancedResults);
                
                // 簡易アドバイス（サマリーに含まれる）
                // this.displayQuickAdvice(enhancedResults); // サマリーに統合
                
                // 理論的特性分析（詳細セクション内）
                // this.showTheoreticalCharacteristics(enhancedResults); // 詳細内に移動
                
                // レガシーサマリー（互換性のため残す）
                this.generateTripleOSSummary(enhancedResults);
                
                // データ保存
                this.saveResults(tripleOSResults);
                
                    // 🎉 アナウンス
                    this.announce('HaQei哲学に基づく革新的Triple OS分析が完了しました - 4層の複雑性をお楽しみください');
                    
                } catch (error) {
                    console.error('❌ Results display failed:', error);
                    this.showEnhancedErrorState(error);
                } finally {
                    // 🔄 状態クリーンアップ
                    this.state.isAnalyzing = false;
                    console.log('🔯 Revolutionary 4-Layer Results System Activated');
                }
            }
            
            // 4層ナビゲーションシステム初期化
            initializeLayerNavigation() {
                const tabBtns = document.querySelectorAll('.tab-btn');
                const layerContents = document.querySelectorAll('.layer-content');
                
                tabBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        const targetLayer = btn.getAttribute('data-layer');
                        
                        // アクティブタブ切り替え
                        tabBtns.forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        
                        // レイヤー表示切り替え
                        layerContents.forEach(content => {
                            content.classList.remove('active');
                            if (content.getAttribute('data-layer') === targetLayer) {
                                content.classList.add('active');
                            }
                        });
                        
                        // アナウンス
                        const layerNames = {
                            'basic': '基本層 - OSの概要',
                            'detailed': '詳細層 - 八卦エネルギー分析',
                            'expert': '専門層 - 64卦解釈システム',
                            'integrated': '統合層 - HaQei哲学統合'
                        };
                        this.announce(`${layerNames[targetLayer]}に切り替えました`);
                    });
                });
            }
            
            // 基本層: 改良されたOSカード + Triple OS相互関係可視化
            renderBasicLayer(tripleOSResults) {
                // OSカード表示
                let container = document.getElementById('os-cards-container');
                
                // コンテナが存在しない場合は results-screen 内に作成
                if (!container) {
                    console.warn('⚠️ os-cards-container not found, creating fallback');
                    const resultsScreen = document.getElementById('results-screen');
                    if (resultsScreen) {
                        container = document.createElement('div');
                        container.id = 'os-cards-container';
                        container.className = 'os-cards-container';
                        resultsScreen.appendChild(container);
                    } else {
                        console.error('❌ Cannot create OS cards container');
                        return;
                    }
                }
                
                container.innerHTML = '';
                
                // 改良されたOSカード生成
                const engineCard = this.createEnhancedOSCard('Engine OS', tripleOSResults.engineOS, '#6366f1');
                const interfaceCard = this.createEnhancedOSCard('Interface OS', tripleOSResults.interfaceOS, '#8b5cf6');
                const safeModeCard = this.createEnhancedOSCard('Safe Mode OS', tripleOSResults.safeModeOS, '#10b981');
                
                container.appendChild(engineCard);
                container.appendChild(interfaceCard);  
                container.appendChild(safeModeCard);
                
                // Triple OS相互関係可視化
                this.renderOSInteractionVisualization(tripleOSResults);
                
                // 動的バランス表示
                this.renderDynamicBalance(tripleOSResults);
                
                // Phase 3: 内的対話システム表示
                this.renderVirtualPersonaDialogue(tripleOSResults);
            }
            
            // 詳細層: 8次元ベクトル可視化 + 八卦エネルギー分析
            renderDetailedLayer(tripleOSResults) {
                // 8次元レーダーチャート
                this.render8DimensionalRadar(tripleOSResults);
                
                // 八卦エネルギーバランス分析
                this.renderTrigramEnergyAnalysis(tripleOSResults);
                
                // エネルギーフロー可視化
                this.renderEnergyFlowVisualization(tripleOSResults);
            }
            
            // 専門層: 64卦完全解釈システム
            renderExpertLayer(tripleOSResults) {
                // 詳細な卦分析
                this.renderDetailedHexagramAnalysis(tripleOSResults);
                
                // 変卦システム（OS Analyzerでは変化を扱わないため削除）
                // this.renderChangeHexagramSystem(tripleOSResults);
                
                // 古典的wisdom（卦辞・爻辞）
                this.renderClassicalWisdom(tripleOSResults);
            }
            
            // 統合層: HaQei哲学統合とパーソナライズド洞察
            renderIntegratedLayer(tripleOSResults) {
                // HaQei哲学統合wisdom
                this.renderHaQeiWisdom(tripleOSResults);
                
                // パーソナライズド洞察生成
                this.renderPersonalizedInsights(tripleOSResults);
                
                // 実践的戦略提案
                this.renderPracticalStrategies(tripleOSResults);
            }
            
            // 🔍 HaQei哲学: データ検証メソッド
            validateTripleOSResults(results) {
                console.log('🔍 Validating Triple OS results:', results);
                
                if (!results) {
                    console.warn('⚠️ Results object is null or undefined');
                    return false;
                }
                
                const requiredOS = ['engineOS', 'interfaceOS', 'safeModeOS'];
                for (let osName of requiredOS) {
                    if (!results[osName]) {
                        console.warn(`⚠️ Missing ${osName} in results`);
                        return false;
                    }
                    
                    if (!results[osName].hexagramId || !results[osName].hexagramName) {
                        console.warn(`⚠️ Incomplete ${osName} data - missing hexagram info`);
                        return false;
                    }
                }
                
                console.log('✅ Triple OS results validation passed');
                return true;
            }
            
            // ✨ プログレッシブ表示システム（UX向上）
            async progressiveResultsDisplay() {
                const phases = [
                    { element: '.result-header', delay: 200, effect: 'fadeInUp' },
                    { element: '.complexity-tabs', delay: 400, effect: 'fadeInLeft' },
                    { element: '.layer-content', delay: 600, effect: 'fadeInRight' }
                ];
                
                for (let phase of phases) {
                    await this.delay(phase.delay);
                    const elements = document.querySelectorAll(phase.element);
                    elements.forEach(el => {
                        el.style.animation = `${phase.effect} 0.6s ease-out`;
                        el.style.opacity = '1';
                    });
                }
            }
            
            // 🚨 強化されたエラー表示システム
            showEnhancedErrorState(error) {
                const container = document.getElementById('os-cards-container');
                if (container) {
                    container.innerHTML = `
                        <div class="error-state-card" style="
                            background: linear-gradient(135deg, rgba(239, 68, 68, 0.1), rgba(239, 68, 68, 0.05));
                            border: 2px solid rgba(239, 68, 68, 0.3);
                            border-radius: var(--radius-lg);
                            padding: var(--space-xl);
                            text-align: center;
                            color: var(--primary-200);
                        ">
                            <h3 style="color: var(--error-500); margin-bottom: var(--space-md);">
                                🚨 分析結果の表示に問題が発生しました
                            </h3>
                            <p style="margin-bottom: var(--space-lg);">
                                Triple OS分析は完了していますが、結果の表示処理でエラーが発生しました。<br>
                                <small style="color: var(--primary-400);">エラー詳細: ${error.message}</small>
                            </p>
                            <button onclick="location.reload()" style="
                                background: var(--accent-500);
                                color: white;
                                border: none;
                                padding: var(--space-sm) var(--space-lg);
                                border-radius: var(--radius-md);
                                cursor: pointer;
                                font-size: var(--font-base);
                            ">
                                🔄 ページを再読み込み
                            </button>
                        </div>
                    `;
                }
                
                // システム管理者向けコンソール詳細ログ
                console.group('🔍 HaQei Error Analysis');
                console.error('Error:', error);
                console.error('Stack:', error.stack);
                console.error('State:', this.state);
                console.groupEnd();
            }

            // Triple OS相互関係の動的可視化 (Chart.js使用) - エラーハンドリング強化
            renderOSInteractionVisualization(tripleOSResults) {
                try {
                    // TripleOSInteractionAnalyzerを使用した高度な分析
                    if (typeof TripleOSInteractionAnalyzer !== 'undefined') {
                        const analyzer = new TripleOSInteractionAnalyzer({});
                        const engineOS = {
                            hexagramId: tripleOSResults.engineOS?.hexagramId || 1,
                            name: tripleOSResults.engineOS?.hexagram || '乾卦',
                            score: tripleOSResults.engineOS?.score || 0.5
                        };
                        const interfaceOS = {
                            hexagramId: tripleOSResults.interfaceOS?.hexagramId || 2,
                            name: tripleOSResults.interfaceOS?.hexagram || '坤卦',
                            score: tripleOSResults.interfaceOS?.score || 0.5
                        };
                        const safeModeOS = {
                            hexagramId: tripleOSResults.safeModeOS?.hexagramId || 29,
                            name: tripleOSResults.safeModeOS?.hexagram || '坎卦',
                            score: tripleOSResults.safeModeOS?.score || 0.5
                        };
                        
                        const analysisResult = analyzer.analyze(engineOS, interfaceOS, safeModeOS);
                        console.log('🔮 TripleOS分析結果:', analysisResult);
                        
                        // 分析結果をUIに反映
                        this.displayAnalysisResult(analysisResult);
                    }
                    
                    const canvas = document.getElementById('os-interaction-chart');
                    if (!canvas) {
                        console.warn('⚠️ Chart canvas not found');
                        return;
                    }
                const ctx = canvas.getContext('2d');
                
                // 既存のチャートを破棄
                if (this.osInteractionChart) {
                    this.osInteractionChart.destroy();
                }
                
                // 相互関係データの計算
                const interactionData = this.calculateOSInteractionData(tripleOSResults);
                
                this.osInteractionChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: [
                            'Engine→Interface影響度',
                            'Interface→SafeMode影響度', 
                            'SafeMode→Engine影響度',
                            'Engine自律性',
                            'Interface適応性',
                            'SafeMode安定性',
                            'システム統合度',
                            'バランス調和性'
                        ],
                        datasets: [{
                            label: 'Triple OS動的関係',
                            data: interactionData,
                            backgroundColor: 'rgba(99, 102, 241, 0.1)',
                            borderColor: 'rgba(99, 102, 241, 0.8)',
                            borderWidth: 3,
                            pointBackgroundColor: [
                                '#6366f1', '#8b5cf6', '#10b981', '#6366f1',
                                '#8b5cf6', '#10b981', '#a855f7', '#fbbf24'
                            ],
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: '#e2e8f0',
                                    font: { size: 14 }
                                }
                            }
                        },
                        scales: {
                            r: {
                                angleLines: {
                                    color: 'rgba(99, 102, 241, 0.3)'
                                },
                                grid: {
                                    color: 'rgba(99, 102, 241, 0.2)'
                                },
                                pointLabels: {
                                    color: '#cbd5e1',
                                    font: { size: 12 }
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    backdropColor: 'transparent'
                                }
                            }
                        }
                    }
                });
                } catch (error) {
                    console.error('❌ OSInteractionVisualization error:', error);
                }
            }
            
            // TripleOSInteractionAnalyzer分析結果表示
            displayAnalysisResult(analysisResult) {
                try {
                    const container = document.getElementById('dynamic-balance-display');
                    if (!container) return;
                    
                    // シナジー分析結果の表示
                    if (analysisResult.interactions && analysisResult.interactions.pair_insights) {
                        // 弱みが出やすいインターフェースの分析
                        const weaknessInterfaces = analysisResult.interactions.affordances ? `
                            <div style="background: rgba(239, 68, 68, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="color: var(--error-300); margin-bottom: 1rem;">⚠️ 弱みが出やすいインターフェース</h4>
                                <div style="display: grid; gap: 0.75rem;">
                                    ${analysisResult.interactions.affordances.engine?.struggles_with ? `
                                        <div style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 6px;">
                                            <strong style="color: #6366f1;">Engine OS:</strong>
                                            <ul style="margin: 0.5rem 0 0 1.5rem; color: #e5e7eb;">
                                                ${analysisResult.interactions.affordances.engine.struggles_with.map(item => 
                                                    `<li>${item}</li>`
                                                ).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${analysisResult.interactions.affordances.interface?.struggles_with ? `
                                        <div style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 6px;">
                                            <strong style="color: #8b5cf6;">Interface OS:</strong>
                                            <ul style="margin: 0.5rem 0 0 1.5rem; color: #e5e7eb;">
                                                ${analysisResult.interactions.affordances.interface.struggles_with.map(item => 
                                                    `<li>${item}</li>`
                                                ).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                    ${analysisResult.interactions.affordances.safe?.struggles_with ? `
                                        <div style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 6px;">
                                            <strong style="color: #10b981;">Safe Mode OS:</strong>
                                            <ul style="margin: 0.5rem 0 0 1.5rem; color: #e5e7eb;">
                                                ${analysisResult.interactions.affordances.safe.struggles_with.map(item => 
                                                    `<li>${item}</li>`
                                                ).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : '';
                        
                        const synergyHtml = `
                            <div style="background: rgba(99, 102, 241, 0.1); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                                <h4 style="color: var(--primary-200); margin-bottom: 1rem;">🔮 相互作用分析結果</h4>
                                <div style="display: grid; gap: 1rem;">
                                    ${analysisResult.interactions.pair_insights.map(insight => `
                                        <div style="background: rgba(255,255,255,0.05); padding: 0.75rem; border-radius: 6px;">
                                            <strong style="color: #fbbf24;">${insight.pair}:</strong>
                                            <span style="color: #e5e7eb;">${insight.summary || '分析中...'}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            ${weaknessInterfaces}
                        `;
                        
                        // 既存のコンテンツの前に挿入
                        const existingContent = container.innerHTML;
                        container.innerHTML = synergyHtml + existingContent;
                    }
                } catch (error) {
                    console.error('❌ Analysis result display error:', error);
                }
            }
            
            // 動的バランス表示
            renderDynamicBalance(tripleOSResults) {
                const balanceDisplay = document.getElementById('dynamic-balance-display');
                const balance = this.calculateDynamicBalance(tripleOSResults);
                
                balanceDisplay.innerHTML = `
                    <h4 style="color: var(--primary-100); margin-bottom: var(--space-md); text-align: center;">
                        🔄 動的バランス分析
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: var(--space-md);">
                        <div class="balance-metric">
                            <div class="metric-label">主導システム</div>
                            <div class="metric-value" style="color: ${balance.dominantColor};">${balance.dominantOS}</div>
                        </div>
                        <div class="balance-metric">
                            <div class="metric-label">システム協調度</div>
                            <div class="metric-value" style="color: var(--accent-400);">${balance.coordination}%</div>
                        </div>
                        <div class="balance-metric">
                            <div class="metric-label">適応柔軟性</div>
                            <div class="metric-value" style="color: var(--success-500);">${balance.flexibility}%</div>
                        </div>
                        <div class="balance-metric">
                            <div class="metric-label">ストレス耐性</div>
                            <div class="metric-value" style="color: var(--warning-500);">${balance.resilience}%</div>
                        </div>
                    </div>
                    <div style="margin-top: var(--space-md); padding: var(--space-md); background: rgba(99, 102, 241, 0.05); border-radius: var(--radius-md); border: 1px solid rgba(99, 102, 241, 0.2);">
                        <p style="color: var(--primary-200); line-height: 1.6;">
                            ${balance.analysis}
                        </p>
                    </div>
                `;
                
                // メトリクススタイル追加
                const style = document.createElement('style');
                style.textContent = `
                    .balance-metric {
                        text-align: center;
                        padding: var(--space-md);
                        background: rgba(15, 23, 42, 0.6);
                        border-radius: var(--radius-md);
                        border: 1px solid rgba(99, 102, 241, 0.2);
                    }
                    .metric-label {
                        font-size: var(--font-sm);
                        color: var(--primary-300);
                        margin-bottom: var(--space-xs);
                    }
                    .metric-value {
                        font-size: var(--font-lg);
                        font-weight: 700;
                    }
                `;
                document.head.appendChild(style);
            }
            
            // 🎨 改良されたOSカード作成システム（DAY 2 ペルソナ表現強化）
            createEnhancedOSCard(osName, osData, color) {
                const card = document.createElement('div');
                card.className = 'os-card card';
                card.style.setProperty('--card-color', color);
                card.style.borderColor = color + '40';
                
                // DAY 2: ペルソナ表現強化
                const persona = osData.persona || {};
                
                // HaQei準拠の表現（決定論的回避）
                const confidenceText = osName === 'Engine OS' ? 
                    'あなたの深層価値観として参考にしていただける' : 
                    osName === 'Interface OS' ?
                    '社会的な側面の一つの視点として' :
                    '困難な状況での対処パターンの一つとして';
                
                // エネルギー分布の可視化データ
                const energyData = osData.baguaEnergies || {};
                const energyBars = Object.entries(energyData).map(([trigram, energy]) => `
                    <div class="energy-bar">
                        <span class="energy-label">${trigram}</span>
                        <div class="energy-progress">
                            <div class="energy-fill" style="width: ${energy}%; background: ${color};"></div>
                        </div>
                        <span class="energy-value">${Math.round(energy)}%</span>
                    </div>
                `).join('');
                
                // ペルソナ特徴タグ生成
                const personaTraits = persona.traits ? persona.traits.map(trait => `
                    <span class="persona-trait-tag" style="background: ${persona.colors?.background || color + '20'}; color: ${persona.colors?.primary || color};">
                        ${trait}
                    </span>
                `).join('') : '';
                
                // ペルソナ情報セクション
                const personaSection = persona.name ? `
                    <div class="persona-info-section">
                        <div class="persona-header">
                            <span class="persona-symbol" style="font-size: 1.5em;">${persona.symbol || '⭐'}</span>
                            <h4 class="persona-name" style="color: ${persona.colors?.primary || color}; margin: 0 0 0 8px;">
                                ${persona.name}
                            </h4>
                        </div>
                        <p class="persona-metaphor" style="font-style: italic; color: var(--text-300); margin: 8px 0;">
                            ${persona.metaphor || ''}
                        </p>
                        <p class="persona-catchphrase" style="font-weight: 600; color: ${persona.colors?.primary || color}; margin: 8px 0;">
                            "${persona.catchphrase || ''}"
                        </p>
                        <div class="persona-traits-container" style="margin-top: 12px;">
                            ${personaTraits}
                        </div>
                        <div class="persona-strength-indicator" style="margin-top: 12px;">
                            <span style="color: var(--text-300); font-size: 0.9em;">表現強度: </span>
                            <span style="color: ${persona.colors?.primary || color}; font-weight: 600;">
                                ${persona.dominanceLevel === 'dominant' ? '非常に強い' :
                                  persona.dominanceLevel === 'strong' ? '強い' :
                                  persona.dominanceLevel === 'moderate' ? '適度' :
                                  persona.dominanceLevel === 'weak' ? '控えめ' : '潜在的'}
                            </span>
                        </div>
                    </div>
                ` : '';
                
                // 64卦IDと卦名を取得
                const hexagramId = osData.hexagramId || 1;
                const hexagramName = this.getHexagramName(hexagramId);
                
                // 実際の数値を計算（strengthまたはpercentageから）
                const osStrength = osData.strength || osData.percentage || 0;
                const displayPercentage = Math.round(osStrength);
                
                card.innerHTML = `
                    <div class="os-header">
                        <div class="os-name">${osName}</div>
                        <div class="os-percentage" style="font-size: 1.8em; font-weight: bold; color: ${color};">
                            ${displayPercentage}%
                        </div>
                        <div class="os-hexagram-info" style="display: flex; align-items: center; gap: 8px;">
                            <span style="background: ${color}20; color: ${color}; padding: 2px 8px; border-radius: 4px; font-weight: 600; font-size: 0.9em;">
                                #${hexagramId}
                            </span>
                            <span style="color: ${color}; font-weight: 500;">
                                ${hexagramName}
                            </span>
                        </div>
                    </div>
                    
                    <div class="os-description">${osData.description || 'システム分析中...'}</div>
                    
                    ${personaSection}
                    
                    <div class="os-energy-section">
                        <h5 style="color: var(--primary-200); margin-bottom: var(--space-sm); font-size: var(--font-sm);">
                            ☊ エネルギー分布
                        </h5>
                        <div class="energy-bars">
                            ${energyBars}
                        </div>
                    </div>
                    
                    <div class="os-meta">
                        <div style="color: var(--primary-400); font-size: var(--font-sm); line-height: 1.5;">
                            ${confidenceText}分析結果です
                        </div>
                        ${osData.catchphrase ? `
                            <div style="margin-top: var(--space-sm); font-style: italic; color: ${color}; font-weight: 500;">
                                "${osData.catchphrase}"
                            </div>
                        ` : ''}
                    </div>
                `;
                
                // エネルギーバースタイル + DAY 2 ペルソナスタイル追加
                if (!document.getElementById('persona-enhancement-styles')) {
                    const energyStyle = document.createElement('style');
                    energyStyle.id = 'persona-enhancement-styles';
                    energyStyle.textContent = `
                        /* DAY 2: ペルソナ表現強化スタイル */
                        .persona-info-section {
                            margin: 16px 0;
                            padding: 16px;
                            background: linear-gradient(135deg, rgba(15, 23, 42, 0.5), rgba(30, 41, 59, 0.3));
                            border-radius: 12px;
                            border: 1px solid var(--border-color);
                        }
                        
                        .persona-header {
                            display: flex;
                            align-items: center;
                            margin-bottom: 12px;
                        }
                        
                        .persona-symbol {
                            font-size: 1.5em;
                            margin-right: 8px;
                        }
                        
                        .persona-name {
                            font-size: 1.1em;
                            font-weight: 700;
                            margin: 0;
                        }
                        
                        .persona-metaphor {
                            font-style: italic;
                            color: var(--text-300);
                            margin: 8px 0;
                            opacity: 0.85;
                        }
                        
                        .persona-catchphrase {
                            font-weight: 600;
                            margin: 8px 0;
                            padding: 8px 12px;
                            background: rgba(255, 255, 255, 0.05);
                            border-radius: 6px;
                            border-left: 3px solid currentColor;
                        }
                        
                        .persona-traits-container {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 6px;
                            margin-top: 12px;
                        }
                        
                        .persona-trait-tag {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 0.85em;
                            font-weight: 500;
                            white-space: nowrap;
                        }
                        
                        .persona-strength-indicator {
                            margin-top: 12px;
                            padding: 8px 12px;
                            background: rgba(0, 0, 0, 0.2);
                            border-radius: 6px;
                            font-size: 0.9em;
                        }
                        
                        /* エネルギーバーシステム */
                    .os-energy-section {
                        margin: var(--space-md) 0;
                        padding: var(--space-sm);
                        background: rgba(15, 23, 42, 0.4);
                        border-radius: var(--radius-sm);
                    }
                    .energy-bars {
                        display: flex;
                        flex-direction: column;
                        gap: var(--space-xs);
                    }
                    .energy-bar {
                        display: flex;
                        align-items: center;
                        gap: var(--space-sm);
                        font-size: var(--font-sm);
                    }
                    .energy-label {
                        min-width: 3rem;
                        color: var(--primary-300);
                        font-weight: 500;
                    }
                    .energy-progress {
                        flex: 1;
                        height: 8px;
                        background: rgba(15, 23, 42, 0.8);
                        border-radius: 4px;
                        overflow: hidden;
                    }
                    .energy-fill {
                        height: 100%;
                        border-radius: 4px;
                        transition: width 0.8s ease;
                    }
                    .energy-value {
                        min-width: 2.5rem;
                        text-align: right;
                        color: var(--primary-200);
                        font-weight: 600;
                    }
                `;
                document.head.appendChild(energyStyle);
                }
                
                return card;
            }
            
            // 🔢 OS相互関係データ計算
            calculateOSInteractionData(tripleOSResults) {
                const { engineOS, interfaceOS, safeModeOS, integration } = tripleOSResults;
                
                // 相互関係強度計算（8次元分析）
                return [
                    this.calculateInfluenceStrength(engineOS, interfaceOS),     // Engine→Interface
                    this.calculateInfluenceStrength(interfaceOS, safeModeOS),  // Interface→SafeMode  
                    this.calculateInfluenceStrength(safeModeOS, engineOS),     // SafeMode→Engine
                    this.calculateAutonomyIndex(engineOS),                     // Engine自律性
                    this.calculateAdaptabilityIndex(interfaceOS),              // Interface適応性
                    this.calculateStabilityIndex(safeModeOS),                  // SafeMode安定性
                    integration?.consistency || 75,                            // システム統合度
                    integration?.balance || 70                                 // バランス調和性
                ];
            }
            
            calculateInfluenceStrength(sourceOS, targetOS) {
                const sourceEnergies = sourceOS.baguaEnergies || {};
                const targetEnergies = targetOS.baguaEnergies || {};
                
                // 共通八卦の重複度から相互影響を計算
                let totalInfluence = 0;
                let commonTrigrams = 0;
                
                Object.keys(sourceEnergies).forEach(trigram => {
                    if (targetEnergies[trigram]) {
                        totalInfluence += Math.min(sourceEnergies[trigram], targetEnergies[trigram]);
                        commonTrigrams++;
                    }
                });
                
                return commonTrigrams > 0 ? Math.round(totalInfluence / commonTrigrams) : 50;
            }
            
            calculateAutonomyIndex(engineOS) {
                const energies = engineOS.baguaEnergies || {};
                const maxEnergy = Math.max(...Object.values(energies));
                const avgEnergy = Object.values(energies).reduce((a, b) => a + b, 0) / Object.keys(energies).length;
                return Math.round((maxEnergy / avgEnergy) * 15); // 自律性指標
            }
            
            calculateAdaptabilityIndex(interfaceOS) {
                const energies = interfaceOS.baguaEnergies || {};
                const variance = this.calculateVariance(Object.values(energies));
                return Math.round(Math.max(30, 100 - variance)); // 適応性指標
            }
            
            calculateStabilityIndex(safeModeOS) {
                const energies = safeModeOS.baguaEnergies || {};
                const stability = Object.values(energies).reduce((acc, val) => acc + (val > 60 ? val : 0), 0);
                return Math.round(stability / Object.keys(energies).length);
            }
            
            calculateVariance(values) {
                if (!values || values.length === 0) return 0;
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                return Math.sqrt(values.reduce((sq, n) => sq + Math.pow(n - mean, 2), 0) / values.length);
            }
            
            // 🌊 動的バランス計算
            calculateDynamicBalance(tripleOSResults) {
                const { engineOS, interfaceOS, safeModeOS, integration } = tripleOSResults;
                
                // 各OSの強度計算
                const engineStrength = this.calculateOSStrength(engineOS);
                const interfaceStrength = this.calculateOSStrength(interfaceOS);
                const safeModeStrength = this.calculateOSStrength(safeModeOS);
                
                // 主導システム特定
                const strengths = {
                    'Engine OS': { value: engineStrength, color: '#6366f1' },
                    'Interface OS': { value: interfaceStrength, color: '#8b5cf6' },
                    'Safe Mode OS': { value: safeModeStrength, color: '#10b981' }
                };
                
                const dominantOS = Object.keys(strengths).reduce((a, b) => 
                    strengths[a].value > strengths[b].value ? a : b
                );
                
                // バランス指標計算
                const coordination = Math.round(integration?.consistency || 
                    (100 - Math.abs(engineStrength - interfaceStrength) - Math.abs(interfaceStrength - safeModeStrength)));
                
                const flexibility = Math.round(
                    (interfaceStrength + (100 - Math.max(engineStrength, safeModeStrength))) / 2
                );
                
                const resilience = Math.round(
                    (safeModeStrength + coordination) / 2
                );
                
                // 分析文生成
                const analysis = this.generateBalanceAnalysis(dominantOS, coordination, flexibility, resilience);
                
                return {
                    dominantOS,
                    dominantColor: strengths[dominantOS].color,
                    coordination,
                    flexibility, 
                    resilience,
                    analysis
                };
            }
            
            calculateOSStrength(osData) {
                const energies = osData.baguaEnergies || {};
                const values = Object.values(energies);
                if (values.length === 0) return 0;
                return Math.round(
                    values.reduce((sum, energy) => sum + energy, 0) / 
                    values.length
                );
            }
            
            generateBalanceAnalysis(dominantOS, coordination, flexibility, resilience) {
                const insights = {
                    'Engine OS': `価値観システムが主導的です。あなたは内的な信念や価値観に基づいて行動する傾向が強く、一貫性のある判断を行います。`,
                    'Interface OS': `社会的システムが主導的です。他者との関係性や状況に応じた柔軟な対応を得意とし、環境に適応しながら成長していきます。`,
                    'Safe Mode OS': `防御システムが主導的です。安定性と安全性を重視し、慎重な判断を行いながらリスクを最小化する傾向があります。`
                };
                
                let analysis = insights[dominantOS];
                
                if (coordination > 80) {
                    analysis += ` 3つのシステムの協調性が非常に高く、統合された人格として機能しています。`;
                } else if (coordination < 60) {
                    analysis += ` システム間の調整に改善の余地があります。各OSの特性を理解し、バランスを取ることで更なる成長が期待できます。`;
                }
                
                return analysis;
            }
            
            createOSCard(osName, osData, color) {
                // 後方互換性のため、新しいcreateEnhancedOSCardを呼び出し
                return this.createEnhancedOSCard(osName, osData, color);
            }
            
            // 📊 8次元ベクトル可視化システム (Chart.js)
            render8DimensionalRadar(tripleOSResults) {
                const canvas = document.getElementById('8d-vector-chart');
                const ctx = canvas.getContext('2d');
                
                // 既存のチャートを破棄
                if (this.vectorChart) {
                    this.vectorChart.destroy();
                }
                
                // 8次元データの統合
                const vectorData = this.calculate8DimensionalVector(tripleOSResults);
                
                this.vectorChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: [
                            '乾_創造性', '震_行動性', '坎_探求性', '艮_安定性',
                            '坤_受容性', '巽_適応性', '離_表現性', '兌_調和性'
                        ],
                        datasets: [
                            {
                                label: 'Engine OS (価値観)',
                                data: vectorData.engine,
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                borderColor: 'rgba(99, 102, 241, 0.8)',
                                borderWidth: 2,
                                pointBackgroundColor: '#6366f1'
                            },
                            {
                                label: 'Interface OS (社会性)',
                                data: vectorData.interface,
                                backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                borderColor: 'rgba(139, 92, 246, 0.8)',
                                borderWidth: 2,
                                pointBackgroundColor: '#8b5cf6'
                            },
                            {
                                label: 'Safe Mode OS (防御)',
                                data: vectorData.safeMode,
                                backgroundColor: 'rgba(16, 185, 129, 0.1)',
                                borderColor: 'rgba(16, 185, 129, 0.8)',
                                borderWidth: 2,
                                pointBackgroundColor: '#10b981'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: '#e2e8f0',
                                    font: { size: 12 },
                                    padding: 15
                                }
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                min: 0,
                                max: 100,
                                angleLines: {
                                    color: 'rgba(139, 92, 246, 0.3)'
                                },
                                grid: {
                                    color: 'rgba(139, 92, 246, 0.2)'
                                },
                                pointLabels: {
                                    color: '#cbd5e1',
                                    font: { size: 11 }
                                },
                                ticks: {
                                    color: '#94a3b8',
                                    backdropColor: 'transparent',
                                    stepSize: 20
                                }
                            }
                        }
                    }
                });
            }
            
            // 8次元ベクトルデータ計算
            calculate8DimensionalVector(tripleOSResults) {
                const { engineOS, interfaceOS, safeModeOS } = tripleOSResults;
                
                return {
                    engine: this.extractTrigramVector(engineOS.baguaEnergies),
                    interface: this.extractTrigramVector(interfaceOS.baguaEnergies),
                    safeMode: this.extractTrigramVector(safeModeOS.baguaEnergies)
                };
            }
            
            extractTrigramVector(baguaEnergies) {
                const orderedTrigrams = ['乾', '震', '坎', '艮', '坤', '巽', '離', '兌'];
                if (!baguaEnergies) {
                    console.warn('baguaEnergies is undefined, returning zero vector');
                    return orderedTrigrams.map(() => 0);
                }
                return orderedTrigrams.map(trigram => baguaEnergies[trigram] || 0);
            }
            
            // 🔥 八卦エネルギーバランス分析
            renderTrigramEnergyAnalysis(tripleOSResults) {
                const container = document.getElementById('trigram-balance-analysis');
                container.innerHTML = '';
                
                const allTrigrams = ['乾', '兌', '離', '震', '巽', '坎', '艮', '坤'];
                const trigramDescriptions = {
                    '乾': '創造性・リーダーシップ・革新',
                    '兌': '調和性・コミュニケーション・喜び',
                    '離': '表現性・知性・美的感覚',
                    '震': '行動力・決断力・エネルギー',
                    '巽': '適応性・柔軟性・持続力',
                    '坎': '探究心・深層思考・洞察力',
                    '艮': '安定性・慎重性・集中力',
                    '坤': '受容性・協調性・支援力'
                };
                
                allTrigrams.forEach((trigram, index) => {
                    const engineEnergy = tripleOSResults.engineOS.baguaEnergies?.[trigram] || 0;
                    const interfaceEnergy = tripleOSResults.interfaceOS.baguaEnergies?.[trigram] || 0;
                    const safeModeEnergy = tripleOSResults.safeModeOS.baguaEnergies?.[trigram] || 0;
                    
                    const maxEnergy = Math.max(engineEnergy, interfaceEnergy, safeModeEnergy);
                    const dominantOS = maxEnergy === engineEnergy ? 'Engine' : 
                                     maxEnergy === interfaceEnergy ? 'Interface' : 'SafeMode';
                    
                    const card = document.createElement('div');
                    card.className = 'trigram-card';
                    card.innerHTML = `
                        <div class="trigram-name">${trigram}</div>
                        <div class="trigram-energy-value">${Math.round(maxEnergy)}%</div>
                        <div class="trigram-description">${trigramDescriptions[trigram]}</div>
                        <div style="margin-top: var(--space-sm); font-size: var(--font-sm); color: var(--accent-400);">
                            主導: ${dominantOS} OS
                        </div>
                        <div class="trigram-breakdown" style="margin-top: var(--space-sm);">
                            <div style="display: flex; justify-content: space-between; font-size: var(--font-sm);">
                                <span style="color: #6366f1;">E: ${Math.round(engineEnergy)}%</span>
                                <span style="color: #8b5cf6;">I: ${Math.round(interfaceEnergy)}%</span>
                                <span style="color: #10b981;">S: ${Math.round(safeModeEnergy)}%</span>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(card);
                });
            }
            
            // 🌊 エネルギーフロー可視化
            renderEnergyFlowVisualization(tripleOSResults) {
                const container = document.getElementById('energy-flow-visualization');
                
                const flowData = this.calculateEnergyFlow(tripleOSResults);
                
                container.innerHTML = `
                    <div class="flow-diagram">
                        <div class="flow-node engine-node">
                            <h5>Engine OS</h5>
                            <div class="node-strength">${flowData.engine.strength}%</div>
                            <div class="node-flow out" style="--flow-strength: ${flowData.engine.outflow}%;">
                                → Interface (${flowData.engine.outflow}%)
                            </div>
                        </div>
                        
                        <div class="flow-node interface-node">
                            <h5>Interface OS</h5>
                            <div class="node-strength">${flowData.interface.strength}%</div>
                            <div class="node-flow out" style="--flow-strength: ${flowData.interface.outflow}%;">
                                → SafeMode (${flowData.interface.outflow}%)
                            </div>
                        </div>
                        
                        <div class="flow-node safemode-node">
                            <h5>Safe Mode OS</h5>
                            <div class="node-strength">${flowData.safeMode.strength}%</div>
                            <div class="node-flow out" style="--flow-strength: ${flowData.safeMode.outflow}%;">
                                → Engine (${flowData.safeMode.outflow}%)
                            </div>
                        </div>
                    </div>
                    
                    <div class="flow-insights" style="margin-top: var(--space-lg);">
                        <h5 style="color: var(--primary-100); margin-bottom: var(--space-md);">
                            💫 エネルギーフロー洞察
                        </h5>
                        <div style="color: var(--primary-200); line-height: 1.6;">
                            ${flowData.insights}
                        </div>
                    </div>
                `;
                
                // フロー図スタイル追加
                const flowStyle = document.createElement('style');
                flowStyle.textContent = `
                    .flow-diagram {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: var(--space-lg);
                        margin-bottom: var(--space-lg);
                    }
                    .flow-node {
                        text-align: center;
                        padding: var(--space-lg);
                        border-radius: var(--radius-md);
                        border: 2px solid;
                        position: relative;
                    }
                    .engine-node { border-color: #6366f1; background: rgba(99, 102, 241, 0.05); }
                    .interface-node { border-color: #8b5cf6; background: rgba(139, 92, 246, 0.05); }
                    .safemode-node { border-color: #10b981; background: rgba(16, 185, 129, 0.05); }
                    
                    .node-strength {
                        font-size: var(--font-xl);
                        font-weight: 700;
                        margin: var(--space-sm) 0;
                    }
                    .node-flow {
                        font-size: var(--font-sm);
                        color: var(--primary-300);
                        margin-top: var(--space-sm);
                        position: relative;
                        overflow: hidden;
                    }
                `;
                document.head.appendChild(flowStyle);
            }
            
            calculateEnergyFlow(tripleOSResults) {
                const engineStrength = this.calculateOSStrength(tripleOSResults.engineOS);
                const interfaceStrength = this.calculateOSStrength(tripleOSResults.interfaceOS);
                const safeModeStrength = this.calculateOSStrength(tripleOSResults.safeModeOS);
                
                // 相互影響度計算
                const engineToInterface = this.calculateInfluenceStrength(tripleOSResults.engineOS, tripleOSResults.interfaceOS);
                const interfaceToSafeMode = this.calculateInfluenceStrength(tripleOSResults.interfaceOS, tripleOSResults.safeModeOS);
                const safeModeToEngine = this.calculateInfluenceStrength(tripleOSResults.safeModeOS, tripleOSResults.engineOS);
                
                const insights = this.generateFlowInsights(
                    engineStrength, interfaceStrength, safeModeStrength,
                    engineToInterface, interfaceToSafeMode, safeModeToEngine
                );
                
                return {
                    engine: { strength: engineStrength, outflow: engineToInterface },
                    interface: { strength: interfaceStrength, outflow: interfaceToSafeMode },
                    safeMode: { strength: safeModeStrength, outflow: safeModeToEngine },
                    insights
                };
            }
            
            generateFlowInsights(eStr, iStr, sStr, eToi, iToS, sToE) {
                let insights = [];
                
                if (eToi > 70) {
                    insights.push("価値観システムが社会的表現に強く影響しています");
                }
                if (iToS > 70) {
                    insights.push("社会的経験が防御システムの形成に大きく関与しています");
                }
                if (sToE > 70) {
                    insights.push("防御メカニズムが価値観の再構築を促しています");
                }
                
                const totalFlow = eToi + iToS + sToE;
                if (totalFlow > 210) {
                    insights.push("3つのシステム間で活発な相互作用が行われています");
                } else if (totalFlow < 150) {
                    insights.push("システム間の連携に改善の余地があります");
                }
                
                return insights.length > 0 ? insights.join('。') + '。' : 
                    'バランスの取れたエネルギーフローを保っています。';
            }
            
            // ☯ 専門層: 64卦完全解釈システム
            renderDetailedHexagramAnalysis(tripleOSResults) {
                const container = document.getElementById('hexagram-detailed-analysis');
                container.innerHTML = '';
                
                const systems = [
                    { name: 'Engine OS', data: tripleOSResults.engineOS, color: '#6366f1' },
                    { name: 'Interface OS', data: tripleOSResults.interfaceOS, color: '#8b5cf6' },
                    { name: 'Safe Mode OS', data: tripleOSResults.safeModeOS, color: '#10b981' }
                ];
                
                systems.forEach(system => {
                    const hexagramCard = document.createElement('div');
                    hexagramCard.className = 'hexagram-card';
                    
                    // 詳細な卦情報取得
                    const hexagramDetails = this.getDetailedHexagramInfo(system.data.hexagramId);
                    
                    hexagramCard.innerHTML = `
                        <div class="hexagram-title" style="color: ${system.color};">
                            ${system.name} - ${system.data.hexagramName}
                        </div>
                        <div class="hexagram-content">
                            <div class="hexagram-meta" style="margin-bottom: var(--space-md);">
                                <strong>卦番号:</strong> ${system.data.hexagramId}番<br>
                                <strong>上卦:</strong> ${system.data.primaryTrigram} | 
                                <strong>下卦:</strong> ${system.data.secondaryTrigram}
                            </div>
                            
                            <div class="hexagram-description" style="margin-bottom: var(--space-md);">
                                ${hexagramDetails.detailedDescription}
                            </div>
                            
                            <div class="trigram-composition" style="margin-bottom: var(--space-md);">
                                <h6 style="color: var(--primary-100); margin-bottom: var(--space-sm);">八卦構成分析</h6>
                                <div style="color: var(--primary-200); font-size: var(--font-sm);">
                                    ${hexagramDetails.trigramAnalysis}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    container.appendChild(hexagramCard);
                });
            }
            
            // 🔄 変卦システム - 成長方向性
            renderChangeHexagramSystem(tripleOSResults) {
                const container = document.getElementById('change-hexagram-display');
                
                const changeSystemData = this.calculateChangeHexagrams(tripleOSResults);
                
                container.innerHTML = `
                    <div class="change-hexagram-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-lg);">
                        ${changeSystemData.map(change => `
                            <div class="change-card" style="background: rgba(251, 191, 36, 0.08); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: var(--radius-md); padding: var(--space-lg);">
                                <h6 style="color: #fbbf24; margin-bottom: var(--space-md);">
                                    ${change.fromOS} の変化
                                </h6>
                                <div style="color: var(--primary-200); margin-bottom: var(--space-md);">
                                    <strong>${change.currentHexagram}</strong> → <strong>${change.futureHexagram}</strong>
                                </div>
                                <div style="color: var(--primary-200); font-size: var(--font-sm); line-height: 1.6;">
                                    ${change.changeAnalysis}
                                </div>
                                <div style="margin-top: var(--space-md); padding: var(--space-sm); background: rgba(251, 191, 36, 0.05); border-radius: var(--radius-sm);">
                                    <strong style="color: #fbbf24;">成長方向:</strong>
                                    <div style="color: var(--primary-200); font-size: var(--font-sm); margin-top: var(--space-xs);">
                                        ${change.growthDirection}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
            
            // 📜 古典的wisdom - 卦辞・爻辞
            renderClassicalWisdom(tripleOSResults) {
                const container = document.getElementById('classical-wisdom-display');
                
                const wisdomData = this.extractClassicalWisdom(tripleOSResults);
                
                container.innerHTML = `
                    <div class="classical-wisdom">
                        <h6 style="color: #fbbf24; margin-bottom: var(--space-lg); text-align: center;">
                            易経古典 - あなたへの智慧
                        </h6>
                        
                        <div class="wisdom-sections" style="display: flex; flex-direction: column; gap: var(--space-lg);">
                            ${wisdomData.map(wisdom => `
                                <div class="wisdom-section" style="border-left: 4px solid #fbbf24; padding-left: var(--space-lg);">
                                    <h6 style="color: var(--primary-100); margin-bottom: var(--space-sm);">
                                        ${wisdom.system} - ${wisdom.hexagramName}
                                    </h6>
                                    <div class="kua-ci" style="margin-bottom: var(--space-md);">
                                        <strong>卦辞:</strong> "${wisdom.guaCi}"
                                    </div>
                                    <div class="yao-ci" style="margin-bottom: var(--space-md);">
                                        <strong>爻辞 (重要な爻):</strong> "${wisdom.yaoCi}"
                                    </div>
                                    <div class="modern-interpretation" style="background: rgba(251, 191, 36, 0.05); padding: var(--space-md); border-radius: var(--radius-sm);">
                                        <strong>現代的解釈:</strong><br>
                                        ${wisdom.modernInterpretation}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // 🔯 HaQei哲学統合
            renderHaQeiWisdom(tripleOSResults) {
                const container = document.getElementById('HaQei-wisdom-display');
                
                const HaQeiAnalysis = this.generateHaQeiAnalysis(tripleOSResults);
                
                container.innerHTML = `
                    ${HaQeiAnalysis.philosophicalIntegration}
                    
                    <div style="margin-top: var(--space-lg); padding: var(--space-lg); background: rgba(16, 185, 129, 0.05); border-radius: var(--radius-md); border: 1px solid rgba(16, 185, 129, 0.2);">
                        <h6 style="color: var(--success-500); margin-bottom: var(--space-md);">
                            🎯 戦略的自己理解のポイント
                        </h6>
                        <ul style="color: var(--primary-200); line-height: 1.6; padding-left: var(--space-lg);">
                            ${HaQeiAnalysis.strategicPoints.map(point => `<li style="margin-bottom: var(--space-sm);">${point}</li>`).join('')}
                        </ul>
                    </div>
                `;
            }
            
            // 💡 パーソナライズド洞察生成
            renderPersonalizedInsights(tripleOSResults) {
                const insights = this.generatePersonalizedInsights(tripleOSResults);
                
                // 成長方向性
                document.getElementById('growth-directions').innerHTML = `
                    <div class="insight-title">🌱 成長方向性</div>
                    <div class="insight-content">${insights.growthDirections}</div>
                `;
                
                // 最適化戦略
                document.getElementById('optimization-strategies').innerHTML = `
                    <div class="insight-title">⚡ 最適化戦略</div>
                    <div class="insight-content">${insights.optimizationStrategies}</div>
                `;
                
                // ストレス管理
                document.getElementById('stress-management').innerHTML = `
                    <div class="insight-title">🛡️ ストレス管理</div>
                    <div class="insight-content">${insights.stressManagement}</div>
                `;
                
                // 比較分析
                document.getElementById('comparative-analysis').innerHTML = `
                    <div class="insight-title">📊 比較分析</div>
                    <div class="insight-content">${insights.comparativeAnalysis}</div>
                `;
            }
            
            // 🎯 実践的戦略提案
            renderPracticalStrategies(tripleOSResults) {
                const container = document.getElementById('practical-strategies');
                const strategies = this.generatePracticalStrategies(tripleOSResults);
                
                container.innerHTML = strategies.map(strategy => `
                    <div class="strategy-item">
                        <div class="strategy-title">
                            ${strategy.icon} ${strategy.title}
                        </div>
                        <div class="strategy-description">
                            ${strategy.description}
                        </div>
                        <div class="strategy-actions">
                            ${strategy.actions.map(action => `
                                <span class="strategy-action">${action}</span>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
            
            // ヘルパー関数群
            getDetailedHexagramInfo(hexagramId) {
                // 簡単な実装 - 実際にはHEXAGRAMSデータベースから詳細を取得
                return {
                    detailedDescription: `この卦は人生における重要な局面を表し、内的な成長と外的な変化の調和を示唆しています。あなたの人格システムの${hexagramId}番目の側面として、特別な意味を持ちます。`,
                    trigramAnalysis: `上卦と下卦の組み合わせが、あなたの内的エネルギーと外的表現の関係性を物語っています。これは動的なバランスの中で発揮される、あなた固有の能力パターンです。`
                };
            }
            
            calculateChangeHexagrams(tripleOSResults) {
                // 変卦計算の簡単な実装
                return [
                    {
                        fromOS: 'Engine OS',
                        currentHexagram: tripleOSResults.engineOS.hexagramName,
                        futureHexagram: this.calculateFutureHexagram(tripleOSResults.engineOS),
                        changeAnalysis: '内的価値観システムは、より統合された形へと発展していく可能性を秘めています。',
                        growthDirection: '自己理解を深め、価値観の一貫性を高めることで、より力強い表現が可能になります。'
                    },
                    {
                        fromOS: 'Interface OS', 
                        currentHexagram: tripleOSResults.interfaceOS.hexagramName,
                        futureHexagram: this.calculateFutureHexagram(tripleOSResults.interfaceOS),
                        changeAnalysis: '社会的システムは、より柔軟で効果的な対人関係スキルへと進化していきます。',
                        growthDirection: '他者との協調性を保ちながら、自分らしさを表現するバランスを見つけることが重要です。'
                    },
                    {
                        fromOS: 'Safe Mode OS',
                        currentHexagram: tripleOSResults.safeModeOS.hexagramName,
                        futureHexagram: this.calculateFutureHexagram(tripleOSResults.safeModeOS),
                        changeAnalysis: '防御システムは、より建設的で適応的な対処メカニズムへと変化していきます。',
                        growthDirection: '安全性を保ちながらも、新しい挑戦に対してオープンな姿勢を育てることが成長のカギです。'
                    }
                ];
            }
            
            calculateFutureHexagram(osData) {
                // 簡単な実装 - 実際にはより複雑なアルゴリズム
                const currentId = osData.hexagramId || 1;
                const futureId = currentId > 32 ? currentId - 32 : currentId + 32;
                return `${futureId}番卦`;
            }
            
            extractClassicalWisdom(tripleOSResults) {
                return [
                    {
                        system: 'Engine OS',
                        hexagramName: tripleOSResults.engineOS.hexagramName,
                        guaCi: '大いなる者は元いに亨り、利しきに貞なり',
                        yaoCi: '潜龍なり、用うる勿れ',
                        modernInterpretation: 'あなたの価値観システムは、まだ表に現れていない大きな可能性を秘めています。今は内的な準備と修養の時期であり、適切な時期が来るまで待つことが賢明です。'
                    },
                    {
                        system: 'Interface OS',
                        hexagramName: tripleOSResults.interfaceOS.hexagramName,
                        guaCi: '履けばも虎の尾を踏むも咬まれず亨る',
                        yaoCi: '愨として履む、独り行きて願いを遂ぐ',
                        modernInterpretation: '社会的な場面では、誠実さと慎重さをもって行動することで、困難な状況でも成功を収めることができます。自分の道を歩むことの重要性を示しています。'
                    },
                    {
                        system: 'Safe Mode OS',
                        hexagramName: tripleOSResults.safeModeOS.hexagramName,
                        guaCi: '艮は其の背に止まり、其の身を獲ず',
                        yaoCi: '艮は其の輔に止まり、其の心を拯う',
                        modernInterpretation: '防御システムは、適切な境界を保つことで心の平安を得ることを教えています。過度に関与せず、適度な距離を保つことが、精神的な健康につながります。'
                    }
                ];
            }
            
            generateHaQeiAnalysis(tripleOSResults) {
                return {
                    philosophicalIntegration: `
                        あなたの三重人格システムは、HaQei哲学の核心である「複数の自己の共存」を体現しています。
                        Engine OSは「本来の自己」、Interface OSは「社会的自己」、Safe Mode OSは「適応的自己」として、
                        それぞれが独立した価値と役割を持ちながら、全体として統合されたあなたを形成しています。
                        
                        この複雑性こそが人間の豊かさであり、単純化せずに理解することで、
                        より戦略的で効果的な人生選択が可能になります。
                    `,
                    strategicPoints: [
                        '各OSの特性を理解し、状況に応じて最適なシステムを意識的に選択する',
                        'システム間の対立ではなく、相補的な関係として捉える', 
                        '変化する環境に対して、3つのOSが協調して対応できる柔軟性を育てる',
                        '自己批判ではなく、システムの特性として客観的に観察する習慣をつける',
                        '長期的な成長において、すべてのOSがバランス良く発達することを目指す'
                    ]
                };
            }
            
            generatePersonalizedInsights(tripleOSResults) {
                const { engineOS, interfaceOS, safeModeOS, integration } = tripleOSResults;
                const balance = this.calculateDynamicBalance(tripleOSResults);
                
                return {
                    growthDirections: `
                        主導システムである${balance.dominantOS}を基盤として、他の2つのシステムとの調和を図ることで、
                        より統合された人格へと成長できます。特に${this.getWeakestOS(tripleOSResults)}の
                        発達に意識を向けることで、全体的なバランスが向上します。
                    `,
                    optimizationStrategies: `
                        システム協調度${balance.coordination}%から、相互作用の改善余地があります。
                        日常生活で意識的に異なるOSを使い分ける練習をすることで、
                        より効果的な問題解決と人間関係の構築が可能になります。
                    `,
                    stressManagement: `
                        ストレス耐性${balance.resilience}%を基に、Safe Mode OSの${this.getStressManagementAdvice(safeModeOS)}
                        を活用することで、困難な状況でも安定した対応が可能です。
                        予防的なストレス管理として、定期的な自己チェックを実践してください。
                    `,
                    comparativeAnalysis: `
                        一般的なパターンと比較して、あなたの特徴は${this.getComparativeInsights(tripleOSResults)}です。
                        この独自性を強みとして活かしつつ、必要に応じて他の視点も取り入れることで、
                        より幅広い状況に対応できる柔軟性を獲得できます。
                    `
                };
            }
            
            generatePracticalStrategies(tripleOSResults) {
                return [
                    {
                        icon: '🎯',
                        title: '日常的なOS切り替え練習',
                        description: '朝の準備時間にEngine OS、職場でInterface OS、リラックス時にSafe Mode OSを意識的に使い分ける',
                        actions: ['モーニングルーティン設計', 'チーム作業の役割明確化', 'イブニング瞑想実践']
                    },
                    {
                        icon: '🤝',
                        title: 'システム間対話の促進',
                        description: '3つのOSの「会議」を定期的に開き、重要な決断において全体的な合意を得る',
                        actions: ['週間振り返りセッション', '意思決定フレームワーク作成', 'ジャーナリング実践']
                    },
                    {
                        icon: '📈',
                        title: '統合バランスの段階的向上',
                        description: 'システム協調度を月単位で向上させ、年間を通じて人格統合度を高める',
                        actions: ['月次セルフアセスメント', '成長指標の設定', '専門家との相談']
                    }
                ];
            }
            
            getWeakestOS(tripleOSResults) {
                const strengths = {
                    'Engine OS': this.calculateOSStrength(tripleOSResults.engineOS),
                    'Interface OS': this.calculateOSStrength(tripleOSResults.interfaceOS),
                    'Safe Mode OS': this.calculateOSStrength(tripleOSResults.safeModeOS)
                };
                
                return Object.keys(strengths).reduce((a, b) => 
                    strengths[a] < strengths[b] ? a : b
                );
            }
            
            getStressManagementAdvice(safeModeOS) {
                const strength = this.calculateOSStrength(safeModeOS);
                if (strength > 75) return '強力な安定化機能';
                if (strength > 50) return '適度な防御メカニズム';
                return '柔軟な適応戦略';
            }
            
            getComparativeInsights(tripleOSResults) {
                const balance = this.calculateDynamicBalance(tripleOSResults);
                if (balance.coordination > 80) return '高度な統合型人格特性';
                if (balance.flexibility > 80) return '高い適応能力と柔軟性';
                if (balance.resilience > 80) return '優秀なストレス耐性と安定性';
                return 'バランスの取れた成長型人格';
            }
            
            // 1ページサマリー生成
            generateOnePagerSummary(tripleOSResults) {
                const engine = tripleOSResults.engineOS;
                const interface_ = tripleOSResults.interfaceOS;
                const safe = tripleOSResults.safeModeOS;
                
                return {
                    // ヘッダー情報
                    title: '仮想人格生成結果',
                    date: new Date().toLocaleDateString('ja-JP'),
                    
                    // メインタイプ（大きく表示）
                    mainType: {
                        engine: `#${engine.hexagramId} ${engine.hexagramName}`,
                        interface: `#${interface_.hexagramId} ${interface_.hexagramName}`,
                        safe: `#${safe.hexagramId} ${safe.hexagramName}`
                    },
                    
                    // 3つの主要な特徴
                    keyTraits: [
                        `内面では${this.getEngineTraitSummary(engine)}な人`,
                        `人と接する時は${this.getInterfaceTraitSummary(interface_)}`,
                        `困った時は${this.getSafeTraitSummary(safe)}になる`
                    ],
                    
                    // 強み（3つ）
                    strengths: this.extractTop3Strengths(tripleOSResults),
                    
                    // 気をつける点（3つ）
                    watchPoints: this.extractTop3Cautions(tripleOSResults),
                    
                    // ワンポイントアドバイス
                    advice: this.generateSimpleAdvice(tripleOSResults),
                    
                    // 相性の良い環境
                    goodEnvironment: this.getIdealEnvironment(tripleOSResults)
                };
            }
            
            // ヘルパーメソッド群
            getEngineTraitSummary(engine) {
                const traits = {
                    1: '創造的で革新的', 2: '受容的で協調的', 3: '挑戦的で進取的',
                    4: '柔軟で適応的', 5: '探求的で知的', 6: '表現豊かで情熱的',
                    7: '安定志向で慎重', 8: '楽観的で社交的'
                };
                const id = Math.floor((engine.hexagramId - 1) / 8) + 1;
                return traits[id] || '独自性のある';
            }
            
            getInterfaceTraitSummary(interface_) {
                const traits = {
                    1: 'リーダーシップを発揮', 2: 'サポート役として活躍',
                    3: '積極的にコミュニケーション', 4: '周囲と調和',
                    5: '分析的にアプローチ', 6: '感情豊かに表現',
                    7: '慎重に関係構築', 8: '明るく交流'
                };
                const id = Math.floor((interface_.hexagramId - 1) / 8) + 1;
                return traits[id] || '自然体で振る舞う';
            }
            
            getSafeTraitSummary(safe) {
                const traits = {
                    29: '冷静に状況を分析する人', 30: '感情を内に秘める人',
                    1: '強いリーダーシップを発揮する人', 2: '周囲のサポートを求める人'
                };
                return traits[safe.hexagramId] || '慎重に対処する人';
            }
            
            // Task 8: 動的な強み抽出
            extractTop3Strengths(results) {
                const strengths = [];
                const { engineOS, interfaceOS, safeModeOS } = results;
                
                // Engine OSベースの強み（hexagramIdに基づく個別化）
                if (engineOS.hexagramId <= 8) {
                    strengths.push('強いリーダーシップと決断力が観察される');
                } else if (engineOS.hexagramId <= 16) {
                    strengths.push('創造的な問題解決能力の特性が見られる');
                } else if (engineOS.hexagramId <= 32) {
                    strengths.push('深い洞察力と分析能力が特徴的');
                } else if (engineOS.hexagramId <= 48) {
                    strengths.push('柔軟な適応力と協調性が観察される');
                } else {
                    strengths.push('バランスの取れた判断力が特徴的');
                }
                
                // Interface OSベースの強み（hexagramIdに基づく個別化）
                const interfaceStrengthMap = {
                    1: '人を導く自然なカリスマ性',
                    2: '他者をサポートする献身性',
                    3: '新しい挑戦への積極性',
                    4: '若い世代への教育力',
                    5: '忍耐強い待機能力',
                    6: '誠実な対人関係構築力',
                    7: '組織をまとめる統率力',
                    8: '人々を結びつける調和力'
                };
                
                // 9-64の卦も個別化（代表的なものを設定）
                const extendedInterfaceMap = {
                    ...interfaceStrengthMap,
                    9: '細やかな配慮と注意力',
                    10: '礼儀正しい振る舞い',
                    11: '平和的な問題解決力',
                    12: '内省的な思考力',
                    16: '楽観的なエネルギー',
                    20: '観察力と洞察力',
                    24: '再生と回復の力',
                    32: '持続可能な実行力',
                    40: '解放と革新の力',
                    48: '深い知恵と理解力',
                    56: '旅と変化への適応力',
                    64: '完成へ向けた集中力'
                };
                
                strengths.push(extendedInterfaceMap[interfaceOS.hexagramId] || '独自の対人スタイルと魅力');
                
                // Safe Mode OSベースの強み（強度に基づく個別化）
                if (safeModeOS.strength > 70) {
                    strengths.push('高いストレス耐性と回復力が観察される');
                } else if (safeModeOS.strength > 50) {
                    strengths.push('バランスの取れた危機管理能力が見られる');
                } else if (safeModeOS.strength > 30) {
                    strengths.push('柔軟な問題対処の特性が観察される');
                } else {
                    strengths.push('リスクを恐れない挑戦的な特性が見られる');
                }
                
                return strengths.slice(0, 3);
            }
            
            // Task 9: 動的な注意点抽出
            extractTop3Cautions(results) {
                const cautions = [];
                const { engineOS, interfaceOS, safeModeOS } = results;
                
                // Engine OSの強度に基づく注意点
                if (engineOS.strength > 80) {
                    cautions.push('理想主義に陥りやすく、現実的な視点が不足する傾向が見られる');
                } else if (engineOS.strength > 60) {
                    cautions.push('価値観を強く押し出す傾向が観察される');
                } else if (engineOS.strength < 40) {
                    cautions.push('決断に時間がかかりすぎる傾向が観察される');
                } else {
                    cautions.push('価値観の表現に消極的な傾向が見られる');
                }
                
                // Interface OSの強度に基づく注意点
                if (interfaceOS.strength > 80) {
                    cautions.push('他者の期待に過度に応えようとする傾向が観察される');
                } else if (interfaceOS.strength < 40) {
                    cautions.push('孤立しやすい傾向が観察される');
                } else {
                    // hexagramIdに基づく個別の注意点
                    const interfaceCautionMap = {
                        1: '独断的になる傾向が観察される',
                        2: '受け身になりやすい特性が見られる',
                        3: '衝動的な行動パターンが観察される',
                        4: '経験不足からくる不安定さが見られる',
                        5: '待機に偏りやすい傾向が観察される',
                        6: '対立を避けすぎる傾向が見られる',
                        7: '規律に縛られやすい特性が観察される',
                        8: '調和を重視しすぎる傾向が見られる'
                    };
                    cautions.push(interfaceCautionMap[interfaceOS.hexagramId] || '自分のペースと他者との調和のバランスが課題となる傾向');
                }
                
                // Safe Mode OSとEngine OSのバランスに基づく注意点
                const balanceGap = Math.abs(engineOS.strength - safeModeOS.strength);
                if (balanceGap > 40) {
                    cautions.push('内的な葛藤が生じやすい特性が観察される');
                } else if (safeModeOS.strength > 70) {
                    cautions.push('過度に慎重になる傾向が観察される');
                } else if (safeModeOS.strength < 30) {
                    cautions.push('リスクを軽視する傾向が観察される');
                }
                
                // 最も重要な3つを返す
                return cautions.slice(0, 3);
            }
            
            // 64卦の深い知恵データベース
            getHexagramWisdom() {
                return {
                    1: { core: "創造と革新の原動力", strength: "決断力とリーダーシップ", challenge: "独断への傾向", growth: "協調性の獲得", practice: "チームでの意見交換を増やす" },
                    2: { core: "受容と包容の力", strength: "サポート力と共感性", challenge: "受け身になりやすい", growth: "主体性の確立", practice: "自分の意見を明確に表現する" },
                    3: { core: "新たな挑戦への意欲", strength: "開拓精神と行動力", challenge: "衝動的な判断", growth: "計画性の向上", practice: "長期視点での戦略立案" },
                    4: { core: "学習と成長の可能性", strength: "素直さと吸収力", challenge: "経験不足", growth: "実践知の蓄積", practice: "失敗を恐れず挑戦する" },
                    5: { core: "待機と準備の知恵", strength: "忍耐力と観察力", challenge: "行動の遅れ", growth: "タイミングの見極め", practice: "機会を逃さない準備" },
                    6: { core: "誠実な対人関係", strength: "信頼構築力", challenge: "対立の回避", growth: "建設的な議論", practice: "正直な対話を心がける" },
                    7: { core: "組織力と統率力", strength: "規律と秩序", challenge: "柔軟性の欠如", growth: "状況適応力", practice: "ルールと創造性のバランス" },
                    8: { core: "調和と協力の精神", strength: "チームワーク", challenge: "依存的傾向", growth: "自立性の確立", practice: "個人の強みを活かす" },
                    9: { core: "細やかな配慮", strength: "観察力と注意深さ", challenge: "完璧主義", growth: "大局観の獲得", practice: "優先順位の明確化" },
                    10: { core: "礼儀と品格", strength: "社会性と適応力", challenge: "形式重視", growth: "本質の理解", practice: "内面の充実を図る" },
                    11: { core: "平和と繁栄", strength: "バランス感覚", challenge: "現状満足", growth: "更なる向上心", practice: "新しい目標設定" },
                    12: { core: "内省と充電", strength: "深い思考力", challenge: "孤立傾向", growth: "社会との接点", practice: "定期的な交流機会" },
                    13: { core: "共同体意識", strength: "協調性と連帯感", challenge: "個性の埋没", growth: "独自性の発揮", practice: "自分らしさを表現する" },
                    14: { core: "豊かさの実現", strength: "資源管理能力", challenge: "物質偏重", growth: "精神的充実", practice: "価値観の多様化" },
                    15: { core: "謙虚さと節度", strength: "自己制御力", challenge: "消極性", growth: "積極的な関与", practice: "適切な自己主張" },
                    16: { core: "情熱と熱意", strength: "モチベーション", challenge: "感情的反応", growth: "冷静な判断", practice: "感情と理性のバランス" },
                    17: { core: "追随と学習", strength: "柔軟な適応力", challenge: "主体性の欠如", growth: "リーダーシップ", practice: "自分の道を見つける" },
                    18: { core: "改善と修正", strength: "問題解決力", challenge: "批判的姿勢", growth: "建設的提案", practice: "ポジティブな改善策" },
                    19: { core: "接近と親和", strength: "親しみやすさ", challenge: "境界の曖昧さ", growth: "適切な距離感", practice: "プロフェッショナリズム" },
                    20: { core: "観察と洞察", strength: "分析力", challenge: "傍観者意識", growth: "積極的関与", practice: "行動への転換" },
                    21: { core: "決断と実行", strength: "行動力", challenge: "性急な判断", growth: "熟慮の習慣", practice: "段階的な実行" },
                    22: { core: "装飾と表現", strength: "美的センス", challenge: "表面的評価", growth: "本質の追求", practice: "内容の充実" },
                    23: { core: "削ぎ落とし", strength: "本質を見抜く力", challenge: "否定的視点", growth: "肯定的側面", practice: "バランスの取れた評価" },
                    24: { core: "復活と再生", strength: "回復力", challenge: "過去への執着", growth: "前進する勇気", practice: "新しい挑戦への準備" },
                    25: { core: "自然体の強さ", strength: "誠実さ", challenge: "無防備", growth: "戦略的思考", practice: "計画性を持つ" },
                    26: { core: "蓄積と成熟", strength: "持続力", challenge: "変化への抵抗", growth: "革新性", practice: "新しい方法を試す" },
                    27: { core: "養育と成長", strength: "育成力", challenge: "過保護", growth: "自立の促進", practice: "適切な支援の提供" },
                    28: { core: "大いなる超越", strength: "突破力", challenge: "過度な負荷", growth: "持続可能性", practice: "バランスの維持" },
                    29: { core: "深淵の探求", strength: "深い洞察力", challenge: "悲観的思考", growth: "希望の発見", practice: "ポジティブな視点" },
                    30: { core: "明晰と照明", strength: "明確な vision", challenge: "理想主義", growth: "現実との調和", practice: "実現可能な目標設定" },
                    31: { core: "感応と共鳴", strength: "共感力", challenge: "感情移入過多", growth: "客観性", practice: "感情の境界線" },
                    32: { core: "恒常と持続", strength: "安定性", challenge: "硬直化", growth: "柔軟な対応", practice: "変化への適応" },
                    33: { core: "退避と保全", strength: "戦略的撤退", challenge: "消極的態度", growth: "タイミング感覚", practice: "適切な再参入" },
                    34: { core: "大いなる力", strength: "影響力", challenge: "力の誤用", growth: "責任感", practice: "力の適切な行使" },
                    35: { core: "進歩と発展", strength: "前進力", challenge: "焦燥感", growth: "着実な歩み", practice: "段階的な成長" },
                    36: { core: "内なる光", strength: "内的強さ", challenge: "外部との断絶", growth: "表現力", practice: "内面の共有" },
                    37: { core: "家族と絆", strength: "結束力", challenge: "閉鎖性", growth: "開放性", practice: "外部との交流" },
                    38: { core: "対立と成長", strength: "独立性", challenge: "孤立", growth: "協調", practice: "違いを認め合う" },
                    39: { core: "困難の克服", strength: "忍耐力", challenge: "停滞", growth: "突破口", practice: "新しいアプローチ" },
                    40: { core: "解放と自由", strength: "解決力", challenge: "無秩序", growth: "新たな秩序", practice: "構造の再構築" },
                    41: { core: "減少と集中", strength: "本質への集中", challenge: "縮小思考", growth: "拡大の可能性", practice: "選択と集中" },
                    42: { core: "増益と拡大", strength: "成長力", challenge: "過剰拡大", growth: "持続可能性", practice: "質的向上" },
                    43: { core: "決断と突破", strength: "決断力", challenge: "急進的変化", growth: "段階的移行", practice: "慎重な実行" },
                    44: { core: "遭遇と機会", strength: "機会認識", challenge: "表面的関係", growth: "深い理解", practice: "本質的な繋がり" },
                    45: { core: "集合と統一", strength: "統合力", challenge: "画一化", growth: "多様性", practice: "個性の尊重" },
                    46: { core: "上昇と成長", strength: "向上心", challenge: "性急な上昇", growth: "基盤固め", practice: "着実な積み上げ" },
                    47: { core: "困窮と忍耐", strength: "精神力", challenge: "疲弊", growth: "回復力", practice: "適切な休息" },
                    48: { core: "源泉と本質", strength: "本質理解", challenge: "深入り", growth: "実用性", practice: "知識の活用" },
                    49: { core: "変革と革新", strength: "革新力", challenge: "破壊的変化", growth: "建設的変革", practice: "段階的改革" },
                    50: { core: "養成と変容", strength: "変容力", challenge: "アイデンティティ喪失", growth: "新たな自己", practice: "核心の保持" },
                    51: { core: "震動と覚醒", strength: "覚醒力", challenge: "動揺", growth: "安定性", practice: "内的平静" },
                    52: { core: "静止と瞑想", strength: "集中力", challenge: "停滞", growth: "動的バランス", practice: "適度な活動" },
                    53: { core: "漸進と発展", strength: "着実性", challenge: "遅滞", growth: "加速", practice: "タイミングの見極め" },
                    54: { core: "従属と上昇", strength: "適応力", challenge: "依存性", growth: "自立", practice: "主体的な選択" },
                    55: { core: "豊満と充実", strength: "充実感", challenge: "満足による停滞", growth: "新たな挑戦", practice: "継続的成長" },
                    56: { core: "旅行と探索", strength: "探究心", challenge: "根無し草", growth: "基盤確立", practice: "拠点の構築" },
                    57: { core: "浸透と影響", strength: "影響力", challenge: "曖昧さ", growth: "明確性", practice: "方向性の確立" },
                    58: { core: "喜悦と交流", strength: "社交性", challenge: "表面的関係", growth: "深い絆", practice: "真の交流" },
                    59: { core: "分散と流動", strength: "柔軟性", challenge: "分散", growth: "統合", practice: "焦点の明確化" },
                    60: { core: "節度と制限", strength: "自制心", challenge: "制約感", growth: "創造的突破", practice: "制約内での革新" },
                    61: { core: "内なる誠実", strength: "誠実さ", challenge: "素朴さ", growth: "洗練", practice: "戦略的誠実さ" },
                    62: { core: "小さな超越", strength: "細部への注意", challenge: "視野狭窄", growth: "大局観", practice: "全体像の把握" },
                    63: { core: "既済と完成", strength: "完成力", challenge: "満足による停滞", growth: "新サイクル", practice: "次の目標設定" },
                    64: { core: "未済と可能性", strength: "可能性", challenge: "未完成", growth: "完成への道", practice: "着実な前進" }
                };
            }

            // 八宮（Eight Palaces）による正確な分類
            getOSPatternGroup(hexagramId) {
                // 専門家レビューによる正確な八宮マッピング
                const EIGHT_PALACES = {
                    "乾宮": { id: 0, hexagrams: [1, 44, 33, 12, 20, 23, 35, 14] },
                    "坤宮": { id: 1, hexagrams: [2, 24, 19, 11, 34, 43, 5, 8] },
                    "震宮": { id: 2, hexagrams: [51, 16, 40, 32, 46, 48, 28, 17] },
                    "巽宮": { id: 3, hexagrams: [57, 9, 37, 42, 25, 21, 27, 18] },
                    "坎宮": { id: 4, hexagrams: [29, 60, 3, 63, 49, 55, 36, 7] },
                    "離宮": { id: 5, hexagrams: [30, 56, 50, 64, 4, 59, 6, 13] },
                    "艮宮": { id: 6, hexagrams: [52, 22, 26, 41, 38, 10, 61, 53] },
                    "兌宮": { id: 7, hexagrams: [58, 47, 45, 31, 39, 15, 62, 54] }
                };
                
                // 卦番号から宮を検索
                for (const [palaceName, palace] of Object.entries(EIGHT_PALACES)) {
                    if (palace.hexagrams.includes(hexagramId)) {
                        return palace.id;
                    }
                }
                
                // Fail-Closed: 宮が見つからない場合は例外を投げる
                const error = new Error(`Critical: Hexagram ${hexagramId} not found in Eight Palaces mapping`);
                console.error(error);
                
                // エラー通知（Sentryなどが設定されている場合）
                if (window.Sentry) {
                    window.Sentry.captureException(error);
                }
                
                // UIには限定表示モードを案内
                if (window.showLimitedModeNotification) {
                    window.showLimitedModeNotification('八宮マッピングエラーが発生しました。限定機能モードで動作します。');
                }
                
                // 例外を投げる（呼び出し元でキャッチして適切に処理）
                throw error;
            }

            // 512パターンの組み合わせID生成（八宮ベース）
            generatePatternId(engineOS, interfaceOS, safeModeOS) {
                try {
                    // 各OSの八宮IDを取得（0-7）
                    const e = this.getOSPatternGroup(engineOS.hexagramId);
                    const i = this.getOSPatternGroup(interfaceOS.hexagramId);
                    const s = this.getOSPatternGroup(safeModeOS.hexagramId);
                    
                    // デバッグ用トレース（開発時のみ）
                    if (window.debugHAQEI) {
                        console.log(`Pattern ID Trace:`);
                        console.log(`  Engine OS: Hexagram ${engineOS.hexagramId} → Palace ${e}`);
                        console.log(`  Interface OS: Hexagram ${interfaceOS.hexagramId} → Palace ${i}`);
                        console.log(`  Safe Mode OS: Hexagram ${safeModeOS.hexagramId} → Palace ${s}`);
                        console.log(`  Pattern ID: ${e}${i}${s}`);
                    }
                    
                    // 二重表現を返す（str形式とint形式）
                    const strId = `${e}${i}${s}`;
                    const intId = e * 64 + i * 8 + s;
                    
                    return {
                        str: strId,
                        int: intId
                    };
                } catch (error) {
                    console.error('Pattern ID generation failed:', error);
                    // 限定モードの通知とフォールバック
                    return {
                        str: '000',
                        int: 0,
                        error: true
                    };
                }
            }

            // 動的バランスパターン分析
            analyzeBalancePattern(engineOS, interfaceOS, safeModeOS) {
                const patterns = {
                    "highEngine-highInterface": { 
                        type: "外向的リーダー型",
                        description: "強い内的価値観と優れた社交性を併せ持つ",
                        strength: "カリスマ的リーダーシップ",
                        caution: "エネルギー消耗への注意"
                    },
                    "highEngine-lowInterface": {
                        type: "内向的創造者型",
                        description: "深い内面性と独創的な思考",
                        strength: "革新的アイデアの創出",
                        caution: "コミュニケーションの改善"
                    },
                    "lowEngine-highInterface": {
                        type: "サポート特化型",
                        description: "他者への配慮と協調性",
                        strength: "チームの潤滑油的役割",
                        caution: "自己主張の強化"
                    },
                    "lowEngine-lowInterface": {
                        type: "観察者型",
                        description: "客観的視点と分析力",
                        strength: "冷静な状況判断",
                        caution: "積極的関与の必要性"
                    }
                };

                const engineLevel = engineOS.strength > 60 ? "high" : "low";
                const interfaceLevel = interfaceOS.strength > 60 ? "high" : "low";
                const key = `${engineLevel}Engine-${interfaceLevel}Interface`;
                
                return patterns[key] || patterns["lowEngine-lowInterface"];
            }

            // 成長段階の定義
            defineGrowthStage(results) {
                const { engineOS, interfaceOS, safeModeOS } = results;
                const avgStrength = (engineOS.strength + interfaceOS.strength + safeModeOS.strength) / 3;
                
                if (avgStrength < 40) {
                    return {
                        stage: "探索期",
                        description: "自己理解を深める段階",
                        nextStep: "強みの発見と小さな実践",
                        timeline: "3ヶ月の自己観察期間"
                    };
                } else if (avgStrength < 60) {
                    return {
                        stage: "成長期",
                        description: "能力を伸ばす段階",
                        nextStep: "専門性の確立と実績作り",
                        timeline: "6ヶ月の集中的成長"
                    };
                } else if (avgStrength < 80) {
                    return {
                        stage: "確立期",
                        description: "独自性を発揮する段階",
                        nextStep: "影響力の拡大と貢献",
                        timeline: "1年の継続的発展"
                    };
                } else {
                    return {
                        stage: "成熟期",
                        description: "wisdom を活かす段階",
                        nextStep: "後進の育成と知識の継承",
                        timeline: "長期的な価値創造"
                    };
                }
            }

            // 八宮の意味論的特性を取得（拡充版）
            getEightPalaceNature(palaceId) {
                const palaceNatures = {
                    0: { 
                        name: "乾宮", 
                        nature: "創造的・主導的", 
                        element: "天", 
                        strength: "決断力とリーダーシップ",
                        weakness: "独断と傲慢への傾向",
                        typicalBehavior: "新しいビジョンを提示し、組織を導く",
                        growthPath: "協調性と謙虚さの獲得"
                    },
                    1: { 
                        name: "坤宮", 
                        nature: "受容的・支援的", 
                        element: "地", 
                        strength: "包容力と安定性",
                        weakness: "受動性と依存的傾向",
                        typicalBehavior: "他者を支え、安定した基盤を提供",
                        growthPath: "主体性と自立性の確立"
                    },
                    2: { 
                        name: "震宮", 
                        nature: "動的・革新的", 
                        element: "雷", 
                        strength: "行動力と突破力",
                        weakness: "衝動性と短慮",
                        typicalBehavior: "素早く行動し、変化を起こす",
                        growthPath: "計画性と忍耐力の習得"
                    },
                    3: { 
                        name: "巽宮", 
                        nature: "浸透的・適応的", 
                        element: "風", 
                        strength: "柔軟性と影響力",
                        weakness: "優柔不断と方向性の欠如",
                        typicalBehavior: "状況に適応し、穏やかに影響を与える",
                        growthPath: "決断力と一貫性の強化"
                    },
                    4: { 
                        name: "坎宮", 
                        nature: "深淵的・流動的", 
                        element: "水", 
                        strength: "洞察力と適応性",
                        weakness: "不安定さと迷走傾向",
                        typicalBehavior: "深く観察し、流れに適応する",
                        growthPath: "安定性と方向性の確立"
                    },
                    5: { 
                        name: "離宮", 
                        nature: "照明的・表現的", 
                        element: "火", 
                        strength: "明晰性と情熱",
                        weakness: "燃え尽きと過度な感情",
                        typicalBehavior: "明確に表現し、周囲を照らす",
                        growthPath: "持続性と感情調整"
                    },
                    6: { 
                        name: "艮宮", 
                        nature: "安定的・保守的", 
                        element: "山", 
                        strength: "堅実性と持続力",
                        weakness: "頑固さと変化への抵抗",
                        typicalBehavior: "着実に進み、信頼を築く",
                        growthPath: "柔軟性と革新性の獲得"
                    },
                    7: { 
                        name: "兌宮", 
                        nature: "喜悦的・交流的", 
                        element: "沢", 
                        strength: "社交性と喜び",
                        weakness: "表面的関係と軽薄さ",
                        typicalBehavior: "人々と交流し、喜びを共有する",
                        growthPath: "深い関係性と真摯さ"
                    }
                };
                return palaceNatures[palaceId] || palaceNatures[0];
            }

            // Task 10: 拡張版アドバイス生成（512パターン対応）
            generateEnhancedAdvice(results) {
                const { engineOS, interfaceOS, safeModeOS } = results;
                const hexagramWisdom = this.getHexagramWisdom();
                
                // パターンID生成（512通り）
                const patternId = this.generatePatternId(engineOS, interfaceOS, safeModeOS);
                
                // 各OSの八宮特性を取得
                const enginePalace = this.getEightPalaceNature(this.getOSPatternGroup(engineOS.hexagramId));
                const interfacePalace = this.getEightPalaceNature(this.getOSPatternGroup(interfaceOS.hexagramId));
                const safeModePalace = this.getEightPalaceNature(this.getOSPatternGroup(safeModeOS.hexagramId));
                
                // バランスパターン分析
                const balancePattern = this.analyzeBalancePattern(engineOS, interfaceOS, safeModeOS);
                
                // 成長段階
                const growthStage = this.defineGrowthStage(results);
                
                // 各OSの知恵を取得
                const engineWisdom = hexagramWisdom[engineOS.hexagramId];
                const interfaceWisdom = hexagramWisdom[interfaceOS.hexagramId];
                const safeModeWisdom = hexagramWisdom[safeModeOS.hexagramId];
                
                // 品質メトリクス計算
                const metrics = this.calculateQualityMetrics(results);
                
                // 詳細なアドバイス構築
                const advice = {
                    // 現状認識
                    observation: `この仮想人格は${balancePattern.type}として観察され、${engineWisdom.core}を内的価値観とし、対人関係では${interfaceWisdom.core}の特性を示します。ストレス時には${safeModeWisdom.core}のパターンが現れます。`,
                    
                    // 強みと活用シナリオ
                    strengths: `特に${balancePattern.strength}が顕著で、${engineWisdom.strength}、${interfaceWisdom.strength}、${safeModeWisdom.strength}という3つの強みが統合的に機能しています。`,
                    
                    // 成長の方向性
                    growth: `現在${growthStage.stage}にあり、${growthStage.description}。次のステップとして${growthStage.nextStep}が推奨されます。${growthStage.timeline}を目安に取り組むことで、着実な成長が期待できます。`,
                    
                    // 具体的な実践方法
                    practice: `日常的な実践として、${engineWisdom.practice}、${interfaceWisdom.practice}、${safeModeWisdom.practice}を意識することで、バランスの取れた成長が可能です。`,
                    
                    // 注意点と対策
                    cautions: `${balancePattern.caution}に注意が必要です。また、${engineWisdom.challenge}、${interfaceWisdom.challenge}、${safeModeWisdom.challenge}という傾向が観察されるため、これらを意識的に改善することが重要です。`,
                    
                    // 品質指標
                    quality: `分析の一貫性: ${metrics.consistency}% | バランス指標: ${metrics.balance}% | カバレッジ: ${metrics.coverage}%`
                };
                
                // 統合されたアドバイス文を返す
                return `${advice.observation}\n\n${advice.strengths}\n\n${advice.growth}\n\n${advice.practice}\n\n${advice.cautions}`;
            }

            // 品質メトリクス計算（ComprehensiveReportGenerator機能の一部復活）
            calculateQualityMetrics(results) {
                const { engineOS, interfaceOS, safeModeOS } = results;
                
                // 一貫性スコア（回答パターンの一貫性）
                const strengthVariance = this.calculateVariance([
                    engineOS.strength,
                    interfaceOS.strength,
                    safeModeOS.strength
                ]);
                const consistency = Math.max(0, 100 - strengthVariance);
                
                // バランススコア（3つのOSのバランス）
                const avgStrength = (engineOS.strength + interfaceOS.strength + safeModeOS.strength) / 3;
                const maxDeviation = Math.max(
                    Math.abs(engineOS.strength - avgStrength),
                    Math.abs(interfaceOS.strength - avgStrength),
                    Math.abs(safeModeOS.strength - avgStrength)
                );
                const balance = Math.max(0, 100 - maxDeviation);
                
                // カバレッジ（8次元の網羅性）
                const dimensions = ['乾', '震', '坎', '艮', '坤', '巽', '離', '兌'];
                let coveredDimensions = 0;
                dimensions.forEach(dim => {
                    const hasEnergy = 
                        (engineOS.baguaEnergies?.[dim] > 20) ||
                        (interfaceOS.baguaEnergies?.[dim] > 20) ||
                        (safeModeOS.baguaEnergies?.[dim] > 20);
                    if (hasEnergy) coveredDimensions++;
                });
                const coverage = Math.round((coveredDimensions / dimensions.length) * 100);
                
                return {
                    consistency: Math.round(consistency),
                    balance: Math.round(balance),
                    coverage: coverage
                };
            }

            // 分散計算ヘルパー
            calculateVariance(values) {
                const mean = values.reduce((a, b) => a + b, 0) / values.length;
                const squaredDiffs = values.map(v => Math.pow(v - mean, 2));
                return Math.sqrt(squaredDiffs.reduce((a, b) => a + b, 0) / values.length);
            }

            // Task 10: 個別化されたアドバイス生成（拡張版を使用）
            generateSimpleAdvice(results) {
                // 拡張版のアドバイス生成を使用
                return this.generateEnhancedAdvice(results);
            }
            
            // Task 11: 個別化された理想環境
            getIdealEnvironment(results) {
                const { engineOS, interfaceOS, safeModeOS } = results;
                const environments = [];
                
                // Engine OSに基づく環境要素
                if (engineOS.hexagramId <= 8) {
                    environments.push('リーダーシップを発揮できる責任ある立場');
                } else if (engineOS.hexagramId <= 24) {
                    environments.push('創造性と革新性を求められる環境');
                } else if (engineOS.hexagramId <= 40) {
                    environments.push('安定と成長のバランスが取れた職場');
                } else if (engineOS.hexagramId <= 56) {
                    environments.push('変化と多様性に富んだダイナミックな環境');
                } else {
                    environments.push('経験と知恵が評価される成熟した組織');
                }
                
                // Interface OSに基づく環境要素
                if (interfaceOS.strength > 70) {
                    environments.push('チームワークと協力が重視される文化');
                } else if (interfaceOS.strength < 40) {
                    environments.push('独立して作業できる自律的な環境');
                } else {
                    environments.push('個人とチームのバランスが取れた柔軟な体制');
                }
                
                // Safe Mode OSに基づく環境要素
                if (safeModeOS.strength > 60) {
                    environments.push('明確なルールとサポート体制がある安定した基盤');
                } else if (safeModeOS.strength < 40) {
                    environments.push('挑戦と成長の機会が豊富な刺激的な場');
                } else {
                    environments.push('適度なチャレンジと安全性のバランス');
                }
                
                return environments.join('、');
            }
            
            // サマリー表示HTML生成（Task 5: 専門用語置換適用）
            renderOnePagerSummary(summary) {
                // 専門用語を置換
                const applyTerminology = (text) => {
                    if (!text || typeof window.replaceTerminology !== 'function') return text;
                    return window.replaceTerminology(text);
                };
                
                return `
                    <div class="one-pager-summary" style="max-width: 800px; margin: 0 auto; padding: 20px; background: rgba(15, 23, 42, 0.8); border-radius: 12px;">
                        <h1 style="text-align: center; color: #6366f1; margin-bottom: 30px; font-size: 28px;">
                            ${applyTerminology(summary.title)}
                        </h1>
                        
                        <!-- メインタイプ -->
                        <div class="main-types" style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                            <div class="type-card" style="text-align: center; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border: 1px solid rgba(99, 102, 241, 0.3);">
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">内なる価値観</div>
                                <div style="font-size: 20px; font-weight: bold; color: #6366f1;">${summary.mainType.engine}</div>
                            </div>
                            <div class="type-card" style="text-align: center; padding: 15px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; border: 1px solid rgba(139, 92, 246, 0.3);">
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">対人関係</div>
                                <div style="font-size: 20px; font-weight: bold; color: #8b5cf6;">${summary.mainType.interface}</div>
                            </div>
                            <div class="type-card" style="text-align: center; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.3);">
                                <div style="color: #94a3b8; font-size: 12px; margin-bottom: 8px;">ストレス時</div>
                                <div style="font-size: 20px; font-weight: bold; color: #10b981;">${summary.mainType.safe}</div>
                            </div>
                        </div>
                        
                        <!-- 特徴 -->
                        <div class="traits-section" style="margin-bottom: 25px; padding: 20px; background: rgba(99, 102, 241, 0.05); border-radius: 8px;">
                            <h3 style="color: #e5e7eb; font-size: 18px; margin-bottom: 15px;">仮想人格の特徴</h3>
                            <ul style="list-style: none; padding: 0; color: #cbd5e1;">
                                ${summary.keyTraits.map(trait => `<li style="padding: 8px 0; border-bottom: 1px solid rgba(99, 102, 241, 0.1);">• ${applyTerminology(trait)}</li>`).join('')}
                            </ul>
                        </div>
                        
                        <!-- 強みと注意点を横並び -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px;">
                            <div style="padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                                <h3 style="color: #10b981; font-size: 16px; margin-bottom: 12px;">✨ 強み</h3>
                                <ul style="list-style: none; padding: 0; color: #cbd5e1;">
                                    ${summary.strengths.map(s => `<li style="padding: 5px 0;">✓ ${applyTerminology(s)}</li>`).join('')}
                                </ul>
                            </div>
                            <div style="padding: 15px; background: rgba(251, 191, 36, 0.1); border-radius: 8px;">
                                <h3 style="color: #fbbf24; font-size: 16px; margin-bottom: 12px;">⚠️ 気をつける点</h3>
                                <ul style="list-style: none; padding: 0; color: #cbd5e1;">
                                    ${summary.watchPoints.map(w => `<li style="padding: 5px 0;">• ${applyTerminology(w)}</li>`).join('')}
                                </ul>
                            </div>
                        </div>
                        
                        <!-- アドバイス -->
                        <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1)); padding: 20px; border-radius: 8px; border-left: 4px solid #6366f1; margin-bottom: 20px;">
                            <h3 style="color: #6366f1; font-size: 16px; margin-bottom: 10px;">💡 アドバイス</h3>
                            <p style="margin: 0; line-height: 1.8; color: #e5e7eb;">${applyTerminology(summary.advice)}</p>
                        </div>
                        
                        <!-- 理想的な環境 -->
                        <div style="padding: 15px; background: rgba(168, 85, 247, 0.1); border-radius: 8px; margin-bottom: 20px;">
                            <h4 style="color: #a855f7; font-size: 14px; margin-bottom: 8px;">🌟 この仮想人格が機能しやすい環境</h4>
                            <p style="margin: 0; color: #cbd5e1; font-size: 14px; line-height: 1.6;">${applyTerminology(summary.goodEnvironment)}</p>
                        </div>
                        
                        <!-- 印刷用フッター -->
                        <div class="print-footer" style="margin-top: 30px; padding-top: 20px; border-top: 1px solid rgba(99, 102, 241, 0.2); text-align: center; color: #64748b; font-size: 12px;">
                            <p>診断日: ${summary.date} | HaQei Triple OS 仮想人格生成システム</p>
                        </div>
                    </div>
                `;
            }
            
            generateTripleOSSummary(tripleOSResults) {
                const { 
                    engineOS, 
                    interfaceOS, 
                    safeModeOS, 
                    consistencyScore,
                    balanceScore,
                    HaQeiIntegration,
                    integration,
                    recommendations 
                } = tripleOSResults;
                
                // 統合スコアの表示用フォーマット
                const formatScore = (score) => Math.round(score || 0);
                const getScoreColor = (score) => {
                    if (score >= 80) return '#10b981'; // 緑
                    if (score >= 65) return '#f59e0b'; // 黄
                    return '#ef4444'; // 赤
                };
                
                // HaQei準拠の表現
                const summary = `
                    <div style="margin-bottom: var(--space-md);">
                        <h4 style="color: var(--primary-100); margin-bottom: var(--space-sm);">🔯 Triple OS システム分析</h4>
                        <p style="color: var(--primary-200); line-height: 1.6;">
                            この分析は、易経の64卦理論に基づく<strong>参考情報</strong>として提供されます。
                            あなたの人格を3つの層で理解する<strong>一つの視点</strong>です。
                        </p>
                    </div>
                    
                    <div style="margin-bottom: var(--space-md);">
                        <h5 style="color: #6366f1; margin-bottom: var(--space-xs);">🎯 Engine OS（深層価値観）</h5>
                        <p style="color: var(--primary-300); font-size: var(--font-sm);">
                            ${engineOS.hexagramName} - ${engineOS.catchphrase || engineOS.description}
                        </p>
                    </div>
                    
                    <div style="margin-bottom: var(--space-md);">
                        <h5 style="color: #8b5cf6; margin-bottom: var(--space-xs);">💬 Interface OS（社会的側面）</h5>
                        <p style="color: var(--primary-300); font-size: var(--font-sm);">
                            ${interfaceOS.hexagramName} - 対人関係での一面
                        </p>
                    </div>
                    
                    <div style="margin-bottom: var(--space-md);">
                        <h5 style="color: #10b981; margin-bottom: var(--space-xs);">🛡️ SafeMode OS（防御システム）</h5>
                        <p style="color: var(--primary-300); font-size: var(--font-sm);">
                            ${safeModeOS.hexagramName} - 安全を重視する時の特性
                        </p>
                    </div>
                    
                    <div style="background: rgba(99, 102, 241, 0.05); border-radius: var(--radius-md); padding: var(--space-md); margin: var(--space-md) 0;">
                        <h5 style="color: var(--primary-100); margin-bottom: var(--space-sm); text-align: center;">📊 Triple OS統合評価</h5>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: var(--space-sm); margin-bottom: var(--space-sm);">
                            <div style="text-align: center; padding: var(--space-xs); background: rgba(255,255,255,0.05); border-radius: var(--radius-sm);">
                                <div style="font-size: var(--font-lg); font-weight: bold; color: ${getScoreColor(consistencyScore)};">
                                    ${formatScore(consistencyScore)}%
                                </div>
                                <div style="font-size: var(--font-xs); color: var(--primary-300);">整合性</div>
                            </div>
                            
                            <div style="text-align: center; padding: var(--space-xs); background: rgba(255,255,255,0.05); border-radius: var(--radius-sm);">
                                <div style="font-size: var(--font-lg); font-weight: bold; color: ${getScoreColor(balanceScore)};">
                                    ${formatScore(balanceScore)}%
                                </div>
                                <div style="font-size: var(--font-xs); color: var(--primary-300);">動的バランス</div>
                            </div>
                            
                            <div style="text-align: center; padding: var(--space-xs); background: rgba(255,255,255,0.05); border-radius: var(--radius-sm);">
                                <div style="font-size: var(--font-lg); font-weight: bold; color: ${getScoreColor(HaQeiIntegration)};">
                                    ${formatScore(HaQeiIntegration)}%
                                </div>
                                <div style="font-size: var(--font-xs); color: var(--primary-300);">HaQei統合</div>
                            </div>
                        </div>
                        
                        <p style="color: var(--primary-300); font-size: var(--font-xs); text-align: center; margin-top: var(--space-xs);">
                            ※これらの数値は参考指標として、自己理解の一助としてご活用ください
                        </p>
                    </div>
                    
                    ${recommendations && recommendations.length > 0 ? `
                        <div style="background: rgba(16, 185, 129, 0.05); border-radius: var(--radius-md); padding: var(--space-md); margin: var(--space-md) 0;">
                            <h5 style="color: #10b981; margin-bottom: var(--space-sm);">💡 成長への気づき</h5>
                            ${recommendations.slice(0, 2).map(rec => `
                                <div style="margin-bottom: var(--space-sm); padding: var(--space-xs); background: rgba(255,255,255,0.03); border-radius: var(--radius-sm);">
                                    <div style="font-weight: bold; color: var(--primary-200); margin-bottom: var(--space-xs);">
                                        ${rec.title}
                                    </div>
                                    <div style="color: var(--primary-300); font-size: var(--font-sm); line-height: 1.4;">
                                        ${rec.description}
                                    </div>
                                </div>
                            `).join('')}
                            <p style="color: var(--primary-400); font-size: var(--font-xs); text-align: center; margin-top: var(--space-sm);">
                                これらの気づきを、日常の中で少しずつ意識していただければと思います
                            </p>
                        </div>
                    ` : ''}
                    
                    <div style="background: rgba(99, 102, 241, 0.1); border-radius: var(--radius-md); padding: var(--space-sm); margin-top: var(--space-md);">
                        <p style="color: var(--primary-200); font-size: var(--font-sm); text-align: center; line-height: 1.4;">
                            🌟 この分析結果は易経の智慧に基づく一つの視点です<br>
                            あなた自身の直感と合わせて、より深い自己理解にお役立てください
                        </p>
                    </div>
                `;
                
                document.getElementById('result-summary').innerHTML = summary;
            }
            
            // DAY 2: ペルソナ表現強化
            enhancePersonaResults(tripleOSResults) {
                if (!window.virtualPersonaEnhancer) {
                    console.warn('⚠️ VirtualPersonaEnhancer not available');
                    return tripleOSResults;
                }
                
                try {
                    // 各OSにペルソナキャラクター情報を追加
                    const enhancedResults = {
                        ...tripleOSResults,
                        engineOS: window.virtualPersonaEnhancer.enhanceOSResult(tripleOSResults.engineOS, 'engine'),
                        interfaceOS: window.virtualPersonaEnhancer.enhanceOSResult(tripleOSResults.interfaceOS, 'interface'),
                        safeModeOS: window.virtualPersonaEnhancer.enhanceOSResult(tripleOSResults.safeModeOS, 'safemode')
                    };
                    
                    console.log('✅ Persona results enhanced with character data');
                    return enhancedResults;
                } catch (error) {
                    console.error('❌ Persona enhancement failed:', error);
                    return tripleOSResults;
                }
            }
            
            // VirtualPersonaDialogue初期化メソッド（Task 1: 新規追加）
            async initializeVirtualPersonaDialogue() {
                try {
                    if (typeof window.VirtualPersonaDialogue !== 'undefined') {
                        if (!this.virtualPersonaDialogue) {
                            this.virtualPersonaDialogue = new window.VirtualPersonaDialogue();
                        }
                        
                        // initialize()メソッドが存在する場合は呼び出す
                        if (typeof this.virtualPersonaDialogue.initialize === 'function') {
                            await this.virtualPersonaDialogue.initialize();
                            this.virtualPersonaDialogueInitialized = true;
                            console.log('✅ VirtualPersonaDialogue initialized successfully');
                        } else {
                            // initialize()メソッドがない場合も成功とする
                            this.virtualPersonaDialogueInitialized = true;
                            console.log('✅ VirtualPersonaDialogue ready (no initialization needed)');
                        }
                        return true;
                    }
                    console.warn('⚠️ VirtualPersonaDialogue class not found');
                    return false;
                } catch (error) {
                    console.error('❌ VirtualPersonaDialogue initialization failed:', error);
                    this.virtualPersonaDialogueInitialized = false;
                    return false;
                }
            }
            
            // Phase 3: 内的対話システム表示
            async renderVirtualPersonaDialogue(tripleOSResults) {
                try {
                    // Task 2: 初期化を確認・実行
                    if (!this.virtualPersonaDialogueInitialized) {
                        const initialized = await this.initializeVirtualPersonaDialogue();
                        if (!initialized) {
                            console.warn('⚠️ VirtualPersonaDialogue initialization failed');
                            return;
                        }
                    }
                    
                    // 安全なチェック
                    if (typeof window.VirtualPersonaDialogue !== 'undefined' && 
                        window.VirtualPersonaDialogue) {
                        // VirtualPersonaDialogueが利用可能な場合
                    // 結果をOS強度形式に変換
                    const osResults = {
                        engine: {
                            percentage: this.calculateOSStrength(tripleOSResults.engineOS),
                            hexagramName: tripleOSResults.engineOS.hexagramName,
                            description: tripleOSResults.engineOS.description
                        },
                        interface: {
                            percentage: this.calculateOSStrength(tripleOSResults.interfaceOS),
                            hexagramName: tripleOSResults.interfaceOS.hexagramName,
                            description: tripleOSResults.interfaceOS.description
                        },
                        safemode: {
                            percentage: this.calculateOSStrength(tripleOSResults.safeModeOS),
                            hexagramName: tripleOSResults.safeModeOS.hexagramName,
                            description: tripleOSResults.safeModeOS.description
                        }
                    };
                    
                    // 初期対話生成（決断場面）
                    this.currentDialogueScenario = 'decision';
                    this.displayDialogue(osResults, 'decision');
                    
                    // シナリオボタンのイベントリスナー設定
                    this.setupDialogueScenarioButtons(osResults);
                    
                    console.log('✅ Virtual Persona Dialogue rendered successfully');
                    
                    } else {
                        // VirtualPersonaDialogueクラスが見つからない場合
                        console.error('❌ VirtualPersonaDialogue class not found. Check if js/VirtualPersonaDialogue.js is loaded correctly.');
                        throw new Error('VirtualPersonaDialogue not loaded');
                    }
                } catch (error) {
                    console.error('❌ Virtual Persona Dialogue rendering failed:', error);
                    // 根本原因を特定して修正が必要
                    throw error;
                }
            }
            
            // 対話表示メソッド（Task 3: エラーハンドリング強化）
            async displayDialogue(osResults, scenarioType) {
                try {
                    const container = document.getElementById('persona-dialogue-container');
                    if (!container) {
                        console.warn('⚠️ Dialogue container not found');
                        return;
                    }
                    
                    // 初期化確認
                    if (!this.virtualPersonaDialogueInitialized) {
                        container.innerHTML = '<p style="color: #666;">対話システムを初期化中...</p>';
                        const initialized = await this.initializeVirtualPersonaDialogue();
                        if (!initialized) {
                            container.innerHTML = '<p style="color: #999;">対話システムは現在利用できません</p>';
                            return;
                        }
                    }
                    
                    // インスタンスがない場合は作成済みのものを使用
                    if (!this.virtualPersonaDialogue) {
                        console.error('❌ VirtualPersonaDialogue instance not available after initialization');
                        container.innerHTML = '<p style="color: #999;">対話システムの初期化に失敗しました</p>';
                        return;
                    }
                    
                    // generateDialogueメソッドの存在確認
                    if (typeof this.virtualPersonaDialogue.generateDialogue !== 'function') {
                        console.error('❌ generateDialogue method not found');
                        container.innerHTML = '<p style="color: #999;">対話生成機能が利用できません</p>';
                        return;
                    }
                    
                    const dialogue = this.virtualPersonaDialogue.generateDialogue(osResults, scenarioType);
                    
                    if (!dialogue || !dialogue.participants || !Array.isArray(dialogue.participants)) {
                        console.warn('⚠️ Invalid dialogue generated:', dialogue);
                        container.innerHTML = '<p style="color: #999;">対話データの生成に失敗しました</p>';
                        return;
                    }
                
                // 対話HTML生成
                const dialogueHTML = `
                    <div class="dialogue-situation">
                        <h4 class="situation-title">${dialogue.scenario.situation}</h4>
                        <p class="situation-context">${dialogue.scenario.description}</p>
                    </div>
                    
                    <div class="dialogue-participants">
                        ${dialogue.participants.map(participant => {
                            const strengthLevel = participant.strength >= 70 ? 'high' : 
                                                participant.strength >= 40 ? 'medium' : 'low';
                            const personaClass = participant.persona.type;
                            
                            return `
                                <div class="persona-dialogue-card ${personaClass}" data-strength="${strengthLevel}">
                                    <div class="persona-header">
                                        <div style="display: flex; align-items: center;">
                                            <span class="persona-symbol">${participant.persona.symbol}</span>
                                            <h4 class="persona-name">${participant.persona.name}</h4>
                                        </div>
                                        <div class="strength-indicator">${participant.strength}%</div>
                                    </div>
                                    <div class="persona-message">
                                        <p class="dialogue-text">${participant.message}</p>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `;
                
                container.innerHTML = dialogueHTML;
                    
                } catch (error) {
                    console.error('❌ Error in displayDialogue:', error);
                    const container = document.getElementById('persona-dialogue-container');
                    if (container) {
                        container.innerHTML = '<p style="color: #999;">対話の表示中にエラーが発生しました</p>';
                    }
                }
            }
            
            // シナリオボタン設定
            setupDialogueScenarioButtons(osResults) {
                const buttons = document.querySelectorAll('.scenario-btn');
                
                buttons.forEach(button => {
                    button.addEventListener('click', () => {
                        // アクティブボタン切り替え
                        buttons.forEach(btn => btn.classList.remove('active'));
                        button.classList.add('active');
                        
                        // 新しいシナリオの対話生成
                        const scenarioType = button.getAttribute('data-scenario');
                        this.currentDialogueScenario = scenarioType;
                        this.displayDialogue(osResults, scenarioType);
                        
                        console.log(`🎭 Dialogue scenario changed to: ${scenarioType}`);
                    });
                });
            }
            
            saveResults(tripleOSResults) {
                try {
                    // 契約A形式（v1.1）に準拠した保存形式
                    const contractA = {
                        version: "1.1",
                        engine_os: {
                            id: tripleOSResults.engineOS?.hexagramId || 1,
                            name: this.getHexagramName(tripleOSResults.engineOS?.hexagramId || 1),
                            score: (tripleOSResults.engineOS?.strength || 0) / 100
                        },
                        interface_os: {
                            id: tripleOSResults.interfaceOS?.hexagramId || 2,
                            name: this.getHexagramName(tripleOSResults.interfaceOS?.hexagramId || 2),
                            score: (tripleOSResults.interfaceOS?.strength || 0) / 100
                        },
                        safe_mode_os: {
                            id: tripleOSResults.safeModeOS?.hexagramId || 29,
                            name: this.getHexagramName(tripleOSResults.safeModeOS?.hexagramId || 29),
                            score: (tripleOSResults.safeModeOS?.strength || 0) / 100
                        },
                        synergy: {
                            matrix: this.calculateSynergyMatrix(tripleOSResults),
                            notes: "Engine-Interface-Safe Mode間の相互作用パターン"
                        },
                        interactions: {
                            pair_insights: [
                                {
                                    pair: "engine-interface",
                                    category: this.categorizePairInteraction(tripleOSResults.engineOS, tripleOSResults.interfaceOS),
                                    score: this.calculatePairScore(tripleOSResults.engineOS, tripleOSResults.interfaceOS),
                                    summary: "創造性と社会性の調和"
                                },
                                {
                                    pair: "engine-safe",
                                    category: this.categorizePairInteraction(tripleOSResults.engineOS, tripleOSResults.safeModeOS),
                                    score: this.calculatePairScore(tripleOSResults.engineOS, tripleOSResults.safeModeOS),
                                    summary: "理想と現実の葛藤"
                                },
                                {
                                    pair: "interface-safe",
                                    category: this.categorizePairInteraction(tripleOSResults.interfaceOS, tripleOSResults.safeModeOS),
                                    score: this.calculatePairScore(tripleOSResults.interfaceOS, tripleOSResults.safeModeOS),
                                    summary: "社会性と防御性のバランス"
                                }
                            ],
                            affordances: {
                                engine: {
                                    thrives_with: ["革新的な環境", "自由な発想が許される場"],
                                    struggles_with: ["過度な制約", "創造性を抑圧する環境"]
                                },
                                interface: {
                                    thrives_with: ["協調的なチーム", "対話重視の環境"],
                                    struggles_with: ["孤立した作業", "競争的な環境"]
                                },
                                safe: {
                                    thrives_with: ["安定した環境", "明確なルール"],
                                    struggles_with: ["不確実性の高い状況", "急激な変化"]
                                }
                            },
                            inner_conflicts: ["創造性と安定性の対立", "社会性と独立性の葛藤"],
                            integration_prompts: [
                                "どの環境で最も自分らしさを発揮できますか？",
                                "異なる側面をどう統合していけますか？"
                            ]
                        },
                        strengths: this.extractStrengths(tripleOSResults),
                        risks: this.extractRisks(tripleOSResults),
                        created_at: new Date().toISOString()
                    };
                    
                    // 契約A形式で保存
                    localStorage.setItem('haqei_triple_os_results', JSON.stringify(contractA));
                    
                    // 後方互換性のため旧形式でも保存
                    localStorage.setItem('haqei_emergency_results', JSON.stringify({
                        timestamp: contractA.created_at,
                        answers: this.state.answers,
                        tripleOSResults: tripleOSResults,
                        version: '2.0',
                        HaQeiCompliant: true
                    }));
                    
                    console.log('✅ Triple OS Results saved in Contract A format (v1.1)');
                } catch (error) {
                    console.warn('⚠️ Failed to save results:', error);
                }
            }
            
            // ヘルパーメソッド群
            getHexagramName(id) {
                const names = {
                    1: "乾為天", 2: "坤為地", 3: "水雷屯", 4: "山水蒙",
                    5: "水天需", 6: "天水訟", 7: "地水師", 8: "水地比",
                    9: "風天小畜", 10: "天沢履", 11: "地天泰", 12: "天地否",
                    13: "天火同人", 14: "火天大有", 15: "地山謙", 16: "雷地予",
                    17: "沢雷随", 18: "山風蠱", 19: "地沢臨", 20: "風地観",
                    21: "火雷噬嗑", 22: "山火賁", 23: "山地剥", 24: "地雷復",
                    25: "天雷無妄", 26: "山天大畜", 27: "山雷頤", 28: "沢風大過",
                    29: "坎為水", 30: "離為火", 31: "沢山咸", 32: "雷風恒",
                    33: "天山遯", 34: "雷天大壮", 35: "火地晋", 36: "地火明夷",
                    37: "風火家人", 38: "火沢睽", 39: "水山蹇", 40: "雷水解",
                    41: "山沢損", 42: "風雷益", 43: "沢天夬", 44: "天風姤",
                    45: "沢地萃", 46: "地風升", 47: "沢水困", 48: "水風井",
                    49: "沢火革", 50: "火風鼎", 51: "震為雷", 52: "艮為山",
                    53: "風山漸", 54: "雷沢帰妹", 55: "雷火豊", 56: "火山旅",
                    57: "巽為風", 58: "兌為沢", 59: "風水渙", 60: "水沢節",
                    61: "風沢中孚", 62: "雷山小過", 63: "水火既済", 64: "火水未済"
                };
                return names[id] || `卦${id}`;
            }
            
            calculateSynergyMatrix(results) {
                // 簡易的な相互作用マトリクス計算
                return [
                    [0, 0.2, -0.1],
                    [0.2, 0, -0.05],
                    [-0.1, -0.05, 0]
                ];
            }
            
            categorizePairInteraction(os1, os2) {
                // ペア相互作用のカテゴリ分類
                const diff = Math.abs((os1?.strength || 0) - (os2?.strength || 0));
                if (diff < 10) return "HARMONY";
                if (diff < 30) return "SYNERGY";
                if (diff < 50) return "TENSION";
                return "CONFLICT";
            }
            
            calculatePairScore(os1, os2) {
                // ペアスコア計算
                const avg = ((os1?.strength || 0) + (os2?.strength || 0)) / 200;
                return Math.round(avg * 100) / 100;
            }
            
            extractStrengths(results) {
                const strengths = [];
                if (results.engineOS?.dominantTrigram) {
                    strengths.push(`${results.engineOS.dominantTrigram}による創造力`);
                }
                if (results.interfaceOS?.dominantTrigram) {
                    strengths.push(`${results.interfaceOS.dominantTrigram}による社会性`);
                }
                if (results.safeModeOS?.dominantTrigram) {
                    strengths.push(`${results.safeModeOS.dominantTrigram}による防御力`);
                }
                return strengths;
            }
            
            extractRisks(results) {
                return [
                    "過度な理想主義による現実逃避",
                    "社会的圧力による自己喪失",
                    "防御過剰による成長機会の喪失"
                ];
            }
            
            showError(message) {
                this.showScreen('error-screen');
                document.getElementById('error-message').textContent = message;
                this.announce('エラーが発生しました');
            }
            
            restart() {
                // 状態をクリア
                this.state.clearState();
                this.state.currentQuestion = 0;
                this.state.answers = [];
                this.state.tripleOSResults = null;
                this.state.isAnalyzing = false;
                
                // UI初期化
                this.initializeTrigramScores();
                this.showScreen('welcome-screen');
                this.announce('分析がリセットされました');
            }
            
            announce(message) {
                const announcements = document.getElementById('announcements');
                announcements.textContent = message;
                
                // 一定時間後にクリア
                setTimeout(() => {
                    announcements.textContent = '';
                }, 3000);
            }
            
            // 統一実装体制: OSアナライザー専用エラーハンドリング
            handleOSAnalyzerError(errorType, errorMessage) {
                console.error(`🚨 [OSAnalyzer] ${errorType}: ${errorMessage}`);
                
                // 統一実装フレームワーク: エラータイプ別処理
                const OSAnalyzerErrors = {
                    'EVENT_BINDING_ERROR': 'イベントバインディング中にエラーが発生しました',
                    'CALCULATION_ERROR': 'OSアナライザー計算中にエラーが発生しました',
                    'DATA_INSUFFICIENT': '回答データが不完全です（36問未完了）',
                    'SYSTEM_ERROR': 'OSアナライザーシステムエラーが発生しました'
                };
                
                const userFriendlyMessage = OSAnalyzerErrors[errorType] || '予期しないエラーが発生しました';
                
                // 軽微なエラーの場合は警告のみ
                if (errorType === 'EVENT_BINDING_ERROR') {
                    console.warn(`⚠️ [OSAnalyzer] ${userFriendlyMessage} - アプリケーションは継続します`);
                    this.announce(`注意: ${userFriendlyMessage}`);
                    return;
                }
                
                // 重大なエラーの場合はエラー画面表示
                try {
                    const errorMessageElement = document.getElementById('error-message');
                    if (errorMessageElement) {
                        errorMessageElement.textContent = `${userFriendlyMessage}\n\n技術情報: ${errorMessage}`;
                        this.showScreen('error-screen');
                    } else {
                        // フォールバック: console + alert
                        alert(`${userFriendlyMessage}\n\n詳細はコンソールをご確認ください。`);
                    }
                } catch (displayError) {
                    console.error('❌ [OSAnalyzer] Error display failed:', displayError);
                    alert(`エラーが発生しました: ${userFriendlyMessage}`);
                }
            }
            
            delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
            
            // 🚨 絶対要件: 簡易アドバイス機能
            displayQuickAdvice(tripleOSResults) {
                console.log('💡 Generating quick advice for Triple OS results');
                
                // OSタイプ別の簡易アドバイスマッピング
                const quickAdviceMap = {
                    '乾': { 
                        advice: '創造的なリーダーシップを発揮する時期です', 
                        action: '新しいプロジェクトを始める',
                        caution: '独断専行に注意' 
                    },
                    '坤': { 
                        advice: '受容と協調を大切にする時期です', 
                        action: 'チームワークを重視する',
                        caution: '過度な依存を避ける' 
                    },
                    '震': { 
                        advice: '積極的に行動を起こす時期です', 
                        action: '新しい挑戦を恐れない',
                        caution: '衝動的な決断に注意' 
                    },
                    '巽': { 
                        advice: '柔軟性と適応力が重要な時期です', 
                        action: '状況に応じて調整する',
                        caution: '優柔不断にならない' 
                    },
                    '坎': { 
                        advice: '困難を乗り越える知恵が必要な時期です', 
                        action: '深く考察し解決策を見つける',
                        caution: '孤立しないよう注意' 
                    },
                    '離': { 
                        advice: '明確なビジョンを持つ時期です', 
                        action: '目標を明確にして進む',
                        caution: '理想と現実のバランスを保つ' 
                    },
                    '艮': { 
                        advice: '一度立ち止まって振り返る時期です', 
                        action: '現状を冷静に分析する',
                        caution: '停滞しすぎないよう注意' 
                    },
                    '兌': { 
                        advice: '喜びと交流を大切にする時期です', 
                        action: 'コミュニケーションを活発にする',
                        caution: '表面的な関係に注意' 
                    }
                };
                
                // 各OSの主要な八卦を取得
                const getMainTrigram = (os) => {
                    if (os && os.upperBagua) {
                        return os.upperBagua.name;
                    }
                    return '乾'; // デフォルト
                };
                
                // アドバイスコンテナを作成または取得
                let adviceContainer = document.getElementById('quick-advice-container');
                if (!adviceContainer) {
                    const resultsContent = document.querySelector('#results-screen .results-content');
                    if (resultsContent) {
                        adviceContainer = document.createElement('div');
                        adviceContainer.id = 'quick-advice-container';
                        adviceContainer.className = 'quick-advice-section';
                        adviceContainer.style.cssText = `
                            margin-top: var(--space-xl);
                            padding: var(--space-lg);
                            background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05));
                            border: 1px solid rgba(99, 102, 241, 0.3);
                            border-radius: var(--radius-lg);
                        `;
                        resultsContent.appendChild(adviceContainer);
                    }
                }
                
                if (adviceContainer) {
                    const engineTrigram = getMainTrigram(tripleOSResults.engineOS);
                    const interfaceTrigram = getMainTrigram(tripleOSResults.interfaceOS);
                    const safeModeTrigram = getMainTrigram(tripleOSResults.safeModeOS);
                    
                    const engineAdvice = quickAdviceMap[engineTrigram] || quickAdviceMap['乾'];
                    const interfaceAdvice = quickAdviceMap[interfaceTrigram] || quickAdviceMap['坤'];
                    const safeModeAdvice = quickAdviceMap[safeModeTrigram] || quickAdviceMap['艮'];
                    
                    adviceContainer.innerHTML = `
                        <h3 style="color: var(--primary-100); margin-bottom: var(--space-lg); text-align: center; font-size: 1.5rem;">
                            💡 簡易アドバイス
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: var(--space-lg);">
                            <!-- Engine OS アドバイス -->
                            <div class="advice-card" style="background: rgba(99, 102, 241, 0.1); padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #6366f1;">
                                <h4 style="color: #6366f1; margin-bottom: var(--space-sm);">Engine OS からのメッセージ</h4>
                                <p style="color: var(--primary-100); margin-bottom: var(--space-sm);">${engineAdvice.advice}</p>
                                <div style="margin-top: var(--space-sm); padding-top: var(--space-sm); border-top: 1px solid rgba(99, 102, 241, 0.2);">
                                    <p style="color: var(--success-500); font-size: 0.9rem;">
                                        ✅ 推奨アクション: ${engineAdvice.action}
                                    </p>
                                    <p style="color: var(--warning-500); font-size: 0.9rem; margin-top: var(--space-xs);">
                                        ⚠️ 注意点: ${engineAdvice.caution}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Interface OS アドバイス -->
                            <div class="advice-card" style="background: rgba(139, 92, 246, 0.1); padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #8b5cf6;">
                                <h4 style="color: #8b5cf6; margin-bottom: var(--space-sm);">Interface OS からのメッセージ</h4>
                                <p style="color: var(--primary-100); margin-bottom: var(--space-sm);">${interfaceAdvice.advice}</p>
                                <div style="margin-top: var(--space-sm); padding-top: var(--space-sm); border-top: 1px solid rgba(139, 92, 246, 0.2);">
                                    <p style="color: var(--success-500); font-size: 0.9rem;">
                                        ✅ 推奨アクション: ${interfaceAdvice.action}
                                    </p>
                                    <p style="color: var(--warning-500); font-size: 0.9rem; margin-top: var(--space-xs);">
                                        ⚠️ 注意点: ${interfaceAdvice.caution}
                                    </p>
                                </div>
                            </div>
                            
                            <!-- Safe Mode OS アドバイス -->
                            <div class="advice-card" style="background: rgba(16, 185, 129, 0.1); padding: var(--space-md); border-radius: var(--radius-md); border-left: 4px solid #10b981;">
                                <h4 style="color: #10b981; margin-bottom: var(--space-sm);">Safe Mode OS からのメッセージ</h4>
                                <p style="color: var(--primary-100); margin-bottom: var(--space-sm);">${safeModeAdvice.advice}</p>
                                <div style="margin-top: var(--space-sm); padding-top: var(--space-sm); border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                    <p style="color: var(--success-500); font-size: 0.9rem;">
                                        ✅ 推奨アクション: ${safeModeAdvice.action}
                                    </p>
                                    <p style="color: var(--warning-500); font-size: 0.9rem; margin-top: var(--space-xs);">
                                        ⚠️ 注意点: ${safeModeAdvice.caution}
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 統合アドバイス -->
                        <div style="margin-top: var(--space-lg); padding: var(--space-md); background: rgba(168, 85, 247, 0.05); border-radius: var(--radius-md); border: 1px solid rgba(168, 85, 247, 0.2);">
                            <h4 style="color: var(--accent-300); margin-bottom: var(--space-sm);">🎯 総合的な行動指針</h4>
                            <p style="color: var(--primary-200); line-height: 1.6;">
                                あなたの3つのOSが示す方向性を統合すると、創造性と調和と慎重さのバランスを保ちながら進むことが重要な時期といえるでしょう。
                            </p>
                        </div>
                        
                        <!-- 有料版への誘導 -->
                        <div style="margin-top: var(--space-lg); padding: var(--space-md); background: linear-gradient(135deg, rgba(251, 191, 36, 0.05), rgba(245, 158, 11, 0.05)); border: 1px solid rgba(251, 191, 36, 0.3); border-radius: var(--radius-md);">
                            <p style="color: var(--warning-500); text-align: center; font-size: 0.9rem;">
                                🌟 より詳細なパーソナライズド戦略をお求めの方へ
                            </p>
                            <p style="color: var(--primary-300); text-align: center; margin-top: var(--space-sm); font-size: 0.85rem;">
                                Strategic Cockpit（有料版）では、あなただけの完全な戦略書PDFを生成し、<br>
                                月次でアップデートされる行動計画をご提供します
                            </p>
                            <button onclick="window.location.href='./pricing.html'" style="
                                display: block;
                                margin: var(--space-md) auto 0;
                                padding: var(--space-sm) var(--space-lg);
                                background: linear-gradient(135deg, #fbbf24, #f59e0b);
                                color: #111827;
                                border: none;
                                border-radius: var(--radius-md);
                                font-weight: bold;
                                cursor: pointer;
                                transition: transform 0.2s, box-shadow 0.2s;
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 10px 25px rgba(251, 191, 36, 0.3)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                プレミアムプランを見る →
                            </button>
                        </div>
                    `;
                }
            }
            
            // 🚨 絶対要件: 理論的特性分析表示
            showTheoreticalCharacteristics(tripleOSResults) {
                console.log('📈 Showing theoretical characteristics for Triple OS results');
                
                // 理論的特性分析
                const characteristics = {
                    engineOS: this.calculateTheoreticalRarity(tripleOSResults.engineOS),
                    interfaceOS: this.calculateTheoreticalRarity(tripleOSResults.interfaceOS),
                    safeModeOS: this.calculateTheoreticalRarity(tripleOSResults.safeModeOS)
                };
                
                // 特性コンテナを作成または取得
                let characteristicsContainer = document.getElementById('theoretical-characteristics-container');
                if (!characteristicsContainer) {
                    const resultsContent = document.querySelector('#results-screen .results-content');
                    if (resultsContent) {
                        characteristicsContainer = document.createElement('div');
                        characteristicsContainer.id = 'theoretical-characteristics-container';
                        characteristicsContainer.className = 'characteristics-section';
                        characteristicsContainer.style.cssText = `
                            margin-top: var(--space-xl);
                            padding: var(--space-lg);
                            background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(16, 185, 129, 0.05));
                            border: 1px solid rgba(34, 197, 94, 0.3);
                            border-radius: var(--radius-lg);
                        `;
                        resultsContent.appendChild(characteristicsContainer);
                    }
                }
                
                if (characteristicsContainer) {
                    characteristicsContainer.innerHTML = `
                        <h3 style="color: var(--success-500); margin-bottom: var(--space-lg); text-align: center; font-size: 1.5rem;">
                            📊 理論的特性分析
                        </h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-lg);">
                            ${this.renderCharacteristicsCard('Engine OS', characteristics.engineOS, '#6366f1')}
                            ${this.renderCharacteristicsCard('Interface OS', characteristics.interfaceOS, '#8b5cf6')}
                            ${this.renderCharacteristicsCard('Safe Mode OS', characteristics.safeModeOS, '#10b981')}
                        </div>
                        
                        <!-- 全体的な特性 -->
                        <div style="margin-top: var(--space-lg); padding: var(--space-md); background: rgba(99, 102, 241, 0.05); border-radius: var(--radius-md);">
                            <h4 style="color: var(--primary-200); margin-bottom: var(--space-sm);">📍 あなたの総合的な特性</h4>
                            <p style="color: var(--primary-200); line-height: 1.6;">
                                ${this.generateOverallCharacteristics(characteristics)}
                            </p>
                        </div>
                        
                        <!-- ティーザー: より詳細な分析へ -->
                        <div style="margin-top: var(--space-md); padding: var(--space-sm); background: rgba(251, 191, 36, 0.05); border-radius: var(--radius-sm); text-align: center;">
                            <p style="color: var(--warning-500); font-size: 0.9rem;">
                                💎 プレミアム会員になると、易経理論に基づくさらに詳細な特性分析をご提供します
                            </p>
                        </div>
                    `;
                }
            }
            
            // 理論的希少性を計算
            calculateTheoreticalRarity(os) {
                const hexagramId = os.hexagramId || 1;
                const combinationFactor = ((hexagramId * 17) % 100) + 20;
                const rarity = Math.max(5, Math.min(95, combinationFactor));
                
                return {
                    uniqueness: Math.round(rarity),
                    balanceType: this.determineBalanceType(rarity),
                    combinationPattern: this.analyzeCombinationPattern(hexagramId),
                    theoreticalTraits: this.identifyTheoreticalTraits(rarity)
                };
            }
            
            // バランスタイプ判定
            determineBalanceType(rarity) {
                if (rarity >= 80) return { type: '創造性重視型', color: '#fbbf24' };
                if (rarity >= 60) return { type: '調和重視型', color: '#a78bfa' };
                if (rarity >= 40) return { type: 'バランス型', color: '#60a5fa' };
                if (rarity >= 20) return { type: '安定重視型', color: '#10b981' };
                return { type: '適応重視型', color: '#8b5cf6' };
            }
            
            // 組み合わせパターン分析
            analyzeCombinationPattern(hexagramId) {
                const patterns = ['創造×協調パターン', '行動×探求パターン', '安定×適応パターン', '表現×受容パターン'];
                return patterns[hexagramId % 4];
            }
            
            // 理論的特質特定
            identifyTheoreticalTraits(rarity) {
                if (rarity >= 75) {
                    return '易経理論上、変化を創造する力の強いタイプです';
                } else if (rarity >= 50) {
                    return 'バランスの取れた適応力を持つタイプです';
                } else if (rarity >= 25) {
                    return '調和を重視し、安定した成長を目指すタイプです';
                } else {
                    return '独自の視点を持ち、新しいアプローチを見つけるタイプです';
                }
            }
            
            // 特性カードをレンダリング
            renderCharacteristicsCard(title, data, color) {
                return `
                    <div style="background: rgba(255, 255, 255, 0.02); padding: var(--space-md); border-radius: var(--radius-md); border: 1px solid ${color}30;">
                        <h4 style="color: ${color}; margin-bottom: var(--space-md);">${title}</h4>
                        
                        <!-- 理論的希少性表示 -->
                        <div style="margin-bottom: var(--space-md);">
                            <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                <span style="color: var(--primary-300); font-size: 0.9rem;">理論的希少性</span>
                                <span style="color: ${color}; font-weight: bold;">${data.uniqueness}/100</span>
                            </div>
                            <div style="height: 8px; background: rgba(255, 255, 255, 0.1); border-radius: 4px; overflow: hidden;">
                                <div style="height: 100%; width: ${data.uniqueness}%; background: linear-gradient(90deg, ${color}40, ${color}); transition: width 1s ease-out;"></div>
                            </div>
                        </div>
                        
                        <!-- バランスタイプ表示 -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-sm);">
                            <span style="color: var(--primary-300); font-size: 0.9rem;">バランスタイプ</span>
                            <span style="color: ${data.balanceType.color}; font-weight: bold;">${data.balanceType.type}</span>
                        </div>
                        
                        <!-- 組み合わせパターン -->
                        <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-sm);">
                            <span style="color: var(--primary-300); font-size: 0.9rem;">パターン</span>
                            <span style="color: var(--primary-200);">${data.combinationPattern}</span>
                        </div>
                        
                        <!-- 理論的特質 -->
                        <div style="margin-top: var(--space-md); padding-top: var(--space-sm); border-top: 1px solid ${color}20;">
                            <p style="color: var(--primary-200); font-size: 0.85rem; line-height: 1.4;">
                                ${data.theoreticalTraits}
                            </p>
                        </div>
                    </div>
                `;
            }
            
            // 総合的な特性を生成
            generateOverallCharacteristics(characteristics) {
                const avgUniqueness = Math.round(
                    (characteristics.engineOS.uniqueness + 
                     characteristics.interfaceOS.uniqueness + 
                     characteristics.safeModeOS.uniqueness) / 3
                );
                
                if (avgUniqueness >= 70) {
                    return `あなたのTriple OSの組み合わせは、易経理論上非常にユニークなパターンです（理論値: ${avgUniqueness}/100）。この独自性は、革新的な問題解決能力と独創的な視点をもたらします。特に、既存の枠組みを超えた新しいアプローチを必要とする状況で、その真価を発揮するでしょう。`;
                } else if (avgUniqueness >= 30) {
                    return `あなたのTriple OSは、バランスの取れた理論的分布を示しています（理論値: ${avgUniqueness}/100）。これは、様々な状況に適応できる柔軟性と、多くの人と共感・協働できる能力を示唆しています。チームでの活動や、多様な視点を統合する役割に適しています。`;
                } else {
                    return `あなたのTriple OSパターンは、易経理論上特殊な分布を示しています（理論値: ${avgUniqueness}/100）。この特性は、従来とは異なる視点や方法論を持つことを意味し、イノベーションの源泉となる可能性を秘めています。既存の常識にとらわれない発想が、新しい価値を生み出すでしょう。`;
                }
            }
            
            // Triple OSデータ復元機能
            checkAndRestoreTripleOSData() {
                try {
                    console.log('🔍 Checking for saved Triple OS data...');
                    
                    // 保存されたデータを確認
                    const savedTripleOSData = localStorage.getItem('haqei_triple_os_results');
                    
                    if (!savedTripleOSData) {
                        console.log('ℹ️ No saved Triple OS data found');
                        return;
                    }
                    
                    const data = JSON.parse(savedTripleOSData);
                    const saveDate = new Date(data.timestamp || Date.now());
                    const hoursSinceAnalysis = (Date.now() - saveDate.getTime()) / (1000 * 60 * 60);
                    
                    console.log(`📊 Found saved Triple OS data from ${saveDate.toLocaleString()} (${Math.round(hoursSinceAnalysis)}h ago)`);
                    
                    // 24時間以内のデータの場合、復元オプションを表示
                    if (hoursSinceAnalysis < 24) {
                        this.showDataRestoreOption(data, saveDate);
                    } else {
                        console.log('⏰ Saved data is older than 24 hours, not offering restore');
                    }
                    
                } catch (error) {
                    console.error('❌ Error checking saved Triple OS data:', error);
                }
            }
            
            // データ復元オプション表示
            showDataRestoreOption(data, saveDate) {
                const restoreNotification = document.createElement('div');
                restoreNotification.id = 'restore-notification';
                restoreNotification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: rgba(30, 41, 59, 0.95);
                    border: 1px solid #6366f1;
                    border-radius: 12px;
                    padding: 16px;
                    max-width: 320px;
                    z-index: 1000;
                    backdrop-filter: blur(8px);
                    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
                    color: #ffffff;
                `;
                
                restoreNotification.innerHTML = `
                    <div style="display: flex; align-items: start; gap: 12px;">
                        <div style="color: #6366f1; font-size: 20px;">💾</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 6px; color: #6366f1;">
                                前回の分析結果が見つかりました
                            </div>
                            <div style="font-size: 14px; color: #cbd5e1; margin-bottom: 12px;">
                                ${saveDate.toLocaleString()}の分析結果を復元しますか？
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <button id="restore-yes" style="background: #6366f1; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    復元する
                                </button>
                                <button id="restore-no" style="background: transparent; color: #cbd5e1; border: 1px solid #475569; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 12px;">
                                    新規分析
                                </button>
                            </div>
                        </div>
                        <button id="restore-close" style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 16px; padding: 2px;">×</button>
                    </div>
                `;
                
                document.body.appendChild(restoreNotification);
                
                // イベントリスナー設定
                document.getElementById('restore-yes').onclick = () => {
                    this.restoreTripleOSResults(data);
                    restoreNotification.remove();
                };
                
                document.getElementById('restore-no').onclick = () => {
                    restoreNotification.remove();
                    this.announce('新しい分析を開始します');
                };
                
                document.getElementById('restore-close').onclick = () => {
                    restoreNotification.remove();
                };
                
                // 10秒後に自動で閉じる
                setTimeout(() => {
                    if (document.getElementById('restore-notification')) {
                        restoreNotification.remove();
                    }
                }, 10000);
            }
            
            // Triple OS結果復元
            restoreTripleOSResults(data) {
                try {
                    console.log('🔄 Restoring Triple OS results...');
                    
                    // 結果画面に直接ジャンプ
                    this.showScreen('results-screen');
                    
                    // 状態を復元
                    this.state.tripleOSResults = data.tripleOSResults || data;
                    
                    // 結果を再表示
                    this.showResults(this.state.tripleOSResults);
                    
                    // 成功メッセージ
                    this.announce('前回の分析結果を復元しました');
                    
                    console.log('✅ Triple OS results restored successfully');
                    
                } catch (error) {
                    console.error('❌ Error restoring Triple OS results:', error);
                    this.announce('復元に失敗しました。新しい分析を開始してください。');
                }
            }
        }
        
        // 5. アプリケーション初期化
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // 統一実装体制: DOM Ready確認機能
                console.log('🔧 [OSAnalyzer] DOM Ready confirmation starting...');
                
                // DOM準備状態の詳細確認
                const domReadyStatus = {
                    readyState: document.readyState,
                    timestamp: new Date().toISOString(),
                    bodyExists: !!document.body,
                    headExists: !!document.head,
                    scriptsLoaded: document.querySelectorAll('script').length,
                    elementsCount: document.querySelectorAll('*').length
                };
                
                console.log('📊 [OSAnalyzer] DOM Status:', domReadyStatus);
                
                // 重要なDOM要素の存在確認
                const criticalElements = [
                    'welcome-screen',
                    'question-screen', 
                    'results-screen',
                    'error-screen',
                    'main-content'
                ];
                
                const elementStatus = {};
                let missingElements = 0;
                
                criticalElements.forEach(elementId => {
                    const element = document.getElementById(elementId);
                    elementStatus[elementId] = !!element;
                    if (!element) {
                        missingElements++;
                        console.warn(`⚠️ [OSAnalyzer] Critical element missing: ${elementId}`);
                    }
                });
                
                console.log('🎯 [OSAnalyzer] Critical elements check:', elementStatus);
                
                // DOM Ready 完了判定
                const domReadyComplete = (
                    document.readyState === 'complete' || 
                    document.readyState === 'interactive'
                ) && missingElements === 0;
                
                if (domReadyComplete) {
                    console.log('✅ [OSAnalyzer] DOM Ready confirmation: COMPLETE');
                    console.log('🚀 [OSAnalyzer] Proceeding with application initialization...');
                } else {
                    console.warn('⚠️ [OSAnalyzer] DOM Ready confirmation: INCOMPLETE');
                    console.warn(`   - Ready state: ${document.readyState}`);
                    console.warn(`   - Missing elements: ${missingElements}`);
                }
                
                // 統一実装体制: 初期化開始ログ
                console.log('🎯 HaQei Emergency Analyzer initializing...');
                console.log('🔯 Authentic I-Ching 64 Hexagrams Engine loaded');
                console.log('☰ Trigram Mapping System: HaQei philosophy compliant');
                
                // DAY 2: VirtualPersonaEnhancer 初期化
                window.virtualPersonaEnhancer = new VirtualPersonaEnhancer();
                window.virtualPersonaEnhancer.initialize().then(() => {
                    console.log('✅ VirtualPersonaEnhancer initialized');
                }).catch(error => {
                    console.warn('⚠️ VirtualPersonaEnhancer initialization failed:', error);
                });
                
                // Phase 3: VirtualPersonaDialogue 初期化（Task 3: 修正）
                // 注意: 初期化は renderVirtualPersonaDialogue 内で自動的に行われるため、ここでは不要
                
                // アプリケーション開始
                window.criticalCSSAnalyzer = new CriticalCSSAnalyzer();
                // デバッグとテストのためにcurrentAnalyzerとしても公開
                window.currentAnalyzer = window.criticalCSSAnalyzer;
                
                // P1-1: showToastメソッドを追加
                window.criticalCSSAnalyzer.showToast = function(message, type = 'info') {
                    // 既存のトースト要素を削除
                    const existingToast = document.getElementById('haqei-toast');
                    if (existingToast) {
                        existingToast.remove();
                    }
                    
                    // トースト要素を作成
                    const toast = document.createElement('div');
                    toast.id = 'haqei-toast';
                    toast.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        z-index: 10000;
                        padding: 12px 16px;
                        border-radius: 8px;
                        color: white;
                        font-size: 14px;
                        font-weight: 500;
                        max-width: 300px;
                        opacity: 0;
                        transition: opacity 0.3s ease;
                        background: ${type === 'success' ? '#22c55e' : type === 'error' ? '#ef4444' : '#3b82f6'};
                        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    `;
                    toast.textContent = message;
                    
                    // DOMに追加
                    document.body.appendChild(toast);
                    
                    // フェードイン
                    setTimeout(() => {
                        toast.style.opacity = '1';
                    }, 100);
                    
                    // 3秒後に自動削除
                    setTimeout(() => {
                        toast.style.opacity = '0';
                        setTimeout(() => {
                            if (toast.parentNode) {
                                toast.parentNode.removeChild(toast);
                            }
                        }, 300);
                    }, 3000);
                };
                
                // welcome-screenのstart-btnまでスクロール
                setTimeout(() => {
                    const startBtn = document.getElementById('start-btn');
                    if (startBtn) {
                        startBtn.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }, 500);
                
                console.log('✅ Critical CSS Analyzer ready');
                console.log('📊 Questions loaded:', window.QUESTIONS ? window.QUESTIONS.length : 'not loaded');
                console.log('🎭 Triple OS systems:', Object.keys(TRIPLE_OS).length);
                console.log('🔯 I-Ching Orthodoxy validated: Traditional 64 Hexagram matrix');
                
                // Triple OS データ復元機能
                if (window.criticalCSSAnalyzer && typeof window.criticalCSSAnalyzer.checkAndRestoreTripleOSData === 'function') {
                    window.criticalCSSAnalyzer.checkAndRestoreTripleOSData();
                }
                
                // スモークテストボタンのイベントハンドラー
                const smokeTestBtn = document.getElementById('smoke-test-btn');
                const smokeTestResults = document.getElementById('smoke-test-results');
                
                if (smokeTestBtn && smokeTestResults) {
                    smokeTestBtn.addEventListener('click', async () => {
                        try {
                            smokeTestBtn.disabled = true;
                            smokeTestBtn.textContent = '🧪 テスト実行中...';
                            smokeTestResults.style.display = 'block';
                            smokeTestResults.innerHTML = '<div style="color: #6366f1;">📊 スモークテストを実行しています...</div>';
                            
                            // integration.smoke.jsを動的にインポート
                            const smokeModule = await import('./js/integration.smoke.js');
                            const { DeterminismSmokeTest, PerformanceSmokeTest, FiveLineHealthSmokeTest } = smokeModule;
                            
                            const results = [];
                            
                            // 決定論性テスト
                            const determinismTest = new DeterminismSmokeTest();
                            const determinismResult = await determinismTest.run();
                            results.push({
                                name: '決定論性テスト',
                                status: determinismResult.passed ? 'PASS' : 'FAIL',
                                details: determinismResult.details || determinismResult.message
                            });
                            
                            // 性能テスト
                            const performanceTest = new PerformanceSmokeTest();
                            const performanceResult = await performanceTest.run();
                            results.push({
                                name: '性能テスト',
                                status: performanceResult.passed ? 'PASS' : 'FAIL',
                                details: performanceResult.details || performanceResult.message
                            });
                            
                            // 5爻健全性テスト
                            const fiveLineTest = new FiveLineHealthSmokeTest();
                            const fiveLineResult = await fiveLineTest.run();
                            results.push({
                                name: '5爻健全性テスト',
                                status: fiveLineResult.passed ? 'PASS' : 'FAIL',
                                details: fiveLineResult.details || fiveLineResult.message
                            });
                            
                            // 結果表示
                            const passCount = results.filter(r => r.status === 'PASS').length;
                            const totalCount = results.length;
                            const allPassed = passCount === totalCount;
                            
                            let resultHtml = `
                                <div style="margin-bottom: var(--space-sm); font-weight: bold; color: ${allPassed ? '#22c55e' : '#ef4444'};">
                                    📊 テスト結果: ${passCount}/${totalCount} 通過 ${allPassed ? '✅' : '❌'}
                                </div>
                            `;
                            
                            results.forEach(result => {
                                const statusColor = result.status === 'PASS' ? '#22c55e' : '#ef4444';
                                const statusIcon = result.status === 'PASS' ? '✅' : '❌';
                                resultHtml += `
                                    <div style="margin-bottom: var(--space-xs); padding: var(--space-xs); border-left: 3px solid ${statusColor}; background: rgba(${result.status === 'PASS' ? '34, 197, 94' : '239, 68, 68'}, 0.1);">
                                        <div style="font-weight: bold; color: ${statusColor};">
                                            ${statusIcon} ${result.name}: ${result.status}
                                        </div>
                                        <div style="font-size: 0.85em; color: var(--text-600); margin-top: 2px;">
                                            ${result.details}
                                        </div>
                                    </div>
                                `;
                            });
                            
                            smokeTestResults.innerHTML = resultHtml;
                            
                            // トースト通知
                            if (window.criticalCSSAnalyzer && typeof window.criticalCSSAnalyzer.showToast === 'function') {
                                window.criticalCSSAnalyzer.showToast(
                                    `スモークテスト完了: ${passCount}/${totalCount} 通過`,
                                    allPassed ? 'success' : 'error'
                                );
                            }
                            
                        } catch (error) {
                            console.error('❌ Smoke test failed:', error);
                            smokeTestResults.innerHTML = `
                                <div style="color: #ef4444; font-weight: bold;">❌ テスト実行エラー</div>
                                <div style="font-size: 0.85em; color: var(--text-600); margin-top: 2px;">
                                    ${error.message || 'スモークテストの実行中にエラーが発生しました'}
                                </div>
                            `;
                            
                            if (window.criticalCSSAnalyzer && typeof window.criticalCSSAnalyzer.showToast === 'function') {
                                window.criticalCSSAnalyzer.showToast('スモークテスト実行エラー', 'error');
                            }
                        } finally {
                            smokeTestBtn.disabled = false;
                            smokeTestBtn.textContent = '🧪 スモークテスト実行';
                        }
                    });
                }
                
            } catch (error) {
                console.error('❌ Initialization failed:', error);
                document.body.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: #ef4444;">
                        <h1>初期化エラー</h1>
                        <p>アプリケーションの開始に失敗しました。ページを再読み込みしてください。</p>
                        <button onclick="location.reload()" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #6366f1; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
                            再読み込み
                        </button>
                    </div>
                `;
            }
        });
        
        // 6. パフォーマンス最適化
        // サービスワーカー登録（可能な場合）
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/haqei-sw.js')
                    .then(registration => {
                        console.log('✅ Emergency SW registered');
                    })
                    .catch(error => {
                        console.log('⚠️ SW registration failed (optional)');
                    });
            });
        }
        
        // メモリ最適化
        window.addEventListener('beforeunload', () => {
            if (window.criticalCSSAnalyzer) {
                window.criticalCSSAnalyzer = null;
            }
        });
        
        // エラーハンドリング
        window.addEventListener('error', (event) => {
            console.error('❌ Global error:', event.error);
            if (window.criticalCSSAnalyzer) {
                window.criticalCSSAnalyzer.showError('予期しないエラーが発生しました');
            }
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('❌ Unhandled promise rejection:', event.reason);
            event.preventDefault();
            if (window.criticalCSSAnalyzer) {
                window.criticalCSSAnalyzer.showError('処理中にエラーが発生しました');
            }
        });
        
        console.log('📝 HaQei Critical CSS Analyzer script loaded');
        console.log('🎆 HaQei哲学 Triple OS Engine integrated');
        console.log('✨ Critical CSS optimizations applied');
    </script>

    <!-- P1-1: Triple OS保存専用モジュール -->
    <script>
        // 初期化完了後にモジュール読み込み
        window.addEventListener('load', async function() {
            try {
                // 動的インポートでESモジュールを読み込み
                const module = await import('./js/triple-os-storage.js');
                const { saveTripleOSResults } = module;
                
                console.log('[HAQEI] Triple OS storage module loaded');
                
                // グローバルスコープに保存関数を追加
                if (window.criticalCSSAnalyzer) {
                    window.criticalCSSAnalyzer.saveTripleOSToStorage = function(tripleOSResults) {
                        try {
                            // Triple OSの型ラベルを抽出（暫定的にhexagram名を使用）
                            const engineOS = tripleOSResults?.engineOS?.hexagram || tripleOSResults?.engineOS?.name || 'Unknown';
                            const interfaceOS = tripleOSResults?.interfaceOS?.hexagram || tripleOSResults?.interfaceOS?.name || 'Unknown';
                            const safeModeOS = tripleOSResults?.safeModeOS?.hexagram || tripleOSResults?.safeModeOS?.name || 'Unknown';
                            
                            const payload = {
                                engineOS: engineOS,
                                interfaceOS: interfaceOS,
                                safeModeOS: safeModeOS,
                                source: 'os-analyzer@web'
                            };
                            
                            const savedRecord = saveTripleOSResults(payload, { ttlHours: 24 });
                            
                            // 成功通知（非ブロッキング）
                            this.showToast('OS結果を保存しました（24時間有効）', 'success');
                            console.log('[HAQEI] Triple OS保存成功:', savedRecord);
                            
                        } catch (error) {
                            console.error('[HAQEI] Triple OS保存失敗:', error);
                            this.showToast('OS結果の保存に失敗しました。ブラウザ設定をご確認ください。', 'error');
                        }
                    };
                    console.log('[HAQEI] saveTripleOSToStorage method attached');
                } else {
                    console.warn('[HAQEI] criticalCSSAnalyzer not found, retrying in 1 second...');
                    // 1秒後にリトライ
                    setTimeout(() => {
                        if (window.criticalCSSAnalyzer) {
                            window.criticalCSSAnalyzer.saveTripleOSToStorage = function(tripleOSResults) {
                                try {
                                    const engineOS = tripleOSResults?.engineOS?.hexagram || tripleOSResults?.engineOS?.name || 'Unknown';
                                    const interfaceOS = tripleOSResults?.interfaceOS?.hexagram || tripleOSResults?.interfaceOS?.name || 'Unknown';
                                    const safeModeOS = tripleOSResults?.safeModeOS?.hexagram || tripleOSResults?.safeModeOS?.name || 'Unknown';
                                    
                                    const payload = {
                                        engineOS: engineOS,
                                        interfaceOS: interfaceOS,
                                        safeModeOS: safeModeOS,
                                        source: 'os-analyzer@web'
                                    };
                                    
                                    const savedRecord = saveTripleOSResults(payload, { ttlHours: 24 });
                                    this.showToast('OS結果を保存しました（24時間有効）', 'success');
                                    console.log('[HAQEI] Triple OS保存成功:', savedRecord);
                                    
                                } catch (error) {
                                    console.error('[HAQEI] Triple OS保存失敗:', error);
                                    this.showToast('OS結果の保存に失敗しました。ブラウザ設定をご確認ください。', 'error');
                                }
                            };
                            console.log('[HAQEI] saveTripleOSToStorage method attached (retry)');
                        } else {
                            console.error('[HAQEI] criticalCSSAnalyzer still not available');
                        }
                    }, 1000);
                }
                
            } catch (error) {
                console.error('[HAQEI] Failed to load Triple OS storage module:', error);
            }
        });
        
        // 失敗イベントのハンドリング
        window.addEventListener('haqei:tripleos:save-error', (e) => {
            const message = e.detail?.message || '保存エラー';
            if (window.criticalCSSAnalyzer && typeof window.criticalCSSAnalyzer.showToast === 'function') {
                window.criticalCSSAnalyzer.showToast(message, 'error');
            } else {
                console.error('[HAQEI] Toast function not available:', message);
            }
        });
    </script>
</body>
</html>