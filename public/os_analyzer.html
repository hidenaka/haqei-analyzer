<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaQei Triple OS Analyzer</title>
    <!-- モダンCSSを確実に読み込む -->
    <link rel="stylesheet" href="styles-modern.css">
    
    <!-- インラインスタイルで確実に適用 -->
    <style>
        /* 画面切り替えの最小限のスタイル */
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block !important;
        }
        
        /* bodyの古い紫背景を上書き */
        body {
            background: linear-gradient(180deg, #fafafa 0%, #f4f4f5 100%) !important;
        }
    </style>
    
    <!-- 通知スタブ（最初期に定義） -->
    <script>
      if (!window.notifications) {
        (function(){
          function log(level, message) {
            try {
              if (level === 'error' && window.ErrorDisplayUI && typeof window.ErrorDisplayUI.displayError === 'function') {
                window.ErrorDisplayUI.displayError(message);
                return;
              }
            } catch (e) {}
            var prefixMap = { error: '[NOTIFICATION ERROR]:', warning: '[NOTIFICATION WARNING]:', info: '[NOTIFICATION INFO]:', success: '[NOTIFICATION SUCCESS]:' };
            var logger = (level === 'error') ? console.error : (level === 'warning') ? console.warn : console.log;
            logger(prefixMap[level] + ' ' + message);
            if (level === 'error' && typeof alert !== 'undefined') {
              alert('エラー: ' + message);
            }
          }
          window.notifications = {
            showError: function(message){ log('error', message); },
            showWarning: function(message){ log('warning', message); },
            showInfo: function(message){ log('info', message); },
            showSuccess: function(message){ log('success', message); }
          };
        })();
      }
    </script>
    
    <!-- 必須スクリプト（head内） -->
    <script src="assets/H384H64database.js"></script>
    <script src="js/core/phrasing.js"></script>
    <script src="js/core/phase-description.js"></script>
    <script src="js/core/ExpressionGenerator.js"></script>
    <script src="js/core/KeywordAnalyzer.js"></script>
    <script src="js/core/TripleOSInteractionAnalyzer.js"></script>
</head>
<body>
    <!-- ウェルカム画面 -->
    <section id="welcome-screen" class="screen welcome-screen active">
        <h1>HaQei Triple OS Analyzer</h1>
        <div class="welcome-content">
            <p>このシステムは、あなたの思考・行動パターンを3つのOS（オペレーティングシステム）として分析します。</p>
            <ul>
                <li><strong>Engine OS</strong>: あなたの原動力となる思考パターン</li>
                <li><strong>Interface OS</strong>: あなたの対人関係における特徴</li>
                <li><strong>Safe Mode OS</strong>: あなたの安定性と受容性</li>
            </ul>
            <p>36の質問に答えることで、あなた独自のTriple OSプロファイルを生成します。</p>
        </div>
        <button id="start-btn">分析を開始</button>
    </section>
    
    <!-- 質問画面 -->
    <section id="question-screen" class="screen question-screen" style="display:none;">
        <!-- プログレスバーを追加 -->
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
        
        <div id="question-container">
            <div id="question-number"></div>
            <div id="question-title"></div>
        </div>
        <div id="options-container">
            <!-- 選択肢がここに動的に生成される -->
        </div>
        <div class="navigation-buttons">
            <button id="prev-btn">前へ</button>
            <button id="next-btn" disabled style="opacity: 0.5; cursor: not-allowed;">次へ</button>
        </div>
    </section>
    
    <!-- 結果画面 -->
    <section id="results-screen" class="screen results-screen" style="display:none;">
        <h2>あなたのTriple OS分析結果</h2>
        <div id="os-cards-container"></div>
        <div id="summary-view"></div>
        <div id="hexagram-display"></div>
    </section>
    
    <!-- エラー画面 -->
    <section id="error-screen" class="screen error-screen" style="display:none;">
        <div class="error-container">
            <h2>エラーが発生しました</h2>
            <p id="error-message"></p>
            <button id="error-retry-btn" class="btn btn-primary" onclick="location.reload()">再試行</button>
        </div>
    </section>
    
    <!-- アクセシビリティ用の通知要素 -->
    <div id="aria-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></div>
    <div id="aria-announce" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
    
    <!-- UI/UX修正用スタイル -->
    <style>
    /* 画面の基本スタイル */
    .screen {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        min-height: 100vh;
        background: white;
        padding: 20px;
        box-sizing: border-box;
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    /* 非アクティブな画面を隠す */
    .screen:not(.active) {
        display: none !important;
    }
    
    /* アクティブな画面を表示 */
    .screen.active {
        display: block !important;
        opacity: 1;
    }
    
    /* 旧クラス名との互換性 - styles-modern.cssに委譲 */
    .welcome-screen, .question-screen, .results-screen {
        /* styles-modern.cssで定義されているため、ここでは削除 */
    }
    
    .welcome-screen.active, .question-screen.active, .results-screen.active {
        /* styles-modern.cssで定義されているため、ここでは削除 */
    }
    
    /* ボタンスタイル */
    button {
        background: #6366f1;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        transition: all 0.2s;
    }
    
    button:hover:not(:disabled) {
        background: #4f46e5;
        transform: translateY(-2px);
    }
    
    button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
    
    /* 選択肢のスタイルはstyles-modern.cssで定義されたoption-labelクラスを使用 */
    
    /* 質問コンテナのスタイル */
    #question-container {
        margin-bottom: 30px;
    }
    
    #question-title {
        font-size: 20px;
        font-weight: bold;
        color: #1f2937;
        margin-bottom: 10px;
    }
    
    #question-number {
        display: inline-block;
        background: #6366f1;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 14px;
        margin-bottom: 15px;
    }
    
    /* プログレスバー */
    .progress-bar {
        width: 100%;
        height: 8px;
        background: #e5e7eb;
        border-radius: 4px;
        margin: 20px 0;
        overflow: hidden;
    }
    
    .progress-fill {
        height: 100%;
        background: #6366f1;
        border-radius: 4px;
        transition: width 0.3s ease;
    }
    
    /* スクリーンリーダー用の非表示スタイル */
    .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0,0,0,0);
        white-space: nowrap;
        border: 0;
    }
    
    .error-screen {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }
    
    .error-container {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        padding: 2rem;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    </style>
    
    <!-- 必須JavaScript（body末尾） -->
    <script src="assets/js/questions-unified-complete.js"></script>
    <script src="assets/js/app.js"></script>
    <script src="js/ScreenManager.js"></script>
    <script src="js/QuestionManager.js"></script>
    <script src="js/persona-enhancer/VirtualPersonaEnhancer.js"></script>
    <script src="js/os-analyzer/os-analyzer-main.js"></script>
    <script>
        // 初期化処理
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 DOM Content Loaded - Starting initialization');
            
            // 初期画面状態を確実に設定
            const welcomeScreen = document.getElementById('welcome-screen');
            const questionScreen = document.getElementById('question-screen');
            const resultsScreen = document.getElementById('results-screen');
            
            // すべての画面を非表示にする
            [welcomeScreen, questionScreen, resultsScreen].forEach(screen => {
                if (screen) {
                    screen.style.display = 'none';
                    screen.classList.remove('active');
                }
            });
            
            // ウェルカム画面のみを表示
            if (welcomeScreen) {
                welcomeScreen.style.display = 'block';
                welcomeScreen.classList.add('active');
                console.log('✅ Welcome screen displayed');
            } else {
                console.error('❌ Welcome screen not found');
            }
            
            // ScreenManagerが読み込まれているか確認
            if (!window.ScreenManager) {
                console.error('ScreenManager not loaded');
                return;
            }
            
            // QuestionManagerが読み込まれているか確認
            if (!window.QuestionManager) {
                console.error('QuestionManager not loaded');
                return;
            }
            
            // VirtualPersonaEnhancerが読み込まれているか確認
            if (!window.VirtualPersonaEnhancer) {
                console.error('VirtualPersonaEnhancer not loaded');
                return;
            }
            
            // 次へボタンのイベントリスナーを設定
             const nextBtn = document.getElementById('next-btn');
             if (nextBtn && window.QuestionManager) {
                 nextBtn.addEventListener('click', function() {
                     console.log('🔄 Next button clicked');
                     window.QuestionManager.handleNextButtonClick();
                 });
                 console.log('✅ Next button event listener added');
             } else {
                 console.error('❌ Next button or QuestionManager not found');
             }
             
             // 前へボタンのイベントリスナーを設定
             const prevBtn = document.getElementById('prev-btn');
             if (prevBtn && window.QuestionManager) {
                 prevBtn.addEventListener('click', function() {
                     console.log('🔄 Previous button clicked');
                     window.QuestionManager.showPreviousQuestion();
                 });
                 console.log('✅ Previous button event listener added');
             }
             
             // 分析開始ボタンのイベントリスナーを設定
             const startBtn = document.getElementById('start-btn');
             if (startBtn && window.ScreenManager && window.QuestionManager) {
                 startBtn.addEventListener('click', function() {
                     console.log('🚀 Start button clicked');
                     window.ScreenManager.switchTo('question');
                     window.QuestionManager.displayQuestion(0);
                 });
                 console.log('✅ Start button event listener added');
             }
             
             console.log('✅ OS Analyzer initialized successfully');
        });
    </script>
</body>
</html>