<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei ãƒ™ãƒ¼ã‚·ãƒƒã‚¯OSåˆ†æ V9.0-final</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>æ˜“</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        /* ç¶™æ‰¿ç«¶åˆå¯¾ç­– */
        color: transparent;
      }
      .engine-card.selected {
        background-color: #2d4810;
        color: #ffffff;
        border-color: #a3e635;
        box-shadow: 0 0 25px rgba(163, 230, 53, 0.4),
          0 0 0 3px rgba(163, 230, 53, 0.7);
        transform: translateY(-5px) scale(1.05);
      }
      .engine-card.selected .archetype-name {
        color: #ffffff;
      }
      .prose-custom {
        color: #d1d5db;
        line-height: 1.8;
      }
      .prose-custom p {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      .prose-custom strong {
        color: #facc15;
      }
      .diagnostic-item {
        background-color: rgba(31, 41, 55, 0.7);
        border: 1px solid #374151;
        border-radius: 1rem;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
        margin-bottom: 2rem;
      }
      .option-label {
        display: flex;
        align-items: center;
        text-align: left;
        padding: 0.75rem 1rem;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 100%;
        background-color: #374151;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #d1d5db;
      }
      .option-label:hover,
      input[type="radio"]:focus-visible + .option-label {
        background-color: #4b5563;
        border-color: #6366f1;
        color: #ffffff;
      }
      input[type="radio"]:checked + .option-label {
        border-color: #a5b4fc;
        background-color: #4338ca;
        box-shadow: 0 0 10px rgba(165, 180, 252, 0.4);
        color: #ffffff;
      }
      .report-section h3,
      .report-section h4 {
        font-family: "Shippori Mincho", serif;
      }
      .engine-card {
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 1.25rem;
        background-color: #1f2937;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }
      .engine-card:hover,
      .engine-card:focus-visible {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.4);
        border-color: rgba(165, 180, 252, 0.5);
        outline: none;
      }
      .engine-card-header {
        text-align: left;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .engine-card-header .archetype-icon {
        font-size: 1.75rem;
        line-height: 1;
      }
      .engine-card-header .archetype-name {
        font-family: "Shippori Mincho", serif;
        font-weight: 700;
        font-size: 1.125rem;
      }
      .engine-card-tip {
        font-size: 0.75rem;
        margin-top: 0.75rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        color: #d1d5db;
        background-color: rgba(17, 24, 39, 0.6);
        min-height: 2.5rem;
      }
      .radar-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1 / 1;
        margin: auto;
      }

      details summary {
        cursor: pointer;
        padding: 0.5rem 0;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
      }
      details summary:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      details[open] summary {
        margin-bottom: 0.5rem;
      }
      #trigram-tooltip {
        position: fixed;
        background-color: rgba(17, 24, 39, 0.9);
        color: #e5e7eb;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        pointer-events: none;
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 9999;
        max-width: 280px;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-8">
    <div
      class="w-full max-w-4xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-10"
    >
      <header class="text-center mb-10">
        <a
          href="./"
          class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block text-sm"
          >â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a
        >
        <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
          ãƒ™ãƒ¼ã‚·ãƒƒã‚¯OSåˆ†æ
        </h1>
        <p class="text-gray-400 mt-2">
          ã‚ãªãŸã¨ã„ã†å­˜åœ¨ã®æ ¸ã¨ãªã‚‹ã€3ã¤ã®äººæ ¼OSã‚’ç‰¹å®šã—ã¾ã™ã€‚
        </p>
      </header>
      <div id="diagnostic-container"></div>
    </div>
    <template id="os-card-template"></template>
    <div id="trigram-tooltip"></div>
    <script type="module">
      import {
        WORLDVIEW_QUESTIONS,
        SCENARIO_QUESTIONS,
      } from "./js/questions.js";

      const HAQEI_DATA = {
        element_relationships: [
          {
            source_element: "æœ¨",
            target_element: "ç«",
            relationship_type: "ç›¸ç”Ÿ",
          },
          {
            source_element: "ç«",
            target_element: "åœŸ",
            relationship_type: "ç›¸ç”Ÿ",
          },
          {
            source_element: "åœŸ",
            target_element: "é‡‘",
            relationship_type: "ç›¸ç”Ÿ",
          },
          {
            source_element: "é‡‘",
            target_element: "æ°´",
            relationship_type: "ç›¸ç”Ÿ",
          },
          {
            source_element: "æ°´",
            target_element: "æœ¨",
            relationship_type: "ç›¸ç”Ÿ",
          },
          {
            source_element: "æœ¨",
            target_element: "åœŸ",
            relationship_type: "ç›¸å‰‹",
          },
          {
            source_element: "åœŸ",
            target_element: "æ°´",
            relationship_type: "ç›¸å‰‹",
          },
          {
            source_element: "æ°´",
            target_element: "ç«",
            relationship_type: "ç›¸å‰‹",
          },
          {
            source_element: "ç«",
            target_element: "é‡‘",
            relationship_type: "ç›¸å‰‹",
          },
          {
            source_element: "é‡‘",
            target_element: "æœ¨",
            relationship_type: "ç›¸å‰‹",
          },
        ],
        trigrams_master: [
          { trigram_id: 1, name_jp: "ä¹¾", element: "é‡‘" },
          { trigram_id: 2, name_jp: "å…Œ", element: "é‡‘" },
          { trigram_id: 3, name_jp: "é›¢", element: "ç«" },
          { trigram_id: 4, name_jp: "éœ‡", element: "æœ¨" },
          { trigram_id: 5, name_jp: "å·½", element: "æœ¨" },
          { trigram_id: 6, name_jp: "å", element: "æ°´" },
          { trigram_id: 7, name_jp: "è‰®", element: "åœŸ" },
          { trigram_id: 8, name_jp: "å¤", element: "åœŸ" },
        ],
        hexagrams_master: [
          {
            hexagram_id: 1,
            name_jp: "ä¹¾ç‚ºå¤©",
            upper_trigram_id: 1,
            lower_trigram_id: 1,
            catchphrase: "å¤©ç¿”ã‘ã‚‹é¾ã®ã‚ˆã†ãªã€å¤©æ€§ã®ãƒªãƒ¼ãƒ€ãƒ¼",
          },
          {
            hexagram_id: 2,
            name_jp: "å¤ç‚ºåœ°",
            upper_trigram_id: 8,
            lower_trigram_id: 8,
            catchphrase: "å¤§åœ°ã®æ¯ã®ã‚ˆã†ã«ã€ã™ã¹ã¦ã‚’å—ã‘å…¥ã‚Œã‚‹äºº",
          },
          {
            hexagram_id: 3,
            name_jp: "æ°´é›·å±¯",
            upper_trigram_id: 6,
            lower_trigram_id: 4,
            catchphrase: "ç”£ã¿ã®è‹¦ã—ã¿ã‚’ä¹—ã‚Šè¶Šãˆã‚‹ã€ç²˜ã‚Šå¼·ã„é–‹æ‹“è€…",
          },
          {
            hexagram_id: 4,
            name_jp: "å±±æ°´è’™",
            upper_trigram_id: 7,
            lower_trigram_id: 6,
            catchphrase: "æœªçŸ¥ã‚’æã‚Œãšã€ä½•äº‹ã‚‚ç´ ç›´ã«å­¦ã¹ã‚‹å­¦ç¿’è€…",
          },
          {
            hexagram_id: 5,
            name_jp: "æ°´å¤©éœ€",
            upper_trigram_id: 6,
            lower_trigram_id: 1,
            catchphrase: "æœ€å–„ã®æ™‚ã‚’å¾…ã¦ã‚‹ã€è¾›æŠ±å¼·ã„æˆ¦ç•¥å®¶",
          },
          {
            hexagram_id: 6,
            name_jp: "å¤©æ°´è¨Ÿ",
            upper_trigram_id: 1,
            lower_trigram_id: 6,
            catchphrase: "ä¿¡å¿µã‚’è²«ãã€æ­£ç¾©ã‚’å•ã†è«–å®¢",
          },
          {
            hexagram_id: 7,
            name_jp: "åœ°æ°´å¸«",
            upper_trigram_id: 8,
            lower_trigram_id: 6,
            catchphrase: "è¦å¾‹ã¨çµ±ç‡åŠ›ã§ã€çµ„ç¹”ã‚’å°ãå¸ä»¤å®˜",
          },
          {
            hexagram_id: 8,
            name_jp: "æ°´åœ°æ¯”",
            upper_trigram_id: 6,
            lower_trigram_id: 8,
            catchphrase: "å¿ƒã§ç¹‹ãŒã‚Šã€äººã‚’æ”¯ãˆã‚‹ã‚µãƒãƒ¼ã‚¿ãƒ¼",
          },
          {
            hexagram_id: 9,
            name_jp: "é¢¨å¤©å°ç•œ",
            upper_trigram_id: 5,
            lower_trigram_id: 1,
            catchphrase: "å°ã•ãªåŠªåŠ›ã‚’ç©ã¿é‡ã­ã‚‹ã€å …å®Ÿãªå®Ÿå‹™å®¶",
          },
          {
            hexagram_id: 10,
            name_jp: "å¤©æ¾¤å±¥",
            upper_trigram_id: 1,
            lower_trigram_id: 2,
            catchphrase: "ç¤¼ç¯€ã‚’ã‚ãã¾ãˆã€æ…é‡ã«é€²ã‚€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼",
          },
          {
            hexagram_id: 11,
            name_jp: "åœ°å¤©æ³°",
            upper_trigram_id: 8,
            lower_trigram_id: 1,
            catchphrase: "ç•°ãªã‚‹è¦ç´ ã‚’èª¿å’Œã•ã›ã‚‹ã€å¹³å’Œã‚’æ„›ã™ã‚‹èª¿æ•´å½¹",
          },
          {
            hexagram_id: 12,
            name_jp: "å¤©åœ°å¦",
            upper_trigram_id: 1,
            lower_trigram_id: 8,
            catchphrase: "è‡ªåˆ†ã®å†…ãªã‚‹ä¸–ç•Œã‚’ã€æ·±ãè¿½æ±‚ã™ã‚‹æ€æƒ³å®¶",
          },
          {
            hexagram_id: 13,
            name_jp: "å¤©ç«åŒäºº",
            upper_trigram_id: 1,
            lower_trigram_id: 3,
            catchphrase: "å…¬å¹³ãªç†å¿µã§ã€äººã€…ã‚’å›£çµã•ã›ã‚‹ã¾ã¨ã‚å½¹",
          },
          {
            hexagram_id: 14,
            name_jp: "ç«å¤©å¤§æœ‰",
            upper_trigram_id: 3,
            lower_trigram_id: 1,
            catchphrase: "å¤ªé™½ã®ã‚ˆã†ã«ã€å¯›å¤§ã•ã§äººã‚’ç…§ã‚‰ã™ãƒªãƒ¼ãƒ€ãƒ¼",
          },
          {
            hexagram_id: 15,
            name_jp: "åœ°å±±è¬™",
            upper_trigram_id: 8,
            lower_trigram_id: 7,
            catchphrase: "å®ŸåŠ›ãŒã‚ã£ã¦ã‚‚ã€å¸¸ã«è¬™è™šã§ã„ã‚‰ã‚Œã‚‹äººæ ¼è€…",
          },
          {
            hexagram_id: 16,
            name_jp: "é›·åœ°è±«",
            upper_trigram_id: 4,
            lower_trigram_id: 8,
            catchphrase: "å‘¨åˆ°ãªæº–å‚™ã§ã€äººã‚’æ¥½ã—ã¾ã›ã‚‹ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒŠãƒ¼",
          },
          {
            hexagram_id: 17,
            name_jp: "æ²¢é›·éš",
            upper_trigram_id: 2,
            lower_trigram_id: 4,
            catchphrase: "å¤‰åŒ–ã®æ³¢ã«ä¹—ã‚Šã“ãªã™ã€æŸ”è»Ÿãªãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼",
          },
          {
            hexagram_id: 18,
            name_jp: "å±±é¢¨è ±",
            upper_trigram_id: 7,
            lower_trigram_id: 5,
            catchphrase: "æ ¹æœ¬åŸå› ã‚’ç«‹ã¦ç›´ã™ã€æƒ…ç†±çš„ãªæ”¹é©è€…",
          },
          {
            hexagram_id: 19,
            name_jp: "åœ°æ²¢è‡¨",
            upper_trigram_id: 8,
            lower_trigram_id: 2,
            catchphrase: "äººã‚’è‚²ã¦å°ãã€é¢å€’è¦‹ã®ã„ã„ãƒªãƒ¼ãƒ€ãƒ¼",
          },
          {
            hexagram_id: 20,
            name_jp: "é¢¨åœ°è¦³",
            upper_trigram_id: 5,
            lower_trigram_id: 8,
            catchphrase: "ç‰©äº‹ã®æœ¬è³ªã‚’è¦‹æŠœãã€é™ã‹ãªè¦³å¯Ÿè€…",
          },
          {
            hexagram_id: 21,
            name_jp: "ç«é›·å™¬å—‘",
            upper_trigram_id: 3,
            lower_trigram_id: 4,
            catchphrase: "éšœå®³ã‚’å™›ã¿ç •ãã€æ–­å›ºã¨ã—ã¦é€²ã‚€å®Ÿè¡Œè€…",
          },
          {
            hexagram_id: 22,
            name_jp: "å±±ç«è³",
            upper_trigram_id: 7,
            lower_trigram_id: 3,
            catchphrase: "æœ¬è³ªã‚’ç¾ã—ãå½©ã‚‹ã€å¤©æ€§ã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ",
          },
          {
            hexagram_id: 23,
            name_jp: "å±±åœ°å‰",
            upper_trigram_id: 7,
            lower_trigram_id: 8,
            catchphrase: "å¤ã„ã‚‚ã®ã‚’æ‰‹æ”¾ã—ã€æœ¬è³ªã‚’è¦‹å‡ºã™å¤‰é©è€…",
          },
          {
            hexagram_id: 24,
            name_jp: "åœ°é›·å¾©",
            upper_trigram_id: 8,
            lower_trigram_id: 4,
            catchphrase: "å¤±æ•—ã‚’æ¬¡ã«æ´»ã‹ã™ã€ã—ãªã‚„ã‹ãªæŒ‘æˆ¦è€…",
          },
          {
            hexagram_id: 25,
            name_jp: "å¤©é›·æ— å¦„",
            upper_trigram_id: 1,
            lower_trigram_id: 4,
            catchphrase: "è‡ªç„¶ä½“ã§ã€ã‚ã‚‹ãŒã¾ã¾ã‚’å—ã‘å…¥ã‚Œã‚‹æ¥½å¤©å®¶",
          },
          {
            hexagram_id: 26,
            name_jp: "å±±å¤©å¤§ç•œ",
            upper_trigram_id: 7,
            lower_trigram_id: 1,
            catchphrase: "å†…ã«åŠ›ã‚’è“„ãˆã€å¥½æ©Ÿã‚’å¾…ã¤å¤§å™¨æ™©æˆã®äºº",
          },
          {
            hexagram_id: 27,
            name_jp: "å±±é›·é ¤",
            upper_trigram_id: 7,
            lower_trigram_id: 4,
            catchphrase: "è¨€è‘‰ã¨æ™‚é–“ã‚’ã‹ã‘ã¦ã€ç‰©äº‹ã‚’è‚²ã‚€å°‚é–€å®¶",
          },
          {
            hexagram_id: 28,
            name_jp: "æ¾¤é¢¨å¤§é",
            upper_trigram_id: 2,
            lower_trigram_id: 5,
            catchphrase: "å¸¸è­˜ã®æ ã‚’è¶…ãˆã‚‹ã€å¤§èƒ†ãªã‚²ãƒ¼ãƒ ãƒã‚§ãƒ³ã‚¸ãƒ£ãƒ¼",
          },
          {
            hexagram_id: 29,
            name_jp: "åç‚ºæ°´",
            upper_trigram_id: 6,
            lower_trigram_id: 6,
            catchphrase: "å›°é›£ã®æ¸¦ä¸­ã§ã€çœŸç†ã‚’è¦‹å‡ºã™ä¸å±ˆã®æ¢æ±‚è€…",
          },
          {
            hexagram_id: 30,
            name_jp: "é›¢ç‚ºç«",
            upper_trigram_id: 3,
            lower_trigram_id: 3,
            catchphrase: "æƒ…ç†±ã¨çŸ¥æ€§ã§ã€äººã‚’æƒ¹ãã¤ã‘ã‚‹è¯ã‚„ã‹ãªã‚¹ã‚¿ãƒ¼",
          },
          {
            hexagram_id: 31,
            name_jp: "æ²¢å±±å’¸",
            upper_trigram_id: 2,
            lower_trigram_id: 7,
            catchphrase: "ç†å±ˆæŠœãã«ã€å¿ƒã§æ„Ÿã˜å–ã‚Œã‚‹å…±æ„Ÿè€…",
          },
          {
            hexagram_id: 32,
            name_jp: "é›·é¢¨æ’",
            upper_trigram_id: 4,
            lower_trigram_id: 5,
            catchphrase: "æ±ºã‚ãŸé“ã‚’ã€ç€å®Ÿã«æ­©ã¿ç¶šã‘ã‚‹ç¶™ç¶šè€…",
          },
          {
            hexagram_id: 33,
            name_jp: "å¤©å±±é¯",
            upper_trigram_id: 1,
            lower_trigram_id: 7,
            catchphrase: "è³¢æ˜ãªè·é›¢æ„Ÿã‚’ä¿ã¤ã€ã‚¯ãƒ¼ãƒ«ãªæˆ¦ç•¥å®¶",
          },
          {
            hexagram_id: 34,
            name_jp: "é›·å¤©å¤§å£®",
            upper_trigram_id: 4,
            lower_trigram_id: 1,
            catchphrase: "ç›®æ¨™ã«å‘ã‹ã£ã¦ã€åŠ›å¼·ãé€²ã‚€ãƒãƒ£ãƒ¬ãƒ³ã‚¸ãƒ£ãƒ¼",
          },
          {
            hexagram_id: 35,
            name_jp: "ç«åœ°æ™‹",
            upper_trigram_id: 3,
            lower_trigram_id: 8,
            catchphrase: "å‘¨ã‚Šã‚’æ˜ã‚‹ãç…§ã‚‰ã—ã€å‰é€²ã‚’ä¿ƒã™ãƒ—ãƒ­ãƒ¢ãƒ¼ã‚¿ãƒ¼",
          },
          {
            hexagram_id: 36,
            name_jp: "åœ°ç«æ˜å¤·",
            upper_trigram_id: 8,
            lower_trigram_id: 3,
            catchphrase: "é€†å¢ƒã«ã‚ã£ã¦ã‚‚ã€å¸Œæœ›ã‚’å¤±ã‚ãªã„èŠ¯ã®å¼·ã„äºº",
          },
          {
            hexagram_id: 37,
            name_jp: "é¢¨ç«å®¶äºº",
            upper_trigram_id: 5,
            lower_trigram_id: 3,
            catchphrase: "è‡ªåˆ†ã®å±…å ´æ‰€ã‚’ã€å¤§åˆ‡ã«å®ˆã‚Šè‚²ã¦ã‚‹äºº",
          },
          {
            hexagram_id: 38,
            name_jp: "ç«æ²¢ç½",
            upper_trigram_id: 3,
            lower_trigram_id: 2,
            catchphrase: "ã‚ãˆã¦äººã¨é•ã†é“ã‚’è¡Œãã€å€‹æ€§çš„ãªç‹¬å‰µå®¶",
          },
          {
            hexagram_id: 39,
            name_jp: "æ°´å±±è¹‡",
            upper_trigram_id: 6,
            lower_trigram_id: 7,
            catchphrase: "å›°é›£ãªçŠ¶æ³ã‚’ã€çŸ¥æµã¨å·¥å¤«ã§ä¹—ã‚Šè¶Šãˆã‚‹ç­–å£«",
          },
          {
            hexagram_id: 40,
            name_jp: "é›·æ°´è§£",
            upper_trigram_id: 4,
            lower_trigram_id: 6,
            catchphrase: "å•é¡Œã‚’ã‚¹ãƒ”ãƒ¼ãƒ‡ã‚£ã«è§£æ±ºã™ã‚‹ã€æ±ºæ–­åŠ›ã®ã‚ã‚‹äºº",
          },
          {
            hexagram_id: 41,
            name_jp: "å±±æ²¢æ",
            upper_trigram_id: 7,
            lower_trigram_id: 2,
            catchphrase: "äººã®ãŸã‚ã«è‡ªåˆ†ã‚’å½¹ç«‹ã¦ã‚‹ã€èª å®Ÿãªè²¢çŒ®è€…",
          },
          {
            hexagram_id: 42,
            name_jp: "é¢¨é›·ç›Š",
            upper_trigram_id: 5,
            lower_trigram_id: 4,
            catchphrase: "å–„æ„ã®å¾ªç’°ã‚’ç”Ÿã¿å‡ºã™ã€å¿ƒå„ªã—ã„ã‚µãƒãƒ¼ã‚¿ãƒ¼",
          },
          {
            hexagram_id: 43,
            name_jp: "æ²¢å¤©å¤¬",
            upper_trigram_id: 2,
            lower_trigram_id: 1,
            catchphrase: "ãŸã‚ã‚‰ã‚ãšã«æ±ºæ–­ã—ã€é“ã‚’æ‹“ãçªç ´å½¹",
          },
          {
            hexagram_id: 44,
            name_jp: "å¤©é¢¨å§¤",
            upper_trigram_id: 1,
            lower_trigram_id: 5,
            catchphrase: "å¶ç„¶ã®å‡ºä¼šã„ã‚’ãƒãƒ£ãƒ³ã‚¹ã«å¤‰ãˆã‚‹ã€å¤©æ€§ã®ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚«ãƒ¼",
          },
          {
            hexagram_id: 45,
            name_jp: "æ²¢åœ°èƒ",
            upper_trigram_id: 2,
            lower_trigram_id: 8,
            catchphrase: "äººã¨å–œã³ãŒé›†ã¾ã‚‹å ´ã‚’å‰µã‚‹ã€ä¸­å¿ƒäººç‰©",
          },
          {
            hexagram_id: 46,
            name_jp: "åœ°é¢¨å‡",
            upper_trigram_id: 8,
            lower_trigram_id: 5,
            catchphrase: "åœ°é“ãªåŠªåŠ›ã§ã€ç€å®Ÿã«æˆé•·ã§ãã‚‹äºº",
          },
          {
            hexagram_id: 47,
            name_jp: "æ²¢æ°´å›°",
            upper_trigram_id: 2,
            lower_trigram_id: 6,
            catchphrase: "è‹¦ã—ã„çŠ¶æ³ã§ã‚‚ã€è‡ªåˆ†ã‚’è¦‹å¤±ã‚ãªã„å“²å­¦è€…",
          },
          {
            hexagram_id: 48,
            name_jp: "æ°´é¢¨äº•",
            upper_trigram_id: 6,
            lower_trigram_id: 5,
            catchphrase: "èª°ã«ã§ã‚‚å…¬å¹³ã«å°½ãã›ã‚‹ã€ç¸ã®ä¸‹ã®åŠ›æŒã¡",
          },
          {
            hexagram_id: 49,
            name_jp: "æ²¢ç«é©",
            upper_trigram_id: 2,
            lower_trigram_id: 3,
            catchphrase: "å¤ã„å¸¸è­˜ã‚’åˆ·æ–°ã™ã‚‹ã€æƒ…ç†±ã‚’æŒã£ãŸæ”¹é©è€…",
          },
          {
            hexagram_id: 50,
            name_jp: "ç«é¢¨é¼",
            upper_trigram_id: 3,
            lower_trigram_id: 5,
            catchphrase: "æ–°ãŸãªå®‰å®šã‚’ç¯‰ãä¸Šã’ã‚‹ã€æ‡ã®æ·±ã„ã¾ã¨ã‚å½¹",
          },
          {
            hexagram_id: 51,
            name_jp: "éœ‡ç‚ºé›·",
            upper_trigram_id: 4,
            lower_trigram_id: 4,
            catchphrase: "å¤‰åŒ–ã‚’ãƒãƒ£ãƒ³ã‚¹ã«å¤‰ãˆã‚‹ã€ç¬ç™ºåŠ›ã®ã‚ã‚‹è¡Œå‹•æ´¾",
          },
          {
            hexagram_id: 52,
            name_jp: "è‰®ç‚ºå±±",
            upper_trigram_id: 7,
            lower_trigram_id: 7,
            catchphrase: "å‹•ã˜ãªã„è‡ªå·±ã‚’ç¢ºç«‹ã—ãŸã€é™ã‹ãªæ±‚é“è€…",
          },
          {
            hexagram_id: 53,
            name_jp: "é¢¨å±±æ¼¸",
            upper_trigram_id: 5,
            lower_trigram_id: 7,
            catchphrase: "ç‰©äº‹ã‚’ä¸€æ­©ãšã¤ã€ç€å®Ÿã«é€²ã‚ã‚‹èª å®Ÿãªäºº",
          },
          {
            hexagram_id: 54,
            name_jp: "é›·æ²¢å¸°å¦¹",
            upper_trigram_id: 4,
            lower_trigram_id: 2,
            catchphrase: "è‡ªåˆ†ã®æƒ…ç†±ã«æ­£ç›´ã«ç”Ÿãã‚‹ã€ç´”ç²‹ãªæƒ…ç†±å®¶",
          },
          {
            hexagram_id: 55,
            name_jp: "é›·ç«è±Š",
            upper_trigram_id: 4,
            lower_trigram_id: 3,
            catchphrase: "è±Šã‹ã•ã‚’å‰µã‚Šå‡ºã—ã€åˆ†ã‹ã¡åˆã†ã‚«ãƒªã‚¹ãƒ",
          },
          {
            hexagram_id: 56,
            name_jp: "ç«å±±æ—…",
            upper_trigram_id: 3,
            lower_trigram_id: 7,
            catchphrase: "ä¸€ç®‡æ‰€ã«ç•™ã¾ã‚‰ãªã„ã€è‡ªç”±ãªæ—…äºº",
          },
          {
            hexagram_id: 57,
            name_jp: "å·½ç‚ºé¢¨",
            upper_trigram_id: 5,
            lower_trigram_id: 5,
            catchphrase: "éš…ã€…ã¾ã§å¿ƒé…ã‚ŠãŒã§ãã‚‹ã€ã—ãªã‚„ã‹ãªèª¿æ•´å½¹",
          },
          {
            hexagram_id: 58,
            name_jp: "å…Œç‚ºæ²¢",
            upper_trigram_id: 2,
            lower_trigram_id: 2,
            catchphrase: "äººã¨è©±ã™ã“ã¨ã€å–œã°ã›ã‚‹ã“ã¨ãŒå¥½ããªã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒŠãƒ¼",
          },
          {
            hexagram_id: 59,
            name_jp: "é¢¨æ°´æ¸™",
            upper_trigram_id: 5,
            lower_trigram_id: 6,
            catchphrase: "å¿ƒã®å£ã‚’æº¶ã‹ã—ã€é¢¨é€šã—ã‚’è‰¯ãã™ã‚‹èª¿æ•´å½¹",
          },
          {
            hexagram_id: 60,
            name_jp: "æ°´æ²¢ç¯€",
            upper_trigram_id: 6,
            lower_trigram_id: 2,
            catchphrase: "è‡ªåˆ†ã‚’å¾‹ã—ã€ç¯€åº¦ã‚’ä¿ã¤ã“ã¨ãŒã§ãã‚‹äºº",
          },
          {
            hexagram_id: 61,
            name_jp: "é¢¨æ²¢ä¸­å­š",
            upper_trigram_id: 5,
            lower_trigram_id: 2,
            catchphrase: "èª å®Ÿã•ã§ã€äººã®å¿ƒã‚’å‹•ã‹ã™ã“ã¨ãŒã§ãã‚‹äºº",
          },
          {
            hexagram_id: 62,
            name_jp: "é›·å±±å°é",
            upper_trigram_id: 4,
            lower_trigram_id: 7,
            catchphrase: "è¬™è™šã™ãã‚‹ã»ã©ã«ã€ä¸å¯§ã•ã‚’é‡ã‚“ã˜ã‚‹äºº",
          },
          {
            hexagram_id: 63,
            name_jp: "æ°´ç«æ—¢æ¸ˆ",
            upper_trigram_id: 6,
            lower_trigram_id: 3,
            catchphrase: "å®Œç’§ãªãƒãƒ©ãƒ³ã‚¹ã‚’æ±‚ã‚ã‚‹ã€ç§©åºã®ç•ªäºº",
          },
          {
            hexagram_id: 64,
            name_jp: "ç«æ°´æœªæ¸ˆ",
            upper_trigram_id: 3,
            lower_trigram_id: 6,
            catchphrase: "æœªå®Œæˆã®ä¸­ã«ã€ç„¡é™ã®å¯èƒ½æ€§ã‚’è¦‹å‡ºã™æ¢æ±‚è€…",
          },
        ],
        H64_DATA: [
          { hexagram_id: 1, saku_id: 2, sou_id: 1, go_id: 1 },
          { hexagram_id: 2, saku_id: 1, sou_id: 2, go_id: 2 },
          { hexagram_id: 3, saku_id: 50, sou_id: 4, go_id: 23 },
          { hexagram_id: 4, saku_id: 49, sou_id: 3, go_id: 24 },
          { hexagram_id: 5, saku_id: 38, sou_id: 6, go_id: 64 },
          { hexagram_id: 6, saku_id: 37, sou_id: 5, go_id: 63 },
          { hexagram_id: 7, saku_id: 13, sou_id: 8, go_id: 2 },
          { hexagram_id: 8, saku_id: 14, sou_id: 7, go_id: 2 },
          { hexagram_id: 9, saku_id: 46, sou_id: 10, go_id: 61 },
          { hexagram_id: 10, saku_id: 45, sou_id: 9, go_id: 62 },
          { hexagram_id: 11, saku_id: 12, sou_id: 12, go_id: 54 },
          { hexagram_id: 12, saku_id: 11, sou_id: 11, go_id: 53 },
          { hexagram_id: 13, saku_id: 7, sou_id: 14, go_id: 44 },
          { hexagram_id: 14, saku_id: 8, sou_id: 13, go_id: 43 },
          { hexagram_id: 15, saku_id: 52, sou_id: 16, go_id: 40 },
          { hexagram_id: 16, saku_id: 51, sou_id: 15, go_id: 39 },
          { hexagram_id: 17, saku_id: 18, sou_id: 18, go_id: 27 },
          { hexagram_id: 18, saku_id: 17, sou_id: 17, go_id: 28 },
          { hexagram_id: 19, saku_id: 24, sou_id: 20, go_id: 54 },
          { hexagram_id: 20, saku_id: 23, sou_id: 19, go_id: 53 },
          { hexagram_id: 21, saku_id: 27, sou_id: 22, go_id: 35 },
          { hexagram_id: 22, saku_id: 28, sou_id: 21, go_id: 36 },
          { hexagram_id: 23, saku_id: 20, sou_id: 24, go_id: 2 },
          { hexagram_id: 24, saku_id: 19, sou_id: 23, go_id: 2 },
          { hexagram_id: 25, saku_id: 41, sou_id: 26, go_id: 28 },
          { hexagram_id: 26, saku_id: 42, sou_id: 25, go_id: 27 },
          { hexagram_id: 27, saku_id: 22, sou_id: 28, go_id: 2 },
          { hexagram_id: 28, saku_id: 21, sou_id: 27, go_id: 1 },
          { hexagram_id: 29, saku_id: 30, sou_id: 29, go_id: 29 },
          { hexagram_id: 30, saku_id: 29, sou_id: 30, go_id: 30 },
          { hexagram_id: 31, saku_id: 32, sou_id: 32, go_id: 44 },
          { hexagram_id: 32, saku_id: 31, sou_id: 31, go_id: 43 },
          { hexagram_id: 33, saku_id: 56, sou_id: 34, go_id: 53 },
          { hexagram_id: 34, saku_id: 55, sou_id: 33, go_id: 54 },
          { hexagram_id: 35, saku_id: 6, sou_id: 36, go_id: 63 },
          { hexagram_id: 36, saku_id: 5, sou_id: 35, go_id: 64 },
          { hexagram_id: 37, saku_id: 48, sou_id: 38, go_id: 61 },
          { hexagram_id: 38, saku_id: 47, sou_id: 37, go_id: 62 },
          { hexagram_id: 39, saku_id: 16, sou_id: 40, go_id: 63 },
          { hexagram_id: 40, saku_id: 15, sou_id: 39, go_id: 64 },
          { hexagram_id: 41, saku_id: 26, sou_id: 42, go_id: 24 },
          { hexagram_id: 42, saku_id: 25, sou_id: 41, go_id: 23 },
          { hexagram_id: 43, saku_id: 20, sou_id: 44, go_id: 1 },
          { hexagram_id: 44, saku_id: 19, sou_id: 43, go_id: 1 },
          { hexagram_id: 45, saku_id: 10, sou_id: 46, go_id: 53 },
          { hexagram_id: 46, saku_id: 9, sou_id: 45, go_id: 54 },
          { hexagram_id: 47, saku_id: 38, sou_id: 48, go_id: 37 },
          { hexagram_id: 48, saku_id: 37, sou_id: 47, go_id: 38 },
          { hexagram_id: 49, saku_id: 4, sou_id: 50, go_id: 30 },
          { hexagram_id: 50, saku_id: 3, sou_id: 49, go_id: 29 },
          { hexagram_id: 51, saku_id: 16, sou_id: 52, go_id: 51 },
          { hexagram_id: 52, saku_id: 15, sou_id: 51, go_id: 52 },
          { hexagram_id: 53, saku_id: 34, sou_id: 54, go_id: 40 },
          { hexagram_id: 54, saku_id: 33, sou_id: 53, go_id: 39 },
          { hexagram_id: 55, saku_id: 34, sou_id: 56, go_id: 64 },
          { hexagram_id: 56, saku_id: 33, sou_id: 55, go_id: 63 },
          { hexagram_id: 57, saku_id: 52, sou_id: 58, go_id: 57 },
          { hexagram_id: 58, saku_id: 51, sou_id: 57, go_id: 58 },
          { hexagram_id: 59, saku_id: 62, sou_id: 60, go_id: 40 },
          { hexagram_id: 60, saku_id: 61, sou_id: 59, go_id: 39 },
          { hexagram_id: 61, saku_id: 60, sou_id: 62, go_id: 27 },
          { hexagram_id: 62, saku_id: 59, sou_id: 61, go_id: 28 },
          { hexagram_id: 63, saku_id: 6, sou_id: 64, go_id: 30 },
          { hexagram_id: 64, saku_id: 5, sou_id: 63, go_id: 29 },
        ],
        os_manual: {},
      };

      const osManualData = {};

      const analysisState = {
        trigramScores: null,
        adjustedTrigramScores: null,
        engineCandidates: [],
        selectedEngine: null,
        lockedEngineOs: null,
        influentialOses: [],
        userProfileVector: null,
      };

      // æ–°ã—ã„ãƒ™ã‚¯ãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯é–¢æ•°
      function buildUserProfileVector(questions) {
        // H64_PROFILE_VECTORSã®ã‚­ãƒ¼ã‚’å…¨ã¦å–å¾—ã—ã€å…¨è¦ç´ ãŒ0ã®ç©ºã®ãƒ™ã‚¯ãƒˆãƒ«ã‚’ä½œæˆ
        const profileVector = {};

        // å¼•æ•°ã§æ¸¡ã•ã‚ŒãŸquestionsé…åˆ—ã‚’ãƒ«ãƒ¼ãƒ—
        questions.forEach((q) => {
          // å„è¨­å•ã§ã€ãƒã‚§ãƒƒã‚¯ã•ã‚ŒãŸé¸æŠè‚¢ã®scoring_tagsé…åˆ—ã‚’å–å¾—
          const checkedOption = document.querySelector(
            `input[name="${q.id}"]:checked`
          );
          if (checkedOption) {
            const selectedOption = q.options.find(
              (opt) => opt.value === checkedOption.value
            );
            if (selectedOption && selectedOption.scoring_tags) {
              // scoring_tagsã®å„è¦ç´ ã«ã¤ã„ã¦ã€profileVectorã®å¯¾å¿œã™ã‚‹ã‚­ãƒ¼ã«å€¤ã‚’åŠ ç®—
              selectedOption.scoring_tags.forEach((tag) => {
                profileVector[tag.key] =
                  (profileVector[tag.key] || 0) + tag.value;
              });
            }
          }
        });

        return profileVector;
      }

      function calculateCosineSimilarity(vectorA, vectorB) {
        const keys = new Set([
          ...Object.keys(vectorA),
          ...Object.keys(vectorB),
        ]);
        let dotProduct = 0;
        let magnitudeA = 0;
        let magnitudeB = 0;

        keys.forEach((key) => {
          const a = vectorA[key] || 0;
          const b = vectorB[key] || 0;
          dotProduct += a * b;
          magnitudeA += a * a;
          magnitudeB += b * b;
        });

        const magnitudeProduct = Math.sqrt(magnitudeA) * Math.sqrt(magnitudeB);
        return magnitudeProduct === 0 ? 0 : dotProduct / magnitudeProduct;
      }

      function calculateMagnitudeMatchScore(vectorA, vectorB) {
        const keys = new Set([
          ...Object.keys(vectorA),
          ...Object.keys(vectorB),
        ]);
        let totalDifference = 0;

        keys.forEach((key) => {
          const a = vectorA[key] || 0;
          const b = vectorB[key] || 0;
          totalDifference += Math.abs(a - b);
        });

        return Math.max(0, 10 - totalDifference);
      }

      function getEngineCandidates(userProfileVector) {
        // H64_PROFILE_VECTORSã®å…¨OSãƒ‡ãƒ¼ã‚¿ã‚’ãƒ«ãƒ¼ãƒ—å‡¦ç†
        const candidates = HAQEI_DATA.hexagrams_master.map((os) => {
          // å„OSã«ã¤ã„ã¦ã€2ã¤ã®ã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—
          const similarityScore = calculateCosineSimilarity(
            userProfileVector,
            os.profile_vector || {}
          );
          const magnitudeScore = calculateMagnitudeMatchScore(
            userProfileVector,
            os.profile_vector || {}
          );

          // normalizedMagnitudeScoreã‚’æ­£è¦åŒ–
          const normalizedMagnitudeScore = Math.min(magnitudeScore / 10, 1.0);

          // æœ€çµ‚ã‚¹ã‚³ã‚¢ã‚’ç®—å‡º
          const finalScore =
            similarityScore * 0.7 + normalizedMagnitudeScore * 0.3;

          return { ...os, finalScore };
        });

        // ã‚¹ã‚³ã‚¢ã®é«˜ã„é †ã«ã‚½ãƒ¼ãƒˆã—ã¦ä¸Šä½4ä»¶ã‚’è¿”ã™
        return candidates
          .sort((a, b) => b.finalScore - a.finalScore)
          .slice(0, 4);
      }

      let trigramRadarChart = null;
      const diagnosticContainer = document.getElementById(
        "diagnostic-container"
      );

      function renderTrigramRadar(ctx, scores) {
        if (trigramRadarChart) {
          trigramRadarChart.destroy();
        }
        const labels = HAQEI_DATA.trigrams_master
          .sort((a, b) => a.trigram_id - b.trigram_id)
          .map((t) => t.name_jp);
        const dataPoints = Object.keys(scores)
          .sort((a, b) => a - b)
          .map((key) => scores[key]);

        // [æœ€çµ‚FIX-B] ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æ˜ç¤ºçš„ã«å‚ç…§
        trigramRadarChart = new window.Chart(ctx, {
          type: "radar",
          // (ä»¥é™ã®Chart.jsã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯å¤‰æ›´ãªã—)
          data: {
            labels: labels,
            datasets: [
              {
                label: "å…«å¦ã‚¹ã‚³ã‚¢",
                data: dataPoints,
                backgroundColor: "rgba(165, 180, 252, 0.2)",
                borderColor: "#a5b4fc",
                borderWidth: 2,
                pointBackgroundColor: "#e0e7ff",
                pointBorderColor: "#a5b4fc",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "#6366f1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              r: {
                angleLines: { color: "rgba(255, 255, 255, 0.2)" },
                grid: { color: "rgba(255, 255, 255, 0.2)" },
                pointLabels: {
                  font: { size: 14, weight: "bold" },
                  color: "#d1d5db",
                },
                ticks: {
                  display: false,
                  stepSize: 25,
                  backdropColor: "transparent",
                },
                min: 0,
                max: 100,
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) =>
                    `${context.label}: ${context.raw.toFixed(1)}`,
                },
              },
            },
          },
        });
        return trigramRadarChart;
      }
      function updateTrigramRadar(chart, newScores) {
        if (!chart) return;
        const dataPoints = Object.keys(newScores)
          .sort((a, b) => a - b)
          .map((key) => newScores[key]);
        chart.data.datasets[0].data = dataPoints;
        chart.update("none");
      }

      function getTrigramElement(trigramId) {
        return HAQEI_DATA.trigrams_master.find(
          (t) => t.trigram_id === trigramId
        );
      }

      function getRelationship(elem1, elem2) {
        if (!elem1 || !elem2) return "ç„¡é–¢ä¿‚";
        const rel = HAQEI_DATA.element_relationships.find(
          (r) =>
            r.source_element === elem1.element &&
            r.target_element === elem2.element
        );
        return rel ? rel.relationship_type : "ç„¡é–¢ä¿‚";
      }

      function hasXiangSheng(hexA, hexB) {
        if (!hexA || !hexB) return false;
        const aUpper = getTrigramElement(hexA.upper_trigram_id);
        const aLower = getTrigramElement(hexA.lower_trigram_id);
        const bUpper = getTrigramElement(hexB.upper_trigram_id);
        const bLower = getTrigramElement(hexB.lower_trigram_id);
        const pairs = [
          [aUpper, bUpper],
          [aUpper, bLower],
          [aLower, bUpper],
          [aLower, bLower],
        ];
        return pairs.some(
          (p) =>
            getRelationship(p[0], p[1]) === "ç›¸ç”Ÿ" ||
            getRelationship(p[1], p[0]) === "ç›¸ç”Ÿ"
        );
      }

      function hasXiangKe(hexA, hexB) {
        if (!hexA || !hexB) return false;
        const aUpper = getTrigramElement(hexA.upper_trigram_id);
        const aLower = getTrigramElement(hexA.lower_trigram_id);
        const bUpper = getTrigramElement(hexB.upper_trigram_id);
        const bLower = getTrigramElement(hexB.lower_trigram_id);
        const pairs = [
          [aUpper, bUpper],
          [aUpper, bLower],
          [aLower, bUpper],
          [aLower, bLower],
        ];
        return pairs.some(
          (p) =>
            getRelationship(p[0], p[1]) === "ç›¸å‰‹" ||
            getRelationship(p[1], p[0]) === "ç›¸å‰‹"
        );
      }

      function isZong(hexIdA, hexIdB) {
        const souId = HAQEI_DATA.H64_DATA.find(
          (k) => k.hexagram_id === hexIdA
        )?.sou_id;
        return souId === hexIdB;
      }

      function isCuo(hexIdA, hexIdB) {
        const sakuId = HAQEI_DATA.H64_DATA.find(
          (k) => k.hexagram_id === hexIdA
        )?.saku_id;
        return sakuId === hexIdB;
      }

      function calculateInfluenceScores(candidates, engineId) {
        const engineHex = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id === engineId
        );
        return candidates
          .filter((c) => c.hexagram_id !== engineId)
          .map((c) => {
            const rel = {
              xiangSheng: hasXiangSheng(engineHex, c),
              xiangKe: hasXiangKe(engineHex, c),
              zong: isZong(engineId, c.hexagram_id),
              cuo: isCuo(engineId, c.hexagram_id),
            };
            let score = 0;
            if (rel.xiangSheng) score += 30;
            if (rel.xiangKe) score -= 20;
            if (rel.zong) score += 15;
            if (rel.cuo) score -= 10;
            return { id: c.hexagram_id, score, rel };
          })
          .sort((a, b) => b.score - a.score);
      }

      function main() {
        try {
          Object.assign(osManualData, HAQEI_DATA.os_manual || {});
          showIntro();
        } catch (error) {
          console.error("åˆæœŸåŒ–ã«å¤±æ•—:", error);
          diagnosticContainer.innerHTML = `<div class="text-center text-red-400 p-8">ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
        }
      }

      function showIntro() {
        diagnosticContainer.innerHTML = `<div class="text-center bg-gray-900/50 p-6 rounded-xl prose-custom max-w-none text-gray-300"><p class="text-lg">ã‚ˆã†ã“ãã€‚ã“ã‚Œã‹ã‚‰ã€ã‚ãªãŸã ã‘ã®ã€ŒOSè¨­è¨ˆå›³ã€ã‚’å‰µã‚‹ãŸã‚ã®ã€å¯¾è©±ã‚’å§‹ã‚ã¾ã™ã€‚</p><p class="mt-6">HaQeiã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã¯ã€3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã€ã‚ãªãŸã®é­‚ã®è¨­è¨ˆå›³ã‚’å…±åŒã§æ§‹ç¯‰ã—ã¾ã™ã€‚</p><div class="grid md:grid-cols-3 gap-6 my-6 text-left"><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-amber-300 flex items-center"><span class="text-xl mr-2">1</span>ä¾¡å€¤è¦³ã®æ˜ç¢ºåŒ–</h4><p class="text-xs mt-2">ã¾ãšã€ã„ãã¤ã‹ã®å•ã„ã‹ã‚‰ã€ã‚ãªãŸã®æ ¸ã¨ãªã‚‹8ã¤ã®åŸºæœ¬ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ãƒãƒ©ãƒ³ã‚¹ã‚’åˆ†æã—ã¾ã™ã€‚</p></div><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-indigo-300 flex items-center"><span class="text-xl mr-2">2</span>ã‚¨ãƒ³ã‚¸ãƒ³OSã®é¸æŠ</h4><p class="text-xs mt-2">æ¬¡ã«ã€æç¤ºã•ã‚ŒãŸå€™è£œã®ä¸­ã‹ã‚‰ã€ã‚ãªãŸã®æ„Ÿè¦šã«æœ€ã‚‚è¿‘ã„<strong class="text-white">ã€Œã‚¨ãƒ³ã‚¸ãƒ³OSã€ã‚’ã‚ãªãŸè‡ªèº«ãŒé¸æŠ</strong>ã—ã¾ã™ã€‚</p></div><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-green-300 flex items-center"><span class="text-xl mr-2">3</span>è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š</h4><p class="text-xs mt-2">ã‚ãªãŸã®é¸æŠã‚’åŸºã«ã€æ®‹ã‚Šã®OSã‚’ç‰¹å®šã—ã€<strong class="text-white">æˆ¦ç•¥ãƒ¬ãƒãƒ¼ãƒˆ</strong>ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p></div></div><p>ã‚ãªãŸã®æ„Ÿè¦šã“ããŒã€æœ€ã‚‚ä¿¡é ¼ã§ãã‚‹ç¾…é‡ç›¤ã§ã™ã€‚ã©ã†ãã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã€å¯¾è©±ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ã€‚</p></div><div class="mt-8 pt-8 border-t border-gray-700 text-center"><button id="startBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105">å¯¾è©±ã‚’é–‹å§‹ã™ã‚‹</button></div>`;
        document
          .getElementById("startBtn")
          .addEventListener("click", showWorldviewQuestions);
      }

      function showWorldviewQuestions() {
        let html = `<h3 class="text-xl font-bold text-amber-300 mb-6 text-center">Step 1ï¼šã‚ãªãŸã®ä¾¡å€¤è¦³ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„</h3>`;
        WORLDVIEW_QUESTIONS.forEach((q, index) => {
          const worldviewOpts = q.options
            .map(
              (opt) =>
                `<div><input type="radio" name="${q.id}" id="wvq_${q.id}_${opt.value}" value="${opt.value}" class="sr-only peer"><label for="wvq_${q.id}_${opt.value}" class="option-label">${opt.text}</label></div>`
            )
            .join("");
          html += `<div class="diagnostic-item"><div class="question-block"><p class="question-text">${
            index + 1
          }. ${
            q.text
          }</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">${worldviewOpts}</div></div></div>`;
        });
        html += `<div class="mt-8 text-center"><button id="analyzeEnergyBtn" class="w-full sm:w-auto bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300">ä¾¡å€¤è¦³ã‚’åˆ†æã™ã‚‹</button></div>`;
        diagnosticContainer.innerHTML = html;
        document
          .getElementById("analyzeEnergyBtn")
          .addEventListener("click", handleEnergyAnalysis);
      }

      function handleEnergyAnalysis() {
        if (
          !Array.from(document.querySelectorAll('input[name^="wvq"]')).every(
            (r) => document.querySelector(`input[name="${r.name}"]:checked`)
          )
        ) {
          alert("Step 1ã®ã™ã¹ã¦ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        // æ–°ã—ã„ãƒ™ã‚¯ãƒˆãƒ«ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
        analysisState.userProfileVector =
          buildUserProfileVector(WORLDVIEW_QUESTIONS);
        analysisState.trigramScores = runTrigramAnalysis();
        analysisState.adjustedTrigramScores = {
          ...analysisState.trigramScores,
        };
        showRadarVisualization();
      }

      function showRadarVisualization() {
        const html = `
              <h3 class="text-xl font-bold text-amber-300 mb-2 text-center">Step 1-Bï¼šä¾¡å€¤è¦³ã®åˆ†æçµæœ</h3>
              <p class="text-center text-gray-400 mb-6 text-sm">ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã¯ã€ã‚ãªãŸã®ä¾¡å€¤è¦³ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å¯è¦–åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚<br>ã“ã®åˆ†æçµæœã‚’åœŸå°ã¨ã—ã¦ã€ã‚ãªãŸã®ã‚¨ãƒ³ã‚¸ãƒ³OSå€™è£œã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
              <div id="radar-chart-container" class="radar-container">
                  <canvas id="trigram-radar-chart"></canvas>
              </div>
              <section id="wv-confirm" class="mt-8 text-center">
                  <button id="confirm-scores-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300">ã“ã®åˆ†æçµæœã§OSå€™è£œã‚’ç”Ÿæˆ</button>
              </section>
          `;
        diagnosticContainer.innerHTML = html;

        const radarCtx = document
          .getElementById("trigram-radar-chart")
          .getContext("2d");
        trigramRadarChart = renderTrigramRadar(
          radarCtx,
          analysisState.adjustedTrigramScores
        );

        document
          .getElementById("confirm-scores-btn")
          .addEventListener("click", () => {
            analysisState.engineCandidates = getEngineCandidates(
              analysisState.userProfileVector
            );
            showEngineCandidateSelection();
          });
      }

      function showEngineCandidateSelection() {
        let html = `
          <div class="text-center">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Step 2ï¼šã‚ãªãŸã®ã‚¨ãƒ³ã‚¸ãƒ³OSã‚’é¸æŠã—ã¦ãã ã•ã„</h3>
            <div class="bg-gray-900/50 p-6 rounded-xl prose-custom max-w-none text-gray-300">
              <p>ã‚ãªãŸã®ä¾¡å€¤è¦³ã®åˆ†æã«åŸºã¥ãã€ã‚¨ãƒ³ã‚¸ãƒ³OSã®å€™è£œãŒ4ã¤ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿ã€æœ€ã‚‚ã€Œã“ã‚Œã ï¼ã€ã¨æ„Ÿã˜ã‚‹ã‚‚ã®ã‚’<strong>1ã¤ã ã‘</strong>é¸ã‚“ã§ãã ã•ã„ã€‚</p>
              <p class="text-xs text-gray-400 mt-2">ğŸ’¡ ã‚«ãƒ¼ãƒ‰ä¸‹éƒ¨ã®èª¬æ˜ã¯ã€AIãŒãã®OSã‚’å€™è£œã¨ã—ã¦é¸ã‚“ã ç†ç”±ã§ã™ã€‚</p>
            </div>
            <div id="engine-candidate-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">`;

        analysisState.engineCandidates.forEach((os) => {
          const osManual = osManualData[String(os.hexagram_id)] || {};
          const keyword = osManual.keyword_short || "???";
          const icon = osManual.archetype_icon || "â“";

          html += `
            <div id="card-select-${os.hexagram_id}" data-id="${
            os.hexagram_id
          }" class="engine-card" role="button" tabindex="0" aria-pressed="false">
              <div class="card-content">
                <header class="engine-card-header">
                  <span role="img" aria-label="${keyword}" class="archetype-icon">${icon}</span>
                  <div>
                    <h4 class="archetype-name">${os.name_jp}</h4>
                    <span class="text-xs text-indigo-400 font-semibold">${keyword}</span>
                  </div>
                </header>
                <p class="text-sm text-gray-300 mt-3 flex-grow">${
                  osManual.summary || "è§£èª¬æº–å‚™ä¸­..."
                }</p>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <p class="text-xs font-semibold text-gray-400 mb-2">AIã«ã‚ˆã‚‹é¸å®šæ ¹æ‹ </p>
                  <p class="text-sm text-gray-500" data-reason>${
                    os.reason || ""
                  }</p>
                </div>
                <div class="engine-card-tip" data-tip-for="${
                  os.hexagram_id
                }"></div>
              </div>
            </div>`;
        });
        html += `</div><div class="mt-8 text-center"><button id="lock-in-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>ã“ã®OSã§æœ€çµ‚æ±ºå®šã™ã‚‹</button></div></div>`;
        diagnosticContainer.innerHTML = html;

        document.querySelectorAll(".engine-card").forEach((card) => {
          card.addEventListener("click", handleCandidateSelection);
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              handleCandidateSelection({ currentTarget: card });
            }
          });
        });
        document
          .getElementById("lock-in-btn")
          .addEventListener("click", handleEngineLockIn);
      }

      function handleCandidateSelection(event) {
        const selectedCard = event.currentTarget;
        const selectedId = parseInt(selectedCard.dataset.id, 10);

        document.querySelectorAll(".engine-card").forEach((card) => {
          card.classList.remove("selected");
          card.setAttribute("aria-pressed", "false");
        });

        selectedCard.classList.add("selected");
        selectedCard.setAttribute("aria-pressed", "true");

        analysisState.selectedEngine = selectedId;

        document.getElementById("lock-in-btn").disabled = false;
      }

      function handleEngineLockIn() {
        const os = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id === analysisState.selectedEngine
        );
        if (os) {
          analysisState.lockedEngineOs = os;
          analysisState.influentialOses = calculateInfluenceScores(
            analysisState.engineCandidates,
            analysisState.selectedEngine
          );
          showScenarioQuestions();
        }
      }

      function runTrigramAnalysis() {
        const scores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0 };
        WORLDVIEW_QUESTIONS.forEach((q) => {
          const node = document.querySelector(`input[name="${q.id}"]:checked`);
          if (!node) return;
          const choice = q.options.find((opt) => opt.value === node.value);
          if (choice && choice.scoring_tags) {
            // æ–°ã—ã„scoring_tagså½¢å¼ã«å¯¾å¿œ
            choice.scoring_tags.forEach((tag) => {
              // å…«å¦ã®åå‰ã‹ã‚‰IDã‚’å–å¾—ã™ã‚‹ç°¡æ˜“çš„ãªãƒãƒƒãƒ”ãƒ³ã‚°
              const trigramMapping = {
                ä¹¾: 1,
                å…Œ: 2,
                é›¢: 3,
                éœ‡: 4,
                å·½: 5,
                å: 6,
                è‰®: 7,
                å¤: 8,
              };
              if (trigramMapping[tag.key]) {
                scores[trigramMapping[tag.key]] =
                  (scores[trigramMapping[tag.key]] || 0) + tag.value;
              }
            });
          } else if (choice && choice.scores) {
            // æ—§å½¢å¼ã®scoresã‚‚ã‚µãƒãƒ¼ãƒˆ
            for (const id in choice.scores) {
              if (Object.hasOwnProperty.call(choice.scores, id)) {
                scores[id] = (scores[id] || 0) + choice.scores[id];
              }
            }
          }
        });

        const maxScore = Math.max(...Object.values(scores), 1);
        const normalizedScores = {};
        for (const id in scores) {
          const normalized = (scores[id] / maxScore) * 100;
          normalizedScores[id] = Math.max(0, Math.min(100, normalized));
        }
        return normalizedScores;
      }

      function determineInterfaceAndSafemode() {
        const scenarioTrigramScores = {
          1: 0,
          2: 0,
          3: 0,
          4: 0,
          5: 0,
          6: 0,
          7: 0,
          8: 0,
        };
        SCENARIO_QUESTIONS.forEach((q) => {
          const innerNode = document.querySelector(
            `input[name="${q.id}_inner"]:checked`
          );
          const outerNode = document.querySelector(
            `input[name="${q.id}_outer"]:checked`
          );

          const innerChoice = q.options.inner[Number(innerNode.value)];
          if (innerChoice && innerChoice.scoring_tags) {
            // æ–°ã—ã„scoring_tagså½¢å¼ã«å¯¾å¿œ
            innerChoice.scoring_tags.forEach((tag) => {
              const trigramMapping = {
                ä¹¾: 1,
                å…Œ: 2,
                é›¢: 3,
                éœ‡: 4,
                å·½: 5,
                å: 6,
                è‰®: 7,
                å¤: 8,
              };
              if (trigramMapping[tag.key]) {
                scenarioTrigramScores[trigramMapping[tag.key]] =
                  (scenarioTrigramScores[trigramMapping[tag.key]] || 0) +
                  tag.value;
              }
            });
          } else if (innerChoice && innerChoice.scores) {
            // æ—§å½¢å¼ã®scoresã‚‚ã‚µãƒãƒ¼ãƒˆ
            for (const id in innerChoice.scores) {
              if (Object.hasOwnProperty.call(innerChoice.scores, id)) {
                scenarioTrigramScores[id] =
                  (scenarioTrigramScores[id] || 0) + innerChoice.scores[id];
              }
            }
          }

          const outerChoice = q.options.outer[Number(outerNode.value)];
          if (outerChoice && outerChoice.scoring_tags) {
            // æ–°ã—ã„scoring_tagså½¢å¼ã«å¯¾å¿œ
            outerChoice.scoring_tags.forEach((tag) => {
              const trigramMapping = {
                ä¹¾: 1,
                å…Œ: 2,
                é›¢: 3,
                éœ‡: 4,
                å·½: 5,
                å: 6,
                è‰®: 7,
                å¤: 8,
              };
              if (trigramMapping[tag.key]) {
                scenarioTrigramScores[trigramMapping[tag.key]] =
                  (scenarioTrigramScores[trigramMapping[tag.key]] || 0) +
                  tag.value;
              }
            });
          } else if (outerChoice && outerChoice.scores) {
            // æ—§å½¢å¼ã®scoresã‚‚ã‚µãƒãƒ¼ãƒˆ
            for (const id in outerChoice.scores) {
              if (Object.hasOwnProperty.call(outerChoice.scores, id)) {
                scenarioTrigramScores[id] =
                  (scenarioTrigramScores[id] || 0) + outerChoice.scores[id];
              }
            }
          }
        });

        const baseScores = {};
        HAQEI_DATA.hexagrams_master.forEach((hex) => {
          if (hex.hexagram_id === analysisState.lockedEngineOs.hexagram_id)
            return;
          const scenarioScore =
            (scenarioTrigramScores[hex.upper_trigram_id] || 0) +
            (scenarioTrigramScores[hex.lower_trigram_id] || 0);
          let worldviewCompatibilityScore = 0;
          if (analysisState.adjustedTrigramScores[hex.upper_trigram_id])
            worldviewCompatibilityScore +=
              analysisState.adjustedTrigramScores[hex.upper_trigram_id];
          if (analysisState.adjustedTrigramScores[hex.lower_trigram_id])
            worldviewCompatibilityScore +=
              analysisState.adjustedTrigramScores[hex.lower_trigram_id];
          baseScores[hex.hexagram_id] =
            scenarioScore * 0.7 + (worldviewCompatibilityScore / 2) * 0.3;
        });

        const sortedOs = Object.entries(baseScores).sort(
          ([, a], [, b]) => b - a
        );
        const interfaceOs = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id == sortedOs[0][0]
        );
        const safemodeOs = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id == sortedOs[1][0]
        );

        return { interfaceOs, safemodeOs };
      }

      function handleFinalAnalysis() {
        if (!document.getElementById("agreementCheckbox").checked) {
          alert("åˆ©ç”¨è¦ç´„ã¨ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ã«åŒæ„ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        if (
          !Array.from(SCENARIO_QUESTIONS).every(
            (q) =>
              document.querySelector(`input[name="${q.id}_inner"]:checked`) &&
              document.querySelector(`input[name="${q.id}_outer"]:checked`)
          )
        ) {
          alert("Step 3ã®ã™ã¹ã¦ã®ã‚·ãƒŠãƒªã‚ªã«å›ç­”ã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const { interfaceOs, safemodeOs } = determineInterfaceAndSafemode();

        const analysisResult = {
          hexagram_candidates: [
            analysisState.lockedEngineOs,
            interfaceOs,
            safemodeOs,
          ],
          trigram_profile: Object.entries(
            analysisState.adjustedTrigramScores
          ).map(([id, score]) => ({
            id: parseInt(id),
            name_jp: HAQEI_DATA.trigrams_master.find((t) => t.trigram_id == id)
              .name_jp,
            score: score,
          })),
        };

        const dataToStore = {
          analysisResult: analysisResult,
          userContext: {},
          userProfile: {},
        };

        try {
          localStorage.setItem(
            "haqeiOsAnalyzerData",
            JSON.stringify(dataToStore)
          );
          displayReport(analysisResult);
        } catch (e) {
          console.error("OSåˆ†æãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
          alert("ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚");
        }
      }

      function displayReport(analysisResult) {
        const oses = analysisResult.hexagram_candidates;
        let reportHtml = `<div class="text-center space-y-12">
                            <div class="report-section">
                              <h3 class="text-3xl font-bold text-indigo-300">ã‚ãªãŸã®3ã¤ã®äººæ ¼OS</h3>
                              <p class="mt-4 max-w-2xl mx-auto text-gray-400">åˆ†æãŒå®Œäº†ã—ã¾ã—ãŸã€‚ä»¥ä¸‹ãŒã€ã‚ãªãŸã®æ€è€ƒã¨è¡Œå‹•ã®æ ¸ã¨ãªã‚‹3ã¤ã®OSã§ã™ã€‚å„OSã®ç‰¹æ€§ã‚’ç†è§£ã—ã€ä»Šå¾Œã®æˆ¦ç•¥ç«‹æ¡ˆã«ãŠå½¹ç«‹ã¦ãã ã•ã„ã€‚</p>
                              <div id="os-cards-container" class="mt-8 space-y-6 text-left"></div>
                            </div>
                            <div class="mt-16 pt-8 border-t-2 border-dashed border-gray-700">
                                <h3 class="text-xl font-bold text-amber-300 mb-4">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸</h3>
                                <div class="mt-8">
                                    <a href="cockpit.html" class="bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105">æˆ¦ç•¥ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆã§å…¨ä½“åƒã‚’æŠŠæ¡ã™ã‚‹ &rarr;</a>
                                </div>
                            </div>
                          </div>`;
        diagnosticContainer.innerHTML = reportHtml;

        const osCardsContainer = document.getElementById("os-cards-container");
        const template = document.getElementById("os-card-template");
        const osTypes = ["ã‚¨ãƒ³ã‚¸ãƒ³OS", "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹OS", "ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰OS"];
        const osIcons = ["ğŸ”¥", "ğŸ­", "ğŸ›¡ï¸"];
        const colors = ["#F87171", "#60A5FA", "#9CA3AF"];

        oses.forEach((os, index) => {
          if (!os) return;
          const role = osTypes[index];
          const clone = template.content.cloneNode(true);
          const card = clone.querySelector("div");
          const manual = osManualData[String(os.hexagram_id)] || {};

          card.style.borderColor = colors[index];
          card.querySelector("[data-role-icon]").textContent = osIcons[index];
          card.querySelector("[data-role-label]").textContent = role;
          card.querySelector("[data-os-name]").textContent = os.name_jp;
          card.querySelector("[data-os-catchphrase]").textContent =
            os.catchphrase;
          card.querySelector("[data-yin-mode]").textContent =
            manual.defensive_use || "è§£èª¬æº–å‚™ä¸­";
          card.querySelector("[data-yang-mode]").textContent =
            manual.proactive_use || "è§£èª¬æº–å‚™ä¸­";
          card.querySelector("[data-strategic-summary]").textContent =
            manual.summary || "è§£èª¬æº–å‚™ä¸­";

          osCardsContainer.appendChild(clone);
        });
      }

      function showScenarioQuestions() {
        let html = `<h3 class="text-xl font-bold text-indigo-300 mb-6 text-center">Step 3ï¼šã‚ãªãŸã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„</h3>`;
        html += `<p class="text-center text-sm text-gray-400 mb-6">ã‚¨ãƒ³ã‚¸ãƒ³OSã€${analysisState.lockedEngineOs.name_jp}ã€‘ãŒãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã•ã‚Œã¾ã—ãŸã€‚æ¬¡ã«ã€ç¤¾ä¼šçš„ãªå ´é¢ã‚„ã‚¹ãƒˆãƒ¬ã‚¹ä¸‹ã§ã®ã‚ãªãŸã®æŒ¯ã‚‹èˆã„ã‚’åˆ†æã—ã€æ®‹ã‚Šã®OSã‚’ç‰¹å®šã—ã¾ã™ã€‚</p>`;
        SCENARIO_QUESTIONS.forEach((q, index) => {
          const innerOpts = q.options.inner
            .map(
              (opt, i) =>
                `<div><input type="radio" name="${q.id}_inner" value="${i}" id="scq_${q.id}_inner_${i}" class="sr-only peer"><label for="scq_${q.id}_inner_${i}" class="option-label">${opt.text}</label></div>`
            )
            .join("");
          const outerOpts = q.options.outer
            .map(
              (opt, i) =>
                `<div><input type="radio" name="${q.id}_outer" value="${i}" id="scq_${q.id}_outer_${i}" class="sr-only peer"><label for="scq_${q.id}_outer_${i}" class="option-label">${opt.text}</label></div>`
            )
            .join("");
          html += `<div class="diagnostic-item"><p class="text-gray-400 text-sm">ã‚·ãƒŠãƒªã‚ª ${
            index + 1
          }/${
            SCENARIO_QUESTIONS.length
          }</p><p class="font-semibold text-gray-200 mb-4">${
            q.scenario
          }</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="question-block"><p class="question-text">${
            q.inner_q
          }</p><div class="space-y-3 mt-4">${innerOpts}</div></div><div class="question-block"><p class="question-text">${
            q.outer_q
          }</p><div class="space-y-3 mt-4">${outerOpts}</div></div></div></div>`;
        });
        html += `<div class="mt-8 pt-8 border-t border-gray-700">
                  <div class="text-center">
                      <label class="flex items-center justify-center cursor-pointer">
                      <input type="checkbox" id="agreementCheckbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                      <span class="ml-2 text-sm text-gray-400">
                          <a href="/terms.html" target="_blank" class="underline hover:text-white">åˆ©ç”¨è¦ç´„</a>ãŠã‚ˆã³<a href="/privacy.html" target="_blank" class="underline hover:text-white">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ã¾ã™
                      </span>
                      </label>
                  </div>
                  <button id="finalAnalyzeBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105 mt-6 disabled:opacity-50 disabled:cursor-not-allowed" disabled>æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹</button>
                  </div>`;
        diagnosticContainer.innerHTML = html;
        const finalAnalyzeBtn = document.getElementById("finalAnalyzeBtn");
        const finalAgreementCheckbox =
          document.getElementById("agreementCheckbox");
        finalAnalyzeBtn.disabled = true;
        finalAgreementCheckbox.addEventListener("change", () => {
          finalAnalyzeBtn.disabled = !finalAgreementCheckbox.checked;
        });
        finalAnalyzeBtn.addEventListener("click", handleFinalAnalysis);
      }

      document.addEventListener("DOMContentLoaded", main);
    </script>
  </body>
</html>
