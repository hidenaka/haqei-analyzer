<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei ベーシックOS分析 V9.0-final</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>易</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        /* 継承競合対策 */
        color: transparent;
      }
      .engine-card.selected {
        background-color: #2d4810;
        color: #ffffff;
        border-color: #a3e635;
        box-shadow: 0 0 25px rgba(163, 230, 53, 0.4),
          0 0 0 3px rgba(163, 230, 53, 0.7);
        transform: translateY(-5px) scale(1.05);
      }
      .engine-card.selected .archetype-name {
        color: #ffffff;
      }
      .prose-custom {
        color: #d1d5db;
        line-height: 1.8;
      }
      .prose-custom p {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      .prose-custom strong {
        color: #facc15;
      }
      .diagnostic-item {
        background-color: rgba(31, 41, 55, 0.7);
        border: 1px solid #374151;
        border-radius: 1rem;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
        margin-bottom: 2rem;
      }
      .option-label {
        display: flex;
        align-items: center;
        text-align: left;
        padding: 0.75rem 1rem;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 100%;
        background-color: #374151;
        font-size: 0.875rem;
        line-height: 1.5;
        color: #d1d5db;
      }
      .option-label:hover,
      input[type="radio"]:focus-visible + .option-label {
        background-color: #4b5563;
        border-color: #6366f1;
        color: #ffffff;
      }
      input[type="radio"]:checked + .option-label {
        border-color: #a5b4fc;
        background-color: #4338ca;
        box-shadow: 0 0 10px rgba(165, 180, 252, 0.4);
        color: #ffffff;
      }
      .report-section h3,
      .report-section h4 {
        font-family: "Shippori Mincho", serif;
      }
      .engine-card {
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 1.25rem;
        background-color: #1f2937;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }
      .engine-card:hover,
      .engine-card:focus-visible {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.4);
        border-color: rgba(165, 180, 252, 0.5);
        outline: none;
      }
      .engine-card-header {
        text-align: left;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .engine-card-header .archetype-icon {
        font-size: 1.75rem;
        line-height: 1;
      }
      .engine-card-header .archetype-name {
        font-family: "Shippori Mincho", serif;
        font-weight: 700;
        font-size: 1.125rem;
      }
      .engine-card-tip {
        font-size: 0.75rem;
        margin-top: 0.75rem;
        padding: 0.5rem;
        border-radius: 0.375rem;
        color: #d1d5db;
        background-color: rgba(17, 24, 39, 0.6);
        min-height: 2.5rem;
      }
      .radar-container {
        position: relative;
        width: 100%;
        max-width: 400px;
        aspect-ratio: 1 / 1;
        margin: auto;
      }

      details summary {
        cursor: pointer;
        padding: 0.5rem 0;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
      }
      details summary:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      details[open] summary {
        margin-bottom: 0.5rem;
      }
      #trigram-tooltip {
        position: fixed;
        background-color: rgba(17, 24, 39, 0.9);
        color: #e5e7eb;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        padding: 0.75rem 1rem;
        font-size: 0.875rem;
        pointer-events: none;
        opacity: 0;
        transform: scale(0.95);
        transition: opacity 0.3s ease, transform 0.3s ease;
        z-index: 9999;
        max-width: 280px;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-8">
    <div
      class="w-full max-w-4xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-10"
    >
      <header class="text-center mb-10">
        <a
          href="./"
          class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block text-sm"
          >← トップページへ戻る</a
        >
        <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
          ベーシックOS分析
        </h1>
        <p class="text-gray-400 mt-2">
          あなたという存在の核となる、3つの人格OSを特定します。
        </p>
      </header>
      <div id="diagnostic-container"></div>
    </div>
    <template id="os-card-template"></template>
    <div id="trigram-tooltip"></div>
    <script type="module">
      import {
        WORLDVIEW_QUESTIONS,
        SCENARIO_QUESTIONS,
      } from "./js/questions.js";

      const HAQEI_DATA = {
        element_relationships: [
          {
            source_element: "木",
            target_element: "火",
            relationship_type: "相生",
          },
          {
            source_element: "火",
            target_element: "土",
            relationship_type: "相生",
          },
          {
            source_element: "土",
            target_element: "金",
            relationship_type: "相生",
          },
          {
            source_element: "金",
            target_element: "水",
            relationship_type: "相生",
          },
          {
            source_element: "水",
            target_element: "木",
            relationship_type: "相生",
          },
          {
            source_element: "木",
            target_element: "土",
            relationship_type: "相剋",
          },
          {
            source_element: "土",
            target_element: "水",
            relationship_type: "相剋",
          },
          {
            source_element: "水",
            target_element: "火",
            relationship_type: "相剋",
          },
          {
            source_element: "火",
            target_element: "金",
            relationship_type: "相剋",
          },
          {
            source_element: "金",
            target_element: "木",
            relationship_type: "相剋",
          },
        ],
        trigrams_master: [
          { trigram_id: 1, name_jp: "乾", element: "金" },
          { trigram_id: 2, name_jp: "兌", element: "金" },
          { trigram_id: 3, name_jp: "離", element: "火" },
          { trigram_id: 4, name_jp: "震", element: "木" },
          { trigram_id: 5, name_jp: "巽", element: "木" },
          { trigram_id: 6, name_jp: "坎", element: "水" },
          { trigram_id: 7, name_jp: "艮", element: "土" },
          { trigram_id: 8, name_jp: "坤", element: "土" },
        ],
        hexagrams_master: [
          {
            hexagram_id: 1,
            name_jp: "乾為天",
            upper_trigram_id: 1,
            lower_trigram_id: 1,
            catchphrase: "天翔ける龍のような、天性のリーダー",
          },
          {
            hexagram_id: 2,
            name_jp: "坤為地",
            upper_trigram_id: 8,
            lower_trigram_id: 8,
            catchphrase: "大地の母のように、すべてを受け入れる人",
          },
          {
            hexagram_id: 3,
            name_jp: "水雷屯",
            upper_trigram_id: 6,
            lower_trigram_id: 4,
            catchphrase: "産みの苦しみを乗り越える、粘り強い開拓者",
          },
          {
            hexagram_id: 4,
            name_jp: "山水蒙",
            upper_trigram_id: 7,
            lower_trigram_id: 6,
            catchphrase: "未知を恐れず、何事も素直に学べる学習者",
          },
          {
            hexagram_id: 5,
            name_jp: "水天需",
            upper_trigram_id: 6,
            lower_trigram_id: 1,
            catchphrase: "最善の時を待てる、辛抱強い戦略家",
          },
          {
            hexagram_id: 6,
            name_jp: "天水訟",
            upper_trigram_id: 1,
            lower_trigram_id: 6,
            catchphrase: "信念を貫き、正義を問う論客",
          },
          {
            hexagram_id: 7,
            name_jp: "地水師",
            upper_trigram_id: 8,
            lower_trigram_id: 6,
            catchphrase: "規律と統率力で、組織を導く司令官",
          },
          {
            hexagram_id: 8,
            name_jp: "水地比",
            upper_trigram_id: 6,
            lower_trigram_id: 8,
            catchphrase: "心で繋がり、人を支えるサポーター",
          },
          {
            hexagram_id: 9,
            name_jp: "風天小畜",
            upper_trigram_id: 5,
            lower_trigram_id: 1,
            catchphrase: "小さな努力を積み重ねる、堅実な実務家",
          },
          {
            hexagram_id: 10,
            name_jp: "天澤履",
            upper_trigram_id: 1,
            lower_trigram_id: 2,
            catchphrase: "礼節をわきまえ、慎重に進むチャレンジャー",
          },
          {
            hexagram_id: 11,
            name_jp: "地天泰",
            upper_trigram_id: 8,
            lower_trigram_id: 1,
            catchphrase: "異なる要素を調和させる、平和を愛する調整役",
          },
          {
            hexagram_id: 12,
            name_jp: "天地否",
            upper_trigram_id: 1,
            lower_trigram_id: 8,
            catchphrase: "自分の内なる世界を、深く追求する思想家",
          },
          {
            hexagram_id: 13,
            name_jp: "天火同人",
            upper_trigram_id: 1,
            lower_trigram_id: 3,
            catchphrase: "公平な理念で、人々を団結させるまとめ役",
          },
          {
            hexagram_id: 14,
            name_jp: "火天大有",
            upper_trigram_id: 3,
            lower_trigram_id: 1,
            catchphrase: "太陽のように、寛大さで人を照らすリーダー",
          },
          {
            hexagram_id: 15,
            name_jp: "地山謙",
            upper_trigram_id: 8,
            lower_trigram_id: 7,
            catchphrase: "実力があっても、常に謙虚でいられる人格者",
          },
          {
            hexagram_id: 16,
            name_jp: "雷地豫",
            upper_trigram_id: 4,
            lower_trigram_id: 8,
            catchphrase: "周到な準備で、人を楽しませるエンターテイナー",
          },
          {
            hexagram_id: 17,
            name_jp: "沢雷随",
            upper_trigram_id: 2,
            lower_trigram_id: 4,
            catchphrase: "変化の波に乗りこなす、柔軟なフォロワー",
          },
          {
            hexagram_id: 18,
            name_jp: "山風蠱",
            upper_trigram_id: 7,
            lower_trigram_id: 5,
            catchphrase: "根本原因を立て直す、情熱的な改革者",
          },
          {
            hexagram_id: 19,
            name_jp: "地沢臨",
            upper_trigram_id: 8,
            lower_trigram_id: 2,
            catchphrase: "人を育て導く、面倒見のいいリーダー",
          },
          {
            hexagram_id: 20,
            name_jp: "風地観",
            upper_trigram_id: 5,
            lower_trigram_id: 8,
            catchphrase: "物事の本質を見抜く、静かな観察者",
          },
          {
            hexagram_id: 21,
            name_jp: "火雷噬嗑",
            upper_trigram_id: 3,
            lower_trigram_id: 4,
            catchphrase: "障害を噛み砕き、断固として進む実行者",
          },
          {
            hexagram_id: 22,
            name_jp: "山火賁",
            upper_trigram_id: 7,
            lower_trigram_id: 3,
            catchphrase: "本質を美しく彩る、天性のアーティスト",
          },
          {
            hexagram_id: 23,
            name_jp: "山地剝",
            upper_trigram_id: 7,
            lower_trigram_id: 8,
            catchphrase: "古いものを手放し、本質を見出す変革者",
          },
          {
            hexagram_id: 24,
            name_jp: "地雷復",
            upper_trigram_id: 8,
            lower_trigram_id: 4,
            catchphrase: "失敗を次に活かす、しなやかな挑戦者",
          },
          {
            hexagram_id: 25,
            name_jp: "天雷无妄",
            upper_trigram_id: 1,
            lower_trigram_id: 4,
            catchphrase: "自然体で、あるがままを受け入れる楽天家",
          },
          {
            hexagram_id: 26,
            name_jp: "山天大畜",
            upper_trigram_id: 7,
            lower_trigram_id: 1,
            catchphrase: "内に力を蓄え、好機を待つ大器晩成の人",
          },
          {
            hexagram_id: 27,
            name_jp: "山雷頤",
            upper_trigram_id: 7,
            lower_trigram_id: 4,
            catchphrase: "言葉と時間をかけて、物事を育む専門家",
          },
          {
            hexagram_id: 28,
            name_jp: "澤風大過",
            upper_trigram_id: 2,
            lower_trigram_id: 5,
            catchphrase: "常識の枠を超える、大胆なゲームチェンジャー",
          },
          {
            hexagram_id: 29,
            name_jp: "坎為水",
            upper_trigram_id: 6,
            lower_trigram_id: 6,
            catchphrase: "困難の渦中で、真理を見出す不屈の探求者",
          },
          {
            hexagram_id: 30,
            name_jp: "離為火",
            upper_trigram_id: 3,
            lower_trigram_id: 3,
            catchphrase: "情熱と知性で、人を惹きつける華やかなスター",
          },
          {
            hexagram_id: 31,
            name_jp: "沢山咸",
            upper_trigram_id: 2,
            lower_trigram_id: 7,
            catchphrase: "理屈抜きに、心で感じ取れる共感者",
          },
          {
            hexagram_id: 32,
            name_jp: "雷風恒",
            upper_trigram_id: 4,
            lower_trigram_id: 5,
            catchphrase: "決めた道を、着実に歩み続ける継続者",
          },
          {
            hexagram_id: 33,
            name_jp: "天山遯",
            upper_trigram_id: 1,
            lower_trigram_id: 7,
            catchphrase: "賢明な距離感を保つ、クールな戦略家",
          },
          {
            hexagram_id: 34,
            name_jp: "雷天大壮",
            upper_trigram_id: 4,
            lower_trigram_id: 1,
            catchphrase: "目標に向かって、力強く進むチャレンジャー",
          },
          {
            hexagram_id: 35,
            name_jp: "火地晋",
            upper_trigram_id: 3,
            lower_trigram_id: 8,
            catchphrase: "周りを明るく照らし、前進を促すプロモーター",
          },
          {
            hexagram_id: 36,
            name_jp: "地火明夷",
            upper_trigram_id: 8,
            lower_trigram_id: 3,
            catchphrase: "逆境にあっても、希望を失わない芯の強い人",
          },
          {
            hexagram_id: 37,
            name_jp: "風火家人",
            upper_trigram_id: 5,
            lower_trigram_id: 3,
            catchphrase: "自分の居場所を、大切に守り育てる人",
          },
          {
            hexagram_id: 38,
            name_jp: "火沢睽",
            upper_trigram_id: 3,
            lower_trigram_id: 2,
            catchphrase: "あえて人と違う道を行く、個性的な独創家",
          },
          {
            hexagram_id: 39,
            name_jp: "水山蹇",
            upper_trigram_id: 6,
            lower_trigram_id: 7,
            catchphrase: "困難な状況を、知恵と工夫で乗り越える策士",
          },
          {
            hexagram_id: 40,
            name_jp: "雷水解",
            upper_trigram_id: 4,
            lower_trigram_id: 6,
            catchphrase: "問題をスピーディに解決する、決断力のある人",
          },
          {
            hexagram_id: 41,
            name_jp: "山沢損",
            upper_trigram_id: 7,
            lower_trigram_id: 2,
            catchphrase: "人のために自分を役立てる、誠実な貢献者",
          },
          {
            hexagram_id: 42,
            name_jp: "風雷益",
            upper_trigram_id: 5,
            lower_trigram_id: 4,
            catchphrase: "善意の循環を生み出す、心優しいサポーター",
          },
          {
            hexagram_id: 43,
            name_jp: "沢天夬",
            upper_trigram_id: 2,
            lower_trigram_id: 1,
            catchphrase: "ためらわずに決断し、道を拓く突破役",
          },
          {
            hexagram_id: 44,
            name_jp: "天風姤",
            upper_trigram_id: 1,
            lower_trigram_id: 5,
            catchphrase: "偶然の出会いをチャンスに変える、天性のネットワーカー",
          },
          {
            hexagram_id: 45,
            name_jp: "沢地萃",
            upper_trigram_id: 2,
            lower_trigram_id: 8,
            catchphrase: "人と喜びが集まる場を創る、中心人物",
          },
          {
            hexagram_id: 46,
            name_jp: "地風升",
            upper_trigram_id: 8,
            lower_trigram_id: 5,
            catchphrase: "地道な努力で、着実に成長できる人",
          },
          {
            hexagram_id: 47,
            name_jp: "沢水困",
            upper_trigram_id: 2,
            lower_trigram_id: 6,
            catchphrase: "苦しい状況でも、自分を見失わない哲学者",
          },
          {
            hexagram_id: 48,
            name_jp: "水風井",
            upper_trigram_id: 6,
            lower_trigram_id: 5,
            catchphrase: "誰にでも公平に尽くせる、縁の下の力持ち",
          },
          {
            hexagram_id: 49,
            name_jp: "沢火革",
            upper_trigram_id: 2,
            lower_trigram_id: 3,
            catchphrase: "古い常識を刷新する、情熱を持った改革者",
          },
          {
            hexagram_id: 50,
            name_jp: "火風鼎",
            upper_trigram_id: 3,
            lower_trigram_id: 5,
            catchphrase: "新たな安定を築き上げる、懐の深いまとめ役",
          },
          {
            hexagram_id: 51,
            name_jp: "震為雷",
            upper_trigram_id: 4,
            lower_trigram_id: 4,
            catchphrase: "変化をチャンスに変える、瞬発力のある行動派",
          },
          {
            hexagram_id: 52,
            name_jp: "艮為山",
            upper_trigram_id: 7,
            lower_trigram_id: 7,
            catchphrase: "動じない自己を確立した、静かな求道者",
          },
          {
            hexagram_id: 53,
            name_jp: "風山漸",
            upper_trigram_id: 5,
            lower_trigram_id: 7,
            catchphrase: "物事を一歩ずつ、着実に進める誠実な人",
          },
          {
            hexagram_id: 54,
            name_jp: "雷沢帰妹",
            upper_trigram_id: 4,
            lower_trigram_id: 2,
            catchphrase: "自分の情熱に正直に生きる、純粋な情熱家",
          },
          {
            hexagram_id: 55,
            name_jp: "雷火豊",
            upper_trigram_id: 4,
            lower_trigram_id: 3,
            catchphrase: "豊かさを創り出し、分かち合うカリスマ",
          },
          {
            hexagram_id: 56,
            name_jp: "火山旅",
            upper_trigram_id: 3,
            lower_trigram_id: 7,
            catchphrase: "一箇所に留まらない、自由な旅人",
          },
          {
            hexagram_id: 57,
            name_jp: "巽為風",
            upper_trigram_id: 5,
            lower_trigram_id: 5,
            catchphrase: "隅々まで心配りができる、しなやかな調整役",
          },
          {
            hexagram_id: 58,
            name_jp: "兌為沢",
            upper_trigram_id: 2,
            lower_trigram_id: 2,
            catchphrase: "人と話すこと、喜ばせることが好きなエンターテイナー",
          },
          {
            hexagram_id: 59,
            name_jp: "風水渙",
            upper_trigram_id: 5,
            lower_trigram_id: 6,
            catchphrase: "心の壁を溶かし、風通しを良くする調整役",
          },
          {
            hexagram_id: 60,
            name_jp: "水沢節",
            upper_trigram_id: 6,
            lower_trigram_id: 2,
            catchphrase: "自分を律し、節度を保つことができる人",
          },
          {
            hexagram_id: 61,
            name_jp: "風沢中孚",
            upper_trigram_id: 5,
            lower_trigram_id: 2,
            catchphrase: "誠実さで、人の心を動かすことができる人",
          },
          {
            hexagram_id: 62,
            name_jp: "雷山小過",
            upper_trigram_id: 4,
            lower_trigram_id: 7,
            catchphrase: "謙虚すぎるほどに、丁寧さを重んじる人",
          },
          {
            hexagram_id: 63,
            name_jp: "水火既済",
            upper_trigram_id: 6,
            lower_trigram_id: 3,
            catchphrase: "完璧なバランスを求める、秩序の番人",
          },
          {
            hexagram_id: 64,
            name_jp: "火水未済",
            upper_trigram_id: 3,
            lower_trigram_id: 6,
            catchphrase: "未完成の中に、無限の可能性を見出す探求者",
          },
        ],
        H64_DATA: [
          { hexagram_id: 1, saku_id: 2, sou_id: 1, go_id: 1 },
          { hexagram_id: 2, saku_id: 1, sou_id: 2, go_id: 2 },
          { hexagram_id: 3, saku_id: 50, sou_id: 4, go_id: 23 },
          { hexagram_id: 4, saku_id: 49, sou_id: 3, go_id: 24 },
          { hexagram_id: 5, saku_id: 38, sou_id: 6, go_id: 64 },
          { hexagram_id: 6, saku_id: 37, sou_id: 5, go_id: 63 },
          { hexagram_id: 7, saku_id: 13, sou_id: 8, go_id: 2 },
          { hexagram_id: 8, saku_id: 14, sou_id: 7, go_id: 2 },
          { hexagram_id: 9, saku_id: 46, sou_id: 10, go_id: 61 },
          { hexagram_id: 10, saku_id: 45, sou_id: 9, go_id: 62 },
          { hexagram_id: 11, saku_id: 12, sou_id: 12, go_id: 54 },
          { hexagram_id: 12, saku_id: 11, sou_id: 11, go_id: 53 },
          { hexagram_id: 13, saku_id: 7, sou_id: 14, go_id: 44 },
          { hexagram_id: 14, saku_id: 8, sou_id: 13, go_id: 43 },
          { hexagram_id: 15, saku_id: 52, sou_id: 16, go_id: 40 },
          { hexagram_id: 16, saku_id: 51, sou_id: 15, go_id: 39 },
          { hexagram_id: 17, saku_id: 18, sou_id: 18, go_id: 27 },
          { hexagram_id: 18, saku_id: 17, sou_id: 17, go_id: 28 },
          { hexagram_id: 19, saku_id: 24, sou_id: 20, go_id: 54 },
          { hexagram_id: 20, saku_id: 23, sou_id: 19, go_id: 53 },
          { hexagram_id: 21, saku_id: 27, sou_id: 22, go_id: 35 },
          { hexagram_id: 22, saku_id: 28, sou_id: 21, go_id: 36 },
          { hexagram_id: 23, saku_id: 20, sou_id: 24, go_id: 2 },
          { hexagram_id: 24, saku_id: 19, sou_id: 23, go_id: 2 },
          { hexagram_id: 25, saku_id: 41, sou_id: 26, go_id: 28 },
          { hexagram_id: 26, saku_id: 42, sou_id: 25, go_id: 27 },
          { hexagram_id: 27, saku_id: 22, sou_id: 28, go_id: 2 },
          { hexagram_id: 28, saku_id: 21, sou_id: 27, go_id: 1 },
          { hexagram_id: 29, saku_id: 30, sou_id: 29, go_id: 29 },
          { hexagram_id: 30, saku_id: 29, sou_id: 30, go_id: 30 },
          { hexagram_id: 31, saku_id: 32, sou_id: 32, go_id: 44 },
          { hexagram_id: 32, saku_id: 31, sou_id: 31, go_id: 43 },
          { hexagram_id: 33, saku_id: 56, sou_id: 34, go_id: 53 },
          { hexagram_id: 34, saku_id: 55, sou_id: 33, go_id: 54 },
          { hexagram_id: 35, saku_id: 6, sou_id: 36, go_id: 63 },
          { hexagram_id: 36, saku_id: 5, sou_id: 35, go_id: 64 },
          { hexagram_id: 37, saku_id: 48, sou_id: 38, go_id: 61 },
          { hexagram_id: 38, saku_id: 47, sou_id: 37, go_id: 62 },
          { hexagram_id: 39, saku_id: 16, sou_id: 40, go_id: 63 },
          { hexagram_id: 40, saku_id: 15, sou_id: 39, go_id: 64 },
          { hexagram_id: 41, saku_id: 26, sou_id: 42, go_id: 24 },
          { hexagram_id: 42, saku_id: 25, sou_id: 41, go_id: 23 },
          { hexagram_id: 43, saku_id: 20, sou_id: 44, go_id: 1 },
          { hexagram_id: 44, saku_id: 19, sou_id: 43, go_id: 1 },
          { hexagram_id: 45, saku_id: 10, sou_id: 46, go_id: 53 },
          { hexagram_id: 46, saku_id: 9, sou_id: 45, go_id: 54 },
          { hexagram_id: 47, saku_id: 38, sou_id: 48, go_id: 37 },
          { hexagram_id: 48, saku_id: 37, sou_id: 47, go_id: 38 },
          { hexagram_id: 49, saku_id: 4, sou_id: 50, go_id: 30 },
          { hexagram_id: 50, saku_id: 3, sou_id: 49, go_id: 29 },
          { hexagram_id: 51, saku_id: 16, sou_id: 52, go_id: 51 },
          { hexagram_id: 52, saku_id: 15, sou_id: 51, go_id: 52 },
          { hexagram_id: 53, saku_id: 34, sou_id: 54, go_id: 40 },
          { hexagram_id: 54, saku_id: 33, sou_id: 53, go_id: 39 },
          { hexagram_id: 55, saku_id: 34, sou_id: 56, go_id: 64 },
          { hexagram_id: 56, saku_id: 33, sou_id: 55, go_id: 63 },
          { hexagram_id: 57, saku_id: 52, sou_id: 58, go_id: 57 },
          { hexagram_id: 58, saku_id: 51, sou_id: 57, go_id: 58 },
          { hexagram_id: 59, saku_id: 62, sou_id: 60, go_id: 40 },
          { hexagram_id: 60, saku_id: 61, sou_id: 59, go_id: 39 },
          { hexagram_id: 61, saku_id: 60, sou_id: 62, go_id: 27 },
          { hexagram_id: 62, saku_id: 59, sou_id: 61, go_id: 28 },
          { hexagram_id: 63, saku_id: 6, sou_id: 64, go_id: 30 },
          { hexagram_id: 64, saku_id: 5, sou_id: 63, go_id: 29 },
        ],
        os_manual: {},
      };

      const osManualData = {};

      const analysisState = {
        trigramScores: null,
        adjustedTrigramScores: null,
        engineCandidates: [],
        selectedEngine: null,
        lockedEngineOs: null,
        influentialOses: [],
        userProfileVector: null,
      };

      // 新しいベクトルロジック関数
      function buildUserProfileVector(questions) {
        // H64_PROFILE_VECTORSのキーを全て取得し、全要素が0の空のベクトルを作成
        const profileVector = {};

        // 引数で渡されたquestions配列をループ
        questions.forEach((q) => {
          // 各設問で、チェックされた選択肢のscoring_tags配列を取得
          const checkedOption = document.querySelector(
            `input[name="${q.id}"]:checked`
          );
          if (checkedOption) {
            const selectedOption = q.options.find(
              (opt) => opt.value === checkedOption.value
            );
            if (selectedOption && selectedOption.scoring_tags) {
              // scoring_tagsの各要素について、profileVectorの対応するキーに値を加算
              selectedOption.scoring_tags.forEach((tag) => {
                profileVector[tag.key] =
                  (profileVector[tag.key] || 0) + tag.value;
              });
            }
          }
        });

        return profileVector;
      }

      function calculateCosineSimilarity(vectorA, vectorB) {
        const keys = new Set([
          ...Object.keys(vectorA),
          ...Object.keys(vectorB),
        ]);
        let dotProduct = 0;
        let magnitudeA = 0;
        let magnitudeB = 0;

        keys.forEach((key) => {
          const a = vectorA[key] || 0;
          const b = vectorB[key] || 0;
          dotProduct += a * b;
          magnitudeA += a * a;
          magnitudeB += b * b;
        });

        const magnitudeProduct = Math.sqrt(magnitudeA) * Math.sqrt(magnitudeB);
        return magnitudeProduct === 0 ? 0 : dotProduct / magnitudeProduct;
      }

      function calculateMagnitudeMatchScore(vectorA, vectorB) {
        const keys = new Set([
          ...Object.keys(vectorA),
          ...Object.keys(vectorB),
        ]);
        let totalDifference = 0;

        keys.forEach((key) => {
          const a = vectorA[key] || 0;
          const b = vectorB[key] || 0;
          totalDifference += Math.abs(a - b);
        });

        return Math.max(0, 10 - totalDifference);
      }

      function getEngineCandidates(userProfileVector) {
        // H64_PROFILE_VECTORSの全OSデータをループ処理
        const candidates = HAQEI_DATA.hexagrams_master.map((os) => {
          // 各OSについて、2つのスコアを計算
          const similarityScore = calculateCosineSimilarity(
            userProfileVector,
            os.profile_vector || {}
          );
          const magnitudeScore = calculateMagnitudeMatchScore(
            userProfileVector,
            os.profile_vector || {}
          );

          // normalizedMagnitudeScoreを正規化
          const normalizedMagnitudeScore = Math.min(magnitudeScore / 10, 1.0);

          // 最終スコアを算出
          const finalScore =
            similarityScore * 0.7 + normalizedMagnitudeScore * 0.3;

          return { ...os, finalScore };
        });

        // スコアの高い順にソートして上位4件を返す
        return candidates
          .sort((a, b) => b.finalScore - a.finalScore)
          .slice(0, 4);
      }

      let trigramRadarChart = null;
      const diagnosticContainer = document.getElementById(
        "diagnostic-container"
      );

      function renderTrigramRadar(ctx, scores) {
        if (trigramRadarChart) {
          trigramRadarChart.destroy();
        }
        const labels = HAQEI_DATA.trigrams_master
          .sort((a, b) => a.trigram_id - b.trigram_id)
          .map((t) => t.name_jp);
        const dataPoints = Object.keys(scores)
          .sort((a, b) => a - b)
          .map((key) => scores[key]);

        // [最終FIX-B] グローバルスコープを明示的に参照
        trigramRadarChart = new window.Chart(ctx, {
          type: "radar",
          // (以降のChart.jsオプションは変更なし)
          data: {
            labels: labels,
            datasets: [
              {
                label: "八卦スコア",
                data: dataPoints,
                backgroundColor: "rgba(165, 180, 252, 0.2)",
                borderColor: "#a5b4fc",
                borderWidth: 2,
                pointBackgroundColor: "#e0e7ff",
                pointBorderColor: "#a5b4fc",
                pointHoverBackgroundColor: "#fff",
                pointHoverBorderColor: "#6366f1",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
              r: {
                angleLines: { color: "rgba(255, 255, 255, 0.2)" },
                grid: { color: "rgba(255, 255, 255, 0.2)" },
                pointLabels: {
                  font: { size: 14, weight: "bold" },
                  color: "#d1d5db",
                },
                ticks: {
                  display: false,
                  stepSize: 25,
                  backdropColor: "transparent",
                },
                min: 0,
                max: 100,
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) =>
                    `${context.label}: ${context.raw.toFixed(1)}`,
                },
              },
            },
          },
        });
        return trigramRadarChart;
      }
      function updateTrigramRadar(chart, newScores) {
        if (!chart) return;
        const dataPoints = Object.keys(newScores)
          .sort((a, b) => a - b)
          .map((key) => newScores[key]);
        chart.data.datasets[0].data = dataPoints;
        chart.update("none");
      }

      function getTrigramElement(trigramId) {
        return HAQEI_DATA.trigrams_master.find(
          (t) => t.trigram_id === trigramId
        );
      }

      function getRelationship(elem1, elem2) {
        if (!elem1 || !elem2) return "無関係";
        const rel = HAQEI_DATA.element_relationships.find(
          (r) =>
            r.source_element === elem1.element &&
            r.target_element === elem2.element
        );
        return rel ? rel.relationship_type : "無関係";
      }

      function hasXiangSheng(hexA, hexB) {
        if (!hexA || !hexB) return false;
        const aUpper = getTrigramElement(hexA.upper_trigram_id);
        const aLower = getTrigramElement(hexA.lower_trigram_id);
        const bUpper = getTrigramElement(hexB.upper_trigram_id);
        const bLower = getTrigramElement(hexB.lower_trigram_id);
        const pairs = [
          [aUpper, bUpper],
          [aUpper, bLower],
          [aLower, bUpper],
          [aLower, bLower],
        ];
        return pairs.some(
          (p) =>
            getRelationship(p[0], p[1]) === "相生" ||
            getRelationship(p[1], p[0]) === "相生"
        );
      }

      function hasXiangKe(hexA, hexB) {
        if (!hexA || !hexB) return false;
        const aUpper = getTrigramElement(hexA.upper_trigram_id);
        const aLower = getTrigramElement(hexA.lower_trigram_id);
        const bUpper = getTrigramElement(hexB.upper_trigram_id);
        const bLower = getTrigramElement(hexB.lower_trigram_id);
        const pairs = [
          [aUpper, bUpper],
          [aUpper, bLower],
          [aLower, bUpper],
          [aLower, bLower],
        ];
        return pairs.some(
          (p) =>
            getRelationship(p[0], p[1]) === "相剋" ||
            getRelationship(p[1], p[0]) === "相剋"
        );
      }

      function isZong(hexIdA, hexIdB) {
        const souId = HAQEI_DATA.H64_DATA.find(
          (k) => k.hexagram_id === hexIdA
        )?.sou_id;
        return souId === hexIdB;
      }

      function isCuo(hexIdA, hexIdB) {
        const sakuId = HAQEI_DATA.H64_DATA.find(
          (k) => k.hexagram_id === hexIdA
        )?.saku_id;
        return sakuId === hexIdB;
      }

      function calculateInfluenceScores(candidates, engineId) {
        const engineHex = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id === engineId
        );
        return candidates
          .filter((c) => c.hexagram_id !== engineId)
          .map((c) => {
            const rel = {
              xiangSheng: hasXiangSheng(engineHex, c),
              xiangKe: hasXiangKe(engineHex, c),
              zong: isZong(engineId, c.hexagram_id),
              cuo: isCuo(engineId, c.hexagram_id),
            };
            let score = 0;
            if (rel.xiangSheng) score += 30;
            if (rel.xiangKe) score -= 20;
            if (rel.zong) score += 15;
            if (rel.cuo) score -= 10;
            return { id: c.hexagram_id, score, rel };
          })
          .sort((a, b) => b.score - a.score);
      }

      function main() {
        try {
          Object.assign(osManualData, HAQEI_DATA.os_manual || {});
          showIntro();
        } catch (error) {
          console.error("初期化に失敗:", error);
          diagnosticContainer.innerHTML = `<div class="text-center text-red-400 p-8">ページの読み込みに失敗しました: ${error.message}</div>`;
        }
      }

      function showIntro() {
        diagnosticContainer.innerHTML = `<div class="text-center bg-gray-900/50 p-6 rounded-xl prose-custom max-w-none text-gray-300"><p class="text-lg">ようこそ。これから、あなただけの「OS設計図」を創るための、対話を始めます。</p><p class="mt-6">HaQeiアナライザーは、3つのステップで、あなたの魂の設計図を共同で構築します。</p><div class="grid md:grid-cols-3 gap-6 my-6 text-left"><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-amber-300 flex items-center"><span class="text-xl mr-2">1</span>価値観の明確化</h4><p class="text-xs mt-2">まず、いくつかの問いから、あなたの核となる8つの基本エネルギーのバランスを分析します。</p></div><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-indigo-300 flex items-center"><span class="text-xl mr-2">2</span>エンジンOSの選択</h4><p class="text-xs mt-2">次に、提示された候補の中から、あなたの感覚に最も近い<strong class="text-white">「エンジンOS」をあなた自身が選択</strong>します。</p></div><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-green-300 flex items-center"><span class="text-xl mr-2">3</span>行動パターンの特定</h4><p class="text-xs mt-2">あなたの選択を基に、残りのOSを特定し、<strong class="text-white">戦略レポート</strong>を生成します。</p></div></div><p>あなたの感覚こそが、最も信頼できる羅針盤です。どうぞ、リラックスして、対話を楽しんでください。</p></div><div class="mt-8 pt-8 border-t border-gray-700 text-center"><button id="startBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105">対話を開始する</button></div>`;
        document
          .getElementById("startBtn")
          .addEventListener("click", showWorldviewQuestions);
      }

      function showWorldviewQuestions() {
        let html = `<h3 class="text-xl font-bold text-amber-300 mb-6 text-center">Step 1：あなたの価値観について教えてください</h3>`;
        WORLDVIEW_QUESTIONS.forEach((q, index) => {
          const worldviewOpts = q.options
            .map(
              (opt) =>
                `<div><input type="radio" name="${q.id}" id="wvq_${q.id}_${opt.value}" value="${opt.value}" class="sr-only peer"><label for="wvq_${q.id}_${opt.value}" class="option-label">${opt.text}</label></div>`
            )
            .join("");
          html += `<div class="diagnostic-item"><div class="question-block"><p class="question-text">${
            index + 1
          }. ${
            q.text
          }</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">${worldviewOpts}</div></div></div>`;
        });
        html += `<div class="mt-8 text-center"><button id="analyzeEnergyBtn" class="w-full sm:w-auto bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300">価値観を分析する</button></div>`;
        diagnosticContainer.innerHTML = html;
        document
          .getElementById("analyzeEnergyBtn")
          .addEventListener("click", handleEnergyAnalysis);
      }

      function handleEnergyAnalysis() {
        if (
          !Array.from(document.querySelectorAll('input[name^="wvq"]')).every(
            (r) => document.querySelector(`input[name="${r.name}"]:checked`)
          )
        ) {
          alert("Step 1のすべての質問に回答してください。");
          return;
        }

        // 新しいベクトルロジックを使用
        analysisState.userProfileVector =
          buildUserProfileVector(WORLDVIEW_QUESTIONS);
        analysisState.trigramScores = runTrigramAnalysis();
        analysisState.adjustedTrigramScores = {
          ...analysisState.trigramScores,
        };
        showRadarVisualization();
      }

      function showRadarVisualization() {
        const html = `
              <h3 class="text-xl font-bold text-amber-300 mb-2 text-center">Step 1-B：価値観の分析結果</h3>
              <p class="text-center text-gray-400 mb-6 text-sm">レーダーチャートは、あなたの価値観のバランスを可視化したものです。<br>この分析結果を土台として、あなたのエンジンOS候補を生成します。</p>
              <div id="radar-chart-container" class="radar-container">
                  <canvas id="trigram-radar-chart"></canvas>
              </div>
              <section id="wv-confirm" class="mt-8 text-center">
                  <button id="confirm-scores-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300">この分析結果でOS候補を生成</button>
              </section>
          `;
        diagnosticContainer.innerHTML = html;

        const radarCtx = document
          .getElementById("trigram-radar-chart")
          .getContext("2d");
        trigramRadarChart = renderTrigramRadar(
          radarCtx,
          analysisState.adjustedTrigramScores
        );

        document
          .getElementById("confirm-scores-btn")
          .addEventListener("click", () => {
            analysisState.engineCandidates = getEngineCandidates(
              analysisState.userProfileVector
            );
            showEngineCandidateSelection();
          });
      }

      function showEngineCandidateSelection() {
        let html = `
          <div class="text-center">
            <h3 class="text-xl font-bold text-indigo-300 mb-4">Step 2：あなたのエンジンOSを選択してください</h3>
            <div class="bg-gray-900/50 p-6 rounded-xl prose-custom max-w-none text-gray-300">
              <p>あなたの価値観の分析に基づき、エンジンOSの候補が4つ生成されました。以下のカードを読み、最も「これだ！」と感じるものを<strong>1つだけ</strong>選んでください。</p>
              <p class="text-xs text-gray-400 mt-2">💡 カード下部の説明は、AIがそのOSを候補として選んだ理由です。</p>
            </div>
            <div id="engine-candidate-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">`;

        analysisState.engineCandidates.forEach((os) => {
          const osManual = osManualData[String(os.hexagram_id)] || {};
          const keyword = osManual.keyword_short || "???";
          const icon = osManual.archetype_icon || "❓";

          html += `
            <div id="card-select-${os.hexagram_id}" data-id="${
            os.hexagram_id
          }" class="engine-card" role="button" tabindex="0" aria-pressed="false">
              <div class="card-content">
                <header class="engine-card-header">
                  <span role="img" aria-label="${keyword}" class="archetype-icon">${icon}</span>
                  <div>
                    <h4 class="archetype-name">${os.name_jp}</h4>
                    <span class="text-xs text-indigo-400 font-semibold">${keyword}</span>
                  </div>
                </header>
                <p class="text-sm text-gray-300 mt-3 flex-grow">${
                  osManual.summary || "解説準備中..."
                }</p>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <p class="text-xs font-semibold text-gray-400 mb-2">AIによる選定根拠</p>
                  <p class="text-sm text-gray-500" data-reason>${
                    os.reason || ""
                  }</p>
                </div>
                <div class="engine-card-tip" data-tip-for="${
                  os.hexagram_id
                }"></div>
              </div>
            </div>`;
        });
        html += `</div><div class="mt-8 text-center"><button id="lock-in-btn" class="w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>このOSで最終決定する</button></div></div>`;
        diagnosticContainer.innerHTML = html;

        document.querySelectorAll(".engine-card").forEach((card) => {
          card.addEventListener("click", handleCandidateSelection);
          card.addEventListener("keydown", (e) => {
            if (e.key === "Enter" || e.key === " ") {
              e.preventDefault();
              handleCandidateSelection({ currentTarget: card });
            }
          });
        });
        document
          .getElementById("lock-in-btn")
          .addEventListener("click", handleEngineLockIn);
      }

      function handleCandidateSelection(event) {
        const selectedCard = event.currentTarget;
        const selectedId = parseInt(selectedCard.dataset.id, 10);

        document.querySelectorAll(".engine-card").forEach((card) => {
          card.classList.remove("selected");
          card.setAttribute("aria-pressed", "false");
        });

        selectedCard.classList.add("selected");
        selectedCard.setAttribute("aria-pressed", "true");

        analysisState.selectedEngine = selectedId;

        document.getElementById("lock-in-btn").disabled = false;
      }

      function handleEngineLockIn() {
        const os = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id === analysisState.selectedEngine
        );
        if (os) {
          analysisState.lockedEngineOs = os;
          analysisState.influentialOses = calculateInfluenceScores(
            analysisState.engineCandidates,
            analysisState.selectedEngine
          );
          showScenarioQuestions();
        }
      }

      function runTrigramAnalysis() {
        const scores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0 };
        WORLDVIEW_QUESTIONS.forEach((q) => {
          const node = document.querySelector(`input[name="${q.id}"]:checked`);
          if (!node) return;
          const choice = q.options.find((opt) => opt.value === node.value);
          if (choice && choice.scoring_tags) {
            // 新しいscoring_tags形式に対応
            choice.scoring_tags.forEach((tag) => {
              // 八卦の名前からIDを取得する簡易的なマッピング
              const trigramMapping = {
                乾: 1,
                兌: 2,
                離: 3,
                震: 4,
                巽: 5,
                坎: 6,
                艮: 7,
                坤: 8,
              };
              if (trigramMapping[tag.key]) {
                scores[trigramMapping[tag.key]] =
                  (scores[trigramMapping[tag.key]] || 0) + tag.value;
              }
            });
          } else if (choice && choice.scores) {
            // 旧形式のscoresもサポート
            for (const id in choice.scores) {
              if (Object.hasOwnProperty.call(choice.scores, id)) {
                scores[id] = (scores[id] || 0) + choice.scores[id];
              }
            }
          }
        });

        const maxScore = Math.max(...Object.values(scores), 1);
        const normalizedScores = {};
        for (const id in scores) {
          const normalized = (scores[id] / maxScore) * 100;
          normalizedScores[id] = Math.max(0, Math.min(100, normalized));
        }
        return normalizedScores;
      }

      function determineInterfaceAndSafemode() {
        const scenarioTrigramScores = {
          1: 0,
          2: 0,
          3: 0,
          4: 0,
          5: 0,
          6: 0,
          7: 0,
          8: 0,
        };
        SCENARIO_QUESTIONS.forEach((q) => {
          const innerNode = document.querySelector(
            `input[name="${q.id}_inner"]:checked`
          );
          const outerNode = document.querySelector(
            `input[name="${q.id}_outer"]:checked`
          );

          const innerChoice = q.options.inner[Number(innerNode.value)];
          if (innerChoice && innerChoice.scoring_tags) {
            // 新しいscoring_tags形式に対応
            innerChoice.scoring_tags.forEach((tag) => {
              const trigramMapping = {
                乾: 1,
                兌: 2,
                離: 3,
                震: 4,
                巽: 5,
                坎: 6,
                艮: 7,
                坤: 8,
              };
              if (trigramMapping[tag.key]) {
                scenarioTrigramScores[trigramMapping[tag.key]] =
                  (scenarioTrigramScores[trigramMapping[tag.key]] || 0) +
                  tag.value;
              }
            });
          } else if (innerChoice && innerChoice.scores) {
            // 旧形式のscoresもサポート
            for (const id in innerChoice.scores) {
              if (Object.hasOwnProperty.call(innerChoice.scores, id)) {
                scenarioTrigramScores[id] =
                  (scenarioTrigramScores[id] || 0) + innerChoice.scores[id];
              }
            }
          }

          const outerChoice = q.options.outer[Number(outerNode.value)];
          if (outerChoice && outerChoice.scoring_tags) {
            // 新しいscoring_tags形式に対応
            outerChoice.scoring_tags.forEach((tag) => {
              const trigramMapping = {
                乾: 1,
                兌: 2,
                離: 3,
                震: 4,
                巽: 5,
                坎: 6,
                艮: 7,
                坤: 8,
              };
              if (trigramMapping[tag.key]) {
                scenarioTrigramScores[trigramMapping[tag.key]] =
                  (scenarioTrigramScores[trigramMapping[tag.key]] || 0) +
                  tag.value;
              }
            });
          } else if (outerChoice && outerChoice.scores) {
            // 旧形式のscoresもサポート
            for (const id in outerChoice.scores) {
              if (Object.hasOwnProperty.call(outerChoice.scores, id)) {
                scenarioTrigramScores[id] =
                  (scenarioTrigramScores[id] || 0) + outerChoice.scores[id];
              }
            }
          }
        });

        const baseScores = {};
        HAQEI_DATA.hexagrams_master.forEach((hex) => {
          if (hex.hexagram_id === analysisState.lockedEngineOs.hexagram_id)
            return;
          const scenarioScore =
            (scenarioTrigramScores[hex.upper_trigram_id] || 0) +
            (scenarioTrigramScores[hex.lower_trigram_id] || 0);
          let worldviewCompatibilityScore = 0;
          if (analysisState.adjustedTrigramScores[hex.upper_trigram_id])
            worldviewCompatibilityScore +=
              analysisState.adjustedTrigramScores[hex.upper_trigram_id];
          if (analysisState.adjustedTrigramScores[hex.lower_trigram_id])
            worldviewCompatibilityScore +=
              analysisState.adjustedTrigramScores[hex.lower_trigram_id];
          baseScores[hex.hexagram_id] =
            scenarioScore * 0.7 + (worldviewCompatibilityScore / 2) * 0.3;
        });

        const sortedOs = Object.entries(baseScores).sort(
          ([, a], [, b]) => b - a
        );
        const interfaceOs = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id == sortedOs[0][0]
        );
        const safemodeOs = HAQEI_DATA.hexagrams_master.find(
          (h) => h.hexagram_id == sortedOs[1][0]
        );

        return { interfaceOs, safemodeOs };
      }

      function handleFinalAnalysis() {
        if (!document.getElementById("agreementCheckbox").checked) {
          alert("利用規約とプライバシーポリシーに同意してください。");
          return;
        }
        if (
          !Array.from(SCENARIO_QUESTIONS).every(
            (q) =>
              document.querySelector(`input[name="${q.id}_inner"]:checked`) &&
              document.querySelector(`input[name="${q.id}_outer"]:checked`)
          )
        ) {
          alert("Step 3のすべてのシナリオに回答してください。");
          return;
        }
        const { interfaceOs, safemodeOs } = determineInterfaceAndSafemode();

        const analysisResult = {
          hexagram_candidates: [
            analysisState.lockedEngineOs,
            interfaceOs,
            safemodeOs,
          ],
          trigram_profile: Object.entries(
            analysisState.adjustedTrigramScores
          ).map(([id, score]) => ({
            id: parseInt(id),
            name_jp: HAQEI_DATA.trigrams_master.find((t) => t.trigram_id == id)
              .name_jp,
            score: score,
          })),
        };

        const dataToStore = {
          analysisResult: analysisResult,
          userContext: {},
          userProfile: {},
        };

        try {
          localStorage.setItem(
            "haqeiOsAnalyzerData",
            JSON.stringify(dataToStore)
          );
          displayReport(analysisResult);
        } catch (e) {
          console.error("OS分析データの保存に失敗しました:", e);
          alert("データの保存に失敗しました。ブラウザの設定をご確認ください。");
        }
      }

      function displayReport(analysisResult) {
        const oses = analysisResult.hexagram_candidates;
        let reportHtml = `<div class="text-center space-y-12">
                            <div class="report-section">
                              <h3 class="text-3xl font-bold text-indigo-300">あなたの3つの人格OS</h3>
                              <p class="mt-4 max-w-2xl mx-auto text-gray-400">分析が完了しました。以下が、あなたの思考と行動の核となる3つのOSです。各OSの特性を理解し、今後の戦略立案にお役立てください。</p>
                              <div id="os-cards-container" class="mt-8 space-y-6 text-left"></div>
                            </div>
                            <div class="mt-16 pt-8 border-t-2 border-dashed border-gray-700">
                                <h3 class="text-xl font-bold text-amber-300 mb-4">次のステップへ</h3>
                                <div class="mt-8">
                                    <a href="cockpit.html" class="bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105">戦略コックピットで全体像を把握する &rarr;</a>
                                </div>
                            </div>
                          </div>`;
        diagnosticContainer.innerHTML = reportHtml;

        const osCardsContainer = document.getElementById("os-cards-container");
        const template = document.getElementById("os-card-template");
        const osTypes = ["エンジンOS", "インターフェースOS", "セーフモードOS"];
        const osIcons = ["🔥", "🎭", "🛡️"];
        const colors = ["#F87171", "#60A5FA", "#9CA3AF"];

        oses.forEach((os, index) => {
          if (!os) return;
          const role = osTypes[index];
          const clone = template.content.cloneNode(true);
          const card = clone.querySelector("div");
          const manual = osManualData[String(os.hexagram_id)] || {};

          card.style.borderColor = colors[index];
          card.querySelector("[data-role-icon]").textContent = osIcons[index];
          card.querySelector("[data-role-label]").textContent = role;
          card.querySelector("[data-os-name]").textContent = os.name_jp;
          card.querySelector("[data-os-catchphrase]").textContent =
            os.catchphrase;
          card.querySelector("[data-yin-mode]").textContent =
            manual.defensive_use || "解説準備中";
          card.querySelector("[data-yang-mode]").textContent =
            manual.proactive_use || "解説準備中";
          card.querySelector("[data-strategic-summary]").textContent =
            manual.summary || "解説準備中";

          osCardsContainer.appendChild(clone);
        });
      }

      function showScenarioQuestions() {
        let html = `<h3 class="text-xl font-bold text-indigo-300 mb-6 text-center">Step 3：あなたの行動パターンについて教えてください</h3>`;
        html += `<p class="text-center text-sm text-gray-400 mb-6">エンジンOS【${analysisState.lockedEngineOs.name_jp}】がロックインされました。次に、社会的な場面やストレス下でのあなたの振る舞いを分析し、残りのOSを特定します。</p>`;
        SCENARIO_QUESTIONS.forEach((q, index) => {
          const innerOpts = q.options.inner
            .map(
              (opt, i) =>
                `<div><input type="radio" name="${q.id}_inner" value="${i}" id="scq_${q.id}_inner_${i}" class="sr-only peer"><label for="scq_${q.id}_inner_${i}" class="option-label">${opt.text}</label></div>`
            )
            .join("");
          const outerOpts = q.options.outer
            .map(
              (opt, i) =>
                `<div><input type="radio" name="${q.id}_outer" value="${i}" id="scq_${q.id}_outer_${i}" class="sr-only peer"><label for="scq_${q.id}_outer_${i}" class="option-label">${opt.text}</label></div>`
            )
            .join("");
          html += `<div class="diagnostic-item"><p class="text-gray-400 text-sm">シナリオ ${
            index + 1
          }/${
            SCENARIO_QUESTIONS.length
          }</p><p class="font-semibold text-gray-200 mb-4">${
            q.scenario
          }</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="question-block"><p class="question-text">${
            q.inner_q
          }</p><div class="space-y-3 mt-4">${innerOpts}</div></div><div class="question-block"><p class="question-text">${
            q.outer_q
          }</p><div class="space-y-3 mt-4">${outerOpts}</div></div></div></div>`;
        });
        html += `<div class="mt-8 pt-8 border-t border-gray-700">
                  <div class="text-center">
                      <label class="flex items-center justify-center cursor-pointer">
                      <input type="checkbox" id="agreementCheckbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                      <span class="ml-2 text-sm text-gray-400">
                          <a href="/terms.html" target="_blank" class="underline hover:text-white">利用規約</a>および<a href="/privacy.html" target="_blank" class="underline hover:text-white">プライバシーポリシー</a>に同意します
                      </span>
                      </label>
                  </div>
                  <button id="finalAnalyzeBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105 mt-6 disabled:opacity-50 disabled:cursor-not-allowed" disabled>最終レポートを生成する</button>
                  </div>`;
        diagnosticContainer.innerHTML = html;
        const finalAnalyzeBtn = document.getElementById("finalAnalyzeBtn");
        const finalAgreementCheckbox =
          document.getElementById("agreementCheckbox");
        finalAnalyzeBtn.disabled = true;
        finalAgreementCheckbox.addEventListener("change", () => {
          finalAnalyzeBtn.disabled = !finalAgreementCheckbox.checked;
        });
        finalAnalyzeBtn.addEventListener("click", handleFinalAnalysis);
      }

      document.addEventListener("DOMContentLoaded", main);
    </script>
  </body>
</html>
