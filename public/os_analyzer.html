<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei ベーシックOS分析 V7.0</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>易</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .prose-custom {
        color: #d1d5db;
        line-height: 1.8;
      }
      .prose-custom p {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      .prose-custom strong {
        color: #facc15;
      }
      .diagnostic-item {
        background-color: rgba(31, 41, 55, 0.7);
        border: 1px solid #374151;
        border-radius: 1rem;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
        margin-bottom: 2rem;
      }
      .worldview-item {
        background-color: rgba(79, 70, 229, 0.1);
        border: 1px solid #4f46e5;
      }
      .question-text {
        font-weight: 500;
        color: #a5b4fc;
        margin-bottom: 0.75rem;
      }
      .option-label {
        display: flex;
        align-items: center;
        text-align: left;
        padding: 0.75rem 1rem;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 100%;
        background-color: #374151;
        font-size: 0.875rem;
        line-height: 1.5;
      }
      .option-label:hover {
        background-color: #4b5563;
        border-color: #6366f1;
      }
      input[type="radio"]:checked + .option-label {
        background-color: #4f46e5;
        border-color: #a5b4fc;
        color: #e0e7ff;
        font-weight: 600;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(129, 140, 248, 0.2);
      }
      .report-section h3,
      .report-section h4 {
        font-family: "Shippori Mincho", serif;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6">
    <div
      class="w-full max-w-4xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-10"
    >
      <header class="text-center mb-10">
        <a
          href="./"
          class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block text-sm"
          >← トップページへ戻る</a
        >
        <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
          ベーシックOS分析
        </h1>
        <p class="text-gray-400 mt-2">
          あなたという存在の核となる、3つの人格OSを特定します。
        </p>
      </header>

      <div id="input-container"></div>

      <div id="control-container" class="mt-8 pt-8 border-t border-gray-700">
        <div class="text-center">
          <label class="flex items-center justify-center cursor-pointer">
            <input
              type="checkbox"
              id="agreementCheckbox"
              class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500"
            />
            <span class="ml-2 text-sm text-gray-400">
              <a
                href="/terms.html"
                target="_blank"
                class="underline hover:text-white"
                >利用規約</a
              >および<a
                href="/privacy.html"
                target="_blank"
                class="underline hover:text-white"
                >プライバシーポリシー</a
              >に同意します
            </span>
          </label>
        </div>
        <button
          id="analyzeBtn"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105 mt-6 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          人格OSを特定する
        </button>
      </div>

      <div id="report-container" class="hidden"></div>
    </div>

    <script type="module">
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const response = await fetch("/api/data");
          if (!response.ok)
            throw new Error("データベースの読み込みに失敗しました。");
          const { HAQEI_DATA } = await response.json();
          const HDB = HAQEI_DATA;

          if (!HDB.TRIGRAM_INTERACTIONS) {
            throw new Error(
              "TRIGRAM_INTERACTIONSデータベースがHAQEI_DATA内に見つかりません。"
            );
          }
          const TRIGRAM_INTERACTIONS = HDB.TRIGRAM_INTERACTIONS;

          const analyzeBtn = document.getElementById("analyzeBtn");
          const agreementCheckbox =
            document.getElementById("agreementCheckbox");
          const inputContainer = document.getElementById("input-container");
          const controlContainer = document.getElementById("control-container");
          const reportContainer = document.getElementById("report-container");

          const WORLDVIEW_QUESTIONS = [
            {
              id: "wvq1",
              text: "あなたがリーダーとして最も大切にするのは、どちらの力ですか？",
              options: [
                {
                  text: "明確なビジョンと圧倒的な実行力で、チームを力強く牽引する力。",
                  scores: { 1: 2 },
                },
                {
                  text: "メンバー一人ひとりの声に耳を傾け、その可能性を育む、大地のような受容力。",
                  scores: { 8: 2 },
                },
              ],
            },
            {
              id: "wvq2",
              text: "あなたが困難な問題に直面した時、より信頼を置くのはどちらの戦略ですか？",
              options: [
                {
                  text: "知性と分析力を駆使して、問題の構造を明らかにし、論理的な解決策を導き出す。",
                  scores: { 3: 2 },
                },
                {
                  text: "焦らず、困難の渦中で粘り強く耐えながら、物事の本質や真理を探究し続ける。",
                  scores: { 6: 2 },
                },
              ],
            },
            {
              id: "wvq3",
              text: "あなたのチームが停滞し、活力を失っている時、あなたが最初にとる行動はどちらですか？",
              options: [
                {
                  text: "雷鳴のように衝撃的な目標を掲げ、行動を起こすことで、チームに活気を取り戻す。",
                  scores: { 4: 2 },
                },
                {
                  text: "山のように動かず、まず状況を冷静に観察し、停滞の根本原因をじっくりと内省する。",
                  scores: { 7: 2 },
                },
              ],
            },
            {
              id: "wvq4",
              text: "あなたが他者と良好な関係を築く上で、より効果的だと感じるのはどちらですか？",
              options: [
                {
                  text: "相手の心に寄り添い、丁寧な対話を重ねることで、徐々に信頼を浸透させていく。",
                  scores: { 5: 2 },
                },
                {
                  text: "ユーモアを交え、喜びや楽しみをオープンに分かち合うことで、一気に心の距離を縮める。",
                  scores: { 2: 2 },
                },
              ],
            },
            {
              id: "wvq5",
              text: "あなたが社会をより良くするために貢献するなら、どちらのアプローチを選びますか？",
              options: [
                {
                  text: "古い常識やシステムを刷新する「革命」によって、全く新しい社会を創り出す。",
                  scores: { 49: 1 },
                },
                {
                  text: "人々が安心して暮らせる「安定した器」の中で、豊かな文化をじっくりと育む。",
                  scores: { 50: 1 },
                },
              ],
            },
          ];
          const DIAGNOSTIC_QUESTIONS = [
            {
              id: "q1",
              scenario:
                "友人たちとの楽しい旅行計画が、予期せぬトラブルで完全に白紙に戻ってしまいました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「残念すぎる…」という喪失感や悲しみに沈む",
                    scores: { 2: -2, 6: 2, 7: 1 },
                  },
                  {
                    text: "「なぜこうなった？」と原因を分析し、状況を知的に理解しようとする",
                    scores: { 3: 2, 7: 1, 8: -1 },
                  },
                  {
                    text: "「まあ仕方ない、次どうするか考えよう」と、すぐに気持ちを切り替える",
                    scores: { 4: 2, 1: 1, 6: -1 },
                  },
                ],
                outer: [
                  {
                    text: "「私が新しい計画を立てる！」と率先してリーダーシップを発揮する",
                    scores: { 1: 3, 4: 1, 8: -2 },
                  },
                  {
                    text: "「皆がっかりしてるだろう」と、まずメンバーのケアや慰めを優先する",
                    scores: { 8: 2, 5: 2, 1: -1 },
                  },
                  {
                    text: "一旦「どうするかは、また後で考えよう」と、状況を静観する",
                    scores: { 7: 3, 6: 1, 4: -2 },
                  },
                ],
              },
            },
            {
              id: "q2",
              scenario:
                "あなたは全く新しい分野のスキルを、ゼロから学ぶことになりました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる学び方」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「面白そう！」という好奇心と、新しい自分になれることへの期待感",
                    scores: { 4: 2, 3: 2, 7: -1 },
                  },
                  {
                    text: "「本当に自分にできるだろうか…」という不安と、失敗への恐れ",
                    scores: { 6: 2, 7: 1, 1: -2 },
                  },
                  {
                    text: "「どうせやるなら完璧に」という、知的な探求心と向上心",
                    scores: { 1: 2, 6: 1, 2: -1 },
                  },
                ],
                outer: [
                  {
                    text: "まず全体像を把握するため、関連書籍を何冊も読んで体系的に学ぶ",
                    scores: { 7: 2, 3: 1, 4: -1 },
                  },
                  {
                    text: "とにかく実践！専門家や経験者に積極的に質問し、試行錯誤しながら学ぶ",
                    scores: { 4: 3, 2: 1, 7: -2 },
                  },
                  {
                    text: "同じ目標を持つ仲間を見つけ、勉強会を開くなど、協調しながら学ぶ",
                    scores: { 5: 2, 8: 2, 1: -1 },
                  },
                ],
              },
            },
            {
              id: "q3",
              scenario:
                "あなたの意見が、会議で他のメンバーから真っ向から反対されました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「なぜ理解できないんだ！」という怒りや、自分の正しさへの確信",
                    scores: { 1: 2, 3: 1, 8: -2 },
                  },
                  {
                    text: "「私の説明が悪かったのかも…」という自己反省と、関係悪化への不安",
                    scores: { 8: 2, 5: 1, 1: -1 },
                  },
                  {
                    text: "「なるほど、そういう視点もあるのか」という知的な興味",
                    scores: { 6: 2, 7: 1, 4: -1 },
                  },
                ],
                outer: [
                  {
                    text: "感情的にならず、データや論理を用いて、冷静に相手を説得しようと試みる",
                    scores: { 3: 2, 1: 1, 2: -1 },
                  },
                  {
                    text: "一旦相手の意見を受け入れ、共通の落としどころを探る対話的なアプローチをとる",
                    scores: { 5: 3, 8: 1, 1: -1 },
                  },
                  {
                    text: "議論を中断し、時間を置いて、別の角度から再度アプローチする",
                    scores: { 7: 2, 6: 1, 4: -1 },
                  },
                ],
              },
            },
            {
              id: "q4",
              scenario:
                "あなたはプロジェクトで大きな成功を収め、周囲から絶賛されています。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「最高に気持ちいい！」という達成感と、さらなる成功への意欲",
                    scores: { 3: 2, 4: 2, 8: -1 },
                  },
                  {
                    text: "「皆のおかげだ」という、周囲への感謝と謙虚な気持ち",
                    scores: { 8: 2, 2: 1, 1: -2 },
                  },
                  {
                    text: "「なぜ成功したのか」を冷静に分析し、次への再現性を考える",
                    scores: { 7: 2, 1: 1, 3: -1 },
                  },
                ],
                outer: [
                  {
                    text: "成功を祝う盛大なパーティーを開き、喜びを仲間と分かち合う",
                    scores: { 2: 3, 3: 1, 7: -1 },
                  },
                  {
                    text: "すぐに次の目標を設定し、休みなく次の挑戦へと向かう",
                    scores: { 1: 2, 4: 1, 8: -1 },
                  },
                  {
                    text: "成功体験をマニュアル化し、後進の育成や組織の発展に貢献する",
                    scores: { 5: 2, 8: 1, 4: -1 },
                  },
                ],
              },
            },
            {
              id: "q5",
              scenario:
                "あなたと親友が、些細なことから気まずい雰囲気になってしまいました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「自分が何か悪いことをしたかも…」と、自分を責め、不安になる",
                    scores: { 8: 2, 6: 1 },
                  },
                  {
                    text: "「面倒なことになったな…」と、問題から目をそらし、距離を置きたくなる",
                    scores: { 7: 2, 5: -1 },
                  },
                  {
                    text: "「早く仲直りしたい」と、解決を焦る気持ちが強くなる",
                    scores: { 4: 2, 2: 1 },
                  },
                ],
                outer: [
                  {
                    text: "自分から「あの時はごめん」と率直に謝り、関係修復を図る",
                    scores: { 2: 2, 4: 1 },
                  },
                  {
                    text: "しばらく時間を置き、相手からの連絡を待つ",
                    scores: { 7: 2, 8: 1 },
                  },
                  {
                    text: "共通の友人に相談し、間を取り持ってもらおうとする",
                    scores: { 5: 3, 2: -1 },
                  },
                ],
              },
            },
            {
              id: "q6",
              scenario:
                "あなたは、丸一日、誰にも邪魔されない完全な自由時間が与えられました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際に過ごす時間」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「何をしようか？」とワクワクし、やりたいことが次々と思い浮かぶ",
                    scores: { 3: 2, 4: 2 },
                  },
                  {
                    text: "「やっと休める…」と、心身の休息を最優先にしたいと感じる",
                    scores: { 8: 2, 7: 1 },
                  },
                  {
                    text: "「どうせなら有意義に」と、普段できない自己投資や勉強を計画する",
                    scores: { 1: 2, 6: 2 },
                  },
                ],
                outer: [
                  {
                    text: "結局、家でゴロゴロしたり、特に何もせずに過ごしてしまう",
                    scores: { 8: 2, 7: -1 },
                  },
                  {
                    text: "溜まっていた趣味や創作活動に、時間を忘れて没頭する",
                    scores: { 6: 2, 3: 1 },
                  },
                  {
                    text: "友人を誘って食事に行ったり、イベントに出かけたりして、積極的に人と交流する",
                    scores: { 2: 3, 5: 1 },
                  },
                ],
              },
            },
            {
              id: "q7",
              scenario:
                "これまで順調だった物事が、急に停滞し、先の見えない状況になりました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「やり方が悪かったのか？」と、過去の行動を分析し、問題点を探す",
                    scores: { 7: 2, 6: 1 },
                  },
                  {
                    text: "「これも一つの流れだ」と、状況をあるがままに受け入れ、静観する",
                    scores: { 8: 2, 5: 1 },
                  },
                  {
                    text: "「このままではダメだ！」と、強い危機感と、変化への渇望を感じる",
                    scores: { 4: 2, 1: 1 },
                  },
                ],
                outer: [
                  {
                    text: "根本的な原因が分かるまで、全ての行動を一旦ストップする",
                    scores: { 7: 3, 6: -1 },
                  },
                  {
                    text: "停滞を打破するため、全く新しいアプローチや、奇抜なアイデアを試す",
                    scores: { 4: 2, 3: 1 },
                  },
                  {
                    text: "周囲の意見を広く聞き、協力体制を再構築しようと試みる",
                    scores: { 5: 2, 8: 1 },
                  },
                ],
              },
            },
            {
              id: "q8",
              scenario:
                "あなたは、全く興味のなかった分野に、偶然触れる機会がありました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「意外と面白いかも」と、新しい世界への好奇心が刺激される",
                    scores: { 2: 2, 5: 1 },
                  },
                  {
                    text: "「自分の専門とは違う」と、知的な壁を作り、深く関わることを避ける",
                    scores: { 7: 2, 1: -1 },
                  },
                  {
                    text: "「なぜ今まで知らなかったんだろう」と、その分野の歴史や背景を知りたくなる",
                    scores: { 6: 2, 8: 1 },
                  },
                ],
                outer: [
                  {
                    text: "その場でSNSでシェアしたり、誰かにその面白さを話したりする",
                    scores: { 2: 2, 3: 1 },
                  },
                  {
                    text: "その分野の入門書を数冊購入し、自分の知識体系に組み込もうとする",
                    scores: { 6: 2, 1: 1 },
                  },
                  {
                    text: "一度きりの体験として楽しみ、それ以上深入りはしない",
                    scores: { 5: -1, 7: 1 },
                  },
                ],
              },
            },
          ];

          function renderQuestions() {
            let html = `<div class="text-center bg-gray-900/50 p-6 rounded-xl prose-custom max-w-none text-gray-300"><p class="text-lg">ようこそ。これから、あなただけの「OS設計図」を創るための、短い対話を始めます。</p><p class="mt-6">対話は、2つのステップで進みます。</p><div class="grid md:grid-cols-2 gap-6 my-6 text-left"><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-amber-300 flex items-center"><span class="text-xl mr-2">⚙️</span>Step 1：思考のOS（基本設計）を明らかにする</h4><p class="text-xs mt-2">5つの哲学的な問いに対し、あなたの思考OSが、どちらの設計思想に強く共鳴するかを伺います。これにより、あなたの行動や判断の根底にある、思考の「初期設定」が明らかになり、あなたの最も核となる**エンジンOS**が確定します。</p></div><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-indigo-300 flex items-center"><span class="text-xl mr-2">🧭</span>Step 2：行動パターンを特定する</h4><p class="text-xs mt-2">8つの具体的な物語（シナリオ）に対し、あなたが「どう考え、どう行動するか」を伺います。これにより、あなたの社会的な振る舞いや、ストレス下での反応が明らかになり、**インターフェースOS**と**セーフモードOS**が特定されます。</p></div></div><p>どちらのステップにも、正解や不正解はありません。<br />どうぞ、リラックスして、あなたの直感を信じてお答えください。</p></div>`;
            html += `<h3 class="text-xl font-bold text-amber-300 mb-2 mt-8 border-t border-gray-700 pt-8">Step 1：思考のOS（基本設計）を明らかにする</h3>`;
            WORLDVIEW_QUESTIONS.forEach((q, index) => {
              const worldviewOpts = q.options
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}" value="${i}" id="${q.id}_${i}" class="hidden"><label for="${q.id}_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              html += `<div class="diagnostic-item worldview-item"><div class="question-block"><p class="question-text">${
                index + 1
              }. ${
                q.text
              }</p><div class="space-y-3">${worldviewOpts}</div></div></div>`;
            });
            html += `<h3 class="text-xl font-bold text-indigo-300 mb-2 mt-8 border-t border-gray-700 pt-8">Step 2：行動パターンを特定する</h3>`;
            DIAGNOSTIC_QUESTIONS.forEach((q, index) => {
              const innerOpts = q.options.inner
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}_inner" value="${i}" id="${q.id}_inner_${i}" class="hidden"><label for="${q.id}_inner_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              const outerOpts = q.options.outer
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}_outer" value="${i}" id="${q.id}_outer_${i}" class="hidden"><label for="${q.id}_outer_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              html += `<div class="diagnostic-item"><p class="text-gray-400 text-sm">シナリオ ${
                index + 1
              }/${
                DIAGNOSTIC_QUESTIONS.length
              }</p><p class="font-semibold text-gray-200 mb-4">${
                q.scenario
              }</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="question-block"><p class="question-text">${
                q.inner_q
              }</p><div class="space-y-3">${innerOpts}</div></div><div class="question-block"><p class="question-text">${
                q.outer_q
              }</p><div class="space-y-3">${outerOpts}</div></div></div></div>`;
            });
            inputContainer.innerHTML = html;
          }

          function runOsAnalysis() {
            const rootScores = {
              1: 0,
              2: 0,
              3: 0,
              4: 0,
              5: 0,
              6: 0,
              7: 0,
              8: 0,
            };
            const rootHexScores = {};
            let allWorldviewAnswered = true;
            WORLDVIEW_QUESTIONS.forEach((q) => {
              const node = document.querySelector(
                `input[name="${q.id}"]:checked`
              );
              if (!node) {
                allWorldviewAnswered = false;
                return;
              }
              const choice = q.options[node.value];
              for (const id in choice.scores) {
                if (parseInt(id) <= 8) {
                  rootScores[id] = (rootScores[id] || 0) + choice.scores[id];
                } else {
                  rootHexScores[id] =
                    (rootHexScores[id] || 0) + choice.scores[id];
                }
              }
            });

            if (!allWorldviewAnswered) {
              alert("Step 1の質問にすべて回答してください。");
              return null;
            }

            const sortedRootScores = Object.entries(rootScores).sort(
              (a, b) => b[1] - a[1]
            );
            const rootTrigram1 = parseInt(sortedRootScores[0][0]);
            const rootTrigram2 = parseInt(sortedRootScores[1][0]);

            let engineOsCandidate = HDB.hexagrams_master
              .map((hex) => {
                let score = rootHexScores[hex.hexagram_id] || 0;
                if (
                  hex.upper_trigram_id === rootTrigram1 &&
                  hex.lower_trigram_id === rootTrigram2
                )
                  score += 10;
                if (
                  hex.upper_trigram_id === rootTrigram2 &&
                  hex.lower_trigram_id === rootTrigram1
                )
                  score += 10;
                if (
                  hex.upper_trigram_id === rootTrigram1 ||
                  hex.lower_trigram_id === rootTrigram1
                )
                  score += 5;
                if (
                  hex.upper_trigram_id === rootTrigram2 ||
                  hex.lower_trigram_id === rootTrigram2
                )
                  score += 3;
                return { ...hex, score };
              })
              .sort((a, b) => b.score - a.score);
            const engineOs = engineOsCandidate[0];

            const scenarioScores = {};
            HDB.hexagrams_master.forEach(
              (h) => (scenarioScores[h.hexagram_id] = 0)
            );
            let allScenarioAnswered = true;
            DIAGNOSTIC_QUESTIONS.forEach((q) => {
              const innerNode = document.querySelector(
                `input[name="${q.id}_inner"]:checked`
              );
              const outerNode = document.querySelector(
                `input[name="${q.id}_outer"]:checked`
              );
              if (!innerNode || !outerNode) {
                allScenarioAnswered = false;
                return;
              }
              const innerChoice = q.options.inner[innerNode.value];
              const outerChoice = q.options.outer[outerNode.value];
              HDB.hexagrams_master.forEach((hex) => {
                if (innerChoice.scores[hex.lower_trigram_id])
                  scenarioScores[hex.hexagram_id] +=
                    innerChoice.scores[hex.lower_trigram_id];
                if (outerChoice.scores[hex.upper_trigram_id])
                  scenarioScores[hex.hexagram_id] +=
                    outerChoice.scores[hex.upper_trigram_id];
              });
            });

            if (!allScenarioAnswered) {
              alert("Step 2の質問にすべて回答してください。");
              return null;
            }

            const sortedScenarioOs = HDB.hexagrams_master
              .map((hex) => ({
                ...hex,
                score: scenarioScores[hex.hexagram_id] || 0,
              }))
              .sort((a, b) => b.score - a.score);

            const candidates = sortedScenarioOs.filter(
              (os) => os.hexagram_id !== engineOs.hexagram_id
            );

            const interfaceOs = candidates.length > 0 ? candidates[0] : null;
            const safemodeOs = candidates.length > 1 ? candidates[1] : null;

            if (!engineOs || !interfaceOs || !safemodeOs) {
              console.error("OSの特定に失敗しました", {
                engineOs,
                interfaceOs,
                safemodeOs,
              });
              alert(
                "エラー: OSの組み合わせを特定できませんでした。選択肢を変えて再度お試しください。"
              );
              return null;
            }

            return { engineOs, interfaceOs, safemodeOs };
          }

          function generateTriadName(engineOs, interfaceOs, safemodeOs) {
            const engineKeyword =
              engineOs.catchphrase.split("、")[0] || engineOs.name_jp;
            const interfaceKeyword =
              interfaceOs.catchphrase.split("、")[0] || interfaceOs.name_jp;
            const safemodeKeyword =
              safemodeOs.catchphrase.split("、")[0] || safemodeOs.name_jp;

            const patterns = [
              `『${engineKeyword}』の魂を持つ、${interfaceKeyword}。その本質は『${safemodeKeyword}』の叡智に支えられている。`,
              `${interfaceKeyword}の仮面をつけた、『${engineKeyword}』の探求者。危機に瀕した時、『${safemodeKeyword}』が道を示す。`,
              `核となる力は『${engineKeyword}』。世界との対話は『${interfaceKeyword}』。そして、あなたを守る安全装置は『${safemodeKeyword}』。`,
            ];
            return patterns[engineOs.hexagram_id % patterns.length];
          }

          function generateStrategySummary(engineOs, interfaceOs, safemodeOs) {
            const getInteraction = (id1, id2) => {
              if (
                !TRIGRAM_INTERACTIONS[id1] ||
                !TRIGRAM_INTERACTIONS[id1][id2]
              ) {
                return {
                  synergy: "相互作用データ準備中...",
                  conflict: "相互作用データ準備中...",
                };
              }
              return TRIGRAM_INTERACTIONS[id1][id2];
            };

            const innerInteraction = getInteraction(
              engineOs.lower_trigram_id,
              interfaceOs.lower_trigram_id
            );
            const outerInteraction = getInteraction(
              engineOs.upper_trigram_id,
              interfaceOs.upper_trigram_id
            );

            const synergySummary = `あなたのOSの最大の強みは、エンジンOS【${engineOs.name_jp}】とインターフェースOS【${interfaceOs.name_jp}】の連携から生まれます。具体的には、<strong>${innerInteraction.synergy}</strong> また、<strong>${outerInteraction.synergy}</strong> これが、あなたが自然体でいる時に発揮される、独自の価値創造パターンです。`;
            const conflictSummary = `一方で、この強力な連携は、時に内面的な葛藤を生み出します。<strong>${innerInteraction.conflict}</strong> さらに、<strong>${outerInteraction.conflict}</strong> この葛藤が、あなたのエネルギーを消耗させたり、行動をためらわせたりする原因となります。`;
            const finalStrategy = `したがって、あなたのポテンシャルを最大化するための基本戦略は、<strong>「インターフェースOSの特性を意識的に使い、エンジンOSのエネルギーを最適に方向付けること」</strong>です。この二つのOSの『${
              HDB.bible?.zatsu_ka_den?.[engineOs.hexagram_id]?.contrast_theme ||
              "関係性"
            }』がもたらす課題に直面し、強いストレスを感じた時、あなたを守る安全装置として<strong>セーフモードOS【${
              safemodeOs.name_jp
            }】</strong>が起動します。この原点に定期的に立ち返ることで、OSは最適にチューニングされます。`;

            return `
                  <div class="prose-custom space-y-6 text-left">
                      <div class="p-4 bg-gray-900 rounded-lg border-l-2 border-green-400">
                          <p class="font-semibold text-green-300">シナジー（相乗効果）:</p>
                          <p class="text-sm">${synergySummary}</p>
                      </div>
                      <div class="p-4 bg-gray-900 rounded-lg border-l-2 border-red-400">
                           <p class="font-semibold text-red-300">成長課題（チャレンジ）:</p>
                           <p class="text-sm">${conflictSummary}</p>
                      </div>
                      <div class="mt-6 pt-6 border-t border-dashed border-gray-700">
                          <h5 class="font-bold text-amber-300">OSチューニング戦略</h5>
                          <p>${finalStrategy}</p>
                      </div>
                  </div>
              `;
          }

          function displayReport(analysisResult) {
            const { engineOs, interfaceOs, safemodeOs } = analysisResult;
            inputContainer.classList.add("hidden");
            controlContainer.classList.add("hidden");
            reportContainer.classList.remove("hidden");
            window.scrollTo({ top: 0, behavior: "smooth" });

            const triadName = generateTriadName(
              engineOs,
              interfaceOs,
              safemodeOs
            );
            const strategySummary = generateStrategySummary(
              engineOs,
              interfaceOs,
              safemodeOs
            );

            const osSectionHtml = (os, type) => `
                <div class="p-5 rounded-xl shadow-lg flex flex-col bg-gray-900/50 border border-gray-700">
                    <h4 class="text-lg font-bold text-indigo-300 flex items-center mb-2">
                        <span class="text-2xl mr-2">${type.icon}</span>${
              type.title
            }：${os.name_jp}
                    </h4>
                    <p class="text-gray-400">${os.catchphrase}</p>
                    <p class="prose-custom text-sm mt-2">${
                      HDB.os_manual[os.hexagram_id]?.summary ||
                      "詳細な説明は準備中です。"
                    }</p>
                </div>`;

            // ★★★ V6.7：レポートの表示順序を変更 ★★★
            reportContainer.innerHTML = `
                <div class="text-center space-y-12">
                    <div class="report-section">
                        <h3 class="text-3xl font-bold text-indigo-300">あなたのOS三位一体（トリアッド）ダイナミクス</h3>
                        <p class="mt-4 text-gray-300 max-w-2xl mx-auto">あなたの回答から、人格を形成する3つのOSの力学（ダイナミクス）が明らかになりました。これは、あなたという唯一無二のシステムを理解するための、戦略的な設計図です。</p>
                        <p class="text-lg font-bold brand-text mt-4">${triadName}</p>
                    </div>

                    <div class="space-y-8 text-left">
                        <div class="p-6 bg-gray-900/50 rounded-xl border-t-4 border-amber-400">
                            ${osSectionHtml(engineOs, {
                              icon: "🔥",
                              title: "エンジンOS",
                            })}
                        </div>
                        
                        <div class="p-6 bg-gray-900/50 rounded-xl border-t-4 border-indigo-400">
                            ${osSectionHtml(interfaceOs, {
                              icon: "🎭",
                              title: "インターフェースOS",
                            })}
                        </div>

                        <div class="p-6 bg-gray-900/50 rounded-xl border-t-4 border-gray-500">
                            ${osSectionHtml(safemodeOs, {
                              icon: "🛡️",
                              title: "セーフモードOS",
                            })}
                        </div>

                        <div class="p-6 bg-gray-700/50 rounded-xl">
                             <h4 class="text-xl font-bold text-center text-amber-300 mb-4">連携と葛藤のダイナミクス</h4>
                             ${strategySummary}
                        </div>
                    </div>

                    <div class="mt-16 pt-8 border-t-2 border-dashed border-gray-700">
                        <h3 class="text-xl font-bold text-amber-300 mb-4">次のステップへ</h3>
                        <div class="mt-8">
                            <a href="future_simulator.html" class="bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105">
                                未来分岐シミュレーターで、具体的な課題を分析する &rarr;
                            </a>
                        </div>
                    </div>
                </div>
            `;
          }

          analyzeBtn.disabled = true;
          agreementCheckbox.addEventListener("change", () => {
            analyzeBtn.disabled = !agreementCheckbox.checked;
          });
          renderQuestions();

          analyzeBtn.addEventListener("click", () => {
            const analysisResult = runOsAnalysis();
            if (analysisResult) {
              try {
                const dataToStore = {
                  analysisResult: {
                    engineOs: analysisResult.engineOs,
                    interfaceOs: analysisResult.interfaceOs,
                    safemodeOs: analysisResult.safemodeOs,
                  },
                  userContext: {
                    analyzedAt: new Date().toISOString(),
                  },
                };
                localStorage.setItem(
                  "haqeiOsAnalyzerData",
                  JSON.stringify(dataToStore)
                );
              } catch (e) {
                console.error("OS分析データの保存に失敗しました:", e);
              }
              displayReport(analysisResult);
            }
          });
        } catch (error) {
          console.error("初期化に失敗:", error);
          document.body.innerHTML = `<div class="text-center text-red-400 p-8">ページの読み込みに失敗しました: ${error.message}</div>`;
        }
      });
    </script>
  </body>
</html>
