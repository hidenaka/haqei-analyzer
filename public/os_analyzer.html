<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei ベーシックOS分析 Final</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>易</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .prose-custom {
        color: #d1d5db;
        line-height: 1.8;
      }
      .prose-custom p {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      .prose-custom strong {
        color: #fde047;
      }
      .diagnostic-item {
        background-color: rgba(31, 41, 55, 0.7);
        border: 1px solid #374151;
        border-radius: 1rem;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
      }
      .meta-question-item {
        background-color: rgba(79, 70, 229, 0.1);
        border: 1px solid #4f46e5;
      }
      .question-block {
        margin-top: 1.25rem;
      }
      .question-text {
        font-weight: 500;
        color: #a5b4fc;
        margin-bottom: 0.75rem;
      }
      .option-label {
        display: flex;
        align-items: center;
        text-align: left;
        padding: 0.75rem 1rem;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 100%;
        background-color: #374151;
        font-size: 0.875rem;
        line-height: 1.5;
      }
      .option-label:hover {
        background-color: #4b5563;
        border-color: #6366f1;
      }
      input[type="radio"]:checked + .option-label {
        background-color: #4f46e5;
        border-color: #a5b4fc;
        color: #e0e7ff;
        font-weight: 600;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(129, 140, 248, 0.2);
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6">
    <div
      class="w-full max-w-4xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-10"
    >
      <header class="text-center mb-10">
        <a
          href="./"
          class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block text-sm"
          >← トップページへ戻る</a
        >
        <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
          ベーシックOS分析
        </h1>
        <p class="text-gray-400 mt-2">
          あなたという存在の核となる、3つの人格OSを特定します。
        </p>
      </header>

      <div id="input-container" class="space-y-8">
        <div class="text-center bg-gray-900/50 p-4 rounded-xl">
          <p>
            これから提示される8つのシナリオと2つのメタ質問に対し、あなたの「心の中の反応」と「実際の行動」に最も近いものを、それぞれ1つずつ選んでください。
          </p>
        </div>
      </div>

      <div id="control-container" class="mt-8 pt-8 border-t border-gray-700">
        <div class="text-center">
          <label class="flex items-center justify-center cursor-pointer">
            <input
              type="checkbox"
              id="agreementCheckbox"
              class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500"
            />
            <span class="ml-2 text-sm text-gray-400">
              <a
                href="/terms.html"
                target="_blank"
                class="underline hover:text-white"
                >利用規約</a
              >および<a
                href="/privacy.html"
                target="_blank"
                class="underline hover:text-white"
                >プライバシーポリシー</a
              >に同意します
            </span>
          </label>
        </div>
        <button
          id="analyzeBtn"
          class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 ease-in-out transform hover:scale-105 mt-6 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          人格OSを特定する
        </button>
      </div>

      <div id="report-container" class="hidden"></div>
    </div>

    <script type="module">
      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const response = await fetch("/api/data");
          if (!response.ok)
            throw new Error("データベースの読み込みに失敗しました。");
          const { HAQEI_DATA } = await response.json();
          const HDB = HAQEI_DATA;

          const analyzeBtn = document.getElementById("analyzeBtn");
          const agreementCheckbox =
            document.getElementById("agreementCheckbox");
          const inputContainer = document.getElementById("input-container");
          const controlContainer = document.getElementById("control-container");
          const reportContainer = document.getElementById("report-container");

          const HELPERS = {
            getTrigramById: (id) =>
              HDB.trigrams_master.find((t) => t.trigram_id === parseInt(id)) ||
              {},
            getHexagramById: (id) =>
              HDB.hexagrams_master.find(
                (h) => h.hexagram_id === parseInt(id)
              ) || {},
            // HDB.os_manual を参照するヘルパー関数
            getOsManualById: (id) => HDB.os_manual[id] || {},
          };
          const KEYWORD_RESONANCE_DB = HDB.keyword_map || {};
          // (設問データとキーワードDBは長いため、内容は変更ありません)
          const DIAGNOSTIC_QUESTIONS = [
            {
              id: "q1",
              scenario:
                "友人たちとの楽しい旅行計画が、予期せぬトラブルで完全に白紙に戻ってしまいました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「残念すぎる…」という喪失感や悲しみに沈む",
                    scores: { 2: -2, 6: 2, 7: 1 },
                    keywords: ["損失", "悲嘆"],
                  },
                  {
                    text: "「なぜこうなった？」と原因を分析し、状況を知的に理解しようとする",
                    scores: { 3: 2, 7: 1, 8: -1 },
                    keywords: ["分析", "知性", "原因究明"],
                  },
                  {
                    text: "「まあ仕方ない、次どうするか考えよう」と、すぐに気持ちを切り替える",
                    scores: { 4: 2, 1: 1, 6: -1 },
                    keywords: ["決断", "前向き", "行動力"],
                  },
                ],
                outer: [
                  {
                    text: "「私が新しい計画を立てる！」と率先してリーダーシップを発揮する",
                    scores: { 1: 3, 4: 1, 8: -2 },
                    keywords: ["リーダーシップ", "創造", "実行"],
                  },
                  {
                    text: "「皆がっかりしてるだろう」と、まずメンバーのケアや慰めを優先する",
                    scores: { 8: 2, 5: 2, 1: -1 },
                    keywords: ["共感", "サポート", "調和"],
                  },
                  {
                    text: "一旦「どうするかは、また後で考えよう」と、状況を静観する",
                    scores: { 7: 3, 6: 1, 4: -2 },
                    keywords: ["静止", "内省", "待機"],
                  },
                ],
              },
            },
            {
              id: "q2",
              scenario:
                "あなたは全く新しい分野のスキルを、ゼロから学ぶことになりました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる学び方」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「面白そう！」という好奇心と、新しい自分になれることへの期待感",
                    scores: { 4: 2, 3: 2, 7: -1 },
                    keywords: ["好奇心", "喜び", "変化"],
                  },
                  {
                    text: "「本当に自分にできるだろうか…」という不安と、失敗への恐れ",
                    scores: { 6: 2, 7: 1, 1: -2 },
                    keywords: ["困難", "慎重", "不安"],
                  },
                  {
                    text: "「どうせやるなら完璧に」という、知的な探求心と向上心",
                    scores: { 1: 2, 6: 1, 2: -1 },
                    keywords: ["完璧主義", "探求", "向上心"],
                  },
                ],
                outer: [
                  {
                    text: "まず全体像を把握するため、関連書籍を何冊も読んで体系的に学ぶ",
                    scores: { 7: 2, 3: 1, 4: -1 },
                    keywords: ["学習", "分析", "計画"],
                  },
                  {
                    text: "とにかく実践！専門家や経験者に積極的に質問し、試行錯誤しながら学ぶ",
                    scores: { 4: 3, 2: 1, 7: -2 },
                    keywords: ["行動力", "挑戦", "コミュニケーション"],
                  },
                  {
                    text: "同じ目標を持つ仲間を見つけ、勉強会を開くなど、協調しながら学ぶ",
                    scores: { 5: 2, 8: 2, 1: -1 },
                    keywords: ["協力", "チームワーク", "共感"],
                  },
                ],
              },
            },
            {
              id: "q3",
              scenario:
                "あなたの意見が、会議で他のメンバーから真っ向から反対されました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「なぜ理解できないんだ！」という怒りや、自分の正しさへの確信",
                    scores: { 1: 2, 3: 1, 8: -2 },
                    keywords: ["正義感", "対立", "怒り"],
                  },
                  {
                    text: "「私の説明が悪かったのかも…」という自己反省と、関係悪化への不安",
                    scores: { 8: 2, 5: 1, 1: -1 },
                    keywords: ["協調性", "内省", "不安"],
                  },
                  {
                    text: "「なるほど、そういう視点もあるのか」という知的な興味",
                    scores: { 6: 2, 7: 1, 4: -1 },
                    keywords: ["知的好奇心", "分析", "冷静"],
                  },
                ],
                outer: [
                  {
                    text: "感情的にならず、データや論理を用いて、冷静に相手を説得しようと試みる",
                    scores: { 3: 2, 1: 1, 2: -1 },
                    keywords: ["論理", "説得", "知性"],
                  },
                  {
                    text: "一旦相手の意見を受け入れ、共通の落としどころを探る対話的なアプローチをとる",
                    scores: { 5: 3, 8: 1, 1: -1 },
                    keywords: ["調和", "交渉", "共感"],
                  },
                  {
                    text: "議論を中断し、時間を置いて、別の角度から再度アプローチする",
                    scores: { 7: 2, 6: 1, 4: -1 },
                    keywords: ["待機", "戦略", "内省"],
                  },
                ],
              },
            },
            {
              id: "q4",
              scenario:
                "あなたはプロジェクトで大きな成功を収め、周囲から絶賛されています。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「最高に気持ちいい！」という達成感と、さらなる成功への意欲",
                    scores: { 3: 2, 4: 2, 8: -1 },
                    keywords: ["達成感", "情熱", "野心"],
                  },
                  {
                    text: "「皆のおかげだ」という、周囲への感謝と謙虚な気持ち",
                    scores: { 8: 2, 2: 1, 1: -2 },
                    keywords: ["感謝", "謙虚", "チームワーク"],
                  },
                  {
                    text: "「なぜ成功したのか」を冷静に分析し、次への再現性を考える",
                    scores: { 7: 2, 1: 1, 3: -1 },
                    keywords: ["分析", "戦略", "再現性"],
                  },
                ],
                outer: [
                  {
                    text: "成功を祝う盛大なパーティーを開き、喜びを仲間と分かち合う",
                    scores: { 2: 3, 3: 1, 7: -1 },
                    keywords: ["社交性", "喜びの共有", "祝賀"],
                  },
                  {
                    text: "すぐに次の目標を設定し、休みなく次の挑戦へと向かう",
                    scores: { 1: 2, 4: 1, 8: -1 },
                    keywords: ["野心", "継続", "挑戦"],
                  },
                  {
                    text: "成功体験をマニュアル化し、後進の育成や組織の発展に貢献する",
                    scores: { 5: 2, 8: 1, 4: -1 },
                    keywords: ["育成", "貢献", "体系化"],
                  },
                ],
              },
            },
            {
              id: "q5",
              scenario:
                "あなたと親友が、些細なことから気まずい雰囲気になってしまいました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「自分が何か悪いことをしたかも…」と、自分を責め、不安になる",
                    scores: { 8: 2, 6: 1 },
                  },
                  {
                    text: "「面倒なことになったな…」と、問題から目をそらし、距離を置きたくなる",
                    scores: { 7: 2, 5: -1 },
                  },
                  {
                    text: "「早く仲直りしたい」と、解決を焦る気持ちが強くなる",
                    scores: { 4: 2, 2: 1 },
                  },
                ],
                outer: [
                  {
                    text: "自分から「あの時はごめん」と率直に謝り、関係修復を図る",
                    scores: { 2: 2, 4: 1 },
                  },
                  {
                    text: "しばらく時間を置き、相手からの連絡を待つ",
                    scores: { 7: 2, 8: 1 },
                  },
                  {
                    text: "共通の友人に相談し、間を取り持ってもらおうとする",
                    scores: { 5: 3, 2: -1 },
                  },
                ],
              },
            },
            {
              id: "q6",
              scenario:
                "あなたに、丸一日、誰にも邪魔されない完全な自由時間が与えられました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際に過ごす時間」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「何をしようか？」とワクワクし、やりたいことが次々と思い浮かぶ",
                    scores: { 3: 2, 4: 2 },
                  },
                  {
                    text: "「やっと休める…」と、心身の休息を最優先にしたいと感じる",
                    scores: { 8: 2, 7: 1 },
                  },
                  {
                    text: "「どうせなら有意義に」と、普段できない自己投資や勉強を計画する",
                    scores: { 1: 2, 6: 2 },
                  },
                ],
                outer: [
                  {
                    text: "結局、家でゴロゴロしたり、特に何もせずに過ごしてしまう",
                    scores: { 8: 2, 7: -1 },
                  },
                  {
                    text: "溜まっていた趣味や創作活動に、時間を忘れて没頭する",
                    scores: { 6: 2, 3: 1 },
                  },
                  {
                    text: "友人を誘って食事に行ったり、イベントに出かけたりして、積極的に人と交流する",
                    scores: { 2: 3, 5: 1 },
                  },
                ],
              },
            },
            {
              id: "q7",
              scenario:
                "これまで順調だった物事が、急に停滞し、先の見えない状況になりました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「やり方が悪かったのか？」と、過去の行動を分析し、問題点を探す",
                    scores: { 7: 2, 6: 1 },
                  },
                  {
                    text: "「これも一つの流れだ」と、状況をあるがままに受け入れ、静観する",
                    scores: { 8: 2, 5: 1 },
                  },
                  {
                    text: "「このままではダメだ！」と、強い危機感と、変化への渇望を感じる",
                    scores: { 4: 2, 1: 1 },
                  },
                ],
                outer: [
                  {
                    text: "根本的な原因が分かるまで、全ての行動を一旦ストップする",
                    scores: { 7: 3, 6: -1 },
                  },
                  {
                    text: "停滞を打破するため、全く新しいアプローチや、奇抜なアイデアを試す",
                    scores: { 4: 2, 3: 1 },
                  },
                  {
                    text: "周囲の意見を広く聞き、協力体制を再構築しようと試みる",
                    scores: { 5: 2, 8: 1 },
                  },
                ],
              },
            },
            {
              id: "q8",
              scenario:
                "あなたは、全く興味のなかった分野に、偶然触れる機会がありました。",
              inner_q:
                "この時、あなたの「心の中」で、最初に強く湧き上がる感情や思考は？",
              outer_q: "そして、あなたが「実際にとる行動」に、最も近いのは？",
              options: {
                inner: [
                  {
                    text: "「意外と面白いかも」と、新しい世界への好奇心が刺激される",
                    scores: { 2: 2, 5: 1 },
                  },
                  {
                    text: "「自分の専門とは違う」と、知的な壁を作り、深く関わることを避ける",
                    scores: { 7: 2, 1: -1 },
                  },
                  {
                    text: "「なぜ今まで知らなかったんだろう」と、その分野の歴史や背景を知りたくなる",
                    scores: { 6: 2, 8: 1 },
                  },
                ],
                outer: [
                  {
                    text: "その場でSNSでシェアしたり、誰かにその面白さを話したりする",
                    scores: { 2: 2, 3: 1 },
                  },
                  {
                    text: "その分野の入門書を数冊購入し、自分の知識体系に組み込もうとする",
                    scores: { 6: 2, 1: 1 },
                  },
                  {
                    text: "一度きりの体験として楽しみ、それ以上深入りはしない",
                    scores: { 5: -1, 7: 1 },
                  },
                ],
              },
            },
          ];

          const META_QUESTIONS = [
            {
              id: "mq1",
              text: "あなたが物事を判断する際の、最も根源的な「ものさし」はどれですか？",
              options: [
                {
                  text: "その判断は「論理的に正しいか、効率的か」",
                  intention: "logic",
                },
                {
                  text: "その判断は「皆が納得し、調和が保たれるか」",
                  intention: "harmony",
                },
                {
                  text: "その判断は「挑戦的で、自分の成長に繋がるか」",
                  intention: "action",
                },
              ],
            },
            {
              id: "mq2",
              text: "あなたが「最高の状態」だと感じるのは、どんな時ですか？",
              options: [
                {
                  text: "複雑な問題を解き明かし、知的な探求心を満たしている時",
                  intention: "logic",
                },
                {
                  text: "仲間と喜びを分かち合い、深いつながりを感じている時",
                  intention: "harmony",
                },
                {
                  text: "困難な目標を達成し、自らの力を証明できた時",
                  intention: "action",
                },
              ],
            },
          ];
          const INTENTION_BONUS_DB = {
            logic: {
              hex_ids: [1, 3, 6, 7, 10, 26, 27, 33, 52, 62, 63],
              bonus: 1.5,
            },
            harmony: {
              hex_ids: [2, 5, 8, 11, 13, 15, 31, 37, 45, 57, 58],
              bonus: 1.5,
            },
            action: {
              hex_ids: [4, 9, 14, 16, 17, 21, 25, 32, 34, 42, 43, 49, 51, 55],
              bonus: 1.5,
            },
          };

          function renderQuestions() {
            if (!inputContainer) return;
            let html = inputContainer.querySelector("div").outerHTML; // Keep initial message
            DIAGNOSTIC_QUESTIONS.forEach((q, index) => {
              const innerOpts = q.options.inner
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}_inner" value="${i}" id="${q.id}_inner_${i}" class="hidden"><label for="${q.id}_inner_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              const outerOpts = q.options.outer
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}_outer" value="${i}" id="${q.id}_outer_${i}" class="hidden"><label for="${q.id}_outer_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              html += `<div class="diagnostic-item"><p class="text-gray-400 text-sm">シナリオ ${
                index + 1
              }/${
                DIAGNOSTIC_QUESTIONS.length
              }</p><p class="font-semibold text-gray-200 mb-4">${
                q.scenario
              }</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="question-block"><p class="question-text">${
                q.inner_q
              }</p><div class="space-y-3">${innerOpts}</div></div><div class="question-block"><p class="question-text">${
                q.outer_q
              }</p><div class="space-y-3">${outerOpts}</div></div></div></div>`;
            });
            html += `<div class="diagnostic-item meta-question-item mt-8"><p class="font-semibold text-indigo-300 text-center mb-4">最後に、あなたの根源的な価値観についてお聞かせください。</p>`;
            META_QUESTIONS.forEach((q, index) => {
              const metaOpts = q.options
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}" value="${opt.intention}" id="${q.id}_${i}" class="hidden"><label for="${q.id}_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              html += `<div class="question-block mt-6"><p class="question-text">${
                index + 1
              }. ${q.text}</p><div class="space-y-3">${metaOpts}</div></div>`;
            });
            html += `</div>`;
            inputContainer.innerHTML = html;
          }

          function runOsAnalysis() {
            const innerScores = {
              1: 0,
              2: 0,
              3: 0,
              4: 0,
              5: 0,
              6: 0,
              7: 0,
              8: 0,
            };
            const outerScores = {
              1: 0,
              2: 0,
              3: 0,
              4: 0,
              5: 0,
              6: 0,
              7: 0,
              8: 0,
            };
            const hexagramResonanceScores = {};
            for (let i = 1; i <= 64; i++) {
              hexagramResonanceScores[i] = 0;
            }
            let allAnswered = true;
            DIAGNOSTIC_QUESTIONS.forEach((q) => {
              const innerAnswerNode = document.querySelector(
                `input[name="${q.id}_inner"]:checked`
              );
              const outerAnswerNode = document.querySelector(
                `input[name="${q.id}_outer"]:checked`
              );
              if (!innerAnswerNode || !outerAnswerNode) {
                allAnswered = false;
                return;
              }
              const innerChoice = q.options.inner[innerAnswerNode.value];
              for (const trigram_id in innerChoice.scores) {
                innerScores[trigram_id] += innerChoice.scores[trigram_id];
              }
              if (innerChoice.keywords) {
                innerChoice.keywords.forEach((kw) => {
                  if (KEYWORD_RESONANCE_DB[kw]) {
                    KEYWORD_RESONANCE_DB[kw].forEach((hexId) => {
                      hexagramResonanceScores[hexId] =
                        (hexagramResonanceScores[hexId] || 0) + 1.2;
                    });
                  }
                });
              }
              const outerChoice = q.options.outer[outerAnswerNode.value];
              for (const trigram_id in outerChoice.scores) {
                outerScores[trigram_id] += outerChoice.scores[trigram_id];
              }
              if (outerChoice.keywords) {
                outerChoice.keywords.forEach((kw) => {
                  if (KEYWORD_RESONANCE_DB[kw]) {
                    KEYWORD_RESONANCE_DB[kw].forEach((hexId) => {
                      hexagramResonanceScores[hexId] =
                        (hexagramResonanceScores[hexId] || 0) + 1.2;
                    });
                  }
                });
              }
            });
            META_QUESTIONS.forEach((q) => {
              if (!document.querySelector(`input[name="${q.id}"]:checked`))
                allAnswered = false;
            });
            if (!allAnswered) {
              alert("すべての質問に回答してください。");
              return null;
            }

            const intentions = META_QUESTIONS.map(
              (q) =>
                document.querySelector(`input[name="${q.id}"]:checked`).value
            );
            const hexagram_candidates = HDB.hexagrams_master
              .map((hexagram) => {
                const structuralScore =
                  (outerScores[hexagram.upper_trigram_id] || 0) +
                  (innerScores[hexagram.lower_trigram_id] || 0);
                const resonanceScore =
                  hexagramResonanceScores[hexagram.hexagram_id] || 0;
                let final_score = structuralScore + resonanceScore;
                intentions.forEach((intent) => {
                  if (
                    INTENTION_BONUS_DB[intent] &&
                    INTENTION_BONUS_DB[intent].hex_ids.includes(
                      hexagram.hexagram_id
                    )
                  ) {
                    final_score += INTENTION_BONUS_DB[intent].bonus;
                  }
                });
                if (hexagram.lower_trigram_id === hexagram.upper_trigram_id) {
                  final_score *= 0.85;
                }
                return {
                  ...hexagram,
                  final_score: Math.round(final_score * 10) / 10,
                };
              })
              .sort((a, b) => b.final_score - a.final_score);

            return {
              hexagram_candidates: hexagram_candidates.slice(0, 10),
              innerScores,
              outerScores,
            };
          }

          function getOsDescription(osId, role) {
            const manual = HELPERS.getOsManualById(osId);
            if (!manual)
              return {
                role_desc: "解説準備中...",
                potential: "可能性を分析中...",
              };

            const role_desc = manual[role] || manual.summary || "解説準備中...";
            const potential =
              manual.potential || "このOSの可能性については、現在分析中です。";

            return { role_desc, potential };
          }

          function displayReport(analysisResult) {
            const osList = [
              { role: "engine", data: analysisResult.hexagram_candidates[0] },
              {
                role: "interface",
                data: analysisResult.hexagram_candidates[1],
              },
              { role: "safemode", data: analysisResult.hexagram_candidates[2] },
            ];

            inputContainer.classList.add("hidden");
            controlContainer.classList.add("hidden");
            reportContainer.classList.remove("hidden");

            const osCardsHtml = osList
              .map((osItem) => {
                const os = osItem.data;
                const desc = getOsDescription(
                  os.hexagram_id,
                  `as_${osItem.role}`
                );
                const roleInfo = {
                  engine: { label: "エンジンOS", color: "red" },
                  interface: { label: "インターフェースOS", color: "blue" },
                  safemode: { label: "セーフモードOS", color: "gray" },
                };
                const info = roleInfo[osItem.role];

                return `
                        <div class="p-4 bg-gray-900/50 rounded-lg border-l-4 border-${info.color}-400">
                            <p class="text-sm text-${info.color}-300 font-bold">${info.label}</p>
                            <p class="text-xl font-semibold">${os.name_jp}</p>
                            <p class="text-sm text-gray-400 mb-4">${os.catchphrase}</p>
                            <div class="prose-custom text-sm">
                                <p>${desc.role_desc}</p>
                                <div class="mt-4 pt-4 border-t border-gray-700/50">
                                    <p class="font-semibold text-green-400">可能性の種：</p>
                                    <p>${desc.potential}</p>
                                </div>
                            </div>
                        </div>
                    `;
              })
              .join("");

            reportContainer.innerHTML = `
                  <div class="text-center">
                      <h2 class="text-2xl font-bold text-indigo-300">分析完了</h2>
                      <p class="mt-4 text-gray-300">あなたの3つの人格OSが特定されました。</p>
                      <div class="mt-6 space-y-4 text-left">${osCardsHtml}</div>
                      <div class="mt-10 pt-8 border-t border-gray-700">
                        <h3 class="text-xl font-bold text-amber-300 mb-4">アバターとOSの共鳴</h3>
                        <div id="narrative-content" class="text-left text-gray-300 prose-custom max-w-none"></div>
                      </div>
                      <div class="mt-10">
                            <a href="future_simulator.html" class="bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105 shadow-lg shadow-amber-500/30 inline-block">
                                未来分岐シミュレーターで次の道を探る &rarr;
                            </a>
                      </div>
                  </div>
                `;

            // ナラティブ表示のロジック
            const quickData = (() => {
              try {
                return JSON.parse(
                  localStorage.getItem("haqeiQuickAnalyzerData")
                );
              } catch (e) {
                return null;
              }
            })();
            const narrativeContent =
              document.getElementById("narrative-content");
            if (quickData && quickData.avatarTrigramId) {
              const avatar = HELPERS.getTrigramById(quickData.avatarTrigramId);
              let narrative = `<p>クイック診断で特定されたあなたの『八卦アバター』は<strong>【${avatar.name_jp}】</strong>でした。これは、あなたが他者から見られやすい「第一印象」や、社会と関わる際の「表層的なペルソナ」を象徴する、あなたの大切な「分人」の一つです。</p>`;
              let foundResonance = false;
              osList.forEach((osItem) => {
                if (foundResonance || !osItem.data) return;
                if (avatar.trigram_id === osItem.data.upper_trigram_id) {
                  narrative += `<p>この<strong>【${avatar.name_jp}】</strong>のエネルギーは、あなたのOSの一つ<strong>『${osItem.data.name_jp}』</strong>の外面的な側面（上卦）と完全に一致しています。これは、あなたの第一印象と精神的な性質が直結していることを示しており、<strong>あなたの考えや理念がストレートに周囲に伝わりやすい</strong>ことを意味します。</p>`;
                  foundResonance = true;
                } else if (avatar.trigram_id === osItem.data.lower_trigram_id) {
                  narrative += `<p>この<strong>【${avatar.name_jp}】</strong>のエネルギーは、あなたのOSの一つ<strong>『${osItem.data.name_jp}』</strong>の内面的な側面（下卦）と完全に一致しています。これは、あなたの行動原理や無意識の「癖」が、そのままあなたの雰囲気として周囲に伝わっていることを示します。</p>`;
                  foundResonance = true;
                }
              });
              if (!foundResonance) {
                narrative +=
                  "<p>興味深いことに、あなたの『八卦アバター』は、3つのOSを構成するどの八卦とも直接的な関連性が薄いようです。これは、あなたが<strong>社会的な場面で見せる顔と、あなたの内面的なOSの間に、ある種のギャップがある</strong>ことを示唆しています。</p>";
              }
              narrativeContent.innerHTML = narrative;
            } else {
              narrativeContent.innerHTML = `<p class="text-center text-gray-400">先に「クイック診断」を行うと、あなたのアバターとOSの連携についての特別な解説がここに表示されます。</p>`;
            }
          }

          // --- 初期化とイベントリスナー設定 ---
          analyzeBtn.disabled = true;
          agreementCheckbox.addEventListener("change", () => {
            analyzeBtn.disabled = !agreementCheckbox.checked;
          });
          renderQuestions();

          analyzeBtn.addEventListener("click", () => {
            const analysisResult = runOsAnalysis();
            if (!analysisResult) return;

            const quickData = (() => {
              try {
                return JSON.parse(
                  localStorage.getItem("haqeiQuickAnalyzerData")
                );
              } catch (e) {
                return null;
              }
            })();
            const dataToStore = {
              osEngineId: analysisResult.hexagram_candidates[0].hexagram_id,
              osInterfaceId: analysisResult.hexagram_candidates[1].hexagram_id,
              osSafeModeId: analysisResult.hexagram_candidates[2].hexagram_id,
              avatarTrigramId:
                quickData && quickData.avatarTrigramId
                  ? quickData.avatarTrigramId
                  : null,
              analysisResult: analysisResult,
            };

            try {
              localStorage.setItem(
                "haqeiOsAnalyzerData",
                JSON.stringify(dataToStore)
              );
              console.log(
                "OS分析データをlocalStorageに保存しました。",
                dataToStore
              );
            } catch (e) {
              console.error("OS分析データの保存に失敗しました:", e);
            }

            displayReport(analysisResult);
          });
        } catch (error) {
          console.error("初期化に失敗:", error);
          document.body.innerHTML = `<div class="text-center text-red-400 p-8">ページの読み込みに失敗しました: ${error.message}</div>`;
        }
      });
    </script>
  </body>
</html>
