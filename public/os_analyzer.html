<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei ãƒ™ãƒ¼ã‚·ãƒƒã‚¯OSåˆ†æ V8.4</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>æ˜“</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .prose-custom {
        color: #d1d5db;
        line-height: 1.8;
      }
      .prose-custom p {
        margin-top: 1em;
        margin-bottom: 1em;
      }
      .prose-custom strong {
        color: #facc15;
      }
      .diagnostic-item {
        background-color: rgba(31, 41, 55, 0.7);
        border: 1px solid #374151;
        border-radius: 1rem;
        padding: 1.5rem;
        backdrop-filter: blur(10px);
        margin-bottom: 2rem;
      }
      .option-label {
        display: flex;
        align-items: center;
        text-align: left;
        padding: 0.75rem 1rem;
        border: 1px solid #4b5563;
        border-radius: 0.5rem;
        cursor: pointer;
        transition: all 0.2s ease;
        height: 100%;
        background-color: #374151;
        font-size: 0.875rem;
        line-height: 1.5;
      }
      .option-label:hover {
        background-color: #4b5563;
        border-color: #6366f1;
      }
      input[type="radio"]:checked + .option-label {
        border-color: #a5b4fc;
        background-color: #4338ca;
        box-shadow: 0 0 10px rgba(165, 180, 252, 0.4);
      }
      .report-section h3,
      .report-section h4 {
        font-family: "Shippori Mincho", serif;
      }
      .engine-card {
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 0.75rem;
        cursor: pointer;
        transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        padding: 1.25rem;
        background-color: #1f2937;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
      }
      .engine-card:hover {
        transform: translateY(-5px) scale(1.02);
        box-shadow: 0 10px 15px rgba(0, 0, 0, 0.4);
        border-color: rgba(165, 180, 252, 0.5);
      }
      .engine-card.candidate-selected {
        border-color: #818cf8;
        border-width: 3px;
        background-color: #3730a3;
        box-shadow: 0 0 15px rgba(129, 140, 248, 0.4);
      }
      .engine-card.selected {
        border-color: #a3e635;
        box-shadow: 0 0 25px rgba(163, 230, 53, 0.4),
          0 0 0 3px rgba(163, 230, 53, 0.7);
        transform: translateY(-5px) scale(1.05);
        background-color: #3f6212;
      }
      .engine-card-header {
        text-align: left;
        display: flex;
        align-items: center;
        gap: 0.75rem;
      }
      .engine-card-header .archetype-icon {
        font-size: 1.75rem;
        line-height: 1;
      }
      .engine-card-header .archetype-name {
        font-family: "Shippori Mincho", serif;
        font-weight: 700;
        font-size: 1.125rem;
      }
      .engine-card ul {
        list-style: none;
        padding-left: 0;
        min-height: 4rem;
      }
      .engine-card li {
        position: relative;
        padding-left: 1.25rem;
      }
      .engine-card li::before {
        content: "â–¡";
        position: absolute;
        left: 0;
        color: #9ca3af;
      }
      .suitability-bars {
        display: grid;
        grid-template-columns: 2.5rem 1fr;
        gap: 0.375rem;
        align-items: center;
        font-size: 0.6rem;
        color: #9ca3af;
      }
      .bar-container {
        width: 100%;
        background-color: #374151;
        border-radius: 9999px;
        height: 0.5rem;
      }
      .bar-fill {
        height: 0.5rem;
        border-radius: 9999px;
        transition: width 0.5s ease-in-out;
      }
      .bar-highlight {
        box-shadow: 0 0 8px, 0 0 12px;
      }
      details summary {
        cursor: pointer;
        padding: 0.5rem 0;
        border-radius: 0.375rem;
        transition: background-color 0.2s ease;
      }
      details summary:hover {
        background-color: rgba(255, 255, 255, 0.05);
      }
      details[open] summary {
        margin-bottom: 0.5rem;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-8">
    <div
      class="w-full max-w-4xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-10"
    >
      <header class="text-center mb-10">
        <a
          href="./"
          class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block text-sm"
          >â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a
        >
        <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
          ãƒ™ãƒ¼ã‚·ãƒƒã‚¯OSåˆ†æ
        </h1>
        <p class="text-gray-400 mt-2">
          ã‚ãªãŸã¨ã„ã†å­˜åœ¨ã®æ ¸ã¨ãªã‚‹ã€3ã¤ã®äººæ ¼OSã‚’ç‰¹å®šã—ã¾ã™ã€‚
        </p>
      </header>
      <div id="diagnostic-container"></div>
    </div>

    <template id="os-card-template">
      <div class="p-6 bg-gray-900/50 rounded-xl border-t-4">
        <h4 class="text-xl font-bold flex items-center gap-2">
          <span class="text-3xl" data-role-icon></span>
          <span data-role-label></span>ï¼š<span data-os-name></span>
        </h4>
        <p class="mt-2 text-gray-400" data-os-catchphrase></p>
        <details class="mt-4 group">
          <summary
            class="cursor-pointer text-indigo-300 font-semibold hover:text-indigo-200 transition"
          >
            OSé‹ç”¨ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã‚’é–‹ã
          </summary>
          <div class="mt-4 pl-4 border-l-2 border-indigo-700/50 space-y-6">
            <div class="p-4 bg-gray-800/50 rounded-lg">
              <p class="font-semibold text-sky-300">â–  é™°ã®æ©Ÿèƒ½</p>
              <p class="text-xs mt-1 text-gray-400" data-yin-mode></p>
            </div>
            <div class="p-4 bg-gray-800/50 rounded-lg">
              <p class="font-semibold text-amber-300">â–  é™½ã®æ©Ÿèƒ½</p>
              <p class="text-xs mt-1 text-gray-400" data-yang-mode></p>
            </div>
            <div class="p-4 bg-emerald-900/30 rounded-lg">
              <p class="font-semibold text-green-300">â–  æˆ¦ç•¥ã‚µãƒãƒªãƒ¼</p>
              <p class="text-xs mt-1 text-gray-300" data-strategic-summary></p>
            </div>
          </div>
        </details>
      </div>
    </template>

    <script type="module">
      import {
        WORLDVIEW_QUESTIONS,
        SCENARIO_QUESTIONS,
      } from "./js/questions.js";

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          const response = await fetch("/api/data");
          if (!response.ok)
            throw new Error("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          const { HAQEI_DATA } = await response.json();
          const HDB = HAQEI_DATA;

          const manualById = Object.fromEntries(
            Object.values(HDB.os_manual).map((m) => [String(m.hexagram_id), m])
          );

          const state = {
            trigramScores: null,
            worldviewHexScores: {},
            engineCandidates: [],
            selectedEngineOsIds: [],
            lockedEngineOs: null,
          };

          const diagnosticContainer = document.getElementById(
            "diagnostic-container"
          );

          function showIntro() {
            diagnosticContainer.innerHTML = `<div class="text-center bg-gray-900/50 p-6 rounded-xl prose-custom max-w-none text-gray-300"><p class="text-lg">ã‚ˆã†ã“ãã€‚ã“ã‚Œã‹ã‚‰ã€ã‚ãªãŸã ã‘ã®ã€ŒOSè¨­è¨ˆå›³ã€ã‚’å‰µã‚‹ãŸã‚ã®ã€å¯¾è©±ã‚’å§‹ã‚ã¾ã™ã€‚</p><p class="mt-6">HaQeiã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã¯ã€3ã¤ã®ã‚¹ãƒ†ãƒƒãƒ—ã§ã€ã‚ãªãŸã®é­‚ã®è¨­è¨ˆå›³ã‚’å…±åŒã§æ§‹ç¯‰ã—ã¾ã™ã€‚</p><div class="grid md:grid-cols-3 gap-6 my-6 text-left"><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-amber-300 flex items-center"><span class="text-xl mr-2">1</span>ä¾¡å€¤è¦³ã®æ˜ç¢ºåŒ–</h4><p class="text-xs mt-2">ã¾ãšã€ã„ãã¤ã‹ã®å•ã„ã‹ã‚‰ã€ã‚ãªãŸã®æ ¸ã¨ãªã‚‹8ã¤ã®åŸºæœ¬ã‚¨ãƒãƒ«ã‚®ãƒ¼ã®ãƒãƒ©ãƒ³ã‚¹ã‚’åˆ†æã—ã¾ã™ã€‚</p></div><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-indigo-300 flex items-center"><span class="text-xl mr-2">2</span>ã‚¨ãƒ³ã‚¸ãƒ³OSã®é¸æŠ</h4><p class="text-xs mt-2">æ¬¡ã«ã€æç¤ºã•ã‚ŒãŸå€™è£œã®ä¸­ã‹ã‚‰ã€ã‚ãªãŸã®æ„Ÿè¦šã«æœ€ã‚‚è¿‘ã„<strong class="text-white">ã€Œã‚¨ãƒ³ã‚¸ãƒ³OSã€ã‚’ã‚ãªãŸè‡ªèº«ãŒé¸æŠ</strong>ã—ã¾ã™ã€‚</p></div><div class="bg-gray-800/70 p-4 rounded-lg border border-gray-700"><h4 class="font-bold text-green-300 flex items-center"><span class="text-xl mr-2">3</span>è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç‰¹å®š</h4><p class="text-xs mt-2">ã‚ãªãŸã®é¸æŠã‚’åŸºã«ã€æ®‹ã‚Šã®OSã‚’ç‰¹å®šã—ã€<strong class="text-white">æˆ¦ç•¥ãƒ¬ãƒãƒ¼ãƒˆ</strong>ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p></div></div><p>ã‚ãªãŸã®æ„Ÿè¦šã“ããŒã€æœ€ã‚‚ä¿¡é ¼ã§ãã‚‹ç¾…é‡ç›¤ã§ã™ã€‚ã©ã†ãã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦ã€å¯¾è©±ã‚’æ¥½ã—ã‚“ã§ãã ã•ã„ã€‚</p></div><div class="mt-8 pt-8 border-t border-gray-700 text-center"><button id="startBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105">å¯¾è©±ã‚’é–‹å§‹ã™ã‚‹</button></div>`;
            document
              .getElementById("startBtn")
              .addEventListener("click", showWorldviewQuestions);
          }

          function showWorldviewQuestions() {
            let html = `<h3 class="text-xl font-bold text-amber-300 mb-6 text-center">Step 1ï¼šã‚ãªãŸã®ä¾¡å€¤è¦³ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„</h3>`;
            WORLDVIEW_QUESTIONS.forEach((q, index) => {
              const worldviewOpts = q.options
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}" value="${i}" id="${q.id}_${i}" class="hidden"><label for="${q.id}_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              html += `<div class="diagnostic-item"><div class="question-block"><p class="question-text">${
                index + 1
              }. ${
                q.text
              }</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">${worldviewOpts}</div></div></div>`;
            });
            html += `<div class="mt-8 text-center"><button id="analyzeEnergyBtn" class="w-full sm:w-auto bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300">ã‚¨ãƒãƒ«ã‚®ãƒ¼ãƒãƒ©ãƒ³ã‚¹ã‚’åˆ†æã—ã€OSå€™è£œã‚’ç”Ÿæˆ</button></div>`;
            diagnosticContainer.innerHTML = html;
            document
              .getElementById("analyzeEnergyBtn")
              .addEventListener("click", handleEnergyAnalysis);
          }

          function showEngineCandidateSelection() {
            let html = `
              <div class="text-center">
                <h3 class="text-xl font-bold text-indigo-300 mb-4">Step 2-Aï¼šã‚¨ãƒ³ã‚¸ãƒ³OSå€™è£œã®çµã‚Šè¾¼ã¿</h3>
                <div class="bg-gray-900/50 p-6 rounded-xl prose-custom max-w-none text-gray-300">
                  <p>ã‚ãªãŸã®ä¾¡å€¤è¦³ã®åˆ†æã«åŸºã¥ãã€ã‚¨ãƒ³ã‚¸ãƒ³OSã®å€™è£œãŒ4ã¤ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ä»¥ä¸‹ã®ã‚«ãƒ¼ãƒ‰ã‚’èª­ã¿ã€æœ€ã‚‚ã€Œè…‘ã«è½ã¡ã‚‹ã€ã¨æ„Ÿã˜ã‚‹ã‚‚ã®ã‚’ã€<strong>1ã¤ã‹2ã¤</strong>é¸ã‚“ã§ãã ã•ã„ã€‚</p>
                  <p class="text-xs text-gray-400 mt-2">ğŸ’¡ å„ã‚«ãƒ¼ãƒ‰ã®ä¸‹ã«ã‚ã‚‹ã€Œé©åˆç‡ã€ã¯ã€ã‚ãªãŸã®ä¾¡å€¤è¦³ã¨ã€å„OSã‚’æ§‹æˆã™ã‚‹8ã¤ã®åŸºæœ¬ã‚¨ãƒãƒ«ã‚®ãƒ¼ã¨ã®è¦ªå’Œæ€§ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ã€Œè©³ç´°ã€ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®OSãŒç¤¾ä¼šã§æ‹…ã„ã‚„ã™ã„å½¹å‰²ã®ä¾‹ã‚’è¦‹ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚</p>
                </div>
                <div id="engine-candidate-wrapper" class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">`;

            state.engineCandidates.forEach((os) => {
              const osManual = manualById[String(os.hexagram_id)] || {};
              const keyword = osManual.keyword_short || "???";
              const icon = osManual.archetype_icon || "â“";
              const strategicRoles = osManual.strategic_roles || [];

              // --- â‘¤ é©åˆç‡ãƒãƒ¼ç”Ÿæˆãƒ­ã‚¸ãƒƒã‚¯ ---
              const trigramProfile = Object.entries(state.trigramScores).map(
                ([id, score]) => ({ id: parseInt(id), score })
              );
              const maxScore = Math.max(
                ...trigramProfile.map((t) => t.score),
                1
              );

              const barsHtml = trigramProfile
                .sort((a, b) => a.id - b.id)
                .map((trigram) => {
                  const percentage = (trigram.score / maxScore) * 100;
                  const isHighlight =
                    os.upper_trigram_id === trigram.id ||
                    os.lower_trigram_id === trigram.id;
                  const color = HDB.trigrams_master.find(
                    (t) => t.trigram_id === trigram.id
                  )?.color_code;
                  const highlightClass = isHighlight ? "bar-highlight" : "";
                  const barStyle = `width:${percentage}%;
+                   background-color:${color ?? "#4b5563"};
+                   box-shadow:${
                    isHighlight ? `0 0 8px ${color}, 0 0 12px ${color}` : "none"
                  };`;

                  return `
                  <div class="trigram-name">${
                    HDB.trigrams_master.find((t) => t.trigram_id === trigram.id)
                      ?.name_jp
                  }</div>
                  <div class="bar-container">
                    <div class="bar-fill" style="${barStyle}" title="ã‚¹ã‚³ã‚¢: ${trigram.score.toFixed(
                    1
                  )}"></div>
                  </div>`;
                })
                .join("");

              html += `
                <div id="card-select-${os.hexagram_id}" data-id="${
                os.hexagram_id
              }" class="engine-card" role="button" tabindex="0" aria-pressed="false" aria-label="å€™è£œOSï¼š${
                os.name_jp
              }">
                    <div class="card-content">
                        <header class="engine-card-header">
                            <span role="img" aria-label="${keyword}" class="archetype-icon">${icon}</span>
                            <div><h4 class="archetype-name">${
                              os.name_jp
                            }</h4><span class="text-xs text-indigo-300 font-semibold">${keyword}</span></div>
                        </header>
                        <p class="text-sm text-gray-300 mt-3 flex-grow">${
                          osManual.summary || "è§£èª¬æº–å‚™ä¸­..."
                        }</p>

                        <details class="mt-4 text-xs">
                          <summary class="text-indigo-400 hover:text-indigo-200">ã“ã®OSãŒæ‹…ã„ã‚„ã™ã„å½¹å‰²ï¼ˆè©³ç´°ï¼‰</summary>
                          <ul class="mt-2 space-y-1 text-slate-300 list-disc list-inside bg-black/20 p-3 rounded-md">
                            ${strategicRoles
                              .map((role) => `<li>${role}</li>`)
                              .join("")}
                          </ul>
                        </details>

                        <div class="mt-4 pt-4 border-t border-gray-700/50">
                            <p class="text-xs font-semibold text-gray-400 mb-2">ä¾¡å€¤è¦³ã¨ã®é©åˆç‡</p>
                            <div class="suitability-bars">${barsHtml}</div>
                        </div>

                    </div>
                </div>`;
            });
            html += `</div><div class="mt-8 text-center"><button id="nextToCompareBtn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed" disabled>é¸æŠã—ãŸOSã‚’æ¯”è¼ƒã™ã‚‹</button></div></div>`;
            diagnosticContainer.innerHTML = html;

            document
              .querySelectorAll(".engine-card")
              .forEach((card) =>
                card.addEventListener("click", handleCandidateToggle)
              );
            document
              .getElementById("nextToCompareBtn")
              .addEventListener("click", showEngineComparison);
          }
          function showEngineComparison() {
            if (state.selectedEngineOsIds.length === 0) {
              console.warn("æ¯”è¼ƒã™ã‚‹OSãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
              return;
            }
            if (state.selectedEngineOsIds.length === 1) {
              const selectedId = state.selectedEngineOsIds[0];
              handleEngineLockIn({
                currentTarget: { dataset: { id: selectedId } },
              });
              return;
            }
            const [idA, idB] = state.selectedEngineOsIds;
            const osA = HDB.hexagrams_master.find((h) => h.hexagram_id === idA);
            const osB = HDB.hexagrams_master.find((h) => h.hexagram_id === idB);

            const createComparisonCard = (os) => {
              const osManual = manualById[String(os.hexagram_id)] || {};
              return `<div class="p-6 bg-gray-900/50 rounded-xl flex flex-col">
                              <h4 class="text-2xl font-bold text-center mb-4">${
                                os.name_jp
                              }</h4>
                              <p class="text-center text-sm text-gray-400 mb-4 flex-grow">${
                                osManual.summary || ""
                              }</p>
                              <button class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition lock-in-btn mt-auto" data-id="${
                                os.hexagram_id
                              }">
                                  ã“ã‚Œã‚’ã‚¨ãƒ³ã‚¸ãƒ³OSã¨ã—ã¦ãƒ­ãƒƒã‚¯ã‚¤ãƒ³
                              </button>
                           </div>`;
            };

            let html = `<div class="text-center">
                            <h3 class="text-xl font-bold text-indigo-300 mb-4">Step 2-Bï¼šæœ€çµ‚æ±ºå®š</h3>
                             <p class="text-sm text-gray-400 mb-6">ã‚ãªãŸãŒé¸ã‚“ã 2ã¤ã®OSã®æ ¸å¿ƒçš„ãªä¾¡å€¤è¦³ã‚’æ¯”è¼ƒã—ã¾ã™ã€‚ã‚ˆã‚Šã€Œã“ã‚Œã“ããŒè‡ªåˆ†ã ã€ã¨å¼·ãæ„Ÿã˜ã‚‹æ–¹ã‚’ã€ã‚ãªãŸã®**ã‚¨ãƒ³ã‚¸ãƒ³OS**ã¨ã—ã¦ãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã—ã¦ãã ã•ã„ã€‚</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                ${createComparisonCard(osA)}
                                ${createComparisonCard(osB)}
                            </div>
                           <button id="backToSelectionBtn" class="mt-8 text-sm text-gray-400 hover:text-white underline">â† å€™è£œã‚’é¸ã³ç›´ã™</button>
                         </div>`;
            diagnosticContainer.innerHTML = html;
            document
              .querySelectorAll(".lock-in-btn")
              .forEach((btn) =>
                btn.addEventListener("click", handleEngineLockIn)
              );
            document
              .getElementById("backToSelectionBtn")
              .addEventListener("click", showEngineCandidateSelection);
          }

          function showScenarioQuestions() {
            let html = `<h3 class="text-xl font-bold text-indigo-300 mb-6 text-center">Step 3ï¼šã‚ãªãŸã®è¡Œå‹•ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã¤ã„ã¦æ•™ãˆã¦ãã ã•ã„</h3>`;
            html += `<p class="text-center text-sm text-gray-400 mb-6">ã‚¨ãƒ³ã‚¸ãƒ³OSã€${state.lockedEngineOs.name_jp}ã€‘ãŒãƒ­ãƒƒã‚¯ã‚¤ãƒ³ã•ã‚Œã¾ã—ãŸã€‚æ¬¡ã«ã€ç¤¾ä¼šçš„ãªå ´é¢ã‚„ã‚¹ãƒˆãƒ¬ã‚¹ä¸‹ã§ã®ã‚ãªãŸã®æŒ¯ã‚‹èˆã„ã‚’åˆ†æã—ã€æ®‹ã‚Šã®OSã‚’ç‰¹å®šã—ã¾ã™ã€‚</p>`;
            SCENARIO_QUESTIONS.forEach((q, index) => {
              const innerOpts = q.options.inner
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}_inner" value="${i}" id="${q.id}_inner_${i}" class="hidden"><label for="${q.id}_inner_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              const outerOpts = q.options.outer
                .map(
                  (opt, i) =>
                    `<div><input type="radio" name="${q.id}_outer" value="${i}" id="${q.id}_outer_${i}" class="hidden"><label for="${q.id}_outer_${i}" class="option-label">${opt.text}</label></div>`
                )
                .join("");
              html += `<div class="diagnostic-item"><p class="text-gray-400 text-sm">ã‚·ãƒŠãƒªã‚ª ${
                index + 1
              }/${
                SCENARIO_QUESTIONS.length
              }</p><p class="font-semibold text-gray-200 mb-4">${
                q.scenario
              }</p><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div class="question-block"><p class="question-text">${
                q.inner_q
              }</p><div class="space-y-3 mt-4">${innerOpts}</div></div><div class="question-block"><p class="question-text">${
                q.outer_q
              }</p><div class="space-y-3 mt-4">${outerOpts}</div></div></div></div>`;
            });
            html += `<div class="mt-8 pt-8 border-t border-gray-700">
                      <div class="text-center">
                        <label class="flex items-center justify-center cursor-pointer">
                          <input type="checkbox" id="agreementCheckbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
                          <span class="ml-2 text-sm text-gray-400">
                              <a href="/terms.html" target="_blank" class="underline hover:text-white">åˆ©ç”¨è¦ç´„</a>ãŠã‚ˆã³<a href="/privacy.html" target="_blank" class="underline hover:text-white">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a>ã«åŒæ„ã—ã¾ã™
                          </span>
                        </label>
                      </div>
                      <button id="finalAnalyzeBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105 mt-6 disabled:opacity-50 disabled:cursor-not-allowed" disabled>æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã™ã‚‹</button>
                     </div>`;
            diagnosticContainer.innerHTML = html;
            const finalAnalyzeBtn = document.getElementById("finalAnalyzeBtn");
            const finalAgreementCheckbox =
              document.getElementById("agreementCheckbox");
            finalAnalyzeBtn.disabled = true;
            finalAgreementCheckbox.addEventListener("change", () => {
              finalAnalyzeBtn.disabled = !finalAgreementCheckbox.checked;
            });
            finalAnalyzeBtn.addEventListener("click", handleFinalAnalysis);
          }

          function displayReport(analysisResult) {
            diagnosticContainer.innerHTML = "";
            const { engineOs, interfaceOs, safemodeOs } = analysisResult;
            let reportHtml = `<div class="text-center space-y-12">
                                  <div class="report-section">
                                    <h3 class="text-3xl font-bold text-indigo-300">ã‚ãªãŸã®3ã¤ã®äººæ ¼OS</h3>
                                    <div class="mt-4 p-4 bg-gray-900/50 rounded-xl"><h4 class="font-bold text-yellow-300">ã€é‡è¦ã€‘é™°é™½ã«ã¤ã„ã¦ã®æ³¨æ„ç‚¹</h4><p class="text-xs text-gray-400 mt-2">ã“ã‚Œã‹ã‚‰è¡¨ç¤ºã•ã‚Œã‚‹ã€Œé™°ã®æ©Ÿèƒ½ã€ã€Œé™½ã®æ©Ÿèƒ½ã€ã¯ã€ã€Œè‰¯ã„/æ‚ªã„ã€ã¨ã„ã£ãŸä¾¡å€¤åˆ¤æ–­ã‚’å…¨ãå«ã¿ã¾ã›ã‚“ã€‚<br>ã€Œé™°ã€ã¯ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå†…å´ã¸å‘ã‹ã†ã€Œé™ãƒ»å—å‹•ãƒ»è“„ç©ã€ã®æ©Ÿèƒ½ã€ã€Œé™½ã€ã¯ã‚¨ãƒãƒ«ã‚®ãƒ¼ãŒå¤–å´ã¸å‘ã‹ã†ã€Œå‹•ãƒ»èƒ½å‹•ãƒ»ç™ºæ•£ã€ã®æ©Ÿèƒ½ã‚’ç¤ºã—ã¾ã™ã€‚<br>ã‚ãªãŸã®OSã®æ€§èƒ½ã‚’æœ€å¤§åŒ–ã™ã‚‹ã«ã¯ã€ã“ã®ä¸¡æ–¹ã®ãƒ¢ãƒ¼ãƒ‰ã‚’ç†è§£ã—ã€çŠ¶æ³ã«å¿œã˜ã¦è‡ªåœ¨ã«ä½¿ã„åˆ†ã‘ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚</p></div>
                                    <div id="os-cards-container" class="mt-8 space-y-6 text-left"></div>
                                  </div>
                                  <div class="mt-16 pt-8 border-t-2 border-dashed border-gray-700"><h3 class="text-xl font-bold text-amber-300 mb-4">æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸</h3><div class="mt-8"><a href="future_simulator.html" class="bg-amber-500 hover:bg-amber-600 text-gray-900 font-bold py-3 px-8 rounded-lg text-lg transition duration-300 transform hover:scale-105">æœªæ¥åˆ†å²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã€å…·ä½“çš„ãªèª²é¡Œã‚’åˆ†æã™ã‚‹ &rarr;</a></div></div>
                                </div>`;
            diagnosticContainer.innerHTML = reportHtml;

            const osCardsContainer =
              document.getElementById("os-cards-container");
            const template = document.getElementById("os-card-template");

            const createOsCard = (os, role) => {
              if (!os) return null;
              const clone = template.content.cloneNode(true);
              const card = clone.querySelector("div");
              const roleInfo = {
                engine: { label: "ã‚¨ãƒ³ã‚¸ãƒ³OS", color: "#F87171", icon: "ğŸ”¥" },
                interface: {
                  label: "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹OS",
                  color: "#60A5FA",
                  icon: "ğŸ­",
                },
                safemode: {
                  label: "ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰OS",
                  color: "#9CA3AF",
                  icon: "ğŸ›¡ï¸",
                },
              };
              const info = roleInfo[role];
              const manual = manualById[String(os.hexagram_id)] || {};
              card.style.borderColor = info.color;
              card.querySelector("[data-role-icon]").textContent = info.icon;
              card.querySelector("[data-role-label]").textContent = info.label;
              card.querySelector("[data-os-name]").textContent = os.name_jp;
              card.querySelector("[data-os-catchphrase]").textContent =
                os.catchphrase;
              card.querySelector("[data-yin-mode]").textContent =
                manual.defensive_use || "è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
              card.querySelector("[data-yang-mode]").textContent =
                manual.proactive_use || "è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
              card.querySelector("[data-strategic-summary]").textContent =
                manual.summary || "è¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
              return card;
            };

            [engineOs, interfaceOs, safemodeOs].forEach((os, index) => {
              const role = ["engine", "interface", "safemode"][index];
              const cardElement = createOsCard(os, role);
              if (cardElement) osCardsContainer.appendChild(cardElement);
            });
          }

          function handleEnergyAnalysis() {
            if (
              !Array.from(
                document.querySelectorAll('input[name^="wvq"]')
              ).every((r) =>
                document.querySelector(`input[name="${r.name}"]:checked`)
              )
            ) {
              alert("Step 1ã®ã™ã¹ã¦ã®è³ªå•ã«å›ç­”ã—ã¦ãã ã•ã„ã€‚");
              return;
            }
            state.trigramScores = runTrigramAnalysis();
            state.engineCandidates = getEngineCandidates(state.trigramScores);
            showEngineCandidateSelection();
          }

          function handleCandidateToggle(event) {
            const card = event.currentTarget;
            const id = parseInt(card.dataset.id);
            const isSelected = card.classList.contains("candidate-selected");
            let currentSelection = [...state.selectedEngineOsIds];
            if (isSelected) {
              currentSelection = currentSelection.filter(
                (selectedId) => selectedId !== id
              );
            } else {
              if (currentSelection.length >= 2) {
                const removedId = currentSelection.shift();
                const removedCard = document.getElementById(
                  `card-select-${removedId}`
                );
                if (removedCard) {
                  removedCard.classList.remove("candidate-selected");
                  removedCard.setAttribute("aria-pressed", "false");
                }
              }
              currentSelection.push(id);
            }
            state.selectedEngineOsIds = currentSelection;
            card.classList.toggle("candidate-selected", !isSelected);
            card.setAttribute("aria-pressed", String(!isSelected));
            const nextBtn = document.getElementById("nextToCompareBtn");
            nextBtn.disabled = currentSelection.length === 0;
            if (currentSelection.length === 1) {
              nextBtn.textContent = "ã“ã®OSã§æœ€çµ‚æ±ºå®šã™ã‚‹";
            } else {
              nextBtn.textContent = "é¸æŠã—ãŸOSã‚’æ¯”è¼ƒã™ã‚‹";
            }
          }

          function handleEngineLockIn(event) {
            const id = parseInt(event.currentTarget.dataset.id);
            const os = HDB.hexagrams_master.find((h) => h.hexagram_id === id);
            if (os) {
              state.lockedEngineOs = os;
              showScenarioQuestions();
            }
          }

          function handleFinalAnalysis() {
            if (
              !Array.from(SCENARIO_QUESTIONS).every(
                (q) =>
                  document.querySelector(
                    `input[name="${q.id}_inner"]:checked`
                  ) &&
                  document.querySelector(`input[name="${q.id}_outer"]:checked`)
              )
            ) {
              alert("Step 3ã®ã™ã¹ã¦ã®ã‚·ãƒŠãƒªã‚ªã«å›ç­”ã—ã¦ãã ã•ã„ã€‚");
              return;
            }
            const { interfaceOs, safemodeOs } = determineInterfaceAndSafemode();
            const finalResult = {
              engineOs: state.lockedEngineOs,
              interfaceOs,
              safemodeOs,
            };
            displayReport(finalResult);
            try {
              localStorage.setItem(
                "haqeiOsAnalyzerData",
                JSON.stringify(finalResult)
              );
            } catch (e) {
              console.error("OSåˆ†æãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
            }
          }

          function runTrigramAnalysis() {
            const scores = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0, 6: 0, 7: 0, 8: 0 };
            const worldviewHexScores = {};
            WORLDVIEW_QUESTIONS.forEach((q) => {
              const node = document.querySelector(
                `input[name="${q.id}"]:checked`
              );
              const choice = q.options[node.value];
              for (const id in choice.scores) {
                if (parseInt(id) <= 8)
                  scores[id] = (scores[id] || 0) + choice.scores[id];
                else
                  worldviewHexScores[id] =
                    (worldviewHexScores[id] || 0) + choice.scores[id];
              }
            });
            state.worldviewHexScores = worldviewHexScores;
            return scores;
          }

          function getEngineCandidates(baseScores) {
            const sortedRootTrigrams = Object.entries(baseScores).sort(
              (a, b) => b[1] - a[1]
            );
            const rootTrigram1 = parseInt(sortedRootTrigrams[0][0]);
            const candidates = HDB.hexagrams_master
              .map((hex) => {
                let score = state.worldviewHexScores[hex.hexagram_id] || 0;
                if (hex.upper_trigram_id === rootTrigram1) score += 5;
                if (hex.lower_trigram_id === rootTrigram1) score += 5;
                const diversityBoost =
                  hex.upper_trigram_id !== rootTrigram1 &&
                  hex.lower_trigram_id !== rootTrigram1
                    ? 1.5
                    : 0;
                score += diversityBoost;
                return { ...hex, score };
              })
              .sort((a, b) => {
                if (a.score !== b.score) return b.score - a.score;
                return a.hexagram_id - b.hexagram_id;
              });
            const finalCandidates = [];
            const usedTrigramCombos = new Set();
            for (const os of candidates) {
              const combo1 = `${os.upper_trigram_id}-${os.lower_trigram_id}`;
              const combo2 = `${os.lower_trigram_id}-${os.upper_trigram_id}`;
              if (
                !usedTrigramCombos.has(combo1) &&
                !usedTrigramCombos.has(combo2)
              ) {
                finalCandidates.push(os);
                usedTrigramCombos.add(combo1);
              }
              if (finalCandidates.length >= 4) break;
            }
            return finalCandidates;
          }

          function determineInterfaceAndSafemode() {
            const scenarioTrigramScores = {
              1: 0,
              2: 0,
              3: 0,
              4: 0,
              5: 0,
              6: 0,
              7: 0,
              8: 0,
            };
            SCENARIO_QUESTIONS.forEach((q) => {
              const innerNode = document.querySelector(
                `input[name="${q.id}_inner"]:checked`
              );
              const outerNode = document.querySelector(
                `input[name="${q.id}_outer"]:checked`
              );
              const innerChoice = q.options.inner[innerNode.value];
              for (const id in innerChoice.scores) {
                scenarioTrigramScores[id] =
                  (scenarioTrigramScores[id] || 0) + innerChoice.scores[id];
              }
              const outerChoice = q.options.outer[outerNode.value];
              for (const id in outerChoice.scores) {
                scenarioTrigramScores[id] =
                  (scenarioTrigramScores[id] || 0) + outerChoice.scores[id];
              }
            });
            const finalOsScores = {};
            HDB.hexagrams_master.forEach((hex) => {
              if (hex.hexagram_id === state.lockedEngineOs.hexagram_id) return;
              const scenarioScore =
                (scenarioTrigramScores[hex.upper_trigram_id] || 0) +
                (scenarioTrigramScores[hex.lower_trigram_id] || 0);
              let worldviewCompatibilityScore = 0;
              if (state.trigramScores[hex.upper_trigram_id])
                worldviewCompatibilityScore +=
                  state.trigramScores[hex.upper_trigram_id];
              if (state.trigramScores[hex.lower_trigram_id])
                worldviewCompatibilityScore +=
                  state.trigramScores[hex.lower_trigram_id];
              finalOsScores[hex.hexagram_id] =
                scenarioScore * 0.7 + worldviewCompatibilityScore * 0.3;
            });
            const sortedFinalOs = Object.entries(finalOsScores)
              .sort(([, a], [, b]) => b - a)
              .map(([id, score]) => ({
                ...HDB.hexagrams_master.find((h) => h.hexagram_id == id),
                score,
              }));
            return {
              interfaceOs: sortedFinalOs[0],
              safemodeOs: sortedFinalOs[1],
            };
          }

          showIntro();
        } catch (error) {
          console.error("åˆæœŸåŒ–ã«å¤±æ•—:", error);
          document.getElementById(
            "diagnostic-container"
          ).innerHTML = `<div class="text-center text-red-400 p-8">ãƒšãƒ¼ã‚¸ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}</div>`;
        }
      });
    </script>
  </body>
</html>
