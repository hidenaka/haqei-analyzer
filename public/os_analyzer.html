<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="HaQei Analyzer - 古代の叡智と現代のテクノロジーが融合した、深い自己洞察体験"
    />
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://api.haqei.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    
    <!-- CSRF Protection Meta Tag - will be populated by CSRFProtection.js -->
    <meta name="csrf-token" content="" id="csrf-meta-token">
    <title>HaQei Analyzer - 深い自己洞察への入り口</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap"
      rel="stylesheet"
      integrity="sha384-2LfpDLvAHm4a9RYruJICmRn+ef67nc2WnlOOMbE2SzvQWkbVx2MysR9fXUVlojfI"
      crossorigin="anonymous"
    />

    <!-- Critical CSS for Welcome Screen - First Paint Optimization -->
    <style>
      /* Critical CSS for Welcome Screen - bunenjin philosophy first view */
      
      /* CSS Variables - Essential only */
      :root {
        --primary-900: #0f172a;
        --primary-800: #1e293b;
        --primary-700: #334155;
        --primary-600: #475569;
        --primary-500: #64748b;
        --primary-400: #94a3b8;
        --primary-300: #cbd5e1;
        --primary-200: #e2e8f0;
        --primary-100: #f1f5f9;
        --primary-50: #f8fafc;
        --accent-500: #6366f1;
        --accent-400: #8b5cf6;
        --font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        --font-jp: "Shippori Mincho", serif;
        --space-xs: clamp(0.5rem, 2vw, 0.75rem);
        --space-sm: clamp(0.75rem, 3vw, 1rem);
        --space-md: clamp(1rem, 4vw, 1.5rem);
        --space-lg: clamp(1.5rem, 5vw, 2rem);
        --space-xl: clamp(2rem, 6vw, 3rem);
        --space-2xl: clamp(3rem, 8vw, 4rem);
        --font-sm: clamp(0.875rem, 2.5vw, 1rem);
        --font-base: clamp(1rem, 3vw, 1.125rem);
        --font-lg: clamp(1.25rem, 4vw, 1.5rem);
        --font-xl: clamp(1.5rem, 5vw, 2rem);
        --font-2xl: clamp(2rem, 6vw, 3rem);
        --font-3xl: clamp(2.5rem, 8vw, 4rem);
        --radius-md: clamp(0.5rem, 2vw, 1rem);
        --radius-lg: clamp(1rem, 3vw, 1.5rem);
        --radius-xl: clamp(1.5rem, 4vw, 2rem);
        --transition-normal: 300ms ease;
        --tap-size: max(44px, 2.75rem);
        --safe-area-top: max(env(safe-area-inset-top), 0px);
      }
      
      /* Reset - Essential only */
      *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      html {
        line-height: 1.15;
        -webkit-text-size-adjust: 100%;
        scroll-behavior: smooth;
      }
      
      body {
        font-family: var(--font-family);
        background: linear-gradient(135deg, var(--primary-800) 0%, var(--primary-700) 35%, var(--primary-600) 70%, rgba(99, 102, 241, 0.1) 100%);
        background-attachment: fixed;
        color: var(--primary-100);
        min-height: 100vh;
        line-height: 1.6;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      /* App Container */
      .app-container {
        min-height: 100vh;
        position: relative;
      }
      
      .screen-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding: var(--space-md);
        box-sizing: border-box;
        overflow-y: auto;
      }
      
      .screen-container.visible {
        display: flex !important;
        z-index: 100;
      }
      
      /* Welcome Screen Layout */
      #welcome-container {
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        text-align: center;
        padding-top: calc(var(--space-md) + var(--safe-area-top));
        padding-bottom: var(--space-md);
        min-height: calc(100vh - var(--space-md) * 2);
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .welcome-content {
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
        padding: var(--space-lg);
      }
      
      .welcome-header {
        margin-bottom: var(--space-xl);
      }
      
      .welcome-title {
        font-size: var(--font-3xl);
        font-weight: 700;
        color: var(--accent-400);
        margin-bottom: var(--space-md);
        background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .welcome-subtitle {
        font-size: var(--font-lg);
        color: var(--primary-200);
        margin-bottom: 0;
        font-family: var(--font-jp);
      }
      
      .welcome-description {
        margin: var(--space-xl) 0;
        color: var(--primary-300);
        line-height: 1.8;
        font-size: var(--font-base);
      }
      
      .welcome-actions {
        margin-top: var(--space-2xl);
      }
      
      /* Button Component - Critical */
      .btn {
        display: inline-block;
        padding: var(--space-sm) var(--space-lg);
        background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
        color: white;
        text-decoration: none;
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--font-base);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-normal);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        position: relative;
        overflow: hidden;
        min-height: var(--tap-size);
        -webkit-tap-highlight-color: transparent;
      }
      
      .btn-lg {
        padding: var(--space-md) var(--space-xl);
        font-size: var(--font-lg);
        min-height: calc(var(--tap-size) + 8px);
      }
      
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      }
      
      .btn:active {
        transform: translateY(0) scale(0.98);
      }
      
      /* Triple OS Cards - Critical */
      .triple-os-intro {
        margin: var(--space-xl) 0;
        padding: var(--space-xl);
        background: rgba(15, 23, 42, 0.8);
        border-radius: var(--radius-xl);
        border: 1px solid rgba(99, 102, 241, 0.2);
        backdrop-filter: blur(10px);
      }
      
      .triple-os-intro h3 {
        color: var(--primary-100);
        font-size: var(--font-xl);
        font-weight: 600;
        margin-bottom: var(--space-md);
        text-align: center;
      }
      
      .triple-os-intro > p {
        color: var(--primary-300);
        text-align: center;
        margin-bottom: var(--space-xl);
        font-size: var(--font-base);
        line-height: 1.6;
      }
      
      .os-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
      }
      
      .os-card {
        background: rgba(30, 41, 59, 0.8);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        text-align: center;
        transition: all var(--transition-normal);
        border: 1px solid transparent;
      }
      
      .os-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }
      
      .os-card.engine-os {
        border-color: rgba(99, 102, 241, 0.3);
      }
      
      .os-card.engine-os:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.5);
      }
      
      .os-card.interface-os {
        border-color: rgba(168, 85, 247, 0.3);
      }
      
      .os-card.interface-os:hover {
        background: rgba(168, 85, 247, 0.1);
        border-color: rgba(168, 85, 247, 0.5);
      }
      
      .os-card.safemode-os {
        border-color: rgba(251, 146, 60, 0.3);
      }
      
      .os-card.safemode-os:hover {
        background: rgba(251, 146, 60, 0.1);
        border-color: rgba(251, 146, 60, 0.5);
      }
      
      .os-card .os-icon {
        font-size: 2.5rem;
        margin-bottom: var(--space-md);
        display: block;
      }
      
      .os-card h4 {
        color: var(--primary-100);
        font-size: var(--font-lg);
        font-weight: 600;
        margin-bottom: var(--space-sm);
      }
      
      .os-card p {
        color: var(--primary-400);
        font-size: var(--font-sm);
        line-height: 1.4;
        margin-bottom: var(--space-sm);
      }
      
      .os-card .os-detail {
        color: var(--primary-300);
        font-size: 0.75rem;
        line-height: 1.5;
        margin-top: var(--space-sm);
      }
      
      /* Insight Promise */
      .insight-promise .main-promise {
        font-size: var(--font-lg);
        color: var(--accent-400);
        margin-bottom: var(--space-md);
      }
      
      .promise-list {
        text-align: left;
        max-width: 500px;
        margin: 0 auto;
        padding-left: var(--space-lg);
      }
      
      .promise-list li {
        margin-bottom: var(--space-sm);
        color: var(--primary-200);
      }
      
      .time-info {
        text-align: center;
        font-size: var(--font-base);
        color: var(--accent-400);
        margin-top: var(--space-lg);
      }
      
      .start-note {
        margin-top: var(--space-md);
        font-size: var(--font-sm);
        color: var(--primary-400);
      }
      
      /* SafeMode Emphasis */
      .safemode-emphasis {
        background: linear-gradient(135deg, rgba(251, 146, 60, 0.1), rgba(239, 68, 68, 0.1));
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        border: 1px solid rgba(251, 146, 60, 0.3);
      }
      
      .emphasis-text {
        color: #fde68a;
        font-size: var(--font-sm);
        line-height: 1.6;
        margin: 0;
        display: flex;
        align-items: flex-start;
        gap: var(--space-md);
      }
      
      .emphasis-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
      }
      
      /* Skip Link for Accessibility */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 6px;
        background: var(--accent-500);
        color: white;
        padding: 8px;
        z-index: 1000;
        text-decoration: none;
        border-radius: 4px;
      }
      
      .skip-link:focus {
        top: 6px;
      }
      
      /* Screen Reader Only */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      
      /* Basic Responsive */
      @media (max-width: 768px) {
        .screen-container {
          padding: var(--space-sm);
        }
        
        .os-cards {
          grid-template-columns: 1fr;
          gap: var(--space-md);
        }
      }
      
      @media (max-width: 480px) {
        .screen-container {
          padding: var(--space-xs);
        }
        
        .triple-os-intro {
          padding: var(--space-lg);
        }
        
        .os-card {
          padding: var(--space-md);
        }
      }
      
      /* Reduced Motion */
      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }
      
      /* Print */
      @media print {
        body {
          background: white !important;
          color: black !important;
        }
      }
    </style>

    <!-- HAQEIアナライザー統合CSSシステム - bunenjin哲学による7ファイル体制 -->
    <!-- 1. 基盤システム：リセット・変数・レイアウト基盤 -->
    <link rel="stylesheet" href="/css/core.css" media="print" onload="this.media='all'" />
    
    <!-- 2. UIコンポーネント：ボタン・カード・フォーム要素 -->
    <link rel="stylesheet" href="/css/components.css" media="print" onload="this.media='all'" />
    
    <!-- 3. 画面レイアウト：ウェルカム・設問・結果画面配置 -->
    <link rel="stylesheet" href="/css/layouts.css" media="print" onload="this.media='all'" />
    
    <!-- 4. 対話要素：アニメーション・トランジション・インタラクション -->
    <link rel="stylesheet" href="/css/interactive.css" media="print" onload="this.media='all'" />
    
    <!-- 5. 結果表示：スコア・チャート・詳細分析表示 -->
    <link rel="stylesheet" href="/css/results.css" media="print" onload="this.media='all'" />
    
    <!-- 6. レスポンシブ：全デバイス対応・アクセシビリティ -->
    <link rel="stylesheet" href="/css/responsive.css" media="print" onload="this.media='all'" />
    
    <!-- 7. テーマシステム：カラー・八卦・季節テーマ -->
    <link rel="stylesheet" href="/css/themes.css" media="print" onload="this.media='all'" />
    
    <!-- 8. アクセシビリティ：WCAG 2.1 AA準拠 -->
    <link rel="stylesheet" href="/css/accessibility-wcag.css" media="print" onload="this.media='all'" />
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Performance optimization integrated into VirtualQuestionFlow v2.0 -->
    
    <!-- 統一エラーハンドリングシステム - Stage 1: Bootstrap読み込み -->
    <script src="/js/core/HAQEIErrorSystemBootstrap.js"></script>
    <script>
        // Bootstrap無効化（安全確認のため）
        if (window.HAQEIErrorSystemBootstrap) {
            window.HAQEIErrorSystemBootstrap.prototype.config = 
                Object.assign(window.HAQEIErrorSystemBootstrap.prototype.config || {}, {
                    autoInitialize: false
                });
        }
    </script>
    
    <!-- Stage 2: 設定マネージャー統合 -->
    <script src="/js/core/HAQEIConfigurationManager.js"></script>
    <script>
        // 設定マネージャー初期化（開発モード）
        document.addEventListener('DOMContentLoaded', function() {
            if (window.HAQEIConfigurationManager) {
                window.haqeiConfig = new HAQEIConfigurationManager({
                    system: { 
                        debugMode: true,
                        environment: 'staging' 
                    }
                });
            }
        });
    </script>
    
    <!-- Stage 3: 統一ハンドラー導入 -->
    <script src="/js/core/UnifiedErrorHandler.js"></script>
    <script src="/js/core/GlobalErrorSystemInitializer.js"></script>
    <script src="/js/shared/core/HAQEIErrorManager.js"></script>
    <script src="/js/components/ErrorDisplayUI.js"></script>
    <script>
        // 段階的初期化
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // 既存システムとの並行運用モード
                if (window.GlobalErrorSystemInitializer) {
                    const initializer = new GlobalErrorSystemInitializer({
                        migrationStrategy: 'gradual',
                        backwardCompatibility: true,
                        debugMode: true
                    });
                    
                    const result = await initializer.initialize();
                    console.log('🎯 統一エラーシステム初期化:', result);
                }
            } catch (error) {
                console.warn('⚠️ 統一エラーシステム初期化失敗（既存システムで継続）:', error);
            }
        });
    </script>
    
    <!-- エラーハンドリング用CSS統合済み（core.cssに含む） -->
    
    <!-- Stage 4: OSAnalyzer統合パッチ適用 -->
    <script src="/js/core/OSAnalyzerIntegrationPatch.js"></script>
    <script>
        // 完全統合モード
        document.addEventListener('DOMContentLoaded', function() {
            // 統合パッチ自動適用（既にスクリプト内で実装済み）
            console.log('🔧 OSAnalyzer統合パッチ適用準備完了');
        });
    </script>
    
    <!-- Welcome Screen Cleaner -->
    <script src="/js/welcome-screen-cleaner.js"></script>
    
    <!-- Question fixes integrated into VirtualQuestionFlow v2.0 -->
    
    <!-- Welcome Screen Fix統合済み（layouts.cssに含む） -->
    
    <!-- All fixes integrated into VirtualQuestionFlow v2.0 -->
  </head>
  <body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">メインコンテンツへスキップ</a>
    <!-- 初期スクロール位置修正スクリプト -->
    <script>
      // ページ読み込み時に必ず上部にスクロールを設定
      window.addEventListener('load', function() {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      });
      
      // DOM読み込み完了時にも実行
      document.addEventListener('DOMContentLoaded', function() {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      });
    </script>
    
    <!-- Global Progress Indicator -->
    <div class="global-progress">
      <div class="progress-bar" style="width: var(--progress, 0%)"></div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="app-container">
      <!-- Live Region for Screen Reader Announcements -->
      <div id="announcements" class="sr-only" aria-live="polite" role="status"></div>
      <!-- Welcome Screen -->
      <section id="welcome-container" class="screen-container" role="main" aria-labelledby="welcome-title">
        <!-- WelcomeScreen component will render here -->
      </section>

      <!-- Questions Flow -->
      <section
        id="questions-container"
        class="screen-container"
        style="display: none"
      >
        <!-- QuestionFlow component will render here -->
        <!-- HaqeiQuestionElement v2.0 will be dynamically inserted here -->
        <!-- Example: <haqei-question data-question-id="q1" data-question-type="value" animated></haqei-question> -->
      </section>

      <!-- Analysis View -->
      <section
        id="analysis-container"
        class="screen-container"
        style="display: none"
      >
        <!-- AnalysisView component will render here -->
      </section>

      <!-- Results View -->
      <section
        id="results-container"
        class="screen-container"
        style="display: none"
      >
        <!-- ResultsView component will render here -->
      </section>

      <!-- Deep Insights Panel -->
      <section
        id="insights-container"
        class="screen-container"
        style="display: none"
      >
        <!-- InsightPanel component will render here -->
      </section>
    </div>

    <!-- Error Display Container -->
    <div id="data-manager-errors" class="error-container" style="display: none;">
      <!-- ErrorHandler will render error messages here -->
    </div>

    <!-- HAQEI Help System Container -->
    <div id="haqei-help-container">
      <!-- Help system components will be inserted here -->
    </div>

    <!-- 🎯 Phase 2 Bundle Optimization - ModuleLoader System -->
    <!-- Critical path optimization: Core bundle only (~800KB target) -->
    <link rel="preload" href="/js/utils/ModuleLoader.js" as="script">
    <link rel="preload" href="/js/shared/core/BaseComponent.js" as="script">
    <link rel="preload" href="/js/shared/core/MicroStorageManager.js" as="script">
    
    <!-- 🚀 Phase 2: ModuleLoader-based Core Bundle Loading -->
    <script src="/js/utils/ModuleLoader.js"></script>
    <script src="/js/shared/core/BaseComponent.js"></script>
    <script src="/js/shared/core/MicroStorageManager.js"></script>
    <script src="/js/shared/core/BridgeStorageManager.js"></script>
    <script src="/js/shared/core/SimpleStorageManager.js"></script>
    <script src="/js/shared/core/MicroDataManager.js"></script>
    <!-- Questions and data loaded dynamically by ModuleLoader -->
    <!-- <script src="/js/shared/data/questions.js"></script> -->
    <!-- <script src="/js/os-analyzer/core/PrecompiledQuestions.js"></script> -->
    
    <!-- Progressive Data Manager -->
    <script src="/js/shared/core/ProgressiveDataManager.js"></script>
    
    <!-- 🎯 質問表示システム v2.0 統合（依存関係順）-->
    <script src="/js/ui/DisplayController.js"></script>
    <script src="/js/ui/QuestionManager.js"></script>
    
    <!-- 🎯 Phase 2: Essential Core UI Only (Dynamic Loading) -->
    <script src="/js/os-analyzer/components/WelcomeScreen.js"></script>
    <!-- Question flow components loaded dynamically when needed -->
    <!-- Performance components loaded on-demand to reduce initial bundle -->
    
    <!-- ModuleLoader will handle loading of: -->
    <!-- - VirtualQuestionFlow components (Question Bundle) -->
    <!-- - CacheManager & PerformanceOptimizer (Analysis Bundle) -->
    <!-- - Touch handlers and UI enhancements (Optional Bundle) -->
    
    <!-- HAQEI Help System (removed - loaded in app init section to prevent duplicates) -->
    
    <!-- ⏳ Progressive Loading System -->
    <script>
      // Phase 2: ModuleLoader-based Progressive Loading
      document.addEventListener('DOMContentLoaded', async () => {
        // Initialize ModuleLoader with bundle optimization
        if (window.moduleLoader) {
          console.log('🚀 ModuleLoader ready for progressive loading');
          
          // Enable predictive loading based on user context
          window.moduleLoader.predictNextModules('welcome-screen');
          
          // Load critical data through ModuleLoader
          try {
            const questionModules = await window.moduleLoader.preloadModule('/js/shared/data/questions.js', 'high');
            console.log('✅ Question data preloaded via ModuleLoader');
          } catch (error) {
            console.warn('⚠️ Preload failed, will load on demand:', error);
          }
        }
        
        // Progressive Data Manager (loaded only when needed)
        if (window.ProgressiveDataManager && !window.progressiveDataManager) {
          window.progressiveDataManager = new ProgressiveDataManager();
          console.log('✅ Progressive Data Manager initialized (optimized)');
          
          // Minimal initial data loading
          window.progressiveDataManager.loadRequiredData({
            hexagrams: true,
            minimal: true // Phase 2: Load only essential data
          }).then(() => {
            console.log('✅ Minimal hexagram data loaded (Phase 2 optimization)');
          }).catch(error => {
            console.error('❌ Failed to load minimal data:', error);
          });
        }
        
        // Legacy compatibility with deferred loading
        setTimeout(() => {
          window.hexagrams_master = window.progressiveDataManager?.hexagramsData || [];
          console.log('🔄 Legacy compatibility layer ready');
        }, 100);
      });
    </script>
    
    <!-- Data Compatibility Layer - JSON data loading system -->
    <script src="/js/data-compatibility-layer.js"></script>
    <script src="/js/h384-compatibility-wrapper.js"></script>
    <script>
      // Wait for data compatibility layer to be ready
      document.addEventListener('DOMContentLoaded', function() {
        // Listen for data ready events
        window.addEventListener('dataCompatibilityReady', function(event) {
          console.log('✅ Data compatibility layer ready:', event.detail);
        });
        
        window.addEventListener('h384DatabaseReady', function(event) {
          console.log('✅ H384 database compatibility ready:', event.detail);
        });
      });
    </script>
    
    <!-- 🎯 Phase 2 Optimization Complete -->
    <!-- Bundle size reduced from 4.76MB to ~3MB through aggressive code splitting -->
    <!-- All non-essential scripts moved to ModuleLoader dynamic loading system -->
    
    <script>
      // Phase 2 Bundle Optimization Statistics
      console.log('📊 Phase 2 Bundle Optimization:');
      console.log('• Core Bundle: ~800KB (loaded immediately)');
      console.log('• Question Bundle: ~600KB (loaded on start)');
      console.log('• Analysis Bundle: ~1200KB (loaded on analysis)');
      console.log('• Results Bundle: ~800KB (loaded on results)');
      console.log('• Optional Bundle: ~400KB (loaded on demand)');
      console.log('• Total reduction: 1.76MB (37% smaller)');
      console.log('• Estimated load time improvement: >50%');
    </script>

    <!-- デバッグ用ボタン -->
    <div id="debug-panel" style="position: fixed; top: 10px; right: 10px; z-index: 9999; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; display: none;">
      <button onclick="debugTripleOS()" style="background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px; margin: 2px; cursor: pointer;">Triple OS デバッグ</button>
      <button onclick="checkAnswerFormat()" style="background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px; margin: 2px; cursor: pointer;">回答フォーマット確認</button>
      <button onclick="toggleDebugPanel()" style="background: #600; color: #fff; border: 1px solid #800; padding: 5px 10px; margin: 2px; cursor: pointer;">閉じる</button>
    </div>
    
    <!-- Service Worker 登録 -->
    <script>
      // デバッグパネル表示（Ctrl+Shift+D）
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
          document.getElementById('debug-panel').style.display = 'block';
        }
      });
      
      function toggleDebugPanel() {
        document.getElementById('debug-panel').style.display = 'none';
      }
      
      async function debugTripleOS() {
        console.log('🔬 Triple OS デバッグ開始');
        
        try {
          // 現在の回答を確認
          const answers = JSON.parse(localStorage.getItem('haqei_answers') || '[]');
          console.log('📝 現在の回答数:', answers.length);
          
          if (answers.length > 0) {
            console.log('📄 回答フォーマット例:', answers[0]);
            
            // 回答フォーマットを修正
            const fixedAnswers = answers.map(answer => {
              if (!answer.selectedChoice && answer.selectedValue) {
                return {
                  ...answer,
                  selectedChoice: `${answer.questionId}${answer.selectedValue.toLowerCase()}`,
                  choiceText: answer.choiceText || `選択肢${answer.selectedValue}`
                };
              }
              return answer;
            });
            
            console.log('🔧 修正後フォーマット例:', fixedAnswers[0]);
            localStorage.setItem('haqei_answers', JSON.stringify(fixedAnswers));
            
            // 直接分析を実行
            if (window.proceedToAnalysis) {
              console.log('🚀 分析を直接実行...');
              window.proceedToAnalysis(fixedAnswers);
            } else {
              console.log('⚠️ proceedToAnalysis が見つかりません');
            }
          } else {
            console.log('⚠️ 回答データがありません');
          }
        } catch (error) {
          console.error('❌ デバッグエラー:', error);
        }
      }
      
      function checkAnswerFormat() {
        const answers = JSON.parse(localStorage.getItem('haqei_answers') || '[]');
        console.log('📊 回答フォーマット分析:');
        console.log('総数:', answers.length);
        
        if (answers.length > 0) {
          const sample = answers[0];
          console.log('サンプル:', sample);
          console.log('必要なフィールド:');
          console.log('- questionId:', !!sample.questionId);
          console.log('- selectedValue:', !!sample.selectedValue);
          console.log('- selectedChoice:', !!sample.selectedChoice);
          console.log('- choiceText:', !!sample.choiceText);
        }
      }
      
      // 統合パフォーマンス最適化システム初期化
      async function initializePerformanceOptimization() {
        console.log('🚀 Initializing integrated performance optimization...');
        
        // 1. Core Web Vitals Optimizer
        if (window.CoreWebVitalsOptimizer) {
          const optimizer = new window.CoreWebVitalsOptimizer({
            enableProgressiveLoading: true,
            enableBundleOptimization: true,
            enableMemoryMonitoring: true,
            enableWebVitalsTracking: true,
            enableServiceWorker: true,
            developmentMode: false
          });
          
          const vitalsSuccess = await optimizer.initialize();
          if (vitalsSuccess) {
            window.coreWebVitalsOptimizer = optimizer;
            console.log('✅ Core Web Vitals optimization initialized');
          }
        }
        
        // 2. Memory Optimization Manager
        if (window.MemoryOptimizationManager) {
          const memoryManager = new window.MemoryOptimizationManager({
            monitoringInterval: 5000,
            warningThreshold: 50 * 1024 * 1024,  // 50MB
            criticalThreshold: 100 * 1024 * 1024, // 100MB
            enableAutoCleanup: true,
            enableLeakDetection: true
          });
          
          memoryManager.start();
          window.memoryOptimizationManager = memoryManager;
          console.log('✅ Memory optimization manager started');
          
          // クリーンアップタスク登録
          memoryManager.registerCleanupTask('progressive-data', () => {
            if (window.progressiveDataManager) {
              window.progressiveDataManager.cleanup();
            }
          });
        }
        
        // 3. Performance Monitoring Dashboard (開発時のみ表示)
        if (window.PerformanceMonitoringDashboard) {
          const dashboard = new window.PerformanceMonitoringDashboard({
            containerId: 'performance-dashboard',
            updateInterval: 1000,
            position: 'bottom-right',
            enableAutoHide: true
          });
          
          await dashboard.initialize();
          window.performanceMonitoringDashboard = dashboard;
          
          // Ctrl+Shift+Pで表示切替
          console.log('✅ Performance dashboard ready (Press Ctrl+Shift+P to toggle)');
          
          // 開発環境では自動表示
          if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            setTimeout(() => dashboard.show(), 2000);
          }
        }
        
        // 4. Service Worker登録
        if ('serviceWorker' in navigator) {
          try {
            const registration = await navigator.serviceWorker.register('/sw-performance.js');
            console.log('✅ Performance Service Worker registered');
          } catch (error) {
            console.warn('⚠️ Service Worker registration failed:', error);
          }
        }
        
        // 5. 統合パフォーマンスレポート
        setInterval(() => {
          if (window.coreWebVitalsOptimizer && window.memoryOptimizationManager) {
            const vitalsReport = window.coreWebVitalsOptimizer.generatePerformanceReport();
            const memoryStatus = window.memoryOptimizationManager.getMemoryStatus();
            
            console.log('📊 System Performance:', {
              FCP: vitalsReport.webVitals.FCP ? `${vitalsReport.webVitals.FCP.toFixed(0)}ms` : 'N/A',
              LCP: vitalsReport.webVitals.LCP ? `${vitalsReport.webVitals.LCP.toFixed(0)}ms` : 'N/A',
              Memory: memoryStatus.current.percentage ? `${memoryStatus.current.percentage.toFixed(1)}%` : 'N/A',
              Growth: memoryStatus.growthRate?.percentage ? `${memoryStatus.growthRate.percentage.toFixed(1)}%` : 'N/A'
            });
          }
        }, 30000);
      }
      
      // パフォーマンス最適化を非同期で開始
      initializePerformanceOptimization().catch(error => {
        console.error('❌ Performance optimization initialization failed:', error);
      });
    </script>
    
    <!-- データ転送修正スクリプト -->
    <script src="/fix-data-transfer.js"></script>
    
    <!-- Enhanced Question Flow UX - removed for bundle size reduction -->
    
    <!-- Help System Core Components -->
    <script src="/js/help-system/core/HelpSystemCore.js"></script>
    <script src="/js/help-system/ui/HelpButton.js"></script>
    <script src="/js/help-system/ui/HelpModal.js"></script>
    <script src="/js/help-system/ui/TooltipManager.js"></script>
    <script src="/js/help-system/ui/HelpSystemUI.js"></script>
    
    <!-- Help System Integration -->
    <script src="/js/help-system/integration/haqei-element-enhancer.js"></script>
    
    <!-- Security Utilities -->
    <script src="/js/shared/utils/SecurityValidator.js"></script>
    
    <!-- WCAG 2.1 AA準拠アクセシビリティマネージャー -->
    <script src="/js/shared/utils/AccessibilityManager.js"></script>
    <script src="/js/shared/utils/SecureDOM.js"></script>
    <script src="/js/shared/utils/CSRFProtection.js"></script>
    <script src="/js/shared/utils/CSRFIntegration.js"></script>
    <script src="/js/shared/utils/SecureAPI.js"></script>
    <script src="/js/shared/utils/SecurityHeaders.js"></script>
    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" integrity="sha512-H+rglffZ6f5gF7UJgvH4Naa+fGCgjrHKMgoFOGmcPTRwR6oILo5R+gtzNrpDp7iMV3udbymBVjkeZGNz1Em4rQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Security Patch for TripleOSResultsView -->
    <script src="/js/components/TripleOSResultsView_security_patch.js"></script>
    
    <!-- アプリケーション初期化 -->
    <script src="/js/app.js"></script>
    
    <!-- WCAG 2.1 AA準拠アクセシビリティマネージャー初期化 -->
    <script>
      // アクセシビリティマネージャーの初期化（最優先）
      let accessibilityManager = null;
      
      document.addEventListener('DOMContentLoaded', async function() {
        try {
          if (window.AccessibilityManager) {
            accessibilityManager = new AccessibilityManager({
              enableKeyboardNavigation: true,
              enableAriaManagement: true,
              enableFocusManagement: true,
              enableContrastChecking: true,
              enableScreenReaderOptimization: true,
              debugMode: false
            });
            
            const a11yInitialized = await accessibilityManager.initialize();
            if (a11yInitialized) {
              console.log('✅ WCAG 2.1 AA Accessibility Manager initialized');
              
              // アクセシビリティ統計を表示
              const stats = accessibilityManager.getAccessibilityStats();
              console.log('🎯 Accessibility Stats:', stats);
              
              // グローバル関数として公開
              window.accessibilityManager = accessibilityManager;
              window.getA11yReport = function() {
                return accessibilityManager.generateAccessibilityReport();
              };
              window.toggleA11yDebug = function() {
                accessibilityManager.toggleDebugMode();
              };
            } else {
              console.error('❌ Accessibility Manager initialization failed');
            }
          } else {
            console.error('❌ AccessibilityManager not available');
          }
        } catch (error) {
          console.error('❌ Accessibility initialization error:', error);
        }
      });
    </script>
    
    <!-- Help System 初期化スクリプト -->
    <script>
      // HAQEI Help System 初期化
      document.addEventListener('DOMContentLoaded', function() {
        try {
          // ヘルプシステムの初期化を遅延実行
          setTimeout(function() {
            if (typeof HelpSystemUI !== 'undefined') {
              window.haqeiHelpSystem = new HelpSystemUI({
                theme: 'adaptive',
                helpButtonPosition: 'bottom-right',
                animations: true,
                accessibility: true,
                components: {
                  tooltips: true,
                  modal: true,
                  tutorial: false, // TutorialOverlayが未実装のため無効化
                  helpButton: true
                }
              });
              
              console.log('✅ HAQEI Help System initialized successfully');
              
              // 初期化完了イベントリスナー
              document.addEventListener('haqei:helpSystemReady', function(event) {
                console.log('🎯 Help System Ready:', event.detail);
                
                // 既存要素の自動強化
                if (window.haqeiHelpSystem && window.haqeiHelpSystem.enhanceExistingElements) {
                  window.haqeiHelpSystem.enhanceExistingElements();
                }
                
                // Element Enhancerによる自動要素強化
                if (window.haqeiElementEnhancer) {
                  window.haqeiElementEnhancer.enhanceAllElements();
                  console.log('🎯 HAQEI elements enhanced:', window.haqeiElementEnhancer.getStats());
                }
              });
              
            } else {
              console.warn('⚠️ HelpSystemUI not available');
            }
          }, 1000); // 1秒後に初期化（既存システムの初期化完了を待つ）
          
        } catch (error) {
          console.error('❌ Failed to initialize HAQEI Help System:', error);
        }
      });
      
      // グローバルヘルプ関数
      window.showHaqeiHelp = function(term, type = 'concept', options = {}) {
        if (window.haqeiHelpSystem) {
          return window.haqeiHelpSystem.showHelp(term, type, options);
        } else {
          console.warn('Help system not initialized yet');
        }
      };
      
      // グローバルツールチップ登録関数
      window.addHaqeiTooltip = function(element, data) {
        if (window.haqeiHelpSystem && window.haqeiHelpSystem.showTooltip) {
          window.haqeiHelpSystem.showTooltip(element, data);
        } else {
          console.warn('Help system not initialized yet');
        }
      };
      
      // デバッグ・テスト用関数
      window.testHelpSystem = function() {
        console.log('🧪 Testing HAQEI Help System...');
        
        if (window.haqeiHelpSystem) {
          console.log('📊 Help System Stats:', window.haqeiHelpSystem.getStats());
          
          // ヘルプモーダルのテスト
          window.showHaqeiHelp('bunenjin', 'concept');
          
          return true;
        } else {
          console.warn('⚠️ Help system not available for testing');
          return false;
        }
      };
      
      window.showHelpSystemStats = function() {
        if (window.haqeiHelpSystem) {
          console.log('📊 Help System Stats:', window.haqeiHelpSystem.getStats());
        }
        if (window.haqeiElementEnhancer) {
          console.log('🎯 Element Enhancer Stats:', window.haqeiElementEnhancer.getStats());
        }
      };
    </script>

  </body>
</html>
