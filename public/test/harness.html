<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Future Simulator Harness</title>
    <style>
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1220; color:#e5e7eb; padding:24px; }
      .card { background:#111827; border:1px solid #1f2937; border-radius:12px; padding:16px; max-width: 900px; }
      .row { display:flex; gap:12px; align-items:center; }
      .label { width: 160px; color:#9ca3af; }
      .value { color:#f9fafb; font-weight:600; }
      #status { margin: 12px 0; color:#93c5fd }
      #error { margin: 12px 0; color:#fca5a5; display:none }
    </style>
    <script>
      // Provide a stub kuromoji to avoid external network
      window.kuromoji = {
        builder: () => ({ build: (cb) => cb(new Error('kuromoji stubbed for test'))) }
      };
    </script>
  </head>
  <body>
    <h1>Future Simulator Test Harness</h1>
    <div id="status">Initializing...</div>
    <div id="error"></div>
    <div class="card">
      <div class="row"><div class="label">Selected Line</div><div id="result-name" class="value"></div></div>
      <div class="row"><div class="label">Hexagram</div><div id="result-hex" class="value"></div></div>
      <div class="row"><div class="label">Confidence</div><div id="result-conf" class="value"></div></div>
      <div class="row"><div class="label">Data Source</div><div id="result-src" class="value"></div></div>
    </div>

    <script src="../js/services/384DataService.js"></script>
    <script src="../js/ai/TextTo384LinesBridge.js"></script>
    <script>
      (async () => {
        try {
          const bridge = new window.TextTo384LinesBridge();
          await bridge.initialize();
          const input = '新しい環境で挑戦し、困難を乗り越えて成長したい。具体的な行動方針を定めたい';
          const res = await bridge.analyzeTextToSpecificLine(input);

          const name = res?.line_full_name || 'N/A';
          const hex = `${res?.hexagram_name || ''} ${res?.line_position || ''}爻`;
          const conf = `${Math.round((res?.performance?.confidence_score || 0) * 100)}%`;

          // Try to derive data source from internal lines384
          let src = 'Unknown';
          const selectedId = res?.line_384_id;
          if (selectedId && bridge.lines384 && bridge.lines384[selectedId]) {
            src = bridge.lines384[selectedId].dbSource || src;
          }

          document.getElementById('result-name').textContent = name;
          document.getElementById('result-hex').textContent = hex;
          document.getElementById('result-conf').textContent = conf;
          document.getElementById('result-src').textContent = src;
          document.getElementById('status').textContent = '✅ Ready';
        } catch (e) {
          document.getElementById('status').textContent = '❌ Error';
          const el = document.getElementById('error');
          el.style.display = 'block';
          el.textContent = e?.message || String(e);
        }
      })();
    </script>
  </body>
  </html>

