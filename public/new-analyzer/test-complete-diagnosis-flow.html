<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Diagnosis Flow Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeeba;
        }
        .step {
            background-color: #e2e3e5;
            color: #495057;
            border: 1px solid #ced4da;
            font-weight: bold;
        }
        button {
            padding: 12px 24px;
            margin: 10px 5px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }
        .test-btn {
            background-color: #007bff;
            color: white;
        }
        .test-btn:hover {
            background-color: #0056b3;
        }
        .results-preview {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin: 15px 0;
            max-height: 400px;
            overflow-y: auto;
        }
        pre {
            background-color: #f1f3f4;
            padding: 10px;
            border-radius: 4px;
            font-size: 11px;
            overflow-x: auto;
            max-height: 200px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”¬ Complete Diagnosis Flow Test</h1>
        <p><strong>ç›®çš„:</strong> è¨ºæ–­ã®å…¨ãƒ•ãƒ­ãƒ¼ã‚’ç¶²ç¾…çš„ã«ãƒ†ã‚¹ãƒˆã—ã¦ã€çµæœè¡¨ç¤ºãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹ã‚’ç¢ºèª</p>
        
        <button class="test-btn" onclick="runCompleteFlowTest()">ğŸš€ å®Œå…¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button class="test-btn" onclick="runStepByStepTest()">ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button class="test-btn" onclick="clearResults()">ğŸ—‘ï¸ çµæœã‚¯ãƒªã‚¢</button>
        
        <div id="test-results"></div>
        
        <!-- Results Preview Area -->
        <div class="results-preview">
            <h3>ğŸ¯ è¨ºæ–­çµæœãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼:</h3>
            <div id="diagnosis-results-preview" style="min-height: 100px; border: 1px dashed #ccc; padding: 10px;">
                çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
        </div>
    </div>

    <!-- All necessary scripts -->
    <script src="../js/data/data_box.js"></script>
    <script src="../js/data/questions.js"></script>
    <script src="../js/data/vectors.js"></script>
    <script src="../js/data/hexagrams.js"></script>
    <script src="../js/data/hexagram_details.js"></script>
    <script src="../js/data/compatibility_definition.js"></script>
    <script src="../js/data/compatibility_matrix.js"></script>
    <script src="../js/data/action_plans.js"></script>

    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/Calculator.js"></script>
    <script src="js/core/CompatibilityDataLoader.js"></script>
    <script src="js/core/TripleOSEngine.js"></script>
    <script src="js/components/TripleOSResultsView.js"></script>

    <script>
        let testResults = [];
        
        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = `${new Date().toLocaleTimeString()} - ${message}`;
            resultsDiv.appendChild(resultDiv);
            
            testResults.push({ time: Date.now(), message, type });
            
            // Auto-scroll to bottom
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('diagnosis-results-preview').innerHTML = 'çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            testResults = [];
        }

        function createTestAnswers() {
            // å®Ÿéš›ã®è¨ºæ–­ã§ä½¿ç”¨ã•ã‚Œã‚‹å½¢å¼ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
            return [
                // ä¾¡å€¤è¦³è³ªå• (q1-q24)
                {
                    questionId: "q1",
                    selectedValue: "A",
                    scoring_tags: [
                        { key: "ä¹¾_å‰µé€ æ€§", value: 3.0 },
                        { key: "é›¢_è¡¨ç¾æ€§", value: 1.5 }
                    ]
                },
                {
                    questionId: "q2", 
                    selectedValue: "B",
                    scoring_tags: [
                        { key: "å_æ¢æ±‚æ€§", value: 2.5 },
                        { key: "è‰®_å®‰å®šæ€§", value: 2.0 }
                    ]
                },
                {
                    questionId: "q3",
                    selectedValue: "A",
                    scoring_tags: [
                        { key: "éœ‡_è¡Œå‹•æ€§", value: 2.8 },
                        { key: "å…Œ_èª¿å’Œæ€§", value: 1.2 }
                    ]
                },
                {
                    questionId: "q4",
                    selectedValue: "B",
                    scoring_tags: [
                        { key: "å·½_é©å¿œæ€§", value: 2.3 },
                        { key: "å¤_å—å®¹æ€§", value: 1.8 }
                    ]
                },
                {
                    questionId: "q5",
                    selectedValue: "A",
                    scoring_tags: [
                        { key: "ä¹¾_å‰µé€ æ€§", value: 2.5 },
                        { key: "éœ‡_è¡Œå‹•æ€§", value: 2.0 }
                    ]
                },
                // æ›´å¤šçš„ä»·å€¼è§‚é—®é¢˜...
                ...Array.from({length: 19}, (_, i) => ({
                    questionId: `q${i + 6}`,
                    selectedValue: i % 2 === 0 ? "A" : "B",
                    scoring_tags: [
                        { key: ["ä¹¾_å‰µé€ æ€§", "å_æ¢æ±‚æ€§", "é›¢_è¡¨ç¾æ€§", "éœ‡_è¡Œå‹•æ€§"][i % 4], value: 2.0 + Math.random() * 1.5 },
                        { key: ["å…Œ_èª¿å’Œæ€§", "è‰®_å®‰å®šæ€§", "å·½_é©å¿œæ€§", "å¤_å—å®¹æ€§"][i % 4], value: 1.0 + Math.random() * 1.5 }
                    ]
                })),
                // ã‚·ãƒŠãƒªã‚ªè³ªå• (q25-q30)
                {
                    questionId: "q25",
                    outerChoice: {
                        value: "A",
                        text: "ç©æ¥µçš„ã«ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã™ã‚‹",
                        scoring_tags: ["leadership", "confidence", "initiative"]
                    },
                    innerChoice: {
                        value: "B", 
                        text: "æ…é‡ã«çŠ¶æ³ã‚’åˆ†æã™ã‚‹",
                        scoring_tags: ["caution", "analysis", "reflection"]
                    }
                },
                {
                    questionId: "q26",
                    outerChoice: {
                        value: "B",
                        text: "å”èª¿æ€§ã‚’é‡è¦–ã™ã‚‹",
                        scoring_tags: ["cooperation", "harmony", "teamwork"]
                    },
                    innerChoice: {
                        value: "A",
                        text: "è‡ªåˆ†ã®ä¿¡å¿µã‚’è²«ã", 
                        scoring_tags: ["conviction", "independence", "determination"]
                    }
                },
                {
                    questionId: "q27",
                    outerChoice: {
                        value: "A",
                        text: "æ–°ã—ã„ã‚¢ã‚¤ãƒ‡ã‚¢ã‚’ææ¡ˆã™ã‚‹",
                        scoring_tags: ["creativity", "innovation", "initiative"]
                    },
                    innerChoice: {
                        value: "B",
                        text: "å®‰å…¨ãªé¸æŠè‚¢ã‚’é¸ã¶",
                        scoring_tags: ["safety", "caution", "stability"]
                    }
                }
            ];
        }

        async function runCompleteFlowTest() {
            addResult('ğŸš€ å®Œå…¨è¨ºæ–­ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹', 'step');
            
            try {
                // Step 1: ãƒ‡ãƒ¼ã‚¿åˆæœŸåŒ–ç¢ºèª
                addResult('ğŸ“Š Step 1: ãƒ‡ãƒ¼ã‚¿ã¨ã‚¯ãƒ©ã‚¹ã®åˆæœŸåŒ–ç¢ºèª', 'step');
                
                if (typeof DataManager === 'undefined') {
                    addResult('âŒ DataManager class not found', 'error');
                    return;
                }
                addResult('âœ… DataManager class loaded', 'success');

                if (typeof TripleOSEngine === 'undefined') {
                    addResult('âŒ TripleOSEngine class not found', 'error');
                    return;
                }
                addResult('âœ… TripleOSEngine class loaded', 'success');

                if (typeof TripleOSResultsView === 'undefined') {
                    addResult('âŒ TripleOSResultsView class not found', 'error');
                    return;
                }
                addResult('âœ… TripleOSResultsView class loaded', 'success');

                // Step 2: ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
                addResult('ğŸ“ Step 2: DataManageråˆæœŸåŒ–ã¨ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿', 'step');
                const dataManager = new DataManager();
                await dataManager.loadData();
                
                const stats = dataManager.getDataStats();
                addResult(`ğŸ“Š Data loaded: hexagrams=${stats.dataStructure.hexagrams}, questions=${stats.dataStructure.worldviewQuestions}`, 'info');
                
                if (!stats.loaded) {
                    addResult(`âŒ DataManager loading failed: ${stats.error}`, 'error');
                    return;
                }
                addResult('âœ… DataManager initialized successfully', 'success');

                // Step 3: ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–
                addResult('ğŸ”§ Step 3: TripleOSEngineåˆæœŸåŒ–', 'step');
                const engine = new TripleOSEngine(dataManager);
                
                if (!engine.calculator) {
                    addResult('âŒ Calculator not initialized in TripleOSEngine', 'error');
                    return;
                }
                addResult('âœ… TripleOSEngine initialized with Calculator', 'success');

                // Step 4: ãƒ†ã‚¹ãƒˆå›ç­”ãƒ‡ãƒ¼ã‚¿ä½œæˆ
                addResult('ğŸ“ Step 4: ãƒ†ã‚¹ãƒˆå›ç­”ãƒ‡ãƒ¼ã‚¿ä½œæˆ', 'step');
                const testAnswers = createTestAnswers();
                addResult(`ğŸ“Š Created ${testAnswers.length} test answers`, 'info');
                
                // å›ç­”ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ãƒ­ã‚°
                const worldviewCount = testAnswers.filter(a => a.questionId.match(/^q([1-9]|1[0-9]|2[0-4])$/)).length;
                const scenarioCount = testAnswers.filter(a => a.questionId.match(/^q(25|26|27|28|29|30)$/)).length;
                addResult(`ğŸ“‹ Worldview answers: ${worldviewCount}, Scenario answers: ${scenarioCount}`, 'info');

                // Step 5: åˆ†æå®Ÿè¡Œ
                addResult('ğŸ”¬ Step 5: Triple OSåˆ†æå®Ÿè¡Œ', 'step');
                const analysisResult = await engine.analyzeTripleOS(testAnswers);
                
                if (!analysisResult) {
                    addResult('âŒ Analysis returned null/undefined', 'error');
                    return;
                }
                addResult('âœ… Analysis completed successfully', 'success');

                // åˆ†æçµæœã®è©³ç´°ç¢ºèª
                addResult('ğŸ” åˆ†æçµæœè©³ç´°ç¢ºèª:', 'step');
                addResult(`Analysis type: ${analysisResult.analysisType}`, 'info');
                
                if (analysisResult.primaryOS) {
                    addResult(`âœ… Primary OS: ${analysisResult.primaryOS.osName} (ID: ${analysisResult.primaryOS.osId})`, 'success');
                } else {
                    addResult('âŒ Primary OS missing', 'error');
                }

                if (analysisResult.engineOS) {
                    addResult(`âœ… Engine OS: ${analysisResult.engineOS.osName} (hexagramId: ${analysisResult.engineOS.hexagramId})`, 'success');
                } else {
                    addResult('âŒ Engine OS missing', 'error');
                }

                if (analysisResult.interfaceOS) {
                    addResult(`âœ… Interface OS: ${analysisResult.interfaceOS.osName} (hexagramId: ${analysisResult.interfaceOS.hexagramId})`, 'success');
                } else {
                    addResult('âŒ Interface OS missing', 'error');
                }

                if (analysisResult.safeModeOS) {
                    addResult(`âœ… SafeMode OS: ${analysisResult.safeModeOS.osName} (hexagramId: ${analysisResult.safeModeOS.hexagramId})`, 'success');
                } else {
                    addResult('âŒ SafeMode OS missing', 'error');
                }

                if (analysisResult.dimensions) {
                    addResult(`âœ… Dimensions: ${analysisResult.dimensions.length} dimensions analyzed`, 'success');
                } else {
                    addResult('âŒ Dimensions missing', 'error');
                }

                // Step 6: æ´å¯Ÿç”Ÿæˆ
                addResult('ğŸ’¡ Step 6: æ´å¯Ÿç”Ÿæˆ', 'step');
                const insights = await engine.generateInsights(analysisResult);
                
                if (!insights) {
                    addResult('âŒ Insights generation failed', 'error');
                    return;
                }
                addResult('âœ… Insights generated successfully', 'success');
                addResult(`ğŸ“ Summary: ${insights.summary.substring(0, 100)}...`, 'info');

                // Step 7: çµæœãƒ“ãƒ¥ãƒ¼ä½œæˆ
                addResult('ğŸ¨ Step 7: TripleOSResultsViewä½œæˆ', 'step');
                
                // ã‚³ãƒ³ãƒ†ãƒŠä½œæˆ
                const previewContainer = document.getElementById('diagnosis-results-preview');
                previewContainer.innerHTML = '<div id="test-results-container"></div>';
                
                const compatibilityLoader = new CompatibilityDataLoader();
                const options = {
                    analysisResult: analysisResult,
                    insights: insights,
                    compatibilityLoader: compatibilityLoader,
                    dataManager: dataManager
                };

                const resultsView = new TripleOSResultsView('test-results-container', options);
                addResult('âœ… TripleOSResultsView created successfully', 'success');

                // Step 8: åˆæœŸåŒ–ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
                addResult('ğŸ–¼ï¸ Step 8: åˆæœŸåŒ–ã¨ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ', 'step');
                
                try {
                    resultsView.init();
                    addResult('âœ… TripleOSResultsView.init() completed', 'success');
                } catch (initError) {
                    addResult(`âŒ Init failed: ${initError.message}`, 'error');
                    throw initError;
                }

                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœç¢ºèª
                const container = document.getElementById('test-results-container');
                if (container && container.innerHTML.length > 0) {
                    addResult(`âœ… HTML generated: ${container.innerHTML.length} characters`, 'success');
                    addResult('âœ… è¨ºæ–­çµæœãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã—ãŸï¼', 'success');
                } else {
                    addResult('âŒ No HTML content generated', 'error');
                }

                // Step 9: æœ€çµ‚ç¢ºèª
                addResult('ğŸ¯ Step 9: æœ€çµ‚çµæœç¢ºèª', 'step');
                
                const hasTitle = container.innerHTML.includes('ã®äºº');
                const hasOSCards = container.innerHTML.includes('ã‚¨ãƒ³ã‚¸ãƒ³OS');
                const hasDimensions = container.innerHTML.includes('dimension');
                
                addResult(`Title display: ${hasTitle ? 'âœ…' : 'âŒ'}`, hasTitle ? 'success' : 'error');
                addResult(`OS cards display: ${hasOSCards ? 'âœ…' : 'âŒ'}`, hasOSCards ? 'success' : 'error');
                addResult(`Dimensions display: ${hasDimensions ? 'âœ…' : 'âŒ'}`, hasDimensions ? 'success' : 'error');

                if (hasTitle && hasOSCards) {
                    addResult('ğŸ‰ SUCCESS: è¨ºæ–­çµæœãŒå®Œå…¨ã«è¡¨ç¤ºã•ã‚Œã¾ã—ãŸï¼', 'success');
                } else {
                    addResult('âš ï¸ WARNING: ä¸€éƒ¨ã®çµæœãŒè¡¨ç¤ºã•ã‚Œã¦ã„ãªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™', 'warning');
                }

            } catch (error) {
                addResult(`âŒ CRITICAL ERROR: ${error.message}`, 'error');
                addResult(`ğŸ” Stack trace: ${error.stack}`, 'error');
                
                // ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã®è©³ç´°æƒ…å ±
                addResult('ğŸ” Error context:', 'info');
                addResult(`- Error type: ${error.constructor.name}`, 'info');
                addResult(`- Error location: ${error.fileName || 'unknown'}:${error.lineNumber || 'unknown'}`, 'info');
            }
        }

        async function runStepByStepTest() {
            addResult('ğŸ“‹ ã‚¹ãƒ†ãƒƒãƒ—åˆ¥ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰ï¼‰', 'step');
            
            // ã‚ˆã‚Šè©³ç´°ãªãƒ­ã‚°ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            const originalConsole = window.console;
            window.console = {
                ...originalConsole,
                log: (...args) => {
                    originalConsole.log(...args);
                    addResult(`ğŸ› ${args.join(' ')}`, 'info');
                },
                warn: (...args) => {
                    originalConsole.warn(...args);
                    addResult(`âš ï¸ ${args.join(' ')}`, 'warning');
                },
                error: (...args) => {
                    originalConsole.error(...args);
                    addResult(`âŒ ${args.join(' ')}`, 'error');
                }
            };

            await runCompleteFlowTest();
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’æˆ»ã™
            window.console = originalConsole;
        }

        // Auto-run on page load
        document.addEventListener('DOMContentLoaded', function() {
            addResult('ğŸš€ Complete Diagnosis Flow Test initialized', 'info');
            addResult('ğŸ’¡ Click buttons to test the complete diagnosis flow', 'info');
        });
    </script>
</body>
</html>