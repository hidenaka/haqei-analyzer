<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdvancedCompatibilityEngine テスト</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .result { margin: 10px 0; padding: 10px; background: #f0f8ff; border-radius: 4px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>🎯 AdvancedCompatibilityEngine 統合テスト</h1>
    
    <div class="test-container">
        <h2>📋 テスト実行</h2>
        <button id="run-basic-test">基本機能テスト</button>
        <button id="run-advanced-test">高度分析テスト</button>
        <button id="run-integration-test">統合テスト</button>
        <div id="test-results"></div>
    </div>

    <!-- 基本クラス読み込み -->
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/Calculator.js"></script>
    <script src="js/core/Engine.js"></script>
    <script src="js/core/TripleOSEngine.js"></script>
    <script src="js/core/InternalCompatibilityEngine.js"></script>
    <script src="js/core/AdvancedCompatibilityEngine.js"></script>
    <script src="js/core/StorageManager.js"></script>

    <!-- データファイル -->
    <script src="js/data/data_box.js"></script>
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/hexagrams.js"></script>
    <script src="js/data/hexagram_details.js"></script>
    <script src="js/data/compatibility_definition.js"></script>

    <script>
        class AdvancedCompatibilityTester {
            constructor() {
                this.results = [];
                this.setupTestEnvironment();
            }

            async setupTestEnvironment() {
                this.log('🔧 テスト環境をセットアップ中...');
                
                try {
                    // 必要なクラスの初期化
                    this.dataManager = new DataManager();
                    this.internalCompatibilityEngine = new InternalCompatibilityEngine(this.dataManager);
                    this.advancedCompatibilityEngine = new AdvancedCompatibilityEngine(this.internalCompatibilityEngine);
                    
                    this.log('✅ テスト環境セットアップ完了', 'success');
                } catch (error) {
                    this.log(`❌ セットアップエラー: ${error.message}`, 'error');
                }
            }

            log(message, type = 'info') {
                const timestamp = new Date().toLocaleTimeString();
                const color = type === 'success' ? 'green' : type === 'error' ? 'red' : type === 'warning' ? 'orange' : 'black';
                
                console.log(`[${timestamp}] ${message}`);
                
                const resultsDiv = document.getElementById('test-results');
                const logElement = document.createElement('div');
                logElement.style.color = color;
                logElement.textContent = `[${timestamp}] ${message}`;
                resultsDiv.appendChild(logElement);
            }

            async runBasicTest() {
                this.log('🧪 基本機能テスト開始');
                
                try {
                    // クラスの存在確認
                    if (!this.advancedCompatibilityEngine) {
                        throw new Error('AdvancedCompatibilityEngine が初期化されていません');
                    }
                    
                    this.log('✅ AdvancedCompatibilityEngine 初期化確認', 'success');
                    
                    // メソッドの存在確認
                    const requiredMethods = [
                        'analyzeInternalTeamComposition',
                        'detectSpecialPatterns',
                        'findHistoricalMatches',
                        'evaluateContextualFactors'
                    ];
                    
                    for (const method of requiredMethods) {
                        if (typeof this.advancedCompatibilityEngine[method] !== 'function') {
                            throw new Error(`必要なメソッド ${method} が見つかりません`);
                        }
                    }
                    
                    this.log('✅ 必要メソッド存在確認完了', 'success');
                    
                } catch (error) {
                    this.log(`❌ 基本機能テストエラー: ${error.message}`, 'error');
                }
            }

            async runAdvancedTest() {
                this.log('🚀 高度分析テスト開始');
                
                try {
                    // テスト用データ
                    const testEngineOS = 1;  // 乾為天
                    const testInterfaceOS = 2; // 坤為地
                    const testSafeModeOS = 3;  // 水雷屯
                    
                    const testUserContext = {
                        lifeStage: 'developing',
                        goals: ['personal_growth', 'career_growth'],
                        challenges: ['stress_management'],
                        environment: { type: 'corporate' }
                    };

                    this.log(`📊 テスト分析実行: Engine(${testEngineOS}) Interface(${testInterfaceOS}) SafeMode(${testSafeModeOS})`);
                    
                    const result = await this.advancedCompatibilityEngine.analyzeInternalTeamComposition(
                        testEngineOS, 
                        testInterfaceOS, 
                        testSafeModeOS, 
                        testUserContext
                    );
                    
                    if (!result) {
                        throw new Error('分析結果が null です');
                    }
                    
                    // 結果の構造確認
                    const expectedKeys = [
                        'basicCompatibility',
                        'detailedData',
                        'specialPattern',
                        'historicalMatches',
                        'contextualAdjustment',
                        'optimizationHints',
                        'overallAssessment'
                    ];
                    
                    for (const key of expectedKeys) {
                        if (!(key in result)) {
                            this.log(`⚠️ 結果に ${key} が含まれていません`, 'warning');
                        } else {
                            this.log(`✅ ${key} 確認`, 'success');
                        }
                    }
                    
                    // 特殊パターン検出結果表示
                    if (result.specialPattern) {
                        this.log(`🎯 特殊パターン検出: ${result.specialPattern.name}`, 'success');
                    }
                    
                    // 歴史人物マッチング結果表示
                    if (result.historicalMatches && result.historicalMatches.length > 0) {
                        this.log(`👑 歴史人物マッチング: ${result.historicalMatches.length}件`, 'success');
                        result.historicalMatches.forEach(match => {
                            this.log(`  - ${match.name} (類似度: ${Math.round(match.similarity * 100)}%)`, 'success');
                        });
                    }
                    
                    // 最適化ヒント確認
                    if (result.optimizationHints) {
                        const totalHints = Object.values(result.optimizationHints).reduce((sum, hints) => sum + hints.length, 0);
                        this.log(`💡 最適化ヒント: ${totalHints}件`, 'success');
                    }
                    
                    this.log('✅ 高度分析テスト完了', 'success');
                    
                } catch (error) {
                    this.log(`❌ 高度分析テストエラー: ${error.message}`, 'error');
                    console.error('詳細エラー:', error);
                }
            }

            async runIntegrationTest() {
                this.log('🔄 統合テスト開始');
                
                try {
                    // 複数パターンでのテスト
                    const testCases = [
                        { engine: 1, interface: 49, safeMode: 33 }, // ダ・ヴィンチタイプ
                        { engine: 11, interface: 45, safeMode: 15 }, // 聖徳太子タイプ
                        { engine: 1, interface: 43, safeMode: 51 }   // ジョブズタイプ
                    ];
                    
                    for (let i = 0; i < testCases.length; i++) {
                        const testCase = testCases[i];
                        this.log(`📋 統合テスト ${i + 1}/${testCases.length}: Engine(${testCase.engine}) Interface(${testCase.interface}) SafeMode(${testCase.safeMode})`);
                        
                        const result = await this.advancedCompatibilityEngine.analyzeInternalTeamComposition(
                            testCase.engine,
                            testCase.interface,
                            testCase.safeMode
                        );
                        
                        if (result && result.overallAssessment) {
                            const effectiveness = Math.round(result.overallAssessment.teamEffectiveness * 100);
                            this.log(`  ✅ チーム効果性: ${effectiveness}%`, 'success');
                        } else {
                            this.log(`  ⚠️ 結果が不完全です`, 'warning');
                        }
                    }
                    
                    this.log('✅ 統合テスト完了', 'success');
                    
                } catch (error) {
                    this.log(`❌ 統合テストエラー: ${error.message}`, 'error');
                }
            }
        }

        // ページ読み込み完了後に初期化
        document.addEventListener('DOMContentLoaded', async () => {
            const tester = new AdvancedCompatibilityTester();
            
            // ボタンイベント設定
            document.getElementById('run-basic-test').addEventListener('click', () => {
                tester.runBasicTest();
            });
            
            document.getElementById('run-advanced-test').addEventListener('click', () => {
                tester.runAdvancedTest();
            });
            
            document.getElementById('run-integration-test').addEventListener('click', () => {
                tester.runIntegrationTest();
            });
            
            // 自動的に基本テストを実行
            setTimeout(() => {
                tester.runBasicTest();
            }, 1000);
        });
    </script>
</body>
</html>