<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Pipeline Test</title>
</head>
<body>
    <h1>🔍 Data Pipeline Test</h1>
    <div id="results"></div>
    <button onclick="testDataPipeline()">Run Data Pipeline Test</button>

    <!-- Load the same scripts as analyzer.html -->
    <script src="../js/data/data_box.js"></script>
    <script src="../js/data/questions.js"></script>
    <script src="../js/data/vectors.js"></script>
    <script src="../js/data/hexagrams.js"></script>
    <script src="../js/data/hexagram_details.js"></script>

    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/Calculator.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/core/Engine.js"></script>
    <script src="js/core/TripleOSEngine.js"></script>
    <script src="js/core/CompatibilityDataLoader.js"></script>

    <script>
        async function testDataPipeline() {
            console.log("🧪 === DATA PIPELINE TEST START ===");
            
            try {
                // Test 1: Global Data Availability
                console.log("🔍 Test 1: Global Data Availability");
                console.log("  - HAQEI_DATA:", typeof window.HAQEI_DATA, window.HAQEI_DATA ? Object.keys(window.HAQEI_DATA).length : 0);
                console.log("  - H64_8D_VECTORS:", typeof window.H64_8D_VECTORS, window.H64_8D_VECTORS ? Object.keys(window.H64_8D_VECTORS).length : 0);
                console.log("  - WORLDVIEW_QUESTIONS:", typeof window.WORLDVIEW_QUESTIONS, window.WORLDVIEW_QUESTIONS ? window.WORLDVIEW_QUESTIONS.length : 0);
                console.log("  - SCENARIO_QUESTIONS:", typeof window.SCENARIO_QUESTIONS, window.SCENARIO_QUESTIONS ? window.SCENARIO_QUESTIONS.length : 0);
                
                // Test 2: DataManager Loading
                console.log("🔍 Test 2: DataManager Loading");
                const dataManager = new DataManager();
                await dataManager.loadData();
                const stats = dataManager.getDataStats();
                console.log("  - DataManager Stats:", stats);
                
                // Test 3: CompatibilityDataLoader
                console.log("🔍 Test 3: CompatibilityDataLoader");
                const compatLoader = new CompatibilityDataLoader();
                try {
                    const interfaceData = await compatLoader.loadInterfaceData(1);
                    console.log("  - Interface Data Loaded:", !!interfaceData);
                    
                    const safemodeData = await compatLoader.loadSafemodeData(1);
                    console.log("  - Safemode Data Loaded:", !!safemodeData);
                } catch (compatError) {
                    console.error("  - Compatibility Data Error:", compatError.message);
                }
                
                // Test 4: Engine Analysis (Mock)
                console.log("🔍 Test 4: Mock Engine Analysis");
                const calculator = new Calculator();
                calculator.setDataManager(dataManager);
                
                const engine = new TripleOSEngine();
                engine.setDataManager(dataManager);
                engine.setCalculator(calculator);
                
                // Mock answers for testing
                const mockAnswers = [
                    { questionId: "wv_1", selectedOption: "A", value: 3 },
                    { questionId: "wv_2", selectedOption: "B", value: 2 },
                    { questionId: "sc_1", selectedOption: "A", innerChoice: "X", outerChoice: "Y" }
                ];
                
                try {
                    const mockResult = await engine.analyzeTripleOS(mockAnswers);
                    console.log("  - Mock Analysis Result:", mockResult);
                } catch (analysisError) {
                    console.error("  - Analysis Error:", analysisError.message);
                }
                
                console.log("✅ === DATA PIPELINE TEST COMPLETE ===");
                
            } catch (error) {
                console.error("❌ === DATA PIPELINE TEST FAILED ===", error);
            }
        }
        
        // Auto-run test when page loads
        window.addEventListener('load', () => {
            setTimeout(testDataPipeline, 1000);
        });
    </script>
</body>
</html>