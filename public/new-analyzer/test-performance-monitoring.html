<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Performance Monitoring Test - HaQei Analyzer</title>
    <style>
      body {
        font-family: "Inter", sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .test-container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin-bottom: 30px;
        padding: 20px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
      }
      .test-section h2 {
        color: #333;
        margin-top: 0;
      }
      .test-result {
        padding: 10px;
        margin: 10px 0;
        border-radius: 4px;
      }
      .test-pass {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .test-fail {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .test-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .metrics-display {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin: 10px 0;
        font-family: monospace;
        white-space: pre-wrap;
      }
      button {
        background-color: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #0056b3;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background-color: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background-color: #28a745;
        transition: width 0.3s ease;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>🔧 Performance Monitoring Test Suite</h1>
      <p>
        このテストは、HaQei Analyzer
        のパフォーマンス監視機能の実装を検証します。
      </p>

      <!-- Test Progress -->
      <div class="test-section">
        <h2>📊 テスト進行状況</h2>
        <div class="progress-bar">
          <div class="progress-fill" id="test-progress" style="width: 0%"></div>
        </div>
        <div id="test-status">テスト準備中...</div>
      </div>

      <!-- Performance Monitor Initialization Test -->
      <div class="test-section">
        <h2>🚀 1. PerformanceMonitor 初期化テスト</h2>
        <div id="init-test-results"></div>
        <button onclick="runInitializationTest()">初期化テストを実行</button>
      </div>

      <!-- Script Loading Time Measurement Test -->
      <div class="test-section">
        <h2>⏱️ 2. スクリプト読み込み時間測定テスト</h2>
        <div id="script-timing-results"></div>
        <button onclick="runScriptTimingTest()">
          スクリプトタイミングテストを実行
        </button>
      </div>

      <!-- Initialization Process Timing Test -->
      <div class="test-section">
        <h2>🔄 3. 初期化プロセス時間測定テスト</h2>
        <div id="init-timing-results"></div>
        <button onclick="runInitializationTimingTest()">
          初期化タイミングテストを実行
        </button>
      </div>

      <!-- Memory Usage Monitoring Test -->
      <div class="test-section">
        <h2>💾 4. メモリ使用量監視テスト</h2>
        <div id="memory-monitoring-results"></div>
        <button onclick="runMemoryMonitoringTest()">
          メモリ監視テストを実行
        </button>
      </div>

      <!-- Performance Statistics Display Test -->
      <div class="test-section">
        <h2>📈 5. パフォーマンス統計表示テスト</h2>
        <div id="stats-display-results"></div>
        <button onclick="runStatsDisplayTest()">統計表示テストを実行</button>
      </div>

      <!-- Integration Test -->
      <div class="test-section">
        <h2>🔗 6. 統合テスト</h2>
        <div id="integration-results"></div>
        <button onclick="runIntegrationTest()">統合テストを実行</button>
      </div>

      <!-- Run All Tests -->
      <div class="test-section">
        <h2>🎯 全テスト実行</h2>
        <button onclick="runAllTests()" style="background-color: #28a745">
          すべてのテストを実行
        </button>
        <button onclick="clearResults()" style="background-color: #6c757d">
          結果をクリア
        </button>
      </div>

      <!-- Performance Report Display -->
      <div class="test-section">
        <h2>📊 パフォーマンスレポート</h2>
        <div id="performance-report" class="metrics-display"></div>
        <button onclick="displayPerformanceReport()">レポートを表示</button>
      </div>
    </div>

    <!-- Load PerformanceMonitor -->
    <script src="js/core/PerformanceMonitor.js"></script>

    <script>
      // Test state management
      let testResults = {
        initialization: false,
        scriptTiming: false,
        initTiming: false,
        memoryMonitoring: false,
        statsDisplay: false,
        integration: false,
      };

      let testPerformanceMonitor = null;
      let testProgress = 0;

      // Update test progress
      function updateTestProgress() {
        const completedTests = Object.values(testResults).filter(
          (result) => result
        ).length;
        const totalTests = Object.keys(testResults).length;
        testProgress = (completedTests / totalTests) * 100;

        document.getElementById("test-progress").style.width =
          testProgress + "%";
        document.getElementById(
          "test-status"
        ).textContent = `${completedTests}/${totalTests} テスト完了 (${Math.round(
          testProgress
        )}%)`;
      }

      // Helper function to display test results
      function displayTestResult(
        containerId,
        testName,
        passed,
        message,
        details = null
      ) {
        const container = document.getElementById(containerId);
        const resultDiv = document.createElement("div");
        resultDiv.className = `test-result ${
          passed ? "test-pass" : "test-fail"
        }`;

        let content = `${passed ? "✅" : "❌"} ${testName}: ${message}`;
        if (details) {
          content += `\n\n詳細:\n${details}`;
        }

        resultDiv.textContent = content;
        container.appendChild(resultDiv);
      }

      // Test 1: PerformanceMonitor Initialization
      function runInitializationTest() {
        const container = document.getElementById("init-test-results");
        container.innerHTML = "";

        try {
          // Test PerformanceMonitor class availability
          if (typeof PerformanceMonitor === "undefined") {
            displayTestResult(
              "init-test-results",
              "クラス定義確認",
              false,
              "PerformanceMonitor クラスが定義されていません"
            );
            return;
          }

          // Test PerformanceMonitor instantiation
          testPerformanceMonitor = new PerformanceMonitor({
            enableScriptTiming: true,
            enableMemoryMonitoring: true,
            enableDetailedLogging: true,
            reportingInterval: 500,
            maxHistorySize: 50,
          });

          displayTestResult(
            "init-test-results",
            "インスタンス作成",
            true,
            "PerformanceMonitor が正常に作成されました"
          );

          // Test initial properties
          const hasRequiredProperties =
            testPerformanceMonitor.metrics &&
            testPerformanceMonitor.statistics &&
            testPerformanceMonitor.options;

          displayTestResult(
            "init-test-results",
            "プロパティ確認",
            hasRequiredProperties,
            hasRequiredProperties
              ? "必要なプロパティが存在します"
              : "必要なプロパティが不足しています"
          );

          // Test Performance API availability
          const hasPerformanceAPI =
            typeof performance !== "undefined" && performance.now;
          displayTestResult(
            "init-test-results",
            "Performance API",
            hasPerformanceAPI,
            hasPerformanceAPI
              ? "Performance API が利用可能です"
              : "Performance API が利用できません"
          );

          testResults.initialization =
            hasRequiredProperties && hasPerformanceAPI;
          updateTestProgress();
        } catch (error) {
          displayTestResult(
            "init-test-results",
            "初期化テスト",
            false,
            `エラーが発生しました: ${error.message}`
          );
        }
      }

      // Test 2: Script Loading Time Measurement
      function runScriptTimingTest() {
        const container = document.getElementById("script-timing-results");
        container.innerHTML = "";

        if (!testPerformanceMonitor) {
          displayTestResult(
            "script-timing-results",
            "スクリプトタイミング",
            false,
            "PerformanceMonitor が初期化されていません"
          );
          return;
        }

        try {
          // Test script timing start
          testPerformanceMonitor.startScriptTiming("test-script.js");

          // Simulate script loading delay
          setTimeout(() => {
            testPerformanceMonitor.endScriptTiming("test-script.js", true);

            // Check if timing was recorded
            const scriptTiming =
              testPerformanceMonitor.metrics.scriptLoadTimes.get(
                "test-script.js"
              );
            const hasValidTiming =
              scriptTiming &&
              scriptTiming.duration !== null &&
              scriptTiming.status === "loaded";

            displayTestResult(
              "script-timing-results",
              "スクリプト読み込み時間測定",
              hasValidTiming,
              hasValidTiming
                ? `測定成功: ${scriptTiming.duration.toFixed(2)}ms`
                : "測定に失敗しました",
              hasValidTiming ? JSON.stringify(scriptTiming, null, 2) : null
            );

            testResults.scriptTiming = hasValidTiming;
            updateTestProgress();
          }, 100);
        } catch (error) {
          displayTestResult(
            "script-timing-results",
            "スクリプトタイミング",
            false,
            `エラーが発生しました: ${error.message}`
          );
        }
      }

      // Test 3: Initialization Process Timing
      function runInitializationTimingTest() {
        const container = document.getElementById("init-timing-results");
        container.innerHTML = "";

        if (!testPerformanceMonitor) {
          displayTestResult(
            "init-timing-results",
            "初期化タイミング",
            false,
            "PerformanceMonitor が初期化されていません"
          );
          return;
        }

        try {
          // Test initialization phase timing
          testPerformanceMonitor.startInitializationPhase("test-phase");

          // Simulate initialization work
          setTimeout(() => {
            testPerformanceMonitor.endInitializationPhase("test-phase", true);

            // Check if phase timing was recorded
            const phaseTiming =
              testPerformanceMonitor.metrics.initializationPhases.get(
                "test-phase"
              );
            const hasValidTiming =
              phaseTiming &&
              phaseTiming.duration !== null &&
              phaseTiming.status === "completed";

            displayTestResult(
              "init-timing-results",
              "初期化フェーズ時間測定",
              hasValidTiming,
              hasValidTiming
                ? `測定成功: ${phaseTiming.duration.toFixed(2)}ms`
                : "測定に失敗しました",
              hasValidTiming ? JSON.stringify(phaseTiming, null, 2) : null
            );

            testResults.initTiming = hasValidTiming;
            updateTestProgress();
          }, 150);
        } catch (error) {
          displayTestResult(
            "init-timing-results",
            "初期化タイミング",
            false,
            `エラーが発生しました: ${error.message}`
          );
        }
      }

      // Test 4: Memory Usage Monitoring
      function runMemoryMonitoringTest() {
        const container = document.getElementById("memory-monitoring-results");
        container.innerHTML = "";

        if (!testPerformanceMonitor) {
          displayTestResult(
            "memory-monitoring-results",
            "メモリ監視",
            false,
            "PerformanceMonitor が初期化されていません"
          );
          return;
        }

        try {
          // Test memory snapshot
          const snapshot =
            testPerformanceMonitor.takeMemorySnapshot("test-snapshot");

          if (performance.memory) {
            const hasValidSnapshot =
              snapshot &&
              snapshot.usedJSHeapSize !== undefined &&
              snapshot.usedMB !== undefined;

            displayTestResult(
              "memory-monitoring-results",
              "メモリスナップショット",
              hasValidSnapshot,
              hasValidSnapshot
                ? `スナップショット成功: ${snapshot.usedMB}MB`
                : "スナップショットに失敗しました",
              hasValidSnapshot ? JSON.stringify(snapshot, null, 2) : null
            );

            // Test memory monitoring start/stop
            testPerformanceMonitor.startMemoryMonitoring();

            setTimeout(() => {
              testPerformanceMonitor.stopMemoryMonitoring();

              const hasMultipleSnapshots =
                testPerformanceMonitor.metrics.memorySnapshots.length > 1;
              displayTestResult(
                "memory-monitoring-results",
                "メモリ監視機能",
                hasMultipleSnapshots,
                hasMultipleSnapshots
                  ? `監視成功: ${testPerformanceMonitor.metrics.memorySnapshots.length}個のスナップショット`
                  : "監視に失敗しました"
              );

              testResults.memoryMonitoring =
                hasValidSnapshot && hasMultipleSnapshots;
              updateTestProgress();
            }, 1200);
          } else {
            displayTestResult(
              "memory-monitoring-results",
              "メモリ監視",
              false,
              "performance.memory API が利用できません（一部ブラウザでは制限されています）"
            );
            testResults.memoryMonitoring = true; // API制限は正常とみなす
            updateTestProgress();
          }
        } catch (error) {
          displayTestResult(
            "memory-monitoring-results",
            "メモリ監視",
            false,
            `エラーが発生しました: ${error.message}`
          );
        }
      }

      // Test 5: Performance Statistics Display
      function runStatsDisplayTest() {
        const container = document.getElementById("stats-display-results");
        container.innerHTML = "";

        if (!testPerformanceMonitor) {
          displayTestResult(
            "stats-display-results",
            "統計表示",
            false,
            "PerformanceMonitor が初期化されていません"
          );
          return;
        }

        try {
          // Generate detailed report
          const report = testPerformanceMonitor.generateDetailedReport();

          const hasValidReport =
            report &&
            report.summary &&
            report.scriptTiming &&
            report.initializationPhases;

          displayTestResult(
            "stats-display-results",
            "詳細レポート生成",
            hasValidReport,
            hasValidReport
              ? "レポートが正常に生成されました"
              : "レポート生成に失敗しました",
            hasValidReport ? JSON.stringify(report.summary, null, 2) : null
          );

          // Test performance rating calculation
          const rating = testPerformanceMonitor.calculatePerformanceRating();
          const hasValidRating = ["excellent", "good", "fair", "poor"].includes(
            rating
          );

          displayTestResult(
            "stats-display-results",
            "パフォーマンス評価",
            hasValidRating,
            hasValidRating ? `評価: ${rating}` : "評価の計算に失敗しました"
          );

          // Test recommendations generation
          const recommendations =
            testPerformanceMonitor.generateRecommendations();
          const hasRecommendations = Array.isArray(recommendations);

          displayTestResult(
            "stats-display-results",
            "推奨事項生成",
            hasRecommendations,
            hasRecommendations
              ? `${recommendations.length}個の推奨事項が生成されました`
              : "推奨事項の生成に失敗しました"
          );

          testResults.statsDisplay =
            hasValidReport && hasValidRating && hasRecommendations;
          updateTestProgress();
        } catch (error) {
          displayTestResult(
            "stats-display-results",
            "統計表示",
            false,
            `エラーが発生しました: ${error.message}`
          );
        }
      }

      // Test 6: Integration Test
      function runIntegrationTest() {
        const container = document.getElementById("integration-results");
        container.innerHTML = "";

        try {
          // Test full workflow
          const integrationMonitor = new PerformanceMonitor({
            enableScriptTiming: true,
            enableMemoryMonitoring: true,
            enableDetailedLogging: false, // Reduce noise
            reportingInterval: 500,
          });

          // Simulate complete initialization workflow
          integrationMonitor.startInitializationPhase("integration-test");
          integrationMonitor.startScriptTiming("integration-script-1.js");
          integrationMonitor.startScriptTiming("integration-script-2.js");

          setTimeout(() => {
            integrationMonitor.endScriptTiming("integration-script-1.js", true);
            integrationMonitor.endScriptTiming("integration-script-2.js", true);
            integrationMonitor.endInitializationPhase("integration-test", true);

            // Generate final report
            const finalReport = integrationMonitor.finalize();

            const integrationSuccess =
              finalReport &&
              finalReport.summary &&
              finalReport.scriptTiming.details.length === 2 &&
              finalReport.initializationPhases.length === 1;

            displayTestResult(
              "integration-results",
              "統合テスト",
              integrationSuccess,
              integrationSuccess
                ? "全機能が正常に連携しています"
                : "統合テストに失敗しました",
              integrationSuccess
                ? `総読み込み時間: ${finalReport.summary.totalLoadTime.toFixed(
                    2
                  )}ms\n` +
                    `スクリプト数: ${finalReport.scriptTiming.details.length}\n` +
                    `初期化フェーズ数: ${finalReport.initializationPhases.length}`
                : null
            );

            testResults.integration = integrationSuccess;
            updateTestProgress();
          }, 200);
        } catch (error) {
          displayTestResult(
            "integration-results",
            "統合テスト",
            false,
            `エラーが発生しました: ${error.message}`
          );
        }
      }

      // Run all tests
      function runAllTests() {
        clearResults();

        runInitializationTest();

        setTimeout(() => runScriptTimingTest(), 200);
        setTimeout(() => runInitializationTimingTest(), 400);
        setTimeout(() => runMemoryMonitoringTest(), 600);
        setTimeout(() => runStatsDisplayTest(), 2000);
        setTimeout(() => runIntegrationTest(), 2500);
      }

      // Clear all results
      function clearResults() {
        const containers = [
          "init-test-results",
          "script-timing-results",
          "init-timing-results",
          "memory-monitoring-results",
          "stats-display-results",
          "integration-results",
          "performance-report",
        ];

        containers.forEach((id) => {
          const container = document.getElementById(id);
          if (container) container.innerHTML = "";
        });

        testResults = {
          initialization: false,
          scriptTiming: false,
          initTiming: false,
          memoryMonitoring: false,
          statsDisplay: false,
          integration: false,
        };

        updateTestProgress();
      }

      // Display performance report
      function displayPerformanceReport() {
        const container = document.getElementById("performance-report");

        if (!testPerformanceMonitor) {
          container.textContent = "PerformanceMonitor が初期化されていません";
          return;
        }

        try {
          const report = testPerformanceMonitor.generateDetailedReport();
          container.textContent = JSON.stringify(report, null, 2);
        } catch (error) {
          container.textContent = `レポート生成エラー: ${error.message}`;
        }
      }

      // Initialize test page
      document.addEventListener("DOMContentLoaded", function () {
        updateTestProgress();

        // Display info about the test
        const infoDiv = document.createElement("div");
        infoDiv.className = "test-result test-info";
        infoDiv.textContent =
          "💡 このテストページは、タスク8「パフォーマンス監視機能の実装」の検証を行います。各テストボタンをクリックして機能を確認してください。";

        const firstSection = document.querySelector(".test-section");
        firstSection.appendChild(infoDiv);
      });
    </script>
  </body>
</html>
