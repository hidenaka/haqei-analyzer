<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>シナリオ質問デバッグ (Q25-Q30)</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/components.css" />
    <style>
        .debug-panel {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .error { background-color: #ffe6e6; border-color: #ff9999; }
        .success { background-color: #e6ffe6; border-color: #99ff99; }
        .warning { background-color: #fff3e0; border-color: #ffcc99; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .question-test {
            border: 2px solid #333;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
            min-height: 300px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .answer-summary {
            background: #e9ecef;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>🔍 シナリオ質問デバッグ (Q25-Q30)</h1>
    
    <div class="debug-panel">
        <h3>テスト制御</h3>
        <button class="btn" onclick="initializeTest()">テスト初期化</button>
        <button class="btn" onclick="testAllScenarioQuestions()">全シナリオ質問テスト</button>
        <button class="btn" onclick="testSpecificQuestion(25)">Q25テスト</button>
        <button class="btn" onclick="testSpecificQuestion(26)">Q26テスト</button>
        <button class="btn" onclick="testSpecificQuestion(27)">Q27テスト</button>
        <button class="btn" onclick="testSpecificQuestion(28)">Q28テスト</button>
        <button class="btn" onclick="testSpecificQuestion(29)">Q29テスト</button>
        <button class="btn" onclick="testSpecificQuestion(30)">Q30テスト</button>
        <button class="btn" onclick="clearAll()">クリア</button>
    </div>

    <div class="debug-panel">
        <h3>テスト状況</h3>
        <div id="testStatus">初期化前</div>
    </div>

    <div class="question-test">
        <h3>質問表示エリア</h3>
        <div id="questionFlowContainer">
            QuestionFlowがここに表示されます
        </div>
    </div>

    <div class="debug-panel">
        <h3>回答サマリー</h3>
        <div id="answerSummary">回答データがここに表示されます</div>
    </div>

    <div class="debug-panel">
        <h3>詳細ログ</h3>
        <pre id="debugLog">デバッグログがここに表示されます...</pre>
    </div>

    <!-- Scripts -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
        let questionFlow = null;
        let mockStorage = null;
        let scenarioQuestions = [];
        let testAnswers = [];
        let debugLog = document.getElementById('debugLog');
        
        function log(message, type = 'INFO') {
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${type}: ${message}`;
            debugLog.textContent += logMessage + '\n';
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logMessage);
        }

        function updateStatus(message) {
            document.getElementById('testStatus').textContent = message;
            log(`STATUS: ${message}`);
        }

        function clearAll() {
            debugLog.textContent = '';
            document.getElementById('answerSummary').innerHTML = '回答データがここに表示されます';
            testAnswers = [];
            updateStatus('クリア完了');
        }

        function initializeTest() {
            log('シナリオ質問テスト初期化開始');
            updateStatus('初期化中...');
            
            try {
                // 質問データ読み込み確認
                if (typeof WORLDVIEW_QUESTIONS === 'undefined' || typeof SCENARIO_QUESTIONS === 'undefined') {
                    throw new Error('質問データが読み込まれていません');
                }
                
                // 全質問を結合
                const allQuestions = [...WORLDVIEW_QUESTIONS, ...SCENARIO_QUESTIONS];
                
                // シナリオ質問のみを抽出
                scenarioQuestions = allQuestions.filter(q => 
                    q.scenario && q.inner_q && q.outer_q
                );
                
                log(`シナリオ質問数: ${scenarioQuestions.length}`);
                
                // Q25-Q30を特定
                const targetQuestions = scenarioQuestions.filter(q => {
                    const questionNum = parseInt(q.id.replace('q', ''));
                    return questionNum >= 25 && questionNum <= 30;
                });
                
                log(`Q25-Q30のシナリオ質問数: ${targetQuestions.length}`);
                targetQuestions.forEach(q => {
                    log(`  ${q.id}: ${q.scenario.substring(0, 50)}...`);
                });
                
                // モックストレージ作成
                mockStorage = {
                    answers: [],
                    progress: null,
                    saveAnswers: function(answers) { 
                        this.answers = Array.isArray(answers) ? [...answers] : [answers];
                        log(`ストレージ: ${this.answers.length}回答保存`);
                    },
                    getAnswers: function() { return this.answers; },
                    saveProgress: function(progress) { this.progress = progress; },
                    getProgress: function() { return this.progress; }
                };

                // QuestionFlow初期化
                questionFlow = new QuestionFlow("questionFlowContainer", {
                    storageManager: mockStorage
                });

                questionFlow.init();
                
                updateStatus(`初期化完了 - ${questionFlow.questions.length}問読み込み`);
                log('QuestionFlow初期化完了');
                
            } catch (error) {
                updateStatus(`初期化失敗: ${error.message}`);
                log(`初期化エラー: ${error.message}`, 'ERROR');
            }
        }

        function testSpecificQuestion(questionNum) {
            if (!questionFlow) {
                updateStatus('QuestionFlow未初期化');
                return;
            }
            
            log(`\n=== Q${questionNum} 専用テスト開始 ===`);
            
            // 質問を検索
            const questionIndex = questionFlow.questions.findIndex(q => q.id === `q${questionNum}`);
            if (questionIndex === -1) {
                log(`Q${questionNum}が見つかりません`, 'ERROR');
                return;
            }
            
            const question = questionFlow.questions[questionIndex];
            log(`Q${questionNum}を発見: ${question.scenario.substring(0, 50)}...`);
            
            // 質問に移動
            questionFlow.currentQuestionIndex = questionIndex;
            questionFlow.renderCurrentQuestion();
            
            // 質問データの詳細検査
            log(`質問データ詳細:`);
            log(`  ID: ${question.id}`);
            log(`  シナリオ: ${question.scenario}`);
            log(`  内面質問: ${question.inner_q}`);
            log(`  外面質問: ${question.outer_q}`);
            log(`  内面選択肢数: ${question.options.inner ? question.options.inner.length : 0}`);
            log(`  外面選択肢数: ${question.options.outer ? question.options.outer.length : 0}`);
            
            // 模擬回答を作成
            setTimeout(() => {
                simulateAnswersForQuestion(question);
            }, 500);
        }

        function simulateAnswersForQuestion(question) {
            log(`\n--- Q${question.id} 模擬回答テスト ---`);
            
            // 内面選択肢の模擬回答
            if (question.options.inner && question.options.inner.length > 0) {
                const innerOption = question.options.inner[0];
                log(`内面選択肢模擬選択: ${innerOption.value} - ${innerOption.text}`);
                
                const innerMockElement = {
                    value: innerOption.value,
                    dataset: {
                        scoring: JSON.stringify(innerOption.scoring_tags),
                        choiceType: "inner"
                    }
                };
                
                questionFlow.handleAnswerChange(innerMockElement);
            }
            
            // 外面選択肢の模擬回答
            setTimeout(() => {
                if (question.options.outer && question.options.outer.length > 0) {
                    const outerOption = question.options.outer[0];
                    log(`外面選択肢模擬選択: ${outerOption.value} - ${outerOption.text}`);
                    
                    const outerMockElement = {
                        value: outerOption.value,
                        dataset: {
                            scoring: JSON.stringify(outerOption.scoring_tags),
                            choiceType: "outer"
                        }
                    };
                    
                    questionFlow.handleAnswerChange(outerMockElement);
                }
                
                // 回答結果を検証
                setTimeout(() => {
                    validateQuestionAnswer(question);
                }, 100);
            }, 200);
        }

        function validateQuestionAnswer(question) {
            log(`\n--- Q${question.id} 回答検証 ---`);
            
            // 保存された回答を検索
            const savedAnswer = questionFlow.answers.find(a => a.questionId === question.id);
            
            if (!savedAnswer) {
                log(`❌ Q${question.id}の回答が保存されていません`, 'ERROR');
                return;
            }
            
            log(`✅ Q${question.id}の回答が見つかりました`);
            log(`回答詳細: ${JSON.stringify(savedAnswer, null, 2)}`);
            
            // 内面・外面選択肢の検証
            const hasInner = savedAnswer.innerChoice && savedAnswer.innerChoice.value;
            const hasOuter = savedAnswer.outerChoice && savedAnswer.outerChoice.value;
            
            log(`内面選択肢: ${hasInner ? '✅' : '❌'} ${hasInner ? savedAnswer.innerChoice.value : '未保存'}`);
            log(`外面選択肢: ${hasOuter ? '✅' : '❌'} ${hasOuter ? savedAnswer.outerChoice.value : '未保存'}`);
            
            if (!hasInner || !hasOuter) {
                log(`❌ Q${question.id}の回答が不完全です`, 'ERROR');
            } else {
                log(`✅ Q${question.id}の回答が完全です`, 'SUCCESS');
            }
            
            updateAnswerSummary();
        }

        function updateAnswerSummary() {
            const summaryDiv = document.getElementById('answerSummary');
            
            if (questionFlow.answers.length === 0) {
                summaryDiv.innerHTML = '回答データなし';
                return;
            }
            
            let html = '<h4>保存済み回答一覧</h4>';
            
            questionFlow.answers.forEach((answer, index) => {
                const question = questionFlow.questions.find(q => q.id === answer.questionId);
                const isScenario = question && question.scenario;
                
                html += `<div class="answer-summary">`;
                html += `<strong>${answer.questionId}</strong><br>`;
                
                if (isScenario) {
                    const hasInner = answer.innerChoice && answer.innerChoice.value;
                    const hasOuter = answer.outerChoice && answer.outerChoice.value;
                    html += `内面: ${hasInner ? '✅ ' + answer.innerChoice.value : '❌ 未保存'}<br>`;
                    html += `外面: ${hasOuter ? '✅ ' + answer.outerChoice.value : '❌ 未保存'}<br>`;
                } else {
                    html += `回答: ${answer.selectedValue || '未保存'}<br>`;
                }
                
                html += `</div>`;
            });
            
            summaryDiv.innerHTML = html;
        }

        function testAllScenarioQuestions() {
            log('\n=== 全シナリオ質問テスト開始 ===');
            
            const targetQuestions = [25, 26, 27, 28, 29, 30];
            let currentIndex = 0;
            
            function testNext() {
                if (currentIndex >= targetQuestions.length) {
                    log('=== 全シナリオ質問テスト完了 ===');
                    updateStatus('全シナリオ質問テスト完了');
                    return;
                }
                
                const questionNum = targetQuestions[currentIndex];
                testSpecificQuestion(questionNum);
                
                currentIndex++;
                setTimeout(testNext, 2000); // 2秒間隔で次の質問をテスト
            }
            
            testNext();
        }

        // ページ読み込み時に自動初期化
        window.addEventListener('load', () => {
            log('ページ読み込み完了');
            updateStatus('ページ読み込み完了 - 初期化ボタンをクリックしてください');
        });
    </script>
</body>
</html>