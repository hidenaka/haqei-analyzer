<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ‡ãƒãƒƒã‚° (Q25-Q30)</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/components.css" />
    <style>
        .debug-panel {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .error { background-color: #ffe6e6; border-color: #ff9999; }
        .success { background-color: #e6ffe6; border-color: #99ff99; }
        .warning { background-color: #fff3e0; border-color: #ffcc99; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .question-test {
            border: 2px solid #333;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
            min-height: 300px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .answer-summary {
            background: #e9ecef;
            padding: 10px;
            border-radius: 3px;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ‡ãƒãƒƒã‚° (Q25-Q30)</h1>
    
    <div class="debug-panel">
        <h3>ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h3>
        <button class="btn" onclick="initializeTest()">ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–</button>
        <button class="btn" onclick="testAllScenarioQuestions()">å…¨ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="testSpecificQuestion(25)">Q25ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="testSpecificQuestion(26)">Q26ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="testSpecificQuestion(27)">Q27ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="testSpecificQuestion(28)">Q28ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="testSpecificQuestion(29)">Q29ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="testSpecificQuestion(30)">Q30ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="clearAll()">ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="debug-panel">
        <h3>ãƒ†ã‚¹ãƒˆçŠ¶æ³</h3>
        <div id="testStatus">åˆæœŸåŒ–å‰</div>
    </div>

    <div class="question-test">
        <h3>è³ªå•è¡¨ç¤ºã‚¨ãƒªã‚¢</h3>
        <div id="questionFlowContainer">
            QuestionFlowãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
    </div>

    <div class="debug-panel">
        <h3>å›ç­”ã‚µãƒãƒªãƒ¼</h3>
        <div id="answerSummary">å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™</div>
    </div>

    <div class="debug-panel">
        <h3>è©³ç´°ãƒ­ã‚°</h3>
        <pre id="debugLog">ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</pre>
    </div>

    <!-- Scripts -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
        let questionFlow = null;
        let mockStorage = null;
        let scenarioQuestions = [];
        let testAnswers = [];
        let debugLog = document.getElementById('debugLog');
        
        function log(message, type = 'INFO') {
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${type}: ${message}`;
            debugLog.textContent += logMessage + '\n';
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logMessage);
        }

        function updateStatus(message) {
            document.getElementById('testStatus').textContent = message;
            log(`STATUS: ${message}`);
        }

        function clearAll() {
            debugLog.textContent = '';
            document.getElementById('answerSummary').innerHTML = 'å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™';
            testAnswers = [];
            updateStatus('ã‚¯ãƒªã‚¢å®Œäº†');
        }

        function initializeTest() {
            log('ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–é–‹å§‹');
            updateStatus('åˆæœŸåŒ–ä¸­...');
            
            try {
                // è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ç¢ºèª
                if (typeof WORLDVIEW_QUESTIONS === 'undefined' || typeof SCENARIO_QUESTIONS === 'undefined') {
                    throw new Error('è³ªå•ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // å…¨è³ªå•ã‚’çµåˆ
                const allQuestions = [...WORLDVIEW_QUESTIONS, ...SCENARIO_QUESTIONS];
                
                // ã‚·ãƒŠãƒªã‚ªè³ªå•ã®ã¿ã‚’æŠ½å‡º
                scenarioQuestions = allQuestions.filter(q => 
                    q.scenario && q.inner_q && q.outer_q
                );
                
                log(`ã‚·ãƒŠãƒªã‚ªè³ªå•æ•°: ${scenarioQuestions.length}`);
                
                // Q25-Q30ã‚’ç‰¹å®š
                const targetQuestions = scenarioQuestions.filter(q => {
                    const questionNum = parseInt(q.id.replace('q', ''));
                    return questionNum >= 25 && questionNum <= 30;
                });
                
                log(`Q25-Q30ã®ã‚·ãƒŠãƒªã‚ªè³ªå•æ•°: ${targetQuestions.length}`);
                targetQuestions.forEach(q => {
                    log(`  ${q.id}: ${q.scenario.substring(0, 50)}...`);
                });
                
                // ãƒ¢ãƒƒã‚¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½œæˆ
                mockStorage = {
                    answers: [],
                    progress: null,
                    saveAnswers: function(answers) { 
                        this.answers = Array.isArray(answers) ? [...answers] : [answers];
                        log(`ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: ${this.answers.length}å›ç­”ä¿å­˜`);
                    },
                    getAnswers: function() { return this.answers; },
                    saveProgress: function(progress) { this.progress = progress; },
                    getProgress: function() { return this.progress; }
                };

                // QuestionFlowåˆæœŸåŒ–
                questionFlow = new QuestionFlow("questionFlowContainer", {
                    storageManager: mockStorage
                });

                questionFlow.init();
                
                updateStatus(`åˆæœŸåŒ–å®Œäº† - ${questionFlow.questions.length}å•èª­ã¿è¾¼ã¿`);
                log('QuestionFlowåˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                updateStatus(`åˆæœŸåŒ–å¤±æ•—: ${error.message}`);
                log(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }

        function testSpecificQuestion(questionNum) {
            if (!questionFlow) {
                updateStatus('QuestionFlowæœªåˆæœŸåŒ–');
                return;
            }
            
            log(`\n=== Q${questionNum} å°‚ç”¨ãƒ†ã‚¹ãƒˆé–‹å§‹ ===`);
            
            // è³ªå•ã‚’æ¤œç´¢
            const questionIndex = questionFlow.questions.findIndex(q => q.id === `q${questionNum}`);
            if (questionIndex === -1) {
                log(`Q${questionNum}ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`, 'ERROR');
                return;
            }
            
            const question = questionFlow.questions[questionIndex];
            log(`Q${questionNum}ã‚’ç™ºè¦‹: ${question.scenario.substring(0, 50)}...`);
            
            // è³ªå•ã«ç§»å‹•
            questionFlow.currentQuestionIndex = questionIndex;
            questionFlow.renderCurrentQuestion();
            
            // è³ªå•ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°æ¤œæŸ»
            log(`è³ªå•ãƒ‡ãƒ¼ã‚¿è©³ç´°:`);
            log(`  ID: ${question.id}`);
            log(`  ã‚·ãƒŠãƒªã‚ª: ${question.scenario}`);
            log(`  å†…é¢è³ªå•: ${question.inner_q}`);
            log(`  å¤–é¢è³ªå•: ${question.outer_q}`);
            log(`  å†…é¢é¸æŠè‚¢æ•°: ${question.options.inner ? question.options.inner.length : 0}`);
            log(`  å¤–é¢é¸æŠè‚¢æ•°: ${question.options.outer ? question.options.outer.length : 0}`);
            
            // æ¨¡æ“¬å›ç­”ã‚’ä½œæˆ
            setTimeout(() => {
                simulateAnswersForQuestion(question);
            }, 500);
        }

        function simulateAnswersForQuestion(question) {
            log(`\n--- Q${question.id} æ¨¡æ“¬å›ç­”ãƒ†ã‚¹ãƒˆ ---`);
            
            // å†…é¢é¸æŠè‚¢ã®æ¨¡æ“¬å›ç­”
            if (question.options.inner && question.options.inner.length > 0) {
                const innerOption = question.options.inner[0];
                log(`å†…é¢é¸æŠè‚¢æ¨¡æ“¬é¸æŠ: ${innerOption.value} - ${innerOption.text}`);
                
                const innerMockElement = {
                    value: innerOption.value,
                    dataset: {
                        scoring: JSON.stringify(innerOption.scoring_tags),
                        choiceType: "inner"
                    }
                };
                
                questionFlow.handleAnswerChange(innerMockElement);
            }
            
            // å¤–é¢é¸æŠè‚¢ã®æ¨¡æ“¬å›ç­”
            setTimeout(() => {
                if (question.options.outer && question.options.outer.length > 0) {
                    const outerOption = question.options.outer[0];
                    log(`å¤–é¢é¸æŠè‚¢æ¨¡æ“¬é¸æŠ: ${outerOption.value} - ${outerOption.text}`);
                    
                    const outerMockElement = {
                        value: outerOption.value,
                        dataset: {
                            scoring: JSON.stringify(outerOption.scoring_tags),
                            choiceType: "outer"
                        }
                    };
                    
                    questionFlow.handleAnswerChange(outerMockElement);
                }
                
                // å›ç­”çµæœã‚’æ¤œè¨¼
                setTimeout(() => {
                    validateQuestionAnswer(question);
                }, 100);
            }, 200);
        }

        function validateQuestionAnswer(question) {
            log(`\n--- Q${question.id} å›ç­”æ¤œè¨¼ ---`);
            
            // ä¿å­˜ã•ã‚ŒãŸå›ç­”ã‚’æ¤œç´¢
            const savedAnswer = questionFlow.answers.find(a => a.questionId === question.id);
            
            if (!savedAnswer) {
                log(`âŒ Q${question.id}ã®å›ç­”ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“`, 'ERROR');
                return;
            }
            
            log(`âœ… Q${question.id}ã®å›ç­”ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`);
            log(`å›ç­”è©³ç´°: ${JSON.stringify(savedAnswer, null, 2)}`);
            
            // å†…é¢ãƒ»å¤–é¢é¸æŠè‚¢ã®æ¤œè¨¼
            const hasInner = savedAnswer.innerChoice && savedAnswer.innerChoice.value;
            const hasOuter = savedAnswer.outerChoice && savedAnswer.outerChoice.value;
            
            log(`å†…é¢é¸æŠè‚¢: ${hasInner ? 'âœ…' : 'âŒ'} ${hasInner ? savedAnswer.innerChoice.value : 'æœªä¿å­˜'}`);
            log(`å¤–é¢é¸æŠè‚¢: ${hasOuter ? 'âœ…' : 'âŒ'} ${hasOuter ? savedAnswer.outerChoice.value : 'æœªä¿å­˜'}`);
            
            if (!hasInner || !hasOuter) {
                log(`âŒ Q${question.id}ã®å›ç­”ãŒä¸å®Œå…¨ã§ã™`, 'ERROR');
            } else {
                log(`âœ… Q${question.id}ã®å›ç­”ãŒå®Œå…¨ã§ã™`, 'SUCCESS');
            }
            
            updateAnswerSummary();
        }

        function updateAnswerSummary() {
            const summaryDiv = document.getElementById('answerSummary');
            
            if (questionFlow.answers.length === 0) {
                summaryDiv.innerHTML = 'å›ç­”ãƒ‡ãƒ¼ã‚¿ãªã—';
                return;
            }
            
            let html = '<h4>ä¿å­˜æ¸ˆã¿å›ç­”ä¸€è¦§</h4>';
            
            questionFlow.answers.forEach((answer, index) => {
                const question = questionFlow.questions.find(q => q.id === answer.questionId);
                const isScenario = question && question.scenario;
                
                html += `<div class="answer-summary">`;
                html += `<strong>${answer.questionId}</strong><br>`;
                
                if (isScenario) {
                    const hasInner = answer.innerChoice && answer.innerChoice.value;
                    const hasOuter = answer.outerChoice && answer.outerChoice.value;
                    html += `å†…é¢: ${hasInner ? 'âœ… ' + answer.innerChoice.value : 'âŒ æœªä¿å­˜'}<br>`;
                    html += `å¤–é¢: ${hasOuter ? 'âœ… ' + answer.outerChoice.value : 'âŒ æœªä¿å­˜'}<br>`;
                } else {
                    html += `å›ç­”: ${answer.selectedValue || 'æœªä¿å­˜'}<br>`;
                }
                
                html += `</div>`;
            });
            
            summaryDiv.innerHTML = html;
        }

        function testAllScenarioQuestions() {
            log('\n=== å…¨ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            const targetQuestions = [25, 26, 27, 28, 29, 30];
            let currentIndex = 0;
            
            function testNext() {
                if (currentIndex >= targetQuestions.length) {
                    log('=== å…¨ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ†ã‚¹ãƒˆå®Œäº† ===');
                    updateStatus('å…¨ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ†ã‚¹ãƒˆå®Œäº†');
                    return;
                }
                
                const questionNum = targetQuestions[currentIndex];
                testSpecificQuestion(questionNum);
                
                currentIndex++;
                setTimeout(testNext, 2000); // 2ç§’é–“éš”ã§æ¬¡ã®è³ªå•ã‚’ãƒ†ã‚¹ãƒˆ
            }
            
            testNext();
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•åˆæœŸåŒ–
        window.addEventListener('load', () => {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            updateStatus('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
        });
    </script>
</body>
</html>