<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaQei Analyzer - 実装テスト</title>
    
    <!-- Chart.js for レーダーチャート -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- BaseComponent (必要に応じて) -->
    <script>
        class BaseComponent {
            constructor(containerId, options = {}) {
                this.containerId = containerId;
                this.container = typeof containerId === 'string' ? 
                    document.getElementById(containerId) : containerId;
                this.options = { ...this.defaultOptions, ...options };
            }
            
            get defaultOptions() {
                return {};
            }
            
            show() {
                if (this.container) {
                    this.container.style.display = 'block';
                }
            }
            
            hide() {
                if (this.container) {
                    this.container.style.display = 'none';
                }
            }
        }
        
        // グローバルに配置
        window.BaseComponent = BaseComponent;
    </script>
    
    <!-- Enhanced Results CSS -->
    <link rel="stylesheet" href="css/enhanced-results.css">
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .test-section {
            margin: 30px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #fafafa;
        }
        
        .test-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
        }
        
        .test-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #007bff;
            color: white;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .test-btn:hover {
            background: #0056b3;
        }
        
        .test-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .test-result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        #results-container {
            margin-top: 30px;
            min-height: 400px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-loading {
            background: #ffc107;
            animation: pulse 1s infinite;
        }
        
        .status-success {
            background: #28a745;
        }
        
        .status-error {
            background: #dc3545;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🧪 HaQei Analyzer Phase 3 実装テスト</h1>
            <p>以下のボタンをクリックして、各機能の動作を確認してください</p>
        </div>

        <!-- システム初期化テスト -->
        <div class="test-section">
            <h3><span id="init-status" class="status-indicator status-loading"></span>1. システム初期化テスト</h3>
            <p>各コンポーネントが正常に読み込まれるかテストします</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testSystemInitialization()">システム初期化テスト</button>
                <button class="test-btn" onclick="testModuleImports()">モジュールインポートテスト</button>
                <button class="test-btn" onclick="testDependencies()">依存関係チェック</button>
            </div>
            <div id="init-result" class="test-result info" style="display: none;"></div>
        </div>

        <!-- データ生成テスト -->
        <div class="test-section">
            <h3><span id="data-status" class="status-indicator status-loading"></span>2. テストデータ生成</h3>
            <p>診断結果のサンプルデータを生成します</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="generateTestData()">サンプルデータ生成</button>
                <button class="test-btn" onclick="generateMultipleTestData()">複数パターン生成</button>
                <button class="test-btn" onclick="validateTestData()">データ構造検証</button>
            </div>
            <div id="data-result" class="test-result info" style="display: none;"></div>
        </div>

        <!-- 高度相性分析テスト -->
        <div class="test-section">
            <h3><span id="compatibility-status" class="status-indicator status-loading"></span>3. 高度相性分析テスト</h3>
            <p>AdvancedCompatibilityEngine の機能をテストします</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testAdvancedCompatibility()">相性分析実行</button>
                <button class="test-btn" onclick="testSpecialPatterns()">特殊パターン検出</button>
                <button class="test-btn" onclick="testHistoricalMatches()">歴史人物マッチング</button>
                <button class="test-btn" onclick="testContextEvaluation()">コンテキスト評価</button>
            </div>
            <div id="compatibility-result" class="test-result info" style="display: none;"></div>
        </div>

        <!-- エクスポート機能テスト -->
        <div class="test-section">
            <h3><span id="export-status" class="status-indicator status-loading"></span>4. エクスポート機能テスト</h3>
            <p>PDF・画像出力機能をテストします</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testPDFExport()">PDF出力テスト</button>
                <button class="test-btn" onclick="testImageExport()">画像出力テスト</button>
                <button class="test-btn" onclick="testSNSFormats()">SNS形式生成</button>
                <button class="test-btn" onclick="testExportErrors()">エラーハンドリング</button>
            </div>
            <div id="export-result" class="test-result info" style="display: none;"></div>
        </div>

        <!-- 履歴管理テスト -->
        <div class="test-section">
            <h3><span id="history-status" class="status-indicator status-loading"></span>5. 履歴管理テスト</h3>
            <p>DiagnosisHistoryManager の機能をテストします</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testHistorySave()">履歴保存テスト</button>
                <button class="test-btn" onclick="testHistoryRetrieval()">履歴取得テスト</button>
                <button class="test-btn" onclick="testComparison()">結果比較テスト</button>
                <button class="test-btn" onclick="testTrendAnalysis()">トレンド分析</button>
                <button class="test-btn" onclick="testHistoryExport()">履歴エクスポート</button>
            </div>
            <div id="history-result" class="test-result info" style="display: none;"></div>
        </div>

        <!-- パフォーマンステスト -->
        <div class="test-section">
            <h3><span id="performance-status" class="status-indicator status-loading"></span>6. パフォーマンステスト</h3>
            <p>LazyLoadingとCacheManagerをテストします</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testLazyLoading()">遅延読み込みテスト</button>
                <button class="test-btn" onclick="testCacheManager()">キャッシュ機能テスト</button>
                <button class="test-btn" onclick="testPerformanceMetrics()">パフォーマンス測定</button>
                <button class="test-btn" onclick="stressTest()">負荷テスト</button>
            </div>
            <div id="performance-result" class="test-result info" style="display: none;"></div>
        </div>

        <!-- アナリティクステスト -->
        <div class="test-section">
            <h3><span id="analytics-status" class="status-indicator status-loading"></span>7. アナリティクステスト</h3>
            <p>AnalyticsCollector の機能をテストします</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="testAnalyticsCollection()">イベント収集テスト</button>
                <button class="test-btn" onclick="testUserBehaviorTracking()">行動追跡テスト</button>
                <button class="test-btn" onclick="testAnalyticsReport()">分析レポート生成</button>
                <button class="test-btn" onclick="testPrivacyFeatures()">プライバシー機能</button>
            </div>
            <div id="analytics-result" class="test-result info" style="display: none;"></div>
        </div>

        <!-- 統合テスト -->
        <div class="test-section">
            <h3><span id="integration-status" class="status-indicator status-loading"></span>8. 統合テスト</h3>
            <p>全機能を統合した実際の診断結果表示をテストします</p>
            <div class="test-buttons">
                <button class="test-btn" onclick="runIntegrationTest()">統合テスト実行</button>
                <button class="test-btn" onclick="testEnhancedMode()">拡張モードテスト</button>
                <button class="test-btn" onclick="testUserWorkflow()">ユーザーワークフロー</button>
                <button class="test-btn" onclick="runFullSystemTest()">フルシステムテスト</button>
            </div>
            <div id="integration-result" class="test-result info" style="display: none;"></div>
        </div>

        <!-- 結果表示エリア -->
        <div id="results-container"></div>
    </div>

    <script type="module">
        // テスト用のグローバル変数
        window.testResults = {};
        window.testModules = {};
        window.testData = null;

        // テスト結果表示ヘルパー
        function showTestResult(sectionId, status, message, details = '') {
            const statusElement = document.getElementById(`${sectionId}-status`);
            const resultElement = document.getElementById(`${sectionId}-result`);
            
            // ステータスインジケーター更新
            statusElement.className = `status-indicator status-${status}`;
            
            // 結果表示
            resultElement.style.display = 'block';
            resultElement.className = `test-result ${status}`;
            resultElement.textContent = `${message}\n${details}`;
            
            // グローバル結果に保存
            window.testResults[sectionId] = { status, message, details, timestamp: new Date() };
        }

        // 1. システム初期化テスト
        window.testSystemInitialization = async function() {
            try {
                showTestResult('init', 'loading', 'システムを初期化中...');
                
                // 基本的なブラウザAPI確認
                const checks = {
                    'LocalStorage': typeof Storage !== 'undefined',
                    'IndexedDB': 'indexedDB' in window,
                    'WebWorkers': typeof Worker !== 'undefined',
                    'IntersectionObserver': 'IntersectionObserver' in window,
                    'Fetch API': 'fetch' in window,
                    'ES6 Modules': true
                };
                
                const results = Object.entries(checks).map(([name, result]) => 
                    `${result ? '✅' : '❌'} ${name}: ${result ? 'サポート' : '非サポート'}`
                ).join('\n');
                
                const allSupported = Object.values(checks).every(Boolean);
                
                showTestResult('init', allSupported ? 'success' : 'warning', 
                    allSupported ? 'システム初期化成功' : '一部機能が制限される可能性があります', 
                    results);
                    
            } catch (error) {
                showTestResult('init', 'error', 'システム初期化失敗', error.message);
            }
        };

        window.testModuleImports = async function() {
            try {
                showTestResult('init', 'loading', 'モジュールをインポート中...');
                
                const modules = [
                    { name: 'AdvancedCompatibilityEngine', path: './js/core/AdvancedCompatibilityEngine.js' },
                    { name: 'PDFExporter', path: './js/core/PDFExporter.js' },
                    { name: 'ImageExporter', path: './js/core/ImageExporter.js' },
                    { name: 'DiagnosisHistoryManager', path: './js/core/DiagnosisHistoryManager.js' },
                    { name: 'LazyLoadingStrategy', path: './js/core/LazyLoadingStrategy.js' },
                    { name: 'CacheManager', path: './js/core/CacheManager.js' },
                    { name: 'AnalyticsCollector', path: './js/core/AnalyticsCollector.js' }
                ];
                
                const results = [];
                
                for (const module of modules) {
                    try {
                        const imported = await import(module.path);
                        window.testModules[module.name] = imported.default;
                        results.push(`✅ ${module.name}: インポート成功`);
                    } catch (error) {
                        results.push(`❌ ${module.name}: ${error.message}`);
                    }
                }
                
                const successCount = results.filter(r => r.startsWith('✅')).length;
                const status = successCount === modules.length ? 'success' : 
                             successCount > 0 ? 'warning' : 'error';
                
                showTestResult('init', status, 
                    `モジュールインポート完了 (${successCount}/${modules.length})`, 
                    results.join('\n'));
                    
            } catch (error) {
                showTestResult('init', 'error', 'モジュールインポート失敗', error.message);
            }
        };

        window.testDependencies = async function() {
            try {
                showTestResult('init', 'loading', '依存関係をチェック中...');
                
                const dependencies = {
                    'Chart.js': typeof Chart !== 'undefined',
                    'BaseComponent': typeof BaseComponent !== 'undefined'
                };
                
                const results = Object.entries(dependencies).map(([name, available]) => 
                    `${available ? '✅' : '❌'} ${name}: ${available ? '利用可能' : '未読み込み'}`
                ).join('\n');
                
                const allAvailable = Object.values(dependencies).every(Boolean);
                
                showTestResult('init', allAvailable ? 'success' : 'error', 
                    allAvailable ? '依存関係チェック完了' : '必要な依存関係が不足しています', 
                    results);
                    
            } catch (error) {
                showTestResult('init', 'error', '依存関係チェック失敗', error.message);
            }
        };

        // 2. テストデータ生成
        window.generateTestData = function() {
            try {
                showTestResult('data', 'loading', 'サンプルデータを生成中...');
                
                window.testData = {
                    engineOS: {
                        hexagramId: 1,
                        hexagramInfo: {
                            name: '乾為天',
                            reading: 'けんいてん',
                            catchphrase: '創造的エネルギーの源',
                            description: '天の龍のような創造的エネルギーに満ちた存在です。',
                            upper_trigram_id: 1,
                            lower_trigram_id: 1
                        },
                        userVector: {
                            dimension_1: 0.8,
                            dimension_2: 0.6,
                            dimension_3: 0.7,
                            dimension_4: 0.9,
                            dimension_5: 0.5,
                            dimension_6: 0.8,
                            dimension_7: 0.7,
                            dimension_8: 0.6
                        },
                        strength: 0.85
                    },
                    interfaceOS: {
                        hexagramId: 49,
                        hexagramInfo: {
                            name: '火風鼎',
                            reading: 'かふうてい',
                            catchphrase: '革新の後の安定化',
                            description: '新たな文化や秩序を安定させる存在です。',
                            upper_trigram_id: 3,
                            lower_trigram_id: 5
                        },
                        matchScore: 78
                    },
                    safeModeOS: {
                        hexagramId: 33,
                        hexagramInfo: {
                            name: '地雷復',
                            reading: 'ちらいふく',
                            catchphrase: '内省的な観察力',
                            description: '深い洞察力で本質を見抜く防御機制です。',
                            upper_trigram_id: 7,
                            lower_trigram_id: 4
                        },
                        matchScore: 82
                    },
                    consistencyScore: {
                        overall: 0.75,
                        engineInterface: 0.70,
                        engineSafeMode: 0.80,
                        interfaceSafeMode: 0.75
                    },
                    integration: {
                        summary: '創造的でありながら安定した人格構造を持っています。',
                        recommendations: [
                            '創造的エネルギーを建設的に活用する',
                            '内面の安定感を大切にする',
                            'バランスの取れた自己表現を心がける'
                        ]
                    }
                };
                
                showTestResult('data', 'success', 'サンプルデータ生成完了', 
                    `エンジンOS: ${window.testData.engineOS.hexagramInfo.name}\n` +
                    `インターフェースOS: ${window.testData.interfaceOS.hexagramInfo.name}\n` +
                    `セーフモードOS: ${window.testData.safeModeOS.hexagramInfo.name}\n` +
                    `一貫性スコア: ${Math.round(window.testData.consistencyScore.overall * 100)}%`);
                    
            } catch (error) {
                showTestResult('data', 'error', 'サンプルデータ生成失敗', error.message);
            }
        };

        window.generateMultipleTestData = function() {
            try {
                showTestResult('data', 'loading', '複数パターンを生成中...');
                
                const patterns = [];
                for (let i = 0; i < 5; i++) {
                    patterns.push({
                        id: i + 1,
                        engineOS: Math.floor(Math.random() * 64) + 1,
                        interfaceOS: Math.floor(Math.random() * 64) + 1,
                        safeModeOS: Math.floor(Math.random() * 64) + 1,
                        consistency: Math.random()
                    });
                }
                
                window.testPatterns = patterns;
                
                const results = patterns.map(p => 
                    `パターン${p.id}: E${p.engineOS} I${p.interfaceOS} S${p.safeModeOS} (${Math.round(p.consistency * 100)}%)`
                ).join('\n');
                
                showTestResult('data', 'success', '複数パターン生成完了', results);
                
            } catch (error) {
                showTestResult('data', 'error', '複数パターン生成失敗', error.message);
            }
        };

        window.validateTestData = function() {
            try {
                showTestResult('data', 'loading', 'データ構造を検証中...');
                
                if (!window.testData) {
                    throw new Error('テストデータが生成されていません');
                }
                
                const required = [
                    'engineOS.hexagramId',
                    'engineOS.hexagramInfo.name',
                    'interfaceOS.hexagramId',
                    'safeModeOS.hexagramId',
                    'consistencyScore.overall'
                ];
                
                const validation = required.map(path => {
                    const value = path.split('.').reduce((obj, key) => obj?.[key], window.testData);
                    return `${value !== undefined ? '✅' : '❌'} ${path}: ${value !== undefined ? 'OK' : 'Missing'}`;
                }).join('\n');
                
                const isValid = required.every(path => {
                    const value = path.split('.').reduce((obj, key) => obj?.[key], window.testData);
                    return value !== undefined;
                });
                
                showTestResult('data', isValid ? 'success' : 'error', 
                    isValid ? 'データ構造検証完了' : 'データ構造に問題があります', 
                    validation);
                    
            } catch (error) {
                showTestResult('data', 'error', 'データ構造検証失敗', error.message);
            }
        };

        // 3. 高度相性分析テスト
        window.testAdvancedCompatibility = async function() {
            try {
                showTestResult('compatibility', 'loading', '高度相性分析を実行中...');
                
                if (!window.testModules.AdvancedCompatibilityEngine) {
                    throw new Error('AdvancedCompatibilityEngine がインポートされていません');
                }
                
                // モックのInternalCompatibilityEngineを作成
                const mockEngine = {
                    analyzeTripleOSCompatibility: () => ({
                        engineInterface: { synergy: 0.7, conflict: 0.3, harmony: 0.8, tension: 0.2 },
                        engineSafeMode: { synergy: 0.6, conflict: 0.4, harmony: 0.7, tension: 0.3 },
                        interfaceSafeMode: { synergy: 0.8, conflict: 0.2, harmony: 0.9, tension: 0.1 }
                    })
                };
                
                const engine = new window.testModules.AdvancedCompatibilityEngine(mockEngine);
                
                const result = engine.analyzeInternalTeamComposition(1, 49, 33, {
                    lifeStage: 'developing',
                    goals: ['personal_growth'],
                    challenges: ['stress_management']
                });
                
                const summary = `チーム効果性: ${Math.round(result.overallAssessment.teamEffectiveness * 100)}%\n` +
                    `強みエリア: ${result.overallAssessment.strengthAreas.join(', ')}\n` +
                    `成長エリア: ${result.overallAssessment.growthAreas.join(', ')}\n` +
                    `特殊パターン: ${result.specialPattern ? result.specialPattern.name : '検出なし'}`;
                
                showTestResult('compatibility', 'success', '高度相性分析完了', summary);
                
            } catch (error) {
                showTestResult('compatibility', 'error', '高度相性分析失敗', error.message);
            }
        };

        // テスト実行開始
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🧪 テストページが読み込まれました');
            
            // 自動的に基本テストを実行
            setTimeout(() => {
                testSystemInitialization();
            }, 500);
            
            setTimeout(() => {
                testModuleImports();
            }, 1000);
            
            setTimeout(() => {
                generateTestData();
            }, 1500);
        });

        // その他のテスト関数は続きで実装します...
        window.testSpecialPatterns = function() {
            showTestResult('compatibility', 'info', '特殊パターン検出テスト', '実装準備中...');
        };

        window.testHistoricalMatches = function() {
            showTestResult('compatibility', 'info', '歴史人物マッチングテスト', '実装準備中...');
        };

        window.testContextEvaluation = function() {
            showTestResult('compatibility', 'info', 'コンテキスト評価テスト', '実装準備中...');
        };

        window.testPDFExport = function() {
            showTestResult('export', 'info', 'PDF出力テスト', '実装準備中...');
        };

        window.testImageExport = function() {
            showTestResult('export', 'info', '画像出力テスト', '実装準備中...');
        };

        window.testSNSFormats = function() {
            showTestResult('export', 'info', 'SNS形式生成テスト', '実装準備中...');
        };

        window.testExportErrors = function() {
            showTestResult('export', 'info', 'エラーハンドリングテスト', '実装準備中...');
        };

        window.testHistorySave = function() {
            showTestResult('history', 'info', '履歴保存テスト', '実装準備中...');
        };

        window.testHistoryRetrieval = function() {
            showTestResult('history', 'info', '履歴取得テスト', '実装準備中...');
        };

        window.testComparison = function() {
            showTestResult('history', 'info', '結果比較テスト', '実装準備中...');
        };

        window.testTrendAnalysis = function() {
            showTestResult('history', 'info', 'トレンド分析テスト', '実装準備中...');
        };

        window.testHistoryExport = function() {
            showTestResult('history', 'info', '履歴エクスポートテスト', '実装準備中...');
        };

        window.testLazyLoading = function() {
            showTestResult('performance', 'info', '遅延読み込みテスト', '実装準備中...');
        };

        window.testCacheManager = function() {
            showTestResult('performance', 'info', 'キャッシュ機能テスト', '実装準備中...');
        };

        window.testPerformanceMetrics = function() {
            showTestResult('performance', 'info', 'パフォーマンス測定テスト', '実装準備中...');
        };

        window.stressTest = function() {
            showTestResult('performance', 'info', '負荷テスト', '実装準備中...');
        };

        window.testAnalyticsCollection = function() {
            showTestResult('analytics', 'info', 'イベント収集テスト', '実装準備中...');
        };

        window.testUserBehaviorTracking = function() {
            showTestResult('analytics', 'info', '行動追跡テスト', '実装準備中...');
        };

        window.testAnalyticsReport = function() {
            showTestResult('analytics', 'info', '分析レポート生成テスト', '実装準備中...');
        };

        window.testPrivacyFeatures = function() {
            showTestResult('analytics', 'info', 'プライバシー機能テスト', '実装準備中...');
        };

        window.runIntegrationTest = function() {
            showTestResult('integration', 'info', '統合テスト', '実装準備中...');
        };

        window.testEnhancedMode = function() {
            showTestResult('integration', 'info', '拡張モードテスト', '実装準備中...');
        };

        window.testUserWorkflow = function() {
            showTestResult('integration', 'info', 'ユーザーワークフローテスト', '実装準備中...');
        };

        window.runFullSystemTest = function() {
            showTestResult('integration', 'info', 'フルシステムテスト', '実装準備中...');
        };
    </script>
</body>
</html>