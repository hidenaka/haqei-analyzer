<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新しい互換性データ構造テスト</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-header {
            background: #21262d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #58a6ff;
        }
        .test-section {
            background: #161b22;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid;
            font-size: 12px;
        }
        .test-pass {
            background: #0d4429;
            border-color: #238636;
            color: #2ea043;
        }
        .test-fail {
            background: #490202;
            border-color: #da3633;
            color: #f85149;
        }
        .test-warn {
            background: #333017;
            border-color: #d29922;
            color: #f0c674;
        }
        .test-info {
            background: #0c2d6b;
            border-color: #1f6feb;
            color: #58a6ff;
        }
        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #2ea043;
        }
        .json-display {
            background: #010409;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #30363d;
            max-height: 400px;
            overflow-y: auto;
            font-size: 11px;
            margin: 10px 0;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
        .controls {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
        }
        input[type="number"] {
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px;
            border-radius: 4px;
            width: 80px;
        }
        label {
            font-size: 12px;
            color: #8b949e;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🔄 新しい互換性データ構造テスト</h1>
            <p>リニューアルされた互換性データ構造での動作確認を行います。</p>
        </div>

        <div class="test-section">
            <h2>🎯 データ読み込みテスト</h2>
            <div class="controls">
                <label>エンジンID:</label>
                <input type="number" id="engineId" value="46" min="1" max="64">
                
                <label>インターフェースID:</label>
                <input type="number" id="interfaceId" value="1" min="1" max="64">
                
                <label>セーフモードID:</label>
                <input type="number" id="safeModeId" value="1" min="1" max="64">
                
                <button class="btn" onclick="testEngineInterfaceData()">Engine-Interface読み込み</button>
                <button class="btn" onclick="testEngineSafeModeData()">Engine-SafeMode読み込み</button>
                <button class="btn" onclick="clearResults()">クリア</button>
            </div>
            <div id="test-results"></div>
        </div>

        <div class="test-section">
            <h2>📊 読み込み結果</h2>
            <div class="json-display" id="data-display">
                <pre>テストを実行してください...</pre>
            </div>
        </div>

        <div class="test-section">
            <h2>🔍 データ構造分析</h2>
            <div id="structure-analysis"></div>
        </div>

        <div class="test-section">
            <h2>📋 ログ</h2>
            <div class="json-display" id="log-display">
                <pre>ログを表示...</pre>
            </div>
        </div>
    </div>

    <!-- 必要なスクリプトファイルを読み込み -->
    <script src="js/core/CompatibilityDataLoader.js"></script>

    <script>
        let compatibilityLoader;
        let logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 12);
            const logEntry = `[${timestamp}] ${message}`;
            logs.push({ timestamp, message, type });
            
            const logDisplay = document.getElementById('log-display');
            logDisplay.innerHTML = '<pre>' + logs.map(l => l.timestamp + ' ' + l.message).join('\n') + '</pre>';
            logDisplay.scrollTop = logDisplay.scrollHeight;
        }

        function addResult(testName, success, message, data = null) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${success ? 'test-pass' : 'test-fail'}`;
            
            const icon = success ? '✅' : '❌';
            resultDiv.innerHTML = `${icon} <strong>${testName}</strong>: ${message}`;
            
            resultsDiv.appendChild(resultDiv);
            
            if (data) {
                displayData(data);
                analyzeStructure(data);
            }
        }

        function displayData(data) {
            const dataDisplay = document.getElementById('data-display');
            dataDisplay.innerHTML = '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
        }

        function analyzeStructure(data) {
            const analysisDiv = document.getElementById('structure-analysis');
            
            const analysis = {
                hasEngineId: 'engineId' in data,
                hasInterfaceId: 'interfaceId' in data,
                hasSafeModeId: 'safeModeId' in data,
                hasOverallScore: 'overallScore' in data,
                hasSummary: 'summary' in data,
                hasEvaluation: 'evaluation' in data,
                hasAdvice: 'advice' in data,
                hasCompatibility: 'compatibility' in data,
                compatibilityType: data.compatibilityType || 'N/A'
            };

            analysisDiv.innerHTML = Object.entries(analysis).map(([key, value]) => {
                const status = typeof value === 'boolean' ? (value ? '✅' : '❌') : '📋';
                return `<div class="test-result test-info">${status} ${key}: ${value}</div>`;
            }).join('');
        }

        async function testEngineInterfaceData() {
            const engineId = parseInt(document.getElementById('engineId').value);
            const interfaceId = parseInt(document.getElementById('interfaceId').value);
            
            log(`Engine-Interface データ読み込み開始: ${engineId}-${interfaceId}`);
            
            try {
                if (!compatibilityLoader) {
                    compatibilityLoader = new CompatibilityDataLoader();
                    log('CompatibilityDataLoader初期化完了');
                }
                
                const startTime = Date.now();
                const data = await compatibilityLoader.getEngineInterfaceCompatibility(engineId, interfaceId);
                const loadTime = Date.now() - startTime;
                
                log(`データ読み込み完了 (${loadTime}ms)`);
                addResult(
                    `Engine-Interface (${engineId}-${interfaceId})`,
                    true,
                    `読み込み成功 (${loadTime}ms) - スコア: ${data.overallScore}`,
                    data
                );
                
            } catch (error) {
                log(`エラー: ${error.message}`, 'error');
                addResult(
                    `Engine-Interface (${engineId}-${interfaceId})`,
                    false,
                    `読み込み失敗: ${error.message}`
                );
            }
        }

        async function testEngineSafeModeData() {
            const engineId = parseInt(document.getElementById('engineId').value);
            const safeModeId = parseInt(document.getElementById('safeModeId').value);
            
            log(`Engine-SafeMode データ読み込み開始: ${engineId}-${safeModeId}`);
            
            try {
                if (!compatibilityLoader) {
                    compatibilityLoader = new CompatibilityDataLoader();
                    log('CompatibilityDataLoader初期化完了');
                }
                
                const startTime = Date.now();
                const data = await compatibilityLoader.getEngineSafeModeCompatibility(engineId, safeModeId);
                const loadTime = Date.now() - startTime;
                
                log(`データ読み込み完了 (${loadTime}ms)`);
                addResult(
                    `Engine-SafeMode (${engineId}-${safeModeId})`,
                    true,
                    `読み込み成功 (${loadTime}ms) - スコア: ${data.overallScore}`,
                    data
                );
                
            } catch (error) {
                log(`エラー: ${error.message}`, 'error');
                addResult(
                    `Engine-SafeMode (${engineId}-${safeModeId})`,
                    false,
                    `読み込み失敗: ${error.message}`
                );
            }
        }

        function clearResults() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('data-display').innerHTML = '<pre>テスト結果をクリアしました...</pre>';
            document.getElementById('structure-analysis').innerHTML = '';
            logs = [];
            document.getElementById('log-display').innerHTML = '<pre>ログをクリアしました...</pre>';
            log('結果をクリアしました');
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            log('新しい互換性データ構造テストページが読み込まれました');
            
            // Console error handling
            const originalError = console.error;
            console.error = function(...args) {
                log(`Console Error: ${args.join(' ')}`, 'error');
                originalError.apply(console, args);
            };
        });
    </script>
</body>
</html>