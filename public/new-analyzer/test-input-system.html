<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>HaQei Analyzer - テストデータ入力システム</title>
    <!-- 既存のCSSを流用 -->
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/test-input.css" />

    <!-- データ整合性テスト用のスタイル -->
    <style>
      .test-results-summary {
        background: #1e293b;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin: 1rem 0;
        border: 1px solid #334155;
      }

      .test-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .stat-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5rem;
        background: #0f172a;
        border-radius: 0.25rem;
        border: 1px solid #475569;
      }

      .stat-label {
        font-size: 0.9rem;
        color: #cbd5e1;
      }

      .stat-value {
        font-weight: bold;
        font-size: 1.1rem;
        color: #e2e8f0;
      }

      .stat-value.success {
        color: #10b981;
      }

      .stat-value.error {
        color: #ef4444;
      }

      .test-details {
        margin-top: 1rem;
      }

      .test-log {
        max-height: 300px;
        overflow-y: auto;
        background: #0f172a;
        border-radius: 0.5rem;
        padding: 1rem;
        border: 1px solid #475569;
      }

      .test-item {
        padding: 0.5rem;
        margin: 0.25rem 0;
        border-radius: 0.25rem;
        border-left: 4px solid #64748b;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .test-item.success {
        background: rgba(16, 185, 129, 0.1);
        border-left-color: #10b981;
        color: #a7f3d0;
      }

      .test-item.error {
        background: rgba(239, 68, 68, 0.1);
        border-left-color: #ef4444;
        color: #fca5a5;
      }

      .test-item.info {
        background: rgba(59, 130, 246, 0.1);
        border-left-color: #3b82f6;
        color: #93c5fd;
      }

      .test-controls {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: center;
      }

      .btn-primary {
        background: #3b82f6;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 0.5rem;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.2s;
      }

      .btn-primary:hover {
        background: #2563eb;
      }
    </style>
    <!-- HAQEI_DATAをグローバルに供給 -->
    <script type="module" src="js/data/data_box.js"></script>
    <!-- BIBLE_DATAをグローバルに供給 -->
    <script src="../js/bible.js"></script>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>🎯 HaQei Analyzer テストデータ入力システム</h1>
        <p>30人分の回答データを入力し、一括診断を実行するシステム</p>
      </div>

      <!-- タブメニュー -->
      <div class="tabs">
        <button class="tab active" onclick="showTab('input')">
          📝 データ入力
        </button>
        <button class="tab" onclick="showTab('results')">📊 診断結果</button>
        <button class="tab" onclick="showTab('feedback')">
          💬 フィードバック管理
        </button>
        <button class="tab" onclick="showTab('analysis')">📈 分析・検証</button>
      </div>

      <!-- データ入力タブ -->
      <div id="input-tab" class="tab-content active">
        <div
          class="card batch-processing-card"
          style="
            border: 2px solid #10b981;
            background: linear-gradient(
              135deg,
              rgba(16, 185, 129, 0.1),
              rgba(52, 211, 153, 0.1)
            );
          "
        >
          <h3 style="color: #10b981">🚀 回答データ一括処理（推奨）</h3>
          <p style="color: #d1d5db; margin-bottom: 1.5rem">
            複数人の回答データをまとめて貼り付けると、自動で解析・診断・結果生成まで一括実行します
          </p>

          <div class="form-group">
            <label style="color: #e5e7eb; font-weight: 600"
              >回答データを貼り付け（複数人対応）</label
            >
            <div class="input-with-paste">
              <textarea
                id="batch-answers-input"
                rows="12"
                placeholder="【参加者情報】
お名前: 天野 翔
年齢: 26歳
性別: 男性
職業: スタートアップ起業家

【第1部：価値観設問回答】
Q1: A
Q2: A
...

【第2部：シナリオ設問回答】
Q25_内面: B
Q25_外面: A
...

回答2/10

【参加者情報】
お名前: 田中 美咲
..."
                style="
                  width: 100%;
                  min-height: 300px;
                  background: #1a1a1a;
                  color: #e1e1e1;
                  border: 1px solid #374151;
                  border-radius: 0.5rem;
                  padding: 1rem;
                  font-family: 'Courier New', monospace;
                  font-size: 0.9rem;
                  line-height: 1.4;
                  resize: vertical;
                "
              >
### 回答1/2

【参加者情報】
お名前: テスト太郎
年齢: 25歳
性別: 男性
職業: 会社員

【第1部：価値観設問回答】
Q1: A
Q2: B
Q3: A
Q4: B
Q5: A
Q6: B
Q7: A
Q8: B
Q9: A
Q10: B
Q11: A
Q12: B
Q13: A
Q14: B
Q15: A
Q16: B
Q17: A
Q18: B
Q19: A
Q20: B
Q21: A
Q22: B
Q23: A
Q24: B

【第2部：シナリオ設問回答】
Q25_内面: A
Q25_外面: B
Q26_内面: A
Q26_外面: B
Q27_内面: A
Q27_外面: B
Q28_内面: A
Q28_外面: B
Q29_内面: A
Q29_外面: B
Q30_内面: A
Q30_外面: B

### 回答2/2

【参加者情報】
お名前: テスト花子
年齢: 28歳
性別: 女性
職業: デザイナー

【第1部：価値観設問回答】
Q1: B
Q2: A
Q3: B
Q4: A
Q5: B
Q6: A
Q7: B
Q8: A
Q9: B
Q10: A
Q11: B
Q12: A
Q13: B
Q14: A
Q15: B
Q16: A
Q17: B
Q18: A
Q19: B
Q20: A
Q21: B
Q22: A
Q23: A
Q24: A

【第2部：シナリオ設問回答】
Q25_内面: B
Q25_外面: A
Q26_内面: B
Q26_外面: A
Q27_内面: B
Q27_外面: A
Q28_内面: B
Q28_外面: A
Q29_内面: B
Q29_外面: A
Q30_内面: B
Q30_外面: A</textarea
              >
              <div class="paste-controls">
                <button
                  class="btn btn-secondary"
                  id="paste-batch-clipboard-btn"
                >
                  📋 クリップボードから貼り付け
                </button>
                <button class="btn btn-secondary" id="batch-input-clear-btn">
                  🗑️ クリア
                </button>
              </div>
            </div>
          </div>

          <div
            class="batch-actions"
            style="
              display: flex;
              gap: 1rem;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <button
              class="btn btn-success"
              id="start-batch-processing-btn"
              style="
                background: linear-gradient(135deg, #10b981, #059669);
                font-size: 1.1rem;
                padding: 0.75rem 1.5rem;
              "
            >
              🚀 一括処理実行（解析→診断→結果生成）
            </button>

            <div style="color: #9ca3af; font-size: 0.9rem">
              ✨ 貼り付けるだけで全自動処理
            </div>
          </div>

          <div id="batch-progress" style="margin-top: 1rem; min-height: 2rem">
            <!-- 処理進捗がここに表示される -->
          </div>

          <div
            class="batch-help"
            style="
              margin-top: 1rem;
              padding: 1rem;
              background: rgba(59, 130, 246, 0.1);
              border-radius: 0.5rem;
              border-left: 4px solid #3b82f6;
            "
          >
            <h4 style="color: #60a5fa; margin: 0 0 0.5rem 0; font-size: 1rem">
              💡 使い方
            </h4>
            <ol
              style="
                color: #cbd5e1;
                margin: 0;
                padding-left: 1.5rem;
                font-size: 0.9rem;
                line-height: 1.5;
              "
            >
              <li>
                上記のテキストエリアに、受け取った回答データをそのまま貼り付け
              </li>
              <li>「🚀 一括処理実行」ボタンをクリック</li>
              <li>自動で参加者登録 → 回答解析 → 診断実行 → 結果生成まで完了</li>
              <li>完了後、各参加者の結果テキストをコピーしてユーザーに送信</li>
            </ol>
          </div>
        </div>

        <!-- 従来の手動入力セクションは折りたたみ可能に -->
        <div class="card manual-input-card">
          <div
            class="manual-input-header"
            onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'; this.querySelector('.toggle-icon').textContent = this.nextElementSibling.style.display === 'none' ? '▶' : '▼';"
            style="
              cursor: pointer;
              display: flex;
              justify-content: space-between;
              align-items: center;
            "
          >
            <h3>👥 手動入力（従来方式）</h3>
            <span class="toggle-icon" style="font-size: 1.2rem">▼</span>
          </div>

          <div class="manual-input-content">
            <!-- 既存の手動入力UIをここに移動 -->
            <div style="color: #9ca3af; margin-bottom: 1rem; font-size: 0.9rem">
              一人ずつ手動で回答を入力する場合はこちらを使用してください
            </div>

            <div class="card">
              <h3>👥 テスト対象者リスト</h3>
              <div class="form-group">
                <label
                  >対象者情報（1行1人、形式: ID,名前,年齢,性別,職業）</label
                >
                <div class="input-with-paste">
                  <textarea
                    id="participants-list"
                    rows="10"
                    placeholder="user001,山田太郎,28,男性,エンジニア&#10;user002,佐藤花子,32,女性,デザイナー&#10;user003,田中一郎,25,男性,営業"
                  ></textarea>
                  <div class="paste-controls">
                    <button
                      class="btn btn-secondary"
                      id="paste-participants-from-clipboard-btn"
                    >
                      📋 クリップボードから貼り付け
                    </button>
                    <button
                      class="btn btn-secondary"
                      id="clear-participants-list-btn"
                    >
                      🗑️ クリア
                    </button>
                  </div>
                </div>
              </div>
              <button class="btn" id="parse-participants-list-btn">
                👥 対象者リスト解析
              </button>
            </div>

            <div class="card">
              <h3>📋 回答データ一括入力</h3>
              <div class="form-group">
                <label>現在の入力対象者</label>
                <select id="current-participant">
                  <option value="">対象者を選択してください</option>
                </select>
              </div>

              <!-- 回答書式貼り付け -->
              <div class="form-group">
                <label>回答書式一括貼り付け</label>
                <div class="input-with-paste">
                  <textarea
                    id="answers-format-input"
                    rows="15"
                    placeholder="【参加者情報】&#10;お名前: 山田太郎&#10;年齢: 28歳&#10;性別: 男性&#10;職業: システムエンジニア&#10;&#10;【第1部：価値観設問回答】&#10;Q1: A&#10;Q2: C&#10;...&#10;&#10;【第2部：シナリオ設問回答】&#10;Q25_内面: B&#10;Q25_外面: A&#10;..."
                  ></textarea>
                  <div class="paste-controls">
                    <button
                      class="btn btn-secondary"
                      id="paste-answers-format-btn"
                    >
                      📋 回答書式を貼り付け
                    </button>
                    <button
                      class="btn btn-secondary"
                      id="parse-answers-format-btn"
                    >
                      🔍 回答書式を解析
                    </button>
                    <button
                      class="btn btn-secondary"
                      id="clear-answers-format-btn"
                    >
                      🗑️ クリア
                    </button>
                  </div>
                </div>
              </div>

              <!-- 価値観設問入力（Q1-Q24） -->
              <div class="form-section">
                <h4>💭 価値観設問（Q1-Q24）</h4>
                <div id="worldview-inputs">
                  <!-- 動的生成 -->
                </div>
              </div>

              <!-- シナリオ設問入力（Q25-Q30） -->
              <div class="form-section">
                <h4>🎭 シナリオ設問（Q25-Q30）</h4>
                <div id="scenario-inputs">
                  <!-- 動的生成 -->
                </div>
              </div>

              <div class="form-actions">
                <button class="btn btn-success" id="save-current-answers-btn">
                  💾 この回答を保存
                </button>
                <button
                  class="btn btn-secondary"
                  id="clear-current-answers-btn"
                >
                  🗑️ クリア
                </button>
              </div>
            </div>

            <div class="card">
              <h3>🎯 個別診断・結果生成</h3>
              <div class="form-group">
                <label>診断対象者を選択</label>
                <select id="single-diagnosis-participant">
                  <option value="">対象者を選択してください</option>
                  <!-- JavaScript で動的に対象者リストが入る -->
                </select>
              </div>

              <div class="single-diagnosis-actions">
                <button
                  class="btn btn-primary"
                  id="execute-single-diagnosis-btn"
                >
                  🔬 この人の診断実行
                </button>

                <button class="btn btn-secondary" id="show-single-result-btn">
                  📄 結果表示
                </button>

                <button class="btn btn-success" id="copy-single-result-btn">
                  📋 結果コピー
                </button>
              </div>

              <div id="single-diagnosis-status" class="diagnosis-status">
                <!-- 診断ステータス表示 -->
              </div>
            </div>

            <div class="card">
              <h3>📊 入力進捗</h3>
              <div id="input-progress">
                <!-- 進捗表示 -->
              </div>
              <button class="btn btn-primary" id="execute-all-diagnosis-btn">
                🔬 全員の診断実行
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- 診断結果タブ -->
      <div id="results-tab" class="tab-content">
        <div class="card">
          <h3>📊 診断結果一覧</h3>
          <div class="results-summary">
            <div class="summary-item">
              <span class="label">総診断数:</span>
              <span id="total-diagnosis-count">0</span>
            </div>
            <div class="summary-item">
              <span class="label">完了率:</span>
              <span id="completion-rate">0%</span>
            </div>
            <div class="summary-item">
              <span class="label">平均一貫性スコア:</span>
              <span id="avg-consistency-score">0%</span>
            </div>
          </div>

          <div class="results-actions">
            <button class="btn btn-primary" id="export-all-results-btn">
              📥 全結果エクスポート
            </button>
            <button class="btn btn-secondary" id="copy-results-for-sharing-btn">
              📋 結果コピー
            </button>
            <button class="btn btn-info" id="generate-debug-report-btn">
              🐛 デバッグレポート
            </button>
          </div>

          <div id="results-list" class="results-list">
            <!-- 診断結果一覧が動的に生成される -->
          </div>
        </div>

        <div class="card">
          <h3>📋 個別結果管理</h3>
          <div class="individual-results">
            <div class="form-group">
              <label>結果を見る対象者</label>
              <select id="view-result-participant">
                <option value="">対象者を選択してください</option>
              </select>
            </div>

            <div class="result-actions">
              <button class="btn btn-primary" id="show-single-result-btn-2">
                📄 詳細結果表示
              </button>

              <button class="btn btn-secondary" id="generate-quick-result-btn">
                ⚡ 簡易結果生成
              </button>

              <button class="btn btn-success" id="send-result-to-user-btn">
                📧 ユーザーに送信用テキスト生成
              </button>
            </div>
          </div>

          <div class="results-preview" id="single-result-preview">
            <!-- 結果プレビュー -->
          </div>
        </div>
      </div>

      <!-- フィードバック管理タブ -->
      <div id="feedback-tab" class="tab-content">
        <div class="card">
          <h3>💬 ユーザーフィードバック入力</h3>
          <div class="form-group">
            <label>フィードバック対象者</label>
            <select id="feedback-participant">
              <option value="">対象者を選択</option>
            </select>
          </div>

          <div class="feedback-form">
            <div class="form-group">
              <label>的中度（1-5）</label>
              <select id="accuracy-rating">
                <option value="">選択してください</option>
                <option value="1">1 - 全く当てはまらない</option>
                <option value="2">2 - あまり当てはまらない</option>
                <option value="3">3 - どちらとも言えない</option>
                <option value="4">4 - よく当てはまる</option>
                <option value="5">5 - 非常によく当てはまる</option>
              </select>
            </div>

            <div class="form-group">
              <label>満足度（1-5）</label>
              <select id="satisfaction-rating">
                <option value="">選択してください</option>
                <option value="1">1 - 全く満足していない</option>
                <option value="2">2 - あまり満足していない</option>
                <option value="3">3 - どちらとも言えない</option>
                <option value="4">4 - 満足している</option>
                <option value="5">5 - 非常に満足している</option>
              </select>
            </div>

            <div class="form-group">
              <label>印象に残った内容（複数選択可）</label>
              <div class="checkbox-group">
                <label
                  ><input type="checkbox" value="primary_os" />
                  メインの人格OS</label
                >
                <label
                  ><input type="checkbox" value="triple_os" /> 3層OS分析</label
                >
                <label
                  ><input type="checkbox" value="dimensions" /> 8次元分析</label
                >
                <label
                  ><input type="checkbox" value="insights" />
                  洞察・アドバイス</label
                >
                <label
                  ><input type="checkbox" value="accuracy" />
                  的中度の高さ</label
                >
                <label
                  ><input type="checkbox" value="presentation" />
                  結果の表現方法</label
                >
              </div>
            </div>

            <div class="form-group">
              <label>具体的なコメント</label>
              <textarea
                id="user-comments"
                rows="4"
                placeholder="ユーザーからの具体的なフィードバック"
              ></textarea>
            </div>

            <button class="btn btn-success" id="save-feedback-btn">
              💾 フィードバック保存
            </button>
          </div>
        </div>

        <div class="card">
          <h3>📊 フィードバック集計</h3>
          <div id="feedback-summary">
            <!-- フィードバック集計結果 -->
          </div>
        </div>
      </div>

      <!-- 分析・検証タブ -->
      <div id="analysis-tab" class="tab-content">
        <div class="card">
          <h3>📈 アルゴリズム精度分析</h3>
          <div id="accuracy-analysis">
            <!-- 精度分析結果 -->
          </div>
        </div>

        <div class="card">
          <h3>🔍 改善点特定</h3>
          <div id="improvement-analysis">
            <!-- 改善点分析 -->
          </div>
        </div>

        <div class="card">
          <h3>📊 統計データ</h3>
          <div id="statistical-analysis">
            <!-- 統計分析結果 -->
          </div>
          <div class="test-controls" style="margin-top: 1rem">
            <button class="btn btn-primary" id="run-data-integrity-test-btn">
              🧪 データ整合性テスト実行
            </button>
            <button class="btn" id="generate-debug-report-btn-2">
              📋 開発用レポート生成
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- JavaScript -->
    <!-- 1. 基底クラス（必須順序） -->
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/Calculator.js"></script>

    <!-- 2. エンジンクラス（基底クラス後に読み込み） -->
    <script src="js/core/Engine.js"></script>
    <script src="js/core/TripleOSEngine.js"></script>

    <!-- 3. ストレージマネージャー（エンジン後でOK） -->
    <script src="js/core/StorageManager.js"></script>

    <!-- 4. データファイル -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/hexagrams.js"></script>

    <!-- 5. InsightEngine（最後の前に読み込み） -->
    <script src="js/core/InsightEngine.js"></script>

    <!-- 6. テスト入力システム（最後に読み込み） -->
    <script src="js/test-input-system.js"></script>

    <!-- デバッグ用スクリプト -->
    <script>
      // スクリプト読み込み確認
      console.log("🔍 スクリプト読み込み状況チェック:");
      console.log("BaseComponent:", typeof window.BaseComponent);
      console.log("DataManager:", typeof window.DataManager);
      console.log("Calculator:", typeof window.Calculator);
      console.log("Engine:", typeof window.Engine);
      console.log("TripleOSEngine:", typeof window.TripleOSEngine);
      console.log("StorageManager:", typeof window.StorageManager);
      console.log("WORLDVIEW_QUESTIONS:", typeof window.WORLDVIEW_QUESTIONS);
      console.log("SCENARIO_QUESTIONS:", typeof window.SCENARIO_QUESTIONS);
      console.log("HAQEI_DATA:", typeof window.HAQEI_DATA);
      console.log("BIBLE_DATA:", typeof window.BIBLE_DATA);

      // エラーハンドリング
      window.addEventListener("error", function (e) {
        console.error("❌ スクリプト読み込みエラー:", e.filename, e.message);
      });

      // DOMContentLoaded後の確認
      document.addEventListener("DOMContentLoaded", function () {
        console.log("✅ DOM読み込み完了");
        console.log("TestInputSystem:", typeof window.testSystem);

        if (typeof window.testSystem === "undefined") {
          console.error("❌ TestInputSystemの初期化に失敗しました");
        } else {
          console.log("✅ TestInputSystemが正常に初期化されました");
        }
      });
    </script>
  </body>
</html>
