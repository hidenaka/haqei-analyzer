<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="HaQei Analyzer - Âè§‰ª£„ÅÆÂè°Êô∫„Å®Áèæ‰ª£„ÅÆ„ÉÜ„ÇØ„Éé„É≠„Ç∏„Éº„ÅåËûçÂêà„Åó„Åü„ÄÅÊ∑±„ÅÑËá™Â∑±Ê¥ûÂØü‰ΩìÈ®ì"
    />
    <title>HaQei Analyzer - Ê∑±„ÅÑËá™Â∑±Ê¥ûÂØü„Å∏„ÅÆÂÖ•„ÇäÂè£</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />

    <!-- Styles -->
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/components.css" />
    <link rel="stylesheet" href="css/animations.css" />

    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
  </head>
  <body>
    <!-- Global Progress Indicator -->
    <div class="global-progress">
      <div class="progress-bar" style="width: var(--progress, 0%)"></div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="app-container">
      <!-- Welcome Screen -->
      <section id="welcome-container" class="screen-container">
        <!-- WelcomeScreen component will render here -->
      </section>

      <!-- Questions Flow -->
      <section
        id="questions-container"
        class="screen-container"
        style="display: none"
      >
        <!-- QuestionFlow component will render here -->
      </section>

      <!-- Analysis View -->
      <section
        id="analysis-container"
        class="screen-container"
        style="display: none"
      >
        <!-- AnalysisView component will render here -->
      </section>

      <!-- Results View -->
      <section
        id="results-container"
        class="screen-container"
        style="display: none"
      >
        <!-- ResultsView component will render here -->
      </section>

      <!-- Deep Insights Panel -->
      <section
        id="insights-container"
        class="screen-container"
        style="display: none"
      >
        <!-- InsightPanel component will render here -->
      </section>
    </div>

    <!-- 1. Âü∫Â∫ï„ÇØ„É©„ÇπÔºàÂøÖÈ†àÈ†ÜÂ∫èÔºâ -->
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/Calculator.js"></script>

    <!-- 2. „Ç®„É≥„Ç∏„É≥„ÇØ„É©„ÇπÔºàÂü∫Â∫ï„ÇØ„É©„ÇπÂæå„Å´Ë™≠„ÅøËæº„ÅøÔºâ -->
    <script src="js/core/Engine.js"></script>
    <script src="js/core/TripleOSEngine.js"></script>

    <!-- 3. „Çπ„Éà„É¨„Éº„Ç∏„Éû„Éç„Éº„Ç∏„É£„ÉºÔºà„Ç®„É≥„Ç∏„É≥Âæå„ÅßOKÔºâ -->
    <script src="js/core/StorageManager.js"></script>

    <!-- 4. „Éá„Éº„Çø„Éï„Ç°„Ç§„É´ -->
    <script src="js/data/data_box.js"></script>
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/hexagrams.js"></script>

    <!-- 5. UI„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà -->
    <script src="js/components/WelcomeScreen.js"></script>
    <script src="js/components/QuestionFlow.js"></script>
    <script src="js/components/AnalysisView.js"></script>
    <script src="js/components/ResultsView.js"></script>
    <script src="js/components/TripleOSResultsView.js"></script>
    <script src="js/components/InsightPanel.js"></script>

    <!-- 6. „É¶„Éº„ÉÜ„Ç£„É™„ÉÜ„Ç£„Çπ„ÇØ„É™„Éó„Éà -->
    <script src="js/utils/animations.js"></script>
    <script src="js/utils/validators.js"></script>

    <!-- 7. „É°„Ç§„É≥„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÔºàÊúÄÂæå„Å´Ë™≠„ÅøËæº„ÅøÔºâ -->
    <script src="js/app.js"></script>

    <!-- üîß Âº∑Âåñ„Åï„Çå„Åü„Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÁ¢∫Ë™ç -->
    <script>
      // „Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„ÅøÁä∂ÊÖã„ÇíËøΩË∑°
      window.scriptLoadingStatus = {
        dataBoxLoaded: false,
        coreClassesLoaded: false,
        dataFilesLoaded: false,
        componentsLoaded: false,
        allLoaded: false,
        loadAttempts: 0,
        maxAttempts: 50,
        startTime: Date.now(),
        lastCheckTime: Date.now(),
        detailedStatus: {}
      };

      // „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØÈñ¢Êï∞
      function checkDataLoadingComplete() {
        const status = window.scriptLoadingStatus;
        status.loadAttempts++;
        status.lastCheckTime = Date.now();

        console.log(`üîç [LoadingCheck] „Éá„Éº„ÇøË™≠„ÅøËæº„ÅøÁ¢∫Ë™ç (${status.loadAttempts}/${status.maxAttempts}) - ÁµåÈÅéÊôÇÈñì: ${status.lastCheckTime - status.startTime}ms`);

        // data_box.js„ÅÆË™≠„ÅøËæº„ÅøÁ¢∫Ë™çÔºàË©≥Á¥∞„ÉÅ„Çß„ÉÉ„ÇØÔºâ
        status.dataBoxLoaded = typeof window.HAQEI_DATA !== "undefined";
        status.detailedStatus.haqeiDataContent = status.dataBoxLoaded ? 
          (window.HAQEI_DATA && typeof window.HAQEI_DATA === "object" ? "valid" : "invalid") : 
          "undefined";
        
        // „Ç≥„Ç¢„ÇØ„É©„Çπ„ÅÆË™≠„ÅøËæº„ÅøÁ¢∫Ë™ç
        status.coreClassesLoaded = typeof DataManager !== "undefined" && 
                                   typeof Calculator !== "undefined" && 
                                   typeof TripleOSEngine !== "undefined";
        
        // „Éá„Éº„Çø„Éï„Ç°„Ç§„É´„ÅÆË™≠„ÅøËæº„ÅøÁ¢∫Ë™ç
        status.dataFilesLoaded = typeof window.WORLDVIEW_QUESTIONS !== "undefined" && 
                                 typeof window.H64_8D_VECTORS !== "undefined";
        
        // „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆË™≠„ÅøËæº„ÅøÁ¢∫Ë™ç
        status.componentsLoaded = typeof WelcomeScreen !== "undefined" && 
                                  typeof QuestionFlow !== "undefined";

        // ÂÖ®‰Ωì„ÅÆË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂà§ÂÆö
        status.allLoaded = status.dataBoxLoaded && status.coreClassesLoaded && 
                          status.dataFilesLoaded && status.componentsLoaded;

        // Ë©≥Á¥∞„Çπ„ÉÜ„Éº„Çø„Çπ„ÅÆÊõ¥Êñ∞
        status.detailedStatus = {
          ...status.detailedStatus,
          dataBox: status.dataBoxLoaded,
          coreClasses: status.coreClassesLoaded,
          dataFiles: status.dataFilesLoaded,
          components: status.componentsLoaded,
          allLoaded: status.allLoaded,
          globalDataCheck: {
            HAQEI_DATA: typeof window.HAQEI_DATA !== "undefined",
            WORLDVIEW_QUESTIONS: typeof window.WORLDVIEW_QUESTIONS !== "undefined",
            SCENARIO_QUESTIONS: typeof window.SCENARIO_QUESTIONS !== "undefined",
            H64_8D_VECTORS: typeof window.H64_8D_VECTORS !== "undefined"
          }
        };

        console.log("üîç [LoadingCheck] Ë™≠„ÅøËæº„ÅøÁä∂ÊÖã:", status.detailedStatus);

        if (status.allLoaded) {
          const totalLoadTime = status.lastCheckTime - status.startTime;
          console.log(`‚úÖ [LoadingCheck] „Åô„Åπ„Å¶„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„ÅåË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„Åó„Åæ„Åó„Åü (${totalLoadTime}ms)`);
          return true;
        }

        if (status.loadAttempts >= status.maxAttempts) {
          const totalLoadTime = status.lastCheckTime - status.startTime;
          console.warn(`‚ö†Ô∏è [LoadingCheck] Ë™≠„ÅøËæº„ÅøÁ¢∫Ë™ç„Åå„Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åó„Åæ„Åó„Åü (${totalLoadTime}ms)`);
          console.warn("‚ö†Ô∏è [LoadingCheck] Êú™Ë™≠„ÅøËæº„ÅøË¶ÅÁ¥†:", {
            dataBox: !status.dataBoxLoaded,
            coreClasses: !status.coreClassesLoaded,
            dataFiles: !status.dataFilesLoaded,
            components: !status.componentsLoaded
          });
          return false;
        }

        return false;
      }

      // DOMË™≠„ÅøËæº„ÅøÂÆå‰∫ÜÂæå„ÅÆÂá¶ÁêÜ
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üîç [DOMContentLoaded] DOMË™≠„ÅøËæº„ÅøÂÆå‰∫Ü„ÄÅ„Çπ„ÇØ„É™„Éó„ÉàÁ¢∫Ë™ç„ÇíÈñãÂßã");
        
        // ÂàùÂõû„ÉÅ„Çß„ÉÉ„ÇØ
        if (checkDataLoadingComplete()) {
          initializeApplication();
          return;
        }

        // ÂÆöÊúüÁöÑ„Å™„ÉÅ„Çß„ÉÉ„ÇØÔºà100msÈñìÈöîÔºâ
        const checkInterval = setInterval(() => {
          if (checkDataLoadingComplete()) {
            clearInterval(checkInterval);
            initializeApplication();
          }
        }, 100);

        // 5ÁßíÂæå„Å´„Çø„Ç§„É†„Ç¢„Ç¶„Éà
        setTimeout(() => {
          clearInterval(checkInterval);
          console.error("‚ùå [LoadingCheck] „Çπ„ÇØ„É™„Éó„ÉàË™≠„ÅøËæº„Åø„Çø„Ç§„É†„Ç¢„Ç¶„Éà");
          initializeApplication(); // „Çø„Ç§„É†„Ç¢„Ç¶„Éà„Åß„ÇÇÂàùÊúüÂåñ„ÇíË©¶Ë°å
        }, 5000);
      });

      // „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñÈñ¢Êï∞
      function initializeApplication() {
        const initStartTime = Date.now();
        console.log("üöÄ [InitializeApp] „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñÈñãÂßã");
        
        try {
          // ÂøÖÈ†à„ÇØ„É©„Çπ„ÅÆÂ≠òÂú®Á¢∫Ë™ç
          const requiredClasses = {
            BaseComponent: typeof BaseComponent !== "undefined",
            DataManager: typeof DataManager !== "undefined",
            Calculator: typeof Calculator !== "undefined",
            TripleOSEngine: typeof TripleOSEngine !== "undefined",
            StorageManager: typeof StorageManager !== "undefined",
            WelcomeScreen: typeof WelcomeScreen !== "undefined",
            QuestionFlow: typeof QuestionFlow !== "undefined"
          };

          console.log("üîç [InitializeApp] „ÇØ„É©„ÇπÂÆöÁæ©Á¢∫Ë™ç:", requiredClasses);

          // ÂøÖÈ†à„Éá„Éº„Çø„ÅÆÂ≠òÂú®Á¢∫Ë™ç
          const requiredData = {
            HAQEI_DATA: typeof window.HAQEI_DATA !== "undefined",
            WORLDVIEW_QUESTIONS: typeof window.WORLDVIEW_QUESTIONS !== "undefined",
            SCENARIO_QUESTIONS: typeof window.SCENARIO_QUESTIONS !== "undefined",
            H64_8D_VECTORS: typeof window.H64_8D_VECTORS !== "undefined"
          };

          console.log("üîç [InitializeApp] „Éá„Éº„ÇøÂ≠òÂú®Á¢∫Ë™ç:", requiredData);

          // „Ç®„É©„Éº„ÉÅ„Çß„ÉÉ„ÇØ
          const missingClasses = Object.keys(requiredClasses).filter(key => !requiredClasses[key]);
          const missingData = Object.keys(requiredData).filter(key => !requiredData[key]);

          if (missingClasses.length > 0) {
            console.error("‚ùå [InitializeApp] ‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã„ÇØ„É©„Çπ:", missingClasses);
            
            // ÈáçË¶Å„Å™„ÇØ„É©„Çπ„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (missingClasses.includes("DataManager")) {
              console.error("‚ùå [InitializeApp] DataManager„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô - ÈáçË¶Å„Å™„Ç®„É©„Éº");
              window.scriptLoadingStatus.criticalError = "DataManager missing";
            }
          }
          
          if (missingData.length > 0) {
            console.error("‚ùå [InitializeApp] ‰∏çË∂≥„Åó„Å¶„ÅÑ„Çã„Éá„Éº„Çø:", missingData);
            
            // HAQEI_DATA„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅÆÂá¶ÁêÜ
            if (missingData.includes("HAQEI_DATA")) {
              console.error("‚ùå [InitializeApp] HAQEI_DATA„Åå‰∏çË∂≥„Åó„Å¶„ÅÑ„Åæ„Åô - ÈáçË¶Å„Å™„Ç®„É©„Éº");
              window.scriptLoadingStatus.criticalError = "HAQEI_DATA missing";
              
              // Á∑äÊÄ•„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
              console.warn("‚ö†Ô∏è [InitializeApp] Á∑äÊÄ•„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ„ÇíÂÆüË°å");
              window.HAQEI_DATA = {
                hexagrams: {},
                hexagrams_master: [],
                os_manual: {},
                trigrams_master: [],
                element_relationships: [],
                action_plans: {},
                sho_den: {},
                tai_sho_den: {},
                jo_ka_den: {},
                zatsu_ka_den: {},
                tuan_den: {}
              };
            }
          }

          // ÂàùÊúüÂåñÂÆå‰∫Ü„Éï„É©„Ç∞„ÇíË®≠ÂÆö
          window.scriptLoadingStatus.initializationComplete = true;
          window.scriptLoadingStatus.initializationTime = Date.now() - initStartTime;
          
          const initSummary = {
            initializationTime: window.scriptLoadingStatus.initializationTime,
            missingClasses: missingClasses,
            missingData: missingData,
            totalLoadTime: Date.now() - window.scriptLoadingStatus.startTime,
            criticalError: window.scriptLoadingStatus.criticalError || null
          };
          
          console.log("‚úÖ [InitializeApp] „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥ÂàùÊúüÂåñÂÆå‰∫Ü", initSummary);
          
          // App.js„ÅÆÂàùÊúüÂåñ„ÇíÂëº„Å≥Âá∫„ÅôÊ∫ñÂÇô„ÅåÊï¥„Å£„Åü
          console.log("üîß [InitializeApp] App.js„ÅÆÂàùÊúüÂåñÊ∫ñÂÇôÂÆå‰∫Ü");
          
        } catch (error) {
          console.error("‚ùå [InitializeApp] ÂàùÊúüÂåñ‰∏≠„Å´„Ç®„É©„Éº„ÅåÁô∫Áîü:", error);
          window.scriptLoadingStatus.initializationError = error.message;
        }
      }
    </script>

    <!-- üîß „É¨„Ç¨„Ç∑„Éº„Éá„Éê„ÉÉ„Ç∞Áî®„Çπ„ÇØ„É™„Éó„ÉàÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆãÂ≠òÔºâ -->
    <script>
      // ÊóßÂΩ¢Âºè„ÅÆ„Éá„Éê„ÉÉ„Ç∞Á¢∫Ë™çÔºàÂæåÊñπ‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÔºâ
      document.addEventListener("DOMContentLoaded", function () {
        console.log("üîç [Legacy] Class definitions check:");
        console.log("BaseComponent:", typeof BaseComponent);
        console.log("DataManager:", typeof DataManager);
        console.log("Calculator:", typeof Calculator);
        console.log("DiagnosisEngine:", typeof DiagnosisEngine);
        console.log("TripleOSEngine:", typeof TripleOSEngine);
        console.log("StorageManager:", typeof StorageManager);

        // „Ç®„É©„Éº„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅØË≠¶ÂëäË°®Á§∫
        if (typeof DiagnosisEngine === "undefined") {
          console.error("‚ùå DiagnosisEngine is not defined!");
        }
        if (typeof TripleOSEngine === "undefined") {
          console.error("‚ùå TripleOSEngine is not defined!");
        }

        // „Éá„Éº„Çø„ÅÆÂ≠òÂú®Á¢∫Ë™ç
        console.log("WORLDVIEW_QUESTIONS:", typeof WORLDVIEW_QUESTIONS);
        console.log("SCENARIO_QUESTIONS:", typeof SCENARIO_QUESTIONS);
        console.log("H64_8D_VECTORS:", typeof H64_8D_VECTORS);
      });
    </script>
  </body>
</html>
