<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¶æ•°è³ªå•å•é¡Œã®å†ç¾ãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="css/main.css" />
    <link rel="stylesheet" href="css/components.css" />
    <style>
        .debug-overlay {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-width: 300px;
            z-index: 9999;
        }
        .debug-controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
        }
        .debug-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 2px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }
    </style>
</head>
<body>
    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
    <div class="debug-overlay">
        <div id="debugInfo">
            ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
        </div>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
    <div class="debug-controls">
        <div style="margin-bottom: 5px; font-weight: bold;">ãƒ‡ãƒãƒƒã‚°</div>
        <button class="debug-btn" onclick="logCurrentState()">çŠ¶æ…‹ç¢ºèª</button>
        <button class="debug-btn" onclick="forceRender()">å¼·åˆ¶ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°</button>
        <button class="debug-btn" onclick="checkNavigation()">ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª</button>
        <button class="debug-btn" onclick="clearDebugStorage()">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢</button>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div id="app" class="app-container">
        <!-- Questions Flow -->
        <section
            id="questions-container"
            class="screen-container"
            style="display: block"
        >
            <!-- QuestionFlow component will render here -->
        </section>
    </div>

    <!-- ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ï¼ˆanalyzer.htmlã¨åŒã˜é †åºï¼‰ -->
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/DataManager.js"></script>
    <script src="js/core/Calculator.js"></script>
    <script src="js/core/Engine.js"></script>
    <script src="js/core/TripleOSEngine.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/hexagrams.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
        let questionFlow = null;
        let storageManager = null;
        let debugInfo = document.getElementById('debugInfo');

        function updateDebugInfo(info) {
            debugInfo.innerHTML = info;
        }

        function logCurrentState() {
            if (!questionFlow) {
                updateDebugInfo('QuestionFlowæœªåˆæœŸåŒ–');
                return;
            }

            const currentIndex = questionFlow.currentQuestionIndex;
            const currentQuestion = questionFlow.questions[currentIndex];
            const questionNum = currentIndex + 1;
            const isEven = questionNum % 2 === 0;

            const info = `
                ç¾åœ¨ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${currentIndex}<br>
                è³ªå•ç•ªå·: ${questionNum} ${isEven ? '(å¶æ•°)' : '(å¥‡æ•°)'}<br>
                è³ªå•ID: ${currentQuestion?.id || 'ãªã—'}<br>
                å…¨è³ªå•æ•°: ${questionFlow.questions.length}<br>
                å›ç­”æ•°: ${questionFlow.answers.length}<br>
                è¡¨ç¤ºè¦ç´ : ${document.querySelector('#question-display') ? 'ã‚ã‚Š' : 'ãªã—'}
            `;
            
            updateDebugInfo(info);
            console.log('Current state:', {
                currentIndex,
                questionNum,
                isEven,
                questionId: currentQuestion?.id,
                totalQuestions: questionFlow.questions.length,
                answersCount: questionFlow.answers.length
            });
        }

        function forceRender() {
            if (!questionFlow) {
                updateDebugInfo('QuestionFlowæœªåˆæœŸåŒ–');
                return;
            }

            console.log('å¼·åˆ¶ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œ...');
            try {
                questionFlow.renderCurrentQuestion();
                updateDebugInfo('å¼·åˆ¶ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Ÿè¡Œå®Œäº†');
            } catch (error) {
                updateDebugInfo(`å¼·åˆ¶ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:<br>${error.message}`);
                console.error('Force render error:', error);
            }
        }

        function checkNavigation() {
            if (!questionFlow) {
                updateDebugInfo('QuestionFlowæœªåˆæœŸåŒ–');
                return;
            }

            console.log('ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ç¢ºèª...');
            const startIndex = questionFlow.currentQuestionIndex;
            
            // æ¬¡ã®è³ªå•ã«ç§»å‹•
            if (startIndex < questionFlow.questions.length - 1) {
                questionFlow.goToNext();
                setTimeout(() => {
                    logCurrentState();
                    
                    // å…ƒã«æˆ»ã™
                    questionFlow.currentQuestionIndex = startIndex;
                    questionFlow.renderCurrentQuestion();
                }, 500);
            } else {
                updateDebugInfo('æœ€å¾Œã®è³ªå•ã§ã™');
            }
        }

        function clearDebugStorage() {
            if (storageManager) {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢
                localStorage.clear();
                sessionStorage.clear();
                updateDebugInfo('ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢å®Œäº†');
                console.log('Storage cleared');
            }
        }

        // QuestionFlowã®åˆæœŸåŒ–
        async function initializeQuestionFlow() {
            try {
                console.log('QuestionFlowåˆæœŸåŒ–é–‹å§‹...');
                
                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–
                storageManager = new StorageManager();
                
                // QuestionFlowåˆæœŸåŒ–
                questionFlow = new QuestionFlow("questions-container", {
                    storageManager: storageManager,
                    onProgress: function (progress) {
                        console.log(`Progress: ${progress.toFixed(1)}%`);
                    },
                    onComplete: function (answers) {
                        console.log("All questions completed:", answers);
                        updateDebugInfo('å…¨è³ªå•å®Œäº†');
                    }
                });

                questionFlow.init();
                questionFlow.show();

                updateDebugInfo('QuestionFlowåˆæœŸåŒ–å®Œäº†');
                console.log('QuestionFlow initialized:', questionFlow);
                
                // åˆæœŸçŠ¶æ…‹ã‚’ãƒ­ã‚°
                setTimeout(() => {
                    logCurrentState();
                }, 500);

            } catch (error) {
                console.error('QuestionFlow initialization failed:', error);
                updateDebugInfo(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:<br>${error.message}`);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        document.addEventListener("DOMContentLoaded", async function () {
            console.log('DOM loaded, initializing...');
            updateDebugInfo('åˆæœŸåŒ–ä¸­...');
            
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰åˆæœŸåŒ–ï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿å®Œäº†ã‚’å¾…ã¤ï¼‰
            setTimeout(() => {
                initializeQuestionFlow();
            }, 1000);
        });

        // QuestionFlowã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰ã—ã¦ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¿½åŠ 
        document.addEventListener("DOMContentLoaded", function() {
            // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰
            setTimeout(() => {
                if (window.QuestionFlow) {
                    const originalRender = QuestionFlow.prototype.renderCurrentQuestion;
                    QuestionFlow.prototype.renderCurrentQuestion = function() {
                        const questionNum = this.currentQuestionIndex + 1;
                        const isEven = questionNum % 2 === 0;
                        console.log(`ğŸ¯ renderCurrentQuestion called for Q${questionNum} ${isEven ? '(å¶æ•°)' : '(å¥‡æ•°)'}`);
                        
                        const result = originalRender.call(this);
                        
                        // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å¾Œã®çŠ¶æ…‹ç¢ºèª
                        setTimeout(() => {
                            const container = document.querySelector('#question-display');
                            const hasContent = container && container.innerHTML.trim().length > 0;
                            console.log(`ğŸ¯ Q${questionNum} render result: ${hasContent ? 'SUCCESS' : 'FAILED'}`);
                            
                            if (!hasContent) {
                                console.error(`âŒ Q${questionNum}${isEven ? '(å¶æ•°)' : '(å¥‡æ•°)'}ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã«å¤±æ•—ï¼`);
                            }
                        }, 100);
                        
                        return result;
                    };
                }
            }, 500);
        });
    </script>
</body>
</html>