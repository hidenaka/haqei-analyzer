<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-header {
            background: #21262d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #a5a5ff;
        }
        .test-section {
            background: #161b22;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .browser-card {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
            position: relative;
        }
        .browser-detected {
            border-color: #2ea043;
            background: #0d2818;
        }
        .browser-unsupported {
            border-color: #f85149;
            background: #2d1b1e;
        }
        .browser-partial {
            border-color: #d29922;
            background: #2d2613;
        }
        .test-result {
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid;
            font-size: 12px;
        }
        .test-pass {
            background: #0d4429;
            border-color: #238636;
            color: #2ea043;
        }
        .test-fail {
            background: #490202;
            border-color: #da3633;
            color: #f85149;
        }
        .test-warn {
            background: #333017;
            border-color: #d29922;
            color: #f0c674;
        }
        .test-info {
            background: #0c2d6b;
            border-color: #1f6feb;
            color: #58a6ff;
        }
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 15px 0;
        }
        .feature-card {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 12px;
        }
        .feature-supported {
            border-color: #2ea043;
            background: #0d2818;
        }
        .feature-unsupported {
            border-color: #f85149;
            background: #2d1b1e;
        }
        .feature-partial {
            border-color: #d29922;
            background: #2d2613;
        }
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #21262d;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #30363d;
            min-width: 200px;
        }
        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            font-size: 12px;
            width: 100%;
        }
        .btn:hover {
            background: #2ea043;
        }
        .btn-secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background: #30363d;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background-color: #2ea043; }
        .status-fail { background-color: #f85149; }
        .status-warn { background-color: #f0c674; }
        .status-unknown { background-color: #6e7681; }
        .log-section {
            background: #010409;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #30363d;
            max-height: 300px;
            overflow-y: auto;
            font-size: 11px;
        }
        .browser-info {
            font-size: 11px;
            color: #8b949e;
            margin-top: 8px;
        }
        .compatibility-score {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #30363d;
            padding: 5px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        .score-high { background: #238636; }
        .score-medium { background: #d29922; }
        .score-low { background: #da3633; }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="control-panel">
        <h3>äº’æ›æ€§ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h3>
        <button class="btn" onclick="startCompatibilityTest()">äº’æ›æ€§ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        <button class="btn btn-secondary" onclick="testSpecificFeature()">å€‹åˆ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn btn-secondary" onclick="generateReport()">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ</button>
        <button class="btn btn-secondary" onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        <div style="margin-top: 15px;">
            <div>ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶: <span id="current-browser">æ¤œå‡ºä¸­...</span></div>
            <div>äº’æ›æ€§ã‚¹ã‚³ã‚¢: <span id="compatibility-score">-</span></div>
        </div>
    </div>

    <div class="test-container">
        <div class="test-header">
            <h1>ğŸŒ ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆ</h1>
            <p>HaQei Analyzerã®å„ç¨®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œç¢ºèªã¨äº’æ›æ€§æ¤œè¨¼ã‚’è¡Œã„ã¾ã™ã€‚</p>
        </div>

        <div class="test-section">
            <h2>ğŸ” ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡ºçµæœ</h2>
            <div id="browser-detection"></div>
        </div>

        <div class="test-section">
            <h2>âš™ï¸ æ©Ÿèƒ½äº’æ›æ€§ãƒã‚§ãƒƒã‚¯</h2>
            <div class="feature-grid" id="feature-compatibility"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š äº’æ›æ€§ãƒ†ã‚¹ãƒˆçµæœ</h2>
            <div id="compatibility-results"></div>
        </div>

        <div class="test-section">
            <h2>ğŸš¨ æ—¢çŸ¥ã®å•é¡Œãƒ»åˆ¶é™äº‹é …</h2>
            <div id="known-issues"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ­ã‚°</h2>
            <div class="log-section" id="compatibility-log">
                <pre>äº’æ›æ€§ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã™ã‚‹ã«ã¯åˆ¶å¾¡ãƒ‘ãƒãƒ«ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚</pre>
            </div>
        </div>
    </div>

    <script>
        let compatibilityState = {
            isRunning: false,
            browserInfo: {},
            featureSupport: {},
            testResults: [],
            logs: [],
            compatibilityScore: 0
        };

        const requiredFeatures = [
            {
                name: 'ES6 Classes',
                test: () => {
                    try {
                        new Function('class Test {}; return Test;')();
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                fallback: 'ES5 prototypeç¶™æ‰¿ã‚’ä½¿ç”¨',
                critical: true
            },
            {
                name: 'Arrow Functions',
                test: () => {
                    try {
                        new Function('() => {}')();
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                fallback: 'functionå¼ã‚’ä½¿ç”¨',
                critical: false
            },
            {
                name: 'Template Literals',
                test: () => {
                    try {
                        new Function('`test`')();
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                fallback: 'æ–‡å­—åˆ—é€£çµã‚’ä½¿ç”¨',
                critical: false
            },
            {
                name: 'Promise',
                test: () => typeof Promise !== 'undefined',
                fallback: 'ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯é–¢æ•°ã‚’ä½¿ç”¨',
                critical: true
            },
            {
                name: 'async/await',
                test: () => {
                    try {
                        new Function('async function test() { await Promise.resolve(); }')();
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                fallback: 'Promise.then()ã‚’ä½¿ç”¨',
                critical: false
            },
            {
                name: 'localStorage',
                test: () => {
                    try {
                        const test = '__localStorage_test__';
                        localStorage.setItem(test, test);
                        localStorage.removeItem(test);
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                fallback: 'ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨',
                critical: true
            },
            {
                name: 'sessionStorage',
                test: () => {
                    try {
                        const test = '__sessionStorage_test__';
                        sessionStorage.setItem(test, test);
                        sessionStorage.removeItem(test);
                        return true;
                    } catch (e) {
                        return false;
                    }
                },
                fallback: 'ãƒ¡ãƒ¢ãƒªã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ä½¿ç”¨',
                critical: false
            },
            {
                name: 'JSON',
                test: () => typeof JSON !== 'undefined' && typeof JSON.parse === 'function' && typeof JSON.stringify === 'function',
                fallback: 'JSONãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’å¤–éƒ¨èª­ã¿è¾¼ã¿',
                critical: true
            },
            {
                name: 'fetch API',
                test: () => typeof fetch !== 'undefined',
                fallback: 'XMLHttpRequestã‚’ä½¿ç”¨',
                critical: false
            },
            {
                name: 'CSS Grid',
                test: () => {
                    const div = document.createElement('div');
                    div.style.display = 'grid';
                    return div.style.display === 'grid';
                },
                fallback: 'flexboxã¾ãŸã¯floatãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ',
                critical: false
            },
            {
                name: 'CSS Flexbox',
                test: () => {
                    const div = document.createElement('div');
                    div.style.display = 'flex';
                    return div.style.display === 'flex';
                },
                fallback: 'floatãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ',
                critical: false
            },
            {
                name: 'Canvas API',
                test: () => {
                    const canvas = document.createElement('canvas');
                    return !!(canvas.getContext && canvas.getContext('2d'));
                },
                fallback: 'SVGã¾ãŸã¯é™çš„ç”»åƒ',
                critical: false
            },
            {
                name: 'Web Workers',
                test: () => typeof Worker !== 'undefined',
                fallback: 'ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§å‡¦ç†',
                critical: false
            },
            {
                name: 'File API',
                test: () => typeof File !== 'undefined' && typeof FileReader !== 'undefined',
                fallback: 'ãƒ•ã‚¡ã‚¤ãƒ«æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–',
                critical: false
            },
            {
                name: 'Custom Elements',
                test: () => typeof customElements !== 'undefined',
                fallback: 'æ¨™æº–ã®HTMLã‚¨ãƒ¬ãƒ¡ãƒ³ãƒˆ',
                critical: false
            }
        ];

        const knownBrowserIssues = {
            'Internet Explorer': [
                { issue: 'ES6ã‚µãƒãƒ¼ãƒˆãªã—', severity: 'critical', workaround: 'Babelãƒˆãƒ©ãƒ³ã‚¹ãƒ‘ã‚¤ãƒ©ãŒå¿…è¦' },
                { issue: 'Promiseã‚µãƒãƒ¼ãƒˆãªã—', severity: 'critical', workaround: 'polyfillãŒå¿…è¦' },
                { issue: 'CSS Gridã‚µãƒãƒ¼ãƒˆãªã—', severity: 'medium', workaround: 'flexboxã§ä»£æ›¿' },
                { issue: 'fetch APIã‚µãƒãƒ¼ãƒˆãªã—', severity: 'medium', workaround: 'XMLHttpRequestã§ä»£æ›¿' }
            ],
            'Edge Legacy': [
                { issue: 'ä¸€éƒ¨ES6æ©Ÿèƒ½ã®åˆ¶é™', severity: 'medium', workaround: 'polyfillã§å¯¾å¿œ' },
                { issue: 'CSS Gridéƒ¨åˆ†ã‚µãƒãƒ¼ãƒˆ', severity: 'low', workaround: 'ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ãŒå¿…è¦' }
            ],
            'Safari': [
                { issue: 'Dateå‡¦ç†ã®é•ã„', severity: 'low', workaround: 'æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’çµ±ä¸€' },
                { issue: 'localStorageãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰åˆ¶é™', severity: 'medium', workaround: 'try-catchã§ä¾‹å¤–å‡¦ç†' }
            ],
            'Chrome': [
                { issue: 'ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãŒå¤šã„å ´åˆãŒã‚ã‚‹', severity: 'low', workaround: 'å®šæœŸçš„ãªã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³' }
            ],
            'Firefox': [
                { issue: 'ä¸€éƒ¨CSSãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãƒ™ãƒ³ãƒ€ãƒ¼ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹', severity: 'low', workaround: 'ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ä»˜ãCSSã‚’ä½µè¨˜' }
            ]
        };

        function logCompat(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 8);
            const logEntry = `[${timestamp}] ${message}`;
            compatibilityState.logs.push({ timestamp, message, type });
            
            const logSection = document.getElementById('compatibility-log');
            const logElement = document.createElement('div');
            logElement.textContent = logEntry;
            logElement.className = `log-${type}`;
            logSection.appendChild(logElement);
            logSection.scrollTop = logSection.scrollHeight;
        }

        function detectBrowser() {
            const userAgent = navigator.userAgent;
            const platform = navigator.platform;
            
            let browser = 'Unknown';
            let version = 'Unknown';
            let engine = 'Unknown';
            
            // Browser detection
            if (userAgent.includes('Firefox')) {
                browser = 'Firefox';
                const match = userAgent.match(/Firefox\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
                engine = 'Gecko';
            } else if (userAgent.includes('Chrome') && !userAgent.includes('Chromium')) {
                browser = 'Chrome';
                const match = userAgent.match(/Chrome\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
                engine = 'Blink';
            } else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) {
                browser = 'Safari';
                const match = userAgent.match(/Version\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
                engine = 'WebKit';
            } else if (userAgent.includes('Edge')) {
                browser = 'Edge';
                const match = userAgent.match(/Edge\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
                engine = 'EdgeHTML';
            } else if (userAgent.includes('Edg')) {
                browser = 'Edge Chromium';
                const match = userAgent.match(/Edg\/(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
                engine = 'Blink';
            } else if (userAgent.includes('Trident') || userAgent.includes('MSIE')) {
                browser = 'Internet Explorer';
                const match = userAgent.match(/(?:MSIE |rv:)(\d+\.\d+)/);
                version = match ? match[1] : 'Unknown';
                engine = 'Trident';
            }

            return {
                browser,
                version,
                engine,
                platform,
                userAgent,
                isMobile: /Android|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(userAgent),
                cookieEnabled: navigator.cookieEnabled,
                javaEnabled: navigator.javaEnabled ? navigator.javaEnabled() : false,
                onLine: navigator.onLine,
                language: navigator.language,
                languages: navigator.languages || [navigator.language]
            };
        }

        function testFeatureCompatibility() {
            const results = {};
            let supportedCount = 0;
            let criticalIssues = 0;

            requiredFeatures.forEach(feature => {
                try {
                    const supported = feature.test();
                    results[feature.name] = {
                        supported,
                        critical: feature.critical,
                        fallback: feature.fallback
                    };

                    if (supported) {
                        supportedCount++;
                    } else if (feature.critical) {
                        criticalIssues++;
                    }
                } catch (error) {
                    results[feature.name] = {
                        supported: false,
                        critical: feature.critical,
                        fallback: feature.fallback,
                        error: error.message
                    };

                    if (feature.critical) {
                        criticalIssues++;
                    }
                }
            });

            const compatibilityScore = Math.round((supportedCount / requiredFeatures.length) * 100);
            
            return {
                results,
                supportedCount,
                totalFeatures: requiredFeatures.length,
                criticalIssues,
                compatibilityScore
            };
        }

        function renderBrowserDetection() {
            const browserInfo = detectBrowser();
            compatibilityState.browserInfo = browserInfo;
            
            const detectionDiv = document.getElementById('browser-detection');
            
            const compatibility = getBrowserCompatibilityLevel(browserInfo.browser, browserInfo.version);
            
            detectionDiv.innerHTML = `
                <div class="browser-card ${compatibility.class}">
                    <div class="compatibility-score ${compatibility.scoreClass}">${compatibility.score}%</div>
                    <h3>${browserInfo.browser} ${browserInfo.version}</h3>
                    <div class="browser-info">
                        <div><strong>ã‚¨ãƒ³ã‚¸ãƒ³:</strong> ${browserInfo.engine}</div>
                        <div><strong>ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ :</strong> ${browserInfo.platform}</div>
                        <div><strong>è¨€èª:</strong> ${browserInfo.language}</div>
                        <div><strong>ãƒ¢ãƒã‚¤ãƒ«:</strong> ${browserInfo.isMobile ? 'ã¯ã„' : 'ã„ã„ãˆ'}</div>
                        <div><strong>Cookieæœ‰åŠ¹:</strong> ${browserInfo.cookieEnabled ? 'ã¯ã„' : 'ã„ã„ãˆ'}</div>
                        <div><strong>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³:</strong> ${browserInfo.onLine ? 'ã¯ã„' : 'ã„ã„ãˆ'}</div>
                    </div>
                    <div style="margin-top: 10px;">
                        <strong>äº’æ›æ€§ãƒ¬ãƒ™ãƒ«:</strong> ${compatibility.level}
                    </div>
                </div>
            `;

            document.getElementById('current-browser').textContent = `${browserInfo.browser} ${browserInfo.version}`;
        }

        function getCompatibilityScore(compatibility) {
            if (compatibility >= 90) return { class: 'score-high', text: 'é«˜' };
            if (compatibility >= 70) return { class: 'score-medium', text: 'ä¸­' };
            return { class: 'score-low', text: 'ä½' };
        }

        function getCompatibilityClass(compatibility) {
            if (compatibility >= 90) return 'browser-detected';
            if (compatibility >= 70) return 'browser-partial';
            return 'browser-unsupported';
        }

        function getCompatibilityLevel(compatibility) {
            if (compatibility >= 90) return 'å®Œå…¨å¯¾å¿œ';
            if (compatibility >= 70) return 'éƒ¨åˆ†å¯¾å¿œ';
            return 'åˆ¶é™ã‚ã‚Š';
        }

        function getCompatibilityScoreClass(compatibility) {
            if (compatibility >= 90) return 'score-high';
            if (compatibility >= 70) return 'score-medium';
            return 'score-low';
        }

        function getCompatibilityScoreText(compatibility) {
            return `${compatibility}%`;
        }

        function getCompatibilityLevelText(compatibility) {
            if (compatibility >= 90) return 'å®Œå…¨å¯¾å¿œ';
            if (compatibility >= 70) return 'éƒ¨åˆ†å¯¾å¿œ';
            return 'åˆ¶é™ã‚ã‚Š';
        }

        function getBrowserCompatibilityLevel(browser, version) {
            // ç°¡å˜ãªäº’æ›æ€§åˆ¤å®š
            const versionNum = parseFloat(version);
            
            let score = 100;
            let level = 'å®Œå…¨å¯¾å¿œ';
            
            switch (browser) {
                case 'Internet Explorer':
                    score = 30;
                    level = 'éå¯¾å¿œï¼ˆè¦polyfillï¼‰';
                    break;
                case 'Edge Legacy':
                    score = 70;
                    level = 'éƒ¨åˆ†å¯¾å¿œ';
                    break;
                case 'Edge Chromium':
                    score = 95;
                    level = 'å®Œå…¨å¯¾å¿œ';
                    break;
                case 'Chrome':
                    score = versionNum >= 60 ? 95 : 80;
                    level = versionNum >= 60 ? 'å®Œå…¨å¯¾å¿œ' : 'éƒ¨åˆ†å¯¾å¿œ';
                    break;
                case 'Firefox':
                    score = versionNum >= 60 ? 90 : 75;
                    level = versionNum >= 60 ? 'å®Œå…¨å¯¾å¿œ' : 'éƒ¨åˆ†å¯¾å¿œ';
                    break;
                case 'Safari':
                    score = versionNum >= 12 ? 85 : 70;
                    level = versionNum >= 12 ? 'å®Œå…¨å¯¾å¿œ' : 'éƒ¨åˆ†å¯¾å¿œ';
                    break;
                default:
                    score = 60;
                    level = 'ä¸æ˜';
            }

            return {
                score,
                level,
                class: getCompatibilityClass(score),
                scoreClass: getCompatibilityScoreClass(score)
            };
        }

        function renderFeatureCompatibility() {
            const featureTest = testFeatureCompatibility();
            compatibilityState.featureSupport = featureTest;
            compatibilityState.compatibilityScore = featureTest.compatibilityScore;
            
            const featuresDiv = document.getElementById('feature-compatibility');
            featuresDiv.innerHTML = '';

            requiredFeatures.forEach(feature => {
                const result = featureTest.results[feature.name];
                const featureDiv = document.createElement('div');
                
                const statusClass = result.supported ? 'feature-supported' : 
                                   (result.critical ? 'feature-unsupported' : 'feature-partial');
                
                featureDiv.className = `feature-card ${statusClass}`;
                featureDiv.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 8px;">
                        <span class="status-indicator ${result.supported ? 'status-pass' : 'status-fail'}"></span>
                        <strong>${feature.name}</strong>
                        ${feature.critical ? ' <span style="color: #f85149; font-size: 10px;">[å¿…é ˆ]</span>' : ''}
                    </div>
                    <div style="font-size: 11px; color: #8b949e;">
                        ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${result.supported ? 'å¯¾å¿œ' : 'éå¯¾å¿œ'}
                        ${!result.supported ? `<br>ä»£æ›¿æ‰‹æ®µ: ${result.fallback}` : ''}
                        ${result.error ? `<br>ã‚¨ãƒ©ãƒ¼: ${result.error}` : ''}
                    </div>
                `;

                featuresDiv.appendChild(featureDiv);
            });

            const scoreInfo = getCompatibilityScore(featureTest.compatibilityScore);
            document.getElementById('compatibility-score').textContent = 
                `${featureTest.compatibilityScore}% (${scoreInfo.text})`;
        }

        function renderKnownIssues() {
            const issuesDiv = document.getElementById('known-issues');
            const browserName = compatibilityState.browserInfo.browser;
            
            const issues = knownBrowserIssues[browserName] || [];
            
            if (issues.length === 0) {
                issuesDiv.innerHTML = `
                    <div class="test-result test-pass">
                        <span class="status-indicator status-pass"></span>
                        ${browserName}ã«é–¢ã™ã‚‹æ—¢çŸ¥ã®å•é¡Œã¯å ±å‘Šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
                    </div>
                `;
                return;
            }

            issuesDiv.innerHTML = issues.map(issue => {
                const severityClass = {
                    'critical': 'test-fail',
                    'high': 'test-fail',
                    'medium': 'test-warn',
                    'low': 'test-info'
                }[issue.severity];

                const severityIcon = {
                    'critical': 'status-fail',
                    'high': 'status-fail',
                    'medium': 'status-warn',
                    'low': 'status-unknown'
                }[issue.severity];

                return `
                    <div class="test-result ${severityClass}">
                        <span class="status-indicator ${severityIcon}"></span>
                        <strong>${issue.issue}</strong> [${issue.severity}]
                        <br><small>å¯¾å‡¦æ³•: ${issue.workaround}</small>
                    </div>
                `;
            }).join('');
        }

        function addCompatibilityResult(testName, passed, message, details = {}) {
            compatibilityState.testResults.push({
                name: testName,
                passed,
                message,
                details,
                timestamp: Date.now()
            });

            const resultsDiv = document.getElementById('compatibility-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
            
            const statusIcon = passed ? 'âœ…' : 'âŒ';
            resultDiv.innerHTML = `
                <span class="status-indicator ${passed ? 'status-pass' : 'status-fail'}"></span>
                ${statusIcon} <strong>${testName}</strong>: ${message}
                ${Object.keys(details).length > 0 ? `<br><small><pre>${JSON.stringify(details, null, 2)}</pre></small>` : ''}
            `;
            
            resultsDiv.appendChild(resultDiv);
        }

        async function startCompatibilityTest() {
            if (compatibilityState.isRunning) {
                logCompat('äº’æ›æ€§ãƒ†ã‚¹ãƒˆã¯æ—¢ã«å®Ÿè¡Œä¸­ã§ã™', 'warn');
                return;
            }

            compatibilityState.isRunning = true;
            logCompat('ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            
            try {
                // ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º
                logCompat('ãƒ–ãƒ©ã‚¦ã‚¶æƒ…å ±ã‚’æ¤œå‡ºä¸­...', 'info');
                renderBrowserDetection();
                
                // æ©Ÿèƒ½äº’æ›æ€§ãƒ†ã‚¹ãƒˆ
                logCompat('æ©Ÿèƒ½äº’æ›æ€§ã‚’ãƒ†ã‚¹ãƒˆä¸­...', 'info');
                renderFeatureCompatibility();
                
                // æ—¢çŸ¥ã®å•é¡Œè¡¨ç¤º
                logCompat('æ—¢çŸ¥ã®å•é¡Œã‚’ãƒã‚§ãƒƒã‚¯ä¸­...', 'info');
                renderKnownIssues();
                
                // å€‹åˆ¥ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
                await runSpecificCompatibilityTests();
                
                logCompat('ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Œäº†', 'success');
                
            } catch (error) {
                logCompat(`ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ: ${error.message}`, 'error');
            } finally {
                compatibilityState.isRunning = false;
            }
        }

        async function runSpecificCompatibilityTests() {
            // DOMæ“ä½œãƒ†ã‚¹ãƒˆ
            try {
                const testDiv = document.createElement('div');
                testDiv.innerHTML = '<span>test</span>';
                document.body.appendChild(testDiv);
                document.body.removeChild(testDiv);
                
                addCompatibilityResult(
                    'DOMæ“ä½œ',
                    true,
                    'DOMæ“ä½œãŒæ­£å¸¸ã«å‹•ä½œ',
                    {}
                );
            } catch (error) {
                addCompatibilityResult(
                    'DOMæ“ä½œ',
                    false,
                    `DOMæ“ä½œã‚¨ãƒ©ãƒ¼: ${error.message}`,
                    { error: error.stack }
                );
            }

            // ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãƒ†ã‚¹ãƒˆ
            try {
                const testElement = document.createElement('div');
                let eventFired = false;
                
                testElement.addEventListener('click', () => {
                    eventFired = true;
                });
                
                testElement.click();
                
                addCompatibilityResult(
                    'ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†',
                    eventFired,
                    eventFired ? 'ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ãŒæ­£å¸¸ã«å‹•ä½œ' : 'ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã«å•é¡Œ',
                    { eventFired }
                );
            } catch (error) {
                addCompatibilityResult(
                    'ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†',
                    false,
                    `ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼: ${error.message}`,
                    { error: error.stack }
                );
            }

            // CSS ã‚µãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
            try {
                const testElement = document.createElement('div');
                testElement.style.transform = 'translateX(10px)';
                const supportsTransform = testElement.style.transform !== '';
                
                addCompatibilityResult(
                    'CSS Transform',
                    supportsTransform,
                    supportsTransform ? 'CSS TransformãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™' : 'CSS TransformãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“',
                    { supportsTransform }
                );
            } catch (error) {
                addCompatibilityResult(
                    'CSS Transform',
                    false,
                    `CSS Transformãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`,
                    { error: error.stack }
                );
            }

            // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒãƒ¼ãƒˆãƒ†ã‚¹ãƒˆ
            try {
                const supportsAnimation = 'animate' in document.createElement('div');
                
                addCompatibilityResult(
                    'Web Animations API',
                    supportsAnimation,
                    supportsAnimation ? 'Web Animations APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™' : 'Web Animations APIãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“',
                    { supportsAnimation }
                );
            } catch (error) {
                addCompatibilityResult(
                    'Web Animations API',
                    false,
                    `Web Animations APIãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`,
                    { error: error.stack }
                );
            }
        }

        function testSpecificFeature() {
            const featureName = prompt('ãƒ†ã‚¹ãƒˆã™ã‚‹æ©Ÿèƒ½åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¾‹: localStorage, Promise, etc.ï¼‰:');
            if (!featureName) return;

            logCompat(`å€‹åˆ¥æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹: ${featureName}`, 'info');

            const feature = requiredFeatures.find(f => f.name.toLowerCase().includes(featureName.toLowerCase()));
            
            if (feature) {
                try {
                    const result = feature.test();
                    addCompatibilityResult(
                        `å€‹åˆ¥ãƒ†ã‚¹ãƒˆ: ${feature.name}`,
                        result,
                        result ? 'æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã™' : 'æ©Ÿèƒ½ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“',
                        { feature: feature.name, fallback: feature.fallback }
                    );
                    logCompat(`${feature.name}: ${result ? 'å¯¾å¿œ' : 'éå¯¾å¿œ'}`, result ? 'success' : 'warn');
                } catch (error) {
                    addCompatibilityResult(
                        `å€‹åˆ¥ãƒ†ã‚¹ãƒˆ: ${feature.name}`,
                        false,
                        `ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`,
                        { error: error.stack }
                    );
                    logCompat(`${feature.name}: ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ - ${error.message}`, 'error');
                }
            } else {
                logCompat(`æ©Ÿèƒ½ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${featureName}`, 'warn');
            }
        }

        function generateReport() {
            const report = {
                timestamp: new Date().toISOString(),
                browserInfo: compatibilityState.browserInfo,
                featureSupport: compatibilityState.featureSupport,
                testResults: compatibilityState.testResults,
                compatibilityScore: compatibilityState.compatibilityScore,
                knownIssues: knownBrowserIssues[compatibilityState.browserInfo.browser] || [],
                recommendations: generateRecommendations()
            };

            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `browser-compatibility-report-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            logCompat('äº’æ›æ€§ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ', 'success');
        }

        function generateRecommendations() {
            const recommendations = [];
            const browser = compatibilityState.browserInfo.browser;
            const score = compatibilityState.compatibilityScore;

            if (score < 70) {
                recommendations.push('ãƒ–ãƒ©ã‚¦ã‚¶ã‚’æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã‚’å¼·ãæ¨å¥¨ã—ã¾ã™');
            }

            if (browser === 'Internet Explorer') {
                recommendations.push('Internet Explorerã¯éæ¨å¥¨ã§ã™ã€‚Chromeã€Firefoxã€ã¾ãŸã¯Edgeã‚’ã”åˆ©ç”¨ãã ã•ã„');
                recommendations.push('polyfillãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®å°å…¥ã‚’æ¤œè¨ã—ã¦ãã ã•ã„');
            }

            if (!compatibilityState.featureSupport.results?.localStorage?.supported) {
                recommendations.push('localStorageãŒåˆ©ç”¨ã§ããªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã¾ã™');
            }

            if (!compatibilityState.featureSupport.results?.Promise?.supported) {
                recommendations.push('Promise polyfillã®å°å…¥ãŒå¿…è¦ã§ã™');
            }

            return recommendations;
        }

        function clearLogs() {
            document.getElementById('compatibility-log').innerHTML = '<pre>ãƒ­ã‚°ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸã€‚</pre>';
            compatibilityState.logs = [];
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            logCompat('ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', 'info');
            
            // åˆæœŸãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º
            renderBrowserDetection();
        });
    </script>
</body>
</html>