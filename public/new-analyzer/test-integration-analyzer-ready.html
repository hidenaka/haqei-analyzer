<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analyzer準備完了テスト</title>
    <style>
        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 20px;
        }
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
        }
        .test-header {
            background: #21262d;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #58a6ff;
        }
        .test-section {
            background: #161b22;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #30363d;
        }
        .status-card {
            background: #21262d;
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 15px;
            margin: 10px 0;
        }
        .status-ready {
            border-color: #2ea043;
            background: #0d2818;
        }
        .status-pending {
            border-color: #d29922;
            background: #2d2613;
        }
        .status-error {
            border-color: #f85149;
            background: #2d1b1e;
        }
        .btn {
            background: #238636;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 14px;
        }
        .btn:hover {
            background: #2ea043;
        }
        .btn-secondary {
            background: #21262d;
            border: 1px solid #30363d;
        }
        .btn-secondary:hover {
            background: #30363d;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-pass { background-color: #2ea043; }
        .status-fail { background-color: #f85149; }
        .status-warn { background-color: #f0c674; }
        .status-unknown { background-color: #6e7681; }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .info-item {
            background: #161b22;
            border: 1px solid #30363d;
            border-radius: 4px;
            padding: 10px;
            font-size: 12px;
        }
        .log-section {
            background: #010409;
            padding: 15px;
            margin: 10px 0;
            border-radius: 6px;
            border: 1px solid #30363d;
            max-height: 300px;
            overflow-y: auto;
            font-size: 11px;
        }
        pre {
            margin: 0;
            white-space: pre-wrap;
            word-break: break-word;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🎯 Analyzer準備完了テスト</h1>
            <p>analyzer.html が正常に動作するために必要な要素を事前確認します。</p>
            <div>
                <button class="btn" onclick="checkAnalyzerReadiness()">準備状況確認</button>
                <button class="btn btn-secondary" onclick="openAnalyzer()">analyzer.html を開く</button>
                <button class="btn btn-secondary" onclick="openOSAnalyzer()">os_analyzer.html を開く</button>
            </div>
        </div>

        <div class="test-section">
            <h2>📋 準備完了チェックリスト</h2>
            <div id="readiness-checklist"></div>
        </div>

        <div class="test-section">
            <h2>📁 ファイル構造確認</h2>
            <div class="info-grid" id="file-structure"></div>
        </div>

        <div class="test-section">
            <h2>🔧 環境情報</h2>
            <div class="info-grid" id="environment-info"></div>
        </div>

        <div class="test-section">
            <h2>💡 推奨アクション</h2>
            <div id="recommendations"></div>
        </div>

        <div class="test-section">
            <h2>📋 確認ログ</h2>
            <div class="log-section" id="check-log">
                <pre>「準備状況確認」ボタンをクリックして、analyzer.htmlの動作準備を確認してください。</pre>
            </div>
        </div>
    </div>

    <script>
        let checkState = {
            logs: [],
            fileChecks: {},
            environmentInfo: {},
            recommendations: []
        };

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 8);
            const logEntry = `[${timestamp}] ${message}`;
            checkState.logs.push({ timestamp, message, type });
            
            const logSection = document.getElementById('check-log');
            const logElement = document.createElement('div');
            logElement.textContent = logEntry;
            logElement.className = `log-${type}`;
            logSection.appendChild(logElement);
            logSection.scrollTop = logSection.scrollHeight;
        }

        async function checkAnalyzerReadiness() {
            log('Analyzer準備状況確認を開始', 'info');
            
            // 環境情報収集
            await collectEnvironmentInfo();
            
            // ファイル構造確認
            await checkFileStructure();
            
            // 準備完了チェックリスト更新
            updateReadinessChecklist();
            
            // 推奨アクション生成
            generateRecommendations();
            
            log('Analyzer準備状況確認完了', 'success');
        }

        async function collectEnvironmentInfo() {
            log('環境情報を収集中...', 'info');
            
            checkState.environmentInfo = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookieEnabled: navigator.cookieEnabled,
                onLine: navigator.onLine,
                localStorage: (() => {
                    try {
                        const test = '__test__';
                        localStorage.setItem(test, test);
                        localStorage.removeItem(test);
                        return 'available';
                    } catch (e) {
                        return 'unavailable';
                    }
                })(),
                currentUrl: window.location.href,
                protocol: window.location.protocol,
                hostname: window.location.hostname,
                pathname: window.location.pathname
            };

            updateEnvironmentInfo();
        }

        async function checkFileStructure() {
            log('ファイル構造を確認中...', 'info');
            
            const checks = [
                {
                    name: 'analyzer.html',
                    path: './analyzer.html',
                    description: '開発用メインファイル'
                },
                {
                    name: 'os_analyzer.html',
                    path: '../os_analyzer.html',
                    description: '本番用メインファイル'
                },
                {
                    name: 'Chart.js CDN',
                    path: 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                    description: 'グラフライブラリ'
                }
            ];

            checkState.fileChecks = {};

            for (const check of checks) {
                try {
                    const result = await checkFileExists(check.path);
                    checkState.fileChecks[check.name] = {
                        status: result ? 'available' : 'missing',
                        path: check.path,
                        description: check.description
                    };
                    
                    log(`${check.name}: ${result ? '確認' : '未確認'}`, result ? 'success' : 'warn');
                } catch (error) {
                    checkState.fileChecks[check.name] = {
                        status: 'error',
                        path: check.path,
                        description: check.description,
                        error: error.message
                    };
                    log(`${check.name}: エラー - ${error.message}`, 'error');
                }
            }

            updateFileStructureInfo();
        }

        async function checkFileExists(path) {
            if (path.startsWith('http')) {
                // 外部リソースの確認
                try {
                    const response = await fetch(path, { method: 'HEAD', mode: 'no-cors' });
                    return true; // no-corsモードでは詳細なステータスは取得できないが、リクエストが完了すれば存在する
                } catch (error) {
                    return false;
                }
            } else {
                // ローカルファイルの確認（制限あり）
                try {
                    const response = await fetch(path, { method: 'HEAD' });
                    return response.ok;
                } catch (error) {
                    return false;
                }
            }
        }

        function updateEnvironmentInfo() {
            const infoDiv = document.getElementById('environment-info');
            infoDiv.innerHTML = Object.entries(checkState.environmentInfo).map(([key, value]) => `
                <div class="info-item">
                    <strong>${key}:</strong><br>
                    <span style="color: #8b949e;">${value}</span>
                </div>
            `).join('');
        }

        function updateFileStructureInfo() {
            const structureDiv = document.getElementById('file-structure');
            structureDiv.innerHTML = Object.entries(checkState.fileChecks).map(([name, info]) => {
                const statusClass = {
                    'available': 'status-pass',
                    'missing': 'status-warn',
                    'error': 'status-fail'
                }[info.status];

                return `
                    <div class="info-item">
                        <span class="status-indicator ${statusClass}"></span>
                        <strong>${name}</strong><br>
                        <span style="color: #8b949e; font-size: 10px;">${info.description}</span><br>
                        <span style="color: #6e7681; font-size: 10px;">${info.path}</span>
                        ${info.error ? `<br><span style="color: #f85149; font-size: 10px;">エラー: ${info.error}</span>` : ''}
                    </div>
                `;
            }).join('');
        }

        function updateReadinessChecklist() {
            const checklistItems = [
                {
                    name: 'HTTPサーバー環境',
                    check: () => checkState.environmentInfo.protocol === 'http:' || checkState.environmentInfo.protocol === 'https:',
                    importance: 'critical',
                    message: 'HTTPサーバー経由でアクセスしている'
                },
                {
                    name: 'LocalStorage利用可能',
                    check: () => checkState.environmentInfo.localStorage === 'available',
                    importance: 'high',
                    message: 'データ保存機能が利用可能'
                },
                {
                    name: 'ネットワーク接続',
                    check: () => checkState.environmentInfo.onLine,
                    importance: 'medium',
                    message: '外部リソース読み込み可能'
                },
                {
                    name: 'Cookie有効',
                    check: () => checkState.environmentInfo.cookieEnabled,
                    importance: 'low',
                    message: 'セッション管理が可能'
                },
                {
                    name: 'Chart.js アクセス可能',
                    check: () => checkState.fileChecks['Chart.js CDN']?.status === 'available',
                    importance: 'high',
                    message: 'グラフ機能が利用可能'
                }
            ];

            const checklistDiv = document.getElementById('readiness-checklist');
            checklistDiv.innerHTML = checklistItems.map(item => {
                const passed = item.check();
                const statusClass = passed ? 'status-ready' : 'status-error';
                const importanceColor = {
                    'critical': '#f85149',
                    'high': '#d29922',
                    'medium': '#58a6ff',
                    'low': '#8b949e'
                }[item.importance];

                return `
                    <div class="status-card ${statusClass}">
                        <span class="status-indicator ${passed ? 'status-pass' : 'status-fail'}"></span>
                        <strong>${item.name}</strong>
                        <span style="color: ${importanceColor}; font-size: 12px; margin-left: 10px;">[${item.importance}]</span>
                        <div style="margin-top: 8px; font-size: 12px; color: #8b949e;">
                            ${item.message}: ${passed ? '✅ OK' : '❌ NG'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function generateRecommendations() {
            checkState.recommendations = [];

            // HTTPサーバーチェック
            if (checkState.environmentInfo.protocol === 'file:') {
                checkState.recommendations.push({
                    priority: 'high',
                    title: 'HTTPサーバーを使用してください',
                    description: 'ファイルプロトコルではCORSエラーが発生します。以下のコマンドでローカルサーバーを起動：',
                    commands: [
                        'python -m http.server 8000',
                        'npx http-server -p 8000',
                        'php -S localhost:8000'
                    ]
                });
            }

            // LocalStorageチェック
            if (checkState.environmentInfo.localStorage === 'unavailable') {
                checkState.recommendations.push({
                    priority: 'medium',
                    title: 'LocalStorageが利用できません',
                    description: 'プライベートブラウジングモードを無効にするか、別のブラウザをお試しください。'
                });
            }

            // Chart.jsチェック
            if (checkState.fileChecks['Chart.js CDN']?.status !== 'available') {
                checkState.recommendations.push({
                    priority: 'medium',
                    title: 'Chart.jsに接続できません',
                    description: 'ネットワーク接続を確認するか、CDNの代替URLを検討してください。'
                });
            }

            // ネットワークチェック
            if (!checkState.environmentInfo.onLine) {
                checkState.recommendations.push({
                    priority: 'low',
                    title: 'オフライン状態です',
                    description: '外部リソースの読み込みに影響が出る可能性があります。'
                });
            }

            updateRecommendations();
        }

        function updateRecommendations() {
            const recommendationsDiv = document.getElementById('recommendations');
            
            if (checkState.recommendations.length === 0) {
                recommendationsDiv.innerHTML = `
                    <div class="status-card status-ready">
                        <span class="status-indicator status-pass"></span>
                        <strong>すべて準備完了！</strong>
                        <div style="margin-top: 8px; font-size: 12px; color: #8b949e;">
                            analyzer.htmlを安全に実行できます。
                        </div>
                    </div>
                `;
                return;
            }

            recommendationsDiv.innerHTML = checkState.recommendations.map(rec => {
                const priorityColor = {
                    'high': '#f85149',
                    'medium': '#d29922',
                    'low': '#58a6ff'
                }[rec.priority];

                return `
                    <div class="status-card status-pending">
                        <span class="status-indicator status-warn"></span>
                        <strong>${rec.title}</strong>
                        <span style="color: ${priorityColor}; font-size: 12px; margin-left: 10px;">[${rec.priority}]</span>
                        <div style="margin-top: 8px; font-size: 12px; color: #8b949e;">
                            ${rec.description}
                        </div>
                        ${rec.commands ? `
                            <div style="margin-top: 8px; font-size: 11px; background: #161b22; padding: 8px; border-radius: 4px;">
                                ${rec.commands.map(cmd => `<div style="color: #f0c674;">$ ${cmd}</div>`).join('')}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        function openAnalyzer() {
            log('analyzer.html を開いています...', 'info');
            window.open('./analyzer.html', '_blank');
        }

        function openOSAnalyzer() {
            log('os_analyzer.html を開いています...', 'info');
            window.open('../os_analyzer.html', '_blank');
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            log('Analyzer準備完了テストページが読み込まれました', 'info');
            log('「準備状況確認」ボタンをクリックして開始してください', 'info');
        });
    </script>
</body>
</html>