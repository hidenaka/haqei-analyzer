<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>回答データ検証テスト</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-panel {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .error { background-color: #ffe6e6; border-color: #ff9999; }
        .success { background-color: #e6ffe6; border-color: #99ff99; }
        .warning { background-color: #fff3e0; border-color: #ffcc99; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .scenario-test {
            border: 2px solid #333;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🔍 回答データ検証テスト</h1>
    
    <div class="debug-panel">
        <h3>テスト制御</h3>
        <button class="btn" onclick="initializeTest()">テスト初期化</button>
        <button class="btn" onclick="testScenarioAnswers()">シナリオ質問テスト</button>
        <button class="btn" onclick="validateAllAnswers()">全回答検証</button>
        <button class="btn" onclick="simulateAnalysis()">分析処理テスト</button>
        <button class="btn" onclick="clearLog()">ログクリア</button>
    </div>

    <div class="debug-panel">
        <h3>テスト結果</h3>
        <div id="testResults">テスト実行前</div>
    </div>

    <div class="scenario-test">
        <h3>シナリオ質問テスト</h3>
        <div id="scenarioTest">
            <p>シナリオ質問の回答処理をテストします</p>
            <div id="scenarioQuestionDisplay"></div>
        </div>
    </div>

    <div class="debug-panel">
        <h3>詳細ログ</h3>
        <pre id="debugLog">ログ出力がここに表示されます...</pre>
    </div>

    <!-- Scripts -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
        let testResults = [];
        let debugLog = document.getElementById('debugLog');
        let testAnswers = [];
        
        function log(message, type = 'INFO') {
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${type}: ${message}`;
            debugLog.textContent += logMessage + '\n';
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logMessage);
        }

        function clearLog() {
            debugLog.textContent = '';
            testResults = [];
            updateResults();
        }

        function updateResults() {
            const resultsDiv = document.getElementById('testResults');
            if (testResults.length === 0) {
                resultsDiv.innerHTML = 'テスト結果なし';
                return;
            }

            const html = testResults.map(result => `
                <div class="debug-panel ${result.success ? 'success' : 'error'}">
                    <strong>${result.success ? '✅' : '❌'} ${result.name}</strong><br>
                    ${result.message}<br>
                    ${result.details ? `<small>${result.details}</small>` : ''}
                </div>
            `).join('');
            
            resultsDiv.innerHTML = html;
        }

        function addTestResult(name, success, message, details = null) {
            testResults.push({ name, success, message, details });
            updateResults();
            log(`${name}: ${success ? 'SUCCESS' : 'FAIL'} - ${message}`, success ? 'SUCCESS' : 'ERROR');
        }

        function initializeTest() {
            log('テスト初期化開始');
            testAnswers = [];
            
            // 質問データの確認
            if (typeof WORLDVIEW_QUESTIONS === 'undefined') {
                addTestResult('質問データ読み込み', false, 'WORLDVIEW_QUESTIONSが未定義');
                return;
            }
            
            if (typeof SCENARIO_QUESTIONS === 'undefined') {
                addTestResult('質問データ読み込み', false, 'SCENARIO_QUESTIONSが未定義');
                return;
            }
            
            const totalQuestions = WORLDVIEW_QUESTIONS.length + SCENARIO_QUESTIONS.length;
            addTestResult('質問データ読み込み', true, `${totalQuestions}問の質問データを読み込み`);
            
            log('テスト初期化完了');
        }

        function testScenarioAnswers() {
            log('シナリオ質問テスト開始');
            
            // シナリオ質問を探す
            const scenarioQuestions = [...WORLDVIEW_QUESTIONS, ...SCENARIO_QUESTIONS]
                .filter(q => q.scenario && q.inner_q && q.outer_q);
            
            if (scenarioQuestions.length === 0) {
                addTestResult('シナリオ質問検索', false, 'シナリオ質問が見つかりません');
                return;
            }
            
            log(`${scenarioQuestions.length}個のシナリオ質問を発見`);
            
            // 最初のシナリオ質問をテスト
            const testQuestion = scenarioQuestions[0];
            log(`テスト対象: ${testQuestion.id}`);
            
            // シナリオ質問を表示
            displayScenarioQuestion(testQuestion);
            
            // 模擬回答を作成
            const mockAnswer = {
                questionId: testQuestion.id,
                timestamp: new Date().toISOString()
            };
            
            // Inner choice を追加
            if (testQuestion.options.inner && testQuestion.options.inner.length > 0) {
                mockAnswer.innerChoice = {
                    value: testQuestion.options.inner[0].value,
                    scoring_tags: testQuestion.options.inner[0].scoring_tags
                };
                log(`Inner choice 設定: ${mockAnswer.innerChoice.value}`);
            }
            
            // Outer choice を追加
            if (testQuestion.options.outer && testQuestion.options.outer.length > 0) {
                mockAnswer.outerChoice = {
                    value: testQuestion.options.outer[0].value,
                    scoring_tags: testQuestion.options.outer[0].scoring_tags
                };
                log(`Outer choice 設定: ${mockAnswer.outerChoice.value}`);
            }
            
            // 回答を検証
            const isValid = validateScenarioAnswer(testQuestion, mockAnswer);
            addTestResult('シナリオ回答検証', isValid, 
                isValid ? '模擬シナリオ回答が有効' : '模擬シナリオ回答が無効',
                JSON.stringify(mockAnswer, null, 2));
            
            testAnswers.push(mockAnswer);
        }

        function displayScenarioQuestion(question) {
            const display = document.getElementById('scenarioQuestionDisplay');
            display.innerHTML = `
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                    <h4>${question.id}</h4>
                    <p><strong>状況:</strong> ${question.scenario}</p>
                    <p><strong>内面質問:</strong> ${question.inner_q}</p>
                    <p><strong>外面質問:</strong> ${question.outer_q}</p>
                    <p><strong>内面選択肢数:</strong> ${question.options.inner ? question.options.inner.length : 0}</p>
                    <p><strong>外面選択肢数:</strong> ${question.options.outer ? question.options.outer.length : 0}</p>
                </div>
            `;
        }

        function validateScenarioAnswer(question, answer) {
            // QuestionFlowの検証ロジックを再現
            if (!answer.questionId) {
                log('検証失敗: questionId なし', 'ERROR');
                return false;
            }
            
            const isScenario = question.scenario && question.inner_q && question.outer_q;
            if (!isScenario) {
                log('検証失敗: シナリオ質問ではない', 'ERROR');
                return false;
            }
            
            if (!answer.innerChoice || !answer.outerChoice) {
                log('検証失敗: inner/outer choice が不足', 'ERROR');
                return false;
            }
            
            if (!answer.innerChoice.value || !answer.outerChoice.value) {
                log('検証失敗: inner/outer choice の値が空', 'ERROR');
                return false;
            }
            
            log('シナリオ回答検証成功', 'SUCCESS');
            return true;
        }

        function validateAllAnswers() {
            log('全回答検証開始');
            
            if (testAnswers.length === 0) {
                addTestResult('全回答検証', false, '検証する回答がありません');
                return;
            }
            
            let validCount = 0;
            let invalidCount = 0;
            
            testAnswers.forEach((answer, index) => {
                const questions = [...WORLDVIEW_QUESTIONS, ...SCENARIO_QUESTIONS];
                const question = questions.find(q => q.id === answer.questionId);
                
                if (!question) {
                    log(`回答 ${index + 1}: 対応する質問が見つかりません (${answer.questionId})`, 'ERROR');
                    invalidCount++;
                    return;
                }
                
                const isScenario = question.scenario && question.inner_q && question.outer_q;
                let isValid = true;
                
                if (isScenario) {
                    isValid = validateScenarioAnswer(question, answer);
                } else {
                    isValid = answer.selectedValue && answer.selectedValue.length > 0;
                }
                
                if (isValid) {
                    validCount++;
                    log(`回答 ${index + 1}: 有効 (${answer.questionId})`, 'SUCCESS');
                } else {
                    invalidCount++;
                    log(`回答 ${index + 1}: 無効 (${answer.questionId})`, 'ERROR');
                }
            });
            
            addTestResult('全回答検証', invalidCount === 0, 
                `有効: ${validCount}, 無効: ${invalidCount}`,
                `合計 ${testAnswers.length} 回答を検証`);
        }

        function simulateAnalysis() {
            log('分析処理シミュレーション開始');
            
            if (testAnswers.length === 0) {
                addTestResult('分析処理', false, '分析する回答データがありません');
                return;
            }
            
            try {
                // 回答データの形式をチェック
                log(`分析対象回答数: ${testAnswers.length}`);
                
                testAnswers.forEach((answer, index) => {
                    log(`回答 ${index + 1}: ${JSON.stringify(answer, null, 2)}`);
                });
                
                // 分析プロセスで期待される形式かチェック
                const hasValidStructure = testAnswers.every(answer => {
                    return answer.questionId && 
                           (answer.selectedValue || (answer.innerChoice && answer.outerChoice));
                });
                
                addTestResult('分析データ形式', hasValidStructure, 
                    hasValidStructure ? '分析に適した形式' : '分析に不適切な形式');
                
            } catch (error) {
                addTestResult('分析処理', false, `エラー: ${error.message}`);
                log(`分析エラー: ${error.stack}`, 'ERROR');
            }
        }

        // ページ読み込み時に初期化
        window.addEventListener('load', () => {
            log('ページ読み込み完了');
            initializeTest();
        });
    </script>
</body>
</html>