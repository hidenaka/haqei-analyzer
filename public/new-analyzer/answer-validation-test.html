<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›ç­”ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-panel {
            border: 1px solid #ccc;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            background: #f9f9f9;
        }
        .error { background-color: #ffe6e6; border-color: #ff9999; }
        .success { background-color: #e6ffe6; border-color: #99ff99; }
        .warning { background-color: #fff3e0; border-color: #ffcc99; }
        .btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 3px;
            cursor: pointer;
        }
        .scenario-test {
            border: 2px solid #333;
            padding: 20px;
            margin: 15px 0;
            border-radius: 5px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å›ç­”ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="debug-panel">
        <h3>ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h3>
        <button class="btn" onclick="initializeTest()">ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–</button>
        <button class="btn" onclick="testScenarioAnswers()">ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="validateAllAnswers()">å…¨å›ç­”æ¤œè¨¼</button>
        <button class="btn" onclick="simulateAnalysis()">åˆ†æå‡¦ç†ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn" onclick="clearLog()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
    </div>

    <div class="debug-panel">
        <h3>ãƒ†ã‚¹ãƒˆçµæœ</h3>
        <div id="testResults">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰</div>
    </div>

    <div class="scenario-test">
        <h3>ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ†ã‚¹ãƒˆ</h3>
        <div id="scenarioTest">
            <p>ã‚·ãƒŠãƒªã‚ªè³ªå•ã®å›ç­”å‡¦ç†ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™</p>
            <div id="scenarioQuestionDisplay"></div>
        </div>
    </div>

    <div class="debug-panel">
        <h3>è©³ç´°ãƒ­ã‚°</h3>
        <pre id="debugLog">ãƒ­ã‚°å‡ºåŠ›ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</pre>
    </div>

    <!-- Scripts -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
        let testResults = [];
        let debugLog = document.getElementById('debugLog');
        let testAnswers = [];
        
        function log(message, type = 'INFO') {
            const time = new Date().toLocaleTimeString();
            const logMessage = `[${time}] ${type}: ${message}`;
            debugLog.textContent += logMessage + '\n';
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(logMessage);
        }

        function clearLog() {
            debugLog.textContent = '';
            testResults = [];
            updateResults();
        }

        function updateResults() {
            const resultsDiv = document.getElementById('testResults');
            if (testResults.length === 0) {
                resultsDiv.innerHTML = 'ãƒ†ã‚¹ãƒˆçµæœãªã—';
                return;
            }

            const html = testResults.map(result => `
                <div class="debug-panel ${result.success ? 'success' : 'error'}">
                    <strong>${result.success ? 'âœ…' : 'âŒ'} ${result.name}</strong><br>
                    ${result.message}<br>
                    ${result.details ? `<small>${result.details}</small>` : ''}
                </div>
            `).join('');
            
            resultsDiv.innerHTML = html;
        }

        function addTestResult(name, success, message, details = null) {
            testResults.push({ name, success, message, details });
            updateResults();
            log(`${name}: ${success ? 'SUCCESS' : 'FAIL'} - ${message}`, success ? 'SUCCESS' : 'ERROR');
        }

        function initializeTest() {
            log('ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–é–‹å§‹');
            testAnswers = [];
            
            // è³ªå•ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
            if (typeof WORLDVIEW_QUESTIONS === 'undefined') {
                addTestResult('è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿', false, 'WORLDVIEW_QUESTIONSãŒæœªå®šç¾©');
                return;
            }
            
            if (typeof SCENARIO_QUESTIONS === 'undefined') {
                addTestResult('è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿', false, 'SCENARIO_QUESTIONSãŒæœªå®šç¾©');
                return;
            }
            
            const totalQuestions = WORLDVIEW_QUESTIONS.length + SCENARIO_QUESTIONS.length;
            addTestResult('è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿', true, `${totalQuestions}å•ã®è³ªå•ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿`);
            
            log('ãƒ†ã‚¹ãƒˆåˆæœŸåŒ–å®Œäº†');
        }

        function testScenarioAnswers() {
            log('ã‚·ãƒŠãƒªã‚ªè³ªå•ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            // ã‚·ãƒŠãƒªã‚ªè³ªå•ã‚’æ¢ã™
            const scenarioQuestions = [...WORLDVIEW_QUESTIONS, ...SCENARIO_QUESTIONS]
                .filter(q => q.scenario && q.inner_q && q.outer_q);
            
            if (scenarioQuestions.length === 0) {
                addTestResult('ã‚·ãƒŠãƒªã‚ªè³ªå•æ¤œç´¢', false, 'ã‚·ãƒŠãƒªã‚ªè³ªå•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                return;
            }
            
            log(`${scenarioQuestions.length}å€‹ã®ã‚·ãƒŠãƒªã‚ªè³ªå•ã‚’ç™ºè¦‹`);
            
            // æœ€åˆã®ã‚·ãƒŠãƒªã‚ªè³ªå•ã‚’ãƒ†ã‚¹ãƒˆ
            const testQuestion = scenarioQuestions[0];
            log(`ãƒ†ã‚¹ãƒˆå¯¾è±¡: ${testQuestion.id}`);
            
            // ã‚·ãƒŠãƒªã‚ªè³ªå•ã‚’è¡¨ç¤º
            displayScenarioQuestion(testQuestion);
            
            // æ¨¡æ“¬å›ç­”ã‚’ä½œæˆ
            const mockAnswer = {
                questionId: testQuestion.id,
                timestamp: new Date().toISOString()
            };
            
            // Inner choice ã‚’è¿½åŠ 
            if (testQuestion.options.inner && testQuestion.options.inner.length > 0) {
                mockAnswer.innerChoice = {
                    value: testQuestion.options.inner[0].value,
                    scoring_tags: testQuestion.options.inner[0].scoring_tags
                };
                log(`Inner choice è¨­å®š: ${mockAnswer.innerChoice.value}`);
            }
            
            // Outer choice ã‚’è¿½åŠ 
            if (testQuestion.options.outer && testQuestion.options.outer.length > 0) {
                mockAnswer.outerChoice = {
                    value: testQuestion.options.outer[0].value,
                    scoring_tags: testQuestion.options.outer[0].scoring_tags
                };
                log(`Outer choice è¨­å®š: ${mockAnswer.outerChoice.value}`);
            }
            
            // å›ç­”ã‚’æ¤œè¨¼
            const isValid = validateScenarioAnswer(testQuestion, mockAnswer);
            addTestResult('ã‚·ãƒŠãƒªã‚ªå›ç­”æ¤œè¨¼', isValid, 
                isValid ? 'æ¨¡æ“¬ã‚·ãƒŠãƒªã‚ªå›ç­”ãŒæœ‰åŠ¹' : 'æ¨¡æ“¬ã‚·ãƒŠãƒªã‚ªå›ç­”ãŒç„¡åŠ¹',
                JSON.stringify(mockAnswer, null, 2));
            
            testAnswers.push(mockAnswer);
        }

        function displayScenarioQuestion(question) {
            const display = document.getElementById('scenarioQuestionDisplay');
            display.innerHTML = `
                <div style="border: 1px solid #ddd; padding: 15px; border-radius: 5px;">
                    <h4>${question.id}</h4>
                    <p><strong>çŠ¶æ³:</strong> ${question.scenario}</p>
                    <p><strong>å†…é¢è³ªå•:</strong> ${question.inner_q}</p>
                    <p><strong>å¤–é¢è³ªå•:</strong> ${question.outer_q}</p>
                    <p><strong>å†…é¢é¸æŠè‚¢æ•°:</strong> ${question.options.inner ? question.options.inner.length : 0}</p>
                    <p><strong>å¤–é¢é¸æŠè‚¢æ•°:</strong> ${question.options.outer ? question.options.outer.length : 0}</p>
                </div>
            `;
        }

        function validateScenarioAnswer(question, answer) {
            // QuestionFlowã®æ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†ç¾
            if (!answer.questionId) {
                log('æ¤œè¨¼å¤±æ•—: questionId ãªã—', 'ERROR');
                return false;
            }
            
            const isScenario = question.scenario && question.inner_q && question.outer_q;
            if (!isScenario) {
                log('æ¤œè¨¼å¤±æ•—: ã‚·ãƒŠãƒªã‚ªè³ªå•ã§ã¯ãªã„', 'ERROR');
                return false;
            }
            
            if (!answer.innerChoice || !answer.outerChoice) {
                log('æ¤œè¨¼å¤±æ•—: inner/outer choice ãŒä¸è¶³', 'ERROR');
                return false;
            }
            
            if (!answer.innerChoice.value || !answer.outerChoice.value) {
                log('æ¤œè¨¼å¤±æ•—: inner/outer choice ã®å€¤ãŒç©º', 'ERROR');
                return false;
            }
            
            log('ã‚·ãƒŠãƒªã‚ªå›ç­”æ¤œè¨¼æˆåŠŸ', 'SUCCESS');
            return true;
        }

        function validateAllAnswers() {
            log('å…¨å›ç­”æ¤œè¨¼é–‹å§‹');
            
            if (testAnswers.length === 0) {
                addTestResult('å…¨å›ç­”æ¤œè¨¼', false, 'æ¤œè¨¼ã™ã‚‹å›ç­”ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            let validCount = 0;
            let invalidCount = 0;
            
            testAnswers.forEach((answer, index) => {
                const questions = [...WORLDVIEW_QUESTIONS, ...SCENARIO_QUESTIONS];
                const question = questions.find(q => q.id === answer.questionId);
                
                if (!question) {
                    log(`å›ç­” ${index + 1}: å¯¾å¿œã™ã‚‹è³ªå•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (${answer.questionId})`, 'ERROR');
                    invalidCount++;
                    return;
                }
                
                const isScenario = question.scenario && question.inner_q && question.outer_q;
                let isValid = true;
                
                if (isScenario) {
                    isValid = validateScenarioAnswer(question, answer);
                } else {
                    isValid = answer.selectedValue && answer.selectedValue.length > 0;
                }
                
                if (isValid) {
                    validCount++;
                    log(`å›ç­” ${index + 1}: æœ‰åŠ¹ (${answer.questionId})`, 'SUCCESS');
                } else {
                    invalidCount++;
                    log(`å›ç­” ${index + 1}: ç„¡åŠ¹ (${answer.questionId})`, 'ERROR');
                }
            });
            
            addTestResult('å…¨å›ç­”æ¤œè¨¼', invalidCount === 0, 
                `æœ‰åŠ¹: ${validCount}, ç„¡åŠ¹: ${invalidCount}`,
                `åˆè¨ˆ ${testAnswers.length} å›ç­”ã‚’æ¤œè¨¼`);
        }

        function simulateAnalysis() {
            log('åˆ†æå‡¦ç†ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            
            if (testAnswers.length === 0) {
                addTestResult('åˆ†æå‡¦ç†', false, 'åˆ†æã™ã‚‹å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                return;
            }
            
            try {
                // å›ç­”ãƒ‡ãƒ¼ã‚¿ã®å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
                log(`åˆ†æå¯¾è±¡å›ç­”æ•°: ${testAnswers.length}`);
                
                testAnswers.forEach((answer, index) => {
                    log(`å›ç­” ${index + 1}: ${JSON.stringify(answer, null, 2)}`);
                });
                
                // åˆ†æãƒ—ãƒ­ã‚»ã‚¹ã§æœŸå¾…ã•ã‚Œã‚‹å½¢å¼ã‹ãƒã‚§ãƒƒã‚¯
                const hasValidStructure = testAnswers.every(answer => {
                    return answer.questionId && 
                           (answer.selectedValue || (answer.innerChoice && answer.outerChoice));
                });
                
                addTestResult('åˆ†æãƒ‡ãƒ¼ã‚¿å½¢å¼', hasValidStructure, 
                    hasValidStructure ? 'åˆ†æã«é©ã—ãŸå½¢å¼' : 'åˆ†æã«ä¸é©åˆ‡ãªå½¢å¼');
                
            } catch (error) {
                addTestResult('åˆ†æå‡¦ç†', false, `ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                log(`åˆ†æã‚¨ãƒ©ãƒ¼: ${error.stack}`, 'ERROR');
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', () => {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            initializeTest();
        });
    </script>
</body>
</html>