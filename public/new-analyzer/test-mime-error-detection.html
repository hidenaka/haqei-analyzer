<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MIME Type Error Detection Test</title>
    <style>
      body {
        font-family: "Courier New", monospace;
        margin: 20px;
        background-color: #1e1e1e;
        color: #d4d4d4;
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #444;
        border-radius: 5px;
        background-color: #2d2d30;
      }
      .test-title {
        color: #4ec9b0;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .test-result {
        margin: 10px 0;
        padding: 10px;
        border-radius: 3px;
      }
      .success {
        background-color: #0e5132;
        border-left: 4px solid #00d26a;
      }
      .error {
        background-color: #5a1d1d;
        border-left: 4px solid #f85149;
      }
      .warning {
        background-color: #4d3800;
        border-left: 4px solid #ffab00;
      }
      .info {
        background-color: #1a365d;
        border-left: 4px solid #3182ce;
      }
      button {
        background-color: #0078d4;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 3px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background-color: #106ebe;
      }
      pre {
        background-color: #1e1e1e;
        padding: 10px;
        border-radius: 3px;
        overflow-x: auto;
        font-size: 12px;
      }
      .console-output {
        max-height: 300px;
        overflow-y: auto;
        background-color: #0c0c0c;
        padding: 10px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        font-size: 11px;
        white-space: pre-wrap;
      }
    </style>
  </head>
  <body>
    <h1>🔍 MIME Type Error Detection & Path Validation Test</h1>

    <div class="test-section">
      <div class="test-title">📋 Test Overview</div>
      <p>
        このテストページは、Task 7「MIME
        タイプエラーの解決」の実装を検証します：
      </p>
      <ul>
        <li>✅ ローカル開発環境での MIME タイプ設定ガイドの作成</li>
        <li>✅ スクリプトファイルのパス検証機能の実装</li>
        <li>✅ 404 エラーや MIME タイプエラーの検出と報告機能の追加</li>
      </ul>
    </div>

    <div class="test-section">
      <div class="test-title">🛠️ Test Controls</div>
      <button onclick="testPathValidation()">Path Validation Test</button>
      <button onclick="testErrorDetection()">Error Detection Test</button>
      <button onclick="testMimeTypeCheck()">MIME Type Check Test</button>
      <button onclick="test404Detection()">404 Error Detection Test</button>
      <button onclick="testIntegratedSystem()">Integrated System Test</button>
      <button onclick="clearConsole()">Clear Console</button>
    </div>

    <div class="test-section">
      <div class="test-title">📊 Test Results</div>
      <div id="testResults"></div>
    </div>

    <div class="test-section">
      <div class="test-title">🖥️ Console Output</div>
      <div id="consoleOutput" class="console-output"></div>
    </div>

    <!-- Load the core modules -->
    <script src="js/core/ScriptPathValidator.js"></script>
    <script src="js/core/ErrorDetectionReporter.js"></script>

    <script>
      // Console output capture
      const originalConsole = {
        log: console.log,
        warn: console.warn,
        error: console.error,
        group: console.group,
        groupEnd: console.groupEnd,
      };

      let consoleOutput = "";
      let groupLevel = 0;

      function captureConsole() {
        const outputDiv = document.getElementById("consoleOutput");

        ["log", "warn", "error"].forEach((method) => {
          console[method] = function (...args) {
            const indent = "  ".repeat(groupLevel);
            const timestamp = new Date().toLocaleTimeString();
            const message = args
              .map((arg) =>
                typeof arg === "object"
                  ? JSON.stringify(arg, null, 2)
                  : String(arg)
              )
              .join(" ");

            const color =
              method === "error"
                ? "#f85149"
                : method === "warn"
                ? "#ffab00"
                : "#d4d4d4";

            consoleOutput += `<span style="color: #888">[${timestamp}]</span> <span style="color: ${color}">${indent}${message}</span>\n`;
            outputDiv.innerHTML = consoleOutput;
            outputDiv.scrollTop = outputDiv.scrollHeight;

            originalConsole[method].apply(console, args);
          };
        });

        console.group = function (...args) {
          groupLevel++;
          const indent = "  ".repeat(groupLevel - 1);
          const message = args.join(" ");
          consoleOutput += `<span style="color: #4ec9b0">${indent}▼ ${message}</span>\n`;
          outputDiv.innerHTML = consoleOutput;
          originalConsole.group.apply(console, args);
        };

        console.groupEnd = function () {
          groupLevel = Math.max(0, groupLevel - 1);
          originalConsole.groupEnd.apply(console);
        };
      }

      function clearConsole() {
        consoleOutput = "";
        document.getElementById("consoleOutput").innerHTML = "";
        document.getElementById("testResults").innerHTML = "";
      }

      function addTestResult(title, status, details) {
        const resultsDiv = document.getElementById("testResults");
        const resultDiv = document.createElement("div");
        resultDiv.className = `test-result ${status}`;
        resultDiv.innerHTML = `
                <strong>${title}</strong><br>
                ${details}
            `;
        resultsDiv.appendChild(resultDiv);
      }

      // Test 1: Path Validation
      async function testPathValidation() {
        console.group("🔍 Path Validation Test");

        try {
          if (typeof ScriptPathValidator === "undefined") {
            throw new Error("ScriptPathValidator is not loaded");
          }

          const validator = new ScriptPathValidator({
            baseUrl:
              location.origin + location.pathname.replace(/\/[^\/]*$/, ""),
            timeout: 3000,
            strictMode: false,
          });

          // Test various paths
          const testPaths = [
            "js/core/ScriptPathValidator.js", // Should exist
            "js/core/ErrorDetectionReporter.js", // Should exist
            "js/core/NonExistentFile.js", // Should not exist
            "../js/data/data_box.js", // May or may not exist
            "invalid-path-with-spaces and special chars!.js", // Invalid path
          ];

          console.log("Testing paths:", testPaths);

          const results = await validator.validateMultiplePaths(testPaths);
          const summary = validator.generateValidationSummary(results);

          console.log("Validation Summary:", summary);

          results.forEach((result) => {
            console.log(`📁 ${result.path}:`, {
              valid: result.isValid,
              exists: result.exists,
              errors: result.errors,
              warnings: result.warnings,
            });
          });

          addTestResult(
            "✅ Path Validation Test",
            "success",
            `Validated ${results.length} paths. Found ${summary.invalid} issues.`
          );
        } catch (error) {
          console.error("Path validation test failed:", error);
          addTestResult(
            "❌ Path Validation Test",
            "error",
            `Test failed: ${error.message}`
          );
        }

        console.groupEnd();
      }

      // Test 2: Error Detection
      async function testErrorDetection() {
        console.group("🚨 Error Detection Test");

        try {
          if (typeof ErrorDetectionReporter === "undefined") {
            throw new Error("ErrorDetectionReporter is not loaded");
          }

          const reporter = new ErrorDetectionReporter({
            enableAutoDetection: true,
            enableConsoleReporting: true,
            reportingLevel: "detailed",
          });

          console.log("Error Detection Reporter initialized");

          // Simulate various error scenarios
          console.log("Simulating script load error...");

          // Create a script element that will fail to load
          const badScript = document.createElement("script");
          badScript.src = "non-existent-script.js";
          badScript.onerror = () => {
            console.log("Script error event triggered");
          };
          document.head.appendChild(badScript);

          // Wait a bit for error detection
          setTimeout(() => {
            const stats = reporter.getErrorStats();
            console.log("Error Statistics:", stats);

            addTestResult(
              "✅ Error Detection Test",
              "success",
              `Error detection system is working. Total errors: ${stats.total}`
            );
          }, 1000);
        } catch (error) {
          console.error("Error detection test failed:", error);
          addTestResult(
            "❌ Error Detection Test",
            "error",
            `Test failed: ${error.message}`
          );
        }

        console.groupEnd();
      }

      // Test 3: MIME Type Check
      async function testMimeTypeCheck() {
        console.group("🏷️ MIME Type Check Test");

        try {
          if (typeof ScriptPathValidator === "undefined") {
            throw new Error("ScriptPathValidator is not loaded");
          }

          const validator = new ScriptPathValidator();

          // Test MIME type checking for existing files
          const testFiles = [
            "js/core/ScriptPathValidator.js",
            "js/core/ErrorDetectionReporter.js",
          ];

          for (const file of testFiles) {
            console.log(`Checking MIME type for: ${file}`);
            const result = await validator.validateScriptPath(file);

            console.log(`MIME Type: ${result.mimeType}`);
            console.log(`Valid: ${result.isValid}`);

            if (result.errors.length > 0) {
              console.error("Errors:", result.errors);
            }
            if (result.warnings.length > 0) {
              console.warn("Warnings:", result.warnings);
            }
          }

          addTestResult(
            "✅ MIME Type Check Test",
            "success",
            `MIME type validation completed for ${testFiles.length} files`
          );
        } catch (error) {
          console.error("MIME type check test failed:", error);
          addTestResult(
            "❌ MIME Type Check Test",
            "error",
            `Test failed: ${error.message}`
          );
        }

        console.groupEnd();
      }

      // Test 4: 404 Error Detection
      async function test404Detection() {
        console.group("🔍 404 Error Detection Test");

        try {
          if (typeof ErrorDetectionReporter === "undefined") {
            throw new Error("ErrorDetectionReporter is not loaded");
          }

          const reporter = new ErrorDetectionReporter();

          // Test 404 detection
          const nonExistentUrl = "definitely-does-not-exist.js";
          console.log(`Testing 404 detection for: ${nonExistentUrl}`);

          await reporter.performDetailedErrorAnalysis(nonExistentUrl);

          const recentErrors = reporter.getRecentErrors(5);
          console.log("Recent errors:", recentErrors);

          addTestResult(
            "✅ 404 Error Detection Test",
            "success",
            `404 error detection completed. Check console for detailed analysis.`
          );
        } catch (error) {
          console.error("404 detection test failed:", error);
          addTestResult(
            "❌ 404 Error Detection Test",
            "error",
            `Test failed: ${error.message}`
          );
        }

        console.groupEnd();
      }

      // Test 5: Integrated System Test
      async function testIntegratedSystem() {
        console.group("🔧 Integrated System Test");

        try {
          console.log(
            "Testing integrated error detection and path validation system..."
          );

          // Check if both systems are available
          const pathValidatorAvailable =
            typeof ScriptPathValidator !== "undefined";
          const errorReporterAvailable =
            typeof ErrorDetectionReporter !== "undefined";

          console.log("ScriptPathValidator available:", pathValidatorAvailable);
          console.log(
            "ErrorDetectionReporter available:",
            errorReporterAvailable
          );

          if (pathValidatorAvailable && errorReporterAvailable) {
            // Test integration
            const validator = new ScriptPathValidator();
            const reporter = new ErrorDetectionReporter();

            // Test a mix of valid and invalid paths
            const mixedPaths = [
              "js/core/ScriptPathValidator.js", // Should be valid
              "missing-file.js", // Should trigger 404
              "js/core/ErrorDetectionReporter.js", // Should be valid
            ];

            const results = await validator.validateMultiplePaths(mixedPaths);

            console.log("Integrated test results:");
            results.forEach((result) => {
              console.log(`${result.path}: ${result.isValid ? "✅" : "❌"}`);
              if (result.errors.length > 0) {
                console.error("  Errors:", result.errors);
              }
            });

            addTestResult(
              "✅ Integrated System Test",
              "success",
              `Both systems are working together. Tested ${mixedPaths.length} paths.`
            );
          } else {
            throw new Error("One or both systems are not available");
          }
        } catch (error) {
          console.error("Integrated system test failed:", error);
          addTestResult(
            "❌ Integrated System Test",
            "error",
            `Test failed: ${error.message}`
          );
        }

        console.groupEnd();
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", function () {
        captureConsole();

        console.log("🔍 MIME Type Error Detection Test Page Loaded");
        console.log("Available classes:");
        console.log(
          "- ScriptPathValidator:",
          typeof ScriptPathValidator !== "undefined"
        );
        console.log(
          "- ErrorDetectionReporter:",
          typeof ErrorDetectionReporter !== "undefined"
        );

        addTestResult(
          "📋 System Status",
          "info",
          `ScriptPathValidator: ${
            typeof ScriptPathValidator !== "undefined"
              ? "✅ Available"
              : "❌ Not Available"
          }<br>
                 ErrorDetectionReporter: ${
                   typeof ErrorDetectionReporter !== "undefined"
                     ? "✅ Available"
                     : "❌ Not Available"
                 }`
        );

        // Auto-run a basic test
        setTimeout(() => {
          console.log("Running automatic integration check...");
          if (
            typeof ScriptPathValidator !== "undefined" &&
            typeof ErrorDetectionReporter !== "undefined"
          ) {
            addTestResult(
              "🎉 Auto-Check",
              "success",
              "All required modules are loaded and ready for testing!"
            );
          } else {
            addTestResult(
              "⚠️ Auto-Check",
              "warning",
              "Some modules may not be loaded. Check the console for details."
            );
          }
        }, 500);
      });
    </script>
  </body>
</html>
