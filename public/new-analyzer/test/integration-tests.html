<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TripleOS Results Enhancement - çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-pass {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .test-fail {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .test-warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        .test-summary {
            background: #e9ecef;
            padding: 15px;
            border-radius: 6px;
            margin-top: 20px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
        }
        button:hover {
            background: #0056b3;
        }
        .test-details {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <h1>ğŸ”— TripleOS Results Enhancement - çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-container">
        <h2>ğŸ“‹ çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«</h2>
        <button id="run-all-integration-tests">ã™ã¹ã¦ã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ</button>
        <button id="run-data-integrity-tests">ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ</button>
        <button id="run-end-to-end-tests">ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ</button>
        <button id="run-performance-tests">ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
        <button id="run-compatibility-integration-tests">ç›¸æ€§åˆ†æçµ±åˆãƒ†ã‚¹ãƒˆ</button>
        
        <div class="progress-bar" style="display: none;" id="progress-container">
            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
        </div>
    </div>

    <div id="test-results"></div>
    
    <div id="test-summary" class="test-summary" style="display: none;">
        <h3>ğŸ“Š çµ±åˆãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h3>
        <div id="summary-content"></div>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <script src="../js/core/BaseComponent.js"></script>
    <script src="../js/core/DataManager.js"></script>
    <script src="../js/core/Calculator.js"></script>
    <script src="../js/core/Engine.js"></script>
    <script src="../js/core/TripleOSEngine.js"></script>
    <script src="../js/core/EightDimensionAnalysisEngine.js"></script>
    <script src="../js/core/OSDetailEngine.js"></script>
    <script src="../js/core/InternalCompatibilityEngine.js"></script>
    <script src="../js/core/ErrorHandler.js"></script>
    <script src="../js/core/IntegrationAdviceEngine.js"></script>
    <script src="../js/core/StorageManager.js"></script>
    <script src="../js/core/CompatibilityDataLoader.js"></script>
    <script src="../js/components/TripleOSResultsView.js"></script>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« -->
    <script src="../js/data/data_box.js"></script>
    <script src="../js/data/questions.js"></script>
    <script src="../js/data/vectors.js"></script>
    <script src="../js/data/hexagrams.js"></script>
    <script src="../js/data/hexagram_details.js"></script>
    <script src="../js/data/compatibility_definition.js"></script>

    <script>
        class IntegrationTestRunner {
            constructor() {
                this.testResults = [];
                this.currentTestIndex = 0;
                this.totalTests = 0;
                this.setupTestEnvironment();
                this.bindEvents();
            }

            setupTestEnvironment() {
                console.log('ğŸ”§ çµ±åˆãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’åˆæœŸåŒ–ä¸­...');
                this.resultsContainer = document.getElementById('test-results');
                this.summaryContainer = document.getElementById('test-summary');
                this.summaryContent = document.getElementById('summary-content');
                this.progressContainer = document.getElementById('progress-container');
                this.progressFill = document.getElementById('progress-fill');
            }

            bindEvents() {
                document.getElementById('run-all-integration-tests').addEventListener('click', () => {
                    this.runAllIntegrationTests();
                });
                
                document.getElementById('run-data-integrity-tests').addEventListener('click', () => {
                    this.runDataIntegrityTests();
                });
                
                document.getElementById('run-end-to-end-tests').addEventListener('click', () => {
                    this.runEndToEndTests();
                });
                
                document.getElementById('run-performance-tests').addEventListener('click', () => {
                    this.runPerformanceTests();
                });
                
                document.getElementById('run-compatibility-integration-tests').addEventListener('click', () => {
                    this.runCompatibilityIntegrationTests();
                });
            }

            async runAllIntegrationTests() {
                this.clearResults();
                this.showProgress();
                this.addTestSection('ğŸ”— å…¨çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œé–‹å§‹');
                
                await this.runDataIntegrityTests();
                await this.runCompatibilityIntegrationTests();
                await this.runEndToEndTests();
                await this.runPerformanceTests();
                
                this.hideProgress();
                this.showSummary();
            }

            async runDataIntegrityTests() {
                this.addTestSection('ğŸ—‚ï¸ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ');
                
                // ãƒ†ã‚¹ãƒˆ1: 64å¦ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯
                await this.runAsyncTest('64å¦ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯', async () => {
                    const dataManager = new DataManager();
                    const missing = [];
                    
                    for (let i = 1; i <= 64; i++) {
                        try {
                            const hexagram = dataManager.getHexagramData(i);
                            if (!hexagram || !hexagram.name) {
                                missing.push(i);
                            }
                        } catch (error) {
                            missing.push(i);
                        }
                    }
                    
                    if (missing.length > 0) {
                        throw new Error(`æ¬ æã—ã¦ã„ã‚‹64å¦: ${missing.join(', ')}`);
                    }
                    
                    return '64å¦ãƒ‡ãƒ¼ã‚¿ãŒå®Œå…¨ã«æƒã£ã¦ã„ã¾ã™';
                });

                // ãƒ†ã‚¹ãƒˆ2: ç›¸æ€§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯
                await this.runAsyncTest('ç›¸æ€§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«å®Œå…¨æ€§ãƒã‚§ãƒƒã‚¯', async () => {
                    const loader = new CompatibilityDataLoader();
                    const missingFiles = [];
                    
                    // Engine-Interface ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
                    const testIds = [1, 2, 32, 64];
                    for (const id of testIds) {
                        try {
                            await loader.loadEngineInterfaceFile(id);
                        } catch (error) {
                            missingFiles.push(`engine-interface/hexagram_${String(id).padStart(2, '0')}.json`);
                        }
                    }
                    
                    // Engine-SafeMode ãƒ•ã‚¡ã‚¤ãƒ«ãƒã‚§ãƒƒã‚¯ï¼ˆã‚µãƒ³ãƒ—ãƒ«ï¼‰
                    for (const id of testIds) {
                        try {
                            await loader.loadEngineSafeModeFile(id);
                        } catch (error) {
                            missingFiles.push(`engine-safemode/hexagram_${String(id).padStart(2, '0')}.json`);
                        }
                    }
                    
                    if (missingFiles.length > 0) {
                        throw new Error(`æ¬ æãƒ•ã‚¡ã‚¤ãƒ«: ${missingFiles.join(', ')}`);
                    }
                    
                    return `ç›¸æ€§ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã‚ã¾ã—ãŸï¼ˆ${testIds.length * 2}ãƒ•ã‚¡ã‚¤ãƒ«ç¢ºèªæ¸ˆã¿ï¼‰`;
                });

                // ãƒ†ã‚¹ãƒˆ3: 3ã¤ã®OSé–“ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('3ã¤ã®OSé–“ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ', async () => {
                    const engine = new TripleOSEngine();
                    const testData = {
                        answers: new Array(30).fill(0).map(() => Math.floor(Math.random() * 5) + 1)
                    };
                    
                    const result = engine.analyze(testData);
                    
                    // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
                    const requiredFields = ['engineOS', 'interfaceOS', 'safeModeOS', 'eighthDimension'];
                    for (const field of requiredFields) {
                        if (!result[field]) {
                            throw new Error(`å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ ${field} ãŒä¸è¶³ã—ã¦ã„ã¾ã™`);
                        }
                    }
                    
                    // å„OSã®hexagramIdãŒ1-64ã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
                    const osFields = ['engineOS', 'interfaceOS', 'safeModeOS'];
                    for (const field of osFields) {
                        const hexagramId = result[field].hexagramId;
                        if (hexagramId < 1 || hexagramId > 64) {
                            throw new Error(`${field}ã®hexagramIdãŒç¯„å›²å¤–ã§ã™: ${hexagramId}`);
                        }
                    }
                    
                    return '3ã¤ã®OSé–“ã®ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãŒç¢ºèªã•ã‚Œã¾ã—ãŸ';
                });

                // ãƒ†ã‚¹ãƒˆ4: 8æ¬¡å…ƒåˆ†æãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('8æ¬¡å…ƒåˆ†æãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒ†ã‚¹ãƒˆ', async () => {
                    const analysisEngine = new EightDimensionAnalysisEngine();
                    const testVectors = [
                        [0.5, 0.7, 0.3, 0.8, 0.4, 0.6, 0.9, 0.2],
                        [0.1, 0.9, 0.5, 0.5, 0.7, 0.3, 0.8, 0.6],
                        [0.8, 0.2, 0.7, 0.3, 0.9, 0.1, 0.5, 0.4]
                    ];
                    
                    for (let i = 0; i < testVectors.length; i++) {
                        const analysis = analysisEngine.analyze(testVectors[i]);
                        
                        if (!analysis || !analysis.dimensions || analysis.dimensions.length !== 8) {
                            throw new Error(`8æ¬¡å…ƒåˆ†æçµæœãŒä¸æ­£ã§ã™ï¼ˆãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹${i + 1}ï¼‰`);
                        }
                        
                        // å„æ¬¡å…ƒã®ã‚¹ã‚³ã‚¢ãŒ0-1ã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
                        for (let j = 0; j < analysis.dimensions.length; j++) {
                            const score = analysis.dimensions[j].score;
                            if (score < 0 || score > 1) {
                                throw new Error(`æ¬¡å…ƒ${j + 1}ã®ã‚¹ã‚³ã‚¢ãŒç¯„å›²å¤–: ${score}`);
                            }
                        }
                    }
                    
                    return `8æ¬¡å…ƒåˆ†æãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãŒç¢ºèªã•ã‚Œã¾ã—ãŸï¼ˆ${testVectors.length}ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆæ¸ˆã¿ï¼‰`;
                });
            }

            async runCompatibilityIntegrationTests() {
                this.addTestSection('ğŸ¯ ç›¸æ€§åˆ†æçµ±åˆãƒ†ã‚¹ãƒˆ');
                
                // ãƒ†ã‚¹ãƒˆ1: Engine-Interfaceç›¸æ€§ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('Engine-Interfaceç›¸æ€§ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ†ã‚¹ãƒˆ', async () => {
                    const loader = new CompatibilityDataLoader();
                    const testPairs = [[1, 2], [1, 32], [32, 64], [64, 1]];
                    const results = [];
                    
                    for (const [engineId, interfaceId] of testPairs) {
                        const compatibility = await loader.getEngineInterfaceCompatibility(engineId, interfaceId);
                        
                        if (!compatibility || !compatibility.type || typeof compatibility.overallScore !== 'number') {
                            throw new Error(`Engine ${engineId} - Interface ${interfaceId} ã®ç›¸æ€§ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™`);
                        }
                        
                        results.push(compatibility);
                    }
                    
                    return `Engine-Interfaceç›¸æ€§ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ${results.length}ãƒšã‚¢ç¢ºèªæ¸ˆã¿ï¼‰`;
                });

                // ãƒ†ã‚¹ãƒˆ2: Engine-SafeModeç›¸æ€§ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('Engine-SafeModeç›¸æ€§ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ†ã‚¹ãƒˆ', async () => {
                    const loader = new CompatibilityDataLoader();
                    const testPairs = [[1, 3], [2, 4], [32, 33], [63, 64]];
                    const results = [];
                    
                    for (const [engineId, safeModeId] of testPairs) {
                        const compatibility = await loader.getEngineSafeModeCompatibility(engineId, safeModeId);
                        
                        if (!compatibility || !compatibility.type || typeof compatibility.overallScore !== 'number') {
                            throw new Error(`Engine ${engineId} - SafeMode ${safeModeId} ã®ç›¸æ€§ãƒ‡ãƒ¼ã‚¿ãŒä¸æ­£ã§ã™`);
                        }
                        
                        results.push(compatibility);
                    }
                    
                    return `Engine-SafeModeç›¸æ€§ãƒ‡ãƒ¼ã‚¿çµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ${results.length}ãƒšã‚¢ç¢ºèªæ¸ˆã¿ï¼‰`;
                });

                // ãƒ†ã‚¹ãƒˆ3: Triple OSç›¸æ€§çµ±åˆåˆ†æãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('Triple OSç›¸æ€§çµ±åˆåˆ†æãƒ†ã‚¹ãƒˆ', async () => {
                    const loader = new CompatibilityDataLoader();
                    const testTriples = [[1, 2, 3], [32, 33, 34], [62, 63, 64]];
                    const results = [];
                    
                    for (const [engineId, interfaceId, safeModeId] of testTriples) {
                        const tripleCompatibility = await loader.getTripleOSCompatibility(engineId, interfaceId, safeModeId);
                        
                        if (!tripleCompatibility || !tripleCompatibility.integration) {
                            throw new Error(`Triple OS ${engineId}-${interfaceId}-${safeModeId} ã®çµ±åˆåˆ†æãŒä¸æ­£ã§ã™`);
                        }
                        
                        const integration = tripleCompatibility.integration;
                        const requiredProps = ['overallScore', 'stability', 'balance'];
                        for (const prop of requiredProps) {
                            if (typeof integration[prop] !== 'number') {
                                throw new Error(`çµ±åˆåˆ†æã®${prop}ãŒæ•°å€¤ã§ã¯ã‚ã‚Šã¾ã›ã‚“`);
                            }
                        }
                        
                        results.push(tripleCompatibility);
                    }
                    
                    return `Triple OSç›¸æ€§çµ±åˆåˆ†æãƒ†ã‚¹ãƒˆæˆåŠŸï¼ˆ${results.length}çµ„ã¿åˆã‚ã›ç¢ºèªæ¸ˆã¿ï¼‰`;
                });

                // ãƒ†ã‚¹ãƒˆ4: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½çµ±åˆãƒ†ã‚¹ãƒˆ', async () => {
                    const loader = new CompatibilityDataLoader();
                    
                    // æœ€åˆã®èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
                    const start1 = performance.now();
                    const compatibility1 = await loader.getEngineInterfaceCompatibility(1, 2);
                    const time1 = performance.now() - start1;
                    
                    // 2å›ç›®ã®èª­ã¿è¾¼ã¿ï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Šï¼‰
                    const start2 = performance.now();
                    const compatibility2 = await loader.getEngineInterfaceCompatibility(1, 2);
                    const time2 = performance.now() - start2;
                    
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒåŠ¹ã„ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ2å›ç›®ãŒååˆ†é«˜é€Ÿï¼‰
                    if (time2 > time1 * 0.1) {
                        console.warn(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹æœãŒä½ã„å¯èƒ½æ€§: 1å›ç›®${time1.toFixed(2)}ms, 2å›ç›®${time2.toFixed(2)}ms`);
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã®ä¸€è‡´ç¢ºèª
                    if (JSON.stringify(compatibility1) !== JSON.stringify(compatibility2)) {
                        throw new Error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒå…ƒãƒ‡ãƒ¼ã‚¿ã¨ä¸€è‡´ã—ã¾ã›ã‚“');
                    }
                    
                    return `ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½æ­£å¸¸ï¼ˆ1å›ç›®:${time1.toFixed(2)}ms, 2å›ç›®:${time2.toFixed(2)}msï¼‰`;
                });
            }

            async runEndToEndTests() {
                this.addTestSection('ğŸ”„ ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆ');
                
                // ãƒ†ã‚¹ãƒˆ1: å®Œå…¨ãªãƒ•ãƒ­ãƒ¼ï¼ˆè¨ºæ–­â†’ç›¸æ€§åˆ†æâ†’è¡¨ç¤ºï¼‰ãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('å®Œå…¨ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆ', async () => {
                    // 1. è¨ºæ–­å®Ÿè¡Œ
                    const tripleOSEngine = new TripleOSEngine();
                    const testAnswers = new Array(30).fill(0).map(() => Math.floor(Math.random() * 5) + 1);
                    const analysisResult = tripleOSEngine.analyze({ answers: testAnswers });
                    
                    // 2. ç›¸æ€§åˆ†æå®Ÿè¡Œ
                    const compatibilityLoader = new CompatibilityDataLoader();
                    const tripleCompatibility = await compatibilityLoader.getTripleOSCompatibility(
                        analysisResult.engineOS.hexagramId,
                        analysisResult.interfaceOS.hexagramId,
                        analysisResult.safeModeOS.hexagramId
                    );
                    
                    // 3. çµ±åˆã‚¢ãƒ‰ãƒã‚¤ã‚¹ç”Ÿæˆ
                    const adviceEngine = new IntegrationAdviceEngine();
                    const advice = adviceEngine.generateIntegrationAdvice(analysisResult);
                    
                    // 4. çµæœç¢ºèª
                    if (!tripleCompatibility || !advice) {
                        throw new Error('å®Œå…¨ãƒ•ãƒ­ãƒ¼ã®å®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    return 'å®Œå…¨ãƒ•ãƒ­ãƒ¼çµ±åˆãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ';
                });

                // ãƒ†ã‚¹ãƒˆ2: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±åˆãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±åˆãƒ†ã‚¹ãƒˆ', async () => {
                    const errorHandler = new ErrorHandler();
                    const loader = new CompatibilityDataLoader();
                    
                    // å­˜åœ¨ã—ãªã„IDã§ãƒ†ã‚¹ãƒˆ
                    try {
                        await loader.getEngineInterfaceCompatibility(999, 999);
                        throw new Error('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã™ã‚‹ã¹ãã§ã—ãŸ');
                    } catch (error) {
                        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ã§å‡¦ç†
                        const handled = errorHandler.handleError(error, 'compatibility-loading');
                        
                        if (!handled || !handled.userMessage) {
                            throw new Error('ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã›ã‚“ã§ã—ãŸ');
                        }
                    }
                    
                    return 'ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°çµ±åˆãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ';
                });

                // ãƒ†ã‚¹ãƒˆ3: ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“é€£æºãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“é€£æºãƒ†ã‚¹ãƒˆ', async () => {
                    // OSDetailEngine ã¨CompatibilityDataLoader ã®é€£æº
                    const dataManager = new DataManager();
                    const osDetailEngine = new OSDetailEngine(dataManager);
                    const compatibilityLoader = new CompatibilityDataLoader();
                    
                    // 64å¦è©³ç´°ã¨ãã®ç›¸æ€§åˆ†æã‚’çµ„ã¿åˆã‚ã›ã¦å–å¾—
                    const hexagramDetails = osDetailEngine.getHexagramDetails(1);
                    const compatibility = await compatibilityLoader.getEngineInterfaceCompatibility(1, 2);
                    
                    if (!hexagramDetails || !compatibility) {
                        throw new Error('ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“ã®é€£æºã«å¤±æ•—ã—ã¾ã—ãŸ');
                    }
                    
                    // ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ç¢ºèª
                    if (hexagramDetails.name !== compatibility.engineName) {
                        console.warn('åå‰ã®ä¸ä¸€è‡´ãŒç™ºç”Ÿï¼ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®å½±éŸ¿ã®å¯èƒ½æ€§ï¼‰');
                    }
                    
                    return 'ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆé–“é€£æºãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸ';
                });
            }

            async runPerformanceTests() {
                this.addTestSection('âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ');
                
                // ãƒ†ã‚¹ãƒˆ1: å¤§é‡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ€§èƒ½ãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('å¤§é‡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æ€§èƒ½ãƒ†ã‚¹ãƒˆ', async () => {
                    const loader = new CompatibilityDataLoader();
                    const startTime = performance.now();
                    
                    // 10å€‹ã®ç›¸æ€§ãƒ‡ãƒ¼ã‚¿ã‚’ä¸¦è¡Œèª­ã¿è¾¼ã¿
                    const promises = [];
                    for (let i = 1; i <= 10; i++) {
                        promises.push(loader.getEngineInterfaceCompatibility(i, (i % 64) + 1));
                    }
                    
                    const results = await Promise.all(promises);
                    const endTime = performance.now();
                    const totalTime = endTime - startTime;
                    
                    if (totalTime > 5000) { // 5ç§’ä»¥ä¸Š
                        throw new Error(`èª­ã¿è¾¼ã¿æ™‚é–“ãŒé•·ã™ãã¾ã™: ${totalTime.toFixed(2)}ms`);
                    }
                    
                    return `å¤§é‡ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†: ${totalTime.toFixed(2)}msï¼ˆ${results.length}ä»¶ï¼‰`;
                });

                // ãƒ†ã‚¹ãƒˆ2: ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆ', async () => {
                    const loader = new CompatibilityDataLoader();
                    
                    // å¤§é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
                    for (let i = 1; i <= 20; i++) {
                        await loader.getEngineInterfaceCompatibility(i, (i * 2) % 64 + 1);
                    }
                    
                    const stats = loader.getStats();
                    
                    if (stats.cacheSize > 100) {
                        console.warn(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºãŒå¤§ãã„: ${stats.cacheSize}`);
                    }
                    
                    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢
                    loader.clearCache();
                    const clearedStats = loader.getStats();
                    
                    if (clearedStats.cacheSize !== 0) {
                        throw new Error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¯ãƒªã‚¢ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã›ã‚“ã§ã—ãŸ');
                    }
                    
                    return `ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆæœ€å¤§ã‚­ãƒ£ãƒƒã‚·ãƒ¥: ${stats.cacheSize}ä»¶ï¼‰`;
                });

                // ãƒ†ã‚¹ãƒˆ3: åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹æ€§èƒ½ãƒ†ã‚¹ãƒˆ
                await this.runAsyncTest('åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹æ€§èƒ½ãƒ†ã‚¹ãƒˆ', async () => {
                    const loader = new CompatibilityDataLoader();
                    const startTime = performance.now();
                    
                    // åŒã˜ãƒ‡ãƒ¼ã‚¿ã«åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ï¼ˆé‡è¤‡ãƒªã‚¯ã‚¨ã‚¹ãƒˆé˜²æ­¢ã®ãƒ†ã‚¹ãƒˆï¼‰
                    const promises = [];
                    for (let i = 0; i < 5; i++) {
                        promises.push(loader.getEngineInterfaceCompatibility(1, 2));
                    }
                    
                    const results = await Promise.all(promises);
                    const endTime = performance.now();
                    const totalTime = endTime - startTime;
                    
                    // ã™ã¹ã¦åŒã˜çµæœã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
                    const firstResult = JSON.stringify(results[0]);
                    for (let i = 1; i < results.length; i++) {
                        if (JSON.stringify(results[i]) !== firstResult) {
                            throw new Error('åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ã§ç•°ãªã‚‹çµæœãŒè¿”ã•ã‚Œã¾ã—ãŸ');
                        }
                    }
                    
                    return `åŒæ™‚ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†: ${totalTime.toFixed(2)}msï¼ˆ${results.length}ä¸¦è¡Œãƒªã‚¯ã‚¨ã‚¹ãƒˆï¼‰`;
                });
            }

            // ãƒ˜ãƒ«ãƒ‘ãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰
            async runAsyncTest(testName, testFunction) {
                try {
                    const result = await testFunction();
                    this.addTestResult(testName, true, result);
                    this.testResults.push({ name: testName, passed: true, message: result });
                } catch (error) {
                    this.addTestResult(testName, false, error.message);
                    this.testResults.push({ name: testName, passed: false, message: error.message });
                }
                this.updateProgress();
            }

            runTest(testName, testFunction) {
                try {
                    const result = testFunction();
                    this.addTestResult(testName, true, result);
                    this.testResults.push({ name: testName, passed: true, message: result });
                } catch (error) {
                    this.addTestResult(testName, false, error.message);
                    this.testResults.push({ name: testName, passed: false, message: error.message });
                }
                this.updateProgress();
            }

            addTestSection(sectionName) {
                const section = document.createElement('div');
                section.className = 'test-container';
                section.innerHTML = `<h3>${sectionName}</h3>`;
                this.resultsContainer.appendChild(section);
            }

            addTestResult(testName, passed, message) {
                const result = document.createElement('div');
                result.className = `test-result ${passed ? 'test-pass' : 'test-fail'}`;
                result.innerHTML = `
                    <strong>${passed ? 'âœ…' : 'âŒ'} ${testName}</strong>
                    <div class="test-details">${message}</div>
                `;
                this.resultsContainer.appendChild(result);
            }

            clearResults() {
                this.resultsContainer.innerHTML = '';
                this.testResults = [];
                this.currentTestIndex = 0;
                this.summaryContainer.style.display = 'none';
                this.hideProgress();
            }

            showProgress() {
                this.progressContainer.style.display = 'block';
                this.updateProgress();
            }

            hideProgress() {
                this.progressContainer.style.display = 'none';
            }

            updateProgress() {
                if (this.totalTests > 0) {
                    const percent = (this.currentTestIndex / this.totalTests) * 100;
                    this.progressFill.style.width = `${percent}%`;
                }
                this.currentTestIndex++;
            }

            showSummary() {
                const totalTests = this.testResults.length;
                const passedTests = this.testResults.filter(test => test.passed).length;
                const failedTests = totalTests - passedTests;
                const successRate = totalTests > 0 ? Math.round((passedTests / totalTests) * 100) : 0;

                this.summaryContent.innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div><strong>ç·ãƒ†ã‚¹ãƒˆæ•°:</strong> ${totalTests}</div>
                        <div style="color: #28a745;"><strong>æˆåŠŸ:</strong> ${passedTests}</div>
                        <div style="color: #dc3545;"><strong>å¤±æ•—:</strong> ${failedTests}</div>
                        <div><strong>æˆåŠŸç‡:</strong> ${successRate}%</div>
                    </div>
                    <div style="margin-top: 15px;">
                        <strong>çµ±åˆãƒ†ã‚¹ãƒˆçµæœ:</strong> 
                        ${successRate >= 95 ? 'ğŸ‰ å„ªç§€' : successRate >= 80 ? 'âœ… è‰¯å¥½' : successRate >= 60 ? 'âš ï¸ æ”¹å–„æ¨å¥¨' : 'âŒ è¦æ”¹å–„'}
                    </div>
                `;
                
                this.summaryContainer.style.display = 'block';
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            new IntegrationTestRunner();
        });
    </script>
</body>
</html>