<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuestionFlowå›ç­”å®Œäº†ãƒ†ã‚¹ãƒˆ</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .status {
        font-weight: bold;
        margin: 10px 0;
      }
      .answer-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 10px;
        margin: 10px 0;
      }
      .answer-item {
        padding: 8px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 12px;
      }
      .answer-item.missing {
        background-color: #f8d7da;
      }
      .answer-item.complete {
        background-color: #d4edda;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>QuestionFlowå›ç­”å®Œäº†ãƒ†ã‚¹ãƒˆ</h1>
      <p>å¶æ•°ç•ªç›®ã®è³ªå•ã®å›ç­”ãŒæ­£ã—ãä¿å­˜ã•ã‚Œã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¾ã™ã€‚</p>

      <div class="test-section info">
        <h3>ãƒ†ã‚¹ãƒˆçŠ¶æ³</h3>
        <div id="testStatus" class="status">ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...</div>
        <button onclick="runAnswerTest()">å›ç­”ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
        <button onclick="simulateUserAnswers()">
          ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        </button>
        <button onclick="checkAnswerIntegrity()">å›ç­”æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯</button>
        <button onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
      </div>

      <div class="test-section">
        <h3>1. è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ</h3>
        <div id="questionLoadTest">æœªå®Ÿè¡Œ</div>
      </div>

      <div class="test-section">
        <h3>2. å›ç­”ä¿å­˜ãƒ†ã‚¹ãƒˆ</h3>
        <div id="answerSaveTest">æœªå®Ÿè¡Œ</div>
      </div>

      <div class="test-section">
        <h3>3. å¶æ•°ç•ªç›®è³ªå•ãƒ†ã‚¹ãƒˆ</h3>
        <div id="evenQuestionTest">æœªå®Ÿè¡Œ</div>
      </div>

      <div class="test-section">
        <h3>4. å›ç­”å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ</h3>
        <div id="completionTest">æœªå®Ÿè¡Œ</div>
      </div>

      <div class="test-section">
        <h3>5. å›ç­”çŠ¶æ³ä¸€è¦§</h3>
        <div id="answerStatus">æœªå®Ÿè¡Œ</div>
      </div>

      <div class="test-section">
        <h3>ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h3>
        <div id="testSummary">ãƒ†ã‚¹ãƒˆæœªå®Ÿè¡Œ</div>
      </div>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
      let testResults = [];
      let questionFlow = null;
      let mockStorageManager = null;

      function logTest(testName, success, message, details = null) {
        const result = {
          test: testName,
          success: success,
          message: message,
          details: details,
          timestamp: new Date().toISOString(),
        };
        testResults.push(result);

        const elementId =
          testName.replace(/\s+/g, "").replace(/[()]/g, "") + "Test";
        const element = document.getElementById(elementId);
        if (element) {
          const className = success ? "success" : "error";
          element.innerHTML = `
                    <div class="${className}">
                        <strong>${
                          success ? "âœ…" : "âŒ"
                        } ${testName}</strong><br>
                        ${message}
                        ${
                          details
                            ? `<pre>${JSON.stringify(details, null, 2)}</pre>`
                            : ""
                        }
                    </div>
                `;
        }
      }

      function updateStatus(message) {
        document.getElementById("testStatus").textContent = message;
      }

      // ãƒ¢ãƒƒã‚¯StorageManagerã‚’ä½œæˆ
      function createMockStorageManager() {
        return {
          answers: [],
          progress: null,

          saveAnswers: function (answers) {
            this.answers = [...answers];
            console.log("ğŸ’¾ Mock storage: Saved answers", this.answers.length);
          },

          getAnswers: function () {
            return this.answers;
          },

          saveProgress: function (progress) {
            this.progress = progress;
          },

          getProgress: function () {
            return this.progress;
          },
        };
      }

      async function runAnswerTest() {
        testResults = [];
        updateStatus("ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...");

        // 1. è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
        try {
          if (
            typeof WORLDVIEW_QUESTIONS === "undefined" ||
            typeof SCENARIO_QUESTIONS === "undefined"
          ) {
            throw new Error("è³ªå•ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“");
          }

          const totalQuestions =
            WORLDVIEW_QUESTIONS.length + SCENARIO_QUESTIONS.length;
          logTest(
            "è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿",
            true,
            `è³ªå•ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ (${totalQuestions}å•)`,
            {
              worldviewQuestions: WORLDVIEW_QUESTIONS.length,
              scenarioQuestions: SCENARIO_QUESTIONS.length,
            }
          );
        } catch (error) {
          logTest(
            "è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿",
            false,
            `è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ${error.message}`,
            error
          );
          updateStatus("ãƒ†ã‚¹ãƒˆä¸­æ–­ - è³ªå•ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¤±æ•—");
          return;
        }

        // 2. QuestionFlowã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–
        try {
          mockStorageManager = createMockStorageManager();

          // ãƒ†ã‚¹ãƒˆç”¨ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
          let testContainer = document.getElementById(
            "questionFlowTestContainer"
          );
          if (!testContainer) {
            testContainer = document.createElement("div");
            testContainer.id = "questionFlowTestContainer";
            testContainer.style.display = "none";
            document.body.appendChild(testContainer);
          }

          questionFlow = new QuestionFlow("questionFlowTestContainer", {
            storageManager: mockStorageManager,
          });

          questionFlow.init();

          logTest("å›ç­”ä¿å­˜", true, "QuestionFlowãŒæ­£å¸¸ã«åˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ", {
            questionsLoaded: questionFlow.questions.length,
            currentIndex: questionFlow.currentQuestionIndex,
          });
        } catch (error) {
          logTest(
            "å›ç­”ä¿å­˜",
            false,
            `QuestionFlowåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`,
            error
          );
          updateStatus("ãƒ†ã‚¹ãƒˆä¸­æ–­ - QuestionFlowåˆæœŸåŒ–å¤±æ•—");
          return;
        }

        // 3. å¶æ•°ç•ªç›®è³ªå•ã®å›ç­”ãƒ†ã‚¹ãƒˆ
        try {
          const evenQuestionResults = [];
          const testQuestions = questionFlow.questions.slice(0, 10); // æœ€åˆã®10å•ã‚’ãƒ†ã‚¹ãƒˆ

          for (let i = 0; i < testQuestions.length; i++) {
            const question = testQuestions[i];
            const isEven = (i + 1) % 2 === 0;

            // æ¨¡æ“¬å›ç­”ã‚’ä½œæˆ
            const mockRadioElement = {
              value: "test_value_" + (i + 1),
              dataset: {
                scoring: JSON.stringify(["test_tag"]),
                choiceType: undefined,
              },
            };

            // ç¾åœ¨ã®è³ªå•ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
            questionFlow.currentQuestionIndex = i;

            // å›ç­”ã‚’å‡¦ç†
            questionFlow.handleAnswerChange(mockRadioElement);

            // å›ç­”ãŒä¿å­˜ã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
            const savedAnswer = questionFlow.findAnswerByQuestionId(
              question.id
            );
            const isAnswerSaved =
              savedAnswer &&
              savedAnswer.selectedValue === mockRadioElement.value;

            evenQuestionResults.push({
              questionIndex: i + 1,
              questionId: question.id,
              isEven: isEven,
              answerSaved: isAnswerSaved,
              savedValue: savedAnswer ? savedAnswer.selectedValue : null,
            });
          }

          const evenQuestions = evenQuestionResults.filter((r) => r.isEven);
          const evenQuestionsAnswered = evenQuestions.filter(
            (r) => r.answerSaved
          );

          const success = evenQuestionsAnswered.length === evenQuestions.length;
          logTest(
            "å¶æ•°ç•ªç›®è³ªå•",
            success,
            `å¶æ•°ç•ªç›®è³ªå•ãƒ†ã‚¹ãƒˆ: ${evenQuestionsAnswered.length}/${evenQuestions.length}å•ã§å›ç­”ä¿å­˜æˆåŠŸ`,
            evenQuestionResults
          );
        } catch (error) {
          logTest(
            "å¶æ•°ç•ªç›®è³ªå•",
            false,
            `å¶æ•°ç•ªç›®è³ªå•ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`,
            error
          );
        }

        // 4. å›ç­”å®Œäº†ãƒã‚§ãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
        try {
          const completionCheck = questionFlow.checkAllQuestionsAnswered();
          logTest(
            "å›ç­”å®Œäº†ãƒã‚§ãƒƒã‚¯",
            true,
            "å›ç­”å®Œäº†ãƒã‚§ãƒƒã‚¯ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã—ãŸ",
            {
              isComplete: completionCheck.isComplete,
              missingCount: completionCheck.missing.length,
              totalAnswers: questionFlow.answers.length,
            }
          );
        } catch (error) {
          logTest(
            "å›ç­”å®Œäº†ãƒã‚§ãƒƒã‚¯",
            false,
            `å›ç­”å®Œäº†ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼: ${error.message}`,
            error
          );
        }

        // å›ç­”çŠ¶æ³ã®è¡¨ç¤º
        displayAnswerStatus();

        // ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
        const successCount = testResults.filter((r) => r.success).length;
        const totalCount = testResults.length;
        const summaryElement = document.getElementById("testSummary");

        if (successCount === totalCount) {
          summaryElement.innerHTML = `
                    <div class="success">
                        <strong>âœ… å…¨ãƒ†ã‚¹ãƒˆæˆåŠŸ (${successCount}/${totalCount})</strong><br>
                        å¶æ•°ç•ªç›®ã®è³ªå•ã®å›ç­”ä¿å­˜ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚
                    </div>
                `;
          updateStatus("å…¨ãƒ†ã‚¹ãƒˆå®Œäº† - æˆåŠŸ");
        } else {
          summaryElement.innerHTML = `
                    <div class="warning">
                        <strong>âš ï¸ éƒ¨åˆ†çš„æˆåŠŸ (${successCount}/${totalCount})</strong><br>
                        ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                    </div>
                `;
          updateStatus(`ãƒ†ã‚¹ãƒˆå®Œäº† - ${successCount}/${totalCount}æˆåŠŸ`);
        }
      }

      function simulateUserAnswers() {
        if (!questionFlow) {
          alert("å…ˆã«å›ç­”ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„");
          return;
        }

        updateStatus("ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆä¸­...");

        // å…¨è³ªå•ã«å¯¾ã—ã¦å›ç­”ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        for (let i = 0; i < Math.min(questionFlow.questions.length, 20); i++) {
          const question = questionFlow.questions[i];
          questionFlow.currentQuestionIndex = i;

          const isScenario =
            question.scenario && question.inner_q && question.outer_q;

          if (isScenario) {
            // ã‚·ãƒŠãƒªã‚ªè³ªå•ã®å ´åˆ
            const innerMockElement = {
              value: "inner_" + (i + 1),
              dataset: {
                scoring: JSON.stringify(["inner_tag"]),
                choiceType: "inner",
              },
            };

            const outerMockElement = {
              value: "outer_" + (i + 1),
              dataset: {
                scoring: JSON.stringify(["outer_tag"]),
                choiceType: "outer",
              },
            };

            questionFlow.handleAnswerChange(innerMockElement);
            questionFlow.handleAnswerChange(outerMockElement);
          } else {
            // é€šå¸¸è³ªå•ã®å ´åˆ
            const mockElement = {
              value: "answer_" + (i + 1),
              dataset: {
                scoring: JSON.stringify(["answer_tag"]),
                choiceType: undefined,
              },
            };

            questionFlow.handleAnswerChange(mockElement);
          }
        }

        displayAnswerStatus();
        updateStatus("ãƒ¦ãƒ¼ã‚¶ãƒ¼å›ç­”ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆå®Œäº†");
      }

      function checkAnswerIntegrity() {
        if (!questionFlow) {
          alert("å…ˆã«å›ç­”ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„");
          return;
        }

        const integrityCheck = questionFlow.performDataIntegrityCheck();
        const completionCheck = questionFlow.checkAllQuestionsAnswered();

        const statusElement = document.getElementById("answerStatus");
        statusElement.innerHTML = `
                <div class="${
                  integrityCheck.hasIssues ? "warning" : "success"
                }">
                    <h4>ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯çµæœ</h4>
                    <p><strong>æ•´åˆæ€§å•é¡Œ:</strong> ${
                      integrityCheck.hasIssues ? "ã‚ã‚Š" : "ãªã—"
                    }</p>
                    <p><strong>å›ç­”å®Œäº†:</strong> ${
                      completionCheck.isComplete ? "å®Œäº†" : "æœªå®Œäº†"
                    }</p>
                    <p><strong>ç·å›ç­”æ•°:</strong> ${
                      questionFlow.answers.length
                    }</p>
                    <p><strong>æœªå›ç­”æ•°:</strong> ${
                      completionCheck.missing.length
                    }</p>
                    
                    ${
                      integrityCheck.issues.length > 0
                        ? `
                        <h5>æ•´åˆæ€§å•é¡Œè©³ç´°:</h5>
                        <ul>
                            ${integrityCheck.issues
                              .map((issue) => `<li>${issue}</li>`)
                              .join("")}
                        </ul>
                    `
                        : ""
                    }
                    
                    ${
                      completionCheck.missing.length > 0
                        ? `
                        <h5>æœªå›ç­”è³ªå•:</h5>
                        <ul>
                            ${completionCheck.missing
                              .slice(0, 10)
                              .map((missing) => `<li>${missing}</li>`)
                              .join("")}
                            ${
                              completionCheck.missing.length > 10
                                ? `<li>...ä»–${
                                    completionCheck.missing.length - 10
                                  }ä»¶</li>`
                                : ""
                            }
                        </ul>
                    `
                        : ""
                    }
                </div>
            `;
      }

      function displayAnswerStatus() {
        if (!questionFlow) return;

        const statusElement = document.getElementById("answerStatus");
        const answers = questionFlow.answers;
        const questions = questionFlow.questions.slice(0, 20); // æœ€åˆã®20å•ã‚’è¡¨ç¤º

        let html = '<div class="answer-grid">';

        for (let i = 0; i < questions.length; i++) {
          const question = questions[i];
          const answer = questionFlow.findAnswerByQuestionId(question.id);
          const isEven = (i + 1) % 2 === 0;
          const hasAnswer =
            answer &&
            (answer.selectedValue ||
              (answer.innerChoice && answer.outerChoice));

          html += `
                    <div class="answer-item ${
                      hasAnswer ? "complete" : "missing"
                    }">
                        <strong>Q${i + 1} ${
            isEven ? "(å¶æ•°)" : "(å¥‡æ•°)"
          }</strong><br>
                        ID: ${question.id}<br>
                        å›ç­”: ${hasAnswer ? "âœ…" : "âŒ"}<br>
                        ${
                          answer
                            ? `å€¤: ${answer.selectedValue || "ã‚·ãƒŠãƒªã‚ª"}`
                            : "æœªå›ç­”"
                        }
                    </div>
                `;
        }

        html += "</div>";
        statusElement.innerHTML = html;
      }

      function clearResults() {
        testResults = [];
        questionFlow = null;
        mockStorageManager = null;

        const testElements = [
          "questionLoadTest",
          "answerSaveTest",
          "evenQuestionTest",
          "completionTest",
          "answerStatus",
          "testSummary",
        ];
        testElements.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = "æœªå®Ÿè¡Œ";
          }
        });
        updateStatus("ãƒ†ã‚¹ãƒˆæº–å‚™ä¸­...");
      }

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸçŠ¶æ…‹ã‚’è¡¨ç¤º
      window.addEventListener("load", () => {
        updateStatus("ãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº† - å®Ÿè¡Œãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„");
      });
    </script>
  </body>
</html>
