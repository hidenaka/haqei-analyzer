<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è©³ç´°ãªå¶æ•°è³ªå•ãƒ‡ãƒãƒƒã‚°</title>
    <style>
        body { font-family: 'Hiragino Sans', 'ãƒ’ãƒ©ã‚®ãƒè§’ã‚´ Pro W3', Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .debug-panel { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background-color: #ffe6e6; border-color: #ff9999; }
        .success { background-color: #e6ffe6; border-color: #99ff99; }
        .warning { background-color: #fff3e0; border-color: #ffcc99; }
        .info { background-color: #e6f3ff; border-color: #99ccff; }
        button { 
            background: #007bff; color: white; border: none; 
            padding: 8px 16px; margin: 3px; border-radius: 3px; cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        .question-display { 
            border: 2px solid #333; padding: 20px; margin: 15px 0; 
            min-height: 300px; background: white; border-radius: 5px;
        }
        .log-output { 
            background: #f8f9fa; padding: 10px; border-radius: 3px; 
            max-height: 300px; overflow-y: auto; font-family: monospace; 
            white-space: pre-wrap; font-size: 12px;
        }
        .question-nav { 
            display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; 
        }
        .nav-btn { 
            padding: 5px 10px; font-size: 12px; 
            background: #28a745; border: none; color: white; border-radius: 3px;
        }
        .nav-btn.even { background: #dc3545; }
        .nav-btn.current { background: #ffc107; color: black; font-weight: bold; }
        .test-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .test-result { 
            padding: 10px; border: 1px solid #ddd; border-radius: 3px; 
            font-size: 12px; text-align: center;
        }
        .test-result.pass { background: #d4edda; }
        .test-result.fail { background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” å¶æ•°è³ªå•è¡¨ç¤ºå•é¡Œã®è©³ç´°ãƒ‡ãƒãƒƒã‚°</h1>
        
        <div class="debug-panel info">
            <h3>ç¾åœ¨ã®çŠ¶æ³</h3>
            <div id="currentStatus">åˆæœŸåŒ–ä¸­...</div>
        </div>

        <div class="debug-panel">
            <h3>ãƒ†ã‚¹ãƒˆåˆ¶å¾¡</h3>
            <button onclick="initializeQuestionFlow()">QuestionFlowåˆæœŸåŒ–</button>
            <button onclick="runCompleteTest()">å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="testSpecificEvenQuestions()">å¶æ•°è³ªå•ç‰¹åŒ–ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="simulateUserFlow()">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬</button>
            <button onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        </div>

        <div class="debug-panel">
            <h3>è³ªå•ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³</h3>
            <div id="questionNavigation" class="question-nav">
                <!-- è³ªå•ãƒœã‚¿ãƒ³ãŒã“ã“ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
            </div>
        </div>

        <div class="debug-panel">
            <h3>QuestionFlowè¡¨ç¤ºã‚¨ãƒªã‚¢</h3>
            <div id="questionFlowContainer" class="question-display">
                QuestionFlowãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™
            </div>
        </div>

        <div class="debug-panel">
            <h3>ãƒ†ã‚¹ãƒˆçµæœ</h3>
            <div id="testResults" class="test-results">
                <!-- ãƒ†ã‚¹ãƒˆçµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
        </div>

        <div class="debug-panel">
            <h3>è©³ç´°ãƒ­ã‚°</h3>
            <div id="debugLog" class="log-output">ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...</div>
        </div>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
        let questionFlow = null;
        let mockStorage = null;
        let debugLog = document.getElementById('debugLog');
        let testResults = [];

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        function addLog(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${type}: ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // ã‚ªãƒªã‚¸ãƒŠãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            originalConsole.log(`[${type}] ${message}`);
        }

        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ãƒ•ãƒƒã‚¯
        console.log = (...args) => addLog(args.join(' '), 'LOG');
        console.error = (...args) => addLog(args.join(' '), 'ERROR');
        console.warn = (...args) => addLog(args.join(' '), 'WARN');

        function updateStatus(message) {
            document.getElementById('currentStatus').textContent = message;
            addLog(`STATUS: ${message}`);
        }

        function createNavigationButtons() {
            const nav = document.getElementById('questionNavigation');
            nav.innerHTML = '';
            
            if (!questionFlow || !questionFlow.questions) return;

            for (let i = 0; i < Math.min(10, questionFlow.questions.length); i++) {
                const btn = document.createElement('button');
                const questionNum = i + 1;
                const isEven = questionNum % 2 === 0;
                const isCurrent = i === questionFlow.currentQuestionIndex;
                
                btn.textContent = `Q${questionNum}`;
                btn.className = `nav-btn ${isEven ? 'even' : 'odd'} ${isCurrent ? 'current' : ''}`;
                btn.onclick = () => navigateToQuestion(i);
                
                nav.appendChild(btn);
            }
        }

        function navigateToQuestion(index) {
            if (!questionFlow) {
                addLog('ERROR: QuestionFlow not initialized', 'ERROR');
                return;
            }

            const questionNum = index + 1;
            const isEven = questionNum % 2 === 0;
            
            addLog(`\n=== è³ªå•${questionNum}${isEven ? '(å¶æ•°)' : '(å¥‡æ•°)'}ã«ç§»å‹• ===`);
            
            questionFlow.currentQuestionIndex = index;
            
            try {
                questionFlow.renderCurrentQuestion();
                questionFlow.updateNavigationButtons();
                questionFlow.updateProgress();
                
                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœã‚’è©³ç´°ãƒã‚§ãƒƒã‚¯
                setTimeout(() => {
                    checkRenderingResult(index);
                    createNavigationButtons();
                }, 100);
                
            } catch (error) {
                addLog(`è³ªå•${questionNum}ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã§ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
            }
        }

        function checkRenderingResult(questionIndex) {
            const questionNum = questionIndex + 1;
            const isEven = questionNum % 2 === 0;
            const question = questionFlow.questions[questionIndex];
            
            // DOMè¦ç´ ã‚’ãƒã‚§ãƒƒã‚¯
            const container = document.getElementById('questionFlowContainer');
            const questionDisplay = container.querySelector('#question-display');
            
            addLog(`--- è³ªå•${questionNum}${isEven ? '(å¶æ•°)' : '(å¥‡æ•°)'}ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°çµæœãƒã‚§ãƒƒã‚¯ ---`);
            addLog(`è³ªå•ID: ${question.id}`);
            addLog(`è³ªå•ãƒ†ã‚­ã‚¹ãƒˆ: ${question.text || question.scenario || 'ãªã—'}`);
            
            if (!questionDisplay) {
                addLog(`âŒ #question-displayè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼`, 'ERROR');
                return false;
            }
            
            const content = questionDisplay.innerHTML.trim();
            const hasContent = content.length > 0;
            
            addLog(`ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æœ‰ç„¡: ${hasContent ? 'ã‚ã‚Š' : 'ãªã—'}`);
            addLog(`ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é•·: ${content.length}æ–‡å­—`);
            
            if (!hasContent) {
                addLog(`âŒ è³ªå•${questionNum}${isEven ? '(å¶æ•°)' : '(å¥‡æ•°)'}ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒã‚ã‚Šã¾ã›ã‚“ï¼`, 'ERROR');
                
                // è©³ç´°èª¿æŸ»
                addLog(`è³ªå•ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆè©³ç´°:`, 'DEBUG');
                addLog(`  - id: ${question.id}`, 'DEBUG');
                addLog(`  - text: ${question.text || 'ãªã—'}`, 'DEBUG');
                addLog(`  - scenario: ${question.scenario || 'ãªã—'}`, 'DEBUG');
                addLog(`  - options: ${question.options ? question.options.length + 'å€‹' : 'ãªã—'}`, 'DEBUG');
                
                return false;
            } else {
                addLog(`âœ… è³ªå•${questionNum}${isEven ? '(å¶æ•°)' : '(å¥‡æ•°)'}ãŒæ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¾ã—ãŸ`);
                return true;
            }
        }

        function initializeQuestionFlow() {
            addLog('\n=== QuestionFlowåˆæœŸåŒ–é–‹å§‹ ===');
            updateStatus('QuestionFlowåˆæœŸåŒ–ä¸­...');
            
            try {
                // ãƒ¢ãƒƒã‚¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ä½œæˆ
                mockStorage = {
                    answers: [],
                    progress: null,
                    saveAnswers: function(answers) { 
                        this.answers = [...answers];
                        addLog(`ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: ${answers.length}å€‹ã®å›ç­”ã‚’ä¿å­˜`);
                    },
                    getAnswers: function() { return this.answers; },
                    saveProgress: function(progress) { 
                        this.progress = progress;
                        addLog(`ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: é€²è¡ŒçŠ¶æ³ä¿å­˜ (index: ${progress.currentQuestionIndex})`);
                    },
                    getProgress: function() { return this.progress; }
                };

                // QuestionFlowåˆæœŸåŒ–
                questionFlow = new QuestionFlow('questionFlowContainer', {
                    storageManager: mockStorage
                });

                questionFlow.init();
                
                addLog(`QuestionFlowåˆæœŸåŒ–å®Œäº†: ${questionFlow.questions.length}å•èª­ã¿è¾¼ã¿`);
                addLog(`é–‹å§‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹: ${questionFlow.currentQuestionIndex}`);
                
                updateStatus(`åˆæœŸåŒ–å®Œäº† - ${questionFlow.questions.length}å•èª­ã¿è¾¼ã¿`);
                createNavigationButtons();
                
            } catch (error) {
                addLog(`åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'ERROR');
                updateStatus(`åˆæœŸåŒ–å¤±æ•—: ${error.message}`);
            }
        }

        async function testSpecificEvenQuestions() {
            if (!questionFlow) {
                addLog('QuestionFlowãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'ERROR');
                return;
            }

            addLog('\n=== å¶æ•°è³ªå•ç‰¹åŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            updateStatus('å¶æ•°è³ªå•ã‚’ãƒ†ã‚¹ãƒˆä¸­...');
            
            const evenQuestions = [];
            const results = [];

            // å¶æ•°è³ªå•ã‚’ç‰¹å®š
            for (let i = 0; i < questionFlow.questions.length; i++) {
                if ((i + 1) % 2 === 0) {
                    evenQuestions.push(i);
                }
            }

            addLog(`å¶æ•°è³ªå•: ${evenQuestions.map(i => i + 1).join(', ')}`);

            // å„å¶æ•°è³ªå•ã‚’ãƒ†ã‚¹ãƒˆ
            for (let index of evenQuestions.slice(0, 6)) { // æœ€åˆã®6å€‹
                const questionNum = index + 1;
                addLog(`\n--- å¶æ•°è³ªå• Q${questionNum} ãƒ†ã‚¹ãƒˆ ---`);
                
                navigateToQuestion(index);
                
                // å°‘ã—å¾…ã£ã¦ã‹ã‚‰ãƒã‚§ãƒƒã‚¯
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const success = checkRenderingResult(index);
                results.push({
                    questionNum,
                    index,
                    success,
                    isEven: true
                });
            }

            // çµæœè¡¨ç¤º
            displayTestResults(results);
            
            const successCount = results.filter(r => r.success).length;
            addLog(`\n=== å¶æ•°è³ªå•ãƒ†ã‚¹ãƒˆå®Œäº† ===`);
            addLog(`æˆåŠŸ: ${successCount}/${results.length}`);
            
            updateStatus(`å¶æ•°è³ªå•ãƒ†ã‚¹ãƒˆå®Œäº†: ${successCount}/${results.length}æˆåŠŸ`);
        }

        async function runCompleteTest() {
            if (!questionFlow) {
                addLog('QuestionFlowãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'ERROR');
                return;
            }

            addLog('\n=== å®Œå…¨ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            updateStatus('å…¨è³ªå•ã‚’ãƒ†ã‚¹ãƒˆä¸­...');
            
            const results = [];
            const testCount = Math.min(10, questionFlow.questions.length);

            for (let i = 0; i < testCount; i++) {
                const questionNum = i + 1;
                const isEven = questionNum % 2 === 0;
                
                addLog(`\n--- è³ªå• Q${questionNum}${isEven ? '(å¶æ•°)' : '(å¥‡æ•°)'} ãƒ†ã‚¹ãƒˆ ---`);
                
                navigateToQuestion(i);
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const success = checkRenderingResult(i);
                results.push({
                    questionNum,
                    index: i,
                    success,
                    isEven
                });
            }

            displayTestResults(results);
            
            const evenResults = results.filter(r => r.isEven);
            const oddResults = results.filter(r => !r.isEven);
            const evenSuccess = evenResults.filter(r => r.success).length;
            const oddSuccess = oddResults.filter(r => r.success).length;
            
            addLog(`\n=== å®Œå…¨ãƒ†ã‚¹ãƒˆçµæœ ===`);
            addLog(`å¶æ•°è³ªå•: ${evenSuccess}/${evenResults.length}æˆåŠŸ`);
            addLog(`å¥‡æ•°è³ªå•: ${oddSuccess}/${oddResults.length}æˆåŠŸ`);
            
            updateStatus(`ãƒ†ã‚¹ãƒˆå®Œäº† - å¶æ•°:${evenSuccess}/${evenResults.length}, å¥‡æ•°:${oddSuccess}/${oddResults.length}`);
        }

        function displayTestResults(results) {
            const container = document.getElementById('testResults');
            container.innerHTML = '';

            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.success ? 'pass' : 'fail'}`;
                div.innerHTML = `
                    <strong>Q${result.questionNum}</strong><br>
                    ${result.isEven ? 'å¶æ•°' : 'å¥‡æ•°'}<br>
                    ${result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}
                `;
                container.appendChild(div);
            });
        }

        async function simulateUserFlow() {
            if (!questionFlow) {
                addLog('QuestionFlowãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'ERROR');
                return;
            }

            addLog('\n=== ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬é–‹å§‹ ===');
            updateStatus('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’æ¨¡æ“¬ä¸­...');

            // è³ªå•1ã‹ã‚‰é †ç•ªã«é€²ã‚€
            for (let i = 0; i < Math.min(6, questionFlow.questions.length); i++) {
                const questionNum = i + 1;
                addLog(`\nãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³ªå•${questionNum}ã«é€²ã‚€...`);
                
                questionFlow.currentQuestionIndex = i;
                questionFlow.renderCurrentQuestion();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã‚’æ¨¡æ“¬
                if (i < questionFlow.questions.length - 1) {
                    addLog(`æ¬¡ã¸ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯...`);
                    questionFlow.goToNext();
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }

            addLog('=== ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Œäº† ===');
            updateStatus('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Œäº†');
        }

        function clearAllData() {
            if (mockStorage) {
                mockStorage.answers = [];
                mockStorage.progress = null;
            }
            
            debugLog.textContent = '';
            document.getElementById('testResults').innerHTML = '';
            
            addLog('å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
            updateStatus('ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•åˆæœŸåŒ–
        window.addEventListener('load', () => {
            addLog('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            updateStatus('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº† - åˆæœŸåŒ–ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„');
        });
    </script>
</body>
</html>