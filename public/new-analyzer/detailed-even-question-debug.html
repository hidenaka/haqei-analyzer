<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>詳細な偶数質問デバッグ</title>
    <style>
        body { font-family: 'Hiragino Sans', 'ヒラギノ角ゴ Pro W3', Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .debug-panel { border: 1px solid #ccc; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .error { background-color: #ffe6e6; border-color: #ff9999; }
        .success { background-color: #e6ffe6; border-color: #99ff99; }
        .warning { background-color: #fff3e0; border-color: #ffcc99; }
        .info { background-color: #e6f3ff; border-color: #99ccff; }
        button { 
            background: #007bff; color: white; border: none; 
            padding: 8px 16px; margin: 3px; border-radius: 3px; cursor: pointer; 
        }
        button:hover { background: #0056b3; }
        .question-display { 
            border: 2px solid #333; padding: 20px; margin: 15px 0; 
            min-height: 300px; background: white; border-radius: 5px;
        }
        .log-output { 
            background: #f8f9fa; padding: 10px; border-radius: 3px; 
            max-height: 300px; overflow-y: auto; font-family: monospace; 
            white-space: pre-wrap; font-size: 12px;
        }
        .question-nav { 
            display: flex; flex-wrap: wrap; gap: 5px; margin: 10px 0; 
        }
        .nav-btn { 
            padding: 5px 10px; font-size: 12px; 
            background: #28a745; border: none; color: white; border-radius: 3px;
        }
        .nav-btn.even { background: #dc3545; }
        .nav-btn.current { background: #ffc107; color: black; font-weight: bold; }
        .test-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
        .test-result { 
            padding: 10px; border: 1px solid #ddd; border-radius: 3px; 
            font-size: 12px; text-align: center;
        }
        .test-result.pass { background: #d4edda; }
        .test-result.fail { background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 偶数質問表示問題の詳細デバッグ</h1>
        
        <div class="debug-panel info">
            <h3>現在の状況</h3>
            <div id="currentStatus">初期化中...</div>
        </div>

        <div class="debug-panel">
            <h3>テスト制御</h3>
            <button onclick="initializeQuestionFlow()">QuestionFlow初期化</button>
            <button onclick="runCompleteTest()">完全テスト実行</button>
            <button onclick="testSpecificEvenQuestions()">偶数質問特化テスト</button>
            <button onclick="simulateUserFlow()">ユーザーフロー模擬</button>
            <button onclick="clearAllData()">全データクリア</button>
        </div>

        <div class="debug-panel">
            <h3>質問ナビゲーション</h3>
            <div id="questionNavigation" class="question-nav">
                <!-- 質問ボタンがここに生成される -->
            </div>
        </div>

        <div class="debug-panel">
            <h3>QuestionFlow表示エリア</h3>
            <div id="questionFlowContainer" class="question-display">
                QuestionFlowがここに表示されます
            </div>
        </div>

        <div class="debug-panel">
            <h3>テスト結果</h3>
            <div id="testResults" class="test-results">
                <!-- テスト結果がここに表示される -->
            </div>
        </div>

        <div class="debug-panel">
            <h3>詳細ログ</h3>
            <div id="debugLog" class="log-output">デバッグ情報がここに表示されます...</div>
        </div>
    </div>

    <!-- 必要なスクリプトを読み込み -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
        let questionFlow = null;
        let mockStorage = null;
        let debugLog = document.getElementById('debugLog');
        let testResults = [];

        // コンソール出力をキャプチャ
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };

        function addLog(message, type = 'INFO') {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${type}: ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            
            // オリジナルのコンソールにも出力
            originalConsole.log(`[${type}] ${message}`);
        }

        // コンソールをフック
        console.log = (...args) => addLog(args.join(' '), 'LOG');
        console.error = (...args) => addLog(args.join(' '), 'ERROR');
        console.warn = (...args) => addLog(args.join(' '), 'WARN');

        function updateStatus(message) {
            document.getElementById('currentStatus').textContent = message;
            addLog(`STATUS: ${message}`);
        }

        function createNavigationButtons() {
            const nav = document.getElementById('questionNavigation');
            nav.innerHTML = '';
            
            if (!questionFlow || !questionFlow.questions) return;

            for (let i = 0; i < Math.min(10, questionFlow.questions.length); i++) {
                const btn = document.createElement('button');
                const questionNum = i + 1;
                const isEven = questionNum % 2 === 0;
                const isCurrent = i === questionFlow.currentQuestionIndex;
                
                btn.textContent = `Q${questionNum}`;
                btn.className = `nav-btn ${isEven ? 'even' : 'odd'} ${isCurrent ? 'current' : ''}`;
                btn.onclick = () => navigateToQuestion(i);
                
                nav.appendChild(btn);
            }
        }

        function navigateToQuestion(index) {
            if (!questionFlow) {
                addLog('ERROR: QuestionFlow not initialized', 'ERROR');
                return;
            }

            const questionNum = index + 1;
            const isEven = questionNum % 2 === 0;
            
            addLog(`\n=== 質問${questionNum}${isEven ? '(偶数)' : '(奇数)'}に移動 ===`);
            
            questionFlow.currentQuestionIndex = index;
            
            try {
                questionFlow.renderCurrentQuestion();
                questionFlow.updateNavigationButtons();
                questionFlow.updateProgress();
                
                // レンダリング結果を詳細チェック
                setTimeout(() => {
                    checkRenderingResult(index);
                    createNavigationButtons();
                }, 100);
                
            } catch (error) {
                addLog(`質問${questionNum}のレンダリングでエラー: ${error.message}`, 'ERROR');
            }
        }

        function checkRenderingResult(questionIndex) {
            const questionNum = questionIndex + 1;
            const isEven = questionNum % 2 === 0;
            const question = questionFlow.questions[questionIndex];
            
            // DOM要素をチェック
            const container = document.getElementById('questionFlowContainer');
            const questionDisplay = container.querySelector('#question-display');
            
            addLog(`--- 質問${questionNum}${isEven ? '(偶数)' : '(奇数)'}のレンダリング結果チェック ---`);
            addLog(`質問ID: ${question.id}`);
            addLog(`質問テキスト: ${question.text || question.scenario || 'なし'}`);
            
            if (!questionDisplay) {
                addLog(`❌ #question-display要素が見つかりません！`, 'ERROR');
                return false;
            }
            
            const content = questionDisplay.innerHTML.trim();
            const hasContent = content.length > 0;
            
            addLog(`コンテンツ有無: ${hasContent ? 'あり' : 'なし'}`);
            addLog(`コンテンツ長: ${content.length}文字`);
            
            if (!hasContent) {
                addLog(`❌ 質問${questionNum}${isEven ? '(偶数)' : '(奇数)'}にコンテンツがありません！`, 'ERROR');
                
                // 詳細調査
                addLog(`質問オブジェクト詳細:`, 'DEBUG');
                addLog(`  - id: ${question.id}`, 'DEBUG');
                addLog(`  - text: ${question.text || 'なし'}`, 'DEBUG');
                addLog(`  - scenario: ${question.scenario || 'なし'}`, 'DEBUG');
                addLog(`  - options: ${question.options ? question.options.length + '個' : 'なし'}`, 'DEBUG');
                
                return false;
            } else {
                addLog(`✅ 質問${questionNum}${isEven ? '(偶数)' : '(奇数)'}が正常に表示されました`);
                return true;
            }
        }

        function initializeQuestionFlow() {
            addLog('\n=== QuestionFlow初期化開始 ===');
            updateStatus('QuestionFlow初期化中...');
            
            try {
                // モックストレージ作成
                mockStorage = {
                    answers: [],
                    progress: null,
                    saveAnswers: function(answers) { 
                        this.answers = [...answers];
                        addLog(`ストレージ: ${answers.length}個の回答を保存`);
                    },
                    getAnswers: function() { return this.answers; },
                    saveProgress: function(progress) { 
                        this.progress = progress;
                        addLog(`ストレージ: 進行状況保存 (index: ${progress.currentQuestionIndex})`);
                    },
                    getProgress: function() { return this.progress; }
                };

                // QuestionFlow初期化
                questionFlow = new QuestionFlow('questionFlowContainer', {
                    storageManager: mockStorage
                });

                questionFlow.init();
                
                addLog(`QuestionFlow初期化完了: ${questionFlow.questions.length}問読み込み`);
                addLog(`開始インデックス: ${questionFlow.currentQuestionIndex}`);
                
                updateStatus(`初期化完了 - ${questionFlow.questions.length}問読み込み`);
                createNavigationButtons();
                
            } catch (error) {
                addLog(`初期化エラー: ${error.message}`, 'ERROR');
                updateStatus(`初期化失敗: ${error.message}`);
            }
        }

        async function testSpecificEvenQuestions() {
            if (!questionFlow) {
                addLog('QuestionFlowが初期化されていません', 'ERROR');
                return;
            }

            addLog('\n=== 偶数質問特化テスト開始 ===');
            updateStatus('偶数質問をテスト中...');
            
            const evenQuestions = [];
            const results = [];

            // 偶数質問を特定
            for (let i = 0; i < questionFlow.questions.length; i++) {
                if ((i + 1) % 2 === 0) {
                    evenQuestions.push(i);
                }
            }

            addLog(`偶数質問: ${evenQuestions.map(i => i + 1).join(', ')}`);

            // 各偶数質問をテスト
            for (let index of evenQuestions.slice(0, 6)) { // 最初の6個
                const questionNum = index + 1;
                addLog(`\n--- 偶数質問 Q${questionNum} テスト ---`);
                
                navigateToQuestion(index);
                
                // 少し待ってからチェック
                await new Promise(resolve => setTimeout(resolve, 300));
                
                const success = checkRenderingResult(index);
                results.push({
                    questionNum,
                    index,
                    success,
                    isEven: true
                });
            }

            // 結果表示
            displayTestResults(results);
            
            const successCount = results.filter(r => r.success).length;
            addLog(`\n=== 偶数質問テスト完了 ===`);
            addLog(`成功: ${successCount}/${results.length}`);
            
            updateStatus(`偶数質問テスト完了: ${successCount}/${results.length}成功`);
        }

        async function runCompleteTest() {
            if (!questionFlow) {
                addLog('QuestionFlowが初期化されていません', 'ERROR');
                return;
            }

            addLog('\n=== 完全テスト開始 ===');
            updateStatus('全質問をテスト中...');
            
            const results = [];
            const testCount = Math.min(10, questionFlow.questions.length);

            for (let i = 0; i < testCount; i++) {
                const questionNum = i + 1;
                const isEven = questionNum % 2 === 0;
                
                addLog(`\n--- 質問 Q${questionNum}${isEven ? '(偶数)' : '(奇数)'} テスト ---`);
                
                navigateToQuestion(i);
                await new Promise(resolve => setTimeout(resolve, 200));
                
                const success = checkRenderingResult(i);
                results.push({
                    questionNum,
                    index: i,
                    success,
                    isEven
                });
            }

            displayTestResults(results);
            
            const evenResults = results.filter(r => r.isEven);
            const oddResults = results.filter(r => !r.isEven);
            const evenSuccess = evenResults.filter(r => r.success).length;
            const oddSuccess = oddResults.filter(r => r.success).length;
            
            addLog(`\n=== 完全テスト結果 ===`);
            addLog(`偶数質問: ${evenSuccess}/${evenResults.length}成功`);
            addLog(`奇数質問: ${oddSuccess}/${oddResults.length}成功`);
            
            updateStatus(`テスト完了 - 偶数:${evenSuccess}/${evenResults.length}, 奇数:${oddSuccess}/${oddResults.length}`);
        }

        function displayTestResults(results) {
            const container = document.getElementById('testResults');
            container.innerHTML = '';

            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.success ? 'pass' : 'fail'}`;
                div.innerHTML = `
                    <strong>Q${result.questionNum}</strong><br>
                    ${result.isEven ? '偶数' : '奇数'}<br>
                    ${result.success ? '✅ 成功' : '❌ 失敗'}
                `;
                container.appendChild(div);
            });
        }

        async function simulateUserFlow() {
            if (!questionFlow) {
                addLog('QuestionFlowが初期化されていません', 'ERROR');
                return;
            }

            addLog('\n=== ユーザーフロー模擬開始 ===');
            updateStatus('ユーザーフローを模擬中...');

            // 質問1から順番に進む
            for (let i = 0; i < Math.min(6, questionFlow.questions.length); i++) {
                const questionNum = i + 1;
                addLog(`\nユーザーが質問${questionNum}に進む...`);
                
                questionFlow.currentQuestionIndex = i;
                questionFlow.renderCurrentQuestion();
                
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // 次へボタンクリックを模擬
                if (i < questionFlow.questions.length - 1) {
                    addLog(`次へボタンクリック...`);
                    questionFlow.goToNext();
                    await new Promise(resolve => setTimeout(resolve, 300));
                }
            }

            addLog('=== ユーザーフロー模擬完了 ===');
            updateStatus('ユーザーフロー模擬完了');
        }

        function clearAllData() {
            if (mockStorage) {
                mockStorage.answers = [];
                mockStorage.progress = null;
            }
            
            debugLog.textContent = '';
            document.getElementById('testResults').innerHTML = '';
            
            addLog('全データクリア完了');
            updateStatus('データクリア完了');
        }

        // ページ読み込み時に自動初期化
        window.addEventListener('load', () => {
            addLog('ページ読み込み完了');
            updateStatus('ページ読み込み完了 - 初期化ボタンをクリックしてください');
        });
    </script>
</body>
</html>