<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuestionFlow修正テスト</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      .test-section {
        margin: 20px 0;
        padding: 15px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .success {
        background-color: #d4edda;
        border-color: #c3e6cb;
      }
      .error {
        background-color: #f8d7da;
        border-color: #f5c6cb;
      }
      .warning {
        background-color: #fff3cd;
        border-color: #ffeaa7;
      }
      .info {
        background-color: #d1ecf1;
        border-color: #bee5eb;
      }
      pre {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
      }
      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin: 5px;
      }
      button:hover {
        background: #0056b3;
      }
      .status {
        font-weight: bold;
        margin: 10px 0;
      }
      #test-container {
        min-height: 200px;
        border: 2px dashed #ddd;
        padding: 20px;
        margin: 20px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>QuestionFlow修正テスト</h1>
      <p>QuestionFlowクラスが正しく動作するかテストします。</p>

      <div class="test-section info">
        <h3>テスト状況</h3>
        <div id="testStatus" class="status">テスト準備中...</div>
        <button onclick="runClassTest()">クラステスト実行</button>
        <button onclick="runQuestionFlowTest()">QuestionFlowテスト実行</button>
        <button onclick="clearResults()">結果クリア</button>
      </div>

      <div class="test-section">
        <h3>1. クラス定義テスト</h3>
        <div id="classTest">未実行</div>
      </div>

      <div class="test-section">
        <h3>2. データ読み込みテスト</h3>
        <div id="dataTest">未実行</div>
      </div>

      <div class="test-section">
        <h3>3. QuestionFlowインスタンス化テスト</h3>
        <div id="instanceTest">未実行</div>
      </div>

      <div class="test-section">
        <h3>4. QuestionFlow動作テスト</h3>
        <div id="functionTest">未実行</div>
        <div id="test-container">
          <!-- QuestionFlowがここに表示される -->
        </div>
      </div>

      <div class="test-section">
        <h3>テスト結果サマリー</h3>
        <div id="testSummary">テスト未実行</div>
      </div>
    </div>

    <!-- 必要なスクリプトを読み込み -->
    <script src="js/data/questions.js"></script>
    <script src="js/data/vectors.js"></script>
    <script src="js/data/data_box.js"></script>
    <script src="js/core/BaseComponent.js"></script>
    <script src="js/core/StorageManager.js"></script>
    <script src="js/components/QuestionFlow.js"></script>

    <script>
      let testResults = [];

      function logTest(testName, success, message, details = null) {
        const result = {
          test: testName,
          success: success,
          message: message,
          details: details,
          timestamp: new Date().toISOString(),
        };
        testResults.push(result);

        const elementId =
          testName.replace(/\s+/g, "").replace(/[()]/g, "") + "Test";
        const element = document.getElementById(elementId);
        if (element) {
          const className = success ? "success" : "error";
          element.innerHTML = `
                    <div class="${className}">
                        <strong>${
                          success ? "✅" : "❌"
                        } ${testName}</strong><br>
                        ${message}
                        ${
                          details
                            ? `<pre>${JSON.stringify(details, null, 2)}</pre>`
                            : ""
                        }
                    </div>
                `;
        }
      }

      function updateStatus(message) {
        document.getElementById("testStatus").textContent = message;
      }

      function runClassTest() {
        testResults = [];
        updateStatus("クラステスト実行中...");

        // 1. クラス定義テスト
        try {
          const classDefinitions = {
            BaseComponent: typeof BaseComponent !== "undefined",
            QuestionFlow: typeof QuestionFlow !== "undefined",
            StorageManager: typeof StorageManager !== "undefined",
          };

          const missingClasses = Object.keys(classDefinitions).filter(
            (key) => !classDefinitions[key]
          );

          if (missingClasses.length === 0) {
            logTest(
              "クラス定義",
              true,
              "全ての必要なクラスが定義されています",
              classDefinitions
            );
          } else {
            logTest(
              "クラス定義",
              false,
              `不足しているクラス: ${missingClasses.join(", ")}`,
              classDefinitions
            );
          }
        } catch (error) {
          logTest(
            "クラス定義",
            false,
            `クラス定義テストエラー: ${error.message}`,
            error
          );
        }

        // 2. データ読み込みテスト
        try {
          const dataAvailability = {
            HAQEI_DATA: typeof window.HAQEI_DATA !== "undefined",
            WORLDVIEW_QUESTIONS:
              typeof window.WORLDVIEW_QUESTIONS !== "undefined",
            SCENARIO_QUESTIONS:
              typeof window.SCENARIO_QUESTIONS !== "undefined",
            H64_8D_VECTORS: typeof window.H64_8D_VECTORS !== "undefined",
          };

          const availableCount =
            Object.values(dataAvailability).filter(Boolean).length;
          const totalCount = Object.keys(dataAvailability).length;

          if (availableCount === totalCount) {
            logTest(
              "データ読み込み",
              true,
              `全てのデータが読み込まれています (${availableCount}/${totalCount})`,
              dataAvailability
            );
          } else {
            logTest(
              "データ読み込み",
              false,
              `一部のデータが不足しています (${availableCount}/${totalCount})`,
              dataAvailability
            );
          }
        } catch (error) {
          logTest(
            "データ読み込み",
            false,
            `データ読み込みテストエラー: ${error.message}`,
            error
          );
        }

        updateStatus("クラステスト完了");
        updateSummary();
      }

      function runQuestionFlowTest() {
        updateStatus("QuestionFlowテスト実行中...");

        // 3. QuestionFlowインスタンス化テスト
        try {
          if (typeof QuestionFlow === "undefined") {
            throw new Error("QuestionFlowクラスが定義されていません");
          }

          // モックStorageManagerを作成
          const mockStorageManager = {
            getAnswers: () => [],
            getProgress: () => null,
            saveAnswers: (answers) =>
              console.log("Mock save answers:", answers.length),
            saveProgress: (progress) =>
              console.log("Mock save progress:", progress),
          };

          const questionFlow = new QuestionFlow("test-container", {
            storageManager: mockStorageManager,
          });

          logTest(
            "QuestionFlowインスタンス化",
            true,
            "QuestionFlowが正常にインスタンス化されました",
            {
              questionsLoaded: questionFlow.questions.length,
              currentIndex: questionFlow.currentQuestionIndex,
            }
          );

          // 4. QuestionFlow動作テスト
          try {
            questionFlow.init();

            logTest(
              "QuestionFlow動作",
              true,
              "QuestionFlowが正常に初期化されました",
              {
                questionsCount: questionFlow.questions.length,
                answersCount: questionFlow.answers.length,
                containerVisible: questionFlow.container.innerHTML.length > 0,
              }
            );

            // 簡単な回答テスト
            if (questionFlow.questions.length > 0) {
              const firstQuestion = questionFlow.questions[0];
              console.log("First question:", firstQuestion);

              // 模擬回答を作成
              const mockRadioElement = {
                value: "test_value",
                dataset: {
                  scoring: JSON.stringify([{ key: "test", value: 1 }]),
                  choiceType: undefined,
                },
              };

              questionFlow.handleAnswerChange(mockRadioElement);

              const hasAnswer = questionFlow.answers.length > 0;
              logTest(
                "QuestionFlow動作",
                hasAnswer,
                hasAnswer
                  ? "回答処理が正常に動作しました"
                  : "回答処理に問題があります",
                {
                  answersAfterTest: questionFlow.answers.length,
                  firstAnswer: questionFlow.answers[0] || null,
                }
              );
            }
          } catch (initError) {
            logTest(
              "QuestionFlow動作",
              false,
              `QuestionFlow初期化エラー: ${initError.message}`,
              initError
            );
          }
        } catch (error) {
          logTest(
            "QuestionFlowインスタンス化",
            false,
            `QuestionFlowインスタンス化エラー: ${error.message}`,
            error
          );
        }

        updateStatus("QuestionFlowテスト完了");
        updateSummary();
      }

      function updateSummary() {
        const successCount = testResults.filter((r) => r.success).length;
        const totalCount = testResults.length;
        const summaryElement = document.getElementById("testSummary");

        if (totalCount === 0) {
          summaryElement.innerHTML = '<div class="info">テスト未実行</div>';
          return;
        }

        if (successCount === totalCount) {
          summaryElement.innerHTML = `
                    <div class="success">
                        <strong>✅ 全テスト成功 (${successCount}/${totalCount})</strong><br>
                        QuestionFlowクラスが正常に動作しています。
                    </div>
                `;
        } else {
          summaryElement.innerHTML = `
                    <div class="warning">
                        <strong>⚠️ 部分的成功 (${successCount}/${totalCount})</strong><br>
                        一部のテストで問題が発生しました。詳細を確認してください。
                    </div>
                `;
        }
      }

      function clearResults() {
        testResults = [];
        const testElements = [
          "classTest",
          "dataTest",
          "instanceTest",
          "functionTest",
          "testSummary",
        ];
        testElements.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.textContent = "未実行";
          }
        });

        // テストコンテナをクリア
        const testContainer = document.getElementById("test-container");
        if (testContainer) {
          testContainer.innerHTML = "<!-- QuestionFlowがここに表示される -->";
        }

        updateStatus("テスト準備中...");
      }

      // ページ読み込み完了後に初期状態を表示
      window.addEventListener("load", () => {
        updateStatus("テスト準備完了 - 実行ボタンをクリックしてください");

        // 自動的にクラステストを実行
        setTimeout(() => {
          runClassTest();
        }, 1000);
      });
    </script>
  </body>
</html>
