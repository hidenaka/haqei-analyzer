<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>包括的変化パターンエンジン - テスト＆デモ</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            padding: 30px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }
        
        .header {
            text-align: center;
            margin-bottom: 40px;
        }
        
        .title {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
            margin-bottom: 30px;
        }
        
        .control-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .input-group {
            background: rgba(255, 255, 255, 0.1);
            padding: 20px;
            border-radius: 10px;
        }
        
        .input-group h3 {
            margin-top: 0;
            color: #FFD700;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            margin-bottom: 15px;
        }
        
        input::placeholder, textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 30px 0;
        }
        
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            color: white;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .results-area {
            background: rgba(0, 0, 0, 0.3);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            min-height: 400px;
        }
        
        .pattern-card {
            background: rgba(255, 255, 255, 0.1);
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #FFD700;
        }
        
        .pattern-card.free {
            border-left-color: #4ECDC4;
        }
        
        .pattern-card.premium {
            border-left-color: #FF6B6B;
        }
        
        .pattern-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .pattern-description {
            margin-bottom: 15px;
            opacity: 0.9;
        }
        
        .pattern-details {
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
        
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4ECDC4;
        }
        
        .stat-label {
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .console-output {
            background: #000;
            color: #00ff00;
            padding: 20px;
            border-radius: 10px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .upgrade-notice {
            background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 class="title">包括的変化パターンエンジン</h1>
            <p class="subtitle">易経7変化パターンの完全実装 - bunenjin哲学対応</p>
        </div>
        
        <div class="control-panel">
            <div class="input-group">
                <h3>🎯 基本設定</h3>
                <label for="hexagram">卦番号 (1-64):</label>
                <input type="number" id="hexagram" min="1" max="64" value="29" placeholder="29 (坎為水)">
                
                <label for="changingLines">変爻 (1-6, カンマ区切り):</label>
                <input type="text" id="changingLines" value="2,5" placeholder="2,5">
                
                <label for="userType">ユーザータイプ:</label>
                <select id="userType">
                    <option value="free">無料版 (2パターン表示)</option>
                    <option value="premium">有料版 (全7パターン表示)</option>
                </select>
            </div>
            
            <div class="input-group">
                <h3>🎭 コンテキスト設定</h3>
                <label for="situation">状況:</label>
                <select id="situation">
                    <option value="general">一般的</option>
                    <option value="career_challenge">キャリアの課題</option>
                    <option value="relationship">人間関係</option>
                    <option value="life_change">人生の変化</option>
                    <option value="decision_making">意思決定</option>
                </select>
                
                <label for="urgency">緊急度:</label>
                <select id="urgency">
                    <option value="low">低</option>
                    <option value="moderate">中</option>
                    <option value="high">高</option>
                    <option value="critical">緊急</option>
                </select>
                
                <label for="timeframe">時間枠:</label>
                <select id="timeframe">
                    <option value="immediate">即座</option>
                    <option value="short_term">短期</option>
                    <option value="medium_term">中期</option>
                    <option value="long_term">長期</option>
                </select>
            </div>
        </div>
        
        <div class="button-group">
            <button onclick="calculatePatterns()" id="calculateBtn">🎯 7パターン計算実行</button>
            <button onclick="runQuickTest()">⚡ クイックテスト</button>
            <button onclick="runFullDemo()">🔍 フルデモ実行</button>
            <button onclick="runDiagnostics()">🩺 システム診断</button>
            <button onclick="clearResults()">🗑️ 結果クリア</button>
        </div>
        
        <div class="stats-panel" id="statsPanel" style="display: none;">
            <div class="stat-card">
                <div class="stat-value" id="responseTime">--</div>
                <div class="stat-label">応答時間 (ms)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="patternsCount">--</div>
                <div class="stat-label">計算パターン数</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="confidence">--</div>
                <div class="stat-label">信頼度 (%)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="cacheHit">--</div>
                <div class="stat-label">キャッシュヒット</div>
            </div>
        </div>
        
        <div class="results-area" id="resultsArea">
            <h3>🌟 計算結果</h3>
            <p>上記のボタンを押して7変化パターンの計算を実行してください。</p>
            
            <div id="patterns-container"></div>
            <div id="integration-results"></div>
            <div id="recommendations"></div>
        </div>
        
        <div class="console-output" id="consoleOutput" style="display: none;">
            <h4>🖥️ コンソール出力</h4>
            <div id="consoleContent"></div>
        </div>
    </div>

    <!-- 必要なスクリプトファイルの読み込み -->
    <script src="./js/core/IChingTransformationEngine.js"></script>
    <script src="./js/pages/future-simulator/ComprehensiveTransformationPatterns.js"></script>
    <script src="./js/pages/future-simulator/ComprehensiveTransformationPatterns-usage.js"></script>

    <script>
        // グローバル変数
        let transformationEngine = null;
        let consoleMessages = [];
        
        // ページ読み込み時の初期化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 包括的変化パターンエンジン テストページ初期化');
            
            try {
                // エンジン初期化
                transformationEngine = new ComprehensiveTransformationPatterns();
                
                // コンソール出力キャプチャ
                setupConsoleCapture();
                
                // 初期システム情報表示
                await displaySystemInfo();
                
                console.log('✅ 初期化完了');
                
            } catch (error) {
                console.error('❌ 初期化エラー:', error);
                showError('初期化に失敗しました: ' + error.message);
            }
        });
        
        // メインパターン計算実行
        async function calculatePatterns() {
            if (!transformationEngine) {
                showError('エンジンが初期化されていません');
                return;
            }
            
            const button = document.getElementById('calculateBtn');
            button.disabled = true;
            button.innerHTML = '<span class="loading"></span> 計算中...';
            
            try {
                // 入力データ収集
                const inputData = {
                    hexagram: parseInt(document.getElementById('hexagram').value),
                    changingLines: document.getElementById('changingLines').value
                        .split(',')
                        .map(s => parseInt(s.trim()))
                        .filter(n => n >= 1 && n <= 6),
                    userType: document.getElementById('userType').value,
                    context: {
                        situation: document.getElementById('situation').value,
                        urgency: document.getElementById('urgency').value,
                        timeframe: document.getElementById('timeframe').value
                    }
                };
                
                console.log('📊 入力データ:', inputData);
                
                // 計算実行
                const startTime = performance.now();
                const result = await transformationEngine.calculateAllPatterns(inputData);
                const responseTime = performance.now() - startTime;
                
                console.log('✅ 計算完了:', result);
                
                // 結果表示
                displayResults(result, responseTime);
                
                // 統計更新
                updateStats(result, responseTime);
                
            } catch (error) {
                console.error('❌ 計算エラー:', error);
                showError('計算エラー: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = '🎯 7パターン計算実行';
            }
        }
        
        // 結果表示
        function displayResults(result, responseTime) {
            const container = document.getElementById('patterns-container');
            container.innerHTML = '';
            
            if (result.error) {
                container.innerHTML = `<div class="pattern-card" style="border-left-color: #FF6B6B;">
                    <div class="pattern-name">❌ エラー</div>
                    <div class="pattern-description">${result.message}</div>
                    ${result.fallbackResult ? '<p>フォールバック結果を表示します。</p>' : ''}
                </div>`;
                return;
            }
            
            // 基本情報表示
            container.innerHTML = `
                <div class="pattern-card">
                    <div class="pattern-name">📊 計算概要</div>
                    <div class="pattern-description">
                        <strong>入力卦:</strong> 第${result.inputHexagram}卦<br>
                        <strong>変爻:</strong> ${result.changingLines.join(', ') || 'なし'}<br>
                        <strong>ユーザータイプ:</strong> ${result.userType}<br>
                        <strong>応答時間:</strong> ${responseTime.toFixed(2)}ms<br>
                        <strong>信頼度:</strong> ${(result.confidence * 100).toFixed(1)}%
                    </div>
                </div>
            `;
            
            // 無料版の場合のアップグレード案内
            if (result.userType === 'free' && result.hiddenPatternsCount > 0) {
                container.innerHTML += `
                    <div class="upgrade-notice">
                        💎 ${result.hiddenPatternsCount}個の追加パターンが有料版で利用可能です<br>
                        ${result.upgradeMessage}
                    </div>
                `;
            }
            
            // パターン結果表示
            if (result.patterns && result.patterns.length > 0) {
                result.patterns.forEach(pattern => {
                    const cardClass = pattern.displayInFree ? 'free' : 'premium';
                    const visibilityIcon = pattern.displayInFree ? '🆓' : '💎';
                    
                    container.innerHTML += `
                        <div class="pattern-card ${cardClass}">
                            <div class="pattern-name">${visibilityIcon} ${pattern.name} (${pattern.pattern})</div>
                            <div class="pattern-description">${pattern.description}</div>
                            <div class="pattern-details">
                                ${JSON.stringify(pattern, null, 2)}
                            </div>
                        </div>
                    `;
                });
            }
            
            // 統合結果表示
            if (result.integration) {
                document.getElementById('integration-results').innerHTML = `
                    <div class="pattern-card">
                        <div class="pattern-name">🔗 統合分析結果</div>
                        <div class="pattern-description">
                            <strong>支配的パターン:</strong> ${result.integration.dominantPattern?.name || 'なし'}<br>
                            <strong>パターン調和度:</strong> ${((result.integration.patternHarmony || 0) * 100).toFixed(1)}%
                        </div>
                        <div class="pattern-details">
                            ${JSON.stringify(result.integration, null, 2)}
                        </div>
                    </div>
                `;
            }
            
            // 推奨事項表示
            if (result.recommendations && result.recommendations.length > 0) {
                document.getElementById('recommendations').innerHTML = `
                    <div class="pattern-card">
                        <div class="pattern-name">💡 推奨事項</div>
                        <div class="pattern-description">
                            ${result.recommendations.map(r => `• ${r}`).join('<br>')}
                        </div>
                    </div>
                `;
            }
        }
        
        // 統計情報更新
        function updateStats(result, responseTime) {
            document.getElementById('statsPanel').style.display = 'grid';
            document.getElementById('responseTime').textContent = responseTime.toFixed(0);
            document.getElementById('patternsCount').textContent = result.patterns?.length || 0;
            document.getElementById('confidence').textContent = ((result.confidence || 0) * 100).toFixed(0);
            
            // キャッシュヒット情報取得
            if (transformationEngine) {
                const stats = transformationEngine.getStatistics();
                const cacheHitRate = (stats.performance.cacheHitRate * 100).toFixed(0);
                document.getElementById('cacheHit').textContent = cacheHitRate + '%';
            }
        }
        
        // クイックテスト実行
        async function runQuickTest() {
            console.log('⚡ クイックテスト開始');
            showConsole();
            
            try {
                const result = await quickTest();
                console.log('✅ クイックテスト完了:', result);
            } catch (error) {
                console.error('❌ クイックテストエラー:', error);
            }
        }
        
        // フルデモ実行
        async function runFullDemo() {
            console.log('🔍 フルデモ開始');
            showConsole();
            
            try {
                const demo = new TransformationPatternsDemo();
                await demo.runDemo();
                console.log('✅ フルデモ完了');
            } catch (error) {
                console.error('❌ フルデモエラー:', error);
            }
        }
        
        // システム診断実行
        async function runDiagnostics() {
            console.log('🩺 システム診断開始');
            showConsole();
            
            try {
                const diagnostics = await transformationEngine.runDiagnostics();
                console.log('診断結果:', diagnostics);
                
                // 診断結果を画面に表示
                const container = document.getElementById('patterns-container');
                container.innerHTML = `
                    <div class="pattern-card">
                        <div class="pattern-name">🩺 システム診断結果</div>
                        <div class="pattern-description">
                            <strong>システム健康状態:</strong> ${diagnostics.systemHealth}<br>
                            <strong>問題数:</strong> ${diagnostics.issues.length}
                        </div>
                        <div class="pattern-details">
                            ${JSON.stringify(diagnostics, null, 2)}
                        </div>
                    </div>
                `;
                
                console.log('✅ システム診断完了');
            } catch (error) {
                console.error('❌ システム診断エラー:', error);
            }
        }
        
        // システム情報表示
        async function displaySystemInfo() {
            if (!transformationEngine) return;
            
            const stats = transformationEngine.getStatistics();
            console.log('📊 システム情報:', stats);
        }
        
        // コンソール出力キャプチャ
        function setupConsoleCapture() {
            const originalLog = console.log;
            const originalError = console.error;
            const originalWarn = console.warn;
            
            console.log = function(...args) {
                originalLog.apply(console, args);
                addConsoleMessage('log', args.join(' '));
            };
            
            console.error = function(...args) {
                originalError.apply(console, args);
                addConsoleMessage('error', args.join(' '));
            };
            
            console.warn = function(...args) {
                originalWarn.apply(console, args);
                addConsoleMessage('warn', args.join(' '));
            };
        }
        
        // コンソールメッセージ追加
        function addConsoleMessage(type, message) {
            consoleMessages.push({
                type,
                message,
                timestamp: new Date().toLocaleTimeString()
            });
            
            // 最新100件に制限
            if (consoleMessages.length > 100) {
                consoleMessages = consoleMessages.slice(-100);
            }
            
            updateConsoleDisplay();
        }
        
        // コンソール表示更新
        function updateConsoleDisplay() {
            const content = document.getElementById('consoleContent');
            if (!content) return;
            
            content.innerHTML = consoleMessages.map(msg => {
                const color = msg.type === 'error' ? '#ff6b6b' : 
                            msg.type === 'warn' ? '#ffa500' : '#00ff00';
                return `<div style="color: ${color};">[${msg.timestamp}] ${msg.message}</div>`;
            }).join('');
            
            content.scrollTop = content.scrollHeight;
        }
        
        // コンソール表示切り替え
        function showConsole() {
            document.getElementById('consoleOutput').style.display = 'block';
        }
        
        // 結果クリア
        function clearResults() {
            document.getElementById('patterns-container').innerHTML = '';
            document.getElementById('integration-results').innerHTML = '';
            document.getElementById('recommendations').innerHTML = '';
            document.getElementById('statsPanel').style.display = 'none';
            document.getElementById('consoleOutput').style.display = 'none';
            consoleMessages = [];
            
            console.log('🗑️ 結果をクリアしました');
        }
        
        // エラー表示
        function showError(message) {
            const container = document.getElementById('patterns-container');
            container.innerHTML = `
                <div class="pattern-card" style="border-left-color: #FF6B6B;">
                    <div class="pattern-name">❌ エラー</div>
                    <div class="pattern-description">${message}</div>
                </div>
            `;
        }
    </script>
</body>
</html>