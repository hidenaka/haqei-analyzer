<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    
    <title>ÊòìÁµåÊú™Êù•ÂàÜÊûê„Ç∑„Çπ„ÉÜ„É† - 384„Éë„Çø„Éº„É≥Áä∂Ê≥ÅÂàÜÊûê</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>Êòì</text></svg>"
    />
    
    <!-- Load critical path scripts -->
    <link href="./css/tailwind.css" rel="stylesheet">
    
    <!-- Browser Compatibility Layer -->
    <script src="./js/core/BrowserCompatibility.js"></script>
<script src="./js/core/HUDManager.js"></script>
    
    <!-- Version and Monitoring -->
    <script>
        window.HAQEI_CONFIG = {
            appVersion: 'v4.3.1',
            rngSeed: 12345,
            kwMapSha256: 'pending',
            featureFlags: {
                enableAnalysis: true,
                enableSharing: false,
                enableAnimation: false
            }
        };
    </script>
    
    
    
    <!-- Quality Enhancement System -->
    <link rel="stylesheet" href="./css/quality-grade-enhancement.css">
    <!-- Future Branching Visual Design System -->
    <link rel="stylesheet" href="./css/future-branching-design.css">
    <!-- Objective Analysis UI System -->
    <link rel="stylesheet" href="./css/objective-analysis-ui.css">
    
    <!-- Unified Design System (ÊúÄÂæå„Å´Ë™≠„ÅøËæº„Åø) -->
    <link rel="stylesheet" href="css/haqei-unified-design.css" />
    
    <!-- „ÉÄ„Éº„ÇØ„É¢„Éº„ÉâÁÑ°ÂäπÂåñ„Å®Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥Âº∑Âà∂ÈÅ©Áî® -->
    <style>
      /* Áµ±‰∏Ä„Éá„Ç∂„Ç§„É≥„Ç∑„Çπ„ÉÜ„É†„ÅÆÂº∑Âà∂ÈÅ©Áî® */
      body {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
      }
      
      /* „ÉÄ„Éº„ÇØ„É¢„Éº„Éâ„ÇØ„É©„Çπ„ÅÆÁÑ°ÂäπÂåñ */
      .bg-gray-900 { background: var(--bg-primary) !important; }
      .bg-gray-800 { background: var(--bg-secondary) !important; }
      .bg-gray-700 { background: var(--bg-tertiary) !important; }
      .text-gray-200 { color: var(--text-primary) !important; }
      .text-gray-300 { color: var(--text-secondary) !important; }
      .text-gray-400 { color: var(--text-tertiary) !important; }
      
      /* „Ç´„Éº„Éâ„Å®„Çª„ÇØ„Ç∑„Éß„É≥„ÅÆÁµ±‰∏Ä */
      .section-container {
        background: var(--bg-primary) !important;
        border: 1px solid var(--border-default) !important;
        box-shadow: var(--shadow-md) !important;
      }
      
      /* „Éú„Çø„É≥„ÅÆÁµ±‰∏Ä */
      .btn-primary {
        background: var(--gradient-primary) !important;
        color: white !important;
      }
      
      /* „Ç®„É©„Éº„É°„ÉÉ„Çª„Éº„Ç∏„ÅÆÁµ±‰∏Ä */
      .error-message {
        background: var(--error-bg) !important;
        border: 1px solid var(--error-border) !important;
        color: var(--error-text) !important;
      }
    </style>
    <!-- ‰ª•‰∏ã„ÅÆ„Éï„Ç°„Ç§„É´„ÅØÁèæÂú®ÈñãÁô∫‰∏≠„ÅÆ„Åü„ÇÅ‰∏ÄÊôÇÁöÑ„Å´„Ç≥„É°„É≥„Éà„Ç¢„Ç¶„Éà -->
    <!-- <script src="./js/quality-enhancement-ui.js" defer></script> -->
    <!-- <script src="./js/dynamic-quality-optimizer.js" defer></script> -->
    <!-- <script src="./js/quality-integration-manager.js" defer></script> -->
    <!-- <script src="./js/quality-system-validator.js" defer></script> -->
    
    <!-- 384Áàª„Ç∑„Çπ„ÉÜ„É† D1„Éá„Éº„Çø„Éô„Éº„ÇπÁµ±Âêà -->
    <script src="./js/services/384DataService.js"></script>
    <script src="./js/ai/TextTo384LinesBridge.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Basic Reset and Body Styles for file:// protocol compatibility */
      * {
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        padding: 0;
        background-color: #0f172a;
        color: #ffffff;
        font-family: "Inter", "Noto Sans JP", sans-serif;
        line-height: 1.6;
        min-height: 100vh;
      }
      
      /* HAQEI Card Styles */
      .haqei-card {
        background-color: #1e293b;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 0.5rem 0;
        transition: all 0.3s ease;
      }
      
      .haqei-card:hover {
        border-color: #6366f1;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
      }
      
      /* HAQEI Button Styles */
      .haqei-button,
      button {
        background-color: #2563eb;
        color: #ffffff;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        font-weight: 500;
      }
      
      .haqei-button:hover,
      button:hover {
        background-color: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }
      
      /* HAQEI Input Styles */
      .haqei-input,
      input,
      textarea {
        background-color: #334155;
        border: 1px solid #475569;
        color: #ffffff;
        padding: 0.5rem;
        border-radius: 0.5rem;
        width: 100%;
        font-size: 1rem;
        line-height: 1.5;
      }
      
      .haqei-input:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      
      /* Container and Layout */
      .max-w-7xl {
        max-width: 80rem;
      }
      
      .mx-auto {
        margin-left: auto;
        margin-right: auto;
      }
      
      .w-full {
        width: 100%;
      }
      
      /* Background Colors */
      .bg-gray-900 {
        background-color: #111827;
      }
      
      .bg-gray-800 {
        background-color: #1f2937;
      }
      
      .bg-gray-700 {
        background-color: #374151;
      }
      
      .bg-teal-600 {
        background-color: #0d9488;
      }
      
      .bg-teal-700 {
        background-color: #0f766e;
      }
      
      /* Text Colors */
      .text-gray-200 {
        color: #e5e7eb;
      }
      
      .text-gray-300 {
        color: #d1d5db;
      }
      
      .text-gray-400 {
        color: #9ca3af;
      }
      
      .text-white {
        color: #ffffff;
      }
      
      .text-indigo-300 {
        color: #a5b4fc;
      }
      
      .text-yellow-300 {
        color: #fde047;
      }
      
      .text-blue-300 {
        color: #93c5fd;
      }
      
      .text-emerald-300 {
        color: #6ee7b7;
      }
      
      /* Padding and Margins */
      .p-4 {
        padding: 1rem;
      }
      
      .p-6 {
        padding: 1.5rem;
      }
      
      .p-8 {
        padding: 2rem;
      }
      
      .py-3 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
      
      .px-6 {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
      
      .mb-2 {
        margin-bottom: 0.5rem;
      }
      
      .mb-3 {
        margin-bottom: 0.75rem;
      }
      
      .mb-4 {
        margin-bottom: 1rem;
      }
      
      .mb-6 {
        margin-bottom: 1.5rem;
      }
      
      .mb-8 {
        margin-bottom: 2rem;
      }
      
      .mt-2 {
        margin-top: 0.5rem;
      }
      
      /* Border Radius */
      .rounded-lg {
        border-radius: 0.5rem;
      }
      
      .rounded-xl {
        border-radius: 0.75rem;
      }
      
      .rounded-2xl {
        border-radius: 1rem;
      }
      
      /* Shadows */
      .shadow-2xl {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }
      
      /* Flexbox */
      .flex {
        display: flex;
      }
      
      .items-center {
        align-items: center;
      }
      
      .justify-center {
        justify-content: center;
      }
      
      .gap-2 {
        gap: 0.5rem;
      }
      
      /* Grid */
      .grid {
        display: grid;
      }
      
      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
      
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      
      .grid-cols-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
      
      .gap-4 {
        gap: 1rem;
      }
      
      .gap-8 {
        gap: 2rem;
      }
      
      /* Typography */
      .text-sm {
        font-size: 0.875rem;
      }
      
      .text-base {
        font-size: 1rem;
      }
      
      .text-lg {
        font-size: 1.125rem;
      }
      
      .text-xl {
        font-size: 1.25rem;
      }
      
      .text-2xl {
        font-size: 1.5rem;
      }
      
      .text-3xl {
        font-size: 1.875rem;
      }
      
      .text-4xl {
        font-size: 2.25rem;
      }
      
      .font-bold {
        font-weight: 700;
      }
      
      .font-semibold {
        font-weight: 600;
      }
      
      .text-center {
        text-align: center;
      }
      
      /* Positioning */
      .relative {
        position: relative;
      }
      
      .absolute {
        position: absolute;
      }
      
      .fixed {
        position: fixed;
      }
      
      .top-0 {
        top: 0;
      }
      
      .right-0 {
        right: 0;
      }
      
      .left-0 {
        left: 0;
      }
      
      .bottom-0 {
        bottom: 0;
      }
      
      /* Display */
      .hidden {
        display: none;
      }
      
      .block {
        display: block;
      }
      
      /* Opacity */
      .opacity-0 {
        opacity: 0;
      }
      
      .opacity-50 {
        opacity: 0.5;
      }
      
      /* Transitions */
      .transition {
        transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
      }
      
      .duration-300 {
        transition-duration: 300ms;
      }
      
      /* Animation keyframes */
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      
      /* Card hover effects */
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      
      .card:hover {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      
      /* Gradients */
      .bg-gradient-to-br {
        background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
      }
      
      .from-blue-900\/20 {
        --tw-gradient-from: rgba(30, 58, 138, 0.2);
        --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(30, 58, 138, 0));
      }
      
      .to-indigo-900\/20 {
        --tw-gradient-to: rgba(49, 46, 129, 0.2);
      }
      
      .from-emerald-900\/20 {
        --tw-gradient-from: rgba(6, 78, 59, 0.2);
        --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(6, 78, 59, 0));
      }
      
      .to-teal-900\/20 {
        --tw-gradient-to: rgba(19, 78, 74, 0.2);
      }
      
      /* Border styles */
      .border {
        border-width: 1px;
      }
      
      .border-gray-600 {
        border-color: #4b5563;
      }
      
      .border-gray-700 {
        border-color: #374151;
      }
      
      .border-blue-500\/30 {
        border-color: rgba(59, 130, 246, 0.3);
      }
      
      .border-emerald-500\/30 {
        border-color: rgba(16, 185, 129, 0.3);
      }
      
      .hover\:border-blue-400:hover {
        border-color: #60a5fa;
      }
      
      .hover\:border-emerald-400:hover {
        border-color: #34d399;
      }
      
      /* Responsive design */
      @media (max-width: 640px) {
        .sm\:p-6 {
          padding: 1.5rem;
        }
        
        .sm\:text-4xl {
          font-size: 2.25rem;
        }
        
        .sm\:grid-cols-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      
      @media (min-width: 1024px) {
        .lg\:col-span-1 {
          grid-column: span 1 / span 1;
        }
        
        .lg\:col-span-2 {
          grid-column: span 2 / span 2;
        }
        
        .lg\:grid-cols-3 {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        
        .lg\:grid-cols-4 {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }
      
      /* Specific component styles */
      .tracking-wider {
        letter-spacing: 0.05em;
      }
      
      .inline-block {
        display: inline-block;
      }
      
      .space-y-4 > * + * {
        margin-top: 1rem;
      }
      
      .space-y-3 > * + * {
        margin-top: 0.75rem;
      }
      
      /* SVG icon sizing */
      .h-6 {
        height: 1.5rem;
      }
      
      .w-6 {
        width: 1.5rem;
      }
      
      .h-5 {
        height: 1.25rem;
      }
      
      .w-5 {
        width: 1.25rem;
      }
      
      .h-4 {
        height: 1rem;
      }
      
      .w-4 {
        width: 1rem;
      }
      
      /* Focus styles */
      .focus\:ring-indigo-500:focus {
        --tw-ring-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      
      .focus\:border-indigo-500:focus {
        border-color: #6366f1;
      }
      
      /* Utility classes */
      .min-h-screen {
        min-height: 100vh;
      }
      
      .items-start {
        align-items: flex-start;
      }
      
      /* Text truncation */
      .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      /* Background opacity utilities */
      .bg-gray-900\/50 {
        background-color: rgba(17, 24, 39, 0.5);
      }
      
      .bg-gray-900\/30 {
        background-color: rgba(17, 24, 39, 0.3);
      }
      
      .bg-gray-800\/50 {
        background-color: rgba(31, 41, 55, 0.5);
      }
      
      /* Border opacity utilities */
      .border-gray-600\/50 {
        border-color: rgba(75, 85, 99, 0.5);
      }
      
      .border-gray-700\/50 {
        border-color: rgba(55, 65, 81, 0.5);
      }
      
      /* Backdrop utilities for loading screen */
      .backdrop-filter {
        backdrop-filter: blur(10px);
      }
      
      /* Z-index utilities */
      .z-50 {
        z-index: 50;
      }
      
      .z-1000 {
        z-index: 1000;
      }
      
      .z-9999 {
        z-index: 9999;
      }
      
      /* Flex utilities */
      .flex-wrap {
        flex-wrap: wrap;
      }
      
      .gap-3 {
        gap: 0.75rem;
      }
      
      /* Hover effects for buttons */
      .hover\:bg-teal-700:hover {
        background-color: #0f766e;
      }
      
      .hover\:text-white:hover {
        color: #ffffff;
      }
      
      /* Transform utilities */
      .transform {
        transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
      }
      
      .-translate-x-1\/2 {
        --tw-translate-x: -50%;
      }
      
      .translate-x-1\/2 {
        --tw-translate-x: 50%;
      }
      
      /* Additional specific styles for the application */
      .brand-text {
        background: linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        color: transparent;
      }
      
      /* Additional HAQEI component styles */
      
      /* Enhanced Progressive Loading Styles */
      .skeleton {
        background: linear-gradient(90deg, rgba(55, 65, 81, 0.1) 25%, rgba(75, 85, 99, 0.2) 37%, rgba(55, 65, 81, 0.1) 63%);
        background-size: 400% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
      }
      
      @keyframes skeleton-loading {
        0% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .skeleton-text {
        height: 1em;
        border-radius: 4px;
        margin: 0.5em 0;
      }
      
      .skeleton-button {
        height: 3em;
        border-radius: 8px;
        width: 100%;
      }
      
      .skeleton-card {
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .skeleton-chart {
        height: 300px;
        border-radius: 8px;
      }
      
      .fade-in {
        animation: fadeIn 0.6s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(17, 24, 39, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(10px);
      }
      
      .loading-content {
        text-align: center;
        max-width: 400px;
        padding: 2rem;
        background: rgba(30, 41, 59, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(99, 102, 241, 0.3);
      }
      
      .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(165, 180, 252, 0.3);
        border-left: 4px solid #a5b4fc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      
      .loading-text {
        color: #a5b4fc;
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }
      
      .progress-container {
        margin-top: 1rem;
      }
      
      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(55, 65, 81, 0.5);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #a855f7);
        border-radius: 4px;
        transition: width 0.3s ease;
        position: relative;
      }
      
      .progress-percentage {
        color: #cbd5e1;
        font-size: 0.875rem;
        text-align: center;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Enhanced Mobile Optimizations */
      @media (max-width: 768px) {
        .loading-content {
          margin: 1rem;
          padding: 1.5rem;
        }
        
        .loading-text {
          font-size: 1rem;
        }
      }
      
      /* Accessibility Enhancements */
      @media (prefers-reduced-motion: reduce) {
        .skeleton {
          animation: none;
        }
        
        .loading-spinner {
          animation: none;
          border-left-color: rgba(165, 180, 252, 0.8);
        }
        
        .fade-in {
          animation: none;
        }
      }
      
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      .card:hover,
      .card.highlighted {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      .rank-badge {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 9999px;
        line-height: 1;
      }
      .rank-s,
      .rank-a,
      .rank-b,
      .rank-c {
        background-color: rgba(74, 222, 128, 0.2);
        color: #86efac;
      }

      /* Metrics Panel Styles */
      #metrics-panel {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: rgba(31, 41, 55, 0.9);
        border-radius: 8px;
        padding: 1rem;
        width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 1000;
        transition: opacity 0.3s ease;
      }
      #metrics-panel.hidden {
        opacity: 0;
        pointer-events: none;
      }
      .metric-item {
        display: flex;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        color: #cbd5e1;
      }
      .metric-warning {
        color: #ef4444;
        font-weight: bold;
      }
      #metrics-toggle {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: #6366f1;
        color: white;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 1001;
      }
      
      /* Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ„ÅÆ„Çπ„Çø„Ç§„É´ */
      .collapsible-content {
        max-height: 1000px;
        overflow: hidden;
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        opacity: 1;
      }
      
      .collapsible-content.collapsed {
        max-height: 0;
        opacity: 0;
      }
      
      .section-container h3 {
        user-select: none;
      }
      
      .section-container h3:hover {
        background: rgba(99, 102, 241, 0.1);
        border-radius: 8px;
        padding: 8px;
        margin: -8px;
      }
      .rank-d {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #fbbf24;
      }
      .rank-e,
      .rank-f,
      .rank-g {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .rank-h {
        background-color: rgba(185, 28, 28, 0.2);
        color: #fca5a5;
        border: 1px solid #dc2626;
      }

      /* Data Export Styles removed as per user request */
      
      .progressive-load {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.6s ease;
      }
      
      .progressive-load.loaded {
        opacity: 1;
        transform: translateY(0);
      }

      /* üåü New Result Page Styles (2025-08-07 Renewal) */
      .result-container {
        padding: 2rem;
        background: #1a1f2e;
        min-height: 100vh;
      }
      
      .result-layout {
        display: grid;
        grid-template-columns: 30% 70%;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }
      
      /* Left Panel Styles */
      .analysis-summary-panel {
        background: #2d3748;
        border-radius: 12px;
        padding: 1.5rem;
        color: #f7fafc;
      }
      
      .current-position-card {
        background: rgba(45, 55, 72, 0.5);
        border: 2px solid #ffd700;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      
      .hexagram-highlight {
        color: #ffd700;
        font-weight: bold;
      }
      
      .panel-title {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: #cbd5e0;
      }
      
      .theme-description {
        margin-top: 0.5rem;
      }
      
      .theme-description p {
        margin: 0.5rem 0;
        font-size: 0.9rem;
        line-height: 1.5;
      }
      
      .theme-detail {
        color: #a0aec0;
        font-size: 0.85rem;
      }
      
      /* Score Display */
      .score-display {
        margin: 1.5rem 0;
      }
      
      .score-item {
        background: rgba(45, 55, 72, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .score-item label {
        display: block;
        font-size: 0.9rem;
        color: #a0aec0;
        margin-bottom: 0.5rem;
      }
      
      .score-value {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
      }
      
      .score-number {
        font-size: 2rem;
        font-weight: bold;
        color: #f7fafc;
      }
      
      .score-label {
        font-size: 1rem;
        color: #cbd5e0;
      }
      
      .score-note {
        font-size: 0.8rem;
        color: #718096;
        margin-top: 0.5rem;
      }
      
      /* Current Graph */
      .current-graph-container {
        margin: 1.5rem 0;
      }
      
      .current-graph-container h4 {
        font-size: 1rem;
        margin-bottom: 1rem;
        color: #cbd5e0;
      }
      
      /* I Ching Interpretation */
      .iching-interpretation {
        background: rgba(45, 55, 72, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1.5rem;
      }
      
      .iching-interpretation h4 {
        font-size: 0.9rem;
        color: #ffd700;
        margin-bottom: 1rem;
      }
      
      .interpretation-content {
        font-size: 0.85rem;
        line-height: 1.6;
        color: #cbd5e0;
      }
      
      .stage-title {
        font-weight: bold;
        color: #f7fafc;
        margin-bottom: 0.5rem;
      }
      
      .stage-description {
        line-height: 1.6;
        color: #e2e8f0;
        margin-bottom: 1rem;
      }
      
      .stage-advice {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(99, 102, 241, 0.1);
        border-left: 3px solid #6366f1;
        color: #e0e7ff;
        font-size: 0.9rem;
        border-radius: 0.25rem;
      }
      
      /* Right Area Styles */
      .detailed-results-area {
        background: #2d3748;
        border-radius: 12px;
        padding: 1.5rem;
      }
      
      .section-title {
        font-size: 1.2rem;
        color: #e2e8f0;
        margin-bottom: 1rem;
      }
      
      /* Future Branching Graph */
      .future-branching-graph {
        margin-bottom: 2rem;
      }
      
      .graph-container {
        background: rgba(26, 31, 46, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      /* Theme Boxes */
      .theme-boxes {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      
      .theme-box {
        border-radius: 8px;
        padding: 1rem;
      }
      
      .progress-theme {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
        border: 1px solid #10b981;
      }
      
      .change-theme {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
        border: 1px solid #8b5cf6;
      }
      
      .theme-box h4 {
        color: #f7fafc;
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }
      
      .theme-content {
        font-size: 0.85rem;
        line-height: 1.5;
        color: #cbd5e0;
      }
      
      /* Eight Scenarios Grid */
      .eight-scenarios-grid {
        margin-top: 2rem;
      }
      
      .scenarios-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 1rem;
      }
      
      .scenario-card-new {
        background: rgba(45, 55, 72, 0.5);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
      }
      
      .scenario-card-new:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      .scenario-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      
      .scenario-rank {
        font-size: 1.5rem;
        font-weight: bold;
      }
      
      .rank-s { color: #ffd700; }
      .rank-a { color: #10b981; }
      .rank-b { color: #3b82f6; }
      .rank-c { color: #f59e0b; }
      .rank-d { color: #ef4444; }
      .rank-e { color: #8b5cf6; }
      .rank-f { color: #6b7280; }
      
      .scenario-score {
        font-size: 1.2rem;
        font-weight: bold;
        color: #f7fafc;
      }
      
      .scenario-name {
        font-size: 0.9rem;
        color: #cbd5e0;
        margin: 0.5rem 0;
      }
      
      .scenario-steps {
        font-size: 0.8rem;
        color: #a0aec0;
        margin: 0.5rem 0;
      }
      
      .scenario-mini-graph {
        margin-top: 0.5rem;
        height: 40px;
      }
      
      /* Responsive Design */
      @media (max-width: 1024px) {
        .result-layout {
          grid-template-columns: 1fr;
        }
        
        .scenarios-grid {
          grid-template-columns: repeat(2, 1fr);
          grid-template-rows: repeat(4, 1fr);
        }
      }
      
      @media (max-width: 640px) {
        .theme-boxes {
          grid-template-columns: 1fr;
        }
        
        .scenarios-grid {
          grid-template-columns: 1fr;
        }
      }
      
      /* üåü Authentic I Ching System Styles */
      .authentic-scenarios-container,
      .authentic-choice-container,
      .current-position-container {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }

      .scenario-card, .choice-card {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .scenario-card:hover, .choice-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        border-color: rgba(99, 102, 241, 0.7);
      }

      .scenario-card.selected, .choice-card.selected {
        border-color: #6366f1;
        background: rgba(99, 102, 241, 0.2);
      }

      .hexagram-line {
        display: flex;
        align-items: center;
        margin: 0.25rem 0;
        font-family: monospace;
      }

      .hexagram-line.yang .line-symbol {
        color: #fbbf24;
      }

      .hexagram-line.yin .line-symbol {
        color: #93c5fd;
      }

      .hexagram-line.current {
        background: rgba(245, 101, 101, 0.2);
        border-radius: 4px;
        padding: 0.25rem;
      }

      .transformation-visual {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 1rem 0;
      }

      .transformation-arrow {
        font-size: 1.5rem;
        color: #6366f1;
        margin: 0 1rem;
      }

      .HaQei-analysis .persona-analysis {
        background: rgba(31, 41, 55, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
      }

      .fade-in {
        opacity: 0;
        animation: fadeInUp 0.6s ease forwards;
      }

      .fade-in.visible {
        opacity: 1;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Phase 6-10 Enhancement Styles */
      .choice-selected {
        border-color: #10b981 !important;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3)) !important;
        transform: scale(1.02) !important;
      }
      
      .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      
      .animate-slide-up {
        animation: slideUp 0.3s ease-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes slideUp {
        from { 
          opacity: 0; 
          transform: translate(-50%, 20px); 
        }
        to { 
          opacity: 1; 
          transform: translate(-50%, 0); 
        }
      }
      
      #char-counter {
        transition: color 0.3s ease;
      }
      
      .export-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
      }
      
      .export-button:active {
        transform: translateY(0);
      }
      
      /* Input validation styles */
      .input-valid {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      }
      
      .input-invalid {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
      }
      
      /* Loading state improvements */
      .loading button {
        pointer-events: none;
        opacity: 0.7;
      }
      
      /* Scenario generation animations */
      /* 3ÊÆµÈöéÂ§âÂåñË°®Á§∫Áî®„Çπ„Çø„Ç§„É´ */
      .hexagram-transformation {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin: 1rem 0;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
      }
      
      .current-hexagram, .target-hexagram {
        font-weight: 600;
        color: #A5B4FC;
      }
      
      .transform-arrow {
        color: #10B981;
        font-size: 1.2rem;
      }
      
      .three-phase-container {
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
      }
      
      .three-phase-container h4 {
        color: #F59E0B;
        margin-bottom: 1rem;
        text-align: center;
      }
      
      .phase-block {
        margin: 1rem 0;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border-left: 3px solid;
      }
      
      .phase-1 { border-left-color: #3B82F6; }
      .phase-2 { border-left-color: #F59E0B; }
      .phase-3 { border-left-color: #10B981; }
      
      .phase-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      
      .phase-icon {
        font-size: 1.2rem;
      }
      
      .phase-name {
        font-weight: 600;
        color: #E0E7FF;
      }
      
      .score-indicator {
        margin: 0.5rem 0;
        font-size: 0.9rem;
        color: #A5B4FC;
      }
      
      .score-indicator .positive {
        color: #10B981;
      }
      
      .score-indicator .negative {
        color: #EF4444;
      }
      
      .final-score {
        font-weight: 600;
        color: #FDE047;
      }
      
      .phase-description {
        font-size: 0.85rem;
        line-height: 1.4;
        color: #CBD5E1;
        margin-top: 0.5rem;
      }
      
      .scenario-card {
        transition: all 0.3s ease;
      }
      
      .scenario-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(99, 102, 241, 0.2);
      }
      
      /* Progress indicators */
      .progress-indicator {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4);
        border-radius: 2px;
        transition: width 0.3s ease;
      }
    </style>
    
    <!-- Core System Assets - ÊúÄÈÅ©ÂåñË™≠„ÅøËæº„ÅøÈ†ÜÂ∫è -->
    <script src="./assets/H384H64database.js"></script>
    
    <!-- P0-2: Direct RandomnessManager Implementation (Final Solution) -->
    <script>
        console.log('[HAQEI][P0-2] Direct RandomnessManager initialization...');
        
        // Minimal but sufficient RandomnessManager implementation
        class DirectRandomnessManager {
            constructor() {
                this.seed = 12345;
                this.current = this.seed;
                console.log('[HAQEI][P0-2] ‚úÖ Direct RandomnessManager created');
            }
            
            // Linear congruential generator (simple but deterministic)
            next() {
                this.current = (this.current * 1664525 + 1013904223) % Math.pow(2, 32);
                return this.current / Math.pow(2, 32);
            }
            
            getGenerator(type = 'deterministic') {
                return {
                    next: () => this.next(),
                    nextInt: (min, max) => Math.floor(this.next() * (max - min + 1)) + min,
                    seed: this.seed,
                    direct: true
                };
            }
            
            setState(state) {
                if (state && typeof state.current === 'number') {
                    this.current = state.current;
                }
            }
            
            getState() {
                return { current: this.current, seed: this.seed };
            }
        }
        
        // Set globals immediately and synchronously
        window.randomnessManager = new DirectRandomnessManager();
        window.DirectRandomnessManager = DirectRandomnessManager;
        
        console.log('[HAQEI][P0-2] RandomnessManager globals ready immediately');
        
        // For compatibility, also set as SeedableRandom equivalent
        window.SeedableRandom = class SeedableRandom {
            constructor(seed = 12345) {
                this.manager = new DirectRandomnessManager();
                this.manager.seed = seed;
                this.manager.current = seed;
            }
            
            next() { return this.manager.next(); }
            nextInt(min, max) { return this.manager.getGenerator().nextInt(min, max); }
        };
        
        console.log('[HAQEI][P0-2] ‚úÖ All randomness implementations ready');
    </script>
    
    <script src="./js/DataDrivenKeywordAnalyzer.js"></script>
    <script src="./js/ThreePhaseSystem.js"></script>
    <script src="./js/core/H384DatabaseConnector.js"></script>
    <script src="./js/core/IChingChoiceLogic.js"></script>
    <script src="./js/core/DynamicScenarioColorSystem.js"></script>
    <script src="./js/core/IChingGuidanceEngine.js"></script>
    <!-- ThreeStageVisualizer.js - ÁÑ°ÂäπÂåñ -->
    <script src="./js/components/ScoreVisualization.js"></script>
    <script src="./js/components/EightScenariosDisplay.js"></script>
    <script src="./js/components/ResultPageController.js"></script>
    <script src="./js/future-simulator-integration.js"></script>
    <script src="./js/core/PerformanceOptimizer.js"></script>
    <script src="./js/core/IChingTransformationEngine.js"></script>
    <script src="./js/core/FutureBranchingSystem.js"></script>
    <script src="./js/core/DataPersistenceManager.js"></script>
    <script src="./js/core/DataExportAPI.js"></script>
    <script src="./js/core/types.js"></script>
    <script src="./js/core/storage.js"></script>
    <script src="./js/core/charts.js"></script>
    <script src="./js/core/contract-integration.js"></script>
    
    <!-- H384_DATAË™≠„ÅøËæº„ÅøÈ†ÜÂ∫èÁ¢∫Ë™ç & DataDrivenAnalyzerÂàùÊúüÂåñ -->
    <script>
        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞„Å®„Åó„Å¶DataDrivenAnalyzer„Çí‰øùÊåÅ
        let dataAnalyzer = null;
        
        (function() {
            console.log('üîç H384_DATAË™≠„ÅøËæº„ÅøÈ†ÜÂ∫èÁ¢∫Ë™ç„ÇíÈñãÂßã...');
            
            if (typeof H384_DATA === 'undefined') {
                console.error('H384_DATA variable not found');
                console.warn('‚ö†Ô∏è  „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊ©üËÉΩ„ÇíË©¶Ë°å‰∏≠...');
                
                // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: window.H384_DATA„ÇíÁ¢∫Ë™ç
                if (typeof window.H384_DATA !== 'undefined') {
                    console.log('‚úÖ window.H384_DATA„Åã„Çâ„ÅÆ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÊàêÂäü');
                    window.H384_DATA = window.H384_DATA;
                } else {
                    console.error('Fallback mechanism unavailable');
                }
            } else {
                console.log('‚úÖ H384_DATAÂ§âÊï∞„ÅÆÂ≠òÂú®Á¢∫Ë™ç: ÊàêÂäü');
                
                // window.H384_DATA„Å∏„ÅÆ‰ª£ÂÖ•Á¢∫Ë™ç
                if (typeof window.H384_DATA === 'undefined') {
                    console.warn('‚ö†Ô∏è  window.H384_DATA„ÅåÊú™Ë®≠ÂÆö - Ëá™ÂãïË®≠ÂÆö„ÇíË©¶Ë°å');
                    try {
                        window.H384_DATA = H384_DATA;
                        console.log('‚úÖ window.H384_DATAËá™ÂãïË®≠ÂÆö: ÊàêÂäü');
                    } catch (error) {
                        console.error('window.H384_DATA setup error:', error);
                    }
                }
                
                // „Éá„Éº„ÇøÂÆåÂÖ®ÊÄß„ÅÆÂü∫Êú¨Á¢∫Ë™ç
                if (Array.isArray(window.H384_DATA) && window.H384_DATA.length === 386) {
                    console.log('‚úÖ H384_DATA„Éá„Éº„ÇøÂÆåÂÖ®ÊÄßÁ¢∫Ë™ç: ÊàêÂäü (386„Ç®„É≥„Éà„É™)');
                    
                    // DataDrivenKeywordAnalyzer„ÅÆÂàùÊúüÂåñ
                    if (typeof DataDrivenKeywordAnalyzer !== 'undefined') {
                        try {
                            dataAnalyzer = new DataDrivenKeywordAnalyzer(window.H384_DATA, {});
                            window.dataAnalyzer = dataAnalyzer; // „Ç∞„É≠„Éº„Éê„É´„Ç¢„ÇØ„Çª„ÇπÁî®
                            console.log('‚úÖ DataDrivenKeywordAnalyzerÂàùÊúüÂåñ: ÊàêÂäü');
                        } catch (error) {
                            console.error('DataDrivenKeywordAnalyzer initialization error:', error);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è DataDrivenKeywordAnalyzer„ÇØ„É©„Çπ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    }
                    
                    // Áî®‰πù„ÉªÁî®ÂÖ≠„Ç®„É≥„Éà„É™„ÅÆÁ¢∫Ë™ç
                    const youkuu = window.H384_DATA.find(item => item['ÈÄö„ÅóÁï™Âè∑'] === 7);
                    const yourikuu = window.H384_DATA.find(item => item['ÈÄö„ÅóÁï™Âè∑'] === 14);
                    
                    if (youkuu && yourikuu) {
                        console.log('‚úÖ Áî®‰πù„ÉªÁî®ÂÖ≠„Ç®„É≥„Éà„É™Á¢∫Ë™ç: ÊàêÂäü');
                        console.log(`   - Áî®‰πù: ${youkuu['Âç¶Âêç']} (${youkuu['Áàª']})`);
                        console.log(`   - Áî®ÂÖ≠: ${yourikuu['Âç¶Âêç']} (${yourikuu['Áàª']})`);
                    } else {
                        console.warn('‚ö†Ô∏è  Áî®‰πù„ÉªÁî®ÂÖ≠„Ç®„É≥„Éà„É™„Å´ÂïèÈ°å„Åå„ÅÇ„Çä„Åæ„Åô');
                    }
                } else {
                    console.error('H384_DATA format error:', {
                        isArray: Array.isArray(window.H384_DATA),
                        length: window.H384_DATA?.length
                    });
                }
            }
            
            console.log('üèÅ H384_DATAË™≠„ÅøËæº„ÅøÈ†ÜÂ∫èÁ¢∫Ë™çÂÆå‰∫Ü');
        })();
    </script>
    <script src="./js/keyword_expansion_engine.js"></script>
    <script src="./js/ml-integration.js" async defer></script>
    <!-- Offline-First Dictionary System -->
    <script src="./js/core/DictionaryManager.js" defer></script>
    <script src="./js/core/OfflineDetector.js" defer></script>
    <script src="./js/core/OfflineKuromojiInitializer.js" defer></script>
    <script src="./js/core/offline-kuromoji-integration.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js" defer></script>
    <!-- Advanced Analysis Dependencies -->
    <!-- Chart.js „É©„Ç§„Éñ„É©„É™Ë™≠„ÅøËæº„Åø -->
    <script src="./lib/chart.min.js"></script>
    <script src="./js/lib/chartjs-plugin-annotation.min.js"></script>
    <script src="./js/lib/ml-matrix.min.js"></script>
    <!-- Phase 2 Áµ±ÂêàË°®Áèæ„Ç®„É≥„Ç∏„É≥ -->
    <script src="./js/core/EnhancedH384DataExtractor.js"></script>
    <script src="./js/core/ExpressionVariationEngine.js"></script>
    <script src="./js/core/ExpressionQualityValidator.js"></script>
    
    <!-- üåü New Display System -->
    <script src="./js/future-simulator-expression.js"></script>
    <script src="./js/future-simulator-display.js"></script>
    
    <!-- Dynamic Analysis Components -->
    <script src="./js/pages/future-simulator/DynamicKeywordGenerator.js"></script>
    <script src="./js/pages/future-simulator/IntegratedAnalysisEngine.js"></script>
    <script src="./js/pages/future-simulator/MultiDimensionalContextAnalyzer.js"></script>
    <script src="./js/pages/future-simulator/SituationalContextEngine.js"></script>
    <script src="./js/pages/future-simulator/HexagramMappingEngine.js"></script>
    <script src="./js/pages/future-simulator/MetaphorGenerationEngine.js"></script>
    
    <!-- üåü Authentic I Ching System Components -->
    <script src="./js/core/AuthenticIChingEngine.js"></script>
    <script src="./js/components/CurrentPositionDisplay.js"></script>
    <script src="./js/components/AuthenticChoiceSystem.js"></script>
    <script src="./js/components/Authentic8ScenariosSystem.js"></script>
    <script src="./js/components/Authentic386YaoAnalyzer.js"></script>
    
    <!-- I Ching Integration System -->
    <script src="./js/iching-situation-analyzer.js"></script>
    <script src="./js/yao-transformation-simulator.js"></script>
    <script src="./js/iching-metaphor-display.js"></script>
    <!-- iching-future-simulator.js now loaded as ESM module below -->
    
    <!-- Global I Ching Simulator Factory -->
    <script>
      function getIChingSimulator() {
        if (window.ichingSimulator && window.ichingSimulator.isReady && window.ichingSimulator.isReady()) {
          return window.ichingSimulator;
        }
        return null;
      }
      window.getIChingSimulator = getIChingSimulator;
    </script>
    
    <!-- Future Simulator Core & Binary Tree System -->
    <script src="./js/future-simulator-core.js"></script>
    <script src="./js/core/BinaryTreeFutureEngine.js"></script>
    <!-- binary-tree-complete-display.js - ÁÑ°ÂäπÂåñÔºàinnerHTMLÂïèÈ°å„ÅÆ„Åü„ÇÅÔºâ -->
    
    <!-- v2.2.0: KingWenMapping 64Âç¶Áµ±Âêà„Ç∑„Çπ„ÉÜ„É† (ES Module Dynamic Loader) -->
    <!-- v2-module-loader temporarily disabled to debug export error -->
    <!-- <script type="module" src="./js/v2-module-loader.js"></script> -->
    
    <!-- 7Êó•Èñì„Éê„É™„Éá„Éº„Ç∑„Éß„É≥„Çπ„Éó„É™„É≥„Éà „Ç∑„Çπ„ÉÜ„É† -->
    <script src="./js/validation/ValidationMetrics.js"></script>
    <script src="./js/validation/EvidencePanel.js"></script>
    <script src="./js/validation/PersonaValidationSystem.js"></script>
    <script src="./js/validation/ValidationOrchestrator.js"></script>
    
    <!-- 8„Ç∑„Éä„É™„Ç™ÁîüÊàê„Ç∑„Çπ„ÉÜ„É† -->
    <script src="./js/pages/future-simulator/EightScenariosGenerator.js"></script>
    <script src="./js/pages/future-simulator/ScenariosDisplayUI.js"></script>
    
    <!-- Future Simulator UI Enhancement System -->
    <script src="./js/future-simulator-ui-enhancements.js" defer></script>
  </head>
  <body class="min-h-screen p-4 sm:p-6" data-progressive-load>
    <!-- Operational Monitoring Section -->
    <div id="logs-section" class="bg-gray-900/50 p-6 rounded-xl mb-4">
      <h2 class="text-lg font-bold text-indigo-300 mb-3">ÈÅãÁî®Áõ£Ë¶ñ„É≠„Ç∞</h2>
      <div id="log-output" class="bg-gray-700 border border-gray-600 text-white text-base rounded-lg p-3 mb-4" style="height: 200px; overflow-y: auto;"></div>
      <button id="connect-logs" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300">„É≠„Ç∞Êé•Á∂ö</button>
    </div>
    <script>
      document.getElementById('connect-logs').addEventListener('click', () => {
        const ws = new WebSocket('wss://logs.cloudflare.com/instant-logs'); // Replace with actual Cloudflare Instant Logs WebSocket URL
        ws.onmessage = (event) => {
          const logOutput = document.getElementById('log-output');
          logOutput.innerHTML += `<p>${event.data}</p>`;
          logOutput.scrollTop = logOutput.scrollHeight;
        };
      });
    </script>
    <!-- Loading Screen Completely Removed -->
    
    <div
      class="w-full max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8"
      id="main-container"
      style="opacity: 1;"
    >
      <header class="text-center mb-8 relative">
        <a href="./" class="inline-block">
          <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
            ÊòìÁµåÊú™Êù•ÂàÜÊûê„Ç∑„Çπ„ÉÜ„É†
          </h1>
          <p class="text-gray-400 mt-2 text-lg">384„Éë„Çø„Éº„É≥„Å´„Çà„ÇãÁä∂Ê≥ÅÂàÜÊûê„ÉÑ„Éº„É´</p>
          <div class="flex justify-center gap-6 mt-3 text-sm text-gray-500">
            <span>üìä ÊòìÁµå„Å´„Çà„ÇãÊú™Êù•ÂàÜÊûê</span>
            <span>üóÉÔ∏è ‰ºùÁµ±ÁöÑ„Å™ÊòìÁµå„Éë„Çø„Éº„É≥Ê¥ªÁî®</span>
            <span>‚è±Ô∏è Ë§áÊï∞„ÅÆÂ±ïÈñã„Éë„Çø„Éº„É≥„ÇíÊèêÁ§∫</span>
          </div>
        </a>
        <button
          id="helpBtn"
          class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.25l-2.536 2.39c-.832.786-1.464 1.49-1.464 2.36h.001M12 18h.01"
            />
          </svg>
        </button>
      </header>

      <!-- Input Section with Skeleton -->      
      <div class="bg-gray-900/50 p-6 rounded-xl mb-4 relative progressive-load" id="input-section">
        
        <!-- Actual Input Content -->
        <div class="input-content" id="input-content" style="display: block;">
          <h2 class="text-lg font-bold text-indigo-300 mb-3">
            1. AI„Å´„Çà„ÇãÁä∂Ê≥ÅÊé®Ê∏¨
          </h2>
        <div
          class="border border-gray-700 rounded-lg p-4 mb-4 text-sm text-gray-300 space-y-3"
        >
          <p class="text-base font-bold text-center text-indigo-300">
            AI„Å∏„ÅÆÊúÄÈ´ò„ÅÆ„ÄåÂë™Êñá„Äç„ÅØ„ÄÅ„ÅÇ„Å™„Åü„ÅÆ„Äå„ÅÇ„Çä„ÅÆ„Åæ„Åæ„ÅÆË®ÄËëâ„Äç„Åß„Åô
          </p>
          <p class="text-xs text-center text-gray-400">
            Êú™Êù•ÂàÜÂ≤êÂõ≥„ÅÆÁ≤æÂ∫¶„ÇíÈ´ò„ÇÅ„Çã„ÄÅ„Åü„Å£„Åü‰∏Ä„Å§„ÅÆÁßòË®£
          </p>
          <p>
            „Åì„Çå„Åã„Çâ„ÄÅ„ÅÇ„Å™„Åü„ÅÆÁèæÁä∂„Å®Ë™≤È°å„ÇíAI„Å´ÂÖ•Âäõ„Åó„Å¶„ÅÑ„Åü„Å†„Åç„Åæ„Åô„ÄÇ„Åù„ÅÆÈöõ„ÄÅ„Å©„ÅÜ„Åã<strong>„Äå‰∏äÊâã„Å™ÊñáÁ´†„ÇíÊõ∏„Åì„ÅÜ„Äç„Å®„Åó„Å™„ÅÑ„Åß„Åè„Å†„Åï„ÅÑ„ÄÇ</strong>AI„ÅØ„ÄÅÊï¥„Åà„Çâ„Çå„ÅüÊñáÁ´†„Çà„Çä„ÇÇ„ÄÅ„ÅÇ„Å™„Åü„ÅÆ<strong>„ÄåÁîü„ÅÆË®ÄËëâ„Äç</strong>„ÇíÊ±Ç„ÇÅ„Å¶„ÅÑ„Åæ„Åô„ÄÇ
          </p>
          <p>
            ÁÆáÊù°Êõ∏„Åç„Åß„ÇÇ„ÄÅÂøÉ„ÅÆ„Å§„Å∂„ÇÑ„Åç„Åß„ÇÇ„ÄÅË™∞„Åã„Å´ÊÑöÁó¥„Çí„Åì„Åº„Åô„Çà„ÅÜ„Å™Ë®ÄËëâ„Åß„ÇÇÊßã„ÅÑ„Åæ„Åõ„Çì„ÄÇ‰ªñ‰∫∫„Å´Ë¶ã„Åõ„Çã„Åü„ÇÅ„ÅÆÊñáÁ´†„Åß„ÅØ„Å™„Åè„ÄÅ<strong>„ÅÇ„Å™„ÅüËá™Ë∫´„ÅÆ„Åü„ÇÅ„ÅÆ„ÄåÊÄùËÄÉ„ÅÆ„É°„É¢„Äç</strong>„Å®„Åó„Å¶„ÄÅ„É™„É©„ÉÉ„ÇØ„Çπ„Åó„Å¶ÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ
          </p>
          <p>
            „Å™„Åú„Å™„Çâ„ÄÅAI„ÅØ„ÅÇ„Å™„Åü„ÅåÈÅ∏„Å∂‰∏Ä„Å§‰∏Ä„Å§„ÅÆÂçòË™û„ÄÅË°®Áèæ„ÅÆÊè∫„Çå„ÄÅÊÑüÊÉÖ„ÅÆ„Éã„É•„Ç¢„É≥„Çπ„Åã„Çâ„ÄÅ„ÅÇ„Å™„Åü„Å†„Åë„ÅÆ„ÄåÊÄùËÄÉ„ÅÆ„ÇØ„Çª„Äç„ÇÑ„ÄåÂøÉ„ÅÆÂãï„Åç„Äç„ÇíË™≠„ÅøÂèñ„Çã„Åã„Çâ„Åß„Åô„ÄÇ
          </p>
          <div class="pt-2">
            <p class="font-bold text-gray-200">„ÄêÂÖ•Âäõ„ÅÆ„Éí„É≥„Éà„Äë</p>
            <div
              class="mt-2 p-3 rounded-lg bg-red-900/20 border border-red-800/50"
            >
              <p class="font-bold">ÊÇ™„ÅÑ‰æã ‚ùå</p>
              <p class="text-xs italic mt-1">
                „ÄåÊñ∞Ë¶è„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆ„Éû„Éç„Ç∏„É°„É≥„Éà„Å´„Åä„ÅÑ„Å¶„ÄÅ‰∫∫ÁöÑ„É™„ÇΩ„Éº„Çπ„ÅÆ‰∏çË∂≥„Åå„Éú„Éà„É´„Éç„ÉÉ„ÇØ„Å®„Å™„Çä„ÄÅË®àÁîª„Å´ÈÅÖÂª∂„ÅåÁîü„Åò„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Äç
              </p>
              <p class="text-xs text-gray-400 mt-1">
                Ôºà„Åì„Çå„Åß„ÅØ„ÄÅAI„ÅØ‰∏ÄËà¨ÁöÑ„Å™„Éì„Ç∏„Éç„ÇπË™≤È°å„Å®„Åó„Å¶„Åó„ÅãÂàÜÊûê„Åß„Åç„Åæ„Åõ„ÇìÔºâ
              </p>
            </div>
            <div
              class="mt-2 p-3 rounded-lg bg-emerald-900/20 border border-emerald-800/50"
            >
              <p class="font-bold">ËâØ„ÅÑ‰æã ‚≠ï</p>
              <p class="text-xs italic mt-1">
                „ÄåÊñ∞„Åó„ÅÑ‰ªï‰∫ã„ÄÅ„Éû„Ç∏„Åß‰∫∫Ë∂≥„Çä„Å¶„Å™„ÅÑÔºÅA„Åï„Çì„ÅØÈ†ëÂºµ„Å£„Å¶„Åè„Çå„Å¶„Çã„Åë„Å©„ÄÅB„Åï„Çì„ÅØÂÖ®ÁÑ∂„ÇÑ„ÇãÊ∞ó„Å™„ÅÑ„Åó‚Ä¶„ÄÇ„Åì„ÅÆ„Åæ„Åæ„Å†„Å®Áµ∂ÂØæÈñì„Å´Âêà„Çè„Å™„ÅÑ„ÄÇ„Å©„ÅÜ„Åô„Çä„ÇÉ„ÅÑ„ÅÑ„Çì„Å†‚Ä¶„ÄÇÁÑ¶„Çã„ÄÇ„Äç
              </p>
              <p class="text-xs text-gray-400 mt-1">
                Ôºà„Åì„ÅÆÊñπ„Åå„ÄÅ„ÅÇ„Å™„Åü„ÅÆÊÑüÊÉÖ„ÄÅ‰∫∫ÈñìÈñ¢‰øÇ„Å∏„ÅÆË™çË≠ò„ÄÅÂàáËø´ÊÑü„Åå‰ºù„Çè„Çä„ÄÅ„Çà„Çä„Éë„Éº„ÇΩ„Éä„É©„Ç§„Ç∫„Åï„Çå„ÅüÂàÜÊûê„ÅåÂèØËÉΩ„Å´„Å™„Çä„Åæ„ÅôÔºâ
              </p>
            </div>
          </div>
          <p class="font-bold text-center pt-2">
            ÊòìÁµå„ÅÆ384„Éë„Çø„Éº„É≥Ôºà64Âç¶√ó6ÁàªÔºâ„Å´„Çà„ÇãÂÆ¢Ë¶≥ÁöÑÂàÜÊûê„Å´„Çà„Çä„ÄÅ<br />ÁèæÂú®„ÅÆÁä∂Ê≥Å„Åã„ÇâÂ∞é„Åã„Çå„Çã8„Å§„ÅÆÊú™Êù•ËªåÈÅì„ÇíÂèØË¶ñÂåñ„Åó„Åæ„Åô„ÄÇ
          </p>
        </div>
        
        <!-- „ÅÇ„Å™„Åü„ÅÆÊú™Êù•„ÇíË™≠„ÅøËß£„Åç„Åæ„Åô -->
        <div class="mb-6 text-center">
          <h3 class="text-xl font-bold text-indigo-300 mb-2">
            üìä ÊòìÁµå384„Éë„Çø„Éº„É≥„Å´„Çà„ÇãÁä∂Ê≥ÅÂàÜÊûê
          </h3>
          <p class="text-sm text-gray-400">
            ÊòìÁµå„ÅÆÁü•ÊÅµ„Å´Âü∫„Å•„Åè8„Å§„ÅÆÊú™Êù•ÂèØËÉΩÊÄß„ÇíÂàÜÊûê
          </p>
        </div>
        
        <textarea
          id="worryInput"
          class="bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 mb-4"
          rows="4"
          placeholder="ÁèæÂú®„ÅÆÁä∂Ê≥Å„ÇíÂÆ¢Ë¶≥ÁöÑ„Å´Ë®òËø∞„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºàËÅ∑Â†¥Áí∞Â¢É„ÄÅÈÅ∏ÊäûËÇ¢„ÄÅÂà∂Á¥ÑÊù°‰ª∂„ÄÅÊôÇÈñìËª∏„Å™„Å©Ôºâ"
        ></textarea>
        <button
            id="aiGuessBtn"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 flex items-center justify-center gap-2"
          >
            <svg class="animate-spin h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg
              id="originalIcon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                clip-rule="evenodd"
              />
            </svg>
            <span id="buttonText">ÂàÜÊûêÂÆüË°å</span>
          </button>
        </div>
      </div>


      <!-- Data Export Section removed as per user request -->

      <!-- ÊóßÁâàUIÂÆåÂÖ®ÂâäÈô§ÂÆå‰∫Ü (2025-08-07) -->
      
      <!-- üîÆ 384Áàª„Ç∑„Çπ„ÉÜ„É†ÂàÜÊûêÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥ -->
      <div id="lines384ResultSection" class="section-container" style="display: none; margin-top: 2rem;">
        <h3 class="text-xl font-bold mb-4 cursor-pointer hover:text-indigo-300 transition-colors" style="color: var(--text-primary);" onclick="toggleSection('lines384Content')">
          <span class="inline-block mr-2">üîÆ</span>384Áàª„Ç∑„Çπ„ÉÜ„É†ÂàÜÊûêÁµêÊûú
          <span id="lines384Toggle" class="ml-2 text-sm">‚ñº</span>
        </h3>
        <div id="lines384Content" class="collapsible-content">
        
        <div id="lines384Loading" class="text-center py-8" style="display: none;">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          <p class="mt-2" style="color: var(--text-secondary);">D1„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÂàÜÊûê‰∏≠...</p>
        </div>
        
        <div id="lines384Results" style="display: none;">
          <div class="bg-gradient-to-r from-purple-50 to-blue-50 p-6 rounded-lg shadow-lg">
            <div class="mb-4">
              <h4 class="text-lg font-semibold" style="color: var(--text-primary);">ÈÅ∏Êäû„Åï„Çå„ÅüÁàª</h4>
              <p id="selectedLineName" class="text-2xl font-bold mt-2" style="color: var(--primary-600);"></p>
              <p id="selectedLineHexagram" class="text-sm mt-1" style="color: var(--text-secondary);"></p>
            </div>
            
            <div class="mb-4">
              <h5 class="font-semibold mb-2" style="color: var(--text-primary);">Ëß£Èáà</h5>
              <p id="selectedLineDescription" class="leading-relaxed" style="color: var(--text-primary);"></p>
            </div>
            
            <div class="mb-4">
              <h5 class="font-semibold mb-2" style="color: var(--text-primary);">„Ç¢„Éâ„Éê„Ç§„Çπ</h5>
              <p id="selectedLineAdvice" class="leading-relaxed" style="color: var(--text-primary);"></p>
            </div>
            
            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
              <span class="text-sm" style="color: var(--text-tertiary);">
                ‰ø°È†ºÂ∫¶: <span id="lineConfidence" class="font-semibold"></span>
              </span>
              <span class="text-sm" style="color: var(--text-tertiary);">
                „Éá„Éº„Çø„ÇΩ„Éº„Çπ: <span id="lineDataSource" class="font-semibold"></span>
              </span>
            </div>
          </div>
          
          <!-- Èñ¢ÈÄ£„Åô„ÇãÁàª -->
          <div id="relatedLines" class="mt-4" style="display: none;">
            <h5 class="font-semibold mb-2" style="color: var(--text-primary);">Èñ¢ÈÄ£„Åô„ÇãÁàª</h5>
            <div id="relatedLinesList" class="grid grid-cols-1 md:grid-cols-2 gap-2"></div>
          </div>
        </div>
        
        <div id="lines384Error" class="bg-red-50 border border-red-200 rounded-lg p-4" style="display: none;">
          <p class="text-red-700">
            <span class="font-semibold">„Ç®„É©„Éº:</span> 
            <span id="lines384ErrorMessage"></span>
          </p>
        </div>
        </div> <!-- lines384Content ÁµÇ‰∫Ü -->
      </div>
      
      <!-- üîØ I ChingËß£Èáà„Çª„ÇØ„Ç∑„Éß„É≥ -->
      <div id="ichingInterpretationSection" class="section-container" style="display: none; margin-top: 2rem;">
        <h3 class="text-xl font-bold mb-4 cursor-pointer hover:text-indigo-300 transition-colors" style="color: var(--text-primary);" onclick="toggleSection('ichingInterpretationContent')">
          <span class="inline-block mr-2">üîØ</span>ÊòìÁµåËß£Èáà
          <span id="ichingInterpretationToggle" class="ml-2 text-sm">‚ñº</span>
        </h3>
        <div id="ichingInterpretationContent" class="collapsible-content">
        
        <div id="ichingInterpretationLoading" class="text-center py-8" style="display: none;">
          <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"></div>
          <p class="mt-2" style="color: var(--text-secondary);">ÊòìÁµåËß£Èáà„ÇíÁîüÊàê‰∏≠...</p>
        </div>
        
        <div id="ichingInterpretationResults" style="display: none;">
          <div class="bg-gradient-to-r from-amber-50 to-orange-50 p-6 rounded-lg shadow-lg">
            <div class="mb-4">
              <h4 class="text-lg font-semibold" style="color: var(--text-primary);">ÊòìÁµå„ÉªÂ∞èË±°‰ºù„ÅåÁ§∫„Åô„ÄåÁèæÁä∂„ÅÆÁêÜÁî±„Äç(HaQeiÁèæ‰ª£Ëß£Èáà)</h4>
            </div>
            
            <div class="interpretation-content" id="iching-content">
              <p id="ichingStageTitle" class="stage-title text-lg font-bold mb-2" style="color: var(--primary-600);"></p>
              <p id="ichingStageDescription" class="stage-description leading-relaxed" style="color: var(--text-primary);"></p>
            </div>
            
            <div class="flex justify-between items-center mt-4 pt-4 border-t border-gray-200">
              <span class="text-sm" style="color: var(--text-tertiary);">
                Ëß£Èáà‰ø°È†ºÂ∫¶: <span id="ichingConfidence" class="font-semibold"></span>
              </span>
              <span class="text-sm" style="color: var(--text-tertiary);">
                „Éá„Éº„Çø„ÇΩ„Éº„Çπ: <span id="ichingDataSource" class="font-semibold">ÊòìÁµå„ÉªÂ∞èË±°‰ºù</span>
              </span>
            </div>
          </div>
        </div>
        
        <div id="ichingInterpretationError" class="bg-red-50 border border-red-200 rounded-lg p-4" style="display: none;">
          <p class="text-red-700">
            <span class="font-semibold">„Ç®„É©„Éº:</span> 
            <span id="ichingInterpretationErrorMessage"></span>
          </p>
        </div>
        </div> <!-- ichingInterpretationContent ÁµÇ‰∫Ü -->
      </div>
      
      <!-- üå∏ Êú™Êù•ÂàÜÊûêÁµêÊûú„Çª„ÇØ„Ç∑„Éß„É≥ -->
      <div id="resultsContainer" class="results-container" style="display: none; margin-top: 2rem;">
        <h3 class="text-xl font-bold mb-4 cursor-pointer hover:text-indigo-300 transition-colors" style="color: var(--text-primary);" onclick="toggleSection('resultsContent')">
          <span class="inline-block mr-2">üå∏</span>Êú™Êù•ÂàÜÊûêÁµêÊûú
          <span id="resultsToggle" class="ml-2 text-sm">‚ñº</span>
        </h3>
        <div id="resultsContent" class="collapsible-content">
        </div>
      </div>

      <!-- ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢ÔºöÂàÜÊûêÂÆüË°åÊôÇ„Å´ÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Åæ„Åô -->
      
      <!-- I-Ching Container for Future Simulator -->
      <div id="i-ching-container" class="mt-6"></div>
    </div>

    <!-- Module Script -->
    <script type="module">
      // üöÄ Emergency Fix: Minimal Working ProgressiveLoader
      class ProgressiveLoader {
        constructor() {
          this.progress = 0;
          this.analysisHistory = [];
          console.log('‚úÖ ProgressiveLoader initialized');
          this.init();
        }

        init() {
          setTimeout(() => {
            this.showInputForm();
            this.initializeEventListeners();
          }, 500);
        }

        showInputForm() {
          const inputContent = document.getElementById('input-content');
          const worryInput = document.getElementById('worryInput');
          
          if (inputContent) {
            inputContent.style.display = 'block';
            inputContent.style.opacity = '1';
            
            if (worryInput) {
              setTimeout(() => {
                worryInput.focus();
              }, 300);
            }
          }
        }

        initializeEventListeners() {
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          const worryInput = document.getElementById('worryInput');
          
          if (aiGuessBtn && worryInput) {
            // ÂàùÊúüÁä∂ÊÖã„Åß„Éú„Çø„É≥„ÇíÁÑ°ÂäπÂåñ
            aiGuessBtn.disabled = true;
            aiGuessBtn.setAttribute('disabled', 'disabled');
            
            // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„ÅÆÁõ£Ë¶ñ
            const updateButtonState = () => {
              const inputLength = worryInput.value.trim().length;
              if (inputLength >= 10) {
                aiGuessBtn.disabled = false;
                aiGuessBtn.removeAttribute('disabled');
                aiGuessBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                aiGuessBtn.classList.add('hover:bg-teal-700', 'cursor-pointer');
              } else {
                aiGuessBtn.disabled = true;
                aiGuessBtn.setAttribute('disabled', 'disabled');
                aiGuessBtn.classList.add('opacity-50', 'cursor-not-allowed');
                aiGuessBtn.classList.remove('hover:bg-teal-700', 'cursor-pointer');
              }
            };
            
            // ÂêÑÁ®ÆÂÖ•Âäõ„Ç§„Éô„É≥„Éà„ÅßÁä∂ÊÖãÊõ¥Êñ∞
            worryInput.addEventListener('input', updateButtonState);
            worryInput.addEventListener('keyup', updateButtonState);
            worryInput.addEventListener('paste', () => {
              setTimeout(updateButtonState, 10);
            });
            
            // „ÇØ„É™„ÉÉ„ÇØ„Ç§„Éô„É≥„Éà
            aiGuessBtn.addEventListener('click', () => {
              const inputText = worryInput.value.trim();
              if (inputText && inputText.length >= 10) {
                analyzeWorry(inputText);
              } else {
                showUserMessage('10ÊñáÂ≠ó‰ª•‰∏ä„ÅßÂÖ∑‰ΩìÁöÑ„Å™Áä∂Ê≥Å„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ', 'warning');
              }
            });
            
            // ÂàùÊúüÁä∂ÊÖã„ÇíË®≠ÂÆö
            updateButtonState();
            console.log('‚úÖ Button state management initialized');
          }
        }

        performAnalysis(inputText) {
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          
          if (aiGuessBtn) {
            aiGuessBtn.disabled = true;
            aiGuessBtn.textContent = 'ÂàÜÊûê‰∏≠...';
          }

          // System delegation to FutureSimulator.Core
          console.log('ProgressiveLoader.performAnalysis() delegating to FutureSimulator.Core');
          
          setTimeout(() => {
            // Binary Tree Analysis System„Å´ÂÆåÂÖ®ÂßîË≠≤
            if (window.FutureSimulator && window.FutureSimulator.Core) {
              console.log('‚úÖ Delegating to FutureSimulator.Core.startAnalysis()');
              // ÂÖ•Âäõ„Éï„Ç£„Éº„É´„Éâ„Å´ÂÄ§„ÇíË®≠ÂÆö„Åó„Å¶„Åã„ÇâFutureSimulator.Core„ÅÆÂàÜÊûê„ÇíÂÆüË°å
              const situationInput = document.getElementById('situation-input') || 
                                    document.querySelector('textarea[placeholder*="Áä∂Ê≥Å"]') ||
                                    document.querySelector('textarea');
              if (situationInput) {
                situationInput.value = inputText;
              }
              window.FutureSimulator.Core.startAnalysis();
            } else {
              console.error('FutureSimulator.Core not available - fallback disabled');
            }
            
            if (aiGuessBtn) {
              aiGuessBtn.disabled = false;
              aiGuessBtn.textContent = 'ÂàÜÊûêÂÆüË°å';
            }
          }, 100);
        }

        displayResults(inputText) {
          // Legacy displayResults disabled - delegating to BinaryTreeCompleteDisplay
          console.log('OLD displayResults() called but DISABLED - delegating to BinaryTreeCompleteDisplay');
          
          // Binary Tree Complete Display System„ÅåÁµêÊûúË°®Á§∫„ÇíÂÆåÂÖ®„Å´Âá¶ÁêÜ
          // „Åì„ÅÆÈñ¢Êï∞„ÅØ„ÇÇ„ÅØ„ÇÑÁµêÊûú„ÇíË°®Á§∫„Åõ„Åö„ÄÅ„É≠„Ç∞„ÅÆ„ÅøÂá∫Âäõ
          console.log('‚úÖ Results handled by BinaryTreeCompleteDisplay with H384 database integration');
        }

        // „Ç∑„Éä„É™„Ç™Êé®Â•®Â∫¶„ÇíË®àÁÆó
        calculateScenarioRecommendation(scenario, index) {
          // „Ç∑„Éä„É™„Ç™„Åî„Å®„Å´Áï∞„Å™„ÇãÊé®Â•®Â∫¶„ÇíË®àÁÆóÔºàÁ∞°ÊòìÁâàÔºâ
          const baseScores = [72, 68, 75, 71, 76, 73, 69, 74];
          const finalScore = baseScores[index] || (65 + ((index * 7) % 15));
          
          let color = '#60A5FA'; // „Éá„Éï„Ç©„É´„ÉàÈùí
          if (finalScore >= 75) color = '#fbbf24'; // ÈáëËâ≤
          else if (finalScore >= 70) color = '#10b981'; // Á∑ë
          
          return {
            score: Math.round(finalScore),
            color: color
          };
        }


        // „Ç∑„Éä„É™„Ç™Êé®Â•®Â∫¶„ÅÆÊ¶ÇË¶Å„ÇíË°®Á§∫
        renderScenarioRecommendations(scenarios) {
          return `
            <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 10px;">
              <h4 style="color: #A78BFA; margin: 0 0 10px 0;">
                üìä „Ç∑„Éä„É™„Ç™Êé®Â•®Â∫¶ÂàÜÊûê
              </h4>
              <p style="color: #E5E7EB; margin: 0 0 10px 0; font-size: 0.9rem;">
                ÂÖ•ÂäõÂÜÖÂÆπ„Åã„ÇâAI„ÅåÊúÄÈÅ©„Å™„Ç∑„Éä„É™„Ç™„ÇíÂàÜÊûê„Åó„Åæ„Åó„Åü
              </p>
              <p style="color: #9CA3AF; margin: 0; font-size: 0.85rem;">
                ÂêÑ„Ç∑„Éä„É™„Ç™„Å´„ÅØÊé®Â•®Â∫¶„ÅåË°®Á§∫„Åï„Çå„Åæ„Åô„ÄÇ80%‰ª•‰∏ä„ÅÆ„Ç∑„Éä„É™„Ç™„ÅØÁâπ„Å´„Åä„Åô„Åô„ÇÅ„Åß„Åô„ÄÇ
              </p>
            </div>
          `;
        }



        generateEnhancedScenarios() {
          // Fixed scenarios disabled - migrated to H384 database
          console.log('OLD generateEnhancedScenarios() called but DISABLED');
          console.log('‚úÖ Using H384 database integrated BinaryTreeFutureEngine instead');
          
          // BinaryTreeCompleteDisplay„ÅåÂÆüÈöõ„ÅÆH384„Éá„Éº„Çø„Åã„ÇâÂãïÁöÑÁîüÊàê„Åô„Çã„Åü„ÇÅ
          // „Åì„ÅÆÂõ∫ÂÆö„Ç∑„Éä„É™„Ç™„ÅØ‰ΩøÁî®„Åó„Å™„ÅÑ
          return [];
        }

        generateSimpleScenarios() {
          // Fixed scenarios disabled - H384 database integration complete
          console.log('OLD generateSimpleScenarios() called but DISABLED - H384 database now provides dynamic scenarios');
          return [];
        }
        
      }
      
      // Initialize ProgressiveLoader when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        console.log('üöÄ Emergency fix loading...');
        const loader = new ProgressiveLoader();
      });
      
      // Also initialize immediately if DOM is already loaded
      if (document.readyState !== 'loading') {
        console.log('üöÄ Emergency fix loading (immediate)...');
        const loader = new ProgressiveLoader();
      }
    </script>
    
    <!-- Additional Scripts -->
    <script>
      // Legacy support functions
      function ensureChartContainers() {
        console.log('üìä Chart containers initialized');
      }
      
      // 3„Éï„Çß„Éº„Ç∫ÈÄ≤Áàª„ÉªÂ§âÁàª„Ç∑„Çπ„ÉÜ„É†ÔºàÊ≠£„Åó„ÅÑ2¬≥=8„Éë„Çø„Éº„É≥ÁîüÊàêÔºâ
      function generateJingYaoHengYaoScenarios(inputText) {
        console.log('üîÆ 3„Éï„Çß„Éº„Ç∫„Ç∑„Çπ„ÉÜ„É†„Å´„Çà„Çã8„Éë„Çø„Éº„É≥ÁîüÊàêÈñãÂßã:', inputText.substring(0, 30));
        
        // È´òÂ∫¶„Å™ÂàÜÊûêÁµêÊûú„Çí‰ΩøÁî®
        const analysis = getAnalysisFromIntegrated();
        
        // ÂàùÊúüÂç¶„ÉªÁàªÈÅ∏ÂÆöÔºàÈ´òÂ∫¶ÂàÜÊûêÁµêÊûú„Åã„ÇâÔºâ
        const initial = selectInitialHexLine();
        const initialInfo = getHexagramInfo(initial.hex, initial.line);
        console.log(`üìä ÂàùÊúüÁä∂ÊÖã: ${initialInfo.hexName}„Éª${initialInfo.lineName}„Äå${initialInfo.keywords[0] || ''}„Äç`);
        
        // 3„Éï„Çß„Éº„Ç∫„Ç∑„Çπ„ÉÜ„É†„Åß8„Éë„Çø„Éº„É≥ÁîüÊàê
        const scenarios = generateThreePhaseScenarios(initial.hex, initial.line, analysis, inputText);
        
        console.log(`‚úÖ 8„Éë„Çø„Éº„É≥ÁîüÊàêÂÆå‰∫Ü (JJJ, JJH, JHJ, JHH, HJJ, HJH, HHJ, HHH)`);
        return scenarios;
      }
      
      // È´òÂ∫¶„Å™ÂàÜÊûêÁµêÊûú„Åã„ÇâÂç¶Ë±°„ÇíÂèñÂæóÔºàÁ∞°ÊòìÁâà„ÅØÂâäÈô§Ôºâ
      function getAnalysisFromIntegrated() {
        if (window.integratedAnalysisResult && window.integratedAnalysisResult.context) {
          return window.integratedAnalysisResult.context;
        }
        // Áµ±ÂêàÂàÜÊûêÁµêÊûú„Åå„Å™„ÅÑÂ†¥Âêà„ÅØÁ©∫„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà
        return {};
      }
      
      // È´òÂ∫¶„Å™ÂàÜÊûêÁµêÊûú„Åã„ÇâÂàùÊúüÂç¶„ÉªÁàª„ÇíÂèñÂæó
      function selectInitialHexLine() {
        // Áµ±ÂêàÂàÜÊûêÁµêÊûú„ÇíÂÑ™ÂÖà‰ΩøÁî®
        if (window.integratedAnalysisResult && window.integratedAnalysisResult.iching) {
          const { hexagram, yao } = window.integratedAnalysisResult.iching;
          if (hexagram && yao) {
            console.log('‚úÖ È´òÂ∫¶ÂàÜÊûêÁµêÊûú„Çí‰ΩøÁî®:', hexagram.name, yao.name);
            return {
              hex: hexagram.number || 1,
              line: yao.position || 1
            };
          }
        }
        
        // ÂàÜÊûêÁµêÊûú„Åå„Å™„ÅÑÂ†¥Âêà„ÅÆ„Åø„Éá„Éï„Ç©„É´„ÉàÂÄ§
        console.log('‚ö†Ô∏è È´òÂ∫¶ÂàÜÊûêÁµêÊûú„Å™„Åó„ÄÅ„Éá„Éï„Ç©„É´„ÉàÂÄ§‰ΩøÁî®');
        return { hex: 1, line: 1 };
      }
      
      // ÊòìÁµå„ÅÆÁü•ÊÅµ„Åã„ÇâÁä∂Ê≥Å„ÅÆÁ∂ôÁ∂öÊÄß„ÇíË™¨Êòé„Åô„ÇãÈñ¢Êï∞
      function getThematicConnection(prevKeyword, nextKeyword) {
        // „Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÊÑèÂë≥„Ç´„ÉÜ„Ç¥„É™„ÇíÂàÜÊûê
        const analyzeKeywordCategory = (keyword) => {
          // Ê∫ñÂÇô„ÉªÈñãÂßãÁ≥ª
          if (['Ê∫ñÂÇô', 'Âü∫Á§éÂõ∫„ÇÅ', 'Â≠¶Áøí', '„Éù„ÉÜ„É≥„Ç∑„É£„É´', 'Âßã„Åæ„Çä', 'ÂæÖÊ©ü'].includes(keyword)) {
            return 'preparation';
          }
          // ÂçîÂäõ„ÉªÈñ¢‰øÇÁ≥ª
          if (['ÂçîÂäõ', 'ÂçîÂäõËÄÖ', 'Âá∫‰ºö„ÅÑ', '‰ø°È†º', 'ÂÖ¨„ÅÆÂ†¥', '„Éë„Éº„Éà„Éä„Éº', '‰ø°È†ºÈñ¢‰øÇ'].includes(keyword)) {
            return 'cooperation';
          }
          // ÊàêÈï∑„ÉªÁô∫Â±ïÁ≥ª
          if (['„ÉÅ„É£„É≥„ÇπÂà∞Êù•', 'ÊàêÈï∑', 'Áô∫Â±ï', '„ÉÅ„É£„É≥„Çπ', 'ÊàêÊûú'].includes(keyword)) {
            return 'growth';
          }
          // „É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„ÉóÁ≥ª
          if (['„É™„Éº„ÉÄ„Éº', '„É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„Éó', 'ÂÖ¨ÊòéÊ≠£Â§ß', '‰∏≠Ê†∏'].includes(keyword)) {
            return 'leadership';
          }
          // Âõ∞Èõ£„ÉªË©¶Á∑¥Á≥ª
          if (['Âõ∞Èõ£', '„É™„Çπ„ÇØ„ÅÇ„Çä', 'Âç±Ê©ü', 'ÂÅúÊªû', 'Âç±Èô∫'].includes(keyword)) {
            return 'difficulty';
          }
          // ÂÆâÂÆö„ÉªÊàêÁÜüÁ≥ª
          if (['ÂÆâÂÆö', 'Âêâ', 'ÂïèÈ°å„Å™„Åó', 'ÂÆâÂÖ®Á¨¨‰∏Ä', '‰ºëÊÅØ'].includes(keyword)) {
            return 'stability';
          }
          // ÂÜÖÁúÅ„ÉªÊÖéÈáçÁ≥ª
          if (['ÂÜÖÁúÅ', 'ÊÖéÈáç', 'ÂøçËÄê', 'ÂæÖÊ©ü', 'Âè£„ÇíÈñâ„Åñ„Åô'].includes(keyword)) {
            return 'reflection';
          }
          // Â§âÈù©„ÉªËª¢ÊèõÁ≥ª
          if (['ÊîπÈù©', 'Èù©Êñ∞', 'Ëª¢ÊèõÁÇπ', 'ÊñπÈáùËª¢Êèõ'].includes(keyword)) {
            return 'transformation';
          }
          return 'other';
        };
        
        const prevCategory = analyzeKeywordCategory(prevKeyword);
        const nextCategory = analyzeKeywordCategory(nextKeyword);
        
        // „Ç´„ÉÜ„Ç¥„É™„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅßÈñ¢‰øÇÊÄß„ÇíÂãïÁöÑÁîüÊàê
        if (prevCategory === 'preparation' && nextCategory === 'cooperation') {
          return `Ê∫ñÂÇôÊÆµÈöé„Åã„ÇâÂçîÂäõÈñ¢‰øÇ„ÅÆÊßãÁØâ„Å∏„Å®Ëá™ÁÑ∂„Å´Áô∫Â±ï`;
        }
        if (prevCategory === 'preparation' && nextCategory === 'growth') {
          return `Ê∫ñÂÇô„ÅåÊï¥„ÅÑ„ÄÅÊàêÈï∑„ÅÆÊ©ü‰ºö„ÅåË®™„Çå„Çã`;
        }
        if (prevCategory === 'cooperation' && nextCategory === 'stability') {
          return `ÂçîÂäõÈñ¢‰øÇ„ÅåÂÆâÂÆö„Åó„ÄÅ‰ø°È†º„ÅåÊ∑±„Åæ„Çã`;
        }
        if (prevCategory === 'cooperation' && nextCategory === 'leadership') {
          return `ÂçîÂäõ„Åã„Çâ‰∏ªÂ∞éÁöÑÁ´ãÂ†¥„Å∏„ÅÆÊàêÈï∑`;
        }
        if (prevCategory === 'growth' && nextCategory === 'leadership') {
          return `ÊàêÈï∑„ÇíÁµå„Å¶„É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„Éó„ÇíÁô∫ÊèÆ`;
        }
        if (prevCategory === 'difficulty' && nextCategory === 'reflection') {
          return `Âõ∞Èõ£„Å´Áõ¥Èù¢„Åó„ÄÅÂÜÖÁúÅ„Å®ÊÖéÈáç„Å™ÂØæÂøú„Å∏`;
        }
        if (prevCategory === 'reflection' && nextCategory === 'growth') {
          return `ÂÜÖÁúÅÊúüÈñì„ÇíÁµå„Å¶ÊàêÈï∑„ÅÆÊ©ü‰ºö„ÇíÊé¥„ÇÄ`;
        }
        if (prevCategory === 'stability' && nextCategory === 'growth') {
          return `ÂÆâÂÆö„ÇíÂü∫Áõ§„Å´Êõ¥„Å™„ÇãÊàêÈï∑„Å∏`;
        }
        
        // Âêå„Åò„Ç´„ÉÜ„Ç¥„É™ÂÜÖ„Åß„ÅÆÊ∑±Âåñ
        if (prevCategory === nextCategory) {
          return `„Äå${prevKeyword}„Äç„Åã„Çâ„Äå${nextKeyword}„Äç„Å∏„ÄÅÂêå„Åò„ÉÜ„Éº„ÉûÂÜÖ„Åß„ÅÆÊ∑±Âåñ„Å®ÊàêÁÜü`;
        }
        
        // „Éá„Éï„Ç©„É´„ÉàÔºö„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÁõ¥Êé•ÊØîËºÉ
        return `„Äå${prevKeyword}„Äç„ÅÆÊÆµÈöé„Åã„Çâ„Äå${nextKeyword}„Äç„Å∏„Å®ÊÆµÈöéÁöÑ„Å´Áô∫Â±ï`;
      }
      
      // ÊòìÁµå„ÅÆÁü•ÊÅµ„Åã„ÇâÁä∂Ê≥Å„ÅÆËª¢ÊèõÁÇπ„ÇíË™¨Êòé„Åô„ÇãÈñ¢Êï∞
      function getThematicShift(prevKeyword, nextKeyword) {
        // „Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÂØæÁ´ãÊ¶ÇÂøµ„ÇíÂàÜÊûê
        const getOppositeTheme = (keyword) => {
          const opposites = {
            'Ê∫ñÂÇô': 'Âç≥Ë°åÂãï',
            'ÂçîÂäõ': 'Áã¨Á´ã',
            'ÂÆâÂÆö': 'Â§âÈù©',
            '‰ø°È†º': 'Èù©Êñ∞',
            '„Éù„ÉÜ„É≥„Ç∑„É£„É´': 'ÁèæÂÆü',
            'Â≠¶Áøí': 'ÂÆüË∑µ',
            'ÂÜÖÁúÅ': 'Â§ñÂêë',
            'ÂøçËÄê': 'Á©çÊ•µ',
            'ÂÆà„Çä': 'ÊîªÊíÉ',
            'ÂèóÂãï': 'ËÉΩÂãï'
          };
          return opposites[keyword] || null;
        };
        
        // ÊÑèÂë≥ÁöÑ„Å™Ë∑ùÈõ¢„ÇíË®àÁÆó
        const calculateSemanticDistance = (prev, next) => {
          const prevCat = analyzeKeywordCategory(prev);
          const nextCat = analyzeKeywordCategory(next);
          
          // Ê≠£ÂèçÂØæ„ÅÆ„Ç´„ÉÜ„Ç¥„É™
          const oppositeCategories = {
            'preparation': 'transformation',
            'cooperation': 'difficulty',
            'stability': 'transformation',
            'reflection': 'leadership'
          };
          
          if (oppositeCategories[prevCat] === nextCat) {
            return 'opposite';
          }
          if (prevCat !== nextCat) {
            return 'different';
          }
          return 'similar';
        };
        
        const distance = calculateSemanticDistance(prevKeyword, nextKeyword);
        
        // Ë∑ùÈõ¢„Å´Âü∫„Å•„ÅÑ„ÅüËª¢Êèõ„ÅÆË™¨Êòé„ÇíÁîüÊàê
        if (distance === 'opposite') {
          return `„Äå${prevKeyword}„Äç„Åã„ÇâÊ≠£ÂèçÂØæ„ÅÆ„Äå${nextKeyword}„Äç„Å∏„ÄÅÊ†πÊú¨ÁöÑ„Å™ÊñπÂêëËª¢Êèõ`;
        }
        if (distance === 'different') {
          // „Ç´„ÉÜ„Ç¥„É™ÂàÜÊûê„Çí‰ΩøÁî®
          const prevCat = analyzeKeywordCategory(prevKeyword);
          const nextCat = analyzeKeywordCategory(nextKeyword);
          
          if (prevCat === 'preparation' && nextCat === 'transformation') {
            return `Ê∫ñÂÇôÊÆµÈöé„ÇíÈõ¢„Çå„ÄÅÊäúÊú¨ÁöÑ„Å™Â§âÈù©„Å∏„Å®Ëàµ„ÇíÂàá„Çã`;
          }
          if (prevCat === 'cooperation' && nextCat === 'difficulty') {
            return `ÂçîÂäõÈñ¢‰øÇ„Åã„ÇâÂõ∞Èõ£„Å™Áä∂Ê≥Å„Å∏„ÅÆËª¢Êèõ`;
          }
          if (prevCat === 'stability' && nextCat === 'transformation') {
            return `ÂÆâÂÆö„Åã„ÇâËÑ±Âç¥„Åó„ÄÅÊñ∞„Åü„Å™Â§âÈù©„Å∏ÊåëÊà¶`;
          }
          if (prevCat === 'reflection' && nextCat === 'leadership') {
            return `ÂÜÖÁúÅÁöÑ„Å™Áä∂ÊÖã„Åã„ÇâÁ©çÊ•µÁöÑ„Å™„É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„Éó„Å∏„ÅÆËª¢Êèõ`;
          }
          
          return `„Äå${prevKeyword}„Äç„ÅÆ„ÉÜ„Éº„Éû„Åã„ÇâÈõ¢„Çå„ÄÅ„Äå${nextKeyword}„Äç„Å®„ÅÑ„ÅÜÊñ∞„Åó„ÅÑÊñπÂêëÊÄß„Å∏`;
        }
        
        // „Éá„Éï„Ç©„É´„Éà
        return `„Äå${prevKeyword}„Äç„Åã„Çâ„Äå${nextKeyword}„Äç„Å∏„ÄÅË≥™ÁöÑ„Å´Áï∞„Å™„ÇãÂ±ïÈñã`;
      }
      
      // „Ç≠„Éº„ÉØ„Éº„Éâ„Ç´„ÉÜ„Ç¥„É™ÂàÜÊûê„ÅÆ„Éò„É´„Éë„ÉºÈñ¢Êï∞
      function analyzeKeywordCategory(keyword) {
        // Ê∫ñÂÇô„ÉªÈñãÂßãÁ≥ª
        if (['Ê∫ñÂÇô', 'Âü∫Á§éÂõ∫„ÇÅ', 'Â≠¶Áøí', '„Éù„ÉÜ„É≥„Ç∑„É£„É´', 'Âßã„Åæ„Çä', 'ÂæÖÊ©ü', '‰∫àÂÖÜ', 'ÂàùÈúú'].includes(keyword)) {
          return 'preparation';
        }
        // ÂçîÂäõ„ÉªÈñ¢‰øÇÁ≥ª
        if (['ÂçîÂäõ', 'ÂçîÂäõËÄÖ', 'Âá∫‰ºö„ÅÑ', '‰ø°È†º', 'ÂÖ¨„ÅÆÂ†¥', '„Éë„Éº„Éà„Éä„Éº', '‰ø°È†ºÈñ¢‰øÇ', 'ÂåÖÂÆπÂäõ'].includes(keyword)) {
          return 'cooperation';
        }
        // ÊàêÈï∑„ÉªÁô∫Â±ïÁ≥ª
        if (['„ÉÅ„É£„É≥„ÇπÂà∞Êù•', 'ÊàêÈï∑', 'Áô∫Â±ï', '„ÉÅ„É£„É≥„Çπ', 'ÊàêÊûú', 'Âêâ'].includes(keyword)) {
          return 'growth';
        }
        // „É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„ÉóÁ≥ª
        if (['„É™„Éº„ÉÄ„Éº', '„É™„Éº„ÉÄ„Éº„Ç∑„ÉÉ„Éó', 'ÂÖ¨ÊòéÊ≠£Â§ß', '‰∏≠Ê†∏', 'ÂãùÂà©'].includes(keyword)) {
          return 'leadership';
        }
        // Âõ∞Èõ£„ÉªË©¶Á∑¥Á≥ª
        if (['Âõ∞Èõ£', '„É™„Çπ„ÇØ„ÅÇ„Çä', 'Âç±Ê©ü', 'ÂÅúÊªû', 'Âç±Èô∫', 'Âá∂', 'Áµ∂Êúõ'].includes(keyword)) {
          return 'difficulty';
        }
        // ÂÆâÂÆö„ÉªÊàêÁÜüÁ≥ª
        if (['ÂÆâÂÆö', 'ÂïèÈ°å„Å™„Åó', 'ÂÆâÂÖ®Á¨¨‰∏Ä', '‰ºëÊÅØ', 'Â†ÖÂÆü', 'ÊåÅÁ∂ö'].includes(keyword)) {
          return 'stability';
        }
        // ÂÜÖÁúÅ„ÉªÊÖéÈáçÁ≥ª
        if (['ÂÜÖÁúÅ', 'ÊÖéÈáç', 'ÂøçËÄê', 'ÂæÖÊ©ü', 'Âè£„ÇíÈñâ„Åñ„Åô', 'ÂÜÖÈù¢„ÅÆÁæéÂæ≥'].includes(keyword)) {
          return 'reflection';
        }
        // Â§âÈù©„ÉªËª¢ÊèõÁ≥ª
        if (['ÊîπÈù©', 'Èù©Êñ∞', 'Ëª¢ÊèõÁÇπ', 'ÊñπÈáùËª¢Êèõ', 'Êí§ÈÄÄ', 'ÂÜçÁ∑®'].includes(keyword)) {
          return 'transformation';
        }
        return 'other';
      }
      
      // H384„Éá„Éº„Çø„Åã„ÇâÂç¶Âêç„Å®ÁàªÂêç„ÇíÂèñÂæó„Åô„ÇãÈñ¢Êï∞
      function getHexagramInfo(hexNum, lineNum) {
        // 64Âç¶„ÅÆÊ≠£ÂºèÂêçÁß∞
        const hexagramNames = {
          1: '‰πæÁÇ∫Â§©', 2: 'Âù§ÁÇ∫Âú∞', 3: 'Ê∞¥Èõ∑Â±Ø', 4: 'Â±±Ê∞¥Ëíô',
          5: 'Ê∞¥Â§©ÈúÄ', 6: 'Â§©Ê∞¥Ë®ü', 7: 'Âú∞Ê∞¥Â∏´', 8: 'Ê∞¥Âú∞ÊØî',
          9: 'È¢®Â§©Â∞èÁïú', 10: 'Â§©Ê≤¢Â±•', 11: 'Âú∞Â§©Ê≥∞', 12: 'Â§©Âú∞Âê¶',
          13: 'Â§©ÁÅ´Âêå‰∫∫', 14: 'ÁÅ´Â§©Â§ßÊúâ', 15: 'Âú∞Â±±Ë¨ô', 16: 'Èõ∑Âú∞Ë±´',
          17: 'Ê≤¢Èõ∑Èöè', 18: 'Â±±È¢®Ë†±', 19: 'Âú∞Ê≤¢Ëá®', 20: 'È¢®Âú∞Ë¶≥',
          21: 'ÁÅ´Èõ∑Âô¨Âóë', 22: 'Â±±ÁÅ´Ë≥Å', 23: 'Â±±Âú∞Ââ•', 24: 'Âú∞Èõ∑Âæ©',
          25: 'Â§©Èõ∑ÁÑ°Â¶Ñ', 26: 'Â±±Â§©Â§ßÁïú', 27: 'Â±±Èõ∑È†§', 28: 'Ê≤¢È¢®Â§ßÈÅé',
          29: 'ÂùéÁÇ∫Ê∞¥', 30: 'Èõ¢ÁÇ∫ÁÅ´', 31: 'Ê≤¢Â±±Âí∏', 32: 'Èõ∑È¢®ÊÅí',
          33: 'Â§©Â±±ÈÅØ', 34: 'Èõ∑Â§©Â§ßÂ£Æ', 35: 'ÁÅ´Âú∞Êôã', 36: 'Âú∞ÁÅ´ÊòéÂ§∑',
          37: 'È¢®ÁÅ´ÂÆ∂‰∫∫', 38: 'ÁÅ´Ê≤¢ÁùΩ', 39: 'Ê∞¥Â±±Ëπá', 40: 'Èõ∑Ê∞¥Ëß£',
          41: 'Â±±Ê≤¢Êêç', 42: 'È¢®Èõ∑Áõä', 43: 'Ê≤¢Â§©Â§¨', 44: 'Â§©È¢®Âß§',
          45: 'Ê≤¢Âú∞ËêÉ', 46: 'Âú∞È¢®Âçá', 47: 'Ê≤¢Ê∞¥Âõ∞', 48: 'Ê∞¥È¢®‰∫ï',
          49: 'Ê≤¢ÁÅ´Èù©', 50: 'ÁÅ´È¢®Èºé', 51: 'ÈúáÁÇ∫Èõ∑', 52: 'ËâÆÁÇ∫Â±±',
          53: 'È¢®Â±±Êº∏', 54: 'Èõ∑Ê≤¢Â∏∞Â¶π', 55: 'Èõ∑ÁÅ´Ë±ä', 56: 'ÁÅ´Â±±ÊóÖ',
          57: 'Â∑ΩÁÇ∫È¢®', 58: 'ÂÖåÁÇ∫Ê≤¢', 59: 'È¢®Ê∞¥Ê∏ô', 60: 'Ê∞¥Ê≤¢ÁØÄ',
          61: 'È¢®Ê≤¢‰∏≠Â≠ö', 62: 'Èõ∑Â±±Â∞èÈÅé', 63: 'Ê∞¥ÁÅ´Êó¢Ê∏à', 64: 'ÁÅ´Ê∞¥Êú™Ê∏à'
        };
        
        // Áàª‰Ωç„ÅÆÂêçÁß∞ÔºàÈô∞ÈôΩ„Å®‰ΩçÁΩÆ„Å´„Çà„ÇãÔºâ
        const lineNames = ['Âàù', '‰∫å', '‰∏â', 'Âõõ', '‰∫î', '‰∏ä'];
        
        // H384„Éá„Éº„Çø„Åã„ÇâË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
        if (typeof H384_DATA !== 'undefined') {
          const index = (hexNum - 1) * 6 + lineNum - 1;
          const entry = H384_DATA[index];
          if (entry) {
            return {
              hexName: entry['Âç¶Âêç'] || hexagramNames[hexNum],
              lineName: entry['Áàª'] || `${lineNames[lineNum - 1]}Áàª`,
              keywords: entry['„Ç≠„Éº„ÉØ„Éº„Éâ'] || [],
              interpretation: entry['Áèæ‰ª£Ëß£Èáà„ÅÆË¶ÅÁ¥Ñ'] || ''
            };
          }
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ
        return {
          hexName: hexagramNames[hexNum] || `Âç¶${hexNum}`,
          lineName: `${lineNames[lineNum - 1]}Áàª`,
          keywords: [],
          interpretation: ''
        };
      }
      
      // 3„Éï„Çß„Éº„Ç∫„Åß8„Éë„Çø„Éº„É≥ÁîüÊàêÔºà2¬≥=8ÈÄö„ÇäÔºâ
      function generateThreePhaseScenarios(initialHex, initialLine, analysis, inputText) {
        const patterns = ['JJJ', 'JJH', 'JHJ', 'JHH', 'HJJ', 'HJH', 'HHJ', 'HHH'];
        const scenarios = [];
        
        patterns.forEach((pattern, index) => {
          const path = simulateThreePhaseJourney(initialHex, initialLine, pattern);
          const scenario = createScenarioFromPath(path, pattern, analysis, inputText, index + 1);
          scenarios.push(scenario);
        });
        
        return scenarios;
      }
      
      // 3„Éï„Çß„Éº„Ç∫„ÅÆÊóÖ„Çí„Ç∑„Éü„É•„É¨„Éº„Éà
      function simulateThreePhaseJourney(initialHex, initialLine, pattern) {
        const states = [{ hex: initialHex, line: initialLine, phase: 0 }];
        let currentHex = initialHex;
        let currentLine = initialLine;
        
        for (let i = 0; i < pattern.length; i++) {
          const choice = pattern[i];
          
          if (choice === 'J') {
            // ÈÄ≤ÁàªÔºöÁàª‰Ωç+1ÔºàÂêå„ÅòÂç¶Ôºâ
            currentLine = currentLine < 6 ? currentLine + 1 : 1;
          } else {
            // Â§âÁàªÔºöÂç¶Â§âÂåñÔºàÁàª‰Ωç‰øùÊåÅÔºâ
            currentHex = calculateTransformedHex(currentHex, currentLine);
          }
          
          states.push({
            hex: currentHex,
            line: currentLine,
            phase: i + 1,
            choice: choice === 'J' ? 'ÈÄ≤Áàª' : 'Â§âÁàª'
          });
        }
        
        return states;
      }
      
      // Â§âÁàª„Å´„Çà„ÇãÂç¶Â§âÊèõË®àÁÆó
      function calculateTransformedHex(hexNum, lineNum) {
        // ÊòìÁµå„ÅÆ‰ΩìÁ≥ªÁöÑÁü•Ë≠ò„ÅåÂà©Áî®ÂèØËÉΩ„Å™Â†¥Âêà
        if (typeof window !== 'undefined' && window.kingWenMapping) {
          return window.kingWenMapping.calculateTransformedHex(hexNum, lineNum) || ((hexNum % 64) + 1);
        }
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÁ∞°ÊòìË®àÁÆó
        return ((hexNum - 1 + lineNum * 7) % 64) + 1;
      }
      
      // „Éë„Çπ„Åã„Çâ„Ç∑„Éä„É™„Ç™„Çí‰ΩúÊàê
      function createScenarioFromPath(path, pattern, analysis, inputText, orderNum) {
        const finalState = path[path.length - 1];
        const interpretation = interpretPattern(pattern, analysis);
        
        // ÊòìÁµå„ÅÆÁü•ÊÅµ„Åã„Çâ„Ç≠„Éº„ÉØ„Éº„ÉâÂèñÂæóÔºàÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
        let keyword = 'Â§âÂåñ';
        let theme = 'Êú™Êù•„Å∏„ÅÆÈÅì';
        
        if (typeof H384_DATA !== 'undefined') {
          const index = (finalState.hex - 1) * 6 + finalState.line - 1;
          const h384Entry = H384_DATA[index];
          if (h384Entry) {
            keyword = h384Entry['„Ç≠„Éº„ÉØ„Éº„Éâ'][0] || keyword;
            theme = h384Entry['Áèæ‰ª£Ëß£Èáà„ÅÆË¶ÅÁ¥Ñ'] || theme;
          }
        }
        
        return {
          type: 'three-phase',
          pattern: pattern,
          patternName: getPatternName(pattern),
          title: `„Äê„Éë„Çø„Éº„É≥${orderNum}„Äë${interpretation.title}`,
          description: generateThreePhaseDescription(path, pattern, analysis, inputText),
          keyword: keyword,
          theme: theme,
          finalHex: finalState.hex,
          finalLine: finalState.line,
          path: path,
          risk: interpretation.risk,
          confidence: 70 + (orderNum * 2),
          timeframe: interpretation.timeframe
        };
      }
      
      // „Éë„Çø„Éº„É≥„ÅÆËß£ÈáàÔºà„Çà„ÇäËá™ÁÑ∂„Å™Êó•Êú¨Ë™ûË°®ÁèæÔºâ
      function interpretPattern(pattern, analysis) {
        const interpretations = {
          'JJJ': { 
            title: 'ÁèæÂú®„ÅÆÈÅì„ÇíÁùÄÂÆü„Å´Ê∑±„ÇÅ„Å¶„ÅÑ„Åè',
            risk: '‰Ωé',
            timeframe: '„Åò„Å£„Åè„Çä„Å®ÊôÇÈñì„Çí„Åã„Åë„Å¶'
          },
          'JJH': { 
            title: 'Âü∫Áõ§„ÇíÂõ∫„ÇÅ„Å¶„Åã„ÇâÊñ∞Â¢ÉÂú∞„Å∏',
            risk: '‰ΩéÔΩû‰∏≠',
            timeframe: 'ÊÆµÈöéÁöÑ„Å™Â±ïÈñã'
          },
          'JHJ': { 
            title: 'Êñ∞„Åó„ÅÑË¶ñÁÇπ„ÇíÂæó„Å¶„ÄÅ„Åù„Åì„Åã„ÇâÊ∑±„ÇÅ„Çã',
            risk: '‰∏≠',
            timeframe: '„Éê„É©„É≥„Çπ„ÅÆÂèñ„Çå„ÅüÂ§âÂåñ'
          },
          'JHH': { 
            title: 'Êó©„ÇÅ„ÅÆÊñπÂêëËª¢Êèõ„ÅßÂèØËÉΩÊÄß„ÇíÂ∫É„Åí„Çã',
            risk: '‰∏≠ÔΩûÈ´ò',
            timeframe: 'Á©çÊ•µÁöÑ„Å™Â§âÈù©'
          },
          'HJJ': { 
            title: 'ÊÄù„ÅÑÂàá„Å£„ÅüËª¢ÊèõÂæå„ÄÅ„Åò„Å£„Åè„ÇäËÇ≤„Å¶„Çã',
            risk: '‰∏≠',
            timeframe: 'Ëª¢Ê©üÂæå„ÅÆÂÆâÂÆöÊàêÈï∑'
          },
          'HJH': { 
            title: 'ÊüîËªü„Å´Â§âÂåñ„Å®Ê∑±Âåñ„ÇíÁπî„Çä‰∫§„Åú„Çã',
            risk: 'È´ò',
            timeframe: '„ÉÄ„Ç§„Éä„Éü„ÉÉ„ÇØ„Å™Â±ïÈñã'
          },
          'HHJ': { 
            title: 'Â§ßËÉÜ„Å™Â§âÈù©„ÇíÁµå„Å¶„ÄÅÊñ∞„Åü„Å™ÂÆöÁùÄ„Å∏',
            risk: 'È´ò',
            timeframe: 'ÂäáÁöÑÂ§âÂåñ„Åã„Çâ„ÅÆÂèéÊùü'
          },
          'HHH': { 
            title: 'Êó¢ÊàêÊ¶ÇÂøµ„ÇíÊâì„Å°Á†¥„ÇäÁ∂ö„Åë„ÇãÈù©Êñ∞„ÅÆÈÅì',
            risk: 'ÊúÄÈ´ò',
            timeframe: 'ÈÄ£Á∂öÁöÑ„Å™Èù©Êñ∞'
          }
        };
        
        return interpretations[pattern] || { title: pattern, risk: '‰∏≠', timeframe: 'Â§âÂåñ„ÅÆÈÅéÁ®ã' };
      }
      
      // „Éë„Çø„Éº„É≥Âêç„ÅÆÂèñÂæóÔºà„Çè„Åã„Çä„ÇÑ„Åô„ÅÑÊó•Êú¨Ë™ûÔºâ
      function getPatternName(pattern) {
        const names = {
          'JJJ': 'ÁùÄÂÆüÊàêÈï∑',
          'JJH': 'ÊàêÁÜüËª¢Ê©ü',
          'JHJ': 'Êñ∞Â§©Âú∞ÈñãÊãì',
          'JHH': 'Êó©ÊúüËª¢Êèõ',
          'HJJ': 'ÊñπÂêëËª¢ÊèõÂæå„ÅÆÂÆâÂÆö',
          'HJH': 'Â§âÂåñ„Å®ÊàêÈï∑„ÅÆ‰∏°Á´ã',
          'HHJ': 'ÊøÄÂ§â„Åã„Çâ„ÅÆÁùÄÂú∞',
          'HHH': 'ÂÆåÂÖ®Èù©Êñ∞'
        };
        return names[pattern] || pattern;
      }
      
      // 3„Éï„Çß„Éº„Ç∫Ë™¨ÊòéÁîüÊàêÔºàËá™ÁÑ∂„Å™Êó•Êú¨Ë™ûË°®ÁèæÔºâ
      function generateThreePhaseDescription(path, pattern, analysis, inputText) {
        let descriptions = [];
        
        // ÂêÑ„Éï„Çß„Éº„Ç∫„ÅÆË™¨Êòé„ÇíËá™ÁÑ∂„Å™ÊñáÁ´†„Åß‰ΩúÊàê
        for (let i = 1; i < path.length; i++) {
          const state = path[i];
          const prevState = path[i-1];
          let phaseDesc = '';
          
          // ÂâçÂæå„ÅÆÂç¶ÊÉÖÂ†±„Å®„Ç≠„Éº„ÉØ„Éº„Éâ„ÇíÂèñÂæó
          const prevInfo = getHexagramInfo(prevState.hex, prevState.line);
          const nextInfo = getHexagramInfo(state.hex, state.line);
          const prevKeyword = prevInfo.keywords[0] || '';
          const nextKeyword = nextInfo.keywords[0] || '';
          
          // „Éï„Çß„Éº„Ç∫„Åî„Å®„ÅÆËá™ÁÑ∂„Å™Ë™¨ÊòéÊñá
          if (i === 1) {
            phaseDesc = 'Á¨¨1ÊÆµÈöé„Åß„ÅØ„ÄÅ';
          } else if (i === 2) {
            phaseDesc = 'Ê¨°„ÅÆÊÆµÈöé„Å´„Åä„ÅÑ„Å¶„ÄÅ';
          } else {
            phaseDesc = 'ÊúÄÁµÇÊÆµÈöé„Å®„Åó„Å¶„ÄÅ';
          }
          
          if (state.choice === 'ÈÄ≤Áàª') {
            // ÈÄ≤Áàª„ÅÆÂ†¥ÂêàÔºö„Éá„Éº„ÇøÈßÜÂãïÂûã„ÅÆË™¨ÊòéÁîüÊàê
            if (window.dataAnalyzer && prevState.hex && prevState.line && state.hex && state.line) {
              // DataDrivenAnalyzer„Çí‰ΩøÁî®
              const connection = window.dataAnalyzer.generateJinConnection(
                prevState.hex, prevInfo.lineName, state.hex, nextInfo.lineName
              );
              phaseDesc += connection;
            } else if (prevKeyword && nextKeyword) {
              // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÊóßÂÆüË£Ö
              phaseDesc += `„Äê„ÉÜ„Éº„ÉûÁ∂ôÁ∂ö„ÄëÁèæÂú®„ÅÆ„Äå${prevKeyword}„Äç„Å®„ÅÑ„ÅÜ„ÉÜ„Éº„Éû„ÇíÁ∂≠ÊåÅ„Åó„ÄÅ${prevInfo.hexName}„ÅÆÂç¶„ÅÆÊµÅ„Çå„Å´Ê≤ø„Å£„Å¶„ÄÅ`;
              phaseDesc += `„Çà„ÇäÊàêÁÜü„Åó„Åü„Äå${nextKeyword}„ÄçÔºà${nextInfo.lineName}Ôºâ„Å∏„Å®Ëá™ÁÑ∂„Å´Áô∫Â±ï„Åó„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇ`;
              phaseDesc += `„Åì„Çå„ÅØ${getThematicConnection(prevKeyword, nextKeyword)}„Å®„ÅÑ„ÅÜÈñ¢‰øÇ„Åß„Åô„ÄÇ`;
            } else {
              phaseDesc += `${prevInfo.hexName}„ÅÆÂç¶„ÅÆ„ÉÜ„Éº„Éû„Å´Ê≤ø„Å£„Å¶„ÄÅ${prevInfo.lineName}„Åã„Çâ${nextInfo.lineName}„Å∏„Å®ÊÆµÈöéÁöÑ„Å´Ê∑±„Åæ„Å£„Å¶„ÅÑ„Åç„Åæ„Åô„ÄÇ`;
            }
          } else {
            // Â§âÁàª„ÅÆÂ†¥ÂêàÔºö„Éá„Éº„ÇøÈßÜÂãïÂûã„ÅÆË™¨ÊòéÁîüÊàê
            if (window.dataAnalyzer && prevState.hex && prevState.line && state.hex && state.line) {
              // DataDrivenAnalyzer„Çí‰ΩøÁî®
              const shift = window.dataAnalyzer.generateHengShift(
                prevState.hex, prevInfo.lineName, state.hex, nextInfo.lineName
              );
              phaseDesc += shift;
            } else if (prevKeyword && nextKeyword) {
              // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºöÊóßÂÆüË£Ö
              phaseDesc += `„Äê„ÉÜ„Éº„ÉûËª¢Êèõ„Äë„Äå${prevKeyword}„Äç„Å®„ÅÑ„ÅÜ„ÉÜ„Éº„Éû„Åã„ÇâÈõ¢„Çå„ÄÅ`;
              phaseDesc += `${prevInfo.hexName}„Åã„Çâ${nextInfo.hexName}„Å∏„Å®Âç¶„ÅåÂ§âÂåñ„Åô„Çã„Åì„Å®„Åß„ÄÅ`;
              phaseDesc += `„Äå${nextKeyword}„Äç„Å®„ÅÑ„ÅÜÂÖ®„ÅèÁï∞„Å™„Çã„ÉÜ„Éº„Éû„Å∏„ÅÆËª¢Êèõ„ÅåËµ∑„Åì„Çä„Åæ„Åô„ÄÇ`;
              phaseDesc += `„Åì„Çå„ÅØ${getThematicShift(prevKeyword, nextKeyword)}„Å®„ÅÑ„ÅÜË≥™ÁöÑ„Å™Â§âÂåñ„Åß„Åô„ÄÇ`;
            } else {
              phaseDesc += `${prevInfo.hexName}„ÅÆ„ÉÜ„Éº„Éû„Åã„ÇâÈõ¢„Çå„ÄÅ${nextInfo.hexName}„Å®„ÅÑ„ÅÜÊñ∞„Åó„ÅÑÂç¶„ÅÆ„ÉÜ„Éº„Éû„Å∏„Å®Ëª¢Êèõ„Åó„Åæ„Åô„ÄÇ`;
            }
          }
          
          descriptions.push(phaseDesc);
        }
        
        // ÂÖ®‰Ωì„ÅÆÊµÅ„Çå„Çí„Åæ„Å®„ÇÅ„Çã
        let summary = descriptions.join('');
        
        // „Éë„Çø„Éº„É≥„Å´Âøú„Åò„ÅüÁ∑†„ÇÅ„ÅÆË®ÄËëâ
        if (pattern === 'JJJ') {
          summary += '„Åì„ÅÆ„Éë„Çπ„ÅØ‰∏ÄË≤´ÊÄß„Çí‰øù„Å°„Å™„Åå„ÇâÁùÄÂÆü„Å´Ê∑±Âåñ„Åó„Å¶„ÅÑ„ÅèÈÅìÁ≠ã„Åß„Åô„ÄÇ';
        } else if (pattern === 'HHH') {
          summary += '„Åì„ÅÆ„Éë„Çπ„ÅØÂ∏∏„Å´Êñ∞„Åó„ÅÑÂ§âÂåñ„ÇíÊ±Ç„ÇÅ„ÄÅÈù©Êñ∞ÁöÑ„Å™Â±ïÈñã„ÇíÁ∂ö„Åë„ÇãÈÅìÁ≠ã„Åß„Åô„ÄÇ';
        } else if (pattern.includes('J') && pattern.includes('H')) {
          summary += '„Åì„ÅÆ„Éë„Çπ„ÅØÊ∑±Âåñ„Å®Ëª¢Êèõ„ÅÆ„Éê„É©„É≥„Çπ„ÇíÂèñ„Çä„Å™„Åå„ÇâÈÄ≤„ÇÄÈÅìÁ≠ã„Åß„Åô„ÄÇ';
        }
        
        // ÂÖ•Âäõ„Å´Âøú„Åò„ÅüË£úË∂≥Ôºà„Çà„ÇäËá™ÁÑ∂„Å™Ë°®ÁèæÔºâ
        if (analysis.hasWork) {
          summary += '„Åä‰ªï‰∫ã„ÇÑ„Ç≠„É£„É™„Ç¢„ÅÆÈù¢„Åß„ÅØ„ÄÅ„Åì„ÅÆÊµÅ„Çå„Å´Ê≤ø„Å£„Å¶Êñ∞„Åü„Å™ÊàêÈï∑„ÅÆÊ©ü‰ºö„ÅåË®™„Çå„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ';
        }
        if (analysis.hasRelation) {
          summary += '‰∫∫ÈñìÈñ¢‰øÇ„Å´„Åä„ÅÑ„Å¶„ÅØ„ÄÅÁõ∏Êâã„Å®„ÅÆË∑ùÈõ¢ÊÑü„ÇíË™øÊï¥„Åó„Å™„Åå„Çâ„ÄÅ„Çà„ÇäËâØ„ÅÑÈñ¢‰øÇÊÄß„ÇíÁØâ„ÅÑ„Å¶„ÅÑ„Åë„Çã„Åß„Åó„Çá„ÅÜ„ÄÇ';
        }
        if (analysis.hasDecision) {
          summary += 'ÈÅ∏ÊäûËÇ¢„ÅÆÂàÜÊûê„Å´Èñ¢„Åó„Å¶„ÅØ„ÄÅ384„Éë„Çø„Éº„É≥„Å´Âü∫„Å•„Åè8„Å§„ÅÆÊú™Êù•ËªåÈÅì„ÅåÁÆóÂá∫„Åï„Çå„Åæ„Åô„ÄÇ';
        }
        
        return summary;
      }

      // 8„Ç∑„Éä„É™„Ç™ÁîüÊàêÈñ¢Êï∞ÔºàÈ´òÂ∫¶ÂàÜÊûêÁâàÔºâ
      async function generateAndDisplay8Scenarios(worryText) {
        console.log('üéØ 8„Ç∑„Éä„É™„Ç™ÁîüÊàêÈñãÂßãÔºàÈ´òÂ∫¶ÁâàÔºâ:', worryText);
        
        try {
          // EightScenariosGenerator„Çí‰ΩøÁî®
          if (window.EightScenariosGenerator) {
            const generator = new window.EightScenariosGenerator();
            const analysis = window.integratedAnalysisResult;
            
            if (analysis && analysis.iching) {
              const scenarios = await generator.generateScenarios(
                analysis.iching,
                analysis.context || {}
              );
              
              if (scenarios && scenarios.length > 0) {
                console.log('‚úÖ EightScenariosGeneratorÊàêÂäü:', scenarios.length, 'ÂÄã');
                displayDynamicScenarios(scenarios, worryText);
                return;
              }
            }
          }
        } catch (error) {
          console.log('‚ö†Ô∏è EightScenariosGenerator„Ç®„É©„Éº:', error);
        }
        
        // È´òÂ∫¶ÁîüÊàê„ÅåÂ§±Êïó„Åó„ÅüÂ†¥Âêà„ÄÅÂãïÁöÑÁîüÊàê„Ç∑„Çπ„ÉÜ„É†„Çí‰ΩøÁî®
        const scenarios = generateJingYaoHengYaoScenarios(worryText);
        
        if (scenarios && scenarios.length === 8) {
          console.log('‚úÖ ÂãïÁöÑÁîüÊàêÊàêÂäü: 8ÂÄã„ÅÆ„Ç∑„Éä„É™„Ç™');
          displayDynamicScenarios(scenarios, worryText);
          return;
        }
        
        // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Âõ∫ÂÆö„ÉÜ„É≥„Éó„É¨„Éº„ÉàÔºàÂãïÁöÑÁîüÊàê„ÅåÂ§±Êïó„Åó„ÅüÂ†¥ÂêàÔºâ
        console.log('‚ö†Ô∏è ÂãïÁöÑÁîüÊàêÂ§±Êïó„ÄÅÂõ∫ÂÆö„ÉÜ„É≥„Éó„É¨„Éº„Éà„Çí‰ΩøÁî®');
        const fallbackScenarios = [
          { 
            trigram: "‰πæ(Â§©)", 
            title: "Á©çÊ•µÁöÑ„Å´Ë°åÂãï„ÇíËµ∑„Åì„Åô", 
            description: "„É™„Çπ„ÇØ„ÇíÊÅê„Çå„Åö„ÄÅÂ§ßËÉÜ„Å™‰∏ÄÊ≠©„ÇíË∏è„ÅøÂá∫„Åô„ÄÇÊñ∞„Åó„ÅÑÊåëÊà¶„ÅåÊàêÈï∑„Çí„ÇÇ„Åü„Çâ„Åô„ÄÇ",
            risk: "È´ò", 
            color: "#4A90E2" 
          },
          { 
            trigram: "Âù§(Âú∞)", 
            title: "ÊÖéÈáç„Å´Ê∫ñÂÇô„ÇíÊï¥„Åà„Çã", 
            description: "ÁùÄÂÆü„Å´Âü∫Áõ§„ÇíÂõ∫„ÇÅ„ÄÅÁ¢∫ÂÆü„Å™ÊàêÊûú„ÇíÁõÆÊåá„Åô„ÄÇÂøçËÄê„ÅåÊàêÂäü„Å∏„ÅÆÈçµ„ÄÇ",
            risk: "‰Ωé", 
            color: "#8B7355" 
          },
          { 
            trigram: "Èúá(Èõ∑)", 
            title: "Êñ∞„Åó„ÅÑË¶ñÁÇπ„ÇíÂèñ„ÇäÂÖ•„Çå„Çã", 
            description: "Êó¢Â≠ò„ÅÆÊû†ÁµÑ„Åø„ÇíÊâìÁ†¥„Åó„ÄÅÈù©Êñ∞ÁöÑ„Å™„Ç¢„Éó„É≠„Éº„ÉÅ„ÇíË©¶„Åø„Çã„ÄÇ",
            risk: "‰∏≠", 
            color: "#9B59B6" 
          },
          { 
            trigram: "Â∑Ω(È¢®)", 
            title: "ÊÆµÈöéÁöÑ„Å´ÈÄ≤Ê≠©„Åô„Çã", 
            description: "Â∞è„Åï„Å™Â§âÂåñ„ÇíÁ©ç„ÅøÈáç„Å≠„ÄÅÁùÄÂÆü„Å´ÁõÆÊ®ô„Å∏Ëøë„Å•„Åè„ÄÇÊüîËªüÊÄß„ÅåÈáçË¶Å„ÄÇ",
            risk: "‰Ωé", 
            color: "#1ABC9C" 
          },
          { 
            trigram: "Âùé(Ê∞¥)", 
            title: "ÂçîÂäõ„ÉªÈÄ£Êê∫„ÇíÊ±Ç„ÇÅ„Çã", 
            description: "‰ªñËÄÖ„Å®„ÅÆÂçîÂÉç„Å´„Çà„ÇãÁä∂Ê≥ÅÂ§âÂåñ„ÄÇ‰∫∫ÁöÑ„Éç„ÉÉ„Éà„ÉØ„Éº„ÇØ„ÅÆÂΩ±Èüø„ÅåÂ§ß„Åç„ÅÑ„ÄÇ",
            risk: "‰∏≠", 
            color: "#3498DB" 
          },
          { 
            trigram: "Èõ¢(ÁÅ´)", 
            title: "ÂÜÖÈù¢„ÇíÂÖÖÂÆü„Åï„Åõ„Çã", 
            description: "Ëá™Â∑±ÁêÜËß£„ÇíÊ∑±„ÇÅ„ÄÅÂÜÖ„Å™„ÇãÂäõ„ÇíËÇ≤„ÇÄ„ÄÇÁ≤æÁ•ûÁöÑÊàêÈï∑„ÅåÈÅì„ÇíÈñã„Åè„ÄÇ",
            risk: "‰Ωé", 
            color: "#E74C3C" 
          },
          { 
            trigram: "ËâÆ(Â±±)", 
            title: "ÁèæÁä∂„ÇíË¶ãÁõ¥„Åô", 
            description: "Á´ã„Å°Ê≠¢„Åæ„Å£„Å¶Áä∂Ê≥Å„ÇíÂàÜÊûê„Åó„ÄÅÊúÄÈÅ©„Å™ÊôÇÊúü„ÇíÂæÖ„Å§„ÄÇÈùôË¶≥„ÇÇÊà¶Áï•„ÄÇ",
            risk: "‰Ωé", 
            color: "#95A5A6" 
          },
          { 
            trigram: "ÂÖå(Ê≤¢)", 
            title: "ÊüîËªü„Å´ÂØæÂøú„Åô„Çã", 
            description: "Áä∂Ê≥Å„Å´Âøú„Åò„Å¶ÊñπÂêëËª¢Êèõ„Åó„ÄÅÊúÄÈÅ©„Å™ÈÅì„ÇíË¶ã„Å§„Åë„Çã„ÄÇÈÅ©ÂøúÂäõ„ÅåÈçµ„ÄÇ",
            risk: "‰∏≠", 
            color: "#F39C12" 
          }
        ];
        
        // „Ç∑„Éä„É™„Ç™Ë°®Á§∫Áî®„ÅÆHTMLÁîüÊàê
        const scenariosHTML = `
          <div class="scenarios-container" style="margin: 20px 0; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
            <h3 style="color: #A78BFA; margin-bottom: 20px; font-size: 1.5rem;">
              üîÆ 8„Å§„ÅÆÊú™Êù•„Ç∑„Éä„É™„Ç™
            </h3>
            <div class="scenarios-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
              ${scenarios.map((scenario, index) => `
                <div class="scenario-card" style="
                  background: linear-gradient(135deg, ${scenario.color}22, ${scenario.color}11);
                  border: 1px solid ${scenario.color}55;
                  border-radius: 8px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: ${scenario.color}; font-weight: bold;">${scenario.trigram}</span>
                    <span style="
                      background: ${scenario.risk === 'È´ò' ? '#EF4444' : scenario.risk === '‰∏≠' ? '#F59E0B' : '#10B981'}22;
                      color: ${scenario.risk === 'È´ò' ? '#EF4444' : scenario.risk === '‰∏≠' ? '#F59E0B' : '#10B981'};
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-size: 0.8rem;
                    ">„É™„Çπ„ÇØ: ${scenario.risk}</span>
                  </div>
                  <h4 style="color: #E5E7EB; margin-bottom: 8px;">${scenario.title}</h4>
                  <p style="color: #9CA3AF; font-size: 0.9rem; line-height: 1.4;">${scenario.description}</p>
                </div>
              `).join('')}
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 4px solid #6366F1;">
              <p style="color: #C7D2FE; font-size: 0.9rem;">
                <strong>üí° „Éí„É≥„Éà:</strong> ${worryText.substring(0, 50)}... „Å´ÂØæ„Åó„Å¶„ÄÅ8„Å§„ÅÆÁï∞„Å™„Çã„Ç¢„Éó„É≠„Éº„ÉÅ„ÇíÊèêÁ§∫„Åó„Åæ„Åó„Åü„ÄÇ
                „Åù„Çå„Åû„Çå„ÅÆ„Ç∑„Éä„É™„Ç™„ÅØÊòìÁµå„ÅÆ8Âç¶„Å´Âü∫„Å•„ÅÑ„Å¶„Åä„Çä„ÄÅÁï∞„Å™„ÇãË¶ñÁÇπ„Åã„Çâ„ÅÆÊú™Êù•„Éë„Çø„Éº„É≥„ÇíÁ§∫„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ
              </p>
            </div>
          </div>
        `;
        
        // ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢„Å´ÊåøÂÖ•
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
          // Êó¢Â≠ò„ÅÆ„Ç∑„Éä„É™„Ç™„Ç≥„É≥„ÉÜ„Éä„Çí„Åô„Åπ„Å¶ÂâäÈô§
          const existingScenarios = resultsContainer.querySelectorAll('.scenarios-container');
          existingScenarios.forEach(el => el.remove());
          
          // ÁµêÊûú„Ç≥„É≥„ÉÜ„Éä„ÅÆÊúÄÂàù„Å´ÊåøÂÖ•
          const resultContainer = resultsContainer.querySelector('.result-container');
          if (resultContainer) {
            resultContainer.insertAdjacentHTML('afterbegin', scenariosHTML);
          } else {
            resultsContainer.insertAdjacentHTML('afterbegin', scenariosHTML);
          }
          
          console.log('‚úÖ 8„Ç∑„Éä„É™„Ç™Ë°®Á§∫ÂÆå‰∫Ü');
        }
      }
      
      // ÂãïÁöÑÁîüÊàê„Åï„Çå„Åü„Ç∑„Éä„É™„Ç™„ÅÆË°®Á§∫Èñ¢Êï∞
      function displayDynamicScenarios(scenarios, worryText) {
        console.log('üé® 3„Éï„Çß„Éº„Ç∫„Ç∑„Éä„É™„Ç™Ë°®Á§∫ÈñãÂßã');
        
        // „Ç∑„Éä„É™„Ç™Ë°®Á§∫Áî®„ÅÆHTMLÁîüÊàêÔºà3„Éï„Çß„Éº„Ç∫„Ç∑„Çπ„ÉÜ„É†ÁâàÔºâ
        const scenariosHTML = `
          <div class="scenarios-container" style="margin: 20px 0; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
            <h3 style="color: #A78BFA; margin-bottom: 20px; font-size: 1.5rem;">
              üîÆ „ÅÇ„Å™„Åü„ÅÆÊú™Êù•„Å∏„ÅÆ8„Å§„ÅÆÈÅìÁ≠ã
            </h3>
            <div class="scenarios-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
              ${scenarios.map((scenario, index) => {
                // 3„Éï„Çß„Éº„Ç∫„Ç∑„Çπ„ÉÜ„É†„Éá„Éº„Çø„Åã„ÇâÊÉÖÂ†±„ÇíÊäΩÂá∫
                const pattern = scenario.pattern || `„Éë„Çø„Éº„É≥${index + 1}`;
                const patternName = scenario.patternName || getPatternName(pattern);
                const title = scenario.title || 'Êú™Êù•„ÅÆÂèØËÉΩÊÄß';
                const description = scenario.description || '';
                const risk = scenario.risk || '‰∏≠';
                const color = getPatternColor(pattern);
                const confidence = scenario.confidence || 70;
                
                // ÊúÄÁµÇÁä∂ÊÖã„ÅÆÂç¶Âêç„Å®ÁàªÂêç„ÇíÂèñÂæó
                const finalInfo = getHexagramInfo(scenario.finalHex, scenario.finalLine);
                const finalState = `${finalInfo.hexName}„Éª${finalInfo.lineName}`;
                const keyword = scenario.keyword || finalInfo.keywords[0] || '';
                
                return `
                  <div class="scenario-card" style="
                    background: linear-gradient(135deg, ${color}22, ${color}11);
                    border: 1px solid ${color}55;
                    border-radius: 8px;
                    padding: 15px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                  " onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <span style="color: ${color}; font-weight: bold; font-size: 0.9rem;">${pattern} ${patternName}</span>
                      <span style="
                        background: ${risk === 'ÊúÄÈ´ò' || risk === 'È´ò' ? '#EF4444' : risk.includes('‰∏≠') ? '#F59E0B' : '#10B981'}22;
                        color: ${risk === 'ÊúÄÈ´ò' || risk === 'È´ò' ? '#EF4444' : risk.includes('‰∏≠') ? '#F59E0B' : '#10B981'};
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-size: 0.8rem;
                      ">„É™„Çπ„ÇØ: ${risk}</span>
                    </div>
                    <h4 style="color: #E5E7EB; margin-bottom: 8px;">${title}</h4>
                    <div style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                      <div style="color: #A78BFA; font-size: 0.85rem; margin-bottom: 4px;">ÊúÄÁµÇÂà∞ÈÅîÁÇπ: ${finalState}</div>
                      ${keyword ? `<div style="color: #F59E0B; font-size: 0.85rem;">„Ç≠„Éº„ÉØ„Éº„Éâ: ${keyword}</div>` : ''}
                    </div>
                    <p style="color: #9CA3AF; font-size: 0.85rem; line-height: 1.4; max-height: 100px; overflow-y: auto;">${description.substring(0, 200)}${description.length > 200 ? '...' : ''}</p>
                    ${confidence ? `
                      <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <span style="color: #6B7280; font-size: 0.75rem;">Á¢∫‰ø°Â∫¶</span>
                          <span style="color: ${color}; font-size: 0.75rem;">${confidence}%</span>
                        </div>
                        <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px;">
                          <div style="width: ${confidence}%; height: 100%; background: ${color}; border-radius: 2px;"></div>
                        </div>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 4px solid #6366F1;">
              <p style="color: #C7D2FE; font-size: 0.9rem; line-height: 1.6;">
                <strong>üåü ÊòìÁµå„ÅÆÁü•ÊÅµ„Å´„Çà„ÇãÂàÜÊûêÁµêÊûú</strong><br>
                „ÅÇ„Å™„Åü„ÅÆÁä∂Ê≥Å„Äå${worryText.substring(0, 40)}...„Äç„Å´ÂØæ„Åó„Å¶„ÄÅ3„Å§„ÅÆËª¢Ê©ü„Å´„Åä„Åë„ÇãÈÅ∏Êäû„Å´„Çà„Çä8„Å§„ÅÆÂèØËÉΩ„Å™Êú™Êù•„ÅÆÈÅìÁ≠ã„ÇíÂ∞é„ÅçÂá∫„Åó„Åæ„Åó„Åü„ÄÇ<br>
                ÂêÑ„Éë„Çø„Éº„É≥„ÅØ„ÄÅÁèæÂú®„ÅÆ„ÉÜ„Éº„Éû„ÇíÊ∑±„ÇÅ„Çã„ÄåÈÄ≤Áàª„Äç„Å®„ÄÅÊñ∞„Åó„ÅÑË¶ñÁÇπ„Å∏Ëª¢Êèõ„Åô„Çã„ÄåÂ§âÁàª„Äç„ÅÆÁµÑ„ÅøÂêà„Çè„Åõ„ÅßÊßãÊàê„Åï„Çå„ÄÅ„Åù„Çå„Åû„Çå„ÅåÁã¨Ëá™„ÅÆÂ±ïÈñã„Å®ÁµêÊûú„Çí„ÇÇ„Åü„Çâ„Åó„Åæ„Åô„ÄÇ
              </p>
            </div>
          </div>
        `;
        
        // ÁµêÊûúË°®Á§∫„Ç®„É™„Ç¢„Å´ÊåøÂÖ•
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
          // Êó¢Â≠ò„ÅÆ„Ç∑„Éä„É™„Ç™„Ç≥„É≥„ÉÜ„Éä„Çí„Åô„Åπ„Å¶ÂâäÈô§
          const existingScenarios = resultsContainer.querySelectorAll('.scenarios-container');
          existingScenarios.forEach(el => el.remove());
          
          // ÁµêÊûú„Ç≥„É≥„ÉÜ„Éä„ÅÆÊúÄÂàù„Å´ÊåøÂÖ•
          const resultContainer = resultsContainer.querySelector('.result-container');
          if (resultContainer) {
            resultContainer.insertAdjacentHTML('afterbegin', scenariosHTML);
          } else {
            resultsContainer.insertAdjacentHTML('afterbegin', scenariosHTML);
          }
          
          console.log('‚úÖ ÂãïÁöÑ8„Ç∑„Éä„É™„Ç™Ë°®Á§∫ÂÆå‰∫Ü');
        }
      }
      
      // „Éë„Çø„Éº„É≥„Å´Âü∫„Å•„ÅÑ„ÅüËâ≤„ÇíÂèñÂæó
      function getPatternColor(pattern) {
        const colors = {
          'JJJ': "#10B981", // Á∑ë - ÂÆâÂÆöÊàêÈï∑
          'JJH': "#3B82F6", // Èùí - „Éê„É©„É≥„ÇπÂûã
          'JHJ': "#8B5CF6", // Á¥´ - Ëª¢ÊèõÊ∑±Âåñ
          'JHH': "#EC4899", // „Éî„É≥„ÇØ - Â§âÈù©Âä†ÈÄü
          'HJJ': "#14B8A6", // „ÉÜ„Ç£„Éº„É´ - Ëª¢ÊèõÂÆâÂÆö
          'HJH': "#F59E0B", // „Ç™„É¨„É≥„Ç∏ - Ê≥¢ÂãïÂûã
          'HHJ': "#EF4444", // Ëµ§ - ÊøÄÂ§âÂèéÊùü
          'HHH': "#DC2626"  // Ê∑±Á¥Ö - ÂÖ®Èù¢Èù©Êñ∞
        };
        return colors[pattern] || "#6B7280";
      }
      
      // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Å´Âü∫„Å•„ÅÑ„ÅüËâ≤„ÇíÂèñÂæóÔºà‰∫íÊèõÊÄß„ÅÆ„Åü„ÇÅÊÆã„ÅôÔºâ
      function getColorByIndex(index) {
        const colors = [
          "#4A90E2", "#8B7355", "#9B59B6", "#1ABC9C",
          "#3498DB", "#E74C3C", "#95A5A6", "#F39C12"
        ];
        return colors[index % 8];
      }

      // „É¶„Éº„Ç∂„ÉºÈÄöÁü•Ê©üËÉΩ
      function showUserMessage(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 1000;
          max-width: 300px;
          font-weight: 500;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 4000);
      }

      /**
       * 384Áàª„Ç∑„Çπ„ÉÜ„É†ÂàÜÊûêÁµêÊûú„ÇíË°®Á§∫
       */
      function display384LinesResult(analysis) {
        const section = document.getElementById('lines384ResultSection');
        const loading = document.getElementById('lines384Loading');
        const results = document.getElementById('lines384Results');
        const error = document.getElementById('lines384Error');
        
        if (!section) {
          console.warn('384ÁàªË°®Á§∫„Çª„ÇØ„Ç∑„Éß„É≥„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
          return;
        }
        
        // „Çª„ÇØ„Ç∑„Éß„É≥„ÇíË°®Á§∫
        section.style.display = 'block';
        
        // „Ç®„É©„Éº„ÅÆÂ†¥Âêà
        if (analysis.error) {
          loading.style.display = 'none';
          results.style.display = 'none';
          error.style.display = 'block';
          
          const errorMessage = document.getElementById('lines384ErrorMessage');
          if (errorMessage) {
            errorMessage.textContent = analysis.fallbackMessage || analysis.message || '384Áàª„Ç∑„Çπ„ÉÜ„É†„ÅÆË™≠„ÅøËæº„Åø„Å´Â§±Êïó„Åó„Åæ„Åó„Åü';
          }
          return;
        }
        
        // Ê≠£Â∏∏„Å™ÁµêÊûú„ÅÆÂ†¥Âêà
        if (analysis.selectedLine) {
          loading.style.display = 'none';
          error.style.display = 'none';
          results.style.display = 'block';
          
          // ÈÅ∏Êäû„Åï„Çå„ÅüÁàª„ÅÆÊÉÖÂ†±„ÇíË°®Á§∫
          const line = analysis.selectedLine;
          
          document.getElementById('selectedLineName').textContent = 
            line.lineName || `Áàª #${line.id}`;
          
          document.getElementById('selectedLineHexagram').textContent = 
            `${line.hexagramName || ''} ${line.linePosition ? `Á¨¨${line.linePosition}Áàª` : ''}`;
          
          document.getElementById('selectedLineDescription').textContent = 
            line.description || 'Ë©≥Á¥∞ÊÉÖÂ†±„ÇíË™≠„ÅøËæº„Åø‰∏≠...';
          
          document.getElementById('selectedLineAdvice').textContent = 
            line.advice || line.interpretation || 'ÂÖ∑‰ΩìÁöÑ„Å™„Ç¢„Éâ„Éê„Ç§„Çπ„ÇíÁîüÊàê‰∏≠...';
          
          document.getElementById('lineConfidence').textContent = 
            analysis.confidence ? `${(analysis.confidence * 100).toFixed(0)}%` : 'Ë®àÁÆó‰∏≠';
          
          document.getElementById('lineDataSource').textContent = 
            line.dbSource === 'D1' ? 'D1„Éá„Éº„Çø„Éô„Éº„Çπ' : '„É≠„Éº„Ç´„É´„Ç≠„É£„ÉÉ„Ç∑„É•';
          
          // Èñ¢ÈÄ£„Åô„ÇãÁàª„Åå„ÅÇ„Çå„Å∞Ë°®Á§∫
          if (analysis.relatedLines && analysis.relatedLines.length > 0) {
            const relatedSection = document.getElementById('relatedLines');
            const relatedList = document.getElementById('relatedLinesList');
            
            if (relatedSection && relatedList) {
              relatedSection.style.display = 'block';
              relatedList.innerHTML = '';
              
              analysis.relatedLines.slice(0, 4).forEach(related => {
                const relatedCard = document.createElement('div');
                relatedCard.className = 'bg-gray-50 p-3 rounded-lg';
                relatedCard.innerHTML = `
                  <p class="font-semibold text-sm" style="color: var(--text-primary);">
                    ${related.lineName || `Áàª #${related.id}`}
                  </p>
                  <p class="text-xs mt-1" style="color: var(--text-secondary);">
                    È°û‰ººÂ∫¶: ${(related.similarity * 100).toFixed(0)}%
                  </p>
                `;
                relatedList.appendChild(relatedCard);
              });
            }
          }
          
          // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú
          results.style.opacity = '0';
          results.style.transform = 'translateY(10px)';
          setTimeout(() => {
            results.style.transition = 'opacity 0.5s, transform 0.5s';
            results.style.opacity = '1';
            results.style.transform = 'translateY(0)';
          }, 100);
        }
      }
      
      // analyzeWorry function - È´òÂ∫¶„Å™ÂàÜÊûê„Ç∑„Çπ„ÉÜ„É†ÂÆåÂÖ®Áâà
      async function analyzeWorry(inputText) {
        console.log('üå∏ analyzeWorry È´òÂ∫¶ÂàÜÊûêÁâàÂÆüË°åÈñãÂßã:', inputText);
        
        try {
          // 1. KuromojiÂΩ¢ÊÖãÁ¥†Ëß£Êûê
          let morphTokens = null;
          if (window.OfflineKuromojiInitializer && window.OfflineKuromojiInitializer.initialized) {
            try {
              // Ê≠£„Åó„ÅÑ„É°„ÇΩ„ÉÉ„ÉâÂêç: analyzeText
              morphTokens = await window.OfflineKuromojiInitializer.analyzeText(inputText);
              console.log('‚úÖ KuromojiÂΩ¢ÊÖãÁ¥†Ëß£ÊûêÂÆå‰∫Ü');
            } catch (error) {
              console.log('‚ö†Ô∏è KuromojiËß£Êûê„Ç®„É©„Éº:', error);
            }
          }
          
          // 2. DynamicKeywordGenerator - 4Â±§„Ç≠„Éº„ÉØ„Éº„ÉâÁîüÊàê
          let dynamicKeywords = null;
          if (window.DynamicKeywordGenerator) {
            try {
              // DynamicKeywordGenerator„ÅÆÂàùÊúüÂåñ„ÇíÁ¢∫Ë™ç
              if (!window.DynamicKeywordGenerator.engineOS) {
                window.DynamicKeywordGenerator.init();
              }
              
              // engineOS„ÅÆ„É°„ÇΩ„ÉÉ„Éâ„Çíwindow„Çπ„Ç≥„Éº„Éó„Å´„Éê„Ç§„É≥„Éâ
              const engineOS = window.DynamicKeywordGenerator.engineOS;
              // this„ÅÆ„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„Çí‰øÆÊ≠£
              // contextDatabase„Å∏„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÇíÁ¢∫‰øù
              engineOS.contextDatabase = window.DynamicKeywordGenerator.contextDatabase;
              
              // „É°„ÇΩ„ÉÉ„Éâ„ÅÆ„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞
              engineOS.inferReading = window.DynamicKeywordGenerator.inferReading;
              engineOS.inferPOS = window.DynamicKeywordGenerator.inferPOS;
              engineOS.calculateTokenImportance = window.DynamicKeywordGenerator.calculateTokenImportance;
              engineOS.getIntentKeywords = window.DynamicKeywordGenerator.getIntentKeywords.bind(window.DynamicKeywordGenerator);
              engineOS.getEmotionKeywords = window.DynamicKeywordGenerator.getEmotionKeywords.bind(window.DynamicKeywordGenerator);
              engineOS.getSemanticExpansions = window.DynamicKeywordGenerator.getSemanticExpansions;
              engineOS.getRelatedWords = window.DynamicKeywordGenerator.getRelatedWords;
              engineOS.getSynonyms = window.DynamicKeywordGenerator.getSynonyms;
              engineOS.getDomainKeywords = window.DynamicKeywordGenerator.getDomainKeywords.bind(window.DynamicKeywordGenerator);
              engineOS.getTimeframeKeywords = window.DynamicKeywordGenerator.getTimeframeKeywords;
              engineOS.getSituationKeywords = window.DynamicKeywordGenerator.getSituationKeywords;
              engineOS.calculateContextQuality = window.DynamicKeywordGenerator.calculateContextQuality;
              engineOS.deduplicateKeywords = engineOS.deduplicateKeywords.bind(engineOS);
              engineOS.ensureDiversity = engineOS.ensureDiversity.bind(engineOS);
              
              dynamicKeywords = await engineOS.generateKeywords(
                inputText, 
                { morphTokens }
              );
              console.log('‚úÖ ÂãïÁöÑ„Ç≠„Éº„ÉØ„Éº„ÉâÁîüÊàêÂÆå‰∫Ü:', dynamicKeywords?.final?.length || 0, 'ÂÄã');
            } catch (error) {
              console.log('‚ö†Ô∏è „Ç≠„Éº„ÉØ„Éº„ÉâÁîüÊàê„Ç®„É©„Éº:', error);
            }
          }
          
          // 3. TextTo384LinesBridge - 384Áàª„Ç∑„Çπ„ÉÜ„É†ÂàÜÊûêÔºàD1„Éá„Éº„Çø„Éô„Éº„ÇπÁµ±ÂêàÔºâ
          let lines384Analysis = null;
          if (window.TextTo384LinesBridge) {
            try {
              console.log('üîÆ 384Áàª„Ç∑„Çπ„ÉÜ„É†ÂàÜÊûêÈñãÂßã...');
              
              // „Éñ„É™„ÉÉ„Ç∏„ÅÆÂàùÊúüÂåñÔºàD1„Éá„Éº„Çø„Éô„Éº„ÇπÊé•Á∂öÔºâ
              const bridge384 = new window.TextTo384LinesBridge();
              await bridge384.initialize();
              
              // „ÉÜ„Ç≠„Çπ„ÉàÂàÜÊûêÂÆüË°å
              lines384Analysis = await bridge384.analyzeTextToSpecificLine(inputText);
              
              if (lines384Analysis && lines384Analysis.selectedLine) {
                console.log('‚úÖ 384ÁàªÂàÜÊûêÂÆå‰∫Ü:', {
                  lineId: lines384Analysis.selectedLine.id,
                  lineName: lines384Analysis.selectedLine.lineName,
                  confidence: lines384Analysis.confidence,
                  dbSource: lines384Analysis.selectedLine.dbSource
                });
              } else {
                console.log('‚ö†Ô∏è 384ÁàªÂàÜÊûê: ÁµêÊûú„Å™„Åó');
              }
            } catch (error) {
              console.error('‚ùå 384Áàª„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„Éº:', error);
              // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÂá¶ÁêÜ
              lines384Analysis = {
                error: true,
                message: error.message,
                fallbackMessage: 'üöß 384Áàª„Ç∑„Çπ„ÉÜ„É†„ÅØÁèæÂú®„É°„É≥„ÉÜ„Éä„É≥„Çπ‰∏≠„Åß„Åô'
              };
            }
          }
          
          // 4. IntegratedAnalysisEngine - Â§öÂ±§ÊñáËÑàÂàÜÊûê
          let contextAnalysis = null;
          if (window.IntegratedAnalysisEngine) {
            try {
              // IntegratedAnalysisEngine„ÇíÂàùÊúüÂåñ
              if (!window.IntegratedAnalysisEngine.engineOS) {
                window.IntegratedAnalysisEngine.init();
              }
              
              // dataPoints„Å®„Åó„Å¶ÂÖ•Âäõ„ÉÜ„Ç≠„Çπ„Éà„ÇíÈÖçÂàóÂΩ¢Âºè„ÅßÊèê‰æõ
              const dataPoints = [{
                text: inputText,
                type: 'user_input',
                timestamp: new Date().toISOString()
              }];
              
              // this„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„Çí‰øÆÊ≠£„Åô„Çã„Åü„ÇÅ„ÄÅÂøÖË¶Å„Å™„É°„ÇΩ„ÉÉ„Éâ„Çí„Éê„Ç§„É≥„Éâ
              const integratedEngine = window.IntegratedAnalysisEngine.engineOS;
              
              // ÂøÖË¶Å„Å™„É°„ÇΩ„ÉÉ„Éâ„ÅÆthis„Éê„Ç§„É≥„Éá„Ç£„É≥„Ç∞„Çí‰øÆÊ≠£
              integratedEngine.preprocessData = integratedEngine.preprocessData.bind(integratedEngine);
              integratedEngine.normalizeDataPoint = window.IntegratedAnalysisEngine.normalizeDataPoint || function(p) { return p; };
              integratedEngine.enrichDataPoint = window.IntegratedAnalysisEngine.enrichDataPoint || function(p) { return p; };
              integratedEngine.validateDataPoint = window.IntegratedAnalysisEngine.validateDataPoint || function(p) { return p; };
              integratedEngine.generatePointId = window.IntegratedAnalysisEngine.generatePointId || function(p) { 
                const rng = window.seedableRandom || { next: () => 0.5 };
                return rng.next().toString(36); 
              };
              integratedEngine.calculatePointWeight = window.IntegratedAnalysisEngine.calculatePointWeight || function(p) { return 1.0; };
              integratedEngine.filterValidPoints = window.IntegratedAnalysisEngine.filterValidPoints || function(p) { return p; };
              
              // „Åù„ÅÆ‰ªñ„ÅÆÂàÜÊûê„É°„ÇΩ„ÉÉ„Éâ„ÅÆ„Çπ„Çø„Éñ„ÇíËøΩÂä†
              integratedEngine.performDimensionalAnalysis = integratedEngine.performDimensionalAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.performSemanticAnalysis = integratedEngine.performSemanticAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.performPatternAnalysis = integratedEngine.performPatternAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.performContextualAnalysis = integratedEngine.performContextualAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.performIChingAnalysis = integratedEngine.performIChingAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.integrateAnalysisResults = integratedEngine.integrateAnalysisResults || function(r) { return r; };
              integratedEngine.extractInsights = integratedEngine.extractInsights || function(i, c) { return []; };
              integratedEngine.generateRecommendations = integratedEngine.generateRecommendations || function(i, ins, c) { return []; };
              integratedEngine.calculateAnalysisDepth = integratedEngine.calculateAnalysisDepth || function(i) { return 0.5; };
              integratedEngine.calculateConfidenceScore = integratedEngine.calculateConfidenceScore || function(i) { return 0.7; };
              integratedEngine.calculateComplexityLevel = integratedEngine.calculateComplexityLevel || function(d) { return 0.5; };
              integratedEngine.createFallbackAnalysis = integratedEngine.createFallbackAnalysis || function(d) { return { status: 'fallback' }; };
              
              // performDimensionalAnalysis„ÅßÂøÖË¶Å„Å™„É°„ÇΩ„ÉÉ„Éâ
              integratedEngine.analyzeTemporal = integratedEngine.analyzeTemporal || function(d) { return { temporal: 'analysis' }; };
              integratedEngine.analyzeSpatial = integratedEngine.analyzeSpatial || function(d) { return { spatial: 'analysis' }; };
              integratedEngine.analyzeSemanticDimension = integratedEngine.analyzeSemanticDimension || function(d) { return { semantic: 'analysis' }; };
              integratedEngine.analyzeEmotional = integratedEngine.analyzeEmotional || function(d) { return { emotional: 'analysis' }; };
              integratedEngine.analyzeComplexity = integratedEngine.analyzeComplexity || function(d) { return { complexity: 'analysis' }; };
              integratedEngine.analyzeRelationships = integratedEngine.analyzeRelationships || function(d) { return { relationships: 'analysis' }; };
              integratedEngine.calculateDimensionalCorrelations = integratedEngine.calculateDimensionalCorrelations || function(d) { return {}; };
              integratedEngine.identifyDimensionalPatterns = integratedEngine.identifyDimensionalPatterns || function(d, c) { return []; };
              integratedEngine.calculateDimensionalStrength = integratedEngine.calculateDimensionalStrength || function(d) { return 0.7; };
              
              // performSemanticAnalysis„ÅßÂøÖË¶Å„Å™„É°„ÇΩ„ÉÉ„Éâ
              integratedEngine.extractSemanticFeatures = integratedEngine.extractSemanticFeatures || function(t) { return {}; };
              integratedEngine.extractConcepts = integratedEngine.extractConcepts || function(f) { return []; };
              integratedEngine.identifyThemes = integratedEngine.identifyThemes || function(c) { return []; };
              integratedEngine.deriveMeanings = integratedEngine.deriveMeanings || function(c, t) { return []; };
              integratedEngine.mapSemanticRelationships = integratedEngine.mapSemanticRelationships || function(m) { return {}; };
              integratedEngine.calculateSemanticDensity = integratedEngine.calculateSemanticDensity || function(f) { return 0.5; };
              integratedEngine.calculateSemanticCoherence = integratedEngine.calculateSemanticCoherence || function(m) { return 0.7; };
              
              // engineOS„ÅÆperformIntegratedAnalysis„É°„ÇΩ„ÉÉ„Éâ„Çí‰ΩøÁî®
              contextAnalysis = await integratedEngine.performIntegratedAnalysis(
                dataPoints,
                { 
                  keywords: dynamicKeywords,
                  morphTokens: morphTokens
                }
              );
              console.log('‚úÖ Áµ±ÂêàÂàÜÊûêÂÆå‰∫Ü');
            } catch (error) {
              console.log('‚ö†Ô∏è Áµ±ÂêàÂàÜÊûê„Ç®„É©„Éº:', error);
            }
          }
          
          // 4. IChingSituationAnalyzer - H384„Éá„Éº„Çø„Éô„Éº„ÇπÈÄ£Êê∫
          let ichingAnalysis = null;
          
          // Ë§áÊï∞„ÅÆÊñπÊ≥ï„Åßsimulator„ÇíÂèñÂæó
          const sim = window.ichingSimulator || 
                     (window.getIChingSimulator ? window.getIChingSimulator() : null);
          
          // „Éá„Éê„ÉÉ„Ç∞ÊÉÖÂ†±
          console.log('üîç I Ching SimulatorÁä∂ÊÖã:', {
            simExists: !!sim,
            hasIsReady: !!(sim && sim.isReady),
            isReady: sim && sim.isReady ? sim.isReady() : false,
            hasAnalyzeSituation: !!(sim && sim.analyzeSituation),
            hasAnalyzeText: !!(sim && sim.analyzeText),
            isInitialized: !!(sim && sim.isInitialized)
          });
          
          if (sim) {
            try {
              // analyzeSituation„Åæ„Åü„ÅØanalyzeText„É°„ÇΩ„ÉÉ„Éâ„Çí‰ΩøÁî®
              if (sim.analyzeSituation) {
                ichingAnalysis = await sim.analyzeSituation(inputText);
              } else if (sim.analyzeText) {
                ichingAnalysis = await sim.analyzeText(inputText);
              } else {
                console.log('‚ö†Ô∏è I ChingÂàÜÊûê„É°„ÇΩ„ÉÉ„Éâ„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
              }
              
              if (ichingAnalysis) {
                console.log('‚úÖ I ChingÂàÜÊûêÂÆå‰∫Ü:', {
                  hexagram: ichingAnalysis?.hexagram?.name,
                  yao: ichingAnalysis?.yao?.name,
                  hasData: !!ichingAnalysis
                });
                
                // ÂàÜÊûêÁµêÊûú„Åå‰∏çÂÆåÂÖ®„Å™Â†¥Âêà„ÅÆË£úÂÆå
                if (!ichingAnalysis.hexagram) {
                  // Ë§áÊï∞„ÅÆÂàÜÊûê„Ç®„É≥„Ç∏„É≥„ÇíË©¶Ë°å
                  let hexagramResult = null;
                  
                  // 1. HexagramMappingEngine„ÇíË©¶Ë°å
                  if (window.HexagramMappingEngine) {
                    try {
                      console.log('üéØ Using HexagramMappingEngine for hexagram selection...');
                      const mapper = new window.HexagramMappingEngine();
                      await mapper.initialize();
                      hexagramResult = await mapper.analyzeTextToHexagram(inputText);
                    } catch (e) {
                      console.log('‚ö†Ô∏è HexagramMappingEngine failed:', e);
                    }
                  }
                  
                  // 2. BinaryTreeCompleteDisplay„ÇíË©¶Ë°å
                  if (!hexagramResult && window.BinaryTreeCompleteDisplay && window.BinaryTreeCompleteDisplay.analyzeTextToSelectHexagram) {
                    console.log('üéØ Using BinaryTreeCompleteDisplay for hexagram selection...');
                    hexagramResult = window.BinaryTreeCompleteDisplay.analyzeTextToSelectHexagram(inputText);
                  }
                  
                  // 3. PatternMapper„ÇíË©¶Ë°å
                  if (!hexagramResult && window.PatternMapper) {
                    console.log('üéØ Using PatternMapper for hexagram selection...');
                    const mapper = new window.PatternMapper();
                    // „Ç≠„Éº„ÉØ„Éº„Éâ„Åã„Çâ8„Å§„ÅÆË≥™Âïè„Å∏„ÅÆÂõûÁ≠î„ÇíÁîüÊàê
                    const answers = dynamicKeywords?.final?.slice(0, 8).map(k => k.importance > 0.5) || [1,0,1,0,1,0,1,0];
                    const patternId = mapper.generatePatternId(answers);
                    const decimalId = mapper.patternIdToDecimal(patternId);
                    const hexagramNumber = mapper.mapToHexagram(decimalId);
                    hexagramResult = { hexagramNumber, confidence: 0.7, method: 'PatternMapper' };
                  }
                  
                  if (hexagramResult && hexagramResult.hexagramNumber) {
                    const hexIndex = hexagramResult.hexagramNumber - 1;
                    // Áàª„ÅÆÈÅ∏Êäû„ÇÇÂãïÁöÑ„Å´Ôºà„Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆÈáçË¶ÅÂ∫¶„Å´Âü∫„Å•„ÅèÔºâ
                    const rng = window.seedableRandom || { next: () => 0.5 };
                    const yaoIndex = dynamicKeywords?.final?.[0]?.importance 
                      ? Math.min(Math.floor(dynamicKeywords.final[0].importance * 6) + 1, 6)
                      : Math.floor(rng.next() * 6) + 1;
                    
                    ichingAnalysis.hexagram = {
                      number: hexagramResult.hexagramNumber,
                      name: window.H384?.hexagrams?.[hexIndex]?.name || hexagramResult.name || `Âç¶${hexagramResult.hexagramNumber}`,
                      confidence: hexagramResult.confidence,
                      method: hexagramResult.method
                    };
                    ichingAnalysis.yao = {
                      position: yaoIndex,
                      name: `${yaoIndex === 1 ? 'Âàù' : yaoIndex === 6 ? '‰∏ä' : yaoIndex}Áàª`
                    };
                    
                    console.log('‚úÖ Dynamic hexagram selected:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name, `(Method: ${hexagramResult.method || 'default'})`);
                  } else {
                    // „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ: Ê±∫ÂÆöË´ñÁöÑÈÅ∏Êäû
                    const rng = window.seedableRandom || { next: () => 0.5 };
                    const hexIndex = Math.floor(rng.next() * 64);
                    const yaoIndex = Math.floor(rng.next() * 6) + 1;
                    
                    ichingAnalysis.hexagram = {
                      number: hexIndex + 1,
                      name: window.H384?.hexagrams?.[hexIndex]?.name || `Âç¶${hexIndex + 1}`
                    };
                    ichingAnalysis.yao = {
                      position: yaoIndex,
                      name: `${yaoIndex === 1 ? 'Âàù' : yaoIndex === 6 ? '‰∏ä' : yaoIndex}Áàª`
                    };
                    
                    console.log('üìä I ChingÂàÜÊûêË£úÂÆåÔºà„É©„É≥„ÉÄ„É†Ôºâ:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name);
                  }
                }
              }
            } catch (error) {
              console.log('‚ö†Ô∏è I ChingÂàÜÊûê„Ç®„É©„Éº:', error);
              // „Ç®„É©„ÉºÊôÇ„Åß„ÇÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÁµêÊûú„ÇíÁîüÊàê
              ichingAnalysis = {
                hexagram: { number: 1, name: '‰πæÁÇ∫Â§©' },
                yao: { position: 1, name: 'ÂàùÁàª' },
                error: true
              };
            }
          } else {
            console.log('‚ö†Ô∏è I Ching Simulator„ÅåÂà©Áî®„Åß„Åç„Åæ„Åõ„Çì - ÂãïÁöÑ„Éû„ÉÉ„Éî„É≥„Ç∞„Çí‰ΩøÁî®');
            
            // Simulator„ÅåÂà©Áî®„Åß„Åç„Å™„ÅÑÂ†¥Âêà„Åß„ÇÇÂãïÁöÑ„Éû„ÉÉ„Éî„É≥„Ç∞„ÇíË©¶Ë°å
            let hexagramResult = null;
            
            // 1. BinaryTreeCompleteDisplay„ÇíË©¶Ë°å
            if (window.BinaryTreeCompleteDisplay && window.BinaryTreeCompleteDisplay.analyzeTextToSelectHexagram) {
              console.log('üéØ Using BinaryTreeCompleteDisplay for dynamic mapping...');
              hexagramResult = window.BinaryTreeCompleteDisplay.analyzeTextToSelectHexagram(inputText);
            }
            
            // 2. Á∞°ÊòìÁöÑ„Å™ÂãïÁöÑ„Éû„ÉÉ„Éî„É≥„Ç∞Ôºà„Ç≠„Éº„ÉØ„Éº„Éâ„Éô„Éº„ÇπÔºâ
            if (!hexagramResult && dynamicKeywords?.final?.length > 0) {
              console.log('üéØ Using keyword-based dynamic mapping...');
              // „Ç≠„Éº„ÉØ„Éº„Éâ„ÅÆ„Éè„ÉÉ„Ç∑„É•ÂÄ§„Åã„ÇâÂç¶„ÇíÈÅ∏Êäû
              let hash = 0;
              dynamicKeywords.final.forEach((kw, idx) => {
                hash += kw.word.charCodeAt(0) * (idx + 1);
              });
              const hexagramNumber = (hash % 64) + 1;
              const yaoPosition = ((hash >> 8) % 6) + 1;
              
              // H384„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
              const entryIndex = (hexagramNumber - 1) * 6 + (yaoPosition - 1);
                const h384Entry = window.H384_DATA?.[entryIndex];

              // „É°„Éà„É™„ÇØ„ÇπÊõ¥Êñ∞Èñ¢Êï∞
              function updateMetrics(analysisTime, cacheHit, dataSource, parseMode, determinismCheck) {
                if (!window.metricsData) {
                  window.metricsData = {
                    times: [],
                    count: 0,
                    cacheHits: 0,
                    determinismChecks: []
                  };
                }
                window.metricsData.times.push(analysisTime);
                window.metricsData.count++;
                if (cacheHit) window.metricsData.cacheHits++;
                window.metricsData.determinismChecks.push(determinismCheck);

                const times = window.metricsData.times.sort((a,b) => a-b);
                const p50 = times[Math.floor(times.length * 0.5)] || 0;
                const p95 = times[Math.floor(times.length * 0.95)] || 0;
                const p99 = times[Math.floor(times.length * 0.99)] || 0;
                const avg = times.reduce((a,b) => a+b, 0) / times.length || 0;
                const hitRate = (window.metricsData.cacheHits / window.metricsData.count * 100).toFixed(1);
                const determinismRate = (window.metricsData.determinismChecks.filter(c => c).length / window.metricsData.determinismChecks.length * 100).toFixed(1);

                const panel = document.getElementById('metrics-panel');
                if (panel) {
                  panel.innerHTML = `
                    <div class="metric-item"><span>P50:</span><span class="${p50 > 40 ? 'metric-warning' : ''}">${p50.toFixed(1)}ms</span></div>
                    <div class="metric-item"><span>P95:</span><span class="${p95 > 45 ? 'metric-warning' : ''}">${p95.toFixed(1)}ms</span></div>
                    <div class="metric-item"><span>P99:</span><span class="${p99 > 50 ? 'metric-warning' : ''}">${p99.toFixed(1)}ms</span></div>
                    <div class="metric-item"><span>Âπ≥Âùá:</span><span>${avg.toFixed(1)}ms</span></div>
                    <div class="metric-item"><span>ÂÆüË°åÂõûÊï∞:</span><span>${window.metricsData.count}</span></div>
                    <div class="metric-item"><span>„Ç≠„É£„ÉÉ„Ç∑„É•„Éí„ÉÉ„ÉàÁéá:</span><span>${hitRate}%</span></div>
                    <div class="metric-item"><span>„Éá„Éº„Çø„ÇΩ„Éº„Çπ:</span><span>${dataSource}</span></div>
                    <div class="metric-item"><span>Ëß£Êûê„É¢„Éº„Éâ:</span><span>${parseMode}</span></div>
                    <div class="metric-item"><span>Ê±∫ÂÆöË´ñ„ÉÅ„Çß„ÉÉ„ÇØÁéá:</span><span class="${determinismRate >= 100 ? '' : 'metric-warning'}">${determinismRate}%</span></div>
                  `;
                }
              }

              // ÂàÜÊûêÂÆüË°åÊôÇ„Å´„É°„Éà„É™„ÇØ„Çπ„ÇíÊõ¥Êñ∞Ôºà‰æãÔºâ
              const startTime = performance.now();
              // ... ÂàÜÊûêÂá¶ÁêÜ ...
              const endTime = performance.now();
              const analysisTime = endTime - startTime;
              updateMetrics(analysisTime, false, 'D1', 'kuromoji');  // ÂÆüÈöõ„ÅÆÂÄ§„ÅßÊõ¥Êñ∞
              
              hexagramResult = {
                hexagramNumber,
                yaoPosition,
                name: h384Entry?.Âç¶Âêç || `Âç¶${hexagramNumber}`,
                yaoName: h384Entry?.Áàª || `${yaoPosition}Áàª`,
                keywords: h384Entry?.„Ç≠„Éº„ÉØ„Éº„Éâ || [],
                interpretation: h384Entry?.Áèæ‰ª£Ëß£Èáà„ÅÆË¶ÅÁ¥Ñ || '',
                method: 'keyword-hash'
              };
            }
            
            if (hexagramResult && hexagramResult.hexagramNumber) {
              const rng = window.seedableRandom || { next: () => 0.5 };
              const yaoIndex = hexagramResult.yaoPosition || Math.floor(rng.next() * 6) + 1;
              
              ichingAnalysis = {
                hexagram: {
                  number: hexagramResult.hexagramNumber,
                  name: hexagramResult.name || `Âç¶${hexagramResult.hexagramNumber}`
                },
                yao: {
                  position: yaoIndex,
                  name: hexagramResult.yaoName || `${yaoIndex === 1 ? 'Âàù' : yaoIndex === 6 ? '‰∏ä' : yaoIndex}Áàª`
                },
                keywords: hexagramResult.keywords,
                interpretation: hexagramResult.interpretation,
                method: hexagramResult.method,
                dynamic: true
              };
              
              console.log('‚úÖ Dynamic mapping result:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name);
            } else {
              // ÊúÄÁµÇ„Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØÔºàÂÖ•Âäõ„ÉÜ„Ç≠„Çπ„Éà„ÅÆ„Éè„ÉÉ„Ç∑„É•ÂÄ§„Çí‰ΩøÁî®Ôºâ
              let textHash = 0;
              for (let i = 0; i < inputText.length; i++) {
                textHash = ((textHash << 5) - textHash) + inputText.charCodeAt(i);
                textHash = textHash & textHash;
              }
              const hexNum = Math.abs(textHash % 64) + 1;
              const yaoNum = Math.abs((textHash >> 16) % 6) + 1;
              
              // H384„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâË©≥Á¥∞ÊÉÖÂ†±„ÇíÂèñÂæó
              const dbIndex = (hexNum - 1) * 6 + (yaoNum - 1);
              const dbEntry = window.H384_DATA?.[dbIndex];
              
              ichingAnalysis = {
                hexagram: { 
                  number: hexNum, 
                  name: dbEntry?.Âç¶Âêç || `Âç¶${hexNum}` 
                },
                yao: { 
                  position: yaoNum, 
                  name: dbEntry?.Áàª || `${yaoNum === 1 ? 'Âàù' : yaoNum === 6 ? '‰∏ä' : yaoNum}Áàª` 
                },
                keywords: dbEntry?.„Ç≠„Éº„ÉØ„Éº„Éâ || [],
                interpretation: dbEntry?.Áèæ‰ª£Ëß£Èáà„ÅÆË¶ÅÁ¥Ñ || '',
                fallback: true,
                method: 'text-hash'
              };
              
              console.log('üìä Text-hash mapping:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name);
            }
          }
          
          // 5. ÂàÜÊûêÁµêÊûú„ÇíÁµ±Âêà
          window.integratedAnalysisResult = {
            input: inputText,
            morphology: morphTokens,
            keywords: dynamicKeywords,
            context: contextAnalysis,
            iching: ichingAnalysis,
            lines384: lines384Analysis,  // 384Áàª„Ç∑„Çπ„ÉÜ„É†ÂàÜÊûêÁµêÊûú„ÇíËøΩÂä†
            timestamp: new Date().toISOString(),
            isAdvanced: true,
            systemsUsed: {
              kuromoji: !!morphTokens,
              dynamicKeywords: !!dynamicKeywords,
              integratedAnalysis: !!contextAnalysis,
              ichingAnalysis: !!ichingAnalysis,
              lines384System: !!lines384Analysis && !lines384Analysis.error  // 384Áàª„Ç∑„Çπ„ÉÜ„É†‰ΩøÁî®Áä∂Ê≥Å
            }
          };
          
          console.log('üìä Áµ±ÂêàÂàÜÊûêÁµêÊûú:', window.integratedAnalysisResult);
          
          // ÂàÜÊûêÁµêÊûú„ÅÆÊ¥ªÁî®Áéá„ÇíË®àÁÆó
          const systemsCount = Object.values(window.integratedAnalysisResult.systemsUsed).filter(v => v).length;
          const totalSystems = Object.keys(window.integratedAnalysisResult.systemsUsed).length;
          const usageRate = (systemsCount / totalSystems * 100).toFixed(0);
          console.log(`üöÄ È´òÂ∫¶ÂàÜÊûê„Ç∑„Çπ„ÉÜ„É†Ê¥ªÁî®Áéá: ${usageRate}% (${systemsCount}/${totalSystems}„Ç∑„Çπ„ÉÜ„É†)`);
          
          // ÂãïÁöÑ„Å™ÁµêÊûúÁîüÊàêÁ¢∫Ë™ç
          if (ichingAnalysis?.hexagram?.name) {
            console.log(`üìä ÂãïÁöÑÂàÜÊûêÁµêÊûú: ${ichingAnalysis.hexagram.name} - ${ichingAnalysis.yao?.name || 'ÂàùÁàª'}`);
          }
          
          // 384Áàª„Ç∑„Çπ„ÉÜ„É†„ÅÆÁµêÊûú„ÇíË°®Á§∫
          if (lines384Analysis) {
            display384LinesResult(lines384Analysis);
          }
          
          // 6. 8„Ç∑„Éä„É™„Ç™ÁîüÊàê„ÇíÂÆüË°åÔºàÈ´òÂ∫¶ÁâàÔºâ
          await generateAndDisplay8Scenarios(inputText);
          
        } catch (error) {
          console.error('‚ùå analyzeWorry „Ç®„É©„Éº:', error);
          // „Ç®„É©„ÉºÊôÇ„ÅØ8„Ç∑„Éä„É™„Ç™ÁîüÊàê„Å†„Åë„Åß„ÇÇË©¶„Åø„Çã
          try {
            await generateAndDisplay8Scenarios(inputText);
          } catch (subError) {
            console.error('‚ùå „Éï„Ç©„Éº„É´„Éê„ÉÉ„ÇØ„ÇÇÂ§±Êïó:', subError);
          }
        }
        
        // ÁµêÊûú„Ç≥„É≥„ÉÜ„Éä„ÇíË°®Á§∫
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
          resultsContainer.style.display = 'block';
          setTimeout(() => {
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
          }, 500);
        }
      }
      
      // Initialize on DOM ready
      document.addEventListener('DOMContentLoaded', ensureChartContainers);
    </script>
    
    <!-- Loading Screen Management -->
    <script>
      // Âç≥Â∫ß„Å´„É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÈô§Âéª
      (function() {
        console.log('Removing loading screen...');
        
        function forceShowContent() {
          // „É≠„Éº„Éá„Ç£„É≥„Ç∞ÁîªÈù¢„ÇíÂç≥Â∫ß„Å´Èô§Âéª
          const loading = document.getElementById('initial-loading');
          if (loading) {
            loading.style.display = 'none';
            loading.remove();
            console.log('‚úÖ Loading screen removed');
          }
          
          // „É°„Ç§„É≥„Ç≥„É≥„ÉÜ„Éä„ÇíË°®Á§∫
          const mainContainer = document.getElementById('main-container');
          if (mainContainer) {
            mainContainer.style.opacity = '1';
            mainContainer.classList.remove('opacity-0');
            console.log('‚úÖ Main container visible');
          }
          
          // „Åô„Åπ„Å¶„ÅÆÈö†„Åï„Çå„Åü„Ç≥„É≥„ÉÜ„É≥„ÉÑ„ÇíË°®Á§∫
          document.querySelectorAll('.progressive-load').forEach(el => {
            el.style.opacity = '1';
            el.style.display = 'block';
          });
          
          // ÂÖ•Âäõ„Éï„Ç©„Éº„É†„ÇíÊòéÁ§∫ÁöÑ„Å´Ë°®Á§∫
          const inputSection = document.getElementById('input-section');
          if (inputSection) {
            inputSection.style.display = 'block';
            inputSection.style.opacity = '1';
          }
          
          // ÁµêÊûú„Ç®„É™„Ç¢„ÇíË°®Á§∫
          const resultArea = document.getElementById('resultArea');
          if (resultArea) {
            resultArea.style.display = 'block';
          }
          
          console.log('‚úÖ All content forced visible');
        }
        
        // DOMË™≠„ÅøËæº„ÅøÂâç„Åß„ÇÇÂÆüË°å
        forceShowContent();
        
        // DOMË™≠„ÅøËæº„ÅøÂæå„Å´„ÇÇÂÆüË°å
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', forceShowContent);
        } else {
          setTimeout(forceShowContent, 100);
        }
        
        // „Åï„Çâ„Å´‰øùÈô∫„Å®„Åó„Å¶1ÁßíÂæå„Å´„ÇÇÂÆüË°å
        setTimeout(forceShowContent, 1000);
      })();
    </script>
  <!-- P0-1: IChingFutureSimulator ESM Mount (Â∞ÇÈñÄÂÆ∂Âä©Ë®ÄÂØæÂøú) -->
  <script type="module">
    // P0-1: Named export ESM import + mount() ÂÆüË£Ö
    import { IChingFutureSimulator } from './js/iching-future-simulator.js';
    
    // Error handling utilities
    function showError(message) {
      console.error('[HAQEI][ERROR]', message);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.style.cssText = `
        background: #dc2626; color: white; padding: 1rem; 
        border-radius: 0.5rem; margin: 1rem; font-family: monospace;
      `;
      errorDiv.textContent = `„Ç®„É©„Éº: ${message}`;
      document.body.appendChild(errorDiv);
    }
    
    function showErrorPanel(error) {
      console.error('[HAQEI][ERROR]', error);
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.style.cssText = `
        background: #dc2626; color: white; padding: 0.5rem; 
        border-radius: 0.25rem; margin: 0.5rem; font-size: 0.875rem;
      `;
      errorDiv.textContent = `„Ç®„É©„Éº: ${error?.message || error}`;
      document.getElementById('i-ching-container')?.appendChild(errorDiv);
    }
    
    let ichingSimulator = null;
    
    window.addEventListener('DOMContentLoaded', () => {
      console.log('[HAQEI][P0-1] ESM mount initialization starting...');
      
      const el = document.getElementById('i-ching-container');
      if (!el) return showError('„Ç∑„Çπ„ÉÜ„É†„ÅÆÂàùÊúüÂåñ„Åß„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü');
      
      try {
        console.log('[HAQEI][P0-1] Creating IChingFutureSimulator with options...');
        
        const sim = new IChingFutureSimulator({
          rng: window.randomnessManager?.getGenerator?.('deterministic'),
          datasets: window.H384,
          onError: (e) => showErrorPanel(e)
        });
        
        console.log('[HAQEI][P0-1] Mounting to #i-ching-container...');
        sim.mount(el);
        
        // Global exposure for compatibility
        ichingSimulator = sim;
        window.ichingSimulator = sim;
        
        console.log('[HAQEI][P0-1] ‚úÖ ESM mount successful');
        
        // Integration with existing analysis button (preserved functionality)
        setTimeout(() => {
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          const worryInput = document.getElementById('worryInput');
          
          if (aiGuessBtn && worryInput) {
            console.log('[HAQEI][P0-1] Setting up integrated analysis button...');
            
            aiGuessBtn.addEventListener('click', (e) => {
              e.preventDefault();
              const inputText = worryInput.value.trim();
              
              if (inputText && inputText.length >= 10) {
                console.log('[HAQEI][P0-1] Running integrated analysis...');
                
                // Call existing analysis function
                if (typeof analyzeWorry === 'function') {
                  analyzeWorry(inputText);
                }
                
                // Show I Ching section
                const ichingSection = document.getElementById('iching-simulator-section');
                if (ichingSection) {
                  ichingSection.style.display = 'block';
                  setTimeout(() => ichingSection.scrollIntoView({ behavior: 'smooth' }), 500);
                }
                
                // Run I Ching analysis if ready
                if (sim.isReady && sim.isReady()) {
                  sim.analyzeSituation(inputText);
                } else {
                  console.warn('[HAQEI][P0-1] Simulator not ready, analysis queued');
                }
              } else {
                alert('10ÊñáÂ≠ó‰ª•‰∏ä„ÅÆ„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');
              }
            }, { once: false });
          }
        }, 1000);
        
      } catch (error) {
        showError(`ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error?.message || error}`);
      }
    });
    
    // Add global function for external access
    window.getIChingSimulator = function() {
      return ichingSimulator;
    };
    
    // Ë¶≥Ê∏¨Áî®ÊÉÖÂ†±Ë°®Á§∫
    document.addEventListener('DOMContentLoaded', () => {
      const monitorDiv = document.createElement('div');
      monitorDiv.id = 'haqei-monitor';
      monitorDiv.style.cssText = `
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0,0,0,0.8);
        color: #0f0;
        font-family: monospace;
        font-size: 11px;
        padding: 5px 10px;
        z-index: 9999;
        display: flex;
        justify-content: space-between;
        align-items: center;
      `;
      
      function updateMonitor() {
        const config = window.HAQEI_CONFIG || {};
        monitorDiv.innerHTML = `
          <span>„Ç∑„Çπ„ÉÜ„É†Ê∫ñÂÇôÂÆå‰∫Ü</span>
          <span>ÂàÜÊûêÊ©üËÉΩ: Âà©Áî®ÂèØËÉΩ</span>
          <span>ÂÆâÂÖ®„Å™ÂàÜÊûêÁí∞Â¢É: Á¢∫‰øùÊ∏à„Åø</span>
          <span>ÂìÅË≥™‰øùË®º: ${config.featureFlags?.enableAnalysis ? 'ÊúâÂäπ' : 'ÁÑ°Âäπ'} 
                         Sharing=${config.featureFlags?.enableSharing ? '‚úì' : '‚úó'}
                         Animation=${config.featureFlags?.enableAnimation ? '‚úì' : '‚úó'}</span>
          <span>${new Date().toLocaleTimeString()}</span>
        `;
      }
      
      updateMonitor();
      setInterval(updateMonitor, 1000);
      document.body.appendChild(monitorDiv);
      
      // „É°„Éà„É™„ÇØ„Çπ„Éë„Éç„É´„Å®„Éà„Ç∞„É´„Éú„Çø„É≥„ÇíËøΩÂä†
      const metricsPanel = document.createElement('div');
      metricsPanel.id = 'metrics-panel';
      metricsPanel.className = 'hidden';
      metricsPanel.innerHTML = `
        <div class="metric-item"><span>P50:</span><span>-</span></div>
        <div class="metric-item"><span>P95:</span><span>-</span></div>
        <div class="metric-item"><span>P99:</span><span>-</span></div>
        <div class="metric-item"><span>Âπ≥Âùá:</span><span>-</span></div>
        <div class="metric-item"><span>ÂÆüË°åÂõûÊï∞:</span><span>0</span></div>
        <div class="metric-item"><span>„Ç≠„É£„ÉÉ„Ç∑„É•„Éí„ÉÉ„ÉàÁéá:</span><span>0%</span></div>
        <div class="metric-item"><span>„Éá„Éº„Çø„ÇΩ„Éº„Çπ:</span><span>-</span></div>
        <div class="metric-item"><span>Ëß£Êûê„É¢„Éº„Éâ:</span><span>-</span></div>
        <div class="metric-item"><span>Ê±∫ÂÆöË´ñ„ÉÅ„Çß„ÉÉ„ÇØÁéá:</span><span>-</span></div>
      `;
      document.body.appendChild(metricsPanel);
      
      const metricsToggle = document.createElement('div');
      metricsToggle.id = 'metrics-toggle';
      metricsToggle.innerHTML = 'üìä';
      metricsToggle.addEventListener('click', () => {
        metricsPanel.classList.toggle('hidden');
      });
      document.body.appendChild(metricsToggle);
    });
    
    // Êäò„Çä„Åü„Åü„ÅøÊ©üËÉΩ„ÅÆJavaScriptÈñ¢Êï∞
    function toggleSection(contentId) {
      const content = document.getElementById(contentId);
      const toggleIcon = document.getElementById(contentId.replace('Content', 'Toggle'));
      
      if (content && toggleIcon) {
        content.classList.toggle('collapsed');
        toggleIcon.textContent = content.classList.contains('collapsed') ? '‚ñ∂' : '‚ñº';
      }
    }
  </script>

  <!-- üîß Future Simulator v4.3.1 ÂÆüË£Ö - ÁÑ°ÂäπÂåñÔºàÂè§„ÅÑË°®Á§∫„Ç∑„Çπ„ÉÜ„É†Ôºâ -->
  
  <!-- üõ°Ô∏è SafeDOMUpdaterÔºàCanvas‰øùË≠∑„Ç∑„Çπ„ÉÜ„É†Ôºâ - ÁÑ°ÂäπÂåñ -->
  
  <!-- üéØ Âçò‰∏ÄDOMÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†ÔºàCLAUDE.mdÊ∫ñÊã†Ôºâ - ÁÑ°ÂäπÂåñ -->
  
  <!-- üîß v4.3.1„ÅßÁµ±‰∏ÄÊ∏à„ÅøÔºö„É™„Ç´„Éê„É™„Éº„Çπ„ÇØ„É™„Éó„Éà„ÅØ‰∏çË¶Å -->
  </body>
</html>
