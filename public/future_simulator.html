<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei マルチバース・アナライザー</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>易</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .card {
        transition: all 0.2s ease-in-out;
        cursor: pointer;
      }
      .card:hover,
      .card.highlighted {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      .rank-badge {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 9999px;
        line-height: 1;
      }
      .rank-s,
      .rank-a,
      .rank-b,
      .rank-c {
        background-color: rgba(74, 222, 128, 0.2);
        color: #86efac;
        border: 1px solid #4ade80;
      }
      .rank-d,
      .rank-e,
      .rank-f,
      .rank-g {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .rank-h {
        background-color: rgba(185, 28, 28, 0.2);
        color: #fca5a5;
        border: 1px solid #dc2626;
      }

      .toggle-label {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid transparent;
        transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
      }
      .toggle-label:hover,
      .toggle-label.highlighted {
        transform: scale(1.1);
      }
      .toggle-legend {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 6px;
      }
      .modal-overlay {
        transition: opacity 0.3s ease;
      }
      .modal-content {
        transition: transform 0.3s ease;
      }
      .eval-label {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 10px;
      }
      .trend-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 6px;
        width: 100%;
        text-align: center;
      }
      .trend-up {
        background-color: rgba(52, 211, 153, 0.2);
        color: #6ee7b7;
        border: 1px solid #34d399;
      }
      .trend-invest {
        background-color: rgba(96, 165, 250, 0.2);
        color: #93c5fd;
        border: 1px solid #60a5fa;
      }
      .trend-stable {
        background-color: rgba(209, 213, 219, 0.2);
        color: #d1d5db;
        border: 1px solid #9ca3af;
      }
      .trend-stagnate {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #fbbf24;
      }
      .trend-down {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .trend-risk-mgmt {
        background-color: rgba(167, 139, 250, 0.2);
        color: #c4b5fd;
        border: 1px solid #a78bfa;
      }
      .trend-recovery {
        background-color: rgba(34, 197, 94, 0.2);
        color: #86efac;
        border: 1px solid #4ade80;
      }

      .yong-yao-step {
        background: linear-gradient(
          145deg,
          rgba(55, 48, 163, 0.2),
          rgba(129, 140, 248, 0.1)
        );
        border: 1px solid #a5b4fc;
        border-radius: 0.75rem;
        box-shadow: 0 0 20px rgba(165, 180, 252, 0.2);
        margin-top: 1rem;
        margin-bottom: 1rem;
      }
      .yong-yao-transition {
        background-color: rgba(253, 224, 71, 0.1);
        border: 1px solid rgba(253, 224, 71, 0.4);
        color: #fde047;
      }
      .yong-yao-title-icon {
        color: #fde047;
        font-size: 1.1em;
        margin-left: 0.5rem;
        text-shadow: 0 0 10px #facc15;
      }
      .diff-up {
        color: #6ee7b7;
      }
      .diff-down {
        color: #fca5a5;
      }
      .diff-zero {
        color: #9ca3af;
      }
      .full-text {
        white-space: normal; /* テキストを通常通り折り返す */
        overflow: visible; /* はみ出た部分を表示する */
        text-overflow: clip; /* 省略記号(...)を無効にする */
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6">
    <div
      class="w-full max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8"
    >
      <header class="text-center mb-8 relative">
        <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
          HaQei
        </h1>
        <p class="text-gray-400 mt-2 text-lg">マルチバース・アナライザー</p>
        <button
          id="helpBtn"
          class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.25l-2.536 2.39c-.832.786-1.464 1.49-1.464 2.36h.001M12 18h.01"
            />
          </svg>
        </button>
      </header>

      <div
        class="bg-gray-900/50 p-6 rounded-xl mb-8 flex flex-col sm:flex-row items-center justify-center gap-4"
      >
        <div>
          <label
            for="hexagramInput"
            class="block text-sm font-medium text-gray-300 mb-1"
            >状況卦（番号または名前）</label
          >
          <input
            type="text"
            id="hexagramInput"
            list="hexagram-names"
            class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 text-center"
            placeholder="例: 3"
            value="3"
          />
        </div>
        <div>
          <label
            for="lineInput"
            class="block text-sm font-medium text-gray-300 mb-1"
            >現在の爻（1～6）</label
          >
          <input
            type="number"
            id="lineInput"
            min="1"
            max="6"
            class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 text-center"
            placeholder="例: 1"
            value="1"
          />
        </div>
        <button
          id="analyzeBtn"
          class="w-full sm:w-auto mt-4 sm:mt-0 sm:self-end bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300"
        >
          予測実行
        </button>
      </div>

      <div id="resultArea" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start mb-12">
          <div class="lg:col-span-1">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              分析サマリー
            </h2>
            <div class="space-y-4">
              <div
                id="summaryCard"
                class="p-4 rounded-lg border border-yellow-400/50 bg-yellow-400/10"
              >
                <h3
                  id="currentTitle"
                  class="text-lg font-semibold text-yellow-300"
                ></h3>
                <p
                  id="currentKeywords"
                  class="text-sm text-yellow-200 mt-1"
                ></p>
                <p id="currentSummary" class="text-gray-300 mt-2 text-sm"></p>
                <div class="mt-3 pt-3 border-t border-yellow-400/30">
                  <h4 class="font-bold text-yellow-300">現在地の総合評価</h4>
                  <div class="flex items-baseline">
                    <p id="currentScore" class="text-3xl font-bold"></p>
                    <span id="currentScoreLabel"></span>
                  </div>
                  <p id="currentScoreDesc" class="text-xs"></p>
                </div>
                <div class="mt-3 pt-3 border-t border-yellow-400/30">
                  <h4 class="font-bold text-yellow-300">
                    今回の変化のしやすさ (移行コスト)
                  </h4>
                  <div class="flex items-baseline">
                    <p id="transitionCost" class="text-3xl font-bold"></p>
                    <span id="transitionCostLabel"></span>
                  </div>
                  <p id="transitionCostDesc" class="text-xs"></p>
                </div>
                <div id="firstActionContainer"></div>
              </div>
            </div>
          </div>

          <div class="lg:col-span-2 bg-gray-900/50 p-6 rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              未来分岐グラフ：総合評価の推移
            </h2>
            <div class="relative" style="height: 400px">
              <canvas id="summaryChart"></canvas>
            </div>
            <div
              id="chartToggles"
              class="flex flex-wrap gap-x-4 gap-y-2 justify-center mt-4"
            ></div>
          </div>
        </div>

        <div>
          <h2 class="text-2xl font-bold mb-6 text-center text-indigo-300">
            8つの未来の最終到達点
          </h2>
          <div
            id="detailCardsContainer"
            class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6"
          ></div>
        </div>
      </div>

      <div id="initialMessage" class="text-center py-12">
        <p class="text-xl text-gray-500">
          状況卦と現在の爻を入力して、「予測実行」ボタンを押してください。
        </p>
      </div>
    </div>

    <div
      id="modalContainer"
      class="fixed inset-0 z-50 flex items-center justify-center hidden"
    >
      <div
        id="modalOverlay"
        class="absolute inset-0 bg-black/70 modal-overlay opacity-0"
      ></div>
      <div
        id="modalContent"
        class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-8 relative transform scale-95"
      >
        <button
          id="modalCloseBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <div id="modalBody"></div>
      </div>
    </div>

    <datalist id="hexagram-names"></datalist>
    <script src="./js/koudo_shishin_database.js"></script>

    <script type="module">
      // koudo_shishin_database.jsはpublic/js/にあるため、このパスで正しく読み込めます

      // --- グローバル変数 ---
      let HAQEI_DATA = null; // APIから取得したデータを格納する
      let H64_DATA = null;
      let H384_DATA = null;
      let summaryChartInstance = null;

      /**
       * アプリケーションの初期化関数
       * ページの読み込み時にAPIからデータを取得し、全てを準備します
       */
      async function initializeApp() {
        try {
          const response = await fetch("/api/data"); // 作成したAPIを呼び出す
          if (!response.ok) {
            throw new Error(
              `APIの呼び出しに失敗しました: ${response.statusText}`
            );
          }
          const apiData = await response.json();
          HAQEI_DATA = apiData.HAQEI_DATA;
          H64_DATA = HAQEI_DATA.H64_DATA;
          H384_DATA = HAQEI_DATA["384"];

          // データが正常に読み込めたら、UIの準備をする
          setupDatalist();
          document.getElementById("analyzeBtn").disabled = false;
          document.getElementById("analyzeBtn").textContent = "予測実行";
          document.getElementById("initialMessage").textContent =
            "準備完了です。状況卦と現在の爻を入力してください。";
        } catch (error) {
          console.error("データの初期化に失敗しました:", error);
          showModal(
            `<h2 class="text-2xl font-bold text-red-400 mb-4">初期化エラー</h2><p>アプリケーションの起動に必要なデータを読み込めませんでした。ページを再読み込みするか、開発者に連絡してください。</p><p class="mt-2 text-sm text-gray-500">${error.message}</p>`
          );
          document.getElementById("analyzeBtn").disabled = true;
          document.getElementById("analyzeBtn").textContent = "読込失敗";
        }
      }

      function setupDatalist() {
        if (typeof H64_DATA !== "undefined" && H64_DATA.length > 0) {
          const datalist = document.getElementById("hexagram-names");
          H64_DATA.forEach((hex) => {
            const option = document.createElement("option");
            option.value = hex.名前;
            datalist.appendChild(option);
          });
        } else {
          console.error("H64_DATAが読み込めていません。");
        }
      }

      document.addEventListener("DOMContentLoaded", () => {
        // ボタンを一旦非活性化し、テキストを変更
        const analyzeBtn = document.getElementById("analyzeBtn");
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = "データ読込中...";

        // アプリケーションを初期化
        initializeApp();

        analyzeBtn.addEventListener("click", handleAnalysis);
        document
          .getElementById("modalOverlay")
          .addEventListener("click", hideModal);
        document
          .getElementById("modalCloseBtn")
          .addEventListener("click", hideModal);
        document
          .getElementById("helpBtn")
          .addEventListener("click", showHelpModal);
      });

      function handleAnalysis() {
        // データがまだ読み込めていない場合は何もしない
        if (!HAQEI_DATA) {
          showModal(
            `<h2 class="text-2xl font-bold text-yellow-400 mb-4">データ読込中</h2><p>まだデータの準備が完了していません。もうしばらくお待ちください。</p>`
          );
          return;
        }

        const hexagramInput = document
          .getElementById("hexagramInput")
          .value.trim();
        const lineNum = parseInt(document.getElementById("lineInput").value);
        let hexNum = parseInt(hexagramInput);
        if (isNaN(hexNum)) {
          const foundHex = H64_DATA.find((h) => h.名前 === hexagramInput);
          hexNum = foundHex ? foundHex.卦番号 : null;
        }
        if (
          !hexNum ||
          isNaN(lineNum) ||
          typeof H384_DATA === "undefined" ||
          H384_DATA.length === 0
        ) {
          showModal(
            `<h2 class="text-2xl font-bold text-red-400 mb-4">入力エラー</h2><p>有効な卦と爻を入力してください。</p>`
          );
          return;
        }
        const allPaths = generateAllPaths(hexNum, lineNum);
        if (allPaths.length === 0) {
          showModal(
            `<h2 class="text-2xl font-bold text-red-400 mb-4">分析エラー</h2><p>未来予測パスを生成できませんでした。入力値またはデータを確認してください。</p>`
          );
          return;
        }
        const sortedPaths = allPaths.sort(
          (a, b) => b[3].S7_総合評価スコア - a[3].S7_総合評価スコア
        );
        updateUI(sortedPaths);
      }

      // ▼▼▼【テキスト省略修正版 v9.10】updateUI関数 ▼▼▼
      function updateUI(sortedPaths) {
        document.getElementById("initialMessage").classList.add("hidden");
        document.getElementById("resultArea").classList.remove("hidden");

        const startState = sortedPaths[0][0];

        document.getElementById(
          "currentTitle"
        ).innerText = `現在地: ${startState["親となる卦"]} ${startState.爻}`;
        document.getElementById("currentKeywords").innerText = `テーマ: ${
          startState.キーワード || ""
        }`;
        document.getElementById("currentSummary").innerText =
          startState.現代解釈の要約;

        const currentScore = startState.S7_総合評価スコア;
        const scoreEval = getScoreEvaluation(currentScore);
        document.getElementById(
          "currentScore"
        ).innerText = `${currentScore} 点`;
        const scoreLabel = document.getElementById("currentScoreLabel");
        scoreLabel.innerText = scoreEval.label;
        scoreLabel.className = `eval-label ${scoreEval.colorClass}`;
        document.getElementById(
          "currentScoreDesc"
        ).innerText = `※ ${scoreEval.desc}`;

        const transitionCost = 100 - (startState.S6_変動性スコア || 50);
        const costEval = getTransitionCostEvaluation(transitionCost);
        document.getElementById(
          "transitionCost"
        ).innerText = `${transitionCost} 点`;
        const costLabel = document.getElementById("transitionCostLabel");
        costLabel.innerText = costEval.label;
        costLabel.className = `eval-label ${costEval.colorClass}`;
        document.getElementById(
          "transitionCostDesc"
        ).innerText = `※ ${costEval.desc}`;

        document.getElementById("summaryCard").onclick = () =>
          showCurrentStateModal(startState);

        const targetName = `${startState.卦名} ${startState.爻}`;
        const guidelineData =
          typeof koudo !== "undefined"
            ? koudo.find((item) => item.name === targetName)
            : null;

        const actionContainer = document.getElementById("firstActionContainer");

        if (guidelineData) {
          const tooltipText =
            "【進】とは現在のテーマに沿って着実に進む選択です。【変】とは、状況を打開するために異なるアプローチを取り入れる選択です。";
          actionContainer.innerHTML = `
        <div class="mt-4 pt-4 border-t border-yellow-400/30">
            <h4 class="font-bold text-yellow-300 mb-3 flex items-center">
                最初の行動選択
                <span class="ml-2 text-xs bg-gray-600 rounded-full h-4 w-4 flex items-center justify-center cursor-help" title="${tooltipText}">?</span>
            </h4>
            <div class="space-y-3">
                <div class="p-3 rounded-lg bg-teal-900/40 border border-teal-700/60">
                    <p class="font-bold text-teal-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-8.707l-3-3a1 1 0 00-1.414 0l-3 3a1 1 0 001.414 1.414L9 9.414V13a1 1 0 102 0V9.414l1.293 1.293a1 1 0 001.414-1.414z" clip-rule="evenodd" /></svg>
                        【進】テーマを深化させる
                    </p>
                    <p class="text-xs text-gray-300 mt-1 full-text">${guidelineData.shin}</p>
                </div>
                <div class="p-3 rounded-lg bg-purple-900/40 border border-purple-700/60">
                    <p class="font-bold text-purple-300 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM14 11a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1h-1a1 1 0 110-2h1v-1a1 1 0 011-1z" /></svg>
                        【変】状況を転換する
                    </p>
                    <p class="text-xs text-gray-300 mt-1 full-text">${guidelineData.hen}</p>
                </div>
            </div>
        </div>
    `;
        } else {
          actionContainer.innerHTML = "";
        }

        renderSummaryChart(sortedPaths);
        renderDetailCards(sortedPaths);
        renderChartToggles(sortedPaths);
        setupInteraction();
      }

      function getScoreEvaluation(score) {
        if (score >= 80)
          return {
            label: "Excellent",
            colorClass: "bg-green-500 text-white",
            desc: "非常に良い状況です。",
          };
        if (score >= 60)
          return {
            label: "Good",
            colorClass: "bg-emerald-500 text-white",
            desc: "良い状況です。チャンスを活かしましょう。",
          };
        if (score >= 40)
          return {
            label: "Average",
            colorClass: "bg-yellow-500 text-white",
            desc: "平均的な状況。油断は禁物です。",
          };
        if (score >= 20)
          return {
            label: "Poor",
            colorClass: "bg-orange-500 text-white",
            desc: "厳しい状況。慎重な判断が必要です。",
          };
        return {
          label: "Critical",
          colorClass: "bg-red-600 text-white",
          desc: "極めて危険な状況。抜本的な対策が必要です。",
        };
      }

      function getTransitionCostEvaluation(cost) {
        if (cost <= 20)
          return {
            label: "絶好機",
            colorClass: "bg-sky-500 text-white",
            desc: "極めて変化しやすい絶好のチャンス期間です。",
          };
        if (cost <= 40)
          return {
            label: "好機",
            colorClass: "bg-teal-500 text-white",
            desc: "変化を起こしやすい好機です。",
          };
        if (cost <= 60)
          return {
            label: "普通",
            colorClass: "bg-gray-500 text-white",
            desc: "変化には相応のエネルギーが必要です。",
          };
        if (cost <= 80)
          return {
            label: "困難",
            colorClass: "bg-rose-500 text-white",
            desc: "変化は困難。現状維持も視野に。",
          };
        return {
          label: "膠着",
          colorClass: "bg-zinc-700 text-white",
          desc: "変化は極めて困難。今は動くべき時ではありません。",
        };
      }

      function evaluateSpiralProgress(currentState, futureState) {
        const changes = {
          sogo: futureState.S7_総合評価スコア - currentState.S7_総合評価スコア,
          antei: futureState.S3_安定性スコア - currentState.S3_安定性スコア,
          senzai: futureState.S2_ポテンシャル - currentState.S2_ポテンシャル,
          risk: currentState.S4_リスク - futureState.S4_リスク,
        };
        const EXCELLENT_SCORE_THRESHOLD = 75,
          SOGO_LARGE_UP_THRESHOLD = 15,
          SOGO_UP_THRESHOLD = 5,
          SOGO_STAGNATE_THRESHOLD = -2,
          SENZAI_LARGE_UP_THRESHOLD = 10,
          ANTEI_UP_THRESHOLD = 5,
          RISK_LARGE_DOWN_THRESHOLD = 10,
          STAGNATE_THRESHOLD = 2;
        if (changes.sogo >= SOGO_LARGE_UP_THRESHOLD)
          return futureState.S7_総合評価スコア >= EXCELLENT_SCORE_THRESHOLD
            ? {
                trend: "飛躍的成長",
                message:
                  "素晴らしい飛躍です！状況が劇的に好転し、高評価の領域に到達しました。",
                colorClass: "trend-up",
              }
            : {
                trend: "急回復",
                message:
                  "危機的状況から急速に回復しています。大きな前進ですが、まだ道半ばです。",
                colorClass: "trend-recovery",
              };
        if (changes.sogo >= SOGO_UP_THRESHOLD) {
          if (changes.antei >= 0)
            return {
              trend: "安定的成長",
              message: "理想的な進歩です。着実に階段を上っています。",
              colorClass: "trend-up",
            };
          if (changes.senzai > 0)
            return {
              trend: "発展的成長",
              message: "良い成長です。将来の可能性を広げながら前進しています。",
              colorClass: "trend-invest",
            };
          return {
            trend: "成長",
            message:
              "状況は好転しています。安定性も意識すると更に良いでしょう。",
            colorClass: "trend-up",
          };
        }
        if (changes.sogo > SOGO_STAGNATE_THRESHOLD) {
          if (changes.senzai >= SENZAI_LARGE_UP_THRESHOLD)
            return {
              trend: "未来への投資",
              message:
                "未来への良い投資ができています。次のステップで大きく飛躍する可能性があります。",
              colorClass: "trend-invest",
            };
          if (changes.antei >= ANTEI_UP_THRESHOLD && changes.risk >= 0)
            return {
              trend: "良い停滞",
              message:
                "賢明な停滞です。次の一歩のための安全な足場を固めています。",
              colorClass: "trend-stable",
            };
          if (
            Math.abs(changes.sogo) < STAGNATE_THRESHOLD &&
            Math.abs(changes.antei) < STAGNATE_THRESHOLD
          )
            return {
              trend: "注意すべき停滞",
              message:
                "状況が停滞しています。新しい視点や行動のきっかけを探す時期かもしれません。",
              colorClass: "trend-stagnate",
            };
        }
        if (changes.risk >= RISK_LARGE_DOWN_THRESHOLD)
          return {
            trend: "戦略的下降",
            message:
              "賢明なリスク管理です。大きな問題を回避するための戦略的な一歩です。",
            colorClass: "trend-risk-mgmt",
          };
        if (changes.risk < 0)
          return {
            trend: "危険な下降",
            message:
              "注意が必要です。状況が悪化する可能性があります。原因を見直すべきです。",
            colorClass: "trend-down",
          };
        return {
          trend: "下降傾向",
          message:
            "状況が少し後退しています。原因を分析し、次の手を考えましょう。",
          colorClass: "trend-down",
        };
      }

      function renderSummaryChart(sortedPaths) {
        if (summaryChartInstance) summaryChartInstance.destroy();
        const ctx = document.getElementById("summaryChart").getContext("2d");
        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];
        const currentScore = sortedPaths[0][0].S7_総合評価スコア;
        const datasets = sortedPaths.map((path, index) => {
          const isTop = index < 4;
          return {
            label: `シナリオ ${index + 1}`,
            data: path.map((p) => p.S7_総合評価スコア),
            borderColor: isTop ? topColors[index] : bottomColors[index - 4],
            borderWidth: isTop ? 3.5 : 1.5,
            tension: 0.1,
            pointRadius: 4,
            pointBackgroundColor: "white",
            pointHoverRadius: 6,
          };
        });
        summaryChartInstance = new Chart(ctx, {
          type: "line",
          data: {
            labels: ["現在地", "フェーズ1", "フェーズ2", "フェーズ3"],
            datasets: datasets,
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                min: 0,
                max: 100,
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(255, 255, 255, 0.1)" },
              },
              x: {
                ticks: { color: "#9ca3af" },
                grid: { color: "rgba(255, 255, 255, 0.1)" },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: { mode: "index", intersect: false },
              annotation: {
                annotations: {
                  currentScoreLine: {
                    type: "line",
                    yMin: currentScore,
                    yMax: currentScore,
                    borderColor: "rgb(253, 224, 71)",
                    borderWidth: 2,
                    borderDash: [6, 6],
                    label: {
                      content: "現在地のスコア",
                      enabled: true,
                      position: "end",
                      backgroundColor: "rgba(253, 224, 71, 0.8)",
                      color: "black",
                      font: { size: 10 },
                    },
                  },
                },
              },
            },
          },
        });
      }

      function renderDetailCards(sortedPaths) {
        const container = document.getElementById("detailCardsContainer");
        container.innerHTML = "";
        const rankLabels = ["S", "A", "B", "C", "D", "E", "F", "H"];
        sortedPaths.forEach((path, index) => {
          const finalState = path[path.length - 1];
          const overallTrend = evaluateSpiralProgress(path[0], path[3]);
          const firstStepTrend = evaluateSpiralProgress(path[0], path[1]);

          const card = document.createElement("div");
          const rankClass = `rank-${rankLabels[index].toLowerCase()}`;
          card.id = `card-${index}`;
          card.className =
            "card bg-gray-900/50 p-4 rounded-xl border-2 border-transparent transition-all duration-300 flex flex-col";
          card.dataset.index = index;
          card.addEventListener("click", () =>
            showScenarioModal(path, index, overallTrend, firstStepTrend)
          );

          const pathHistory = path
            .slice(1)
            .map((p) => (p.choice === "change" ? "変" : "進"))
            .join(" → ");
          const finalStateTitle = `${finalState["親となる卦"]} ${finalState.爻}`;

          card.innerHTML = `
            <div class="flex items-start justify-between mb-2">
                <h3 class="text-md font-bold text-gray-300">シナリオ ${
                  index + 1
                }</h3>
                <span class="rank-badge ${rankClass}">${
            rankLabels[index]
          }</span>
            </div>
            <div class="text-xs text-gray-500 mb-3" style="min-height: 1em;">経路: ${pathHistory}</div>
            <div class="grid grid-cols-2 gap-2 mb-3 text-center">
                <div>
                    <p class="text-[10px] text-gray-400 mb-1 font-semibold">全体トレンド</p>
                    <div class="trend-badge ${
                      overallTrend.colorClass
                    }" title="${overallTrend.message}">${
            overallTrend.trend
          }</div>
                </div>
                <div>
                    <p class="text-[10px] text-gray-400 mb-1 font-semibold">初期ステップ</p>
                    <div class="trend-badge ${
                      firstStepTrend.colorClass
                    }" title="${firstStepTrend.message}">${
            firstStepTrend.trend
          }</div>
                </div>
            </div>
            <p class="text-lg font-semibold text-indigo-300 mt-auto pt-2 border-t border-gray-700/50">${finalStateTitle}</p>
            <div class="my-3" style="height: 110px; padding-left: 5px;">
                <canvas id="miniChart-${index}"></canvas>
            </div>
            <p class="text-xs text-gray-400 mt-1">${
              finalState.現代解釈の要約
            }</p>
        `;

          container.appendChild(card);
          renderMiniBarChart(index, finalState);
        });
      }

      function renderMiniBarChart(index, state) {
        const ctx = document
          .getElementById(`miniChart-${index}`)
          .getContext("2d");
        const data = [
          state.S1_基本スコア,
          state.S2_ポテンシャル,
          state.S3_安定性スコア,
          Math.abs(state.S4_リスク),
          state.S6_変動性スコア,
        ];
        const colors = [
          "rgba(96, 165, 250, 0.7)",
          "rgba(52, 211, 153, 0.7)",
          "rgba(167, 139, 250, 0.7)",
          "rgba(248, 113, 113, 0.7)",
          "rgba(251, 191, 36, 0.7)",
        ];
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["基本", "潜在力", "安定性", "リスク", "変動性"],
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderWidth: 0,
                barPercentage: 0.8,
                categoryPercentage: 0.9,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            scales: {
              x: { display: false, min: 0, max: 100 },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: "#9ca3af", font: { size: 10 } },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
          },
        });
      }

      function renderChartToggles(sortedPaths) {
        const container = document.getElementById("chartToggles");
        container.innerHTML = "";
        sortedPaths.forEach((path, index) => {
          const color = summaryChartInstance.data.datasets[index].borderColor;
          const finalScore = path[path.length - 1].S7_総合評価スコア;
          const overallTrend = evaluateSpiralProgress(path[0], path[3]);

          const wrapper = document.createElement("div");
          wrapper.className = "w-full sm:w-auto";

          const checkbox = document.createElement("input");
          checkbox.type = "checkbox";
          checkbox.id = `toggle-${index}`;
          checkbox.checked = true;
          checkbox.className = "hidden";

          const label = document.createElement("label");
          label.htmlFor = `toggle-${index}`;
          label.className = "toggle-label text-xs p-2 mb-1";
          label.dataset.index = index;
          label.title = `最終スコア: ${finalScore}, 全体トレンド: ${overallTrend.trend} (${overallTrend.message})`;

          label.innerHTML = `<span class="toggle-legend" style="background-color: ${color};"></span><span>シナリオ ${
            index + 1
          } (${finalScore}点)</span>`;

          checkbox.addEventListener("change", () => {
            const isVisible = checkbox.checked;
            summaryChartInstance.setDatasetVisibility(index, isVisible);
            label.style.opacity = isVisible ? "1" : "0.5";
            summaryChartInstance.update();
          });

          wrapper.appendChild(checkbox);
          wrapper.appendChild(label);
          container.appendChild(wrapper);
        });
      }

      function showModal(content) {
        const modalBody = document.getElementById("modalBody");
        modalBody.innerHTML = content;
        const modalContainer = document.getElementById("modalContainer");
        modalContainer.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        setTimeout(() => {
          document.getElementById("modalOverlay").classList.remove("opacity-0");
          document.getElementById("modalContent").classList.remove("scale-95");
        }, 10);
      }

      function showCurrentStateModal(state) {
        const scoresHtml = `...`;
        const modalContentHtml = `...`;
        showModal(modalContentHtml);
      }

      function showScenarioModal(path, index, overallTrend, firstStepTrend) {
        const rankLabels = ["S", "A", "B", "C", "D", "E", "F", "H"];
        const rankClass = `rank-${rankLabels[index].toLowerCase()}`;
        let trendHtml = "";
        if (firstStepTrend && firstStepTrend.trend === "危険な下降") {
          trendHtml = `<div class="p-3 rounded-lg mb-4 bg-red-900/80 border border-red-600 text-sm"><p class="font-bold text-red-200">【注意】最初のステップは危険な下降です</p><p class="text-xs text-gray-200 mt-1">このシナリオは最終的に「${overallTrend.trend}」を目指しますが、初期段階で状況が大きく悪化するリスクを伴います。</p></div>`;
        } else {
          trendHtml = `<div class="p-3 rounded-lg mb-4 ${overallTrend.colorClass}">
            <h3 class="font-bold text-lg">${overallTrend.trend}</h3>
            <p class="text-sm mt-1">${overallTrend.message}</p>
        </div>`;
        }
        let modalContentHtml = `
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-2xl font-bold text-indigo-300">シナリオ ${
              index + 1
            } の詳細</h2>
            <span class="rank-badge ${rankClass} text-lg">${
          rankLabels[index]
        }</span>
        </div>
        ${trendHtml} 
    `;
        const getScoreDiffHtml = (currentScore, prevScore) => {
          if (typeof prevScore !== "number") return "";
          const diff = Math.round((currentScore - prevScore) * 10) / 10;
          let icon = "";
          let colorClass = "diff-zero";
          if (diff > 0) {
            icon = "▲";
            colorClass = "diff-up";
          } else if (diff < 0) {
            icon = "▼";
            colorClass = "diff-down";
          } else {
            return `<span class="ml-2 text-xs w-10 text-center ${colorClass}">±0</span>`;
          }
          return `<span class="ml-2 text-xs w-10 text-left flex items-center ${colorClass}">${icon}${Math.abs(
            diff
          )}</span>`;
        };
        path.forEach((step, stepIndex) => {
          const phaseLabels = [
            "現在地",
            "フェーズ1",
            "フェーズ2",
            "最終到達点",
          ];
          const isYongYao = step.爻 === "用九" || step.爻 === "用六";
          const previousStep = stepIndex > 0 ? path[stepIndex - 1] : null;
          const stepWrapperClass = isYongYao ? "yong-yao-step" : "";
          const stepTitleIcon = isYongYao
            ? '<span class="yong-yao-title-icon">☯</span>'
            : "";
          const s1_diff = getScoreDiffHtml(
            step.S1_基本スコア,
            previousStep?.S1_基本スコア
          );
          const s2_diff = getScoreDiffHtml(
            step.S2_ポテンシャル,
            previousStep?.S2_ポテンシャル
          );
          const s3_diff = getScoreDiffHtml(
            step.S3_安定性スコア,
            previousStep?.S3_安定性スコア
          );
          const s4_diff = getScoreDiffHtml(
            step.S4_リスク,
            previousStep?.S4_リスク
          );
          const s6_diff = getScoreDiffHtml(
            step.S6_変動性スコア,
            previousStep?.S6_変動性スコア
          );
          const s7_diff = getScoreDiffHtml(
            step.S7_総合評価スコア,
            previousStep?.S7_総合評価スコア
          );
          let stepHtml = `<div class="py-4 px-4 border-b border-gray-700 last:border-b-0 ${stepWrapperClass}">
            <h4 class="text-lg font-semibold text-gray-100 flex items-center">${
              phaseLabels[stepIndex]
            }: ${step["親となる卦"]} ${step.爻} ${stepTitleIcon}</h4>
            <p class="text-sm text-yellow-300 my-1">テーマ: ${
              step.キーワード || ""
            }</p>
            <p class="text-xs text-gray-400 mt-1">${step.現代解釈の要約}</p>
            <div class="mt-4 grid grid-cols-2 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs">
                <div class="flex justify-between items-center"><span class="text-gray-400">基本:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
                  step.S1_基本スコア
                }</span>${s1_diff}</div></div>
                <div class="flex justify-between items-center"><span class="text-gray-400">ポテンシャル:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
                  step.S2_ポテンシャル
                }</span>${s2_diff}</div></div>
                <div class="flex justify-between items-center"><span class="text-gray-400">安定性:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
                  step.S3_安定性スコア
                }</span>${s3_diff}</div></div>
                <div class="flex justify-between items-center"><span class="text-gray-400">リスク:</span><div class="flex items-center"><span class="font-mono w-6 text-right text-red-400">${
                  step.S4_リスク
                }</span>${s4_diff}</div></div>
                <div class="flex justify-between items-center"><span class="text-gray-400">変動性:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
                  step.S6_変動性スコア
                }</span>${s6_diff}</div></div>
                <div class="flex justify-between items-center"><span class="text-gray-400">主体性:</span><span>${
                  step.S5_主体性
                }</span></div>
                <div class="col-span-full flex justify-between items-center font-bold border-t border-gray-600 pt-2 mt-2">
                    <span class="text-gray-300">総合評価:</span>
                    <div class="flex items-center">
                        <span class="font-mono text-lg text-indigo-300">${
                          step.S7_総合評価スコア
                        }</span>
                        ${s7_diff
                          .replace("text-xs", "text-sm")
                          .replace("w-10", "w-12")}
                    </div>
                </div>
            </div>`;
          if (stepIndex < path.length - 1) {
            const nextStep = path[stepIndex + 1];
            const targetName = `${step["親となる卦"]} ${step.爻}`;
            const guidelineData =
              typeof koudo !== "undefined"
                ? koudo.find((item) => item.name === targetName)
                : null;
            let actionGuidelineTitle = "",
              actionGuidelineText = "",
              bgColor = "";
            if (guidelineData) {
              if (nextStep.choice === "change") {
                actionGuidelineTitle = `<p class="font-bold text-purple-300">行動指針【変】：状況を転換する</p>`;
                actionGuidelineText = `<p class="text-xs text-gray-300 mt-1">${guidelineData.hen}</p>`;
                bgColor = "bg-purple-900/40 border border-purple-700/60";
              } else {
                actionGuidelineTitle = `<p class="font-bold text-teal-300">行動指針【進】：テーマを深化させる</p>`;
                actionGuidelineText = `<p class="text-xs text-gray-300 mt-1">${guidelineData.shin}</p>`;
                bgColor = "bg-teal-900/40 border border-teal-700/60";
              }
            } else {
              actionGuidelineTitle = `<p class="font-bold text-yellow-400">行動指針</p>`;
              actionGuidelineText = `<p class="text-xs text-gray-500 mt-1">（行動指針データが見つかりませんでした。）</p>`;
              bgColor = "bg-gray-700/50 border border-gray-600";
            }
            stepHtml += `<div class="mt-4 pt-4 border-t border-gray-700/50"><div class="p-3 rounded-lg text-sm ${bgColor}">${actionGuidelineTitle}${actionGuidelineText}</div></div>`;
          }
          stepHtml += `</div>`;
          modalContentHtml += stepHtml;
        });
        showModal(modalContentHtml);
      }

      function showHelpModal() {
        const helpContentHtml = `...`; // 省略
        showModal(helpContentHtml);
      }

      function hideModal() {
        const modalContainer = document.getElementById("modalContainer");
        document.getElementById("modalOverlay").classList.add("opacity-0");
        document.getElementById("modalContent").classList.add("scale-95");
        setTimeout(() => {
          modalContainer.classList.add("hidden");
          document.body.style.overflow = "";
        }, 300);
      }

      function highlightScenario(index) {
        if (summaryChartInstance) {
          summaryChartInstance.data.datasets.forEach((dataset, i) => {
            dataset.borderWidth = i === index ? 5 : i < 4 ? 3.5 : 1.5;
          });
          summaryChartInstance.update("none");
        }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => {
          el.classList.remove("highlighted");
        });
        document.getElementById(`card-${index}`)?.classList.add("highlighted");
        document
          .querySelector(`.toggle-label[data-index='${index}']`)
          ?.classList.add("highlighted");
      }

      function clearHighlights() {
        if (summaryChartInstance) {
          summaryChartInstance.data.datasets.forEach((dataset, i) => {
            dataset.borderWidth = i < 4 ? 3.5 : 1.5;
          });
          summaryChartInstance.update("none");
        }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => {
          el.classList.remove("highlighted");
        });
      }

      function setupInteraction() {
        const chartToggles = document.getElementById("chartToggles");
        const detailCards = document.getElementById("detailCardsContainer");
        const chartCanvas = document.getElementById("summaryChart");

        const handleMouseOver = (e) => {
          const target = e.target.closest("[data-index]");
          if (target) {
            const index = parseInt(target.dataset.index, 10);
            highlightScenario(index);
          }
        };

        chartToggles.addEventListener("mouseover", handleMouseOver);
        detailCards.addEventListener("mouseover", handleMouseOver);

        chartToggles.addEventListener("mouseleave", clearHighlights);
        detailCards.addEventListener("mouseleave", clearHighlights);
        chartCanvas.addEventListener("mouseleave", clearHighlights);

        chartCanvas.onmousemove = (evt) => {
          const activeElements = summaryChartInstance.getElementsAtEventForMode(
            evt,
            "index",
            { intersect: false },
            true
          );
          if (activeElements.length > 0) {
            highlightScenario(activeElements[0].datasetIndex);
          }
        };
      }

      const findLineDataByNum = (hexNum, lineNum) => {
        if (lineNum < 1 || lineNum > 6) return null;
        if (typeof H384_DATA === "undefined") return null;
        const lineName = ["初", "二", "三", "四", "五", "上"][lineNum - 1];
        return H384_DATA.find(
          (line) => line.卦番号 === hexNum && line.爻.includes(lineName)
        );
      };
      const findYongYaoData = (hexNum) => {
        if (typeof H384_DATA === "undefined") return null;
        const yongName = hexNum === 1 ? "用九" : "用六";
        return H384_DATA.find(
          (line) => line.卦番号 === hexNum && line.爻 === yongName
        );
      };

      const findHexData = (hexNum) => {
        if (typeof H64_DATA === "undefined") return null;
        return H64_DATA.find((hex) => hex.卦番号 === hexNum);
      };

      const getNextState = (currentState, choice) => {
        let nextHexNum, nextLineNum;
        const currentLineNum = currentState.lineNum;
        const currentHexNum = currentState.卦番号;
        if (currentState.爻 === "用九") {
          const data = findLineDataByNum(2, 1);
          if (!data) return null;
          return { ...data, lineNum: 1, choice: "stagnate" };
        }
        if (currentState.爻 === "用六") {
          const data = findLineDataByNum(1, 1);
          if (!data) return null;
          return { ...data, lineNum: 1, choice: "stagnate" };
        }

        if (choice === "stagnate") {
          if (
            (currentHexNum === 1 || currentHexNum === 2) &&
            currentLineNum === 6
          ) {
            const yongData = findYongYaoData(currentHexNum);
            if (yongData) {
              return { ...yongData, lineNum: 7, choice: "stagnate" };
            }
          }

          nextHexNum = currentHexNum;
          nextLineNum = currentLineNum >= 6 ? 1 : currentLineNum + 1;
        } else {
          const currentHexData = findHexData(currentHexNum);
          if (!currentHexData) return null;
          const lineKeys = [
            "初爻変",
            "二爻変",
            "三爻変",
            "四爻変",
            "五爻変",
            "上爻変",
          ];
          nextHexNum = currentHexData[lineKeys[currentLineNum - 1]];
          nextLineNum = currentLineNum;
        }
        const data = findLineDataByNum(nextHexNum, nextLineNum);
        if (!data) return null;
        return { ...data, lineNum: nextLineNum, choice: choice };
      };

      function generateAllPaths(startHex, startLine) {
        const startData = findLineDataByNum(startHex, startLine);
        if (!startData) return [];
        const initialState = {
          ...startData,
          lineNum: startLine,
          choice: "start",
        };
        let paths = [[initialState]];
        for (let i = 0; i < 3; i++) {
          const newPaths = [];
          for (const path of paths) {
            const lastState = path[path.length - 1];
            const stagnateState = getNextState(lastState, "stagnate");
            if (stagnateState) newPaths.push([...path, stagnateState]);
            const changeState = getNextState(lastState, "change");
            if (changeState) newPaths.push([...path, changeState]);
          }
          paths = newPaths;
        }
        return paths.filter((p) => p.length === 4);
      }
    </script>
  </body>
</html>
