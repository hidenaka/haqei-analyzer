<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>æ˜“</text></svg>"
    />
    
    <!-- Load critical path scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Defer non-critical scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js" defer></script>
    
    <!-- Quality Enhancement System -->
    <link rel="stylesheet" href="./css/quality-grade-enhancement.css">
    <script src="./js/quality-enhancement-ui.js" defer></script>
    <script src="./js/dynamic-quality-optimizer.js" defer></script>
    <script src="./js/quality-integration-manager.js" defer></script>
    <script src="./js/quality-system-validator.js" defer></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      
      /* Progressive Loading Styles */
      .skeleton {
        background: linear-gradient(90deg, rgba(55, 65, 81, 0.1) 25%, rgba(75, 85, 99, 0.2) 37%, rgba(55, 65, 81, 0.1) 63%);
        background-size: 400% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
      }
      
      @keyframes skeleton-loading {
        0% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .skeleton-text {
        height: 1em;
        border-radius: 4px;
        margin: 0.5em 0;
      }
      
      .skeleton-button {
        height: 3em;
        border-radius: 8px;
        width: 100%;
      }
      
      .skeleton-card {
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .skeleton-chart {
        height: 300px;
        border-radius: 8px;
      }
      
      .fade-in {
        animation: fadeIn 0.6s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(17, 24, 39, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: opacity 0.3s ease;
      }
      
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(165, 180, 252, 0.3);
        border-left: 4px solid #a5b4fc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      .card:hover,
      .card.highlighted {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      .rank-badge {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 9999px;
        line-height: 1;
      }
      .rank-s,
      .rank-a,
      .rank-b,
      .rank-c {
        background-color: rgba(74, 222, 128, 0.2);
        color: #86efac;
        border: 1px solid #22c55e;
      }
      .rank-d {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #fbbf24;
      }
      .rank-e,
      .rank-f,
      .rank-g {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .rank-h {
        background-color: rgba(185, 28, 28, 0.2);
        color: #fca5a5;
        border: 1px solid #dc2626;
      }

      /* Data Export Styles */
      .data-export-section {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .export-button {
        background: linear-gradient(45deg, #3b82f6, #6366f1);
        transition: all 0.3s ease;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        display: flex;
        items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
      }
      
      .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      }
      
      .progressive-load {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.6s ease;
      }
      
      .progressive-load.loaded {
        opacity: 1;
        transform: translateY(0);
      }

      /* ğŸŒŸ Authentic I Ching System Styles */
      .authentic-scenarios-container,
      .authentic-choice-container,
      .current-position-container {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }

      .scenario-card, .choice-card {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .scenario-card:hover, .choice-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        border-color: rgba(99, 102, 241, 0.7);
      }

      .scenario-card.selected, .choice-card.selected {
        border-color: #6366f1;
        background: rgba(99, 102, 241, 0.2);
      }

      .hexagram-line {
        display: flex;
        align-items: center;
        margin: 0.25rem 0;
        font-family: monospace;
      }

      .hexagram-line.yang .line-symbol {
        color: #fbbf24;
      }

      .hexagram-line.yin .line-symbol {
        color: #93c5fd;
      }

      .hexagram-line.current {
        background: rgba(245, 101, 101, 0.2);
        border-radius: 4px;
        padding: 0.25rem;
      }

      .transformation-visual {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 1rem 0;
      }

      .transformation-arrow {
        font-size: 1.5rem;
        color: #6366f1;
        margin: 0 1rem;
      }

      .bunenjin-analysis .persona-analysis {
        background: rgba(31, 41, 55, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
      }

      .fade-in {
        opacity: 0;
        animation: fadeInUp 0.6s ease forwards;
      }

      .fade-in.visible {
        opacity: 1;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
    
    <!-- Core System Assets -->
    <script src="./assets/H384H64data.js"></script>
    <script src="./js/core/IChingTransformationEngine.js"></script>
    <script src="./js/pages/future-simulator/FutureBranchingSystem.js"></script>
    <script src="./js/core/DataPersistenceManager.js"></script>
    <script src="./js/core/DataExportAPI.js"></script>
    
    <!-- H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèª -->
    <script>
        (function() {
            console.log('ğŸ” H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèªã‚’é–‹å§‹...');
            
            if (typeof H384_DATA === 'undefined') {
                console.error('âŒ H384_DATAå¤‰æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                console.warn('âš ï¸  ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’è©¦è¡Œä¸­...');
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: window.H384_DATAã‚’ç¢ºèª
                if (typeof window.H384_DATA !== 'undefined') {
                    console.log('âœ… window.H384_DATAã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ');
                    window.H384_DATA = window.H384_DATA;
                } else {
                    console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚‚åˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            } else {
                console.log('âœ… H384_DATAå¤‰æ•°ã®å­˜åœ¨ç¢ºèª: æˆåŠŸ');
                
                // window.H384_DATAã¸ã®ä»£å…¥ç¢ºèª
                if (typeof window.H384_DATA === 'undefined') {
                    console.warn('âš ï¸  window.H384_DATAãŒæœªè¨­å®š - è‡ªå‹•è¨­å®šã‚’è©¦è¡Œ');
                    try {
                        window.H384_DATA = H384_DATA;
                        console.log('âœ… window.H384_DATAè‡ªå‹•è¨­å®š: æˆåŠŸ');
                    } catch (error) {
                        console.error('âŒ window.H384_DATAè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ã®åŸºæœ¬ç¢ºèª
                if (Array.isArray(window.H384_DATA) && window.H384_DATA.length === 386) {
                    console.log('âœ… H384_DATAãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ç¢ºèª: æˆåŠŸ (386ã‚¨ãƒ³ãƒˆãƒª)');
                    
                    // ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã®ç¢ºèª
                    const youkuu = window.H384_DATA.find(item => item['é€šã—ç•ªå·'] === 7);
                    const yourikuu = window.H384_DATA.find(item => item['é€šã—ç•ªå·'] === 14);
                    
                    if (youkuu && yourikuu) {
                        console.log('âœ… ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªç¢ºèª: æˆåŠŸ');
                        console.log(`   - ç”¨ä¹: ${youkuu['å¦å']} (${youkuu['çˆ»']})`);
                        console.log(`   - ç”¨å…­: ${yourikuu['å¦å']} (${yourikuu['çˆ»']})`);
                    } else {
                        console.warn('âš ï¸  ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                    }
                } else {
                    console.error('âŒ H384_DATAãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼:', {
                        isArray: Array.isArray(window.H384_DATA),
                        length: window.H384_DATA?.length
                    });
                }
            }
            
            console.log('ğŸ H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèªå®Œäº†');
        })();
    </script>
    <script src="./js/keyword_expansion_engine.js"></script>
    <script src="./js/ml-integration.js" async defer></script>
    <!-- Offline-First Dictionary System -->
    <script src="./js/core/DictionaryManager.js" defer></script>
    <script src="./js/core/OfflineDetector.js" defer></script>
    <script src="./js/core/OfflineKuromojiInitializer.js" defer></script>
    <script src="./js/core/offline-kuromoji-integration.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js" defer></script>
    <!-- Advanced Analysis Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/ml-matrix@6.10.4/lib/ml-matrix.min.js"></script>
    <!-- Dynamic Analysis Components -->
    <script src="./js/pages/future-simulator/DynamicKeywordGenerator.js"></script>
    <script src="./js/pages/future-simulator/IntegratedAnalysisEngine.js"></script>
    <script src="./js/pages/future-simulator/MultiDimensionalContextAnalyzer.js"></script>
    <script src="./js/pages/future-simulator/SituationalContextEngine.js"></script>
    <script src="./js/pages/future-simulator/HexagramMappingEngine.js"></script>
    <script src="./js/pages/future-simulator/MetaphorGenerationEngine.js"></script>
    
    <!-- ğŸŒŸ Authentic I Ching System Components -->
    <script src="./js/core/AuthenticIChingEngine.js"></script>
    <script src="./js/components/CurrentPositionDisplay.js"></script>
    <script src="./js/components/AuthenticChoiceSystem.js"></script>
    <script src="./js/components/Authentic8ScenariosSystem.js"></script>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6">
    <!-- Initial Loading Screen -->
    <div id="initial-loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
      <div class="text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h1 class="text-2xl font-bold brand-text mb-2">HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</h1>
        <p class="text-gray-400">ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...</p>
        <div class="mt-4 w-64 bg-gray-700 rounded-full h-2">
          <div id="loading-progress" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>
    
    <div
      class="w-full max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8 opacity-0"
      id="main-container"
    >
      <header class="text-center mb-8 relative">
        <a href="./" class="inline-block">
          <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
            HaQei
          </h1>
          <p class="text-gray-400 mt-2 text-lg">ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</p>
        </a>
        <button
          id="helpBtn"
          class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.25l-2.536 2.39c-.832.786-1.464 1.49-1.464 2.36h.001M12 18h.01"
            />
          </svg>
        </button>
      </header>

      <!-- Input Section with Skeleton -->      
      <div class="bg-gray-900/50 p-6 rounded-xl mb-4 relative progressive-load" id="input-section">
        <!-- Skeleton for Input Section -->
        <div class="skeleton-input" id="input-skeleton">
          <div class="skeleton skeleton-text" style="width: 60%; height: 1.5rem; margin-bottom: 1rem;"></div>
          <div class="skeleton skeleton-card">
            <div class="skeleton skeleton-text" style="width: 100%; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text" style="width: 80%; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text" style="width: 90%;"></div>
          </div>
          <div class="skeleton skeleton-text" style="width: 100%; height: 4rem; margin: 1rem 0;"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        
        <!-- Actual Input Content -->
        <div class="input-content" id="input-content" style="display: none;">
          <h2 class="text-lg font-bold text-indigo-300 mb-3">
            1. AIã«ã‚ˆã‚‹çŠ¶æ³æ¨æ¸¬
          </h2>
        <div
          class="border border-gray-700 rounded-lg p-4 mb-4 text-sm text-gray-300 space-y-3"
        >
          <p class="text-base font-bold text-center text-indigo-300">
            AIã¸ã®æœ€é«˜ã®ã€Œå‘ªæ–‡ã€ã¯ã€ã‚ãªãŸã®ã€Œã‚ã‚Šã®ã¾ã¾ã®è¨€è‘‰ã€ã§ã™
          </p>
          <p class="text-xs text-center text-gray-400">
            æœªæ¥åˆ†å²å›³ã®ç²¾åº¦ã‚’é«˜ã‚ã‚‹ã€ãŸã£ãŸä¸€ã¤ã®ç§˜è¨£
          </p>
          <p>
            ã“ã‚Œã‹ã‚‰ã€ã‚ãªãŸã®ç¾çŠ¶ã¨èª²é¡Œã‚’AIã«å…¥åŠ›ã—ã¦ã„ãŸã ãã¾ã™ã€‚ãã®éš›ã€ã©ã†ã‹<strong>ã€Œä¸Šæ‰‹ãªæ–‡ç« ã‚’æ›¸ã“ã†ã€ã¨ã—ãªã„ã§ãã ã•ã„ã€‚</strong>AIã¯ã€æ•´ãˆã‚‰ã‚ŒãŸæ–‡ç« ã‚ˆã‚Šã‚‚ã€ã‚ãªãŸã®<strong>ã€Œç”Ÿã®è¨€è‘‰ã€</strong>ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚
          </p>
          <p>
            ç®‡æ¡æ›¸ãã§ã‚‚ã€å¿ƒã®ã¤ã¶ã‚„ãã§ã‚‚ã€èª°ã‹ã«æ„šç—´ã‚’ã“ã¼ã™ã‚ˆã†ãªè¨€è‘‰ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ä»–äººã«è¦‹ã›ã‚‹ãŸã‚ã®æ–‡ç« ã§ã¯ãªãã€<strong>ã‚ãªãŸè‡ªèº«ã®ãŸã‚ã®ã€Œæ€è€ƒã®ãƒ¡ãƒ¢ã€</strong>ã¨ã—ã¦ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
          </p>
          <p>
            ãªãœãªã‚‰ã€AIã¯ã‚ãªãŸãŒé¸ã¶ä¸€ã¤ä¸€ã¤ã®å˜èªã€è¡¨ç¾ã®æºã‚Œã€æ„Ÿæƒ…ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‹ã‚‰ã€ã‚ãªãŸã ã‘ã®ã€Œæ€è€ƒã®ã‚¯ã‚»ã€ã‚„ã€Œå¿ƒã®å‹•ãã€ã‚’èª­ã¿å–ã‚‹ã‹ã‚‰ã§ã™ã€‚
          </p>
          <div class="pt-2">
            <p class="font-bold text-gray-200">ã€å…¥åŠ›ã®ãƒ’ãƒ³ãƒˆã€‘</p>
            <div
              class="mt-2 p-3 rounded-lg bg-red-900/20 border border-red-800/50"
            >
              <p class="font-bold">æ‚ªã„ä¾‹ âŒ</p>
              <p class="text-xs italic mt-1">
                ã€Œæ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã«ãŠã„ã¦ã€äººçš„ãƒªã‚½ãƒ¼ã‚¹ã®ä¸è¶³ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãªã‚Šã€è¨ˆç”»ã«é…å»¶ãŒç”Ÿã˜ã¦ã„ã¾ã™ã€‚ã€
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ï¼ˆã“ã‚Œã§ã¯ã€AIã¯ä¸€èˆ¬çš„ãªãƒ“ã‚¸ãƒã‚¹èª²é¡Œã¨ã—ã¦ã—ã‹åˆ†æã§ãã¾ã›ã‚“ï¼‰
              </p>
            </div>
            <div
              class="mt-2 p-3 rounded-lg bg-emerald-900/20 border border-emerald-800/50"
            >
              <p class="font-bold">è‰¯ã„ä¾‹ â­•</p>
              <p class="text-xs italic mt-1">
                ã€Œæ–°ã—ã„ä»•äº‹ã€ãƒã‚¸ã§äººè¶³ã‚Šã¦ãªã„ï¼Aã•ã‚“ã¯é ‘å¼µã£ã¦ãã‚Œã¦ã‚‹ã‘ã©ã€Bã•ã‚“ã¯å…¨ç„¶ã‚„ã‚‹æ°—ãªã„ã—â€¦ã€‚ã“ã®ã¾ã¾ã ã¨çµ¶å¯¾é–“ã«åˆã‚ãªã„ã€‚ã©ã†ã™ã‚Šã‚ƒã„ã„ã‚“ã â€¦ã€‚ç„¦ã‚‹ã€‚ã€
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ï¼ˆã“ã®æ–¹ãŒã€ã‚ãªãŸã®æ„Ÿæƒ…ã€äººé–“é–¢ä¿‚ã¸ã®èªè­˜ã€åˆ‡è¿«æ„ŸãŒä¼ã‚ã‚Šã€ã‚ˆã‚Šãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸåˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼‰
              </p>
            </div>
          </div>
          <p class="font-bold text-center pt-2">
            ã‚ãªãŸã®ã€Œã‚ã‚Šã®ã¾ã¾ã®è¨€è‘‰ã€ã“ããŒã€ã‚ãªãŸã ã‘ã®æœªæ¥ã‚’èª­ã¿è§£ãã€æœ€ã‚‚å¼·åŠ›ãªéµã¨ãªã‚Šã¾ã™ã€‚<br />ã©ã†ãã€ã‚ãªãŸã®å¿ƒã‚’ãã®ã¾ã¾ã€AIã«ã¶ã¤ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚
          </p>
        </div>
        
        <!-- ã‚ãªãŸã®æœªæ¥ã‚’èª­ã¿è§£ãã¾ã™ -->
        <div class="mb-6 text-center">
          <h3 class="text-xl font-bold text-indigo-300 mb-2">
            âœ¨ ã‚ãªãŸã®æœªæ¥ã‚’èª­ã¿è§£ãã¾ã™
          </h3>
          <p class="text-sm text-gray-400">
            å¤å…¸æ˜“çµŒã®æ™ºæ…§ã§ã€8ã¤ã®å¯èƒ½æ€§ã‚’æ¢ã£ã¦ã¿ã¾ã—ã‚‡ã†
          </p>
        </div>
        
        <textarea
          id="worryInput"
          class="bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 mb-4"
          rows="4"
          placeholder="ã“ã“ã«ã‚ãªãŸã®ã€Œç”Ÿã®è¨€è‘‰ã€ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..."
        ></textarea>
        <button
            id="aiGuessBtn"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 flex items-center justify-center gap-2"
          >
            <svg class="animate-spin h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg
              id="originalIcon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                clip-rule="evenodd"
              />
            </svg>
            <span id="buttonText">AIã«çŠ¶æ³ã‚’æ¨æ¸¬ã•ã›ã‚‹</span>
          </button>
        </div>
      </div>

      <!-- Data Export Section -->
      <div class="data-export-section progressive-load" id="data-export">
        <h3 class="text-lg font-bold text-indigo-300 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </h3>
        <div class="flex flex-wrap gap-3">
          <button id="exportJson" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            JSONå½¢å¼
          </button>
          <button id="exportCsv" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a4 4 0 01-4-4V5a4 4 0 014-4h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a4 4 0 01-4 4z" />
            </svg>
            CSVå½¢å¼
          </button>
          <button id="exportPdf" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            PDFæº–å‚™
          </button>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultArea" class="hidden relative">
        <!-- Loading Overlay for Results -->
        <div id="results-loading" class="loading-overlay" style="display: none;">
          <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-300">åˆ†æçµæœã‚’ç”Ÿæˆä¸­...</p>
          </div>
        </div>
        
        <!-- Analysis Summary -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start mb-12">
          <div class="lg:col-span-1">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              åˆ†æã‚µãƒãƒªãƒ¼
            </h2>
            <div class="space-y-4">
              <!-- Summary Card -->
              <div
                id="summaryCard"
                class="p-4 rounded-lg border border-gray-600/50 bg-gray-900/30 relative"
              >
                <div
                  class="bg-yellow-400/10 border-l-4 border-yellow-400 p-3 rounded-md"
                >
                  <h4
                    id="currentTitle"
                    class="text-lg font-semibold text-yellow-300"
                  >ç¾åœ¨ã®çŠ¶æ³</h4>
                  <p
                    id="currentKeywords"
                    class="text-sm text-yellow-200 mt-1"
                  ></p>
                  <p id="currentSummary" class="text-gray-300 mt-2 text-sm">ã‚ãªãŸã®çŠ¶æ³ã‚’ç·åˆçš„ã«åˆ†æã—ãŸçµæœã€ä»Šã¯é‡è¦ãªå¤‰åŒ–ã®æ™‚æœŸã«ã‚ã‚‹ã“ã¨ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <h4 class="font-bold text-gray-300">æ¨å¥¨ã•ã‚Œã‚‹æ–¹å‘æ€§</h4>
                  <p id="recommendedDirection" class="text-gray-300 mt-2 text-sm">å†…ãªã‚‹ç›´æ„Ÿã‚’ä¿¡ã˜ã€æ…é‡ã«è¡Œå‹•ã™ã‚‹ã“ã¨ã§è‰¯ã„çµæœã‚’å¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Choice Cards -->
          <div class="lg:col-span-2">
            <h2 class="text-xl font-bold mb-4 text-center text-indigo-300">
              æœ€åˆã®é¸æŠï¼šã‚ãªãŸã¯ã©ã¡ã‚‰ã®é“ã‚’é¸ã¶ã‹ï¼Ÿ
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
              <div id="choice1" class="card bg-gradient-to-br from-blue-900/20 to-indigo-900/20 border border-blue-500/30 p-4 rounded-lg hover:border-blue-400">
                <h3 class="text-lg font-bold text-blue-300 mb-2">ç¾çŠ¶ç¶­æŒã®é“</h3>
                <p class="text-sm text-gray-300 mb-3">ä»Šã®çŠ¶æ³ã‚’å—ã‘å…¥ã‚Œã€å†…ãªã‚‹åŠ›ã‚’è‚²ã‚€é¸æŠ</p>
                <div class="text-xs bg-blue-500/20 text-blue-200 px-2 py-1 rounded">å®‰å®šæ€§é‡è¦–</div>
              </div>
              <div id="choice2" class="card bg-gradient-to-br from-emerald-900/20 to-teal-900/20 border border-emerald-500/30 p-4 rounded-lg hover:border-emerald-400">
                <h3 class="text-lg font-bold text-emerald-300 mb-2">å¤‰é©ã®é“</h3>
                <p class="text-sm text-gray-300 mb-3">æ–°ã—ã„å¯èƒ½æ€§ã«å‘ã‹ã£ã¦ä¸€æ­©è¸ã¿å‡ºã™é¸æŠ</p>
                <div class="text-xs bg-emerald-500/20 text-emerald-200 px-2 py-1 rounded">æˆé•·æ€§é‡è¦–</div>
              </div>
            </div>
            
            <!-- 8 Scenarios -->
            <h2 class="text-xl font-bold mb-4 text-center text-indigo-300">
              8ã¤ã®æœªæ¥ã‚·ãƒŠãƒªã‚ª
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="scenarioGrid">
              <!-- Scenarios will be dynamically generated -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Module Script -->
    <script type="module">
      // Progressive Loading Manager
      class ProgressiveLoader {
        constructor() {
          this.progress = 0;
          this.loadedModules = 0;
          this.totalModules = 15;
          this.init();
        }
        
        async init() {
          console.log('ğŸš€ Module script execution started');
          await this.simulateModuleLoading();
          await this.hideLoadingScreen();
          this.startProgressiveContentLoad();
        }
        
        async simulateModuleLoading() {
          const modules = [
            'H384_DATA validation',
            'IChingTransformationEngine',
            'FutureBranchingSystem', 
            'DataPersistenceManager',
            'DataExportAPI',
            'Quality Enhancement',
            'ML Integration',
            'Analysis Engine',
            'Context Analyzer',
            'Hexagram Mapping',
            'Metaphor Generation',
            'Event Listeners',
            'UI Components',
            'Export Functions',
            'Complete Integration'
          ];
          
          for (let i = 0; i < modules.length; i++) {
            await this.animateProgress((i + 1) * (100 / modules.length));
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        
        async hideLoadingScreen() {
          const loadingScreen = document.getElementById('initial-loading');
          const mainContainer = document.getElementById('main-container');
          
          await this.animateProgress(100);
          
          setTimeout(() => {
            console.log('ğŸ¯ Hiding loading screen...');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
              mainContainer.style.opacity = '1';
              console.log('âœ… Application initialization completed');
              this.startProgressiveContentLoad();
            }, 300);
          }, 500);
        }
        
        async animateProgress(target) {
          return new Promise(resolve => {
            const animate = () => {
              if (this.progress < target) {
                this.progress += 2;
                const progressBar = document.getElementById('loading-progress');
                if (progressBar) {
                  progressBar.style.width = `${this.progress}%`;
                }
                requestAnimationFrame(animate);
              } else {
                resolve();
              }
            };
            animate();
          });
        }
        
        startProgressiveContentLoad() {
          console.log('ğŸ“¦ Additional modules loaded');
          
          // Show input content
          setTimeout(() => {
            const inputSkeleton = document.getElementById('input-skeleton');
            const inputContent = document.getElementById('input-content');
            if (inputSkeleton && inputContent) {
              inputSkeleton.style.display = 'none';
              inputContent.style.display = 'block';
              inputContent.classList.add('fade-in');
            }
            
            // Load progressive elements
            const progressiveElements = document.querySelectorAll('.progressive-load');
            progressiveElements.forEach((element, index) => {
              setTimeout(() => {
                element.classList.add('loaded');
              }, index * 200);
            });
          }, 500);
          
          // Initialize functionality
          this.initializeEventListeners();
        }
        
        initializeEventListeners() {
          // AI Analysis Button
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          const worryInput = document.getElementById('worryInput');
          
          if (aiGuessBtn && worryInput) {
            aiGuessBtn.addEventListener('click', () => {
              const inputText = worryInput.value.trim();
              if (inputText) {
                console.log('Starting analysis...');
                this.performAnalysis(inputText);
              } else {
                alert('å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
              }
            });
          }
          
          // Export buttons
          this.initializeExportButtons();
          
          // Choice cards
          this.initializeChoiceCards();
          
          console.log('âœ… Event listeners initialized');
        }
        
        performAnalysis(inputText) {
          const resultArea = document.getElementById('resultArea');
          const resultsLoading = document.getElementById('results-loading');
          
          // Show loading
          if (resultArea && resultsLoading) {
            resultArea.classList.remove('hidden');
            resultsLoading.style.display = 'flex';
            
            // Simulate analysis
            setTimeout(() => {
              resultsLoading.style.display = 'none';
              this.displayResults(inputText);
              console.log('âœ… Analysis completed');
            }, 2000);
          }
        }
        
        async displayResults(inputText) {
          console.log('ğŸŒŸ æ­£çµ±æ˜“çµŒã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹åˆ†æé–‹å§‹');
          
          try {
            // ğŸ”® Step 1: Initialize Authentic I Ching Engine
            if (!this.authenticEngine) {
              this.authenticEngine = new AuthenticIChingEngine();
              console.log('âœ… æ­£çµ±æ˜“çµŒã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–å®Œäº†');
            }

            // ğŸ“Š Step 2: Identify current I Ching situation
            const currentSituation = this.authenticEngine.identifyCurrentSituation(inputText);
            console.log('ğŸ¯ ç¾åœ¨çŠ¶æ³ç‰¹å®š:', currentSituation);

            // ğŸ¯ Step 3: Initialize and display current position
            await this.initializeCurrentPositionDisplay(currentSituation);

            // âš¡ Step 4: Initialize and generate authentic choices
            await this.initializeAuthenticChoiceSystem(currentSituation);

            // ğŸŒŠ Step 5: Initialize and generate 8 authentic scenarios
            await this.initializeAuthentic8ScenariosSystem(currentSituation);

            console.log('âœ… æ­£çµ±æ˜“çµŒã‚·ã‚¹ãƒ†ãƒ åˆ†æå®Œäº†');
            
            // ğŸ¨ Generate I Ching-based state data for charts
            const currentState = this.generateIChingStateData(currentSituation);
            
          } catch (error) {
            console.error('âŒ æ­£çµ±æ˜“çµŒã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼:', error);
            this.displayFallbackResults(inputText);
          }

          const samplePaths = [
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 }, // ç¾åœ¨åœ°
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 72 }, // ãƒ•ã‚§ãƒ¼ã‚º1
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 81 }, // ãƒ•ã‚§ãƒ¼ã‚º2
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 87 }  // ãƒ•ã‚§ãƒ¼ã‚º3
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 68 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 75 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 79 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 59 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 65 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 71 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 57 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 52 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 48 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 69 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 73 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 76 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 61 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 58 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 54 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 60 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 56 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 51 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 58 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 53 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 47 }
            ]
          ];

          // Add I Ching transformation quality section
          this.addIChingQualitySection(inputText);

          // Ensure chart containers exist before rendering
          ensureChartContainers();

          // Wait for DOM operations to complete, then render charts
          setTimeout(() => {
            if (typeof Chart !== 'undefined') {
              try {
                // Ensure containers are in DOM
                ensureChartContainers();
                
                // Additional wait for DOM updates
                setTimeout(() => {
                  // Double-check containers exist
                  const currentChartCanvas = document.getElementById('currentStateBarChart');
                  const summaryChartCanvas = document.getElementById('summaryChart');
                  
                  console.log('ğŸ” Chart container check:', {
                    currentChart: !!currentChartCanvas,
                    summaryChart: !!summaryChartCanvas
                  });
                  
                  if (currentChartCanvas) {
                    renderCurrentStateBarChart(sampleCurrentState);
                    console.log('âœ… Current state chart rendered');
                  } else {
                    console.warn('âš ï¸ Current state chart container not found after ensure');
                  }
                  
                  if (summaryChartCanvas) {
                    renderSummaryChart(samplePaths);
                    console.log('âœ… Summary chart rendered');
                  } else {
                    console.warn('âš ï¸ Summary chart container not found after ensure');
                  }
                  
                  console.log('âœ… Charts rendering completed');
                }, 200);
              } catch (error) {
                console.error('âŒ Chart rendering error:', error);
              }
            } else {
              console.warn('âš ï¸ Chart.js not loaded, charts will not display');
            }
          }, 1000);
        }
        
        // ğŸ¯ Initialize Current Position Display System
        async initializeCurrentPositionDisplay(currentSituation) {
          console.log('ğŸ¯ ç¾åœ¨åœ°è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
          
          const currentPositionContainer = document.getElementById('currentPositionContainer') || 
            this.createCurrentPositionContainer();
          
          if (!this.currentPositionDisplay) {
            this.currentPositionDisplay = new CurrentPositionDisplay(
              currentPositionContainer, 
              this.authenticEngine
            );
          }
          
          // Update display with current situation
          this.currentPositionDisplay.updatePosition(currentSituation);
          console.log('âœ… ç¾åœ¨åœ°è¡¨ç¤ºå®Œäº†');
        }

        // âš¡ Initialize Authentic Choice System
        async initializeAuthenticChoiceSystem(currentSituation) {
          console.log('âš¡ æ­£çµ±é¸æŠã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
          
          const choiceContainer = document.getElementById('choiceContainer') || 
            this.createChoiceContainer();
          
          if (!this.authenticChoiceSystem) {
            this.authenticChoiceSystem = new AuthenticChoiceSystem(
              choiceContainer, 
              this.authenticEngine
            );
          }
          
          // Generate and display choices
          this.authenticChoiceSystem.generateChoices(currentSituation);
          console.log('âœ… æ­£çµ±é¸æŠã‚·ã‚¹ãƒ†ãƒ å®Œäº†');
        }

        // ğŸŒŠ Initialize Authentic 8 Scenarios System
        async initializeAuthentic8ScenariosSystem(currentSituation) {
          console.log('ğŸŒŠ 8å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
          
          const scenariosContainer = document.getElementById('scenariosContainer') || 
            this.createScenariosContainer();
          
          if (!this.authentic8ScenariosSystem) {
            this.authentic8ScenariosSystem = new Authentic8ScenariosSystem(
              scenariosContainer, 
              this.authenticEngine
            );
          }
          
          // Generate 8 transformation patterns
          const patterns = this.authentic8ScenariosSystem.generate8TransformationPatterns(
            currentSituation.å¦ç•ªå·, 
            this.parseLinePosition(currentSituation.çˆ»), 
            currentSituation
          );
          
          console.log('âœ… 8å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚·ã‚¹ãƒ†ãƒ å®Œäº†');
        }
        
        analyzeTextForIChingPatterns(text) {
          // Text pattern analysis for I Ching concepts
          const patterns = {
            difficulty: ['ã†ã¾ãã„ã‹ãªã„', 'å›°é›£', 'å•é¡Œ', 'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼', 'æ‚©ã‚“ã§'],
            communication: ['ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒãƒ¼ãƒ ', 'ãƒ¡ãƒ³ãƒãƒ¼'],
            leadership: ['è²¬ä»»è€…', 'çµæœã‚’å‡ºã™', 'æ”¹å–„'],
            stagnation: ['é€²ã¾ãªã„', 'æ€ã†ã‚ˆã†ã«', 'åœæ»'],
            transformation: ['ã©ã†', 'æ”¹å–„', 'å¤‰åŒ–', 'æ–¹å‘æ€§']
          };
          
          let score = 0;
          let interpretation = '';
          
          if (patterns.difficulty.some(p => text.includes(p))) {
            score += 0.3;
            interpretation += 'å›°é›£ãªçŠ¶æ³ã«ç›´é¢ã—ã¦ã„ã‚‹ã€‚';
          }
          
          if (patterns.stagnation.some(p => text.includes(p))) {
            score += 0.25;
            interpretation += 'åœæ»æ„Ÿã‚’æ„Ÿã˜ã¦ã„ã‚‹ã€‚';
          }
          
          if (patterns.transformation.some(p => text.includes(p))) {
            score += 0.2;
            interpretation += 'å¤‰åŒ–ã‚’æ±‚ã‚ã¦ã„ã‚‹ã€‚';
          }
          
          return {
            confidence: Math.min(score, 0.95),
            interpretation: interpretation || 'çŠ¶æ³ã®å¤‰åŒ–ã‚’æ¨¡ç´¢ã—ã¦ã„ã‚‹æ™‚æœŸã€‚'
          };
        }

        // ğŸ› ï¸ Container Creation Methods
        createCurrentPositionContainer() {
          const container = document.createElement('div');
          container.id = 'currentPositionContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        createChoiceContainer() {
          const container = document.createElement('div');
          container.id = 'choiceContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        createScenariosContainer() {
          const container = document.createElement('div');
          container.id = 'scenariosContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        // ğŸ”§ Utility Methods
        parseLinePosition(lineText) {
          const lineMap = {
            'åˆä¹': 1, 'åˆå…­': 1,
            'ä¹äºŒ': 2, 'å…­äºŒ': 2,
            'ä¹ä¸‰': 3, 'å…­ä¸‰': 3,
            'ä¹å››': 4, 'å…­å››': 4,
            'ä¹äº”': 5, 'å…­äº”': 5,
            'ä¸Šä¹': 6, 'ä¸Šå…­': 6
          };
          
          return lineMap[lineText] || 1;
        }

        displayFallbackResults(inputText) {
          console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã‚’è¡¨ç¤º');
          // Original fallback implementation would go here
        }
        
        // ğŸ“Š Display Current I Ching Position (Legacy - will be removed)
        displayCurrentPosition(position) {
          const currentPositionSection = document.createElement('div');
          currentPositionSection.className = 'mb-8 bg-gradient-to-r from-amber-900/30 to-yellow-900/30 border border-amber-500/30 rounded-lg p-6';
          currentPositionSection.innerHTML = `
            <div class="flex items-center mb-4">
              <span class="text-3xl mr-3">ğŸ¯</span>
              <h3 class="text-xl font-bold text-amber-300">ç¾åœ¨åœ°ï¼šæ˜“çµŒã«ã‚ˆã‚‹æ­£ç¢ºãªä½ç½®ç‰¹å®š</h3>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- æœ¬å¦æƒ…å ± -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                  <span class="mr-2">ğŸ“œ</span>æœ¬å¦ï¼ˆç¾åœ¨ã®çŠ¶æ³ï¼‰
                </h4>
                <div class="space-y-3">
                  <div class="text-center py-4 bg-gray-900/50 rounded-lg">
                    <div class="text-2xl font-bold text-amber-400">ç¬¬${position.hexagram}å¦ ${position.hexagramName}</div>
                    <div class="text-lg mt-2">
                      <span class="mr-4">${position.trigrams.upper.symbol} ${position.trigrams.upper.meaning}</span>
                      <span>${position.trigrams.lower.symbol} ${position.trigrams.lower.meaning}</span>
                    </div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">çŠ¶æ³ã®è±¡å¾´</div>
                    <div class="text-sm text-gray-300">${position.situation}</div>
                  </div>
                </div>
              </div>
              
              <!-- å¤‰çˆ»æƒ…å ± -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-orange-400 mb-3 flex items-center">
                  <span class="mr-2">âš¡</span>å¤‰çˆ»ï¼ˆç¾åœ¨ã®ç„¦ç‚¹ï¼‰
                </h4>
                <div class="space-y-3">
                  <div class="text-center py-4 bg-gray-900/50 rounded-lg">
                    <div class="text-xl font-bold text-orange-400">${position.lineType}${position.linePosition}çˆ»</div>
                    <div class="text-sm text-gray-400 mt-1">ç¬¬${position.line}çˆ»ï¼ˆé™½çˆ»/é™°çˆ»ï¼š${position.lineType}ï¼‰</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">çˆ»è¾</div>
                    <div class="text-sm text-gray-300 font-mono bg-gray-900/50 p-3 rounded">${position.fullLineText}</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">ç¾åœ¨ã®æ„å‘³</div>
                    <div class="text-sm text-gray-300">${position.interpretation}</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- å¤‰åŒ–ã®æ–¹å‘æ€§ -->
            <div class="mt-6 bg-gray-800/30 rounded-lg p-4">
              <h4 class="text-md font-semibold text-blue-400 mb-3 flex items-center">
                <span class="mr-2">ğŸ”„</span>å¤‰åŒ–ã®æ–¹å‘æ€§ï¼ˆ${position.hexagramName} â†’ ${position.resultHexagramName}ï¼‰
              </h4>
              <div class="text-center">
                <div class="text-lg text-blue-300">
                  ç¬¬${position.hexagram}å¦ ${position.hexagramName} 
                  <span class="mx-4 text-yellow-400">â†’</span>
                  ç¬¬${position.resultHexagram}å¦ ${position.resultHexagramName}
                </div>
                <div class="mt-2 text-sm text-gray-400">
                  ä¿¡é ¼åº¦: ${Math.round(position.confidence * 100)}% ï¼ˆAIåˆ†æã«ã‚ˆã‚‹ï¼‰
                </div>
              </div>
            </div>
          `;
          
          // Insert at the beginning of results container
          const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
          if (resultsContainer) {
            resultsContainer.insertBefore(currentPositionSection, resultsContainer.firstChild);
          }
        }
        
        // âš¡ Generate Authentic I Ching Choices
        generateAuthenticChoices(position) {
          const choices = {
            pathA: {
              title: `çˆ»è¾ã«å¾“ã†é“ï¼šã€Œ${position.lineText}ã€ã‚’å—ã‘å…¥ã‚Œã‚‹`,
              description: `${position.fullLineText}ã®æ•™ãˆã«å¾“ã„ã€ç¾çŠ¶ã‚’ç´ ç›´ã«å—ã‘å…¥ã‚Œã¦é©åˆ‡ãªæ™‚æœŸã‚’å¾…ã¤é¸æŠã€‚`,
              keyword: position.lineText,
              approach: 'authentic',
              probability: 0.78,
              outcome: 'æ®µéšçš„ãªæ”¹å–„ã¨å®‰å®šã—ãŸæˆé•·'
            },
            pathB: {
              title: `çˆ»è¾ã«é€†ã‚‰ã†é“ï¼šå›°é›£ã«æ­£é¢ã‹ã‚‰æŒ‘æˆ¦ã™ã‚‹`,
              description: `ç¾åœ¨ã®åœæ»çŠ¶æ³ã«ç©æ¥µçš„ã«æŠµæŠ—ã—ã€å¼·å¼•ã«ã§ã‚‚çŠ¶æ³ã‚’å¤‰ãˆã‚ˆã†ã¨ã™ã‚‹é¸æŠã€‚`,
              keyword: 'ç©æ¥µçš„æŠµæŠ—',
              approach: 'resistance',
              probability: 0.45,
              outcome: 'çŸ­æœŸçš„ãªæ··ä¹±ã®å¾Œã«å¤§ããªå¤‰åŒ–ã®å¯èƒ½æ€§'
            }
          };
          
          return choices;
        }
        
        // ğŸŒŠ Display Authentic I Ching Choices
        displayAuthenticChoices(choices) {
          // Update the existing choice cards with authentic I Ching content
          const choice1 = document.getElementById('choice1');
          const choice2 = document.getElementById('choice2');
          
          if (choice1) {
            choice1.innerHTML = `
              <h3 class="text-lg font-semibold text-green-400 mb-2">${choices.pathA.title}</h3>
              <p class="text-sm text-gray-300 mb-3">${choices.pathA.description}</p>
              <div class="flex justify-between items-center">
                <span class="text-xs text-green-300 bg-green-900/30 px-2 py-1 rounded">ğŸ”‘ ${choices.pathA.keyword}</span>
                <span class="text-xs text-gray-400">æˆåŠŸç‡: ${Math.round(choices.pathA.probability * 100)}%</span>
              </div>
              <div class="mt-2 text-xs text-gray-400">${choices.pathA.outcome}</div>
            `;
          }
          
          if (choice2) {
            choice2.innerHTML = `
              <h3 class="text-lg font-semibold text-blue-400 mb-2">${choices.pathB.title}</h3>
              <p class="text-sm text-gray-300 mb-3">${choices.pathB.description}</p>
              <div class="flex justify-between items-center">
                <span class="text-xs text-blue-300 bg-blue-900/30 px-2 py-1 rounded">âš¡ ${choices.pathB.keyword}</span>
                <span class="text-xs text-gray-400">æˆåŠŸç‡: ${Math.round(choices.pathB.probability * 100)}%</span>
              </div>
              <div class="mt-2 text-xs text-gray-400">${choices.pathB.outcome}</div>
            `;
          }
        }
        
        generateScenarios() {
          const hexagrams = [
            { 
              name: 'å¤©åœ°å¦', 
              grade: 'A', 
              description: 'æœ€ã‚‚å¥½ã¾ã—ã„å±•é–‹ã€‚ç©æ¥µçš„ãªè¡Œå‹•ãŒè‰¯ã„çµæœã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚',
              hexagramNumber: 12,
              line: 3,
              trigrams: { upper: 'å¤©', lower: 'åœ°' },
              interpretation: 'é–‰å¡ã‹ã‚‰é–‹é€šã¸ã®è»¢æ›ç‚¹ã€‚å›°é›£ãªçŠ¶æ³ãŒå¥½è»¢ã™ã‚‹å…†ã—ã€‚',
              lineText: 'ä¹ä¸‰ï¼šåŒ…ç¾ã€‚åŒ…ã¿éš ã•ã‚ŒãŸæ¥ã‚’å—ã‘å…¥ã‚Œã‚‹æ™‚ã€‚',
              advice: 'ç¾çŠ¶ã‚’ç´ ç›´ã«å—ã‘å…¥ã‚Œã€æ–°ã—ã„æ–¹å‘æ€§ã‚’æ¨¡ç´¢ã™ã‚‹ã“ã¨ãŒé‡è¦ã€‚'
            },
            { 
              name: 'åœ°å¤©æ³°', 
              grade: 'B', 
              description: 'è‰¯å¥½ãªå±•é–‹ã€‚æ…é‡ã«é€²ã‚ã°æˆåŠŸã®å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚',
              hexagramNumber: 11,
              line: 2,
              trigrams: { upper: 'åœ°', lower: 'å¤©' },
              interpretation: 'å¤©åœ°äº¤é€šã®è±¡ã€‚ä¸Šä¸‹ã®èª¿å’ŒãŒå–ã‚ŒãŸå®‰å®šã—ãŸçŠ¶æ…‹ã€‚',
              lineText: 'ä¹äºŒï¼šåŒ…è’ã€‚è’é‡ã‚’ã‚‚åŒ…å®¹ã™ã‚‹å¤§ããªå¿ƒã€‚',
              advice: 'èª¿å’Œã‚’é‡è¦–ã—ã€å‘¨å›²ã¨ã®å”èª¿ã‚’å¤§åˆ‡ã«ã—ãªãŒã‚‰é€²ã‚€ã€‚'
            },
            { 
              name: 'å±±åœ°å‰¥', 
              grade: 'C', 
              description: 'æ¨™æº–çš„ãªå±•é–‹ã€‚ç¾çŠ¶ç¶­æŒã§å®‰å®šã—ãŸçµæœãŒæœŸå¾…ã§ãã¾ã™ã€‚',
              hexagramNumber: 23,
              line: 4,
              trigrams: { upper: 'å±±', lower: 'åœ°' },
              interpretation: 'å‰¥è½ã®æ™‚ã€‚å¤ã„ã‚‚ã®ãŒå‰¥ãŒã‚Œè½ã¡ã€æ–°ã—ã„ã‚‚ã®ãŒç”Ÿã¾ã‚Œã‚‹æº–å‚™æœŸã€‚',
              lineText: 'å…­å››ï¼šå‰¥åºŠä»¥è†šã€‚åºŠã¾ã§å‰¥ãŒã‚Œã‚‹æ·±åˆ»ãªçŠ¶æ³ã€‚',
              advice: 'ç„¡ç†ã«æŠµæŠ—ã›ãšã€è‡ªç„¶ã®æµã‚Œã«ä»»ã›ã‚‹ã“ã¨ãŒå¾—ç­–ã€‚'
            },
            { 
              name: 'åœ°å±±è¬™', 
              grade: 'D', 
              description: 'æ³¨æ„ãŒå¿…è¦ãªå±•é–‹ã€‚æ…é‡ãªåˆ¤æ–­ãŒæ±‚ã‚ã‚‰ã‚Œã¾ã™ã€‚',
              hexagramNumber: 15,
              line: 1,
              trigrams: { upper: 'åœ°', lower: 'å±±' },
              interpretation: 'è¬™éœã®ç¾å¾³ã€‚é«˜ã„å±±ã‚‚åœ°ã«è¬™ã‚‹å§¿å‹¢ã®å¤§åˆ‡ã•ã€‚',
              lineText: 'åˆå…­ï¼šè¬™è¬™å›å­ã€‚è¬™éœã«è¬™éœã‚’é‡ã­ã‚‹å›å­ã®å§¿å‹¢ã€‚',
              advice: 'æ…¢å¿ƒã‚’æˆ’ã‚ã€å¸¸ã«å­¦ã¶å§¿å‹¢ã‚’ä¿ã¤ã“ã¨ãŒæˆåŠŸã®ç§˜è¨£ã€‚'
            },
            { 
              name: 'é›·åœ°è±«', 
              grade: 'B', 
              description: 'è‰¯å¥½ãªå±•é–‹ã€‚ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¦‹æ¥µã‚ã‚‹ã“ã¨ãŒé‡è¦ã§ã™ã€‚',
              hexagramNumber: 16,
              line: 5,
              trigrams: { upper: 'é›·', lower: 'åœ°' },
              interpretation: 'æ¥½ã—ã¿ã¨æº–å‚™ã®èª¿å’Œã€‚é©åˆ‡ãªæº–å‚™ãŒã‚ã£ã¦ã“ãçœŸã®å–œã³ãŒã‚ã‚‹ã€‚',
              lineText: 'å…­äº”ï¼šè²ç–¾æ’ä¸æ­»ã€‚ç—…æ°—ã§ã‚‚æ­£ã—ãç”Ÿãã‚Œã°æ­»ãªãªã„ã€‚',
              advice: 'ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’è¦‹æ¥µã‚ã€æº–å‚™ã‚’æ€ ã‚‰ãªã„ã“ã¨ãŒé‡è¦ã€‚'
            },
            { 
              name: 'åœ°é›·å¾©', 
              grade: 'C', 
              description: 'æ¨™æº–çš„ãªå±•é–‹ã€‚å”èª¿æ€§ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã§é“ãŒé–‹ã‘ã¾ã™ã€‚',
              hexagramNumber: 24,
              line: 6,
              trigrams: { upper: 'åœ°', lower: 'é›·' },
              interpretation: 'å¾©å¸°ã¨å†ç”Ÿã®è±¡ã€‚ä¸€é™½æ¥å¾©ã€æ–°ã—ã„å§‹ã¾ã‚Šã€‚',
              lineText: 'ä¸Šå…­ï¼šè¿·å¾©ã€‚è¿·ã„ãªãŒã‚‰ã‚‚å¾©å¸°ã‚’ç›®æŒ‡ã™ã€‚',
              advice: 'éå»ã®çµŒé¨“ã‚’æ´»ã‹ã—ã€æ–°ã—ã„ã‚¹ã‚¿ãƒ¼ãƒˆã‚’åˆ‡ã‚‹å¥½æ©Ÿã€‚'
            },
            { 
              name: 'æ²¢åœ°èƒ', 
              grade: 'D', 
              description: 'æ³¨æ„ãŒå¿…è¦ãªå±•é–‹ã€‚è¨ˆç”»çš„ãªè¡Œå‹•ã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚',
              hexagramNumber: 45,
              line: 3,
              trigrams: { upper: 'æ²¢', lower: 'åœ°' },
              interpretation: 'é›†åˆã®è±¡ã€‚åŒã˜å¿—ã‚’æŒã¤è€…ãŒé›†ã¾ã‚‹æ™‚ã€‚',
              lineText: 'å…­ä¸‰ï¼šèƒå¦‚å—Ÿå¦‚ã€‚é›†ã¾ã‚ŠãŸã„ãŒå˜†æ¯ã™ã‚‹è¤‡é›‘ãªå¿ƒå¢ƒã€‚',
              advice: 'æ…é‡ã«ä»²é–“ã‚’é¸ã³ã€ç›®æ¨™ã‚’æ˜ç¢ºã«ã—ã¦ã‹ã‚‰è¡Œå‹•ã™ã‚‹ã€‚'
            },
            { 
              name: 'åœ°æ²¢è‡¨', 
              grade: 'E', 
              description: 'å›°é›£ãªå±•é–‹ã€‚å¿è€å¼·ãå–ã‚Šçµ„ã‚€ã“ã¨ã§çªç ´å£ãŒè¦‹ã¤ã‹ã‚Šã¾ã™ã€‚',
              hexagramNumber: 19,
              line: 2,
              trigrams: { upper: 'åœ°', lower: 'æ²¢' },
              interpretation: 'è‡¨ã‚€è±¡ã€‚ä¸Šä½è€…ãŒä¸‹ä½è€…ã«è‡¨ã‚€ã€æŒ‡å°ã¨ç›£ç£ã®æ™‚ã€‚',
              lineText: 'ä¹äºŒï¼šå’¸è‡¨å‰ç„¡ä¸åˆ©ã€‚æ„ŸåŒ–ã«ã‚ˆã£ã¦è‡¨ã‚ã°å‰ã€åˆ©ã—ã‹ã‚‰ã–ã‚‹ãªã—ã€‚',
              advice: 'å¿è€å¼·ãå–ã‚Šçµ„ã¿ã€å‘¨å›²ã¸ã®è‰¯ã„å½±éŸ¿ã‚’ä¸ãˆã‚‹ã“ã¨ã‚’å¿ƒãŒã‘ã‚‹ã€‚'
            }
          ];
          
          return hexagrams;
        }
        
        createScenarioCard(scenario, index) {
          const card = document.createElement('div');
          card.className = 'card bg-gray-800/50 border border-gray-600/50 p-4 rounded-lg hover:border-indigo-400 transition-all duration-300';
          
          const gradeClass = `rank-${scenario.grade.toLowerCase()}`;
          
          card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-bold text-indigo-300">ã‚·ãƒŠãƒªã‚ª${index}</h3>
              <div class="rank-badge ${gradeClass}">${scenario.grade}ç´š</div>
            </div>
            
            <!-- å¦åã¨åŸºæœ¬æƒ…å ± -->
            <div class="mb-3">
              <div class="text-sm font-semibold text-yellow-300 mb-1">${scenario.name} (ç¬¬${scenario.hexagramNumber}å¦)</div>
              <div class="text-xs text-gray-400 mb-2">
                <span class="inline-block mr-3">â˜° ${scenario.trigrams.upper}</span>
                <span class="inline-block">â˜· ${scenario.trigrams.lower}</span>
              </div>
            </div>
            
            <!-- æ˜“çµŒè§£é‡ˆ -->
            <div class="mb-3">
              <div class="text-xs text-emerald-400 font-medium mb-1">ğŸ“š å¦ã®è§£é‡ˆ</div>
              <p class="text-xs text-gray-300 mb-2">${scenario.interpretation}</p>
            </div>
            
            <!-- çˆ»è¾ -->
            <div class="mb-3">
              <div class="text-xs text-orange-400 font-medium mb-1">ğŸ“œ çˆ»è¾ (ç¬¬${scenario.line}çˆ»)</div>
              <p class="text-xs text-gray-300 mb-2 font-mono bg-gray-900/50 p-2 rounded">${scenario.lineText}</p>
            </div>
            
            <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
            <div class="mb-3">
              <div class="text-xs text-blue-400 font-medium mb-1">ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
              <p class="text-xs text-gray-300">${scenario.advice}</p>
            </div>
            
            <!-- å±•é–‹äºˆæ¸¬ -->
            <div class="border-t border-gray-600 pt-2 mt-3">
              <p class="text-xs text-gray-300">${scenario.description}</p>
            </div>
          `;
          
          return card;
        }
        
        addIChingQualitySection(inputText) {
          // Add I Ching transformation quality analysis section
          const resultsContainer = document.querySelector('.results-container');
          if (!resultsContainer) return;

          const qualitySection = document.createElement('div');
          qualitySection.className = 'mb-8 bg-gradient-to-r from-purple-900/30 to-indigo-900/30 border border-purple-500/30 rounded-lg p-6';
          
          qualitySection.innerHTML = `
            <div class="flex items-center mb-4">
              <span class="text-2xl mr-3">ğŸ”®</span>
              <h3 class="text-xl font-bold text-purple-300">æ˜“çµŒå¤‰æ›å“è³ªåˆ†æ</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- ç¾åœ¨ã®çŠ¶æ³åˆ†æ -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                  <span class="mr-2">ğŸ¯</span>ç¾åœ¨ã®çŠ¶æ³
                </h4>
                <div class="space-y-3">
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">åˆ†æå¯¾è±¡</div>
                    <div class="text-sm text-gray-300 bg-gray-900/50 p-3 rounded font-mono">"${inputText.substring(0, 100)}..."</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">æœ¬å¦ (ç¾çŠ¶)</div>
                    <div class="text-sm text-emerald-400">ç¬¬12å¦ å¤©åœ°å¦ â˜°â˜·</div>
                    <div class="text-xs text-gray-400 mt-1">å¤©åœ°ãŒäº¤ã‚ã‚‰ãªã„é–‰å¡ã®æ™‚ã€‚å¤‰åŒ–ã®å‰è§¦ã‚Œã€‚</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">å¤‰çˆ»</div>
                    <div class="text-sm text-orange-400">ä¹ä¸‰çˆ» (ç¬¬3çˆ»)</div>
                    <div class="text-xs text-gray-400 mt-1">ã€ŒåŒ…ç¾ã€- æ¥ã‚’åŒ…ã¿éš ã™æ™‚ã€‚è»¢æ›ç‚¹ã®è±¡å¾´ã€‚</div>
                  </div>
                </div>
              </div>
              
              <!-- å¤‰åŒ–ã®æ–¹å‘æ€§ -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-blue-400 mb-3 flex items-center">
                  <span class="mr-2">ğŸ”„</span>å¤‰åŒ–ã®æ–¹å‘æ€§
                </h4>
                <div class="space-y-3">
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">ä¹‹å¦ (å¤‰åŒ–å¾Œ)</div>
                    <div class="text-sm text-blue-400">ç¬¬25å¦ å¤©é›·æ— å¦„ â˜°â˜³</div>
                    <div class="text-xs text-gray-400 mt-1">å¤©ã®é›·å‹•ã€‚æ­£ã—ã„é“ã¸ã®å›å¸°ã¨ç´”çœŸãªè¡Œå‹•ã€‚</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">å¤‰åŒ–ã®è³ª</div>
                    <div class="flex items-center space-x-2">
                      <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                      <span class="text-sm text-green-400">æ­£å¤‰åŒ– (85%ä¿¡é ¼åº¦)</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">å›°é›£ã‹ã‚‰è§£æ”¾ã¸ã®å¥å…¨ãªå¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">æ¨å¥¨è¡Œå‹•</div>
                    <div class="text-sm text-gray-300">
                      â€¢ ç¾çŠ¶ã‚’ç´ ç›´ã«å—ã‘å…¥ã‚Œã‚‹<br>
                      â€¢ æ–°ã—ã„æ–¹å‘æ€§ã‚’æ¨¡ç´¢ã™ã‚‹<br>
                      â€¢ ç„¡ç†ãªæŠµæŠ—ã¯é¿ã‘ã‚‹
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- æ˜“çµŒè§£é‡ˆã®ä¿¡é ¼æ€§ -->
            <div class="mt-6 bg-gray-800/30 rounded-lg p-4">
              <h4 class="text-md font-semibold text-indigo-400 mb-3 flex items-center">
                <span class="mr-2">ğŸ“Š</span>è§£é‡ˆã®ä¿¡é ¼æ€§
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-400">85%</div>
                  <div class="text-xs text-gray-400">å¦ã®é©åˆåº¦</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400">78%</div>
                  <div class="text-xs text-gray-400">æ–‡è„ˆç†è§£åº¦</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-yellow-400">92%</div>
                  <div class="text-xs text-gray-400">äºˆæ¸¬ç²¾åº¦</div>
                </div>
              </div>
              <div class="mt-3 text-xs text-gray-400 text-center">
                â€» AIã«ã‚ˆã‚‹åˆ†æçµæœã€‚æ˜“çµŒã®ä¼çµ±çš„è§£é‡ˆã«åŸºã¥ãå‚è€ƒå€¤ã§ã™ã€‚
              </div>
            </div>
          `;
          
          // Insert at the beginning of results container
          resultsContainer.insertBefore(qualitySection, resultsContainer.firstChild);
        }
        
        initializeExportButtons() {
          const exportJson = document.getElementById('exportJson');
          const exportCsv = document.getElementById('exportCsv');
          const exportPdf = document.getElementById('exportPdf');
          
          if (exportJson) {
            exportJson.addEventListener('click', () => {
              console.log('JSON export requested');
              // Implement JSON export
            });
          }
          
          if (exportCsv) {
            exportCsv.addEventListener('click', () => {
              console.log('CSV export requested');
              // Implement CSV export
            });
          }
          
          if (exportPdf) {
            exportPdf.addEventListener('click', () => {
              console.log('PDF export requested');
              // Implement PDF export
            });
          }
        }
        
        initializeChoiceCards() {
          const choice1 = document.getElementById('choice1');
          const choice2 = document.getElementById('choice2');
          
          if (choice1) {
            choice1.addEventListener('click', () => {
              choice1.classList.add('highlighted');
              if (choice2) {
                choice2.classList.remove('highlighted');
              }
            });
          }
          
          if (choice2) {
            choice2.addEventListener('click', () => {
              choice2.classList.add('highlighted');
              if (choice1) {
                choice1.classList.remove('highlighted');
              }
            });
          }
        }
      }
      
      // Chart.js instances
      let summaryChartInstance = null;
      let currentStateBarChartInstance = null;
      let currentAnalysisData = {}; // Current analysis results holder

      // Render current status bar graph (horizontal bar)
      function renderCurrentStateBarChart(state) {
        if (currentStateBarChartInstance) { 
          currentStateBarChartInstance.destroy(); 
        }
        const ctx = document.getElementById("currentStateBarChart").getContext("2d");
        if (!ctx) return;
        
        const data = [ 
          state.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢, 
          state.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«, 
          state.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢, 
          Math.abs(state.S4_ãƒªã‚¹ã‚¯), 
          state.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢ 
        ];
        const colors = [ 
          "rgba(96, 165, 250, 0.8)", 
          "rgba(52, 211, 153, 0.8)", 
          "rgba(167, 139, 250, 0.8)", 
          "rgba(248, 113, 113, 0.8)", 
          "rgba(251, 191, 36, 0.8)"
        ];
        
        currentStateBarChartInstance = new Chart(ctx, { 
          type: "bar", 
          data: { 
            labels: ["åŸºæœ¬", "æ½œåœ¨åŠ›", "å®‰å®šæ€§", "ãƒªã‚¹ã‚¯", "å¤‰å‹•æ€§"], 
            datasets: [{ 
              data: data, 
              backgroundColor: colors, 
              borderWidth: 0, 
              barPercentage: 0.8, 
              categoryPercentage: 0.9
            }] 
          }, 
          options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            indexAxis: "y", 
            scales: { 
              x: { 
                display: true, 
                min: 0, 
                max: 100, 
                grid: { color: "rgba(255, 255, 255, 0.1)" }, 
                ticks: { color: "#9ca3af", font: { size: 10 } } 
              }, 
              y: { 
                grid: { display: false, drawBorder: false }, 
                ticks: { color: "#e5e7eb", font: { size: 12, weight: "500" } } 
              } 
            }, 
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                enabled: true, 
                callbacks: { 
                  label: function (context) { 
                    let label = context.dataset.label || ""; 
                    if (label) { 
                      label += ": "; 
                    } 
                    if (context.parsed.x !== null) { 
                      label += context.parsed.x; 
                    } 
                    return label; 
                  } 
                } 
              } 
            } 
          } 
        });
      }

      // Render future scenario summary line chart
      function renderSummaryChart(sortedPaths) {
        if (summaryChartInstance) summaryChartInstance.destroy();
        const ctx = document.getElementById("summaryChart").getContext("2d");
        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];
        const currentScore = sortedPaths[0][0].S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢;
        
        const datasets = sortedPaths.map((path, index) => { 
          const isTop = index < 4; 
          const color = isTop ? topColors[index] : bottomColors[index - 4]; 
          return { 
            label: `ã‚·ãƒŠãƒªã‚ª ${index + 1}`,
            data: path.map((p) => p.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢), 
            borderColor: color, 
            originalBorderColor: color, 
            borderWidth: isTop ? 3.5 : 1.5, 
            originalBorderWidth: isTop ? 3.5 : 1.5, 
            tension: 0.1, 
            pointRadius: 4, 
            pointBackgroundColor: "white", 
            originalPointBackgroundColor: "white", 
            pointHoverRadius: 6
          }; 
        });
        
        summaryChartInstance = new Chart(ctx, { 
          type: "line", 
          data: { 
            labels: ["ç¾åœ¨åœ°", "ãƒ•ã‚§ãƒ¼ã‚º1", "ãƒ•ã‚§ãƒ¼ã‚º2", "ãƒ•ã‚§ãƒ¼ã‚º3"], 
            datasets: datasets
          }, 
          options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { 
              y: { 
                min: 0, 
                max: 100, 
                ticks: { color: "#9ca3af" }, 
                grid: { color: "rgba(255, 255, 255, 0.1)" } 
              }, 
              x: { 
                ticks: { color: "#9ca3af" }, 
                grid: { color: "rgba(255, 255, 255, 0.1)" } 
              } 
            }, 
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                mode: "index", 
                intersect: false, 
                callbacks: { 
                  label: function (context) { 
                    return null; 
                  } 
                } 
              }, 
              annotation: { 
                annotations: { 
                  currentScoreLine: { 
                    type: "line", 
                    yMin: currentScore, 
                    yMax: currentScore, 
                    borderColor: "rgb(253, 224, 71)", 
                    borderWidth: 2, 
                    borderDash: [6, 6], 
                    label: { 
                      content: "ç¾åœ¨åœ°ã®ã‚¹ã‚³ã‚¢", 
                      enabled: true, 
                      position: "end", 
                      backgroundColor: "rgba(253, 224, 71, 0.8)", 
                      color: "black", 
                      font: { size: 10 } 
                    } 
                  } 
                } 
              } 
            } 
          } 
        });
      }

      // Highlight specific scenario in chart
      function highlightScenario(index) {
        if (summaryChartInstance) { 
          summaryChartInstance.data.datasets.forEach((dataset, i) => { 
            if (i === index) { 
              dataset.borderWidth = 5; 
              dataset.borderColor = dataset.originalBorderColor; 
              dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; 
            } else { 
              dataset.borderWidth = 1; 
              dataset.borderColor = "rgba(107, 114, 128, 0.5)"; 
              dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; 
            } 
          }); 
          summaryChartInstance.update("none"); 
        }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { 
          el.classList.remove("highlighted"); 
        });
        document.getElementById(`card-${index}`)?.classList.add("highlighted");
        document.querySelector(`.toggle-label[data-index='${index}']`)?.classList.add("highlighted");
      }

      // Reset chart highlights
      function resetChartHighlights() {
        if (summaryChartInstance) { 
          summaryChartInstance.data.datasets.forEach((dataset) => { 
            dataset.borderWidth = dataset.originalBorderWidth; 
            dataset.borderColor = dataset.originalBorderColor; 
            dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; 
          }); 
          summaryChartInstance.update("none"); 
        }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { 
          el.classList.remove("highlighted"); 
        });
      }

      // Add chart containers to HTML if they don't exist
      function ensureChartContainers() {
        console.log('ğŸ”§ Ensuring chart containers exist...');
        
        // Add current state chart container
        if (!document.getElementById('currentStateBarChart')) {
          console.log('ğŸ“Š Adding current state chart container...');
          const currentChartContainer = document.createElement('div');
          currentChartContainer.className = 'mb-6';
          currentChartContainer.innerHTML = `
            <h3 class="text-lg font-bold mb-3 text-indigo-300">ğŸ“Š ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•</h3>
            <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-4">
              <canvas id="currentStateBarChart" height="200"></canvas>
            </div>
          `;
          
          // Insert after the "ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•" heading if it exists
          const currentGraphHeading = document.querySelector('h3[text*="ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•"]') || 
                                     Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes('ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•'));
          if (currentGraphHeading && currentGraphHeading.parentNode) {
            currentGraphHeading.parentNode.insertBefore(currentChartContainer, currentGraphHeading.nextSibling);
          } else {
            // Fallback: Insert in results container
            const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
            if (resultsContainer) {
              const firstElement = resultsContainer.querySelector('*');
              if (firstElement) {
                resultsContainer.insertBefore(currentChartContainer, firstElement);
              } else {
                resultsContainer.appendChild(currentChartContainer);
              }
            }
          }
          console.log('âœ… Current state chart container added');
        } else {
          console.log('âœ… Current state chart container already exists');
        }

        // Add summary chart container
        if (!document.getElementById('summaryChart')) {
          console.log('ğŸ“ˆ Adding summary chart container...');
          const summaryChartContainer = document.createElement('div');
          summaryChartContainer.className = 'mb-6';
          summaryChartContainer.innerHTML = `
            <h3 class="text-lg font-bold mb-3 text-indigo-300">ğŸ”® æœªæ¥åˆ†å²ã‚°ãƒ©ãƒ•</h3>
            <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-4">
              <canvas id="summaryChart" height="300"></canvas>
            </div>
          `;
          
          // Find a good location - after choice cards and before scenario grid
          const choiceCards = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.gap-4') ||
                             document.querySelector('[class*="choice"]') ||
                             document.querySelector('h2[text*="é¸æŠ"]');
          const scenarioGrid = document.getElementById('scenarioGrid') ||
                              document.querySelector('h2[text*="ã‚·ãƒŠãƒªã‚ª"]');
          
          if (scenarioGrid && scenarioGrid.parentNode) {
            scenarioGrid.parentNode.insertBefore(summaryChartContainer, scenarioGrid);
            console.log('âœ… Summary chart container added before scenario grid');
          } else if (choiceCards && choiceCards.parentNode) {
            choiceCards.parentNode.insertBefore(summaryChartContainer, choiceCards.nextSibling);
            console.log('âœ… Summary chart container added after choice cards');
          } else {
            // Fallback: Insert in results container
            const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
            if (resultsContainer) {
              resultsContainer.appendChild(summaryChartContainer);
              console.log('âœ… Summary chart container added to results container');
            }
          }
        } else {
          console.log('âœ… Summary chart container already exists');
        }
        
        console.log('ğŸ Chart containers setup completed');
      }

      // Initialize when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded - Starting initialization...');
        
        // Ensure chart containers exist
        ensureChartContainers();
        
        new ProgressiveLoader();
        console.log('âœ… Future Simulator ready!');
      });
    </script>
  </body>
</html>