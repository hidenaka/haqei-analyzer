<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    
    <title>æ˜“çµŒæœªæ¥åˆ†æã‚·ã‚¹ãƒ†ãƒ  - 384ãƒ‘ã‚¿ãƒ¼ãƒ³çŠ¶æ³åˆ†æ</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>æ˜“</text></svg>"
    />
    
    <!-- Load critical path scripts -->
    <link href="./css/tailwind.css" rel="stylesheet">
    
    <!-- Browser Compatibility Layer -->
    <script src="./js/core/BrowserCompatibility.js"></script>
    
    <!-- Version and Monitoring -->
    <script>
        window.HAQEI_CONFIG = {
            appVersion: 'v4.3.1',
            rngSeed: 12345,
            kwMapSha256: 'pending',
            featureFlags: {
                enableAnalysis: true,
                enableSharing: false,
                enableAnimation: false
            }
        };
    </script>
    
    
    
    <!-- Quality Enhancement System -->
    <link rel="stylesheet" href="./css/quality-grade-enhancement.css">
    <!-- Future Branching Visual Design System -->
    <link rel="stylesheet" href="./css/future-branching-design.css">
    <!-- Objective Analysis UI System -->
    <link rel="stylesheet" href="./css/objective-analysis-ui.css">
    
    <!-- Unified Design System (æœ€å¾Œã«èª­ã¿è¾¼ã¿) -->
    <link rel="stylesheet" href="css/haqei-unified-design.css" />
    
    <!-- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç„¡åŠ¹åŒ–ã¨çµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³å¼·åˆ¶é©ç”¨ -->
    <style>
      /* çµ±ä¸€ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã®å¼·åˆ¶é©ç”¨ */
      body {
        background: var(--bg-primary) !important;
        color: var(--text-primary) !important;
      }
      
      /* ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚¯ãƒ©ã‚¹ã®ç„¡åŠ¹åŒ– */
      .bg-gray-900 { background: var(--bg-primary) !important; }
      .bg-gray-800 { background: var(--bg-secondary) !important; }
      .bg-gray-700 { background: var(--bg-tertiary) !important; }
      .text-gray-200 { color: var(--text-primary) !important; }
      .text-gray-300 { color: var(--text-secondary) !important; }
      .text-gray-400 { color: var(--text-tertiary) !important; }
      
      /* ã‚«ãƒ¼ãƒ‰ã¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®çµ±ä¸€ */
      .section-container {
        background: var(--bg-primary) !important;
        border: 1px solid var(--border-default) !important;
        box-shadow: var(--shadow-md) !important;
      }
      
      /* ãƒœã‚¿ãƒ³ã®çµ±ä¸€ */
      .btn-primary {
        background: var(--gradient-primary) !important;
        color: white !important;
      }
      
      /* ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®çµ±ä¸€ */
      .error-message {
        background: var(--error-bg) !important;
        border: 1px solid var(--error-border) !important;
        color: var(--error-text) !important;
      }
    </style>
    <!-- ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨é–‹ç™ºä¸­ã®ãŸã‚ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ -->
    <!-- <script src="./js/quality-enhancement-ui.js" defer></script> -->
    <!-- <script src="./js/dynamic-quality-optimizer.js" defer></script> -->
    <!-- <script src="./js/quality-integration-manager.js" defer></script> -->
    <!-- <script src="./js/quality-system-validator.js" defer></script> -->
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Basic Reset and Body Styles for file:// protocol compatibility */
      * {
        box-sizing: border-box;
      }
      
      body {
        margin: 0;
        padding: 0;
        background-color: #0f172a;
        color: #ffffff;
        font-family: "Inter", "Noto Sans JP", sans-serif;
        line-height: 1.6;
        min-height: 100vh;
      }
      
      /* HAQEI Card Styles */
      .haqei-card {
        background-color: #1e293b;
        border: 1px solid #334155;
        border-radius: 0.5rem;
        padding: 1rem;
        margin: 0.5rem 0;
        transition: all 0.3s ease;
      }
      
      .haqei-card:hover {
        border-color: #6366f1;
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.2);
      }
      
      /* HAQEI Button Styles */
      .haqei-button,
      button {
        background-color: #2563eb;
        color: #ffffff;
        padding: 0.5rem 1rem;
        border-radius: 0.5rem;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1rem;
        font-weight: 500;
      }
      
      .haqei-button:hover,
      button:hover {
        background-color: #1d4ed8;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
      }
      
      /* HAQEI Input Styles */
      .haqei-input,
      input,
      textarea {
        background-color: #334155;
        border: 1px solid #475569;
        color: #ffffff;
        padding: 0.5rem;
        border-radius: 0.5rem;
        width: 100%;
        font-size: 1rem;
        line-height: 1.5;
      }
      
      .haqei-input:focus,
      input:focus,
      textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      
      /* Container and Layout */
      .max-w-7xl {
        max-width: 80rem;
      }
      
      .mx-auto {
        margin-left: auto;
        margin-right: auto;
      }
      
      .w-full {
        width: 100%;
      }
      
      /* Background Colors */
      .bg-gray-900 {
        background-color: #111827;
      }
      
      .bg-gray-800 {
        background-color: #1f2937;
      }
      
      .bg-gray-700 {
        background-color: #374151;
      }
      
      .bg-teal-600 {
        background-color: #0d9488;
      }
      
      .bg-teal-700 {
        background-color: #0f766e;
      }
      
      /* Text Colors */
      .text-gray-200 {
        color: #e5e7eb;
      }
      
      .text-gray-300 {
        color: #d1d5db;
      }
      
      .text-gray-400 {
        color: #9ca3af;
      }
      
      .text-white {
        color: #ffffff;
      }
      
      .text-indigo-300 {
        color: #a5b4fc;
      }
      
      .text-yellow-300 {
        color: #fde047;
      }
      
      .text-blue-300 {
        color: #93c5fd;
      }
      
      .text-emerald-300 {
        color: #6ee7b7;
      }
      
      /* Padding and Margins */
      .p-4 {
        padding: 1rem;
      }
      
      .p-6 {
        padding: 1.5rem;
      }
      
      .p-8 {
        padding: 2rem;
      }
      
      .py-3 {
        padding-top: 0.75rem;
        padding-bottom: 0.75rem;
      }
      
      .px-6 {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
      }
      
      .mb-2 {
        margin-bottom: 0.5rem;
      }
      
      .mb-3 {
        margin-bottom: 0.75rem;
      }
      
      .mb-4 {
        margin-bottom: 1rem;
      }
      
      .mb-6 {
        margin-bottom: 1.5rem;
      }
      
      .mb-8 {
        margin-bottom: 2rem;
      }
      
      .mt-2 {
        margin-top: 0.5rem;
      }
      
      /* Border Radius */
      .rounded-lg {
        border-radius: 0.5rem;
      }
      
      .rounded-xl {
        border-radius: 0.75rem;
      }
      
      .rounded-2xl {
        border-radius: 1rem;
      }
      
      /* Shadows */
      .shadow-2xl {
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      }
      
      /* Flexbox */
      .flex {
        display: flex;
      }
      
      .items-center {
        align-items: center;
      }
      
      .justify-center {
        justify-content: center;
      }
      
      .gap-2 {
        gap: 0.5rem;
      }
      
      /* Grid */
      .grid {
        display: grid;
      }
      
      .grid-cols-1 {
        grid-template-columns: repeat(1, minmax(0, 1fr));
      }
      
      .grid-cols-2 {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      
      .grid-cols-4 {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
      
      .gap-4 {
        gap: 1rem;
      }
      
      .gap-8 {
        gap: 2rem;
      }
      
      /* Typography */
      .text-sm {
        font-size: 0.875rem;
      }
      
      .text-base {
        font-size: 1rem;
      }
      
      .text-lg {
        font-size: 1.125rem;
      }
      
      .text-xl {
        font-size: 1.25rem;
      }
      
      .text-2xl {
        font-size: 1.5rem;
      }
      
      .text-3xl {
        font-size: 1.875rem;
      }
      
      .text-4xl {
        font-size: 2.25rem;
      }
      
      .font-bold {
        font-weight: 700;
      }
      
      .font-semibold {
        font-weight: 600;
      }
      
      .text-center {
        text-align: center;
      }
      
      /* Positioning */
      .relative {
        position: relative;
      }
      
      .absolute {
        position: absolute;
      }
      
      .fixed {
        position: fixed;
      }
      
      .top-0 {
        top: 0;
      }
      
      .right-0 {
        right: 0;
      }
      
      .left-0 {
        left: 0;
      }
      
      .bottom-0 {
        bottom: 0;
      }
      
      /* Display */
      .hidden {
        display: none;
      }
      
      .block {
        display: block;
      }
      
      /* Opacity */
      .opacity-0 {
        opacity: 0;
      }
      
      .opacity-50 {
        opacity: 0.5;
      }
      
      /* Transitions */
      .transition {
        transition-property: color, background-color, border-color, text-decoration-color, fill, stroke;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
      }
      
      .duration-300 {
        transition-duration: 300ms;
      }
      
      /* Animation keyframes */
      .animate-spin {
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        from {
          transform: rotate(0deg);
        }
        to {
          transform: rotate(360deg);
        }
      }
      
      /* Card hover effects */
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      
      .card:hover {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      
      /* Gradients */
      .bg-gradient-to-br {
        background-image: linear-gradient(to bottom right, var(--tw-gradient-stops));
      }
      
      .from-blue-900\/20 {
        --tw-gradient-from: rgba(30, 58, 138, 0.2);
        --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(30, 58, 138, 0));
      }
      
      .to-indigo-900\/20 {
        --tw-gradient-to: rgba(49, 46, 129, 0.2);
      }
      
      .from-emerald-900\/20 {
        --tw-gradient-from: rgba(6, 78, 59, 0.2);
        --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(6, 78, 59, 0));
      }
      
      .to-teal-900\/20 {
        --tw-gradient-to: rgba(19, 78, 74, 0.2);
      }
      
      /* Border styles */
      .border {
        border-width: 1px;
      }
      
      .border-gray-600 {
        border-color: #4b5563;
      }
      
      .border-gray-700 {
        border-color: #374151;
      }
      
      .border-blue-500\/30 {
        border-color: rgba(59, 130, 246, 0.3);
      }
      
      .border-emerald-500\/30 {
        border-color: rgba(16, 185, 129, 0.3);
      }
      
      .hover\:border-blue-400:hover {
        border-color: #60a5fa;
      }
      
      .hover\:border-emerald-400:hover {
        border-color: #34d399;
      }
      
      /* Responsive design */
      @media (max-width: 640px) {
        .sm\:p-6 {
          padding: 1.5rem;
        }
        
        .sm\:text-4xl {
          font-size: 2.25rem;
        }
        
        .sm\:grid-cols-2 {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
      }
      
      @media (min-width: 1024px) {
        .lg\:col-span-1 {
          grid-column: span 1 / span 1;
        }
        
        .lg\:col-span-2 {
          grid-column: span 2 / span 2;
        }
        
        .lg\:grid-cols-3 {
          grid-template-columns: repeat(3, minmax(0, 1fr));
        }
        
        .lg\:grid-cols-4 {
          grid-template-columns: repeat(4, minmax(0, 1fr));
        }
      }
      
      /* Specific component styles */
      .tracking-wider {
        letter-spacing: 0.05em;
      }
      
      .inline-block {
        display: inline-block;
      }
      
      .space-y-4 > * + * {
        margin-top: 1rem;
      }
      
      .space-y-3 > * + * {
        margin-top: 0.75rem;
      }
      
      /* SVG icon sizing */
      .h-6 {
        height: 1.5rem;
      }
      
      .w-6 {
        width: 1.5rem;
      }
      
      .h-5 {
        height: 1.25rem;
      }
      
      .w-5 {
        width: 1.25rem;
      }
      
      .h-4 {
        height: 1rem;
      }
      
      .w-4 {
        width: 1rem;
      }
      
      /* Focus styles */
      .focus\:ring-indigo-500:focus {
        --tw-ring-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }
      
      .focus\:border-indigo-500:focus {
        border-color: #6366f1;
      }
      
      /* Utility classes */
      .min-h-screen {
        min-height: 100vh;
      }
      
      .items-start {
        align-items: flex-start;
      }
      
      /* Text truncation */
      .truncate {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      
      /* Background opacity utilities */
      .bg-gray-900\/50 {
        background-color: rgba(17, 24, 39, 0.5);
      }
      
      .bg-gray-900\/30 {
        background-color: rgba(17, 24, 39, 0.3);
      }
      
      .bg-gray-800\/50 {
        background-color: rgba(31, 41, 55, 0.5);
      }
      
      /* Border opacity utilities */
      .border-gray-600\/50 {
        border-color: rgba(75, 85, 99, 0.5);
      }
      
      .border-gray-700\/50 {
        border-color: rgba(55, 65, 81, 0.5);
      }
      
      /* Backdrop utilities for loading screen */
      .backdrop-filter {
        backdrop-filter: blur(10px);
      }
      
      /* Z-index utilities */
      .z-50 {
        z-index: 50;
      }
      
      .z-1000 {
        z-index: 1000;
      }
      
      .z-9999 {
        z-index: 9999;
      }
      
      /* Flex utilities */
      .flex-wrap {
        flex-wrap: wrap;
      }
      
      .gap-3 {
        gap: 0.75rem;
      }
      
      /* Hover effects for buttons */
      .hover\:bg-teal-700:hover {
        background-color: #0f766e;
      }
      
      .hover\:text-white:hover {
        color: #ffffff;
      }
      
      /* Transform utilities */
      .transform {
        transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y));
      }
      
      .-translate-x-1\/2 {
        --tw-translate-x: -50%;
      }
      
      .translate-x-1\/2 {
        --tw-translate-x: 50%;
      }
      
      /* Additional specific styles for the application */
      .brand-text {
        background: linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        color: transparent;
      }
      
      /* Additional HAQEI component styles */
      
      /* Enhanced Progressive Loading Styles */
      .skeleton {
        background: linear-gradient(90deg, rgba(55, 65, 81, 0.1) 25%, rgba(75, 85, 99, 0.2) 37%, rgba(55, 65, 81, 0.1) 63%);
        background-size: 400% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
      }
      
      @keyframes skeleton-loading {
        0% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .skeleton-text {
        height: 1em;
        border-radius: 4px;
        margin: 0.5em 0;
      }
      
      .skeleton-button {
        height: 3em;
        border-radius: 8px;
        width: 100%;
      }
      
      .skeleton-card {
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .skeleton-chart {
        height: 300px;
        border-radius: 8px;
      }
      
      .fade-in {
        animation: fadeIn 0.6s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(17, 24, 39, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(10px);
      }
      
      .loading-content {
        text-align: center;
        max-width: 400px;
        padding: 2rem;
        background: rgba(30, 41, 59, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(99, 102, 241, 0.3);
      }
      
      .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(165, 180, 252, 0.3);
        border-left: 4px solid #a5b4fc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      
      .loading-text {
        color: #a5b4fc;
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }
      
      .progress-container {
        margin-top: 1rem;
      }
      
      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(55, 65, 81, 0.5);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #a855f7);
        border-radius: 4px;
        transition: width 0.3s ease;
        position: relative;
      }
      
      .progress-percentage {
        color: #cbd5e1;
        font-size: 0.875rem;
        text-align: center;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Enhanced Mobile Optimizations */
      @media (max-width: 768px) {
        .loading-content {
          margin: 1rem;
          padding: 1.5rem;
        }
        
        .loading-text {
          font-size: 1rem;
        }
      }
      
      /* Accessibility Enhancements */
      @media (prefers-reduced-motion: reduce) {
        .skeleton {
          animation: none;
        }
        
        .loading-spinner {
          animation: none;
          border-left-color: rgba(165, 180, 252, 0.8);
        }
        
        .fade-in {
          animation: none;
        }
      }
      
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      .card:hover,
      .card.highlighted {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      .rank-badge {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 9999px;
        line-height: 1;
      }
      .rank-s,
      .rank-a,
      .rank-b,
      .rank-c {
        background-color: rgba(74, 222, 128, 0.2);
        color: #86efac;
        border: 1px solid #22c55e;
      }
      .rank-d {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #fbbf24;
      }
      .rank-e,
      .rank-f,
      .rank-g {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .rank-h {
        background-color: rgba(185, 28, 28, 0.2);
        color: #fca5a5;
        border: 1px solid #dc2626;
      }

      /* Data Export Styles removed as per user request */
      
      .progressive-load {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.6s ease;
      }
      
      .progressive-load.loaded {
        opacity: 1;
        transform: translateY(0);
      }

      /* ğŸŒŸ New Result Page Styles (2025-08-07 Renewal) */
      .result-container {
        padding: 2rem;
        background: #1a1f2e;
        min-height: 100vh;
      }
      
      .result-layout {
        display: grid;
        grid-template-columns: 30% 70%;
        gap: 2rem;
        max-width: 1400px;
        margin: 0 auto;
      }
      
      /* Left Panel Styles */
      .analysis-summary-panel {
        background: #2d3748;
        border-radius: 12px;
        padding: 1.5rem;
        color: #f7fafc;
      }
      
      .current-position-card {
        background: rgba(45, 55, 72, 0.5);
        border: 2px solid #ffd700;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
      }
      
      .hexagram-highlight {
        color: #ffd700;
        font-weight: bold;
      }
      
      .panel-title {
        font-size: 1.1rem;
        margin-bottom: 0.5rem;
        color: #cbd5e0;
      }
      
      .theme-description {
        margin-top: 0.5rem;
      }
      
      .theme-description p {
        margin: 0.5rem 0;
        font-size: 0.9rem;
        line-height: 1.5;
      }
      
      .theme-detail {
        color: #a0aec0;
        font-size: 0.85rem;
      }
      
      /* Score Display */
      .score-display {
        margin: 1.5rem 0;
      }
      
      .score-item {
        background: rgba(45, 55, 72, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      .score-item label {
        display: block;
        font-size: 0.9rem;
        color: #a0aec0;
        margin-bottom: 0.5rem;
      }
      
      .score-value {
        display: flex;
        align-items: baseline;
        gap: 0.5rem;
      }
      
      .score-number {
        font-size: 2rem;
        font-weight: bold;
        color: #f7fafc;
      }
      
      .score-label {
        font-size: 1rem;
        color: #cbd5e0;
      }
      
      .score-note {
        font-size: 0.8rem;
        color: #718096;
        margin-top: 0.5rem;
      }
      
      /* Current Graph */
      .current-graph-container {
        margin: 1.5rem 0;
      }
      
      .current-graph-container h4 {
        font-size: 1rem;
        margin-bottom: 1rem;
        color: #cbd5e0;
      }
      
      /* I Ching Interpretation */
      .iching-interpretation {
        background: rgba(45, 55, 72, 0.3);
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1.5rem;
      }
      
      .iching-interpretation h4 {
        font-size: 0.9rem;
        color: #ffd700;
        margin-bottom: 1rem;
      }
      
      .interpretation-content {
        font-size: 0.85rem;
        line-height: 1.6;
        color: #cbd5e0;
      }
      
      .stage-title {
        font-weight: bold;
        color: #f7fafc;
        margin-bottom: 0.5rem;
      }
      
      .stage-advice {
        margin-top: 0.75rem;
        padding: 0.5rem 0.75rem;
        background-color: rgba(99, 102, 241, 0.1);
        border-left: 3px solid #6366f1;
        color: #e0e7ff;
        font-size: 0.9rem;
        border-radius: 0.25rem;
      }
      
      /* Right Area Styles */
      .detailed-results-area {
        background: #2d3748;
        border-radius: 12px;
        padding: 1.5rem;
      }
      
      .section-title {
        font-size: 1.2rem;
        color: #e2e8f0;
        margin-bottom: 1rem;
      }
      
      /* Future Branching Graph */
      .future-branching-graph {
        margin-bottom: 2rem;
      }
      
      .graph-container {
        background: rgba(26, 31, 46, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
      }
      
      /* Theme Boxes */
      .theme-boxes {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
      }
      
      .theme-box {
        border-radius: 8px;
        padding: 1rem;
      }
      
      .progress-theme {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
        border: 1px solid #10b981;
      }
      
      .change-theme {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(139, 92, 246, 0.1));
        border: 1px solid #8b5cf6;
      }
      
      .theme-box h4 {
        color: #f7fafc;
        font-size: 1rem;
        margin-bottom: 0.5rem;
      }
      
      .theme-content {
        font-size: 0.85rem;
        line-height: 1.5;
        color: #cbd5e0;
      }
      
      /* Eight Scenarios Grid */
      .eight-scenarios-grid {
        margin-top: 2rem;
      }
      
      .scenarios-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        grid-template-rows: repeat(2, 1fr);
        gap: 1rem;
      }
      
      .scenario-card-new {
        background: rgba(45, 55, 72, 0.5);
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 8px;
        padding: 1rem;
        transition: all 0.3s ease;
      }
      
      .scenario-card-new:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      .scenario-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
      }
      
      .scenario-rank {
        font-size: 1.5rem;
        font-weight: bold;
      }
      
      .rank-s { color: #ffd700; }
      .rank-a { color: #10b981; }
      .rank-b { color: #3b82f6; }
      .rank-c { color: #f59e0b; }
      .rank-d { color: #ef4444; }
      .rank-e { color: #8b5cf6; }
      .rank-f { color: #6b7280; }
      
      .scenario-score {
        font-size: 1.2rem;
        font-weight: bold;
        color: #f7fafc;
      }
      
      .scenario-name {
        font-size: 0.9rem;
        color: #cbd5e0;
        margin: 0.5rem 0;
      }
      
      .scenario-steps {
        font-size: 0.8rem;
        color: #a0aec0;
        margin: 0.5rem 0;
      }
      
      .scenario-mini-graph {
        margin-top: 0.5rem;
        height: 40px;
      }
      
      /* Responsive Design */
      @media (max-width: 1024px) {
        .result-layout {
          grid-template-columns: 1fr;
        }
        
        .scenarios-grid {
          grid-template-columns: repeat(2, 1fr);
          grid-template-rows: repeat(4, 1fr);
        }
      }
      
      @media (max-width: 640px) {
        .theme-boxes {
          grid-template-columns: 1fr;
        }
        
        .scenarios-grid {
          grid-template-columns: 1fr;
        }
      }
      
      /* ğŸŒŸ Authentic I Ching System Styles */
      .authentic-scenarios-container,
      .authentic-choice-container,
      .current-position-container {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }

      .scenario-card, .choice-card {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .scenario-card:hover, .choice-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        border-color: rgba(99, 102, 241, 0.7);
      }

      .scenario-card.selected, .choice-card.selected {
        border-color: #6366f1;
        background: rgba(99, 102, 241, 0.2);
      }

      .hexagram-line {
        display: flex;
        align-items: center;
        margin: 0.25rem 0;
        font-family: monospace;
      }

      .hexagram-line.yang .line-symbol {
        color: #fbbf24;
      }

      .hexagram-line.yin .line-symbol {
        color: #93c5fd;
      }

      .hexagram-line.current {
        background: rgba(245, 101, 101, 0.2);
        border-radius: 4px;
        padding: 0.25rem;
      }

      .transformation-visual {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 1rem 0;
      }

      .transformation-arrow {
        font-size: 1.5rem;
        color: #6366f1;
        margin: 0 1rem;
      }

      .HaQei-analysis .persona-analysis {
        background: rgba(31, 41, 55, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
      }

      .fade-in {
        opacity: 0;
        animation: fadeInUp 0.6s ease forwards;
      }

      .fade-in.visible {
        opacity: 1;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Phase 6-10 Enhancement Styles */
      .choice-selected {
        border-color: #10b981 !important;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3)) !important;
        transform: scale(1.02) !important;
      }
      
      .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      
      .animate-slide-up {
        animation: slideUp 0.3s ease-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes slideUp {
        from { 
          opacity: 0; 
          transform: translate(-50%, 20px); 
        }
        to { 
          opacity: 1; 
          transform: translate(-50%, 0); 
        }
      }
      
      #char-counter {
        transition: color 0.3s ease;
      }
      
      .export-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
      }
      
      .export-button:active {
        transform: translateY(0);
      }
      
      /* Input validation styles */
      .input-valid {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      }
      
      .input-invalid {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
      }
      
      /* Loading state improvements */
      .loading button {
        pointer-events: none;
        opacity: 0.7;
      }
      
      /* Scenario generation animations */
      /* 3æ®µéšå¤‰åŒ–è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
      .hexagram-transformation {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin: 1rem 0;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
      }
      
      .current-hexagram, .target-hexagram {
        font-weight: 600;
        color: #A5B4FC;
      }
      
      .transform-arrow {
        color: #10B981;
        font-size: 1.2rem;
      }
      
      .three-phase-container {
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 12px;
      }
      
      .three-phase-container h4 {
        color: #F59E0B;
        margin-bottom: 1rem;
        text-align: center;
      }
      
      .phase-block {
        margin: 1rem 0;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 8px;
        border-left: 3px solid;
      }
      
      .phase-1 { border-left-color: #3B82F6; }
      .phase-2 { border-left-color: #F59E0B; }
      .phase-3 { border-left-color: #10B981; }
      
      .phase-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
      }
      
      .phase-icon {
        font-size: 1.2rem;
      }
      
      .phase-name {
        font-weight: 600;
        color: #E0E7FF;
      }
      
      .score-indicator {
        margin: 0.5rem 0;
        font-size: 0.9rem;
        color: #A5B4FC;
      }
      
      .score-indicator .positive {
        color: #10B981;
      }
      
      .score-indicator .negative {
        color: #EF4444;
      }
      
      .final-score {
        font-weight: 600;
        color: #FDE047;
      }
      
      .phase-description {
        font-size: 0.85rem;
        line-height: 1.4;
        color: #CBD5E1;
        margin-top: 0.5rem;
      }
      
      .scenario-card {
        transition: all 0.3s ease;
      }
      
      .scenario-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(99, 102, 241, 0.2);
      }
      
      /* Progress indicators */
      .progress-indicator {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4);
        border-radius: 2px;
        transition: width 0.3s ease;
      }
    </style>
    
    <!-- Core System Assets - æœ€é©åŒ–èª­ã¿è¾¼ã¿é †åº -->
    <script src="./assets/H384H64database.js"></script>
    
    <!-- P0-2: Direct RandomnessManager Implementation (Final Solution) -->
    <script>
        console.log('[HAQEI][P0-2] Direct RandomnessManager initialization...');
        
        // Minimal but sufficient RandomnessManager implementation
        class DirectRandomnessManager {
            constructor() {
                this.seed = 12345;
                this.current = this.seed;
                console.log('[HAQEI][P0-2] âœ… Direct RandomnessManager created');
            }
            
            // Linear congruential generator (simple but deterministic)
            next() {
                this.current = (this.current * 1664525 + 1013904223) % Math.pow(2, 32);
                return this.current / Math.pow(2, 32);
            }
            
            getGenerator(type = 'deterministic') {
                return {
                    next: () => this.next(),
                    nextInt: (min, max) => Math.floor(this.next() * (max - min + 1)) + min,
                    seed: this.seed,
                    direct: true
                };
            }
            
            setState(state) {
                if (state && typeof state.current === 'number') {
                    this.current = state.current;
                }
            }
            
            getState() {
                return { current: this.current, seed: this.seed };
            }
        }
        
        // Set globals immediately and synchronously
        window.randomnessManager = new DirectRandomnessManager();
        window.DirectRandomnessManager = DirectRandomnessManager;
        
        console.log('[HAQEI][P0-2] RandomnessManager globals ready immediately');
        
        // For compatibility, also set as SeedableRandom equivalent
        window.SeedableRandom = class SeedableRandom {
            constructor(seed = 12345) {
                this.manager = new DirectRandomnessManager();
                this.manager.seed = seed;
                this.manager.current = seed;
            }
            
            next() { return this.manager.next(); }
            nextInt(min, max) { return this.manager.getGenerator().nextInt(min, max); }
        };
        
        console.log('[HAQEI][P0-2] âœ… All randomness implementations ready');
    </script>
    
    <!-- Removed: DataDrivenKeywordAnalyzer (obsolete) -->
    <script src="./js/ThreePhaseSystem.js"></script>
    <script src="./js/core/H384DatabaseConnector.js"></script>
    <!-- Removed: IChingChoiceLogic (obsolete) -->
    <script src="./js/core/DynamicScenarioColorSystem.js?v=20250909"></script>
    <script src="./js/core/IChingGuidanceEngine.js?v=20250909"></script>
    <!-- ThreeStageVisualizer.js - ç„¡åŠ¹åŒ– -->
    <!-- Removed legacy UI: ScoreVisualization / EightScenariosDisplay -->
    <!-- <script src="./js/components/ScoreVisualization.js"></script> -->
    <!-- <script src="./js/components/EightScenariosDisplay.js?v=20250909"></script> -->
    <!-- New: EightBranches display (é€²/å¤‰ 8åˆ†å²) -->
    <script src="./js/core/BranchGenerator.js?v=20250909"></script>
    <script src="./js/components/EightBranchesDisplay.js?v=20250909"></script>
    <!-- Removed legacy controller: ResultPageController (not used in minimal mode) -->
    <!-- <script src="./js/components/ResultPageController.js?v=20250909"></script> -->
    <script src="./js/future-simulator-integration.js?v=20250909"></script>
    <script src="./js/core/PerformanceOptimizer.js"></script>
    <script src="./js/core/IChingTransformationEngine.js"></script>
    <script src="./js/core/FutureBranchingSystem.js"></script>
    <script src="./js/core/DataPersistenceManager.js"></script>
    <script src="./js/core/DataExportAPI.js"></script>
    <script src="./js/core/types.js"></script>
    <script src="./js/core/storage.js"></script>
    <script src="./js/core/charts.js"></script>
    <script src="./js/core/contract-integration.js"></script>
    
    <!-- H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèª & DataDrivenAnalyzeråˆæœŸåŒ– -->
    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã¨ã—ã¦DataDrivenAnalyzerã‚’ä¿æŒ
        let dataAnalyzer = null;
        
        (function() {
            console.log('ğŸ” H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèªã‚’é–‹å§‹...');
            
            if (typeof H384_DATA === 'undefined') {
                console.error('H384_DATA variable not found');
                console.warn('âš ï¸  ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’è©¦è¡Œä¸­...');
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: window.H384_DATAã‚’ç¢ºèª
                if (typeof window.H384_DATA !== 'undefined') {
                    console.log('âœ… window.H384_DATAã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ');
                    window.H384_DATA = window.H384_DATA;
                } else {
                    console.error('Fallback mechanism unavailable');
                }
            } else {
                console.log('âœ… H384_DATAå¤‰æ•°ã®å­˜åœ¨ç¢ºèª: æˆåŠŸ');
                
                // window.H384_DATAã¸ã®ä»£å…¥ç¢ºèª
                if (typeof window.H384_DATA === 'undefined') {
                    console.warn('âš ï¸  window.H384_DATAãŒæœªè¨­å®š - è‡ªå‹•è¨­å®šã‚’è©¦è¡Œ');
                    try {
                        window.H384_DATA = H384_DATA;
                        console.log('âœ… window.H384_DATAè‡ªå‹•è¨­å®š: æˆåŠŸ');
                    } catch (error) {
                        console.error('window.H384_DATA setup error:', error);
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ã®åŸºæœ¬ç¢ºèª
                if (Array.isArray(window.H384_DATA) && window.H384_DATA.length === 386) {
                    console.log('âœ… H384_DATAãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ç¢ºèª: æˆåŠŸ (386ã‚¨ãƒ³ãƒˆãƒª)');
                    
                    // DataDrivenKeywordAnalyzerã¯å»ƒæ­¢ï¼ˆIChingGuidanceEngineã«çµ±åˆï¼‰
                    
                    // ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã®ç¢ºèª
                    const youkuu = window.H384_DATA.find(item => item['é€šã—ç•ªå·'] === 7);
                    const yourikuu = window.H384_DATA.find(item => item['é€šã—ç•ªå·'] === 14);
                    
                    if (youkuu && yourikuu) {
                        console.log('âœ… ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªç¢ºèª: æˆåŠŸ');
                        console.log(`   - ç”¨ä¹: ${youkuu['å¦å']} (${youkuu['çˆ»']})`);
                        console.log(`   - ç”¨å…­: ${yourikuu['å¦å']} (${yourikuu['çˆ»']})`);
                    } else {
                        console.warn('âš ï¸  ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                    }
                } else {
                    console.error('H384_DATA format error:', {
                        isArray: Array.isArray(window.H384_DATA),
                        length: window.H384_DATA?.length
                    });
                }
            }
            
            console.log('ğŸ H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèªå®Œäº†');
        })();
    </script>
    <script src="./js/keyword_expansion_engine.js"></script>
    <script src="./js/ml-integration.js" async defer></script>
    <!-- Offline-First Dictionary System -->
    <script src="./js/core/DictionaryManager.js" defer></script>
    <script src="./js/core/OfflineDetector.js" defer></script>
    <script src="./js/core/OfflineKuromojiInitializer.js" defer></script>
    <script src="./js/core/offline-kuromoji-integration.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js" defer></script>
    <!-- Advanced Analysis Dependencies -->
    <!-- Chart.js ãƒ©ã‚¤ãƒ–ãƒ©ãƒªèª­ã¿è¾¼ã¿ -->
    <script src="./lib/chart.min.js"></script>
    <script src="./js/lib/chartjs-plugin-annotation.min.js"></script>
    <script src="./js/lib/ml-matrix.min.js"></script>
    <!-- Phase 2 çµ±åˆè¡¨ç¾ã‚¨ãƒ³ã‚¸ãƒ³ -->
    <script src="./js/core/EnhancedH384DataExtractor.js"></script>
    <script src="./js/core/ExpressionVariationEngine.js"></script>
    <script src="./js/core/ExpressionQualityValidator.js"></script>
    
    <!-- ğŸŒŸ New Display System -->
    <!-- Removed old display stack: future-simulator-expression/display -->
    
    <!-- Dynamic Analysis Components -->
    <script src="./js/pages/future-simulator/DynamicKeywordGenerator.js"></script>
    <script src="./js/pages/future-simulator/IntegratedAnalysisEngine.js"></script>
    <script src="./js/pages/future-simulator/MultiDimensionalContextAnalyzer.js"></script>
    <script src="./js/pages/future-simulator/SituationalContextEngine.js"></script>
    <script src="./js/pages/future-simulator/HexagramMappingEngine.js"></script>
    <script src="./js/pages/future-simulator/MetaphorGenerationEngine.js"></script>
    
    <!-- ğŸŒŸ Authentic I Ching System Components -->
    <script src="./js/core/AuthenticIChingEngine.js"></script>
    <script src="./js/components/CurrentPositionDisplay.js"></script>
    <script src="./js/components/AuthenticChoiceSystem.js"></script>
    <!-- Removed old authentic systems to avoid conflicts -->
    
    <!-- I Ching Integration System -->
    <script src="./js/iching-situation-analyzer.js"></script>
    <script src="./js/yao-transformation-simulator.js"></script>
    <script src="./js/iching-metaphor-display.js"></script>
    <!-- iching-future-simulator.js now loaded as ESM module below -->
    
    <!-- Global I Ching Simulator Factory -->
    <script>
      function getIChingSimulator() {
        if (window.ichingSimulator && window.ichingSimulator.isReady && window.ichingSimulator.isReady()) {
          return window.ichingSimulator;
        }
        return null;
      }
      window.getIChingSimulator = getIChingSimulator;
    </script>
    
    <!-- Future Simulator Core & Binary Tree System -->
    <!-- Removed old core/binary-tree systems (EightScenariosDisplay is authoritative) -->
    <!-- binary-tree-complete-display.js - ç„¡åŠ¹åŒ–ï¼ˆinnerHTMLå•é¡Œã®ãŸã‚ï¼‰ -->
    
    <!-- v2.2.0: KingWenMapping 64å¦çµ±åˆã‚·ã‚¹ãƒ†ãƒ  (ES Module Dynamic Loader) -->
    <!-- v2-module-loader temporarily disabled to debug export error -->
    <!-- <script type="module" src="./js/v2-module-loader.js"></script> -->
    
    <!-- 7æ—¥é–“ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ—ãƒªãƒ³ãƒˆ ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="./js/validation/ValidationMetrics.js"></script>
    <script src="./js/validation/EvidencePanel.js"></script>
    <script src="./js/validation/PersonaValidationSystem.js"></script>
    <script src="./js/validation/ValidationOrchestrator.js"></script>
    
    <!-- 8ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ—§ãƒ­ã‚¸ãƒƒã‚¯ï¼‰å‰Šé™¤ï¼šæ–°UI(EightScenariosDisplay)ã‚’ä½¿ç”¨ -->
    
    <!-- Future Simulator UI Enhancement System -->
    <!-- Removed UI enhancements tied to old display system -->
    <!-- Dev Diagnostics -->
    <script src="./js/dev/Diagnostics.js"></script>
  </head>
  <body class="min-h-screen p-4 sm:p-6" data-progressive-load>
    <!-- Loading Screen Completely Removed -->
    
    <div
      class="w-full max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8"
      id="main-container"
      style="opacity: 1;"
    >
      <header class="text-center mb-8 relative">
        <div class="inline-block">
          <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
            æ˜“çµŒæœªæ¥åˆ†æã‚·ã‚¹ãƒ†ãƒ 
          </h1>
          <p class="text-gray-400 mt-2 text-lg">384ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹çŠ¶æ³åˆ†æãƒ„ãƒ¼ãƒ«</p>
          <div class="flex justify-center gap-6 mt-3 text-sm text-gray-500">
            <span>ğŸ“Š æ˜“çµŒã«ã‚ˆã‚‹æœªæ¥åˆ†æ</span>
            <span>ğŸ—ƒï¸ ä¼çµ±çš„ãªæ˜“çµŒãƒ‘ã‚¿ãƒ¼ãƒ³æ´»ç”¨</span>
            <span>â±ï¸ è¤‡æ•°ã®å±•é–‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æç¤º</span>
          </div>
        </div>
        <button
          id="helpBtn"
          class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.25l-2.536 2.39c-.832.786-1.464 1.49-1.464 2.36h.001M12 18h.01"
            />
          </svg>
        </button>
        <button
          id="diagBtn"
          class="absolute top-0 right-10 p-2 text-gray-400 hover:text-white transition-colors"
          title="Run IChing diagnostics (console)"
          onclick="window.runIChingDiagnostics && window.runIChingDiagnostics()"
        >
          ğŸ§ª
        </button>
      </header>

      <!-- Input Section with Skeleton -->      
      <div class="bg-gray-900/50 p-6 rounded-xl mb-4 relative progressive-load" id="input-section">
        
        <!-- Actual Input Content -->
        <div class="input-content" id="input-content" style="display: block;">
          <h2 class="text-lg font-bold text-indigo-300 mb-3">
            1. AIã«ã‚ˆã‚‹çŠ¶æ³æ¨æ¸¬
          </h2>
        <div
          class="border border-gray-700 rounded-lg p-4 mb-4 text-sm text-gray-300 space-y-3"
        >
          <p class="text-base font-bold text-center text-indigo-300">
            AIã¸ã®æœ€é«˜ã®ã€Œå‘ªæ–‡ã€ã¯ã€ã‚ãªãŸã®ã€Œã‚ã‚Šã®ã¾ã¾ã®è¨€è‘‰ã€ã§ã™
          </p>
          <p class="text-xs text-center text-gray-400">
            æœªæ¥åˆ†å²å›³ã®ç²¾åº¦ã‚’é«˜ã‚ã‚‹ã€ãŸã£ãŸä¸€ã¤ã®ç§˜è¨£
          </p>
          <p>
            ã“ã‚Œã‹ã‚‰ã€ã‚ãªãŸã®ç¾çŠ¶ã¨èª²é¡Œã‚’AIã«å…¥åŠ›ã—ã¦ã„ãŸã ãã¾ã™ã€‚ãã®éš›ã€ã©ã†ã‹<strong>ã€Œä¸Šæ‰‹ãªæ–‡ç« ã‚’æ›¸ã“ã†ã€ã¨ã—ãªã„ã§ãã ã•ã„ã€‚</strong>AIã¯ã€æ•´ãˆã‚‰ã‚ŒãŸæ–‡ç« ã‚ˆã‚Šã‚‚ã€ã‚ãªãŸã®<strong>ã€Œç”Ÿã®è¨€è‘‰ã€</strong>ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚
          </p>
          <p>
            ç®‡æ¡æ›¸ãã§ã‚‚ã€å¿ƒã®ã¤ã¶ã‚„ãã§ã‚‚ã€èª°ã‹ã«æ„šç—´ã‚’ã“ã¼ã™ã‚ˆã†ãªè¨€è‘‰ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ä»–äººã«è¦‹ã›ã‚‹ãŸã‚ã®æ–‡ç« ã§ã¯ãªãã€<strong>ã‚ãªãŸè‡ªèº«ã®ãŸã‚ã®ã€Œæ€è€ƒã®ãƒ¡ãƒ¢ã€</strong>ã¨ã—ã¦ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
          </p>
          <p>
            ãªãœãªã‚‰ã€AIã¯ã‚ãªãŸãŒé¸ã¶ä¸€ã¤ä¸€ã¤ã®å˜èªã€è¡¨ç¾ã®æºã‚Œã€æ„Ÿæƒ…ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‹ã‚‰ã€ã‚ãªãŸã ã‘ã®ã€Œæ€è€ƒã®ã‚¯ã‚»ã€ã‚„ã€Œå¿ƒã®å‹•ãã€ã‚’èª­ã¿å–ã‚‹ã‹ã‚‰ã§ã™ã€‚
          </p>
          <div class="pt-2">
            <p class="font-bold text-gray-200">ã€å…¥åŠ›ã®ãƒ’ãƒ³ãƒˆã€‘</p>
            <div
              class="mt-2 p-3 rounded-lg bg-red-900/20 border border-red-800/50"
            >
              <p class="font-bold">æ‚ªã„ä¾‹ âŒ</p>
              <p class="text-xs italic mt-1">
                ã€Œæ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã«ãŠã„ã¦ã€äººçš„ãƒªã‚½ãƒ¼ã‚¹ã®ä¸è¶³ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãªã‚Šã€è¨ˆç”»ã«é…å»¶ãŒç”Ÿã˜ã¦ã„ã¾ã™ã€‚ã€
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ï¼ˆã“ã‚Œã§ã¯ã€AIã¯ä¸€èˆ¬çš„ãªãƒ“ã‚¸ãƒã‚¹èª²é¡Œã¨ã—ã¦ã—ã‹åˆ†æã§ãã¾ã›ã‚“ï¼‰
              </p>
            </div>
            <div
              class="mt-2 p-3 rounded-lg bg-emerald-900/20 border border-emerald-800/50"
            >
              <p class="font-bold">è‰¯ã„ä¾‹ â­•</p>
              <p class="text-xs italic mt-1">
                ã€Œæ–°ã—ã„ä»•äº‹ã€ãƒã‚¸ã§äººè¶³ã‚Šã¦ãªã„ï¼Aã•ã‚“ã¯é ‘å¼µã£ã¦ãã‚Œã¦ã‚‹ã‘ã©ã€Bã•ã‚“ã¯å…¨ç„¶ã‚„ã‚‹æ°—ãªã„ã—â€¦ã€‚ã“ã®ã¾ã¾ã ã¨çµ¶å¯¾é–“ã«åˆã‚ãªã„ã€‚ã©ã†ã™ã‚Šã‚ƒã„ã„ã‚“ã â€¦ã€‚ç„¦ã‚‹ã€‚ã€
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ï¼ˆã“ã®æ–¹ãŒã€ã‚ãªãŸã®æ„Ÿæƒ…ã€äººé–“é–¢ä¿‚ã¸ã®èªè­˜ã€åˆ‡è¿«æ„ŸãŒä¼ã‚ã‚Šã€ã‚ˆã‚Šãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸåˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼‰
              </p>
            </div>
          </div>
          <p class="font-bold text-center pt-2">
            æ˜“çµŒã®384ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆ64å¦Ã—6çˆ»ï¼‰ã«ã‚ˆã‚‹å®¢è¦³çš„åˆ†æã«ã‚ˆã‚Šã€<br />ç¾åœ¨ã®çŠ¶æ³ã‹ã‚‰å°ã‹ã‚Œã‚‹8ã¤ã®æœªæ¥è»Œé“ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚
          </p>
        </div>
        
        <!-- ã‚ãªãŸã®æœªæ¥ã‚’èª­ã¿è§£ãã¾ã™ -->
        <div class="mb-6 text-center">
          <h3 class="text-xl font-bold text-indigo-300 mb-2">
            ğŸ“Š æ˜“çµŒ384ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚‹çŠ¶æ³åˆ†æ
          </h3>
          <p class="text-sm text-gray-400">
            æ˜“çµŒã®çŸ¥æµã«åŸºã¥ã8ã¤ã®æœªæ¥å¯èƒ½æ€§ã‚’åˆ†æ
          </p>
        </div>
        
        <textarea
          id="worryInput"
          class="bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 mb-4"
          rows="4"
          placeholder="ç¾åœ¨ã®çŠ¶æ³ã‚’å®¢è¦³çš„ã«è¨˜è¿°ã—ã¦ãã ã•ã„ï¼ˆè·å ´ç’°å¢ƒã€é¸æŠè‚¢ã€åˆ¶ç´„æ¡ä»¶ã€æ™‚é–“è»¸ãªã©ï¼‰"
        ></textarea>
        <button
            id="aiGuessBtn"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 flex items-center justify-center gap-2"
          >
            <svg class="animate-spin h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg
              id="originalIcon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                clip-rule="evenodd"
              />
            </svg>
            <span id="buttonText">åˆ†æå®Ÿè¡Œ</span>
          </button>
        </div>
      </div>


      <!-- Data Export Section removed as per user request -->

      <!-- æ—§ç‰ˆUIå®Œå…¨å‰Šé™¤å®Œäº† (2025-08-07) -->
      
      <!-- ğŸŒ¸ æœªæ¥åˆ†æçµæœã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
      <div id="resultsContainer" class="results-container" style="display: none; margin-top: 2rem;"></div>

      <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ï¼šåˆ†æå®Ÿè¡Œæ™‚ã«å‹•çš„ã«ç”Ÿæˆã•ã‚Œã¾ã™ -->
    </div>

    <!-- Module Script -->
    <script type="module">
      // ğŸš€ Emergency Fix: Minimal Working ProgressiveLoader
      class ProgressiveLoader {
        constructor() {
          this.progress = 0;
          this.analysisHistory = [];
          console.log('âœ… ProgressiveLoader initialized');
          this.init();
        }

        init() {
          setTimeout(() => {
            this.showInputForm();
            this.initializeEventListeners();
          }, 500);
        }

        showInputForm() {
          const inputContent = document.getElementById('input-content');
          const worryInput = document.getElementById('worryInput');
          
          if (inputContent) {
            inputContent.style.display = 'block';
            inputContent.style.opacity = '1';
            
            if (worryInput) {
              setTimeout(() => {
                worryInput.focus();
              }, 300);
            }
          }
        }

        initializeEventListeners() {
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          const worryInput = document.getElementById('worryInput');
          
          if (aiGuessBtn && worryInput) {
            // åˆæœŸçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ã‚’ç„¡åŠ¹åŒ–
            aiGuessBtn.disabled = true;
            aiGuessBtn.setAttribute('disabled', 'disabled');
            
            // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ç›£è¦–
            const updateButtonState = () => {
              const inputLength = worryInput.value.trim().length;
              if (inputLength >= 10) {
                aiGuessBtn.disabled = false;
                aiGuessBtn.removeAttribute('disabled');
                aiGuessBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                aiGuessBtn.classList.add('hover:bg-teal-700', 'cursor-pointer');
              } else {
                aiGuessBtn.disabled = true;
                aiGuessBtn.setAttribute('disabled', 'disabled');
                aiGuessBtn.classList.add('opacity-50', 'cursor-not-allowed');
                aiGuessBtn.classList.remove('hover:bg-teal-700', 'cursor-pointer');
              }
            };
            
            // å„ç¨®å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã§çŠ¶æ…‹æ›´æ–°
            worryInput.addEventListener('input', updateButtonState);
            worryInput.addEventListener('keyup', updateButtonState);
            worryInput.addEventListener('paste', () => {
              setTimeout(updateButtonState, 10);
            });
            
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®åˆ†æå®Ÿè¡Œï¼ˆå…¥åŠ›ãŒååˆ†ãªå ´åˆã«ProgressiveLoaderçµŒç”±ã§å®Ÿè¡Œï¼‰
            aiGuessBtn.addEventListener('click', () => {
              const inputText = worryInput.value.trim();
              if (!(inputText && inputText.length >= 10)) {
                showUserMessage('10æ–‡å­—ä»¥ä¸Šã§å…·ä½“çš„ãªçŠ¶æ³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'warning');
                return;
              }
              try {
                if (typeof this.performAnalysis === 'function') {
                  this.performAnalysis(inputText);
                } else if (window.FutureSimulator && window.FutureSimulator.Core && typeof window.FutureSimulator.Core.startAnalysis === 'function') {
                  const situationInput = document.getElementById('situation-input') ||
                                        document.querySelector('textarea[placeholder*="çŠ¶æ³"]') ||
                                        document.querySelector('textarea');
                  if (situationInput) situationInput.value = inputText;
                  window.FutureSimulator.Core.startAnalysis();
                } else {
                  console.error('åˆ†æå®Ÿè¡Œå…ˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                  showUserMessage('å†…éƒ¨ã‚¨ãƒ©ãƒ¼: åˆ†æã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã§ã—ãŸ', 'error');
                }
              } catch (e) {
                console.error('åˆ†æé–‹å§‹æ™‚ã®ã‚¨ãƒ©ãƒ¼:', e);
                showUserMessage('åˆ†æé–‹å§‹æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', 'error');
              }
            });
            
            // åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
            updateButtonState();
            console.log('âœ… Button state management initialized');
          }
        }

        performAnalysis(inputText) {
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          
          if (aiGuessBtn) {
            aiGuessBtn.disabled = true;
            aiGuessBtn.textContent = 'åˆ†æä¸­...';
          }

          // Integration-first delegation
          console.log('ProgressiveLoader.performAnalysis() trying FutureSimulatorIntegration first');
          
          setTimeout(() => {
            // 1) IntegrationãŒã‚ã‚Œã°å„ªå…ˆåˆ©ç”¨
            if (window.futureSimulator && typeof window.futureSimulator.performAnalysis === 'function') {
              console.log('âœ… Delegating to FutureSimulatorIntegration.performAnalysis()');
              try {
                window.futureSimulator.performAnalysis();
              } catch (e) {
                console.error('Integration performAnalysis failed, falling back to Core:', e);
              }
            }
            // 2) CoreãŒã‚ã‚Œã°ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§å®Ÿè¡Œ
            else if (window.FutureSimulator && window.FutureSimulator.Core) {
              console.log('âœ… Delegating to FutureSimulator.Core.startAnalysis()');
              // å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’è¨­å®šã—ã¦ã‹ã‚‰FutureSimulator.Coreã®åˆ†æã‚’å®Ÿè¡Œ
              const situationInput = document.getElementById('situation-input') || 
                                    document.querySelector('textarea[placeholder*="çŠ¶æ³"]') ||
                                    document.querySelector('textarea');
              if (situationInput) {
                situationInput.value = inputText;
              }
              window.FutureSimulator.Core.startAnalysis();
            } else {
              console.error('FutureSimulator.Core not available - fallback disabled');
            }
            
            if (aiGuessBtn) {
              aiGuessBtn.disabled = false;
              aiGuessBtn.textContent = 'åˆ†æå®Ÿè¡Œ';
            }
          }, 100);
        }

        displayResults(inputText) {
          // Legacy displayResults disabled - delegating to BinaryTreeCompleteDisplay
          console.log('OLD displayResults() called but DISABLED - delegating to BinaryTreeCompleteDisplay');
          
          // Binary Tree Complete Display SystemãŒçµæœè¡¨ç¤ºã‚’å®Œå…¨ã«å‡¦ç†
          // ã“ã®é–¢æ•°ã¯ã‚‚ã¯ã‚„çµæœã‚’è¡¨ç¤ºã›ãšã€ãƒ­ã‚°ã®ã¿å‡ºåŠ›
          console.log('âœ… Results handled by BinaryTreeCompleteDisplay with H384 database integration');
        }

        // ã‚·ãƒŠãƒªã‚ªæ¨å¥¨åº¦ã‚’è¨ˆç®—
        calculateScenarioRecommendation(scenario, index) {
          // ã‚·ãƒŠãƒªã‚ªã”ã¨ã«ç•°ãªã‚‹æ¨å¥¨åº¦ã‚’è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
          const baseScores = [72, 68, 75, 71, 76, 73, 69, 74];
          const finalScore = baseScores[index] || (65 + ((index * 7) % 15));
          
          let color = '#60A5FA'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé’
          if (finalScore >= 75) color = '#fbbf24'; // é‡‘è‰²
          else if (finalScore >= 70) color = '#10b981'; // ç·‘
          
          return {
            score: Math.round(finalScore),
            color: color
          };
        }


        // ã‚·ãƒŠãƒªã‚ªæ¨å¥¨åº¦ã®æ¦‚è¦ã‚’è¡¨ç¤º
        renderScenarioRecommendations(scenarios) {
          return `
            <div style="margin: 20px 0; padding: 15px; background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.05)); border: 1px solid rgba(99, 102, 241, 0.3); border-radius: 10px;">
              <h4 style="color: #A78BFA; margin: 0 0 10px 0;">
                ğŸ“Š ã‚·ãƒŠãƒªã‚ªæ¨å¥¨åº¦åˆ†æ
              </h4>
              <p style="color: #E5E7EB; margin: 0 0 10px 0; font-size: 0.9rem;">
                å…¥åŠ›å†…å®¹ã‹ã‚‰AIãŒæœ€é©ãªã‚·ãƒŠãƒªã‚ªã‚’åˆ†æã—ã¾ã—ãŸ
              </p>
              <p style="color: #9CA3AF; margin: 0; font-size: 0.85rem;">
                å„ã‚·ãƒŠãƒªã‚ªã«ã¯æ¨å¥¨åº¦ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚80%ä»¥ä¸Šã®ã‚·ãƒŠãƒªã‚ªã¯ç‰¹ã«ãŠã™ã™ã‚ã§ã™ã€‚
              </p>
            </div>
          `;
        }



        generateEnhancedScenarios() {
          // Fixed scenarios disabled - migrated to H384 database
          console.log('OLD generateEnhancedScenarios() called but DISABLED');
          console.log('âœ… Using H384 database integrated BinaryTreeFutureEngine instead');
          
          // BinaryTreeCompleteDisplayãŒå®Ÿéš›ã®H384ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å‹•çš„ç”Ÿæˆã™ã‚‹ãŸã‚
          // ã“ã®å›ºå®šã‚·ãƒŠãƒªã‚ªã¯ä½¿ç”¨ã—ãªã„
          return [];
        }

        generateSimpleScenarios() {
          // Fixed scenarios disabled - H384 database integration complete
          console.log('OLD generateSimpleScenarios() called but DISABLED - H384 database now provides dynamic scenarios');
          return [];
        }
        
      }
      
      // Initialize ProgressiveLoader when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        console.log('ğŸš€ Emergency fix loading...');
        const loader = new ProgressiveLoader();
      });
      
      // Also initialize immediately if DOM is already loaded
      if (document.readyState !== 'loading') {
        console.log('ğŸš€ Emergency fix loading (immediate)...');
        const loader = new ProgressiveLoader();
      }
    </script>
    
    <!-- Additional Scripts -->
    <script>
      // Legacy support functions
      function ensureChartContainers() {
        console.log('ğŸ“Š Chart containers initialized');
      }
      
      // 3ãƒ•ã‚§ãƒ¼ã‚ºé€²çˆ»ãƒ»å¤‰çˆ»ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæ­£ã—ã„2Â³=8ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼‰
      function generateJingYaoHengYaoScenarios(inputText) {
        console.log('ğŸ”® 3ãƒ•ã‚§ãƒ¼ã‚ºã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚‹8ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆé–‹å§‹:', inputText.substring(0, 30));
        
        // é«˜åº¦ãªåˆ†æçµæœã‚’ä½¿ç”¨
        const analysis = getAnalysisFromIntegrated();
        
        // åˆæœŸå¦ãƒ»çˆ»é¸å®šï¼ˆé«˜åº¦åˆ†æçµæœã‹ã‚‰ï¼‰
        const initial = selectInitialHexLine();
        const initialInfo = getHexagramInfo(initial.hex, initial.line);
        console.log(`ğŸ“Š åˆæœŸçŠ¶æ…‹: ${initialInfo.hexName}ãƒ»${initialInfo.lineName}ã€Œ${initialInfo.keywords[0] || ''}ã€`);
        
        // 3ãƒ•ã‚§ãƒ¼ã‚ºã‚·ã‚¹ãƒ†ãƒ ã§8ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆ
        const scenarios = generateThreePhaseScenarios(initial.hex, initial.line, analysis, inputText);
        
        console.log(`âœ… 8ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆå®Œäº† (JJJ, JJH, JHJ, JHH, HJJ, HJH, HHJ, HHH)`);
        return scenarios;
      }
      
      // é«˜åº¦ãªåˆ†æçµæœã‹ã‚‰å¦è±¡ã‚’å–å¾—ï¼ˆç°¡æ˜“ç‰ˆã¯å‰Šé™¤ï¼‰
      function getAnalysisFromIntegrated() {
        if (window.integratedAnalysisResult && window.integratedAnalysisResult.context) {
          return window.integratedAnalysisResult.context;
        }
        // çµ±åˆåˆ†æçµæœãŒãªã„å ´åˆã¯ç©ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
        return {};
      }
      
      // é«˜åº¦ãªåˆ†æçµæœã‹ã‚‰åˆæœŸå¦ãƒ»çˆ»ã‚’å–å¾—
      function selectInitialHexLine() {
        // çµ±åˆåˆ†æçµæœã‚’å„ªå…ˆä½¿ç”¨
        if (window.integratedAnalysisResult && window.integratedAnalysisResult.iching) {
          const { hexagram, yao } = window.integratedAnalysisResult.iching;
          if (hexagram && yao) {
            console.log('âœ… é«˜åº¦åˆ†æçµæœã‚’ä½¿ç”¨:', hexagram.name, yao.name);
            return {
              hex: hexagram.number || 1,
              line: yao.position || 1
            };
          }
        }
        
        // åˆ†æçµæœãŒãªã„å ´åˆã®ã¿ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
        console.log('âš ï¸ é«˜åº¦åˆ†æçµæœãªã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ä½¿ç”¨');
        return { hex: 1, line: 1 };
      }
      
      // æ˜“çµŒã®çŸ¥æµã‹ã‚‰çŠ¶æ³ã®ç¶™ç¶šæ€§ã‚’èª¬æ˜ã™ã‚‹é–¢æ•°
      function getThematicConnection(prevKeyword, nextKeyword) {
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®æ„å‘³ã‚«ãƒ†ã‚´ãƒªã‚’åˆ†æ
        const analyzeKeywordCategory = (keyword) => {
          // æº–å‚™ãƒ»é–‹å§‹ç³»
          if (['æº–å‚™', 'åŸºç¤å›ºã‚', 'å­¦ç¿’', 'ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«', 'å§‹ã¾ã‚Š', 'å¾…æ©Ÿ'].includes(keyword)) {
            return 'preparation';
          }
          // å”åŠ›ãƒ»é–¢ä¿‚ç³»
          if (['å”åŠ›', 'å”åŠ›è€…', 'å‡ºä¼šã„', 'ä¿¡é ¼', 'å…¬ã®å ´', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', 'ä¿¡é ¼é–¢ä¿‚'].includes(keyword)) {
            return 'cooperation';
          }
          // æˆé•·ãƒ»ç™ºå±•ç³»
          if (['ãƒãƒ£ãƒ³ã‚¹åˆ°æ¥', 'æˆé•·', 'ç™ºå±•', 'ãƒãƒ£ãƒ³ã‚¹', 'æˆæœ'].includes(keyword)) {
            return 'growth';
          }
          // ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ç³»
          if (['ãƒªãƒ¼ãƒ€ãƒ¼', 'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—', 'å…¬æ˜æ­£å¤§', 'ä¸­æ ¸'].includes(keyword)) {
            return 'leadership';
          }
          // å›°é›£ãƒ»è©¦ç·´ç³»
          if (['å›°é›£', 'ãƒªã‚¹ã‚¯ã‚ã‚Š', 'å±æ©Ÿ', 'åœæ»', 'å±é™º'].includes(keyword)) {
            return 'difficulty';
          }
          // å®‰å®šãƒ»æˆç†Ÿç³»
          if (['å®‰å®š', 'å‰', 'å•é¡Œãªã—', 'å®‰å…¨ç¬¬ä¸€', 'ä¼‘æ¯'].includes(keyword)) {
            return 'stability';
          }
          // å†…çœãƒ»æ…é‡ç³»
          if (['å†…çœ', 'æ…é‡', 'å¿è€', 'å¾…æ©Ÿ', 'å£ã‚’é–‰ã–ã™'].includes(keyword)) {
            return 'reflection';
          }
          // å¤‰é©ãƒ»è»¢æ›ç³»
          if (['æ”¹é©', 'é©æ–°', 'è»¢æ›ç‚¹', 'æ–¹é‡è»¢æ›'].includes(keyword)) {
            return 'transformation';
          }
          return 'other';
        };
        
        const prevCategory = analyzeKeywordCategory(prevKeyword);
        const nextCategory = analyzeKeywordCategory(nextKeyword);
        
        // ã‚«ãƒ†ã‚´ãƒªã®çµ„ã¿åˆã‚ã›ã§é–¢ä¿‚æ€§ã‚’å‹•çš„ç”Ÿæˆ
        if (prevCategory === 'preparation' && nextCategory === 'cooperation') {
          return `æº–å‚™æ®µéšã‹ã‚‰å”åŠ›é–¢ä¿‚ã®æ§‹ç¯‰ã¸ã¨è‡ªç„¶ã«ç™ºå±•`;
        }
        if (prevCategory === 'preparation' && nextCategory === 'growth') {
          return `æº–å‚™ãŒæ•´ã„ã€æˆé•·ã®æ©Ÿä¼šãŒè¨ªã‚Œã‚‹`;
        }
        if (prevCategory === 'cooperation' && nextCategory === 'stability') {
          return `å”åŠ›é–¢ä¿‚ãŒå®‰å®šã—ã€ä¿¡é ¼ãŒæ·±ã¾ã‚‹`;
        }
        if (prevCategory === 'cooperation' && nextCategory === 'leadership') {
          return `å”åŠ›ã‹ã‚‰ä¸»å°çš„ç«‹å ´ã¸ã®æˆé•·`;
        }
        if (prevCategory === 'growth' && nextCategory === 'leadership') {
          return `æˆé•·ã‚’çµŒã¦ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®`;
        }
        if (prevCategory === 'difficulty' && nextCategory === 'reflection') {
          return `å›°é›£ã«ç›´é¢ã—ã€å†…çœã¨æ…é‡ãªå¯¾å¿œã¸`;
        }
        if (prevCategory === 'reflection' && nextCategory === 'growth') {
          return `å†…çœæœŸé–“ã‚’çµŒã¦æˆé•·ã®æ©Ÿä¼šã‚’æ´ã‚€`;
        }
        if (prevCategory === 'stability' && nextCategory === 'growth') {
          return `å®‰å®šã‚’åŸºç›¤ã«æ›´ãªã‚‹æˆé•·ã¸`;
        }
        
        // åŒã˜ã‚«ãƒ†ã‚´ãƒªå†…ã§ã®æ·±åŒ–
        if (prevCategory === nextCategory) {
          return `ã€Œ${prevKeyword}ã€ã‹ã‚‰ã€Œ${nextKeyword}ã€ã¸ã€åŒã˜ãƒ†ãƒ¼ãƒå†…ã§ã®æ·±åŒ–ã¨æˆç†Ÿ`;
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ç›´æ¥æ¯”è¼ƒ
        return `ã€Œ${prevKeyword}ã€ã®æ®µéšã‹ã‚‰ã€Œ${nextKeyword}ã€ã¸ã¨æ®µéšçš„ã«ç™ºå±•`;
      }
      
      // æ˜“çµŒã®çŸ¥æµã‹ã‚‰çŠ¶æ³ã®è»¢æ›ç‚¹ã‚’èª¬æ˜ã™ã‚‹é–¢æ•°
      function getThematicShift(prevKeyword, nextKeyword) {
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®å¯¾ç«‹æ¦‚å¿µã‚’åˆ†æ
        const getOppositeTheme = (keyword) => {
          const opposites = {
            'æº–å‚™': 'å³è¡Œå‹•',
            'å”åŠ›': 'ç‹¬ç«‹',
            'å®‰å®š': 'å¤‰é©',
            'ä¿¡é ¼': 'é©æ–°',
            'ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«': 'ç¾å®Ÿ',
            'å­¦ç¿’': 'å®Ÿè·µ',
            'å†…çœ': 'å¤–å‘',
            'å¿è€': 'ç©æ¥µ',
            'å®ˆã‚Š': 'æ”»æ’ƒ',
            'å—å‹•': 'èƒ½å‹•'
          };
          return opposites[keyword] || null;
        };
        
        // æ„å‘³çš„ãªè·é›¢ã‚’è¨ˆç®—
        const calculateSemanticDistance = (prev, next) => {
          const prevCat = analyzeKeywordCategory(prev);
          const nextCat = analyzeKeywordCategory(next);
          
          // æ­£åå¯¾ã®ã‚«ãƒ†ã‚´ãƒª
          const oppositeCategories = {
            'preparation': 'transformation',
            'cooperation': 'difficulty',
            'stability': 'transformation',
            'reflection': 'leadership'
          };
          
          if (oppositeCategories[prevCat] === nextCat) {
            return 'opposite';
          }
          if (prevCat !== nextCat) {
            return 'different';
          }
          return 'similar';
        };
        
        const distance = calculateSemanticDistance(prevKeyword, nextKeyword);
        
        // è·é›¢ã«åŸºã¥ã„ãŸè»¢æ›ã®èª¬æ˜ã‚’ç”Ÿæˆ
        if (distance === 'opposite') {
          return `ã€Œ${prevKeyword}ã€ã‹ã‚‰æ­£åå¯¾ã®ã€Œ${nextKeyword}ã€ã¸ã€æ ¹æœ¬çš„ãªæ–¹å‘è»¢æ›`;
        }
        if (distance === 'different') {
          // ã‚«ãƒ†ã‚´ãƒªåˆ†æã‚’ä½¿ç”¨
          const prevCat = analyzeKeywordCategory(prevKeyword);
          const nextCat = analyzeKeywordCategory(nextKeyword);
          
          if (prevCat === 'preparation' && nextCat === 'transformation') {
            return `æº–å‚™æ®µéšã‚’é›¢ã‚Œã€æŠœæœ¬çš„ãªå¤‰é©ã¸ã¨èˆµã‚’åˆ‡ã‚‹`;
          }
          if (prevCat === 'cooperation' && nextCat === 'difficulty') {
            return `å”åŠ›é–¢ä¿‚ã‹ã‚‰å›°é›£ãªçŠ¶æ³ã¸ã®è»¢æ›`;
          }
          if (prevCat === 'stability' && nextCat === 'transformation') {
            return `å®‰å®šã‹ã‚‰è„±å´ã—ã€æ–°ãŸãªå¤‰é©ã¸æŒ‘æˆ¦`;
          }
          if (prevCat === 'reflection' && nextCat === 'leadership') {
            return `å†…çœçš„ãªçŠ¶æ…‹ã‹ã‚‰ç©æ¥µçš„ãªãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã¸ã®è»¢æ›`;
          }
          
          return `ã€Œ${prevKeyword}ã€ã®ãƒ†ãƒ¼ãƒã‹ã‚‰é›¢ã‚Œã€ã€Œ${nextKeyword}ã€ã¨ã„ã†æ–°ã—ã„æ–¹å‘æ€§ã¸`;
        }
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        return `ã€Œ${prevKeyword}ã€ã‹ã‚‰ã€Œ${nextKeyword}ã€ã¸ã€è³ªçš„ã«ç•°ãªã‚‹å±•é–‹`;
      }
      
      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚«ãƒ†ã‚´ãƒªåˆ†æã®ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°
      function analyzeKeywordCategory(keyword) {
        // æº–å‚™ãƒ»é–‹å§‹ç³»
        if (['æº–å‚™', 'åŸºç¤å›ºã‚', 'å­¦ç¿’', 'ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«', 'å§‹ã¾ã‚Š', 'å¾…æ©Ÿ', 'äºˆå…†', 'åˆéœœ'].includes(keyword)) {
          return 'preparation';
        }
        // å”åŠ›ãƒ»é–¢ä¿‚ç³»
        if (['å”åŠ›', 'å”åŠ›è€…', 'å‡ºä¼šã„', 'ä¿¡é ¼', 'å…¬ã®å ´', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼', 'ä¿¡é ¼é–¢ä¿‚', 'åŒ…å®¹åŠ›'].includes(keyword)) {
          return 'cooperation';
        }
        // æˆé•·ãƒ»ç™ºå±•ç³»
        if (['ãƒãƒ£ãƒ³ã‚¹åˆ°æ¥', 'æˆé•·', 'ç™ºå±•', 'ãƒãƒ£ãƒ³ã‚¹', 'æˆæœ', 'å‰'].includes(keyword)) {
          return 'growth';
        }
        // ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ç³»
        if (['ãƒªãƒ¼ãƒ€ãƒ¼', 'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—', 'å…¬æ˜æ­£å¤§', 'ä¸­æ ¸', 'å‹åˆ©'].includes(keyword)) {
          return 'leadership';
        }
        // å›°é›£ãƒ»è©¦ç·´ç³»
        if (['å›°é›£', 'ãƒªã‚¹ã‚¯ã‚ã‚Š', 'å±æ©Ÿ', 'åœæ»', 'å±é™º', 'å‡¶', 'çµ¶æœ›'].includes(keyword)) {
          return 'difficulty';
        }
        // å®‰å®šãƒ»æˆç†Ÿç³»
        if (['å®‰å®š', 'å•é¡Œãªã—', 'å®‰å…¨ç¬¬ä¸€', 'ä¼‘æ¯', 'å …å®Ÿ', 'æŒç¶š'].includes(keyword)) {
          return 'stability';
        }
        // å†…çœãƒ»æ…é‡ç³»
        if (['å†…çœ', 'æ…é‡', 'å¿è€', 'å¾…æ©Ÿ', 'å£ã‚’é–‰ã–ã™', 'å†…é¢ã®ç¾å¾³'].includes(keyword)) {
          return 'reflection';
        }
        // å¤‰é©ãƒ»è»¢æ›ç³»
        if (['æ”¹é©', 'é©æ–°', 'è»¢æ›ç‚¹', 'æ–¹é‡è»¢æ›', 'æ’¤é€€', 'å†ç·¨'].includes(keyword)) {
          return 'transformation';
        }
        return 'other';
      }
      
      // H384ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰å¦åã¨çˆ»åã‚’å–å¾—ã™ã‚‹é–¢æ•°
      function getHexagramInfo(hexNum, lineNum) {
        // 64å¦ã®æ­£å¼åç§°
        const hexagramNames = {
          1: 'ä¹¾ç‚ºå¤©', 2: 'å¤ç‚ºåœ°', 3: 'æ°´é›·å±¯', 4: 'å±±æ°´è’™',
          5: 'æ°´å¤©éœ€', 6: 'å¤©æ°´è¨Ÿ', 7: 'åœ°æ°´å¸«', 8: 'æ°´åœ°æ¯”',
          9: 'é¢¨å¤©å°ç•œ', 10: 'å¤©æ²¢å±¥', 11: 'åœ°å¤©æ³°', 12: 'å¤©åœ°å¦',
          13: 'å¤©ç«åŒäºº', 14: 'ç«å¤©å¤§æœ‰', 15: 'åœ°å±±è¬™', 16: 'é›·åœ°è±«',
          17: 'æ²¢é›·éš', 18: 'å±±é¢¨è ±', 19: 'åœ°æ²¢è‡¨', 20: 'é¢¨åœ°è¦³',
          21: 'ç«é›·å™¬å—‘', 22: 'å±±ç«è³', 23: 'å±±åœ°å‰¥', 24: 'åœ°é›·å¾©',
          25: 'å¤©é›·ç„¡å¦„', 26: 'å±±å¤©å¤§ç•œ', 27: 'å±±é›·é ¤', 28: 'æ²¢é¢¨å¤§é',
          29: 'åç‚ºæ°´', 30: 'é›¢ç‚ºç«', 31: 'æ²¢å±±å’¸', 32: 'é›·é¢¨æ’',
          33: 'å¤©å±±é¯', 34: 'é›·å¤©å¤§å£®', 35: 'ç«åœ°æ™‹', 36: 'åœ°ç«æ˜å¤·',
          37: 'é¢¨ç«å®¶äºº', 38: 'ç«æ²¢ç½', 39: 'æ°´å±±è¹‡', 40: 'é›·æ°´è§£',
          41: 'å±±æ²¢æ', 42: 'é¢¨é›·ç›Š', 43: 'æ²¢å¤©å¤¬', 44: 'å¤©é¢¨å§¤',
          45: 'æ²¢åœ°èƒ', 46: 'åœ°é¢¨å‡', 47: 'æ²¢æ°´å›°', 48: 'æ°´é¢¨äº•',
          49: 'æ²¢ç«é©', 50: 'ç«é¢¨é¼', 51: 'éœ‡ç‚ºé›·', 52: 'è‰®ç‚ºå±±',
          53: 'é¢¨å±±æ¼¸', 54: 'é›·æ²¢å¸°å¦¹', 55: 'é›·ç«è±Š', 56: 'ç«å±±æ—…',
          57: 'å·½ç‚ºé¢¨', 58: 'å…Œç‚ºæ²¢', 59: 'é¢¨æ°´æ¸™', 60: 'æ°´æ²¢ç¯€',
          61: 'é¢¨æ²¢ä¸­å­š', 62: 'é›·å±±å°é', 63: 'æ°´ç«æ—¢æ¸ˆ', 64: 'ç«æ°´æœªæ¸ˆ'
        };
        
        // çˆ»ä½ã®åç§°ï¼ˆé™°é™½ã¨ä½ç½®ã«ã‚ˆã‚‹ï¼‰
        const lineNames = ['åˆ', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'ä¸Š'];
        
        // H384ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰è©³ç´°æƒ…å ±ã‚’å–å¾—
        if (typeof H384_DATA !== 'undefined') {
          const index = (hexNum - 1) * 6 + lineNum - 1;
          const entry = H384_DATA[index];
          if (entry) {
            return {
              hexName: entry['å¦å'] || hexagramNames[hexNum],
              lineName: entry['çˆ»'] || `${lineNames[lineNum - 1]}çˆ»`,
              keywords: entry['ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'] || [],
              interpretation: entry['ç¾ä»£è§£é‡ˆã®è¦ç´„'] || ''
            };
          }
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        return {
          hexName: hexagramNames[hexNum] || `å¦${hexNum}`,
          lineName: `${lineNames[lineNum - 1]}çˆ»`,
          keywords: [],
          interpretation: ''
        };
      }
      
      // 3ãƒ•ã‚§ãƒ¼ã‚ºã§8ãƒ‘ã‚¿ãƒ¼ãƒ³ç”Ÿæˆï¼ˆ2Â³=8é€šã‚Šï¼‰
      function generateThreePhaseScenarios(initialHex, initialLine, analysis, inputText) {
        const patterns = ['JJJ', 'JJH', 'JHJ', 'JHH', 'HJJ', 'HJH', 'HHJ', 'HHH'];
        const scenarios = [];
        
        patterns.forEach((pattern, index) => {
          const path = simulateThreePhaseJourney(initialHex, initialLine, pattern);
          const scenario = createScenarioFromPath(path, pattern, analysis, inputText, index + 1);
          scenarios.push(scenario);
        });
        
        return scenarios;
      }
      
      // 3ãƒ•ã‚§ãƒ¼ã‚ºã®æ—…ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
      function simulateThreePhaseJourney(initialHex, initialLine, pattern) {
        const states = [{ hex: initialHex, line: initialLine, phase: 0 }];
        let currentHex = initialHex;
        let currentLine = initialLine;
        
        for (let i = 0; i < pattern.length; i++) {
          const choice = pattern[i];
          
          if (choice === 'J') {
            // é€²çˆ»ï¼šçˆ»ä½+1ï¼ˆåŒã˜å¦ï¼‰
            currentLine = currentLine < 6 ? currentLine + 1 : 1;
          } else {
            // å¤‰çˆ»ï¼šå¦å¤‰åŒ–ï¼ˆçˆ»ä½ä¿æŒï¼‰
            currentHex = calculateTransformedHex(currentHex, currentLine);
          }
          
          states.push({
            hex: currentHex,
            line: currentLine,
            phase: i + 1,
            choice: choice === 'J' ? 'é€²çˆ»' : 'å¤‰çˆ»'
          });
        }
        
        return states;
      }
      
      // å¤‰çˆ»ã«ã‚ˆã‚‹å¦å¤‰æ›è¨ˆç®—
      function calculateTransformedHex(hexNum, lineNum) {
        // æ˜“çµŒã®ä½“ç³»çš„çŸ¥è­˜ãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆ
        if (typeof window !== 'undefined' && window.kingWenMapping) {
          return window.kingWenMapping.calculateTransformedHex(hexNum, lineNum) || ((hexNum % 64) + 1);
        }
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç°¡æ˜“è¨ˆç®—
        return ((hexNum - 1 + lineNum * 7) % 64) + 1;
      }
      
      // ãƒ‘ã‚¹ã‹ã‚‰ã‚·ãƒŠãƒªã‚ªã‚’ä½œæˆ
      function createScenarioFromPath(path, pattern, analysis, inputText, orderNum) {
        const finalState = path[path.length - 1];
        const interpretation = interpretPattern(pattern, analysis);
        
        // æ˜“çµŒã®çŸ¥æµã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å–å¾—ï¼ˆå¯èƒ½ãªå ´åˆï¼‰
        let keyword = 'å¤‰åŒ–';
        let theme = 'æœªæ¥ã¸ã®é“';
        
        if (typeof H384_DATA !== 'undefined') {
          const index = (finalState.hex - 1) * 6 + finalState.line - 1;
          const h384Entry = H384_DATA[index];
          if (h384Entry) {
            keyword = h384Entry['ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'][0] || keyword;
            theme = h384Entry['ç¾ä»£è§£é‡ˆã®è¦ç´„'] || theme;
          }
        }
        
        return {
          type: 'three-phase',
          pattern: pattern,
          patternName: getPatternName(pattern),
          title: `ã€ãƒ‘ã‚¿ãƒ¼ãƒ³${orderNum}ã€‘${interpretation.title}`,
          description: generateThreePhaseDescription(path, pattern, analysis, inputText),
          keyword: keyword,
          theme: theme,
          finalHex: finalState.hex,
          finalLine: finalState.line,
          path: path,
          risk: interpretation.risk,
          confidence: 70 + (orderNum * 2),
          timeframe: interpretation.timeframe
        };
      }
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³ã®è§£é‡ˆï¼ˆã‚ˆã‚Šè‡ªç„¶ãªæ—¥æœ¬èªè¡¨ç¾ï¼‰
      function interpretPattern(pattern, analysis) {
        const interpretations = {
          'JJJ': { 
            title: 'ç¾åœ¨ã®é“ã‚’ç€å®Ÿã«æ·±ã‚ã¦ã„ã',
            risk: 'ä½',
            timeframe: 'ã˜ã£ãã‚Šã¨æ™‚é–“ã‚’ã‹ã‘ã¦'
          },
          'JJH': { 
            title: 'åŸºç›¤ã‚’å›ºã‚ã¦ã‹ã‚‰æ–°å¢ƒåœ°ã¸',
            risk: 'ä½ï½ä¸­',
            timeframe: 'æ®µéšçš„ãªå±•é–‹'
          },
          'JHJ': { 
            title: 'æ–°ã—ã„è¦–ç‚¹ã‚’å¾—ã¦ã€ãã“ã‹ã‚‰æ·±ã‚ã‚‹',
            risk: 'ä¸­',
            timeframe: 'ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸå¤‰åŒ–'
          },
          'JHH': { 
            title: 'æ—©ã‚ã®æ–¹å‘è»¢æ›ã§å¯èƒ½æ€§ã‚’åºƒã’ã‚‹',
            risk: 'ä¸­ï½é«˜',
            timeframe: 'ç©æ¥µçš„ãªå¤‰é©'
          },
          'HJJ': { 
            title: 'æ€ã„åˆ‡ã£ãŸè»¢æ›å¾Œã€ã˜ã£ãã‚Šè‚²ã¦ã‚‹',
            risk: 'ä¸­',
            timeframe: 'è»¢æ©Ÿå¾Œã®å®‰å®šæˆé•·'
          },
          'HJH': { 
            title: 'æŸ”è»Ÿã«å¤‰åŒ–ã¨æ·±åŒ–ã‚’ç¹”ã‚Šäº¤ãœã‚‹',
            risk: 'é«˜',
            timeframe: 'ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ãªå±•é–‹'
          },
          'HHJ': { 
            title: 'å¤§èƒ†ãªå¤‰é©ã‚’çµŒã¦ã€æ–°ãŸãªå®šç€ã¸',
            risk: 'é«˜',
            timeframe: 'åŠ‡çš„å¤‰åŒ–ã‹ã‚‰ã®åæŸ'
          },
          'HHH': { 
            title: 'æ—¢æˆæ¦‚å¿µã‚’æ‰“ã¡ç ´ã‚Šç¶šã‘ã‚‹é©æ–°ã®é“',
            risk: 'æœ€é«˜',
            timeframe: 'é€£ç¶šçš„ãªé©æ–°'
          }
        };
        
        return interpretations[pattern] || { title: pattern, risk: 'ä¸­', timeframe: 'å¤‰åŒ–ã®éç¨‹' };
      }
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³åã®å–å¾—ï¼ˆã‚ã‹ã‚Šã‚„ã™ã„æ—¥æœ¬èªï¼‰
      function getPatternName(pattern) {
        const names = {
          'JJJ': 'ç€å®Ÿæˆé•·',
          'JJH': 'æˆç†Ÿè»¢æ©Ÿ',
          'JHJ': 'æ–°å¤©åœ°é–‹æ‹“',
          'JHH': 'æ—©æœŸè»¢æ›',
          'HJJ': 'æ–¹å‘è»¢æ›å¾Œã®å®‰å®š',
          'HJH': 'å¤‰åŒ–ã¨æˆé•·ã®ä¸¡ç«‹',
          'HHJ': 'æ¿€å¤‰ã‹ã‚‰ã®ç€åœ°',
          'HHH': 'å®Œå…¨é©æ–°'
        };
        return names[pattern] || pattern;
      }
      
      // 3ãƒ•ã‚§ãƒ¼ã‚ºèª¬æ˜ç”Ÿæˆï¼ˆè‡ªç„¶ãªæ—¥æœ¬èªè¡¨ç¾ï¼‰
      function generateThreePhaseDescription(path, pattern, analysis, inputText) {
        let descriptions = [];
        
        // å„ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã‚’è‡ªç„¶ãªæ–‡ç« ã§ä½œæˆ
        for (let i = 1; i < path.length; i++) {
          const state = path[i];
          const prevState = path[i-1];
          let phaseDesc = '';
          
          // å‰å¾Œã®å¦æƒ…å ±ã¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
          const prevInfo = getHexagramInfo(prevState.hex, prevState.line);
          const nextInfo = getHexagramInfo(state.hex, state.line);
          const prevKeyword = prevInfo.keywords[0] || '';
          const nextKeyword = nextInfo.keywords[0] || '';
          
          // ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®è‡ªç„¶ãªèª¬æ˜æ–‡
          if (i === 1) {
            phaseDesc = 'ç¬¬1æ®µéšã§ã¯ã€';
          } else if (i === 2) {
            phaseDesc = 'æ¬¡ã®æ®µéšã«ãŠã„ã¦ã€';
          } else {
            phaseDesc = 'æœ€çµ‚æ®µéšã¨ã—ã¦ã€';
          }
          
          if (state.choice === 'é€²çˆ»') {
            // é€²çˆ»ã®å ´åˆï¼šãƒ‡ãƒ¼ã‚¿é§†å‹•å‹ã®èª¬æ˜ç”Ÿæˆ
            if (window.dataAnalyzer && prevState.hex && prevState.line && state.hex && state.line) {
              // DataDrivenAnalyzerã‚’ä½¿ç”¨
              const connection = window.dataAnalyzer.generateJinConnection(
                prevState.hex, prevInfo.lineName, state.hex, nextInfo.lineName
              );
              phaseDesc += connection;
            } else if (prevKeyword && nextKeyword) {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ—§å®Ÿè£…
              phaseDesc += `ã€ãƒ†ãƒ¼ãƒç¶™ç¶šã€‘ç¾åœ¨ã®ã€Œ${prevKeyword}ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã‚’ç¶­æŒã—ã€${prevInfo.hexName}ã®å¦ã®æµã‚Œã«æ²¿ã£ã¦ã€`;
              phaseDesc += `ã‚ˆã‚Šæˆç†Ÿã—ãŸã€Œ${nextKeyword}ã€ï¼ˆ${nextInfo.lineName}ï¼‰ã¸ã¨è‡ªç„¶ã«ç™ºå±•ã—ã¦ã„ãã¾ã™ã€‚`;
              phaseDesc += `ã“ã‚Œã¯${getThematicConnection(prevKeyword, nextKeyword)}ã¨ã„ã†é–¢ä¿‚ã§ã™ã€‚`;
            } else {
              phaseDesc += `${prevInfo.hexName}ã®å¦ã®ãƒ†ãƒ¼ãƒã«æ²¿ã£ã¦ã€${prevInfo.lineName}ã‹ã‚‰${nextInfo.lineName}ã¸ã¨æ®µéšçš„ã«æ·±ã¾ã£ã¦ã„ãã¾ã™ã€‚`;
            }
          } else {
            // å¤‰çˆ»ã®å ´åˆï¼šãƒ‡ãƒ¼ã‚¿é§†å‹•å‹ã®èª¬æ˜ç”Ÿæˆ
            if (window.dataAnalyzer && prevState.hex && prevState.line && state.hex && state.line) {
              // DataDrivenAnalyzerã‚’ä½¿ç”¨
              const shift = window.dataAnalyzer.generateHengShift(
                prevState.hex, prevInfo.lineName, state.hex, nextInfo.lineName
              );
              phaseDesc += shift;
            } else if (prevKeyword && nextKeyword) {
              // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šæ—§å®Ÿè£…
              phaseDesc += `ã€ãƒ†ãƒ¼ãƒè»¢æ›ã€‘ã€Œ${prevKeyword}ã€ã¨ã„ã†ãƒ†ãƒ¼ãƒã‹ã‚‰é›¢ã‚Œã€`;
              phaseDesc += `${prevInfo.hexName}ã‹ã‚‰${nextInfo.hexName}ã¸ã¨å¦ãŒå¤‰åŒ–ã™ã‚‹ã“ã¨ã§ã€`;
              phaseDesc += `ã€Œ${nextKeyword}ã€ã¨ã„ã†å…¨ãç•°ãªã‚‹ãƒ†ãƒ¼ãƒã¸ã®è»¢æ›ãŒèµ·ã“ã‚Šã¾ã™ã€‚`;
              phaseDesc += `ã“ã‚Œã¯${getThematicShift(prevKeyword, nextKeyword)}ã¨ã„ã†è³ªçš„ãªå¤‰åŒ–ã§ã™ã€‚`;
            } else {
              phaseDesc += `${prevInfo.hexName}ã®ãƒ†ãƒ¼ãƒã‹ã‚‰é›¢ã‚Œã€${nextInfo.hexName}ã¨ã„ã†æ–°ã—ã„å¦ã®ãƒ†ãƒ¼ãƒã¸ã¨è»¢æ›ã—ã¾ã™ã€‚`;
            }
          }
          
          descriptions.push(phaseDesc);
        }
        
        // å…¨ä½“ã®æµã‚Œã‚’ã¾ã¨ã‚ã‚‹
        let summary = descriptions.join('');
        
        // ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¿œã˜ãŸç· ã‚ã®è¨€è‘‰
        if (pattern === 'JJJ') {
          summary += 'ã“ã®ãƒ‘ã‚¹ã¯ä¸€è²«æ€§ã‚’ä¿ã¡ãªãŒã‚‰ç€å®Ÿã«æ·±åŒ–ã—ã¦ã„ãé“ç­‹ã§ã™ã€‚';
        } else if (pattern === 'HHH') {
          summary += 'ã“ã®ãƒ‘ã‚¹ã¯å¸¸ã«æ–°ã—ã„å¤‰åŒ–ã‚’æ±‚ã‚ã€é©æ–°çš„ãªå±•é–‹ã‚’ç¶šã‘ã‚‹é“ç­‹ã§ã™ã€‚';
        } else if (pattern.includes('J') && pattern.includes('H')) {
          summary += 'ã“ã®ãƒ‘ã‚¹ã¯æ·±åŒ–ã¨è»¢æ›ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚ŠãªãŒã‚‰é€²ã‚€é“ç­‹ã§ã™ã€‚';
        }
        
        // å…¥åŠ›ã«å¿œã˜ãŸè£œè¶³ï¼ˆã‚ˆã‚Šè‡ªç„¶ãªè¡¨ç¾ï¼‰
        if (analysis.hasWork) {
          summary += 'ãŠä»•äº‹ã‚„ã‚­ãƒ£ãƒªã‚¢ã®é¢ã§ã¯ã€ã“ã®æµã‚Œã«æ²¿ã£ã¦æ–°ãŸãªæˆé•·ã®æ©Ÿä¼šãŒè¨ªã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚';
        }
        if (analysis.hasRelation) {
          summary += 'äººé–“é–¢ä¿‚ã«ãŠã„ã¦ã¯ã€ç›¸æ‰‹ã¨ã®è·é›¢æ„Ÿã‚’èª¿æ•´ã—ãªãŒã‚‰ã€ã‚ˆã‚Šè‰¯ã„é–¢ä¿‚æ€§ã‚’ç¯‰ã„ã¦ã„ã‘ã‚‹ã§ã—ã‚‡ã†ã€‚';
        }
        if (analysis.hasDecision) {
          summary += 'é¸æŠè‚¢ã®åˆ†æã«é–¢ã—ã¦ã¯ã€384ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã8ã¤ã®æœªæ¥è»Œé“ãŒç®—å‡ºã•ã‚Œã¾ã™ã€‚';
        }
        
        return summary;
      }

      // 8ã‚·ãƒŠãƒªã‚ªç”Ÿæˆé–¢æ•°ï¼ˆé«˜åº¦åˆ†æç‰ˆï¼‰
      // æ—§8ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã¯å‰Šé™¤ï¼ˆæ–°UI/EightScenariosDisplay ã‚’ä½¿ç”¨ï¼‰
      async function generateAndDisplay8Scenarios(worryText) {
        const fallbackScenarios = [
          { 
            trigram: "ä¹¾(å¤©)", 
            title: "ç©æ¥µçš„ã«è¡Œå‹•ã‚’èµ·ã“ã™", 
            description: "ãƒªã‚¹ã‚¯ã‚’æã‚Œãšã€å¤§èƒ†ãªä¸€æ­©ã‚’è¸ã¿å‡ºã™ã€‚æ–°ã—ã„æŒ‘æˆ¦ãŒæˆé•·ã‚’ã‚‚ãŸã‚‰ã™ã€‚",
            risk: "é«˜", 
            color: "#4A90E2" 
          },
          { 
            trigram: "å¤(åœ°)", 
            title: "æ…é‡ã«æº–å‚™ã‚’æ•´ãˆã‚‹", 
            description: "ç€å®Ÿã«åŸºç›¤ã‚’å›ºã‚ã€ç¢ºå®Ÿãªæˆæœã‚’ç›®æŒ‡ã™ã€‚å¿è€ãŒæˆåŠŸã¸ã®éµã€‚",
            risk: "ä½", 
            color: "#8B7355" 
          },
          { 
            trigram: "éœ‡(é›·)", 
            title: "æ–°ã—ã„è¦–ç‚¹ã‚’å–ã‚Šå…¥ã‚Œã‚‹", 
            description: "æ—¢å­˜ã®æ çµ„ã¿ã‚’æ‰“ç ´ã—ã€é©æ–°çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’è©¦ã¿ã‚‹ã€‚",
            risk: "ä¸­", 
            color: "#9B59B6" 
          },
          { 
            trigram: "å·½(é¢¨)", 
            title: "æ®µéšçš„ã«é€²æ­©ã™ã‚‹", 
            description: "å°ã•ãªå¤‰åŒ–ã‚’ç©ã¿é‡ã­ã€ç€å®Ÿã«ç›®æ¨™ã¸è¿‘ã¥ãã€‚æŸ”è»Ÿæ€§ãŒé‡è¦ã€‚",
            risk: "ä½", 
            color: "#1ABC9C" 
          },
          { 
            trigram: "å(æ°´)", 
            title: "å”åŠ›ãƒ»é€£æºã‚’æ±‚ã‚ã‚‹", 
            description: "ä»–è€…ã¨ã®å”åƒã«ã‚ˆã‚‹çŠ¶æ³å¤‰åŒ–ã€‚äººçš„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã®å½±éŸ¿ãŒå¤§ãã„ã€‚",
            risk: "ä¸­", 
            color: "#3498DB" 
          },
          { 
            trigram: "é›¢(ç«)", 
            title: "å†…é¢ã‚’å……å®Ÿã•ã›ã‚‹", 
            description: "è‡ªå·±ç†è§£ã‚’æ·±ã‚ã€å†…ãªã‚‹åŠ›ã‚’è‚²ã‚€ã€‚ç²¾ç¥çš„æˆé•·ãŒé“ã‚’é–‹ãã€‚",
            risk: "ä½", 
            color: "#E74C3C" 
          },
          { 
            trigram: "è‰®(å±±)", 
            title: "ç¾çŠ¶ã‚’è¦‹ç›´ã™", 
            description: "ç«‹ã¡æ­¢ã¾ã£ã¦çŠ¶æ³ã‚’åˆ†æã—ã€æœ€é©ãªæ™‚æœŸã‚’å¾…ã¤ã€‚é™è¦³ã‚‚æˆ¦ç•¥ã€‚",
            risk: "ä½", 
            color: "#95A5A6" 
          },
          { 
            trigram: "å…Œ(æ²¢)", 
            title: "æŸ”è»Ÿã«å¯¾å¿œã™ã‚‹", 
            description: "çŠ¶æ³ã«å¿œã˜ã¦æ–¹å‘è»¢æ›ã—ã€æœ€é©ãªé“ã‚’è¦‹ã¤ã‘ã‚‹ã€‚é©å¿œåŠ›ãŒéµã€‚",
            risk: "ä¸­", 
            color: "#F39C12" 
          }
        ];
        
        // ã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºç”¨ã®HTMLç”Ÿæˆ
        const scenariosHTML = `
          <div class="scenarios-container" style="margin: 20px 0; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
            <h3 style="color: #A78BFA; margin-bottom: 20px; font-size: 1.5rem;">
              ğŸ”® 8ã¤ã®æœªæ¥ã‚·ãƒŠãƒªã‚ª
            </h3>
            <div class="scenarios-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
              ${scenarios.map((scenario, index) => `
                <div class="scenario-card" style="
                  background: linear-gradient(135deg, ${scenario.color}22, ${scenario.color}11);
                  border: 1px solid ${scenario.color}55;
                  border-radius: 8px;
                  padding: 15px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                " onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span style="color: ${scenario.color}; font-weight: bold;">${scenario.trigram}</span>
                    <span style="
                      background: ${scenario.risk === 'é«˜' ? '#EF4444' : scenario.risk === 'ä¸­' ? '#F59E0B' : '#10B981'}22;
                      color: ${scenario.risk === 'é«˜' ? '#EF4444' : scenario.risk === 'ä¸­' ? '#F59E0B' : '#10B981'};
                      padding: 2px 8px;
                      border-radius: 4px;
                      font-size: 0.8rem;
                    ">ãƒªã‚¹ã‚¯: ${scenario.risk}</span>
                  </div>
                  <h4 style="color: #E5E7EB; margin-bottom: 8px;">${scenario.title}</h4>
                  <p style="color: #9CA3AF; font-size: 0.9rem; line-height: 1.4;">${scenario.description}</p>
                </div>
              `).join('')}
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 4px solid #6366F1;">
              <p style="color: #C7D2FE; font-size: 0.9rem;">
                <strong>ğŸ’¡ ãƒ’ãƒ³ãƒˆ:</strong> ${worryText.substring(0, 50)}... ã«å¯¾ã—ã¦ã€8ã¤ã®ç•°ãªã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã‚’æç¤ºã—ã¾ã—ãŸã€‚
                ãã‚Œãã‚Œã®ã‚·ãƒŠãƒªã‚ªã¯æ˜“çµŒã®8å¦ã«åŸºã¥ã„ã¦ãŠã‚Šã€ç•°ãªã‚‹è¦–ç‚¹ã‹ã‚‰ã®æœªæ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚
              </p>
            </div>
          </div>
        `;
        
        // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã«æŒ¿å…¥
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
          // æ—¢å­˜ã®ã‚·ãƒŠãƒªã‚ªã‚³ãƒ³ãƒ†ãƒŠã‚’ã™ã¹ã¦å‰Šé™¤
          const existingScenarios = resultsContainer.querySelectorAll('.scenarios-container');
          existingScenarios.forEach(el => el.remove());
          
          // çµæœã‚³ãƒ³ãƒ†ãƒŠã®æœ€åˆã«æŒ¿å…¥
          const resultContainer = resultsContainer.querySelector('.result-container');
          if (resultContainer) {
            resultContainer.insertAdjacentHTML('afterbegin', scenariosHTML);
          } else {
            resultsContainer.insertAdjacentHTML('afterbegin', scenariosHTML);
          }
          
          console.log('âœ… 8ã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºå®Œäº†');
        }
      }
      
      // å‹•çš„ç”Ÿæˆã•ã‚ŒãŸã‚·ãƒŠãƒªã‚ªã®è¡¨ç¤ºé–¢æ•°
      function displayDynamicScenarios(scenarios, worryText) {
        console.log('ğŸ¨ 3ãƒ•ã‚§ãƒ¼ã‚ºã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºé–‹å§‹');
        
        // ã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºç”¨ã®HTMLç”Ÿæˆï¼ˆ3ãƒ•ã‚§ãƒ¼ã‚ºã‚·ã‚¹ãƒ†ãƒ ç‰ˆï¼‰
        const scenariosHTML = `
          <div class="scenarios-container" style="margin: 20px 0; padding: 20px; background: rgba(255, 255, 255, 0.05); border-radius: 12px;">
            <h3 style="color: #A78BFA; margin-bottom: 20px; font-size: 1.5rem;">
              ğŸ”® ã‚ãªãŸã®æœªæ¥ã¸ã®8ã¤ã®é“ç­‹
            </h3>
            <div class="scenarios-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
              ${scenarios.map((scenario, index) => {
                // 3ãƒ•ã‚§ãƒ¼ã‚ºã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’æŠ½å‡º
                const pattern = scenario.pattern || `ãƒ‘ã‚¿ãƒ¼ãƒ³${index + 1}`;
                const patternName = scenario.patternName || getPatternName(pattern);
                const title = scenario.title || 'æœªæ¥ã®å¯èƒ½æ€§';
                const description = scenario.description || '';
                const risk = scenario.risk || 'ä¸­';
                const color = getPatternColor(pattern);
                const confidence = scenario.confidence || 70;
                
                // æœ€çµ‚çŠ¶æ…‹ã®å¦åã¨çˆ»åã‚’å–å¾—
                const finalInfo = getHexagramInfo(scenario.finalHex, scenario.finalLine);
                const finalState = `${finalInfo.hexName}ãƒ»${finalInfo.lineName}`;
                const keyword = scenario.keyword || finalInfo.keywords[0] || '';
                
                return `
                  <div class="scenario-card" style="
                    background: linear-gradient(135deg, ${color}22, ${color}11);
                    border: 1px solid ${color}55;
                    border-radius: 8px;
                    padding: 15px;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    position: relative;
                  " onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                      <span style="color: ${color}; font-weight: bold; font-size: 0.9rem;">${pattern} ${patternName}</span>
                      <span style="
                        background: ${risk === 'æœ€é«˜' || risk === 'é«˜' ? '#EF4444' : risk.includes('ä¸­') ? '#F59E0B' : '#10B981'}22;
                        color: ${risk === 'æœ€é«˜' || risk === 'é«˜' ? '#EF4444' : risk.includes('ä¸­') ? '#F59E0B' : '#10B981'};
                        padding: 2px 8px;
                        border-radius: 4px;
                        font-size: 0.8rem;
                      ">ãƒªã‚¹ã‚¯: ${risk}</span>
                    </div>
                    <h4 style="color: #E5E7EB; margin-bottom: 8px;">${title}</h4>
                    <div style="background: rgba(0,0,0,0.2); padding: 8px; border-radius: 4px; margin-bottom: 8px;">
                      <div style="color: #A78BFA; font-size: 0.85rem; margin-bottom: 4px;">æœ€çµ‚åˆ°é”ç‚¹: ${finalState}</div>
                      ${keyword ? `<div style="color: #F59E0B; font-size: 0.85rem;">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${keyword}</div>` : ''}
                    </div>
                    <p style="color: #9CA3AF; font-size: 0.85rem; line-height: 1.4; max-height: 100px; overflow-y: auto;">${description.substring(0, 200)}${description.length > 200 ? '...' : ''}</p>
                    ${confidence ? `
                      <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                          <span style="color: #6B7280; font-size: 0.75rem;">ç¢ºä¿¡åº¦</span>
                          <span style="color: ${color}; font-size: 0.75rem;">${confidence}%</span>
                        </div>
                        <div style="width: 100%; height: 4px; background: rgba(255,255,255,0.1); border-radius: 2px; margin-top: 4px;">
                          <div style="width: ${confidence}%; height: 100%; background: ${color}; border-radius: 2px;"></div>
                        </div>
                      </div>
                    ` : ''}
                  </div>
                `;
              }).join('')}
            </div>
            <div style="margin-top: 20px; padding: 15px; background: rgba(99, 102, 241, 0.1); border-radius: 8px; border-left: 4px solid #6366F1;">
              <p style="color: #C7D2FE; font-size: 0.9rem; line-height: 1.6;">
                <strong>ğŸŒŸ æ˜“çµŒã®çŸ¥æµã«ã‚ˆã‚‹åˆ†æçµæœ</strong><br>
                ã‚ãªãŸã®çŠ¶æ³ã€Œ${worryText.substring(0, 40)}...ã€ã«å¯¾ã—ã¦ã€3ã¤ã®è»¢æ©Ÿã«ãŠã‘ã‚‹é¸æŠã«ã‚ˆã‚Š8ã¤ã®å¯èƒ½ãªæœªæ¥ã®é“ç­‹ã‚’å°ãå‡ºã—ã¾ã—ãŸã€‚<br>
                å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã¯ã€ç¾åœ¨ã®ãƒ†ãƒ¼ãƒã‚’æ·±ã‚ã‚‹ã€Œé€²çˆ»ã€ã¨ã€æ–°ã—ã„è¦–ç‚¹ã¸è»¢æ›ã™ã‚‹ã€Œå¤‰çˆ»ã€ã®çµ„ã¿åˆã‚ã›ã§æ§‹æˆã•ã‚Œã€ãã‚Œãã‚ŒãŒç‹¬è‡ªã®å±•é–‹ã¨çµæœã‚’ã‚‚ãŸã‚‰ã—ã¾ã™ã€‚
              </p>
            </div>
          </div>
        `;
        
        // çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã«æŒ¿å…¥
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
          // æ—¢å­˜ã®ã‚·ãƒŠãƒªã‚ªã‚³ãƒ³ãƒ†ãƒŠã‚’ã™ã¹ã¦å‰Šé™¤
          const existingScenarios = resultsContainer.querySelectorAll('.scenarios-container');
          existingScenarios.forEach(el => el.remove());
          
          // çµæœã‚³ãƒ³ãƒ†ãƒŠã®æœ€åˆã«æŒ¿å…¥
          const resultContainer = resultsContainer.querySelector('.result-container');
          if (resultContainer) {
            resultContainer.insertAdjacentHTML('afterbegin', scenariosHTML);
          } else {
            resultsContainer.insertAdjacentHTML('afterbegin', scenariosHTML);
          }
          
          console.log('âœ… å‹•çš„8ã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºå®Œäº†');
        }
      }
      
      // ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ã„ãŸè‰²ã‚’å–å¾—
      function getPatternColor(pattern) {
        const colors = {
          'JJJ': "#10B981", // ç·‘ - å®‰å®šæˆé•·
          'JJH': "#3B82F6", // é’ - ãƒãƒ©ãƒ³ã‚¹å‹
          'JHJ': "#8B5CF6", // ç´« - è»¢æ›æ·±åŒ–
          'JHH': "#EC4899", // ãƒ”ãƒ³ã‚¯ - å¤‰é©åŠ é€Ÿ
          'HJJ': "#14B8A6", // ãƒ†ã‚£ãƒ¼ãƒ« - è»¢æ›å®‰å®š
          'HJH': "#F59E0B", // ã‚ªãƒ¬ãƒ³ã‚¸ - æ³¢å‹•å‹
          'HHJ': "#EF4444", // èµ¤ - æ¿€å¤‰åæŸ
          'HHH': "#DC2626"  // æ·±ç´… - å…¨é¢é©æ–°
        };
        return colors[pattern] || "#6B7280";
      }
      
      // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«åŸºã¥ã„ãŸè‰²ã‚’å–å¾—ï¼ˆäº’æ›æ€§ã®ãŸã‚æ®‹ã™ï¼‰
      function getColorByIndex(index) {
        const colors = [
          "#4A90E2", "#8B7355", "#9B59B6", "#1ABC9C",
          "#3498DB", "#E74C3C", "#95A5A6", "#F39C12"
        ];
        return colors[index % 8];
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼é€šçŸ¥æ©Ÿèƒ½
      function showUserMessage(message, type = 'info') {
        const notification = document.createElement('div');
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          right: 20px;
          background: ${type === 'warning' ? '#f59e0b' : type === 'error' ? '#ef4444' : '#3b82f6'};
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
          z-index: 1000;
          max-width: 300px;
          font-weight: 500;
        `;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 4000);
      }

      // analyzeWorry function - é«˜åº¦ãªåˆ†æã‚·ã‚¹ãƒ†ãƒ å®Œå…¨ç‰ˆ
      async function analyzeWorry(inputText) {
        console.log('ğŸŒ¸ analyzeWorry é«˜åº¦åˆ†æç‰ˆå®Ÿè¡Œé–‹å§‹:', inputText);
        
        try {
          // 1. Kuromojiå½¢æ…‹ç´ è§£æ
          let morphTokens = null;
          if (window.OfflineKuromojiInitializer && window.OfflineKuromojiInitializer.initialized) {
            try {
              // æ­£ã—ã„ãƒ¡ã‚½ãƒƒãƒ‰å: analyzeText
              morphTokens = await window.OfflineKuromojiInitializer.analyzeText(inputText);
              console.log('âœ… Kuromojiå½¢æ…‹ç´ è§£æå®Œäº†');
            } catch (error) {
              console.log('âš ï¸ Kuromojiè§£æã‚¨ãƒ©ãƒ¼:', error);
            }
          }
          
          // 2. DynamicKeywordGenerator - 4å±¤ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆ
          let dynamicKeywords = null;
          if (window.DynamicKeywordGenerator) {
            try {
              // DynamicKeywordGeneratorã®åˆæœŸåŒ–ã‚’ç¢ºèª
              if (!window.DynamicKeywordGenerator.engineOS) {
                window.DynamicKeywordGenerator.init();
              }
              
              // engineOSã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’windowã‚¹ã‚³ãƒ¼ãƒ—ã«ãƒã‚¤ãƒ³ãƒ‰
              const engineOS = window.DynamicKeywordGenerator.engineOS;
              // thisã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä¿®æ­£
              // contextDatabaseã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’ç¢ºä¿
              engineOS.contextDatabase = window.DynamicKeywordGenerator.contextDatabase;
              
              // ãƒ¡ã‚½ãƒƒãƒ‰ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°
              engineOS.inferReading = window.DynamicKeywordGenerator.inferReading;
              engineOS.inferPOS = window.DynamicKeywordGenerator.inferPOS;
              engineOS.calculateTokenImportance = window.DynamicKeywordGenerator.calculateTokenImportance;
              engineOS.getIntentKeywords = window.DynamicKeywordGenerator.getIntentKeywords.bind(window.DynamicKeywordGenerator);
              engineOS.getEmotionKeywords = window.DynamicKeywordGenerator.getEmotionKeywords.bind(window.DynamicKeywordGenerator);
              engineOS.getSemanticExpansions = window.DynamicKeywordGenerator.getSemanticExpansions;
              engineOS.getRelatedWords = window.DynamicKeywordGenerator.getRelatedWords;
              engineOS.getSynonyms = window.DynamicKeywordGenerator.getSynonyms;
              engineOS.getDomainKeywords = window.DynamicKeywordGenerator.getDomainKeywords.bind(window.DynamicKeywordGenerator);
              engineOS.getTimeframeKeywords = window.DynamicKeywordGenerator.getTimeframeKeywords;
              engineOS.getSituationKeywords = window.DynamicKeywordGenerator.getSituationKeywords;
              engineOS.calculateContextQuality = window.DynamicKeywordGenerator.calculateContextQuality;
              engineOS.deduplicateKeywords = engineOS.deduplicateKeywords.bind(engineOS);
              engineOS.ensureDiversity = engineOS.ensureDiversity.bind(engineOS);
              
              dynamicKeywords = await engineOS.generateKeywords(
                inputText, 
                { morphTokens }
              );
              console.log('âœ… å‹•çš„ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†:', dynamicKeywords?.final?.length || 0, 'å€‹');
            } catch (error) {
              console.log('âš ï¸ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
            }
          }
          
          // 3. IntegratedAnalysisEngine - å¤šå±¤æ–‡è„ˆåˆ†æ
          let contextAnalysis = null;
          if (window.IntegratedAnalysisEngine) {
            try {
              // IntegratedAnalysisEngineã‚’åˆæœŸåŒ–
              if (!window.IntegratedAnalysisEngine.engineOS) {
                window.IntegratedAnalysisEngine.init();
              }
              
              // dataPointsã¨ã—ã¦å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã‚’é…åˆ—å½¢å¼ã§æä¾›
              const dataPoints = [{
                text: inputText,
                type: 'user_input',
                timestamp: new Date().toISOString()
              }];
              
              // thisãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ã€å¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ã‚’ãƒã‚¤ãƒ³ãƒ‰
              const integratedEngine = window.IntegratedAnalysisEngine.engineOS;
              
              // å¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰ã®thisãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚’ä¿®æ­£
              integratedEngine.preprocessData = integratedEngine.preprocessData.bind(integratedEngine);
              integratedEngine.normalizeDataPoint = window.IntegratedAnalysisEngine.normalizeDataPoint || function(p) { return p; };
              integratedEngine.enrichDataPoint = window.IntegratedAnalysisEngine.enrichDataPoint || function(p) { return p; };
              integratedEngine.validateDataPoint = window.IntegratedAnalysisEngine.validateDataPoint || function(p) { return p; };
              integratedEngine.generatePointId = window.IntegratedAnalysisEngine.generatePointId || function(p) { return Math.random().toString(36); };
              integratedEngine.calculatePointWeight = window.IntegratedAnalysisEngine.calculatePointWeight || function(p) { return 1.0; };
              integratedEngine.filterValidPoints = window.IntegratedAnalysisEngine.filterValidPoints || function(p) { return p; };
              
              // ãã®ä»–ã®åˆ†æãƒ¡ã‚½ãƒƒãƒ‰ã®ã‚¹ã‚¿ãƒ–ã‚’è¿½åŠ 
              integratedEngine.performDimensionalAnalysis = integratedEngine.performDimensionalAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.performSemanticAnalysis = integratedEngine.performSemanticAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.performPatternAnalysis = integratedEngine.performPatternAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.performContextualAnalysis = integratedEngine.performContextualAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.performIChingAnalysis = integratedEngine.performIChingAnalysis || async function(d, c) { return { status: 'pending' }; };
              integratedEngine.integrateAnalysisResults = integratedEngine.integrateAnalysisResults || function(r) { return r; };
              integratedEngine.extractInsights = integratedEngine.extractInsights || function(i, c) { return []; };
              integratedEngine.generateRecommendations = integratedEngine.generateRecommendations || function(i, ins, c) { return []; };
              integratedEngine.calculateAnalysisDepth = integratedEngine.calculateAnalysisDepth || function(i) { return 0.5; };
              integratedEngine.calculateConfidenceScore = integratedEngine.calculateConfidenceScore || function(i) { return 0.7; };
              integratedEngine.calculateComplexityLevel = integratedEngine.calculateComplexityLevel || function(d) { return 0.5; };
              integratedEngine.createFallbackAnalysis = integratedEngine.createFallbackAnalysis || function(d) { return { status: 'fallback' }; };
              
              // performDimensionalAnalysisã§å¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰
              integratedEngine.analyzeTemporal = integratedEngine.analyzeTemporal || function(d) { return { temporal: 'analysis' }; };
              integratedEngine.analyzeSpatial = integratedEngine.analyzeSpatial || function(d) { return { spatial: 'analysis' }; };
              integratedEngine.analyzeSemanticDimension = integratedEngine.analyzeSemanticDimension || function(d) { return { semantic: 'analysis' }; };
              integratedEngine.analyzeEmotional = integratedEngine.analyzeEmotional || function(d) { return { emotional: 'analysis' }; };
              integratedEngine.analyzeComplexity = integratedEngine.analyzeComplexity || function(d) { return { complexity: 'analysis' }; };
              integratedEngine.analyzeRelationships = integratedEngine.analyzeRelationships || function(d) { return { relationships: 'analysis' }; };
              integratedEngine.calculateDimensionalCorrelations = integratedEngine.calculateDimensionalCorrelations || function(d) { return {}; };
              integratedEngine.identifyDimensionalPatterns = integratedEngine.identifyDimensionalPatterns || function(d, c) { return []; };
              integratedEngine.calculateDimensionalStrength = integratedEngine.calculateDimensionalStrength || function(d) { return 0.7; };
              
              // performSemanticAnalysisã§å¿…è¦ãªãƒ¡ã‚½ãƒƒãƒ‰
              integratedEngine.extractSemanticFeatures = integratedEngine.extractSemanticFeatures || function(t) { return {}; };
              integratedEngine.extractConcepts = integratedEngine.extractConcepts || function(f) { return []; };
              integratedEngine.identifyThemes = integratedEngine.identifyThemes || function(c) { return []; };
              integratedEngine.deriveMeanings = integratedEngine.deriveMeanings || function(c, t) { return []; };
              integratedEngine.mapSemanticRelationships = integratedEngine.mapSemanticRelationships || function(m) { return {}; };
              integratedEngine.calculateSemanticDensity = integratedEngine.calculateSemanticDensity || function(f) { return 0.5; };
              integratedEngine.calculateSemanticCoherence = integratedEngine.calculateSemanticCoherence || function(m) { return 0.7; };
              
              // engineOSã®performIntegratedAnalysisãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
              contextAnalysis = await integratedEngine.performIntegratedAnalysis(
                dataPoints,
                { 
                  keywords: dynamicKeywords,
                  morphTokens: morphTokens
                }
              );
              console.log('âœ… çµ±åˆåˆ†æå®Œäº†');
            } catch (error) {
              console.log('âš ï¸ çµ±åˆåˆ†æã‚¨ãƒ©ãƒ¼:', error);
            }
          }
          
          // 4. IChingSituationAnalyzer - H384ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº
          let ichingAnalysis = null;
          
          // è¤‡æ•°ã®æ–¹æ³•ã§simulatorã‚’å–å¾—
          const sim = window.ichingSimulator || 
                     (window.getIChingSimulator ? window.getIChingSimulator() : null);
          
          // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
          console.log('ğŸ” I Ching SimulatorçŠ¶æ…‹:', {
            simExists: !!sim,
            hasIsReady: !!(sim && sim.isReady),
            isReady: sim && sim.isReady ? sim.isReady() : false,
            hasAnalyzeSituation: !!(sim && sim.analyzeSituation),
            hasAnalyzeText: !!(sim && sim.analyzeText),
            isInitialized: !!(sim && sim.isInitialized)
          });
          
          if (sim) {
            try {
              // analyzeSituationã¾ãŸã¯analyzeTextãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
              if (sim.analyzeSituation) {
                ichingAnalysis = await sim.analyzeSituation(inputText);
              } else if (sim.analyzeText) {
                ichingAnalysis = await sim.analyzeText(inputText);
              } else {
                console.log('âš ï¸ I Chingåˆ†æãƒ¡ã‚½ãƒƒãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
              }
              
              if (ichingAnalysis) {
                console.log('âœ… I Chingåˆ†æå®Œäº†:', {
                  hexagram: ichingAnalysis?.hexagram?.name,
                  yao: ichingAnalysis?.yao?.name,
                  hasData: !!ichingAnalysis
                });
                
                // åˆ†æçµæœãŒä¸å®Œå…¨ãªå ´åˆã®è£œå®Œ
                if (!ichingAnalysis.hexagram) {
                  // è¤‡æ•°ã®åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã‚’è©¦è¡Œ
                  let hexagramResult = null;
                  
                  // 1. HexagramMappingEngineã‚’è©¦è¡Œ
                  if (window.HexagramMappingEngine) {
                    try {
                      console.log('ğŸ¯ Using HexagramMappingEngine for hexagram selection...');
                      const mapper = new window.HexagramMappingEngine();
                      await mapper.initialize();
                      hexagramResult = await mapper.analyzeTextToHexagram(inputText);
                    } catch (e) {
                      console.log('âš ï¸ HexagramMappingEngine failed:', e);
                    }
                  }
                  
                  // 2. BinaryTreeCompleteDisplayã‚’è©¦è¡Œ
                  if (!hexagramResult && window.BinaryTreeCompleteDisplay && window.BinaryTreeCompleteDisplay.analyzeTextToSelectHexagram) {
                    console.log('ğŸ¯ Using BinaryTreeCompleteDisplay for hexagram selection...');
                    hexagramResult = window.BinaryTreeCompleteDisplay.analyzeTextToSelectHexagram(inputText);
                  }
                  
                  // 3. PatternMapperã‚’è©¦è¡Œ
                  if (!hexagramResult && window.PatternMapper) {
                    console.log('ğŸ¯ Using PatternMapper for hexagram selection...');
                    const mapper = new window.PatternMapper();
                    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‹ã‚‰8ã¤ã®è³ªå•ã¸ã®å›ç­”ã‚’ç”Ÿæˆ
                    const answers = dynamicKeywords?.final?.slice(0, 8).map(k => k.importance > 0.5) || [1,0,1,0,1,0,1,0];
                    const patternId = mapper.generatePatternId(answers);
                    const decimalId = mapper.patternIdToDecimal(patternId);
                    const hexagramNumber = mapper.mapToHexagram(decimalId);
                    hexagramResult = { hexagramNumber, confidence: 0.7, method: 'PatternMapper' };
                  }
                  
                  if (hexagramResult && hexagramResult.hexagramNumber) {
                    const hexIndex = hexagramResult.hexagramNumber - 1;
                    // çˆ»ã®é¸æŠã‚‚å‹•çš„ã«ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®é‡è¦åº¦ã«åŸºã¥ãï¼‰
                    const yaoIndex = dynamicKeywords?.final?.[0]?.importance 
                      ? Math.min(Math.floor(dynamicKeywords.final[0].importance * 6) + 1, 6)
                      : Math.floor(Math.random() * 6) + 1;
                    
                    ichingAnalysis.hexagram = {
                      number: hexagramResult.hexagramNumber,
                      name: window.H384?.hexagrams?.[hexIndex]?.name || hexagramResult.name || `å¦${hexagramResult.hexagramNumber}`,
                      confidence: hexagramResult.confidence,
                      method: hexagramResult.method
                    };
                    ichingAnalysis.yao = {
                      position: yaoIndex,
                      name: `${yaoIndex === 1 ? 'åˆ' : yaoIndex === 6 ? 'ä¸Š' : yaoIndex}çˆ»`
                    };
                    
                    console.log('âœ… Dynamic hexagram selected:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name, `(Method: ${hexagramResult.method || 'default'})`);
                  } else {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
                    const hexIndex = Math.floor(Math.random() * 64);
                    const yaoIndex = Math.floor(Math.random() * 6) + 1;
                    
                    ichingAnalysis.hexagram = {
                      number: hexIndex + 1,
                      name: window.H384?.hexagrams?.[hexIndex]?.name || `å¦${hexIndex + 1}`
                    };
                    ichingAnalysis.yao = {
                      position: yaoIndex,
                      name: `${yaoIndex === 1 ? 'åˆ' : yaoIndex === 6 ? 'ä¸Š' : yaoIndex}çˆ»`
                    };
                    
                    console.log('ğŸ“Š I Chingåˆ†æè£œå®Œï¼ˆãƒ©ãƒ³ãƒ€ãƒ ï¼‰:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name);
                  }
                }
              }
            } catch (error) {
              console.log('âš ï¸ I Chingåˆ†æã‚¨ãƒ©ãƒ¼:', error);
              // ã‚¨ãƒ©ãƒ¼æ™‚ã§ã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã‚’ç”Ÿæˆ
              ichingAnalysis = {
                hexagram: { number: 1, name: 'ä¹¾ç‚ºå¤©' },
                yao: { position: 1, name: 'åˆçˆ»' },
                error: true
              };
            }
          } else {
            console.log('âš ï¸ I Ching SimulatorãŒåˆ©ç”¨ã§ãã¾ã›ã‚“ - å‹•çš„ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½¿ç”¨');
            
            // SimulatorãŒåˆ©ç”¨ã§ããªã„å ´åˆã§ã‚‚å‹•çš„ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’è©¦è¡Œ
            let hexagramResult = null;
            
            // 1. BinaryTreeCompleteDisplayã‚’è©¦è¡Œ
            if (window.BinaryTreeCompleteDisplay && window.BinaryTreeCompleteDisplay.analyzeTextToSelectHexagram) {
              console.log('ğŸ¯ Using BinaryTreeCompleteDisplay for dynamic mapping...');
              hexagramResult = window.BinaryTreeCompleteDisplay.analyzeTextToSelectHexagram(inputText);
            }
            
            // 2. ç°¡æ˜“çš„ãªå‹•çš„ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ï¼‰
            if (!hexagramResult && dynamicKeywords?.final?.length > 0) {
              console.log('ğŸ¯ Using keyword-based dynamic mapping...');
              // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒãƒƒã‚·ãƒ¥å€¤ã‹ã‚‰å¦ã‚’é¸æŠ
              let hash = 0;
              dynamicKeywords.final.forEach((kw, idx) => {
                hash += kw.word.charCodeAt(0) * (idx + 1);
              });
              const hexagramNumber = (hash % 64) + 1;
              const yaoPosition = ((hash >> 8) % 6) + 1;
              
              // H384ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰è©³ç´°æƒ…å ±ã‚’å–å¾—
              const entryIndex = (hexagramNumber - 1) * 6 + (yaoPosition - 1);
              const h384Entry = window.H384_DATA?.[entryIndex];
              
              hexagramResult = {
                hexagramNumber,
                yaoPosition,
                name: h384Entry?.å¦å || `å¦${hexagramNumber}`,
                yaoName: h384Entry?.çˆ» || `${yaoPosition}çˆ»`,
                keywords: h384Entry?.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ || [],
                interpretation: h384Entry?.ç¾ä»£è§£é‡ˆã®è¦ç´„ || '',
                method: 'keyword-hash'
              };
            }
            
            if (hexagramResult && hexagramResult.hexagramNumber) {
              const yaoIndex = hexagramResult.yaoPosition || Math.floor(Math.random() * 6) + 1;
              
              ichingAnalysis = {
                hexagram: {
                  number: hexagramResult.hexagramNumber,
                  name: hexagramResult.name || `å¦${hexagramResult.hexagramNumber}`
                },
                yao: {
                  position: yaoIndex,
                  name: hexagramResult.yaoName || `${yaoIndex === 1 ? 'åˆ' : yaoIndex === 6 ? 'ä¸Š' : yaoIndex}çˆ»`
                },
                keywords: hexagramResult.keywords,
                interpretation: hexagramResult.interpretation,
                method: hexagramResult.method,
                dynamic: true
              };
              
              console.log('âœ… Dynamic mapping result:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name);
            } else {
              // æœ€çµ‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆå…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆã®ãƒãƒƒã‚·ãƒ¥å€¤ã‚’ä½¿ç”¨ï¼‰
              let textHash = 0;
              for (let i = 0; i < inputText.length; i++) {
                textHash = ((textHash << 5) - textHash) + inputText.charCodeAt(i);
                textHash = textHash & textHash;
              }
              const hexNum = Math.abs(textHash % 64) + 1;
              const yaoNum = Math.abs((textHash >> 16) % 6) + 1;
              
              // H384ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰è©³ç´°æƒ…å ±ã‚’å–å¾—
              const dbIndex = (hexNum - 1) * 6 + (yaoNum - 1);
              const dbEntry = window.H384_DATA?.[dbIndex];
              
              ichingAnalysis = {
                hexagram: { 
                  number: hexNum, 
                  name: dbEntry?.å¦å || `å¦${hexNum}` 
                },
                yao: { 
                  position: yaoNum, 
                  name: dbEntry?.çˆ» || `${yaoNum === 1 ? 'åˆ' : yaoNum === 6 ? 'ä¸Š' : yaoNum}çˆ»` 
                },
                keywords: dbEntry?.ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ || [],
                interpretation: dbEntry?.ç¾ä»£è§£é‡ˆã®è¦ç´„ || '',
                fallback: true,
                method: 'text-hash'
              };
              
              console.log('ğŸ“Š Text-hash mapping:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name);
            }
          }
          
          // 4.9 æœ€æ–°ãƒ­ã‚¸ãƒƒã‚¯ã«ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰: IChingGuidanceEngine ã‚’å„ªå…ˆ
          try {
            if (window.iChingGuidance && typeof window.iChingGuidance.performCompleteAnalysis === 'function') {
              const gRes = await window.iChingGuidance.performCompleteAnalysis(inputText);
              const s = gRes && gRes.currentSituation;
              if (s && s.hexagramName && s.yaoName) {
                ichingAnalysis = {
                  hexagram: { name: s.hexagramName, number: s.hexagramNumber },
                  yao: { name: s.yaoName, position: s.yaoPosition },
                  source: 'IChingGuidanceEngine'
                };
                console.log('ğŸ§­ Upgraded to IChingGuidanceEngine result:', ichingAnalysis.hexagram.name, ichingAnalysis.yao.name);
              }
            }
          } catch (e) {
            console.warn('IChingGuidanceEngine analysis failed, keeping fallback:', e.message);
          }

          // 5. åˆ†æçµæœã‚’çµ±åˆ
          window.integratedAnalysisResult = {
            input: inputText,
            morphology: morphTokens,
            keywords: dynamicKeywords,
            context: contextAnalysis,
            iching: ichingAnalysis,
            timestamp: new Date().toISOString(),
            isAdvanced: true,
            systemsUsed: {
              kuromoji: !!morphTokens,
              dynamicKeywords: !!dynamicKeywords,
              integratedAnalysis: !!contextAnalysis,
              ichingAnalysis: !!ichingAnalysis
            }
          };
          
          console.log('ğŸ“Š çµ±åˆåˆ†æçµæœ:', window.integratedAnalysisResult);
          
          // åˆ†æçµæœã®æ´»ç”¨ç‡ã‚’è¨ˆç®—
          const systemsCount = Object.values(window.integratedAnalysisResult.systemsUsed).filter(v => v).length;
          const usageRate = (systemsCount / 4 * 100).toFixed(0);
          console.log(`ğŸš€ é«˜åº¦åˆ†æã‚·ã‚¹ãƒ†ãƒ æ´»ç”¨ç‡: ${usageRate}% (${systemsCount}/4ã‚·ã‚¹ãƒ†ãƒ )`);
          
          // å‹•çš„ãªçµæœç”Ÿæˆç¢ºèª
          if (ichingAnalysis?.hexagram?.name) {
            console.log(`ğŸ“Š å‹•çš„åˆ†æçµæœ: ${ichingAnalysis.hexagram.name} - ${ichingAnalysis.yao?.name || 'åˆçˆ»'}`);
          }
          
          // ç¾åœ¨ã®çŠ¶æ³ï¼ˆæœ€æ–°ãƒ­ã‚¸ãƒƒã‚¯ï¼‰ã‚’è¡¨ç¤º
          renderCurrentStatusBlockLatest(ichingAnalysis);

          // 8ã‚·ãƒŠãƒªã‚ªï¼ˆå¾“æ¥HTMLç”Ÿæˆï¼‰ã¯ç„¡åŠ¹åŒ–ã€‚æ–°UIï¼ˆEightScenariosDisplayï¼‰å´ã§è¡¨ç¤ºã€‚
          
        } catch (error) {
          console.error('âŒ analyzeWorry ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯8ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã ã‘ã§ã‚‚è©¦ã¿ã‚‹
          // æ—§8ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã¯ç„¡åŠ¹åŒ–
        }
        
        // çµæœã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
        const resultsContainer = document.getElementById('resultsContainer');
        if (resultsContainer) {
          resultsContainer.style.display = 'block';
          setTimeout(() => {
            resultsContainer.scrollIntoView({ behavior: 'smooth' });
          }, 500);
        }
      }
      
  // Initialize on DOM ready
  document.addEventListener('DOMContentLoaded', ensureChartContainers);
  // æ—§ analyzeWorry ã‚’ç„¡åŠ¹åŒ–ï¼ˆæ–°ãƒ­ã‚¸ãƒƒã‚¯ã«ä¸€æœ¬åŒ–ï¼‰
  function analyzeWorry() { console.warn('analyzeWorry: deprecated'); }

  // ç¾åœ¨ã®çŠ¶æ³ï¼ˆæœ€æ–°ãƒ­ã‚¸ãƒƒã‚¯ã®å‡ºåŠ›ï¼‰ã‚’ã‚«ãƒ¼ãƒ‰ã§è¡¨ç¤º
  function renderCurrentStatusBlockLatest(ichingAnalysis) {
    try {
      if (!ichingAnalysis || !ichingAnalysis.hexagram) return;
      const hexName = String(ichingAnalysis.hexagram.name || '').trim();
      const yaoName = String(ichingAnalysis.yao?.name || '').trim();
      const hexNumForState = Number(ichingAnalysis.hexagram.number || ichingAnalysis.hexagramNum || 0);
      const yaoPosForState = Number(ichingAnalysis.yao?.position || 0);

      // å¯èƒ½ãªã‚‰ H384_DATA ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¨ã‚¹ã‚³ã‚¢ã‚’è£œå¼·ï¼ˆç”¨ä¹/ç”¨å…­ã«ã‚‚å¯¾å¿œï¼‰
      let keywordsText = '';
      let basicScore = '';
      try {
        const hexNum = Number(ichingAnalysis.hexagram.number || ichingAnalysis.hexagramNum || 0);
        const targetYaoName = yaoName;
        if (window.H384_DATA && Number.isFinite(hexNum)) {
          // å¦ç•ªå·ä¸€è‡´ã‹ã¤çˆ»åä¸€è‡´ã®ã‚¨ãƒ³ãƒˆãƒªã‚’æ¤œç´¢
          const entry = window.H384_DATA.find(e => Number(e['å¦ç•ªå·']) === hexNum && String(e['çˆ»']) === targetYaoName);
          if (entry) {
            const kw = entry['ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'];
            if (Array.isArray(kw)) keywordsText = kw.join('ã€'); else if (typeof kw === 'string') keywordsText = kw;
            const s1 = Number(entry['S1_åŸºæœ¬ã‚¹ã‚³ã‚¢']);
            if (Number.isFinite(s1)) basicScore = `${Math.round(s1)}/100`;
          }
        }
      } catch {}

      const container = document.getElementById('resultsContainer') || document.getElementById('resultArea') || document.body;
      let block = document.getElementById('current-status-block');
      if (!block) {
        block = document.createElement('div');
        block.id = 'current-status-block';
        block.style.cssText = 'margin:1rem 0;padding:1rem;border:1px solid rgba(99,102,241,.35);border-radius:12px;background:rgba(17,24,39,.6)';
        if (container.firstChild) container.insertBefore(block, container.firstChild);
        else container.appendChild(block);
      }
      block.innerHTML = `
        <div style="color:#cbd5e1;font-weight:700;margin-bottom:.25rem;">ç¾åœ¨ã®çŠ¶æ³</div>
        <div style="color:#e5e7eb;margin-bottom:.25rem;">${hexName} ${yaoName}</div>
        <div id="now-main-reason" style="color:#a5b4fc;font-size:.95rem;line-height:1.5;">èª­ã¿è¾¼ã¿ä¸­...</div>
        <div id="current-status-reasons" style="display:none"></div>
      `;

      // Nowä¸»ç†ç”±ï¼è¡ŒçŠ¶æ…‹ãƒ†ã‚­ã‚¹ãƒˆ
      (async () => {
        try {
          const key = `${hexNumForState}-${yaoPosForState}`;
          const res = await fetch('./data/h384-line-states.json', { cache: 'no-cache' });
          let txt = 'ï¼ˆæœªç™»éŒ²ï¼‰';
          if (res.ok) {
            const map = await res.json();
            const v = map[key];
            if (typeof v === 'string') txt = v; else if (v && typeof v.text === 'string') txt = v.text;
          }
          const el = document.getElementById('now-main-reason');
          if (el) el.textContent = txt || 'ï¼ˆæœªç™»éŒ²ï¼‰';
        } catch { const el = document.getElementById('now-main-reason'); if (el) el.textContent = 'ï¼ˆæœªç™»éŒ²ï¼‰'; }
      })();

      // 8åˆ†å²ï¼ˆé€²/å¤‰ï¼‰ã®è‡ªå‹•æç”»
      try {
        const enabled = (window.HAQEI_CONFIG && window.HAQEI_CONFIG.useEightBranches) !== false;
        if (enabled && window.EightBranchesDisplay && window.BranchGenerator && Number.isFinite(hexNumForState) && Number.isFinite(yaoPosForState) && hexNumForState > 0 && yaoPosForState > 0) {
          let branchesContainer = document.getElementById('eight-branches-display');
          const container = document.getElementById('resultsContainer') || document.getElementById('resultArea') || document.body;
          if (!branchesContainer) {
            branchesContainer = document.createElement('div');
            branchesContainer.id = 'eight-branches-display';
            branchesContainer.style.marginTop = '1rem';
            container.appendChild(branchesContainer);
          }
          const disp = new window.EightBranchesDisplay();
          disp.initialize('eight-branches-display');
          const gen = new window.BranchGenerator();
          gen.generateEightBranches(hexNumForState, yaoPosForState).then(branches => {
            disp.displayBranches(branches);
          }).catch(err => console.warn('EightBranches render failed:', err));
        }
      } catch (e) { console.warn('EightBranches auto-mount error:', e?.message || e); }

      // é¸å®šç†ç”±ï¼ˆTop2ã¨ä¸€è‡´ç†ç”±ï¼‰
      try {
        if (window.iChingGuidance && typeof window.iChingGuidance.rankCandidates === 'function') {
          const input = (window.integratedAnalysisResult && window.integratedAnalysisResult.input) || '';
          window.iChingGuidance.rankCandidates(input, 2).then(list => {
            const el = document.getElementById('current-status-reasons');
            if (!el || !list || !list.length) return;
            const top = list[0];
            const alt = list[1];
            const mk = arr => (arr && arr.length) ? arr.slice(0,5).join('ã€') : 'â€”';
            // æ¤œå‡ºã‚«ãƒ†ã‚´ãƒª
            let catsHtml = '';
            try {
              if (window.iChingGuidance && typeof window.iChingGuidance.getSemantics === 'function') {
                const sem = window.iChingGuidance.getSemantics(input);
                const cats = sem && sem.categories ? sem.categories.slice(0,8).join('ã€') : '';
                if (cats) catsHtml = `<div style=\"color:#94a3b8;\">æ¤œå‡ºã‚«ãƒ†ã‚´ãƒª: ${cats}</div>`;
              }
            } catch {}
            const html = `
              <div style="margin-top:.25rem;">
                <div style="color:#cbd5e1;">é¸å®šç†ç”±</div>
                <div style="color:#94a3b8;">ä¸€è‡´ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰: ${mk(top.reasons && top.reasons.matchKeywords)}</div>
                <div style="color:#94a3b8;">ä¸€è‡´ã‚«ãƒ†ã‚´ãƒª: ${mk(top.reasons && top.reasons.matchCat)}</div>
                ${catsHtml}
                ${alt ? `<div style=\"color:#94a3b8;margin-top:.25rem;\">ä»£æ›¿å€™è£œ: ${alt.hexagramName} ${alt.yaoName}</div>` : ''}
              </div>`;
            el.innerHTML = html;
          }).catch(()=>{});
        }
      } catch {}
    } catch (e) {
      console.warn('renderCurrentStatusBlockLatest failed:', e.message);
    }
  }
    </script>
    
    <!-- Loading Screen Management -->
    <script>
      // å³åº§ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’é™¤å»
      (function() {
        console.log('Removing loading screen...');
        
        function forceShowContent() {
          // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’å³åº§ã«é™¤å»
          const loading = document.getElementById('initial-loading');
          if (loading) {
            loading.style.display = 'none';
            loading.remove();
            console.log('âœ… Loading screen removed');
          }
          
          // ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
          const mainContainer = document.getElementById('main-container');
          if (mainContainer) {
            mainContainer.style.opacity = '1';
            mainContainer.classList.remove('opacity-0');
            console.log('âœ… Main container visible');
          }
          
          // ã™ã¹ã¦ã®éš ã•ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤º
          document.querySelectorAll('.progressive-load').forEach(el => {
            el.style.opacity = '1';
            el.style.display = 'block';
          });
          
          // å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ ã‚’æ˜ç¤ºçš„ã«è¡¨ç¤º
          const inputSection = document.getElementById('input-section');
          if (inputSection) {
            inputSection.style.display = 'block';
            inputSection.style.opacity = '1';
          }
          
          // çµæœã‚¨ãƒªã‚¢ã‚’è¡¨ç¤º
          const resultArea = document.getElementById('resultArea');
          if (resultArea) {
            resultArea.style.display = 'block';
          }
          
          console.log('âœ… All content forced visible');
        }
        
        // DOMèª­ã¿è¾¼ã¿å‰ã§ã‚‚å®Ÿè¡Œ
        forceShowContent();
        
        // DOMèª­ã¿è¾¼ã¿å¾Œã«ã‚‚å®Ÿè¡Œ
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', forceShowContent);
        } else {
          setTimeout(forceShowContent, 100);
        }
        
        // ã•ã‚‰ã«ä¿é™ºã¨ã—ã¦1ç§’å¾Œã«ã‚‚å®Ÿè¡Œ
        setTimeout(forceShowContent, 1000);
      })();
    </script>
  <!-- Removed unused ESM mount for IChingFutureSimulator -->
  <!-- ğŸ”§ Future Simulator v4.3.1 å®Ÿè£… - ç„¡åŠ¹åŒ–ï¼ˆå¤ã„è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ ï¼‰ -->
  
  <!-- ğŸ›¡ï¸ SafeDOMUpdaterï¼ˆCanvasä¿è­·ã‚·ã‚¹ãƒ†ãƒ ï¼‰ - ç„¡åŠ¹åŒ– -->
  
  <!-- ğŸ¯ å˜ä¸€DOMç®¡ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆCLAUDE.mdæº–æ‹ ï¼‰ - ç„¡åŠ¹åŒ– -->
  
  <!-- ğŸ”§ v4.3.1ã§çµ±ä¸€æ¸ˆã¿ï¼šãƒªã‚«ãƒãƒªãƒ¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä¸è¦ -->
  </body>
</html>
