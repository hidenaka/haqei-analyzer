<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei マルチバース・アナライザー</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>易</text></svg>"
    />
    
    <!-- Load critical path scripts -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Defer non-critical scripts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js" defer></script>
    
    <!-- Quality Enhancement System -->
    <link rel="stylesheet" href="./css/quality-grade-enhancement.css">
    <script src="./js/quality-enhancement-ui.js" defer></script>
    <script src="./js/dynamic-quality-optimizer.js" defer></script>
    <script src="./js/quality-integration-manager.js" defer></script>
    <script src="./js/quality-system-validator.js" defer></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      
      /* Progressive Loading Styles */
      .skeleton {
        background: linear-gradient(90deg, rgba(55, 65, 81, 0.1) 25%, rgba(75, 85, 99, 0.2) 37%, rgba(55, 65, 81, 0.1) 63%);
        background-size: 400% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
      }
      
      @keyframes skeleton-loading {
        0% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .skeleton-text {
        height: 1em;
        border-radius: 4px;
        margin: 0.5em 0;
      }
      
      .skeleton-button {
        height: 3em;
        border-radius: 8px;
        width: 100%;
      }
      
      .skeleton-card {
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .skeleton-chart {
        height: 300px;
        border-radius: 8px;
      }
      
      .fade-in {
        animation: fadeIn 0.6s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(17, 24, 39, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        transition: opacity 0.3s ease;
      }
      
      .loading-spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(165, 180, 252, 0.3);
        border-left: 4px solid #a5b4fc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      .card:hover,
      .card.highlighted {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      .rank-badge {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 9999px;
        line-height: 1;
      }
      .rank-s,
      .rank-a,
      .rank-b,
      .rank-c {
        background-color: rgba(74, 222, 128, 0.2);
        color: #86efac;
        border: 1px solid #22c55e;
      }
      .rank-d {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #fbbf24;
      }
      .rank-e,
      .rank-f,
      .rank-g {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .rank-h {
        background-color: rgba(185, 28, 28, 0.2);
        color: #fca5a5;
        border: 1px solid #dc2626;
      }

      /* Data Export Styles */
      .data-export-section {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .export-button {
        background: linear-gradient(45deg, #3b82f6, #6366f1);
        transition: all 0.3s ease;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        display: flex;
        items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
      }
      
      .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      }
      
      .progressive-load {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.6s ease;
      }
      
      .progressive-load.loaded {
        opacity: 1;
        transform: translateY(0);
      }

      /* 🌟 Authentic I Ching System Styles */
      .authentic-scenarios-container,
      .authentic-choice-container,
      .current-position-container {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }

      .scenario-card, .choice-card {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .scenario-card:hover, .choice-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        border-color: rgba(99, 102, 241, 0.7);
      }

      .scenario-card.selected, .choice-card.selected {
        border-color: #6366f1;
        background: rgba(99, 102, 241, 0.2);
      }

      .hexagram-line {
        display: flex;
        align-items: center;
        margin: 0.25rem 0;
        font-family: monospace;
      }

      .hexagram-line.yang .line-symbol {
        color: #fbbf24;
      }

      .hexagram-line.yin .line-symbol {
        color: #93c5fd;
      }

      .hexagram-line.current {
        background: rgba(245, 101, 101, 0.2);
        border-radius: 4px;
        padding: 0.25rem;
      }

      .transformation-visual {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 1rem 0;
      }

      .transformation-arrow {
        font-size: 1.5rem;
        color: #6366f1;
        margin: 0 1rem;
      }

      .bunenjin-analysis .persona-analysis {
        background: rgba(31, 41, 55, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
      }

      .fade-in {
        opacity: 0;
        animation: fadeInUp 0.6s ease forwards;
      }

      .fade-in.visible {
        opacity: 1;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
    </style>
    
    <!-- Core System Assets -->
    <script src="./assets/H384H64data.js"></script>
    <script src="./js/core/IChingTransformationEngine.js"></script>
    <script src="./js/pages/future-simulator/FutureBranchingSystem.js"></script>
    <script src="./js/core/DataPersistenceManager.js"></script>
    <script src="./js/core/DataExportAPI.js"></script>
    
    <!-- H384_DATA読み込み順序確認 -->
    <script>
        (function() {
            console.log('🔍 H384_DATA読み込み順序確認を開始...');
            
            if (typeof H384_DATA === 'undefined') {
                console.error('❌ H384_DATA変数が見つかりません');
                console.warn('⚠️  フォールバック機能を試行中...');
                
                // フォールバック: window.H384_DATAを確認
                if (typeof window.H384_DATA !== 'undefined') {
                    console.log('✅ window.H384_DATAからのフォールバック成功');
                    window.H384_DATA = window.H384_DATA;
                } else {
                    console.error('❌ フォールバック機能も利用できません');
                }
            } else {
                console.log('✅ H384_DATA変数の存在確認: 成功');
                
                // window.H384_DATAへの代入確認
                if (typeof window.H384_DATA === 'undefined') {
                    console.warn('⚠️  window.H384_DATAが未設定 - 自動設定を試行');
                    try {
                        window.H384_DATA = H384_DATA;
                        console.log('✅ window.H384_DATA自動設定: 成功');
                    } catch (error) {
                        console.error('❌ window.H384_DATA設定エラー:', error);
                    }
                }
                
                // データ完全性の基本確認
                if (Array.isArray(window.H384_DATA) && window.H384_DATA.length === 386) {
                    console.log('✅ H384_DATAデータ完全性確認: 成功 (386エントリ)');
                    
                    // 用九・用六エントリの確認
                    const youkuu = window.H384_DATA.find(item => item['通し番号'] === 7);
                    const yourikuu = window.H384_DATA.find(item => item['通し番号'] === 14);
                    
                    if (youkuu && yourikuu) {
                        console.log('✅ 用九・用六エントリ確認: 成功');
                        console.log(`   - 用九: ${youkuu['卦名']} (${youkuu['爻']})`);
                        console.log(`   - 用六: ${yourikuu['卦名']} (${yourikuu['爻']})`);
                    } else {
                        console.warn('⚠️  用九・用六エントリに問題があります');
                    }
                } else {
                    console.error('❌ H384_DATAデータ形式エラー:', {
                        isArray: Array.isArray(window.H384_DATA),
                        length: window.H384_DATA?.length
                    });
                }
            }
            
            console.log('🏁 H384_DATA読み込み順序確認完了');
        })();
    </script>
    <script src="./js/keyword_expansion_engine.js"></script>
    <script src="./js/ml-integration.js" async defer></script>
    <!-- Offline-First Dictionary System -->
    <script src="./js/core/DictionaryManager.js" defer></script>
    <script src="./js/core/OfflineDetector.js" defer></script>
    <script src="./js/core/OfflineKuromojiInitializer.js" defer></script>
    <script src="./js/core/offline-kuromoji-integration.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js" defer></script>
    <!-- Advanced Analysis Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/ml-matrix@6.10.4/lib/ml-matrix.min.js"></script>
    <!-- Dynamic Analysis Components -->
    <script src="./js/pages/future-simulator/DynamicKeywordGenerator.js"></script>
    <script src="./js/pages/future-simulator/IntegratedAnalysisEngine.js"></script>
    <script src="./js/pages/future-simulator/MultiDimensionalContextAnalyzer.js"></script>
    <script src="./js/pages/future-simulator/SituationalContextEngine.js"></script>
    <script src="./js/pages/future-simulator/HexagramMappingEngine.js"></script>
    <script src="./js/pages/future-simulator/MetaphorGenerationEngine.js"></script>
    
    <!-- 🌟 Authentic I Ching System Components -->
    <script src="./js/core/AuthenticIChingEngine.js"></script>
    <script src="./js/components/CurrentPositionDisplay.js"></script>
    <script src="./js/components/AuthenticChoiceSystem.js"></script>
    <script src="./js/components/Authentic8ScenariosSystem.js"></script>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6">
    <!-- Initial Loading Screen -->
    <div id="initial-loading" class="fixed inset-0 bg-gray-900 flex items-center justify-center z-50">
      <div class="text-center">
        <div class="loading-spinner mx-auto mb-4"></div>
        <h1 class="text-2xl font-bold brand-text mb-2">HaQei マルチバース・アナライザー</h1>
        <p class="text-gray-400">システムを初期化中...</p>
        <div class="mt-4 w-64 bg-gray-700 rounded-full h-2">
          <div id="loading-progress" class="bg-indigo-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
      </div>
    </div>
    
    <div
      class="w-full max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8 opacity-0"
      id="main-container"
    >
      <header class="text-center mb-8 relative">
        <a href="./" class="inline-block">
          <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
            HaQei
          </h1>
          <p class="text-gray-400 mt-2 text-lg">マルチバース・アナライザー</p>
        </a>
        <button
          id="helpBtn"
          class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.25l-2.536 2.39c-.832.786-1.464 1.49-1.464 2.36h.001M12 18h.01"
            />
          </svg>
        </button>
      </header>

      <!-- Input Section with Skeleton -->      
      <div class="bg-gray-900/50 p-6 rounded-xl mb-4 relative progressive-load" id="input-section">
        <!-- Skeleton for Input Section -->
        <div class="skeleton-input" id="input-skeleton">
          <div class="skeleton skeleton-text" style="width: 60%; height: 1.5rem; margin-bottom: 1rem;"></div>
          <div class="skeleton skeleton-card">
            <div class="skeleton skeleton-text" style="width: 100%; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text" style="width: 80%; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text" style="width: 90%;"></div>
          </div>
          <div class="skeleton skeleton-text" style="width: 100%; height: 4rem; margin: 1rem 0;"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        
        <!-- Actual Input Content -->
        <div class="input-content" id="input-content" style="display: none;">
          <h2 class="text-lg font-bold text-indigo-300 mb-3">
            1. AIによる状況推測
          </h2>
        <div
          class="border border-gray-700 rounded-lg p-4 mb-4 text-sm text-gray-300 space-y-3"
        >
          <p class="text-base font-bold text-center text-indigo-300">
            AIへの最高の「呪文」は、あなたの「ありのままの言葉」です
          </p>
          <p class="text-xs text-center text-gray-400">
            未来分岐図の精度を高める、たった一つの秘訣
          </p>
          <p>
            これから、あなたの現状と課題をAIに入力していただきます。その際、どうか<strong>「上手な文章を書こう」としないでください。</strong>AIは、整えられた文章よりも、あなたの<strong>「生の言葉」</strong>を求めています。
          </p>
          <p>
            箇条書きでも、心のつぶやきでも、誰かに愚痴をこぼすような言葉でも構いません。他人に見せるための文章ではなく、<strong>あなた自身のための「思考のメモ」</strong>として、リラックスして入力してください。
          </p>
          <p>
            なぜなら、AIはあなたが選ぶ一つ一つの単語、表現の揺れ、感情のニュアンスから、あなただけの「思考のクセ」や「心の動き」を読み取るからです。
          </p>
          <div class="pt-2">
            <p class="font-bold text-gray-200">【入力のヒント】</p>
            <div
              class="mt-2 p-3 rounded-lg bg-red-900/20 border border-red-800/50"
            >
              <p class="font-bold">悪い例 ❌</p>
              <p class="text-xs italic mt-1">
                「新規プロジェクトのマネジメントにおいて、人的リソースの不足がボトルネックとなり、計画に遅延が生じています。」
              </p>
              <p class="text-xs text-gray-400 mt-1">
                （これでは、AIは一般的なビジネス課題としてしか分析できません）
              </p>
            </div>
            <div
              class="mt-2 p-3 rounded-lg bg-emerald-900/20 border border-emerald-800/50"
            >
              <p class="font-bold">良い例 ⭕</p>
              <p class="text-xs italic mt-1">
                「新しい仕事、マジで人足りてない！Aさんは頑張ってくれてるけど、Bさんは全然やる気ないし…。このままだと絶対間に合わない。どうすりゃいいんだ…。焦る。」
              </p>
              <p class="text-xs text-gray-400 mt-1">
                （この方が、あなたの感情、人間関係への認識、切迫感が伝わり、よりパーソナライズされた分析が可能になります）
              </p>
            </div>
          </div>
          <p class="font-bold text-center pt-2">
            あなたの「ありのままの言葉」こそが、あなただけの未来を読み解く、最も強力な鍵となります。<br />どうぞ、あなたの心をそのまま、AIにぶつけてみてください。
          </p>
        </div>
        
        <!-- あなたの未来を読み解きます -->
        <div class="mb-6 text-center">
          <h3 class="text-xl font-bold text-indigo-300 mb-2">
            ✨ あなたの未来を読み解きます
          </h3>
          <p class="text-sm text-gray-400">
            古典易経の智慧で、8つの可能性を探ってみましょう
          </p>
        </div>
        
        <textarea
          id="worryInput"
          class="bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 mb-4"
          rows="4"
          placeholder="ここにあなたの「生の言葉」を入力してください..."
        ></textarea>
        <button
            id="aiGuessBtn"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 flex items-center justify-center gap-2"
          >
            <svg class="animate-spin h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg
              id="originalIcon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                clip-rule="evenodd"
              />
            </svg>
            <span id="buttonText">AIに状況を推測させる</span>
          </button>
        </div>
      </div>

      <!-- Data Export Section -->
      <div class="data-export-section progressive-load" id="data-export">
        <h3 class="text-lg font-bold text-indigo-300 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          データエクスポート
        </h3>
        <div class="flex flex-wrap gap-3">
          <button id="exportJson" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            JSON形式
          </button>
          <button id="exportCsv" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a4 4 0 01-4-4V5a4 4 0 014-4h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a4 4 0 01-4 4z" />
            </svg>
            CSV形式
          </button>
          <button id="exportPdf" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            PDF準備
          </button>
        </div>
      </div>

      <!-- Results Section -->
      <div id="resultArea" class="hidden relative">
        <!-- Loading Overlay for Results -->
        <div id="results-loading" class="loading-overlay" style="display: none;">
          <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-300">分析結果を生成中...</p>
          </div>
        </div>
        
        <!-- Analysis Summary -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start mb-12">
          <div class="lg:col-span-1">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              分析サマリー
            </h2>
            <div class="space-y-4">
              <!-- Summary Card -->
              <div
                id="summaryCard"
                class="p-4 rounded-lg border border-gray-600/50 bg-gray-900/30 relative"
              >
                <div
                  class="bg-yellow-400/10 border-l-4 border-yellow-400 p-3 rounded-md"
                >
                  <h4
                    id="currentTitle"
                    class="text-lg font-semibold text-yellow-300"
                  >現在の状況</h4>
                  <p
                    id="currentKeywords"
                    class="text-sm text-yellow-200 mt-1"
                  ></p>
                  <p id="currentSummary" class="text-gray-300 mt-2 text-sm">あなたの状況を総合的に分析した結果、今は重要な変化の時期にあることが示されています。</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <h4 class="font-bold text-gray-300">推奨される方向性</h4>
                  <p id="recommendedDirection" class="text-gray-300 mt-2 text-sm">内なる直感を信じ、慎重に行動することで良い結果を得られるでしょう。</p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Choice Cards -->
          <div class="lg:col-span-2">
            <h2 class="text-xl font-bold mb-4 text-center text-indigo-300">
              最初の選択：あなたはどちらの道を選ぶか？
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
              <div id="choice1" class="card bg-gradient-to-br from-blue-900/20 to-indigo-900/20 border border-blue-500/30 p-4 rounded-lg hover:border-blue-400">
                <h3 class="text-lg font-bold text-blue-300 mb-2">現状維持の道</h3>
                <p class="text-sm text-gray-300 mb-3">今の状況を受け入れ、内なる力を育む選択</p>
                <div class="text-xs bg-blue-500/20 text-blue-200 px-2 py-1 rounded">安定性重視</div>
              </div>
              <div id="choice2" class="card bg-gradient-to-br from-emerald-900/20 to-teal-900/20 border border-emerald-500/30 p-4 rounded-lg hover:border-emerald-400">
                <h3 class="text-lg font-bold text-emerald-300 mb-2">変革の道</h3>
                <p class="text-sm text-gray-300 mb-3">新しい可能性に向かって一歩踏み出す選択</p>
                <div class="text-xs bg-emerald-500/20 text-emerald-200 px-2 py-1 rounded">成長性重視</div>
              </div>
            </div>
            
            <!-- 8 Scenarios -->
            <h2 class="text-xl font-bold mb-4 text-center text-indigo-300">
              8つの未来シナリオ
            </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="scenarioGrid">
              <!-- Scenarios will be dynamically generated -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Module Script -->
    <script type="module">
      // Progressive Loading Manager
      class ProgressiveLoader {
        constructor() {
          this.progress = 0;
          this.loadedModules = 0;
          this.totalModules = 15;
          this.init();
        }
        
        async init() {
          console.log('🚀 Module script execution started');
          await this.simulateModuleLoading();
          await this.hideLoadingScreen();
          this.startProgressiveContentLoad();
        }
        
        async simulateModuleLoading() {
          const modules = [
            'H384_DATA validation',
            'IChingTransformationEngine',
            'FutureBranchingSystem', 
            'DataPersistenceManager',
            'DataExportAPI',
            'Quality Enhancement',
            'ML Integration',
            'Analysis Engine',
            'Context Analyzer',
            'Hexagram Mapping',
            'Metaphor Generation',
            'Event Listeners',
            'UI Components',
            'Export Functions',
            'Complete Integration'
          ];
          
          for (let i = 0; i < modules.length; i++) {
            await this.animateProgress((i + 1) * (100 / modules.length));
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        
        async hideLoadingScreen() {
          const loadingScreen = document.getElementById('initial-loading');
          const mainContainer = document.getElementById('main-container');
          
          await this.animateProgress(100);
          
          setTimeout(() => {
            console.log('🎯 Hiding loading screen...');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
              mainContainer.style.opacity = '1';
              console.log('✅ Application initialization completed');
              this.startProgressiveContentLoad();
            }, 300);
          }, 500);
        }
        
        async animateProgress(target) {
          return new Promise(resolve => {
            const animate = () => {
              if (this.progress < target) {
                this.progress += 2;
                const progressBar = document.getElementById('loading-progress');
                if (progressBar) {
                  progressBar.style.width = `${this.progress}%`;
                }
                requestAnimationFrame(animate);
              } else {
                resolve();
              }
            };
            animate();
          });
        }
        
        startProgressiveContentLoad() {
          console.log('📦 Additional modules loaded');
          
          // Show input content
          setTimeout(() => {
            const inputSkeleton = document.getElementById('input-skeleton');
            const inputContent = document.getElementById('input-content');
            if (inputSkeleton && inputContent) {
              inputSkeleton.style.display = 'none';
              inputContent.style.display = 'block';
              inputContent.classList.add('fade-in');
            }
            
            // Load progressive elements
            const progressiveElements = document.querySelectorAll('.progressive-load');
            progressiveElements.forEach((element, index) => {
              setTimeout(() => {
                element.classList.add('loaded');
              }, index * 200);
            });
          }, 500);
          
          // Initialize functionality
          this.initializeEventListeners();
        }
        
        initializeEventListeners() {
          // AI Analysis Button
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          const worryInput = document.getElementById('worryInput');
          
          if (aiGuessBtn && worryInput) {
            aiGuessBtn.addEventListener('click', () => {
              const inputText = worryInput.value.trim();
              if (inputText) {
                console.log('Starting analysis...');
                this.performAnalysis(inputText);
              } else {
                alert('入力テキストを入力してください。');
              }
            });
          }
          
          // Export buttons
          this.initializeExportButtons();
          
          // Choice cards
          this.initializeChoiceCards();
          
          console.log('✅ Event listeners initialized');
        }
        
        performAnalysis(inputText) {
          const resultArea = document.getElementById('resultArea');
          const resultsLoading = document.getElementById('results-loading');
          
          // Show loading
          if (resultArea && resultsLoading) {
            resultArea.classList.remove('hidden');
            resultsLoading.style.display = 'flex';
            
            // Simulate analysis
            setTimeout(() => {
              resultsLoading.style.display = 'none';
              this.displayResults(inputText);
              console.log('✅ Analysis completed');
            }, 2000);
          }
        }
        
        async displayResults(inputText) {
          console.log('🌟 正統易経システムによる分析開始');
          
          try {
            // 🔮 Step 1: Initialize Authentic I Ching Engine
            if (!this.authenticEngine) {
              this.authenticEngine = new AuthenticIChingEngine();
              console.log('✅ 正統易経エンジン初期化完了');
            }

            // 📊 Step 2: Identify current I Ching situation
            const currentSituation = this.authenticEngine.identifyCurrentSituation(inputText);
            console.log('🎯 現在状況特定:', currentSituation);

            // 🎯 Step 3: Initialize and display current position
            await this.initializeCurrentPositionDisplay(currentSituation);

            // ⚡ Step 4: Initialize and generate authentic choices
            await this.initializeAuthenticChoiceSystem(currentSituation);

            // 🌊 Step 5: Initialize and generate 8 authentic scenarios
            await this.initializeAuthentic8ScenariosSystem(currentSituation);

            console.log('✅ 正統易経システム分析完了');
            
            // 🎨 Generate I Ching-based state data for charts
            const currentState = this.generateIChingStateData(currentSituation);
            
          } catch (error) {
            console.error('❌ 正統易経システムエラー:', error);
            this.displayFallbackResults(inputText);
          }

          const samplePaths = [
            [
              { S7_総合評価スコア: 63 }, // 現在地
              { S7_総合評価スコア: 72 }, // フェーズ1
              { S7_総合評価スコア: 81 }, // フェーズ2
              { S7_総合評価スコア: 87 }  // フェーズ3
            ],
            [
              { S7_総合評価スコア: 63 },
              { S7_総合評価スコア: 68 },
              { S7_総合評価スコア: 75 },
              { S7_総合評価スコア: 79 }
            ],
            [
              { S7_総合評価スコア: 63 },
              { S7_総合評価スコア: 59 },
              { S7_総合評価スコア: 65 },
              { S7_総合評価スコア: 71 }
            ],
            [
              { S7_総合評価スコア: 63 },
              { S7_総合評価スコア: 57 },
              { S7_総合評価スコア: 52 },
              { S7_総合評価スコア: 48 }
            ],
            [
              { S7_総合評価スコア: 63 },
              { S7_総合評価スコア: 69 },
              { S7_総合評価スコア: 73 },
              { S7_総合評価スコア: 76 }
            ],
            [
              { S7_総合評価スコア: 63 },
              { S7_総合評価スコア: 61 },
              { S7_総合評価スコア: 58 },
              { S7_総合評価スコア: 54 }
            ],
            [
              { S7_総合評価スコア: 63 },
              { S7_総合評価スコア: 60 },
              { S7_総合評価スコア: 56 },
              { S7_総合評価スコア: 51 }
            ],
            [
              { S7_総合評価スコア: 63 },
              { S7_総合評価スコア: 58 },
              { S7_総合評価スコア: 53 },
              { S7_総合評価スコア: 47 }
            ]
          ];

          // Add I Ching transformation quality section
          this.addIChingQualitySection(inputText);

          // Ensure chart containers exist before rendering
          ensureChartContainers();

          // Wait for DOM operations to complete, then render charts
          setTimeout(() => {
            if (typeof Chart !== 'undefined') {
              try {
                // Ensure containers are in DOM
                ensureChartContainers();
                
                // Additional wait for DOM updates
                setTimeout(() => {
                  // Double-check containers exist
                  const currentChartCanvas = document.getElementById('currentStateBarChart');
                  const summaryChartCanvas = document.getElementById('summaryChart');
                  
                  console.log('🔍 Chart container check:', {
                    currentChart: !!currentChartCanvas,
                    summaryChart: !!summaryChartCanvas
                  });
                  
                  if (currentChartCanvas) {
                    renderCurrentStateBarChart(sampleCurrentState);
                    console.log('✅ Current state chart rendered');
                  } else {
                    console.warn('⚠️ Current state chart container not found after ensure');
                  }
                  
                  if (summaryChartCanvas) {
                    renderSummaryChart(samplePaths);
                    console.log('✅ Summary chart rendered');
                  } else {
                    console.warn('⚠️ Summary chart container not found after ensure');
                  }
                  
                  console.log('✅ Charts rendering completed');
                }, 200);
              } catch (error) {
                console.error('❌ Chart rendering error:', error);
              }
            } else {
              console.warn('⚠️ Chart.js not loaded, charts will not display');
            }
          }, 1000);
        }
        
        // 🎯 Initialize Current Position Display System
        async initializeCurrentPositionDisplay(currentSituation) {
          console.log('🎯 現在地表示システム初期化開始');
          
          const currentPositionContainer = document.getElementById('currentPositionContainer') || 
            this.createCurrentPositionContainer();
          
          if (!this.currentPositionDisplay) {
            this.currentPositionDisplay = new CurrentPositionDisplay(
              currentPositionContainer, 
              this.authenticEngine
            );
          }
          
          // Update display with current situation
          this.currentPositionDisplay.updatePosition(currentSituation);
          console.log('✅ 現在地表示完了');
        }

        // ⚡ Initialize Authentic Choice System
        async initializeAuthenticChoiceSystem(currentSituation) {
          console.log('⚡ 正統選択システム初期化開始');
          
          const choiceContainer = document.getElementById('choiceContainer') || 
            this.createChoiceContainer();
          
          if (!this.authenticChoiceSystem) {
            this.authenticChoiceSystem = new AuthenticChoiceSystem(
              choiceContainer, 
              this.authenticEngine
            );
          }
          
          // Generate and display choices
          this.authenticChoiceSystem.generateChoices(currentSituation);
          console.log('✅ 正統選択システム完了');
        }

        // 🌊 Initialize Authentic 8 Scenarios System
        async initializeAuthentic8ScenariosSystem(currentSituation) {
          console.log('🌊 8変化パターンシステム初期化開始');
          
          const scenariosContainer = document.getElementById('scenariosContainer') || 
            this.createScenariosContainer();
          
          if (!this.authentic8ScenariosSystem) {
            this.authentic8ScenariosSystem = new Authentic8ScenariosSystem(
              scenariosContainer, 
              this.authenticEngine
            );
          }
          
          // Generate 8 transformation patterns
          const patterns = this.authentic8ScenariosSystem.generate8TransformationPatterns(
            currentSituation.卦番号, 
            this.parseLinePosition(currentSituation.爻), 
            currentSituation
          );
          
          console.log('✅ 8変化パターンシステム完了');
        }
        
        analyzeTextForIChingPatterns(text) {
          // Text pattern analysis for I Ching concepts
          const patterns = {
            difficulty: ['うまくいかない', '困難', '問題', 'プレッシャー', '悩んで'],
            communication: ['コミュニケーション', 'チーム', 'メンバー'],
            leadership: ['責任者', '結果を出す', '改善'],
            stagnation: ['進まない', '思うように', '停滞'],
            transformation: ['どう', '改善', '変化', '方向性']
          };
          
          let score = 0;
          let interpretation = '';
          
          if (patterns.difficulty.some(p => text.includes(p))) {
            score += 0.3;
            interpretation += '困難な状況に直面している。';
          }
          
          if (patterns.stagnation.some(p => text.includes(p))) {
            score += 0.25;
            interpretation += '停滞感を感じている。';
          }
          
          if (patterns.transformation.some(p => text.includes(p))) {
            score += 0.2;
            interpretation += '変化を求めている。';
          }
          
          return {
            confidence: Math.min(score, 0.95),
            interpretation: interpretation || '状況の変化を模索している時期。'
          };
        }

        // 🛠️ Container Creation Methods
        createCurrentPositionContainer() {
          const container = document.createElement('div');
          container.id = 'currentPositionContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        createChoiceContainer() {
          const container = document.createElement('div');
          container.id = 'choiceContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        createScenariosContainer() {
          const container = document.createElement('div');
          container.id = 'scenariosContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        // 🔧 Utility Methods
        parseLinePosition(lineText) {
          const lineMap = {
            '初九': 1, '初六': 1,
            '九二': 2, '六二': 2,
            '九三': 3, '六三': 3,
            '九四': 4, '六四': 4,
            '九五': 5, '六五': 5,
            '上九': 6, '上六': 6
          };
          
          return lineMap[lineText] || 1;
        }

        displayFallbackResults(inputText) {
          console.log('🔄 フォールバック結果を表示');
          // Original fallback implementation would go here
        }
        
        // 📊 Display Current I Ching Position (Legacy - will be removed)
        displayCurrentPosition(position) {
          const currentPositionSection = document.createElement('div');
          currentPositionSection.className = 'mb-8 bg-gradient-to-r from-amber-900/30 to-yellow-900/30 border border-amber-500/30 rounded-lg p-6';
          currentPositionSection.innerHTML = `
            <div class="flex items-center mb-4">
              <span class="text-3xl mr-3">🎯</span>
              <h3 class="text-xl font-bold text-amber-300">現在地：易経による正確な位置特定</h3>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- 本卦情報 -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                  <span class="mr-2">📜</span>本卦（現在の状況）
                </h4>
                <div class="space-y-3">
                  <div class="text-center py-4 bg-gray-900/50 rounded-lg">
                    <div class="text-2xl font-bold text-amber-400">第${position.hexagram}卦 ${position.hexagramName}</div>
                    <div class="text-lg mt-2">
                      <span class="mr-4">${position.trigrams.upper.symbol} ${position.trigrams.upper.meaning}</span>
                      <span>${position.trigrams.lower.symbol} ${position.trigrams.lower.meaning}</span>
                    </div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">状況の象徴</div>
                    <div class="text-sm text-gray-300">${position.situation}</div>
                  </div>
                </div>
              </div>
              
              <!-- 変爻情報 -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-orange-400 mb-3 flex items-center">
                  <span class="mr-2">⚡</span>変爻（現在の焦点）
                </h4>
                <div class="space-y-3">
                  <div class="text-center py-4 bg-gray-900/50 rounded-lg">
                    <div class="text-xl font-bold text-orange-400">${position.lineType}${position.linePosition}爻</div>
                    <div class="text-sm text-gray-400 mt-1">第${position.line}爻（陽爻/陰爻：${position.lineType}）</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">爻辞</div>
                    <div class="text-sm text-gray-300 font-mono bg-gray-900/50 p-3 rounded">${position.fullLineText}</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">現在の意味</div>
                    <div class="text-sm text-gray-300">${position.interpretation}</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 変化の方向性 -->
            <div class="mt-6 bg-gray-800/30 rounded-lg p-4">
              <h4 class="text-md font-semibold text-blue-400 mb-3 flex items-center">
                <span class="mr-2">🔄</span>変化の方向性（${position.hexagramName} → ${position.resultHexagramName}）
              </h4>
              <div class="text-center">
                <div class="text-lg text-blue-300">
                  第${position.hexagram}卦 ${position.hexagramName} 
                  <span class="mx-4 text-yellow-400">→</span>
                  第${position.resultHexagram}卦 ${position.resultHexagramName}
                </div>
                <div class="mt-2 text-sm text-gray-400">
                  信頼度: ${Math.round(position.confidence * 100)}% （AI分析による）
                </div>
              </div>
            </div>
          `;
          
          // Insert at the beginning of results container
          const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
          if (resultsContainer) {
            resultsContainer.insertBefore(currentPositionSection, resultsContainer.firstChild);
          }
        }
        
        // ⚡ Generate Authentic I Ching Choices
        generateAuthenticChoices(position) {
          const choices = {
            pathA: {
              title: `爻辞に従う道：「${position.lineText}」を受け入れる`,
              description: `${position.fullLineText}の教えに従い、現状を素直に受け入れて適切な時期を待つ選択。`,
              keyword: position.lineText,
              approach: 'authentic',
              probability: 0.78,
              outcome: '段階的な改善と安定した成長'
            },
            pathB: {
              title: `爻辞に逆らう道：困難に正面から挑戦する`,
              description: `現在の停滞状況に積極的に抵抗し、強引にでも状況を変えようとする選択。`,
              keyword: '積極的抵抗',
              approach: 'resistance',
              probability: 0.45,
              outcome: '短期的な混乱の後に大きな変化の可能性'
            }
          };
          
          return choices;
        }
        
        // 🌊 Display Authentic I Ching Choices
        displayAuthenticChoices(choices) {
          // Update the existing choice cards with authentic I Ching content
          const choice1 = document.getElementById('choice1');
          const choice2 = document.getElementById('choice2');
          
          if (choice1) {
            choice1.innerHTML = `
              <h3 class="text-lg font-semibold text-green-400 mb-2">${choices.pathA.title}</h3>
              <p class="text-sm text-gray-300 mb-3">${choices.pathA.description}</p>
              <div class="flex justify-between items-center">
                <span class="text-xs text-green-300 bg-green-900/30 px-2 py-1 rounded">🔑 ${choices.pathA.keyword}</span>
                <span class="text-xs text-gray-400">成功率: ${Math.round(choices.pathA.probability * 100)}%</span>
              </div>
              <div class="mt-2 text-xs text-gray-400">${choices.pathA.outcome}</div>
            `;
          }
          
          if (choice2) {
            choice2.innerHTML = `
              <h3 class="text-lg font-semibold text-blue-400 mb-2">${choices.pathB.title}</h3>
              <p class="text-sm text-gray-300 mb-3">${choices.pathB.description}</p>
              <div class="flex justify-between items-center">
                <span class="text-xs text-blue-300 bg-blue-900/30 px-2 py-1 rounded">⚡ ${choices.pathB.keyword}</span>
                <span class="text-xs text-gray-400">成功率: ${Math.round(choices.pathB.probability * 100)}%</span>
              </div>
              <div class="mt-2 text-xs text-gray-400">${choices.pathB.outcome}</div>
            `;
          }
        }
        
        generateScenarios() {
          const hexagrams = [
            { 
              name: '天地否', 
              grade: 'A', 
              description: '最も好ましい展開。積極的な行動が良い結果をもたらします。',
              hexagramNumber: 12,
              line: 3,
              trigrams: { upper: '天', lower: '地' },
              interpretation: '閉塞から開通への転換点。困難な状況が好転する兆し。',
              lineText: '九三：包羞。包み隠された恥を受け入れる時。',
              advice: '現状を素直に受け入れ、新しい方向性を模索することが重要。'
            },
            { 
              name: '地天泰', 
              grade: 'B', 
              description: '良好な展開。慎重に進めば成功の可能性が高いです。',
              hexagramNumber: 11,
              line: 2,
              trigrams: { upper: '地', lower: '天' },
              interpretation: '天地交通の象。上下の調和が取れた安定した状態。',
              lineText: '九二：包荒。荒野をも包容する大きな心。',
              advice: '調和を重視し、周囲との協調を大切にしながら進む。'
            },
            { 
              name: '山地剥', 
              grade: 'C', 
              description: '標準的な展開。現状維持で安定した結果が期待できます。',
              hexagramNumber: 23,
              line: 4,
              trigrams: { upper: '山', lower: '地' },
              interpretation: '剥落の時。古いものが剥がれ落ち、新しいものが生まれる準備期。',
              lineText: '六四：剥床以膚。床まで剥がれる深刻な状況。',
              advice: '無理に抵抗せず、自然の流れに任せることが得策。'
            },
            { 
              name: '地山謙', 
              grade: 'D', 
              description: '注意が必要な展開。慎重な判断が求められます。',
              hexagramNumber: 15,
              line: 1,
              trigrams: { upper: '地', lower: '山' },
              interpretation: '謙遜の美徳。高い山も地に謙る姿勢の大切さ。',
              lineText: '初六：謙謙君子。謙遜に謙遜を重ねる君子の姿勢。',
              advice: '慢心を戒め、常に学ぶ姿勢を保つことが成功の秘訣。'
            },
            { 
              name: '雷地豫', 
              grade: 'B', 
              description: '良好な展開。タイミングを見極めることが重要です。',
              hexagramNumber: 16,
              line: 5,
              trigrams: { upper: '雷', lower: '地' },
              interpretation: '楽しみと準備の調和。適切な準備があってこそ真の喜びがある。',
              lineText: '六五：貞疾恒不死。病気でも正しく生きれば死なない。',
              advice: 'タイミングを見極め、準備を怠らないことが重要。'
            },
            { 
              name: '地雷復', 
              grade: 'C', 
              description: '標準的な展開。協調性を大切にすることで道が開けます。',
              hexagramNumber: 24,
              line: 6,
              trigrams: { upper: '地', lower: '雷' },
              interpretation: '復帰と再生の象。一陽来復、新しい始まり。',
              lineText: '上六：迷復。迷いながらも復帰を目指す。',
              advice: '過去の経験を活かし、新しいスタートを切る好機。'
            },
            { 
              name: '沢地萃', 
              grade: 'D', 
              description: '注意が必要な展開。計画的な行動を心がけましょう。',
              hexagramNumber: 45,
              line: 3,
              trigrams: { upper: '沢', lower: '地' },
              interpretation: '集合の象。同じ志を持つ者が集まる時。',
              lineText: '六三：萃如嗟如。集まりたいが嘆息する複雑な心境。',
              advice: '慎重に仲間を選び、目標を明確にしてから行動する。'
            },
            { 
              name: '地沢臨', 
              grade: 'E', 
              description: '困難な展開。忍耐強く取り組むことで突破口が見つかります。',
              hexagramNumber: 19,
              line: 2,
              trigrams: { upper: '地', lower: '沢' },
              interpretation: '臨む象。上位者が下位者に臨む、指導と監督の時。',
              lineText: '九二：咸臨吉無不利。感化によって臨めば吉、利しからざるなし。',
              advice: '忍耐強く取り組み、周囲への良い影響を与えることを心がける。'
            }
          ];
          
          return hexagrams;
        }
        
        createScenarioCard(scenario, index) {
          const card = document.createElement('div');
          card.className = 'card bg-gray-800/50 border border-gray-600/50 p-4 rounded-lg hover:border-indigo-400 transition-all duration-300';
          
          const gradeClass = `rank-${scenario.grade.toLowerCase()}`;
          
          card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-bold text-indigo-300">シナリオ${index}</h3>
              <div class="rank-badge ${gradeClass}">${scenario.grade}級</div>
            </div>
            
            <!-- 卦名と基本情報 -->
            <div class="mb-3">
              <div class="text-sm font-semibold text-yellow-300 mb-1">${scenario.name} (第${scenario.hexagramNumber}卦)</div>
              <div class="text-xs text-gray-400 mb-2">
                <span class="inline-block mr-3">☰ ${scenario.trigrams.upper}</span>
                <span class="inline-block">☷ ${scenario.trigrams.lower}</span>
              </div>
            </div>
            
            <!-- 易経解釈 -->
            <div class="mb-3">
              <div class="text-xs text-emerald-400 font-medium mb-1">📚 卦の解釈</div>
              <p class="text-xs text-gray-300 mb-2">${scenario.interpretation}</p>
            </div>
            
            <!-- 爻辞 -->
            <div class="mb-3">
              <div class="text-xs text-orange-400 font-medium mb-1">📜 爻辞 (第${scenario.line}爻)</div>
              <p class="text-xs text-gray-300 mb-2 font-mono bg-gray-900/50 p-2 rounded">${scenario.lineText}</p>
            </div>
            
            <!-- アドバイス -->
            <div class="mb-3">
              <div class="text-xs text-blue-400 font-medium mb-1">💡 アドバイス</div>
              <p class="text-xs text-gray-300">${scenario.advice}</p>
            </div>
            
            <!-- 展開予測 -->
            <div class="border-t border-gray-600 pt-2 mt-3">
              <p class="text-xs text-gray-300">${scenario.description}</p>
            </div>
          `;
          
          return card;
        }
        
        addIChingQualitySection(inputText) {
          // Add I Ching transformation quality analysis section
          const resultsContainer = document.querySelector('.results-container');
          if (!resultsContainer) return;

          const qualitySection = document.createElement('div');
          qualitySection.className = 'mb-8 bg-gradient-to-r from-purple-900/30 to-indigo-900/30 border border-purple-500/30 rounded-lg p-6';
          
          qualitySection.innerHTML = `
            <div class="flex items-center mb-4">
              <span class="text-2xl mr-3">🔮</span>
              <h3 class="text-xl font-bold text-purple-300">易経変換品質分析</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- 現在の状況分析 -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                  <span class="mr-2">🎯</span>現在の状況
                </h4>
                <div class="space-y-3">
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">分析対象</div>
                    <div class="text-sm text-gray-300 bg-gray-900/50 p-3 rounded font-mono">"${inputText.substring(0, 100)}..."</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">本卦 (現状)</div>
                    <div class="text-sm text-emerald-400">第12卦 天地否 ☰☷</div>
                    <div class="text-xs text-gray-400 mt-1">天地が交わらない閉塞の時。変化の前触れ。</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">変爻</div>
                    <div class="text-sm text-orange-400">九三爻 (第3爻)</div>
                    <div class="text-xs text-gray-400 mt-1">「包羞」- 恥を包み隠す時。転換点の象徴。</div>
                  </div>
                </div>
              </div>
              
              <!-- 変化の方向性 -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-blue-400 mb-3 flex items-center">
                  <span class="mr-2">🔄</span>変化の方向性
                </h4>
                <div class="space-y-3">
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">之卦 (変化後)</div>
                    <div class="text-sm text-blue-400">第25卦 天雷无妄 ☰☳</div>
                    <div class="text-xs text-gray-400 mt-1">天の雷動。正しい道への回帰と純真な行動。</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">変化の質</div>
                    <div class="flex items-center space-x-2">
                      <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                      <span class="text-sm text-green-400">正変化 (85%信頼度)</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">困難から解放への健全な変化パターン</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">推奨行動</div>
                    <div class="text-sm text-gray-300">
                      • 現状を素直に受け入れる<br>
                      • 新しい方向性を模索する<br>
                      • 無理な抵抗は避ける
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 易経解釈の信頼性 -->
            <div class="mt-6 bg-gray-800/30 rounded-lg p-4">
              <h4 class="text-md font-semibold text-indigo-400 mb-3 flex items-center">
                <span class="mr-2">📊</span>解釈の信頼性
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-400">85%</div>
                  <div class="text-xs text-gray-400">卦の適合度</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400">78%</div>
                  <div class="text-xs text-gray-400">文脈理解度</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-yellow-400">92%</div>
                  <div class="text-xs text-gray-400">予測精度</div>
                </div>
              </div>
              <div class="mt-3 text-xs text-gray-400 text-center">
                ※ AIによる分析結果。易経の伝統的解釈に基づく参考値です。
              </div>
            </div>
          `;
          
          // Insert at the beginning of results container
          resultsContainer.insertBefore(qualitySection, resultsContainer.firstChild);
        }
        
        initializeExportButtons() {
          const exportJson = document.getElementById('exportJson');
          const exportCsv = document.getElementById('exportCsv');
          const exportPdf = document.getElementById('exportPdf');
          
          if (exportJson) {
            exportJson.addEventListener('click', () => {
              console.log('JSON export requested');
              // Implement JSON export
            });
          }
          
          if (exportCsv) {
            exportCsv.addEventListener('click', () => {
              console.log('CSV export requested');
              // Implement CSV export
            });
          }
          
          if (exportPdf) {
            exportPdf.addEventListener('click', () => {
              console.log('PDF export requested');
              // Implement PDF export
            });
          }
        }
        
        initializeChoiceCards() {
          const choice1 = document.getElementById('choice1');
          const choice2 = document.getElementById('choice2');
          
          if (choice1) {
            choice1.addEventListener('click', () => {
              choice1.classList.add('highlighted');
              if (choice2) {
                choice2.classList.remove('highlighted');
              }
            });
          }
          
          if (choice2) {
            choice2.addEventListener('click', () => {
              choice2.classList.add('highlighted');
              if (choice1) {
                choice1.classList.remove('highlighted');
              }
            });
          }
        }
      }
      
      // Chart.js instances
      let summaryChartInstance = null;
      let currentStateBarChartInstance = null;
      let currentAnalysisData = {}; // Current analysis results holder

      // Render current status bar graph (horizontal bar)
      function renderCurrentStateBarChart(state) {
        if (currentStateBarChartInstance) { 
          currentStateBarChartInstance.destroy(); 
        }
        const ctx = document.getElementById("currentStateBarChart").getContext("2d");
        if (!ctx) return;
        
        const data = [ 
          state.S1_基本スコア, 
          state.S2_ポテンシャル, 
          state.S3_安定性スコア, 
          Math.abs(state.S4_リスク), 
          state.S6_変動性スコア 
        ];
        const colors = [ 
          "rgba(96, 165, 250, 0.8)", 
          "rgba(52, 211, 153, 0.8)", 
          "rgba(167, 139, 250, 0.8)", 
          "rgba(248, 113, 113, 0.8)", 
          "rgba(251, 191, 36, 0.8)"
        ];
        
        currentStateBarChartInstance = new Chart(ctx, { 
          type: "bar", 
          data: { 
            labels: ["基本", "潜在力", "安定性", "リスク", "変動性"], 
            datasets: [{ 
              data: data, 
              backgroundColor: colors, 
              borderWidth: 0, 
              barPercentage: 0.8, 
              categoryPercentage: 0.9
            }] 
          }, 
          options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            indexAxis: "y", 
            scales: { 
              x: { 
                display: true, 
                min: 0, 
                max: 100, 
                grid: { color: "rgba(255, 255, 255, 0.1)" }, 
                ticks: { color: "#9ca3af", font: { size: 10 } } 
              }, 
              y: { 
                grid: { display: false, drawBorder: false }, 
                ticks: { color: "#e5e7eb", font: { size: 12, weight: "500" } } 
              } 
            }, 
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                enabled: true, 
                callbacks: { 
                  label: function (context) { 
                    let label = context.dataset.label || ""; 
                    if (label) { 
                      label += ": "; 
                    } 
                    if (context.parsed.x !== null) { 
                      label += context.parsed.x; 
                    } 
                    return label; 
                  } 
                } 
              } 
            } 
          } 
        });
      }

      // Render future scenario summary line chart
      function renderSummaryChart(sortedPaths) {
        if (summaryChartInstance) summaryChartInstance.destroy();
        const ctx = document.getElementById("summaryChart").getContext("2d");
        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];
        const currentScore = sortedPaths[0][0].S7_総合評価スコア;
        
        const datasets = sortedPaths.map((path, index) => { 
          const isTop = index < 4; 
          const color = isTop ? topColors[index] : bottomColors[index - 4]; 
          return { 
            label: `シナリオ ${index + 1}`,
            data: path.map((p) => p.S7_総合評価スコア), 
            borderColor: color, 
            originalBorderColor: color, 
            borderWidth: isTop ? 3.5 : 1.5, 
            originalBorderWidth: isTop ? 3.5 : 1.5, 
            tension: 0.1, 
            pointRadius: 4, 
            pointBackgroundColor: "white", 
            originalPointBackgroundColor: "white", 
            pointHoverRadius: 6
          }; 
        });
        
        summaryChartInstance = new Chart(ctx, { 
          type: "line", 
          data: { 
            labels: ["現在地", "フェーズ1", "フェーズ2", "フェーズ3"], 
            datasets: datasets
          }, 
          options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { 
              y: { 
                min: 0, 
                max: 100, 
                ticks: { color: "#9ca3af" }, 
                grid: { color: "rgba(255, 255, 255, 0.1)" } 
              }, 
              x: { 
                ticks: { color: "#9ca3af" }, 
                grid: { color: "rgba(255, 255, 255, 0.1)" } 
              } 
            }, 
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                mode: "index", 
                intersect: false, 
                callbacks: { 
                  label: function (context) { 
                    return null; 
                  } 
                } 
              }, 
              annotation: { 
                annotations: { 
                  currentScoreLine: { 
                    type: "line", 
                    yMin: currentScore, 
                    yMax: currentScore, 
                    borderColor: "rgb(253, 224, 71)", 
                    borderWidth: 2, 
                    borderDash: [6, 6], 
                    label: { 
                      content: "現在地のスコア", 
                      enabled: true, 
                      position: "end", 
                      backgroundColor: "rgba(253, 224, 71, 0.8)", 
                      color: "black", 
                      font: { size: 10 } 
                    } 
                  } 
                } 
              } 
            } 
          } 
        });
      }

      // Highlight specific scenario in chart
      function highlightScenario(index) {
        if (summaryChartInstance) { 
          summaryChartInstance.data.datasets.forEach((dataset, i) => { 
            if (i === index) { 
              dataset.borderWidth = 5; 
              dataset.borderColor = dataset.originalBorderColor; 
              dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; 
            } else { 
              dataset.borderWidth = 1; 
              dataset.borderColor = "rgba(107, 114, 128, 0.5)"; 
              dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; 
            } 
          }); 
          summaryChartInstance.update("none"); 
        }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { 
          el.classList.remove("highlighted"); 
        });
        document.getElementById(`card-${index}`)?.classList.add("highlighted");
        document.querySelector(`.toggle-label[data-index='${index}']`)?.classList.add("highlighted");
      }

      // Reset chart highlights
      function resetChartHighlights() {
        if (summaryChartInstance) { 
          summaryChartInstance.data.datasets.forEach((dataset) => { 
            dataset.borderWidth = dataset.originalBorderWidth; 
            dataset.borderColor = dataset.originalBorderColor; 
            dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; 
          }); 
          summaryChartInstance.update("none"); 
        }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { 
          el.classList.remove("highlighted"); 
        });
      }

      // Add chart containers to HTML if they don't exist
      function ensureChartContainers() {
        console.log('🔧 Ensuring chart containers exist...');
        
        // Add current state chart container
        if (!document.getElementById('currentStateBarChart')) {
          console.log('📊 Adding current state chart container...');
          const currentChartContainer = document.createElement('div');
          currentChartContainer.className = 'mb-6';
          currentChartContainer.innerHTML = `
            <h3 class="text-lg font-bold mb-3 text-indigo-300">📊 現在地のグラフ</h3>
            <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-4">
              <canvas id="currentStateBarChart" height="200"></canvas>
            </div>
          `;
          
          // Insert after the "現在地のグラフ" heading if it exists
          const currentGraphHeading = document.querySelector('h3[text*="現在地のグラフ"]') || 
                                     Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes('現在地のグラフ'));
          if (currentGraphHeading && currentGraphHeading.parentNode) {
            currentGraphHeading.parentNode.insertBefore(currentChartContainer, currentGraphHeading.nextSibling);
          } else {
            // Fallback: Insert in results container
            const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
            if (resultsContainer) {
              const firstElement = resultsContainer.querySelector('*');
              if (firstElement) {
                resultsContainer.insertBefore(currentChartContainer, firstElement);
              } else {
                resultsContainer.appendChild(currentChartContainer);
              }
            }
          }
          console.log('✅ Current state chart container added');
        } else {
          console.log('✅ Current state chart container already exists');
        }

        // Add summary chart container
        if (!document.getElementById('summaryChart')) {
          console.log('📈 Adding summary chart container...');
          const summaryChartContainer = document.createElement('div');
          summaryChartContainer.className = 'mb-6';
          summaryChartContainer.innerHTML = `
            <h3 class="text-lg font-bold mb-3 text-indigo-300">🔮 未来分岐グラフ</h3>
            <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-4">
              <canvas id="summaryChart" height="300"></canvas>
            </div>
          `;
          
          // Find a good location - after choice cards and before scenario grid
          const choiceCards = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.gap-4') ||
                             document.querySelector('[class*="choice"]') ||
                             document.querySelector('h2[text*="選択"]');
          const scenarioGrid = document.getElementById('scenarioGrid') ||
                              document.querySelector('h2[text*="シナリオ"]');
          
          if (scenarioGrid && scenarioGrid.parentNode) {
            scenarioGrid.parentNode.insertBefore(summaryChartContainer, scenarioGrid);
            console.log('✅ Summary chart container added before scenario grid');
          } else if (choiceCards && choiceCards.parentNode) {
            choiceCards.parentNode.insertBefore(summaryChartContainer, choiceCards.nextSibling);
            console.log('✅ Summary chart container added after choice cards');
          } else {
            // Fallback: Insert in results container
            const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
            if (resultsContainer) {
              resultsContainer.appendChild(summaryChartContainer);
              console.log('✅ Summary chart container added to results container');
            }
          }
        } else {
          console.log('✅ Summary chart container already exists');
        }
        
        console.log('🏁 Chart containers setup completed');
      }

      // Initialize when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded - Starting initialization...');
        
        // Ensure chart containers exist
        ensureChartContainers();
        
        new ProgressiveLoader();
        console.log('✅ Future Simulator ready!');
      });
    </script>
  </body>
</html>