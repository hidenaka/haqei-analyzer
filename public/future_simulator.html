<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei マルチバース・アナライザー</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>易</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/1.4.0/chartjs-plugin-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      .card:hover,
      .card.highlighted {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      .rank-badge {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 9999px;
        line-height: 1;
      }
      .rank-s,
      .rank-a,
      .rank-b,
      .rank-c {
        background-color: rgba(74, 222, 128, 0.2);
        color: #86efac;
        border: 1px solid #4ade80;
      }
      .rank-d,
      .rank-e,
      .rank-f,
      .rank-g {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .rank-h {
        background-color: rgba(185, 28, 28, 0.2);
        color: #fca5a5;
        border: 1px solid #dc2626;
      }
      .toggle-label {
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 6px;
        border: 1px solid transparent;
        transition: background-color 0.2s, border-color 0.2s, transform 0.2s;
      }
      .toggle-label:hover,
      .toggle-label.highlighted {
        transform: scale(1.1);
      }
      .toggle-legend {
        width: 12px;
        height: 12px;
        border-radius: 2px;
        margin-right: 6px;
      }
      .modal-overlay {
        transition: opacity 0.3s ease;
      }
      .modal-content {
        transition: transform 0.3s ease;
      }
      .eval-label {
        display: inline-block;
        padding: 2px 10px;
        border-radius: 9999px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-left: 10px;
      }
      .trend-badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 6px;
        width: 100%;
        text-align: center;
      }
      .trend-up {
        background-color: rgba(52, 211, 153, 0.2);
        color: #6ee7b7;
        border: 1px solid #34d399;
      }
      .trend-invest {
        background-color: rgba(96, 165, 250, 0.2);
        color: #93c5fd;
        border: 1px solid #60a5fa;
      }
      .trend-stable {
        background-color: rgba(209, 213, 219, 0.2);
        color: #d1d5db;
        border: 1px solid #9ca3af;
      }
      .trend-stagnate {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #fbbf24;
      }
      .trend-down {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .trend-risk-mgmt {
        background-color: rgba(167, 139, 250, 0.2);
        color: #c4b5fd;
        border: 1px solid #a78bfa;
      }
      .trend-recovery {
        background-color: rgba(34, 197, 94, 0.2);
        color: #86efac;
        border: 1px solid #4ade80;
      }
      .yong-yao-step {
        background: linear-gradient(
          145deg,
          rgba(55, 48, 163, 0.2),
          rgba(129, 140, 248, 0.1)
        );
        border: 1px solid #a5b4fc;
        border-radius: 0.75rem;
        box-shadow: 0 0 20px rgba(165, 180, 252, 0.2);
        margin-top: 1rem;
        margin-bottom: 1rem;
      }
      .yong-yao-transition {
        background-color: rgba(253, 224, 71, 0.1);
        border: 1px solid rgba(253, 224, 71, 0.4);
        color: #fde047;
      }
      .yong-yao-title-icon {
        color: #fde047;
        font-size: 1.1em;
        margin-left: 0.5rem;
        text-shadow: 0 0 10px #facc15;
      }
      .diff-up {
        color: #6ee7b7;
      }
      .diff-down {
        color: #fca5a5;
      }
      .diff-zero {
        color: #9ca3af;
      }
      .full-text {
        white-space: normal;
        overflow: visible;
        text-overflow: clip;
      }
      #aiReasoningContainer {
        border-left: 3px solid #a5b4fc;
        background: rgba(165, 180, 252, 0.05);
      }
      .deep-dive-btn {
        background: linear-gradient(
          145deg,
          rgba(253, 224, 71, 0.8),
          rgba(251, 146, 60, 0.8)
        );
        color: #111827;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(253, 224, 71, 0.2);
      }
      .deep-dive-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(253, 191, 36, 0.4);
      }
      .future-contents-reveal {
        opacity: 1 !important;
      }
      .ai-recommended {
        transform: scale(1.03);
        box-shadow: 0 0 35px rgba(74, 222, 128, 0.5),
          0 0 0 3px rgba(74, 222, 128, 0.6);
        border-color: rgba(74, 222, 128, 0.6) !important;
      }
      .dimmed-by-choice {
        opacity: 0.4;
        transform: scale(0.98);
      }
    </style>
    <script src="./js/koudo_shishin_database.js"></script>
    <script src="./js/ai_theme_database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js"></script>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6">
    <div
      class="w-full max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8"
    >
      <header class="text-center mb-8 relative">
        <a href="./" class="inline-block">
          <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
            HaQei
          </h1>
          <p class="text-gray-400 mt-2 text-lg">マルチバース・アナライザー</p>
        </a>
        <button
          id="helpBtn"
          class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.25l-2.536 2.39c-.832.786-1.464 1.49-1.464 2.36h.001M12 18h.01"
            />
          </svg>
        </button>
      </header>

      <div class="bg-gray-900/50 p-6 rounded-xl mb-4">
        <h2 class="text-lg font-bold text-indigo-300 mb-3">
          1. AIによる状況推測
        </h2>
        <div
          class="border border-gray-700 rounded-lg p-4 mb-4 text-sm text-gray-300 space-y-3"
        >
          <p class="text-base font-bold text-center text-indigo-300">
            AIへの最高の「呪文」は、あなたの「ありのままの言葉」です
          </p>
          <p class="text-xs text-center text-gray-400">
            未来分岐図の精度を高める、たった一つの秘訣
          </p>
          <p>
            これから、あなたの現状と課題をAIに入力していただきます。その際、どうか<strong>「上手な文章を書こう」としないでください。</strong>AIは、整えられた文章よりも、あなたの<strong>「生の言葉」</strong>を求めています。
          </p>
          <p>
            箇条書きでも、心のつぶやきでも、誰かに愚痴をこぼすような言葉でも構いません。他人に見せるための文章ではなく、<strong>あなた自身のための「思考のメモ」</strong>として、リラックスして入力してください。
          </p>
          <p>
            なぜなら、AIはあなたが選ぶ一つ一つの単語、表現の揺れ、感情のニュアンスから、あなただけの「思考のクセ」や「心の動き」を読み取るからです。
          </p>
          <div class="pt-2">
            <p class="font-bold text-gray-200">【入力のヒント】</p>
            <div
              class="mt-2 p-3 rounded-lg bg-red-900/20 border border-red-800/50"
            >
              <p class="font-bold">悪い例 ❌</p>
              <p class="text-xs italic mt-1">
                「新規プロジェクトのマネジメントにおいて、人的リソースの不足がボトルネックとなり、計画に遅延が生じています。」
              </p>
              <p class="text-xs text-gray-400 mt-1">
                （これでは、AIは一般的なビジネス課題としてしか分析できません）
              </p>
            </div>
            <div
              class="mt-2 p-3 rounded-lg bg-emerald-900/20 border border-emerald-800/50"
            >
              <p class="font-bold">良い例 ⭕</p>
              <p class="text-xs italic mt-1">
                「新しい仕事、マジで人足りてない！Aさんは頑張ってくれてるけど、Bさんは全然やる気ないし…。このままだと絶対間に合わない。どうすりゃいいんだ…。焦る。」
              </p>
              <p class="text-xs text-gray-400 mt-1">
                （この方が、あなたの感情、人間関係への認識、切迫感が伝わり、よりパーソナライズされた分析が可能になります）
              </p>
            </div>
          </div>
          <p class="font-bold text-center pt-2">
            あなたの「ありのままの言葉」こそが、あなただけの未来を読み解く、最も強力な鍵となります。<br />どうぞ、あなたの心をそのまま、AIにぶつけてみてください。
          </p>
        </div>
        <textarea
          id="worryInput"
          class="bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 mb-4"
          rows="4"
          placeholder="ここにあなたの「生の言葉」を入力してください..."
        ></textarea>
        <button
            id="aiGuessBtn"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 flex items-center justify-center gap-2"
          >
            <svg class="animate-spin h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg
              id="originalIcon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                clip-rule="evenodd"
              />
            </svg>
            <span id="buttonText">AIに状況を推測させる</span>
          </button>
      </div>

      <div class="bg-gray-900/50 p-6 rounded-xl mb-8 space-y-4">
    
    <details class="group">
        <summary class="text-sm text-center text-indigo-400 hover:text-indigo-300 cursor-pointer transition-colors">
            または、状況卦と爻を手動で指定して予測する
        </summary>
        <div class="mt-4 pt-4 border-t border-gray-700 flex flex-col sm:flex-row items-center justify-center gap-4">
            <div>
                <label for="hexagramInput" class="block text-sm font-medium text-gray-300 mb-1">状況卦（番号または名前）</label>
                <input type="text" id="hexagramInput" list="hexagram-names" class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 text-center" placeholder="例: 3">
            </div>
            <div>
                <label for="lineInput" class="block text-sm font-medium text-gray-300 mb-1">現在の爻（1～6）</label>
                <input type="number" id="lineInput" min="1" max="6" class="bg-gray-700 border border-gray-600 text-white text-lg rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-3 text-center" placeholder="例: 1">
            </div>
            <button id="manualAnalyzeBtn" class="w-full sm:w-auto mt-4 sm:mt-0 sm:self-end bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-lg text-lg transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                予測実行
            </button>
        </div>
    </details>

    <div class="pt-4 border-t border-gray-700 text-center">
        <label class="flex items-center justify-center cursor-pointer">
            <input type="checkbox" id="agreementCheckbox" class="h-4 w-4 rounded bg-gray-700 border-gray-600 text-indigo-600 focus:ring-indigo-500">
            <span class="ml-2 text-sm text-gray-400">
                <a href="/terms.html" target="_blank" class="underline hover:text-white">利用規約</a>および<a href="/privacy.html" target="_blank" class="underline hover:text-white">プライバシーポリシー</a>に同意します
            </span>
        </label>
    </div>
</div>

      <div id="resultArea" class="hidden">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start mb-12">
          <div class="lg:col-span-1">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              分析サマリー
            </h2>
            <div class="space-y-4">
              <div
                id="summaryCard"
                class="p-4 rounded-lg border border-gray-600/50 bg-gray-900/30"
              >
                <div
                  class="bg-yellow-400/10 border-l-4 border-yellow-400 p-3 rounded-md"
                >
                  <h4
                    id="currentTitle"
                    class="text-lg font-semibold text-yellow-300"
                  ></h4>
                  <p
                    id="currentKeywords"
                    class="text-sm text-yellow-200 mt-1"
                  ></p>
                  <p id="currentSummary" class="text-gray-300 mt-2 text-sm"></p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <h4 class="font-bold text-gray-300">現在地の総合評価</h4>
                  <div class="flex items-baseline">
                    <p id="currentScore" class="text-3xl font-bold"></p>
                    <span id="currentScoreLabel"></span>
                  </div>
                  <p id="currentScoreDesc" class="text-xs"></p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <h4 class="font-bold text-gray-300">
                    今回の変化のしやすさ (移行コスト)
                  </h4>
                  <div class="flex items-baseline">
                    <p id="transitionCost" class="text-3xl font-bold"></p>
                    <span id="transitionCostLabel"></span>
                  </div>
                  <p id="transitionCostDesc" class="text-xs"></p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <div class="flex items-center justify-between mb-2">
                    <h4 class="font-bold text-gray-300">現在地のグラフ</h4>
                    <button
                      id="paramHelpBtn"
                      class="text-yellow-400 hover:text-yellow-300 text-xl cursor-pointer"
                      title="グラフの見方"
                    >
                      <span
                        style="
                          display: inline-block;
                          transform: translateY(-2px);
                        "
                      >
                        ⭐️
                      </span>
                    </button>
                  </div>
                  <div
                    class="relative"
                    style="height: 150px; padding-left: 5px"
                  >
                    <canvas id="currentStateBarChart"></canvas>
                  </div>
                </div>
                <div id="firstActionContainer" class="mt-4"></div>
              </div>
            </div>
          </div>
          <div class="lg:col-span-2 bg-gray-900/50 p-6 rounded-xl">
            <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
              未来分岐グラフ：総合評価の推移
            </h2>
            <div
              id="aiReasoningContainer"
              class="mb-4 p-4 rounded-lg hidden"
            ></div>
            <div class="relative" style="height: 400px">
              <canvas id="summaryChart"></canvas>
            </div>
            <div
              id="chartToggles"
              class="grid grid-cols-2 md:grid-cols-4 gap-3 mt-4"
            ></div>
          </div>
        </div>

        <div id="revealButtonContainer" class="text-center mt-8 hidden">
          <button
            id="revealButton"
            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 transform hover:scale-105 shadow-lg"
          >
            未来への選択肢と、8つの全シナリオを見る
          </button>
        </div>

        <div
          id="futureContentsWrapper"
          class="hidden opacity-0 transition-opacity duration-1000"
        >
          <div id="futureChoiceContainer" class="my-12">
            <h2 class="text-2xl font-bold mb-6 text-center text-indigo-300">
              最初の選択：あなたはどちらの道を選ぶか？
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div id="choiceCardShin" data-choice="stagnate" class="card p-6 rounded-xl border-2 border-transparent transition-all duration-300 bg-gray-900/50 hover:border-teal-500 hover:shadow-lg hover:shadow-teal-500/10"></div>
              <div id="choiceCardHen" data-choice="change" class="card p-6 rounded-xl border-2 border-transparent transition-all duration-300 bg-gray-900/50 hover:border-purple-500 hover:shadow-lg hover:shadow-purple-500/10"></div>
              ></div>
            </div>
          </div>

          <div>
            <h2 class="text-2xl font-bold mb-2 text-center text-indigo-300">
              8つの未来シナリオ
            </h2>
            <p
              id="aiRecommendationMessage"
              class="text-center text-amber-300 mb-6 hidden"
            ></p>
            <div
              id="detailCardsContainer"
              class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6"
            ></div>
          </div>
        </div>
      </div>

      <div id="initialMessage" class="text-center py-12">
        <p class="text-xl text-gray-500">
          まずは、あなたの「ありのままの言葉」を、<br />上のテキストボックスに入力してください。
        </p>
      </div>
    </div>

    <div
      id="modalContainer"
      class="fixed inset-0 z-50 flex items-center justify-center hidden"
    >
      <div
        id="modalOverlay"
        class="absolute inset-0 bg-black/70 modal-overlay opacity-0"
      ></div>
      <div
        id="modalContent"
        class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-2xl max-h-[80vh] overflow-y-auto p-8 relative transform scale-95"
      >
        <button
          id="modalCloseBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <div id="modalBody"></div>
      </div>
    </div>

    <datalist id="hexagram-names"></datalist>

    
    <script type="module">
      window.H384_CONTEXT_TYPE_LIST = [
          { "通し番号": 1, "context_type": "nascent" },
          { "通し番号": 2, "context_type": "growth" },
          { "通し番号": 3, "context_type": "caution" },
          { "通し番号": 4, "context_type": "struggle" },
          { "通し番号": 5, "context_type": "completion" },
          { "通し番号": 6, "context_type": "decline" },
          { "通し番号": 7, "context_type": "completion" },
          { "通し番号": 8, "context_type": "nascent" },
          { "通し番号": 9, "context_type": "stable" },
          { "通し番号": 10, "context_type": "stable" },
          { "通し番号": 11, "context_type": "caution" },
          { "通し番号": 12, "context_type": "completion" },
          { "通し番号": 13, "context_type": "decline" },
          { "通し番号": 14, "context_type": "stable" },
          { "通し番号": 15, "context_type": "struggle" },
          { "通し番号": 16, "context_type": "struggle" },
          { "通し番号": 17, "context_type": "caution" },
          { "通し番号": 18, "context_type": "growth" },
          { "通し番号": 19, "context_type": "caution" },
          { "通し番号": 20, "context_type": "decline" },
          { "通し番号": 21, "context_type": "nascent" },
          { "通し番号": 22, "context_type": "completion" },
          { "通し番号": 23, "context_type": "caution" },
          { "通し番号": 24, "context_type": "decline" },
          { "通し番号": 25, "context_type": "stable" },
          { "通し番号": 26, "context_type": "caution" },
          { "通し番号": 27, "context_type": "stable" },
          { "通し番号": 28, "context_type": "stable" },
          { "通し番号": 29, "context_type": "struggle" },
          { "通し番号": 30, "context_type": "growth" },
          { "通し番号": 31, "context_type": "stable" },
          { "通し番号": 32, "context_type": "growth" },
          { "通し番号": 33, "context_type": "conflict" },
          { "通し番号": 34, "context_type": "caution" },
          { "通し番号": 35, "context_type": "stable" },
          { "通し番号": 36, "context_type": "growth" },
          { "通し番号": 37, "context_type": "completion" },
          { "通し番号": 38, "context_type": "decline" },
          { "通し番号": 39, "context_type": "nascent" },
          { "通し番号": 40, "context_type": "completion" },
          { "通し番号": 41, "context_type": "decline" },
          { "通し番号": 42, "context_type": "stable" },
          { "通し番号": 43, "context_type": "caution" },
          { "通し番号": 44, "context_type": "completion" },
          { "通し番号": 45, "context_type": "nascent" },
          { "通し番号": 46, "context_type": "stable" },
          { "通し番号": 47, "context_type": "conflict" },
          { "通し番号": 48, "context_type": "growth" },
          { "通し番号": 49, "context_type": "completion" },
          { "通し番号": 50, "context_type": "decline" },
          { "通し番号": 51, "context_type": "growth" },
          { "通し番号": 52, "context_type": "stable" },
          { "通し番号": 53, "context_type": "conflict" },
          { "通し番号": 54, "context_type": "growth" },
          { "通し番号": 55, "context_type": "completion" },
          { "通し番号": 56, "context_type": "decline" },
          { "通し番号": 57, "context_type": "stable" },
          { "通し番号": 58, "context_type": "completion" },
          { "通し番号": 59, "context_type": "caution" },
          { "通し番号": 60, "context_type": "stable" },
          { "通し番号": 61, "context_type": "caution" },
          { "通し番号": 62, "context_type": "completion" },
          { "通し番号": 63, "context_type": "nascent" },
          { "通し番号": 64, "context_type": "completion" },
          { "通し番号": 65, "context_type": "caution" },
          { "通し番号": 66, "context_type": "growth" },
          { "通し番号": 67, "context_type": "completion" },
          { "通し番号": 68, "context_type": "decline" },
          { "通し番号": 69, "context_type": "stable" },
          { "通し番号": 70, "context_type": "caution" },
          { "通し番号": 71, "context_type": "caution" },
          { "通し番号": 72, "context_type": "growth" },
          { "通し番号": 73, "context_type": "stable" },
          { "通し番号": 74, "context_type": "completion" },
          { "通し番号": 75, "context_type": "nascent" },
          { "通し番号": 76, "context_type": "conflict" },
          { "通し番号": 77, "context_type": "conflict" },
          { "通し番号": 78, "context_type": "stable" },
          { "通し番号": 79, "context_type": "completion" },
          { "通し番号": 80, "context_type": "stable" },
          { "通し番号": 81, "context_type": "nascent" },
          { "通し番号": 82, "context_type": "growth" },
          { "通し番号": 83, "context_type": "completion" },
          { "通し番号": 84, "context_type": "stable" },
          { "通し番号": 85, "context_type": "completion" },
          { "通し番号": 86, "context_type": "completion" },
          { "通し番号": 87, "context_type": "growth" },
          { "通し番号": 88, "context_type": "stable" },
          { "通し番号": 89, "context_type": "completion" },
          { "通し番号": 90, "context_type": "stable" },
          { "通し番号": 91, "context_type": "growth" },
          { "通し番号": 92, "context_type": "growth" },
          { "通し番号": 93, "context_type": "caution" },
          { "通し番号": 94, "context_type": "stable" },
          { "通し番号": 95, "context_type": "decline" },
          { "通し番号": 96, "context_type": "completion" },
          { "通し番号": 97, "context_type": "decline" },
          { "通し番号": 98, "context_type": "decline" },
          { "通し番号": 99, "context_type": "growth" },
          { "通し番号": 100, "context_type": "caution" },
          { "通し番号": 101, "context_type": "growth" },
          { "通し番号": 102, "context_type": "caution" },
          { "通し番号": 103, "context_type": "completion" },
          { "通し番号": 104, "context_type": "decline" },
          { "通し番号": 105, "context_type": "growth" },
          { "通し番号": 106, "context_type": "stable" },
          { "通し番号": 107, "context_type": "caution" },
          { "通し番号": 108, "context_type": "decline" },
          { "通し番号": 109, "context_type": "completion" },
          { "通し番号": 110, "context_type": "completion" },
          { "通し番号": 111, "context_type": "nascent" },
          { "通し番号": 112, "context_type": "completion" },
          { "通し番号": 113, "context_type": "caution" },
          { "通し番号": 114, "context_type": "stable" },
          { "通し番号": 115, "context_type": "completion" },
          { "通し番号": 116, "context_type": "completion" },
          { "通し番号": 117, "context_type": "nascent" },
          { "通し番号": 118, "context_type": "stable" },
          { "通し番号": 119, "context_type": "struggle" },
          { "通し番号": 120, "context_type": "growth" },
          { "通し番号": 121, "context_type": "completion" },
          { "通し番号": 122, "context_type": "completion" },
          { "通し番号": 123, "context_type": "growth" },
          { "通し番号": 124, "context_type": "caution" },
          { "通し番号": 125, "context_type": "struggle" },
          { "通し番号": 126, "context_type": "growth" },
          { "通し番号": 127, "context_type": "stable" },
          { "通し番号": 128, "context_type": "decline" },
          { "通し番号": 129, "context_type": "nascent" },
          { "通し番号": 130, "context_type": "stable" },
          { "通し番号": 131, "context_type": "stable" },
          { "通し番号": 132, "context_type": "growth" },
          { "通し番号": 133, "context_type": "stable" },
          { "通し番号": 134, "context_type": "completion" },
          { "通し番号": 135, "context_type": "decline" },
          { "通し番号": 136, "context_type": "decline" },
          { "通し番号": 137, "context_type": "stable" },
          { "通し番号": 138, "context_type": "decline" },
          { "通し番号": 139, "context_type": "growth" },
          { "通し番号": 140, "context_type": "completion" },
          { "通し番号": 141, "context_type": "growth" },
          { "通し番号": 142, "context_type": "growth" },
          { "通し番号": 143, "context_type": "struggle" },
          { "通し番号": 144, "context_type": "growth" },
          { "通し番号": 145, "context_type": "completion" },
          { "通し番号": 146, "context_type": "decline" },
          { "通し番号": 147, "context_type": "nascent" },
          { "通し番号": 148, "context_type": "stable" },
          { "通し番号": 149, "context_type": "caution" },
          { "通し番号": 150, "context_type": "stable" },
          { "通し番号": 151, "context_type": "stable" },
          { "通し番号": 152, "context_type": "decline" },
          { "通し番号": 153, "context_type": "caution" },
          { "通し番号": 154, "context_type": "struggle" },
          { "通し番号": 155, "context_type": "growth" },
          { "通し番号": 156, "context_type": "stable" },
          { "通し番号": 157, "context_type": "growth" },
          { "通し番号": 158, "context_type": "completion" },
          { "通し番号": 159, "context_type": "caution" },
          { "通し番号": 160, "context_type": "caution" },
          { "通し番号": 161, "context_type": "decline" },
          { "通し番号": 162, "context_type": "growth" },
          { "通し番号": 163, "context_type": "stable" },
          { "通し番号": 164, "context_type": "completion" },
          { "通し番号": 165, "context_type": "caution" },
          { "通し番号": 166, "context_type": "growth" },
          { "通し番号": 167, "context_type": "decline" },
          { "通し番号": 168, "context_type": "stable" },
          { "通し番号": 169, "context_type": "growth" },
          { "通し番号": 170, "context_type": "decline" },
          { "通し番号": 171, "context_type": "struggle" },
          { "通し番号": 172, "context_type": "struggle" },
          { "通し番号": 173, "context_type": "struggle" },
          { "通し番号": 174, "context_type": "growth" },
          { "通し番号": 175, "context_type": "growth" },
          { "通し番号": 176, "context_type": "decline" },
          { "通し番号": 177, "context_type": "nascent" },
          { "通し番号": 178, "context_type": "completion" },
          { "通し番号": 179, "context_type": "decline" },
          { "通し番号": 180, "context_type": "decline" },
          { "通し番号": 181, "context_type": "growth" },
          { "通し番号": 182, "context_type": "growth" },
          { "通し番号": 183, "context_type": "nascent" },
          { "通し番号": 184, "context_type": "caution" },
          { "通し番号": 185, "context_type": "caution" },
          { "通し番号": 186, "context_type": "completion" },
          { "通し番号": 187, "context_type": "stable" },
          { "通し番号": 188, "context_type": "decline" },
          { "通し番号": 189, "context_type": "caution" },
          { "通し番号": 190, "context_type": "stable" },
          { "通し番号": 191, "context_type": "decline" },
          { "通し番号": 192, "context_type": "decline" },
          { "通し番号": 193, "context_type": "stable" },
          { "通し番号": 194, "context_type": "decline" },
          { "通し番号": 195, "context_type": "caution" },
          { "通し番号": 196, "context_type": "stable" },
          { "通し番号": 197, "context_type": "struggle" },
          { "通し番号": 198, "context_type": "growth" },
          { "通し番号": 199, "context_type": "completion" },
          { "通し番号": 200, "context_type": "completion" },
          { "通し番号": 201, "context_type": "caution" },
          { "通し番号": 202, "context_type": "stable" },
          { "通し番号": 203, "context_type": "decline" },
          { "通し番号": 204, "context_type": "growth" },
          { "通し番号": 205, "context_type": "stable" },
          { "通し番号": 206, "context_type": "struggle" },
          { "通し番号": 207, "context_type": "nascent" },
          { "通し番号": 208, "context_type": "growth" },
          { "通し番号": 209, "context_type": "completion" },
          { "通し番号": 210, "context_type": "caution" },
          { "通し番号": 211, "context_type": "completion" },
          { "通し番号": 212, "context_type": "caution" },
          { "通し番号": 213, "context_type": "caution" },
          { "通し番号": 214, "context_type": "growth" },
          { "通し番号": 215, "context_type": "growth" },
          { "通し番号": 216, "context_type": "growth" },
          { "通し番号": 217, "context_type": "stable" },
          { "通し番号": 218, "context_type": "decline" },
          { "通し番号": 219, "context_type": "nascent" },
          { "通し番号": 220, "context_type": "stable" },
          { "通し番号": 221, "context_type": "conflict" },
          { "通し番号": 222, "context_type": "completion" },
          { "通し番号": 223, "context_type": "completion" },
          { "通し番号": 224, "context_type": "completion" },
          { "通し番号": 225, "context_type": "stable" },
          { "通し番号": 226, "context_type": "growth" },
          { "通し番号": 227, "context_type": "conflict" },
          { "通し番号": 228, "context_type": "growth" },
          { "通し番号": 229, "context_type": "completion" },
          { "通し番号": 230, "context_type": "conflict" },
          { "通し番号": 231, "context_type": "stable" },
          { "通し番号": 232, "context_type": "struggle" },
          { "通し番号": 233, "context_type": "struggle" },
          { "通し番号": 234, "context_type": "growth" },
          { "通し番号": 235, "context_type": "growth" },
          { "通し番号": 236, "context_type": "completion" },
          { "通し番号": 237, "context_type": "nascent" },
          { "通し番号": 238, "context_type": "growth" },
          { "通し番号": 239, "context_type": "caution" },
          { "通し番号": 240, "context_type": "growth" },
          { "通し番号": 241, "context_type": "completion" },
          { "通し番号": 242, "context_type": "completion" },
          { "通し番号": 243, "context_type": "growth" },
          { "通し番号": 244, "context_type": "growth" },
          { "通し番号": 245, "context_type": "conflict" },
          { "通し番号": 246, "context_type": "growth" },
          { "通し番号": 247, "context_type": "completion" },
          { "通し番号": 248, "context_type": "completion" },
          { "通し番号": 249, "context_type": "nascent" },
          { "通し番号": 250, "context_type": "completion" },
          { "通し番号": 251, "context_type": "growth" },
          { "通し番号": 252, "context_type": "growth" },
          { "通し番号": 253, "context_type": "completion" },
          { "通し番号": 254, "context_type": "decline" },
          { "通し番号": 255, "context_type": "caution" },
          { "通し番号": 256, "context_type": "caution" },
          { "通し番号": 257, "context_type": "conflict" },
          { "通し番号": 258, "context_type": "struggle" },
          { "通し番号": 259, "context_type": "growth" },
          { "通し番号": 260, "context_type": "decline" },
          { "通し番号": 261, "context_type": "caution" },
          { "通し番号": 262, "context_type": "stable" },
          { "通し番号": 263, "context_type": "struggle" },
          { "通し番号": 264, "context_type": "decline" },
          { "通し番号": 265, "context_type": "completion" },
          { "通し番号": 266, "context_type": "stable" },
          { "通し番号": 267, "context_type": "conflict" },
          { "通し番号": 268, "context_type": "growth" },
          { "通し番号": 269, "context_type": "struggle" },
          { "通し番号": 270, "context_type": "completion" },
          { "通し番号": 271, "context_type": "stable" },
          { "通し番号": 272, "context_type": "decline" },
          { "通し番号": 273, "context_type": "nascent" },
          { "通し番号": 274, "context_type": "growth" },
          { "通し番号": 275, "context_type": "caution" },
          { "通し番号": 276, "context_type": "completion" },
          { "通し番号": 277, "context_type": "stable" },
          { "通し番号": 278, "context_type": "decline" },
          { "通し番号": 279, "context_type": "struggle" },
          { "通し番号": 280, "context_type": "struggle" },
          { "通し番号": 281, "context_type": "decline" },
          { "通し番号": 282, "context_type": "growth" },
          { "通し番号": 283, "context_type": "struggle" },
          { "通し番号": 284, "context_type": "growth" },
          { "通し番号": 285, "context_type": "decline" },
          { "通し番号": 286, "context_type": "caution" },
          { "通し番号": 287, "context_type": "struggle" },
          { "通し番号": 288, "context_type": "stable" },
          { "通し番号": 289, "context_type": "completion" },
          { "通し番号": 290, "context_type": "completion" },
          { "通し番号": 291, "context_type": "caution" },
          { "通し番号": 292, "context_type": "growth" },
          { "通し番号": 293, "context_type": "caution" },
          { "通し番号": 294, "context_type": "growth" },
          { "通し番号": 295, "context_type": "completion" },
          { "通し番号": 296, "context_type": "stable" },
          { "通し番号": 297, "context_type": "nascent" },
          { "通し番号": 298, "context_type": "stable" },
          { "通し番号": 299, "context_type": "struggle" },
          { "通し番号": 300, "context_type": "decline" },
          { "通し番号": 301, "context_type": "stable" },
          { "通し番号": 302, "context_type": "completion" },
          { "通し番号": 303, "context_type": "growth" },
          { "通し番号": 304, "context_type": "caution" },
          { "通し番号": 305, "context_type": "struggle" },
          { "通し番号": 306, "context_type": "struggle" },
          { "通し番号": 307, "context_type": "struggle" },
          { "通し番号": 308, "context_type": "caution" },
          { "通し番号": 309, "context_type": "nascent" },
          { "通し番号": 310, "context_type": "struggle" },
          { "通し番号": 311, "context_type": "struggle" },
          { "通し番号": 312, "context_type": "stable" },
          { "通し番号": 313, "context_type": "stable" },
          { "通し番号": 314, "context_type": "completion" },
          { "通し番号": 315, "context_type": "nascent" },
          { "通し番号": 316, "context_type": "stable" },
          { "通し番号": 317, "context_type": "decline" },
          { "通し番号": 318, "context_type": "stable" },
          { "通し番号": 319, "context_type": "completion" },
          { "通し番号": 320, "context_type": "completion" },
          { "通し番号": 321, "context_type": "nascent" },
          { "通し番号": 322, "context_type": "stable" },
          { "通し番号": 323, "context_type": "caution" },
          { "通し番号": 324, "context_type": "stable" },
          { "通し番号": 325, "context_type": "stable" },
          { "通し番号": 326, "context_type": "decline" },
          { "通し番号": 327, "context_type": "nascent" },
          { "通し番号": 328, "context_type": "stable" },
          { "通し番号": 329, "context_type": "caution" },
          { "通し番号": 330, "context_type": "growth" },
          { "通し番号": 331, "context_type": "completion" },
          { "通し番号": 332, "context_type": "decline" },
          { "通し番号": 333, "context_type": "caution" },
          { "通し番号": 334, "context_type": "stable" },
          { "通し番号": 335, "context_type": "decline" },
          { "通し番号": 336, "context_type": "stable" },
          { "通し番号": 337, "context_type": "growth" },
          { "通し番号": 338, "context_type": "decline" },
          { "通し番号": 339, "context_type": "struggle" },
          { "通し番号": 340, "context_type": "struggle" },
          { "通し番号": 341, "context_type": "decline" },
          { "通し番号": 342, "context_type": "completion" },
          { "通し番号": 343, "context_type": "completion" },
          { "通し番号": 344, "context_type": "decline" },
          { "通し番号": 345, "context_type": "nascent" },
          { "通し番号": 346, "context_type": "completion" },
          { "通し番号": 347, "context_type": "caution" },
          { "通し番号": 348, "context_type": "growth" },
          { "通し番号": 349, "context_type": "caution" },
          { "通し番号": 350, "context_type": "decline" },
          { "通し番号": 351, "context_type": "growth" },
          { "通し番号": 352, "context_type": "growth" },
          { "通し番号": 353, "context_type": "stable" },
          { "通し番号": 354, "context_type": "growth" },
          { "通し番号": 355, "context_type": "caution" },
          { "通し番号": 356, "context_type": "caution" },
          { "通し番号": 357, "context_type": "stable" },
          { "通し番号": 358, "context_type": "decline" },
          { "通し番号": 359, "context_type": "decline" },
          { "通し番号": 360, "context_type": "stable" },
          { "通し番号": 361, "context_type": "completion" },
          { "通し番号": 362, "context_type": "caution" },
          { "通し番号": 363, "context_type": "nascent" },
          { "通し番号": 364, "context_type": "completion" },
          { "通し番号": 365, "context_type": "conflict" },
          { "通し番号": 366, "context_type": "growth" },
          { "通し番号": 367, "context_type": "completion" },
          { "通し番号": 368, "context_type": "decline" },
          { "通し番号": 369, "context_type": "caution" },
          { "通し番号": 370, "context_type": "stable" },
          { "通し番号": 371, "context_type": "caution" },
          { "通し番号": 372, "context_type": "stable" },
          { "通し番号": 373, "context_type": "struggle" },
          { "通し番号": 374, "context_type": "decline" },
          { "通し番号": 375, "context_type": "nascent" },
          { "通し番号": 376, "context_type": "stable" },
          { "通し番号": 377, "context_type": "struggle" },
          { "通し番号": 378, "context_type": "stable" },
          { "通し番号": 379, "context_type": "completion" },
          { "通し番号": 380, "context_type": "decline" },
          { "通し番号": 381, "context_type": "nascent" },
          { "通し番号": 382, "context_type": "stable" },
          { "通し番号": 383, "context_type": "caution" },
          { "通し番号": 384, "context_type": "growth" },
          { "通し番号": 385, "context_type": "completion" },
          { "通し番号": 386, "context_type": "caution" }
    ];
      // --- グローバル変数 ---
      let kuromojiTokenizer = null;
      let HAQEI_DATA = null;
      let H64_DATA = null;
      let H384_DATA = null;
      let summaryChartInstance = null;
      let currentStateBarChartInstance = null;
      let currentAnalysisData = {}; // 現在の分析結果を保持する

      // --- アプリケーション初期化 ---
      async function initializeApp() {
        const aiGuessBtn = document.getElementById("aiGuessBtn");
        const manualAnalyzeBtn = document.getElementById("manualAnalyzeBtn");

        const showLoadingState = (message, isLoading) => {
          const spinner = document.getElementById('loadingSpinner');
          const originalIcon = document.getElementById('originalIcon');
          const buttonText = document.getElementById('buttonText');

          if (isLoading) {
            if(spinner) spinner.classList.remove('hidden');
            if(originalIcon) originalIcon.classList.add('hidden');
            if(buttonText) buttonText.textContent = message;
            if(aiGuessBtn) aiGuessBtn.disabled = true;
            if(manualAnalyzeBtn) {
              manualAnalyzeBtn.disabled = true;
              manualAnalyzeBtn.textContent = message;
            }
          } else {
            if(spinner) spinner.classList.add('hidden');
            if(originalIcon) originalIcon.classList.remove('hidden');
            if(buttonText) buttonText.textContent = 'AIに状況を推測させる';
            if(manualAnalyzeBtn) manualAnalyzeBtn.textContent = "予測実行";
          }
        };

        showLoadingState("辞書データ読込中...", true);

        try {
          const [apiData] = await Promise.all([
            fetch("/api/data").then(res => res.ok ? res.json() : Promise.reject(`APIエラー: ${res.status}`)),
            new Promise((resolve, reject) => {
              kuromoji.builder({ dicPath: "https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/" }).build((err, tokenizer) => {
                if (err) return reject(err);
                kuromojiTokenizer = tokenizer;
                resolve();
              });
            })
          ]);

          HAQEI_DATA = apiData.HAQEI_DATA;
          H64_DATA = HAQEI_DATA.H64_DATA;
          H384_DATA = HAQEI_DATA["384"];
          // ▼▼ context_typeマージ処理をここに追加 ▼▼
          if (window.H384_CONTEXT_TYPE_LIST && Array.isArray(window.H384_CONTEXT_TYPE_LIST)) {
            const contextTypeMap = Object.fromEntries(window.H384_CONTEXT_TYPE_LIST.map(item => [item["通し番号"], item["context_type"]]));
            H384_DATA = H384_DATA.map(obj => ({ ...obj, context_type: contextTypeMap[obj["通し番号"]] || null }));
          }
          // ▲▲ context_typeマージ処理ここまで ▲▲
          setupDatalist();
          console.log("アプリケーションの初期化が完了しました。");
        } catch (error) {
          console.error("データの初期化に失敗しました:", error);
          showModal(`<h2 class="text-2xl font-bold text-red-400 mb-4">初期化エラー</h2><p>必要なデータを読み込めませんでした。</p><p class="mt-2 text-sm text-gray-500">${error}</p>`);
        } finally {
          showLoadingState("AIに状況を推測させる", false);
        }
      }

    // --- イベントリスナーとメインロジック ---
    document.addEventListener("DOMContentLoaded", () => {
        const agreementCheckbox = document.getElementById('agreementCheckbox');
        const aiGuessBtn = document.getElementById('aiGuessBtn');
        const manualAnalyzeBtn = document.getElementById('manualAnalyzeBtn');
        const worryInput = document.getElementById("worryInput");

        // ボタンの有効/無効を切り替える関数
        const updateButtonState = () => {
            const isChecked = agreementCheckbox.checked;
            if (aiGuessBtn && manualAnalyzeBtn && !aiGuessBtn.textContent.includes('読込中')) {
                aiGuessBtn.disabled = !isChecked;
                manualAnalyzeBtn.disabled = !isChecked;
            }
        };

        // メインの分析処理を実行する関数
        const handleAnalysis = async (isManual = false) => {
            let hexagramNumber, lineNumber, resultPaths, reasoning = null, explanation = null;

            // ローディング表示
            const spinner = document.getElementById('loadingSpinner');
            const originalIcon = document.getElementById('originalIcon');
            const buttonText = document.getElementById('buttonText');
            spinner.classList.remove('hidden');
            originalIcon.classList.add('hidden');
            buttonText.textContent = 'AIが解析中...';
            aiGuessBtn.disabled = true;
            manualAnalyzeBtn.disabled = true;

            try {
                if (isManual) {
                    const hexagramInput = document.getElementById("hexagramInput").value.trim();
                    lineNumber = parseInt(document.getElementById("lineInput").value, 10);
                    hexagramNumber = parseInt(hexagramInput);
                    if (isNaN(hexagramNumber)) {
                        const foundHex = H64_DATA.find((h) => h.名前 === hexagramInput);
                        hexagramNumber = foundHex ? foundHex.卦番号 : null;
                    }
                    if (!hexagramNumber || isNaN(lineNumber) || lineNumber < 1 || lineNumber > 6) {
                        alert("有効な卦と爻を入力してください。");
                        return;
                    }
                } else {
                    const worryText = worryInput.value.trim();
                    if (!isInputSufficient(worryText).isValid) {
                        showModal(`<h2 class="text-2xl font-bold text-yellow-400 mb-4">入力内容のご確認</h2><p>あなたの状況をより深く理解するために、もう少し詳しく教えていただけますか。</p>`);
                        return;
                    }

                    // コンテキスト判定を実行
                    const contextType = analyzeContextType(worryText);
                    console.log('コンテキスト分析結果:', contextType);

                    // 確認モーダルを表示
                    const confirmResult = await showContextConfirmModal(contextType);

                    // ユーザーの選択に応じて処理を分岐
                    let finalContextType = contextType;
                    if (!confirmResult) {
                        // 「いいえ」を選択した場合、コンテキストを切り替えて再度モーダルを表示
                        const switchedContextType = contextType === 'personal' ? 'social' : 'personal';
                        await showContextSwitchModal(switchedContextType);
                        finalContextType = switchedContextType;
                    }

                    // 選択されたコンテキストに基づき、AIによる状況推測を実行
                    const result = await callAIAssistant(worryText, H384_DATA, window.futureThemeMap, finalContextType);
                    if (!result) {
                        showModal(`<h2 class="text-2xl font-bold text-red-400 mb-4">AI推測エラー</h2><p>状況に合致する卦を見つけられませんでした。表現を変えて再度お試しください。</p>`);
                        return;
                    }
                    hexagramNumber = result.卦番号;
                    lineNumber = result.爻番号;
                    reasoning = result.根拠;
                    explanation = result.解説;
                }

                resultPaths = generateAllPaths(hexagramNumber, lineNumber);
                if (resultPaths && resultPaths.length > 0) {
                    updateUI(resultPaths, reasoning, explanation); // UIを更新して結果を表示
                } else {
                    alert("分析結果の生成に失敗しました。");
                }
            } catch (error) {
                console.error("分析処理でエラー:", error);
                alert(`分析処理中にエラーが発生しました: ${error.message}`);
            } finally {
                spinner.classList.add('hidden');
                originalIcon.classList.remove('hidden');
                buttonText.textContent = 'AIに状況を推測させる';
                updateButtonState();
            }
        };

        // --- イベントリスナー設定 ---
        initializeApp().then(() => {
            updateButtonState(); // 初期化完了後にボタン状態を更新
        });

        agreementCheckbox.addEventListener('change', updateButtonState);

        aiGuessBtn.addEventListener("click", () => {
            if (!agreementCheckbox.checked) {
                alert('利用規約とプライバシーポリシーに同意してください。');
                return;
            }
            handleAnalysis(false);
        });

        manualAnalyzeBtn.addEventListener("click", () => {
            if (!agreementCheckbox.checked) {
                alert('利用規約とプライバシーポリシーに同意してください。');
                return;
            }
            handleAnalysis(true);
        });
        
        document.getElementById("modalOverlay").addEventListener("click", hideModal);
        document.getElementById("modalCloseBtn").addEventListener("click", hideModal);
        document.getElementById("helpBtn").addEventListener("click", showHelpModal);
        document.body.addEventListener("click", function (event) {
            const paramHelpBtn = event.target.closest("#paramHelpBtn");
            if (paramHelpBtn) showParameterHelpModal();
        });
    });

    /**
     * 選択したシナリオのデータを保存し、cockpit.htmlへ遷移する
     */
    function saveAndNavigateToCockpit(worryText, allPaths, selectedIndex) {
        if (!allPaths || allPaths.length === 0 || selectedIndex === undefined) {
            alert("分析データまたは選択されたシナリオがありません。");
            return;
        }
        
        const dataToStore = {
            worry: worryText,
            paths: allPaths,
            selectedFuture: {
                path: allPaths[selectedIndex],
                rank: ["S", "A", "B", "C", "D", "E", "F", "H"][selectedIndex] || "N/A",
            }
        };

        try {
            localStorage.setItem("proFutureReportData", JSON.stringify(dataToStore));
            window.location.href = "cockpit.html";
        } catch (e) {
            console.error("localStorageへのデータ保存に失敗しました:", e);
            alert("データの保存に失敗しました。ブラウザの設定をご確認ください。");
        }
    }
    
    // ===================================================
    // ここから下は、UIの描画やデータ処理を行うヘルパー関数です
    // ===================================================

    function setupDatalist() {
        if (H64_DATA && H64_DATA.length > 0) {
            const datalist = document.getElementById("hexagram-names");
            H64_DATA.forEach((hex) => {
                const option = document.createElement("option");
                option.value = hex.名前;
                datalist.appendChild(option);
            });
        }
    }
    
    function updateUI(sortedPaths, reasoning = null, explanation = null) {
        const worryText = document.getElementById("worryInput").value;
        currentAnalysisData = {
            worry: worryText,
            paths: sortedPaths,
        };

        document.getElementById("initialMessage").classList.add("hidden");
        document.getElementById("resultArea").classList.remove("hidden");

        const reasoningContainer = document.getElementById("aiReasoningContainer");
        if (reasoning) {
            reasoningContainer.innerHTML = `<p class="text-sm text-green-200">${reasoning}</p>`;
            reasoningContainer.classList.remove("hidden");
        } else {
            reasoningContainer.classList.add("hidden");
        }

        const startState = sortedPaths[0][0];
        currentAnalysisData.startState = startState;
        document.getElementById("currentTitle").innerText = `現在地: ${startState["親となる卦"]} ${startState.爻}`;
        document.getElementById("currentKeywords").innerText = `テーマ: ${startState.キーワード || ""}`;
        document.getElementById("currentSummary").innerText = startState.現代解釈の要約;
        
        const currentScore = startState.S7_総合評価スコア;
        const scoreEval = getScoreEvaluation(currentScore);
        document.getElementById("currentScore").innerText = `${currentScore} 点`;
        const scoreLabel = document.getElementById("currentScoreLabel");
        scoreLabel.innerText = scoreEval.label;
        scoreLabel.className = `eval-label ${scoreEval.colorClass}`;
        document.getElementById("currentScoreDesc").innerText = `※ ${scoreEval.desc}`;
        
        const transitionCost = 100 - (startState.S6_変動性スコア || 50);
        const costEval = getTransitionCostEvaluation(transitionCost);
        document.getElementById("transitionCost").innerText = `${transitionCost} 点`;
        const costLabel = document.getElementById("transitionCostLabel");
        costLabel.innerText = costEval.label;
        costLabel.className = `eval-label ${costEval.colorClass}`;
        document.getElementById("transitionCostDesc").innerText = `※ ${costEval.desc}`;
        
        document.getElementById("summaryCard").onclick = () => showCurrentStateModal(startState);
        renderCurrentStateBarChart(startState);

        const futureContentsWrapper = document.getElementById("futureContentsWrapper");
        const revealButtonContainer = document.getElementById("revealButtonContainer");
        const revealButton = document.getElementById("revealButton");

        futureContentsWrapper.classList.add("hidden", "opacity-0");
        futureContentsWrapper.classList.remove("future-contents-reveal");
        revealButtonContainer.classList.remove("hidden");
        revealButton.style.display = "inline-block";

        const revealHandler = () => {
            futureContentsWrapper.classList.remove("hidden");
            setTimeout(() => {
                futureContentsWrapper.classList.add("future-contents-reveal");
                futureContentsWrapper.scrollIntoView({ behavior: "smooth", block: "start" });
            }, 100);
            revealButton.style.display = "none";
        };
        revealButton.removeEventListener("click", revealHandler);
        revealButton.addEventListener("click", revealHandler, { once: true });

        renderSummaryChart(sortedPaths);
        renderDetailCards(sortedPaths);
        renderChartToggles(sortedPaths);
        setupInteraction(sortedPaths);
    }
      
    function renderDetailCards(sortedPaths) {
        const container = document.getElementById("detailCardsContainer");
        container.innerHTML = "";
        const rankLabels = ["S", "A", "B", "C", "D", "E", "F", "H"];
        
        const recommendationMessageEl = document.getElementById("aiRecommendationMessage");
        recommendationMessageEl.innerHTML = `AIの分析では、<strong class="text-green-300">シナリオ1（Sランク）</strong>があなたの課題解決と成長に最も貢献する可能性があります。<br class="hidden sm:block">まずはこちらの物語から読んでみませんか？`;
        recommendationMessageEl.classList.remove("hidden");

        sortedPaths.forEach((path, index) => {
            const finalState = path[path.length - 1];
            const overallTrend = evaluateSpiralProgress(path[0], path[3]);
            const firstStepTrend = evaluateSpiralProgress(path[0], path[1]);
            const card = document.createElement("div");
            const rankClass = `rank-${rankLabels[index].toLowerCase()}`;
            const isRecommended = index === 0;

            card.id = `card-${index}`;
            card.className = `card relative bg-gray-900/50 p-4 rounded-xl border-2 border-transparent flex flex-col ${isRecommended ? "ai-recommended" : ""}`;
            card.dataset.index = index;
            card.addEventListener("click", (e) => {
                if (e.target.closest(".deep-dive-btn")) return;
                showScenarioModal(path, index, overallTrend, firstStepTrend);
            });

            const pathHistory = path.slice(1).map(p => p.choice === "change" ? "変" : "進").join(" → ");
            const finalStateTitle = `${finalState["親となる卦"]} ${finalState.爻}`;
            const badgeHtml = isRecommended ? `<div class="absolute top-2.5 right-2.5 bg-green-400 text-gray-900 text-xs font-bold px-3 py-1 rounded-full shadow-lg z-10">✨ AI推奨</div>` : "";

            const buttonHtml = `
            <div class="mt-auto pt-4 border-t border-gray-700/50">
                <button class="deep-dive-btn inline-block w-full text-center font-bold py-2 px-4 rounded-lg text-sm" data-scenario-index="${index}">
                    この未来でコックピットへ
                </button>
            </div>`;

            card.innerHTML = `
                ${badgeHtml}
                <div class="flex items-start justify-between mb-2">
                    <h3 class="text-md font-bold text-gray-300">シナリオ ${index + 1}</h3>
                    <span class="rank-badge ${rankClass}">${rankLabels[index]}</span>
                </div>
                <div class="text-xs text-gray-500 mb-3" style="min-height: 1em;">経路: ${pathHistory}</div>
                <div class="grid grid-cols-2 gap-2 mb-3 text-center">
                    <div><p class="text-[10px] text-gray-400 mb-1 font-semibold">全体トレンド</p><div class="trend-badge ${overallTrend.colorClass}" title="${overallTrend.message}">${overallTrend.trend}</div></div>
                    <div><p class="text-[10px] text-gray-400 mb-1 font-semibold">初期ステップ</p><div class="trend-badge ${firstStepTrend.colorClass}" title="${firstStepTrend.message}">${firstStepTrend.trend}</div></div>
                </div>
                <p class="text-lg font-semibold text-indigo-300">${finalStateTitle}</p>
                <div class="my-3" style="height: 110px; padding-left: 5px;"><canvas id="miniChart-${index}"></canvas></div>
                <p class="text-xs text-gray-400 mt-1 mb-4 flex-grow">${finalState.現代解釈の要約}</p>
                ${buttonHtml}
            `;
            container.appendChild(card);
        });

        container.querySelectorAll('.deep-dive-btn').forEach(button => {
            button.addEventListener('click', (event) => {
                event.stopPropagation();
                const scenarioIndex = parseInt(event.currentTarget.dataset.scenarioIndex, 10);
                saveAndNavigateToCockpit(currentAnalysisData.worry, currentAnalysisData.paths, scenarioIndex);
            });
        });

        sortedPaths.forEach((path, index) => {
            renderMiniBarChart(index, path[path.length - 1]);
        });
    }

      function renderMiniBarChart(index, state) {
        const ctx = document
          .getElementById(`miniChart-${index}`)
          .getContext("2d");
        const data = [
          state.S1_基本スコア,
          state.S2_ポテンシャル,
          state.S3_安定性スコア,
          Math.abs(state.S4_リスク),
          state.S6_変動性スコア,
        ];
        const colors = [
          "rgba(96, 165, 250, 0.7)",
          "rgba(52, 211, 153, 0.7)",
          "rgba(167, 139, 250, 0.7)",
          "rgba(248, 113, 113, 0.7)",
          "rgba(251, 191, 36, 0.7)",
        ];
        new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["基本", "潜在力", "安定性", "リスク", "変動性"],
            datasets: [
              {
                data: data,
                backgroundColor: colors,
                borderWidth: 0,
                barPercentage: 0.8,
                categoryPercentage: 0.9,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: "y",
            scales: {
              x: { display: false, min: 0, max: 100 },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: "#9ca3af", font: { size: 10 } },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: { enabled: false },
            },
          },
        });
      }

      function renderChartToggles(sortedPaths) {
        const container = document.getElementById("chartToggles");
        container.innerHTML = "";

        const getScenarioSummary = (path) => {
          const route = path
            .slice(1)
            .map((p) => (p.choice === "change" ? "変" : "進"));
          const routeText = route.join("→");
          const summaries = {
            "進→進→進": "信じた道を、まっすぐ進んでいく未来",
            "進→進→変": "じっくり育てたチカラを、新しい世界で試す未来",
            "進→変→進": "寄り道で得たヒントで、本来の道を豊かにする未来",
            "進→変→変": "変化の波を乗りこなし、軽やかに進んでいく未来",
            "変→進→進":
              "新しい世界に飛び込み、そこを「自分の居場所」にする未来",
            "変→進→変": "ひとつの場所に安住せず、自由に可能性を試す未来",
            "変→変→進": "試行錯誤の旅を経て、「これだ」と思える道に出会う未来",
            "変→変→変": "常識を塗り替え、新しい時代を切り拓いていく未来",
          };
          return summaries[routeText] || "カスタム経路";
        };

        sortedPaths.forEach((path, index) => {
          const color =
            summaryChartInstance.data.datasets[index].originalBorderColor;
          const finalScore = path[path.length - 1].S7_総合評価スコア;
          const scenarioSummary = getScenarioSummary(path);

          const legendItem = document.createElement("div");

          legendItem.className =
            "toggle-label text-xs p-2 rounded-lg bg-gray-800/50 border border-gray-700/50 w-full flex-col h-full";
          legendItem.dataset.index = index;
          legendItem.title = `シナリオ ${index + 1}: ${path
            .slice(1)
            .map((p) => (p.choice === "change" ? "変" : "進"))
            .join("→")}`;

          legendItem.innerHTML = `
        <div class="flex items-center w-full mb-1">
          <span class="toggle-legend" style="background-color: ${color};"></span>
          <span class="font-bold text-gray-200">シナリオ ${
            index + 1
          } (${finalScore}点)</span>
        </div>
        <span class="text-gray-400 text-[10px] w-full text-left">${scenarioSummary}</span>
      `;

          const overallTrend = evaluateSpiralProgress(path[0], path[3]);
          const firstStepTrend = evaluateSpiralProgress(path[0], path[1]);

          legendItem.addEventListener("click", () => {
            showScenarioModal(path, index, overallTrend, firstStepTrend);
          });

          container.appendChild(legendItem);
        });
      }

      function showModal(content) {
        document.getElementById("modalBody").innerHTML = content;
        const modalContainer = document.getElementById("modalContainer");
        modalContainer.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        setTimeout(() => {
          document.getElementById("modalOverlay").classList.remove("opacity-0");
          document.getElementById("modalContent").classList.remove("scale-95");
        }, 10);
      }

      function showScenarioModal(path, index, overallTrend, firstStepTrend) {
        const rankLabels = ["S", "A", "B", "C", "D", "E", "F", "H"];
        const rankClass = `rank-${rankLabels[index].toLowerCase()}`;
        let trendHtml = "";
        if (firstStepTrend && firstStepTrend.trend === "危険な下降") {
          trendHtml = `<div class="p-3 rounded-lg mb-4 bg-red-900/80 border border-red-600 text-sm"><p class="font-bold text-red-200">【注意】最初のステップは危険な下降です</p><p class="text-xs text-gray-200 mt-1">このシナリオは「${overallTrend.trend}」を目指しますが、初期段階で状況が大きく悪化するリスクを伴います。</p></div>`;
        } else {
          trendHtml = `<div class="p-3 rounded-lg mb-4 ${overallTrend.colorClass}"><h3 class="font-bold text-lg">${overallTrend.trend}</h3><p class="text-sm mt-1">${overallTrend.message}</p></div>`;
        }
        let modalContentHtml = `<div class="flex items-center justify-between mb-4"><h2 class="text-2xl font-bold text-indigo-300">シナリオ ${
          index + 1
        } の詳細</h2><span class="rank-badge ${rankClass} text-lg">${
          rankLabels[index]
        }</span></div>${trendHtml}`;

        const getScoreDiffHtml = (currentScore, prevScore) => {
          if (typeof prevScore !== "number") return "";
          const diff = Math.round((currentScore - prevScore) * 10) / 10;
          let icon = "";
          let colorClass = "diff-zero";
          if (diff > 0) {
            icon = "▲";
            colorClass = "diff-up";
          } else if (diff < 0) {
            icon = "▼";
            colorClass = "diff-down";
          } else {
            return `<span class="ml-2 text-xs w-10 text-center ${colorClass}">±0</span>`;
          }
          return `<span class="ml-2 text-xs w-10 text-left flex items-center ${colorClass}">${icon}${Math.abs(
            diff
          )}</span>`;
        };

        path.forEach((step, stepIndex) => {
          const phaseLabels = ["現在地", "フェーズ1", "フェーズ2", "フェーズ3"];
          const isYongYao = step.爻 === "用九" || step.爻 === "用六";
          const previousStep = stepIndex > 0 ? path[stepIndex - 1] : null;
          const stepWrapperClass = isYongYao ? "yong-yao-step" : "";
          const stepTitleIcon = isYongYao
            ? '<span class="yong-yao-title-icon">☯</span>'
            : "";

          const s1_diff = getScoreDiffHtml(
            step.S1_基本スコア,
            previousStep?.S1_基本スコア
          );
          const s2_diff = getScoreDiffHtml(
            step.S2_ポテンシャル,
            previousStep?.S2_ポテンシャル
          );
          const s3_diff = getScoreDiffHtml(
            step.S3_安定性スコア,
            previousStep?.S3_安定性スコア
          );
          const s4_diff = getScoreDiffHtml(
            step.S4_リスク,
            previousStep?.S4_リスク
          );
          const s6_diff = getScoreDiffHtml(
            step.S6_変動性スコア,
            previousStep?.S6_変動性スコア
          );
          const s7_diff = getScoreDiffHtml(
            step.S7_総合評価スコア,
            previousStep?.S7_総合評価スコア
          );

          let guidelineHtml = "";
          if (stepIndex < path.length - 1) {
            const nextStep = path[stepIndex + 1];

            const targetName = `${step["親となる卦"]} ${step.爻}`;
            const normalizedTargetName = `${step["親となる卦"]} ${step.爻}`
              .replace(/\s+/g, " ")
              .trim();

            const guidelineData =
              typeof window.koudoShishinData !== "undefined"
                ? window.koudoShishinData.find(
                    (item) =>
                      item.name.replace(/\s+/g, " ").trim() === targetName
                  )
                : null;

            let actionGuidelineTitle = "",
              actionGuidelineText = "",
              bgColor = "";

            if (guidelineData) {
              if (nextStep.choice === "change") {
                actionGuidelineTitle = `<p class="font-bold text-purple-300">行動指針【変】：状況を転換する</p>`;
                actionGuidelineText = `<p class="text-xs text-gray-300 mt-1">${guidelineData.hen}</p>`;
                bgColor = "bg-purple-900/40 border border-purple-700/60";
              } else {
                actionGuidelineTitle = `<p class="font-bold text-teal-300">行動指針【進】：テーマを深化させる</p>`;
                actionGuidelineText = `<p class="text-xs text-gray-300 mt-1">${guidelineData.shin}</p>`;
                bgColor = "bg-teal-900/40 border border-teal-700/60";
              }
            } else {
              actionGuidelineTitle = `<p class="font-bold text-yellow-400">行動指針</p>`;
              actionGuidelineText = `<p class="text-xs text-gray-500 mt-1">（行動指針データが見つかりませんでした。）</p>`;
              bgColor = "bg-gray-700/50 border border-gray-600";
            }
            guidelineHtml = `<div class="mt-4 pt-4 border-t border-gray-700/50"><div class="p-3 rounded-lg text-sm ${bgColor}">${actionGuidelineTitle}${actionGuidelineText}</div></div>`;
          }

          modalContentHtml += `
        <div class="py-4 px-4 border-b border-gray-700 last:border-b-0 ${stepWrapperClass}">
          <h4 class="text-lg font-semibold text-gray-100 flex items-center">${
            phaseLabels[stepIndex]
          }: ${step["親となる卦"]} ${step.爻} ${stepTitleIcon}</h4>
          <p class="text-sm text-yellow-300 my-1">テーマ: ${
            step.キーワード || ""
          }</p>
          <p class="text-xs text-gray-400 mt-1">${step.現代解釈の要約}</p>
          <div class="mt-4 grid grid-cols-2 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs">
            <div class="flex justify-between items-center"><span class="text-gray-400">基本:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
              step.S1_基本スコア
            }</span>${s1_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">ポテンシャル:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
              step.S2_ポテンシャル
            }</span>${s2_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">安定性:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
              step.S3_安定性スコア
            }</span>${s3_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">リスク:</span><div class="flex items-center"><span class="font-mono w-6 text-right text-red-400">${
              step.S4_リスク
            }</span>${s4_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">変動性:</span><div class="flex items-center"><span class="font-mono w-6 text-right">${
              step.S6_変動性スコア
            }</span>${s6_diff}</div></div>
            <div class="flex justify-between items-center"><span class="text-gray-400">主体性:</span><span>${
              step.S5_主体性
            }</span></div>
            <div class="col-span-full flex justify-between items-center font-bold border-t border-gray-600 pt-2 mt-2">
              <span class="text-gray-300">総合評価:</span>
              <div class="flex items-center">
                <span class="font-mono text-lg text-indigo-300">${
                  step.S7_総合評価スコア
                }</span>
                ${s7_diff.replace("text-xs", "text-sm").replace("w-10", "w-12")}
              </div>
            </div>
          </div>
          ${guidelineHtml}
        </div>
      `;
        });
        showModal(modalContentHtml);
      }

      function showCurrentStateModal(state) {
        const content = `
                      <h2 class="text-2xl font-bold text-indigo-300 mb-4">現在地の詳細: ${
                        state["親となる卦"]
                      } ${state.爻}</h2>
                      <p class="text-sm text-yellow-300 my-1">テーマ: ${
                        state.キーワード || ""
                      }</p>
                      <p class="text-sm text-gray-300 mt-3">${
                        state.現代解釈の全文 || state.現代解釈の要約
                      }</p>
                      <div class="mt-6 pt-4 border-t border-gray-700 grid grid-cols-2 gap-4 text-sm">
                          <div><span class="font-bold text-gray-400">基本スコア:</span> ${
                            state.S1_基本スコア
                          }</div>
                          <div><span class="font-bold text-gray-400">ポテンシャル:</span> ${
                            state.S2_ポテンシャル
                          }</div>
                          <div><span class="font-bold text-gray-400">安定性スコア:</span> ${
                            state.S3_安定性スコア
                          }</div>
                          <div><span class="font-bold text-gray-400">リスク:</span> ${
                            state.S4_リスク
                          }</div>
                          <div><span class="font-bold text-gray-400">主体性:</span> ${
                            state.S5_主体性
                          }</div>
                          <div><span class="font-bold text-gray-400">変動性スコア:</span> ${
                            state.S6_変動性スコア
                          }</div>
                          <div class="col-span-2 mt-2 pt-2 border-t border-gray-600"><span class="font-bold text-indigo-300">総合評価スコア:</span> ${
                            state.S7_総合評価スコア
                          }</div>
                      </div>
                  `;
        showModal(content);
      }

      function showHelpModal() {
        const helpContent = `
                  <h2 class="text-2xl font-bold text-indigo-300 mb-4">HaQei マルチバース・アナライザーとは？</h2>
                  <p class="text-gray-300 mb-3">このツールは、古代の知恵である「易経」と現代のAI技術を融合させ、あなたの現状を多角的に分析し、未来の可能性を可視化するためのものです。</p>
                  <h3 class="text-lg font-semibold text-indigo-300 mt-6 mb-2">使い方</h3>
                  <ol class="list-decimal list-inside space-y-3 text-gray-300">
                      <li><strong>AIによる状況推測:</strong> あなたが今抱えている悩みや状況を、感じたままの「生の言葉」で入力し、「AIに状況を推測させる」ボタンを押してください。AIがあなたの言葉から最も近い状況（卦と爻）を自動で設定します。</li>
                      <li><strong>手動設定:</strong> もし占いたい状況が明確な場合は、AIの推測を使わずに「状況卦」と「現在の爻」を手動で入力することも可能です。</li>
                      <li><strong>予測実行:</strong> 状況が設定されたら、「予測実行」ボタンを押します。あなたの現在地から分岐する8つの未来シナリオがグラフとカードで表示されます。</li>
                  </ol>
                  <h3 class="text-lg font-semibold text-indigo-300 mt-6 mb-2">結果の見方</h3>
                  <ul class="list-disc list-inside space-y-3 text-gray-300">
                      <li><strong>分析サマリー:</strong> あなたの「現在地」の評価と、状況が変化しやすい時期かどうか（移行コスト）を確認できます。</li>
                      <li><strong>未来分岐グラフ:</strong> 8つのシナリオが今後どのように推移するかを「総合評価」のスコアで示します。線が上に行くほど好ましい未来です。</li>
                      <li><strong>8つの未来のシナリオ:</strong> 各シナリオが行き着く未来の状態をカードで示します。カードをクリックすると、そこに至るまでの詳細なステップ（行動指針）を確認できます。</li>
                  </ul>
              `;
        showModal(helpContent);
      }

      function showParameterHelpModal() {
        // 保存された現在地のデータを取得
        const state = currentAnalysisData.startState;
        // データがない場合はモーダルを開かない
        if (!state) {
          alert("先に「予測実行」ボタンを押して、分析を完了させてください。");
          return;
        }

        // --- 各スコアに対応する解説文を生成する ---
        const getDesc = (score, type) => {
          let highThreshold = 60;
          let lowThreshold = 40;

          // スコアのレベルを判定（リスクのみ評価が逆転）
          const getLevel = (currentScore, isReversed = false) => {
            if (currentScore >= highThreshold)
              return isReversed ? "low" : "high";
            if (currentScore <= lowThreshold)
              return isReversed ? "high" : "low";
            return "medium";
          };

          let explanation = "";
          const level = getLevel(score, type === "risk");

          switch (type) {
            case "kihon":
              if (level === "high")
                explanation = `状況の根本的なエネルギーが<strong class="text-green-300">充実している</strong>ことを示します。物事を推進するための力強い基盤がある状態です。`;
              else if (level === "low")
                explanation = `状況の根本的なエネルギーが<strong class="text-red-300">不足している</strong>ことを示します。物事を進める上での土台が弱く、苦労を伴う可能性があります。`;
              else
                explanation = `状況の根本的なエネルギーは<strong class="text-yellow-300">標準的</strong>です。安定はしていますが、エネルギーに大きな余裕があるわけではありません。`;
              break;
            case "potential":
              if (level === "high")
                explanation = `将来的な<strong class="text-green-300">成長の伸びしろが大きい</strong>ことを示します。現状を超えて大きく飛躍する可能性を秘めています。`;
              else if (level === "low")
                explanation = `将来的な<strong class="text-red-300">成長の伸びしろが限定的</strong>であることを示します。大きな飛躍よりも、現状の維持や改善がテーマとなります。`;
              else
                explanation = `将来的な<strong class="text-yellow-300">成長の伸びしろは標準的</strong>です。着実な前進は期待できますが、ブレークスルーには更なる要素が必要です。`;
              break;
            case "antei":
              if (level === "high")
                explanation = `状況が<strong class="text-green-300">非常に安定的</strong>であることを示します。外部からの影響を受けにくく、計画通りに物事を進めやすい状態です。`;
              else if (level === "low")
                explanation = `状況が<strong class="text-red-300">非常に不安定</strong>であることを示します。予期せぬ変化が起こりやすく、臨機応変な対応が求められます。`;
              else
                explanation = `状況の<strong class="text-yellow-300">安定性は標準的</strong>です。大きな動揺はありませんが、不測の事態への備えは必要です。`;
              break;
            case "risk":
              // リスクの説明ではlevelのhigh/lowが直感と合うように表示
              if (level === "high")
                explanation = `内在する<strong class="text-red-300">リスクが非常に高い</strong>ことを示します。重大な問題や困難が潜んでいるため、極めて慎重な判断が求められます。`;
              else if (level === "low")
                explanation = `内在する<strong class="text-green-300">リスクは低い</strong>状態です。目に見える障害は少なく、比較的安全に行動できます。`;
              else
                explanation = `内在する<strong class="text-yellow-300">リスクは標準的</strong>です。注意すべき点はありますが、過度に警戒する必要はありません。`;
              break;
            case "hendou":
              if (level === "high")
                explanation = `状況の<strong class="text-green-300">変動性が高い</strong>ことを示します。あなたの働きかけが結果に直結しやすく、状況をコントロールしやすい局面です。`;
              else if (level === "low")
                explanation = `状況の<strong class="text-red-300">変動性が低い</strong>ことを示します。状況が膠着しており、個人の力で変化を起こすのは困難かもしれません。`;
              else
                explanation = `状況の<strong class="text-yellow-300">変動性は標準的</strong>です。あなたの行動は影響を与えますが、結果が表れるまでには時間がかかる可能性があります。`;
              break;
          }
          return `<p class="text-sm mt-1">${explanation}</p>`;
        };

        const getShutaiDesc = (type) => {
          if (type === "能動") {
            return `この状況では<strong class="text-yellow-200">「能動的」</strong>なスタンスが有効とされます。あなた自身の意思決定と行動が、今後の展開を左右する重要な鍵となります。`;
          }
          return `この状況では<strong class="text-yellow-200">「受動的」</strong>なスタンスが有効とされます。自ら流れを作ろうとするより、環境やタイミングを見極めて対応することが求められます。`;
        };

        const helpContent = `
      <h2 class="text-2xl font-bold text-indigo-300 mb-6">パラメータの見方</h2>
      <div class="space-y-5 text-left">

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #93c5fd;">■ 基本スコア ${
                state.S1_基本スコア
              }点</h3>
              ${getDesc(state.S1_基本スコア, "kihon")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #6ee7b7;">■ 潜在力 (ポテンシャル) ${
                state.S2_ポテンシャル
              }点</h3>
              ${getDesc(state.S2_ポテンシャル, "potential")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #c4b5fd;">■ 安定性スコア ${
                state.S3_安定性スコア
              }点</h3>
              ${getDesc(state.S3_安定性スコア, "antei")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #fca5a5;">■ リスク ${
                state.S4_リスク
              }点</h3>
               ${getDesc(state.S4_リスク, "risk")}
          </div>

           <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #fde047;">■ 変動性スコア ${
                state.S6_変動性スコア
              }点</h3>
               ${getDesc(state.S6_変動性スコア, "hendou")}
          </div>

          <div>
              <h3 class="text-xl font-semibold mb-1" style="color: #e5e7eb;">■ 主体性</h3>
              <p class="text-sm mt-1">${getShutaiDesc(state.S5_主体性)}</p>
          </div>

      </div>
  `;
        showModal(helpContent);
      }

      function hideModal() {
        const modalContainer = document.getElementById("modalContainer");
        document.getElementById("modalOverlay").classList.add("opacity-0");
        document.getElementById("modalContent").classList.add("scale-95");
        setTimeout(() => {
          modalContainer.classList.add("hidden");
          document.body.style.overflow = "";
        }, 300);
      }

      function setupInteraction(sortedPaths) {
        const chartToggles = document.getElementById("chartToggles");
        const detailCards = document.getElementById("detailCardsContainer");
        const chartCanvas = document.getElementById("summaryChart");

        // カードを個別にハイライトする仕掛け
        const handleMouseOver = (e) => {
          const target = e.target.closest("[data-index]");
          if (target) {
            const index = parseInt(target.dataset.index, 10);
            highlightScenario(index);
          }
        };
        const resetAllHighlights = () => {
          resetChartHighlights();
          document.querySelectorAll(".dimmed-by-choice").forEach((card) => {
            card.classList.remove("dimmed-by-choice");
          });
        };
        chartToggles.addEventListener("mouseover", handleMouseOver);
        detailCards.addEventListener("mouseover", handleMouseOver);
        chartToggles.addEventListener("mouseleave", resetChartHighlights);
        detailCards.addEventListener("mouseleave", resetChartHighlights);
        chartCanvas.addEventListener("mouseleave", resetChartHighlights);

        chartCanvas.onmousemove = (evt) => {
          const activeElements = summaryChartInstance.getElementsAtEventForMode(
            evt,
            "index",
            { intersect: false },
            true
          );
          if (activeElements.length > 0) {
            highlightScenario(activeElements[0].datasetIndex);
          }
        };

        // --- ▼▼▼ 【改造ポイント】「最初の選択」と未来カードを連動させる仕掛け ▼▼▼ ---
        const choiceCardShin = document.getElementById("choiceCardShin");
        const choiceCardHen = document.getElementById("choiceCardHen");

        // 関係ないカードを少し暗くする関数
        const highlightRelatedScenarios = (choiceType) => {
          sortedPaths.forEach((path, index) => {
            const card = document.getElementById(`card-${index}`);
            if (card) {
              const pathChoice = path[1]?.choice;
              if (pathChoice !== choiceType) {
                card.classList.add("dimmed-by-choice");
              }
            }
          });
        };

        if (choiceCardShin) {
          choiceCardShin.addEventListener("mouseover", () => {
            highlightRelatedScenarios("stagnate"); // "進" の道
            highlightMultipleScenarios("stagnate", sortedPaths); // グラフも連動
          });
          choiceCardShin.addEventListener("mouseleave", resetAllHighlights);
        }

        if (choiceCardHen) {
          choiceCardHen.addEventListener("mouseover", () => {
            highlightRelatedScenarios("change"); // "変" の道
            highlightMultipleScenarios("change", sortedPaths); // グラフも連動
          });
          choiceCardHen.addEventListener("mouseleave", resetAllHighlights);
        }
      }

      const findLineDataByNum = (hexNum, lineNum) => {
        if (lineNum < 1 || lineNum > 6 || !H384_DATA) return null;
        const lineName = ["初", "二", "三", "四", "五", "上"][lineNum - 1];
        return H384_DATA.find(
          (line) => line.卦番号 === hexNum && line.爻.includes(lineName)
        );
      };

      const findYongYaoData = (hexNum) => {
        if (!H384_DATA) return null;
        const yongName = hexNum === 1 ? "用九" : "用六";
        return H384_DATA.find(
          (line) => line.卦番号 === hexNum && line.爻 === yongName
        );
      };

      const findHexData = (hexNum) => {
        if (!H64_DATA) return null;
        return H64_DATA.find((hex) => hex.卦番号 === hexNum);
      };

      const getNextState = (currentState, choice) => {
        let nextHexNum, nextLineNum;
        const { lineNum: currentLineNum, 卦番号: currentHexNum } = currentState;
        if (currentState.爻 === "用九") {
          const data = findLineDataByNum(2, 1);
          return data ? { ...data, lineNum: 1, choice: "stagnate" } : null;
        }
        if (currentState.爻 === "用六") {
          const data = findLineDataByNum(1, 1);
          return data ? { ...data, lineNum: 1, choice: "stagnate" } : null;
        }
        if (choice === "stagnate") {
          if (
            (currentHexNum === 1 || currentHexNum === 2) &&
            currentLineNum === 6
          ) {
            const yongData = findYongYaoData(currentHexNum);
            if (yongData)
              return { ...yongData, lineNum: 7, choice: "stagnate" };
          }
          nextHexNum = currentHexNum;
          nextLineNum = currentLineNum >= 6 ? 1 : currentLineNum + 1;
        } else {
          const currentHexData = findHexData(currentHexNum);
          if (!currentHexData) return null;
          const lineKeys = [
            "初爻変",
            "二爻変",
            "三爻変",
            "四爻変",
            "五爻変",
            "上爻変",
          ];
          nextHexNum = currentHexData[lineKeys[currentLineNum - 1]];
          nextLineNum = currentLineNum;
        }
        const data = findLineDataByNum(nextHexNum, nextLineNum);
        return data ? { ...data, lineNum: nextLineNum, choice: choice } : null;
      };

      function generateAllPaths(startHex, startLine) {
        const startData = findLineDataByNum(startHex, startLine);
        if (!startData) return [];
        let paths = [[{ ...startData, lineNum: startLine, choice: "start" }]];
        for (let i = 0; i < 3; i++) {
          const newPaths = [];
          for (const path of paths) {
            const lastState = path[path.length - 1];
            const stagnateState = getNextState(lastState, "stagnate");
            if (stagnateState) newPaths.push([...path, stagnateState]);
            const changeState = getNextState(lastState, "change");
            if (changeState) newPaths.push([...path, changeState]);
          }
          paths = newPaths;
        }
        return paths.filter((p) => p.length === 4);
      }
      function restoreState() {
        // localStorageから保存されたデータを読み込む
        const savedDataString = localStorage.getItem("proFutureReportData");

        if (savedDataString) {
          const savedData = JSON.parse(savedDataString);

          // 必要なデータ（相談内容と分析結果）が揃っているか確認
          if (
            savedData.worry &&
            savedData.paths &&
            savedData.paths.length > 0
          ) {
            console.log("保存された分析データを復元します。");

            // 相談内容をテキストエリアに再設定
            document.getElementById("worryInput").value = savedData.worry;

            // 分析結果のUIを再描画
            // (AIによる推測の根拠などは復元されませんが、グラフやシナリオは復元されます)
            updateUI(savedData.paths);
          }
        }
      }
      // future_simulator.html の <script> 内に追加する

      /**
       * OS分析のデータをlocalStorageから読み込む
       */
      function getOsAnalyzerData() {
        try {
          const data = localStorage.getItem("haqeiOsAnalyzerData");
          return data ? JSON.parse(data) : null;
        } catch (e) {
          console.error("OS分析データの読み込みに失敗しました。", e);
          return null;
        }
      }
      function sendAnonymousData(professionalData) {
        if (
          !professionalData ||
          !professionalData.profile ||
          !professionalData.analysis ||
          !professionalData.selectedFuture
        ) {
          console.log("送信するための分析データが不十分です。");
          return;
        }

        const anonymousPayload = {
          mbti: professionalData.profile.mbti,
          enneagram: professionalData.profile.enneagram,
          os_engine: professionalData.analysis.hexagram_candidates[0]?.name_jp,
          os_interface:
            professionalData.analysis.hexagram_candidates[1]?.name_jp,
          start_hexagram:
            professionalData.selectedFuture.path[0]?.["親となる卦"],
          selected_scenario_rank: professionalData.selectedFuture.rank,
          selected_scenario_path: professionalData.selectedFuture.path
            .slice(1)
            .map((p) => (p.choice === "change" ? "変" : "進"))
            .join("→"),
          final_hexagram:
            professionalData.selectedFuture.path[3]?.["親となる卦"],
          worry_word_count: extractWords(professionalData.worry).length,
        };

        const endpoint = "/api/collect-anonymous-data";
        const dataToSend = JSON.stringify(anonymousPayload);

        if (navigator.sendBeacon) {
          navigator.sendBeacon(endpoint, dataToSend);
        } else {
          fetch(endpoint, {
            method: "POST",
            body: dataToSend,
            keepalive: true,
            headers: { "Content-Type": "application/json" },
          });
        }
      }

      /**
       * 「深掘り分析」ボタンがクリックされた時の処理
       * @param {Event} event - クリックイベント
       */
      function handleDeepDiveClick(event) {
        event.preventDefault(); // ページ遷移を一旦停止

        // 1. OS分析の結果をlocalStorageから読み込む
        const osData = getOsAnalyzerData();
        if (!osData) {
          showModal(
            `<h2 class="text-2xl font-bold text-yellow-400 mb-4">OS分析データがありません</h2><p>この機能を利用するには、先に「人格OS分析」を実行する必要があります。</p><a href="./os_analyzer.html" class="inline-block mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg">OS分析ページへ移動</a>`
          );
          return;
        }

        // 2. 未来予測の分析結果が揃っているか確認
        if (
          !currentAnalysisData.worry ||
          !currentAnalysisData.paths ||
          currentAnalysisData.paths.length === 0
        ) {
          showModal(
            `<h2 class="text-2xl font-bold text-yellow-400 mb-4">未来予測データがありません</h2><p>先に「予測実行」ボタンを押して、分析を完了させてください。</p>`
          );
          return;
        }

        const button = event.target.closest(".deep-dive-btn");
        const scenarioIndex = parseInt(button.dataset.scenarioIndex, 10);

        // 3. 必要な情報をすべて統合したデータオブジェクトを作成
        const professionalData = {
          analysis: osData.analysisResult, // OS分析結果
          context: osData.userContext, // OS分析時のユーザー状況
          profile: osData.userProfile, // OS分析時のユーザープロファイル
          worry: currentAnalysisData.worry, // 未来予測で入力した課題
          selectedFuture: {
            path: currentAnalysisData.paths[scenarioIndex], // 選択した未来シナリオの全ステップ情報
            rank:
              ["S", "A", "B", "C", "D", "E", "F", "H"][scenarioIndex] || "N/A",
          },
        };

        // 4. localStorageに "haqeiProfessionalData" というキーで保存
        localStorage.setItem(
          "haqeiProfessionalData",
          JSON.stringify(professionalData)
        );
        sendAnonymousData(professionalData);
        // 5. professional_report.html へ遷移
        window.location.href = button.href;
      }
      function getScoreEvaluation(score) {
        if (score >= 80) return { label: "Excellent", colorClass: "bg-green-500 text-white", desc: "非常に良い状況です。", };
        if (score >= 60) return { label: "Good", colorClass: "bg-emerald-500 text-white", desc: "良い状況です。チャンスを活かしましょう。", };
        if (score >= 40) return { label: "Average", colorClass: "bg-yellow-500 text-white", desc: "平均的な状況。油断は禁物です。", };
        if (score >= 20) return { label: "Poor", colorClass: "bg-orange-500 text-white", desc: "厳しい状況。慎重な判断が必要です。", };
        return { label: "Critical", colorClass: "bg-red-600 text-white", desc: "極めて危険な状況。抜本的な対策が必要です。", };
      }

      function getTransitionCostEvaluation(cost) {
        if (cost <= 20) return { label: "絶好機", colorClass: "bg-sky-500 text-white", desc: "極めて変化しやすい絶好のチャンス期間です。", };
        if (cost <= 40) return { label: "好機", colorClass: "bg-teal-500 text-white", desc: "変化を起こしやすい好機です。", };
        if (cost <= 60) return { label: "普通", colorClass: "bg-gray-500 text-white", desc: "変化には相応のエネルギーが必要です。", };
        if (cost <= 80) return { label: "困難", colorClass: "bg-rose-500 text-white", desc: "変化は困難。現状維持も視野に。", };
        return { label: "膠着", colorClass: "bg-zinc-700 text-white", desc: "変化は極めて困難。今は動くべき時ではありません。", };
      }

      function renderCurrentStateBarChart(state) {
        if (currentStateBarChartInstance) { currentStateBarChartInstance.destroy(); }
        const ctx = document.getElementById("currentStateBarChart").getContext("2d");
        if (!ctx) return;
        const data = [ state.S1_基本スコア, state.S2_ポテンシャル, state.S3_安定性スコア, Math.abs(state.S4_リスク), state.S6_変動性スコア, ];
        const colors = [ "rgba(96, 165, 250, 0.8)", "rgba(52, 211, 153, 0.8)", "rgba(167, 139, 250, 0.8)", "rgba(248, 113, 113, 0.8)", "rgba(251, 191, 36, 0.8)", ];
        currentStateBarChartInstance = new Chart(ctx, { type: "bar", data: { labels: ["基本", "潜在力", "安定性", "リスク", "変動性"], datasets: [{ data: data, backgroundColor: colors, borderWidth: 0, barPercentage: 0.8, categoryPercentage: 0.9, }, ], }, options: { responsive: true, maintainAspectRatio: false, indexAxis: "y", scales: { x: { display: true, min: 0, max: 100, grid: { color: "rgba(255, 255, 255, 0.1)" }, ticks: { color: "#9ca3af", font: { size: 10 } }, }, y: { grid: { display: false, drawBorder: false }, ticks: { color: "#e5e7eb", font: { size: 12, weight: "500" } }, }, }, plugins: { legend: { display: false }, tooltip: { enabled: true, callbacks: { label: function (context) { let label = context.dataset.label || ""; if (label) { label += ": "; } if (context.parsed.x !== null) { label += context.parsed.x; } return label; }, }, }, }, }, });
      }

      function evaluateSpiralProgress(currentState, futureState) {
        const changes = { sogo: futureState.S7_総合評価スコア - currentState.S7_総合評価スコア, antei: futureState.S3_安定性スコア - currentState.S3_安定性スコア, senzai: futureState.S2_ポテンシャル - currentState.S2_ポテンシャル, risk: currentState.S4_リスク - futureState.S4_リスク, };
        const EXCELLENT_SCORE_THRESHOLD = 75, SOGO_LARGE_UP_THRESHOLD = 15, SOGO_UP_THRESHOLD = 5, SOGO_STAGNATE_THRESHOLD = -2, SENZAI_LARGE_UP_THRESHOLD = 10, ANTEI_UP_THRESHOLD = 5, RISK_LARGE_DOWN_THRESHOLD = 10, STAGNATE_THRESHOLD = 2;
        if (changes.sogo >= SOGO_LARGE_UP_THRESHOLD) return futureState.S7_総合評価スコア >= EXCELLENT_SCORE_THRESHOLD ? { trend: "飛躍的成長", message: "素晴らしい飛躍です！状況が劇的に好転し、高評価の領域に到達しました。", colorClass: "trend-up", } : { trend: "急回復", message: "危機的状況から急速に回復しています。大きな前進ですが、まだ道半ばです。", colorClass: "trend-recovery", };
        if (changes.sogo >= SOGO_UP_THRESHOLD) { if (changes.antei >= 0) return { trend: "安定的成長", message: "理想的な進歩です。着実に階段を上っています。", colorClass: "trend-up", }; if (changes.senzai > 0) return { trend: "発展的成長", message: "良い成長です。将来の可能性を広げながら前進しています。", colorClass: "trend-invest", }; return { trend: "成長", message: "状況は好転しています。安定性も意識すると更に良いでしょう。", colorClass: "trend-up", }; }
        if (changes.sogo > SOGO_STAGNATE_THRESHOLD) { if (changes.senzai >= SENZAI_LARGE_UP_THRESHOLD) return { trend: "未来への投資", message: "未来への良い投資ができています。次のステップで大きく飛躍する可能性があります。", colorClass: "trend-invest", }; if (changes.antei >= ANTEI_UP_THRESHOLD && changes.risk >= 0) return { trend: "良い停滞", message: "賢明な停滞です。次の一歩のための安全な足場を固めています。", colorClass: "trend-stable", }; if ( Math.abs(changes.sogo) < STAGNATE_THRESHOLD && Math.abs(changes.antei) < STAGNATE_THRESHOLD ) return { trend: "注意すべき停滞", message: "状況が停滞しています。新しい視点や行動のきっかけを探す時期かもしれません。", colorClass: "trend-stagnate", }; }
        if (changes.risk >= RISK_LARGE_DOWN_THRESHOLD) return { trend: "戦略的下降", message: "賢明なリスク管理です。大きな問題を回避するための戦略的な一歩です。", colorClass: "trend-risk-mgmt", };
        if (changes.risk < 0) return { trend: "危険な下降", message: "注意が必要です。状況が悪化する可能性があります。原因を見直すべきです。", colorClass: "trend-down", };
        return { trend: "下降傾向", message: "状況が少し後退しています。原因を分析し、次の手を考えましょう。", colorClass: "trend-down", };
      }

      function renderSummaryChart(sortedPaths) {
        if (summaryChartInstance) summaryChartInstance.destroy();
        const ctx = document.getElementById("summaryChart").getContext("2d");
        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];
        const currentScore = sortedPaths[0][0].S7_総合評価スコア;
        const datasets = sortedPaths.map((path, index) => { const isTop = index < 4; const color = isTop ? topColors[index] : bottomColors[index - 4]; return { label: `シナリオ ${index + 1}`, data: path.map((p) => p.S7_総合評価スコア), borderColor: color, originalBorderColor: color, borderWidth: isTop ? 3.5 : 1.5, originalBorderWidth: isTop ? 3.5 : 1.5, tension: 0.1, pointRadius: 4, pointBackgroundColor: "white", originalPointBackgroundColor: "white", pointHoverRadius: 6, }; });
        summaryChartInstance = new Chart(ctx, { type: "line", data: { labels: ["現在地", "フェーズ1", "フェーズ2", "フェーズ3"], datasets: datasets, }, options: { responsive: true, maintainAspectRatio: false, scales: { y: { min: 0, max: 100, ticks: { color: "#9ca3af" }, grid: { color: "rgba(255, 255, 255, 0.1)" }, }, x: { ticks: { color: "#9ca3af" }, grid: { color: "rgba(255, 255, 255, 0.1)" }, }, }, plugins: { legend: { display: false }, tooltip: { mode: "index", intersect: false, callbacks: { label: function (context) { return null; }, }, }, annotation: { annotations: { currentScoreLine: { type: "line", yMin: currentScore, yMax: currentScore, borderColor: "rgb(253, 224, 71)", borderWidth: 2, borderDash: [6, 6], label: { content: "現在地のスコア", enabled: true, position: "end", backgroundColor: "rgba(253, 224, 71, 0.8)", color: "black", font: { size: 10 }, }, }, }, }, }, }, });
      }

      function highlightScenario(index) {
        if (summaryChartInstance) { summaryChartInstance.data.datasets.forEach((dataset, i) => { if (i === index) { dataset.borderWidth = 5; dataset.borderColor = dataset.originalBorderColor; dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; } else { dataset.borderWidth = 1; dataset.borderColor = "rgba(107, 114, 128, 0.5)"; dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; } }); summaryChartInstance.update("none"); }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { el.classList.remove("highlighted"); });
        document.getElementById(`card-${index}`)?.classList.add("highlighted");
        document.querySelector(`.toggle-label[data-index='${index}']`)?.classList.add("highlighted");
      }

      function resetChartHighlights() {
        if (summaryChartInstance) { summaryChartInstance.data.datasets.forEach((dataset) => { dataset.borderWidth = dataset.originalBorderWidth; dataset.borderColor = dataset.originalBorderColor; dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; }); summaryChartInstance.update("none"); }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { el.classList.remove("highlighted"); });
      }

      function highlightMultipleScenarios(choiceType, sortedPaths) {
        if (summaryChartInstance) { summaryChartInstance.data.datasets.forEach((dataset, i) => { if (i < sortedPaths.length) { const pathChoice = sortedPaths[i][1]?.choice; if (pathChoice === choiceType) { dataset.borderWidth = dataset.originalBorderWidth; dataset.borderColor = dataset.originalBorderColor; dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; } else { dataset.borderWidth = 1; dataset.borderColor = "rgba(107, 114, 128, 0.5)"; dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; } } else { dataset.borderWidth = 1; dataset.borderColor = "rgba(107, 114, 128, 0.5)"; dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; } }); summaryChartInstance.update("none"); }
      }

  
      function isInputSufficient(text) {
        if (text.length < 10) { return { isValid: false, message: "入力された内容が短すぎます。10文字以上で入力してください。", }; }
        if (!kuromojiTokenizer) { return { isValid: false, message: "AIの言語解析エンジンの準備ができていません。少し待ってから再度お試しください。", }; }
        const tokens = kuromojiTokenizer.tokenize(text);
        const meaningfulPos = ["名詞", "動詞", "形容詞"];
        const meaningfulWordCount = tokens.filter((token) => { return ( meaningfulPos.includes(token.pos) && token.pos_detail_1 !== "非自立" && token.pos_detail_1 !== "接尾" && token.pos_detail_1 !== "数" ); }).length;
        if (meaningfulWordCount < 3) { return { isValid: false, message: "文章に含まれる具体的な単語（名詞、動詞、形容詞）が少ないようです。", }; }
        return { isValid: true, message: "" };
      }

      function extractWords(text) {
        if (!kuromojiTokenizer || !text) return [];
        const tokens = kuromojiTokenizer.tokenize(text);
        const targetPos = ["名詞", "動詞", "形容詞"];
        const words = tokens.filter((token) => targetPos.includes(token.pos) && token.pos_detail_1 !== "非自立" && token.pos_detail_1 !== "接尾" && token.surface_form.length > 1).map((token) => token.basic_form);
        return [...new Set(words)];
      }

      /**
       * 感情極性の判定を行う
       * @param {string} text - 分析対象のテキスト
       * @param {Array} keywords - マッチしたキーワード
       * @returns {string} 'negative', 'positive', 'neutral'
       */
      function analyzeEmotionalContext(text, keywords) {
        const negativeContextPatterns = [
          /まだ.*ない/, /なかなか.*ない/, /思うように.*ない/,
          /苦労/, /困難/, /もどかしい/, /不安/, /悩み/,
          /進まない/, /見えない/, /足りない/, /限られて/,
          /先が見えず/, /もどかしさ/, /少しずつ/, /進んでいない/,
          /リソースが限られ/, /資金/, /投資/, /コスト/
        ];
        
        const positiveContextPatterns = [
          /順調/, /うまく/, /成功/, /達成/, /完成/, /安定/,
          /信頼を得/, /評価され/, /認められ/, /収益化/
        ];
        
        // キーワード周辺の文脈をチェック
        for (const keyword of keywords) {
          const keywordIndex = text.indexOf(keyword);
          if (keywordIndex !== -1) {
            const context = text.substring(
              Math.max(0, keywordIndex - 50), 
              keywordIndex + keyword.length + 50
            );
            
            const isNegativeContext = negativeContextPatterns.some(pattern => 
              pattern.test(context)
            );
            
            if (isNegativeContext) {
              return 'negative'; // キーワードがネガティブ文脈で使われている
            }
          }
        }
        
        // 全体的な感情極性をチェック
        const negativeCount = negativeContextPatterns.filter(pattern => pattern.test(text)).length;
        const positiveCount = positiveContextPatterns.filter(pattern => pattern.test(text)).length;
        
        if (negativeCount > positiveCount) return 'negative';
        if (positiveCount > negativeCount) return 'positive';
        return 'neutral';
      }

      /**
       * 時制と状態の分析を行う
       * @param {string} text - 分析対象のテキスト
       * @returns {string} 'current_struggle', 'future_aspiration', 'neutral'
       */
      function analyzeTemporalContext(text) {
        const futureAspirationPatterns = [
          /ために/, /目指して/, /したい/, /なりたい/,
          /将来の/, /これからの/, /いつかの/, /収益化したい/,
          /.*のために.*選んだ/
        ];
        
        const currentStrugglePatterns = [
          /今は/, /現在/, /まだ.*ない/, /途中/, /過程/,
          /開発中/, /進行中/, /取り組んで/, /先が見えず/,
          /もどかしさ/, /少しずつ/, /進んでいない/
        ];
        
        if (currentStrugglePatterns.some(pattern => pattern.test(text))) {
          return 'current_struggle'; // 現在進行中の課題
        }
        
        if (futureAspirationPatterns.some(pattern => pattern.test(text))) {
          return 'future_aspiration'; // 将来への願望
        }
        
        return 'neutral';
      }

      /**
       * セマンティック関連度計算
       * @param {string} inputText - ユーザー入力テキスト
       * @param {Object} lineData - 爻データ
       * @param {string} matchedKeyword - マッチしたキーワード
       * @returns {Object} {multiplier: number, confidence: number}
       */
      function calculateSemanticRelevance(inputText, lineData, matchedKeyword) {
        // TF-IDF風の単語重要度計算
        const inputWords = extractWords(inputText);
        const summaryWords = extractWords(lineData.現代解釈の要約 || '');
        
        // 共通語彙の計算
        const commonWords = inputWords.filter(word => summaryWords.includes(word));
        const commonWordRatio = commonWords.length / Math.max(inputWords.length, 1);
        
        // キーワードの重要度評価
        const keywordImportance = evaluateKeywordImportance(matchedKeyword, inputText);
        
        // セマンティック類似度の計算
        const semanticSimilarity = calculateJaccardSimilarity(inputWords, summaryWords);
        
        // 最終的な関連度乗数（0.5〜1.5の範囲）
        const multiplier = Math.max(0.5, Math.min(1.5, 
          0.7 + (commonWordRatio * 0.3) + (keywordImportance * 0.3) + (semanticSimilarity * 0.2)
        ));
        
        // 信頼度スコア（0〜1）
        const confidence = (commonWordRatio + keywordImportance + semanticSimilarity) / 3;
        
        return { multiplier, confidence };
      }

      /**
       * キーワード重要度評価
       * @param {string} keyword - 評価対象キーワード
       * @param {string} text - 全体テキスト
       * @returns {number} 0〜1の重要度スコア
       */
      function evaluateKeywordImportance(keyword, text) {
        const textLength = text.length;
        const keywordLength = keyword.length;
        const occurrences = (text.match(new RegExp(keyword, 'g')) || []).length;
        
        // 相対的重要度（テキスト長との比率）
        const relativeImportance = (keywordLength * occurrences) / textLength;
        
        // 出現頻度による重要度調整
        const frequencyBonus = Math.min(0.3, occurrences * 0.1);
        
        return Math.min(1, relativeImportance * 10 + frequencyBonus);
      }

      /**
       * Jaccard類似度計算
       * @param {Array} set1 - 単語配列1
       * @param {Array} set2 - 単語配列2
       * @returns {number} 0〜1の類似度
       */
      function calculateJaccardSimilarity(set1, set2) {
        const intersection = set1.filter(word => set2.includes(word));
        const union = [...new Set([...set1, ...set2])];
        
        return union.length === 0 ? 0 : intersection.length / union.length;
      }

      /**
       * コンテキスト適合度評価
       * @param {string} emotionalContext - 感情コンテキスト
       * @param {string} temporalContext - 時間コンテキスト
       * @param {string} contextType - コンテキスト種別
       * @param {Object} lineData - 爻データ
       * @returns {number} -0.2〜0.2の適合度調整値
       */
      function evaluateContextFit(emotionalContext, temporalContext, contextType, lineData) {
        let fitScore = 0;
        const summary = lineData.現代解釈の要約 || '';
        const hexagramName = lineData["親となる卦"] || '';
        
        // 感情コンテキストとの適合度（軽微な調整のみ）
        if (emotionalContext === 'negative') {
          if (summary.includes('解決') || summary.includes('改善') || summary.includes('希望')) {
            fitScore += 0.1; // ポジティブな解決策を軽く優遇
          }
        } else if (emotionalContext === 'positive') {
          if (summary.includes('発展') || summary.includes('成長') || summary.includes('前進')) {
            fitScore += 0.05; // 発展系を軽く優遇
          }
        }
        
        // 時間コンテキストとの適合度
        if (temporalContext === 'current_struggle') {
          if (summary.includes('継続') || summary.includes('努力') || summary.includes('過程')) {
            fitScore += 0.1; // プロセス重視の内容を軽く優遇
          }
        }
        
        // コンテキスト種別との適合度
        if (contextType === 'personal' && summary.includes('自己')) {
          fitScore += 0.05;
        } else if (contextType === 'social' && (summary.includes('組織') || summary.includes('社会'))) {
          fitScore += 0.05;
        }
        
        // 適合度を-0.2〜0.2の範囲に制限
        return Math.max(-0.2, Math.min(0.2, fitScore));
      }

      /**
       * 適応的閾値計算
       * @param {Array} scores - 全スコア配列
       * @param {number} textLength - 入力テキスト長
       * @returns {number} 動的計算された閾値
       */
      function calculateAdaptiveThreshold(scores, textLength) {
        if (scores.length === 0) return 10; // デフォルト最小閾値
        
        // 統計的指標の計算
        const sortedScores = scores.sort((a, b) => b - a);
        const median = sortedScores[Math.floor(sortedScores.length / 2)];
        const average = scores.reduce((sum, score) => sum + score, 0) / scores.length;
        
        // テキスト長による基本閾値調整
        const textLengthFactor = Math.min(1.5, Math.max(0.5, textLength / 100));
        
        // スコア分布による閾値調整
        const scoreDistributionFactor = sortedScores.length > 10 ? 0.8 : 1.0;
        
        // 最終閾値計算（中央値と平均値の重み付き平均）
        const baseThreshold = (median * 0.6) + (average * 0.4);
        const adaptiveThreshold = Math.round(baseThreshold * textLengthFactor * scoreDistributionFactor);
        
        // 最小・最大閾値の制限
        return Math.max(5, Math.min(50, adaptiveThreshold));
      }

      /**
       * コンテキスト自動識別エンジン
       * @param {string} text - 分析対象のテキスト
       * @returns {string} 'personal', 'social'
       */
      function analyzeContextType(text) {
        const personalKeywords = ['私', '自分', '私の', '不安', 'もどかしい', '悩み', '感じる', '思う', '心配', '困っている', '迷っている', '自信がない', '焦っている'];
        const socialKeywords = ['会社', 'チーム', '組織', 'プロジェクト', '社会', '経済', '政治', '業界', '部署', '部門', '企業', '市場', '競合', '顧客', 'ユーザー', 'ステークホルダー'];

        const hasPersonalKeywords = personalKeywords.some(keyword => text.includes(keyword));
        const hasSocialKeywords = socialKeywords.some(keyword => text.includes(keyword));

        if (hasPersonalKeywords || (!hasPersonalKeywords && !hasSocialKeywords)) {
          return 'personal';
        } else if (hasSocialKeywords) {
          return 'social';
        }
      }

      /**
       * コンテキスト確認モーダルの表示
       * @param {string} contextType - コンテキストタイプ
       * @returns {Promise<boolean>} ユーザーの選択結果
       */
      function showContextConfirmModal(contextType) {
        return new Promise((resolve) => {
          const modalContent = `
            <h2 class="text-2xl font-bold text-indigo-300 mb-4">AIによるコンテキスト分析</h2>
            <p class="mb-6">
              ご入力いただいた内容を分析した結果、これは主に<strong class="text-yellow-300">「${
                contextType === 'personal' ? 'あなた個人の内面的な' : '組織や社会といった外部環境の'
              }課題」</strong>であると推測しました。<br>
              この解釈に基づき、分析を進めてよろしいでしょうか？
            </p>
            <div class="flex justify-center space-x-4">
              <button id="confirmYesBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">はい、この解釈で進める</button>
              <button id="confirmNoBtn" class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">いいえ、解釈を切り替える</button>
            </div>
          `;
          showModal(modalContent);

          const confirmYesBtn = document.getElementById('confirmYesBtn');
          const confirmNoBtn = document.getElementById('confirmNoBtn');

          confirmYesBtn.addEventListener('click', () => {
            hideModal();
            resolve(true);
          });

          confirmNoBtn.addEventListener('click', () => {
            hideModal();
            resolve(false);
          });
        });
      }

      /**
       * コンテキスト切り替え通知モーダルの表示
       * @param {string} switchedContextType - 切り替え後のコンテキストタイプ
       * @returns {Promise<void>}
       */
      function showContextSwitchModal(switchedContextType) {
        return new Promise((resolve) => {
          const modalContent = `
            <h2 class="text-2xl font-bold text-indigo-300 mb-4">コンテキスト解釈の切り替え</h2>
            <p class="mb-6">
              では、<strong class="text-yellow-300">「${
                switchedContextType === 'personal' ? 'あなた個人の内面的な' : '組織や社会といった外部環境の'  
              }課題」</strong>として分析を進めます。
            </p>
            <div class="flex justify-center">
              <button id="switchConfirmBtn" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">OK</button>
            </div>
          `;
          showModal(modalContent);

          const switchConfirmBtn = document.getElementById('switchConfirmBtn');
          switchConfirmBtn.addEventListener('click', () => {
            hideModal();
            resolve();  
          });
        });
      }

      async function callAIAssistant(worryText, h384Data, futureThemeMap, contextType = 'personal') {
        if (!kuromojiTokenizer) { 
          showModal(`<h2 class="text-2xl font-bold text-yellow-400 mb-4">AI準備中</h2><p>AIの言語解析エンジンの準備がまだ完了していません。</p>`); 
          return null; 
        }
        
        let bestMatch = { score: -Infinity, line: null, matchedWords: [], reasonKeywords: [], };
        const worryWords = extractWords(worryText);
        let allScores = [];
        
        // 感情極性と時制を分析
        const emotionalContext = analyzeEmotionalContext(worryText, worryWords);
        const temporalContext = analyzeTemporalContext(worryText);
        
        console.log('文脈分析結果:', { emotionalContext, temporalContext, contextType });
        
        h384Data.forEach((lineData) => {
          const themeData = futureThemeMap[lineData.通し番号];
          if (!themeData) return;
          
          let currentScore = 0;
          let reasonKeywords = [];
          let currentMatchedWords = [];
          let confidenceScores = [];
          
          // キーワードマッチング（改善されたロジック）
          if (themeData.positive_keywords && Array.isArray(themeData.positive_keywords)) {
            themeData.positive_keywords.forEach((keywordGroup) => {
              const foundKw = keywordGroup.find((kw) => 
                worryText.includes(kw) || worryWords.includes(kw)
              );
              
              if (foundKw) {
                let keywordScore = 30;
                
                // セマンティックマッチングによる動的スコア調整
                const semanticRelevance = calculateSemanticRelevance(worryText, lineData, foundKw);
                keywordScore = Math.round(keywordScore * semanticRelevance.multiplier);
                
                // コンテキスト適合度による軽微な調整（硬直的バイアス除去）
                const contextFit = evaluateContextFit(emotionalContext, temporalContext, contextType, lineData);
                keywordScore = Math.round(keywordScore * (1 + contextFit * 0.1));
                
                currentScore += keywordScore;
                reasonKeywords.push(keywordGroup[0]);
                confidenceScores.push(semanticRelevance.confidence);
                if (worryText.includes(foundKw)) {
                  currentMatchedWords.push(foundKw);
                }
              }
            });
          }
          
          // 既存のキーワードマッチング
          if (lineData.キーワード) {
            const keywords = lineData.キーワード.split(/、|,/);
            keywords.forEach((kw) => {
              if (worryText.includes(kw.trim())) {
                currentScore += 10;
              }
            });
          }
          
          // 現代解釈の要約との重み付き類似度
          if (lineData.現代解釈の要約 && worryWords.length > 0) {
            const summarySemanticRelevance = calculateSemanticRelevance(worryText, lineData, "");
            const weightedSimilarityScore = Math.round(15 * summarySemanticRelevance.multiplier);
            currentScore += weightedSimilarityScore;
            confidenceScores.push(summarySemanticRelevance.confidence);
          }
          
          // ネガティブキーワードのペナルティ
          if (themeData.negative_keywords && Array.isArray(themeData.negative_keywords)) {
            themeData.negative_keywords.forEach((keywordGroup) => {
              if (keywordGroup.some((kw) => worryText.includes(kw) || worryWords.includes(kw))) {
                currentScore += -20;
              }
            });
          }
          
          // 全スコアを記録（適応的閾値計算用）
          if (currentScore > 0) {
            allScores.push(currentScore);
          }
          
          if (currentScore > bestMatch.score) {
            // 信頼度スコアの計算（平均値）
            const averageConfidence = confidenceScores.length > 0 
              ? confidenceScores.reduce((sum, score) => sum + score, 0) / confidenceScores.length 
              : 0.5;
            
            bestMatch = {
              score: currentScore,
              line: lineData,
              matchedWords: [...new Set(currentMatchedWords)],
              reasonKeywords: [...new Set(reasonKeywords)],
              confidence: averageConfidence,
            };
          }
        });
        
        // 適応的閾値による結果検証
        const adaptiveThreshold = calculateAdaptiveThreshold(allScores, worryText.length);
        
        if (bestMatch.line && bestMatch.score >= adaptiveThreshold) {
          const { line, matchedWords, reasonKeywords, confidence } = bestMatch;
          const lineNum = ["初", "二", "三", "四", "五", "上"].findIndex((l) => line.爻.includes(l)) + 1;
          let mainTheme = reasonKeywords.length > 0 ? reasonKeywords.join("、") : `${line["親となる卦"]} ${line.爻}の持つテーマ`;
          
          // 信頼度表示の準備
          const confidencePercent = Math.round(confidence * 100);
          const confidenceLevel = confidence >= 0.8 ? "高" : confidence >= 0.6 ? "中" : "低";
          const confidenceColor = confidence >= 0.8 ? "text-green-400" : confidence >= 0.6 ? "text-yellow-400" : "text-orange-400";
          
          // 文脈分析結果を含めた根拠説明
          let contextInfo = "";
          if (emotionalContext === 'negative') {
            contextInfo += "現在の状況は困難や課題を抱えている状態と判断され、";
          }
          if (temporalContext === 'current_struggle') {
            contextInfo += "進行中の取り組みや発展段階にある状況と分析されました。";
          }
          
          // コンテキスト情報を追加
          const contextTypeText = contextType === 'personal' ? '個人の内面的な課題' : '組織や社会といった外部環境の課題';
          contextInfo += `また、これは<strong>${contextTypeText}</strong>として分析されました。`;
          
          const reasoning = `AIの推測: ${contextInfo}ご相談の状況は、<strong>${line["親となる卦"]} ${line.爻}</strong>の持つ<strong>「${mainTheme}」</strong>というテーマと強く結びついていると判断しました。<br><small class="${confidenceColor}">予測信頼度: ${confidenceLevel} (${confidencePercent}%)</small>`;
          
          return {
            卦番号: line.卦番号,
            爻番号: lineNum,
            根拠: reasoning,
            信頼度: confidence,
          };
        }
        return null;
      }
    </script>
    <footer class="bg-gray-800">
      <footer class="w-full max-w-4xl mx-auto text-center p-6 mt-8 border-t border-gray-700">
    <div class="space-x-4 mb-4">
        <a href="/terms.html" target="_blank" class="text-sm text-gray-400 hover:text-white">利用規約</a>
        <a href="/privacy.html" target="_blank" class="text-sm text-gray-400 hover:text-white">プライバシーポリシー</a>
    </div>
      <div class="container mx-auto px-6 py-4 text-center text-gray-400">
        <p>&copy; 2025 HaQei. All Rights Reserved.</p>
      </div>
    </footer>
  </body>
</html>
