<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei æˆ¦ç•¥ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ</title>
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>æ˜“</text></svg>"
    />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      .module {
        background: rgba(17, 24, 39, 0.5);
        border: 1px solid rgba(55, 65, 81, 0.5);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }
      .module-title {
        font-family: "Shippori Mincho", serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: #c7d2fe;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #4f46e5;
        padding-bottom: 0.75rem;
      }
      .os-card {
        background-color: #111827;
        border-radius: 0.75rem;
        padding: 1.25rem;
        text-align: center;
        border: 1px solid #374151;
      }
      .os-icon {
        font-size: 1.5rem;
        line-height: 1;
      }
      .os-type {
        font-size: 0.75rem;
        font-weight: 500;
        color: #9ca3af;
        margin-top: 0.25rem;
      }
      .os-name {
        font-family: "Shippori Mincho", serif;
        font-size: 1.5rem;
        font-weight: 700;
        color: #e5e7eb;
        margin-top: 0.5rem;
      }
      .os-reading {
        font-size: 0.75rem;
        color: #6b7280;
      }
      .ai-title {
        font-family: "Shippori Mincho", serif;
        font-size: 1.75rem;
        font-weight: 700;
        color: #c7d2fe;
        text-align: center;
        margin-bottom: 1.5rem;
        line-height: 1.4;
      }
      .ai-text {
        color: #d1d5db;
        line-height: 1.8;
        max-width: 48rem;
        margin-left: auto;
        margin-right: auto;
        background-color: rgba(17, 24, 39, 0.5);
        padding: 1rem 1.5rem;
        border-radius: 0.5rem;
      }
      .ai-text strong {
        color: #fde047;
      }
      .special-lens-card {
        background-color: #1f2937;
        border-radius: 0.5rem;
        padding: 1rem;
        text-align: center;
        height: 100%;
      }
      .scenario-card {
        background-color: #1f2937;
        border-radius: 0.5rem;
        padding: 1rem;
        transition: all 0.2s ease-in-out;
      }
      .scenario-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2),
          0 4px 6px -4px rgba(99, 102, 241, 0.2);
      }
    </style>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-8">
    <div class="w-full max-w-5xl mx-auto">
      <header class="text-center mb-12">
        <h1 class="text-4xl sm:text-5xl font-bold brand-text tracking-wider">
          HaQei æˆ¦ç•¥ã‚³ãƒƒã‚¯ãƒ”ãƒƒãƒˆ
        </h1>
        <p class="text-gray-400 mt-3 text-lg">
          ã‚ãªãŸã¨ã„ã†å”¯ä¸€ã®å­˜åœ¨ã‚’ã€ç«‹ä½“çš„ã«ç†è§£ã™ã‚‹å ´æ‰€
        </p>
      </header>

      <div id="module0" class="module hidden">
        <div
          id="os-summary-cards"
          class="grid grid-cols-1 sm:grid-cols-3 gap-6 mb-8"
        ></div>
        <hr class="border-gray-700/50 my-8" />
        <div id="ai-synthesis-content">
          <div id="ai-loading-placeholder" class="text-center py-8">
            <div class="flex justify-center items-center">
              <div
                class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-300"
              ></div>
              <p class="ml-4 text-gray-400">
                AIãŒã‚ãªãŸã®ãŸã‚ã®çµ±åˆåˆ†æã‚’ç”Ÿæˆä¸­...
              </p>
            </div>
          </div>
        </div>
        <div class="mt-8 text-right">
          <a
            href="os_analyzer.html"
            class="text-sm text-indigo-400 hover:text-indigo-300 transition-colors"
          >
            â†’ OSåˆ†æãƒ¬ãƒãƒ¼ãƒˆå…¨ä½“ã‚’å†ç¢ºèªã™ã‚‹
          </a>
        </div>
      </div>

      <div id="module1" class="module">
        <h2 class="module-title">ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«1: ã‚ãªãŸã®äººæ ¼OS - è‡ªå·±ã®æ ¹å¹¹</h2>
        <div
          id="module1-content"
          class="grid md:grid-cols-2 gap-8 items-center"
        ></div>
      </div>

      <div id="module2" class="module hidden">
        <h2 class="module-title">
          ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«2: ï¼“ã¤ã®ç‰¹æ®Šãƒ¬ãƒ³ã‚º - OSã®å¤šè§’çš„åˆ†æ
        </h2>
        <div
          id="module2-content"
          class="grid grid-cols-1 md:grid-cols-3 gap-6"
        ></div>
      </div>

      <div id="module3" class="module">
        <h2 class="module-title">
          ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«3: ç¾åœ¨åœ°ã®ç¾…é‡ç›¤ - ãƒŸã‚¯ãƒ­ãªå¤‰åŒ–äºˆæ¸¬
        </h2>
        <div id="module3-content">
          <div class="bg-gray-900/50 p-4 rounded-lg">
            <p class="text-center mb-4">
              ã‚ãªãŸã®ã€Œç¾åœ¨åœ°ã€ã‚’å…¥åŠ›ã—ã€ã©ã®ã‚ˆã†ãªæœªæ¥ã®å¯èƒ½æ€§ãŒã‚ã‚‹ã‹ã‚’æ¢ã‚Šã¾ã—ã‚‡ã†ã€‚<br />
              <a
                href="future_simulator.html"
                class="text-sm text-indigo-400 hover:text-indigo-300"
                >â†’ æœªæ¥åˆ†å²ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§å†äºˆæ¸¬ã™ã‚‹</a
              >
            </p>
            <div
              class="flex flex-col sm:flex-row items-center justify-center gap-4"
            >
              <div>
                <label
                  for="hexagramInput"
                  class="block text-sm font-medium text-gray-300 mb-1"
                  >ä»Šã®çŠ¶æ³ï¼ˆå¦ï¼‰</label
                >
                <input
                  type="text"
                  id="hexagramInput"
                  list="hexagram-names"
                  class="bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2 text-center"
                  placeholder="ä¾‹: ä¹¾ç‚ºå¤© or 1"
                />
              </div>
              <div>
                <label
                  for="lineInput"
                  class="block text-sm font-medium text-gray-300 mb-1"
                  >ã‚ãªãŸã®ç«‹ã¡ä½ç½®ï¼ˆçˆ»ï¼‰</label
                >
                <input
                  type="number"
                  id="lineInput"
                  min="1"
                  max="6"
                  class="bg-gray-700 border border-gray-600 text-white rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-2 text-center"
                  placeholder="ä¾‹: 1"
                />
              </div>
              <button
                id="predictBtn"
                class="w-full sm:w-auto mt-4 sm:self-end bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300"
              >
                æœªæ¥ã‚’äºˆæ¸¬
              </button>
            </div>
          </div>
          <div id="prediction-summary" class="mt-6 hidden"></div>
        </div>
      </div>

      <div id="module4" class="module hidden">
        <h2 class="module-title">ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«4: å¤§å±€è¦³ãƒ¢ãƒ‹ã‚¿ãƒ¼ - ãƒã‚¯ãƒ­ãªç‰©èª</h2>
        <div id="module4-content"></div>
      </div>
    </div>
    <datalist id="hexagram-names"></datalist>

    <script type="module">
      let HAQEI_DATA = null;
      let osAnalysisData = null;
      let current8Paths = [];

      async function main() {
        try {
          const response = await fetch("/api/data");
          if (!response.ok)
            throw new Error("ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
          const apiData = await response.json();
          HAQEI_DATA = apiData.HAQEI_DATA;

          setupDatalist();
          initializeAiSynthesisModule();
          initializeOSModules();
          loadAndRenderFutureSimData();

          document
            .getElementById("predictBtn")
            .addEventListener("click", handleFuturePrediction);
        } catch (error) {
          console.error("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:", error);
          document.getElementById(
            "module1-content"
          ).innerHTML = `<p class="text-red-400">ã‚·ã‚¹ãƒ†ãƒ ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>`;
        }
      }

      document.addEventListener("DOMContentLoaded", main);

      function initializeAiSynthesisModule() {
        const module0 = document.getElementById("module0");
        const osDataString = localStorage.getItem("haqeiOsAnalyzerData");

        if (!osDataString) {
          module0.style.display = "none";
          return;
        }

        module0.classList.remove("hidden");
        try {
          const parsedOsData = JSON.parse(osDataString);
          osAnalysisData = parsedOsData; // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«æ ¼ç´
          renderOsCards(parsedOsData.analysisResult);
          fetchIntegratedAnalysis(parsedOsData);
        } catch (e) {
          console.error("OSåˆ†æãƒ‡ãƒ¼ã‚¿ã®è§£æã«å¤±æ•—:", e);
          module0.innerHTML =
            '<p class="text-center text-red-400">OSåˆ†æãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
        }
      }

      function getOsIcon(osType) {
        switch (osType) {
          case "ã‚¨ãƒ³ã‚¸ãƒ³OS":
            return "ğŸ”¥";
          case "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹OS":
            return "ğŸ­";
          case "ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰OS":
            return "ğŸ›¡ï¸";
          default:
            return "âš™ï¸";
        }
      }

      function renderOsCards(analysisResult) {
        const container = document.getElementById("os-summary-cards");
        if (
          !analysisResult ||
          !analysisResult.hexagram_candidates ||
          analysisResult.hexagram_candidates.length < 3
        ) {
          container.innerHTML = `<p class="col-span-3 text-center text-gray-500">OSãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>`;
          return;
        }

        const osTypes = ["ã‚¨ãƒ³ã‚¸ãƒ³OS", "ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹OS", "ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰OS"];
        const osCardsHtml = analysisResult.hexagram_candidates
          .slice(0, 3)
          .map((os, index) => {
            const osType = osTypes[index];
            return `
            <div class="os-card">
              <div class="os-icon">${getOsIcon(osType)}</div>
              <div class="os-type">${osType}</div>
              <div class="os-name">${os.name_jp}</div>
              <div class="os-reading">${os.reading}</div>
            </div>
          `;
          })
          .join("");

        container.innerHTML = osCardsHtml;
      }

      async function fetchIntegratedAnalysis(osAnalysisData) {
        const contentArea = document.getElementById("ai-synthesis-content");
        const placeholder = document.getElementById("ai-loading-placeholder");

        if (
          !osAnalysisData ||
          !osAnalysisData.analysisResult ||
          !osAnalysisData.userContext ||
          !osAnalysisData.userProfile
        ) {
          console.error(
            "ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®OSåˆ†æãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™ã€‚",
            osAnalysisData
          );
          placeholder.style.display = "none";
          contentArea.innerHTML = `
              <div class="text-center text-red-400">
                <h2 class="ai-title">ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼</h2>
                <p>OSåˆ†æãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ãªãŸã‚ã€AIåˆ†æã‚’é–‹å§‹ã§ãã¾ã›ã‚“ã€‚<br>ãŠæ‰‹æ•°ã§ã™ãŒã€ã‚‚ã†ä¸€åº¦<a href="os_analyzer.html" class="underline font-bold">OSåˆ†æãƒšãƒ¼ã‚¸</a>ã‹ã‚‰åˆ†æã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚</p>
              </div>`;
          return;
        }

        try {
          const payload = {
            analysis: osAnalysisData.analysisResult,
            context: osAnalysisData.userContext,
            profile: {
              mbti: osAnalysisData.userProfile.mbti,
              enneagram: osAnalysisData.userProfile.enneagram,
              sf: osAnalysisData.userProfile.sf,
            },
          };

          const response = await fetch("/api/cockpit-ai", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          if (!response.ok) {
            const errorResult = await response.json().catch(() => ({}));
            throw new Error(
              errorResult.error || "AIåˆ†æã‚µãƒ¼ãƒãƒ¼ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
            );
          }

          const result = await response.json();

          placeholder.style.display = "none";

          contentArea.innerHTML = `
            <h2 class="ai-title">${result.title || "AIã«ã‚ˆã‚‹çµ±åˆåˆ†æ"}</h2>
            <div class="ai-text">
              ${result.analysis_text || "<p>åˆ†æçµæœã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>"}
            </div>
          `;
        } catch (error) {
          console.error("Cockpit AI Error:", error);
          placeholder.style.display = "none";
          contentArea.innerHTML = `
            <div class="text-center text-red-400">
              <h2 class="ai-title">åˆ†æã‚¨ãƒ©ãƒ¼</h2>
              <p>${error.message}</p>
            </div>
          `;
        }
      }

      function setupDatalist() {
        if (!HAQEI_DATA) return;
        const datalist = document.getElementById("hexagram-names");
        HAQEI_DATA.hexagrams_master.forEach((hex) => {
          const option = document.createElement("option");
          option.value = hex.name_jp;
          datalist.appendChild(option);
        });
      }

      function initializeOSModules() {
        const osDataString = localStorage.getItem("haqeiOsAnalyzerData");
        if (!osDataString) {
          document.getElementById("module1").style.display = "none";
          document.getElementById("module2").style.display = "none";
          return;
        }
        const localOsAnalysisData = JSON.parse(osDataString);
        renderModule1(localOsAnalysisData.analysisResult);
        renderModule2(localOsAnalysisData.analysisResult);
      }

      // â–¼â–¼â–¼ã€ã“ã“ã‹ã‚‰ãŒä¿®æ­£ç®‡æ‰€ã€‘â–¼â–¼â–¼
      /**
       * future_simulator.htmlã‹ã‚‰æ¸¡ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€
       * ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«3ã®ãƒ•ã‚©ãƒ¼ãƒ ã«è‡ªå‹•å…¥åŠ›ã—ã¦äºˆæ¸¬ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ã€‚
       * * ä¿®æ­£ç‚¹ï¼š
       * 1. èª­ã¿è¾¼ã‚€localStorageã®ã‚­ãƒ¼ã‚’ã€ã‚ˆã‚Šå®Ÿæ…‹ã«å³ã—ãŸ `haqeiFutureSimData` ã«å¤‰æ›´ã€‚
       * 2. éå»ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã¨ã®äº’æ›æ€§ã®ãŸã‚ã€å¤ã„ã‚­ãƒ¼ `proFutureReportData` ã‚‚ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã€‚
       * 3. ã©ã¡ã‚‰ã®ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã§ã‚‚æ­£ã—ãå¦ã¨çˆ»ã®ç•ªå·ã‚’å–å¾—ã§ãã‚‹ã‚ˆã†ã€å‡¦ç†ã‚’å …ç‰¢åŒ–ã€‚
       * 4. ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã¯ã€ä¸è¦ã«ãªã£ãŸã‚­ãƒ¼ã‚’localStorageã‹ã‚‰å‰Šé™¤ã™ã‚‹ã€‚
       */
      function loadAndRenderFutureSimData() {
        // æ–°æ—§ä¸¡æ–¹ã®ã‚­ãƒ¼ã‚’è©¦ã™
        const keysToCheck = ["haqeiFutureSimData", "proFutureReportData"];
        let futureDataString = null;
        let foundKey = null;

        for (const key of keysToCheck) {
          const data = localStorage.getItem(key);
          if (data) {
            futureDataString = data;
            foundKey = key;
            break;
          }
        }

        if (!futureDataString) return; // ãƒ‡ãƒ¼ã‚¿ãŒãªã‘ã‚Œã°ä½•ã‚‚ã—ãªã„

        try {
          const futureData = JSON.parse(futureDataString);
          let hexNum = null;
          let lineNum = null;

          // ãƒ‡ãƒ¼ã‚¿æ§‹é€ ã‚’åˆ¤åˆ¥ã—ã¦ã€å¦ã¨çˆ»ã®ç•ªå·ã‚’å–å¾—ã™ã‚‹
          if (futureData && futureData.startState) {
            // æ–°ã—ã„æ§‹é€  { startState: {...} }
            hexNum = futureData.startState.å¦ç•ªå·;
            lineNum = futureData.startState.lineNum;
          } else if (futureData && futureData.paths) {
            // å¤ã„æ§‹é€  { paths: [[...]] }
            const startState = futureData.paths[0][0];
            hexNum = startState.å¦ç•ªå·;
            lineNum = startState.lineNum;
          }

          if (hexNum && lineNum) {
            const hexInput = document.getElementById("hexagramInput");
            const lineInput = document.getElementById("lineInput");
            const hexData = HAQEI_DATA.hexagrams_master.find(
              (h) => h.hexagram_id === hexNum
            );

            if (hexData) hexInput.value = hexData.name_jp;
            lineInput.value = lineNum;

            // ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›å¾Œã€å³åº§ã«äºˆæ¸¬ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
            document.getElementById("predictBtn").click();

            // ä½¿ç”¨æ¸ˆã¿ã®ãƒ‡ãƒ¼ã‚¿ã‚’localStorageã‹ã‚‰å‰Šé™¤
            localStorage.removeItem(foundKey);
          }
        } catch (e) {
          console.error("æœªæ¥åˆ†å²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯æç”»ã«å¤±æ•—ã—ã¾ã—ãŸ:", e);
          // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ã€ä»–ã®å‡¦ç†ã«å½±éŸ¿ã‚’ä¸ãˆãªã„ã‚ˆã†ã«ã‚­ãƒ¼ã‚’å‰Šé™¤
          if (foundKey) {
            localStorage.removeItem(foundKey);
          }
        }
      }
      // â–²â–²â–²ã€ã“ã“ã¾ã§ãŒä¿®æ­£ç®‡æ‰€ã€‘â–²â–²â–²

      function renderModule1(analysisResult) {
        const container = document.getElementById("module1-content");
        if (
          !analysisResult ||
          !analysisResult.hexagram_candidates ||
          analysisResult.hexagram_candidates.length === 0
        )
          return;
        const primaryOS = analysisResult.hexagram_candidates[0];
        const tuanDen = HAQEI_DATA.bible.tuan_den[primaryOS.hexagram_id];
        const infoHtml = `
          <div>
            <p class="text-gray-400 text-sm">ã‚ãªãŸã®æ ¹å¹¹ã‚’ãªã™äººæ ¼OS</p>
            <h3 class="text-3xl font-bold text-amber-300 mt-1">${
              primaryOS.hexagram_id
            }. ${primaryOS.name_jp}ï¼ˆ${primaryOS.reading}ï¼‰</h3>
            <div class="mt-4 prose prose-invert max-w-none text-gray-300 text-sm">
              <p><strong>ã€å½–ä¼ã«ã‚ˆã‚‹è§£èª¬ã€‘</strong>${
                tuanDen ? tuanDen.summary : "è§£èª¬æº–å‚™ä¸­"
              }</p>
              <p>${tuanDen ? tuanDen.haqei_interpretation : ""}</p>
            </div>
          </div>`;
        const chartHtml = `<div class="relative mx-auto" style="height: 300px; max-width: 400px;"><canvas id="module1-radar-chart"></canvas></div>`;
        container.innerHTML = infoHtml + chartHtml;
        renderRadarChart(analysisResult.trigram_profile);
      }

      function renderRadarChart(trigram_profile) {
        const canvas = document.getElementById("module1-radar-chart");
        if (!canvas) return;
        const ctx = canvas.getContext("2d");
        const sortedProfile = [...trigram_profile].sort((a, b) => a.id - b.id);
        new Chart(ctx, {
          type: "radar",
          data: {
            labels: sortedProfile.map((t) => t.name_jp),
            datasets: [
              {
                label: "ã‚¨ãƒãƒ«ã‚®ãƒ¼å¼·åº¦",
                data: sortedProfile.map((t) => t.score),
                fill: true,
                backgroundColor: "rgba(165, 180, 252, 0.2)",
                borderColor: "#a5b4fc",
                pointBackgroundColor: "#fff",
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              r: {
                angleLines: { color: "rgba(255, 255, 255, 0.2)" },
                grid: { color: "rgba(255, 255, 255, 0.2)" },
                pointLabels: { font: { size: 12 }, color: "#d1d5db" },
                ticks: { display: false },
              },
            },
            plugins: { legend: { display: false } },
          },
        });
      }

      function renderModule2(analysisResult) {
        const container = document.getElementById("module2-content");
        const moduleElement = document.getElementById("module2");
        if (
          !analysisResult ||
          !analysisResult.hexagram_candidates ||
          analysisResult.hexagram_candidates.length === 0
        )
          return;
        const primaryOS_ID = analysisResult.hexagram_candidates[0].hexagram_id;
        const h64Data = HAQEI_DATA.H64_DATA.find(
          (h) => h.å¦ç•ªå· === primaryOS_ID
        );
        if (!h64Data) return;
        const lenses = [
          {
            type: "éŒ¯å¦",
            name: "é¡å†™ã—ã®è‡ªåˆ† (æœ€å¤§ã®èª²é¡Œ)",
            hexId: h64Data.saku_id,
            color: "border-orange-400",
          },
          {
            type: "ç¶œå¦",
            name: "ä»–è€…ã‹ã‚‰ã®è¦–ç‚¹ (è£å´ã®é¡”)",
            hexId: h64Data.sou_id,
            color: "border-blue-400",
          },
          {
            type: "äº’å¦",
            name: "å†…ãªã‚‹æœ¬è³ª (ç§˜ã‚ãŸå¯èƒ½æ€§)",
            hexId: h64Data.go_id,
            color: "border-green-400",
          },
        ];
        container.innerHTML = lenses
          .map((lens) => {
            const hexData = HAQEI_DATA.hexagrams_master.find(
              (h) => h.hexagram_id === lens.hexId
            );
            return `<div class="special-lens-card border-t-4 ${lens.color}"><p class="text-sm font-bold text-gray-400">${lens.type}</p><p class="text-lg font-semibold text-gray-200">${lens.name}</p><div class="my-3"><p class="text-xl font-bold">${hexData.name_jp}</p><p class="text-xs text-gray-500">${hexData.reading}</p></div><p class="text-xs text-gray-400">${hexData.keywords}</p></div>`;
          })
          .join("");
        moduleElement.classList.remove("hidden");
      }

      function handleFuturePrediction() {
        const hexInput = document.getElementById("hexagramInput").value.trim();
        const lineNum = parseInt(
          document.getElementById("lineInput").value,
          10
        );
        let hexNum = parseInt(hexInput, 10);
        if (isNaN(hexNum)) {
          const foundHex = HAQEI_DATA.hexagrams_master.find(
            (h) => h.name_jp === hexInput
          );
          hexNum = foundHex ? foundHex.hexagram_id : null;
        }

        if (!hexNum || isNaN(lineNum) || lineNum < 1 || lineNum > 6) {
          alert("æœ‰åŠ¹ãªå¦ã¨çˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
          return;
        }

        current8Paths = generateAllPaths(hexNum, lineNum);
        if (current8Paths.length === 0) {
          document.getElementById(
            "prediction-summary"
          ).innerHTML = `<p class="text-center text-red-400">äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>`;
          document
            .getElementById("prediction-summary")
            .classList.remove("hidden");
          return;
        }

        renderModule3Summary();
        renderModule4(hexNum);
      }

      function renderModule3Summary() {
        const container = document.getElementById("prediction-summary");
        if (current8Paths.length === 0) {
          container.innerHTML = `<p class="text-center text-gray-500">äºˆæ¸¬ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸Šè¨˜ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰äºˆæ¸¬ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚</p>`;
          container.classList.remove("hidden");
          return;
        }
        const sortedPaths = [...current8Paths].sort(
          (a, b) => b[3].S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢ - a[3].S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢
        );
        const rankLabels = ["S", "A", "B", "C", "D", "E", "F", "H"];

        let summaryHtml = `<h4 class="text-lg font-semibold text-gray-300 mb-4">8ã¤ã®æœªæ¥ã®å¯èƒ½æ€§</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4">`;

        sortedPaths.forEach((path, index) => {
          const originalIndex = current8Paths.findIndex((p) => p === path);
          const finalState = path[3];
          const rank = rankLabels[index] || "N/A";
          summaryHtml += `
                <div class="scenario-card">
                    <div class="flex justify-between items-center">
                        <p class="text-sm font-semibold">ã‚·ãƒŠãƒªã‚ª${
                          originalIndex + 1
                        }: <span class="font-bold text-indigo-300">${
            finalState["è¦ªã¨ãªã‚‹å¦"]
          } ${finalState.çˆ»}</span></p>
                        <span class="font-bold text-sm px-2 py-0.5 rounded-md bg-gray-600">${rank}</span>
                    </div>
                    <p class="text-xs text-gray-400 mt-1">${
                      finalState.ç¾ä»£è§£é‡ˆã®è¦ç´„
                    }</p>
                    <button onclick="window.generateReport(${originalIndex})" class="mt-3 w-full bg-teal-700 hover:bg-teal-600 text-white text-xs font-bold py-1 px-3 rounded-md transition">ã“ã®æœªæ¥ã®æˆ¦ç•¥æ›¸ã‚’ä½œæˆ â†’</button>
                </div>
            `;
        });
        summaryHtml += `</div>`;
        container.innerHTML = summaryHtml;
        container.classList.remove("hidden");
      }

      window.generateReport = (scenarioIndex) => {
        if (!osAnalysisData) {
          alert("å…ˆã«äººæ ¼OSåˆ†æã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚");
          location.href = "os_analyzer.html";
          return;
        }
        if (current8Paths.length === 0) {
          alert("å…ˆã«æœªæ¥äºˆæ¸¬ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚");
          return;
        }
        const professionalData = {
          analysis: osAnalysisData.analysisResult,
          context: osAnalysisData.userContext,
          profile: osAnalysisData.userProfile,
          worry: `${document.getElementById("hexagramInput").value} ${
            document.getElementById("lineInput").value
          }çˆ»ã®çŠ¶æ³ã«ã¤ã„ã¦`,
          selectedFuture: {
            path: current8Paths[scenarioIndex],
          },
        };
        localStorage.setItem(
          "haqeiProfessionalData",
          JSON.stringify(professionalData)
        );
        window.location.href = "professional_report.html";
      };

      function renderModule4(currentHexNum) {
        const container = document.getElementById("module4-content");
        const moduleElement = document.getElementById("module4");
        const story = HAQEI_DATA.bible.jo_ka_den[currentHexNum];
        if (!story) {
          moduleElement.classList.add("hidden");
          return;
        }
        const prevChapter = story.from_prev
          ? HAQEI_DATA.hexagrams_master.find(
              (h) => h.hexagram_id === story.from_prev.prev_id
            )
          : null;
        const nextChapter = story.to_next
          ? HAQEI_DATA.hexagrams_master.find(
              (h) => h.hexagram_id === story.to_next.next_id
            )
          : null;
        const fromHtml = prevChapter
          ? `<p class="text-sm">å‰ã®ç« : <strong>${prevChapter.name_jp}</strong> - <span class="italic text-gray-400">${story.from_prev.explanation}</span></p>`
          : '<p class="text-sm text-gray-400">ç‰©èªã®å§‹ã¾ã‚Šã§ã™ã€‚</p>';
        const toHtml = nextChapter
          ? `<p class="text-sm">æ¬¡ã®ç« : <strong>${nextChapter.name_jp}</strong> - <span class="italic text-gray-400">${story.to_next.explanation}</span></p>`
          : '<p class="text-sm text-gray-400">ã“ã‚Œã«ã¦ç‰©èªã¯ä¸€åŒºåˆ‡ã‚Šã§ã™ã€‚</p>';
        container.innerHTML = `
            <p class="mb-4">ã‚ãªãŸã®ç¾åœ¨åœ°ã¯ã€æ˜“çµŒãŒç´¡ã64ã®ç‰©èªã®ä¸­ã§ã€ä»¥ä¸‹ã®æ–‡è„ˆã«ä½ç½®ã—ã¦ã„ã¾ã™ã€‚</p>
            <div class="space-y-4">
                <div class="p-4 bg-gray-800/50 rounded-lg">${fromHtml}</div>
                <div class="p-4 bg-indigo-900/30 rounded-lg border-l-4 border-indigo-400">
                    <p class="text-sm text-gray-300">ç¾åœ¨ã®ç« : <strong>${
                      HAQEI_DATA.hexagrams_master.find(
                        (h) => h.hexagram_id === currentHexNum
                      ).name_jp
                    }</strong></p>
                    <p class="text-xs italic pl-4 text-white mt-2">ã‚ãªãŸã®é¸æŠï¼ˆçˆ»ï¼‰ãŒã€ã“ã®å¤§ããªç‰©èªï¼ˆå¦ï¼‰ã«ã©ã®ã‚ˆã†ãªå¤‰åŒ–ã‚’ã‚‚ãŸã‚‰ã™ã‹ãŒã€æˆ¦ç•¥ã®éµã¨ãªã‚Šã¾ã™ã€‚</p>
                </div>
                <div class="p-4 bg-gray-800/50 rounded-lg">${toHtml}</div>
            </div>`;
        moduleElement.classList.remove("hidden");
      }

      function generateAllPaths(startHex, startLine) {
        if (!HAQEI_DATA) return [];
        const findLineDataByNum = (hexNum, lineNum) => {
          if (lineNum < 1 || lineNum > 6) return null;
          const lineName = ["åˆ", "äºŒ", "ä¸‰", "å››", "äº”", "ä¸Š"][lineNum - 1];
          return HAQEI_DATA["384"].find(
            (line) => line.å¦ç•ªå· === hexNum && line.çˆ».includes(lineName)
          );
        };
        const findYongYaoData = (hexNum) =>
          HAQEI_DATA["384"].find(
            (line) =>
              line.å¦ç•ªå· === hexNum &&
              line.çˆ» === (hexNum === 1 ? "ç”¨ä¹" : "ç”¨å…­")
          );
        const findHexData = (hexNum) =>
          HAQEI_DATA.H64_DATA.find((hex) => hex.å¦ç•ªå· === hexNum);
        const getNextState = (currentState, choice) => {
          let nextHexNum, nextLineNum;
          const { lineNum: currentLineNum, å¦ç•ªå·: currentHexNum } =
            currentState;
          if (currentState.çˆ» === "ç”¨ä¹")
            return findLineDataByNum(2, 1)
              ? { ...findLineDataByNum(2, 1), lineNum: 1, choice: "stagnate" }
              : null;
          if (currentState.çˆ» === "ç”¨å…­")
            return findLineDataByNum(1, 1)
              ? { ...findLineDataByNum(1, 1), lineNum: 1, choice: "stagnate" }
              : null;
          if (choice === "stagnate") {
            if (
              (currentHexNum === 1 || currentHexNum === 2) &&
              currentLineNum === 6
            ) {
              const yongData = findYongYaoData(currentHexNum);
              if (yongData)
                return { ...yongData, lineNum: 7, choice: "stagnate" };
            }
            nextHexNum = currentHexNum;
            nextLineNum = currentLineNum >= 6 ? 1 : currentLineNum + 1;
          } else {
            const currentHexData = findHexData(currentHexNum);
            if (!currentHexData) return null;
            const lineKeys = [
              "åˆçˆ»å¤‰",
              "äºŒçˆ»å¤‰",
              "ä¸‰çˆ»å¤‰",
              "å››çˆ»å¤‰",
              "äº”çˆ»å¤‰",
              "ä¸Šçˆ»å¤‰",
            ];
            nextHexNum = currentHexData[lineKeys[currentLineNum - 1]];
            nextLineNum = currentLineNum;
          }
          const data = findLineDataByNum(nextHexNum, nextLineNum);
          return data ? { ...data, lineNum: nextLineNum, choice } : null;
        };
        const startData = findLineDataByNum(startHex, startLine);
        if (!startData) return [];
        let paths = [[{ ...startData, lineNum: startLine, choice: "start" }]];
        for (let i = 0; i < 3; i++) {
          const newPaths = [];
          for (const path of paths) {
            const lastState = path[path.length - 1];
            const stagnateState = getNextState(lastState, "stagnate");
            if (stagnateState) newPaths.push([...path, stagnateState]);
            const changeState = getNextState(lastState, "change");
            if (changeState) newPaths.push([...path, changeState]);
          }
          paths = newPaths;
        }
        return paths.filter((p) => p.length === 4);
      }
    </script>
  </body>
</html>
