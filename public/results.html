<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaQei - æ˜“çµŒã‹ã‚‰è¦‹ãŸã‚ãªãŸã®å¯èƒ½æ€§</title>
    <!-- Styles -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/interactive-ui.css">
    <link rel="stylesheet" href="css/user-friendly-display.css">
    <link rel="stylesheet" href="css/strategic-dashboard.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <div id="data-manager-errors" style="display: none;"></div>
    <div id="results-container">
        <!-- TripleOSResultsViewãŒã“ã“ã«å¯¾è©±å‹UIã‚’ç”Ÿæˆ -->
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« -->
    <script type="text/javascript" src="./js/data/data_box.js"></script>
    <script type="text/javascript" src="./js/shared/data/questions.js"></script>
    <script type="text/javascript" src="./js/shared/data/vectors.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagrams.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagram_details.js"></script>
    <script type="text/javascript" src="./js/shared/utils/validators.js"></script>
    <script type="text/javascript" src="./js/shared/utils/animations.js"></script>

    <!-- åŸºç›¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆä¾å­˜é–¢ä¿‚é †ï¼‰ -->
    <script type="text/javascript" src="./js/shared/core/BaseComponent.js"></script>
    <script type="text/javascript" src="./js/shared/core/StorageManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/DataManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/ErrorHandler.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/engines/CompatibilityDataLoader.js"></script>
    
    <!-- Phase 4: æ‰¹åˆ¤çš„æ€è€ƒæ”¯æ´ã‚¨ãƒ³ã‚¸ãƒ³ -->
    <script type="text/javascript" src="./js/os-analyzer/core/ShadowAnalyzer.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/CriticalThinkingEngine.js"></script>
    
    <!-- UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
    <script type="text/javascript" src="./js/components/CriticalProductiveCard.js"></script>
    <script type="text/javascript" src="./js/components/TripleOSResultsView.js"></script>

    <script>
        // ã‚¯ãƒ©ã‚¹ã®èª­ã¿è¾¼ã¿çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        function checkClassDefinitions() {
            const classChecks = {
                'BaseComponent': typeof BaseComponent !== 'undefined',
                'StorageManager': typeof StorageManager !== 'undefined',
                'DataManager': typeof DataManager !== 'undefined',
                'ErrorHandler': typeof ErrorHandler !== 'undefined',
                'CompatibilityDataLoader': typeof CompatibilityDataLoader !== 'undefined',
                'ShadowAnalyzer': typeof ShadowAnalyzer !== 'undefined',
                'CriticalThinkingEngine': typeof CriticalThinkingEngine !== 'undefined',
                'CriticalProductiveCard': typeof CriticalProductiveCard !== 'undefined',
                'TripleOSResultsView': typeof TripleOSResultsView !== 'undefined'
            };
            
            console.log('ğŸ” ã‚¯ãƒ©ã‚¹å®šç¾©ãƒã‚§ãƒƒã‚¯:', classChecks);
            
            // æœªå®šç¾©ã®ã‚¯ãƒ©ã‚¹ã‚’ç‰¹å®š
            const undefinedClasses = Object.entries(classChecks)
                .filter(([name, defined]) => !defined)
                .map(([name]) => name);
            
            if (undefinedClasses.length > 0) {
                console.error('âŒ æœªå®šç¾©ã®ã‚¯ãƒ©ã‚¹:', undefinedClasses);
                return false;
            }
            
            console.log('âœ… ã™ã¹ã¦ã®ã‚¯ãƒ©ã‚¹ãŒæ­£å¸¸ã«å®šç¾©ã•ã‚Œã¦ã„ã¾ã™');
            return true;
        }

        // çµæœè¡¨ç¤ºå°‚ç”¨ã‚·ãƒ³ãƒ—ãƒ«åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸ¯ HaQei Results Page Loading...');
            
            // ã‚¯ãƒ©ã‚¹å®šç¾©ãƒã‚§ãƒƒã‚¯
            if (!checkClassDefinitions()) {
                console.error('âŒ å¿…è¦ãªã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“');
                document.getElementById('results-container').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #f1f5f9; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <h2 style="margin-bottom: 1rem;">ğŸ”® æ˜“çµŒã®æ™ºæ…§ã‚’ç´è§£ã„ã¦ã„ã¾ã™...</h2>
                        <p style="margin-bottom: 1rem;">ã‚ãªãŸã®å¯èƒ½æ€§ã‚’æ¢ã‚‹ãŸã‚ã€å¤ä»£ã®æ™ºæ…§ã¨å‘ãåˆã£ã¦ã„ã¾ã™ã€‚</p>
                        <p style="margin-bottom: 2rem; color: #94a3b8; font-size: 0.9rem;">ã“ã®ç”»é¢ãŒç¶šãå ´åˆã¯ã€ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ›´æ–°ã—ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
                        <a href="javascript:location.reload()" style="display: inline-block; padding: 1rem 2rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: all 300ms ease;">ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹</a>
                    </div>
                `;
                return;
            }
            
            try {
                // ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰åˆ†æçµæœã‚’å–å¾—
                const storageManager = new StorageManager();
                const analysisResult = storageManager.getAnalysisResult();
                const insights = storageManager.getInsights();
                
                console.log('ğŸ“Š Analysis result retrieved successfully');
                console.log('ğŸ’¡ Insights retrieved successfully');
            
                if (!analysisResult) {
                    document.getElementById('results-container').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #f1f5f9; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                            <h2 style="margin-bottom: 1rem;">ğŸ“‹ è¨ºæ–­çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h2>
                            <p style="margin-bottom: 1rem;">ã¾ã è¨ºæ–­ãŒå®Œäº†ã—ã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚</p>
                            <p style="margin-bottom: 2rem; color: #94a3b8; font-size: 0.9rem;">ã‚ãªãŸã®3ã¤ã®é¡”ã‚’ç™ºè¦‹ã™ã‚‹ãŸã‚ã«ã€ã¾ãšè¨ºæ–­ã‚’å—ã‘ã¦ã¿ã¾ã—ã‚‡ã†ã€‚</p>
                            <a href="os_analyzer.html" style="display: inline-block; padding: 1rem 2rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: all 300ms ease;">è¨ºæ–­ã‚’å§‹ã‚ã‚‹</a>
                        </div>
                    `;
                    return;
                }

                console.log('ğŸ” DataManageråˆæœŸåŒ–é–‹å§‹...');
                // DataManageråˆæœŸåŒ–
                const dataManager = new DataManager();
                await dataManager.loadData();
                console.log('âœ… DataManageråˆæœŸåŒ–å®Œäº†');

                console.log('ğŸ” CompatibilityDataLoaderåˆæœŸåŒ–é–‹å§‹...');
                // CompatibilityDataLoaderåˆæœŸåŒ–
                const compatibilityLoader = new CompatibilityDataLoader();
                console.log('âœ… CompatibilityDataLoaderåˆæœŸåŒ–å®Œäº†');

                console.log('ğŸ” TripleOSResultsViewåˆæœŸåŒ–é–‹å§‹...');
                
                // æ˜“çµŒã®æ™ºæ…§å‰ç½®ãã‚’è¿½åŠ 
                const wisdomPreface = document.createElement('div');
                wisdomPreface.className = 'ancient-wisdom-intro';
                wisdomPreface.innerHTML = `
                    <h3>ğŸŒ… å¤ä»£ã®æ™ºæ…§ã‹ã‚‰ã®ç¤ºå”†</h3>
                    <p>æ•°åƒå¹´ã®æ™ºæ…§ã§ã‚ã‚‹æ˜“çµŒã«ç…§ã‚‰ã—åˆã‚ã›ã‚‹ã¨ã€ã‚ãªãŸã«ã¯ã“ã®ã‚ˆã†ãªå‚¾å‘ãŒã‚ã‚‹ã‚ˆã†ã§ã™ã€‚ã“ã‚Œã‚’äººç”Ÿã®å‚è€ƒã®ä¸€ã¤ã¨ã—ã¦ãŠå½¹ç«‹ã¦ãã ã•ã„ã€‚</p>
                `;
                document.getElementById('results-container').appendChild(wisdomPreface);
                
                // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸»æ¨©ã®ãƒ‡ã‚£ã‚¹ã‚¯ãƒ¬ãƒ¼ãƒãƒ¼
                const wisdomDisclaimer = document.createElement('div');
                wisdomDisclaimer.className = 'wisdom-disclaimer';
                wisdomDisclaimer.innerHTML = `
                    <p>ğŸ’¡ ã“ã‚Œã¯æ˜“çµŒã®æ™ºæ…§ã«åŸºã¥ãä¸€ã¤ã®è¦‹æ–¹ã§ã™ã€‚æœ€çµ‚çš„ãªè§£é‡ˆã¨æ´»ç”¨æ–¹æ³•ã¯ã€ã‚ãªãŸè‡ªèº«ãŒæ±ºã‚ã¦ãã ã•ã„ã€‚</p>
                `;
                document.getElementById('results-container').appendChild(wisdomDisclaimer);
                
                // å¯¾è©±å‹UIè¡¨ç¤º
                const resultsView = new TripleOSResultsView('results-container', {
                    analysisResult: analysisResult,
                    insights: insights,
                    compatibilityLoader: compatibilityLoader,
                    dataManager: dataManager,
                    enableSelfReflection: true, // è‡ªå·±æ¢æ±‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’æœ‰åŠ¹åŒ–
                    showWisdomPreface: true // æ™ºæ…§ã®å‰ç½®ãã‚’è¡¨ç¤º
                });

                await resultsView.init();
                console.log('âœ… Results page initialized successfully');
                
            } catch (error) {
                console.error('âŒ Results page initialization failed:', error);
                console.error('âŒ Error stack:', error.stack);
                document.getElementById('results-container').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #f1f5f9; min-height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                        <h2 style="margin-bottom: 1rem;">ğŸŒ€ æ™ºæ…§ã®æµã‚Œã‚’æ•´ãˆã¦ã„ã¾ã™</h2>
                        <p style="margin-bottom: 1rem;">æ˜“çµŒã‹ã‚‰ã®ç¤ºå”†ã‚’å—ã‘å–ã‚‹æº–å‚™ã§ã€å°‘ã—å•é¡ŒãŒç”Ÿã˜ã¾ã—ãŸã€‚</p>
                        <p style="margin-bottom: 2rem; color: #94a3b8; font-size: 0.9rem;">ãŠæ‰‹æ•°ã§ã™ãŒã€ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°ã™ã‚‹ã‹ã€å†åº¦è¨ºæ–­ã‚’å—ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚</p>
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center;">
                            <a href="javascript:location.reload()" style="display: inline-block; padding: 1rem 1.5rem; background: linear-gradient(135deg, #10b981, #059669); color: white; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: all 300ms ease;">ãƒšãƒ¼ã‚¸ã‚’æ›´æ–°</a>
                            <a href="os_analyzer.html" style="display: inline-block; padding: 1rem 1.5rem; background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; text-decoration: none; border-radius: 0.75rem; font-weight: 600; transition: all 300ms ease;">è¨ºæ–­ã‚’ã‚„ã‚Šç›´ã™</a>
                        </div>
                    </div>
                `;
            }
        });
    </script>
</body>
</html>