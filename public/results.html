<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI - 仮想人格対話型自己理解プラットフォーム</title>
    <meta name="description" content="あなたの内なる3つのOS（価値観・社会的側面・防御的側面）との対話を通じて、深い自己理解を促進する革新的なプラットフォーム">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Existing Styles -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/interactive-ui.css">
    
    <!-- New Style for Virtual Persona -->
    <link rel="stylesheet" href="css/virtual-persona-results.css">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- 
    仮想人格対話型自己理解プラットフォーム
    
    概要：
    このページは、ユーザーの診断結果から構築された仮想人格（3つのOS）との
    対話を通じて、深い自己理解を促進するインタラクティブなプラットフォームです。
    
    主要機能：
    1. 仮想人格の段階的構築演出
    2. 3つのOS間の相互作用可視化
    3. 内部対話の再生・シミュレーション
    4. 易経メタファーによる深い洞察
    5. 実践的な自己理解ガイダンス
    -->
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay active">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2 class="loading-title">あなたの仮想人格を構築中...</h2>
            <p class="loading-description">診断結果から、あなたの内なる3つのOSを呼び起こしています</p>
        </div>
    </div>
    
    <!-- Main Container -->
    <div id="virtual-persona-container" class="virtual-persona-container">
        <!-- VirtualPersonaResultsViewがここに動的にコンテンツを生成 -->
    </div>
    
    <!-- Error Display -->
    <div id="error-container" class="error-container" style="display: none;">
        <div class="error-content">
            <h2>エラーが発生しました</h2>
            <p id="error-message"></p>
            <button onclick="location.reload()" class="error-retry-button">再読み込み</button>
        </div>
    </div>
    
    <!-- データファイル -->
    <script type="text/javascript" src="./js/shared/data/questions.js"></script>
    <script type="text/javascript" src="./js/shared/data/vectors.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagrams.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagram_details.js"></script>
    
    <!-- ユーティリティ -->
    <script type="text/javascript" src="./js/shared/utils/validators.js"></script>
    <script type="text/javascript" src="./js/shared/utils/animations.js"></script>
    
    <!-- 基盤ライブラリ -->
    <script type="text/javascript" src="./js/shared/core/BaseComponent.js"></script>
    <script type="text/javascript" src="./js/shared/core/StorageManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/DataManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/ErrorHandler.js"></script>
    
    <!-- 仮想人格関連エンジン -->
    <script type="text/javascript" src="./js/os-analyzer/core/TripleOSEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/PersonalityOS.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/VirtualPersonality.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/OSRelationshipEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/IchingMetaphorEngine.js"></script>
    
    <!-- UI/UXコンポーネント -->
    <script type="text/javascript" src="./js/os-analyzer/components/PersonalityConstructionView.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/components/DialoguePlayer.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/components/OSVoiceSwitcher.js"></script>
    
    <!-- 新規作成：仮想人格結果表示ビュー -->
    <script type="text/javascript" src="./js/components/VirtualPersonaResultsView.js"></script>
    
    <script>
        /**
         * 仮想人格対話型自己理解プラットフォーム - 初期化スクリプト
         * 
         * 目的：
         * - 診断結果の読み込み
         * - 仮想人格の構築
         * - インタラクティブUIの初期化
         * 
         * 処理フロー：
         * 1. localStorageから診断結果を取得
         * 2. 必要なデータの検証
         * 3. VirtualPersonaResultsViewの初期化
         * 4. 仮想人格構築プロセスの開始
         */
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 仮想人格対話型自己理解プラットフォーム - 初期化開始');
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            
            try {
                // StorageManagerから診断結果を取得
                const storageManager = new StorageManager();
                const analysisResult = storageManager.getAnalysisResult();
                const insights = storageManager.getInsights();
                
                console.log('📊 診断結果の取得完了:', {
                    hasAnalysisResult: !!analysisResult,
                    hasInsights: !!insights
                });
                
                // 診断結果の検証
                if (!analysisResult) {
                    throw new Error('診断結果が見つかりません。先に診断を完了してください。');
                }
                
                // Triple OSデータの検証
                if (!analysisResult.engineOS || !analysisResult.interfaceOS || !analysisResult.safeModeOS) {
                    console.error('❌ Triple OSデータが不完全:', analysisResult);
                    throw new Error('Triple OSデータが不完全です。診断をやり直してください。');
                }
                
                // DataManagerの初期化
                console.log('📚 DataManager初期化中...');
                const dataManager = new DataManager();
                await dataManager.loadData();
                console.log('✅ DataManager初期化完了');
                
                // VirtualPersonaResultsViewの初期化
                console.log('🎭 VirtualPersonaResultsView初期化中...');
                const virtualPersonaView = new VirtualPersonaResultsView('virtual-persona-container', {
                    analysisResult: analysisResult,
                    insights: insights,
                    dataManager: dataManager,
                    enableAnimation: true,
                    animationSpeed: 1.0
                });
                
                // 初期化と表示
                await virtualPersonaView.init();
                
                // グローバル参照の設定（アクションボタンから呼び出すため）
                window.virtualPersonaView = virtualPersonaView;
                
                console.log('✅ 仮想人格対話型プラットフォーム初期化完了');
                
                // ローディング画面を非表示
                setTimeout(() => {
                    loadingOverlay.classList.remove('active');
                }, 500);
                
            } catch (error) {
                console.error('❌ 初期化エラー:', error);
                
                // エラー表示
                loadingOverlay.classList.remove('active');
                errorContainer.style.display = 'flex';
                
                if (error.message.includes('診断結果が見つかりません')) {
                    errorMessage.innerHTML = `
                        <p>${error.message}</p>
                        <a href="os_analyzer.html" class="error-link">診断を開始する</a>
                    `;
                } else {
                    errorMessage.textContent = error.message;
                }
            }
        });
        
        // グローバルエラーハンドリング
        window.addEventListener('error', (event) => {
            console.error('❌ グローバルエラー:', event.error);
            // 必要に応じてエラー通知を表示
        });
    </script>
</body>
</html>