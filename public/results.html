<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI - ä»®æƒ³äººæ ¼å¯¾è©±å‹è‡ªå·±ç†è§£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
    <meta name="description" content="ã‚ãªãŸã®å†…ãªã‚‹3ã¤ã®OSï¼ˆä¾¡å€¤è¦³ãƒ»ç¤¾ä¼šçš„å´é¢ãƒ»é˜²å¾¡çš„å´é¢ï¼‰ã¨ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æ·±ã„è‡ªå·±ç†è§£ã‚’ä¿ƒé€²ã™ã‚‹é©æ–°çš„ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Existing Styles -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/interactive-ui.css">
    
    <!-- New Style for Virtual Persona -->
    <link rel="stylesheet" href="css/virtual-persona-results.css">
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- 
    ä»®æƒ³äººæ ¼å¯¾è©±å‹è‡ªå·±ç†è§£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
    
    æ¦‚è¦ï¼š
    ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨ºæ–­çµæœã‹ã‚‰æ§‹ç¯‰ã•ã‚ŒãŸä»®æƒ³äººæ ¼ï¼ˆ3ã¤ã®OSï¼‰ã¨ã®
    å¯¾è©±ã‚’é€šã˜ã¦ã€æ·±ã„è‡ªå·±ç†è§£ã‚’ä¿ƒé€²ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚
    
    ä¸»è¦æ©Ÿèƒ½ï¼š
    1. ä»®æƒ³äººæ ¼ã®æ®µéšçš„æ§‹ç¯‰æ¼”å‡º
    2. 3ã¤ã®OSé–“ã®ç›¸äº’ä½œç”¨å¯è¦–åŒ–
    3. å†…éƒ¨å¯¾è©±ã®å†ç”Ÿãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    4. æ˜“çµŒãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ã«ã‚ˆã‚‹æ·±ã„æ´å¯Ÿ
    5. å®Ÿè·µçš„ãªè‡ªå·±ç†è§£ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
    -->
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay active">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2 class="loading-title">ã‚ãªãŸã®ä»®æƒ³äººæ ¼ã‚’æ§‹ç¯‰ä¸­...</h2>
            <p class="loading-description">è¨ºæ–­çµæœã‹ã‚‰ã€ã‚ãªãŸã®å†…ãªã‚‹3ã¤ã®OSã‚’å‘¼ã³èµ·ã“ã—ã¦ã„ã¾ã™</p>
        </div>
    </div>
    
    <!-- Main Container -->
    <div id="virtual-persona-container" class="virtual-persona-container">
        <!-- VirtualPersonaResultsViewãŒã“ã“ã«å‹•çš„ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ -->
    </div>
    
    <!-- Error Display -->
    <div id="error-container" class="error-container" style="display: none;">
        <div class="error-content">
            <h2>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
            <p id="error-message"></p>
            <button onclick="location.reload()" class="error-retry-button">å†èª­ã¿è¾¼ã¿</button>
        </div>
    </div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« -->
    <script type="text/javascript" src="./js/shared/data/questions.js"></script>
    <script type="text/javascript" src="./js/shared/data/vectors.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagrams.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagram_details.js"></script>
    
    <!-- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -->
    <script type="text/javascript" src="./js/shared/utils/validators.js"></script>
    <script type="text/javascript" src="./js/shared/utils/animations.js"></script>
    
    <!-- åŸºç›¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script type="text/javascript" src="./js/shared/core/BaseComponent.js"></script>
    <script type="text/javascript" src="./js/shared/core/StorageManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/SimpleStorageManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/DataManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/ErrorHandler.js"></script>
    
    <!-- ä»®æƒ³äººæ ¼é–¢é€£ã‚¨ãƒ³ã‚¸ãƒ³ -->
    <script type="text/javascript" src="./js/os-analyzer/core/TripleOSEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/PersonalityOS.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/VirtualPersonality.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/OSRelationshipEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/IchingMetaphorEngine.js"></script>
    
    <!-- UI/UXã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
    <script type="text/javascript" src="./js/os-analyzer/components/PersonalityConstructionView.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/components/DialoguePlayer.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/components/OSVoiceSwitcher.js"></script>
    
    <!-- æ–°è¦ä½œæˆï¼šä»®æƒ³äººæ ¼çµæœè¡¨ç¤ºãƒ“ãƒ¥ãƒ¼ -->
    <script type="text/javascript" src="./js/components/VirtualPersonaResultsView.js"></script>
    
    <script>
        /**
         * ä»®æƒ³äººæ ¼å¯¾è©±å‹è‡ªå·±ç†è§£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  - åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
         * 
         * ç›®çš„ï¼š
         * - è¨ºæ–­çµæœã®èª­ã¿è¾¼ã¿
         * - ä»®æƒ³äººæ ¼ã®æ§‹ç¯‰
         * - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–UIã®åˆæœŸåŒ–
         * 
         * å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼š
         * 1. localStorageã‹ã‚‰è¨ºæ–­çµæœã‚’å–å¾—
         * 2. å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
         * 3. VirtualPersonaResultsViewã®åˆæœŸåŒ–
         * 4. ä»®æƒ³äººæ ¼æ§‹ç¯‰ãƒ—ãƒ­ã‚»ã‚¹ã®é–‹å§‹
         */
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ ä»®æƒ³äººæ ¼å¯¾è©±å‹è‡ªå·±ç†è§£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  - åˆæœŸåŒ–é–‹å§‹');
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            
            try {
                // StorageManagerã‹ã‚‰è¨ºæ–­çµæœã‚’å–å¾—
                const storageManager = new StorageManager();
                let analysisResult = storageManager.getAnalysisResult();
                let insights = storageManager.getInsights();
                
                // SimpleStorageManagerã‚‚åˆæœŸåŒ–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
                const simpleStorageManager = new SimpleStorageManager();
                
                console.log('ğŸ“Š è¨ºæ–­çµæœã®å–å¾—å®Œäº†:', {
                    hasAnalysisResult: !!analysisResult,
                    hasInsights: !!insights
                });
                
                // SimpleStorageManagerã§ã®å–å¾—è©¦è¡Œ
                if (!analysisResult) {
                    console.log('ğŸ”„ StorageManagerã§å–å¾—å¤±æ•— - SimpleStorageManagerã§è©¦è¡Œä¸­...');
                    
                    analysisResult = simpleStorageManager.getAnalysisResult();
                    if (analysisResult) {
                        console.log('âœ… SimpleStorageManagerã§åˆ†æçµæœå–å¾—æˆåŠŸ');
                    }
                }
                
                if (!insights) {
                    console.log('ğŸ”„ ã‚¤ãƒ³ã‚µã‚¤ãƒˆä¸è¶³ - SimpleStorageManagerã§è©¦è¡Œä¸­...');
                    
                    insights = simpleStorageManager.getInsights();
                    if (insights) {
                        console.log('âœ… SimpleStorageManagerã§ã‚¤ãƒ³ã‚µã‚¤ãƒˆå–å¾—æˆåŠŸ');
                    }
                }
                
                // ç›´æ¥localStorageã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å–å¾—
                if (!analysisResult) {
                    console.log('ğŸ”„ SimpleStorageManagerã§ã‚‚å¤±æ•— - ç›´æ¥localStorageç¢ºèªä¸­...');
                    
                    // ç›´æ¥localStorageç¢ºèª
                    const directResult = localStorage.getItem('haqei_analysis_result');
                    const emergencyResult = localStorage.getItem('haqei_emergency_result');
                    
                    if (directResult) {
                        try {
                            const parsed = JSON.parse(directResult);
                            analysisResult = parsed.result || parsed;
                            console.log('âœ… ç›´æ¥localStorageå–å¾—æˆåŠŸ');
                        } catch (parseError) {
                            console.warn('âš ï¸ ç›´æ¥localStorageè§£æå¤±æ•—:', parseError);
                        }
                    } else if (emergencyResult) {
                        try {
                            const emergency = JSON.parse(emergencyResult);
                            analysisResult = emergency.result;
                            insights = emergency.insights;
                            console.log('ğŸš¨ ç·Šæ€¥ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®å¾©æ—§æˆåŠŸ');
                        } catch (parseError) {
                            console.warn('âš ï¸ ç·Šæ€¥ãƒ‡ãƒ¼ã‚¿è§£æå¤±æ•—:', parseError);
                        }
                    }
                }
                
                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (!insights) {
                    console.log('ğŸ”„ ã‚¤ãƒ³ã‚µã‚¤ãƒˆä¸è¶³ - ç›´æ¥localStorageç¢ºèªä¸­...');
                    const directInsights = localStorage.getItem('haqei_insights');
                    
                    if (directInsights) {
                        try {
                            const parsed = JSON.parse(directInsights);
                            insights = parsed.insights || parsed;
                            console.log('âœ… ç›´æ¥localStorageã‚¤ãƒ³ã‚µã‚¤ãƒˆå–å¾—æˆåŠŸ');
                        } catch (parseError) {
                            console.warn('âš ï¸ ã‚¤ãƒ³ã‚µã‚¤ãƒˆè§£æå¤±æ•—:', parseError);
                        }
                    }
                }
                
                // è¨ºæ–­çµæœã®æ¤œè¨¼
                if (!analysisResult) {
                    // LocalStorageã®çŠ¶æ…‹ã‚’ãƒ‡ãƒãƒƒã‚°
                    const storageKeys = Object.keys(localStorage).filter(k => k.includes('haqei'));
                    console.log('ğŸ” LocalStorage HAQEIã‚­ãƒ¼:', storageKeys);
                    storageKeys.forEach(key => {
                        console.log(`ğŸ“‹ ${key}:`, localStorage.getItem(key)?.substring(0, 100) + '...');
                    });
                    
                    throw new Error('è¨ºæ–­çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«è¨ºæ–­ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
                }
                
                // Triple OSãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
                if (!analysisResult.engineOS || !analysisResult.interfaceOS || !analysisResult.safeModeOS) {
                    console.error('âŒ Triple OSãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨:', analysisResult);
                    throw new Error('Triple OSãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™ã€‚è¨ºæ–­ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
                }
                
                // DataManagerã®åˆæœŸåŒ–
                console.log('ğŸ“š DataManageråˆæœŸåŒ–ä¸­...');
                const dataManager = new DataManager();
                await dataManager.loadData();
                console.log('âœ… DataManageråˆæœŸåŒ–å®Œäº†');
                
                // VirtualPersonaResultsViewã®åˆæœŸåŒ–
                console.log('ğŸ­ VirtualPersonaResultsViewåˆæœŸåŒ–ä¸­...');
                const virtualPersonaView = new VirtualPersonaResultsView('virtual-persona-container', {
                    analysisResult: analysisResult,
                    insights: insights,
                    dataManager: dataManager,
                    enableAnimation: true,
                    animationSpeed: 1.0
                });
                
                // åˆæœŸåŒ–ã¨è¡¨ç¤º
                await virtualPersonaView.init();
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã®è¨­å®šï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ï¼‰
                window.virtualPersonaView = virtualPersonaView;
                
                console.log('âœ… ä»®æƒ³äººæ ¼å¯¾è©±å‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤º
                setTimeout(() => {
                    loadingOverlay.classList.remove('active');
                }, 500);
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                loadingOverlay.classList.remove('active');
                errorContainer.style.display = 'flex';
                
                if (error.message.includes('è¨ºæ–­çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
                    errorMessage.innerHTML = `
                        <p>${error.message}</p>
                        <a href="os_analyzer.html" class="error-link">è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹</a>
                    `;
                } else {
                    errorMessage.textContent = error.message;
                }
            }
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            console.error('âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
            // å¿…è¦ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’è¡¨ç¤º
        });
    </script>
</body>
</html>