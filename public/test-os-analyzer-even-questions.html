<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Analyzer å¶æ•°ç•ªè¨­å•è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <style>
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-header {
            background: #1e293b;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .test-results {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .test-item {
            padding: 10px;
            margin: 5px 0;
            border-left: 4px solid #10b981;
            background: white;
        }
        .test-item.failed {
            border-left-color: #ef4444;
        }
        .navigation-test {
            display: flex;
            gap: 10px;
            margin: 20px 0;
        }
        .test-button {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .test-button:hover {
            background: #2563eb;
        }
        .question-display-area {
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            min-height: 400px;
            margin: 20px 0;
        }
        #questions-container {
            width: 100%;
            height: 100%;
        }
        .log-area {
            background: #1e293b;
            color: #f1f5f9;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ§ª OS Analyzer å¶æ•°ç•ªè¨­å•è¡¨ç¤ºãƒ†ã‚¹ãƒˆ</h1>
            <p>VirtualQuestionFlowã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å¶æ•°ç•ªè¨­å•è¡¨ç¤ºæ©Ÿèƒ½ã‚’æ¤œè¨¼ã—ã¾ã™</p>
        </div>

        <div class="test-results" id="test-summary">
            <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼</h2>
            <div id="summary-content">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰...</div>
        </div>

        <div class="navigation-test">
            <button class="test-button" onclick="runEvenQuestionTest()">ğŸš€ å¶æ•°ç•ªè¨­å•ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
            <button class="test-button" onclick="runAllQuestionsTest()">ğŸ“‹ å…¨è¨­å•ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button class="test-button" onclick="resetTest()">ğŸ”„ ãƒ†ã‚¹ãƒˆãƒªã‚»ãƒƒãƒˆ</button>
        </div>

        <div class="question-display-area">
            <div id="questions-container"></div>
        </div>

        <div class="test-results">
            <h3>ğŸ” è©³ç´°ãƒ­ã‚°</h3>
            <div class="log-area" id="test-log"></div>
        </div>

        <div class="test-results" id="detailed-results">
            <h3>ğŸ“„ è©³ç´°ãƒ†ã‚¹ãƒˆçµæœ</h3>
            <div id="results-content">ã¾ã ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
        </div>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <script src="js/shared/core/BaseComponent.js"></script>
    <script src="js/shared/core/StorageManager.js"></script>
    <script src="js/shared/core/DataManager.js"></script>
    <script src="js/shared/data/questions.js"></script>
    <script src="js/os-analyzer/core/PrecompiledQuestions.js"></script>
    <script src="js/os-analyzer/components/HaqeiQuestionElement.js"></script>
    <script src="js/os-analyzer/components/VirtualQuestionFlow.js"></script>

    <script>
        // ãƒ†ã‚¹ãƒˆãƒ­ã‚°ç”¨
        const testLog = document.getElementById('test-log');
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        function logToPage(message, type = 'log') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}\n`;
            testLog.textContent += logEntry;
            testLog.scrollTop = testLog.scrollHeight;
            
            // å…ƒã®consoleãƒ¡ã‚½ãƒƒãƒ‰ã‚‚å‘¼ã³å‡ºã—
            if (type === 'error') originalConsoleError(message);
            else if (type === 'warn') originalConsoleWarn(message);
            else originalConsoleLog(message);
        }

        // console.logã‚’æ¨ªå–ã‚Š
        console.log = (...args) => logToPage(args.join(' '), 'log');
        console.error = (...args) => logToPage(args.join(' '), 'error');
        console.warn = (...args) => logToPage(args.join(' '), 'warn');

        let virtualFlow = null;
        let testResults = [];

        function updateSummary(results) {
            const summaryContent = document.getElementById('summary-content');
            const total = results.length;
            const passed = results.filter(r => r.passed).length;
            const failed = total - passed;
            
            summaryContent.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; text-align: center;">
                    <div>
                        <h3>ğŸ“Š ç·ãƒ†ã‚¹ãƒˆæ•°</h3>
                        <div style="font-size: 24px; font-weight: bold;">${total}</div>
                    </div>
                    <div style="color: #10b981;">
                        <h3>âœ… æˆåŠŸ</h3>
                        <div style="font-size: 24px; font-weight: bold;">${passed}</div>
                    </div>
                    <div style="color: #ef4444;">
                        <h3>âŒ å¤±æ•—</h3>
                        <div style="font-size: 24px; font-weight: bold;">${failed}</div>
                    </div>
                </div>
            `;
        }

        function updateDetailedResults(results) {
            const resultsContent = document.getElementById('results-content');
            let html = '';
            
            results.forEach(result => {
                const statusClass = result.passed ? '' : 'failed';
                const statusIcon = result.passed ? 'âœ…' : 'âŒ';
                
                html += `
                    <div class="test-item ${statusClass}">
                        <h4>${statusIcon} ${result.questionId} (è¨­å•${result.questionNumber})</h4>
                        <p><strong>è¡¨ç¤ºçŠ¶æ…‹:</strong> ${result.passed ? 'æ­£å¸¸è¡¨ç¤º' : 'è¡¨ç¤ºå¤±æ•—'}</p>
                        <p><strong>è¦ç´ å­˜åœ¨:</strong> ${result.elementExists ? 'ã‚ã‚Š' : 'ãªã—'}</p>
                        <p><strong>è¡¨ç¤ºç¢ºèª:</strong> ${result.isVisible ? 'ã¯ã„' : 'ã„ã„ãˆ'}</p>
                        ${result.issues.length > 0 ? `<p><strong>å•é¡Œ:</strong> ${result.issues.join(', ')}</p>` : ''}
                        <details>
                            <summary>è©³ç´°æƒ…å ±</summary>
                            <pre>${JSON.stringify(result, null, 2)}</pre>
                        </details>
                    </div>
                `;
            });
            
            resultsContent.innerHTML = html || 'ãƒ†ã‚¹ãƒˆçµæœãŒã‚ã‚Šã¾ã›ã‚“';
        }

        async function initializeVirtualFlow() {
            if (virtualFlow) {
                console.log('VirtualFlow already initialized, cleaning up first...');
                virtualFlow.cleanup();
            }

            console.log('ğŸš€ VirtualQuestionFlowåˆæœŸåŒ–é–‹å§‹...');
            
            const container = document.getElementById('questions-container');
            container.innerHTML = ''; // ã‚³ãƒ³ãƒ†ãƒŠã‚’ã‚¯ãƒªã‚¢
            
            virtualFlow = new VirtualQuestionFlow('questions-container', {
                storageManager: new StorageManager(),
                onProgress: (progress) => {
                    console.log(`Progress: ${progress.toFixed(1)}%`);
                },
                onComplete: (answers) => {
                    console.log(`Complete: ${answers.length} answers`);
                }
            });
            
            virtualFlow.init();
            
            console.log(`âœ… VirtualFlowåˆæœŸåŒ–å®Œäº†: ${virtualFlow.questions.length}å€‹ã®è¨­å•ã‚’èª­ã¿è¾¼ã¿`);
            return virtualFlow;
        }

        async function testQuestionDisplay(questionId) {
            if (!virtualFlow) {
                throw new Error('VirtualFlow ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
            }

            const questionIndex = virtualFlow.questions.findIndex(q => q.id === questionId);
            if (questionIndex < 0) {
                throw new Error(`è¨­å• ${questionId} ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“`);
            }

            console.log(`ğŸ§ª ${questionId} ã®ãƒ†ã‚¹ãƒˆé–‹å§‹...`);
            
            // è¨­å•ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’è¨­å®š
            virtualFlow.currentQuestionIndex = questionIndex;
            virtualFlow.updateVisibleRange();
            
            // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°å®Œäº†ã‚’å¾…æ©Ÿ
            await new Promise(resolve => setTimeout(resolve, 200));
            
            // DOMè¦ç´ ã®ç¢ºèª
            const viewport = document.querySelector('#virtual-viewport');
            const questionElement = Array.from(viewport?.children || []).find(el => 
                el.dataset && el.dataset.questionId === questionId
            );

            const questionNumber = parseInt(questionId.replace('q', ''));
            const isEven = questionNumber % 2 === 0;

            let result = {
                questionId: questionId,
                questionNumber: questionNumber,
                isEven: isEven,
                elementExists: !!questionElement,
                isVisible: false,
                styles: {},
                shadowDOMPresent: false,
                issues: [],
                passed: false
            };

            if (questionElement) {
                console.log(`âœ… è¦ç´ ç™ºè¦‹: ${questionId}`);
                
                // ã‚¹ã‚¿ã‚¤ãƒ«ç¢ºèª
                const computedStyle = window.getComputedStyle(questionElement);
                result.styles = {
                    display: computedStyle.display,
                    opacity: computedStyle.opacity,
                    visibility: computedStyle.visibility,
                    offsetHeight: questionElement.offsetHeight,
                    offsetWidth: questionElement.offsetWidth
                };

                // å¯è¦–æ€§åˆ¤å®š
                result.isVisible = computedStyle.display !== 'none' && 
                                  computedStyle.opacity !== '0' && 
                                  computedStyle.visibility !== 'hidden' &&
                                  questionElement.offsetHeight > 0;

                // Shadow DOM ç¢ºèª
                result.shadowDOMPresent = !!questionElement.shadowRoot;
                
                console.log(`Display: ${result.styles.display}, Opacity: ${result.styles.opacity}, Height: ${result.styles.offsetHeight}`);
                console.log(`Visible: ${result.isVisible ? 'âœ…' : 'âŒ'}`);

                // å•é¡Œã®ç‰¹å®š
                if (!result.isVisible) {
                    if (result.styles.display === 'none') {
                        result.issues.push('display: none ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹');
                    }
                    if (result.styles.opacity === '0') {
                        result.issues.push('opacity: 0 ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹');
                    }
                    if (result.styles.visibility === 'hidden') {
                        result.issues.push('visibility: hidden ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹');
                    }
                    if (result.styles.offsetHeight === 0) {
                        result.issues.push('è¦ç´ ã®é«˜ã•ãŒ0px');
                    }
                }

                result.passed = result.isVisible;
            } else {
                console.log(`âŒ è¦ç´ ãŒè¦‹ã¤ã‹ã‚‰ãªã„: ${questionId}`);
                result.issues.push('DOMè¦ç´ ãŒä½œæˆã•ã‚Œã¦ã„ãªã„');
            }

            console.log(`${questionId} ãƒ†ã‚¹ãƒˆçµæœ: ${result.passed ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—'}`);
            return result;
        }

        async function runEvenQuestionTest() {
            console.log('\nğŸ§ª å¶æ•°ç•ªè¨­å•è¡¨ç¤ºãƒ†ã‚¹ãƒˆé–‹å§‹');
            testResults = [];
            
            try {
                await initializeVirtualFlow();
                
                if (virtualFlow.questions.length === 0) {
                    throw new Error('è¨­å•ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                // å¶æ•°ç•ªè¨­å•ã‚’ç‰¹å®š
                const evenQuestions = virtualFlow.questions.filter(q => {
                    const num = parseInt(q.id.replace('q', ''));
                    return num % 2 === 0;
                });
                
                console.log(`å¶æ•°ç•ªè¨­å•: ${evenQuestions.length}å€‹ (${evenQuestions.map(q => q.id).join(', ')})`);
                
                // å„å¶æ•°ç•ªè¨­å•ã‚’ãƒ†ã‚¹ãƒˆ
                for (const question of evenQuestions.slice(0, 10)) { // æœ€åˆã®10å€‹ã‚’ãƒ†ã‚¹ãƒˆ
                    const result = await testQuestionDisplay(question.id);
                    testResults.push(result);
                    
                    // UIã‚’æ›´æ–°
                    updateSummary(testResults);
                    updateDetailedResults(testResults);
                    
                    // å°‘ã—å¾…æ©Ÿ
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                console.log('\nğŸ“Š å¶æ•°ç•ªè¨­å•ãƒ†ã‚¹ãƒˆå®Œäº†');
                const passedCount = testResults.filter(r => r.passed).length;
                console.log(`æˆåŠŸ: ${passedCount}/${testResults.length}`);
                
            } catch (error) {
                console.error('âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        async function runAllQuestionsTest() {
            console.log('\nğŸ§ª å…¨è¨­å•è¡¨ç¤ºãƒ†ã‚¹ãƒˆé–‹å§‹');
            testResults = [];
            
            try {
                await initializeVirtualFlow();
                
                if (virtualFlow.questions.length === 0) {
                    throw new Error('è¨­å•ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                }
                
                console.log(`å…¨è¨­å•: ${virtualFlow.questions.length}å€‹`);
                
                // å…¨è¨­å•ã‚’ãƒ†ã‚¹ãƒˆ
                for (const question of virtualFlow.questions.slice(0, 15)) { // æœ€åˆã®15å€‹ã‚’ãƒ†ã‚¹ãƒˆ
                    const result = await testQuestionDisplay(question.id);
                    testResults.push(result);
                    
                    // UIã‚’æ›´æ–°
                    updateSummary(testResults);
                    updateDetailedResults(testResults);
                    
                    // å°‘ã—å¾…æ©Ÿ
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                
                console.log('\nğŸ“Š å…¨è¨­å•ãƒ†ã‚¹ãƒˆå®Œäº†');
                const passedCount = testResults.filter(r => r.passed).length;
                console.log(`æˆåŠŸ: ${passedCount}/${testResults.length}`);
                
            } catch (error) {
                console.error('âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼:', error);
            }
        }

        function resetTest() {
            console.log('ğŸ”„ ãƒ†ã‚¹ãƒˆãƒªã‚»ãƒƒãƒˆ');
            testResults = [];
            
            if (virtualFlow) {
                virtualFlow.cleanup();
                virtualFlow = null;
            }
            
            document.getElementById('questions-container').innerHTML = '';
            document.getElementById('summary-content').innerHTML = 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå‰...';
            document.getElementById('results-content').innerHTML = 'ã¾ã ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“';
            testLog.textContent = '';
        }

        // åˆæœŸåŒ–å®Œäº†ã‚’å¾…ã£ã¦ã‹ã‚‰ãƒ†ã‚¹ãƒˆé–‹å§‹å¯èƒ½ã«ã™ã‚‹
        window.addEventListener('load', () => {
            console.log('ğŸ‰ ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            console.log('åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ:');
            console.log(`- BaseComponent: ${typeof BaseComponent !== 'undefined'}`);
            console.log(`- StorageManager: ${typeof StorageManager !== 'undefined'}`);
            console.log(`- VirtualQuestionFlow: ${typeof VirtualQuestionFlow !== 'undefined'}`);
            console.log(`- WORLDVIEW_QUESTIONS: ${typeof WORLDVIEW_QUESTIONS !== 'undefined'} (${WORLDVIEW_QUESTIONS?.length || 0}å€‹)`);
            console.log(`- SCENARIO_QUESTIONS: ${typeof SCENARIO_QUESTIONS !== 'undefined'} (${SCENARIO_QUESTIONS?.length || 0}å€‹)`);
        });
    </script>
</body>
</html>