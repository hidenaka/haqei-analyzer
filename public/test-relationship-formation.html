<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relationship Formation Test - HAQEI Analyzer</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            margin: 0;
            padding: 20px;
        }
        
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .test-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .test-btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #2980b9;
        }
        
        .test-btn:disabled {
            background: #7f8c8d;
            cursor: not-allowed;
        }
        
        #personality-construction-test {
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            background: #2c3e50;
            min-height: 400px;
        }
        
        .status-display {
            background: #34495e;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .status-item {
            margin: 5px 0;
            padding: 5px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }
        
        .error-display {
            background: #e74c3c;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
        
        .success-display {
            background: #27ae60;
            color: white;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>🔗 Relationship Formation Test</h1>
            <p>PersonalityConstructionView.js の showRelationshipFormation メソッドをテスト</p>
        </div>
        
        <div class="test-controls">
            <button id="test-basic" class="test-btn">基本テスト</button>
            <button id="test-with-data" class="test-btn">データ付きテスト</button>
            <button id="test-error-handling" class="test-btn">エラーハンドリングテスト</button>
            <button id="clear-test" class="test-btn">クリア</button>
        </div>
        
        <div class="status-display">
            <h3>📊 テスト状況</h3>
            <div id="test-status">
                <div class="status-item">準備完了 - テストボタンを押してください</div>
            </div>
        </div>
        
        <div class="error-display" id="error-display"></div>
        <div class="success-display" id="success-display"></div>
        
        <div id="personality-construction-test">
            <!-- PersonalityConstructionView がここに描画されます -->
        </div>
    </div>

    <!-- BaseComponent の仮実装 -->
    <script>
        class BaseComponent {
            constructor(containerId) {
                this.containerId = containerId;
                this.container = document.getElementById(containerId);
                if (!this.container) {
                    throw new Error(`Container with id '${containerId}' not found`);
                }
            }
        }

        // MCP フック の仮実装
        window.mcpHooks = {
            logPhase: (phase, data) => {
                console.log(`🔗 MCP Hook - Phase: ${phase}`, data);
                updateTestStatus(`MCP Hook: ${phase} - ${data.phase || 'N/A'}`);
            },
            logError: (errorType, data) => {
                console.error(`❌ MCP Hook - Error: ${errorType}`, data);
                updateTestStatus(`MCP Error: ${errorType} - ${data.error || 'Unknown error'}`);
            }
        };

        function updateTestStatus(message) {
            const statusDiv = document.getElementById('test-status');
            const statusItem = document.createElement('div');
            statusItem.className = 'status-item';
            statusItem.innerHTML = `<span style="color: #3498db;">${new Date().toLocaleTimeString()}</span> - ${message}`;
            statusDiv.appendChild(statusItem);
            statusDiv.scrollTop = statusDiv.scrollHeight;
        }

        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('success-display');
            successDiv.textContent = message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // テスト用サンプルデータ
        const sampleVirtualPersonality = {
            id: 'test-personality-001',
            engineOS: {
                osName: 'Creative Engine',
                characteristics: {
                    primary_traits: ['創造性', '論理性', '価値判断']
                },
                activation: 0.75
            },
            interfaceOS: {
                osName: 'Social Interface',
                characteristics: {
                    primary_traits: ['協調性', '社交性', '適応性']
                },
                activation: 0.65
            },
            safeModeOS: {
                osName: 'Guardian SafeMode',
                characteristics: {
                    primary_traits: ['保護性', '慎重性', '安定性']
                },
                activation: 0.80
            },
            personalityState: {
                currentDominantOS: 'engine',
                balance: { engine: 0.4, interface: 0.35, safemode: 0.25 }
            },
            personalityMetadata: {
                personalityType: 'クリエイティブ統合型',
                createdAt: new Date().toISOString()
            }
        };
    </script>

    <!-- PersonalityConstructionView.js を読み込み -->
    <script src="js/os-analyzer/components/PersonalityConstructionView.js"></script>

    <script>
        let personalityView = null;

        // テスト関数
        async function runBasicTest() {
            try {
                updateTestStatus('基本テスト開始...');
                
                if (personalityView) {
                    personalityView = null;
                }

                personalityView = new PersonalityConstructionView('personality-construction-test');
                updateTestStatus('PersonalityConstructionView インスタンス作成完了');

                // showRelationshipFormation メソッドの存在確認
                if (typeof personalityView.showRelationshipFormation === 'function') {
                    updateTestStatus('✅ showRelationshipFormation メソッドが存在します');
                    
                    // 基本的な仮想人格データで実行
                    personalityView.virtualPersonality = sampleVirtualPersonality;
                    personalityView.animationSpeed = 3.0; // 高速テスト
                    
                    await personalityView.showRelationshipFormation();
                    showSuccess('✅ 基本テスト完了 - showRelationshipFormation が正常に実行されました');
                    
                } else {
                    throw new Error('showRelationshipFormation メソッドが見つかりません');
                }

            } catch (error) {
                console.error('Basic test failed:', error);
                showError(`基本テストエラー: ${error.message}`);
                updateTestStatus(`❌ 基本テストエラー: ${error.message}`);
            }
        }

        async function runDataTest() {
            try {
                updateTestStatus('データ付きテスト開始...');
                
                if (!personalityView) {
                    personalityView = new PersonalityConstructionView('personality-construction-test');
                }

                // 複雑なテストデータで実行
                personalityView.virtualPersonality = sampleVirtualPersonality;
                personalityView.animationSpeed = 2.0;
                
                await personalityView.showRelationshipFormation();
                showSuccess('✅ データ付きテスト完了');
                
            } catch (error) {
                console.error('Data test failed:', error);
                showError(`データテストエラー: ${error.message}`);
                updateTestStatus(`❌ データテストエラー: ${error.message}`);
            }
        }

        async function runErrorHandlingTest() {
            try {
                updateTestStatus('エラーハンドリングテスト開始...');
                
                if (!personalityView) {
                    personalityView = new PersonalityConstructionView('personality-construction-test');
                }

                // 意図的に問題のあるデータで実行
                personalityView.virtualPersonality = null; // null データでテスト
                personalityView.animationSpeed = 5.0;
                
                await personalityView.showRelationshipFormation();
                showSuccess('✅ エラーハンドリングテスト完了 - フォールバック処理が正常に動作');
                updateTestStatus('✅ フォールバック処理が正常に動作しました');
                
            } catch (error) {
                console.error('Error handling test failed:', error);
                showError(`エラーハンドリングテストエラー: ${error.message}`);
                updateTestStatus(`❌ エラーハンドリングテストエラー: ${error.message}`);
            }
        }

        function clearTest() {
            const container = document.getElementById('personality-construction-test');
            container.innerHTML = '';
            
            const statusDiv = document.getElementById('test-status');
            statusDiv.innerHTML = '<div class="status-item">テストクリア完了 - 新しいテストを開始できます</div>';
            
            personalityView = null;
            updateTestStatus('🔄 テスト環境をクリアしました');
        }

        // イベントリスナー設定
        document.getElementById('test-basic').addEventListener('click', runBasicTest);
        document.getElementById('test-with-data').addEventListener('click', runDataTest);
        document.getElementById('test-error-handling').addEventListener('click', runErrorHandlingTest);
        document.getElementById('clear-test').addEventListener('click', clearTest);

        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            updateTestStatus('🚀 テスト環境初期化完了');
            updateTestStatus('PersonalityConstructionView.js 読み込み完了');
        });
    </script>
</body>
</html>