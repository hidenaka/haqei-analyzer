<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triple OS Save Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            background: #252525;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #5a6578;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            overflow-x: auto;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .warning { color: #ed8936; }
        .info { color: #4299e1; }
    </style>
</head>
<body>
    <h1>ğŸ”¬ Triple OS ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ†ã‚¹ãƒˆ</h1>
    
    <div class="test-section">
        <h2>1. åˆ†æå®Ÿè¡Œã¨ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testCompleteFlow()">å®Œå…¨ãªåˆ†æãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="checkStorageData()">LocalStorageãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèª</button>
        <button onclick="clearTestData()">ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢</button>
        <pre id="flow-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>2. ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆæ¤œè¨¼</h2>
        <button onclick="validateDataFormats()">ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ¤œè¨¼</button>
        <pre id="format-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>3. ä¿å­˜ãƒ¡ã‚½ãƒƒãƒ‰ç›´æ¥ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testDirectSave()">saveAnalysisResultã‚’ç›´æ¥ãƒ†ã‚¹ãƒˆ</button>
        <pre id="save-result"></pre>
    </div>

    <!-- å¿…è¦ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/shared/core/SimpleStorageManager.js"></script>
    <script src="js/shared/utils/DataFlowMonitor.js"></script>
    <script src="js/shared/utils/SimpleHooks.js"></script>
    <script src="js/shared/os-analyzer/DataManager.js"></script>
    <script src="js/shared/os-analyzer/Calculator.js"></script>
    <script src="js/shared/os-analyzer/IChingCompatibilityDataLoader.js"></script>
    <script src="js/os-analyzer/core/Engine.js"></script>
    <script src="js/os-analyzer/core/IChingUltraSyncLogic.js"></script>
    <script src="js/os-analyzer/core/TripleOSEngine.js"></script>
    <script src="js/os-analyzer/core/UltraAnalysisEngine.js"></script>
    <script src="js/shared/core/MicroStorageManager.js"></script>
    <script src="js/shared/core/StorageManager.js"></script>
    <script src="js/shared/core/BridgeStorageManager.js"></script>

    <script>
        // ãƒ†ã‚¹ãƒˆç”¨å›ç­”ãƒ‡ãƒ¼ã‚¿ï¼ˆTripleOSEngineæœŸå¾…å½¢å¼ï¼‰
        const testAnswers = [];
        for (let i = 1; i <= 30; i++) {
            const choices = ['a', 'b', 'c', 'd'];
            const choice = choices[Math.floor(Math.random() * 4)];
            testAnswers.push({
                questionId: `q${i}`,
                selectedChoice: `q${i}${choice}`,
                choiceText: `é¸æŠè‚¢${choice.toUpperCase()}ã®ãƒ†ã‚­ã‚¹ãƒˆ`,
                selectedValue: choice.toUpperCase(),
                timestamp: new Date().toISOString()
            });
        }

        async function testCompleteFlow() {
            const resultEl = document.getElementById('flow-result');
            resultEl.innerHTML = '<span class="info">åˆ†æãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œä¸­...</span>\n';
            
            try {
                // 1. DataManagerã®åˆæœŸåŒ–
                resultEl.innerHTML += '<span class="info">ğŸ“Š DataManageråˆæœŸåŒ–ä¸­...</span>\n';
                const dataManager = new DataManager();
                await dataManager.loadAllData();
                resultEl.innerHTML += '<span class="success">âœ… DataManageråˆæœŸåŒ–å®Œäº†</span>\n\n';
                
                // 2. UltraAnalysisEngineã®åˆæœŸåŒ–ã¨å®Ÿè¡Œ
                resultEl.innerHTML += '<span class="info">ğŸš€ UltraAnalysisEngineåˆ†æé–‹å§‹...</span>\n';
                const engine = new UltraAnalysisEngine(dataManager);
                const analysisResult = await engine.analyzeTripleOS(testAnswers);
                
                resultEl.innerHTML += '<span class="success">âœ… åˆ†æå®Œäº†</span>\n';
                resultEl.innerHTML += `<span class="info">åˆ†æçµæœã‚¿ã‚¤ãƒ—: ${analysisResult?.analysisType || 'unknown'}</span>\n`;
                resultEl.innerHTML += `<span class="info">Engine OS: ${analysisResult?.engineOS ? 'âœ…' : 'âŒ'}</span>\n`;
                resultEl.innerHTML += `<span class="info">Interface OS: ${analysisResult?.interfaceOS ? 'âœ…' : 'âŒ'}</span>\n`;
                resultEl.innerHTML += `<span class="info">SafeMode OS: ${analysisResult?.safeModeOS ? 'âœ…' : 'âŒ'}</span>\n\n`;
                
                // 3. StorageManagerã§ã®ä¿å­˜
                resultEl.innerHTML += '<span class="info">ğŸ’¾ StorageManagerã§ä¿å­˜ä¸­...</span>\n';
                const storageManager = new StorageManager();
                const saveSuccess = storageManager.saveAnalysisResult(analysisResult);
                
                if (saveSuccess) {
                    resultEl.innerHTML += '<span class="success">âœ… StorageManagerä¿å­˜æˆåŠŸ</span>\n';
                } else {
                    resultEl.innerHTML += '<span class="error">âŒ StorageManagerä¿å­˜å¤±æ•—</span>\n';
                }
                
                // 4. ç›´æ¥LocalStorageç¢ºèª
                resultEl.innerHTML += '\n<span class="info">ğŸ“¦ LocalStorageç›´æ¥ç¢ºèª:</span>\n';
                const keys = [
                    'haqei_analysis_result',
                    'haqei_diagnosis_result',
                    'haqei_simple_analysis_result',
                    'haqei_simple_unified_diagnosis_data'
                ];
                
                for (const key of keys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            resultEl.innerHTML += `<span class="success">âœ… ${key}: ${Object.keys(parsed).length}å€‹ã®ã‚­ãƒ¼</span>\n`;
                        } catch (e) {
                            resultEl.innerHTML += `<span class="warning">âš ï¸ ${key}: JSONè§£æã‚¨ãƒ©ãƒ¼</span>\n`;
                        }
                    } else {
                        resultEl.innerHTML += `<span class="error">âŒ ${key}: ãªã—</span>\n`;
                    }
                }
                
                // 5. åˆ†æçµæœã®è©³ç´°
                resultEl.innerHTML += '\n<span class="info">ğŸ“Š åˆ†æçµæœè©³ç´°:</span>\n';
                resultEl.innerHTML += JSON.stringify(analysisResult, null, 2);
                
            } catch (error) {
                resultEl.innerHTML += `\n<span class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</span>\n`;
                resultEl.innerHTML += `<span class="error">ã‚¹ã‚¿ãƒƒã‚¯: ${error.stack}</span>`;
            }
        }

        function checkStorageData() {
            const resultEl = document.getElementById('flow-result');
            resultEl.innerHTML = '<span class="info">LocalStorageãƒ‡ãƒ¼ã‚¿ã‚’ç¢ºèªä¸­...</span>\n\n';
            
            const relevantKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('haqei') || key.includes('analysis') || key.includes('result')) {
                    relevantKeys.push(key);
                }
            }
            
            if (relevantKeys.length === 0) {
                resultEl.innerHTML += '<span class="warning">âš ï¸ é–¢é€£ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</span>';
                return;
            }
            
            relevantKeys.forEach(key => {
                const value = localStorage.getItem(key);
                resultEl.innerHTML += `<span class="info">ğŸ“ ${key}:</span>\n`;
                
                try {
                    const parsed = JSON.parse(value);
                    
                    // Triple OSãƒ‡ãƒ¼ã‚¿ã®å­˜åœ¨ç¢ºèª
                    if (parsed.engineOS || parsed.interfaceOS || parsed.safeModeOS) {
                        resultEl.innerHTML += '<span class="success">  âœ… Triple OSãƒ‡ãƒ¼ã‚¿ã‚ã‚Š</span>\n';
                    }
                    
                    resultEl.innerHTML += `  ãƒ‡ãƒ¼ã‚¿: ${JSON.stringify(parsed, null, 2).substring(0, 500)}...\n\n`;
                } catch (e) {
                    resultEl.innerHTML += `  ç”Ÿãƒ‡ãƒ¼ã‚¿: ${value.substring(0, 100)}...\n\n`;
                }
            });
        }

        function clearTestData() {
            const resultEl = document.getElementById('flow-result');
            
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('haqei')) {
                    keys.push(key);
                }
            }
            
            keys.forEach(key => localStorage.removeItem(key));
            sessionStorage.clear();
            
            resultEl.innerHTML = `<span class="success">âœ… ${keys.length}å€‹ã®ã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ</span>`;
        }

        function validateDataFormats() {
            const resultEl = document.getElementById('format-result');
            resultEl.innerHTML = '<span class="info">ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’æ¤œè¨¼ä¸­...</span>\n\n';
            
            // å›ç­”ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ç¢ºèª
            resultEl.innerHTML += '<span class="info">ğŸ“ å›ç­”ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:</span>\n';
            resultEl.innerHTML += JSON.stringify(testAnswers[0], null, 2) + '\n\n';
            
            // æœŸå¾…ã•ã‚Œã‚‹TripleOSãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            const expectedFormat = {
                analysisType: 'tripleOS',
                engineOS: {
                    name: 'Engine OSå',
                    strength: 0.85,
                    hexagramInfo: { name: 'å¦å' }
                },
                interfaceOS: { /* åŒæ§˜ */ },
                safeModeOS: { /* åŒæ§˜ */ },
                primaryOS: { /* åŒæ§˜ */ },
                timestamp: '2025-08-01T...'
            };
            
            resultEl.innerHTML += '<span class="info">ğŸ“Š æœŸå¾…ã•ã‚Œã‚‹TripleOSãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:</span>\n';
            resultEl.innerHTML += JSON.stringify(expectedFormat, null, 2);
        }

        async function testDirectSave() {
            const resultEl = document.getElementById('save-result');
            resultEl.innerHTML = '<span class="info">ç›´æ¥ä¿å­˜ãƒ†ã‚¹ãƒˆé–‹å§‹...</span>\n\n';
            
            // ãƒ¢ãƒƒã‚¯ã®Triple OSãƒ‡ãƒ¼ã‚¿
            const mockTripleOSData = {
                analysisType: 'tripleOS',
                engineOS: {
                    name: 'ãƒ†ã‚¹ãƒˆEngine OS',
                    strength: 0.85,
                    hexagramInfo: { name: 'ä¹¾ç‚ºå¤©', number: 1 }
                },
                interfaceOS: {
                    name: 'ãƒ†ã‚¹ãƒˆInterface OS',
                    strength: 0.75,
                    hexagramInfo: { name: 'å¤ç‚ºåœ°', number: 2 }
                },
                safeModeOS: {
                    name: 'ãƒ†ã‚¹ãƒˆSafeMode OS',
                    strength: 0.65,
                    hexagramInfo: { name: 'æ°´é›·å±¯', number: 3 }
                },
                primaryOS: {
                    type: 'engine',
                    name: 'ãƒ†ã‚¹ãƒˆEngine OS',
                    strength: 0.85
                },
                timestamp: new Date().toISOString()
            };
            
            try {
                // å„ç¨®StorageManagerã§ãƒ†ã‚¹ãƒˆ
                const managers = [
                    { name: 'StorageManager', instance: new StorageManager() },
                    { name: 'SimpleStorageManager', instance: new SimpleStorageManager() },
                    { name: 'BridgeStorageManager', instance: new BridgeStorageManager() }
                ];
                
                for (const { name, instance } of managers) {
                    resultEl.innerHTML += `<span class="info">ğŸ”§ ${name}ã§ãƒ†ã‚¹ãƒˆ:</span>\n`;
                    
                    const success = instance.saveAnalysisResult(mockTripleOSData);
                    if (success) {
                        resultEl.innerHTML += `<span class="success">  âœ… ä¿å­˜æˆåŠŸ</span>\n`;
                        
                        // èª­ã¿å–ã‚Šç¢ºèª
                        const retrieved = instance.getAnalysisResult();
                        if (retrieved && retrieved.engineOS) {
                            resultEl.innerHTML += `<span class="success">  âœ… èª­ã¿å–ã‚ŠæˆåŠŸ</span>\n`;
                        } else {
                            resultEl.innerHTML += `<span class="error">  âŒ èª­ã¿å–ã‚Šå¤±æ•—</span>\n`;
                        }
                    } else {
                        resultEl.innerHTML += `<span class="error">  âŒ ä¿å­˜å¤±æ•—</span>\n`;
                    }
                }
                
                // ç›´æ¥localStorageç¢ºèª
                resultEl.innerHTML += '\n<span class="info">ğŸ“¦ ç›´æ¥localStorageç¢ºèª:</span>\n';
                const directData = localStorage.getItem('haqei_analysis_result');
                if (directData) {
                    const parsed = JSON.parse(directData);
                    resultEl.innerHTML += '<span class="success">âœ… ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¾ã™</span>\n';
                    resultEl.innerHTML += `  Engine OS: ${parsed.engineOS ? 'âœ…' : 'âŒ'}\n`;
                    resultEl.innerHTML += `  Interface OS: ${parsed.interfaceOS ? 'âœ…' : 'âŒ'}\n`;
                    resultEl.innerHTML += `  SafeMode OS: ${parsed.safeModeOS ? 'âœ…' : 'âŒ'}\n`;
                } else {
                    resultEl.innerHTML += '<span class="error">âŒ haqei_analysis_resultãŒå­˜åœ¨ã—ã¾ã›ã‚“</span>\n';
                }
                
            } catch (error) {
                resultEl.innerHTML += `\n<span class="error">âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>