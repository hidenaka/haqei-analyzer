<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triple OS Save Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #333;
            background: #252525;
            border-radius: 8px;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4a5568;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background: #5a6578;
        }
        pre {
            background: #1a1a1a;
            padding: 15px;
            overflow-x: auto;
            border-radius: 4px;
            border: 1px solid #333;
        }
        .success { color: #48bb78; }
        .error { color: #f56565; }
        .warning { color: #ed8936; }
        .info { color: #4299e1; }
    </style>
</head>
<body>
    <h1>🔬 Triple OS データ保存テスト</h1>
    
    <div class="test-section">
        <h2>1. 分析実行とデータ保存テスト</h2>
        <button onclick="testCompleteFlow()">完全な分析フローをテスト</button>
        <button onclick="checkStorageData()">LocalStorageデータを確認</button>
        <button onclick="clearTestData()">テストデータをクリア</button>
        <pre id="flow-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>2. データフォーマット検証</h2>
        <button onclick="validateDataFormats()">データフォーマットを検証</button>
        <pre id="format-result"></pre>
    </div>
    
    <div class="test-section">
        <h2>3. 保存メソッド直接テスト</h2>
        <button onclick="testDirectSave()">saveAnalysisResultを直接テスト</button>
        <pre id="save-result"></pre>
    </div>

    <!-- 必要なスクリプトを読み込み -->
    <script src="js/shared/core/SimpleStorageManager.js"></script>
    <script src="js/shared/utils/DataFlowMonitor.js"></script>
    <script src="js/shared/utils/SimpleHooks.js"></script>
    <script src="js/shared/os-analyzer/DataManager.js"></script>
    <script src="js/shared/os-analyzer/Calculator.js"></script>
    <script src="js/shared/os-analyzer/IChingCompatibilityDataLoader.js"></script>
    <script src="js/os-analyzer/core/Engine.js"></script>
    <script src="js/os-analyzer/core/IChingUltraSyncLogic.js"></script>
    <script src="js/os-analyzer/core/TripleOSEngine.js"></script>
    <script src="js/os-analyzer/core/UltraAnalysisEngine.js"></script>
    <script src="js/shared/core/MicroStorageManager.js"></script>
    <script src="js/shared/core/StorageManager.js"></script>
    <script src="js/shared/core/BridgeStorageManager.js"></script>

    <script>
        // テスト用回答データ（TripleOSEngine期待形式）
        const testAnswers = [];
        for (let i = 1; i <= 30; i++) {
            const choices = ['a', 'b', 'c', 'd'];
            const choice = choices[Math.floor(Math.random() * 4)];
            testAnswers.push({
                questionId: `q${i}`,
                selectedChoice: `q${i}${choice}`,
                choiceText: `選択肢${choice.toUpperCase()}のテキスト`,
                selectedValue: choice.toUpperCase(),
                timestamp: new Date().toISOString()
            });
        }

        async function testCompleteFlow() {
            const resultEl = document.getElementById('flow-result');
            resultEl.innerHTML = '<span class="info">分析フローを実行中...</span>\n';
            
            try {
                // 1. DataManagerの初期化
                resultEl.innerHTML += '<span class="info">📊 DataManager初期化中...</span>\n';
                const dataManager = new DataManager();
                await dataManager.loadAllData();
                resultEl.innerHTML += '<span class="success">✅ DataManager初期化完了</span>\n\n';
                
                // 2. UltraAnalysisEngineの初期化と実行
                resultEl.innerHTML += '<span class="info">🚀 UltraAnalysisEngine分析開始...</span>\n';
                const engine = new UltraAnalysisEngine(dataManager);
                const analysisResult = await engine.analyzeTripleOS(testAnswers);
                
                resultEl.innerHTML += '<span class="success">✅ 分析完了</span>\n';
                resultEl.innerHTML += `<span class="info">分析結果タイプ: ${analysisResult?.analysisType || 'unknown'}</span>\n`;
                resultEl.innerHTML += `<span class="info">Engine OS: ${analysisResult?.engineOS ? '✅' : '❌'}</span>\n`;
                resultEl.innerHTML += `<span class="info">Interface OS: ${analysisResult?.interfaceOS ? '✅' : '❌'}</span>\n`;
                resultEl.innerHTML += `<span class="info">SafeMode OS: ${analysisResult?.safeModeOS ? '✅' : '❌'}</span>\n\n`;
                
                // 3. StorageManagerでの保存
                resultEl.innerHTML += '<span class="info">💾 StorageManagerで保存中...</span>\n';
                const storageManager = new StorageManager();
                const saveSuccess = storageManager.saveAnalysisResult(analysisResult);
                
                if (saveSuccess) {
                    resultEl.innerHTML += '<span class="success">✅ StorageManager保存成功</span>\n';
                } else {
                    resultEl.innerHTML += '<span class="error">❌ StorageManager保存失敗</span>\n';
                }
                
                // 4. 直接LocalStorage確認
                resultEl.innerHTML += '\n<span class="info">📦 LocalStorage直接確認:</span>\n';
                const keys = [
                    'haqei_analysis_result',
                    'haqei_diagnosis_result',
                    'haqei_simple_analysis_result',
                    'haqei_simple_unified_diagnosis_data'
                ];
                
                for (const key of keys) {
                    const data = localStorage.getItem(key);
                    if (data) {
                        try {
                            const parsed = JSON.parse(data);
                            resultEl.innerHTML += `<span class="success">✅ ${key}: ${Object.keys(parsed).length}個のキー</span>\n`;
                        } catch (e) {
                            resultEl.innerHTML += `<span class="warning">⚠️ ${key}: JSON解析エラー</span>\n`;
                        }
                    } else {
                        resultEl.innerHTML += `<span class="error">❌ ${key}: なし</span>\n`;
                    }
                }
                
                // 5. 分析結果の詳細
                resultEl.innerHTML += '\n<span class="info">📊 分析結果詳細:</span>\n';
                resultEl.innerHTML += JSON.stringify(analysisResult, null, 2);
                
            } catch (error) {
                resultEl.innerHTML += `\n<span class="error">❌ エラー: ${error.message}</span>\n`;
                resultEl.innerHTML += `<span class="error">スタック: ${error.stack}</span>`;
            }
        }

        function checkStorageData() {
            const resultEl = document.getElementById('flow-result');
            resultEl.innerHTML = '<span class="info">LocalStorageデータを確認中...</span>\n\n';
            
            const relevantKeys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('haqei') || key.includes('analysis') || key.includes('result')) {
                    relevantKeys.push(key);
                }
            }
            
            if (relevantKeys.length === 0) {
                resultEl.innerHTML += '<span class="warning">⚠️ 関連データが見つかりません</span>';
                return;
            }
            
            relevantKeys.forEach(key => {
                const value = localStorage.getItem(key);
                resultEl.innerHTML += `<span class="info">📁 ${key}:</span>\n`;
                
                try {
                    const parsed = JSON.parse(value);
                    
                    // Triple OSデータの存在確認
                    if (parsed.engineOS || parsed.interfaceOS || parsed.safeModeOS) {
                        resultEl.innerHTML += '<span class="success">  ✅ Triple OSデータあり</span>\n';
                    }
                    
                    resultEl.innerHTML += `  データ: ${JSON.stringify(parsed, null, 2).substring(0, 500)}...\n\n`;
                } catch (e) {
                    resultEl.innerHTML += `  生データ: ${value.substring(0, 100)}...\n\n`;
                }
            });
        }

        function clearTestData() {
            const resultEl = document.getElementById('flow-result');
            
            const keys = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.includes('haqei')) {
                    keys.push(key);
                }
            }
            
            keys.forEach(key => localStorage.removeItem(key));
            sessionStorage.clear();
            
            resultEl.innerHTML = `<span class="success">✅ ${keys.length}個のキーをクリアしました</span>`;
        }

        function validateDataFormats() {
            const resultEl = document.getElementById('format-result');
            resultEl.innerHTML = '<span class="info">データフォーマットを検証中...</span>\n\n';
            
            // 回答データフォーマットの確認
            resultEl.innerHTML += '<span class="info">📝 回答データフォーマット:</span>\n';
            resultEl.innerHTML += JSON.stringify(testAnswers[0], null, 2) + '\n\n';
            
            // 期待されるTripleOSフォーマット
            const expectedFormat = {
                analysisType: 'tripleOS',
                engineOS: {
                    name: 'Engine OS名',
                    strength: 0.85,
                    hexagramInfo: { name: '卦名' }
                },
                interfaceOS: { /* 同様 */ },
                safeModeOS: { /* 同様 */ },
                primaryOS: { /* 同様 */ },
                timestamp: '2025-08-01T...'
            };
            
            resultEl.innerHTML += '<span class="info">📊 期待されるTripleOSフォーマット:</span>\n';
            resultEl.innerHTML += JSON.stringify(expectedFormat, null, 2);
        }

        async function testDirectSave() {
            const resultEl = document.getElementById('save-result');
            resultEl.innerHTML = '<span class="info">直接保存テスト開始...</span>\n\n';
            
            // モックのTriple OSデータ
            const mockTripleOSData = {
                analysisType: 'tripleOS',
                engineOS: {
                    name: 'テストEngine OS',
                    strength: 0.85,
                    hexagramInfo: { name: '乾為天', number: 1 }
                },
                interfaceOS: {
                    name: 'テストInterface OS',
                    strength: 0.75,
                    hexagramInfo: { name: '坤為地', number: 2 }
                },
                safeModeOS: {
                    name: 'テストSafeMode OS',
                    strength: 0.65,
                    hexagramInfo: { name: '水雷屯', number: 3 }
                },
                primaryOS: {
                    type: 'engine',
                    name: 'テストEngine OS',
                    strength: 0.85
                },
                timestamp: new Date().toISOString()
            };
            
            try {
                // 各種StorageManagerでテスト
                const managers = [
                    { name: 'StorageManager', instance: new StorageManager() },
                    { name: 'SimpleStorageManager', instance: new SimpleStorageManager() },
                    { name: 'BridgeStorageManager', instance: new BridgeStorageManager() }
                ];
                
                for (const { name, instance } of managers) {
                    resultEl.innerHTML += `<span class="info">🔧 ${name}でテスト:</span>\n`;
                    
                    const success = instance.saveAnalysisResult(mockTripleOSData);
                    if (success) {
                        resultEl.innerHTML += `<span class="success">  ✅ 保存成功</span>\n`;
                        
                        // 読み取り確認
                        const retrieved = instance.getAnalysisResult();
                        if (retrieved && retrieved.engineOS) {
                            resultEl.innerHTML += `<span class="success">  ✅ 読み取り成功</span>\n`;
                        } else {
                            resultEl.innerHTML += `<span class="error">  ❌ 読み取り失敗</span>\n`;
                        }
                    } else {
                        resultEl.innerHTML += `<span class="error">  ❌ 保存失敗</span>\n`;
                    }
                }
                
                // 直接localStorage確認
                resultEl.innerHTML += '\n<span class="info">📦 直接localStorage確認:</span>\n';
                const directData = localStorage.getItem('haqei_analysis_result');
                if (directData) {
                    const parsed = JSON.parse(directData);
                    resultEl.innerHTML += '<span class="success">✅ データが存在します</span>\n';
                    resultEl.innerHTML += `  Engine OS: ${parsed.engineOS ? '✅' : '❌'}\n`;
                    resultEl.innerHTML += `  Interface OS: ${parsed.interfaceOS ? '✅' : '❌'}\n`;
                    resultEl.innerHTML += `  SafeMode OS: ${parsed.safeModeOS ? '✅' : '❌'}\n`;
                } else {
                    resultEl.innerHTML += '<span class="error">❌ haqei_analysis_resultが存在しません</span>\n';
                }
                
            } catch (error) {
                resultEl.innerHTML += `\n<span class="error">❌ エラー: ${error.message}</span>`;
            }
        }
    </script>
</body>
</html>