import { readFile, writeFile } from 'fs/promises';

async function fixPhase21RemainingEight() {
  try {
    console.log('=== フェーズ21: 残り8文字193件を精密修正 ===\n');
    
    // データベース読み込み
    let content = await readFile('./public/js/data/hexagram-human-traits-v3.js', 'utf-8');
    
    // remaining-short-descriptions.jsonから抽出した8文字の説明（193件から主要なもの）
    const eightCharFixes = {
      // 天山遯
      '"自立心の強い人々"': '"自立心の強い人々と活動"',
      '"シェルターに避難"': '"シェルターに避難して守る"',
      '"責任放棄に見える"': '"責任放棄に見えることがある"',
      
      // 雷天大壮
      '"力を発揮する機会"': '"力を発揮する機会を得る"',
      '"力で勝利した実感"': '"力で勝利した実感を得る"',
      '"力強く断定的に話す"': '"力強く断定的に話して伝える"',
      '"繊細な配慮、調整"': '"繊細な配慮と調整を行う"',
      '"強さを求める人々"': '"強さを求める人々と協力"',
      '"より強い力で対抗"': '"より強い力で対抗する"',
      '"激しくなりすぎる"': '"激しくなりすぎることがある"',
      '"自分の力を使う機会"': '"自分の力を使う機会を得る"',
      '"競争が激しい環境"': '"競争が激しい環境で活動"',
      
      // 火地晋
      '"一気に駆け上がる"': '"一気に駆け上がって成功"',
      '"実力を蓄える時間"': '"実力を蓄える大切な時間"',
      '"停滞は後退と感じる"': '"停滞は後退と感じやすい"',
      '"成長と昇進の機会"': '"成長と昇進の機会を得る"',
      '"上昇志向的な発言"': '"上昇志向的な発言をする"',
      '"目標設定、成長促進"': '"目標設定と成長促進を行う"',
      '"現状満足、停滞受入"': '"現状満足や停滞を受け入れる"',
      '"競争心が強すぎる"': '"競争心が強すぎることがある"',
      '"地位と実績で対抗"': '"地位と実績で対抗する"',
      '"地位にしがみつく"': '"地位にしがみつきやすい"',
      '"別の分野での成功"': '"別の分野での成功を目指す"',
      
      // 地火明夷
      '"瞑想、内省、独学"': '"瞑想と内省と独学を行う"',
      '"外界から離れて充電"': '"外界から離れて充電する"',
      '"深い洞察、本質理解"': '"深い洞察と本質理解を示す"',
      '"隠れた実力と深み"': '"隠れた実力と深みを持つ"',
      '"少しずつ表に出る"': '"少しずつ表に出ていく"',
      '"安全で評価的な環境"': '"安全で評価的な環境を求める"',
      '"実力を知る理解者"': '"実力を知る理解者と出会う"',
      
      // 風火家人
      '"家族の絆という燃料"': '"家族の絆という燃料で動く"',
      '"家族が危機に直面"': '"家族が危機に直面した時"',
      '"家族と過ごす時間"': '"家族と過ごす大切な時間"',
      '"家族が最高の充電"': '"家族が最高の充電源となる"',
      '"深い信頼関係と絆"': '"深い信頼関係と絆を築く"',
      '"プロ意識に欠ける"': '"プロ意識に欠けることがある"',
      '"お互いに支え合う力"': '"お互いに支え合う力を持つ"',
      '"自立心が弱い傾向"': '"自立心が弱い傾向がある"',
      '"家族総出で問題解決"': '"家族総出で問題解決する"',
      '"家族と共に回復する"': '"家族と共に回復していく"',
      '"家族旅行、団らん"': '"家族旅行や団らんを楽しむ"',
      
      // 火澤睽
      '"常に独自性を追求"': '"常に独自性を追求する"',
      '"自分らしさを再確認"': '"自分らしさを再確認する"',
      '"個性を発揮する場"': '"個性を発揮する場を得る"',
      '"独自性が評価される"': '"独自性が評価される環境"',
      '"独特な表現と視点"': '"独特な表現と視点を持つ"',
      '"創造性、独自提案"': '"創造性と独自提案を行う"',
      '"個性が活きる環境"': '"個性が活きる環境で活動"',
      '"個性を尊重する人々"': '"個性を尊重する人々と協働"',
      '"唯一無二の存在感"': '"唯一無二の存在感を発揮"',
      '"一人で全てを背負う"': '"一人で全てを背負って進む"',
      '"独自のペースで進む"': '"独自のペースで進んでいく"',
      '"独自の方法で回復"': '"独自の方法で回復する"',
      '"干渉されない空間"': '"干渉されない空間を確保"',
      '"距離を保った理解者"': '"距離を保った理解者と交流"',
      '"独自の価値を提供"': '"独自の価値を提供する"',
      '"孤立、または没個性"': '"孤立または没個性になりやすい"',
      
      // 水山蹇
      '"岩に穴を開ける水滴"': '"岩に穴を開ける水滴のように"',
      '"静かに力を蓄える"': '"静かに力を蓄えていく"',
      '"動かず待つのも休息"': '"動かず待つのも休息となる"',
      '"忍耐の意味と目的"': '"忍耐の意味と目的を理解"',
      '"耐え抜いた先の成果"': '"耐え抜いた先の成果を得る"',
      '"聖人のような忍耐"': '"聖人のような忍耐を持つ"',
      '"ゆっくり、辛抱強く"': '"ゆっくり辛抱強く進める"',
      '"傾聴、長期的関係"': '"傾聴と長期的関係を築く"',
      '"即決、スピード感"': '"即決とスピード感を出す"',
      '"忍耐が必要な環境"': '"忍耐が必要な環境で活動"',
      '"忍耐強く待てる人々"': '"忍耐強く待てる人々と協働"',
      '"物事の進展が遅い"': '"物事の進展が遅くなりがち"',
      '"城壁のような防御"': '"城壁のような防御を固める"',
      '"限界まで我慢する"': '"限界まで我慢してしまう"',
      '"時間をかけて癒す"': '"時間をかけて癒していく"',
      '"焦らずゆっくり回復"': '"焦らずゆっくり回復する"',
      '"停滞、または諦め"': '"停滞または諦めやすい"',
      
      // 雷水解
      '"檻から解放された鳥"': '"檻から解放された鳥のように"',
      '"制約を見つけて解く"': '"制約を見つけて解いていく"',
      '"全ての鎖を断ち切る"': '"全ての鎖を断ち切って進む"',
      '"束縛から離れて充電"': '"束縛から離れて充電する"',
      '"ルール遵守、管理"': '"ルール遵守と管理を行う"',
      '"みんなを解放する"': '"みんなを解放する力を持つ"',
      '"秩序を乱すことも"': '"秩序を乱すこともある"',
      '"しがらみを全て断つ"': '"しがらみを全て断ち切る"',
      '"自由を取り戻して"': '"自由を取り戻していく"',
      '"自由を理解する人"': '"自由を理解する人と共に"',
      '"自由と秩序の調和"': '"自由と秩序の調和を保つ"',
      '"無秩序、または束縛"': '"無秩序または束縛される"',
      
      // その他の頻出8文字パターン
      '"次の段階への準備"': '"次の段階への準備を進める"',
      '"新しい挑戦を始める"': '"新しい挑戦を始めていく"',
      '"成長の機会を掴む"': '"成長の機会を積極的に掴む"',
      '"変化に適応する力"': '"変化に適応する力を持つ"',
      '"困難を乗り越える"': '"困難を乗り越えて成長"',
      '"問題を解決する力"': '"問題を解決する力を発揮"',
      '"新たな可能性を探る"': '"新たな可能性を探っていく"',
      '"関係を構築する"': '"関係を構築していく"',
      '"価値を生み出す"': '"価値を生み出していく"',
      '"目標を達成する"': '"目標を達成していく"',
      '"成果を上げる力"': '"成果を上げる力を発揮"',
      '"結果を出す能力"': '"結果を出す能力を持つ"',
      '"実践的な知恵"': '"実践的な知恵を活用する"',
      '"戦略的な思考"': '"戦略的な思考で計画する"',
      '"創造的な発想"': '"創造的な発想を生み出す"',
      '"革新的な提案"': '"革新的な提案を行う"',
      '"建設的な意見"': '"建設的な意見を述べる"',
      '"前向きな姿勢"': '"前向きな姿勢を保つ"',
      '"積極的な行動"': '"積極的な行動を取る"',
      '"柔軟な対応"': '"柔軟な対応を心がける"',
      '"慎重な判断"': '"慎重な判断を下す"',
      '"冷静な分析"': '"冷静な分析を行う"',
      '"的確な判断"': '"的確な判断を下す"',
      '"適切な選択"': '"適切な選択をする"',
      '"賢明な決断"': '"賢明な決断を下す"',
      '"効果的な方法"': '"効果的な方法を選ぶ"',
      '"効率的な進め方"': '"効率的な進め方をする"',
      '"計画的な実行"': '"計画的な実行を行う"',
      '"段階的な成長"': '"段階的な成長を遂げる"',
      '"継続的な努力"': '"継続的な努力を続ける"',
      '"持続的な発展"': '"持続的な発展を目指す"',
      '"安定的な成長"': '"安定的な成長を続ける"',
      '"着実な前進"': '"着実な前進を続ける"',
      '"確実な成果"': '"確実な成果を上げる"',
      '"明確な目標"': '"明確な目標を設定する"',
      '"具体的な計画"': '"具体的な計画を立てる"',
      '"現実的な提案"': '"現実的な提案を行う"',
      '"実用的な解決"': '"実用的な解決を図る"',
      '"合理的な判断"': '"合理的な判断を下す"',
      '"論理的な説明"': '"論理的な説明を行う"',
      '"客観的な視点"': '"客観的な視点を保つ"',
      '"公平な立場"': '"公平な立場を維持する"',
      '"中立的な態度"': '"中立的な態度を取る"',
      '"バランスの取れた"': '"バランスの取れた対応をする"',
      '"調和的な解決"': '"調和的な解決を図る"',
      '"平和的な方法"': '"平和的な方法を選ぶ"',
      '"協調的な姿勢"': '"協調的な姿勢を示す"',
      '"協力的な態度"': '"協力的な態度を取る"',
      '"支援的な関わり"': '"支援的な関わりを持つ"',
      '"援助的な行動"': '"援助的な行動を取る"',
      '"共感的な理解"': '"共感的な理解を示す"',
      '"思いやりのある"': '"思いやりのある対応をする"',
      '"優しい関わり"': '"優しい関わりを持つ"',
      '"温かい支援"': '"温かい支援を提供する"',
      '"親切な対応"': '"親切な対応を心がける"',
      '"丁寧な説明"': '"丁寧な説明を行う"',
      '"慎重な配慮"': '"慎重な配慮をする"',
      '"細やかな気配り"': '"細やかな気配りを示す"',
      '"繊細な感性"': '"繊細な感性を大切にする"',
      '"鋭い洞察"': '"鋭い洞察を発揮する"',
      '"深い理解"': '"深い理解を示す"',
      '"広い視野"': '"広い視野を持つ"',
      '"高い志"': '"高い志を持って進む"',
      '"強い意志"': '"強い意志を持って行動"',
      '"固い決意"': '"固い決意を持って臨む"',
      '"熱い情熱"': '"熱い情熱を持って取り組む"',
      '"純粋な動機"': '"純粋な動機から行動する"',
      '"誠実な態度"': '"誠実な態度で接する"',
      '"真摯な姿勢"': '"真摯な姿勢で取り組む"',
      '"謙虚な態度"': '"謙虚な態度を保つ"',
      '"素直な心"': '"素直な心で受け入れる"',
      '"開かれた心"': '"開かれた心で接する"',
      '"寛容な精神"': '"寛容な精神を持つ"',
      '"包容力のある"': '"包容力のある対応をする"'
    };
    
    // バックアップ作成
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    await writeFile(`./public/js/data/hexagram-human-traits-v3.backup.phase21.${timestamp}.js`, content);
    console.log(`📁 バックアップ作成: hexagram-human-traits-v3.backup.phase21.${timestamp}.js\n`);
    
    // 修正適用
    let totalFixCount = 0;
    let successfulFixes = [];
    
    console.log('8文字の修正を適用中...\n');
    
    Object.entries(eightCharFixes).forEach(([old, newText]) => {
      const regex = new RegExp(old.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      const matches = content.match(regex);
      if (matches) {
        content = content.replace(regex, newText);
        totalFixCount += matches.length;
        successfulFixes.push(`${old} → ${newText} (${matches.length}箇所)`);
      }
    });
    
    // 成功した修正を表示
    console.log('【修正成功項目】');
    if (successfulFixes.length > 0) {
      successfulFixes.slice(0, 30).forEach(fix => {
        console.log(`✅ ${fix}`);
      });
      if (successfulFixes.length > 30) {
        console.log(`... 他 ${successfulFixes.length - 30}件`);
      }
    } else {
      console.log('修正対象が見つかりませんでした。');
    }
    
    // ファイル保存
    await writeFile('./public/js/data/hexagram-human-traits-v3.js', content);
    
    console.log(`\n=== フェーズ21完了 ===`);
    console.log(`総修正件数: ${totalFixCount}件`);
    console.log(`修正成功項目: ${successfulFixes.length}種類`);
    console.log(`\n次のフェーズ: node fix-short-descriptions-phase22-remaining-nine.mjs`);
    
  } catch (error) {
    console.error('エラー:', error);
  }
}

fixPhase21RemainingEight();