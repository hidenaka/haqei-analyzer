<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¶æ•°ç•ªè¨­å•è¡¨ç¤ºå•é¡Œ å®Œå…¨è§£æ±ºãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Helvetica Neue', sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #1e1b4b 0%, #312e81 25%, #4c1d95 50%, #5b21b6 75%, #6d28d9 100%);
            color: #f1f5f9;
            min-height: 100vh;
            margin: 0;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(15, 23, 42, 0.9);
            padding: 30px;
            border-radius: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }
        h1 {
            text-align: center;
            color: #6366f1;
            font-size: 2.5rem;
            margin-bottom: 30px;
            text-shadow: 0 2px 10px rgba(99, 102, 241, 0.5);
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 16px;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        .test-result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
        }
        .success {
            background: rgba(16, 185, 129, 0.2);
            border: 1px solid rgba(16, 185, 129, 0.5);
            color: #10b981;
        }
        .error {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.5);
            color: #ef4444;
        }
        .warning {
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.5);
            color: #f59e0b;
        }
        .info {
            background: rgba(59, 130, 246, 0.2);
            border: 1px solid rgba(59, 130, 246, 0.5);
            color: #3b82f6;
        }
        button {
            margin: 10px 5px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        }
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(99, 102, 241, 0.4);
        }
        button:disabled {
            background: rgba(100, 116, 139, 0.5);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .test-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .stat-card {
            padding: 20px;
            background: rgba(51, 65, 85, 0.6);
            border-radius: 12px;
            text-align: center;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #6366f1;
            border-radius: 12px;
            background: white;
        }
        #log {
            max-height: 400px;
            overflow-y: auto;
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .question-indicator {
            padding: 10px;
            text-align: center;
            border-radius: 6px;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        .question-indicator.odd {
            background: rgba(139, 92, 246, 0.2);
            border: 1px solid rgba(139, 92, 246, 0.5);
            color: #a78bfa;
        }
        .question-indicator.even {
            background: rgba(99, 102, 241, 0.2);
            border: 1px solid rgba(99, 102, 241, 0.5);
            color: #6366f1;
        }
        .question-indicator.tested {
            background: rgba(16, 185, 129, 0.3);
            border-color: #10b981;
            color: #10b981;
        }
        .question-indicator.failed {
            background: rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
            color: #ef4444;
        }
        .progress-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 50%, #a78bfa 100%);
            transition: width 0.5s ease;
            width: 0%;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ¯ å¶æ•°ç•ªè¨­å•è¡¨ç¤ºå•é¡Œ å®Œå…¨è§£æ±ºãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h3>ğŸš¨ å•é¡Œæ¦‚è¦</h3>
            <div class="info test-result">
                <strong>ç—‡çŠ¶:</strong> q2, q4, q6, q8...q30ãªã©ã®å¶æ•°ç•ªè¨­å•ãŒè¡¨ç¤ºã•ã‚Œãªã„<br>
                <strong>ä¿®æ­£æ¸ˆã¿:</strong> 2025-08-02 VirtualQuestionFlow.js showCurrentQuestion()ãƒ¡ã‚½ãƒƒãƒ‰å®Œå…¨æ”¹ä¿®<br>
                <strong>ãƒ†ã‚¹ãƒˆç›®çš„:</strong> ä¿®æ­£ãŒå®Œå…¨ã«æ©Ÿèƒ½ã—ã€å¶æ•°ç•ªè¨­å•ãŒç¢ºå®Ÿã«è¡¨ç¤ºã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ“Š ãƒ†ã‚¹ãƒˆçµ±è¨ˆ</h3>
            <div class="test-stats">
                <div class="stat-card">
                    <div class="stat-number" id="total-questions">30</div>
                    <div class="stat-label">ç·è¨­å•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="even-questions">15</div>
                    <div class="stat-label">å¶æ•°ç•ªè¨­å•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="tested-count">0</div>
                    <div class="stat-label">ãƒ†ã‚¹ãƒˆæ¸ˆã¿</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="success-rate">0%</div>
                    <div class="stat-label">æˆåŠŸç‡</div>
                </div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill"></div>
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸ® ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h3>
            <button onclick="runCompleteTest()" id="run-test-btn">ğŸš€ å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <button onclick="testSpecificQuestions()" id="test-even-btn">ğŸ¯ å¶æ•°ç•ªè¨­å•ã®ã¿ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="testProblemQuestions()" id="test-problem-btn">âš ï¸ å•é¡Œç™ºç”Ÿå‚¾å‘è¨­å•ãƒ†ã‚¹ãƒˆ</button>
            <button onclick="clearResults()">ğŸ§¹ çµæœã‚¯ãƒªã‚¢</button>
        </div>

        <div class="test-section">
            <h3>ğŸ“‹ è¨­å•è¡¨ç¤ºçŠ¶æ³</h3>
            <div class="test-grid" id="question-grid">
                <!-- å‹•çš„ã«ç”Ÿæˆ -->
            </div>
        </div>

        <div class="test-section">
            <h3>ğŸƒâ€â™‚ï¸ OS Analyzerå®Ÿè¡Œç’°å¢ƒ</h3>
            <iframe src="os_analyzer.html" id="analyzer-frame"></iframe>
        </div>

        <div class="test-section">
            <h3>ğŸ“ ãƒ†ã‚¹ãƒˆçµæœ</h3>
            <div id="results-container"></div>
            <div id="log"></div>
        </div>
    </div>

    <script>
        let testResults = [];
        let frameApp = null;
        let totalQuestions = 30;
        let testedCount = 0;

        // ãƒ­ã‚°å‡ºåŠ›
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEl = document.getElementById('log');
            const resultEl = document.createElement('div');
            resultEl.className = `test-result ${type}`;
            resultEl.textContent = `[${timestamp}] ${message}`;
            
            const resultsContainer = document.getElementById('results-container');
            resultsContainer.appendChild(resultEl);
            
            logEl.innerHTML += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
            
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // çµ±è¨ˆæ›´æ–°
        function updateStats() {
            const successCount = testResults.filter(r => r.success).length;
            const successRate = testedCount > 0 ? Math.round((successCount / testedCount) * 100) : 0;
            
            document.getElementById('tested-count').textContent = testedCount;
            document.getElementById('success-rate').textContent = `${successRate}%`;
            document.getElementById('progress-fill').style.width = `${(testedCount / totalQuestions) * 100}%`;
        }

        // è¨­å•ã‚°ãƒªãƒƒãƒ‰åˆæœŸåŒ–
        function initializeQuestionGrid() {
            const grid = document.getElementById('question-grid');
            grid.innerHTML = '';
            
            for (let i = 1; i <= 30; i++) {
                const indicator = document.createElement('div');
                indicator.className = `question-indicator ${i % 2 === 0 ? 'even' : 'odd'}`;
                indicator.textContent = `Q${i}`;
                indicator.id = `q${i}-indicator`;
                indicator.title = `è¨­å•${i} (${i % 2 === 0 ? 'å¶æ•°' : 'å¥‡æ•°'}ç•ª)`;
                grid.appendChild(indicator);
            }
        }

        // è¨­å•è¡¨ç¤ºçŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        async function checkQuestionDisplay(questionIndex) {
            if (!frameApp || !frameApp.questionFlow) {
                throw new Error('OS Analyzer not initialized');
            }

            const originalIndex = frameApp.questionFlow.currentQuestionIndex;
            const questionNum = questionIndex + 1;
            const isEven = questionNum % 2 === 0;
            
            log(`ğŸ” è¨­å•${questionNum}(${isEven ? 'å¶æ•°' : 'å¥‡æ•°'}ç•ª)ã®è¡¨ç¤ºãƒ†ã‚¹ãƒˆé–‹å§‹`, 'info');
            
            try {
                // è¨­å•ã«ç§»å‹•
                frameApp.questionFlow.currentQuestionIndex = questionIndex;
                frameApp.questionFlow.updateVisibleRange();
                
                // è¡¨ç¤ºå®Œäº†ã‚’å¾…ã¤
                await new Promise(resolve => setTimeout(resolve, 200));
                
                // è¡¨ç¤ºçŠ¶æ…‹ã‚’ç¢ºèª
                const element = frameApp.questionFlow.activeElements.get(questionIndex);
                if (!element) {
                    throw new Error(`è¨­å•è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (index: ${questionIndex})`);
                }

                const computedStyle = window.getComputedStyle(element);
                const rect = element.getBoundingClientRect();
                
                const isVisible = computedStyle.display !== 'none' && 
                                 computedStyle.visibility !== 'hidden' && 
                                 rect.height > 0 && 
                                 rect.width > 0;

                const result = {
                    questionId: `q${questionNum}`,
                    questionIndex: questionIndex,
                    isEven: isEven,
                    success: isVisible,
                    displayStyle: computedStyle.display,
                    visibility: computedStyle.visibility,
                    opacity: computedStyle.opacity,
                    width: rect.width,
                    height: rect.height,
                    timestamp: new Date().toISOString()
                };

                testResults.push(result);
                testedCount++;

                // UIæ›´æ–°
                const indicator = document.getElementById(`q${questionNum}-indicator`);
                if (indicator) {
                    indicator.className = `question-indicator ${isEven ? 'even' : 'odd'} ${isVisible ? 'tested' : 'failed'}`;
                    indicator.textContent = `Q${questionNum}${isVisible ? 'âœ“' : 'âœ—'}`;
                }

                if (isVisible) {
                    log(`âœ… Q${questionNum} è¡¨ç¤ºæˆåŠŸ - ${isEven ? 'å¶æ•°ç•ªè¨­å•' : 'å¥‡æ•°ç•ªè¨­å•'}`, 'success');
                } else {
                    log(`âŒ Q${questionNum} è¡¨ç¤ºå¤±æ•— - ${isEven ? 'å¶æ•°ç•ªè¨­å•' : 'å¥‡æ•°ç•ªè¨­å•'} (display: ${computedStyle.display}, height: ${rect.height})`, 'error');
                }

                updateStats();
                return result;

            } catch (error) {
                const result = {
                    questionId: `q${questionNum}`,
                    questionIndex: questionIndex,
                    isEven: isEven,
                    success: false,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };

                testResults.push(result);
                testedCount++;

                const indicator = document.getElementById(`q${questionNum}-indicator`);
                if (indicator) {
                    indicator.className = `question-indicator ${isEven ? 'even' : 'odd'} failed`;
                    indicator.textContent = `Q${questionNum}âœ—`;
                }

                log(`âŒ Q${questionNum} ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                updateStats();
                return result;

            } finally {
                // å…ƒã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã«æˆ»ã™
                frameApp.questionFlow.currentQuestionIndex = originalIndex;
                frameApp.questionFlow.updateVisibleRange();
            }
        }

        // å®Œå…¨ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        async function runCompleteTest() {
            if (!frameApp) {
                log('âŒ OS AnalyzerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            log('ğŸš€ å…¨è¨­å•è¡¨ç¤ºãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            const startTime = performance.now();
            
            // ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
            document.getElementById('run-test-btn').disabled = true;
            
            try {
                for (let i = 0; i < totalQuestions; i++) {
                    await checkQuestionDisplay(i);
                    
                    // é€²è¡ŒçŠ¶æ³è¡¨ç¤º
                    if ((i + 1) % 5 === 0 || i === totalQuestions - 1) {
                        log(`ğŸ“Š é€²è¡ŒçŠ¶æ³: ${i + 1}/${totalQuestions} å®Œäº†`, 'info');
                    }
                }

                const endTime = performance.now();
                const duration = Math.round(endTime - startTime);
                
                // çµæœã‚µãƒãƒªãƒ¼
                const evenResults = testResults.filter(r => r.isEven);
                const oddResults = testResults.filter(r => !r.isEven);
                const evenSuccess = evenResults.filter(r => r.success).length;
                const oddSuccess = oddResults.filter(r => r.success).length;
                const failedQuestions = testResults.filter(r => !r.success);

                log(`\nğŸ === ãƒ†ã‚¹ãƒˆå®Œäº† (${duration}ms) ===`, 'info');
                log(`ç·è¨­å•æ•°: ${totalQuestions}`, 'info');
                log(`å¶æ•°ç•ªè¨­å•: ${evenSuccess}/${evenResults.length} æˆåŠŸ`, evenSuccess === evenResults.length ? 'success' : 'error');
                log(`å¥‡æ•°ç•ªè¨­å•: ${oddSuccess}/${oddResults.length} æˆåŠŸ`, oddSuccess === oddResults.length ? 'success' : 'error');
                
                if (failedQuestions.length > 0) {
                    log(`âŒ å¤±æ•—ã—ãŸè¨­å•: ${failedQuestions.map(r => r.questionId).join(', ')}`, 'error');
                    log(`âš ï¸ å¶æ•°ç•ªè¨­å•è¡¨ç¤ºå•é¡ŒãŒå†ç™ºã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™`, 'warning');
                } else {
                    log(`âœ… å…¨è¨­å•ã®è¡¨ç¤ºãƒ†ã‚¹ãƒˆæˆåŠŸï¼å¶æ•°ç•ªè¨­å•ã‚‚æ­£å¸¸ã«è¡¨ç¤ºã•ã‚Œã¦ã„ã¾ã™`, 'success');
                }

            } catch (error) {
                log(`âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                document.getElementById('run-test-btn').disabled = false;
            }
        }

        // å¶æ•°ç•ªè¨­å•ã®ã¿ãƒ†ã‚¹ãƒˆ
        async function testSpecificQuestions() {
            if (!frameApp) {
                log('âŒ OS AnalyzerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            log('ğŸ¯ å¶æ•°ç•ªè¨­å•ã®ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
            document.getElementById('test-even-btn').disabled = true;

            try {
                const evenQuestions = [];
                for (let i = 1; i < totalQuestions; i += 2) { // 1, 3, 5... => 2, 4, 6...
                    evenQuestions.push(i);
                }

                for (const index of evenQuestions) {
                    await checkQuestionDisplay(index);
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                const evenResults = testResults.filter(r => r.isEven);
                const successCount = evenResults.filter(r => r.success).length;
                
                log(`ğŸ¯ å¶æ•°ç•ªè¨­å•ãƒ†ã‚¹ãƒˆå®Œäº†: ${successCount}/${evenResults.length} æˆåŠŸ`, 
                    successCount === evenResults.length ? 'success' : 'error');

            } catch (error) {
                log(`âŒ å¶æ•°ç•ªè¨­å•ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                document.getElementById('test-even-btn').disabled = false;
            }
        }

        // å•é¡Œç™ºç”Ÿå‚¾å‘è¨­å•ãƒ†ã‚¹ãƒˆï¼ˆq2, q4, q6, q30ãªã©ï¼‰
        async function testProblemQuestions() {
            if (!frameApp) {
                log('âŒ OS AnalyzerãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
                return;
            }

            log('âš ï¸ å•é¡Œç™ºç”Ÿå‚¾å‘è¨­å•ãƒ†ã‚¹ãƒˆé–‹å§‹', 'warning');
            document.getElementById('test-problem-btn').disabled = true;

            try {
                // éå»ã«å•é¡ŒãŒå ±å‘Šã•ã‚ŒãŸè¨­å•
                const problemQuestions = [1, 3, 5, 9, 11, 13, 19, 21, 23, 29]; // q2, q4, q6, q10, q12, q14, q20, q22, q24, q30
                
                for (const index of problemQuestions) {
                    await checkQuestionDisplay(index);
                    await new Promise(resolve => setTimeout(resolve, 150));
                }

                const problemResults = testResults.filter(r => problemQuestions.includes(r.questionIndex));
                const successCount = problemResults.filter(r => r.success).length;
                
                log(`âš ï¸ å•é¡Œç™ºç”Ÿå‚¾å‘è¨­å•ãƒ†ã‚¹ãƒˆå®Œäº†: ${successCount}/${problemResults.length} æˆåŠŸ`, 
                    successCount === problemResults.length ? 'success' : 'warning');

            } catch (error) {
                log(`âŒ å•é¡Œç™ºç”Ÿå‚¾å‘è¨­å•ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            } finally {
                document.getElementById('test-problem-btn').disabled = false;
            }
        }

        // çµæœã‚¯ãƒªã‚¢
        function clearResults() {
            testResults = [];
            testedCount = 0;
            document.getElementById('results-container').innerHTML = '';
            document.getElementById('log').innerHTML = '';
            initializeQuestionGrid();
            updateStats();
            log('ğŸ§¹ ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'info');
        }

        // ãƒ•ãƒ¬ãƒ¼ãƒ åˆæœŸåŒ–
        function initializeFrame() {
            const frame = document.getElementById('analyzer-frame');
            
            frame.onload = () => {
                setTimeout(() => {
                    try {
                        const frameWindow = frame.contentWindow;
                        
                        if (frameWindow.app && frameWindow.app.questionFlow) {
                            frameApp = frameWindow.app;
                            totalQuestions = frameApp.questionFlow.questions.length;
                            
                            document.getElementById('total-questions').textContent = totalQuestions;
                            document.getElementById('even-questions').textContent = Math.floor(totalQuestions / 2);
                            
                            log(`âœ… OS AnalyzeråˆæœŸåŒ–å®Œäº† (${totalQuestions}å•)`, 'success');
                            log('ğŸ® ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'info');
                            
                            // ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–
                            document.getElementById('run-test-btn').disabled = false;
                            document.getElementById('test-even-btn').disabled = false;
                            document.getElementById('test-problem-btn').disabled = false;

                        } else {
                            log('âŒ OS Analyzerã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
                        }
                    } catch (error) {
                        log(`âŒ ãƒ•ãƒ¬ãƒ¼ãƒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    }
                }, 3000);
            };
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initializeQuestionGrid();
            updateStats();
            
            // åˆæœŸçŠ¶æ…‹ã§ãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–
            document.getElementById('run-test-btn').disabled = true;
            document.getElementById('test-even-btn').disabled = true;
            document.getElementById('test-problem-btn').disabled = true;
            
            log('ğŸ¯ å¶æ•°ç•ªè¨­å•è¡¨ç¤ºå•é¡Œ å®Œå…¨è§£æ±ºãƒ†ã‚¹ãƒˆæº–å‚™å®Œäº†', 'info');
            log('ğŸ“± OS Analyzerèª­ã¿è¾¼ã¿ä¸­...', 'info');
            
            initializeFrame();
        });
    </script>
</body>
</html>