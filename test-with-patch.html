<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>🚨 Test with Emergency Patch</title>
</head>
<body>
    <h1>🚨 HAQEI with Emergency Patch</h1>
    
    <div style="background: #fee; padding: 1rem; border: 2px solid #f66; border-radius: 0.5rem; margin: 1rem 0;">
        <strong>🚨 Emergency Patch Status</strong>
        <div id="patch-status">Loading...</div>
    </div>
    
    <!-- Load the original os_analyzer.html in iframe -->
    <iframe id="main-app" src="http://localhost:8788/os_analyzer.html" width="100%" height="600" style="border: 1px solid #ccc;"></iframe>
    
    <div style="margin: 1rem 0;">
        <button onclick="testEmergencyPatch()" style="padding: 1rem 2rem; background: #dc2626; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
            🚨 Test Emergency Patch
        </button>
        <button onclick="testOriginal()" style="padding: 1rem 2rem; background: #2563eb; color: white; border: none; border-radius: 0.5rem; cursor: pointer; margin-left: 1rem;">
            🧪 Test Original Button
        </button>
    </div>
    
    <div id="test-results" style="background: #f8f9fa; padding: 1rem; border-radius: 0.5rem; margin: 1rem 0;">
        <h3>Test Results:</h3>
        <div id="results-content">No tests run yet</div>
    </div>
    
    <script>
        let testResults = [];
        
        function addResult(message, isSuccess = true) {
            const timestamp = new Date().toLocaleTimeString();
            testResults.push(`<p style="color: ${isSuccess ? 'green' : 'red'};">${isSuccess ? '✅' : '❌'} [${timestamp}] ${message}</p>`);
            document.getElementById('results-content').innerHTML = testResults.join('');
        }
        
        function testEmergencyPatch() {
            addResult('Testing emergency patch...', true);
            
            const iframe = document.getElementById('main-app');
            const iframeWindow = iframe.contentWindow;
            
            // Inject the emergency patch
            const script = iframe.contentDocument.createElement('script');
            script.src = 'http://localhost:8788/emergency-patch.js';
            script.onload = function() {
                addResult('Emergency patch script loaded', true);
                
                // Wait a moment then test
                setTimeout(() => {
                    const startBtn = iframe.contentDocument.getElementById('start-btn');
                    if (startBtn) {
                        addResult('Start button found, attempting click', true);
                        startBtn.click();
                        
                        // Check if question screen becomes active
                        setTimeout(() => {
                            const questionScreen = iframe.contentDocument.getElementById('question-screen');
                            const isActive = questionScreen && questionScreen.classList.contains('active');
                            
                            if (isActive) {
                                addResult('SUCCESS: Question screen is now active!', true);
                            } else {
                                addResult('FAILED: Question screen is not active', false);
                            }
                        }, 1000);
                    } else {
                        addResult('ERROR: Start button not found', false);
                    }
                }, 2000);
            };
            script.onerror = function() {
                addResult('ERROR: Failed to load emergency patch script', false);
            };
            iframe.contentDocument.head.appendChild(script);
        }
        
        function testOriginal() {
            addResult('Testing original functionality...', true);
            
            const iframe = document.getElementById('main-app');
            const startBtn = iframe.contentDocument.getElementById('start-btn');
            
            if (startBtn) {
                addResult('Original start button found, clicking', true);
                startBtn.click();
                
                setTimeout(() => {
                    const questionScreen = iframe.contentDocument.getElementById('question-screen');
                    const isActive = questionScreen && questionScreen.classList.contains('active');
                    
                    if (isActive) {
                        addResult('Original functionality works!', true);
                    } else {
                        addResult('Original functionality not working', false);
                    }
                }, 1000);
            } else {
                addResult('ERROR: Original start button not found', false);
            }
        }
        
        // Monitor patch status
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('patch-status').innerHTML = 'Ready to test emergency patch';
                addResult('Test environment loaded and ready', true);
            }, 2000);
        });
    </script>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }
    </style>
</body>
</html>