# HAQEIアナライザー質問表示システム要件定義書

**バージョン**: 1.0  
**作成日**: 2025-08-05  
**作成者**: Requirements Analyst (HAQEI Project)  

---

## 1. エグゼクティブサマリー

### 1.1 プロジェクト概要
HAQEIアナライザーは、古代の叡智（I Ching/易経）と現代のテクノロジーを融合した自己洞察システムです。本文書は、30問の質問表示システムに関する包括的な要件定義を行い、現在発生している表示問題の根本的解決策を提示します。

### 1.2 現在の問題状況
- **表示問題**: 30問の質問が正しく表示されない（CSSコードが表示される）
- **サイズ問題**: haqei-question要素のサイズが0になる
- **UI問題**: ラジオボタンとラベルが見えない
- **競合問題**: モーダルダイアログが表示を妨げる
- **偶数番設問問題**: 特に偶数番設問（q2, q4, q6...q30）の表示が不安定

### 1.3 目標
HaQei哲学に基づいた、完璧に動作する30問質問表示システムの実現

---

## 2. システム分析

### 2.1 現在のアーキテクチャ分析

#### 2.1.1 既存コンポーネント構成
```
os_analyzer.html (メイン画面)
├── VirtualQuestionFlow.js (仮想スクロール管理)
├── HaqeiQuestionElement.js (Web Component)
├── 質問データ (questions.js)
├── CSSスタイルシート群
│   ├── virtual-question-emergency-fix.css
│   ├── question-display-fix.css
│   └── その他27のCSSファイル
└── エラーハンドリングシステム
```

#### 2.1.2 問題の根本原因
1. **CSS競合問題**: 29個のCSSファイル間での優先度競合
2. **Web Component初期化問題**: Shadow DOM作成タイミングの不整合
3. **仮想スクロール表示制御の複雑性**: 表示/非表示の競合状態
4. **エラーハンドリングの不完全性**: MutationObserverとタイムアウト処理の組み合わせ問題

---

## 3. 機能要件 (Functional Requirements)

### 3.1 基本機能要件

#### FR-001: 質問表示機能
- **要件**: 30問の質問を順次表示する
- **詳細**: 
  - 価値観設問24問（q1-q24）: エンジンOS特定用
  - シナリオ設問6問（q25-q30）: 内面/外面の二択選択
  - 各質問は完全に表示される前に次の質問へ遷移してはならない
- **優先度**: 必須 (Must Have)

#### FR-002: 回答選択機能
- **要件**: 各質問のラジオボタン選択機能
- **詳細**:
  - 価値観設問: 単一選択（A-E）
  - シナリオ設問: 内面選択 + 外面選択の双方必須
  - 選択状態の視覚的フィードバック
  - 未選択状態での次の質問への遷移禁止
- **優先度**: 必須 (Must Have)

#### FR-003: 質問間遷移機能
- **要件**: 前の質問/次の質問への遷移
- **詳細**:
  - 「前の質問」ボタン: 1つ前の質問に戻る
  - 「次の質問」ボタン: 回答済みの場合のみ有効
  - 最後の質問では「分析開始」ボタンに変更
  - キーボードナビゲーション対応（←→キー）
  - タッチジェスチャー対応（スワイプ）
- **優先度**: 必須 (Must Have)

#### FR-004: 回答保存機能
- **要件**: 選択した回答をリアルタイムで保存
- **詳細**:
  - LocalStorageへの自動保存
  - デバウンス処理による性能最適化
  - ページリロード時の回答復元
  - 回答フォーマット統一（TripleOSEngine.js互換）
- **優先度**: 必須 (Must Have)

#### FR-005: 進捗表示機能
- **要件**: 現在の回答進捗を表示
- **詳細**:
  - 現在の質問番号表示（例: 5/30）
  - 完了済み質問数表示
  - プログレスバー（視覚的進捗）
  - 進捗率の計算とコールバック通知
- **優先度**: 必須 (Must Have)

#### FR-006: 結果遷移機能
- **要件**: 全質問完了後の分析画面遷移
- **詳細**:
  - 30問完了時の自動検知
  - MutationObserverによる最終質問表示確認
  - onCompleteコールバック実行
  - app.showAnalysis()への遷移処理
- **優先度**: 必須 (Must Have)

### 3.2 追加機能要件

#### FR-007: 質問カテゴリ表示
- **要件**: 質問の種類を明確に表示
- **詳細**:
  - 価値観設問: 💭アイコンと「価値観設問」ラベル
  - シナリオ設問: 🎭アイコンと「シナリオ設問」ラベル
  - 8次元のヒント表示（乾創造性、震行動性等）
- **優先度**: 推奨 (Should Have)

#### FR-008: 回答状況確認機能
- **要件**: 既回答質問の確認と修正
- **詳細**:
  - 以前に戻った際の回答状態復元
  - 回答変更時の自動保存
  - 回答完了質問の視覚的区別
- **優先度**: 推奨 (Should Have)

---

## 4. 非機能要件 (Non-Functional Requirements)

### 4.1 可視性要件

#### NFR-001: 完全表示保証
- **要件**: 全ての質問要素が確実に表示される
- **基準**: 
  - Web Component表示成功率: 100%
  - 偶数番設問の表示成功率: 100%
  - Shadow DOM内容の表示: 100%
- **検証方法**: 自動化されたE2Eテスト
- **優先度**: 必須 (Must Have)

#### NFR-002: CSS競合解決
- **要件**: 外部CSSとの競合を完全に回避
- **基準**:
  - Shadow DOM内部でのスタイル隔離
  - !important使用によるスタイル強制
  - z-index層の明確な管理
- **検証方法**: 複数ブラウザでの表示確認
- **優先度**: 必須 (Must Have)

#### NFR-003: レスポンシブ表示
- **要件**: 全デバイスでの最適表示
- **基準**:
  - デスクトップ: 1920x1080以上
  - タブレット: 768x1024以上
  - スマートフォン: 375x667以上
- **優先度**: 必須 (Must Have)

### 4.2 パフォーマンス要件

#### NFR-004: レンダリング性能
- **要件**: 高速な質問表示とナビゲーション
- **基準**:
  - 質問表示時間: 50ms以下
  - 質問間遷移時間: 100ms以下
  - メモリ使用量: 50MB以下
- **検証方法**: Performance APIによる測定
- **優先度**: 必須 (Must Have)

#### NFR-005: 仮想スクロール効率
- **要件**: 大量質問でのメモリ効率
- **基準**:
  - 同時レンダリング質問数: 3問以下
  - DOM要素プール効率: 90%以上
  - メモリリーク: 0
- **優先度**: 推奨 (Should Have)

### 4.3 ユーザビリティ要件

#### NFR-006: 操作性
- **要件**: 直感的で快適な操作感
- **基準**:
  - クリック反応時間: 16ms以下（60fps）
  - タッチ操作精度: 95%以上
  - キーボード操作対応: 完全
- **優先度**: 必須 (Must Have)

#### NFR-007: 視覚的フィードバック
- **要件**: 明確な状態表示
- **基準**:
  - 選択状態の視覚的区別: 明確
  - ホバー効果: 滑らか
  - トランジションアニメーション: 0.3秒以下
- **優先度**: 推奨 (Should Have)

### 4.4 アクセシビリティ要件

#### NFR-008: WCAG 2.1 AA準拠
- **要件**: 障がい者対応のアクセシビリティ
- **基準**:
  - キーボードナビゲーション: 完全対応
  - スクリーンリーダー対応: ARIA属性完備
  - コントラスト比: 4.5:1以上
- **優先度**: 推奨 (Should Have)

---

## 5. 技術要件 (Technical Requirements)

### 5.1 Web Components要件

#### TR-001: HaqeiQuestionElement仕様
- **技術**: Custom Elements API + Shadow DOM
- **要件**:
  - 完全なDOM隔離によるスタイル独立性
  - 接続/切断のライフサイクル管理
  - 属性変更の動的対応
  - イベント処理の適切な設定
- **実装**: `class HaqeiQuestionElement extends HTMLElement`

#### TR-002: Shadow DOM設計
- **要件**: 外部CSSとの完全隔離
- **仕様**:
  - mode: 'open'による開発時デバッグ対応
  - 内部スタイルの完全定義
  - :hostセレクターによる外部制御
  - CSS Custom Propertiesによる統一テーマ
- **優先度**: 必須 (Must Have)

### 5.2 仮想スクロール要件

#### TR-003: VirtualQuestionFlow仕様
- **技術**: 仮想化による性能最適化
- **要件**:
  - 可視範囲管理（current ± 1）
  - DOM要素プールによるメモリ最適化
  - MutationObserverによる表示確認
  - パフォーマンス指標の収集
- **実装**: Netflix品質の仮想スクロール

#### TR-004: 表示制御システム
- **要件**: 確実な要素表示制御
- **仕様**:
  - ensureElementVisible(): 多重保証表示
  - ensureElementHidden(): 完全非表示
  - verifyDisplayWithObserver(): リアルタイム監視
  - forceElementVisible(): 最終手段表示
- **優先度**: 必須 (Must Have)

### 5.3 モバイル対応要件

#### TR-005: タッチジェスチャー
- **技術**: TouchGestureHandler実装
- **要件**:
  - スワイプナビゲーション（左右）
  - タップ選択対応
  - マルチタッチ防止
  - 誤操作防止（最小移動距離50px）
- **優先度**: 推奨 (Should Have)

#### TR-006: レスポンシブ設計
- **要件**: 全デバイス対応
- **仕様**:
  - フレキシブルグリッドレイアウト
  - メディアクエリによる段階的調整
  - タッチターゲットサイズ44px以上
  - ビューポート最適化
- **優先度**: 必須 (Must Have)

### 5.4 ブラウザ互換性要件

#### TR-007: 対応ブラウザ
- **必須対応**:
  - Chrome 90+
  - Firefox 88+
  - Safari 14+
  - Edge 90+
- **推奨対応**:
  - Chrome 80+（Android）
  - Safari 13+（iOS）
- **非対応**: Internet Explorer

#### TR-008: ポリフィル要件
- **対象機能**:
  - Web Components（古いブラウザ）
  - CSS Custom Properties
  - IntersectionObserver
  - MutationObserver
- **実装**: 必要に応じて軽量ポリフィル使用

---

## 6. HaQei哲学統合要件

### 6.1 I Ching（易経）統合

#### BR-001: 8次元測定システム
- **哲学的背景**: 易経の8卦による人格分析
- **要件**:
  - 乾（創造性）: 天の力、リーダーシップ
  - 震（行動性）: 雷の力、実行力
  - 坎（探求性）: 水の力、深層理解
  - 艮（安定性）: 山の力、持続性
  - 坤（受容性）: 地の力、協調性
  - 巽（適応性）: 風の力、柔軟性
  - 離（表現性）: 火の力、発信力
  - 兌（調和性）: 沢の力、楽観性

#### BR-002: Triple OS Architecture統合
- **概念**: Engine OS（内面）× Interface OS（外面）× Safe Mode（安全装置）
- **要件**:
  - シナリオ設問での内面/外面の明確な分離
  - Safe Mode判定のための安全性指標
  - 3つのOSバランス分析
- **実装**: 回答データの適切な構造化

### 6.2 7-Stage Navigation System

#### BR-003: 質問フロー設計
- **哲学的根拠**: 成長段階に応じた質問配置
- **要件**:
  1. **Welcome（歓迎）**: システム理解
  2. **Foundation（基盤）**: 基礎価値観（q1-q8）
  3. **Development（発展）**: 応用価値観（q9-q16）
  4. **Challenge（挑戦）**: 困難対処（q17-q24）
  5. **Integration（統合）**: シナリオ統合（q25-q28）
  6. **Transcendence（超越）**: 最終統合（q29-q30）
  7. **Analysis（分析）**: 結果表示

#### BR-004: 質問カテゴリ統一
- **要件**: HaQei哲学に基づく質問分類
- **仕様**:
  - 各質問に8次元スコアリング
  - 爻（こう）レベルによる深度設定
  - 相生相克関係の考慮
  - complementary/conflicting関係の明示

---

## 7. 制約条件

### 7.1 技術制約

#### C-001: 既存システム互換性
- **制約**: VirtualQuestionFlowシステムとの完全互換性維持
- **影響**: 新しい表示システムは既存のAPIと同じインターフェースを提供
- **対策**: 既存のコールバック関数とイベント処理の維持

#### C-002: データ構造維持
- **制約**: 既存の回答データ構造（haqei_answers）の維持
- **影響**: LocalStorageフォーマットの変更不可
- **対策**: データ変換レイヤーでの対応

#### C-003: UI/UXデザイン継承
- **制約**: 現在のダークテーマとデザイン方針の維持
- **影響**: 色彩、フォント、レイアウトの大幅変更不可
- **対策**: CSS Variables使用による柔軟な調整

### 7.2 パフォーマンス制約

#### C-004: メモリ使用量
- **制約**: 50MB以下のメモリ使用量
- **影響**: 大量DOM要素の同時作成禁止
- **対策**: 仮想スクロールとDOMプール活用

#### C-005: 初期読み込み時間
- **制約**: 3秒以内の初期表示完了
- **影響**: 大量CSSファイルの読み込み最適化必要
- **対策**: CSS統合とクリティカルパス最適化

### 7.3 運用制約

#### C-006: 本番環境対応
- **制約**: Cloudflare Pages環境での動作保証
- **影響**: Node.js依存の機能使用不可
- **対策**: ブラウザネイティブAPIのみ使用

#### C-007: SEO要件
- **制約**: 検索エンジン対応の必要性
- **影響**: 初期HTML構造の提供必要
- **対策**: サーバーサイドレンダリングまたは静的生成

---

## 8. 実装計画

### 8.1 フェーズ1: 基盤修正（Week 1-2）
- CSS競合の根本解決
- Web Component安定化
- 基本表示機能の確実な動作

### 8.2 フェーズ2: 機能強化（Week 3-4）
- MutationObserver統合
- パフォーマンス最適化
- エラーハンドリング強化

### 8.3 フェーズ3: UX改善（Week 5-6）
- タッチジェスチャー実装
- アニメーション改善
- アクセシビリティ対応

### 8.4 フェーズ4: 統合テスト（Week 7-8）
- E2Eテスト実装
- パフォーマンステスト
- ブラウザ互換性確認

---

## 9. リスク分析

### 9.1 技術リスク

#### R-001: CSS競合の完全解決困難
- **確率**: 中
- **影響**: 高
- **対策**: Shadow DOM完全隔離 + CSS-in-JS移行検討

#### R-002: Web Component対応ブラウザ制限
- **確率**: 低
- **影響**: 中
- **対策**: ポリフィル導入

### 9.2 性能リスク

#### R-003: 仮想スクロール複雑化
- **確率**: 中
- **影響**: 中
- **対策**: 段階的実装とフォールバック機能

#### R-004: メモリリーク
- **確率**: 低
- **影響**: 高
- **対策**: 厳密なクリーンアップ処理

### 9.3 UXリスク

#### R-005: 既存ユーザーの混乱
- **確率**: 低
- **影響**: 中
- **対策**: A/Bテストと段階的ロールアウト

---

## 10. 検証・テスト要件

### 10.1 単体テスト
- Web Component単体での動作確認
- 仮想スクロール機能のユニットテスト
- I Ching統合ロジックの検証

### 10.2 統合テスト
- 全30問の表示完了テスト
- 回答保存・復元テスト
- 分析画面遷移テスト

### 10.3 E2Eテスト
- ユーザーシナリオテスト
- 複数ブラウザでの動作確認
- パフォーマンス計測

### 10.4 アクセシビリティテスト
- スクリーンリーダー対応確認
- キーボードナビゲーション確認
- WCAG 2.1 AA準拠確認

---

## 11. 成功基準

### 11.1 機能的成功基準
- [ ] 30問すべてが正常に表示される
- [ ] 偶数番設問の表示成功率100%
- [ ] 回答選択と保存が完璧に動作する
- [ ] 分析画面への遷移が確実に実行される

### 11.2 品質成功基準
- [ ] 質問表示時間50ms以下を達成
- [ ] メモリ使用量50MB以下を維持
- [ ] 全対応ブラウザで100%動作
- [ ] ユーザビリティテストで90%以上の満足度

### 11.3 哲学的成功基準
- [ ] HaQei哲学の完全実装
- [ ] I Ching 8次元の正確な測定
- [ ] Triple OS Architectureの適切な反映
- [ ] 7-Stage Navigation Systemの完全実現

---

## 12. 承認・レビュー

### 12.1 承認プロセス
1. Requirements Analyst（本文書作成者）による内部レビュー
2. CTO Agentによる技術妥当性レビュー
3. I Ching Expert Agentによる哲学的整合性レビュー
4. QA Testerによるテスト観点レビュー
5. 最終承認とImplementation Phase移行

### 12.2 変更管理
- 要件変更時は本文書の更新と承認プロセスの再実行
- Git履歴による変更追跡
- 影響範囲分析の実施

---

## 13. 付録

### 13.1 用語集
- **HaQei**: 分人哲学。状況に応じて異なる人格を使い分ける考え方
- **I Ching**: 易経。古代中国の占術・哲学体系
- **Triple OS**: Engine OS + Interface OS + Safe Mode の3層構造
- **7-Stage Navigation**: HAQEIシステムの7段階成長モデル
- **haqei-question**: 質問表示用のWeb Component
- **VirtualQuestionFlow**: 仮想スクロールによる質問管理システム

### 13.2 参考資料
- 易経入門（高田真治・後藤基巳訳）
- Web Components標準仕様
- WCAG 2.1 アクセシビリティガイドライン
- HaQei理論（平野啓一郎）

---

**文書終了**

このシステム要件定義書は、HAQEIアナライザーの質問表示システムを完璧に実装するための包括的な指針です。HaQei哲学とI Ching統合を軸として、技術的完成度と哲学的深度を両立させた要件を定義しました。

実装チームは本文書に基づき、段階的な開発を進めることで、ユーザーに深い自己洞察体験を提供する高品質なシステムを構築できます。