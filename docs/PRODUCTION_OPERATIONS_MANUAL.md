# HAQEIアナライザー本番運用マニュアル

## 概要

HAQEIアナライザーは、bunenjin哲学に基づく深い自己洞察体験を提供する企業レベルWebアプリケーションです。本マニュアルは、本番環境での運用・監視・トラブルシューティングに関する包括的な情報を提供します。

## 目次

1. [システム概要](#システム概要)
2. [運用体制](#運用体制)
3. [日常運用手順](#日常運用手順)
4. [監視・アラート](#監視アラート)
5. [トラブルシューティング](#トラブルシューティング)
6. [緊急時対応](#緊急時対応)
7. [メンテナンス](#メンテナンス)
8. [セキュリティ](#セキュリティ)
9. [バックアップ・復旧](#バックアップ復旧)
10. [容量計画](#容量計画)

## システム概要

### アーキテクチャ

- **フロントエンド**: Vue.js 3.x + TypeScript
- **ホスティング**: Cloudflare Pages
- **CDN**: Cloudflare CDN
- **監視**: カスタム監視システム + 外部サービス
- **セキュリティ**: Cloudflare Security + WAF

### 主要URL

- **本番環境**: https://haqei.com
- **ステージング**: https://staging.haqei.com
- **Blue環境**: https://blue.haqei.com
- **管理画面**: https://dash.cloudflare.com
- **監視ダッシュボード**: https://monitoring.haqei.com

### サービスレベル目標（SLO）

- **可用性**: 99.9%（月間43分以下のダウンタイム）
- **応答時間**: 3秒以下（95パーセンタイル）
- **エラー率**: 1%以下
- **セキュリティインシデント**: 0件

## 運用体制

### 役割と責任

#### 運用チーム（Operations Team）
- **責任**: 日常監視、アラート対応、定期メンテナンス
- **連絡先**: ops@haqei.com
- **稼働時間**: 24時間365日

#### 開発チーム（Development Team）
- **責任**: アプリケーション障害対応、機能改修
- **連絡先**: dev@haqei.com
- **稼働時間**: 平日9:00-18:00（緊急時24時間対応）

#### セキュリティチーム（Security Team）
- **責任**: セキュリティインシデント対応、脆弱性管理
- **連絡先**: security@haqei.com
- **稼働時間**: 24時間365日

### エスカレーション手順

1. **Level 1**: 運用チーム（初期対応）
2. **Level 2**: 開発チーム（技術的問題）
3. **Level 3**: CTO・アーキテクト（重大障害）
4. **Level 4**: 経営陣（事業影響大）

## 日常運用手順

### 朝の運用チェック（9:00）

1. **システム全体の健全性確認**
```bash
./scripts/health-check.sh
```

2. **前日のアラート・インシデント確認**
- 監視ダッシュボードをチェック
- アラート履歴の確認
- 未解決インシデントの確認

3. **パフォーマンス指標確認**
- 応答時間トレンド
- エラー率
- トラフィック量
- リソース使用率

4. **バックアップ状況確認**
- 自動バックアップの成功確認
- バックアップファイルの整合性チェック

### 夕方の運用チェック（18:00）

1. **日中のシステム状況まとめ**
2. **翌日のメンテナンス予定確認**
3. **週次・月次作業の準備確認**
4. **夜間監視体制の確認**

### 週次作業（月曜日）

1. **セキュリティ監査レポート確認**
```bash
npm run test:security
```

2. **依存関係の脆弱性チェック**
```bash
npm audit
```

3. **SSL証明書有効期限確認**
```bash
./scripts/health-check.sh --ssl-check
```

4. **ログローテーション・アーカイブ**

### 月次作業（第1営業日）

1. **容量計画レビュー**
2. **パフォーマンストレンド分析**
3. **セキュリティポリシー見直し**
4. **災害復旧テスト**

## 監視・アラート

### 監視項目

#### システム監視
- **HTTP応答**: ステータスコード、応答時間
- **DNS解決**: 名前解決の成功・失敗
- **SSL証明書**: 有効期限、暗号化強度
- **CDNステータス**: Cloudflareサービス状態

#### アプリケーション監視
- **JavaScript エラー**: フロントエンドエラー
- **ユーザー行動**: 分析完了率、離脱率
- **bunenjin準拠**: 哲学的正確性スコア
- **I Ching 正統性**: 六十四卦の精度

#### セキュリティ監視
- **不審なアクセス**: 異常なトラフィック
- **攻撃パターン**: DDoS、SQLi、XSS等
- **認証失敗**: ログイン試行の異常
- **データ流出**: 機密情報の漏洩検知

### アラート設定

#### Critical（重大）- 即座に対応
- サイトダウン（5xx エラー）
- セキュリティ攻撃検知
- データ破損・流出
- SSL証明書期限切れ

#### Warning（警告）- 1時間以内に対応
- 応答時間の悪化（5秒以上）
- エラー率の上昇（2%以上）
- リソース使用率の上昇（80%以上）
- 不审なアクセスパターン

#### Info（情報）- 翌営業日までに確認
- パフォーマンスの軽微な低下
- ユーザー行動の変化
- システム使用量の増加

### 通知チャンネル

- **Slack**: #haqei-alerts（リアルタイム通知）
- **Email**: ops@haqei.com（詳細情報）
- **SMS**: 緊急時のみ（Critical アラート）

## トラブルシューティング

### よくある問題と対処法

#### 1. サイトが表示されない

**症状**: HTTP 5xx エラー、DNS解決失敗

**確認手順**:
```bash
# 1. サイトの状態確認
curl -I https://haqei.com

# 2. DNS解決確認
nslookup haqei.com

# 3. CDN状態確認
curl -I -H "Host: haqei.com" https://cloudflare-edge-ip
```

**対処法**:
1. Cloudflareダッシュボードでサービス状態を確認
2. 必要に応じてCloudflare設定を確認
3. 問題が継続する場合はロールバック実行

#### 2. 応答時間の悪化

**症状**: ページ読み込みが遅い（5秒以上）

**確認手順**:
```bash
# パフォーマンステスト実行
lighthouse https://haqei.com --output=json

# リソース使用状況確認
./scripts/health-check.sh --performance
```

**対処法**:
1. CDNキャッシュのクリア
2. 画像・アセットの最適化確認
3. 必要に応じてトラフィック制限

#### 3. JavaScript エラー

**症状**: フロントエンド機能の動作不良

**確認手順**:
1. ブラウザの開発者ツールでエラー確認
2. ユーザーエージェント・ブラウザ固有の問題確認
3. アセットファイルの読み込み確認

**対処法**:
1. 問題のあるブラウザ・環境を特定
2. 必要に応じて修正版をデプロイ
3. 緊急時は該当機能を一時無効化

### 診断コマンド

```bash
# システム全体のヘルスチェック
./scripts/health-check.sh

# 特定URLのテスト
./scripts/health-check.sh --url https://haqei.com/specific-page

# パフォーマンス詳細分析
./scripts/health-check.sh --performance

# セキュリティスキャン
npm run test:security
```

## 緊急時対応

### インシデント対応手順

#### Phase 1: 初期対応（0-15分）

1. **インシデント確認**
   - アラートの詳細確認
   - 影響範囲の特定
   - 重要度の判定

2. **初期対応**
   ```bash
   # 緊急ヘルスチェック
   ./scripts/health-check.sh --emergency
   
   # 必要に応じて緊急ロールバック
   ./scripts/rollback-production.sh --emergency
   ```

3. **関係者への通知**
   - Slackでインシデント宣言
   - 必要に応じてエスカレーション

#### Phase 2: 問題分析（15-60分）

1. **根本原因の調査**
   - ログ分析
   - メトリクス確認
   - 外部サービス状態確認

2. **影響範囲の詳細把握**
   - 影響を受けるユーザー数
   - 機能への影響度
   - ビジネスインパクト

#### Phase 3: 問題解決（1-4時間）

1. **修正作業**
   - 修正版の開発・テスト
   - ステージング環境での検証
   - 本番デプロイ

2. **検証**
   ```bash
   # 修正後の動作確認
   ./scripts/health-check.sh --comprehensive
   ```

#### Phase 4: 事後処理（4時間-1週間）

1. **インシデントクローズ**
   - 解決確認
   - 関係者への完了通知

2. **ポストモーテム**
   - 根本原因分析
   - 再発防止策の策定
   - プロセス改善の実施

### ロールバック手順

#### 通常のロールバック
```bash
# 対話式ロールバック（推奨）
./scripts/rollback-production.sh

# 特定のデプロイメントIDへのロールバック
./scripts/rollback-production.sh --target <deployment-id>
```

#### 緊急ロールバック
```bash
# 前回のデプロイメントに自動復帰
./scripts/rollback-production.sh --emergency
```

### コミュニケーション

#### 内部コミュニケーション
- **Slack**: #haqei-incidents
- **定期更新**: 30分ごと
- **エスカレーション**: 重要度に応じて

#### 外部コミュニケーション
- **ステータスページ**: https://status.haqei.com
- **ユーザー通知**: 必要に応じてサイト内通知
- **メディア対応**: 重大インシデントのみ

## メンテナンス

### 定期メンテナンス

#### 日次メンテナンス（深夜2:00-4:00）
- ログのアーカイブ・圧縮
- キャッシュの最適化
- セキュリティスキャン

#### 週次メンテナンス（日曜深夜）
- システム全体のヘルスチェック
- 依存関係の更新確認
- バックアップの整合性確認

#### 月次メンテナンス（第1日曜深夜）
- セキュリティパッチの適用
- パフォーマンス最適化
- 容量計画の見直し

### 計画メンテナンス手順

#### 事前準備（1週間前）
1. **メンテナンス計画書作成**
2. **影響分析の実施**
3. **ロールバック手順の確認**
4. **関係者への事前通知**

#### メンテナンス実施
1. **メンテナンスモード開始**
   ```bash
   # メンテナンスページの表示
   export VITE_MAINTENANCE_MODE=true
   npm run deploy:staging
   ```

2. **作業実施**
3. **動作確認**
   ```bash
   ./scripts/health-check.sh --comprehensive
   ```

4. **メンテナンスモード終了**

#### 事後作業
1. **作業結果の確認**
2. **関係者への完了報告**
3. **メンテナンス報告書作成**

## セキュリティ

### セキュリティ監視

#### 監視項目
- **WAF ログ**: 攻撃パターンの検知
- **アクセスログ**: 異常なアクセスパターン
- **認証ログ**: ログイン失敗・成功
- **システムログ**: 権限昇格・不正アクセス

#### セキュリティメトリクス
- **攻撃検知数**: 日次・週次トレンド
- **脆弱性件数**: 定期スキャン結果
- **SSL評価**: SSL Labs スコア
- **セキュリティヘッダー**: 設定の妥当性

### インシデント対応

#### セキュリティインシデントの分類

**Level 1（低リスク）**
- 軽微な脆弱性の発見
- 不審なアクセスの検知
- 設定不備の発見

**Level 2（中リスク）**
- 中程度の脆弱性
- 標的型攻撃の兆候
- システムへの不正アクセス試行

**Level 3（高リスク）**
- 重大な脆弱性
- データ漏洩の可能性
- システムへの不正侵入

**Level 4（最高リスク）**
- データ漏洩の確認
- システムの完全な侵害
- 業務継続への重大な影響

#### 対応手順

1. **初期対応**（0-30分）
   - インシデントの確認・分類
   - 影響範囲の特定
   - 緊急時の隔離措置

2. **詳細調査**（30分-4時間）
   - フォレンジック調査
   - 攻撃手法の分析
   - 被害状況の詳細把握

3. **封じ込め**（4-24時間）
   - 脆弱性の修正
   - セキュリティ設定の強化
   - 監視の強化

4. **復旧・事後処理**（1-7日）
   - システムの完全復旧
   - 再発防止策の実装
   - 事後報告書の作成

### セキュリティチェックリスト

#### 日次チェック
- [ ] WAFログの確認
- [ ] 異常なアクセスパターンの確認
- [ ] SSL証明書の状態確認
- [ ] セキュリティアラートの確認

#### 週次チェック
- [ ] 脆弱性スキャンの実行
- [ ] セキュリティパッチの確認
- [ ] アクセス権限の監査
- [ ] バックアップの暗号化確認

#### 月次チェック
- [ ] ペネトレーションテストの実施
- [ ] セキュリティポリシーの見直し
- [ ] インシデント対応手順の更新
- [ ] セキュリティ研修の実施

## バックアップ・復旧

### バックアップ戦略

#### バックアップ対象
- **アプリケーションコード**: Git リポジトリ
- **設定ファイル**: 環境設定・サーバー設定
- **ユーザーデータ**: ローカルストレージ・セッション
- **ログファイル**: アクセスログ・エラーログ・監査ログ

#### バックアップスケジュール
- **リアルタイム**: Git コミット（コード）
- **日次**: ログファイル、設定ファイル
- **週次**: フルバックアップ
- **月次**: アーカイブバックアップ

#### バックアップ保存先
- **プライマリ**: Cloudflare KV Storage
- **セカンダリ**: AWS S3（地理的分散）
- **ターシャリ**: ローカルバックアップ（緊急時）

### 復旧手順

#### 軽微な障害（RTO: 1時間）
```bash
# 設定ファイルの復旧
git checkout production -- config/

# アプリケーションの再デプロイ
./scripts/deploy-production.sh
```

#### 中程度の障害（RTO: 4時間）
```bash
# 前回のデプロイメントにロールバック
./scripts/rollback-production.sh --emergency

# バックアップからの設定復旧
./scripts/restore-config.sh --date yesterday
```

#### 重大な障害（RTO: 8時間）
1. **インフラストラクチャの再構築**
2. **バックアップからの完全復旧**
3. **データ整合性の確認**
4. **段階的サービス復旧**

### 災害復旧（DR）

#### DR サイト
- **地理的分散**: 東京・大阪・海外
- **自動フェイルオーバー**: DNS ベース
- **データ同期**: リアルタイム

#### DR テスト
- **月次**: 部分的DR テスト
- **四半期**: 完全DR テスト
- **年次**: 災害シナリオ演習

## 容量計画

### 監視メトリクス

#### トラフィック指標
- **リクエスト数**: 日次・時間別
- **データ転送量**: 日次・月次
- **同時接続数**: ピック時
- **地理的分散**: 地域別アクセス

#### リソース指標
- **CDN使用量**: Cloudflare メトリクス
- **ストレージ使用量**: KV・R2 使用量
- **帯域幅**: 月次使用量
- **API 呼び出し数**: Workers 実行回数

### 成長予測

#### 短期予測（3ヶ月）
- 月間20%の成長を想定
- ピーク時の負荷対応
- 季節性要因の考慮

#### 中期予測（1年）
- 年間300%の成長を想定
- 新機能追加による負荷増
- 国際展開による地理的拡散

#### 長期予測（3年）
- 10倍の規模拡大を想定
- アーキテクチャの見直し
- コスト最適化の検討

### スケーリング戦略

#### 水平スケーリング
- **CDN の活用**: グローバル配信
- **負荷分散**: 地理的ルーティング
- **キャッシュ戦略**: 多層キャッシュ

#### 垂直スケーリング
- **Cloudflare プラン**: Enterprise への移行
- **Workers**: より多くのCPU時間
- **KV**: より大きなストレージ

## 付録

### 連絡先一覧

#### 社内チーム
- **運用チーム**: ops@haqei.com / +81-3-XXXX-XXXX
- **開発チーム**: dev@haqei.com / Slack: #dev-team
- **セキュリティチーム**: security@haqei.com / +81-90-XXXX-XXXX
- **CTO**: cto@haqei.com / +81-90-XXXX-XXXX

#### 外部サービス
- **Cloudflare サポート**: Enterprise プランサポート
- **セキュリティベンダー**: security-vendor@company.com
- **法的相談**: legal@lawfirm.com

### 重要なコマンド

```bash
# システム全体ヘルスチェック
./scripts/health-check.sh

# 緊急ロールバック
./scripts/rollback-production.sh --emergency

# 本番デプロイ
./scripts/deploy-production.sh

# セキュリティスキャン
npm run test:security

# パフォーマンステスト
npm run test:performance

# 包括的テスト
npm run test:integration
```

### 重要なURL

- **本番サイト**: https://haqei.com
- **ステータスページ**: https://status.haqei.com
- **監視ダッシュボード**: https://monitoring.haqei.com
- **Cloudflare ダッシュボード**: https://dash.cloudflare.com
- **GitHub リポジトリ**: https://github.com/haqei/haqei-analyzer

### 設定ファイル

- **本番環境設定**: `/config/production.config.js`
- **環境変数**: `/.env.production`
- **監視設定**: `/monitoring/production-monitoring.config.js`
- **Cloudflare設定**: `/wrangler.toml`

---

**文書バージョン**: 1.0.0  
**最終更新**: 2025年8月5日  
**次回見直し**: 2025年11月5日  
**承認者**: CTO  