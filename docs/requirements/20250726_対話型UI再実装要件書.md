# 20250726_対話型UI再実装要件書

**実装日時**: 2025年07月26日  
**担当**: Claude Code Assistant  
**対象**: HaQei Analyzer 対話型UI機能の完全再実装

## 背景と現状分析

### 問題点
- 既存の対話型UI実装（20250723_IMPLEMENTATION_LOG_INTERACTIVE_UI.md準拠）が正常動作していない
- 修正前のモーダルベース表示と同じ状態に戻っている
- 既存結果表示機能との競合が発生している

### 参照仕様
- ベース仕様: `requirements/archive/20250723_IMPLEMENTATION_LOG_INTERACTIVE_UI.md`
- 対象ファイル: `/public/new-analyzer/analyzer.html`

## 実装要件詳細

### 1. 既存機能削除対象

#### 1.1 削除すべき機能
- モーダルベースの結果表示システム
- 従来の静的RadarChart実装
- 非対話的なOS表示カード
- 静的な力学分析表示

#### 1.2 削除対象ファイル・メソッド
- `TripleOSResultsView.js` - 既存のrender()メソッド
- 静的CSS（対話機能のないスタイル）
- Chart.jsの従来実装

### 2. 対話型UI実装要件

#### 2.1 インタラクティブ・レーダーチャート
**必須機能**:
- 8次元の各頂点にホバーツールチップ機能
- 技術仕様: Chart.js v3.9.1 + カスタムツールチップコールバック
- データソース: 8次元ベクトルデータ

**実装技術詳細**:
```javascript
// ツールチップカスタマイズ実装例
tooltip: {
    callbacks: {
        label: function(context) {
            const label = context.label || '';
            const value = context.raw || 0;
            const description = dimensionDescriptions[label] || '';
            return `${label}: ${value.toFixed(1)} - ${description}`;
        }
    }
}
```

**Chart.jsインスタンス管理**:
```javascript
// エラー防止のためのインスタンス管理
if (this.radarChart) {
    this.radarChart.destroy();
    this.radarChart = null;
}
this.radarChart = new Chart(ctx, { ... });
```

#### 2.2 OSカードの深掘り機能
**必須機能**:
- クリック展開で「潜在的な強み」「成長の課題」表示
- UI仕様: アコーディオン式展開
- データソース: `HEXAGRAM_DETAILS`の`engine.potential_strengths/weaknesses`

**フォールバック対応**:
```javascript
// データ不足時の堅牢なフォールバック
getHexagramDetails(hexagramId) {
    // 複数ソースからデータ取得を試行
    // データ不足時は有意義なフォールバック情報を返却
    return {
        potential_strengths: ['創造性と行動力', 'リーダーシップ', '問題解決能力'],
        potential_weaknesses: ['完璧主義', 'ストレス管理', '他者との協調']
    };
}
```

#### 2.3 内なる力学の完全可視化
**必須機能**:
- 5つの評価項目を横棒グラフ付きで詳細表示
- UI仕様: アコーディオン式展開・Harmony/Tension色分け
- 実装対象: Interface OS、Safe Mode OSの詳細分析

**視覚表現要件**:
- プログレスバー + 数値 + 説明文
- カラーコーディング（調和=緑系、緊張=赤系）

#### 2.4 エラーハンドリング・堅牢性
**必須要件**:
- データ不足でもクラッシュしない設計
- 有意義な代替情報の提供
- Chart.jsインスタンス重複エラーの防止
- analysisResult等の多層防御

**実装例**:
```javascript
// 多層防御によるnullチェック
render() {
    if (!this.analysisResult) {
        this.container.innerHTML = '<div class="error">分析結果が見つかりません。</div>';
        return;
    }
    const { engineOS, interfaceOS, safeModeOS } = this.analysisResult;
    // さらに各OSオブジェクトの存在チェック
}
```

### 3. デザイン・UX要件

#### 3.1 デザインテーマ
- ダークテーマ + グラスモーフィズム効果
- フォント: Shippori Mincho日本語フォント
- アニメーション: 0.5s ease-out トランジション

#### 3.2 レスポンシブ対応
- 900px以下でレイアウト調整
- モバイルデバイス対応

#### 3.3 アクセシビリティ
- キーボードナビゲーション対応
- 適切なARIAラベル
- スクリーンリーダー対応

### 4. パフォーマンス要件

#### 4.1 非同期描画最適化
- Chart.js描画: 100ms遅延
- 力学データ読み込み: 200ms遅延
- CSS transitionの最適化

#### 4.2 メモリ管理
- Chart.jsインスタンスの適切な破棄
- イベントリスナーのクリーンアップ

## 実装手順

### Phase 1: 既存機能削除
1. `TripleOSResultsView.js`の既存render()メソッド削除
2. 静的CSS・非対話機能の削除
3. 従来Chart.js実装の削除

### Phase 2: 対話型UI実装
1. インタラクティブレーダーチャート実装
2. OSカード深掘り機能実装
3. 力学可視化機能実装

### Phase 3: エラーハンドリング・堅牢性強化
1. フォールバック機能実装
2. 多層防御システム実装
3. パフォーマンス最適化

### Phase 4: デザイン・UX調整
1. ダークテーマ + グラスモーフィズム適用
2. レスポンシブ対応
3. アクセシビリティ対応

## 成功基準

### 動作確認項目
1. ✅ レーダーチャート各頂点のホバーツールチップ表示
2. ✅ OSカードクリック展開で強み・課題詳細表示
3. ✅ 力学カードクリック展開で評価項目詳細表示
4. ✅ レスポンシブデザイン（900px以下でレイアウト調整）
5. ✅ エラー時の適切なフォールバック動作

### パフォーマンス基準
- 初期描画: 2秒以内
- チャート表示: 500ms以内
- アコーディオン展開: 300ms以内

## 技術制約・注意事項

### データ制約
- HEXAGRAM_DETAILSの一部データ不足（ID 16, 30等）
- フォールバック機能必須

### 技術制約
- Chart.js v3.9.1使用必須
- 既存データ構造との互換性維持
- レガシーブラウザ対応不要

### 開発方針
1. **ユーザー体験最優先**: 動作しない機能より確実に動く機能
2. **段階的実装**: 小さな単位で確実に実装
3. **堅牢性重視**: エラーハンドリングを最優先
4. **実用性優先**: 技術的美しさより現実的な問題解決

## 将来拡張予定

### データ拡充
- 残り63卦のHEXAGRAM_DETAILSデータ追加
- より詳細な評価項目データ整備

### 機能拡張
- バーチャルスクロール対応（大規模データ用）
- アニメーション効果強化
- 自動テストスイート整備

## 品質保証

### テスト項目
1. 単体テスト: 各コンポーネントの独立動作
2. 統合テスト: データ連携・表示確認
3. ユーザビリティテスト: 実際の操作確認
4. パフォーマンステスト: 負荷・メモリ使用量確認

### 検証環境
- Chrome 最新版
- Firefox 最新版
- Safari 最新版
- Edge 最新版

---

**要件定義完了**: 2025年07月26日  
**承認**: 実装開始可能  
**優先度**: 最高（Critical）