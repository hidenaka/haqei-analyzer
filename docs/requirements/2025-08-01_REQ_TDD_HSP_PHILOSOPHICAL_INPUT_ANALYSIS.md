# TDD要件定義書: HSP的・哲学的ユーザー入力の高精度分析システム

## 1. 背景・課題
### 現在の問題
- 実際のユーザー入力「世の中イライラしてる人敏感に感じやすく対応しちゃう。自分の気持ちが浮き沈みが影響受けやすい。そういう自分の性格をもっとニュートラルを保てるようにするにはどうしたらいいんだろうって言う。元の部分が志の本質をバランスよく整えて、人と地球の調和の取れた充実した世界を創造するって言うことを、自分の人生の心志として生きているんですが」
- 結果: 「統合分析でマッチなし、フォールバック結果を生成」
- 総キーワード数: 0 (平均: NaN/卦)
- ML統合システムがフォールバックモード

### ユーザー入力の特徴分析
1. **HSP的特性**: 敏感性、共感性、他者の感情への反応
2. **感情調整**: 浮き沈み、ニュートラル志向、バランス重視
3. **哲学的要素**: 地球環境、調和、人生の志、創造
4. **自己改善意欲**: 性格改善、成長志向

## 2. 機能要件

### FR-001: HSP特性検出システム
**要件**: HSP（Highly Sensitive Person）的特性を含む入力を正確に検出
- **入力例**: 「敏感に感じやすく」「影響受けやすい」「イライラしてる人」
- **期待する分類**: emotion_management または personal
- **対象卦**: 31番卦（沢山咸）、58番卦（兌為沢）、29番卦（坎為水）

### FR-002: 感情調整キーワード拡張
**要件**: 感情の浮き沈み・バランス志向の表現を包括的にカバー
- **拡張キーワード**: 
  - 「浮き沈み」「ニュートラル」「バランス」「整える」
  - 「安定」「調和」「平衡」「均衡」
- **口語的表現**: 「〜しちゃう」「〜だろうって」「〜なんですが」

### FR-003: 哲学的・スピリチュアル要素検出
**要件**: 人生観・世界観・価値観を含む表現の認識
- **対象表現**: 
  - 「志の本質」「人と地球の調和」「充実した世界を創造」
  - 「人生の心志」「生きている」
- **期待する分類**: philosophical または personal
- **対象卦**: 1番卦（乾為天）、2番卦（坤為地）、50番卦（火風鼎）

### FR-004: 形態素解析精度向上
**要件**: kuromoji.jsによる日本語解析の精度向上
- **長文対応**: 複数の文脈が混在する長文の適切な分割
- **口語表現対応**: SNS的な口語表現の正確な解析
- **複合語対応**: 「敏感に感じやすく」等の複合的表現

### FR-005: コンテキスト分類精度向上
**要件**: 8分類システムの感度向上
```javascript
const contextTypes = {
  emotion_management: ['敏感', '影響受ける', 'イライラ', '浮き沈み', 'ニュートラル'],
  personal: ['性格', '自分', '志', '人生'],
  philosophical: ['調和', '創造', '本質', '世界', '地球'],
  social: ['人', '対応', '関係'],
  // ... 他の分類
}
```

## 3. 非機能要件

### NFR-001: パフォーマンス要件
- キーワード抽出処理時間: 500ms以内
- 分析結果生成時間: 1秒以内
- メモリ使用量: 50MB以内

### NFR-002: 精度要件
- キーワード抽出成功率: 95%以上
- コンテキスト分類精度: 85%以上
- フォールバック発生率: 5%以下

### NFR-003: 拡張性要件
- 新しいキーワードパターンの動的追加
- 分類カテゴリの柔軟な拡張
- ML統合システムとの互換性維持

## 4. テスト要件

### TR-001: 単体テスト
- 各キーワード抽出関数の個別テスト
- 形態素解析結果の検証
- コンテキスト分類ロジックの検証

### TR-002: 統合テスト
- エンドツーエンドの分析フロー検証
- ML統合システムとの連携テスト
- フォールバック機能の動作確認

### TR-003: 実データテスト
- 提供されたユーザー入力での動作確認
- 類似パターンでの一貫性確認
- エラーケースでの適切な処理確認

## 5. 成功基準

### 定量的指標
1. **キーワード抽出**: 提供入力で10個以上のキーワード抽出
2. **分類精度**: emotion_management または philosophical への正確な分類
3. **卦選択**: 31番卦（沢山咸）または関連卦への適切なマッチング
4. **信頼度**: 70%以上の分析信頼度

### 定性的指標
1. **ユーザー体験**: フォールバック状態の解消
2. **分析品質**: 具体的で実用的なアドバイス生成
3. **システム安定性**: エラー発生の大幅削減

## 6. 実装優先順位

### Phase 1: 基盤改善 (High Priority)
1. kuromoji.js形態素解析の設定最適化
2. キーワードデータベースの拡張
3. コンテキスト分類ロジックの改善

### Phase 2: 精度向上 (High Priority)
1. HSP特性キーワードの追加
2. 哲学的表現パターンの拡張
3. 口語表現対応の強化

### Phase 3: 統合・検証 (Medium Priority)
1. ML統合システムとの最適化
2. 包括的テストスイートの実装
3. パフォーマンス最適化

## 7. 検証方法

### 検証データ
```javascript
const testInputs = [
  {
    input: "世の中イライラしてる人敏感に感じやすく対応しちゃう。自分の気持ちが浮き沈みが影響受けやすい。そういう自分の性格をもっとニュートラルを保てるようにするにはどうしたらいいんだろうって言う。元の部分が志の本質をバランスよく整えて、人と地球の調和の取れた充実した世界を創造するって言うことを、自分の人生の心志として生きているんですが",
    expectedContext: "emotion_management",
    expectedHexagram: [31, 58, 29],
    expectedKeywords: ["敏感", "浮き沈み", "ニュートラル", "バランス", "調和", "志", "本質", "創造"]
  }
];
```

### 自動検証スクリプト
- 継続的インテグレーションでの自動テスト
- リグレッション防止のための定期実行
- パフォーマンス監視とアラート

この要件定義に基づいて、次のフェーズでテストケース作成と実装を進めます。