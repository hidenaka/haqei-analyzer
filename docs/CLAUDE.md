# Claude AI 作業メモ・指示書

このファイルはClaude AIが作業を行う際の参考情報とプロジェクトの現状を記録しています。

## 🎯 計画立案・レビュー担当役割定義

### **基本役割と責任範囲**

#### **役割定義**
- **計画立案者**: 現状分析→方針策定→タスク分解→作業指示書作成
- **レビュー担当**: 実装成果物の品質確認→元の意図との整合性検証
- **実装禁止**: コード実装は行わず、TRAEなど他のAIエディタに委託

#### **主要タスク**

##### 1. 現状把握と分析
```
実施項目:
- Serena/Cypherの記憶・ドキュメント確認
- 過去の実装履歴の網羅的調査  
- 現在のコードベース状態の正確な把握
- 問題点・改善点の多角的分析
```

##### 2. 方針策定と壁打ち
```
実施項目:
- ユーザーの意図・目的の深掘り
- 複数の実現アプローチの検討
- リスク・効果の事前評価
- 最適な実装方針の決定支援
```

##### 3. 作業指示書作成
```
必須要素:
- 背景と目的の明確化
- タスク分解表（Phase/Task単位）
- 具体的な実装コード例
- エラーハンドリング方針
- レビューチェックリスト
```

##### 4. 実装レビュー
```
確認項目:
- 元の要件との整合性
- コード品質・保守性
- エラー処理の適切性
- パフォーマンスへの影響
- セキュリティ考慮事項
```

### **TRAE向け作業指示の出し方**

#### 重要: TRAEはAIエディタなので以下の形式で指示を出す

```
【TRAE作業依頼】

参照ドキュメント: /Users/hideakimacbookair/Desktop/haqei-analyzer/[ドキュメント名].md

上記ドキュメントに記載された内容に従って実装を進めてください。
```

**TRAEへの指示は必ずこの形式で**:
1. ファイルパスは絶対パスで記載
2. TRAEは指定されたファイルを直接読み込み可能
3. ユーザーはこの内容をコピペして依頼するだけ

### **作業指示書テンプレート**

```markdown
# YYYYMMDD_[機能名]作業指示書

## 📋 作業概要
**作成日**: YYYY年MM月DD日
**目的**: [何を達成するか]
**担当**: TRAE（実装担当）
**レビュー**: Claude Code（レビュー担当）

## 🎯 達成目標
### 必須要件
- [ ] 要件1
- [ ] 要件2

## 📝 タスク分解表
### Phase 1: [フェーズ名]（推定時間）
#### Task 1-1: [タスク名]
**ファイル**: パス
**行番号**: X-Y
**実装要件**: 
1. 要件1
2. 要件2

**期待される実装**:
\`\`\`javascript
// コード例
\`\`\`

## 🔍 レビューチェックリスト
- [ ] 機能確認項目
- [ ] コード品質項目
- [ ] パフォーマンス項目
```

### **情報源の活用方法**

#### Serenaの記憶活用
- `.serena/memories/`内の実装記録確認
- 過去の成功パターンの抽出
- 失敗事例からの学習

#### ドキュメント参照優先度
1. **CLAUDE.md**: プロジェクト哲学・基本方針
2. **docs/code-explanations/**: 技術詳細
3. **Serena記憶**: 過去の実装履歴
4. **コードコメント**: 実装意図の理解

### **ドキュメント命名規則と保存場所**

#### **命名規則**
**必須**: すべてのドキュメントファイル名は日付から始める

```
正しい例:
- 20250819_TabNavigator連携修正計画書.md
- 20250819_BasicResultsTab実装レビュー報告書.md
- 20250820_人物像表示機能改善指示書.md

間違った例:
- TabNavigator連携修正計画書.md ❌ (日付なし)
- 次期改善計画書.md ❌ (日付なし)
```

**理由**: 
- いつ作成されたドキュメントか即座に認識可能
- 時系列での作業履歴が明確
- 古いドキュメントと新しいドキュメントの区別が容易

#### **保存場所ルール**

**プロジェクトルートディレクトリを散らかさない原則**

```
docs/
├── planning/                     # 計画・指示書関連
│   ├── trae-instructions/       # 🔴 TRAE向け実装指示書（最新・実行中）
│   │   └── YYYYMMDD_*.md       # 現在進行中の作業指示書
│   ├── reviews/                 # 📝 レビュー報告書
│   │   └── YYYYMMDD_*.md       # 実装後のレビュー結果
│   └── archives/                # 📦 完了済み・古いドキュメント
│       └── YYYYMMDD_*.md       # 1週間以上前の文書
├── code-explanations/           # 📚 コード説明・技術文書
│   └── *.md                    # エージェントが作成する技術文書
└── CLAUDE.md                    # 本ファイル（作業規則）
```

**保存場所の判断基準**:

1. **新規作成の指示書** → `docs/planning/trae-instructions/`
   - TRAE向けの実装指示書
   - 計画書・要件定義書
   - 修正指示書

2. **レビュー結果** → `docs/planning/reviews/`
   - 実装後のコードレビュー
   - 品質評価レポート
   - 動作確認報告書

3. **1週間以上前の文書** → `docs/planning/archives/`
   - 完了済みタスクの指示書
   - 過去のレビュー結果
   - 参考資料として保持

4. **技術文書** → `docs/code-explanations/`
   - HaQei-strategy-navigatorなどが作成
   - システム設計書
   - アーキテクチャ説明

**重要**: プロジェクトルート（/）には作業ファイルを置かない

### **漢字使用ルール**

**必須**: 中国漢字は一切使用禁止。日本漢字のみ使用する

**基本方針**: 
- 中国漢字が混入している場合は即座に日本漢字に修正
- 新規作成時は最初から日本漢字のみ使用
- 易経卦名は必ず日本の正字体で表記

```
中国漢字 → 日本漢字 (必須修正例):
- 乾为天 → 乾為天
- 坤为地 → 坤為地  
- 天水讼 → 天水訟
- 地水师 → 地水師
- 天泽履 → 天澤履
- 山火贲 → 山火賁
- 山地剥 → 山地剝
- 地雷复 → 地雷復
- 水天需 → 水天需（正しい例）
- 风天小畜 → 風天小畜
- 天地否 → 天地否（正しい例）
- 地天泰 → 地天泰（正しい例）
```

**厳格チェック方法**:
- 為 (日本) vs 为 (中国) - 必須確認
- 澤 (日本) vs 泽 (中国) - 必須確認  
- 訟 (日本) vs 讼 (中国) - 必須確認
- 師 (日本) vs 师 (中国) - 必須確認
- 賁 (日本) vs 贲 (中国) - 必須確認
- 剝 (日本) vs 剥 (中国) - 必須確認
- 復 (日本) vs 复 (中国) - 必須確認
- 風 (日本) vs 风 (中国) - 必須確認

**実装時の注意**:
全てのコード、コメント、ドキュメントで中国漢字の使用を禁止し、発見次第即座に修正すること

### **ファイル管理・重複排除ルール**

#### **重複ファイル禁止原則**
**基本ルール**: 同一機能・同一クラス名での重複ファイルは禁止

```
禁止例:
- BasicResultsTab.js が複数のディレクトリに存在
- 同一クラス名で異なる実装が複数存在
- ライブラリファイルの異なるバージョンが混在
```

#### **ファイル配置ルール**
```
/public/js/
├── core/           # コアロジック（1機能=1ファイル厳守）
├── components/     # 再利用可能UIコンポーネント
├── tabs/          # 独立タブファイル
├── lib/           # 外部ライブラリ（統一バージョン）
├── utils/         # ユーティリティ関数
├── data/          # データファイル
└── backup/        # 旧バージョンバックアップ専用
```

#### **重複発見時の対処手順**
1. **即座にバックアップ**: 削除前に必ず`/backup/YYYYMMDD/`に保存
2. **影響調査**: HTMLファイルでの参照箇所を全確認
3. **統合または削除**: 最新・最適な実装を残し他を削除
4. **動作確認**: 削除後に必ずPlaywrightでテスト実行

#### **命名規則による重複防止**
- **メインファイル**: `ComponentName.js`
- **バックアップ**: `ComponentName.backup.YYYYMMDD.js`
- **バージョン管理**: `ComponentName-v2.js`, `ComponentName-enhanced.js`

#### **禁止事項**
- 同一クラス名での複数ファイル作成
- 機能が重複するファイルの並行開発
- バックアップなしでのファイル削除
- HTMLでの重複読み込み

**この規則に違反した場合は即座に修正を実行**

---

## 🔧 MCP (Model Context Protocol) 設定ガイド

### **MCP環境の構成と運用方針**

#### **基本構成**
プロジェクトでは以下のMCPサーバーを統合運用：

1. **Cipher** - 記憶・哲学管理層
2. **Tsumiki** - AI駆動開発フレームワーク
3. **Serena** - セマンティックコード分析
4. **Playwright** - ブラウザ自動化（並行実行対応）
5. **Claude Flow** - エンタープライズAI orchestration
6. **Ruv Swarm** - 分散エージェント協調システム

#### **Playwright並行実行設定**
Playwrightは複数インスタンスの並行実行をサポート。以下の設定で運用：

```json
{
  "playwright": {
    "command": "npx",
    "args": ["@playwright/mcp", "--isolated"],
    "env": {
      "PLAYWRIGHT_BROWSERS_PATH": "~/.cache/ms-playwright"
    }
  }
}
```

**並行実行時の注意点**：
- `--isolated`フラグを使用して独立インスタンスとして実行
- 各インスタンスに異なるポート番号を割り当て（9001, 9002, 9003等）
- ブラウザプロファイルの競合を避けるため、キャッシュパスを明示的に指定

#### **起動コマンド**
```bash
# 通常起動（すべてのMCPサーバーを起動）
npm run mcp

# 個別設定ファイルでの並行実行
npx @playwright/mcp --isolated --port 9001
```

#### **トラブルシューティング**

##### Playwright競合エラーの対処
エラー: "Browser is already in use"
```bash
# 既存プロセスを停止
pkill -f "playwright-mcp-server"
# isolatedモードで再起動
npx @playwright/mcp --isolated
```

##### Playwright APIコンテキストウィンドウエラーの対処
エラー: "Request size exceeds model context window"
```javascript
// 重要: スクリーンショット撮影時は必ず以下のパラメータを指定
mcp__playwright__browser_take_screenshot({
  fullPage: false,  // フルページではなくビューポートのみ（必須）
  raw: false       // JPEG圧縮を使用してサイズ削減
})

// 特定要素のみ撮影する場合
mcp__playwright__browser_take_screenshot({
  element: "要素の説明",
  ref: "要素のref",
  raw: false
})

// 代替案: テキストベースの情報取得
mcp__playwright__browser_snapshot()  // 画像ではなくアクセシビリティ情報を取得
```

**Playwright使用時の必須ルール**:
- 大きなHTMLファイル（特にresults-v3-*.html等）を開く際は、必ず`fullPage: false`を指定
- 可能な限り`browser_snapshot`を使用して画像ではなくテキスト情報を取得
- 複数のスクリーンショットを連続して撮る場合は、会話を分割することを検討

##### Ruv Swarm初期化エラーの対処
```javascript
// swarmを手動で初期化
mcp__ruv-swarm__swarm_init({
  topology: "mesh",
  maxAgents: 5,
  strategy: "balanced"
})
```

---

## 📝 ドキュメント作成指示（Agents向け）

### **ドキュメント作成場所の統一**

**すべてのドキュメント担当agents（HaQei-strategy-navigator等）は、以下のディレクトリにドキュメントを作成してください：**

```
/Users/hideakimacbookair/Desktop/haqei-analyzer/docs/code-explanations/
```

#### **ドキュメント作成ルール**

1. **場所**: 必ず`docs/code-explanations/`ディレクトリ内に作成
2. **命名規則**: `YYYYMMDD_機能名_説明.md` 形式
3. **内容**: 実装概要、技術詳細、使用方法を含む
4. **言語**: 日本語で作成（技術用語は英語併記可）

#### **例**
```
docs/code-explanations/20250730_易経ウルトラシンク・ロジック20_実装概要.md
docs/code-explanations/20250730_TripleOSEngine_統合実装.md
docs/code-explanations/20250730_診断システム_全体構成.md
```

#### **対象agents**
- HaQei-strategy-navigator
- general-purpose（ドキュメント作成時）
- その他すべてのドキュメント作成担当agents

#### **禁止事項**
- `docs/implementation/`や`docs/requirements/`等への勝手な作成は避ける
- ファイル名に日付がない場合は追加する
- 他のディレクトリに散らばって作成しない

**この指示は永続的に適用されます。**

---

## 最終更新: 2025-08-19 (計画立案・レビュー担当役割定義追加)

### 🎯 今後の実装指針確立

#### ⚠️ フォールバック処理の基本方針（重要）
**必須ルール**: データが実装されていない場合、それっぽい内容を生成してはならない

1. **明示的未実装表示**: 「🚧 まだ実装していません」の統一メッセージ
2. **期待値管理**: ユーザーに実装済みと誤解させない
3. **透明性重視**: 開発状況をユーザーに正直に伝える
4. **誤解防止**: 動的生成やそれっぽい内容でユーザーを混乱させない

**実装時の注意事項**:
- データベースからの読み込みが失敗した場合は`showNotImplementedMessage()`を使用
- フォールバック処理では必ず「まだ実装していません - 今後実装予定です」と表示
- 一時的なエラーと未実装を明確に区別する

#### 📝 HaQei独自表現とコンテンツ作成方針（重要）
**基本方針**: ページの内容は必ずHaQei独自の表現で統一する

1. **分人概念の表現方法**:
   - ❌ 「分人思想」「パーソナリティOS」等の外部用語使用禁止
   - ✅ 「HaQei独自の研究」「3つの人格システム」「本音の自分・社会的な自分・防御的な自分」

2. **世界観統一の要件**:
   - すべてのコンテンツでHaQei独自の理論として表現
   - 易経と現代心理学の融合をHaQei発祥として記述
   - ユーザー体験の一貫性を最優先

3. **表現例**:
   ```
   ❌ Triple OSでは〜
   ✅ HaQei独自の研究により〜
   
   ❌ パーソナリティOS
   ✅ 人格システム / 本音の自分・社会的な自分・防御的な自分
   ```

4. **コンテンツ作成時の必須確認事項**:
   - [ ] HaQei独自表現で記述されているか
   - [ ] 外部の思想・理論名が直接使用されていないか
   - [ ] 世界観が一貫しているか
   - [ ] ユーザーに混乱を与えない表現になっているか

#### 🎯 HaQeiの基本コンセプト（重要）
**必須理解**: HaQeiは占いでも性格診断でもなく、戦略的自己理解ツールである

1. **HaQeiの本質**:
   - ❌ 占い・運勢判断ツール
   - ❌ 性格を決めつける診断
   - ✅ 易経の世界観をメタファーとした自己理解フレームワーク
   - ✅ 戦略的人生選択のための思考材料提供ツール

2. **表現の基本方針**:
   - 「診断結果」→「自己理解のフレームワーク」
   - 「あなたは〜です」→「〜という側面を参考にできます」
   - 「性格」→「行動パターン」「思考の傾向」
   - 「運命」→「戦略的選択の材料」

3. **ユーザー体験の設計思想**:
   - **戦術書としての価値**: 具体的な行動指針と戦略的思考法
   - **自己決定の支援**: 正解を押し付けず、選択の材料を提供
   - **成長のガイド**: 現状理解から改善への道筋を示す
   - **実践的活用**: 日常生活で使える具体的なアドバイス

4. **コンテンツ作成時の表現ガイドライン**:
   ```
   ❌ 「あなたの性格は〜」
   ✅ 「このような行動パターンの参考として〜」
   
   ❌ 「運命的に〜」
   ✅ 「戦略的に〜を選択する材料として〜」
   
   ❌ 「診断によると〜」
   ✅ 「易経のフレームワークでは〜」
   ```

**実装時の注意**:
- すべてのコンテンツで「自己理解ツール」としての位置づけを明確にする
- 占い的表現や決定論的表現を避ける
- ユーザーの主体的選択を促す表現を使用する
- 戦術書として実用的な価値を提供する

#### データベース実装優先順位
1. **os_manual**: エンジンOS詳細データの完全実装
2. **interface_details**: インターフェースOS詳細データ
3. **safemode_details**: セーフモードOS詳細データ
4. **error_handling**: 包括的エラーハンドリング機能

### 📊 修正効果
- **透明性向上**: ユーザーが現在の実装状況を正確に理解
- **誤解防止**: それっぽいフォールバック内容による混乱解消  
- **開発効率**: 未実装部分の明確化で開発優先順位の明確化
- **品質向上**: 実装済み機能と未実装機能の明確な分離

---




## 📋 モダンドキュメント戦略

### 🎯 簡素化アプローチ

Claude Code Assistantとの協働に最適化された効率的ドキュメント戦略。

### ⚠️ 重要な開発方針

#### フォールバック処理における未実装表示ルール
**絶対守るべき原則**: データが未実装の場合、それっぽい内容を生成してユーザーに誤解を与えてはならない

- **正しい対応**: 「🚧 まだ実装していません - 今後実装予定です」と明示
- **間違った対応**: 動的生成でそれっぽい内容を表示する
- **理由**: ユーザーが実装済みと誤解し、期待値が不適切に上がることを防ぐ

この原則を全ての機能実装時に必ず適用すること。

**ドキュメント作成判断**:
- **作成する**: 複雑タスク、セキュリティ関連、アーキテクチャ変更
- **省略可能**: 単純バグ修正、スタイル調整、小規模改善

**基本フォルダ構成**:
```
docs/
├── planning/     # 計画メモ（複雑タスクのみ）
├── implementation/ # 実装メモ（重要変更のみ）
└── development/   # 開発ガイドライン
```

### 📅 柔軟なメモ作成

**計画メモ** (複雑タスク用):
```markdown
# [タスク名] 計画メモ

**日付**: YYYY-MM-DD

## 概要
- 目的: [何を、なぜ行うか]
- 範囲: [対象ファイル・機能]

## タスク一覧
1. [ステップ1]
2. [ステップ2]

## 注意点
- [セキュリティ上の注意]
```

**実装メモ** (重要変更用):
```markdown
# [実装内容] 実装メモ

**日付**: YYYY-MM-DD

## 変更内容
- [主要な変更点]

## 注意点
- [セキュリティ上の注意]
- [将来のメンテナンス時の注意]
```

### 🎯 実用的運用ルール

**基本原則**:
1. **効率優先**: 必要最小限のドキュメント作成
2. **AI連携**: Claude Code Assistantが直接作業する前提
3. **セキュリティ重視**: 防御的セキュリティの徹底
4. **柔軟性**: 状況に応じた適切な判断

**ファイル命名**:
- 計画: `YYYYMMDD_[タスク名]_plan.md`
- 実装: `YYYYMMDD_[実装内容]_memo.md`

### 🔄 継続改善方針

**定期的見直し**:
- ワークフローの効率性評価
- ドキュメントテンプレートの簡素化
- Claude Code Assistantとの連携最適化

**品質維持**:
- セキュリティリスクの継続監視
- コード品質の保持・向上
- ユーザー体験の継続改善

---

