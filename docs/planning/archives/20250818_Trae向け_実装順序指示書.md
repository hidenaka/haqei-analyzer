# 🎯 Trae向け実装順序指示書 - 必ず順番通りに実行

## ⚠️ 超重要：実装前の必須確認

### 🤖 AI理解確認（実装前に必ず回答）
1. **理解している実装内容**: 何を作るか具体的に説明
2. **不明な点や確認事項**: 曖昧な箇所をリストアップ
3. **実装順序とチェックポイント**: 各ステップと完了基準
4. **想定される技術的課題**: 予想される問題と対策

## 📋 実装順序（必ず順番を守る）

### 🔴 Phase 0: 準備（10分）

#### Step 0.1: 環境確認
```bash
# 1. 現在のディレクトリ確認
pwd
# 期待値: /Users/hideakimacbookair/Desktop/haqei-analyzer

# 2. Gitステータス確認
git status

# 3. ブランチ確認
git branch
```

#### Step 0.2: CLAUDE.md確認
```bash
# 必須：開発ルールを読む
cat CLAUDE.md | head -50
```

#### Step 0.3: バックアップ作成
```bash
# 重要ファイルのバックアップ
cp public/js/core/QuestionManager.js public/js/core/QuestionManager.js.backup_$(date "+%Y%m%d_%H%M%S")
cp public/js/os-analyzer-main.js public/js/os-analyzer-main.js.backup_$(date "+%Y%m%d_%H%M%S")
```

---

### 🟡 Phase 1: 現状確認とテスト作成（20分）

#### Step 1.1: 現在の問題を確認
```bash
# 開発サーバー起動
npm run dev

# ブラウザで確認
# http://localhost:8788/os_analyzer.html
```

**確認項目**:
- [ ] ウェルカム画面が表示される
- [ ] 「分析を開始」ボタンをクリック
- [ ] Q1でラジオボタンが表示されるか
- [ ] Q2に進んでラジオボタンが表示されるか
- [ ] コンソールにエラーが出ているか（F12）

#### Step 1.2: テストファイル作成（TDD）
```javascript
// test-radio-button-fix.js を作成
const testRadioButtonDisplay = async () => {
    console.log('🧪 === Radio Button Display Test ===');
    
    // Test 1: Q1のラジオボタン確認
    console.log('Test 1: Checking Q1 radio buttons...');
    // ここに詳細なテストコード
    
    // Test 2: Q2のラジオボタン確認
    console.log('Test 2: Checking Q2 radio buttons...');
    // ここに詳細なテストコード
    
    // Test 3: エラーハンドリング確認
    console.log('Test 3: Error handling...');
    // ここに詳細なテストコード
};

// 実行
testRadioButtonDisplay();
```

#### Step 1.3: エラー記録
```markdown
# error-log.md を作成
## 発生しているエラー
1. TypeError: Cannot read properties of undefined (reading 'text')
   - 場所: QuestionManager.js:XXX行目
   - 原因: 

2. その他のエラー:
   - 
```

---

### 🟢 Phase 2: QuestionManager.js修正（30分）

#### Step 2.1: ファイル確認
```bash
# ファイルの存在と行数確認
ls -la public/js/core/QuestionManager.js
wc -l public/js/core/QuestionManager.js
```

#### Step 2.2: displayQuestionメソッド修正
```javascript
// public/js/core/QuestionManager.js

// 修正前のコードをコメントアウト
/*
displayQuestion(index) {
    // 既存のコード
}
*/

// 修正後のコード
displayQuestion(index) {
    console.log('📍 displayQuestion called with:', index, typeof index);
    
    // 1. 引数の型チェックと変換
    let questionIndex = index;
    
    if (typeof index === 'object' && index !== null) {
        console.warn('⚠️ Object passed to displayQuestion, converting...');
        
        // オブジェクトからインデックスを抽出
        if ('index' in index) {
            questionIndex = index.index;
        } else if ('currentQuestion' in index) {
            questionIndex = index.currentQuestion;
        } else if (!isNaN(parseInt(index))) {
            questionIndex = parseInt(index);
        } else {
            console.error('❌ Cannot extract index from:', index);
            questionIndex = 0;
        }
    }
    
    // 2. インデックスの検証
    if (typeof questionIndex !== 'number' || isNaN(questionIndex)) {
        console.error('❌ Invalid question index:', questionIndex);
        return;
    }
    
    // 3. 範囲チェック
    if (questionIndex < 0 || questionIndex >= this.questions.length) {
        console.error('❌ Index out of range:', questionIndex);
        return;
    }
    
    // 4. 質問データの取得
    const question = this.questions[questionIndex];
    if (!question) {
        console.error('❌ Question not found at index:', questionIndex);
        return;
    }
    
    // 5. 質問テキストと選択肢の検証
    if (!question.text || !question.options || !Array.isArray(question.options)) {
        console.error('❌ Invalid question structure:', question);
        return;
    }
    
    console.log('✅ Displaying question:', questionIndex, question.text);
    
    // 6. 質問テキストの表示
    const questionContainer = document.getElementById('question-text');
    if (questionContainer) {
        questionContainer.textContent = `Q${questionIndex + 1}. ${question.text}`;
    }
    
    // 7. ラジオボタンHTMLの生成
    const optionsHTML = question.options.map((option, i) => {
        return `
            <label class="option-label">
                <input type="radio" 
                       name="q${questionIndex + 1}" 
                       value="${option.value || i}"
                       data-question-index="${questionIndex}"
                       data-option-index="${i}">
                <span class="option-text">${option.text || option}</span>
            </label>
        `;
    }).join('');
    
    // 8. DOM更新
    const optionsContainer = document.getElementById('options-container');
    if (optionsContainer) {
        optionsContainer.innerHTML = optionsHTML;
        console.log('✅ Radio buttons created for question', questionIndex + 1);
    } else {
        console.error('❌ Options container not found');
    }
    
    // 9. プログレスバー更新
    this.updateProgressBar(questionIndex);
}
```

#### Step 2.3: 動作確認
```bash
# ブラウザをリロード
# F12でコンソールを確認
# Q1, Q2の表示を確認
```

---

### 🔵 Phase 3: os-analyzer-main.js修正（20分）

#### Step 3.1: showQuestionメソッド修正
```javascript
// public/js/os-analyzer-main.js

// showQuestion メソッドを探す（4000行以降）
showQuestion() {
    console.log('📍 showQuestion called, currentQuestion:', this.currentQuestion);
    
    // QuestionManagerが利用可能か確認
    if (!this.QuestionManager) {
        console.error('❌ QuestionManager not initialized');
        return;
    }
    
    // インデックスを渡す（オブジェクトではなく）
    if (typeof this.QuestionManager.displayQuestion === 'function') {
        // ⭐ 重要：インデックスを直接渡す
        this.QuestionManager.displayQuestion(this.currentQuestion);
    } else {
        console.error('❌ displayQuestion method not found');
    }
    
    // ボタンの状態更新
    this.updateNavigationButtons();
}
```

#### Step 3.2: イベントリスナー重複対策
```javascript
// handleNextButtonClick の重複防止
initEventListeners() {
    const nextBtn = document.getElementById('nextBtn');
    const prevBtn = document.getElementById('prevBtn');
    
    // 重複防止のためのフラグチェック
    if (nextBtn && !nextBtn.dataset.listenerAttached) {
        nextBtn.dataset.listenerAttached = 'true';
        nextBtn.addEventListener('click', () => {
            console.log('➡️ Next button clicked');
            this.handleNextButtonClick();
        });
    }
    
    if (prevBtn && !prevBtn.dataset.listenerAttached) {
        prevBtn.dataset.listenerAttached = 'true';
        prevBtn.addEventListener('click', () => {
            console.log('⬅️ Previous button clicked');
            this.handlePrevButtonClick();
        });
    }
}
```

---

### 🟣 Phase 4: 統合テストと検証（20分）

#### Step 4.1: 全体動作テスト
```bash
# サーバー再起動
# Ctrl+C で停止後
npm run dev
```

#### Step 4.2: チェックリスト確認
**必須確認項目**:
- [ ] Q1: ラジオボタン表示 ✅
- [ ] Q2: ラジオボタン表示 ✅
- [ ] Q3-Q36: すべて表示確認
- [ ] TypeError解消 ✅
- [ ] 不要なアラート削除 ✅
- [ ] 選択肢が選択可能
- [ ] 次へ/前へボタン動作
- [ ] 結果画面への遷移

#### Step 4.3: エラーログ確認
```javascript
// ブラウザコンソールで実行
console.clear();
// 操作を行い、エラーが出ないか確認
```

---

### ⚫ Phase 5: 仕上げと記録（10分）

#### Step 5.1: 不要なconsole.log削除
```javascript
// デバッグ用のconsole.logを削除またはコメントアウト
// ただし、エラーログは残す
```

#### Step 5.2: Lintチェック
```bash
npm run lint
# エラーがあれば修正
```

#### Step 5.3: 作業記録作成
```bash
# 作業記録を保存
cat > .serena/memories/radio_button_fix_$(date "+%Y%m%d").md << EOF
# ラジオボタン表示問題修正 - $(date "+%Y/%m/%d")

## 実施内容
- QuestionManager.js displayQuestionメソッド修正
- os-analyzer-main.js showQuestionメソッド修正
- イベントリスナー重複対策

## 修正前の問題
- Q2以降でラジオボタンが表示されない
- TypeError発生

## 修正後の結果
- 全質問でラジオボタン表示 ✅
- エラー解消 ✅

## テスト結果
- Q1-Q36: すべて正常動作
EOF
```

#### Step 5.4: Git差分確認
```bash
# 変更内容確認
git diff public/js/core/QuestionManager.js
git diff public/js/os-analyzer-main.js
```

---

## 🚨 トラブルシューティング

### エラー1: ファイルが見つからない
```bash
# 正しいパスを検索
find . -name "QuestionManager.js" -type f
```

### エラー2: 変更が反映されない
```bash
# キャッシュクリア
# ブラウザで Ctrl+Shift+R（強制リロード）
```

### エラー3: 新しいエラーが発生
```bash
# バックアップから復元
cp public/js/core/QuestionManager.js.backup_* public/js/core/QuestionManager.js
```

## 📊 完了基準

### 必須達成項目
1. ✅ Q1-Q36すべてでラジオボタン表示
2. ✅ TypeError解消
3. ✅ 選択肢の選択が可能
4. ✅ 画面遷移が正常動作
5. ✅ コンソールにエラーなし

### 確認方法
```javascript
// ブラウザコンソールで実行
document.querySelectorAll('input[type="radio"]').length > 0
// true が返れば成功
```

## 🎯 最終確認

実装完了後、以下を必ず確認：

1. **動作確認**
   - 36問すべて確認した ✅
   - エラーが出ていない ✅

2. **コード品質**
   - 不要なconsole.log削除 ✅
   - Lintエラーなし ✅

3. **ドキュメント**
   - 作業記録を保存 ✅
   - このチェックリストを完了 ✅

---

**重要**: 各Phaseを飛ばさず、必ず順番通りに実行してください。
問題が発生した場合は、次のPhaseに進まず、まず原因を特定してください。

## 🔴 質問数について
**HAQEIシステムは36問の質問を使用します。**