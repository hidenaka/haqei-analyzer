# 🔧 384爻システム 文脈理解修正計画書

**作成日時**: 2025年8月28日 16:30  
**優先度**: 🔴 最高（システムの根幹機能）  
**推定作業時間**: 6-8時間  

---

## 📋 問題の根本原因

### 1. **ノイズが支配的になっている**
```javascript
// Line 1857-1878: 探索ノイズが過剰
const primaryNoise = ((lineId * noiseBase * 17) % 200) / 1000; // 0-0.2
const unusedBonus = (usageCount === 0) ? 0.35 : 0; // 未使用に0.35追加
// 合計で最大0.85のノイズが追加される
```
**セマンティックスコア（0.45）よりノイズ（最大0.85）の方が大きい**

### 2. **セマンティックベクトルが機能していない**
- 656次元ベクトルの生成方法に問題がある可能性
- すべてのテキストで似たようなベクトルになっている
- コサイン類似度が常に似た値を返す

### 3. **決定論的処理が順番割当を生む**
```javascript
// Line 1292-1294: スコアが同じ場合、lineIdの小さい順
if (Math.abs(scoreDiff) > 0.000001) {
    return scoreDiff > 0 ? 1 : -1;
}
return a.lineId - b.lineId; // ← これが順番割当の原因
```

---

## 🎯 修正計画

### Phase 1: ノイズの適正化（1時間）

#### 1-1. 探索ノイズを大幅削減
```javascript
// 現在: 最大0.85
// 修正後: 最大0.05（セマンティックスコアの1/10以下）
const primaryNoise = ((lineId * noiseBase * 17) % 20) / 10000; // 0-0.002
const unusedBonus = (usageCount === 0) ? 0.03 : 0; // 0.35→0.03
```

#### 1-2. スコア配分の再調整
```javascript
// 現在の配分
セマンティック: 45%
ノイズ: 実質85%（!）

// 修正後の配分
セマンティック: 70%  // 大幅増加
キーワード: 15%       // 維持
位置調整: 10%         // 削減
ノイズ: 5%            // 大幅削減
```

### Phase 2: セマンティック処理の強化（3時間）

#### 2-1. テキストベクトル生成の改善
```javascript
generateTextVector656(text) {
    const vector = new Float32Array(656);
    
    // 1. 形態素解析の強化
    const words = this.tokenizeJapanese(text);
    
    // 2. 重要語の抽出
    const importantWords = this.extractImportantWords(words);
    
    // 3. 意味的特徴の埋め込み
    // - 0-100: 基本意味特徴
    // - 100-200: 時間的特徴（始まり/終わり等）
    // - 200-300: エネルギー特徴（上昇/下降等）
    // - 300-400: 感情特徴
    // - 400-500: 行動特徴
    // - 500-656: コンテキスト特徴
    
    this.embedSemanticFeatures(vector, importantWords);
    
    return vector;
}
```

#### 2-2. 爻ごとの特徴ベクトル強化
```javascript
// 各爻に意味的特徴を明確に定義
updateSemanticVectors(lineId, lineData) {
    const position = ((lineId - 1) % 6) + 1;
    const vector = new Float32Array(656);
    
    // 位置による明確な特徴付け
    switch(position) {
        case 1: // 初爻 - 始まり
            this.setBeginningFeatures(vector);
            break;
        case 5: // 五爻 - リーダーシップ
            this.setLeadershipFeatures(vector);
            break;
        case 6: // 上爻 - 完成
            this.setCompletionFeatures(vector);
            break;
    }
    
    lineData.semantic_vectors = vector;
}
```

### Phase 3: キーワードマッチングの改善（1時間）

#### 3-1. 位置特有キーワードの拡充
```javascript
const positionKeywords = {
    1: ['始', '新', '初', 'スタート', '開始', '第一歩', '出発', 
        'これから', '今から', '始まり', '起点', '原点'],
    2: ['成長', '発展', '進歩', '前進', '向上', '改善', '育つ',
        '伸びる', '広がる', '展開'],
    3: ['困難', '試練', '壁', '課題', '問題', '苦労', '努力',
        '頑張る', '乗り越える', '挑戦'],
    4: ['転換', '変化', '岐路', '選択', '決断', '分かれ道',
        '移行', '転機', '節目', '変わる'],
    5: ['リーダー', '責任', '統率', '指導', '管理', '決定',
        '判断', '方針', '戦略', '統括', '主導', '中心'],
    6: ['完成', '終了', '完了', '結果', '成果', '集大成',
        '終わり', '締めくくり', '最後', '極限']
};
```

#### 3-2. キーワードマッチングの重み付け
```javascript
calculateKeywordMatch(lineKeywords, textKeywords) {
    let score = 0;
    
    for (const keyword of textKeywords) {
        if (lineKeywords.includes(keyword)) {
            // 完全一致: 高スコア
            score += 1.0;
        } else {
            // 部分一致や類義語もチェック
            const partialScore = this.calculatePartialMatch(keyword, lineKeywords);
            score += partialScore * 0.5;
        }
    }
    
    return Math.min(1.0, score / Math.max(1, textKeywords.length));
}
```

### Phase 4: デバッグと検証（2時間）

#### 4-1. スコア計算の可視化
```javascript
// デバッグモードを追加
calculateLineScore(lineId, lineData, analysis, text, debug = false) {
    const scores = {
        semantic: 0,
        keyword: 0,
        position: 0,
        noise: 0,
        total: 0
    };
    
    // 各要素のスコアを記録
    if (debug) {
        console.log(`Line ${lineId}:`, scores);
    }
    
    return scores.total;
}
```

#### 4-2. テスト駆動開発
```javascript
// 明確な期待値を持つテストケース
const testCases = [
    {
        text: '新しいプロジェクトを始める',
        expectedRange: [1, 7], // 1番卦の初爻付近
        reason: '「始める」は初爻の特徴'
    },
    {
        text: 'リーダーとして決断する',
        expectedPosition: 5, // 五爻
        reason: 'リーダー、決断は五爻の特徴'
    }
];
```

---

## 📊 実装タスク分解

### 緊急度: 高（今すぐ実装）
1. **ノイズ削減** - Line 1857-1878を修正（30分）
2. **スコア配分変更** - Line 1807-1835を修正（30分）
3. **デバッグ出力追加** - スコア可視化（30分）

### 緊急度: 中（次に実装）
4. **キーワード拡充** - positionKeywordsを追加（1時間）
5. **キーワードマッチング改善** - 部分一致対応（1時間）
6. **テキストベクトル生成改善** - 形態素解析強化（2時間）

### 緊急度: 低（後日実装）
7. **爻ベクトル再生成** - 全384爻の特徴ベクトル見直し（2時間）
8. **類似度計算最適化** - セグメント重み調整（1時間）
9. **包括的テスト** - 500サンプルでの検証（1時間）

---

## 🚀 実装優先順位

### Day 1（今日）: 緊急修正
- [ ] ノイズを0.05以下に削減
- [ ] セマンティックスコアを70%に増加
- [ ] デバッグ出力で問題確認
- [ ] 基本テストで改善確認

### Day 2: 本格改修
- [ ] キーワードシステム全面改修
- [ ] テキストベクトル生成ロジック改善
- [ ] 位置別特徴の強化

### Day 3: 検証と最適化
- [ ] 500サンプルテスト
- [ ] 微調整
- [ ] 本番デプロイ準備

---

## 🎯 成功基準

### 必須達成項目
- ✅ 意味的分類精度: 60%以上（現在20%）
- ✅ キーワード別差別化: 明確な違い
- ✅ 順番割当の解消: ランダムな分布
- ✅ 5爻キーワード反応: 80%以上

### 期待値
- 「始める」系 → 1-2爻（80%以上）
- 「リーダー」系 → 5爻（60%以上）
- 「完了」系 → 6爻（60%以上）

---

## 📝 注意事項

1. **後方互換性維持**: 決定論性は維持する
2. **パフォーマンス**: 処理速度3ms/サンプル以内
3. **段階的実装**: 一度に全部変えない
4. **テスト重視**: 各変更後に必ずテスト

---

**計画作成者**: Claude Code Assistant  
**レビュー**: 未実施  
**承認**: 待機中