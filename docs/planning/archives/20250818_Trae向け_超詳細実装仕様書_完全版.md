# 📚 Trae向け超詳細実装仕様書 - OS Analyzer システム完全版

## 🎯 作業目的
OS AnalyzerシステムのUI/UX改善と技術的問題の修正

## ⚠️ 最重要事項
**必ず CLAUDE.md のルールに従ってください**
- AI理解確認の4項目に回答
- テストファーストで開発
- 指示範囲厳守

## 📂 最新フォルダ構造（2025/01/18時点）

```
/Users/hideakimacbookair/Desktop/haqei-analyzer/
├── public/
│   ├── os_analyzer.html         # メインHTML
│   ├── css/
│   │   ├── os-analyzer.css      # OS Analyzer専用CSS
│   │   └── haqei-unified-design.css  # 統一デザインCSS
│   ├── js/
│   │   ├── os-analyzer-main.js  # メインコントローラー
│   │   ├── core/
│   │   │   ├── QuestionManager.js    # 質問管理システム（重要）
│   │   │   ├── ScreenManager.js      # 画面遷移管理
│   │   │   ├── DataPersistenceManager.js  # データ永続化
│   │   │   └── TripleOSInteractionAnalyzer.js  # Triple OS分析
│   │   └── components/
│   │       └── InteractiveSystem.js  # UI対話システム
│   └── assets/
│       └── js/
│           ├── app.js            # 質問データ定義
│           └── questions-unified-v2.js  # 統一質問データ
```

## 🔧 修正対象ファイル

### 1. /public/js/core/QuestionManager.js
**役割**: 質問表示とラジオボタン生成を管理

#### 問題箇所（行番号は変動する可能性あり）
```javascript
// 問題のあるコード例
displayQuestion(index) {
    // オブジェクトが渡された場合の処理が不足
    if (typeof index === 'object') {
        // エラー処理が必要
    }
}
```

#### 修正内容
```javascript
displayQuestion(index) {
    // 引数の型チェックと変換
    let questionIndex = index;
    
    // オブジェクトが渡された場合の対処
    if (typeof index === 'object' && index !== null) {
        console.warn('⚠️ Object passed to displayQuestion, attempting to extract index');
        
        // indexプロパティがある場合
        if ('index' in index) {
            questionIndex = index.index;
        }
        // currentQuestionプロパティがある場合
        else if ('currentQuestion' in index) {
            questionIndex = index.currentQuestion;
        }
        // 数値に変換可能な場合
        else if (!isNaN(parseInt(index))) {
            questionIndex = parseInt(index);
        }
        // それでも駄目な場合はデフォルト値
        else {
            console.error('❌ Cannot extract index from object:', index);
            questionIndex = 0;
        }
    }
    
    // インデックスの検証
    if (typeof questionIndex !== 'number' || isNaN(questionIndex)) {
        console.error('❌ Invalid question index:', questionIndex);
        return;
    }
    
    // 質問の取得
    const question = this.questions[questionIndex];
    if (!question || !question.text) {
        console.error('❌ Question not found or invalid:', questionIndex);
        return;
    }
    
    // ラジオボタンHTML生成
    const optionsHTML = question.options.map((option, i) => `
        <label class="option-label">
            <input type="radio" 
                   name="q${questionIndex + 1}" 
                   value="${option.value}"
                   data-question-index="${questionIndex}">
            <span class="option-text">${option.text}</span>
        </label>
    `).join('');
    
    // DOM更新
    const container = document.getElementById('options-container');
    if (container) {
        container.innerHTML = optionsHTML;
    }
}
```

### 2. /public/js/os-analyzer-main.js
**役割**: メインコントローラー、画面遷移管理

#### 問題箇所
```javascript
// 問題: オブジェクトを渡している
showQuestion() {
    // this.state.questions[index] を渡してしまっている
    QuestionManager.displayQuestion(this.state.questions[this.currentQuestion]);
}
```

#### 修正内容
```javascript
showQuestion() {
    // インデックスを渡すように修正
    if (this.QuestionManager && typeof this.QuestionManager.displayQuestion === 'function') {
        // インデックスを直接渡す
        this.QuestionManager.displayQuestion(this.currentQuestion);
    } else {
        console.error('QuestionManager not available');
    }
}
```

### 3. イベントリスナー重複問題の修正

#### 問題箇所
```javascript
// 複数回登録されてしまう
document.getElementById('nextBtn').addEventListener('click', handler);
```

#### 修正内容
```javascript
// データ属性で重複防止
const nextBtn = document.getElementById('nextBtn');
if (nextBtn && !nextBtn.dataset.questionnaireHandler) {
    nextBtn.dataset.questionnaireHandler = 'true';
    nextBtn.addEventListener('click', this.handleNextButtonClick.bind(this));
}
```

## 📝 実装手順

### ステップ1: テスト作成（TDD）
```javascript
// test-question-display.js
async function testQuestionDisplay() {
    console.log('🧪 Testing question display...');
    
    // テスト1: インデックスで呼び出し
    QuestionManager.displayQuestion(0);
    
    // テスト2: オブジェクトで呼び出し（エラーハンドリング確認）
    QuestionManager.displayQuestion({index: 1});
    
    // テスト3: 無効な値で呼び出し
    QuestionManager.displayQuestion(null);
    
    // 結果確認
    const radioButtons = document.querySelectorAll('input[type="radio"]');
    console.assert(radioButtons.length > 0, 'Radio buttons should exist');
}
```

### ステップ2: QuestionManager.js修正
1. ファイルをバックアップ
2. displayQuestion メソッドに型チェック追加
3. エラーハンドリング強化
4. コンソールログで動作確認

### ステップ3: os-analyzer-main.js修正
1. showQuestion メソッドの引数修正
2. QuestionManagerへの委譲処理確認
3. イベントリスナー重複防止

### ステップ4: 統合テスト
```bash
# ローカルサーバー起動
npm run dev

# ブラウザで確認
# http://localhost:8788/os_analyzer.html

# コンソールでエラー確認
# F12 → Console タブ
```

## 🔍 動作確認チェックリスト

### 基本動作
- [ ] ウェルカム画面が表示される
- [ ] 「分析を開始」ボタンが動作する
- [ ] 質問画面に遷移する

### 質問表示
- [ ] Q1でラジオボタンが表示される
- [ ] Q2以降でもラジオボタンが表示される
- [ ] 選択肢のテキストが正しく表示される
- [ ] ラジオボタンが選択可能

### エラー対応
- [ ] TypeError が発生しない
- [ ] コンソールにエラーが出ない
- [ ] 不要なアラートが表示されない

### 画面遷移
- [ ] 次へボタンで次の質問に進む
- [ ] 前へボタンで前の質問に戻る
- [ ] 最後の質問後に結果画面へ遷移

## ⚠️ 注意事項

### 絶対に触らないファイル
- /data/*.json （データファイル）
- package.json （削除したら `git restore package.json`）
- /public/assets/js/app.js （質問データ定義）

### デバッグ方法
```javascript
// 問題箇所の特定
console.log('🔍 Current index:', index);
console.log('🔍 Type of index:', typeof index);
console.log('🔍 Question data:', this.questions[index]);

// スタックトレース確認
console.trace('Function call trace');
```

### エラー時の対処
1. **TypeError: Cannot read properties of undefined**
   - 原因: オブジェクトをインデックスとして使用
   - 対処: 型チェックと変換処理を追加

2. **Radio buttons not displaying**
   - 原因: DOM要素の生成失敗
   - 対処: HTML生成ロジックを確認

3. **Event listener duplication**
   - 原因: 複数回の登録
   - 対処: データ属性で重複チェック

## 📊 期待される結果

### 修正前の問題
- Q1: ラジオボタン表示 ✅
- Q2+: ラジオボタン非表示 ❌
- TypeError発生 ❌
- 不要なアラート ❌

### 修正後の期待結果
- Q1: ラジオボタン表示 ✅
- Q2+: ラジオボタン表示 ✅
- TypeError解消 ✅
- アラート削除 ✅

## 🚀 作業開始前の確認

1. **CLAUDE.mdを読む**
   ```bash
   cat CLAUDE.md
   ```

2. **テストファイル作成**
   ```bash
   echo "// Test for question display" > test-question-display.js
   ```

3. **現状確認**
   ```bash
   npm run dev
   # ブラウザで http://localhost:8788/os_analyzer.html
   ```

4. **エラー確認**
   - F12でConsoleタブを開く
   - エラーメッセージを記録

## 📝 作業記録テンプレート

作業完了後、以下の形式で記録を残してください：

```markdown
## 作業記録 - $(date "+%Y%m%d")

### 実施内容
- [ ] QuestionManager.js 修正
- [ ] os-analyzer-main.js 修正
- [ ] テスト実施

### 発生した問題
- 

### 解決方法
- 

### 動作確認結果
- Q1-Q36: ✅/❌
- エラー: ✅/❌

### 残課題
- 
```

---

**重要**: この仕様書に従って作業を進め、不明な点があれば質問してください。
勝手な判断での実装変更は禁止です。

## 🔴 質問数について
**HAQEIシステムは36問の質問を使用します。**
- 質問データ: `/public/assets/js/questions-full.js`
- 質問数: 36問（Q1〜Q36）
- 各質問に5つの選択肢