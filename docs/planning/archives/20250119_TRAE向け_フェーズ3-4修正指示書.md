# 📋 TRAE向け フェーズ3-4修正指示書 - データ活用強化とスマホ最適化

## 🎯 修正の目的

1. **洞察タブ・シナリオタブ**: H384データベースの実データを活用し、より深い分析を提供
2. **エクスポートタブ**: スマホユーザー向けの共有機能を実装
3. **動作確認**: 修正後の画面表示が正しく機能することを確認

## 📊 フェーズ3: 洞察タブのH384データベース連携

### 修正ファイル: `/public/js/components/tabs/InsightsTab.js`

#### 1. コンストラクタにHexagramExtractor追加

```javascript
class InsightsTab extends BaseTabView {
    constructor(tabId) {
        super(tabId);
        this.analysisData = null;
        this.insights = null;
        this.ichingEngine = null;
        this.hexagramExtractor = null; // 追加
    }
```

#### 2. 初期化メソッドの修正

```javascript
    /**
     * タブコンテンツの初期化
     */
    init() {
        this.initializeIChingEngine();
        this.initializeHexagramExtractor(); // 追加
        this.bindEvents();
    }

    /**
     * HexagramExtractorの初期化（新規追加）
     */
    initializeHexagramExtractor() {
        if (typeof HexagramExtractor !== 'undefined') {
            this.hexagramExtractor = new HexagramExtractor();
            console.log('✅ InsightsTab: HexagramExtractor initialized');
        } else {
            console.warn('⚠️ InsightsTab: HexagramExtractor not available');
        }
    }
```

#### 3. 易卦詳細情報取得メソッドの追加

```javascript
    /**
     * H384データベースから易卦の詳細情報を取得
     */
    getHexagramDetailedInsights(hexagramName, osType) {
        if (!this.hexagramExtractor) {
            return this.getFallbackInsights(hexagramName, osType);
        }

        const hexagramData = this.hexagramExtractor.getHexagramDataByName(hexagramName);
        
        if (!hexagramData || hexagramData.length === 0) {
            return this.getFallbackInsights(hexagramName, osType);
        }

        // 最初の3つの爻データを使用して洞察を生成
        const topYaos = hexagramData.slice(0, 3);
        
        return {
            keywords: this.extractKeywords(topYaos),
            interpretation: this.generateInterpretation(topYaos, osType),
            advice: this.generatePersonalizedAdvice(topYaos, osType),
            scores: this.calculateDetailedScores(topYaos)
        };
    }

    /**
     * キーワード抽出
     */
    extractKeywords(yaos) {
        const allKeywords = [];
        yaos.forEach(yao => {
            if (yao['キーワード']) {
                allKeywords.push(...yao['キーワード']);
            }
        });
        // 重複を除去して最初の5つを返す
        return [...new Set(allKeywords)].slice(0, 5);
    }

    /**
     * 解釈の生成
     */
    generateInterpretation(yaos, osType) {
        const interpretations = yaos.map(yao => yao['現代解釈の要約'] || '').filter(i => i);
        
        if (interpretations.length === 0) {
            return this.getDefaultInterpretation(osType);
        }

        // OSタイプに応じて解釈をカスタマイズ
        const osContext = {
            'engine': 'あなたの内的動機と創造性において、',
            'interface': 'あなたの社会的な関わりにおいて、',
            'safemode': 'あなたの心の安定と基盤において、'
        };

        return osContext[osType] + interpretations[0];
    }

    /**
     * パーソナライズされたアドバイス生成
     */
    generatePersonalizedAdvice(yaos, osType) {
        const advice = [];
        
        yaos.forEach((yao, index) => {
            const score = yao['S1_基本スコア'] || 50;
            const keyword = yao['キーワード'] ? yao['キーワード'][0] : '';
            
            if (score >= 70) {
                advice.push(`「${keyword}」の力を最大限に活用しましょう`);
            } else if (score >= 50) {
                advice.push(`「${keyword}」の側面をさらに発展させる余地があります`);
            } else {
                advice.push(`「${keyword}」の要素を意識的に強化することが大切です`);
            }
        });

        return advice.slice(0, 3);
    }

    /**
     * 詳細スコア計算
     */
    calculateDetailedScores(yaos) {
        const scores = {
            potential: 0,
            stability: 0,
            growth: 0
        };

        yaos.forEach(yao => {
            scores.potential += (yao['S1_基本スコア'] || 0) * 0.4;
            scores.stability += (yao['S2_関連スコア'] || 0) * 0.3;
            scores.growth += (yao['S3_状況スコア'] || 0) * 0.3;
        });

        return {
            potential: Math.round(scores.potential / yaos.length),
            stability: Math.round(scores.stability / yaos.length),
            growth: Math.round(scores.growth / yaos.length)
        };
    }
```

#### 4. 易経概要セクションの修正

```javascript
    /**
     * 易経概要セクションのレンダリング（修正版）
     */
    renderIChingOverview() {
        const { engineOS, interfaceOS, safeModeOS } = this.analysisData;
        
        // H384データベースから詳細情報を取得
        const engineInsights = this.getHexagramDetailedInsights(engineOS.hexagram.name, 'engine');
        const interfaceInsights = this.getHexagramDetailedInsights(interfaceOS.hexagram.name, 'interface');
        const safeModeInsights = this.getHexagramDetailedInsights(safeModeOS.hexagram.name, 'safemode');
        
        return `
            <div class="iching-overview-section">
                <h3 class="section-title">
                    <span class="section-icon">☯️</span>
                    易経による深層分析
                </h3>
                <div class="hexagram-grid">
                    <!-- Engine OS Card -->
                    <div class="hexagram-insight-card engine">
                        <div class="hexagram-header">
                            <div class="hexagram-symbol">${engineOS.hexagram.symbol}</div>
                            <div class="hexagram-info">
                                <h4 class="hexagram-name">${engineOS.hexagram.name}</h4>
                                <p class="hexagram-role">内なる価値観の源泉</p>
                            </div>
                        </div>
                        
                        <div class="hexagram-keywords">
                            ${engineInsights.keywords.map(keyword => 
                                `<span class="keyword-tag">${keyword}</span>`
                            ).join('')}
                        </div>
                        
                        <div class="hexagram-interpretation">
                            <p>${engineInsights.interpretation}</p>
                        </div>
                        
                        <div class="hexagram-scores">
                            <div class="score-item">
                                <span class="score-label">潜在力</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${engineInsights.scores.potential}%"></div>
                                </div>
                                <span class="score-value">${engineInsights.scores.potential}%</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">安定性</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${engineInsights.scores.stability}%"></div>
                                </div>
                                <span class="score-value">${engineInsights.scores.stability}%</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">成長性</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${engineInsights.scores.growth}%"></div>
                                </div>
                                <span class="score-value">${engineInsights.scores.growth}%</span>
                            </div>
                        </div>
                        
                        <div class="hexagram-advice">
                            <h5 class="advice-title">💡 実践的アドバイス</h5>
                            <ul class="advice-list">
                                ${engineInsights.advice.map(item => 
                                    `<li>${item}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- Interface OS Card -->
                    <div class="hexagram-insight-card interface">
                        <div class="hexagram-header">
                            <div class="hexagram-symbol">${interfaceOS.hexagram.symbol}</div>
                            <div class="hexagram-info">
                                <h4 class="hexagram-name">${interfaceOS.hexagram.name}</h4>
                                <p class="hexagram-role">社会との関わり方</p>
                            </div>
                        </div>
                        
                        <div class="hexagram-keywords">
                            ${interfaceInsights.keywords.map(keyword => 
                                `<span class="keyword-tag">${keyword}</span>`
                            ).join('')}
                        </div>
                        
                        <div class="hexagram-interpretation">
                            <p>${interfaceInsights.interpretation}</p>
                        </div>
                        
                        <div class="hexagram-scores">
                            <div class="score-item">
                                <span class="score-label">潜在力</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${interfaceInsights.scores.potential}%"></div>
                                </div>
                                <span class="score-value">${interfaceInsights.scores.potential}%</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">安定性</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${interfaceInsights.scores.stability}%"></div>
                                </div>
                                <span class="score-value">${interfaceInsights.scores.stability}%</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">成長性</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${interfaceInsights.scores.growth}%"></div>
                                </div>
                                <span class="score-value">${interfaceInsights.scores.growth}%</span>
                            </div>
                        </div>
                        
                        <div class="hexagram-advice">
                            <h5 class="advice-title">💡 実践的アドバイス</h5>
                            <ul class="advice-list">
                                ${interfaceInsights.advice.map(item => 
                                    `<li>${item}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>

                    <!-- Safe Mode OS Card -->
                    <div class="hexagram-insight-card safemode">
                        <div class="hexagram-header">
                            <div class="hexagram-symbol">${safeModeOS.hexagram.symbol}</div>
                            <div class="hexagram-info">
                                <h4 class="hexagram-name">${safeModeOS.hexagram.name}</h4>
                                <p class="hexagram-role">心の基盤と安定</p>
                            </div>
                        </div>
                        
                        <div class="hexagram-keywords">
                            ${safeModeInsights.keywords.map(keyword => 
                                `<span class="keyword-tag">${keyword}</span>`
                            ).join('')}
                        </div>
                        
                        <div class="hexagram-interpretation">
                            <p>${safeModeInsights.interpretation}</p>
                        </div>
                        
                        <div class="hexagram-scores">
                            <div class="score-item">
                                <span class="score-label">潜在力</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${safeModeInsights.scores.potential}%"></div>
                                </div>
                                <span class="score-value">${safeModeInsights.scores.potential}%</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">安定性</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${safeModeInsights.scores.stability}%"></div>
                                </div>
                                <span class="score-value">${safeModeInsights.scores.stability}%</span>
                            </div>
                            <div class="score-item">
                                <span class="score-label">成長性</span>
                                <div class="score-bar">
                                    <div class="score-fill" style="width: ${safeModeInsights.scores.growth}%"></div>
                                </div>
                                <span class="score-value">${safeModeInsights.scores.growth}%</span>
                            </div>
                        </div>
                        
                        <div class="hexagram-advice">
                            <h5 class="advice-title">💡 実践的アドバイス</h5>
                            <ul class="advice-list">
                                ${safeModeInsights.advice.map(item => 
                                    `<li>${item}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }
```

## 🎮 フェーズ3: シナリオタブのH384データベース連携

### 修正ファイル: `/public/js/components/tabs/ScenariosTab.js`

#### 1. コンストラクタとinit修正

```javascript
class ScenariosTab extends BaseTabView {
    constructor(tabId) {
        super(tabId);
        this.analysisData = null;
        this.currentScenario = null;
        this.dialogueHistory = [];
        this.simulationState = 'idle';
        this.interactionEngine = null;
        this.hexagramExtractor = null; // 追加
    }

    init() {
        this.initializeInteractionEngine();
        this.initializeHexagramExtractor(); // 追加
        this.bindEvents();
    }

    /**
     * HexagramExtractorの初期化（新規追加）
     */
    initializeHexagramExtractor() {
        if (typeof HexagramExtractor !== 'undefined') {
            this.hexagramExtractor = new HexagramExtractor();
            console.log('✅ ScenariosTab: HexagramExtractor initialized');
        } else {
            console.warn('⚠️ ScenariosTab: HexagramExtractor not available');
        }
    }
```

#### 2. データベース連携シナリオ生成

```javascript
    /**
     * H384データベースを活用したシナリオ生成
     */
    generateDataDrivenScenarios() {
        if (!this.analysisData || !this.hexagramExtractor) {
            return this.getDefaultScenarios();
        }

        const scenarios = [];
        
        // 各OSの易卦データを取得
        const engineData = this.hexagramExtractor.getHexagramDataByName(
            this.analysisData.engineOS.hexagram.name
        );
        const interfaceData = this.hexagramExtractor.getHexagramDataByName(
            this.analysisData.interfaceOS.hexagram.name
        );
        const safeModeData = this.hexagramExtractor.getHexagramDataByName(
            this.analysisData.safeModeOS.hexagram.name
        );

        // シナリオ1: 内的葛藤
        if (engineData && engineData.length > 0) {
            const engineKeywords = engineData[0]['キーワード'] || [];
            scenarios.push({
                id: 'inner-conflict',
                name: '内的葛藤の解決',
                icon: '🔥',
                description: `「${engineKeywords[0]}」と「${engineKeywords[1] || '安定'}」の間で揺れ動く心の対話`,
                participants: ['Engine OS', 'Safe Mode OS'],
                dialogue: this.generateConflictDialogue(engineData, safeModeData),
                insights: this.extractScenarioInsights(engineData, safeModeData)
            });
        }

        // シナリオ2: 社会的調和
        if (interfaceData && interfaceData.length > 0) {
            const interfaceKeywords = interfaceData[0]['キーワード'] || [];
            scenarios.push({
                id: 'social-harmony',
                name: '社会的調和の探求',
                icon: '🤝',
                description: `「${interfaceKeywords[0]}」を通じて他者との関係を深める対話`,
                participants: ['Interface OS', 'Engine OS'],
                dialogue: this.generateHarmonyDialogue(interfaceData, engineData),
                insights: this.extractScenarioInsights(interfaceData, engineData)
            });
        }

        // シナリオ3: 統合的成長
        scenarios.push({
            id: 'integrated-growth',
            name: '統合的成長への道',
            icon: '🌟',
            description: '3つのOSが協力して新たな可能性を探る対話',
            participants: ['Engine OS', 'Interface OS', 'Safe Mode OS'],
            dialogue: this.generateIntegratedDialogue(engineData, interfaceData, safeModeData),
            insights: this.extractTripleInsights(engineData, interfaceData, safeModeData)
        });

        return scenarios;
    }

    /**
     * 葛藤対話の生成
     */
    generateConflictDialogue(engineData, safeModeData) {
        const dialogue = [];
        
        if (engineData && engineData[0]) {
            const engineInterpretation = engineData[0]['現代解釈の要約'] || '';
            const engineKeyword = engineData[0]['キーワード'][0] || '創造性';
            
            dialogue.push({
                speaker: 'Engine OS',
                message: `私は「${engineKeyword}」を追求したい。${engineInterpretation.substring(0, 50)}...`,
                emotion: 'passionate'
            });
        }

        if (safeModeData && safeModeData[0]) {
            const safeModeKeyword = safeModeData[0]['キーワード'][0] || '安定';
            const safeModeInterpretation = safeModeData[0]['現代解釈の要約'] || '';
            
            dialogue.push({
                speaker: 'Safe Mode OS',
                message: `でも「${safeModeKeyword}」も大切です。${safeModeInterpretation.substring(0, 50)}...`,
                emotion: 'cautious'
            });
        }

        dialogue.push({
            speaker: 'Engine OS',
            message: 'リスクを恐れていては成長できない。新しい挑戦が必要だ。',
            emotion: 'determined'
        });

        dialogue.push({
            speaker: 'Safe Mode OS',
            message: '慎重に進むことで、持続可能な成長が可能になります。',
            emotion: 'thoughtful'
        });

        return dialogue;
    }
```

#### 3. シナリオ表示セクションの修正

```javascript
    /**
     * シナリオセレクターのレンダリング（修正版）
     */
    renderScenarioSelector() {
        const scenarios = this.generateDataDrivenScenarios(); // データ駆動型シナリオを使用
        
        return `
            <div class="scenario-selector-section">
                <h3 class="section-title">
                    <span class="section-icon">🎬</span>
                    パーソナライズされたシナリオ
                </h3>
                <p class="section-description">
                    あなたの易卦に基づいた、独自の内的対話シナリオです
                </p>
                <div class="scenario-grid">
                    ${scenarios.map(scenario => `
                        <div class="scenario-card" data-scenario="${scenario.id}">
                            <div class="scenario-header">
                                <span class="scenario-icon">${scenario.icon}</span>
                                <h4 class="scenario-name">${scenario.name}</h4>
                            </div>
                            <p class="scenario-description">${scenario.description}</p>
                            <div class="scenario-participants">
                                ${scenario.participants.map(participant => `
                                    <span class="participant-tag ${participant.toLowerCase().replace(' ', '-')}">${participant}</span>
                                `).join('')}
                            </div>
                            <div class="scenario-insights-preview">
                                <h5>主要なテーマ:</h5>
                                <ul class="theme-list">
                                    ${scenario.insights ? scenario.insights.themes.map(theme => 
                                        `<li>${theme}</li>`
                                    ).join('') : ''}
                                </ul>
                            </div>
                            <button class="scenario-start-btn" onclick="scenariosTab.startScenario('${scenario.id}')">
                                このシナリオを開始
                            </button>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }
```

## 📱 フェーズ4: スマホ向けエクスポート機能

### 修正ファイル: `/public/js/components/tabs/ExportTab.js`

#### 1. モバイル向けエクスポート形式の追加

```javascript
    /**
     * レポートテンプレートの初期化（修正版）
     */
    initializeReportTemplates() {
        // 既存のテンプレートに加えて、モバイル用を追加
        this.reportTemplates = [
            // ... 既存のテンプレート ...
            
            // モバイル向けテンプレート
            {
                id: 'mobile-card',
                name: 'モバイル結果カード',
                description: 'SNS共有用の画像カード（Instagram/Twitter）',
                icon: '📱',
                sections: ['mobile-visual'],
                format: 'image',
                mobile: true
            },
            {
                id: 'line-share',
                name: 'LINE共有用テキスト',
                description: 'LINEで送りやすい形式のテキスト',
                icon: '💬',
                sections: ['line-text'],
                format: 'text',
                mobile: true
            },
            {
                id: 'qr-code',
                name: 'QRコード保存',
                description: '結果をQRコードで保存・共有',
                icon: '📲',
                sections: ['qr'],
                format: 'qr',
                mobile: true
            }
        ];
    }
```

#### 2. モバイルエクスポートセクションの追加

```javascript
    /**
     * モバイル向けエクスポートセクション（新規追加）
     */
    renderMobileExport() {
        const isMobile = window.innerWidth <= 768;
        
        if (!isMobile) {
            return ''; // デスクトップでは表示しない
        }
        
        return `
            <div class="mobile-export-section">
                <h3 class="section-title">
                    <span class="section-icon">📱</span>
                    スマホで共有
                </h3>
                
                <!-- SNS共有カード -->
                <div class="mobile-share-card">
                    <h4>SNS共有用カード</h4>
                    <div class="share-preview" id="sharePreview">
                        ${this.generateShareCardPreview()}
                    </div>
                    <div class="share-buttons">
                        <button class="share-btn instagram" onclick="exportTab.shareToInstagram()">
                            <span class="btn-icon">📷</span>
                            Instagramストーリー
                        </button>
                        <button class="share-btn twitter" onclick="exportTab.shareToTwitter()">
                            <span class="btn-icon">🐦</span>
                            Twitterに投稿
                        </button>
                        <button class="share-btn download" onclick="exportTab.downloadAsImage()">
                            <span class="btn-icon">💾</span>
                            画像として保存
                        </button>
                    </div>
                </div>
                
                <!-- LINE共有 -->
                <div class="line-share-section">
                    <h4>LINE/メッセージで共有</h4>
                    <div class="line-text-preview" id="lineTextPreview">
                        ${this.generateLineText()}
                    </div>
                    <div class="line-buttons">
                        <button class="share-btn line" onclick="exportTab.shareToLine()">
                            <span class="btn-icon">💚</span>
                            LINEで送る
                        </button>
                        <button class="share-btn copy" onclick="exportTab.copyToClipboard()">
                            <span class="btn-icon">📋</span>
                            テキストをコピー
                        </button>
                    </div>
                </div>
                
                <!-- QRコード -->
                <div class="qr-code-section">
                    <h4>QRコードで保存</h4>
                    <div class="qr-code-container" id="qrCodeContainer">
                        <!-- QRコードをここに生成 -->
                    </div>
                    <p class="qr-description">
                        このQRコードには結果のURLが含まれています。
                        後で確認したり、友達と共有できます。
                    </p>
                    <button class="share-btn qr-save" onclick="exportTab.saveQRCode()">
                        <span class="btn-icon">📲</span>
                        QRコードを保存
                    </button>
                </div>
            </div>
        `;
    }

    /**
     * SNS共有カードのプレビュー生成
     */
    generateShareCardPreview() {
        const { engineOS, interfaceOS, safeModeOS } = this.analysisData;
        const totalScore = Math.round((engineOS.score + interfaceOS.score + safeModeOS.score) / 3);
        
        return `
            <div class="share-card-visual">
                <div class="card-header">
                    <h3 class="card-title">私のTriple OS診断結果</h3>
                    <div class="card-score">${totalScore}</div>
                </div>
                
                <div class="card-os-summary">
                    <div class="os-item">
                        <span class="os-emoji">⚡</span>
                        <span class="os-name">Engine</span>
                        <span class="os-score">${engineOS.score}</span>
                        <span class="os-hexagram">${engineOS.hexagram.symbol}</span>
                    </div>
                    <div class="os-item">
                        <span class="os-emoji">🔄</span>
                        <span class="os-name">Interface</span>
                        <span class="os-score">${interfaceOS.score}</span>
                        <span class="os-hexagram">${interfaceOS.hexagram.symbol}</span>
                    </div>
                    <div class="os-item">
                        <span class="os-emoji">🛡️</span>
                        <span class="os-name">Safe Mode</span>
                        <span class="os-score">${safeModeOS.score}</span>
                        <span class="os-hexagram">${safeModeOS.hexagram.symbol}</span>
                    </div>
                </div>
                
                <div class="card-footer">
                    <p class="card-tagline">#HAQEI #自己分析 #Triple_OS</p>
                    <p class="card-url">haqei.com</p>
                </div>
            </div>
        `;
    }

    /**
     * LINE共有用テキスト生成
     */
    generateLineText() {
        const { engineOS, interfaceOS, safeModeOS } = this.analysisData;
        const totalScore = Math.round((engineOS.score + interfaceOS.score + safeModeOS.score) / 3);
        
        return `
【HAQEI診断結果】
総合スコア: ${totalScore}点

⚡ Engine OS: ${engineOS.score}点
${engineOS.hexagram.symbol} ${engineOS.hexagram.name}

🔄 Interface OS: ${interfaceOS.score}点  
${interfaceOS.hexagram.symbol} ${interfaceOS.hexagram.name}

🛡️ Safe Mode OS: ${safeModeOS.score}点
${safeModeOS.hexagram.symbol} ${safeModeOS.hexagram.name}

詳細はこちら: https://haqei.com/results/${this.getResultId()}
        `;
    }

    /**
     * 画像として保存
     */
    async downloadAsImage() {
        const shareCard = document.getElementById('sharePreview');
        
        // html2canvasライブラリを使用（CDN追加が必要）
        if (typeof html2canvas !== 'undefined') {
            const canvas = await html2canvas(shareCard);
            const link = document.createElement('a');
            link.download = `haqei-result-${Date.now()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        } else {
            alert('画像生成機能を読み込み中です。もう一度お試しください。');
            // html2canvasを動的に読み込む
            this.loadHtml2Canvas();
        }
    }

    /**
     * LINEで共有
     */
    shareToLine() {
        const text = document.getElementById('lineTextPreview').textContent;
        const encodedText = encodeURIComponent(text);
        window.open(`https://line.me/R/msg/text/?${encodedText}`);
    }

    /**
     * クリップボードにコピー
     */
    async copyToClipboard() {
        const text = document.getElementById('lineTextPreview').textContent;
        
        try {
            await navigator.clipboard.writeText(text);
            this.showNotification('✅ テキストをコピーしました');
        } catch (err) {
            // フォールバック
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            this.showNotification('✅ テキストをコピーしました');
        }
    }

    /**
     * 通知表示
     */
    showNotification(message) {
        const notification = document.createElement('div');
        notification.className = 'copy-notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 300);
        }, 2000);
    }
```

#### 3. renderContentメソッドの修正

```javascript
    renderContent(container) {
        if (!this.analysisData) {
            this.showLoading(container);
            return;
        }

        const isMobile = window.innerWidth <= 768;

        const content = `
            <div class="export-container">
                ${this.renderHeader()}
                ${isMobile ? this.renderMobileExport() : ''} <!-- モバイル時は最初に表示 -->
                ${!isMobile ? this.renderQuickExport() : ''}
                ${!isMobile ? this.renderReportTemplates() : ''}
                ${this.renderCustomExport()}
                ${this.renderExportHistory()}
                ${!isMobile ? this.renderSharingOptions() : ''}
            </div>
        `;

        container.innerHTML = content;
        this.initializeInteractiveElements();
        
        // QRコード生成
        if (isMobile) {
            this.generateQRCode();
        }
    }
```

## 🎨 追加CSS

### 新規ファイル: `/public/css/insights-enhanced.css`

```css
/* 洞察タブの強化スタイル */
.hexagram-insight-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.hexagram-header {
    display: flex;
    align-items: center;
    gap: 16px;
    margin-bottom: 16px;
}

.hexagram-symbol {
    font-size: 48px;
    color: #1E293B;
}

.hexagram-keywords {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 16px;
}

.keyword-tag {
    padding: 4px 12px;
    background: linear-gradient(135deg, #667EEA, #764BA2);
    color: white;
    border-radius: 16px;
    font-size: 13px;
    font-weight: 500;
}

.hexagram-scores {
    margin: 16px 0;
}

.score-item {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 8px;
}

.score-label {
    width: 60px;
    font-size: 12px;
    color: #6B7280;
}

.score-bar {
    flex: 1;
    height: 8px;
    background: #E5E7EB;
    border-radius: 4px;
    overflow: hidden;
}

.score-fill {
    height: 100%;
    background: linear-gradient(90deg, #3B82F6, #8B5CF6);
    transition: width 0.6s ease;
}

.score-value {
    width: 40px;
    text-align: right;
    font-weight: 600;
    color: #1E293B;
}

.hexagram-advice {
    background: #F9FAFB;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
}

.advice-title {
    font-size: 14px;
    font-weight: 600;
    color: #1E293B;
    margin-bottom: 8px;
}

.advice-list {
    margin: 0;
    padding-left: 20px;
    font-size: 13px;
    color: #4B5563;
    line-height: 1.6;
}
```

### 新規ファイル: `/public/css/export-mobile.css`

```css
/* モバイル向けエクスポートスタイル */
.mobile-export-section {
    padding: 20px;
}

.mobile-share-card {
    background: white;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 24px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
}

.share-card-visual {
    background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
    color: white;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 16px;
}

.card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.card-title {
    font-size: 18px;
    font-weight: 600;
}

.card-score {
    font-size: 36px;
    font-weight: 700;
}

.card-os-summary {
    display: flex;
    justify-content: space-around;
    margin: 20px 0;
}

.os-item {
    text-align: center;
}

.os-emoji {
    display: block;
    font-size: 24px;
    margin-bottom: 4px;
}

.os-name {
    display: block;
    font-size: 12px;
    opacity: 0.9;
}

.os-score {
    display: block;
    font-size: 20px;
    font-weight: 600;
    margin: 4px 0;
}

.os-hexagram {
    display: block;
    font-size: 28px;
}

.card-footer {
    text-align: center;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid rgba(255, 255, 255, 0.3);
}

.card-tagline {
    font-size: 12px;
    opacity: 0.9;
    margin-bottom: 4px;
}

.card-url {
    font-size: 14px;
    font-weight: 600;
}

.share-buttons {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
}

.share-btn {
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s ease;
}

.share-btn.instagram {
    background: linear-gradient(45deg, #F58529, #DD2A7B, #8134AF, #515BD4);
    color: white;
}

.share-btn.twitter {
    background: #1DA1F2;
    color: white;
}

.share-btn.line {
    background: #00B900;
    color: white;
}

.share-btn.copy {
    background: #6B7280;
    color: white;
}

.share-btn.download {
    background: #3B82F6;
    color: white;
    grid-column: 1 / -1;
}

.line-text-preview {
    background: #F9FAFB;
    border-radius: 8px;
    padding: 16px;
    margin-bottom: 16px;
    font-family: monospace;
    font-size: 13px;
    line-height: 1.6;
    white-space: pre-wrap;
}

.qr-code-container {
    text-align: center;
    padding: 20px;
    background: white;
    border-radius: 8px;
    margin-bottom: 16px;
}

.copy-notification {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: #10B981;
    color: white;
    padding: 12px 24px;
    border-radius: 8px;
    font-size: 14px;
    font-weight: 500;
    transition: transform 0.3s ease;
    z-index: 10000;
}

.copy-notification.show {
    transform: translateX(-50%) translateY(0);
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .export-container {
        padding: 16px;
    }
    
    .share-buttons {
        grid-template-columns: 1fr;
    }
    
    .quick-export-section,
    .report-templates-section {
        display: none;
    }
}
```

## 🧪 動作確認テストコード

### 新規ファイル: `/phase3-4-test.mjs`

```javascript
import { chromium } from 'playwright';

console.log('🧪 フェーズ3-4修正確認テスト開始\n');

const browser = await chromium.launch({ 
    headless: false,
    devtools: true 
});

const context = await browser.newContext({
    viewport: { width: 390, height: 844 }, // iPhone 12サイズ
    userAgent: 'Mozilla/5.0 (iPhone; CPU iPhone OS 14_0 like Mac OS X) AppleWebKit/605.1.15'
});

const page = await context.newPage();

try {
    // サーバーにアクセス
    console.log('📱 Step 1: モバイルビューでページを開く');
    await page.goto('http://localhost:8012/public/results.html');
    await page.waitForTimeout(2000);

    // 洞察タブのテスト
    console.log('\n💡 Step 2: 洞察タブのH384データ活用確認');
    
    // 洞察タブに切り替え
    await page.evaluate(() => {
        const buttons = Array.from(document.querySelectorAll('button'));
        const insightButton = buttons.find(b => b.textContent.includes('洞察'));
        if (insightButton) insightButton.click();
    });
    
    await page.waitForTimeout(1000);
    
    const insightCheck = await page.evaluate(() => {
        return {
            hexagramExtractor: typeof window.HexagramExtractor !== 'undefined',
            keywordTags: document.querySelectorAll('.keyword-tag').length,
            scoreItems: document.querySelectorAll('.score-item').length,
            adviceLists: document.querySelectorAll('.advice-list').length,
            hasInterpretation: document.querySelector('.hexagram-interpretation')?.textContent?.length > 0
        };
    });
    
    console.log('  HexagramExtractor: ' + (insightCheck.hexagramExtractor ? '✅' : '❌'));
    console.log('  キーワードタグ数: ' + insightCheck.keywordTags);
    console.log('  スコア項目数: ' + insightCheck.scoreItems);
    console.log('  アドバイスリスト数: ' + insightCheck.adviceLists);
    console.log('  解釈テキスト: ' + (insightCheck.hasInterpretation ? '✅' : '❌'));

    // シナリオタブのテスト
    console.log('\n🎭 Step 3: シナリオタブのH384データ活用確認');
    
    await page.evaluate(() => {
        const buttons = Array.from(document.querySelectorAll('button'));
        const scenarioButton = buttons.find(b => b.textContent.includes('シナリオ'));
        if (scenarioButton) scenarioButton.click();
    });
    
    await page.waitForTimeout(1000);
    
    const scenarioCheck = await page.evaluate(() => {
        const scenarioCards = document.querySelectorAll('.scenario-card');
        const themes = document.querySelectorAll('.theme-list li');
        
        return {
            scenarioCount: scenarioCards.length,
            hasPersonalizedScenarios: Array.from(scenarioCards).some(card => 
                card.textContent.includes('キーワード') || card.textContent.includes('易卦')
            ),
            themeCount: themes.length,
            hasDialogue: document.querySelector('.dialogue-message')?.textContent?.length > 0
        };
    });
    
    console.log('  シナリオ数: ' + scenarioCheck.scenarioCount);
    console.log('  パーソナライズ: ' + (scenarioCheck.hasPersonalizedScenarios ? '✅' : '❌'));
    console.log('  テーマ数: ' + scenarioCheck.themeCount);

    // エクスポートタブのテスト（モバイル）
    console.log('\n📱 Step 4: モバイル向けエクスポート機能確認');
    
    await page.evaluate(() => {
        const buttons = Array.from(document.querySelectorAll('button'));
        const exportButton = buttons.find(b => 
            b.textContent.includes('エクスポート') || b.textContent.includes('共有')
        );
        if (exportButton) exportButton.click();
    });
    
    await page.waitForTimeout(1000);
    
    const exportCheck = await page.evaluate(() => {
        return {
            hasMobileSection: !!document.querySelector('.mobile-export-section'),
            hasShareCard: !!document.querySelector('.share-card-visual'),
            hasLineText: !!document.querySelector('.line-text-preview'),
            shareButtonCount: document.querySelectorAll('.share-btn').length,
            hasInstagramButton: !!document.querySelector('.share-btn.instagram'),
            hasLineButton: !!document.querySelector('.share-btn.line'),
            hasCopyButton: !!document.querySelector('.share-btn.copy')
        };
    });
    
    console.log('  モバイルセクション: ' + (exportCheck.hasMobileSection ? '✅' : '❌'));
    console.log('  共有カード: ' + (exportCheck.hasShareCard ? '✅' : '❌'));
    console.log('  LINE用テキスト: ' + (exportCheck.hasLineText ? '✅' : '❌'));
    console.log('  共有ボタン数: ' + exportCheck.shareButtonCount);
    console.log('  Instagram: ' + (exportCheck.hasInstagramButton ? '✅' : '❌'));
    console.log('  LINE: ' + (exportCheck.hasLineButton ? '✅' : '❌'));
    console.log('  コピー: ' + (exportCheck.hasCopyButton ? '✅' : '❌'));

    // コピー機能のテスト
    console.log('\n📋 Step 5: コピー機能テスト');
    
    const copySuccess = await page.evaluate(async () => {
        const copyButton = document.querySelector('.share-btn.copy');
        if (copyButton) {
            copyButton.click();
            await new Promise(resolve => setTimeout(resolve, 500));
            return !!document.querySelector('.copy-notification');
        }
        return false;
    });
    
    console.log('  コピー通知: ' + (copySuccess ? '✅' : '❌'));

    // スクリーンショット
    await page.screenshot({ 
        path: 'phase3-4-mobile-test.png', 
        fullPage: true 
    });
    console.log('\n📸 スクリーンショット: phase3-4-mobile-test.png');

    // 総合評価
    console.log('\n========== 評価 ==========');
    const score = {
        insights: (insightCheck.keywordTags > 0 && insightCheck.hasInterpretation) ? 30 : 0,
        scenarios: (scenarioCheck.hasPersonalizedScenarios) ? 30 : 0,
        mobileExport: (exportCheck.hasMobileSection && exportCheck.hasShareCard) ? 30 : 0,
        functionality: (copySuccess) ? 10 : 0
    };
    
    const total = Object.values(score).reduce((a, b) => a + b, 0);
    
    console.log(`洞察タブ改善: ${score.insights}/30点`);
    console.log(`シナリオタブ改善: ${score.scenarios}/30点`);
    console.log(`モバイルエクスポート: ${score.mobileExport}/30点`);
    console.log(`機能動作: ${score.functionality}/10点`);
    console.log(`総合: ${total}/100点`);
    
    if (total >= 80) {
        console.log('\n🎉 修正は成功です！');
    } else if (total >= 60) {
        console.log('\n⚠️ 部分的に修正されています');
    } else {
        console.log('\n❌ 修正が不完全です');
    }

} finally {
    console.log('\n🌐 ブラウザを開いたままにします');
    console.log('終了するには Ctrl+C を押してください');
    await new Promise(() => {});
}
```

## ✅ 実装確認チェックリスト

### 洞察タブ
- [ ] HexagramExtractorが初期化される
- [ ] 各OSカードにキーワードタグが表示される
- [ ] 潜在力・安定性・成長性のスコアバーが表示される
- [ ] H384データベースの現代解釈が表示される
- [ ] パーソナライズされたアドバイスが3つ表示される

### シナリオタブ
- [ ] 易卦データに基づいたシナリオが生成される
- [ ] キーワードを使った対話が表示される
- [ ] 主要なテーマがリスト表示される
- [ ] シナリオ開始ボタンが機能する

### エクスポートタブ（モバイル）
- [ ] モバイル表示時に専用セクションが表示される
- [ ] SNS共有用カードのプレビューが表示される
- [ ] Instagram/Twitter/LINE共有ボタンが表示される
- [ ] テキストコピー機能が動作する
- [ ] コピー成功通知が表示される

## 🚀 実装手順

1. **CSSファイルの追加**
   - `insights-enhanced.css`を作成
   - `export-mobile.css`を作成
   - results.htmlに読み込み追加

2. **JavaScriptファイルの修正**
   - InsightsTab.jsに上記コードを追加
   - ScenariosTab.jsに上記コードを追加
   - ExportTab.jsに上記コードを追加

3. **動作確認**
   ```bash
   # サーバー起動
   python3 -m http.server 8012
   
   # テスト実行
   node phase3-4-test.mjs
   ```

4. **確認ポイント**
   - 洞察タブでH384データが活用されている
   - シナリオタブでパーソナライズされたシナリオが表示される
   - モバイル表示でエクスポート機能が最適化されている

## 🎉 期待される成果

1. **データの価値最大化**
   - H384データベースの384個の爻データが活用される
   - ユーザー固有の易卦に基づいた深い洞察

2. **スマホユーザビリティ向上**
   - SNS共有が簡単に
   - LINE/メッセージアプリでの共有対応
   - モバイルファーストのUI

これで、より価値のある分析結果とスマホでの使いやすさが実現されます！