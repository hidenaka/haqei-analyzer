# TRAE向け 九宮構成段階的実装 修正作業指示書

**作成日**: 2025年8月21日  
**目的**: アコーディオン式10項目分析を維持しながら、九宮構成を段階的に実装  
**方針**: **既存機能を壊さず、並行実装によるリスク最小化**  

---

## ⚠️ 重要事項

### 現在の状況
- ✅ **アコーディオン式10項目分析が完全実装・正常動作中**
- ✅ **V3データベース連携が正常動作中**
- ❌ **九宮構成（generateNinePhaseAnalysis）は未実装**

### 実装方針
**既存のアコーディオンを削除せず、九宮構成を追加実装してから切り替える**

---

## 📋 Phase 1: 事前準備（リスク回避）

### Task 1.1: 現在の状態をバックアップ
```bash
# 重要ファイルのバックアップ作成
cp public/js/core/SummaryGenerator.js public/js/core/SummaryGenerator.backup.js
cp public/js/tabs/BasicResultsTab.js public/js/tabs/BasicResultsTab.backup.js
cp public/css/results.css public/css/results.backup.css

# バックアップ確認
ls -la public/js/core/*.backup.js
ls -la public/js/tabs/*.backup.js
ls -la public/css/*.backup.css
```

### Task 1.2: 開発モード切り替え機能の追加
**ファイル**: `/public/js/tabs/BasicResultsTab.js`

constructorの最初に追加（約25行目）:
```javascript
constructor(container) {
    super(container);
    
    // 開発モード切り替えフラグ（九宮構成テスト用）
    this.useNinePhaseLayout = false;  // ← これを追加
    
    // URLパラメータで切り替え可能にする
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('ninePhase') === 'true') {
        this.useNinePhaseLayout = true;
        console.log('🔧 九宮構成モード有効化');
    }
    
    // 以下既存のコード...
}
```

---

## 📋 Phase 2: 九宮構成の追加実装（既存機能を維持）

### Task 2.1: generateNinePhaseAnalysisメソッドの追加
**ファイル**: `/public/js/core/SummaryGenerator.js`

**重要**: `generateDetailedSummary()`メソッドは**削除しない**  
追加位置: `generateDetailedSummary()`メソッドの**後**（約87行目以降）

```javascript
/**
 * 九宮構成による詳細分析を生成（新規追加）
 * @param {Object} analysisData - 分析データ
 * @returns {Object} 九宮分析結果
 */
generateNinePhaseAnalysis(analysisData) {
    console.log('🔷 九宮構成分析開始');
    
    if (!analysisData) {
        return this.getFallbackNinePhaseAnalysis();
    }
    
    try {
        const { engineOS, interfaceOS, safeModeOS } = analysisData;
        
        // V3データ取得
        const engineV3 = this.getV3DataForOS(engineOS.hexagramName, 'engineOS');
        const interfaceV3 = this.getV3DataForOS(interfaceOS.hexagramName, 'interfaceOS');
        const safeModeV3 = this.getV3DataForOS(safeModeOS.hexagramName, 'safeModeOS');
        
        return {
            // Engine OS 3側面
            engineDrive: {
                title: '原動力',
                icon: '⚡',
                score: engineOS.score,
                content: engineV3?.profile?.type || '創造的エネルギー',
                description: engineV3?.profile?.description || 'あなたの内なる原動力の源泉',
                detail: engineV3?.normalState?.whatHappens || '積極的に新しいことに挑戦する'
            },
            engineCreativity: {
                title: '創造性',
                icon: '💡',
                score: this.calculateSubScore(engineOS.score, 'creativity'),
                content: engineV3?.normalState?.example || 'アイデアが次々と湧いてくる',
                description: '新しいものを生み出す力',
                detail: this.extractCreativityPattern(engineV3)
            },
            enginePropulsion: {
                title: '推進力',
                icon: '🚀',
                score: this.calculateSubScore(engineOS.score, 'propulsion'),
                content: engineV3?.maintenance?.tip || '定期的に新しい刺激を取り入れる',
                description: '物事を前に進める力',
                detail: this.extractPropulsionPattern(engineV3)
            },
            
            // Interface OS 3側面
            interfaceSocial: {
                title: '社会性',
                icon: '🤝',
                score: interfaceOS.score,
                content: interfaceV3?.profile?.type || '調和型',
                description: interfaceV3?.profile?.description || '周囲と調和的な関係を築く',
                detail: interfaceV3?.howToTalk?.style || '相手に配慮した話し方'
            },
            interfaceEmpathy: {
                title: '共感力',
                icon: '💖',
                score: this.calculateSubScore(interfaceOS.score, 'empathy'),
                content: interfaceV3?.relationshipTips?.empathy || '相手の気持ちを理解する',
                description: '他者を理解し寄り添う力',
                detail: this.extractEmpathyPattern(interfaceV3)
            },
            interfaceInfluence: {
                title: '影響力',
                icon: '✨',
                score: this.calculateSubScore(interfaceOS.score, 'influence'),
                content: interfaceV3?.bestEnvironment?.impact || '周囲にポジティブな影響を与える',
                description: '周りに与えるインパクト',
                detail: this.extractInfluencePattern(interfaceV3)
            },
            
            // SafeMode OS 3側面
            safeModeStability: {
                title: '安定性',
                icon: '⚖️',
                score: safeModeOS.score,
                content: safeModeV3?.profile?.type || '堅実型',
                description: safeModeV3?.profile?.description || '一貫性のある安定した基盤',
                detail: safeModeV3?.normalState?.whatHappens || '冷静に状況を見極める'
            },
            safeModeDefense: {
                title: '防御力',
                icon: '🛡️',
                score: this.calculateSubScore(safeModeOS.score, 'defense'),
                content: safeModeV3?.stressResponse?.whatYouDo || 'ストレスから自分を守る',
                description: 'リスクから身を守る力',
                detail: this.extractDefensePattern(safeModeV3)
            },
            safeModeRecovery: {
                title: '回復力',
                icon: '🌱',
                score: this.calculateSubScore(safeModeOS.score, 'recovery'),
                content: safeModeV3?.howToRecover?.bestWay || '十分な休息を取る',
                description: '立ち直る力と方法',
                detail: this.extractRecoveryPattern(safeModeV3)
            },
            
            // 統合分析
            integration: this.calculateIntegration(engineOS, interfaceOS, safeModeOS)
        };
    } catch (error) {
        console.error('❌ 九宮分析生成エラー:', error);
        return this.getFallbackNinePhaseAnalysis();
    }
}

/**
 * サブスコアを計算（新規追加）
 */
calculateSubScore(baseScore, aspect) {
    const variation = {
        creativity: 0.9,
        propulsion: 1.1,
        empathy: 0.95,
        influence: 1.05,
        defense: 0.85,
        recovery: 1.15
    };
    
    return Math.round(baseScore * (variation[aspect] || 1));
}

/**
 * 各パターンの抽出メソッド群（新規追加）
 */
extractCreativityPattern(v3Data) {
    if (!v3Data) return '創造的な思考パターンを持つ';
    return v3Data.normalState?.example || v3Data.profile?.metaphor || '新しいアイデアを生み出す';
}

extractPropulsionPattern(v3Data) {
    if (!v3Data) return '着実に前進する力を持つ';
    return v3Data.maintenance?.warning || v3Data.normalState?.whatHappens || '目標に向かって推進する';
}

extractEmpathyPattern(v3Data) {
    if (!v3Data) return '他者の感情を理解する';
    return v3Data.relationshipTips?.advice || v3Data.howToTalk?.example || '相手の立場で考える';
}

extractInfluencePattern(v3Data) {
    if (!v3Data) return '周囲に良い影響を与える';
    return v3Data.bestEnvironment?.where || v3Data.profile?.description || 'ポジティブな変化を起こす';
}

extractDefensePattern(v3Data) {
    if (!v3Data) return '自分を守る術を知っている';
    return v3Data.stressResponse?.example || v3Data.emergencyMode?.whatHappens || '冷静に対処する';
}

extractRecoveryPattern(v3Data) {
    if (!v3Data) return '自然に回復する力がある';
    return v3Data.howToRecover?.example || v3Data.howToRecover?.bestWay || '時間をかけて立ち直る';
}

/**
 * 統合分析を計算（新規追加）
 */
calculateIntegration(engineOS, interfaceOS, safeModeOS) {
    const personalHexagram = this.derivePersonalHexagram(engineOS, interfaceOS, safeModeOS);
    
    const scores = [engineOS.score, interfaceOS.score, safeModeOS.score];
    const maxScore = Math.max(...scores);
    const minScore = Math.min(...scores);
    const balance = 100 - (maxScore - minScore);
    
    const average = scores.reduce((a, b) => a + b, 0) / 3;
    const variance = scores.reduce((sum, score) => sum + Math.pow(score - average, 2), 0) / 3;
    const harmony = Math.round(100 - Math.sqrt(variance));
    
    const synergy = this.calculateSynergy(engineOS, interfaceOS, safeModeOS);
    
    return {
        hexagram: personalHexagram.name,
        hexagramDescription: personalHexagram.description,
        balance: balance,
        harmony: harmony,
        synergy: synergy,
        overallScore: Math.round((balance + harmony + synergy) / 3),
        message: this.generateIntegrationMessage(personalHexagram, balance, harmony, synergy)
    };
}

/**
 * 人格卦を導出（新規追加）
 */
derivePersonalHexagram(engineOS, interfaceOS, safeModeOS) {
    const dominant = [engineOS, interfaceOS, safeModeOS].reduce((max, os) => 
        os.score > max.score ? os : max
    );
    
    return {
        name: dominant.hexagramName,
        description: `${dominant.hexagramName}の特性が強く表れています`
    };
}

/**
 * シナジーを計算（新規追加）
 */
calculateSynergy(engineOS, interfaceOS, safeModeOS) {
    const engineInterface = this.calculatePairSynergy(engineOS, interfaceOS);
    const interfaceSafeMode = this.calculatePairSynergy(interfaceOS, safeModeOS);
    const safeModeEngine = this.calculatePairSynergy(safeModeOS, engineOS);
    
    return Math.round((engineInterface + interfaceSafeMode + safeModeEngine) / 3);
}

/**
 * ペア間のシナジーを計算（新規追加）
 */
calculatePairSynergy(os1, os2) {
    const diff = Math.abs(os1.score - os2.score);
    return Math.max(0, 100 - diff * 2);
}

/**
 * 統合メッセージを生成（新規追加）
 */
generateIntegrationMessage(hexagram, balance, harmony, synergy) {
    let message = `あなたの人格は「${hexagram.name}」的な特性を持ちます。`;
    
    if (balance >= 80) {
        message += '3つのOSが非常にバランス良く発達しています。';
    } else if (harmony >= 80) {
        message += '内面的な調和が取れた安定した人格です。';
    } else if (synergy >= 80) {
        message += '各要素が相乗効果を生み出す優れた統合性があります。';
    } else {
        message += '個性的な強みを持つ独自の人格構造です。';
    }
    
    return message;
}

/**
 * フォールバック用の九宮分析（新規追加）
 */
getFallbackNinePhaseAnalysis() {
    console.log('⚠️ 九宮分析フォールバックを使用');
    return {
        engineDrive: {
            title: '原動力',
            icon: '⚡',
            score: 70,
            content: '創造的エネルギー',
            description: 'あなたの内なる原動力',
            detail: '新しいことへの挑戦を楽しむ'
        },
        engineCreativity: {
            title: '創造性',
            icon: '💡',
            score: 68,
            content: 'アイデアが豊富',
            description: '新しいものを生み出す力',
            detail: '独創的な発想を持つ'
        },
        enginePropulsion: {
            title: '推進力',
            icon: '🚀',
            score: 72,
            content: '前進する力',
            description: '物事を進める力',
            detail: '目標に向かって進む'
        },
        interfaceSocial: {
            title: '社会性',
            icon: '🤝',
            score: 65,
            content: '調和的',
            description: '人との関わり方',
            detail: '協調性を重視'
        },
        interfaceEmpathy: {
            title: '共感力',
            icon: '💖',
            score: 70,
            content: '理解力がある',
            description: '他者への理解',
            detail: '相手の立場で考える'
        },
        interfaceInfluence: {
            title: '影響力',
            icon: '✨',
            score: 68,
            content: 'ポジティブな影響',
            description: '周囲への影響',
            detail: '良い変化を起こす'
        },
        safeModeStability: {
            title: '安定性',
            icon: '⚖️',
            score: 75,
            content: '堅実な基盤',
            description: '安定した土台',
            detail: '一貫性がある'
        },
        safeModeDefense: {
            title: '防御力',
            icon: '🛡️',
            score: 72,
            content: '自己防衛',
            description: 'リスク管理',
            detail: '慎重に対処'
        },
        safeModeRecovery: {
            title: '回復力',
            icon: '🌱',
            score: 78,
            content: '立ち直る力',
            description: '回復能力',
            detail: '時間をかけて回復'
        },
        integration: {
            hexagram: '乾為天',
            hexagramDescription: '創造的な力に満ちています',
            balance: 75,
            harmony: 70,
            synergy: 72,
            overallScore: 72,
            message: 'バランスの取れた人格構造です'
        }
    };
}
```

### Task 2.2: 九宮表示メソッドの追加
**ファイル**: `/public/js/tabs/BasicResultsTab.js`

**重要**: `renderDetailedAnalysisSection()`メソッドは**削除しない**  
追加位置: `renderDetailedAnalysisSection()`メソッドの**後**（約867行目以降）

```javascript
/**
 * 九宮分析セクションのレンダリング（新規追加）
 * @returns {string} HTML文字列
 */
renderNinePhaseSection() {
    console.log('🔷 九宮構成レンダリング開始');
    
    if (!this.summaryGenerator || !this.analysisData) {
        return '<div class="nine-phase-placeholder">分析準備中...</div>';
    }
    
    // 九宮構成のメソッドが実装されているか確認
    if (typeof this.summaryGenerator.generateNinePhaseAnalysis !== 'function') {
        console.warn('⚠️ generateNinePhaseAnalysisメソッドが未実装');
        return '';
    }
    
    const analysis = this.summaryGenerator.generateNinePhaseAnalysis(this.analysisData);
    
    return `
        <div class="nine-phase-section">
            <div class="nine-phase-header">
                <h2>📊 九宮による人格深層分析</h2>
                <p class="nine-phase-subtitle">36問の回答から導き出された9つの側面</p>
            </div>
            
            <div class="nine-phase-grid">
                <!-- Engine OS 列 -->
                <div class="phase-column engine-column">
                    <div class="column-header">
                        <h3>⚙️ Engine OS</h3>
                        <p>内なる原動力</p>
                    </div>
                    ${this.renderPhaseCard(analysis.engineDrive, 'engine')}
                    ${this.renderPhaseCard(analysis.engineCreativity, 'engine')}
                    ${this.renderPhaseCard(analysis.enginePropulsion, 'engine')}
                </div>
                
                <!-- Interface OS 列 -->
                <div class="phase-column interface-column">
                    <div class="column-header">
                        <h3>🔄 Interface OS</h3>
                        <p>社会との関わり</p>
                    </div>
                    ${this.renderPhaseCard(analysis.interfaceSocial, 'interface')}
                    ${this.renderPhaseCard(analysis.interfaceEmpathy, 'interface')}
                    ${this.renderPhaseCard(analysis.interfaceInfluence, 'interface')}
                </div>
                
                <!-- SafeMode OS 列 -->
                <div class="phase-column safemode-column">
                    <div class="column-header">
                        <h3>🛡️ SafeMode OS</h3>
                        <p>守りと回復</p>
                    </div>
                    ${this.renderPhaseCard(analysis.safeModeStability, 'safemode')}
                    ${this.renderPhaseCard(analysis.safeModeDefense, 'safemode')}
                    ${this.renderPhaseCard(analysis.safeModeRecovery, 'safemode')}
                </div>
            </div>
            
            ${this.renderIntegrationPanel(analysis.integration)}
        </div>
    `;
}

/**
 * 各フェーズカードのレンダリング（新規追加）
 */
renderPhaseCard(phaseData, osType) {
    if (!phaseData) return '';
    
    const scoreClass = this.getScoreClass(phaseData.score);
    
    return `
        <div class="phase-card phase-card-${osType}" data-score="${phaseData.score}">
            <div class="phase-card-header">
                <span class="phase-icon">${phaseData.icon}</span>
                <h4 class="phase-title">${phaseData.title}</h4>
                <span class="phase-score ${scoreClass}">${phaseData.score}pts</span>
            </div>
            <div class="phase-card-content">
                <p class="phase-main">${phaseData.content}</p>
                <p class="phase-description">${phaseData.description}</p>
            </div>
            <div class="phase-card-detail">
                <p>${phaseData.detail}</p>
            </div>
        </div>
    `;
}

/**
 * 統合パネルのレンダリング（新規追加）
 */
renderIntegrationPanel(integration) {
    if (!integration) return '';
    
    return `
        <div class="integration-panel">
            <div class="integration-header">
                <h3>🌟 統合分析 - あなたの人格卦</h3>
            </div>
            <div class="integration-content">
                <div class="hexagram-display">
                    <h4 class="hexagram-name">${integration.hexagram}</h4>
                    <p class="hexagram-description">${integration.hexagramDescription}</p>
                </div>
                
                <div class="integration-metrics">
                    <div class="metric-item">
                        <span class="metric-label">バランス</span>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: ${integration.balance}%"></div>
                        </div>
                        <span class="metric-value">${integration.balance}%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">調和</span>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: ${integration.harmony}%"></div>
                        </div>
                        <span class="metric-value">${integration.harmony}%</span>
                    </div>
                    <div class="metric-item">
                        <span class="metric-label">シナジー</span>
                        <div class="metric-bar">
                            <div class="metric-fill" style="width: ${integration.synergy}%"></div>
                        </div>
                        <span class="metric-value">${integration.synergy}%</span>
                    </div>
                </div>
                
                <div class="integration-message">
                    <p>${integration.message}</p>
                    <div class="overall-score">
                        <span>総合スコア</span>
                        <strong>${integration.overallScore}</strong>
                        <span>/ 100</span>
                    </div>
                </div>
            </div>
        </div>
    `;
}
```

### Task 2.3: 切り替えロジックの実装
**ファイル**: `/public/js/tabs/BasicResultsTab.js`

`renderTripleOSCards()`メソッド内（約230行目付近）を修正:

```javascript
renderTripleOSCards() {
    console.log('🎨 Triple OSカードを描画');
    
    const container = this.getContainer();
    if (!container) {
        console.error('❌ renderTripleOSCards: コンテナが見つかりません');
        return;
    }
    
    const { engineOS, interfaceOS, safeModeOS } = this.analysisData;
    console.log('📊 OSデータ:', { engineOS, interfaceOS, safeModeOS });
    
    // 要約データの生成
    const fourLineSummary = this.summaryGenerator ? 
        this.summaryGenerator.generateFourLineSummary(this.analysisData) : null;

    // 切り替えロジック（追加）
    let detailedAnalysisHTML = '';
    
    if (this.useNinePhaseLayout) {
        // 九宮構成を使用
        console.log('🔷 九宮構成モードで表示');
        detailedAnalysisHTML = this.renderNinePhaseSection();
    } else {
        // 既存のアコーディオンを使用
        console.log('📋 アコーディオンモードで表示');
        detailedAnalysisHTML = this.renderDetailedAnalysisSection();
    }

    container.innerHTML = `
        ${fourLineSummary ? this.renderSummarySection(fourLineSummary) : ''}
        <div class="os-cards-wrapper">
            ${this.renderEngineOSCard(engineOS)}
            ${this.renderInterfaceOSCard(interfaceOS)}
            ${this.renderSafeModeOSCard(safeModeOS)}
        </div>
        ${detailedAnalysisHTML}
    `;
    
    console.log('✅ Triple OSカード描画完了');
}
```

### Task 2.4: 九宮構成用CSSの追加
**ファイル**: `/public/css/results.css`

最後に追加（既存のCSSは削除しない）:

```css
/* ========== 九宮分析セクション（新規追加） ========== */
.nine-phase-section {
    margin-top: 3rem;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 12px;
}

.nine-phase-header {
    text-align: center;
    margin-bottom: 2rem;
}

.nine-phase-header h2 {
    color: #2c3e50;
    font-size: 1.8rem;
    margin-bottom: 0.5rem;
}

.nine-phase-subtitle {
    color: #6c757d;
    font-size: 0.95rem;
}

/* グリッドレイアウト */
.nine-phase-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 2rem;
}

/* 列ヘッダー */
.phase-column {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.column-header {
    text-align: center;
    padding: 0.75rem;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.column-header h3 {
    font-size: 1.1rem;
    margin: 0 0 0.25rem 0;
}

.column-header p {
    font-size: 0.85rem;
    color: #6c757d;
    margin: 0;
}

/* フェーズカード */
.phase-card {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    box-shadow: 0 2px 4px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    border-left: 4px solid;
}

.phase-card-engine {
    border-left-color: #FF6B6B;
}

.phase-card-interface {
    border-left-color: #4ECDC4;
}

.phase-card-safemode {
    border-left-color: #95E77E;
}

.phase-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.12);
}

.phase-card-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
}

.phase-icon {
    font-size: 1.2rem;
}

.phase-title {
    flex: 1;
    font-size: 0.95rem;
    font-weight: 600;
    margin: 0;
}

.phase-score {
    font-size: 0.85rem;
    font-weight: bold;
    padding: 0.15rem 0.5rem;
    border-radius: 12px;
    background: #f0f0f0;
}

.score-excellent {
    background: #d4edda;
    color: #155724;
}

.score-good {
    background: #cce5ff;
    color: #004085;
}

.score-moderate {
    background: #fff3cd;
    color: #856404;
}

.score-low {
    background: #f8d7da;
    color: #721c24;
}

.phase-card-content {
    margin-bottom: 0.5rem;
}

.phase-main {
    font-size: 0.9rem;
    font-weight: 500;
    color: #2c3e50;
    margin: 0 0 0.25rem 0;
}

.phase-description {
    font-size: 0.85rem;
    color: #6c757d;
    margin: 0;
}

.phase-card-detail {
    padding-top: 0.5rem;
    border-top: 1px solid #e9ecef;
}

.phase-card-detail p {
    font-size: 0.85rem;
    color: #495057;
    margin: 0;
    line-height: 1.4;
}

/* 統合パネル */
.integration-panel {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 12px;
    padding: 2rem;
    margin-top: 2rem;
}

.integration-header h3 {
    text-align: center;
    font-size: 1.4rem;
    margin: 0 0 1.5rem 0;
}

.hexagram-display {
    text-align: center;
    margin-bottom: 1.5rem;
}

.hexagram-name {
    font-size: 1.8rem;
    margin: 0 0 0.5rem 0;
}

.hexagram-description {
    font-size: 1rem;
    opacity: 0.95;
    margin: 0;
}

.integration-metrics {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
    margin-bottom: 1.5rem;
}

.metric-item {
    text-align: center;
}

.metric-label {
    display: block;
    font-size: 0.85rem;
    margin-bottom: 0.5rem;
    opacity: 0.9;
}

.metric-bar {
    height: 8px;
    background: rgba(255,255,255,0.3);
    border-radius: 4px;
    overflow: hidden;
    margin-bottom: 0.25rem;
}

.metric-fill {
    height: 100%;
    background: white;
    border-radius: 4px;
    transition: width 1s ease;
}

.metric-value {
    font-size: 1.1rem;
    font-weight: bold;
}

.integration-message {
    text-align: center;
    padding-top: 1rem;
    border-top: 1px solid rgba(255,255,255,0.3);
}

.integration-message p {
    font-size: 1rem;
    line-height: 1.5;
    margin: 0 0 1rem 0;
}

.overall-score {
    display: inline-flex;
    align-items: baseline;
    gap: 0.5rem;
    font-size: 1rem;
}

.overall-score strong {
    font-size: 2rem;
}

/* レスポンシブ対応 */
@media (max-width: 768px) {
    .nine-phase-grid {
        grid-template-columns: 1fr;
    }
    
    .integration-metrics {
        grid-template-columns: 1fr;
    }
    
    .phase-column {
        border-bottom: 2px solid #e9ecef;
        padding-bottom: 1rem;
        margin-bottom: 1rem;
    }
    
    .phase-column:last-child {
        border-bottom: none;
    }
}

@media (max-width: 480px) {
    .nine-phase-section {
        padding: 1rem;
    }
    
    .phase-card {
        padding: 0.75rem;
    }
    
    .integration-panel {
        padding: 1.5rem 1rem;
    }
}
```

---

## 🧪 Phase 3: テストと確認

### Task 3.1: 通常モードの動作確認（アコーディオン）
```bash
# 通常モードでアクセス
1. ブラウザで results.html を開く
2. 以下が表示されることを確認：
   - 4行要約
   - Triple OSカード（3枚）
   - アコーディオン式10項目分析
3. コンソールエラーがないことを確認
```

### Task 3.2: 九宮構成モードの動作確認
```bash
# 九宮構成モードでアクセス
1. ブラウザで results.html?ninePhase=true を開く
2. コンソールに「🔧 九宮構成モード有効化」が表示されることを確認
3. 以下が表示されることを確認：
   - 4行要約
   - Triple OSカード（3枚）
   - 九宮構成（3×3グリッド）
   - 統合パネル
4. コンソールエラーがないことを確認
```

### Task 3.3: 切り替えテスト
```javascript
// ブラウザコンソールで実行
// アコーディオンモードから九宮構成モードへ切り替え
window.basicResultsTab.useNinePhaseLayout = true;
window.basicResultsTab.render(document.querySelector('#basic-tab-panel'));

// 九宮構成モードからアコーディオンモードへ切り替え
window.basicResultsTab.useNinePhaseLayout = false;
window.basicResultsTab.render(document.querySelector('#basic-tab-panel'));
```

### Task 3.4: データ連携確認
```javascript
// コンソールで実行
// 九宮構成のデータ生成確認
const testData = {
    engineOS: { hexagramName: '乾為天', score: 75 },
    interfaceOS: { hexagramName: '兌為澤', score: 68 },
    safeModeOS: { hexagramName: '坤為地', score: 82 }
};

const ninePhaseData = window.basicResultsTab.summaryGenerator.generateNinePhaseAnalysis(testData);
console.log('九宮データ:', ninePhaseData);
```

---

## 📋 Phase 4: 本番切り替え準備

### Task 4.1: A/Bテスト実装（オプション）
```javascript
// BasicResultsTab.js のconstructor内
// ランダムに50%のユーザーに九宮構成を表示
this.useNinePhaseLayout = Math.random() > 0.5;
console.log(`📊 A/Bテスト: ${this.useNinePhaseLayout ? '九宮構成' : 'アコーディオン'}モード`);
```

### Task 4.2: 設定ファイルによる切り替え（オプション）
```javascript
// config.js を作成
window.HAQEI_CONFIG = {
    useNinePhaseLayout: false,  // true に変更で九宮構成有効化
    enableDevMode: true
};

// BasicResultsTab.js で参照
this.useNinePhaseLayout = window.HAQEI_CONFIG?.useNinePhaseLayout || false;
```

---

## ✅ 完了チェックリスト

### Phase 1
- [ ] バックアップファイル作成完了
- [ ] 開発モード切り替え機能追加

### Phase 2
- [ ] generateNinePhaseAnalysisメソッド追加
- [ ] renderNinePhaseSection メソッド追加
- [ ] 切り替えロジック実装
- [ ] CSS追加

### Phase 3
- [ ] 通常モード動作確認
- [ ] 九宮構成モード動作確認
- [ ] モード切り替え動作確認
- [ ] エラーなし確認

### Phase 4（オプション）
- [ ] A/Bテスト設定
- [ ] 設定ファイル作成

---

## 🚨 トラブルシューティング

### エラー1: generateNinePhaseAnalysis is not a function
**原因**: メソッドが正しく追加されていない
**解決**: SummaryGenerator.jsへの追加を確認

### エラー2: 九宮構成が表示されない
**原因**: URLパラメータが正しくない
**解決**: `?ninePhase=true` を確認

### エラー3: スタイルが適用されない
**原因**: CSSファイルの読み込みエラー
**解決**: results.cssへの追加とキャッシュクリア

---

## 📞 サポート

問題が発生した場合は、以下の情報を報告してください：
1. 使用したURL（通常 or ?ninePhase=true）
2. コンソールエラーメッセージ
3. スクリーンショット
4. 実行した手順

この段階的実装により、**既存機能を壊すリスクなく**九宮構成を実装できます。