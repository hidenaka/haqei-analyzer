# 📋 HAQEI緊急修正指示書

## 🎯 目的
仮想ユーザーインタビューで判明した「**実装済みなのに表示されていない機能**」を即座に修正

---

## 🔴 優先度1: 5分で完了する修正

### Task 1.1: DetailedAnalysisTabの修正

**ファイル**: `/public/js/components/tabs/DetailedAnalysisTab.js`

**修正箇所**: `renderContent()`メソッド内

```javascript
// 現在のコード
renderContent(container) {
    const content = `
        <div class="detailed-analysis-container">
            ${this.renderBalanceAnalysis()}
            ${this.renderRadarChart()}
            ${this.renderSynergyAnalysis()}
            ${this.renderSummary()}
        </div>
    `;
}

// 修正後（1行追加するだけ）
renderContent(container) {
    const content = `
        <div class="detailed-analysis-container">
            ${this.renderBalanceAnalysis()}
            ${this.renderRadarChart()}
            ${this.renderSynergyAnalysis()}
            ${this.renderInteractionDetails()}  // ← この行を追加！
            ${this.renderSummary()}
        </div>
    `;
}
```

**追加メソッド**:
```javascript
renderInteractionDetails() {
    if (!window.TripleOSInteractionAnalyzer) return '';
    
    const analyzer = new TripleOSInteractionAnalyzer();
    const result = analyzer.analyze(
        this.analysisData.engineOS,
        this.analysisData.interfaceOS,
        this.analysisData.safeModeOS
    );
    
    return `
        <div class="interaction-details-section" style="margin:30px 0;padding:25px;background:#f0f9ff;border-radius:16px;">
            <h3>🔄 3つの側面の相互作用</h3>
            <div class="synergy-grid" style="display:grid;gap:20px;margin:20px 0;">
                <div class="synergy-item" style="display:flex;align-items:center;gap:15px;">
                    <span>内的動機×社会性</span>
                    <div style="flex:1;height:24px;background:#e0f2fe;border-radius:12px;overflow:hidden;">
                        <div style="width:${result.synergy.engine_interface * 100}%;height:100%;background:linear-gradient(90deg,#0ea5e9,#0284c7);"></div>
                    </div>
                    <span>${Math.round(result.synergy.engine_interface * 100)}%</span>
                </div>
                <div class="synergy-item" style="display:flex;align-items:center;gap:15px;">
                    <span>内的動機×安定性</span>
                    <div style="flex:1;height:24px;background:#e0f2fe;border-radius:12px;overflow:hidden;">
                        <div style="width:${result.synergy.engine_safe * 100}%;height:100%;background:linear-gradient(90deg,#0ea5e9,#0284c7);"></div>
                    </div>
                    <span>${Math.round(result.synergy.engine_safe * 100)}%</span>
                </div>
                <div class="synergy-item" style="display:flex;align-items:center;gap:15px;">
                    <span>社会性×安定性</span>
                    <div style="flex:1;height:24px;background:#e0f2fe;border-radius:12px;overflow:hidden;">
                        <div style="width:${result.synergy.interface_safe * 100}%;height:100%;background:linear-gradient(90deg,#0ea5e9,#0284c7);"></div>
                    </div>
                    <span>${Math.round(result.synergy.interface_safe * 100)}%</span>
                </div>
            </div>
        </div>
    `;
}
```

### Task 1.2: BasicResultsTabの修正

**ファイル**: `/public/js/components/tabs/BasicResultsTab.js`

**修正箇所**: `renderContent()`メソッド内

```javascript
// 現在のコード
renderContent(container) {
    const content = `
        <div class="basic-results-container">
            ${this.renderOSCards()}
            ${this.renderSummary()}
        </div>
    `;
}

// 修正後（1行追加するだけ）
renderContent(container) {
    const content = `
        <div class="basic-results-container">
            ${this.renderOSCards()}
            ${this.renderHistoricalComparison()}  // ← この行を追加！
            ${this.renderSummary()}
        </div>
    `;
}
```

**追加メソッド**:
```javascript
renderHistoricalComparison() {
    const storageManager = new StorageManager();
    const previous = storageManager.getPreviousAnalysisResult();
    
    if (!previous) return '';
    
    const current = this.analysisData;
    const changes = {
        engineOS: current.engineOS.score - previous.engineOS.score,
        interfaceOS: current.interfaceOS.score - previous.interfaceOS.score,
        safeModeOS: current.safeModeOS.score - previous.safeModeOS.score
    };
    
    return `
        <div style="margin:20px 0;padding:20px;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:12px;color:white;">
            <h4>📊 前回からの変化</h4>
            <div style="display:grid;gap:15px;margin:15px 0;">
                <div style="display:flex;justify-content:space-between;padding:10px;background:rgba(255,255,255,0.1);border-radius:8px;">
                    <span>Engine OS（内的動機）</span>
                    <span style="color:${changes.engineOS >= 0 ? '#4ade80' : '#f87171'};font-weight:bold;">
                        ${changes.engineOS >= 0 ? '↑' : '↓'} ${Math.abs(changes.engineOS).toFixed(1)}%
                    </span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:10px;background:rgba(255,255,255,0.1);border-radius:8px;">
                    <span>Interface OS（社会性）</span>
                    <span style="color:${changes.interfaceOS >= 0 ? '#4ade80' : '#f87171'};font-weight:bold;">
                        ${changes.interfaceOS >= 0 ? '↑' : '↓'} ${Math.abs(changes.interfaceOS).toFixed(1)}%
                    </span>
                </div>
                <div style="display:flex;justify-content:space-between;padding:10px;background:rgba(255,255,255,0.1);border-radius:8px;">
                    <span>Safe Mode OS（安定性）</span>
                    <span style="color:${changes.safeModeOS >= 0 ? '#4ade80' : '#f87171'};font-weight:bold;">
                        ${changes.safeModeOS >= 0 ? '↑' : '↓'} ${Math.abs(changes.safeModeOS).toFixed(1)}%
                    </span>
                </div>
            </div>
            <p style="opacity:0.8;font-size:0.9em;">前回: ${new Date(previous.timestamp).toLocaleDateString('ja-JP')}</p>
        </div>
    `;
}
```

---

## 🟡 優先度2: 理解しやすさ改善（30分）

### Task 2.1: 専門用語の日本語化

**全タブ共通**: OS名に日本語説明を追加

```javascript
// 各タブのrenderOSCards()などで使用
const OS_NAMES = {
    'Engine OS': 'Engine OS（内的動機）',
    'Interface OS': 'Interface OS（社会性）',
    'Safe Mode OS': 'Safe Mode OS（安定性）'
};

// 易経用語にツールチップ
<span title="こう - 卦を構成する6本の線">爻</span>
<span title="か - 易経の基本シンボル">卦</span>
```

### Task 2.2: InsightsTabの現在段階を強調

**ファイル**: `/public/js/components/tabs/InsightsTab.js`

既存の`stage-item.active`クラスにCSSを追加:

```css
.stage-item.active {
    background: linear-gradient(135deg, #fbbf24, #f59e0b) !important;
    color: white !important;
    transform: scale(1.05);
    box-shadow: 0 10px 25px rgba(245, 158, 11, 0.3);
    border: 2px solid #f59e0b;
}
```

---

## ✅ 動作確認手順

1. **ブラウザで開く**: `public/results.html`
2. **コンソールで確認**:
```javascript
// TripleOSInteractionAnalyzerの存在確認
console.log(typeof TripleOSInteractionAnalyzer);  // "function"が表示されればOK

// 履歴データの確認
console.log(new StorageManager().getPreviousAnalysisResult());  // データが表示されればOK
```

3. **表示確認**:
- DetailedAnalysisTabに「3つの側面の相互作用」が表示される
- BasicResultsTabに「前回からの変化」が表示される（2回目以降）

---

## ⚠️ 注意事項

- **インラインスタイルを使用**してCSSファイル作成を回避
- **既存メソッドを上書きしない**（追加のみ）
- **window.オブジェクトの存在確認**を必ず行う

---

## 📊 期待される効果

### ユーザーフィードバックの改善
- 「TripleOSの相互作用が見えない」→ ✅ 表示される
- 「前回との比較がない」→ ✅ 表示される
- 「専門用語が分からない」→ ✅ 日本語説明付き

### 実装コスト
- 優先度1: **5分**（コード2行追加）
- 優先度2: **30分**（表示改善）
- 合計: **35分以内で完了**

---

## 🚀 実装開始

1. まず**優先度1の2つの修正**を行う（5分）
2. ブラウザで動作確認
3. 問題なければ優先度2へ進む

**この指示書の内容で不明な点があれば、`/20250119_TRAE実装指示書_既存システム活用版.md`を参照してください。**