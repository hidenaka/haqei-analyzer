# ğŸ—ï¸ 384çˆ»ã‚·ã‚¹ãƒ†ãƒ  Edgeåˆ¶ç´„å¯¾å¿œã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

**æ–‡æ›¸ç•ªå·**: SD-384-EC-001  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0ï¼ˆEdgeåˆ¶ç´„å¯¾å¿œç‰ˆï¼‰  
**ä½œæˆæ—¥**: 2025å¹´8æœˆ28æ—¥  
**ä½œæˆè€…**: HAQEIé–‹ç™ºãƒãƒ¼ãƒ   
**æ‰¿èªè€…**: [æœªæ‰¿èª]

---

## 1. ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

### 1.1 å­¦ç¿’/æ¨è«–åˆ†é›¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              384çˆ» Edgeåˆ¶ç´„å¯¾å¿œã‚·ã‚¹ãƒ†ãƒ                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    ãƒ¦ãƒ¼ã‚¶ãƒ¼å±¤                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚ãƒ–ãƒ©ã‚¦ã‚¶UI     â”‚ â”‚Service       â”‚ â”‚IndexedDB     â”‚     â”‚
â”‚  â”‚(React/Vue)    â”‚ â”‚Worker        â”‚ â”‚ãƒ­ãƒ¼ã‚«ãƒ«Cache â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              Edgeæ¨è«–å±¤ï¼ˆCloudflareï¼‰                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚       è»½é‡æ¨è«–ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆ45msä»¥å†…å‡¦ç†ï¼‰                â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚    â”‚
â”‚  â”‚  â”‚æ­£è¦è¡¨ç¾   â”‚ â”‚åœ§ç¸®è¾æ›¸  â”‚ â”‚è»½é‡      â”‚         â”‚    â”‚
â”‚  â”‚  â”‚å½¢æ…‹ç´ è§£æ â”‚ â”‚é¡ç¾©èª    â”‚ â”‚ãƒ™ã‚¯ãƒˆãƒ«  â”‚         â”‚    â”‚
â”‚  â”‚  â”‚(5ms)     â”‚ â”‚(3ms)     â”‚ â”‚(10ms)    â”‚         â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚    â”‚
â”‚  â”‚  â”‚    é«˜é€Ÿã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆäº‹å‰è¨ˆç®—æ¸ˆã¿ï¼‰           â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  ãƒ»ãƒ«ãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ2msï¼‰              â”‚ â”‚    â”‚
â”‚  â”‚  â”‚  ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡85%ä»¥ä¸Š                â”‚ â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            Cloudflare Storageå±¤ï¼ˆåˆ¶é™å†…ï¼‰                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚D1 DB     â”‚ â”‚Workers KVâ”‚ â”‚R2 Storageâ”‚ â”‚Cache API â”‚  â”‚
â”‚  â”‚45MBÃ—2    â”‚ â”‚10MB      â”‚ â”‚ãƒ¢ãƒ‡ãƒ«    â”‚ â”‚çµæœCache â”‚  â”‚
â”‚  â”‚384çˆ»åŸºæœ¬ â”‚ â”‚é »å‡ºCache â”‚ â”‚5MBåœ§ç¸®   â”‚ â”‚1MB       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å­¦ç¿’å±¤ï¼ˆåˆ¥ã‚¤ãƒ³ãƒ•ãƒ©ï¼‰                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  GPU/TPUã‚µãƒ¼ãƒãƒ¼ï¼ˆAWS SageMaker / GCP ML Engineï¼‰   â”‚    â”‚
â”‚  â”‚  ãƒ»æ—¥æ¬¡ãƒãƒƒãƒå­¦ç¿’ï¼ˆæ·±å¤œ2-4æ™‚ï¼‰                      â”‚    â”‚
â”‚  â”‚  ãƒ»ãƒ•ãƒ«ã‚µã‚¤ã‚ºãƒ¢ãƒ‡ãƒ«è¨“ç·´                             â”‚    â”‚
â”‚  â”‚  ãƒ»ãƒ¢ãƒ‡ãƒ«åœ§ç¸®ãƒ»é‡å­åŒ–                               â”‚    â”‚
â”‚  â”‚  ãƒ»CDNçµŒç”±ã§Edgeã¸é…ä¿¡                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 åˆ¶ç´„å¯¾å¿œè¨­è¨ˆåŸå‰‡

```yaml
è¨­è¨ˆåŸå‰‡:
  Edgeå„ªå…ˆ:
    - æ¨è«–å‡¦ç†ã®ã¿Edgeå®Ÿè¡Œ
    - å­¦ç¿’ã¯ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰åˆ†é›¢
    - ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ
    
  è»½é‡åŒ–:
    - ãƒ¢ãƒ‡ãƒ«åœ§ç¸®ï¼ˆ5MBä»¥ä¸‹ï¼‰
    - è¾æ›¸åœ§ç¸®ï¼ˆ1MBä»¥ä¸‹ï¼‰
    - ãƒ™ã‚¯ãƒˆãƒ«æ¬¡å…ƒå‰Šæ¸›ï¼ˆ300â†’50æ¬¡å…ƒï¼‰
    
  åˆ†å‰²é…ä¿¡:
    - ãƒ‡ãƒ¼ã‚¿åˆ†å‰²æ ¼ç´
    - é…å»¶ãƒ­ãƒ¼ãƒ‰
    - CDNæ´»ç”¨
    
  ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯:
    - 3æ®µéšã®ã‚°ãƒ¬ãƒ¼ã‚¹ãƒ•ãƒ«ãƒ‡ã‚°ãƒ¬ãƒ¼ãƒ‰
    - ã‚ªãƒ•ãƒ©ã‚¤ãƒ³å¯¾å¿œ
    - ç°¡æ˜“ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°
```

---

## 2. ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆï¼ˆEdgeæœ€é©åŒ–ï¼‰

### 2.1 D1 Databaseè¨­è¨ˆï¼ˆåˆ†å‰²æ§‹æˆï¼‰

```sql
-- DB1: åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ (25MB)
CREATE TABLE lines_384_core (
    line_id INTEGER PRIMARY KEY,           -- 1-384
    hexagram_id INTEGER NOT NULL,          -- 1-64
    line_position INTEGER NOT NULL,        -- 1-6
    hexagram_name TEXT NOT NULL,
    
    -- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãƒ‡ãƒ¼ã‚¿
    shin_data TEXT,                        -- åœ§ç¸®æ¸ˆã¿
    hen_data TEXT,                         -- åœ§ç¸®æ¸ˆã¿
    keywords TEXT,                         -- JSONé…åˆ—
    
    -- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
    INDEX idx_hexagram (hexagram_id),
    INDEX idx_keywords (keywords)
);

-- DB2: æ‹¡å¼µãƒ‡ãƒ¼ã‚¿ (20MB)
CREATE TABLE lines_384_extended (
    line_id INTEGER PRIMARY KEY,
    summary TEXT,                          -- è¦ç´„ç‰ˆçˆ»è¾
    traits TEXT,                           -- ç°¡ç•¥åŒ–ç‰¹æ€§
    vector_50d BLOB                       -- åœ§ç¸®ãƒ™ã‚¯ãƒˆãƒ«
);

-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†ï¼ˆéåŒæœŸï¼‰
CREATE TABLE feedback_queue (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id TEXT,
    input_hash TEXT,
    predicted_line INTEGER,
    timestamp INTEGER,
    synced INTEGER DEFAULT 0
);
```

### 2.2 Workers KVè¨­è¨ˆï¼ˆé«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‰

```javascript
// ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ§‹é€ ï¼ˆ10MBåˆ¶é™å†…ï¼‰
const KV_STRUCTURE = {
    // é »å‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆ5MBï¼‰
    "cache:pattern:{hash}": {
        result: { line_id: 1, confidence: 0.92 },
        ttl: 86400  // 24æ™‚é–“
    },
    
    // åœ§ç¸®è¾æ›¸ï¼ˆ3MBï¼‰
    "dict:synonyms": {
        "ãƒªãƒ¼ãƒ€ãƒ¼": ["æŒ‡å°è€…", "çµ±ç‡è€…"],
        "å¤‰åŒ–": ["å¤‰å‹•", "æ¨ç§»", "å¤‰å®¹"],
        // ... é »å‡º1000èªã®ã¿
    },
    
    // è»½é‡ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ2MBï¼‰
    "vectors:compressed": {
        version: "v1.0",
        dimensions: 50,
        data: "base64_encoded_binary"
    }
};
```

### 2.3 R2 Storageï¼ˆãƒ¢ãƒ‡ãƒ«é…ä¿¡ï¼‰

```yaml
ãƒ¢ãƒ‡ãƒ«æ§‹æˆ:
  inference_model_v1.wasm:
    - WebAssemblyæ¨è«–ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆ2MBï¼‰
    - SIMDæœ€é©åŒ–æ¸ˆã¿
    
  vectors_384_50d.bin:
    - 384çˆ»ã®50æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ï¼ˆ2MBï¼‰
    - Float16é‡å­åŒ–
    
  lookup_tables.json:
    - äº‹å‰è¨ˆç®—ã‚¹ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆ1MBï¼‰
    - gzipåœ§ç¸®
```

---

## 3. è»½é‡NLPå®Ÿè£…

### 3.1 æ­£è¦è¡¨ç¾ãƒ™ãƒ¼ã‚¹å½¢æ…‹ç´ è§£æ

```javascript
class LightweightMorphemeAnalyzer {
    constructor() {
        // æ˜“çµŒå°‚é–€ãƒ‘ã‚¿ãƒ¼ãƒ³å„ªå…ˆ
        this.patterns = [
            { regex: /ä¹¾ç‚ºå¤©|å¤ç‚ºåœ°|æ°´é›·å±¯/g, type: 'hexagram' },
            { regex: /åˆä¹|ä¹äºŒ|ä¹ä¸‰|ä¹å››|ä¹äº”|ä¸Šä¹/g, type: 'line' },
            { regex: /é™½çˆ»|é™°çˆ»|å¤‰çˆ»/g, type: 'yao' },
            { regex: /[ä¸€-é¾¥]+/g, type: 'kanji' },
            { regex: /[ã-ã‚“]+/g, type: 'hiragana' },
            { regex: /[ã‚¡-ãƒ¶]+/g, type: 'katakana' }
        ];
        
        // é »å‡º5000èªè¾æ›¸ï¼ˆåœ§ç¸®å½¢å¼ï¼‰
        this.dictionary = new CompressedDictionary();
    }
    
    async analyze(text, timeLimit = 10) {
        const startTime = performance.now();
        const tokens = [];
        
        // å°‚é–€ç”¨èªå„ªå…ˆãƒãƒƒãƒãƒ³ã‚°
        for (const pattern of this.patterns) {
            if (performance.now() - startTime > timeLimit) break;
            
            const matches = text.matchAll(pattern.regex);
            for (const match of matches) {
                tokens.push({
                    surface: match[0],
                    type: pattern.type,
                    position: match.index
                });
            }
        }
        
        // é‡è¤‡é™¤å»ã¨ä½ç½®ã‚½ãƒ¼ãƒˆ
        return this.deduplicateTokens(tokens);
    }
}
```

### 3.2 åœ§ç¸®é¡ç¾©èªå‡¦ç†

```javascript
class CompressedSynonymProcessor {
    constructor() {
        this.synonymMap = null;
        this.loadPromise = this.loadSynonyms();
    }
    
    async loadSynonyms() {
        // Workers KVã‹ã‚‰åœ§ç¸®è¾æ›¸å–å¾—
        const compressed = await env.KV.get('dict:synonyms', 'arrayBuffer');
        this.synonymMap = await this.decompress(compressed);
    }
    
    async expand(keyword, maxSynonyms = 5) {
        await this.loadPromise;
        
        // ç›´æ¥ãƒãƒƒãƒ—æ¤œç´¢ï¼ˆO(1)ï¼‰
        const synonyms = this.synonymMap[keyword] || [];
        
        // ç·¨é›†è·é›¢ã«ã‚ˆã‚‹è¿½åŠ å€™è£œï¼ˆè»½é‡ï¼‰
        if (synonyms.length < maxSynonyms) {
            const similar = this.findSimilarWords(keyword, maxSynonyms - synonyms.length);
            synonyms.push(...similar);
        }
        
        return synonyms.slice(0, maxSynonyms);
    }
    
    findSimilarWords(word, limit) {
        // Levenshteinè·é›¢ã®ç°¡æ˜“å®Ÿè£…
        const candidates = [];
        const maxDistance = Math.min(2, word.length / 3);
        
        for (const [key, _] of Object.entries(this.synonymMap)) {
            if (this.editDistance(word, key) <= maxDistance) {
                candidates.push(key);
                if (candidates.length >= limit) break;
            }
        }
        
        return candidates;
    }
}
```

### 3.3 è»½é‡ãƒ™ã‚¯ãƒˆãƒ«å‡¦ç†

```javascript
class LightweightVectorProcessor {
    constructor() {
        this.vectors = null;
        this.dimensions = 50;  // åœ§ç¸®æ¸ˆã¿æ¬¡å…ƒ
    }
    
    async initialize() {
        // R2ã‹ã‚‰åœ§ç¸®ãƒ™ã‚¯ãƒˆãƒ«å–å¾—
        const response = await fetch('/models/vectors_384_50d.bin');
        const buffer = await response.arrayBuffer();
        
        // Float16 â†’ Float32å¤‰æ›
        this.vectors = new Float32Array(384 * this.dimensions);
        const view = new DataView(buffer);
        
        for (let i = 0; i < this.vectors.length; i++) {
            this.vectors[i] = this.float16ToFloat32(view.getUint16(i * 2, true));
        }
    }
    
    async findSimilar(inputVector, topK = 10) {
        const similarities = new Float32Array(384);
        
        // SIMDæœ€é©åŒ–å†…ç©è¨ˆç®—
        for (let i = 0; i < 384; i++) {
            const offset = i * this.dimensions;
            similarities[i] = this.simdDotProduct(
                inputVector,
                this.vectors.subarray(offset, offset + this.dimensions)
            );
        }
        
        // Top-Ké¸æŠï¼ˆãƒ’ãƒ¼ãƒ—ä½¿ç”¨ï¼‰
        return this.selectTopK(similarities, topK);
    }
    
    simdDotProduct(a, b) {
        // WebAssembly SIMDæ´»ç”¨
        if (typeof WebAssembly.SIMD !== 'undefined') {
            return wasmSIMD.dotProduct(a, b);
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…
        let sum = 0;
        for (let i = 0; i < a.length; i++) {
            sum += a[i] * b[i];
        }
        return sum;
    }
}
```

---

## 4. ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚¨ãƒ³ã‚¸ãƒ³ï¼ˆEdgeæœ€é©åŒ–ï¼‰

### 4.1 é«˜é€Ÿè¤‡åˆã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°

```javascript
class EdgeOptimizedScorer {
    constructor() {
        this.weights = {
            keyword_match: 0.35,    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´
            synonym_match: 0.25,    // é¡ç¾©èªä¸€è‡´
            vector_similarity: 0.25, // ãƒ™ã‚¯ãƒˆãƒ«é¡ä¼¼åº¦
            pattern_cache: 0.15    // ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚­ãƒ£ãƒƒã‚·ãƒ¥
        };
        
        this.cache = new Map();
        this.maxCacheSize = 10000;
    }
    
    async score(input) {
        const startTime = performance.now();
        
        // 1. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªï¼ˆ1msï¼‰
        const cacheKey = this.hashInput(input);
        if (this.cache.has(cacheKey)) {
            return this.cache.get(cacheKey);
        }
        
        // 2. ä¸¦åˆ—å‡¦ç†ã§å„ã‚¹ã‚³ã‚¢è¨ˆç®—
        const [keywords, synonyms, vector] = await Promise.all([
            this.extractKeywords(input),      // 5ms
            this.expandSynonyms(input),       // 3ms
            this.computeVector(input)          // 10ms
        ]);
        
        // 3. äº‹å‰è¨ˆç®—ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§ï¼ˆ2msï¼‰
        const scores = await this.lookupScores(keywords, synonyms, vector);
        
        // 4. æœ€çµ‚ã‚¹ã‚³ã‚¢è¨ˆç®—ï¼ˆ1msï¼‰
        const result = this.combineScores(scores);
        
        // 5. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
        this.updateCache(cacheKey, result);
        
        // å‡¦ç†æ™‚é–“ç¢ºèª
        const elapsed = performance.now() - startTime;
        if (elapsed > 45) {
            console.warn(`Scoring took ${elapsed}ms - optimization needed`);
        }
        
        return result;
    }
    
    async lookupScores(keywords, synonyms, vector) {
        // äº‹å‰è¨ˆç®—æ¸ˆã¿ã‚¹ã‚³ã‚¢ãƒ†ãƒ¼ãƒ–ãƒ«å‚ç…§
        const lookupTable = await this.getLookupTable();
        const scores = new Float32Array(384);
        
        for (let i = 0; i < 384; i++) {
            // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚¹ã‚³ã‚¢ï¼ˆãƒãƒƒã‚·ãƒ¥ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰
            const kwScore = this.keywordScore(keywords, lookupTable.keywords[i]);
            
            // é¡ç¾©èªã‚¹ã‚³ã‚¢ï¼ˆãƒ“ãƒƒãƒˆãƒãƒƒãƒ—ï¼‰
            const synScore = this.synonymScore(synonyms, lookupTable.synonyms[i]);
            
            // ãƒ™ã‚¯ãƒˆãƒ«ã‚¹ã‚³ã‚¢ï¼ˆäº‹å‰è¨ˆç®—æ¸ˆã¿ï¼‰
            const vecScore = lookupTable.vectors[i];
            
            scores[i] = kwScore * this.weights.keyword_match +
                       synScore * this.weights.synonym_match +
                       vecScore * this.weights.vector_similarity;
        }
        
        return scores;
    }
}
```

### 4.2 ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆ¦ç•¥

```javascript
class FallbackStrategy {
    async executeWithFallback(input) {
        try {
            // ãƒ¬ãƒ™ãƒ«1: ãƒ•ãƒ«æ©Ÿèƒ½ï¼ˆ30msç›®æ¨™ï¼‰
            return await this.fullScoring(input);
        } catch (error) {
            console.warn('Falling back to simplified scoring:', error);
            
            try {
                // ãƒ¬ãƒ™ãƒ«2: ç°¡æ˜“ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ï¼ˆ10msï¼‰
                return await this.simplifiedScoring(input);
            } catch (error2) {
                console.warn('Falling back to rule-based:', error2);
                
                // ãƒ¬ãƒ™ãƒ«3: ãƒ«ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹ï¼ˆ5msï¼‰
                return this.ruleBasedScoring(input);
            }
        }
    }
    
    async simplifiedScoring(input) {
        // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒãƒã®ã¿
        const keywords = this.extractBasicKeywords(input);
        return this.matchKeywords(keywords);
    }
    
    ruleBasedScoring(input) {
        // å›ºå®šãƒ«ãƒ¼ãƒ«
        if (input.includes('ãƒªãƒ¼ãƒ€ãƒ¼')) return { line_id: 1, confidence: 0.7 };
        if (input.includes('å§‹ã¾ã‚Š')) return { line_id: 1, confidence: 0.6 };
        // ... ãã®ä»–ã®ãƒ«ãƒ¼ãƒ«
        return { line_id: 1, confidence: 0.5 }; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }
}
```

---

## 5. ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 

### 5.1 å­¦ç¿’ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼‰

```python
# backend/training_pipeline.py
class OfflineTrainingPipeline:
    def __init__(self):
        self.model = None
        self.training_data = []
        self.validation_data = []
    
    async def daily_batch_training(self):
        """æ—¥æ¬¡ãƒãƒƒãƒå­¦ç¿’ï¼ˆæ·±å¤œ2-4æ™‚å®Ÿè¡Œï¼‰"""
        
        # 1. Edgeã‹ã‚‰ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†
        feedbacks = await self.collect_feedbacks_from_edge()
        
        # 2. ãƒ‡ãƒ¼ã‚¿æº–å‚™
        self.prepare_training_data(feedbacks)
        
        # 3. ãƒ•ãƒ«ãƒ¢ãƒ‡ãƒ«è¨“ç·´
        full_model = await self.train_full_model(
            epochs=100,
            batch_size=32,
            learning_rate=0.001
        )
        
        # 4. ãƒ¢ãƒ‡ãƒ«åœ§ç¸®
        compressed_model = await self.compress_model(
            full_model,
            target_size_mb=5,
            quantization='int8'
        )
        
        # 5. æ¤œè¨¼
        metrics = await self.validate_model(compressed_model)
        
        # 6. ãƒ‡ãƒ—ãƒ­ã‚¤åˆ¤å®š
        if metrics['accuracy'] > 0.85:
            await self.deploy_to_edge(compressed_model)
    
    async def compress_model(self, model, target_size_mb, quantization):
        """ãƒ¢ãƒ‡ãƒ«åœ§ç¸®å‡¦ç†"""
        compressed = model
        
        # é‡å­åŒ–
        if quantization == 'int8':
            compressed = self.quantize_to_int8(compressed)
        
        # ãƒ—ãƒ«ãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆæåˆˆã‚Šï¼‰
        compressed = self.prune_weights(compressed, sparsity=0.5)
        
        # çŸ¥è­˜è’¸ç•™
        compressed = self.knowledge_distillation(
            teacher=model,
            student=compressed
        )
        
        # WebAssemblyå¤‰æ›
        wasm_model = self.convert_to_wasm(compressed)
        
        return wasm_model
    
    async def deploy_to_edge(self, model):
        """CDNçµŒç”±ã§Edgeã¸ãƒ‡ãƒ—ãƒ­ã‚¤"""
        
        # ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°
        version = f"v{datetime.now().strftime('%Y%m%d_%H%M%S')}"
        
        # R2ã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        await self.upload_to_r2(model, version)
        
        # Workers KVãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿æ›´æ–°
        await self.update_kv_metadata(version)
        
        # ã‚«ãƒŠãƒªã‚¢ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆ5% â†’ 25% â†’ 100%ï¼‰
        await self.canary_deployment(version)
```

### 5.2 ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†

```javascript
// edge/feedback_collector.js
class FeedbackCollector {
    async collectAndBuffer(prediction, actual = null) {
        const feedback = {
            session_id: this.getSessionId(),
            input_hash: this.hashInput(prediction.input),
            predicted_line: prediction.line_id,
            confidence: prediction.confidence,
            actual_line: actual,
            timestamp: Date.now()
        };
        
        // D1ã«éåŒæœŸä¿å­˜
        await env.DB.prepare(
            'INSERT INTO feedback_queue (session_id, input_hash, predicted_line, timestamp) VALUES (?, ?, ?, ?)'
        ).bind(
            feedback.session_id,
            feedback.input_hash, 
            feedback.predicted_line,
            feedback.timestamp
        ).run();
        
        // ãƒãƒƒãƒã‚µã‚¤ã‚ºåˆ°é”æ™‚ã«ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é€ä¿¡
        const count = await this.getFeedbackCount();
        if (count >= 100) {
            await this.flushToBackend();
        }
    }
    
    async flushToBackend() {
        const feedbacks = await env.DB.prepare(
            'SELECT * FROM feedback_queue WHERE synced = 0 LIMIT 1000'
        ).all();
        
        if (feedbacks.results.length > 0) {
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIã¸é€ä¿¡
            await fetch('https://ml-backend.example.com/feedbacks', {
                method: 'POST',
                body: JSON.stringify(feedbacks.results)
            });
            
            // é€ä¿¡æ¸ˆã¿ãƒãƒ¼ã‚¯
            await env.DB.prepare(
                'UPDATE feedback_queue SET synced = 1 WHERE id IN (' +
                feedbacks.results.map(f => f.id).join(',') + ')'
            ).run();
        }
    }
}
```

---

## 6. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 6.1 ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°æˆ¦ç•¥

```javascript
class MultiLevelCache {
    constructor() {
        this.l1 = new Map();           // ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹å†…ï¼‰
        this.l1MaxSize = 1000;
        this.l2 = env.KV;              // Workers KVï¼ˆã‚¨ãƒƒã‚¸å…¨ä½“ï¼‰
        this.l3 = caches.default;      // Cache APIï¼ˆCDNï¼‰
    }
    
    async get(key) {
        // L1: ãƒ¡ãƒ¢ãƒªï¼ˆ0msï¼‰
        if (this.l1.has(key)) {
            return { data: this.l1.get(key), source: 'memory' };
        }
        
        // L2: Workers KVï¼ˆ5msï¼‰
        const kvData = await this.l2.get(key, 'json');
        if (kvData) {
            this.l1.set(key, kvData);
            return { data: kvData, source: 'kv' };
        }
        
        // L3: Cache APIï¼ˆ10msï¼‰
        const cacheResponse = await this.l3.match(key);
        if (cacheResponse) {
            const data = await cacheResponse.json();
            await this.promote(key, data);
            return { data, source: 'cache' };
        }
        
        return null;
    }
    
    async set(key, value, ttl = 3600) {
        // å…¨ãƒ¬ãƒ™ãƒ«ã«éåŒæœŸæ›¸ãè¾¼ã¿
        this.l1.set(key, value);
        
        // L1ã‚µã‚¤ã‚ºåˆ¶å¾¡
        if (this.l1.size > this.l1MaxSize) {
            const firstKey = this.l1.keys().next().value;
            this.l1.delete(firstKey);
        }
        
        // L2/L3ã¸ã®éåŒæœŸæ›¸ãè¾¼ã¿ï¼ˆãƒ–ãƒ­ãƒƒã‚­ãƒ³ã‚°ã—ãªã„ï¼‰
        this.l2.put(key, JSON.stringify(value), { expirationTtl: ttl });
        
        const response = new Response(JSON.stringify(value));
        this.l3.put(key, response);
    }
}
```

### 6.2 é…å»¶èª­ã¿è¾¼ã¿

```javascript
class LazyLoader {
    constructor() {
        this.loaded = new Set();
        this.loading = new Map();
    }
    
    async loadResource(resource) {
        // æ—¢ã«èª­ã¿è¾¼ã¿æ¸ˆã¿
        if (this.loaded.has(resource)) {
            return true;
        }
        
        // èª­ã¿è¾¼ã¿ä¸­
        if (this.loading.has(resource)) {
            return await this.loading.get(resource);
        }
        
        // æ–°è¦èª­ã¿è¾¼ã¿
        const loadPromise = this.performLoad(resource);
        this.loading.set(resource, loadPromise);
        
        try {
            await loadPromise;
            this.loaded.add(resource);
            this.loading.delete(resource);
            return true;
        } catch (error) {
            this.loading.delete(resource);
            throw error;
        }
    }
    
    async performLoad(resource) {
        switch (resource) {
            case 'vectors':
                // å¿…è¦æ™‚ã®ã¿ãƒ™ã‚¯ãƒˆãƒ«ãƒ­ãƒ¼ãƒ‰
                return await this.loadVectors();
            case 'extended_dict':
                // å¿…è¦æ™‚ã®ã¿æ‹¡å¼µè¾æ›¸ãƒ­ãƒ¼ãƒ‰
                return await this.loadExtendedDictionary();
            default:
                throw new Error(`Unknown resource: ${resource}`);
        }
    }
}
```

---

## 7. ç›£è¦–ã¨ãƒ­ã‚°

### 7.1 ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–

```javascript
class PerformanceMonitor {
    constructor() {
        this.metrics = {
            requests: 0,
            totalTime: 0,
            cacheHits: 0,
            errors: 0
        };
    }
    
    async track(operation) {
        const startTime = performance.now();
        const startMemory = performance.memory?.usedJSHeapSize;
        
        try {
            const result = await operation();
            
            const elapsed = performance.now() - startTime;
            const memoryUsed = performance.memory?.usedJSHeapSize - startMemory;
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
            this.metrics.requests++;
            this.metrics.totalTime += elapsed;
            
            // é–¾å€¤ãƒã‚§ãƒƒã‚¯
            if (elapsed > 50) {
                console.warn(`Operation exceeded 50ms limit: ${elapsed}ms`);
                await this.reportSlowOperation(operation, elapsed);
            }
            
            if (memoryUsed > 10 * 1024 * 1024) {  // 10MB
                console.warn(`High memory usage: ${memoryUsed / 1024 / 1024}MB`);
            }
            
            return result;
            
        } catch (error) {
            this.metrics.errors++;
            throw error;
        }
    }
    
    async reportMetrics() {
        const report = {
            timestamp: Date.now(),
            avgResponseTime: this.metrics.totalTime / this.metrics.requests,
            cacheHitRate: this.metrics.cacheHits / this.metrics.requests,
            errorRate: this.metrics.errors / this.metrics.requests
        };
        
        // Cloudflare Analytics Engineã¸é€ä¿¡
        await env.ANALYTICS.writeDataPoint(report);
    }
}
```

---

## 8. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆæ§‹æˆ

### 8.1 ç’°å¢ƒåˆ¥æ§‹æˆ

```yaml
environments:
  development:
    edge:
      runtime: wrangler dev
      database: D1 local
      cache: local memory
    backend:
      runtime: docker compose
      ml_framework: tensorflow
      
  staging:
    edge:
      runtime: Cloudflare Workers (preview)
      database: D1 preview
      cache: Workers KV preview
    backend:
      runtime: AWS ECS
      ml_framework: SageMaker
      
  production:
    edge:
      runtime: Cloudflare Workers
      database: D1 (åˆ†å‰²æ§‹æˆ)
      cache: Workers KV + Cache API
      regions: [US, EU, APAC]
    backend:
      runtime: AWS ECS + Fargate
      ml_framework: SageMaker
      gpu: p3.2xlarge (å­¦ç¿’æ™‚ã®ã¿)
```

### 8.2 CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³

```yaml
deploy_pipeline:
  edge_deploy:
    - test: npm run test:edge
    - build: npm run build:edge
    - compress: npm run compress:assets
    - deploy: wrangler publish
    - verify: npm run verify:edge
    
  backend_deploy:
    - test: pytest tests/
    - build: docker build
    - push: docker push
    - deploy: ecs deploy
    - verify: python verify.py
    
  model_update:
    - train: python train.py
    - compress: python compress_model.py
    - validate: python validate.py
    - upload: aws s3 cp
    - notify: wrangler kv:key put
```

---

## æ‰¿èª

| å½¹å‰² | æ°å | æ‰¿èªæ—¥ | ç½²å |
|------|------|--------|------|
| ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ | | | |
| ã‚¤ãƒ³ãƒ•ãƒ©ãƒªãƒ¼ãƒ‰ | | | |
| MLã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ¼ãƒ‰ | | | |

**æ–‡æ›¸ç®¡ç†**
- **è¨­è¨ˆæ–¹é‡**: Edgeåˆ¶ç´„ã‚’è€ƒæ…®ã—ãŸå­¦ç¿’/æ¨è«–åˆ†é›¢
- **æŠ€è¡“é¸å®š**: è»½é‡NLP + WebAssembly + åœ§ç¸®ãƒ¢ãƒ‡ãƒ«
- **åˆ¶ç´„å¯¾å¿œ**: Cloudflareåˆ¶é™å†…ã§ã®æœ€é©åŒ–
- **é…å¸ƒå…ˆ**: é–‹ç™ºãƒãƒ¼ãƒ ã€ã‚¤ãƒ³ãƒ•ãƒ©ãƒãƒ¼ãƒ ã€MLãƒãƒ¼ãƒ 