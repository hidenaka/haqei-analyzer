# 🏗️ 384爻システム Cloudflare Pages対応システム設計書

**文書番号**: SD-384-005  
**バージョン**: 5.0（現実的Cloudflare Pages版）  
**作成日**: 2025年8月28日  
**作成者**: HAQEI開発チーム  
**承認者**: [未承認]

---

## 1. システム概要

### 1.1 現実的設計原則

#### 制約事項と対応策
```yaml
制約事項:
  - Cloudflare Pages: サーバーサイドDBMS不可
  - データライセンス: 外部辞書の配布・利用制限  
  - 開発リソース: 現実的な工数・スケジュール
  - 決定論性要求: 同一入力→同一出力の保証

現実的対応策:
  - Edge-Native設計: D1 + Workers KV + IndexedDB
  - 既存データ活用: koudo_shishin.jsonから開始
  - 軽量NLP: 正規表現ベース基本解析
  - 決定論的学習: 日次バッチ更新による一貫性保証
```

### 1.2 システムアーキテクチャ

```
┌─────────────────────────────────────────┐
│      384爻 現実的Edge分析システム         │
├─────────────────────────────────────────┤
│            クライアント層                 │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐  │
│  │Browser  │ │Service  │ │IndexedDB│  │
│  │UI       │ │Worker   │ │Cache    │  │
│  └─────────┘ └─────────┘ └─────────┘  │
├─────────────────────────────────────────┤
│           Cloudflare Edge層             │
│  ┌─────────────────────────────────────┐ │
│  │  DeterministicScoringEngine        │ │
│  │  ┌───────┐ ┌───────┐ ┌───────┐   │ │
│  │  │shin   │ │hen    │ │context│   │ │
│  │  │35%    │ │25%    │ │40%    │   │ │
│  │  └───────┘ └───────┘ └───────┘   │ │
│  └─────────────────────────────────────┘ │
├─────────────────────────────────────────┤
│          Cloudflare Storage層           │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐  │
│  │D1 DB    │ │Workers  │ │Static   │  │
│  │(50MB)   │ │KV       │ │Assets   │  │
│  │384爻統合│ │学習管理  │ │JSON     │  │
│  └─────────┘ └─────────┘ └─────────┘  │
└─────────────────────────────────────────┘
```

---

## 2. データ設計

### 2.1 D1 Database設計

```sql
-- 384爻基本データテーブル
CREATE TABLE lines_384 (
    line_id INTEGER PRIMARY KEY,           -- 1-384
    hexagram_id INTEGER NOT NULL,          -- 1-64
    line_position INTEGER NOT NULL,        -- 1-6
    hexagram_name TEXT NOT NULL,           
    
    -- koudo_shishin.json 確実データ
    shin_data TEXT,
    hen_data TEXT,
    
    -- 決定論性保証
    data_version INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- 決定論的学習フィードバック
CREATE TABLE user_feedback (
    id INTEGER PRIMARY KEY,
    batch_date TEXT NOT NULL,              -- 日次バッチ管理
    input_text TEXT NOT NULL,
    predicted_line_id INTEGER,
    correct_line_id INTEGER,
    accuracy_rating INTEGER,
    data_version INTEGER DEFAULT 1,        -- 使用データバージョン
    processed_in_batch INTEGER DEFAULT 0   -- バッチ処理済みフラグ
);
```

### 2.2 Workers KV設計

```javascript
// 決定論的重みデータ（日次更新）
KV["weights:version:1"] = {
  data_version: 1,
  effective_date: "2025-08-28",
  scoring_weights: {
    shin_match: 0.35,        // shin完全一致
    hen_match: 0.25,         // hen完全一致  
    partial_match: 0.20,     // 部分一致
    length_similarity: 0.10, // 文字列長類似度
    context_bonus: 0.10      // 文脈ボーナス
  },
  deterministic_synonyms: {
    "リーダー": ["指導者", "統率者"],
    "組織": ["グループ", "チーム", "集団"],
    "責任": ["義務", "使命", "役割"]
  }
}
```

---

## 3. 実装設計

### 3.1 決定論的分析エンジン

```javascript
class DeterministicAnalysisEngine {
    constructor(d1Database, kvStore) {
        this.db = d1Database;
        this.kv = kvStore;
    }
    
    async analyzeText(inputText, dataVersion = 1) {
        // 1. 決定論的重み取得
        const weights = await this.kv.get(`weights:version:${dataVersion}`);
        
        // 2. キャッシュ確認（バージョン込み）
        const cacheKey = this.generateCacheKey(inputText, dataVersion);
        const cached = await this.checkCache(cacheKey);
        if (cached) return cached;
        
        // 3. 基本テキスト分析
        const tokens = this.basicTokenize(inputText);
        const keywords = this.extractKeywords(tokens);
        
        // 4. 全384爻とのスコア計算
        const scores = await this.calculateAllScores(keywords, weights);
        
        // 5. 最高スコア爻選択
        const bestMatch = scores[0];
        
        const result = {
            line_id: bestMatch.line_id,
            confidence: bestMatch.total_score,
            data_version: dataVersion,
            processing_time_ms: bestMatch.processing_time,
            deterministic: true // 決定論性保証フラグ
        };
        
        // 6. キャッシュ保存
        await this.saveToCache(cacheKey, result);
        
        return result;
    }
    
    async calculateLineScore(lineData, keywords, weights) {
        let totalScore = 0;
        
        // shin完全一致スコア (35%)
        const shinScore = this.calculateExactMatch(
            keywords, lineData.shin_data
        );
        totalScore += shinScore * weights.shin_match;
        
        // hen完全一致スコア (25%)  
        const henScore = this.calculateExactMatch(
            keywords, lineData.hen_data
        );
        totalScore += henScore * weights.hen_match;
        
        // 部分一致スコア (20%)
        const partialScore = this.calculatePartialMatch(
            keywords, lineData.shin_data, lineData.hen_data
        );
        totalScore += partialScore * weights.partial_match;
        
        // 文字列長類似度 (10%)
        const lengthScore = this.calculateLengthSimilarity(
            keywords.join(''), lineData.shin_data + lineData.hen_data
        );
        totalScore += lengthScore * weights.length_similarity;
        
        // 文脈ボーナス (10%)
        const contextScore = this.calculateContextBonus(keywords, lineData);
        totalScore += contextScore * weights.context_bonus;
        
        return {
            line_id: lineData.line_id,
            total_score: totalScore,
            score_breakdown: {
                shin_score: shinScore,
                hen_score: henScore, 
                partial_score: partialScore,
                length_score: lengthScore,
                context_score: contextScore
            }
        };
    }
}
```

### 3.2 日次バッチ学習システム

```javascript
class DeterministicLearningSystem {
    async processDailyBatch(batchDate) {
        const batchLog = {
            batch_date: batchDate,
            batch_status: 'processing',
            start_time: Date.now()
        };
        
        try {
            // 1. 未処理フィードバック取得
            const feedbacks = await this.getUnprocessedFeedback(batchDate);
            
            // 2. 重み調整計算
            const weightAdjustments = await this.calculateWeightAdjustments(feedbacks);
            
            // 3. 新データバージョン生成
            const newVersion = await this.createNewDataVersion(weightAdjustments);
            
            // 4. KV重み更新
            await this.updateKVWeights(newVersion, weightAdjustments);
            
            // 5. フィードバック処理済みマーク
            await this.markFeedbackProcessed(feedbacks, batchDate);
            
            batchLog.batch_status = 'completed';
            batchLog.new_data_version = newVersion;
            batchLog.feedbacks_processed = feedbacks.length;
            
        } catch (error) {
            batchLog.batch_status = 'failed';
            batchLog.error = error.message;
        }
        
        // 6. バッチログ保存
        await this.saveBatchLog(batchLog);
        
        return batchLog;
    }
}
```

---

## 4. 品質保証・承認基準

### 4.1 決定論性テスト

```javascript
// 決定論性保証テスト
async function testDeterminism() {
    const testInput = "リーダーとして組織を導く責任";
    const dataVersion = 1;
    
    const results = [];
    for (let i = 0; i < 10; i++) {
        const result = await engine.analyzeText(testInput, dataVersion);
        results.push(result);
    }
    
    // 全結果が同一であることを確認
    const allIdentical = results.every(r => 
        r.line_id === results[0].line_id && 
        r.confidence === results[0].confidence
    );
    
    assert(allIdentical, "決定論性保証テスト失敗");
}
```

### 4.2 段階的実装計画

```yaml
Phase 1 (2週間): 基盤構築
  - D1 Database初期化
  - koudo_shishin.json統合
  - 基本スコアリング実装

Phase 2 (2週間): 決定論的分析
  - DeterministicAnalysisEngine実装
  - IndexedDBキャッシュ実装
  - 決定論性テスト

Phase 3 (2週間): 学習システム
  - Workers KVフィードバック収集
  - 日次バッチ学習実装
  - バージョニングシステム

Phase 4 (1週間): 統合テスト・デプロイ
  - Cloudflare Pages統合
  - 性能・決定論性テスト
  - 本番デプロイ
```

---

## 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| システムアーキテクト | | | |
| 技術リード | | | |

**文書管理**
- **設計原則**: 現実的・実装可能なCloudflare Pages対応
- **決定論性**: 日次バッチ更新による一貫性保証
- **データ活用**: 既存koudo_shishin.jsonから段階的拡張
- **配布先**: 開発チーム、QAチーム