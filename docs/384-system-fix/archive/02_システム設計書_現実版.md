# ğŸ—ï¸ 384çˆ»ã‚·ã‚¹ãƒ†ãƒ  Cloudflare Pageså¯¾å¿œã‚·ã‚¹ãƒ†ãƒ è¨­è¨ˆæ›¸

**æ–‡æ›¸ç•ªå·**: SD-384-005  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 5.0ï¼ˆç¾å®Ÿçš„Cloudflare Pagesç‰ˆï¼‰  
**ä½œæˆæ—¥**: 2025å¹´8æœˆ28æ—¥  
**ä½œæˆè€…**: HAQEIé–‹ç™ºãƒãƒ¼ãƒ   
**æ‰¿èªè€…**: [æœªæ‰¿èª]

---

## 1. ã‚·ã‚¹ãƒ†ãƒ æ¦‚è¦

### 1.1 ç¾å®Ÿçš„è¨­è¨ˆåŸå‰‡

#### åˆ¶ç´„äº‹é …ã¨å¯¾å¿œç­–
```yaml
åˆ¶ç´„äº‹é …:
  - Cloudflare Pages: ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰DBMSä¸å¯
  - ãƒ‡ãƒ¼ã‚¿ãƒ©ã‚¤ã‚»ãƒ³ã‚¹: å¤–éƒ¨è¾æ›¸ã®é…å¸ƒãƒ»åˆ©ç”¨åˆ¶é™  
  - é–‹ç™ºãƒªã‚½ãƒ¼ã‚¹: ç¾å®Ÿçš„ãªå·¥æ•°ãƒ»ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  - æ±ºå®šè«–æ€§è¦æ±‚: åŒä¸€å…¥åŠ›â†’åŒä¸€å‡ºåŠ›ã®ä¿è¨¼

ç¾å®Ÿçš„å¯¾å¿œç­–:
  - Edge-Nativeè¨­è¨ˆ: D1 + Workers KV + IndexedDB
  - æ—¢å­˜ãƒ‡ãƒ¼ã‚¿æ´»ç”¨: koudo_shishin.jsonã‹ã‚‰é–‹å§‹
  - è»½é‡NLP: æ­£è¦è¡¨ç¾ãƒ™ãƒ¼ã‚¹åŸºæœ¬è§£æ
  - æ±ºå®šè«–çš„å­¦ç¿’: æ—¥æ¬¡ãƒãƒƒãƒæ›´æ–°ã«ã‚ˆã‚‹ä¸€è²«æ€§ä¿è¨¼
```

### 1.2 ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      384çˆ» ç¾å®Ÿçš„Edgeåˆ†æã‚·ã‚¹ãƒ†ãƒ          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚            ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå±¤                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚Browser  â”‚ â”‚Service  â”‚ â”‚IndexedDBâ”‚  â”‚
â”‚  â”‚UI       â”‚ â”‚Worker   â”‚ â”‚Cache    â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚           Cloudflare Edgeå±¤             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  DeterministicScoringEngine        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”   â”‚ â”‚
â”‚  â”‚  â”‚shin   â”‚ â”‚hen    â”‚ â”‚contextâ”‚   â”‚ â”‚
â”‚  â”‚  â”‚35%    â”‚ â”‚25%    â”‚ â”‚40%    â”‚   â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚          Cloudflare Storageå±¤           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚D1 DB    â”‚ â”‚Workers  â”‚ â”‚Static   â”‚  â”‚
â”‚  â”‚(50MB)   â”‚ â”‚KV       â”‚ â”‚Assets   â”‚  â”‚
â”‚  â”‚384çˆ»çµ±åˆâ”‚ â”‚å­¦ç¿’ç®¡ç†  â”‚ â”‚JSON     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆ

### 2.1 D1 Databaseè¨­è¨ˆ

```sql
-- 384çˆ»åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ãƒ†ãƒ¼ãƒ–ãƒ«
CREATE TABLE lines_384 (
    line_id INTEGER PRIMARY KEY,           -- 1-384
    hexagram_id INTEGER NOT NULL,          -- 1-64
    line_position INTEGER NOT NULL,        -- 1-6
    hexagram_name TEXT NOT NULL,           
    
    -- koudo_shishin.json ç¢ºå®Ÿãƒ‡ãƒ¼ã‚¿
    shin_data TEXT,
    hen_data TEXT,
    
    -- æ±ºå®šè«–æ€§ä¿è¨¼
    data_version INTEGER DEFAULT 1,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

-- æ±ºå®šè«–çš„å­¦ç¿’ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
CREATE TABLE user_feedback (
    id INTEGER PRIMARY KEY,
    batch_date TEXT NOT NULL,              -- æ—¥æ¬¡ãƒãƒƒãƒç®¡ç†
    input_text TEXT NOT NULL,
    predicted_line_id INTEGER,
    correct_line_id INTEGER,
    accuracy_rating INTEGER,
    data_version INTEGER DEFAULT 1,        -- ä½¿ç”¨ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³
    processed_in_batch INTEGER DEFAULT 0   -- ãƒãƒƒãƒå‡¦ç†æ¸ˆã¿ãƒ•ãƒ©ã‚°
);
```

### 2.2 Workers KVè¨­è¨ˆ

```javascript
// æ±ºå®šè«–çš„é‡ã¿ãƒ‡ãƒ¼ã‚¿ï¼ˆæ—¥æ¬¡æ›´æ–°ï¼‰
KV["weights:version:1"] = {
  data_version: 1,
  effective_date: "2025-08-28",
  scoring_weights: {
    shin_match: 0.35,        // shinå®Œå…¨ä¸€è‡´
    hen_match: 0.25,         // henå®Œå…¨ä¸€è‡´  
    partial_match: 0.20,     // éƒ¨åˆ†ä¸€è‡´
    length_similarity: 0.10, // æ–‡å­—åˆ—é•·é¡ä¼¼åº¦
    context_bonus: 0.10      // æ–‡è„ˆãƒœãƒ¼ãƒŠã‚¹
  },
  deterministic_synonyms: {
    "ãƒªãƒ¼ãƒ€ãƒ¼": ["æŒ‡å°è€…", "çµ±ç‡è€…"],
    "çµ„ç¹”": ["ã‚°ãƒ«ãƒ¼ãƒ—", "ãƒãƒ¼ãƒ ", "é›†å›£"],
    "è²¬ä»»": ["ç¾©å‹™", "ä½¿å‘½", "å½¹å‰²"]
  }
}
```

---

## 3. å®Ÿè£…è¨­è¨ˆ

### 3.1 æ±ºå®šè«–çš„åˆ†æã‚¨ãƒ³ã‚¸ãƒ³

```javascript
class DeterministicAnalysisEngine {
    constructor(d1Database, kvStore) {
        this.db = d1Database;
        this.kv = kvStore;
    }
    
    async analyzeText(inputText, dataVersion = 1) {
        // 1. æ±ºå®šè«–çš„é‡ã¿å–å¾—
        const weights = await this.kv.get(`weights:version:${dataVersion}`);
        
        // 2. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç¢ºèªï¼ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³è¾¼ã¿ï¼‰
        const cacheKey = this.generateCacheKey(inputText, dataVersion);
        const cached = await this.checkCache(cacheKey);
        if (cached) return cached;
        
        // 3. åŸºæœ¬ãƒ†ã‚­ã‚¹ãƒˆåˆ†æ
        const tokens = this.basicTokenize(inputText);
        const keywords = this.extractKeywords(tokens);
        
        // 4. å…¨384çˆ»ã¨ã®ã‚¹ã‚³ã‚¢è¨ˆç®—
        const scores = await this.calculateAllScores(keywords, weights);
        
        // 5. æœ€é«˜ã‚¹ã‚³ã‚¢çˆ»é¸æŠ
        const bestMatch = scores[0];
        
        const result = {
            line_id: bestMatch.line_id,
            confidence: bestMatch.total_score,
            data_version: dataVersion,
            processing_time_ms: bestMatch.processing_time,
            deterministic: true // æ±ºå®šè«–æ€§ä¿è¨¼ãƒ•ãƒ©ã‚°
        };
        
        // 6. ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
        await this.saveToCache(cacheKey, result);
        
        return result;
    }
    
    async calculateLineScore(lineData, keywords, weights) {
        let totalScore = 0;
        
        // shinå®Œå…¨ä¸€è‡´ã‚¹ã‚³ã‚¢ (35%)
        const shinScore = this.calculateExactMatch(
            keywords, lineData.shin_data
        );
        totalScore += shinScore * weights.shin_match;
        
        // henå®Œå…¨ä¸€è‡´ã‚¹ã‚³ã‚¢ (25%)  
        const henScore = this.calculateExactMatch(
            keywords, lineData.hen_data
        );
        totalScore += henScore * weights.hen_match;
        
        // éƒ¨åˆ†ä¸€è‡´ã‚¹ã‚³ã‚¢ (20%)
        const partialScore = this.calculatePartialMatch(
            keywords, lineData.shin_data, lineData.hen_data
        );
        totalScore += partialScore * weights.partial_match;
        
        // æ–‡å­—åˆ—é•·é¡ä¼¼åº¦ (10%)
        const lengthScore = this.calculateLengthSimilarity(
            keywords.join(''), lineData.shin_data + lineData.hen_data
        );
        totalScore += lengthScore * weights.length_similarity;
        
        // æ–‡è„ˆãƒœãƒ¼ãƒŠã‚¹ (10%)
        const contextScore = this.calculateContextBonus(keywords, lineData);
        totalScore += contextScore * weights.context_bonus;
        
        return {
            line_id: lineData.line_id,
            total_score: totalScore,
            score_breakdown: {
                shin_score: shinScore,
                hen_score: henScore, 
                partial_score: partialScore,
                length_score: lengthScore,
                context_score: contextScore
            }
        };
    }
}
```

### 3.2 æ—¥æ¬¡ãƒãƒƒãƒå­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 

```javascript
class DeterministicLearningSystem {
    async processDailyBatch(batchDate) {
        const batchLog = {
            batch_date: batchDate,
            batch_status: 'processing',
            start_time: Date.now()
        };
        
        try {
            // 1. æœªå‡¦ç†ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å–å¾—
            const feedbacks = await this.getUnprocessedFeedback(batchDate);
            
            // 2. é‡ã¿èª¿æ•´è¨ˆç®—
            const weightAdjustments = await this.calculateWeightAdjustments(feedbacks);
            
            // 3. æ–°ãƒ‡ãƒ¼ã‚¿ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”Ÿæˆ
            const newVersion = await this.createNewDataVersion(weightAdjustments);
            
            // 4. KVé‡ã¿æ›´æ–°
            await this.updateKVWeights(newVersion, weightAdjustments);
            
            // 5. ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯å‡¦ç†æ¸ˆã¿ãƒãƒ¼ã‚¯
            await this.markFeedbackProcessed(feedbacks, batchDate);
            
            batchLog.batch_status = 'completed';
            batchLog.new_data_version = newVersion;
            batchLog.feedbacks_processed = feedbacks.length;
            
        } catch (error) {
            batchLog.batch_status = 'failed';
            batchLog.error = error.message;
        }
        
        // 6. ãƒãƒƒãƒãƒ­ã‚°ä¿å­˜
        await this.saveBatchLog(batchLog);
        
        return batchLog;
    }
}
```

---

## 4. å“è³ªä¿è¨¼ãƒ»æ‰¿èªåŸºæº–

### 4.1 æ±ºå®šè«–æ€§ãƒ†ã‚¹ãƒˆ

```javascript
// æ±ºå®šè«–æ€§ä¿è¨¼ãƒ†ã‚¹ãƒˆ
async function testDeterminism() {
    const testInput = "ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦çµ„ç¹”ã‚’å°ãè²¬ä»»";
    const dataVersion = 1;
    
    const results = [];
    for (let i = 0; i < 10; i++) {
        const result = await engine.analyzeText(testInput, dataVersion);
        results.push(result);
    }
    
    // å…¨çµæœãŒåŒä¸€ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
    const allIdentical = results.every(r => 
        r.line_id === results[0].line_id && 
        r.confidence === results[0].confidence
    );
    
    assert(allIdentical, "æ±ºå®šè«–æ€§ä¿è¨¼ãƒ†ã‚¹ãƒˆå¤±æ•—");
}
```

### 4.2 æ®µéšçš„å®Ÿè£…è¨ˆç”»

```yaml
Phase 1 (2é€±é–“): åŸºç›¤æ§‹ç¯‰
  - D1 DatabaseåˆæœŸåŒ–
  - koudo_shishin.jsonçµ±åˆ
  - åŸºæœ¬ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°å®Ÿè£…

Phase 2 (2é€±é–“): æ±ºå®šè«–çš„åˆ†æ
  - DeterministicAnalysisEngineå®Ÿè£…
  - IndexedDBã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…
  - æ±ºå®šè«–æ€§ãƒ†ã‚¹ãƒˆ

Phase 3 (2é€±é–“): å­¦ç¿’ã‚·ã‚¹ãƒ†ãƒ 
  - Workers KVãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯åé›†
  - æ—¥æ¬¡ãƒãƒƒãƒå­¦ç¿’å®Ÿè£…
  - ãƒãƒ¼ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ 

Phase 4 (1é€±é–“): çµ±åˆãƒ†ã‚¹ãƒˆãƒ»ãƒ‡ãƒ—ãƒ­ã‚¤
  - Cloudflare Pagesçµ±åˆ
  - æ€§èƒ½ãƒ»æ±ºå®šè«–æ€§ãƒ†ã‚¹ãƒˆ
  - æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤
```

---

## æ‰¿èª

| å½¹å‰² | æ°å | æ‰¿èªæ—¥ | ç½²å |
|------|------|--------|------|
| ã‚·ã‚¹ãƒ†ãƒ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ | | | |
| æŠ€è¡“ãƒªãƒ¼ãƒ‰ | | | |

**æ–‡æ›¸ç®¡ç†**
- **è¨­è¨ˆåŸå‰‡**: ç¾å®Ÿçš„ãƒ»å®Ÿè£…å¯èƒ½ãªCloudflare Pageså¯¾å¿œ
- **æ±ºå®šè«–æ€§**: æ—¥æ¬¡ãƒãƒƒãƒæ›´æ–°ã«ã‚ˆã‚‹ä¸€è²«æ€§ä¿è¨¼
- **ãƒ‡ãƒ¼ã‚¿æ´»ç”¨**: æ—¢å­˜koudo_shishin.jsonã‹ã‚‰æ®µéšçš„æ‹¡å¼µ
- **é…å¸ƒå…ˆ**: é–‹ç™ºãƒãƒ¼ãƒ ã€QAãƒãƒ¼ãƒ 