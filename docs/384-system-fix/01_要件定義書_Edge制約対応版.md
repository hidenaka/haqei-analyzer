# 🎯 384爻システム AI実装制約対応版 要件定義書

**文書番号**: RD-384-AI-002  
**バージョン**: 2.0（Edge制約対応版）  
**作成日**: 2025年8月28日  
**作成者**: HAQEI開発チーム  
**承認者**: [未承認]

---

## 1. プロジェクト概要

### 1.1 背景と課題

**現状の課題**:
- 384爻分類システムがkoudo_shishin.jsonの25%のデータのみ使用
- enhanced_hexagrams_complete.json、yaoci_31-63.json、h384.json等の75%データが未活用
- 単純な文字列マッチングによる低精度分類
- 形態素解析・類義語処理・学習機構の欠如

**AI実装による解決アプローチ**:
- 全JSONデータの完全統合活用（100%データ利用）
- MeCab/WordNet等の外部辞書導入による高度NLP
- セマンティックベクトル・TF-IDF・類義語ベクトルによる高精度分析
- 機械学習による継続的精度向上

### 1.2 プロジェクト目標

| 目標項目 | 現状値 | 目標値（制約考慮） | 達成期限 |
|----------|--------|-------------------|----------|
| データ活用率 | 25% | 85%（軽量化版） | 実装完了時 |
| 分類精度 | 約50% | 85%以上 | 3ヶ月運用後 |
| 応答時間(p50) | 100ms | 30ms以下 | Edge最適化後 |
| 応答時間(p99) | 500ms | 100ms以下 | キャッシュ導入後 |
| カバー率 | 限定的 | 主要パターン90% | バックエンド学習後 |
| 学習効果 | なし | 日次バッチ更新 | 運用開始1週間後 |

---

## 2. 機能要件

### 2.1 データ統合要件

#### 2.1.1 統合対象データソース
```yaml
Edge対応データ統合:
  必須データ（D1統合）:
    koudo_shishin.json:
      - 既存shin/henデータ（優先度: 高）
      - サイズ: 約500KB
      - 統合方法: D1 lines_384基本テーブル
      
    軽量化統合データ:
      - enhanced_hexagrams要約版（1MB以下に圧縮）
      - yaoci_31-63要約版（500KB以下）
      - h384キーワードのみ（200KB以下）
      - 統合方法: D1複数テーブル分割格納

  軽量NLP辞書:
    簡易形態素解析:
      - カスタム正規表現ベース（100KB）
      - 易経専門用語辞書（500KB）
      - 統合方法: Workers KVキャッシュ
      
    圧縮類義語辞書:
      - 頻出1000語の類義語マップ（300KB）
      - 易経ドメイン特化辞書（200KB）
      - 統合方法: JSONファイル直接配信

  推論専用モデル:
    軽量ベクトル:
      - 次元圧縮済み埋め込み（50次元、5MB）
      - 事前計算384爻ベクトル（2MB）
      - 統合方法: CDN配信 + ブラウザキャッシュ

制約対応:
  Cloudflare D1制限:
    - 単一DB: 50MB以下
    - 分割戦略: 複数DBインスタンス使用
    
  Workers KV制限:
    - 値サイズ: 25MB/値以下
    - 分割格納による対応
    
  CPU時間制限:
    - 50ms/リクエスト
    - キャッシュ優先アーキテクチャ
```

#### 2.1.2 データベース要件
```yaml
マルチ環境対応:
  開発環境:
    - SQLite: ローカル開発・テスト用
    - MongoDB: 学習データ蓄積
    - Redis: 高速キャッシュ
    - InfluxDB: パフォーマンス監視
    
  本番環境（Cloudflare Pages）:
    - D1 Database: Edge SQLite互換
    - Workers KV: 分散キーバリューストア
    - Durable Objects: ステートフル処理
    - Analytics Engine: リアルタイム分析
    
環境自動切替:
    - ビルド時環境変数による自動選択
    - データベースアダプター層による抽象化
```

### 2.2 Edge対応軽量NLP要件

#### 2.2.1 軽量形態素解析
```yaml
処理フロー:
  1. 正規表現ベース解析:
     - 事前定義パターンマッチング（10ms以内）
     - 易経専門用語の優先認識
     - キャッシュ活用率90%以上
     
  2. 簡易品詞推定:
     - ルールベース品詞タグ付け
     - 頻出5000語の辞書参照
     
  3. 高速キーワード抽出:
     - 事前計算TF-IDFスコア参照
     - 上位10キーワードのみ抽出
     - 処理時間5ms以内
```

#### 2.2.2 軽量類義語・意味解析
```yaml
圧縮類義語処理:
  - 頻出1000語の類義語マップ（事前作成）
  - 編集距離による簡易類似度
  - ルックアップテーブル方式（1ms以内）
  
軽量セマンティック処理:
  - 50次元圧縮ベクトル使用
  - 事前計算済み384爻ベクトル
  - 高速内積計算（SIMD最適化）
  - ブラウザWebAssembly活用
```

### 2.3 スコアリングアルゴリズム

#### 2.3.1 複合スコアリング
```yaml
スコア構成要素:
  形態素マッチング（25%）:
    - キーワード完全一致
    - 品詞重み付けマッチング
    - N-gramマッチング
    
  類義語マッチング（30%）:
    - WordNet類似度スコア
    - ドメイン特化類義語
    - 文脈類似度
    
  セマンティックスコア（25%）:
    - ベクトル空間類似度
    - 潜在意味解析（LSA）
    - トピックモデリング（LDA）
    
  爻辞直接マッチング（15%）:
    - 爻辞テキスト類似度
    - 意味・性格特性マッチング
    
  学習スコア（5%）:
    - フィードバック基づく重み
    - 成功パターン学習
```

### 2.4 学習/推論分離型機械学習要件

#### 2.4.1 バックエンド学習（オフライン）
```yaml
学習環境:
  実行場所:
    - 専用GPUサーバー or クラウドML基盤
    - AWS SageMaker / Google Cloud ML
    - 日次バッチ実行（深夜帯）
    
  学習データ収集:
    - Edgeからフィードバック収集（非同期）
    - Workers KV経由でバッファリング
    - 1000件/日を目安にバッチ化
    
  モデル更新:
    - 軽量モデルへの圧縮（5MB以下）
    - 量子化・プルーニング適用
    - CDN経由での配信（差分更新）
```

#### 2.4.2 Edge推論（リアルタイム）
```yaml
推論最適化:
  軽量推論エンジン:
    - WebAssembly実装（高速化）
    - 事前計算済みルックアップテーブル
    - 決定論的スコアリング
    
  キャッシュ戦略:
    - 入力ハッシュによる結果キャッシュ
    - 頻出パターンの事前計算
    - ヒット率80%以上目標
    
  フォールバック:
    - モデル読み込み失敗時の簡易スコアリング
    - ルールベース分類への自動切替
```

---

## 3. 非機能要件

### 3.1 性能要件（Edge制約考慮）

| 項目 | 要件値 | 測定条件 |
|------|--------|---------|
| 応答時間(p50) | 30ms以下 | キャッシュヒット時 |
| 応答時間(p99) | 100ms以下 | キャッシュミス時 |
| 同時処理 | 500req/sec | Cloudflare Workers |
| D1データベース | 45MB以下 | 分割DB合計 |
| Workers KV使用量 | 10MB以下 | キャッシュデータ |
| CPU時間/リクエスト | 45ms以下 | Workers制限内 |
| キャッシュヒット率 | 85%以上 | 24時間運用後 |

### 3.2 可用性・信頼性

```yaml
可用性:
  - SLA: 99.95%
  - 自動フェイルオーバー
  - マルチリージョン展開
  
信頼性:
  - データ整合性保証
  - トランザクション管理
  - 自動バックアップ（日次）
  - ポイントインタイムリカバリ
```

### 3.3 拡張性

```yaml
水平拡張:
  - Workers自動スケーリング
  - データベースレプリケーション
  - キャッシュ分散
  
垂直拡張:
  - 新データソース追加対応
  - アルゴリズム追加プラグイン化
  - 多言語対応準備
```

### 3.4 保守性・運用性

```yaml
監視・ログ:
  - リアルタイムメトリクス（Grafana）
  - 分散トレーシング（Jaeger）
  - 集約ログ分析（ELK Stack）
  - アラート自動化
  
デプロイメント:
  - CI/CD完全自動化
  - Blue-Green デプロイ
  - カナリアリリース
  - 自動ロールバック
```

---

## 4. 制約事項

### 4.1 技術制約
- Cloudflare Pages環境での動作必須
- ブラウザ互換性（Chrome/Firefox/Safari最新2バージョン）
- モバイル対応（iOS/Android）

### 4.2 リソース制約（厳格適用）
- D1 Database: 単一DB 50MB制限 → 複数DB分割で対応
- Workers KV: 値サイズ25MB/値、総量100MB/月
- CPU時間: 50ms/リクエスト → キャッシュ必須
- メモリ: 128MB/Worker → 軽量処理のみ
- ペイロード: 100MB/リクエスト

### 4.3 ライセンス制約と対策
- MeCab: ライセンス問題 → 正規表現ベース代替実装
- WordNet: 再配布制限 → API経由or圧縮辞書
- 事前学習モデル: サイズ制限 → 量子化・圧縮版使用
- 各JSONデータ: プロジェクト内利用可（要圧縮）

### 4.4 アーキテクチャ制約
- 学習処理: Edge実行不可 → バックエンド分離必須
- 大規模モデル: 配信不可 → CDN分割配信
- リアルタイム学習: 不可 → 日次バッチ更新

---

## 5. 成功基準

### 5.1 定量的基準（制約考慮版）

| 評価項目 | 達成基準 | 測定方法 |
|----------|---------|---------|
| 分類精度 | 85%以上 | 1000件テストセット |
| 応答速度(p50) | 30ms以下 | 本番環境測定 |
| 応答速度(p99) | 100ms以下 | 本番環境測定 |
| データ活用率 | 85% | 軽量化後の統合率 |
| 学習効果 | 月3%改善 | バッチ学習後の精度 |
| システム稼働率 | 99.9% | 月間ダウンタイム |
| キャッシュヒット率 | 85%以上 | 24時間平均 |

### 5.2 定性的基準
- 易経専門家による妥当性評価
- ユーザビリティテスト合格
- コード品質基準達成（SonarQube A評価）
- ドキュメント完備度100%

---

## 承認

| 役割 | 氏名 | 承認日 | 署名 |
|------|------|--------|------|
| プロジェクトオーナー | | | |
| 技術責任者 | | | |
| 品質保証責任者 | | | |

**文書管理**
- **設計方針**: Edge制約を考慮したAI実装版
- **データ活用**: 軽量化JSONデータ + 圧縮辞書
- **技術選定**: 軽量NLP + 学習/推論分離 + Edge最適化
- **制約対応**: Cloudflare Pages制限内での実装
- **配布先**: 開発チーム、AIエンジニア、インフラチーム