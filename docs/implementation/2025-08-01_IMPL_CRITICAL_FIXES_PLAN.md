# HAQEIアナライザー緊急修正計画書

作成日: 2025年8月1日  
優先度: 最高  
作成者: Claude Code

## 1. 現状の問題点分析

### 1.1 重大なバグ
1. **q30（最後の偶数番設問）が表示されない**
   - 他の偶数番設問は修正により表示されるようになった
   - q30のみ `offsetHeight: 0` で表示されない
   - 原因: 分析画面への遷移処理と競合している可能性

2. **AnalysisView is not defined エラー**
   - 分析プロセス開始時に発生
   - 原因: AnalysisViewコンポーネントが読み込まれていない

### 1.2 UI/UXの問題
1. **トップページの文言が思想と不一致**
   - 現在: 単純な診断ツールのような説明
   - 必要: 「3つの人格OSの相互作用を易経メタファーで解説」という思想の反映

2. **ボタン表示の問題**
   - 「分析開始」ボタンではない表示になっている

3. **画面レイアウトの崩れ**
   - CSSの競合または上書きによる可能性

## 2. 修正計画

### Phase 1: 緊急修正（即座実行）

#### 2.1 q30表示バグの修正
```javascript
/**
 * 最後の設問（q30）の特別処理
 * 
 * 問題：
 * - q30表示時に分析画面への遷移処理が同時に走る
 * - DOMから要素が削除される前に表示処理が実行される
 * 
 * 解決策：
 * - 完了チェックのタイミングを調整
 * - q30の表示を確実に行ってから遷移処理を実行
 */
```

#### 2.2 AnalysisViewの読み込み修正
```javascript
/**
 * AnalysisViewコンポーネントの動的読み込み
 * 
 * 問題：
 * - AnalysisViewが定義されていない
 * - 必要なファイルが読み込まれていない
 * 
 * 解決策：
 * - app.jsでAnalysisViewを適切に読み込む
 * - 依存関係を正しく設定
 */
```

### Phase 2: UI/UX修正（1時間以内）

#### 2.3 トップページ文言の修正
```javascript
/**
 * WelcomeScreenの文言更新
 * 
 * 変更内容：
 * - タイトル: 「HaQei Analyzer - 仮想人格形成システム」
 * - 説明文: 「あなたの回答から3つの人格OS（Engine/Interface/Safe Mode）を
 *   構築し、その相互作用を易経の64卦を通じて解析します」
 * - ボタン: 「分析を開始する」
 */
```

#### 2.4 CSSの修正
- design-fix.cssとdesign-restoration.cssの競合を解消
- !importantの過度な使用を整理

### Phase 3: 品質保証（継続）

#### 2.5 テストケースの作成
- q30の表示確認テスト
- 分析画面への遷移テスト
- 全体的な画面フローテスト

## 3. 実装順序

1. **AnalysisView読み込み修正**（最優先）
   - proceedToAnalysis関数が正常に動作するため

2. **q30表示バグ修正**
   - 完了判定のタイミング調整
   - DOM操作の順序最適化

3. **トップページ修正**
   - WelcomeScreen.jsの文言更新
   - ボタンテキストの修正

4. **CSS整理**
   - 不要な!importantの削除
   - スタイルの統合

## 4. リスクと対策

### リスク
1. 既存の回答データが失われる可能性
2. 修正により新たなバグが発生する可能性

### 対策
1. LocalStorageのバックアップ機能を確認
2. 段階的な修正とテストの実施
3. コンソールログによる詳細な動作確認

## 5. 成功基準

1. **機能面**
   - [ ] q30が正しく表示される
   - [ ] 分析画面への遷移が正常に動作
   - [ ] エラーが発生しない

2. **UI/UX面**
   - [ ] トップページの文言が思想を反映
   - [ ] ボタン表示が「分析を開始する」
   - [ ] レイアウトが崩れていない

3. **品質面**
   - [ ] すべての設問が表示される
   - [ ] 回答データが正しく保存される
   - [ ] パフォーマンスが維持される

## 6. 実装開始

この計画に基づいて、以下の順序で実装を開始します：

1. AnalysisView読み込み問題の調査と修正
2. q30表示バグの根本原因特定と修正
3. UI/UXの改善
4. 総合テストと品質確認