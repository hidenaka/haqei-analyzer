# 即時テスト実行フロー

## 🎯 基本原則：開発→即テスト→修正

### テスト実行ルール
1. **Playwright必須使用** - localhost直接アクセスは禁止
2. **別インスタンス活用** - エラー時は新インスタンスで再試行
3. **並列テスト推奨** - 複数ブラウザで同時検証

## 📋 標準テストフロー

### 1. 開発直後の即時テスト
```javascript
// 開発完了後、同じメッセージ内で：
[Single Message]:
  - Write("new-feature.js", content)
  - Write("test-new-feature.html", testContent)
  - Bash("node playwright-test-new-feature.cjs")
```

### 2. Playwrightテストスクリプトテンプレート
```javascript
const { chromium } = require('playwright');

(async () => {
  console.log('🚀 [機能名]テスト開始');
  
  const browser = await chromium.launch({
    headless: false, // 開発時は表示
    args: ['--no-sandbox']
  });
  
  const context = await browser.newContext({
    viewport: { width: 1280, height: 800 }
  });
  
  const page = await context.newPage();
  
  // コンソールログ収集
  const logs = [];
  page.on('console', msg => {
    logs.push({
      type: msg.type(),
      text: msg.text(),
      time: new Date().toISOString()
    });
  });
  
  try {
    // Step 1: ページアクセス
    await page.goto('http://localhost:8788/[target].html');
    await page.waitForTimeout(2000);
    
    // Step 2: 機能テスト
    // TODO: 具体的なテスト内容
    
    // Step 3: エラーチェック
    const errors = logs.filter(log => log.type === 'error');
    if (errors.length > 0) {
      console.error('❌ エラー検出:', errors);
    } else {
      console.log('✅ エラーなし');
    }
    
    // スクリーンショット
    await page.screenshot({ path: '[feature]-test.png' });
    
  } catch (error) {
    console.error('テストエラー:', error);
  } finally {
    await browser.close();
    console.log('🏁 テスト完了');
  }
})();
```

## 🔄 エラー発見時の即修正フロー

### 1. エラー分析
```javascript
// エラーログから原因特定
if (error.includes('undefined')) {
  // 未定義エラー → 初期化チェック
} else if (error.includes('TypeError')) {
  // 型エラー → 型チェック追加
}
```

### 2. 修正実装
```javascript
// 同一メッセージで修正と再テスト
[Single Message]:
  - Edit("problem-file.js", old, new)
  - Bash("node playwright-test-again.cjs")
```

### 3. 修正確認ループ
- エラー解消まで修正→テストを繰り返す
- 最大3回で解決しない場合は設計見直し

## 📊 テストカバレッジ基準

### 必須テスト項目
- [ ] 基本機能動作
- [ ] エラーハンドリング
- [ ] エッジケース
- [ ] パフォーマンス（1秒以内）
- [ ] モバイル互換性

### テスト種別と実行タイミング
| テスト種別 | 実行タイミング | ツール |
|-----------|--------------|--------|
| ユニットテスト | コード変更時 | Jest/Vitest |
| 統合テスト | 機能完成時 | Playwright |
| E2Eテスト | リリース前 | Playwright |
| 性能テスト | 最適化後 | Lighthouse |

## 🚀 並列テスト実行

### 複数ブラウザ同時テスト
```javascript
// browsers-test.cjs
const browsers = ['chromium', 'firefox', 'webkit'];

Promise.all(browsers.map(async (browserType) => {
  const browser = await playwright[browserType].launch();
  // テスト実行
  await browser.close();
}));
```

### デバイス別テスト
```javascript
const devices = [
  playwright.devices['iPhone 13'],
  playwright.devices['iPad Pro'],
  playwright.devices['Desktop Chrome']
];
```

## 📝 テスト結果レポート

### 自動生成フォーマット
```markdown
# [機能名]テスト結果 - YYYYMMDD HH:MM

## テスト概要
- 対象機能: 
- テスト種別: 
- 実行時間: 

## 結果サマリー
- ✅ 成功: X件
- ❌ 失敗: X件
- ⚠️ 警告: X件

## エラー詳細
[エラーがある場合のみ]

## スクリーンショット
[自動キャプチャ画像]

## 次のアクション
- [ ] 修正必要項目
```

## 🔧 トラブルシューティング

### Playwright使用不可時
1. 別プロファイルで新インスタンス作成
2. ポート変更（8788 → 8789）
3. Docker環境での実行

### テスト高速化
- 並列実行の活用
- キャッシュ活用
- 不要な待機時間削減

## 📌 ベストプラクティス

1. **テストファースト思考**
   - 実装前にテストケース作成
   - 失敗するテストから開始

2. **継続的テスト**
   - commit前に必ずテスト
   - CI/CDパイプライン統合

3. **テストの保守**
   - テストコードも本番コード同様に管理
   - 定期的なリファクタリング

---

このフローに従うことで、品質を保ちながら高速開発を実現します。