<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Ching機能動作確認テスト</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .result { background: #f5f5f5; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 10px; cursor: pointer; }
        textarea { width: 100%; height: 100px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>🎯 HAQEIアナライザー I Ching統合機能 動作確認テスト</h1>
    
    <div class="test-section">
        <h2>Phase 1: システム初期化確認</h2>
        <div id="init-results"></div>
        <button onclick="testSystemInit()">システム初期化テスト実行</button>
    </div>
    
    <div class="test-section">
        <h2>Phase 2: JavaScript エラー確認</h2>
        <div id="error-results"></div>
        <button onclick="testJavaScriptErrors()">JavaScriptエラーテスト実行</button>
    </div>
    
    <div class="test-section">
        <h2>Phase 3: I Ching分析機能テスト</h2>
        <textarea id="situation-input" placeholder="状況を入力してください（例：転職を考えているが、現在の会社を辞めるべきか迷っている）">転職を考えているが、現在の会社を辞めるべきか迷っている</textarea>
        <button onclick="testIChingAnalysis()">I Ching分析テスト実行</button>
        <div id="analysis-results"></div>
    </div>
    
    <div class="test-section">
        <h2>Phase 4: データベース接続確認</h2>
        <div id="database-results"></div>
        <button onclick="testDatabaseConnection()">データベース接続テスト実行</button>
    </div>
    
    <div class="test-section">
        <h2>Phase 5: 包括的機能確認</h2>
        <div id="comprehensive-results"></div>
        <button onclick="runComprehensiveTest()">包括テスト実行</button>
    </div>

    <script>
        let testResults = {
            systemInit: false,
            jsErrors: [],
            ichingAnalysis: false,
            databaseConnection: false,
            overallStatus: 'pending'
        };

        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : type === 'warning' ? 'warning' : '';
            element.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()}: ${message}</div>`;
        }

        function testSystemInit() {
            log('init-results', '🔄 システム初期化テストを開始します...', 'info');
            
            // H384データの確認
            if (typeof window.H384_DATA !== 'undefined') {
                log('init-results', `✅ H384_DATA読み込み成功: ${window.H384_DATA.length}エントリー`, 'success');
                testResults.systemInit = true;
            } else {
                log('init-results', '❌ H384_DATAが読み込まれていません', 'error');
            }
            
            // I Ching関連クラスの確認
            const ichingClasses = [
                'IChingFutureSimulator',
                'IChingSituationAnalyzer', 
                'YaoTransformationSimulator',
                'IChingMetaphorDisplay'
            ];
            
            ichingClasses.forEach(className => {
                if (typeof window[className] !== 'undefined') {
                    log('init-results', `✅ ${className}クラス利用可能`, 'success');
                } else {
                    log('init-results', `⚠️ ${className}クラスが見つかりません`, 'warning');
                }
            });
            
            // グローバル変数の確認
            const globalVars = ['hexagrams_master', 'futureThemeMap', 'koudoShishinData'];
            globalVars.forEach(varName => {
                if (typeof window[varName] !== 'undefined') {
                    log('init-results', `✅ ${varName}利用可能`, 'success');
                } else {
                    log('init-results', `⚠️ ${varName}が見つかりません`, 'warning');
                }
            });
        }

        function testJavaScriptErrors() {
            log('error-results', '🔄 JavaScriptエラーテストを開始します...', 'info');
            
            // コンソールエラーのキャプチャ
            const originalError = console.error;
            let errorCount = 0;
            
            console.error = function(...args) {
                errorCount++;
                const errorMsg = args.join(' ');
                if (errorMsg.includes('await is only valid in async functions')) {
                    log('error-results', `❌ CRITICAL: ${errorMsg}`, 'error');
                    testResults.jsErrors.push(errorMsg);
                } else {
                    log('error-results', `⚠️ Error: ${errorMsg}`, 'warning');
                }
                originalError.apply(console, args);
            };
            
            // 基本的な動作テスト
            try {
                // 簡単な関数実行テスト
                const testFunction = () => {
                    return "Test successful";
                };
                const result = testFunction();
                log('error-results', `✅ 基本JavaScript動作: ${result}`, 'success');
            } catch (error) {
                log('error-results', `❌ 基本JavaScript動作エラー: ${error.message}`, 'error');
                testResults.jsErrors.push(error.message);
            }
            
            setTimeout(() => {
                if (errorCount === 0) {
                    log('error-results', '✅ JavaScriptエラーは検出されませんでした', 'success');
                } else {
                    log('error-results', `❌ ${errorCount}個のエラーが検出されました`, 'error');
                }
                console.error = originalError;
            }, 2000);
        }

        function testIChingAnalysis() {
            const situation = document.getElementById('situation-input').value;
            log('analysis-results', `🔄 I Ching分析テストを開始します: "${situation}"`, 'info');
            
            try {
                // IChingFutureSimulatorの動作テスト
                if (typeof IChingFutureSimulator !== 'undefined') {
                    const container = document.createElement('div');
                    const simulator = new IChingFutureSimulator(container);
                    log('analysis-results', '✅ IChingFutureSimulator初期化成功', 'success');
                    
                    // 初期化テスト
                    if (typeof simulator.init === 'function') {
                        simulator.init().then(() => {
                            log('analysis-results', '✅ I Chingシステム初期化完了', 'success');
                            testResults.ichingAnalysis = true;
                        }).catch(error => {
                            log('analysis-results', `❌ I Chingシステム初期化エラー: ${error.message}`, 'error');
                        });
                    }
                } else {
                    log('analysis-results', '❌ IChingFutureSimulatorクラスが利用できません', 'error');
                }
                
                // 状況分析のテスト
                if (typeof IChingSituationAnalyzer !== 'undefined') {
                    const analyzer = new IChingSituationAnalyzer();
                    log('analysis-results', '✅ IChingSituationAnalyzer初期化成功', 'success');
                } else {
                    log('analysis-results', '⚠️ IChingSituationAnalyzerが見つかりません', 'warning');
                }
                
            } catch (error) {
                log('analysis-results', `❌ I Ching分析テストエラー: ${error.message}`, 'error');
                testResults.jsErrors.push(error.message);
            }
        }

        function testDatabaseConnection() {
            log('database-results', '🔄 データベース接続テストを開始します...', 'info');
            
            // H384データベーステスト
            if (window.H384_DATA && Array.isArray(window.H384_DATA)) {
                log('database-results', `✅ H384データベース接続成功: ${window.H384_DATA.length}エントリー`, 'success');
                
                // サンプルデータの確認
                const sampleEntry = window.H384_DATA[0];
                if (sampleEntry && typeof sampleEntry === 'object') {
                    log('database-results', `✅ サンプルデータ構造確認: ${Object.keys(sampleEntry).join(', ')}`, 'success');
                    testResults.databaseConnection = true;
                } else {
                    log('database-results', '❌ H384データの構造に問題があります', 'error');
                }
            } else {
                log('database-results', '❌ H384データベースが利用できません', 'error');
            }
            
            // その他のデータベースの確認
            const databases = [
                { name: 'hexagrams_master', desc: '64卦マスターデータ' },
                { name: 'futureThemeMap', desc: '未来テーママップ' },
                { name: 'koudoShishinData', desc: '行動指針データ' }
            ];
            
            databases.forEach(db => {
                if (window[db.name]) {
                    log('database-results', `✅ ${db.desc}利用可能`, 'success');
                } else {
                    log('database-results', `⚠️ ${db.desc}が見つかりません`, 'warning');
                }
            });
        }

        function runComprehensiveTest() {
            log('comprehensive-results', '🎯 包括的機能確認テストを開始します...', 'info');
            
            // 全てのテストを順次実行
            testSystemInit();
            setTimeout(() => testJavaScriptErrors(), 1000);
            setTimeout(() => testIChingAnalysis(), 2000);
            setTimeout(() => testDatabaseConnection(), 3000);
            
            setTimeout(() => {
                // 総合評価
                const passedTests = [
                    testResults.systemInit,
                    testResults.jsErrors.length === 0,
                    testResults.ichingAnalysis,
                    testResults.databaseConnection
                ].filter(test => test).length;
                
                const totalTests = 4;
                const successRate = Math.round((passedTests / totalTests) * 100);
                
                if (successRate >= 80) {
                    testResults.overallStatus = 'success';
                    log('comprehensive-results', `🎉 総合テスト結果: ${successRate}% (${passedTests}/${totalTests}) - 成功`, 'success');
                    log('comprehensive-results', '✅ HAQEIアナライザーI Ching統合機能は正常に動作しています！', 'success');
                } else if (successRate >= 60) {
                    testResults.overallStatus = 'partial';
                    log('comprehensive-results', `⚠️ 総合テスト結果: ${successRate}% (${passedTests}/${totalTests}) - 部分的成功`, 'warning');
                    log('comprehensive-results', '⚠️ 一部の機能に問題がありますが、基本動作は可能です', 'warning');
                } else {
                    testResults.overallStatus = 'failure';
                    log('comprehensive-results', `❌ 総合テスト結果: ${successRate}% (${passedTests}/${totalTests}) - 修正が必要`, 'error');
                    log('comprehensive-results', '❌ システムに重要な問題があります。修正が必要です。', 'error');
                }
                
                // エラーサマリー
                if (testResults.jsErrors.length > 0) {
                    log('comprehensive-results', `📋 検出されたエラー数: ${testResults.jsErrors.length}`, 'error');
                    testResults.jsErrors.forEach((error, index) => {
                        log('comprehensive-results', `${index + 1}. ${error}`, 'error');
                    });
                }
                
            }, 5000);
        }

        // ページ読み込み時の自動チェック
        window.addEventListener('load', function() {
            log('init-results', '🚀 ページ読み込み完了。テスト準備完了。', 'success');
        });
    </script>
</body>
</html>