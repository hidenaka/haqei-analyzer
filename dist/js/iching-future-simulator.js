class IChingFutureSimulator{constructor(n){this.container=n,this.situationAnalyzer=null,this.transformationSimulator=null,this.metaphorDisplay=null,this.branchingSystem=null,this.currentAnalysis=null,this.isInitialized=!1,console.log("ğŸ¯ I Ching Future Simulator initializing...")}async init(){try{return console.log("ğŸ”„ Initializing I Ching Future Simulator components..."),this.initializeComponents(),this.loadH384Data(),this.setupEventListeners(),this.initializeUI(),this.isInitialized=!0,console.log("âœ… I Ching Future Simulator initialized successfully"),!0}catch(n){return console.error("âŒ Failed to initialize I Ching Future Simulator:",n),!1}}async initializeComponents(){this.situationAnalyzer=new IChingSituationAnalyzer,this.situationAnalyzer.init(),this.transformationSimulator=new YaoTransformationSimulator(this.situationAnalyzer),this.transformationSimulator.init();const n=this.container.querySelector("#iching-metaphor-container")||this.container;this.metaphorDisplay=new IChingMetaphorDisplay(n),this.metaphorDisplay.init(),window.FutureBranchingSystem&&(this.branchingSystem=new FutureBranchingSystem)}async loadH384Data(){try{if(window.H384_DATA&&Array.isArray(window.H384_DATA))return console.log("âœ… H384_DATA already loaded:",window.H384_DATA.length,"entries"),!0;const n=document.createElement("script");return n.src="./assets/H384H64database.js",new Promise((t,e)=>{n.onload=()=>{window.H384_DATA&&Array.isArray(window.H384_DATA)?(console.log("âœ… H384_DATA loaded successfully:",window.H384_DATA.length,"entries"),t(!0)):e(new Error("H384_DATA not available after script load"))},n.onerror=()=>{e(new Error("Failed to load H384_DATA script"))},document.head.appendChild(n)})}catch(n){throw console.error("âŒ Failed to load H384 data:",n),n}}setupEventListeners(){this.metaphorDisplay&&this.metaphorDisplay.container&&this.metaphorDisplay.container.addEventListener("ichingTransformation",n=>{this.handleTransformation(n.detail)});const n=document.getElementById("situation-analysis-form");n&&n.addEventListener("submit",n=>{n.preventDefault(),this.handleSituationInput(n)});const t=document.getElementById("quick-analysis-btn");t&&t.addEventListener("click",()=>{this.runQuickAnalysis()})}initializeUI(){document.getElementById("situation-input-section")||this.createInputSection(),document.getElementById("simulator-status")||this.createStatusSection()}createInputSection(){const n=document.createElement("div");n.id="situation-input-section",n.className="situation-input-section",n.innerHTML='\n      <div class="input-header">\n        <h3>ğŸ” çŠ¶æ³åˆ†æ</h3>\n        <p>ç¾åœ¨ã®çŠ¶æ³ã‚„æ‚©ã¿ã‚’è‡ªç”±ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚æ˜“çµŒã®çŸ¥æµã§åˆ†æã—ã€æœ€é©ãªæœªæ¥ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æç¤ºã—ã¾ã™ã€‚</p>\n      </div>\n      \n      <form id="situation-analysis-form" class="analysis-form">\n        <div class="input-group">\n          <label for="situation-text">ç¾åœ¨ã®çŠ¶æ³ãƒ»æ‚©ã¿ãƒ»èª²é¡Œ</label>\n          <textarea \n            id="situation-text" \n            name="situation" \n            rows="4" \n            placeholder="ä¾‹: è»¢è·ã‚’è€ƒãˆã¦ã„ã‚‹ãŒã€ä»Šã®å®‰å®šã—ãŸè·å ´ã‚’é›¢ã‚Œã‚‹ã¹ãã‹è¿·ã£ã¦ã„ã¾ã™ã€‚æ–°ã—ã„æŒ‘æˆ¦ã‚’ã—ãŸã„æ°—æŒã¡ã¨ã€ãƒªã‚¹ã‚¯ã‚’æã‚Œã‚‹æ°—æŒã¡ãŒæ··åœ¨ã—ã¦ã„ã¾ã™..."\n            required\n          ></textarea>\n        </div>\n        \n        <div class="form-actions">\n          <button type="submit" class="analyze-btn primary">\n            <span class="btn-icon">ğŸ¯</span>\n            çŠ¶æ³ã‚’åˆ†æã™ã‚‹\n          </button>\n          <button type="button" id="quick-analysis-btn" class="analyze-btn secondary">\n            <span class="btn-icon">âš¡</span>\n            ã‚¯ã‚¤ãƒƒã‚¯åˆ†æ\n          </button>\n        </div>\n      </form>\n      \n      <div class="example-situations">\n        <h4>åˆ†æä¾‹</h4>\n        <div class="example-grid">\n          <button class="example-btn" data-example="career">\n            ğŸ’¼ ã‚­ãƒ£ãƒªã‚¢ã®æ‚©ã¿\n          </button>\n          <button class="example-btn" data-example="love">\n            ğŸ’• æ‹æ„›ãƒ»äººé–“é–¢ä¿‚\n          </button>\n          <button class="example-btn" data-example="life">\n            ğŸŒ± äººç”Ÿã®è»¢æ›ç‚¹\n          </button>\n        </div>\n      </div>\n    ',this.container.insertBefore(n,this.container.firstChild);n.querySelectorAll(".example-btn").forEach(n=>{n.addEventListener("click",()=>{this.loadExampleSituation(n.dataset.example)})}),this.addInputSectionStyles()}createStatusSection(){const n=document.createElement("div");n.id="simulator-status",n.className="simulator-status",n.innerHTML='\n      <div class="status-indicator">\n        <div class="status-icon">ğŸŒŸ</div>\n        <div class="status-text">æ˜“çµŒã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼æº–å‚™å®Œäº†</div>\n      </div>\n    ',this.container.appendChild(n)}addInputSectionStyles(){if(document.getElementById("input-section-styles"))return;const n=document.createElement("style");n.id="input-section-styles",n.textContent="\n      .situation-input-section {\n        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);\n        border: 2px solid rgba(99, 102, 241, 0.3);\n        border-radius: 1rem;\n        padding: 2rem;\n        margin-bottom: 2rem;\n        color: #ffffff;\n      }\n\n      .input-header {\n        text-align: center;\n        margin-bottom: 2rem;\n      }\n\n      .input-header h3 {\n        font-size: 1.5rem;\n        font-weight: 700;\n        margin-bottom: 0.5rem;\n        background: linear-gradient(135deg, #6366f1, #a855f7);\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n      }\n\n      .input-header p {\n        color: #94a3b8;\n        font-size: 0.975rem;\n        line-height: 1.6;\n      }\n\n      .analysis-form {\n        margin-bottom: 2rem;\n      }\n\n      .input-group {\n        margin-bottom: 1.5rem;\n      }\n\n      .input-group label {\n        display: block;\n        font-weight: 600;\n        margin-bottom: 0.5rem;\n        color: #e2e8f0;\n      }\n\n      .input-group textarea {\n        width: 100%;\n        padding: 1rem;\n        background: rgba(51, 65, 85, 0.5);\n        border: 1px solid rgba(148, 163, 184, 0.3);\n        border-radius: 0.5rem;\n        color: #ffffff;\n        font-size: 1rem;\n        line-height: 1.5;\n        resize: vertical;\n        font-family: inherit;\n      }\n\n      .input-group textarea:focus {\n        outline: none;\n        border-color: #6366f1;\n        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n      }\n\n      .input-group textarea::placeholder {\n        color: #64748b;\n      }\n\n      .form-actions {\n        display: flex;\n        gap: 1rem;\n        justify-content: center;\n        flex-wrap: wrap;\n      }\n\n      .analyze-btn {\n        display: flex;\n        align-items: center;\n        gap: 0.5rem;\n        padding: 0.75rem 1.5rem;\n        border: none;\n        border-radius: 0.5rem;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        font-size: 1rem;\n      }\n\n      .analyze-btn.primary {\n        background: linear-gradient(135deg, #6366f1, #8b5cf6);\n        color: #ffffff;\n      }\n\n      .analyze-btn.primary:hover {\n        background: linear-gradient(135deg, #5855eb, #7c3aed);\n        transform: translateY(-2px);\n        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);\n      }\n\n      .analyze-btn.secondary {\n        background: rgba(51, 65, 85, 0.8);\n        color: #e2e8f0;\n        border: 1px solid rgba(148, 163, 184, 0.3);\n      }\n\n      .analyze-btn.secondary:hover {\n        background: rgba(71, 85, 105, 0.8);\n        border-color: rgba(99, 102, 241, 0.5);\n      }\n\n      .example-situations {\n        border-top: 1px solid rgba(148, 163, 184, 0.2);\n        padding-top: 1.5rem;\n      }\n\n      .example-situations h4 {\n        font-size: 1rem;\n        font-weight: 600;\n        margin-bottom: 1rem;\n        color: #cbd5e1;\n        text-align: center;\n      }\n\n      .example-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 1rem;\n      }\n\n      .example-btn {\n        padding: 1rem;\n        background: rgba(51, 65, 85, 0.3);\n        border: 1px solid rgba(148, 163, 184, 0.2);\n        border-radius: 0.5rem;\n        color: #e2e8f0;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        font-size: 0.875rem;\n        text-align: center;\n      }\n\n      .example-btn:hover {\n        border-color: rgba(99, 102, 241, 0.5);\n        background: rgba(99, 102, 241, 0.1);\n        transform: translateY(-2px);\n      }\n\n      .simulator-status {\n        position: fixed;\n        bottom: 2rem;\n        right: 2rem;\n        background: rgba(30, 41, 59, 0.9);\n        backdrop-filter: blur(10px);\n        border: 1px solid rgba(99, 102, 241, 0.3);\n        border-radius: 0.75rem;\n        padding: 1rem;\n        color: #ffffff;\n        z-index: 1000;\n        min-width: 200px;\n      }\n\n      .status-indicator {\n        display: flex;\n        align-items: center;\n        gap: 0.75rem;\n      }\n\n      .status-icon {\n        font-size: 1.25rem;\n      }\n\n      .status-text {\n        font-size: 0.875rem;\n        font-weight: 500;\n      }\n\n      @media (max-width: 768px) {\n        .form-actions {\n          flex-direction: column;\n        }\n        \n        .example-grid {\n          grid-template-columns: 1fr;\n        }\n        \n        .simulator-status {\n          bottom: 1rem;\n          right: 1rem;\n          left: 1rem;\n        }\n      }\n    ",document.head.appendChild(n)}loadExampleSituation(n){const t={career:"ç¾åœ¨5å¹´é–“åŒã˜ä¼šç¤¾ã§åƒã„ã¦ã„ã¾ã™ãŒã€æˆé•·ãŒåœæ»ã—ã¦ã„ã‚‹æ„Ÿã˜ãŒã—ã¾ã™ã€‚è»¢è·ã‚’è€ƒãˆã¦ã„ã¾ã™ãŒã€ä»Šã®å®‰å®šã—ãŸç’°å¢ƒã‚’é›¢ã‚Œã‚‹ã“ã¨ã¸ã®ä¸å®‰ã¨ã€æ–°ã—ã„æŒ‘æˆ¦ã¸ã®æœŸå¾…ãŒæ··åœ¨ã—ã¦ã„ã¾ã™ã€‚ã©ã†åˆ¤æ–­ã™ã¹ãã‹è¿·ã£ã¦ã„ã¾ã™ã€‚",love:"3å¹´ä»˜ãåˆã£ã¦ã„ã‚‹æ‹äººãŒã„ã¾ã™ãŒã€æœ€è¿‘å°†æ¥ã¸ã®ä¸å®‰ã‚’æ„Ÿã˜ã¦ã„ã¾ã™ã€‚çµå©šã®è©±ã‚‚å‡ºã¦ã„ã¾ã™ãŒã€æœ¬å½“ã«ã“ã®äººã¨ä¸€ç”Ÿã‚’å…±ã«ã§ãã‚‹ã®ã‹ã€ä»–ã«ã‚‚ã£ã¨è‰¯ã„ç›¸æ‰‹ãŒã„ã‚‹ã®ã§ã¯ãªã„ã‹ã¨ã„ã†æ€ã„ãŒé ­ã‚’ã‚ˆãã‚Šã¾ã™ã€‚",life:"äººç”Ÿã®å¤§ããªè»¢æ›ç‚¹ã«ç«‹ã£ã¦ã„ã¾ã™ã€‚ä»Šã®ç”Ÿæ´»ã¯å®‰å®šã—ã¦ã„ã¾ã™ãŒã€ã©ã“ã‹ç‰©è¶³ã‚Šãªã•ã‚’æ„Ÿã˜ã¦ã„ã¾ã™ã€‚æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ãŸã„æ°—æŒã¡ã¨ã€å¤‰åŒ–ã¸ã®æã‚ŒãŒæˆ¦ã£ã¦ã„ã¦ã€ã©ã®æ–¹å‘ã«é€²ã‚€ã¹ãã‹åˆ†ã‹ã‚‰ãªã„çŠ¶æ…‹ã§ã™ã€‚"},e=document.getElementById("situation-text");e&&t[n]&&(e.value=t[n],e.focus())}async handleSituationInput(n){const t=new FormData(n.target).get("situation");!t||t.trim().length<10?alert("çŠ¶æ³ã‚’ã‚‚ã†å°‘ã—è©³ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ10æ–‡å­—ä»¥ä¸Šï¼‰"):await this.analyzeSituation(t)}async runQuickAnalysis(){const n=["äººç”Ÿã®é‡è¦ãªé¸æŠã«è¿«ã‚‰ã‚Œã¦ãŠã‚Šã€ã©ã®é“ã‚’é¸ã¶ã¹ãã‹è¿·ã£ã¦ã„ã¾ã™ã€‚","æ–°ã—ã„ç’°å¢ƒã¸ã®å¤‰åŒ–ã‚’è€ƒãˆã¦ã„ã‚‹ãŒã€ãƒªã‚¹ã‚¯ã¨å¯èƒ½æ€§ã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ¸¬ã‚Šã‹ã­ã¦ã„ã¾ã™ã€‚","ç¾åœ¨ã®çŠ¶æ³ã«æº€è¶³ã—ã¦ã„ãªã„ãŒã€å…·ä½“çš„ã«ã©ã†å¤‰ãˆã‚‹ã¹ãã‹æ–¹å‘æ€§ãŒè¦‹ãˆã¾ã›ã‚“ã€‚"],t=n[Math.floor(Math.random()*n.length)];await this.analyzeSituation(t)}async analyzeSituation(n){if(this.isInitialized)try{console.log("ğŸ” Analyzing situation:",n.substring(0,50)+"..."),this.updateStatus("åˆ†æä¸­...","ğŸ”„"),console.log("ğŸ¯ [DEBUG] Calling situationAnalyzer.analyzeSituation...");const t=this.situationAnalyzer.analyzeSituation(n);if(console.log("ğŸ¯ [DEBUG] Analysis result received:",!!t),!t)throw new Error("Analysis failed");this.currentAnalysis={...t,inputText:n,timestamp:(new Date).toISOString()},console.log("ğŸ¯ [DEBUG] Calling metaphorDisplay.displaySituationAnalysis..."),this.metaphorDisplay.displaySituationAnalysis(this.currentAnalysis),this.updateStatus("åˆ†æå®Œäº† - ãƒ†ãƒ¼ãƒã‚’é¸æŠã—ã¦ãã ã•ã„","âœ…"),this.collapsInputSection(),console.log("âœ… Situation analysis completed:",this.currentAnalysis)}catch(t){console.error("âŒ Analysis error:",t),this.updateStatus("åˆ†æã‚¨ãƒ©ãƒ¼","âŒ"),alert("åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚")}else console.error("âŒ Simulator not initialized")}async handleTransformation(n){const{currentSituation:t,choice:e}=n;if(t&&e)try{console.log("ğŸ”„ Processing transformation:",e),this.updateStatus("æœªæ¥ã‚·ãƒŠãƒªã‚ªã‚’ç”Ÿæˆä¸­...","ğŸ”®");const n=this.transformationSimulator.simulateTransformation(t,e);if(!n)throw new Error("Transformation failed");this.metaphorDisplay.displayTransformation(n),this.branchingSystem&&this.integrateBranchingSystem(n),this.updateStatus("ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†","ğŸŒŸ"),console.log("âœ… Transformation completed:",n)}catch(i){console.error("âŒ Transformation error:",i),this.updateStatus("ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼","âŒ"),alert("ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚")}else console.error("âŒ Invalid transformation data")}async integrateBranchingSystem(n){if(this.branchingSystem)try{const e={current:n.newSituation.h384Entry?n.newSituation.h384Entry["ç¾ä»£è§£é‡ˆã®è¦ç´„"]:"æ–°ã—ã„çŠ¶æ³ã«ç§»è¡Œã—ã¾ã—ãŸ",choices:n.scenarios.map(n=>({type:n.type,label:n.title,description:n.timeline[0]?.description||n.title})),outcomes:n.scenarios.map(n=>({type:"optimistic"===n.type?"positive":"challenging"===n.type?"challenging":"neutral",label:n.title,description:n.outcomes[0]?.title||n.title,timeframe:n.timeline[0]?.timeframe||"æœªæ¥",probability:Math.round(100*n.probability)}))},i=document.getElementById("future-branching-container");if(i&&this.branchingSystem)try{"function"==typeof this.branchingSystem.init&&await this.branchingSystem.init(i),"function"==typeof this.branchingSystem.createBranching?this.branchingSystem.createBranching(e):console.log("ğŸ“Š FutureBranchingSystemçµ±åˆã‚¹ã‚­ãƒƒãƒ—ï¼ˆcreateBranchingãƒ¡ã‚½ãƒƒãƒ‰æœªå®Ÿè£…ï¼‰")}catch(t){console.warn("âš ï¸ FutureBranchingSystemçµ±åˆã‚¨ãƒ©ãƒ¼:",t.message)}}catch(t){console.error("âŒ Branching system integration error:",t)}}updateStatus(n,t="ğŸŒŸ"){const e=document.querySelector(".status-text"),i=document.querySelector(".status-icon");e&&(e.textContent=n),i&&(i.textContent=t)}collapsInputSection(){const n=document.getElementById("situation-input-section");if(n){n.style.transform="translateY(-20px)",n.style.opacity="0.7",n.style.maxHeight="200px",n.style.overflow="hidden";const t=document.createElement("button");t.textContent="ğŸ”„ å†åˆ†æ",t.className="analyze-btn secondary",t.style.margin="1rem auto",t.style.display="block",t.addEventListener("click",()=>{this.expandInputSection()}),n.appendChild(t)}}expandInputSection(){const n=document.getElementById("situation-input-section");if(n){n.style.transform="translateY(0)",n.style.opacity="1",n.style.maxHeight="none";const t=n.querySelector("button:last-child");t&&t.textContent.includes("å†åˆ†æ")&&t.remove(),this.metaphorDisplay&&this.metaphorDisplay.reset(),this.updateStatus("å†åˆ†æã®æº–å‚™å®Œäº†","ğŸ”„")}}reset(){this.currentAnalysis=null,this.metaphorDisplay&&this.metaphorDisplay.reset(),this.expandInputSection();const n=document.getElementById("situation-text");n&&(n.value=""),this.updateStatus("ãƒªã‚»ãƒƒãƒˆå®Œäº†","ğŸ”„")}async analyzeText(n){return await this.analyzeSituation(n)}getCurrentAnalysis(){return this.currentAnalysis}isReady(){return this.isInitialized&&this.situationAnalyzer&&this.transformationSimulator&&this.metaphorDisplay}}window.IChingFutureSimulator=IChingFutureSimulator;