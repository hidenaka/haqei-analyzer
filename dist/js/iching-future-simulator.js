class IChingFutureSimulator{constructor(n){this.container=n,this.situationAnalyzer=null,this.transformationSimulator=null,this.metaphorDisplay=null,this.branchingSystem=null,this.currentAnalysis=null,this.isInitialized=!1,console.log("🎯 I Ching Future Simulator initializing...")}async init(){try{return console.log("🔄 Initializing I Ching Future Simulator components..."),this.initializeComponents(),this.loadH384Data(),this.setupEventListeners(),this.initializeUI(),this.isInitialized=!0,console.log("✅ I Ching Future Simulator initialized successfully"),!0}catch(n){return console.error("❌ Failed to initialize I Ching Future Simulator:",n),!1}}async initializeComponents(){this.situationAnalyzer=new IChingSituationAnalyzer,this.situationAnalyzer.init(),this.transformationSimulator=new YaoTransformationSimulator(this.situationAnalyzer),this.transformationSimulator.init();const n=this.container.querySelector("#iching-metaphor-container")||this.container;this.metaphorDisplay=new IChingMetaphorDisplay(n),this.metaphorDisplay.init(),window.FutureBranchingSystem&&(this.branchingSystem=new FutureBranchingSystem)}async loadH384Data(){try{if(window.H384_DATA&&Array.isArray(window.H384_DATA))return console.log("✅ H384_DATA already loaded:",window.H384_DATA.length,"entries"),!0;const n=document.createElement("script");return n.src="./assets/H384H64database.js",new Promise((t,e)=>{n.onload=()=>{window.H384_DATA&&Array.isArray(window.H384_DATA)?(console.log("✅ H384_DATA loaded successfully:",window.H384_DATA.length,"entries"),t(!0)):e(new Error("H384_DATA not available after script load"))},n.onerror=()=>{e(new Error("Failed to load H384_DATA script"))},document.head.appendChild(n)})}catch(n){throw console.error("❌ Failed to load H384 data:",n),n}}setupEventListeners(){this.metaphorDisplay&&this.metaphorDisplay.container&&this.metaphorDisplay.container.addEventListener("ichingTransformation",n=>{this.handleTransformation(n.detail)});const n=document.getElementById("situation-analysis-form");n&&n.addEventListener("submit",n=>{n.preventDefault(),this.handleSituationInput(n)});const t=document.getElementById("quick-analysis-btn");t&&t.addEventListener("click",()=>{this.runQuickAnalysis()})}initializeUI(){document.getElementById("situation-input-section")||this.createInputSection(),document.getElementById("simulator-status")||this.createStatusSection()}createInputSection(){const n=document.createElement("div");n.id="situation-input-section",n.className="situation-input-section",n.innerHTML='\n      <div class="input-header">\n        <h3>🔍 状況分析</h3>\n        <p>現在の状況や悩みを自由に入力してください。易経の知恵で分析し、最適な未来パターンを提示します。</p>\n      </div>\n      \n      <form id="situation-analysis-form" class="analysis-form">\n        <div class="input-group">\n          <label for="situation-text">現在の状況・悩み・課題</label>\n          <textarea \n            id="situation-text" \n            name="situation" \n            rows="4" \n            placeholder="例: 転職を考えているが、今の安定した職場を離れるべきか迷っています。新しい挑戦をしたい気持ちと、リスクを恐れる気持ちが混在しています..."\n            required\n          ></textarea>\n        </div>\n        \n        <div class="form-actions">\n          <button type="submit" class="analyze-btn primary">\n            <span class="btn-icon">🎯</span>\n            状況を分析する\n          </button>\n          <button type="button" id="quick-analysis-btn" class="analyze-btn secondary">\n            <span class="btn-icon">⚡</span>\n            クイック分析\n          </button>\n        </div>\n      </form>\n      \n      <div class="example-situations">\n        <h4>分析例</h4>\n        <div class="example-grid">\n          <button class="example-btn" data-example="career">\n            💼 キャリアの悩み\n          </button>\n          <button class="example-btn" data-example="love">\n            💕 恋愛・人間関係\n          </button>\n          <button class="example-btn" data-example="life">\n            🌱 人生の転換点\n          </button>\n        </div>\n      </div>\n    ',this.container.insertBefore(n,this.container.firstChild);n.querySelectorAll(".example-btn").forEach(n=>{n.addEventListener("click",()=>{this.loadExampleSituation(n.dataset.example)})}),this.addInputSectionStyles()}createStatusSection(){const n=document.createElement("div");n.id="simulator-status",n.className="simulator-status",n.innerHTML='\n      <div class="status-indicator">\n        <div class="status-icon">🌟</div>\n        <div class="status-text">易経シミュレーター準備完了</div>\n      </div>\n    ',this.container.appendChild(n)}addInputSectionStyles(){if(document.getElementById("input-section-styles"))return;const n=document.createElement("style");n.id="input-section-styles",n.textContent="\n      .situation-input-section {\n        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);\n        border: 2px solid rgba(99, 102, 241, 0.3);\n        border-radius: 1rem;\n        padding: 2rem;\n        margin-bottom: 2rem;\n        color: #ffffff;\n      }\n\n      .input-header {\n        text-align: center;\n        margin-bottom: 2rem;\n      }\n\n      .input-header h3 {\n        font-size: 1.5rem;\n        font-weight: 700;\n        margin-bottom: 0.5rem;\n        background: linear-gradient(135deg, #6366f1, #a855f7);\n        -webkit-background-clip: text;\n        -webkit-text-fill-color: transparent;\n      }\n\n      .input-header p {\n        color: #94a3b8;\n        font-size: 0.975rem;\n        line-height: 1.6;\n      }\n\n      .analysis-form {\n        margin-bottom: 2rem;\n      }\n\n      .input-group {\n        margin-bottom: 1.5rem;\n      }\n\n      .input-group label {\n        display: block;\n        font-weight: 600;\n        margin-bottom: 0.5rem;\n        color: #e2e8f0;\n      }\n\n      .input-group textarea {\n        width: 100%;\n        padding: 1rem;\n        background: rgba(51, 65, 85, 0.5);\n        border: 1px solid rgba(148, 163, 184, 0.3);\n        border-radius: 0.5rem;\n        color: #ffffff;\n        font-size: 1rem;\n        line-height: 1.5;\n        resize: vertical;\n        font-family: inherit;\n      }\n\n      .input-group textarea:focus {\n        outline: none;\n        border-color: #6366f1;\n        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);\n      }\n\n      .input-group textarea::placeholder {\n        color: #64748b;\n      }\n\n      .form-actions {\n        display: flex;\n        gap: 1rem;\n        justify-content: center;\n        flex-wrap: wrap;\n      }\n\n      .analyze-btn {\n        display: flex;\n        align-items: center;\n        gap: 0.5rem;\n        padding: 0.75rem 1.5rem;\n        border: none;\n        border-radius: 0.5rem;\n        font-weight: 600;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        font-size: 1rem;\n      }\n\n      .analyze-btn.primary {\n        background: linear-gradient(135deg, #6366f1, #8b5cf6);\n        color: #ffffff;\n      }\n\n      .analyze-btn.primary:hover {\n        background: linear-gradient(135deg, #5855eb, #7c3aed);\n        transform: translateY(-2px);\n        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);\n      }\n\n      .analyze-btn.secondary {\n        background: rgba(51, 65, 85, 0.8);\n        color: #e2e8f0;\n        border: 1px solid rgba(148, 163, 184, 0.3);\n      }\n\n      .analyze-btn.secondary:hover {\n        background: rgba(71, 85, 105, 0.8);\n        border-color: rgba(99, 102, 241, 0.5);\n      }\n\n      .example-situations {\n        border-top: 1px solid rgba(148, 163, 184, 0.2);\n        padding-top: 1.5rem;\n      }\n\n      .example-situations h4 {\n        font-size: 1rem;\n        font-weight: 600;\n        margin-bottom: 1rem;\n        color: #cbd5e1;\n        text-align: center;\n      }\n\n      .example-grid {\n        display: grid;\n        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));\n        gap: 1rem;\n      }\n\n      .example-btn {\n        padding: 1rem;\n        background: rgba(51, 65, 85, 0.3);\n        border: 1px solid rgba(148, 163, 184, 0.2);\n        border-radius: 0.5rem;\n        color: #e2e8f0;\n        cursor: pointer;\n        transition: all 0.3s ease;\n        font-size: 0.875rem;\n        text-align: center;\n      }\n\n      .example-btn:hover {\n        border-color: rgba(99, 102, 241, 0.5);\n        background: rgba(99, 102, 241, 0.1);\n        transform: translateY(-2px);\n      }\n\n      .simulator-status {\n        position: fixed;\n        bottom: 2rem;\n        right: 2rem;\n        background: rgba(30, 41, 59, 0.9);\n        backdrop-filter: blur(10px);\n        border: 1px solid rgba(99, 102, 241, 0.3);\n        border-radius: 0.75rem;\n        padding: 1rem;\n        color: #ffffff;\n        z-index: 1000;\n        min-width: 200px;\n      }\n\n      .status-indicator {\n        display: flex;\n        align-items: center;\n        gap: 0.75rem;\n      }\n\n      .status-icon {\n        font-size: 1.25rem;\n      }\n\n      .status-text {\n        font-size: 0.875rem;\n        font-weight: 500;\n      }\n\n      @media (max-width: 768px) {\n        .form-actions {\n          flex-direction: column;\n        }\n        \n        .example-grid {\n          grid-template-columns: 1fr;\n        }\n        \n        .simulator-status {\n          bottom: 1rem;\n          right: 1rem;\n          left: 1rem;\n        }\n      }\n    ",document.head.appendChild(n)}loadExampleSituation(n){const t={career:"現在5年間同じ会社で働いていますが、成長が停滞している感じがします。転職を考えていますが、今の安定した環境を離れることへの不安と、新しい挑戦への期待が混在しています。どう判断すべきか迷っています。",love:"3年付き合っている恋人がいますが、最近将来への不安を感じています。結婚の話も出ていますが、本当にこの人と一生を共にできるのか、他にもっと良い相手がいるのではないかという思いが頭をよぎります。",life:"人生の大きな転換点に立っています。今の生活は安定していますが、どこか物足りなさを感じています。新しいことを始めたい気持ちと、変化への恐れが戦っていて、どの方向に進むべきか分からない状態です。"},e=document.getElementById("situation-text");e&&t[n]&&(e.value=t[n],e.focus())}async handleSituationInput(n){const t=new FormData(n.target).get("situation");!t||t.trim().length<10?alert("状況をもう少し詳しく入力してください（10文字以上）"):await this.analyzeSituation(t)}async runQuickAnalysis(){const n=["人生の重要な選択に迫られており、どの道を選ぶべきか迷っています。","新しい環境への変化を考えているが、リスクと可能性のバランスを測りかねています。","現在の状況に満足していないが、具体的にどう変えるべきか方向性が見えません。"],t=n[Math.floor(Math.random()*n.length)];await this.analyzeSituation(t)}async analyzeSituation(n){if(this.isInitialized)try{console.log("🔍 Analyzing situation:",n.substring(0,50)+"..."),this.updateStatus("分析中...","🔄"),console.log("🎯 [DEBUG] Calling situationAnalyzer.analyzeSituation...");const t=this.situationAnalyzer.analyzeSituation(n);if(console.log("🎯 [DEBUG] Analysis result received:",!!t),!t)throw new Error("Analysis failed");this.currentAnalysis={...t,inputText:n,timestamp:(new Date).toISOString()},console.log("🎯 [DEBUG] Calling metaphorDisplay.displaySituationAnalysis..."),this.metaphorDisplay.displaySituationAnalysis(this.currentAnalysis),this.updateStatus("分析完了 - テーマを選択してください","✅"),this.collapsInputSection(),console.log("✅ Situation analysis completed:",this.currentAnalysis)}catch(t){console.error("❌ Analysis error:",t),this.updateStatus("分析エラー","❌"),alert("分析中にエラーが発生しました。もう一度お試しください。")}else console.error("❌ Simulator not initialized")}async handleTransformation(n){const{currentSituation:t,choice:e}=n;if(t&&e)try{console.log("🔄 Processing transformation:",e),this.updateStatus("未来シナリオを生成中...","🔮");const n=this.transformationSimulator.simulateTransformation(t,e);if(!n)throw new Error("Transformation failed");this.metaphorDisplay.displayTransformation(n),this.branchingSystem&&this.integrateBranchingSystem(n),this.updateStatus("シミュレーション完了","🌟"),console.log("✅ Transformation completed:",n)}catch(i){console.error("❌ Transformation error:",i),this.updateStatus("シミュレーションエラー","❌"),alert("シミュレーション中にエラーが発生しました。")}else console.error("❌ Invalid transformation data")}async integrateBranchingSystem(n){if(this.branchingSystem)try{const e={current:n.newSituation.h384Entry?n.newSituation.h384Entry["現代解釈の要約"]:"新しい状況に移行しました",choices:n.scenarios.map(n=>({type:n.type,label:n.title,description:n.timeline[0]?.description||n.title})),outcomes:n.scenarios.map(n=>({type:"optimistic"===n.type?"positive":"challenging"===n.type?"challenging":"neutral",label:n.title,description:n.outcomes[0]?.title||n.title,timeframe:n.timeline[0]?.timeframe||"未来",probability:Math.round(100*n.probability)}))},i=document.getElementById("future-branching-container");if(i&&this.branchingSystem)try{"function"==typeof this.branchingSystem.init&&await this.branchingSystem.init(i),"function"==typeof this.branchingSystem.createBranching?this.branchingSystem.createBranching(e):console.log("📊 FutureBranchingSystem統合スキップ（createBranchingメソッド未実装）")}catch(t){console.warn("⚠️ FutureBranchingSystem統合エラー:",t.message)}}catch(t){console.error("❌ Branching system integration error:",t)}}updateStatus(n,t="🌟"){const e=document.querySelector(".status-text"),i=document.querySelector(".status-icon");e&&(e.textContent=n),i&&(i.textContent=t)}collapsInputSection(){const n=document.getElementById("situation-input-section");if(n){n.style.transform="translateY(-20px)",n.style.opacity="0.7",n.style.maxHeight="200px",n.style.overflow="hidden";const t=document.createElement("button");t.textContent="🔄 再分析",t.className="analyze-btn secondary",t.style.margin="1rem auto",t.style.display="block",t.addEventListener("click",()=>{this.expandInputSection()}),n.appendChild(t)}}expandInputSection(){const n=document.getElementById("situation-input-section");if(n){n.style.transform="translateY(0)",n.style.opacity="1",n.style.maxHeight="none";const t=n.querySelector("button:last-child");t&&t.textContent.includes("再分析")&&t.remove(),this.metaphorDisplay&&this.metaphorDisplay.reset(),this.updateStatus("再分析の準備完了","🔄")}}reset(){this.currentAnalysis=null,this.metaphorDisplay&&this.metaphorDisplay.reset(),this.expandInputSection();const n=document.getElementById("situation-text");n&&(n.value=""),this.updateStatus("リセット完了","🔄")}async analyzeText(n){return await this.analyzeSituation(n)}getCurrentAnalysis(){return this.currentAnalysis}isReady(){return this.isInitialized&&this.situationAnalyzer&&this.transformationSimulator&&this.metaphorDisplay}}window.IChingFutureSimulator=IChingFutureSimulator;