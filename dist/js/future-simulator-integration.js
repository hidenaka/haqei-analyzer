console.log("🚀 Future Simulator Integration Loading..."),function(){"use strict";class FutureSimulatorIntegration{constructor(){this.name="FutureSimulatorIntegration",this.version="3.0.0",this.isInitialized=!1,this.h384db=null,this.guidanceEngine=null,this.visualizer=null,this.scenariosDisplay=null,this.resultPageController=null,this.currentAnalysis=null}async initialize(){console.log("🔄 FutureSimulatorIntegration initializing...");try{return await this.initializeDatabase(),await this.initializeGuidanceEngine(),this.initializeVisualizers(),this.setupEventListeners(),this.isInitialized=!0,console.log("✅ FutureSimulatorIntegration initialized successfully"),!0}catch(e){return console.error("❌ FutureSimulatorIntegration initialization failed:",e),!1}}async initializeDatabase(){window.h384db?(this.h384db=window.h384db,this.h384db.isLoaded||await this.h384db.initialize(),console.log("✅ H384 Database connected")):(console.warn("⚠️ H384 Database not available, creating new instance"),this.h384db=new window.H384DatabaseConnector,await this.h384db.initialize())}async initializeGuidanceEngine(){window.iChingGuidance?(this.guidanceEngine=window.iChingGuidance,this.guidanceEngine.isInitialized||await this.guidanceEngine.initialize(),console.log("✅ I Ching Guidance Engine initialized")):(console.warn("⚠️ Creating new I Ching Guidance Engine"),this.guidanceEngine=new window.IChingGuidanceEngine,await this.guidanceEngine.initialize())}initializeVisualizers(){if(window.ThreeStageVisualizer){this.visualizer=new window.ThreeStageVisualizer;document.getElementById("three-stage-visualizer")&&this.visualizer.initialize("three-stage-visualizer")}if(window.EightScenariosDisplay){this.scenariosDisplay=new window.EightScenariosDisplay;document.getElementById("eight-scenarios-display")&&this.scenariosDisplay.initialize("eight-scenarios-display")}window.ResultPageController&&(this.resultPageController=new window.ResultPageController,this.resultPageController.initialize(),console.log("✅ ResultPageController initialized")),console.log("✅ Visualizers initialized")}setupEventListeners(){const e=document.getElementById("aiGuessBtn");e&&e.addEventListener("click",async()=>{await this.performAnalysis()});const t=document.getElementById("worryInput");t&&t.addEventListener("keypress",async e=>{"Enter"===e.key&&!1===e.shiftKey&&(e.preventDefault(),await this.performAnalysis())});const i=document.getElementById("eight-scenarios-display");i&&i.addEventListener("scenarioSelected",e=>{this.handleScenarioSelection(e.detail)})}async performAnalysis(){const e=document.getElementById("worryInput");if(!e)return;const t=e.value.trim();if(!t||t.length<10)alert("10文字以上の内容を入力してください");else{this.showLoading(!0);try{const e=await this.guidanceEngine.performCompleteAnalysis(t);if(!e)throw new Error("分析に失敗しました");this.currentAnalysis=e,await this.displayResults(e),this.saveAnalysis(e)}catch(i){console.error("❌ Analysis failed:",i),alert("分析中にエラーが発生しました")}finally{this.showLoading(!1)}}}async displayResults(e){if(console.log("📊 Displaying analysis results:",e),this.resultPageController){const t={currentHexagram:{number:e.currentSituation?.hexagramNumber||1,name:e.currentSituation?.hexagramName},currentYao:{position:e.currentSituation?.yaoPosition||1,name:e.currentSituation?.yaoName},theme:e.currentSituation?.theme,themeDetail:e.currentSituation?.description,scenarios:e.eightScenarios,progressTheme:e.threeStageProcess?.progressTheme,changeTheme:e.threeStageProcess?.changeTheme};await this.resultPageController.displayResults(t),e.currentSituation&&this.updateChoiceCards(e.currentSituation)}if(this.displayCurrentSituation(e.currentSituation),console.log("🎯 [CRITICAL DEBUG] threeStageProcess check:",{hasVisualizer:!!this.visualizer,hasThreeStageProcess:!!e.threeStageProcess,threeStageProcessData:e.threeStageProcess,stagesCount:e.threeStageProcess?.stages?.length}),this.visualizer&&e.threeStageProcess){if(!document.getElementById("three-stage-visualizer")){const e=document.createElement("div");e.id="three-stage-visualizer",e.style.marginTop="2rem";const t=document.getElementById("resultArea");t&&t.appendChild(e),this.visualizer.initialize("three-stage-visualizer")}this.visualizer.drawThreeStageProcess(e.threeStageProcess,e.eightScenarios)}if(this.scenariosDisplay&&e.eightScenarios){if(!document.getElementById("eight-scenarios-display")){const e=document.createElement("div");e.id="eight-scenarios-display",e.style.marginTop="2rem";const t=document.getElementById("resultArea");t&&t.appendChild(e),this.scenariosDisplay.initialize("eight-scenarios-display")}e.eightScenarios&&e.eightScenarios.length>0?(this.scenariosDisplay.displayScenarios(e.eightScenarios,e.threeStageProcess),setTimeout(()=>{this.scenariosDisplay.animateDisplay()},100)):console.warn("⚠️ No eightScenarios data available for display")}const t=document.getElementById("resultArea");t&&(t.style.display="block",t.scrollIntoView({behavior:"smooth"})),window.futureAnalysisCompleted=!0;const i=document.getElementById("iching-simulator-section");i&&(i.style.display="block",i.style.opacity="1")}displayCurrentSituation(e){const t=document.getElementById("currentTitle");if(t){const i=this.generateHexagramVisual(e["卦番号"]);t.innerHTML=`\n          <div style="display: flex; align-items: center; justify-content: center; gap: 1rem;">\n            ${i}\n            <span>${e["卦名"]} ${e["爻"]}</span>\n          </div>\n        `}const i=document.getElementById("currentKeywords");i&&e["キーワード"]&&(i.textContent=e["キーワード"].join(" / "));const n=document.getElementById("currentSummary");n&&(n.textContent=e["現代解釈の要約"]);const s=document.getElementById("recommendedDirection");if(s){const t=e["S5_主体性推奨スタンス"];let i="";i="能動"===t?"積極的に行動を起こし、主体的に状況を切り開いていくことが推奨されます。":"受動"===t?"状況を慎重に観察し、適切なタイミングを待つことが推奨されます。":"バランスを保ちながら、状況に応じて柔軟に対応することが推奨されます。",s.textContent=i}this.updateChoiceCards(e)}generateHexagramVisual(e){const t=({1:"111111",2:"000000",3:"010001",4:"100010",5:"010111",6:"111010",7:"000010",8:"010000"}[e]||"000000").split("").reverse();let i='<div style="display: flex; flex-direction: column; gap: 2px;">';return t.forEach(e=>{i+="1"===e?'<div style="width: 40px; height: 4px; background: currentColor;"></div>':'<div style="display: flex; gap: 4px;"><div style="width: 18px; height: 4px; background: currentColor;"></div><div style="width: 18px; height: 4px; background: currentColor;"></div></div>'}),i+="</div>",i}updateChoiceCards(e){const t=document.getElementById("choice1"),i=document.getElementById("choice2");if(t&&e){const i=e["キーワード"]||[];t.innerHTML=`\n          <h3 class="text-lg font-bold text-blue-300 mb-2">テーマに従う道</h3>\n          <p class="text-sm text-gray-300 mb-3">「${i.join("、")}」を受け入れて行動する</p>\n          <div class="text-xs bg-blue-500/20 text-blue-200 px-2 py-1 rounded">\n            ${"能動"===e["S5_主体性推奨スタンス"]?"積極的行動":"慎重な観察"}\n          </div>\n        `}if(i&&e){const t=e["キーワード"]||[];i.innerHTML=`\n          <h3 class="text-lg font-bold text-emerald-300 mb-2">新たな道を探る</h3>\n          <p class="text-sm text-gray-300 mb-3">「${t.join("、")}」とは異なる選択を模索</p>\n          <div class="text-xs bg-emerald-500/20 text-emerald-200 px-2 py-1 rounded">\n            ${"能動"===e["S5_主体性推奨スタンス"]?"慎重な転換":"積極的変革"}\n          </div>\n        `}}handleScenarioSelection(e){console.log("🎯 Scenario selected:",e),this.visualizer&&this.visualizer.selectPath(e.path),this.displayScenarioDetails(e)}displayScenarioDetails(e){let t=document.getElementById("scenario-details");if(!t){t=document.createElement("div"),t.id="scenario-details",t.style.marginTop="2rem",t.style.padding="1.5rem",t.style.background="linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1))",t.style.borderRadius="12px",t.style.border="1px solid rgba(99, 102, 241, 0.3)";const e=document.getElementById("resultArea");e&&e.appendChild(t)}t.innerHTML=`\n        <h3 style="color: #A5B4FC; margin-bottom: 1rem;">\n          選択されたシナリオ: ${e.title}\n        </h3>\n        <div style="color: #E5E7EB;">\n          <p style="margin-bottom: 1rem;">${e.description}</p>\n          <div style="display: flex; gap: 2rem; margin-bottom: 1rem;">\n            <div>\n              <strong style="color: #FDE047;">成功確率:</strong> ${e.probability}%\n            </div>\n            <div>\n              <strong style="color: #FDE047;">易経参照:</strong> ${e.iChingReference.hexagram}\n            </div>\n          </div>\n          <div style="margin-top: 1rem;">\n            <strong style="color: #10B981;">推奨アクション:</strong>\n            <p style="margin-top: 0.5rem;">\n              ${this.generateActionRecommendation(e)}\n            </p>\n          </div>\n        </div>\n      `,t.scrollIntoView({behavior:"smooth"})}generateActionRecommendation(e){return{"conservative,collaborative,cautious":"現状を基盤に、信頼できる仲間と共に慎重に進めていきましょう。急がず、着実な一歩を重視してください。","conservative,collaborative,decisive":"既存の枠組みを活用しながら、チームで迅速な意思決定を行いましょう。協力関係を大切にしてください。","conservative,independent,cautious":"自分のペースを保ちながら、独自の道を慎重に開拓していきましょう。焦る必要はありません。","conservative,independent,decisive":"既存の資源を活用しつつ、独自の判断で素早く行動しましょう。自信を持って進んでください。","progressive,collaborative,cautious":"新しい可能性を仲間と共に慎重に探求していきましょう。革新と安全性のバランスを重視してください。","progressive,collaborative,decisive":"チーム一丸となって、大胆な変革を迅速に実行しましょう。勢いを大切にしてください。","progressive,independent,cautious":"独自の革新的アイデアを、計画的に実現していきましょう。準備を怠らないでください。","progressive,independent,decisive":"自分の直感を信じて、革新的な道を迷わず進みましょう。今がその時です。"}[e.path.join(",")]||"状況をよく観察し、最適なタイミングで行動を起こしましょう。"}showLoading(e){const t=document.getElementById("loadingSpinner"),i=document.getElementById("originalIcon"),n=document.getElementById("buttonText"),s=document.getElementById("aiGuessBtn");e?(t&&(t.style.display="block"),i&&(i.style.display="none"),n&&(n.textContent="分析中..."),s&&(s.disabled=!0)):(t&&(t.style.display="none"),i&&(i.style.display="block"),n&&(n.textContent="分析実行"),s&&(s.disabled=!1))}saveAnalysis(e){if("undefined"!=typeof localStorage){const t=JSON.parse(localStorage.getItem("future_simulator_history")||"[]");t.unshift(e),t.length>10&&(t.length=10),localStorage.setItem("future_simulator_history",JSON.stringify(t))}}getAnalysisHistory(){return"undefined"!=typeof localStorage?JSON.parse(localStorage.getItem("future_simulator_history")||"[]"):[]}}"undefined"!=typeof window&&(window.FutureSimulatorIntegration=FutureSimulatorIntegration,window.futureSimulator=new FutureSimulatorIntegration,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.futureSimulator.initialize()}):setTimeout(()=>{window.futureSimulator.initialize()},100)),console.log("✅ FutureSimulatorIntegration loaded")}("undefined"!=typeof window&&window);