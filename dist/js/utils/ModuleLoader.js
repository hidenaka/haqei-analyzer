class ModuleLoader{constructor(e={}){this.options={enableCaching:!0,enablePreloading:!0,enableAnalytics:!0,maxCacheSize:50,preloadDelay:1e3,retryAttempts:3,...e},this.loadedModules=new Map,this.loadingPromises=new Map,this.moduleMetadata=new Map,this.preloadQueue=[],this.loadingHistory=[],this.predictiveCache=new Map,this.stats={totalLoads:0,cacheHits:0,loadErrors:0,totalLoadTime:0,bundlesSaved:0},this.bundles=this.initializeBundles(),console.log("üöÄ ModuleLoader initialized - Dynamic import system ready")}initializeBundles(){return{core:{name:"Core Bundle",priority:1,modules:["/js/shared/core/BaseComponent.js","/js/shared/core/MicroStorageManager.js","/js/shared/core/MicroDataManager.js","/js/shared/utils/SecurityValidator.js"],preload:!0,estimatedSize:"800KB"},questions:{name:"Question Flow Bundle",priority:2,modules:["/js/os-analyzer/components/VirtualQuestionFlow-core.js","/js/os-analyzer/components/VirtualQuestionFlow-renderer.js","/js/os-analyzer/components/VirtualQuestionFlow-navigator.js","/js/shared/data/questions.js","/js/os-analyzer/core/PrecompiledQuestions.js"],preload:!1,estimatedSize:"600KB"},analysis:{name:"Analysis Engine Bundle",priority:3,modules:["/js/os-analyzer/core/TripleOSEngine.js","/js/os-analyzer/core/UltraAnalysisEngine.js","/js/os-analyzer/core/IChingUltraSyncLogic.js","/js/core/H384_DATABASE.js","/js/os-analyzer/core/StatisticalEngine.js","/js/shared/core/DataManager.js"],preload:!1,estimatedSize:"1200KB"},results:{name:"Results Display Bundle",priority:4,modules:["/js/components/TripleOSResultsView.js","/js/os-analyzer/components/ResultsView.js","/js/lib/chart.min.js","/js/lib/chartjs-plugin-annotation.min.js","/js/data/hexagram_details.js"],preload:!1,estimatedSize:"800KB"},optional:{name:"Optional Features Bundle",priority:5,modules:["/js/help-system/core/HelpSystemCore.js","/js/help-system/ui/HelpSystemUI.js","/js/shared/utils/AccessibilityManager.js","/js/utils/HexagramSVGGenerator.js"],preload:!1,estimatedSize:"400KB"}}}async loadModule(e,s={}){const o=performance.now();try{if(this.options.enableCaching&&this.loadedModules.has(e))return this.stats.cacheHits++,console.log(`üì¶ Module loaded from cache: ${e}`),this.loadedModules.get(e);if(this.loadingPromises.has(e))return await this.loadingPromises.get(e);const t=this.loadModuleWithRetry(e,s);this.loadingPromises.set(e,t);const a=await t;this.options.enableCaching&&(this.loadedModules.set(e,a),this.pruneCache());const i=performance.now()-o;return this.updateLoadStats(e,i,!0),console.log(`‚úÖ Module loaded: ${e} (${i.toFixed(0)}ms)`),a}catch(t){this.stats.loadErrors++,console.error(`‚ùå Failed to load module: ${e}`,t);const o=s.fallback;if(o&&"function"==typeof o)return console.log(`üîÑ Using fallback for: ${e}`),o();throw t}finally{this.loadingPromises.delete(e)}}async loadModuleWithRetry(e,s){let o;const t=s.retries||this.options.retryAttempts;for(let i=1;i<=t;i++)try{const s=e+(i>1?`?retry=${i}&t=${Date.now()}`:""),o=await import(s);return i>1&&console.log(`üîÑ Module loaded after ${i} attempts: ${e}`),o}catch(a){if(o=a,i<t){const s=Math.min(1e3*Math.pow(2,i-1),5e3);console.warn(`‚ö†Ô∏è Module load attempt ${i} failed, retrying in ${s}ms: ${e}`),await new Promise(e=>setTimeout(e,s))}}throw o}async loadBundle(e,s={}){const o=this.bundles[e];if(!o)throw new Error(`Bundle not found: ${e}`);const t=performance.now();console.log(`üì¶ Loading bundle: ${o.name} (${o.estimatedSize})`);try{const e=o.modules.map(e=>this.loadModule(e,s)),a=await Promise.all(e),i=performance.now()-t;return console.log(`‚úÖ Bundle loaded: ${o.name} (${i.toFixed(0)}ms)`),this.stats.bundlesSaved+=this.estimateBundleSavings(o),a}catch(a){throw console.error(`‚ùå Bundle load failed: ${o.name}`,a),a}}async preloadModule(e,s="normal"){this.options.enablePreloading&&(this.preloadQueue.push({modulePath:e,priority:s,timestamp:Date.now()}),setTimeout(()=>this.processPreloadQueue(),this.options.preloadDelay))}async processPreloadQueue(){if(0===this.preloadQueue.length)return;this.preloadQueue.sort((e,s)=>{const o={high:0,normal:1,low:2};return o[e.priority]-o[s.priority]||e.timestamp-s.timestamp});const e=this.preloadQueue.splice(0,3);for(const o of e)try{await this.loadModule(o.modulePath,{isPreload:!0}),console.log(`üîÑ Preloaded: ${o.modulePath}`)}catch(s){console.warn(`‚ö†Ô∏è Preload failed: ${o.modulePath}`,s)}}predictNextModules(e){const s=[],o=(this.loadingHistory.slice(-10),{"welcome-screen":["questions"],questions:["analysis"],analysis:["results"],results:["optional"]});return o[e]&&s.push(...o[e]),s.forEach(e=>{this.bundles[e]&&this.bundles[e].modules.forEach(e=>{this.preloadModule(e,"high")})}),s}pruneCache(){if(this.loadedModules.size<=this.options.maxCacheSize)return;const e=Array.from(this.loadedModules.entries());e.slice(0,e.length-this.options.maxCacheSize).forEach(([e])=>{this.loadedModules.delete(e),console.log(`üóëÔ∏è Pruned from cache: ${e}`)})}cleanupUnusedModules(){const e=Date.now();for(const[s,o]of this.moduleMetadata.entries())e-o.lastAccessed>3e5&&(this.loadedModules.delete(s),this.moduleMetadata.delete(s),console.log(`üßπ Cleaned up unused module: ${s}`))}updateLoadStats(e,s,o){this.stats.totalLoads++,o&&(this.stats.totalLoadTime+=s,this.loadingHistory.push({modulePath:e,loadTime:s,timestamp:Date.now()}),this.loadingHistory.length>100&&(this.loadingHistory=this.loadingHistory.slice(-50)))}estimateBundleSavings(e){return 1024*(parseInt(e.estimatedSize)||0)}getStats(){const e=this.stats.totalLoads>0?this.stats.totalLoadTime/this.stats.totalLoads:0;return{...this.stats,averageLoadTime:e,cacheHitRatio:this.stats.totalLoads>0?(this.stats.cacheHits/this.stats.totalLoads*100).toFixed(1)+"%":"0%",modulesInCache:this.loadedModules.size,estimatedSavings:this.formatBytes(this.stats.bundlesSaved)}}formatBytes(e){if(0===e)return"0 B";const s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(2))+" "+["B","KB","MB","GB"][s]}debugLoadedModules(){console.log("üìä ModuleLoader Debug Info:"),console.log("Loaded modules:",Array.from(this.loadedModules.keys())),console.log("Statistics:",this.getStats()),console.log("Bundle configuration:",this.bundles)}exportConfiguration(){return{bundles:this.bundles,options:this.options,stats:this.getStats(),loadingHistory:this.loadingHistory.slice(-20)}}}window.ModuleLoader=ModuleLoader,window.moduleLoader||(window.moduleLoader=new ModuleLoader({enableAnalytics:!0,enablePreloading:!0,maxCacheSize:30}),console.log("üéØ Global ModuleLoader initialized for HAQEI optimizer")),"undefined"!=typeof module&&module.exports&&(module.exports=ModuleLoader);