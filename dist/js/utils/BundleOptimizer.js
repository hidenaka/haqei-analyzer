class BundleOptimizer{constructor(e={}){this.options={enableMonitoring:!0,enableAnalysis:!0,enableReporting:!0,analysisInterval:3e4,maxBundleSize:3145728,warningThreshold:2621440,...e},this.bundleMetrics={totalSize:0,loadedModules:new Map,loadTimes:new Map,memoryUsage:new Map,duplicateDetection:new Map},this.performanceObserver=null,this.memoryObserver=null,this.analysisResults={bundleSize:0,optimization:{duplicates:[],unused:[],heavyModules:[],suggestions:[]},performance:{loadTimes:{},memoryImpact:{},cacheEfficiency:0}},console.log("üîß BundleOptimizer initialized - Phase 2 monitoring active"),this.options.enableMonitoring&&this.startMonitoring()}startMonitoring(){this.options.enableMonitoring&&(console.log("üìä Starting bundle optimization monitoring..."),this.monitorScriptLoading(),this.monitorMemoryUsage(),setInterval(()=>{this.performAnalysis()},this.options.analysisInterval),"PerformanceObserver"in window&&this.setupPerformanceObserver())}monitorScriptLoading(){const e=window.import||(async e=>import(e));window.import=async t=>{const i=performance.now();try{const o=await e(t),s=performance.now()-i;return this.trackModuleLoad(t,s,o),o}catch(o){throw this.trackLoadError(t,o),o}};document.querySelectorAll("script[src]").forEach(e=>{this.estimateScriptSize(e.src)})}trackModuleLoad(e,t,i){const o=this.estimateModuleSize(i);this.bundleMetrics.loadedModules.set(e,{loadTime:t,estimatedSize:o,timestamp:Date.now(),module:i}),this.bundleMetrics.loadTimes.set(e,t),this.bundleMetrics.totalSize+=o,this.bundleMetrics.totalSize>this.options.warningThreshold&&console.warn(`‚ö†Ô∏è Bundle size approaching limit: ${this.formatBytes(this.bundleMetrics.totalSize)}`),console.log(`üì¶ Module tracked: ${e} (${this.formatBytes(o)}, ${t.toFixed(0)}ms)`)}estimateModuleSize(e){try{const t=JSON.stringify(e);return new Blob([t]).size}catch(t){return 10240}}async estimateScriptSize(e){try{const t=(await fetch(e,{method:"HEAD"})).headers.get("content-length");if(t){const i=parseInt(t);return this.bundleMetrics.totalSize+=i,console.log(`üìú Script size estimated: ${e} (${this.formatBytes(i)})`),i}}catch(t){console.warn(`‚ö†Ô∏è Could not estimate size for: ${e}`)}return 0}monitorMemoryUsage(){if(!("memory"in performance))return void console.warn("‚ö†Ô∏è Memory monitoring not available in this browser");const trackMemory=()=>{const e=performance.memory;if(this.bundleMetrics.memoryUsage.set(Date.now(),{used:e.usedJSHeapSize,total:e.totalJSHeapSize,limit:e.jsHeapSizeLimit}),this.bundleMetrics.memoryUsage.size>100){const e=Array.from(this.bundleMetrics.memoryUsage.entries()).slice(-50);this.bundleMetrics.memoryUsage.clear(),e.forEach(([e,t])=>{this.bundleMetrics.memoryUsage.set(e,t)})}};setInterval(trackMemory,5e3),trackMemory()}setupPerformanceObserver(){try{this.performanceObserver=new PerformanceObserver(e=>{e.getEntries().forEach(e=>{"resource"===e.entryType&&e.name.includes(".js")&&this.trackResourcePerformance(e)})}),this.performanceObserver.observe({entryTypes:["resource","navigation"]}),console.log("üìä PerformanceObserver setup complete")}catch(e){console.warn("‚ö†Ô∏è PerformanceObserver setup failed:",e)}}trackResourcePerformance(e){const t={url:e.name,duration:e.duration,transferSize:e.transferSize||0,encodedBodySize:e.encodedBodySize||0,decodedBodySize:e.decodedBodySize||0,startTime:e.startTime,responseEnd:e.responseEnd};this.analysisResults.performance.loadTimes[e.name]=t,t.transferSize>0&&(this.bundleMetrics.totalSize+=t.transferSize)}performAnalysis(){console.log("üîç Performing bundle optimization analysis...");const e={timestamp:Date.now(),bundleSize:this.bundleMetrics.totalSize,moduleCount:this.bundleMetrics.loadedModules.size,optimization:this.analyzeOptimizations(),performance:this.analyzePerformance(),recommendations:[]};return e.recommendations=this.generateRecommendations(e),this.analysisResults=e,this.options.enableReporting&&this.generateReport(e),e}analyzeOptimizations(){const e=this.findDuplicateCode(),t=this.findUnusedModules();return{duplicates:e,unused:t,heavyModules:this.findHeavyModules(),totalWaste:e.totalSize+t.totalSize}}findDuplicateCode(){const e=[];let t=0;const i=Array.from(this.bundleMetrics.loadedModules.entries());for(let o=0;o<i.length;o++)for(let s=o+1;s<i.length;s++){const[n,a]=i[o],[r,l]=i[s];Math.abs(a.estimatedSize-l.estimatedSize)<1024&&a.estimatedSize>5120&&(e.push({modules:[n,r],estimatedDuplication:.3*Math.min(a.estimatedSize,l.estimatedSize),confidence:"low"}),t+=.3*Math.min(a.estimatedSize,l.estimatedSize))}return{duplicates:e,totalSize:t}}findUnusedModules(){const e=[];let t=0;const i=Date.now();return this.bundleMetrics.loadedModules.forEach((o,s)=>{i-o.timestamp>3e5&&(e.push({path:s,size:o.estimatedSize,lastAccessed:o.timestamp,reason:"Not accessed in 5+ minutes"}),t+=o.estimatedSize)}),{unused:e,totalSize:t}}findHeavyModules(){const e=[];return this.bundleMetrics.loadedModules.forEach((t,i)=>{t.estimatedSize>102400&&e.push({path:i,size:t.estimatedSize,loadTime:t.loadTime,impactScore:t.estimatedSize/1024+t.loadTime/10})}),e.sort((e,t)=>t.impactScore-e.impactScore),e}analyzePerformance(){const e=Array.from(this.bundleMetrics.loadTimes.values()),t=Array.from(this.bundleMetrics.memoryUsage.values());return{averageLoadTime:e.length>0?e.reduce((e,t)=>e+t,0)/e.length:0,slowestLoad:e.length>0?Math.max(...e):0,fastestLoad:e.length>0?Math.min(...e):0,currentMemoryUsage:t.length>0?t[t.length-1].used:0,memoryGrowthRate:this.calculateMemoryGrowthRate(t)}}calculateMemoryGrowthRate(e){if(e.length<2)return 0;const t=e[0],i=e[e.length-1],o=5e3*(e.length-1);return(i.used-t.used)/o*1e3}generateRecommendations(e){const t=[];if(e.bundleSize>this.options.maxBundleSize&&t.push({type:"size",priority:"high",message:`Bundle size (${this.formatBytes(e.bundleSize)}) exceeds target (${this.formatBytes(this.options.maxBundleSize)})`,suggestion:"Consider additional code splitting or removing unused modules"}),e.optimization.heavyModules.length>0){const i=e.optimization.heavyModules[0];t.push({type:"performance",priority:"medium",message:`Heavy module detected: ${i.path} (${this.formatBytes(i.size)})`,suggestion:"Consider lazy loading or splitting this module"})}return e.optimization.duplicates.totalSize>51200&&t.push({type:"optimization",priority:"medium",message:`Potential duplicate code: ${this.formatBytes(e.optimization.duplicates.totalSize)} wasted`,suggestion:"Review modules for shared utilities that can be extracted"}),e.performance.memoryGrowthRate>1024&&t.push({type:"memory",priority:"high",message:`High memory growth rate: ${this.formatBytes(e.performance.memoryGrowthRate)}/sec`,suggestion:"Check for memory leaks and implement cleanup"}),t}generateReport(e){console.log("üìä Bundle Optimization Report - Phase 2"),console.log("=".repeat(50)),console.log(`üì¶ Total Bundle Size: ${this.formatBytes(e.bundleSize)}`),console.log(`üìÑ Loaded Modules: ${e.moduleCount}`),console.log(`‚ö° Average Load Time: ${e.performance.averageLoadTime.toFixed(0)}ms`),console.log(`üß† Memory Usage: ${this.formatBytes(e.performance.currentMemoryUsage)}`),e.optimization.totalWaste>0&&console.log(`‚ôªÔ∏è Potential Savings: ${this.formatBytes(e.optimization.totalWaste)}`),e.recommendations.length>0&&(console.log("üéØ Recommendations:"),e.recommendations.forEach((e,t)=>{console.log(`${t+1}. [${e.priority.toUpperCase()}] ${e.message}`),console.log(`   üí° ${e.suggestion}`)})),console.log("=".repeat(50)),window.bundleOptimizationReport=e}getOptimizationStatus(){const e=this.bundleMetrics.totalSize,t=this.options.maxBundleSize,i=Math.max(0,e-t);return{currentSize:this.formatBytes(e),targetSize:this.formatBytes(t),isOptimized:e<=t,potentialSavings:this.formatBytes(i),optimizationPercentage:t>0?Math.max(0,(t-e)/t*100).toFixed(1)+"%":"0%"}}formatBytes(e){if(0===e)return"0 B";const t=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t]}exportData(){return{metrics:{totalSize:this.bundleMetrics.totalSize,moduleCount:this.bundleMetrics.loadedModules.size,loadedModules:Array.from(this.bundleMetrics.loadedModules.entries())},analysis:this.analysisResults,status:this.getOptimizationStatus(),timestamp:Date.now()}}}window.bundleOptimizer||(window.bundleOptimizer=new BundleOptimizer({enableMonitoring:!0,enableAnalysis:!0,enableReporting:!0}),console.log("üéØ BundleOptimizer initialized for Phase 2 monitoring"),window.getBundleReport=()=>window.bundleOptimizer.performAnalysis(),window.getBundleStatus=()=>window.bundleOptimizer.getOptimizationStatus(),window.exportBundleData=()=>window.bundleOptimizer.exportData()),"undefined"!=typeof module&&module.exports&&(module.exports=BundleOptimizer);