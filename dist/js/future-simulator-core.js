console.log("🎯 Future Simulator Core Loading..."),window.FutureSimulator=window.FutureSimulator||{},FutureSimulator.Core={initialized:!1,authentic386Integration:null,useAuthentic386:!0,async init(){console.log("🚀 Future Simulator initializing...");try{this.initKuromoji(),this.init386System(),this.initializeEngines(),this.initUI(),this.setupEventListeners(),this.initialized=!0,console.log("✅ Future Simulator initialized successfully");const e=document.getElementById("initial-loading");e&&(e.style.display="none")}catch(e){console.error("❌ Initialization error:",e),this.showError("システムの初期化に失敗しました。ページを再読み込みしてください。")}},initKuromoji:async()=>(console.log("📝 Initializing Japanese text analyzer..."),new Promise((e,t)=>{if("undefined"==typeof kuromoji)return console.log("ℹ️ Kuromoji not available, using simple analysis"),void e();kuromoji.builder({dicPath:"https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/"}).build((t,n)=>{t?(console.warn("⚠️ Kuromoji init failed, continuing with simple analysis"),e()):(window.tokenizer=n,console.log("✅ Japanese analyzer ready"),e())})})),async init386System(){console.log("🎋 Initializing Authentic 386 System...");try{void 0!==window.Authentic386YaoAnalyzer?(this.authentic386Analyzer=new window.Authentic386YaoAnalyzer,await this.authentic386Analyzer.initialize(),console.log("✅ Authentic 386爻 Analyzer initialized successfully"),this.useAuthentic386=!0):void 0!==window.Authentic386Integration?(this.authentic386Integration=new window.Authentic386Integration,this.authentic386Integration.initialize(),console.log("✅ Authentic 386 System integrated successfully"),this.useAuthentic386=!0):(console.warn("⚠️ Authentic386 systems not available, using legacy system"),this.useAuthentic386=!1)}catch(e){console.error("❌ 386 System initialization error:",e),this.useAuthentic386=!1}},async initUI(){console.log("🎨 Initializing UI components...");try{const e=document.querySelector(".future-simulator-container")||document.body;"none"===e.style.display&&(e.style.display="block");const t=document.getElementById("situation-input")||document.querySelector('textarea[placeholder*="状況"]')||document.querySelector("textarea");t&&(t.addEventListener("input",this.handleInputChange.bind(this)),this.setupCharacterCounter(t),console.log("✅ Input field initialized")),"undefined"!=typeof Chart?console.log("📊 Chart.js available"):(console.log("ℹ️ Chart.js not available, using fallback displays"),this.setupFallbackVisualization())}catch(e){console.error("❌ UI initialization error:",e)}},setupCharacterCounter(e){try{if(e.nextElementSibling?.classList?.contains("character-counter"))return;const t=document.createElement("div");t.className="character-counter",t.style.cssText="font-size: 12px; color: #6b7280; text-align: right; margin-top: 4px;";const updateCounter=()=>{const n=e.value.length;t.textContent=`${n} 文字`,t.style.color=n>500?"#ef4444":"#6b7280"};e.addEventListener("input",updateCounter),e.parentNode.insertBefore(t,e.nextSibling),updateCounter()}catch(t){console.error("❌ Character counter setup error:",t)}},setupFallbackVisualization(){console.log("🎨 Setting up fallback visualization system..."),window.createFallbackChart=(e,t)=>{if(t)try{const n=Math.max(...e.map(e=>e.value||0)),i=e.map(e=>{const t=n>0?e.value/n*100:0;return`\n            <div class="chart-bar" style="margin-bottom: 8px;">\n              <div class="bar-label" style="display: inline-block; width: 120px; font-size: 12px;">${e.label||"データ"}</div>\n              <div class="bar-container" style="display: inline-block; width: 200px; background: #e2e8f0; height: 20px; border-radius: 10px; overflow: hidden; vertical-align: middle;">\n                <div class="bar-fill" style="width: ${t}%; height: 100%; background: linear-gradient(90deg, #3b82f6, #06b6d4); transition: width 0.5s ease;"></div>\n              </div>\n              <span style="margin-left: 8px; font-size: 12px; color: #6b7280;">${e.value||0}%</span>\n            </div>\n          `}).join("");t.innerHTML=`\n          <div class="fallback-chart" style="padding: 16px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">\n            <div style="margin-bottom: 16px; font-weight: bold; color: #374151;">データ可視化</div>\n            ${i}\n          </div>\n        `}catch(n){console.error("❌ Fallback chart error:",n),t.innerHTML='<div style="padding: 16px; color: #6b7280;">データの表示でエラーが発生しました</div>'}}},setupEventListeners(){console.log("🔗 Setting up event listeners...");const e=document.getElementById("analyze-button")||document.querySelector('button[onclick*="analyze"]')||document.querySelector(".analyze-btn")||Array.from(document.querySelectorAll("button")).find(e=>e.textContent.includes("分析"));e&&(e.onclick=()=>this.startAnalysis(),console.log("✅ Analyze button connected")),document.addEventListener("click",e=>{(e.target.matches('[data-action="analyze"]')||e.target.textContent.includes("分析")||e.target.textContent.includes("シミュレート"))&&(e.preventDefault(),this.startAnalysis())})},handleInputChange(e){const t=e.target.value.trim(),n=document.querySelector('button[onclick*="analyze"]')||document.querySelector(".analyze-btn");n&&(n.disabled=t.length<10)},async startAnalysis(){console.log("🔍 Starting advanced analysis with text interpretation...");const e=document.getElementById("situation-input")||document.querySelector('textarea[placeholder*="状況"]')||document.querySelector("textarea");if(!e||!e.value.trim())return void alert("状況を入力してください");const t=e.value.trim();this.showLoading();try{let e,i=1,s=null,a=null;if(this.authentic386Analyzer&&this.authentic386Analyzer.initialized)console.log("🎋 Using Authentic 386爻 Analysis System..."),a=this.authentic386Analyzer.analyzeText(t),a&&(console.log("✅ 386爻 Analysis Result:",a),a.hexagram&&(s=a.hexagram,i=6*a.hexagram.hexagram_id-6+(a.yao?.position||1)),a.specialYao&&console.log("🌟 Special Yao detected:",a.specialYao.name));else if(window.IntegratedAnalysisEngine&&window.MultiDimensionalContextAnalyzer){console.log("🔍 Using IntegratedAnalysisEngine for deep text analysis...");const e=window.IntegratedAnalysisEngine&&window.IntegratedAnalysisEngine.performAnalysis?window.IntegratedAnalysisEngine.performAnalysis(t):null;console.log("📊 Integrated analysis result:",e);const n=window.MultiDimensionalContextAnalyzer&&window.MultiDimensionalContextAnalyzer.analyzeContext?window.MultiDimensionalContextAnalyzer.analyzeContext(t):null;if(console.log("🌐 Multi-dimensional context:",n),window.DynamicKeywordGenerator&&window.DynamicKeywordGenerator.generateKeywords){const e=await window.DynamicKeywordGenerator.generateKeywords(t);console.log("🔤 Dynamic keywords generated:",e)}if(window.h384db&&e){const t=window.h384db.findBestMatch(e.keywords||[]);t&&(i=t.lineNumber,s=t.hexagramData,console.log(`✅ Found matching hexagram: ${s["卦名"]} ${s["爻"]}`))}}if(window.tokenizer){console.log("📝 Using Kuromoji for morphological analysis...");const e=window.tokenizer.tokenize(t);console.log("🔤 Morphological tokens:",e)}if(s||(console.log("⚠️ Using fallback random selection..."),i=Math.floor(384*Math.random())+1),this.useAuthentic386&&this.authentic386Integration)console.log("🏅 Using Authentic 386-Line Analysis System"),e=this.authentic386Integration.analyzeWithAuthentic386(t,{branchCount:8,enableSpecialLines:!0,integrationMode:"enhanced",currentLine:i}),this.displayAuthentic386Results(e);else if(window.Extended512HexagramEngine&&window.Extended512HexagramEngine.initialized)console.log("🌟 Using Extended 512-Pattern Analysis System"),e=window.Extended512HexagramEngine.analyze512Pattern(t,{detailed:!0,include_yong_yao:!0,branch_count:8,currentLine:i}),this.display512PatternResults(e);else if(window.BinaryTreeFutureEngine){console.log("🌳 Using Binary Tree Future Analysis System"),console.log(`📍 Current line determined: ${i}`);const e={inputText:t,hexagramData:s,integratedAnalysis:window.IntegratedAnalysisEngine&&window.IntegratedAnalysisEngine.performAnalysis?window.IntegratedAnalysisEngine.performAnalysis(t):null,contextAnalysis:window.MultiDimensionalContextAnalyzer?window.MultiDimensionalContextAnalyzer.analyzeContext(t):null},a=new window.BinaryTreeFutureEngine;console.log("🔍 DEBUG: Calling generateBinaryTreeFutures with:",{currentLine:i,context:e});const o=await a.generateBinaryTreeFutures(i,e);console.log("🔍 DEBUG: generateBinaryTreeFutures returned:",o),console.log("🎯 Calling IChingGuidanceEngine.performCompleteAnalysis for threeStageProcess...");let r=null;if(window.iChingGuidance&&window.iChingGuidance.performCompleteAnalysis)try{r=await window.iChingGuidance.performCompleteAnalysis(t),console.log("✅ IChingGuidanceEngine analysis completed:",{hasThreeStageProcess:!!r?.threeStageProcess,hasEightScenarios:!!r?.eightScenarios,threeStageProcessStages:r?.threeStageProcess?.stages?.length})}catch(n){console.error("❌ IChingGuidanceEngine analysis failed:",n)}else console.warn("⚠️ IChingGuidanceEngine not available");this.displayBinaryTreeResults(o),r&&window.futureSimulatorIntegration&&(console.log("🔄 Sending complete analysis to FutureSimulatorIntegration..."),window.futureSimulatorIntegration.displayResults(r))}else{console.log("⚡ Using Standard Analysis System");const e=this.generateScenarios(t);this.displayResults(e)}}catch(n){console.error("Analysis error:",n),this.showError("分析中にエラーが発生しました。標準システムで再試行します。");const e=this.generateScenarios(t);this.displayResults(e)}},displayAuthentic386Results(e){console.log("🎋 Displaying Authentic 386-Line results:",{mode:e.integrationMode,special:e.specialLineDetected?.detected,authenticity:e.authenticity});const t=this.getResultsContainer();if(!t)return void console.error("Results container not found");t.innerHTML="";const n=this.generateAuthentic386HTML(e);t.innerHTML=n,this.setupAuthentic386Interactions(e),t.scrollIntoView({behavior:"smooth",block:"start"}),this.hideLoading()},generateAuthentic386HTML(e){const t=e.specialLineDetected?.detected,n=e.specialLineDetected?.type;let i="";if(t)i=`\n        <div class="current-pattern-card bg-gradient-to-r from-yellow-50 to-orange-50 rounded-xl p-6 mb-6 border-2 border-orange-300 shadow-lg">\n          <div class="flex items-center justify-between mb-4">\n            <h2 class="text-2xl font-bold text-gray-800">🌟 特殊爻検出</h2>\n            <span class="px-4 py-2 bg-orange-600 text-white rounded-full text-sm font-bold animate-pulse">\n              ${n} - 極めて稀\n            </span>\n          </div>\n          \n          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">\n            <div class="text-center p-4 bg-white rounded-lg border border-orange-200">\n              <div class="text-4xl mb-2">${"YouKuu"===n?"🐉":"🌙"}</div>\n              <div class="font-bold text-orange-700">${n}</div>\n              <div class="text-sm text-orange-600">\n                ${"YouKuu"===n?"群龍無首吉":"利永貞"}\n              </div>\n            </div>\n            <div class="text-center p-4 bg-white rounded-lg border border-orange-200">\n              <div class="text-3xl mb-2">⚡</div>\n              <div class="font-semibold text-gray-700">変化レベル</div>\n              <div class="text-sm text-orange-600">最大級変化</div>\n            </div>\n            <div class="text-center p-4 bg-white rounded-lg border border-orange-200">\n              <div class="text-3xl mb-2">🎯</div>\n              <div class="font-semibold text-gray-700">信頼性</div>\n              <div class="text-sm text-orange-600">${Math.round(100*e.authenticity)}%</div>\n            </div>\n          </div>\n          \n          <div class="bg-orange-100 rounded-lg p-4 border border-orange-200">\n            <h3 class="font-bold text-orange-800 mb-2">特殊状況解釈:</h3>\n            <p class="text-orange-700">\n              ${this.getSpecialLineInterpretation(n)}\n            </p>\n          </div>\n        </div>\n      `;else{const t=e.integratedAnalysis?.hexagram;i=`\n        <div class="current-pattern-card bg-gradient-to-r from-indigo-50 to-blue-50 rounded-xl p-6 mb-6 border border-blue-200">\n          <div class="flex items-center justify-between mb-4">\n            <h2 class="text-2xl font-bold text-gray-800">現在の状況</h2>\n            <span class="px-3 py-1 bg-blue-600 text-white rounded-full text-sm font-medium">\n              正統386爻システム\n            </span>\n          </div>\n          \n          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">\n            <div class="text-center p-4 bg-white rounded-lg">\n              <div class="text-3xl mb-2">☯️</div>\n              <div class="font-semibold text-gray-700">${t?.number||"?"}. ${t?.name||"未確定"}</div>\n              <div class="text-sm text-gray-500">易経卦</div>\n            </div>\n            <div class="text-center p-4 bg-white rounded-lg">\n              <div class="text-3xl mb-2">🔮</div>\n              <div class="font-semibold text-gray-700">信頼性</div>\n              <div class="text-sm text-blue-600">${Math.round(100*e.authenticity)}%</div>\n            </div>\n            <div class="text-center p-4 bg-white rounded-lg">\n              <div class="text-3xl mb-2">🎯</div>\n              <div class="font-semibold text-gray-700">分析モード</div>\n              <div class="text-sm text-blue-600">${e.integrationMode}</div>\n            </div>\n          </div>\n        </div>\n      `}const s=e.eightScenarios?.scenarios||[];return`\n      <div class="analysis-results-386 fade-in">\n        ${i}\n        \n        \x3c!-- 8つの未来分岐 --\x3e\n        <div class="scenarios-section">\n          <h2 class="text-2xl font-bold text-gray-800 mb-4">🌸 8つの変化の道筋</h2>\n          ${this.generateScenariosHTML(s)}\n        </div>\n        \n        \x3c!-- 推奨行動 --\x3e\n        <div class="recommendation-card bg-green-50 rounded-xl p-6 mt-6 border border-green-200">\n          <h3 class="text-xl font-bold text-green-800 mb-3">🎯 推奨行動</h3>\n          <p class="text-green-700">${this.getActionRecommendation(e)}</p>\n        </div>\n      </div>\n    `},generateScenariosHTML(e){return e&&0!==e.length?`\n      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">\n        ${e.map((e,t)=>`\n          <div class="scenario-card bg-white rounded-lg p-4 border hover:shadow-lg transition-shadow cursor-pointer"\n               onclick="FutureSimulator.Core.showScenarioDetail(${t})">\n            <div class="text-center mb-3">\n              <div class="text-2xl mb-2">${this.getScenarioEmoji(e.direction)}</div>\n              <h4 class="font-semibold text-gray-800">${e.name||e.direction}</h4>\n            </div>\n            <div class="text-sm text-gray-600 mb-2">\n              ${e.description?.substring(0,80)}...\n            </div>\n            <div class="flex justify-between text-xs text-gray-500">\n              <span>確率: ${Math.round(100*(e.probability||.125))}%</span>\n              <span>${e.timeframe||"medium_term"}</span>\n            </div>\n          </div>\n        `).join("")}\n      </div>\n    `:'<p class="text-gray-500">シナリオデータを生成中...</p>'},setupAuthentic386Interactions(e){window.currentAnalysisResult=e,e.specialLineDetected?.detected&&(console.log("🌟 Special line interactions enabled"),this.setupSpecialLineInteractions(e.specialLineDetected.type))},getSpecialLineInterpretation:e=>"YouKuu"===e?"全ての要素が最高度の創造的エネルギーを持つ極めて稀な状況です。リーダーシップを分散し、各人が自律的に協力することで理想的な結果が期待できます。「群龍無首」の状態 - 特定のリーダーに依存しない組織の最高形態です。":"YouRokuu"===e?"全ての要素が最高度の受容的エネルギーを持つ極めて稀な状況です。地道で持続的なアプローチにより、長期的な安定と発展が期待できます。「永貞に利し」の状態 - 正道を守り続けることによる真の利益の獲得です。":"特殊な状況が検出されました。",getActionRecommendation(e){const t=e.specialLineDetected;if(t?.detected){if("YouKuu"===t.type)return"創造力が最高潮に達している状況です。各メンバーの自主性を最大限活かし、トップダウンではなく協調的なアプローチで進めることをお勧めします。";if("YouRokuu"===t.type)return"受容性と持続性が最高度に発揮される状況です。急がず着実に、正道を守りながら長期的な視点で取り組むことをお勧めします。"}return e.recommendedAction||"易経の指導に従い、現在の状況に適した方法で進めることをお勧めします。"},getScenarioEmoji:e=>({creative_leadership:"🐉",joyful_expression:"😊",illuminating_clarity:"☀️",initiating_action:"⚡",gentle_penetration:"🌿",adaptive_flow:"🌊",stable_foundation:"🏔️",receptive_support:"🌙","乾":"🐉","兌":"😊","離":"☀️","震":"⚡","巽":"🌿","坎":"🌊","艮":"🏔️","坤":"🌙"}[e]||"🔮"),showScenarioDetail(e){if(window.currentAnalysisResult&&window.currentAnalysisResult.eightScenarios){const t=window.currentAnalysisResult.eightScenarios.scenarios[e];t&&alert(`${t.name}\n\n${t.description||"シナリオの詳細情報"}\n\n推奨: ${t.recommendation||"状況に応じて対応してください"}`)}},setupSpecialLineInteractions(e){console.log(`🌟 Setting up ${e} interactions`)},display512PatternResults(e){console.log("🎨 Displaying 512-pattern results:",e.pattern_id);const t=this.getResultsContainer();if(!t)return void console.error("Results container not found");t.innerHTML="";const n=this.generate512PatternHTML(e);t.innerHTML=n,this.setup512PatternInteractions(e),t.scrollIntoView({behavior:"smooth",block:"start"}),this.hideLoading()},generate512PatternHTML(e){const t=e.current_pattern,n=e.future_branches;return`\n      <div class="analysis-results-512 fade-in">\n        \x3c!-- Current Pattern Display --\x3e\n        <div class="current-pattern-card bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 mb-6 border border-purple-200">\n          <div class="flex items-center justify-between mb-4">\n            <h2 class="text-2xl font-bold text-gray-800">現在の状況パターン</h2>\n            <span class="px-3 py-1 bg-purple-600 text-white rounded-full text-sm font-medium">\n              ${t.id} (512中の${t.pattern_index+1})\n            </span>\n          </div>\n          \n          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">\n            <div class="text-center p-4 bg-white rounded-lg">\n              <div class="text-3xl mb-2">☯️</div>\n              <div class="font-semibold text-gray-700">第${t.line_position}爻</div>\n              <div class="text-sm text-gray-500">\n                ${t.is_yong_yao?"用爻（特殊）":"通常爻"}\n              </div>\n            </div>\n            <div class="text-center p-4 bg-white rounded-lg">\n              <div class="text-3xl mb-2">${this.getElementEmoji(t.dominant_element)}</div>\n              <div class="font-semibold text-gray-700">${t.dominant_element}の性質</div>\n              <div class="text-sm text-gray-500">${t.transformation_type}</div>\n            </div>\n            <div class="text-center p-4 bg-white rounded-lg">\n              <div class="text-3xl mb-2">🎯</div>\n              <div class="font-semibold text-gray-700">信頼性</div>\n              <div class="text-sm text-gray-500">${Math.round(100*t.authenticity_score)}%</div>\n            </div>\n          </div>\n          \n          <div class="bg-white rounded-lg p-4">\n            <h3 class="font-semibold text-gray-800 mb-2">HaQei哲学的意味</h3>\n            <p class="text-gray-700">${t.haqei_meaning}</p>\n          </div>\n          \n          ${e.yong_yao_analysis?this.generateYongYaoHTML(e.yong_yao_analysis):""}\n        </div>\n\n        \x3c!-- Future Branches (8 Scenarios) --\x3e\n        <div class="future-branches-container">\n          <div class="flex items-center justify-between mb-6">\n            <h2 class="text-2xl font-bold text-gray-800">八象未来分岐図</h2>\n            <span class="text-sm text-gray-600">\n              512パターンから8つの代表的な未来を選出\n            </span>\n          </div>\n          \n          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">\n            ${n.map((e,t)=>this.generateBranchHTML(e,t)).join("")}\n          </div>\n        </div>\n\n        \x3c!-- Philosophical Guidance --\x3e\n        <div class="philosophical-guidance bg-gradient-to-r from-amber-50 to-orange-50 rounded-xl p-6 mt-6 border border-amber-200">\n          <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">\n            <span class="text-2xl mr-2">🧘‍♂️</span>\n            HaQei哲学的指導\n          </h3>\n          <div class="space-y-3">\n            ${e.philosophical_guidance?e.philosophical_guidance.map(e=>`<p class="text-gray-700 leading-relaxed">${e}</p>`).join(""):'<p class="text-gray-700">状況に応じた指導を生成中...</p>'}\n          </div>\n        </div>\n      </div>\n    `},generateYongYaoHTML:e=>`\n      <div class="yong-yao-analysis mt-4 p-4 bg-gradient-to-r from-yellow-50 to-amber-50 rounded-lg border border-yellow-200">\n        <h4 class="font-semibold text-amber-800 mb-2 flex items-center">\n          <span class="text-lg mr-2">⚡</span>\n          用爻の特殊な意味 - ${"yong_jiu"===e.type?"用九（創造の極致）":"用六（受容の極致）"}\n        </h4>\n        <p class="text-amber-700 text-sm leading-relaxed">${e.wisdom}</p>\n        <div class="mt-2 text-xs text-amber-600">\n          注意事項: ${e.caution}\n        </div>\n      </div>\n    `,generateBranchHTML:(e,t)=>`\n      <div class="branch-card bg-white rounded-lg p-4 border border-gray-200 hover:shadow-lg transition-all duration-300 cursor-pointer"\n           data-branch-index="${t}" \n           data-bagua="${e.bagua}">\n        <div class="text-center mb-3">\n          <div class="text-4xl mb-2">${e.emoji}</div>\n          <h3 class="font-bold text-gray-800 text-sm">${e.nature}の道</h3>\n          <p class="text-xs text-gray-600">${e.direction}</p>\n        </div>\n        \n        <div class="space-y-2">\n          <div class="text-xs">\n            <span class="font-semibold">関連性:</span> \n            <span class="inline-block w-16 h-2 bg-gray-200 rounded-full overflow-hidden">\n              <div class="h-full bg-blue-500 rounded-full" \n                   style="width: ${Math.min(100,e.relevance_score)}%"></div>\n            </span>\n          </div>\n          <div class="text-xs">\n            <span class="font-semibold">確率:</span> ${e.probability}\n          </div>\n        </div>\n        \n        <p class="text-xs text-gray-700 mt-2 line-clamp-3">${e.description}</p>\n        \n        <div class="mt-3 pt-2 border-t border-gray-100">\n          <p class="text-xs text-blue-600 font-medium">クリックで詳細表示</p>\n        </div>\n      </div>\n    `,setup512PatternInteractions(e){document.querySelectorAll(".branch-card").forEach(t=>{t.addEventListener("click",t=>{const n=parseInt(t.currentTarget.dataset.branchIndex),i=e.future_branches[n];this.showBranchDetails(i,e)})})},showBranchDetails(e,t){const n=document.createElement("div");n.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",n.innerHTML=`\n      <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-screen overflow-y-auto">\n        <div class="flex items-center justify-between mb-4">\n          <h2 class="text-2xl font-bold text-gray-800 flex items-center">\n            <span class="text-3xl mr-3">${e.emoji}</span>\n            ${e.nature}の道 (${e.bagua})\n          </h2>\n          <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">&times;</button>\n        </div>\n        \n        <div class="space-y-4">\n          <div>\n            <h3 class="font-semibold text-gray-800 mb-2">方向性</h3>\n            <p class="text-gray-700">${e.direction}</p>\n          </div>\n          \n          <div>\n            <h3 class="font-semibold text-gray-800 mb-2">詳細説明</h3>\n            <p class="text-gray-700">${e.description}</p>\n          </div>\n          \n          <div>\n            <h3 class="font-semibold text-gray-800 mb-2">指導内容</h3>\n            <p class="text-gray-700">${e.guidance}</p>\n          </div>\n          \n          ${e.haqei_wisdom?`\n            <div>\n              <h3 class="font-semibold text-gray-800 mb-2">HaQei智慧</h3>\n              <p class="text-gray-700">${e.haqei_wisdom}</p>\n            </div>\n          `:""}\n          \n          <div class="grid grid-cols-2 gap-4 mt-4">\n            <div class="text-center p-3 bg-blue-50 rounded-lg">\n              <div class="font-semibold text-blue-800">関連性</div>\n              <div class="text-2xl font-bold text-blue-600">${Math.round(e.relevance_score)}%</div>\n            </div>\n            <div class="text-center p-3 bg-green-50 rounded-lg">\n              <div class="font-semibold text-green-800">確率</div>\n              <div class="text-2xl font-bold text-green-600">${e.probability}</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `,document.body.appendChild(n),n.querySelector(".close-modal").addEventListener("click",()=>{document.body.removeChild(n)}),n.addEventListener("click",e=>{e.target===n&&document.body.removeChild(n)})},displayBinaryTreeResults(e){console.log("🌳 Displaying Binary Tree results with BinaryTreeCompleteDisplay:",{currentLine:e.currentLine,totalPaths:e.finalEightPaths?.length||0,version:e.version});const t=this.getResultsContainer();t?(t.innerHTML="",this.generateBinaryTreeHTML(e),setTimeout(()=>{const e=document.querySelector(".binary-tree-complete-analysis");e&&e.scrollIntoView({behavior:"smooth",block:"start"}),this.hideLoading()},200)):console.error("Results container not found")},generateBinaryTreeHTML(e){const t=this.enhanceResultData(e);return window.BinaryTreeCompleteDisplay?(window.BinaryTreeCompleteDisplay.display(t),'<div id="binary-tree-display-container">\x3c!-- Rendered by BinaryTreeCompleteDisplay --\x3e</div>'):'<div class="error-message">Display system not available</div>'},enhanceResultData(e){return!e.finalEightPaths&&e.branches&&(e.finalEightPaths=this.convertBranchesToPaths(e.branches)),e.finalEightPaths&&(e.finalEightPaths=e.finalEightPaths.map((e,t)=>({...e,pathIndex:e.pathIndex||t+1,title:e.title||`パス${t+1}`,description:e.description||e.fullDescription||this.generatePathDescription(e),probability:e.probability||1/8,route:e.route||["開始","中間","終了"]}))),e},convertBranchesToPaths(e){const t=[];let n=1;return e&&e.level3&&Object.entries(e.level3).forEach(([e,i])=>{Object.entries(i).forEach(([i,s])=>{Object.entries(s).forEach(([s,a])=>{t.push({pathIndex:n++,title:this.generatePathTitle(e,i,s),description:this.generatePathDescriptionFromBranch(e,i,s),probability:a.final_probability||1/8,route:this.generatePathRoute(e,i,s)})})})}),t.length>0?t:this.generateDefaultPaths()},generatePathTitle:(e,t,n)=>({progress_continue_strengthen:"継続強化・突破型",progress_continue_moderate:"継続強化・安定型",progress_adjust_strengthen:"継続調整・革新型",progress_adjust_moderate:"継続調整・改善型",transform_complete_strengthen:"転換完全・飛躍型",transform_complete_moderate:"転換完全・段階型",transform_integrate_strengthen:"転換統合・融合型",transform_integrate_moderate:"転換統合・創造型"}[`${e}_${t}_${n.replace("option_a","strengthen").replace("option_b","moderate")}`]||`${e}・${t}・${n}`),generatePathDescriptionFromBranch:(e,t,n)=>({progress_continue_strengthen:"現在の強みを最大限に活かし、既存の方向性をさらに推進する道",progress_continue_moderate:"安定性を重視しながら着実に前進する堅実な道",progress_adjust_strengthen:"基本路線を維持しながら革新的な改善を加える道",progress_adjust_moderate:"柔軟な調整により最適なバランスを保つ道",transform_complete_strengthen:"根本的な変革により飛躍的成長を達成する道",transform_complete_moderate:"計画的な転換により新たな可能性を開拓する道",transform_integrate_strengthen:"新旧の要素を創造的に統合し独自の価値を生み出す道",transform_integrate_moderate:"多様な要素をバランスよく統合する道"}[`${e}_${t}_${n.replace("option_a","strengthen").replace("option_b","moderate")}`]||"新たな可能性を探索する道"),generatePathRoute(e,t,n){const i={progress:"継続選択",transform:"転換選択",continue:"強化方向",adjust:"調整方向",complete:"完全転換",integrate:"統合方向",option_a:"積極推進",option_b:"着実進行"};return["開始",i[e]||e,i[t]||t,i[n]||n]},generateDefaultPaths:()=>[{pathIndex:1,title:"継続強化・突破型",description:"現在の強みを最大限に活かす道",probability:.135,route:["開始","継続選択","強化方向","積極推進"]},{pathIndex:2,title:"継続強化・安定型",description:"着実な成長を重視する道",probability:.115,route:["開始","継続選択","強化方向","着実進行"]},{pathIndex:3,title:"継続調整・革新型",description:"既存の枠組みを革新する道",probability:.13,route:["開始","継続選択","調整方向","積極推進"]},{pathIndex:4,title:"継続調整・改善型",description:"段階的な改善を重ねる道",probability:.12,route:["開始","継続選択","調整方向","着実進行"]},{pathIndex:5,title:"転換統合・融合型",description:"新旧の要素を統合する道",probability:.14,route:["開始","転換選択","統合方向","積極推進"]},{pathIndex:6,title:"転換統合・創造型",description:"全く新しい価値を創造する道",probability:.13,route:["開始","転換選択","統合方向","着実進行"]},{pathIndex:7,title:"転換段階・飛躍型",description:"大きな飛躍を目指す道",probability:.12,route:["開始","転換選択","完全転換","積極推進"]},{pathIndex:8,title:"転換段階・探索型",description:"新たな可能性を探索する道",probability:.11,route:["開始","転換選択","完全転換","着実進行"]}],generatePathDescription:e=>e.route&&e.route.length>0?`${e.route.join(" → ")}を通じて、新たな未来を切り開く道`:"未来への新たな可能性を探索する道",generateHaQeiIntegrationHTML:e=>`\n      <div class="haqei-integration bg-gradient-to-r from-amber-50 to-yellow-50 rounded-xl p-6 mt-6 border border-amber-200">\n        <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">\n          <span class="text-2xl mr-2">🧘‍♂️</span>\n          HaQei哲学的統合\n        </h3>\n        \n        <div class="space-y-4">\n          <div class="bg-white rounded-lg p-4">\n            <h4 class="font-semibold text-amber-800 mb-2">🤝 矛盾受容の原則</h4>\n            <p class="text-amber-700 text-sm">${e.contradiction_acceptance?.explanation||"複数の相反する道筋が同時に存在することを受け入れることで、より豊かな選択肢が生まれます"}</p>\n          </div>\n          \n          <div class="bg-white rounded-lg p-4">\n            <h4 class="font-semibold text-amber-800 mb-2">🎭 段階的分人切り替え</h4>\n            <div class="space-y-2 text-sm text-amber-700">\n              <div><strong>第1段階:</strong> ${e.persona_switching?.level1||"戦略的思考分人"}</div>\n              <div><strong>第2段階:</strong> ${e.persona_switching?.level2||"実行判断分人"}</div>\n              <div><strong>第3段階:</strong> ${e.persona_switching?.level3||"最終決断分人"}</div>\n            </div>\n          </div>\n          \n          <div class="bg-white rounded-lg p-4">\n            <h4 class="font-semibold text-amber-800 mb-2">🌟 統合的知恵</h4>\n            <p class="text-amber-700 text-sm">${e.unified_wisdom?.meta_guidance||"全ての選択肢を理解することで、状況に最適な判断が可能になります"}</p>\n          </div>\n        </div>\n      </div>\n    `,setupBinaryTreeInteractions(e){console.log("🌳 Setting up binary tree interactions"),window.currentBinaryResult=e,document.querySelectorAll(".level1-option").forEach(t=>{t.addEventListener("click",t=>{const n=t.currentTarget.dataset.choice;this.handleLevel1Selection(n,e)})}),document.querySelectorAll(".path-card").forEach(t=>{t.addEventListener("click",t=>{const n=parseInt(t.currentTarget.dataset.pathIndex);this.showPathDetails(n,e)})})},handleLevel1Selection(e,t){console.log(`🎯 Level 1 selection: ${e}`),document.getElementById("level-1-selection").classList.add("hidden"),document.getElementById("level-2-selection").classList.remove("hidden");const n=document.getElementById("level-2-options");n.innerHTML="progress"===e?'\n        <button class="level2-option bg-green-50 hover:bg-green-100 border-2 border-green-200 rounded-lg p-4 transition-all duration-300" data-choice="continue" data-parent="progress">\n          <div class="text-2xl mb-2">⬆️</div>\n          <div class="font-bold text-green-800">さらに進む</div>\n          <div class="text-sm text-green-600 mt-2">順行の方向性をより強化する</div>\n        </button>\n        <button class="level2-option bg-yellow-50 hover:bg-yellow-100 border-2 border-yellow-200 rounded-lg p-4 transition-all duration-300" data-choice="adjust" data-parent="progress">\n          <div class="text-2xl mb-2">⚖️</div>\n          <div class="font-bold text-yellow-800">一部転換</div>\n          <div class="text-sm text-yellow-600 mt-2">順行しつつも部分的に調整する</div>\n        </button>\n      ':'\n        <button class="level2-option bg-red-50 hover:bg-red-100 border-2 border-red-200 rounded-lg p-4 transition-all duration-300" data-choice="complete" data-parent="transform">\n          <div class="text-2xl mb-2">🔄</div>\n          <div class="font-bold text-red-800">完全転換</div>\n          <div class="text-sm text-red-600 mt-2">根本的な方向転換を行う</div>\n        </button>\n        <button class="level2-option bg-purple-50 hover:bg-purple-100 border-2 border-purple-200 rounded-lg p-4 transition-all duration-300" data-choice="integrate" data-parent="transform">\n          <div class="text-2xl mb-2">🤝</div>\n          <div class="font-bold text-purple-800">統合的転換</div>\n          <div class="text-sm text-purple-600 mt-2">既存要素と新要素を統合する</div>\n        </button>\n      ',document.querySelectorAll(".level2-option").forEach(e=>{e.addEventListener("click",e=>{const n=e.currentTarget.dataset.choice,i=e.currentTarget.dataset.parent;this.handleLevel2Selection(i,n,t)})})},handleLevel2Selection(e,t,n){console.log(`🎯 Level 2 selection: ${e} → ${t}`),document.getElementById("level-2-selection").classList.add("hidden"),document.getElementById("level-3-selection").classList.remove("hidden");document.getElementById("level-3-options").innerHTML=`\n      <button class="level3-option bg-blue-50 hover:bg-blue-100 border-2 border-blue-200 rounded-lg p-4 transition-all duration-300" data-choice="strengthen" data-path="${e}-${t}">\n        <div class="text-2xl mb-2">💪</div>\n        <div class="font-bold text-blue-800">継続強化</div>\n        <div class="text-sm text-blue-600 mt-2">選択した方向性をさらに強化</div>\n      </button>\n      <button class="level3-option bg-gray-50 hover:bg-gray-100 border-2 border-gray-200 rounded-lg p-4 transition-all duration-300" data-choice="moderate" data-path="${e}-${t}">\n        <div class="text-2xl mb-2">⚖️</div>\n        <div class="font-bold text-gray-800">部分的修正</div>\n        <div class="text-sm text-gray-600 mt-2">バランスを保ちながら調整</div>\n      </button>\n    `,document.querySelectorAll(".level3-option").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.choice,i=e.currentTarget.dataset.path;this.handleLevel3Selection(i,t,n)})})},handleLevel3Selection(e,t,n){console.log(`🎯 Final selection: ${e} → ${t}`),document.getElementById("level-3-selection").classList.add("hidden");const i=document.getElementById("final-patterns-display");i.classList.remove("hidden");const s=document.createElement("div");s.className="completion-message bg-emerald-50 border border-emerald-200 rounded-lg p-4 mb-6",s.innerHTML=`\n      <div class="flex items-center">\n        <div class="text-3xl mr-4">🎉</div>\n        <div>\n          <div class="font-bold text-emerald-800">選択プロセス完了！</div>\n          <div class="text-sm text-emerald-600">あなたの3段階選択: ${e} → ${t}</div>\n          <div class="text-sm text-emerald-600">以下の8つの道筋があなたの前に開かれています</div>\n        </div>\n      </div>\n    `,i.insertBefore(s,i.firstChild),i.scrollIntoView({behavior:"smooth"})},showPathDetails(e,t){const n=t.finalEightPaths[e];if(!n)return;const i=document.createElement("div");i.className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",i.innerHTML=`\n      <div class="bg-white rounded-xl p-6 max-w-2xl w-full max-h-screen overflow-y-auto">\n        <div class="flex items-center justify-between mb-4">\n          <h2 class="text-2xl font-bold text-gray-800">\n            ${n.title}\n          </h2>\n          <button class="close-modal text-gray-500 hover:text-gray-700 text-2xl">&times;</button>\n        </div>\n        \n        <div class="space-y-4">\n          <div>\n            <h3 class="font-semibold text-gray-800 mb-2">選択経路</h3>\n            <div class="flex items-center space-x-2 text-sm bg-gray-50 p-3 rounded-lg">\n              ${(n.route||[]).map(e=>`<span class="bg-white px-2 py-1 rounded">${e}</span>`).join('<span class="text-gray-400">→</span>')}\n            </div>\n          </div>\n          \n          <div>\n            <h3 class="font-semibold text-gray-800 mb-2">詳細説明</h3>\n            <p class="text-gray-700">${n.fullDescription||n.title}</p>\n          </div>\n          \n          <div>\n            <h3 class="font-semibold text-gray-800 mb-2">実践的指導</h3>\n            <ul class="list-disc list-inside text-gray-700 space-y-1">\n              ${(n.practical_guidance||["状況を観察する","段階的に進む","柔軟に対応する"]).map(e=>`<li>${e}</li>`).join("")}\n            </ul>\n          </div>\n          \n          <div class="grid grid-cols-2 gap-4">\n            <div class="text-center p-3 bg-blue-50 rounded-lg">\n              <div class="font-semibold text-blue-800">実現確率</div>\n              <div class="text-2xl font-bold text-blue-600">${Math.round(100*(n.probability||.125))}%</div>\n            </div>\n            <div class="text-center p-3 bg-green-50 rounded-lg">\n              <div class="font-semibold text-green-800">期間目安</div>\n              <div class="text-lg font-bold text-green-600">${n.timeline||"3-6ヶ月"}</div>\n            </div>\n          </div>\n          \n          <div>\n            <h3 class="font-semibold text-gray-800 mb-2">成功要因</h3>\n            <div class="flex flex-wrap gap-2">\n              ${(n.success_factors||["継続性","適応力","判断力"]).map(e=>`<span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm">${e}</span>`).join("")}\n            </div>\n          </div>\n          \n          <div>\n            <h3 class="font-semibold text-gray-800 mb-2">注意すべき課題</h3>\n            <div class="flex flex-wrap gap-2">\n              ${(n.potential_challenges||["変化への抵抗","外的要因","タイミング"]).map(e=>`<span class="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm">${e}</span>`).join("")}\n            </div>\n          </div>\n        </div>\n      </div>\n    `,document.body.appendChild(i),i.querySelector(".close-modal").addEventListener("click",()=>{document.body.removeChild(i)}),i.addEventListener("click",e=>{e.target===i&&document.body.removeChild(i)})},getResultsContainer(){return document.getElementById("results-container")||document.getElementById("analysis-results")||document.querySelector(".results-section")||this.createResultsContainer()},getElementEmoji:e=>({"木":"🌱","火":"🔥","土":"🌍","金":"⚡","水":"🌊"}[e]||"⭐"),generateScenarios(e){console.log("🎲 Generating scenarios for:",e.substring(0,50)+"...");return[{title:"現状維持の未来",description:"現在の状況を継続した場合の展開",content:"現在の方向性を維持することで、安定した成長が期待できます。リスクは少なく、着実な進歩を遂げるでしょう。",probability:"高",timeframe:"短期～中期",advice:"現在の取り組みを継続し、小さな改善を積み重ねましょう。"},{title:"積極変化の未来",description:"大胆な変化を選択した場合の展開",content:"新しい挑戦に踏み出すことで、大きな成長の機会を得られます。困難はありますが、それを乗り越えた先に新しい可能性が広がります。",probability:"中",timeframe:"中期～長期",advice:"リスクを慎重に評価しつつ、準備を整えてから行動しましょう。"},{title:"調和的発展の未来",description:"バランスを重視した選択の展開",content:"慎重さと積極性のバランスを保ちながら、段階的に変化を進めることで、最も安全で効果的な成果を得られるでしょう。",probability:"高",timeframe:"中期",advice:"様々な選択肢を検討し、最適なタイミングを見極めましょう。"},{title:"内省深化の未来",description:"自己理解を深める選択の展開",content:"まずは自分自身と向き合い、真に望む方向性を明確にすることで、より確信を持って次のステップに進めるでしょう。",probability:"中",timeframe:"短期",advice:"時間をかけて自分の価値観と目標を整理することが重要です。"},{title:"協力拡張の未来",description:"他者との連携を重視した展開",content:"信頼できる人々との協力関係を築くことで、一人では達成できない大きな成果を生み出すことができるでしょう。",probability:"中",timeframe:"中期",advice:"ネットワークを広げ、win-winの関係を構築しましょう。"},{title:"潜伏準備の未来",description:"時期を待ち準備を重ねる選択の展開",content:"今は準備の時期。適切な機会を待ちながら実力を蓄えることで、最良のタイミングで行動に移すことができるでしょう。",probability:"高",timeframe:"短期～中期",advice:"焦らず、しっかりとした基盤作りに集中しましょう。"}].sort(()=>Math.random()-.5).slice(0,4)},displayResults(e){console.log("📊 Displaying analysis results...");let t=document.getElementById("results-container")||document.getElementById("analysis-results")||document.querySelector(".results-section");t||(t=this.createResultsContainer()),t.innerHTML=`\n      <div class="results-header">\n        <h2>🔮 未来分析結果</h2>\n        <p>あなたの状況から導き出された可能性のあるシナリオです</p>\n      </div>\n      <div class="scenarios-grid">\n        ${e.map((e,t)=>`\n          <div class="scenario-card" style="animation-delay: ${.2*t}s">\n            <div class="scenario-header">\n              <h3>${e.title}</h3>\n              <span class="probability-badge">${e.probability}確率</span>\n            </div>\n            <div class="scenario-content">\n              <p class="description">${e.description}</p>\n              <p class="content">${e.content}</p>\n              <div class="scenario-meta">\n                <span class="timeframe">⏱️ ${e.timeframe}</span>\n              </div>\n              <div class="advice">\n                <strong>💡 アドバイス:</strong> ${e.advice}\n              </div>\n            </div>\n          </div>\n        `).join("")}\n      </div>\n      <div class="results-footer">\n        <p><em>※ これらは易経の思想に基づく一般的な指針です。最終的な判断はご自身でお決めください。</em></p>\n        <button onclick="location.reload()" class="retry-button">🔄 新しく分析する</button>\n      </div>\n    `,t.style.display="block",t.scrollIntoView({behavior:"smooth"})},createResultsContainer(){const e=document.createElement("div");e.id="results-container",e.className="results-section";const t=document.querySelector(".input-section")||document.querySelector("form")||document.querySelector("textarea").closest("div");return t?t.parentNode.insertBefore(e,t.nextSibling):document.body.appendChild(e),e},showLoading(){const e=document.querySelector('button[onclick*="analyze"]')||document.querySelector(".analyze-btn");e&&(e.disabled=!0,e.textContent="🔮 分析中...");const t=document.getElementById("results-loading");t&&(t.style.display="block")},hideLoading(){const e=document.querySelector('button[onclick*="analyze"]')||document.querySelector(".analyze-btn");e&&(e.disabled=!1,e.textContent="🎯 未来を分析する");const t=document.getElementById("results-loading");t&&(t.style.display="none")},async initializeEngines(){console.log("🔧 Initializing analysis engines...");try{window.IntegratedAnalysisEngine&&window.IntegratedAnalysisEngine.init(),window.SituationalContextEngine&&window.SituationalContextEngine.init(),window.MultiDimensionalContextAnalyzer&&window.MultiDimensionalContextAnalyzer.init(),console.log("✅ Analysis engines initialized")}catch(e){console.error("❌ Engine initialization error:",e)}},showError(e){console.error("❌ System Error:",e);const t=document.getElementById("error-display")||document.getElementById("result-display");t?t.innerHTML=`\n        <div class="error-message" style="background: #ff4444; color: white; padding: 1rem; border-radius: 0.5rem;">\n          <h3>システムエラー</h3>\n          <p>${e}</p>\n          <p><small>詳細はコンソールをご確認ください。</small></p>\n        </div>\n      `:alert(e),this.hideLoading()},safeLoadComponent(e){try{const t=window[e];return t&&"function"==typeof t.init?(t.init(),console.log(`✅ ${e} loaded successfully`),!0):(console.warn(`⚠️ ${e} not available or missing init method`),!1)}catch(t){return console.error(`❌ Error loading ${e}:`,t.message),!1}}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{setTimeout(()=>FutureSimulator.Core.init(),1e3)}):setTimeout(()=>FutureSimulator.Core.init(),1e3),console.log("✅ Future Simulator Core loaded");