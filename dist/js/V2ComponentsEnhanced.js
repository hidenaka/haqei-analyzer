class EnhancedMetricsCalculator{constructor(){this.wuxingMatrix={"木":{generates:"火",overcomes:"土",generatedBy:"水",overcomedBy:"金"},"火":{generates:"土",overcomes:"金",generatedBy:"木",overcomedBy:"水"},"土":{generates:"金",overcomes:"水",generatedBy:"火",overcomedBy:"木"},"金":{generates:"水",overcomes:"木",generatedBy:"土",overcomedBy:"火"},"水":{generates:"木",overcomes:"火",generatedBy:"金",overcomedBy:"土"}},this.baguaToWuxing={"乾":"金","兌":"金","離":"火","震":"木","巽":"木","坎":"水","艮":"土","坤":"土"},this.cache=new Map}calculate(e){const n=performance.now(),t=this.generateCacheKey(e);if(this.cache.has(t))return this.cache.get(t);const a=this.extractAndNormalizeVectors(e),i=this.calculateDetailedSynergy(a,e),s=this.calculateDetailedTension(a,e),r=this.calculateEnhancedConfidence(e,a),c=this.calculateBarycenter(a),l=this.calculateVariance(a,c),o=this.detectDynamicPatterns(a,i,s),d={synergy_edges:i.edges,synergy:i.global,synergy_details:i,tension:s.global,tension_details:s,confidence:r,barycenter:c,variance:l,patterns:o,computation_time:performance.now()-n};return this.cache.set(t,d),d}extractAndNormalizeVectors(e){const n=["乾","震","坎","兌","離","巽","艮","坤"],extractNormalizedVector=e=>{if(!e||!e.baguaEnergies)return n.map(()=>1/8);const t=n.map(n=>Math.max(0,(e.baguaEnergies[n]||0)/100)),a=Math.sqrt(t.reduce((e,n)=>e+n*n,0));return 0===a?n.map(()=>1/8):t.map(e=>e/a)};return{engine:extractNormalizedVector(e.engineOS),interface:extractNormalizedVector(e.interfaceOS),safe:extractNormalizedVector(e.safeModeOS),raw:{engine:e.engineOS?.baguaEnergies||{},interface:e.interfaceOS?.baguaEnergies||{},safe:e.safeModeOS?.baguaEnergies||{}}}}calculateDetailedSynergy(e,n){const t={},a={};[["engine","interface","EI"],["interface","safe","IS"],["engine","safe","ES"]].forEach(([i,s,r])=>{const c=this.cosineSimilarity(e[i],e[s]),l=this.calculateWuxingSynergy(n[i+"OS"],n[s+"OS"]),o=this.calculateResonance(e[i],e[s]),d=Math.min(1,Math.max(0,.7*c+.2*l+.1*o));t[r]=d,a[r]={cosine:c,wuxing:l,resonance:o,final:d}});const i=this.calculateEdgeWeights(e),s=t.EI*i.EI+t.IS*i.IS+t.ES*i.ES;return{edges:t,global:s,weights:i,details:a}}calculateDetailedTension(e,n){const t={},a={};[["engine","interface","EI"],["interface","safe","IS"],["engine","safe","ES"]].forEach(([i,s,r])=>{const c=Math.max(0,-this.cosineSimilarity(e[i],e[s])),l=this.calculateWuxingConflict(n[i+"OS"],n[s+"OS"]),o=this.calculateCollision(e[i],e[s]),d=this.calculateDivergence(e[i],e[s]),g=Math.min(1,.4*c+.3*l+.2*o+.1*d);t[r]=g,a[r]={negative_cosine:c,wuxing_conflict:l,collision:o,divergence:d,final:g}});const i=this.calculateTriangleElongation(e),s=Object.values(t).reduce((e,n)=>e+n,0)/3,r=Math.min(1,s+.15*i);return{edges:t,global:r,elongation:i,details:a}}calculateWuxingSynergy(e,n){if(!e||!n)return 0;const t=this.getDominantBagua(e),a=this.getDominantBagua(n),i=this.baguaToWuxing[t],s=this.baguaToWuxing[a];return i&&s?this.wuxingMatrix[i].generates===s||this.wuxingMatrix[s].generates===i?.8:i===s?.5:0:0}calculateWuxingConflict(e,n){if(!e||!n)return 0;const t=this.getDominantBagua(e),a=this.getDominantBagua(n),i=this.baguaToWuxing[t],s=this.baguaToWuxing[a];return i&&s&&(this.wuxingMatrix[i].overcomes===s||this.wuxingMatrix[s].overcomes===i)?.7:0}getDominantBagua(e){if(!e||!e.baguaEnergies)return"乾";const n=Object.entries(e.baguaEnergies);return 0===n.length?"乾":n.reduce((n,[t,a])=>a>(e.baguaEnergies[n]||0)?t:n,n[0][0])}calculateResonance(e,n){let t=0;for(let a=0;a<e.length;a++)e[a]>.15&&n[a]>.15&&(t+=e[a]*n[a]);return Math.min(1,2*t)}calculateCollision(e,n){let t=0;for(let a=0;a<e.length;a++){const i=Math.abs(e[a]-n[a]);i>.3&&(t+=i*Math.max(e[a],n[a]))}return Math.min(1,t)}calculateDivergence(e,n){let t=0;for(let a=0;a<e.length;a++){const i=e[a]+.001,s=n[a]+.001;t+=i*Math.log(i/s)}return Math.min(1,Math.abs(t)/2)}calculateEdgeWeights(e){const n=this.vectorStrength(e.engine),t=this.vectorStrength(e.interface),a=this.vectorStrength(e.safe),i=n+t+a;return{EI:(n+t)/(2*i),IS:(t+a)/(2*i),ES:(n+a)/(2*i)}}vectorStrength(e){return 1/(1+e.reduce((e,n)=>n<=0?e:e-n*Math.log(n),0))}calculateTriangleElongation(e){const n=[this.euclideanDistance(e.engine,e.interface),this.euclideanDistance(e.interface,e.safe),this.euclideanDistance(e.engine,e.safe)],t=n.reduce((e,n)=>e+n,0),a=t/2,i=a*(a-n[0])*(a-n[1])*(a-n[2]);if(i<=0)return 1;const s=Math.sqrt(i),r=Math.sqrt(3)/4*Math.pow(t/3,2);return 1-Math.min(1,s/r)}calculateEnhancedConfidence(e,n){const t=this.calculateInternalConsistency(e),a=this.estimateTemporalStability(n),i=this.calculateResponseNaturality(e),s=this.calculateHerfindahl(n),r=.3*t+.3*a+.2*i+.2*(1-3*Math.abs(s-.33));return Math.max(0,Math.min(1,r))}calculateInternalConsistency(e){let n=0;return["engineOS","interfaceOS","safeModeOS"].forEach(t=>{const a=e[t];if(!a||!a.baguaEnergies)return void(n+=.5);const i=Object.values(a.baguaEnergies),s=i.reduce((e,n)=>e+n,0)/i.length,r=i.reduce((e,n)=>e+Math.pow(n-s,2),0)/i.length,c=r>0?Math.sqrt(r)/s:0;n+=1/(1+c)}),n/3}estimateTemporalStability(e){const n=[this.euclideanDistance(e.engine,e.interface),this.euclideanDistance(e.interface,e.safe),this.euclideanDistance(e.engine,e.safe)].reduce((e,n)=>e+n,0)/3;return Math.exp(-Math.pow(n-.5,2)/.1)}calculateResponseNaturality(e){let n=1;return["engineOS","interfaceOS","safeModeOS"].forEach(t=>{const a=e[t];if(!a||!a.baguaEnergies)return;Object.values(a.baguaEnergies).forEach(e=>{(e<10||e>90)&&(n*=.95),50===e&&(n*=.98)})}),n}calculateBarycenter(e){const n=.33,t=.33,a=.34,i=[];for(let s=0;s<8;s++)i[s]=e.engine[s]*n+e.interface[s]*t+e.safe[s]*a;return i}calculateVariance(e,n){let t=0;return["engine","interface","safe"].forEach(a=>{for(let i=0;i<8;i++)t+=Math.pow(e[a][i]-n[i],2)}),t/24}detectDynamicPatterns(e,n,t){const a=[];n.global>.6&&t.global<.3&&a.push({type:"harmony",label:"調和型",description:"3つのOSが協調的に機能",strength:(n.global-t.global)/2}),n.global<.3&&t.global>.6&&a.push({type:"conflict",label:"葛藤型",description:"OS間に創造的緊張が存在",strength:(t.global-n.global)/2});const i=this.calculateDominance(e.engine,e);i>.5&&a.push({type:"engine-led",label:"Engine主導",description:"創造性と探求が支配的",strength:i});const s=this.calculateBalance(e);return s>.7&&a.push({type:"balanced",label:"バランス型",description:"全OSが均等に機能",strength:s}),a}calculateDominance(e,n){const t=Object.values(n).flat().reduce((e,n)=>e+n,0);return e.reduce((e,n)=>e+n,0)/t}calculateBalance(e){const n=[e.engine.reduce((e,n)=>e+n,0),e.interface.reduce((e,n)=>e+n,0),e.safe.reduce((e,n)=>e+n,0)],t=n.reduce((e,n)=>e+n,0)/3,a=n.reduce((e,n)=>e+Math.pow(n-t,2),0)/3;return Math.exp(10*-a)}cosineSimilarity(e,n){let t=0,a=0,i=0;for(let s=0;s<e.length;s++)t+=e[s]*n[s],a+=e[s]*e[s],i+=n[s]*n[s];return 0===a||0===i?0:t/(Math.sqrt(a)*Math.sqrt(i))}euclideanDistance(e,n){let t=0;for(let a=0;a<e.length;a++)t+=Math.pow(e[a]-n[a],2);return Math.sqrt(t)}calculateHerfindahl(e){const n=[...e.engine,...e.interface,...e.safe],t=n.reduce((e,n)=>e+n,0);return 0===t?1/24:n.reduce((e,n)=>e+Math.pow(n/t,2),0)}generateCacheKey(e){const n=[];return["engineOS","interfaceOS","safeModeOS"].forEach(t=>{e[t]?.baguaEnergies&&n.push(...Object.values(e[t].baguaEnergies))}),n.join("_")}}class EnhancedZoneBRenderer{constructor(){this.calculator=new EnhancedMetricsCalculator}render(e,n){const t=this.calculator.calculate(n);e.innerHTML=`\n            <div class="zone-b-container">\n                <h3 class="zone-title">力学ステートメント</h3>\n                \n                <div class="dynamics-grid">\n                    ${this.renderSynergyCard(t.synergy_details)}\n                    ${this.renderTensionCard(t.tension_details)}\n                </div>\n                \n                <div class="pattern-insights">\n                    ${this.renderPatterns(t.patterns)}\n                </div>\n                \n                <div class="detailed-metrics">\n                    ${this.renderDetailedMetrics(t)}\n                </div>\n                \n                <div class="computation-info">\n                    <small>計算時間: ${t.computation_time.toFixed(2)}ms</small>\n                </div>\n            </div>\n        `,this.attachEventListeners(e,t)}renderSynergyCard(e){return`\n            <div class="dynamics-card synergy-card ${e.global>.6?"high":e.global>.3?"medium":"low"}">\n                <h4>シナジー: ${(100*e.global).toFixed(1)}%</h4>\n                <div class="edge-details">\n                    ${this.renderEdgeDetail("E-I",e.edges.EI,e.details.EI)}\n                    ${this.renderEdgeDetail("I-S",e.edges.IS,e.details.IS)}\n                    ${this.renderEdgeDetail("E-S",e.edges.ES,e.details.ES)}\n                </div>\n                <p class="insight">\n                    ${this.generateSynergyInsight(e)}\n                </p>\n            </div>\n        `}renderTensionCard(e){return`\n            <div class="dynamics-card tension-card ${e.global>.6?"high":e.global>.3?"medium":"low"}">\n                <h4>テンション: ${(100*e.global).toFixed(1)}%</h4>\n                <div class="edge-details">\n                    ${this.renderEdgeDetail("E-I",e.edges.EI,e.details.EI)}\n                    ${this.renderEdgeDetail("I-S",e.edges.IS,e.details.IS)}\n                    ${this.renderEdgeDetail("E-S",e.edges.ES,e.details.ES)}\n                </div>\n                <p class="insight">\n                    ${this.generateTensionInsight(e)}\n                </p>\n            </div>\n        `}renderEdgeDetail(e,n,t){return`\n            <div class="edge-detail" data-edge="${e}">\n                <span class="edge-label">${e}</span>\n                <div class="edge-bar">\n                    <div class="edge-fill" style="width: ${100*n}%"></div>\n                </div>\n                <span class="edge-value">${(100*n).toFixed(0)}%</span>\n            </div>\n        `}renderPatterns(e){return e&&0!==e.length?e.map(e=>`\n            <div class="pattern-badge ${e.type}">\n                <span class="pattern-label">${e.label}</span>\n                <span class="pattern-strength">${(100*e.strength).toFixed(0)}%</span>\n                <div class="pattern-description">${e.description}</div>\n            </div>\n        `).join(""):'<p class="no-patterns">特定のパターンは検出されませんでした</p>'}renderDetailedMetrics(e){return`\n            <details class="metrics-details">\n                <summary>詳細メトリクス</summary>\n                <div class="metrics-grid">\n                    <div class="metric-item">\n                        <span>Confidence</span>\n                        <span>${(100*e.confidence).toFixed(1)}%</span>\n                    </div>\n                    <div class="metric-item">\n                        <span>重心分散</span>\n                        <span>${e.variance.toFixed(3)}</span>\n                    </div>\n                    <div class="metric-item">\n                        <span>三角形歪度</span>\n                        <span>${(100*e.tension_details.elongation).toFixed(1)}%</span>\n                    </div>\n                </div>\n            </details>\n        `}generateSynergyInsight(e){return e.global>.7?"非常に高い協調性。3つのOSが統合的に機能しています。":e.global>.4?"適度な協調性。状況に応じた柔軟な切り替えが可能です。":"独立性が高い状態。各OSが個別に機能する傾向があります。"}generateTensionInsight(e){return e.global>.7?"高い内的葛藤。創造的な緊張が成長の機会となります。":e.global>.4?"健全な緊張状態。バランスを保ちながら発展可能です。":"安定した状態。変化への準備が整っています。"}attachEventListeners(e,n){e.querySelectorAll(".edge-detail").forEach(e=>{e.addEventListener("mouseenter",e=>{const t=e.currentTarget.dataset.edge.replace("-","");this.showEdgeTooltip(e.currentTarget,n,t)}),e.addEventListener("mouseleave",()=>{this.hideTooltip()})})}showEdgeTooltip(e,n,t){const a=document.createElement("div");a.className="edge-tooltip",a.innerHTML=`\n            <div class="tooltip-content">\n                <strong>${t}詳細</strong>\n                <div>コサイン類似度: ${(100*n.synergy_details.details[t]?.cosine).toFixed(1)}%</div>\n                <div>五行相生: ${(100*n.synergy_details.details[t]?.wuxing).toFixed(1)}%</div>\n                <div>共鳴度: ${(100*n.synergy_details.details[t]?.resonance).toFixed(1)}%</div>\n            </div>\n        `,e.appendChild(a)}hideTooltip(){document.querySelectorAll(".edge-tooltip").forEach(e=>e.remove())}}"undefined"!=typeof module&&module.exports&&(module.exports={EnhancedMetricsCalculator:EnhancedMetricsCalculator,EnhancedZoneBRenderer:EnhancedZoneBRenderer});