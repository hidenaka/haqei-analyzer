console.log("🧠 ML Integration Loading with HaQei Philosophy..."),window.MLIntegration={initialized:!1,haqeiConfiguration:{philosophy:"haqei",approach:"harmony_driven",acceptance_contradiction:!0,organic_learning:!0,compassionate_analysis:!0,wisdom_guided:!0},engineOS:null,interfaceOS:null,safeMode:null,async init(){console.log("🚀 MLIntegration initializing with HaQei principles...");try{this.setupTripleOSArchitecture(),await this.initializeMLModels(),await this.setupHaQeiEnhancement(),this.validateMLCapabilities(),this.initialized=!0,console.log("✅ MLIntegration initialized with HaQei philosophy")}catch(e){console.error("❌ MLIntegration initialization failed:",e),this.activateSafeMode()}},setupTripleOSArchitecture(){console.log("🔧 Setting up Triple OS Architecture for ML..."),this.engineOS={name:"ML Engine OS",version:"1.0.0",philosophy:"haqei-ml",async analyzeText(e,t={}){try{const i={sentiment:this.analyzeSentiment(e),keywords:this.extractKeywords(e),themes:this.identifyThemes(e),emotions:this.detectEmotions(e),complexity:this.assessComplexity(e),haqei_alignment:this.assessHaQeiAlignment(e)};return{text:e,analysis:i,context:t,confidence:this.calculateOverallConfidence(i),philosophy:"haqei-enhanced"}}catch(i){return console.warn("⚠️ Text analysis error:",i),this.createFallbackAnalysis(e)}},analyzeSentiment(e){let t=0,i=0;["嬉しい","楽しい","幸せ","良い","素晴らしい","愛","希望","成功","調和","平和"].forEach(i=>{const n=(e.match(new RegExp(i,"g"))||[]).length;t+=n}),["悲しい","辛い","困る","悪い","問題","不安","心配","失敗","対立","混乱"].forEach(t=>{const n=(e.match(new RegExp(t,"g"))||[]).length;i+=n});const n=t+i;if(0===n)return{polarity:0,magnitude:0,classification:"neutral"};const a=(t-i)/n;let s="neutral";return a>.2?s="positive":a<-.2&&(s="negative"),{polarity:a,magnitude:n/e.length*100,classification:s,positive_score:t,negative_score:i}},extractKeywords(e){const t=e.match(/[一-龯]+/g)||[],i=new Map;t.forEach(e=>{e.length>=2&&i.set(e,(i.get(e)||0)+1)});return Array.from(i.entries()).map(([t,i])=>({word:t,frequency:i,importance:this.calculateWordImportance(t,i,e.length),category:this.categorizeWord(t)})).sort((e,t)=>t.importance-e.importance).slice(0,10)},calculateWordImportance(e,t,i){let n=t/i*100;e.length>=3&&(n*=1.2),e.length>=4&&(n*=1.1);return["調和","慈悲","智慧","真実","平和","理解","成長","愛","協力"].includes(e)&&(n*=1.5),Math.min(n,1)},categorizeWord(e){const t={emotion:["嬉しい","悲しい","愛","怒り","不安","希望"],action:["する","行う","作る","学ぶ","成長","変化"],relation:["関係","友人","家族","仲間","協力","理解"],time:["過去","現在","未来","時間","瞬間"],philosophy:["調和","智慧","真実","慈悲","平和"]};for(const[i,n]of Object.entries(t))if(n.some(t=>e.includes(t)))return i;return"general"},identifyThemes(e){const t=[];return Object.entries({personal_development:/成長|発展|向上|自己実現|学習/g,relationships:/関係|友人|家族|愛|理解|協力/g,work_career:/仕事|会社|キャリア|職場|プロジェクト/g,health_wellness:/健康|体調|心身|バランス|ウェルネス/g,spirituality:/精神|魂|哲学|瞑想|智慧|真実/g,creativity:/創造|アート|表現|革新|アイデア/g}).forEach(([i,n])=>{const a=(e.match(n)||[]).length;a>0&&t.push({theme:i,relevance:Math.min(a/3,1),matches:a})}),t.sort((e,t)=>t.relevance-e.relevance)},detectEmotions(e){const t={};let i=0;Object.entries({joy:/嬉し|楽し|幸せ|喜び|満足|良い/g,sadness:/悲し|辛い|寂し|憂鬱|落ち込/g,anger:/怒り|腹立|イライラ|憤り|不満/g,fear:/不安|心配|怖|恐れ|緊張/g,love:/愛|好き|大切|慈し|思いやり/g,hope:/希望|期待|夢|願い|未来/g,peace:/平和|安心|落ち着|調和|静か/g}).forEach(([n,a])=>{const s=(e.match(a)||[]).length;t[n]={count:s,intensity:Math.min(s/2,1)},i+=s});let n=0,a=0;return["joy","love","hope","peace"].forEach(e=>{n+=t[e].count}),["sadness","anger","fear"].forEach(e=>{a+=t[e].count}),{emotions:t,emotional_balance:{positive:n,negative:a,ratio:i>0?n/i:.5},dominant_emotion:this.findDominantEmotion(t),overall_intensity:i/e.length*100}},findDominantEmotion(e){let t=0,i="neutral";return Object.entries(e).forEach(([e,n])=>{n.intensity>t&&(t=n.intensity,i=e)}),{emotion:i,intensity:t}},assessComplexity(e){const t={length:e.length/500,sentence_count:(e.match(/[。！？]/g)||[]).length,unique_words:new Set(e.match(/[一-龯]+/g)||[]).size,conjunction_usage:(e.match(/しかし|だが|ところが|一方|それでも/g)||[]).length,abstract_concepts:(e.match(/概念|思考|哲学|精神|本質/g)||[]).length},i=.2*Math.min(t.length,1)+.2*Math.min(t.sentence_count/10,1)+.3*Math.min(t.unique_words/50,1)+.2*Math.min(t.conjunction_usage/3,1)+.1*Math.min(t.abstract_concepts/5,1);return{score:i,level:i>.7?"high":i>.4?"medium":"low",factors:t}},assessHaQeiAlignment(e){const t={};let i=0;return Object.entries({harmony:/調和|平和|バランス|統合|協調|協力/g,compassion:/慈悲|思いやり|愛|共感|理解|支援|優しさ/g,wisdom:/智慧|知恵|学習|成長|洞察|経験|理解/g,authenticity:/真実|誠実|正直|自然|純粋|本質|素直/g}).forEach(([n,a])=>{const s=(e.match(a)||[]).length,o=Math.min(s/3,1);t[n]={matches:s,score:o,keywords:[...e.matchAll(a)].map(e=>e[0])},i+=o}),{principles:t,overall_score:i/4,classification:this.classifyHaQeiAlignment(i/4),recommendations:this.generateHaQeiRecommendations(t)}},classifyHaQeiAlignment:e=>e>=.7?"highly_aligned":e>=.4?"moderately_aligned":e>=.2?"partially_aligned":"minimally_aligned",generateHaQeiRecommendations(e){const t=[];return Object.entries(e).forEach(([e,i])=>{if(i.score<.5){const i={harmony:"調和と協力の要素を取り入れることをお勧めします",compassion:"思いやりと共感の視点を加えることをお勧めします",wisdom:"学習と成長の機会を見つけることをお勧めします",authenticity:"真実と誠実さを重視することをお勧めします"};t.push(i[e])}}),t},calculateOverallConfidence:e=>[e.sentiment?.2:0,e.keywords.length>0?.2:0,e.themes.length>0?.2:0,e.emotions?.2:0,e.haqei_alignment?.2:0].reduce((e,t)=>e+t,0),createFallbackAnalysis:e=>({text:e,analysis:{sentiment:{polarity:0,classification:"neutral"},keywords:[],themes:[],emotions:{emotions:{},emotional_balance:{ratio:.5}},complexity:{score:.3,level:"low"},haqei_alignment:{overall_score:.3,classification:"partially_aligned"}},confidence:.3,philosophy:"haqei-fallback"})},this.interfaceOS={name:"ML Interface OS",formatAnalysisResult(e){return{summary:{confidence:Math.round(100*e.confidence)+"%",sentiment:e.analysis.sentiment.classification,complexity:e.analysis.complexity.level,haqei_alignment:e.analysis.haqei_alignment.classification,top_keywords:e.analysis.keywords.slice(0,5).map(e=>e.word)},detailed:{sentiment_analysis:this.formatSentimentAnalysis(e.analysis.sentiment),keyword_analysis:this.formatKeywordAnalysis(e.analysis.keywords),theme_analysis:this.formatThemeAnalysis(e.analysis.themes),emotion_analysis:this.formatEmotionAnalysis(e.analysis.emotions),haqei_analysis:this.formatHaQeiAnalysis(e.analysis.haqei_alignment)},insights:this.generateInsights(e.analysis),recommendations:this.generateRecommendations(e.analysis)}},formatSentimentAnalysis(e){return{polarity:e.polarity?.toFixed(2)||0,classification:e.classification,strength:e.magnitude?.toFixed(2)||0,interpretation:this.interpretSentiment(e.classification,e.polarity)}},interpretSentiment:(e,t)=>({positive:`ポジティブな感情が表現されています（強度: ${Math.abs(100*t).toFixed(0)}%）`,negative:`ネガティブな感情が表現されています（強度: ${Math.abs(100*t).toFixed(0)}%）`,neutral:"中性的な表現です"}[e]||"分析中..."),formatKeywordAnalysis(e){return{total_keywords:e.length,top_keywords:e.slice(0,5),categories:this.groupKeywordsByCategory(e),importance_distribution:this.calculateImportanceDistribution(e)}},groupKeywordsByCategory(e){const t={};return e.forEach(e=>{const i=e.category||"general";t[i]||(t[i]=[]),t[i].push(e)}),Object.entries(t).map(([e,t])=>({category:e,count:t.length,keywords:t.slice(0,3).map(e=>e.word)}))},calculateImportanceDistribution(e){let t=0,i=0,n=0;return e.forEach(e=>{e.importance>=.7?t++:e.importance>=.4?i++:n++}),{high:t,medium:i,low:n}},formatThemeAnalysis:e=>({identified_themes:e.length,primary_theme:e[0]||null,theme_distribution:e.map(e=>({theme:e.theme,relevance:Math.round(100*e.relevance)+"%",strength:e.matches}))}),formatEmotionAnalysis:e=>({dominant_emotion:e.dominant_emotion,emotional_balance:{positive_ratio:Math.round(100*e.emotional_balance.ratio)+"%",balance_type:e.emotional_balance.ratio>.6?"positive":e.emotional_balance.ratio<.4?"negative":"balanced"},emotion_intensity:Math.round(100*e.overall_intensity)/100,detected_emotions:Object.entries(e.emotions).filter(([e,t])=>t.intensity>0).map(([e,t])=>({emotion:e,intensity:Math.round(100*t.intensity)+"%"}))}),formatHaQeiAnalysis:e=>({overall_alignment:Math.round(100*e.overall_score)+"%",classification:e.classification,principle_scores:Object.entries(e.principles).map(([e,t])=>({principle:e,score:Math.round(100*t.score)+"%",keywords:t.keywords})),recommendations:e.recommendations}),generateInsights(e){const t=[];return"neutral"!==e.sentiment.classification&&t.push(`文章は${e.sentiment.classification}なトーンを持っています`),e.themes.length>0&&t.push(`主要テーマは「${e.themes[0].theme}」です`),e.haqei_alignment.overall_score>.6&&t.push("HaQei哲学の原理と高い適合性を示しています"),t},generateRecommendations(e){const t=[];return e.haqei_alignment.recommendations.length>0&&t.push(...e.haqei_alignment.recommendations),e.emotions.emotional_balance.ratio<.3&&t.push("よりポジティブな視点を取り入れることをお勧めします"),"low"===e.complexity.level&&t.push("より詳細な説明を加えることで内容が充実します"),t}},this.safeMode={name:"ML Safe Mode OS",active:!1,activate(){return console.log("🛡️ MLIntegration Safe Mode activated"),this.active=!0,{basic_analysis:!0,advanced_features:!1,philosophy:"haqei-safe"}},performSafeAnalysis(e){const t=e.length,i=e.includes("良い")||e.includes("嬉しい")?"positive":e.includes("悪い")||e.includes("悲しい")?"negative":"neutral";return{text:e,analysis:{word_count:t,basic_sentiment:i,safe_mode:!0},confidence:.3,philosophy:"haqei-safe"}}},console.log("✅ Triple OS Architecture setup complete")},async initializeMLModels(){console.log("🧠 Initializing ML models..."),this.models={sentiment:{loaded:!0,type:"rule_based"},keyword_extraction:{loaded:!0,type:"frequency_based"},theme_detection:{loaded:!0,type:"pattern_matching"},emotion_detection:{loaded:!0,type:"lexicon_based"},complexity_analysis:{loaded:!0,type:"linguistic_features"}},console.log("✅ ML models initialized")},async setupHaQeiEnhancement(){console.log("☯️ Setting up HaQei enhancement..."),this.haqeiEnhancement={harmony_enhancement:e=>(e.haqei_alignment.principles.harmony.score<.5&&(e.recommendations=e.recommendations||[],e.recommendations.push("調和と協力の視点を加えることをお勧めします")),e),compassion_enhancement:e=>(e.emotions.emotional_balance.ratio<.4&&(e.recommendations=e.recommendations||[],e.recommendations.push("思いやりと共感の要素を取り入れることをお勧めします")),e),wisdom_enhancement:e=>("low"===e.complexity.level&&(e.recommendations=e.recommendations||[],e.recommendations.push("より深い洞察や学びの要素を追加することをお勧めします")),e),authenticity_enhancement:e=>(e.haqei_alignment.principles.authenticity.score<.5&&(e.recommendations=e.recommendations||[],e.recommendations.push("誠実さと真実の表現を重視することをお勧めします")),e)},console.log("✅ HaQei enhancement setup complete")},validateMLCapabilities(){console.log("🔍 Validating ML capabilities...");const e={text_analysis:!!this.engineOS,sentiment_analysis:!0,keyword_extraction:!0,theme_detection:!0,emotion_detection:!0,haqei_alignment:!0};this.capabilities=e,console.log("✅ ML capabilities validated:",e)},activateSafeMode(){console.log("🛡️ Activating Safe Mode..."),this.safeMode.activate(),this.initialized=!0},async analyzeText(e,t={}){this.initialized||await this.init();try{if(this.safeMode.active)return this.safeMode.performSafeAnalysis(e);const i=await this.engineOS.analyzeText(e,t),n=this.applyHaQeiEnhancement(i);return this.interfaceOS.formatAnalysisResult(n)}catch(i){return console.error("❌ Text analysis failed:",i),this.safeMode.activate(),this.safeMode.performSafeAnalysis(e)}},applyHaQeiEnhancement(e){let t={...e};return Object.values(this.haqeiEnhancement).forEach(e=>{t.analysis=e(t.analysis)}),t},getStatus(){return{initialized:this.initialized,safe_mode_active:this.safeMode?.active||!1,models_loaded:Object.keys(this.models||{}).length,capabilities:this.capabilities||{},philosophy:"haqei",architecture:"triple-os"}},getCapabilities(){const e=["basic_text_analysis"];return this.engineOS&&e.push("advanced_text_analysis","sentiment_analysis","keyword_extraction"),this.haqeiEnhancement&&e.push("haqei_alignment_analysis","philosophy_enhancement"),this.safeMode?.active||e.push("theme_detection","emotion_analysis","complexity_assessment"),e}},document.addEventListener("DOMContentLoaded",()=>{window.MLIntegration.init()}),console.log("✅ ML Integration loaded with HaQei Philosophy");