export class LineSelector{constructor(){this.layers={lower:[1,2],middle:[3,4],upper:[5,6]},this.themeLayerMapping={"仕事":"middle","人間関係":"middle","健康":"lower","学習":"lower","財務":"upper",default:"middle"}}selectStartingLine(e,t){const n=t.keyThemes?.[0]?.name||"default",r=this.themeLayerMapping[n]||this.themeLayerMapping.default;let i=0;"high"===t.urgencyLevel?i=1:"low"===t.urgencyLevel&&(i=-1);const o=this.getLayerLines(r,i),l=t.emotionalTone?.intensity||.5,a=Math.floor(l*o.length);return o[Math.min(a,o.length-1)]}getLayerLines(e,t=0){const n=["lower","middle","upper"];let r=n.indexOf(e);return r=Math.max(0,Math.min(2,r+t)),this.layers[n[r]]}determineChangeCount(e){const t=e.complexityLevel;if("low"===t)return 1;if("medium"===t)return 2;if("high"===t)return 3;if("mixed"===e.emotionalTone?.type){const e="low"===t?2:3;return Math.min(4,e+Math.floor(2*Math.random()))}return 2}selectLinesToChange(e,t,n=null){const r=n||this.determineChangeCount(t),i=this.selectStartingLine({},t),o=new Set([i]);for(;o.size<r&&o.size<6;){const e=[];for(const t of o)t>1&&!o.has(t-1)&&e.push(t-1),t<6&&!o.has(t+1)&&e.push(t+1);if(0===e.length)for(let t=1;t<=6;t++)o.has(t)||e.push(t);if(!(e.length>0))break;{const t=e[Math.floor(Math.random()*e.length)];o.add(t)}}return Array.from(o).sort((e,t)=>e-t)}getLayerDescription(e){return{lower:"基礎・開始の段階",middle:"実行・展開の段階",upper:"完成・終結の段階"}[e]||"変化の段階"}getLinePositionMeaning(e){return{1:"始まりの兆し",2:"内的な準備",3:"外への一歩",4:"外的な展開",5:"成熟と統合",6:"完成と転換"}[e]||`第${e}爻`}}