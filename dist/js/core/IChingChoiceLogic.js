console.log("☯️ IChingChoiceLogic Loading..."),function(){"use strict";class IChingChoiceLogic{constructor(){this.name="IChingChoiceLogic",this.version="2.0.0",this.h384db=null,this.hexagramSequence=["乾為天","坤為地","水雷屯","山水蒙","水天需","天水訟","地水師","水地比","風天小畜","天澤履","地天泰","天地否","天火同人","火天大有","地山謙","雷地豫","澤雷随","山風蠱","地澤臨","風地観","火雷噬嗑","山火賁","山地剥","地雷復","天雷无妄","山天大畜","山雷頤","澤風大過","坎為水","離為火","澤山咸","雷風恒","天山遯","雷天大壮","火地晋","地火明夷","風火家人","火澤睽","水山蹇","雷水解","山澤損","風雷益","澤天夬","天風姤","澤地萃","地風升","澤水困","水風井","澤火革","火風鼎","震為雷","艮為山","風山漸","雷澤帰妹","雷火豊","火山旅","巽為風","兌為澤","風水渙","水澤節","風澤中孚","雷山小過","水火既済","火水未済"],this.yaoNames={1:{yang:"初九",yin:"初六"},2:{yang:"九二",yin:"六二"},3:{yang:"九三",yin:"六三"},4:{yang:"九四",yin:"六四"},5:{yang:"九五",yin:"六五"},6:{yang:"上九",yin:"上六"}}}async initialize(){return console.log("🔄 IChingChoiceLogic initializing..."),window.h384db&&window.h384db.isLoaded?this.h384db=window.h384db:console.warn("⚠️ H384 Database not ready"),console.log("✅ IChingChoiceLogic initialized"),!0}calculateChange(e,t){return console.log(`🔄 Calculating change: ${e["卦名"]} ${e["爻"]}, follow=${t}`),t?this.progressYao(e):this.changeYao(e)}progressYao(e){const t=this.getYaoNumber(e["爻"]),o=e["卦番号"];if(t<6){const i=t+1,n=this.getHexagramYaoData(o,i);return console.log(`📈 進爻: ${e["爻"]} → ${n["爻"]}`),n}{const t=this.getNextHexagramBySequence(o),i=this.getHexagramYaoData(t,1);return console.log(`📈 次卦へ: ${e["卦名"]} → ${i["卦名"]}`),i}}getNextHexagramBySequence(e){return 64===e?1:e+1}changeYao(e){const t=this.hexagramToBinary(e["卦番号"]),o=this.getYaoNumber(e["爻"]),i=o-1,n=[...t];n[i]="1"===n[i]?"0":"1";const a=this.binaryToHexagram(n.join("")),r=this.getHexagramYaoData(a,o);return console.log(`🔄 変爻: ${e["卦名"]}${e["爻"]} → ${r["卦名"]}${r["爻"]}`),r}getYaoNumber(e){return{"初九":1,"初六":1,"九二":2,"六二":2,"九三":3,"六三":3,"九四":4,"六四":4,"九五":5,"六五":5,"上九":6,"上六":6,"用九":7,"用六":7}[e]||1}isYangYao(e){return e.includes("九")}hexagramToBinary(e){return this.getHexagramStructure(e)}binaryToHexagram(e){return this.findHexagramByStructure(e)}getHexagramStructure(e){const t={1:"111111",2:"000000",3:"010001",4:"100010",5:"010111",6:"111010",7:"000010",8:"010000",9:"110111",10:"111011",11:"000111",12:"111000",13:"111101",14:"101111",15:"000100",16:"001000",17:"011001",18:"100110",19:"000011",20:"110000",21:"101001",22:"100101",23:"100000",24:"000001",25:"111001",26:"100111",27:"100001",28:"011110",29:"010010",30:"101101",31:"011100",32:"001110",33:"111100",34:"001111",35:"101000",36:"000101",37:"110101",38:"101011",39:"010100",40:"001010",41:"100011",42:"110001",43:"011111",44:"111110",45:"011000",46:"000110",47:"011010",48:"010110",49:"011101",50:"101110",51:"001001",52:"100100",53:"110100",54:"001011",55:"001101",56:"101100",57:"110110",58:"011011",59:"110010",60:"010011",61:"110011",62:"001100",63:"010101",64:"101010"};return t[e]?t[e].split(""):["0","0","0","0","0","0"]}findHexagramByStructure(e){return{111111:1,"000000":2,"010001":3,100010:4,"010111":5,111010:6,"000010":7,"010000":8,110111:9,111011:10,"000111":11,111e3:12,111101:13,101111:14,"000100":15,"001000":16,"011001":17,100110:18,"000011":19,11e4:20,101001:21,100101:22,1e5:23,"000001":24,111001:25,100111:26,100001:27,"011110":28,"010010":29,101101:30,"011100":31,"001110":32,111100:33,"001111":34,101e3:35,"000101":36,110101:37,101011:38,"010100":39,"001010":40,100011:41,110001:42,"011111":43,111110:44,"011000":45,"000110":46,"011010":47,"010110":48,"011101":49,101110:50,"001001":51,100100:52,110100:53,"001011":54,"001101":55,101100:56,110110:57,"011011":58,110010:59,"010011":60,110011:61,"001100":62,"010101":63,101010:64}[e]||1}getHexagramYaoData(e,t){return this.h384db?this.h384db.getHexagramYaoData(e,t):(console.error("❌ Database not connected"),null)}generateThreeStageChoices(e){const t=[];let o=e;for(let i=1;i<=3;i++){const e={stage:i,current:o,theme:this.extractTheme(o),choices:[{id:"follow",label:"テーマに従う",description:`「${o["キーワード"].join("、")}」を受け入れて行動する`,next:this.calculateChange(o,!0),compatibility:this.calculateCompatibility(o,!0)},{id:"reject",label:"テーマに従わない",description:`「${o["キーワード"].join("、")}」とは異なる道を選ぶ`,next:this.calculateChange(o,!1),compatibility:this.calculateCompatibility(o,!1)}]};t.push(e),o=e.choices[0].next}return t}extractTheme(e){return{keywords:e["キーワード"],interpretation:e["現代解釈の要約"],stance:e["S5_主体性推奨スタンス"],action:this.getRecommendedAction(e)}}getRecommendedAction(e){const t=e["S5_主体性推奨スタンス"],o=e["キーワード"];return"能動"===t?`積極的に${o[0]}を実行する`:"受動"===t?`慎重に${o[0]}の時期を待つ`:`状況を見極めながら${o[0]}を意識する`}calculateCompatibility(e,t){const o=e["S7_総合評価スコア"],i=Math.abs(e["S4_リスク"]);return t?Math.round(.8*o+.2*(100-i)):Math.round(.6*(100-o)+.4*i)}generate8Scenarios(e){const t=[];return[["follow","follow","follow"],["follow","follow","reject"],["follow","reject","follow"],["follow","reject","reject"],["reject","follow","follow"],["reject","follow","reject"],["reject","reject","follow"],["reject","reject","reject"]].forEach((o,i)=>{let n=e[0].current;const a=[];o.forEach((t,o)=>{const i=e[o],r=i.choices.find(e=>e.id===t);a.push({stage:o+1,hexagram:n,choice:t,choiceLabel:r.label,theme:i.theme}),n=r.next}),t.push({id:i+1,path:o,pathDetails:a,finalHexagram:n,title:this.generateScenarioTitle(o),description:this.generateScenarioDescription(a),probability:this.calculateScenarioProbability(a),recommendation:this.generateRecommendation(a)})}),t}generateScenarioTitle(e){return{"follow,follow,follow":"完全受容の道","follow,follow,reject":"最終転換の道","follow,reject,follow":"中間転換の道","follow,reject,reject":"後半革新の道","reject,follow,follow":"初期革新の道","reject,follow,reject":"両端革新の道","reject,reject,follow":"最終受容の道","reject,reject,reject":"完全革新の道"}[e.join(",")]||"未定義の道"}generateScenarioDescription(e){let t="";return e.forEach((e,o)=>{const i="follow"===e.choice?"受け入れ":"拒否し";t+=`第${o+1}段階で「${e.theme.keywords[0]}」を${i}、`}),t+="新たな道を切り開く。",t}calculateScenarioProbability(e){let t=0;return e.forEach(e=>{const o=e.hexagram,i="follow"===e.choice,n=this.calculateCompatibility(o,i);t+=n}),Math.round(t/e.length)}generateRecommendation(e){const t=e.filter(e=>"follow"===e.choice).length;return 3===t?"易経の教えに完全に従い、自然の流れに身を任せることで最良の結果を得られるでしょう。":0===t?"既存の枠組みにとらわれず、独自の道を切り開くことで新たな可能性が開けるでしょう。":"バランスを保ちながら、状況に応じて柔軟に対応することが成功への鍵となるでしょう。"}}"undefined"!=typeof window&&(window.IChingChoiceLogic=IChingChoiceLogic,window.iChingChoice=new IChingChoiceLogic,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.iChingChoice.initialize()}):window.iChingChoice.initialize()),console.log("✅ IChingChoiceLogic loaded")}("undefined"!=typeof window&&window);