!function(e){"use strict";class TripleOSInteractionAnalyzer{constructor(){try{this.version="1.2",console.log("🔮 TripleOSInteractionAnalyzer v1.2 (refactored) initialized"),this.expressionGenerator="undefined"!=typeof ExpressionGenerator?new ExpressionGenerator:null,this.keywordAnalyzer="undefined"!=typeof KeywordAnalyzer?new KeywordAnalyzer:null,this._synergyCache=new Map,this._interactionCache=new Map,this._strengthsCache=new Map,this._risksCache=new Map,this._keywordCombinationCache=new Map,this._hexagramCharCache=new Map,this._MAX_CACHE_SIZE=200,this.interactionPatterns=this.initializeInteractionPatterns(),this.hexagramCharacteristics=this.loadHexagramCharacteristics()}catch(e){console.error("❌ TripleOSInteractionAnalyzer initialization error:",e),this.version="1.1",this.interactionPatterns={},this.hexagramCharacteristics={},this._initializeFallbackData()}}analyze(e,n,t){try{if(!this._validateOSInput(e)||!this._validateOSInput(n)||!this._validateOSInput(t))throw new Error("Invalid OS input parameters");return{version:this.version,engine_os:{id:e.hexagramId||1,name:e.name||"乾為天",score:e.score||.5},interface_os:{id:n.hexagramId||2,name:n.name||"坤為地",score:n.score||.5},safe_mode_os:{id:t.hexagramId||29,name:t.name||"坎為水",score:t.score||.5},synergy:this.calculateSynergy(e,n,t),interactions:this.generateInteractions(e,n,t),strengths:this.identifyStrengths(e,n,t),risks:this.identifyRisks(e,n,t),created_at:(new Date).toISOString()}}catch(r){return console.error("❌ Analysis error:",r),this._getDefaultAnalysisResult(e,n,t)}}calculateSynergy(e,n,t){try{const r=`synergy_${e.hexagramId}_${n.hexagramId}_${t.hexagramId}`;if(this._synergyCache.has(r))return this._synergyCache.get(r);const s=[[0,0,0],[0,0,0],[0,0,0]];return s[0][1]=s[1][0]=this.calculatePairSynergy(e,n,"engine-interface"),s[0][2]=s[2][0]=this.calculatePairSynergy(e,t,"engine-safe"),s[1][2]=s[2][1]=this.calculatePairSynergy(n,t,"interface-safe"),this._manageCacheSize(this._synergyCache),this._synergyCache.set(r,s),s}catch(s){return console.error("❌ Synergy calculation error:",s),[[0,0,0],[0,0,0],[0,0,0]]}const r=this.generateSynergyNotes(e,n,t,matrix);return{matrix:matrix,notes:r}}calculatePairSynergy(e,n,t="unknown"){try{const r=e.hexagramId||1,s=n.hexagramId||1,a=this.getHexagramCharacteristics(r),i=this.getHexagramCharacteristics(s);if(r===s)return this.analyzeSameHexagram(a,t);const o=this.calculateKeywordSynergy(a.keywords,i.keywords);if(o>=.7)return o;const c=this.calculateEnergyCompatibility(a.energy,i.energy);if(c>=.6)return c;if("engine-interface"===t){if(this.haveSimilarDirection(a,i))return.5}else if("engine-safe"===t){if(this.isHealthyComplement(a,i))return.4;if(this.isStressfulComplement(a,i))return-.3}else if("interface-safe"===t&&this.isWellBalanced(a,i))return.3;if(this.isMutualHexagram(r,s))return this.isStressfulComplement(a,i)?-.2:.4;if(1===Math.abs(r-s))return.3;if(this.isOppositeHexagram(r,s))return-.1;if(this.areEnergyConflicting(a.energy,i.energy))return-.2;const h=this.analyzeStrengthWeaknessInteraction(a,i);return 0!==h?h:0}catch(r){return console.error("❌ Pair synergy calculation error:",r),0}}generateInteractions(e,n,t){try{const r=`interactions_${e.hexagramId}_${n.hexagramId}_${t.hexagramId}`;if(this._interactionCache?.has(r))return this._interactionCache.get(r);const s={pair_insights:[this.analyzePair("engine-interface",e,n),this.analyzePair("engine-safe",e,t),this.analyzePair("interface-safe",n,t)],affordances:this.generateAffordances(e,n,t),inner_conflicts:this.identifyInnerConflicts(e,n,t),integration_prompts:this.generateIntegrationPrompts(e,n,t)};return this._interactionCache&&(this._manageCacheSize(this._interactionCache),this._interactionCache.set(r,s)),s}catch(r){return console.error("❌ Interactions generation error:",r),{pair_insights:[],affordances:[],inner_conflicts:[],integration_prompts:[]}}}analyzePair(e,n,t){const r=this.calculatePairSynergy(n,t,e);let s="HARMONY";s=r>=.6?"SYNERGY":r>=.2?"HARMONY":r>=-.2?"TENSION":"CONFLICT";const a=this.generatePairSummary(n,t,s,e);return{pair:e,category:s,score:Math.abs(r),synergy:r,summary:a}}generateAffordances(e,n,t){const r=this.getHexagramCharacteristics(e.hexagramId),s=this.getHexagramCharacteristics(n.hexagramId),a=this.getHexagramCharacteristics(t.hexagramId);return{engine:{thrives_with:[`${s.keywords[0]||s.strength}が活きる環境での${r.strength}の発揮`,`${a.keywords[1]||a.keywords[0]||a.strength}による${r.keywords[0]||r.strength}の洗練`,`${r.energy}が最大化される自由と規律のバランス`],struggles_with:[`${r.weakness}が露呈する${s.weakness}的状況`,`${a.energy}による${r.keywords[1]||r.keywords[0]||r.strength}の抑制`,`${r.keywords[2]||r.keywords[1]||r.keywords[0]||r.strength}を阻害する過度な${a.keywords[0]||a.strength}`]},interface:{thrives_with:[`${s.strength}を活かした${r.keywords[0]||r.strength}と${a.keywords[0]||a.strength}の調整`,`${s.keywords[1]||s.keywords[0]||s.strength}による組織全体の${s.keywords[2]||s.keywords[1]||s.keywords[0]||s.strength}促進`,`${s.energy}が評価される協調的環境`],struggles_with:[`${s.weakness}により${r.strength}が発揮できない場面`,`${s.keywords[0]||s.strength}と${a.keywords[1]||a.keywords[0]||a.strength}の矛盾による混乱`,`${r.energy}との不協和による${s.keywords[2]||s.keywords[1]||s.keywords[0]||s.strength}の低下`]},safe:{thrives_with:[`${a.strength}による${r.keywords[2]||r.keywords[1]||r.keywords[0]||r.strength}の安定化`,`${a.keywords[0]||a.strength}が必要な長期的${a.keywords[1]||a.keywords[0]||a.strength}の確保`,`${a.energy}による${r.weakness}の抑制効果`],struggles_with:[`${a.weakness}による${r.keywords[0]||r.strength}の停滞`,`${s.energy}との不調和による${a.keywords[2]||a.keywords[1]||a.keywords[0]||a.strength}の混乱`,`${a.keywords[1]||a.keywords[0]||a.strength}への固執による機会損失`]}}}identifyInnerConflicts(e,n,t){const r=this.getHexagramCharacteristics(e.hexagramId),s=this.getHexagramCharacteristics(n.hexagramId),a=this.getHexagramCharacteristics(t.hexagramId),i=[];i.push(`${r.name}の「${r.keywords[0]||r.strength}」と${a.name}の「${a.keywords[0]||a.strength}」の間で生じる${this.generateConflictTheme(r,a)}`),i.push(`${s.name}の「${s.strength}」が、${r.keywords[1]||r.keywords[0]||r.strength}と${a.keywords[1]||a.keywords[0]||a.strength}の両立を困難にする葛藤`),i.push(`${r.energy}、${s.energy}、${a.energy}の３つのエネルギーパターンの不協和`),i.push("成果・調和・安全の価値観が衝突する場面での優先順位付けの葛藤");const o=this.identifyAdditionalConflicts(e,n,t);return i.push(...o),i}identifyAdditionalConflicts(e,n,t){const r=[];return Math.abs(e.score-n.score)>.3&&r.push("内的動機と外的表現のバランスに関する継続的な調整の葛藤"),r}generateIntegrationPrompts(e,n,t){const r=this.getHexagramCharacteristics(e.hexagramId),s=this.getHexagramCharacteristics(n.hexagramId),a=this.getHexagramCharacteristics(t.hexagramId),i=[];i.push(`あなたの${r.name}が持つ「${r.strength}」を最大化するには、どんな${r.keywords[2]||r.keywords[1]||r.keywords[0]||r.strength}的環境が必要ですか？`),i.push(`${s.name}の「${s.keywords[0]||s.strength}」と${r.name}の「${r.keywords[0]||r.strength}」をシナジーさせる具体的方法は？`),i.push(`${a.name}の「${a.strength}」を活かしつつ、${a.weakness}を克服するにはどんな工夫ができますか？`),i.push("3つのOSそれぞれが最も活きる「時間帯」「場所」「相手」を明確にできますか？");const o=this.suggestGrowthDirection(e,n,t);return i.push(o),i}identifyStrengths(e,n,t){const r=[];r.push(`${e.name}による明確な推進力と方向性`),r.push(`${n.name}による柔軟な対人調整能力`),r.push(`${t.name}によるリスク管理と品質保証`);this.calculateTotalSynergy(e,n,t)>.6&&r.push("3OS間の高い相乗効果による統合的判断力");const s=this.identifySpecialCombination(e,n,t);return s&&r.push(s),r}identifyRisks(e,n,t){const r=[];r.push(`${e.name}の過度な推進による燃え尽きリスク`),r.push(`${n.name}の調和重視による決断遅延リスク`),r.push(`${t.name}の慎重さによる機会損失リスク`);this.calculateConflictLevel(e,n,t)>.5&&r.push("OS間の葛藤による意思決定の停滞リスク");const s=this.checkImbalance(e,n,t);return s&&r.push(s),r}loadHexagramCharacteristics(){return{1:{name:"乾為天",keywords:["創造力","リーダーシップ","強い推進力","天の力"],strength:"決断力と実行力",weakness:"傲慢になりやすい",energy:"陽的・積極的・上昇志向"},2:{name:"坤為地",keywords:["受容性","包容力","柔軟性","大地の徳"],strength:"調和と協調",weakness:"主体性の欠如",energy:"陰的・受動的・安定志向"},3:{name:"水雷屯",keywords:["始動","困難克服","創業の苦労","潜在力"],strength:"困難を乗り越える力",weakness:"準備不足による混乱",energy:"動的・挑戦的・成長志向"},4:{name:"山水蒙",keywords:["教育","学習","啓発","指導"],strength:"知識の蓄積と伝授",weakness:"経験不足による判断ミス",energy:"学習的・成長的・受容志向"},5:{name:"水天需",keywords:["待機","忍耐","準備","時機到来"],strength:"適切なタイミングを待つ力",weakness:"行動の遅れによる機会損失",energy:"待機的・忍耐的・準備志向"},6:{name:"天水訟",keywords:["争議","対立","法的解決","正義"],strength:"公正な解決を求める力",weakness:"対立の長期化",energy:"対立的・競争的・正義志向"},7:{name:"地水師",keywords:["組織","統率","軍事","規律"],strength:"組織的行動力",weakness:"硬直化による柔軟性の欠如",energy:"統制的・組織的・規律志向"},8:{name:"水地比",keywords:["親和","協調","団結","相互支援"],strength:"協力関係の構築",weakness:"依存関係による自立性の欠如",energy:"協調的・親和的・団結志向"},9:{name:"風天小畜",keywords:["小さな蓄積","準備","柔軟性","調整"],strength:"細かな配慮と調整力",weakness:"小規模すぎる対応",energy:"蓄積的・調整的・柔軟志向"},10:{name:"天沢履",keywords:["礼儀","慎重","品格","正道"],strength:"品格のある行動",weakness:"過度の慎重さによる停滞",energy:"品格的・慎重的・正道志向"},11:{name:"地天泰",keywords:["調和","交流","平和","繁栄"],strength:"上下の円滑な交流",weakness:"現状への慢心",energy:"調和的・交流的・統合志向"},12:{name:"天地否",keywords:["閉塞","停滞","断絶","変革の必要"],strength:"現状打破の力",weakness:"コミュニケーション不全",energy:"分離的・内向的・変革志向"},13:{name:"天火同人",keywords:["協力","同志","公明正大","団結"],strength:"公正な協力関係の構築",weakness:"内輪意識による排他性",energy:"協力的・公正的・団結志向"},14:{name:"火天大有",keywords:["豊かさ","成功","繁栄","統合"],strength:"豊かな資源の効果的活用",weakness:"成功による慢心",energy:"豊饒的・成功的・統合志向"},15:{name:"地山謙",keywords:["謙遜","低姿勢","美徳","尊敬"],strength:"謙虚さによる信頼獲得",weakness:"自己主張の不足",energy:"謙遜的・受容的・美徳志向"},16:{name:"雷地豫",keywords:["喜び","活気","準備","楽観"],strength:"前向きな活力",weakness:"油断による準備不足",energy:"活発的・楽観的・準備志向"},17:{name:"沢雷随",keywords:["追随","柔軟性","適応","変化対応"],strength:"変化への柔軟な適応力",weakness:"主体性の欠如",energy:"適応的・柔軟的・追随志向"},18:{name:"山風蠱",keywords:["腐敗","改革","再生","刷新"],strength:"問題解決と改革力",weakness:"改革の困難さ",energy:"改革的・再生的・刷新志向"},19:{name:"地沢臨",keywords:["接近","指導","温情","包容"],strength:"温かい指導力",weakness:"甘さによる甘えの誘発",energy:"指導的・温情的・包容志向"},20:{name:"風地観",keywords:["観察","洞察","理解","客観性"],strength:"深い洞察力",weakness:"行動力の不足",energy:"観察的・洞察的・客観志向"},21:{name:"火雷噬嗑",keywords:["決断","処断","除去","解決"],strength:"問題の根本解決力",weakness:"強硬すぎる処断",energy:"決断的・処断的・解決志向"},22:{name:"山火賁",keywords:["装飾","美化","文化","優雅"],strength:"美的センスと表現力",weakness:"外見重視による本質軽視",energy:"美的・文化的・装飾志向"},23:{name:"山地剝",keywords:["剥落","衰退","侵食","忍耐"],strength:"困難な状況での忍耐力",weakness:"衰退への無力感",energy:"忍耐的・受動的・防御志向"},24:{name:"地雷復",keywords:["復活","回復","再生","希望"],strength:"復活と再生の力",weakness:"回復の遅さ",energy:"復活的・再生的・希望志向"},25:{name:"天雷无妄",keywords:["純真","自然","無邪気","天真"],strength:"純粋で自然な行動力",weakness:"世間知らずによる失敗",energy:"純真的・自然的・無邪気志向"},26:{name:"山天大畜",keywords:["蓄積","抑制","準備","力の貯蓄"],strength:"大きな力の蓄積能力",weakness:"行動の遅れ",energy:"蓄積的・抑制的・準備志向"},27:{name:"山雷頤",keywords:["養育","栄養","自制","節制"],strength:"適切な養育と自制力",weakness:"過度の制限による停滞",energy:"養育的・節制的・自制志向"},28:{name:"沢風大過",keywords:["過度","危険","重荷","極限"],strength:"極限状況での対応力",weakness:"過度による破綻リスク",energy:"極限的・危険的・過度志向"},29:{name:"坎為水",keywords:["深い洞察","危機管理","慎重さ","内省"],strength:"リスク察知能力",weakness:"過度の悲観",energy:"流動的・適応的・深層志向"},30:{name:"離為火",keywords:["明晰性","情熱","照明","文明"],strength:"物事を明るく照らす",weakness:"燃え尽きやすい",energy:"発散的・照明的・外向志向"},31:{name:"沢山咸",keywords:["感応","共鳴","相互影響","感受性"],strength:"他者との深い共感",weakness:"過度の感情移入",energy:"共鳴的・感応的・相互志向"},32:{name:"雷風恒",keywords:["持続","継続","不変","永続"],strength:"持続的な努力",weakness:"変化への対応不足",energy:"持続的・継続的・恒常志向"},33:{name:"天山遯",keywords:["退避","戦略的撤退","保身","時機待ち"],strength:"適切な退き際の判断",weakness:"消極的すぎる姿勢",energy:"退避的・保守的・待機志向"},34:{name:"雷天大壮",keywords:["強大","威力","勇猛","積極性"],strength:"強力な行動力",weakness:"勇み足による失敗",energy:"強力的・積極的・勇猛志向"},35:{name:"火地晋",keywords:["進歩","昇進","向上","発展"],strength:"着実な進歩力",weakness:"急ぎすぎによる失敗",energy:"進歩的・向上的・発展志向"},36:{name:"地火明夷",keywords:["困難","暗黒","忍耐","潜伏"],strength:"困難な状況での忍耐力",weakness:"消極的な姿勢",energy:"潜伏的・忍耐的・内向志向"},37:{name:"風火家人",keywords:["家族","調和","秩序","親和"],strength:"家庭的な調和力",weakness:"内向きすぎる視点",energy:"家庭的・調和的・親和志向"},38:{name:"火沢睽",keywords:["対立","反目","矛盾","不和"],strength:"対立を通じた成長",weakness:"関係性の悪化",energy:"対立的・矛盾的・分離志向"},39:{name:"水山蹇",keywords:["困難","障害","停滞","忍耐"],strength:"困難に耐える力",weakness:"前進の困難",energy:"停滞的・忍耐的・内省志向"},40:{name:"雷水解",keywords:["解決","解放","緩和","開放"],strength:"問題解決力",weakness:"解決後の気の緩み",energy:"解決的・開放的・緩和志向"},41:{name:"山沢損",keywords:["謙遜","削減","本質への集中","無駄の排除"],strength:"本質を見極める力",weakness:"自己犠牲の過多",energy:"削減的・本質的・内向志向"},42:{name:"風雷益",keywords:["利益","増進","成長","発展"],strength:"相互利益の創造",weakness:"利益追求の偏重",energy:"増進的・成長的・発展志向"},43:{name:"沢天夬",keywords:["決断","排除","除去","断絶"],strength:"明確な決断力",weakness:"性急すぎる判断",energy:"決断的・排除的・断絶志向"},44:{name:"天風姤",keywords:["遭遇","邂逅","偶然","出会い"],strength:"新しい出会いの力",weakness:"予期しない困難",energy:"遭遇的・偶然的・出会い志向"},45:{name:"沢地萃",keywords:["集合","結集","統合","団結"],strength:"集団統合力",weakness:"統率の困難",energy:"集合的・統合的・団結志向"},46:{name:"地風升",keywords:["上昇","成長","発達","向上"],strength:"着実な成長力",weakness:"成長の鈍化",energy:"上昇的・成長的・向上志向"},47:{name:"沢水困",keywords:["困窮","窮地","制約","限界"],strength:"困窮での創意工夫",weakness:"資源不足による制約",energy:"困窮的・制約的・限界志向"},48:{name:"水風井",keywords:["源泉","供給","安定","恒常性"],strength:"安定した供給力",weakness:"変化への対応不足",energy:"源泉的・供給的・安定志向"},49:{name:"沢火革",keywords:["革命","変革","改革","刷新"],strength:"革新的変革力",weakness:"変革による混乱",energy:"革新的・変革的・刷新志向"},50:{name:"火風鼎",keywords:["確立","完成","安定","統治"],strength:"安定した統治力",weakness:"保守的すぎる姿勢",energy:"確立的・完成的・統治志向"},51:{name:"震為雷",keywords:["衝撃","活動","動揺","刺激"],strength:"強力な活動力",weakness:"衝動的な行動",energy:"衝撃的・活動的・刺激志向"},52:{name:"艮為山",keywords:["静止","瞑想","不動","安定"],strength:"揺るぎない安定性",weakness:"変化への抵抗",energy:"静的・不動的・瞑想志向"},53:{name:"風山漸",keywords:["漸進","段階的","着実","穏健"],strength:"着実な段階的進歩",weakness:"進歩の遅さ",energy:"漸進的・段階的・穏健志向"},54:{name:"雷沢帰妹",keywords:["結合","婚姻","統合","調和"],strength:"異なるものの統合力",weakness:"統合の困難",energy:"結合的・統合的・調和志向"},55:{name:"雷火豊",keywords:["豊富","充実","栄光","絶頂"],strength:"豊かな充実感",weakness:"絶頂期の驕り",energy:"豊富的・充実的・栄光志向"},56:{name:"火山旅",keywords:["旅行","移動","変化","探求"],strength:"環境変化への適応力",weakness:"不安定な立場",energy:"移動的・変化的・探求志向"},57:{name:"巽為風",keywords:["柔軟","浸透","順応","影響"],strength:"柔軟な浸透力",weakness:"意志の弱さ",energy:"柔軟的・浸透的・順応志向"},58:{name:"兌為沢",keywords:["喜び","楽しみ","親しみ","交流"],strength:"人との親和力",weakness:"軽薄さによる信頼失墜",energy:"喜悦的・親和的・交流志向"},59:{name:"風水渙",keywords:["散開","分散","拡散","解放"],strength:"柔軟な拡散力",weakness:"統制の困難",energy:"散開的・分散的・解放志向"},60:{name:"水沢節",keywords:["節制","調節","適度","制限"],strength:"適切な制御力",weakness:"過度の制約",energy:"節制的・調節的・制限志向"},61:{name:"風沢中孚",keywords:["誠実","信頼","真心","内実"],strength:"深い信頼関係の構築",weakness:"純粋すぎる信頼",energy:"誠実的・信頼的・真心志向"},62:{name:"雷山小過",keywords:["小さな過ち","微調整","謙遜","慎重"],strength:"細かな調整力",weakness:"小心すぎる姿勢",energy:"調整的・謙遜的・慎重志向"},63:{name:"水火既済",keywords:["完成","達成","調和","完璧"],strength:"物事の完成力",weakness:"次への移行困難",energy:"完成的・調和的・安定志向"},64:{name:"火水未済",keywords:["未完","継続","可能性","永遠の挑戦"],strength:"無限の可能性",weakness:"完成への不安",energy:"継続的・挑戦的・未来志向"}}}getHexagramCharacteristics(e){try{const n=`hex_${e}`;if(this._hexagramCharCache?.has(n))return this._hexagramCharCache.get(n);const t=this.hexagramCharacteristics[e]||this.hexagramCharacteristics[1];return this._hexagramCharCache&&(this._manageCacheSize(this._hexagramCharCache),this._hexagramCharCache.set(n,t)),t}catch(n){return console.error("❌ Hexagram characteristics error:",n),this.hexagramCharacteristics[1]||{name:`第${e}卦`,keywords:["変化","調整","発展"],strength:"適応力",weakness:"不安定性",energy:"流動的"}}}initializeInteractionPatterns(){return new Map([["1-2",{type:"complementary",strength:.9,description:"天地の完全補完"}],["3-4",{type:"developmental",strength:.7,description:"始動と成長の連携"}],["29-30",{type:"transformative",strength:.6,description:"困難と光明の変換"}]])}isMutualHexagram(e,n){return e+n===65}isOppositeHexagram(e,n){return 32===Math.abs(e-n)}calculateSpeedConflict(e,n){const t=e.score||.5,r=1-(n.score||.5);return Math.abs(t-r)}calculateDecisionConflict(e){return e.score||.5}hasValueConflict(e,n,t){const r=[e.score,n.score,t.score];return this.calculateVariance(r)>.2}calculateVariance(e){const n=e.reduce((e,n)=>e+n,0)/e.length;return e.map(e=>Math.pow(e-n,2)).reduce((e,n)=>e+n,0)/e.length}calculateTotalSynergy(e,n,t){return(this.calculatePairSynergy(e,n,"engine-interface")+this.calculatePairSynergy(e,t,"engine-safe")+this.calculatePairSynergy(n,t,"interface-safe"))/3}calculateConflictLevel(e,n,t){const r=this.calculateTotalSynergy(e,n,t);return Math.max(0,-r)}checkImbalance(e,n,t){const r=[e.score,n.score,t.score],s=Math.max(...r),a=Math.min(...r);if(s-a>.5){const r=[e,n,t].find(e=>e.score===s),i=[e,n,t].find(e=>e.score===a);return`「${r.name}」の過度な優位と「${i.name}」の抑制によるバランス崩壊リスク`}return null}identifySpecialCombination(e,n,t){return{"1-2-29":"創造と受容に内省を加えた深い洞察力","3-4-5":"始動・成長・待機のリズムを持つ持続的発展力"}[`${e.hexagramId}-${n.hexagramId}-${t.hexagramId}`]||null}generatePairSummary(e,n,t,r="unknown"){const s=this.getHexagramCharacteristics(e.hexagramId),a=this.getHexagramCharacteristics(n.hexagramId);return this.generateDynamicPairDescription(s,a,t,e.hexagramId,n.hexagramId,r)}generateDynamicPairDescription(e,n,t,r,s,a="unknown"){const i=Math.abs(r-s),o=this.isKnownComplementaryPair(r,s),c=this.isKnownOppositePair(r,s),h=1===i,g=r===s;return"SYNERGY"===t?g?"engine-interface"===a?`${e.name}の${e.strength}が実行系と調整系で完璧に連携し、最高のパフォーマンスを発揮`:"engine-safe"===a?`${e.name}の${e.strength}が主軸と安全網の両面で機能し、安定した高いパフォーマンスを実現`:"interface-safe"===a?`${e.name}の${e.strength}が調整役と安全網の両面で機能し、完璧なバランスを保つ`:`${e.name}の${e.strength}が複数の役割で一貫して最高の成果を生む`:o?`${e.name}と${n.name}が綜卦関係により完全な補完を成し、${e.keywords[0]||e.name}と${n.keywords[0]||n.name}が最高の相乗効果を生む`:e.energy.includes("陽")&&n.energy.includes("陰")?`${e.name}の${e.keywords[0]||e.strength}が${n.name}の${n.keywords[0]||n.strength}を活性化し、陰陽の理想的バランスを実現`:`${e.name}の${e.strength}と${n.name}の${n.strength}が共鳴し、相互に力を増幅させる`:"HARMONY"===t?g?e.keywords.some(e=>["調和","協調","安定","平和","受容性","包容力","柔軟性"].includes(e))?`同じ${e.name}同士が、共通の${e.keywords.find(e=>["調和","協調","安定","平和","受容性","包容力","柔軟性"].includes(e))}により安定した基盤を提供`:`同じ${e.name}同士が、共通の${e.keywords[0]}により穏やかに共存し、安定性を維持`:h?`隣接する${e.name}と${n.name}が、${e.keywords[2]}から${n.keywords[2]}への自然な流れを作る`:this.haveSimilarEnergy(e.energy,n.energy)?`${e.name}と${n.name}が共通の${this.extractCommonEnergyPattern(e.energy,n.energy)}により穏やかに共存`:`${e.name}の${e.keywords[1]}と${n.name}の${n.keywords[1]}が互いを尊重し合う調和的関係`:"TENSION"===t?g?"engine-safe"===a?e.keywords.some(e=>["調和","協調","安定","平和","受容性","包容力","柔軟性"].includes(e))?`同じ${e.name}同士が、安定・調和の役割において適度な相互補完を図る`:`同じ${e.name}同士が、${e.strength}の発揮を巡って適度な緊張を持ち、多様性を促進`:`同じ${e.name}同士が、${e.strength}の発揮を巡って競合し、創造的な緊張を生む`:c?`錯卦関係の${e.name}と${n.name}が、${e.keywords[0]||e.strength}と${n.keywords[0]||n.strength}の方向性の違いで緊張を生む`:this.areEnergyConflicting(e.energy,n.energy)?`${e.name}の${e.energy}と${n.name}の${n.energy}が根本的に異なり、調整が必要な緊張関係`:this.generateHumanRelatableDescription(e,n,a):g?"engine-safe"===a?`${e.name}の${e.weakness||"リスク"}が主軸と安全網の両方で発現し、深刻な脆弱性を生む`:"engine-interface"===a?`${e.name}の${e.weakness||"リスク"}が実行系と調整系の両方で発現し、システム全体の障害を引き起こす`:"interface-safe"===a?`${e.name}の${e.weakness||"リスク"}が調整役と安全網の両方で発現し、回復困難な混乱を生む`:`${e.name}の${e.weakness||"リスク"}が複数の役割で同時発現し、破壊的な相乗効果を生む`:e.weakness===n.weakness?`${e.name}と${n.name}が共通の弱点「${e.weakness}」により相互に問題を増幅させる`:this.areDirectlyOpposing(e,n)?`${e.name}の${e.keywords[0]||e.name}と${n.name}の${n.keywords[0]||n.name}が正面から衝突し、解決困難な対立を生む`:`${e.name}の${e.weakness}と${n.name}の${n.weakness}が相互に悪影響を及ぼす破壊的関係`}isKnownComplementaryPair(e,n){const t=[[1,2],[3,50],[11,12],[13,14],[31,32],[41,42],[43,44],[53,54],[61,62],[63,64]];for(let[r,s]of t)if(e===r&&n===s||e===s&&n===r)return!0;return!1}isKnownOppositePair(e,n){const t=[[1,2],[29,30],[51,57],[52,58]];for(let[r,s]of t)if(e===r&&n===s||e===s&&n===r)return!0;return!1}haveSimilarEnergy(e,n){const t=e.split("・"),r=n.split("・");let s=0;return t.forEach(e=>{r.forEach(n=>{(e.includes(n.substring(0,2))||n.includes(e.substring(0,2)))&&s++})}),s>=2}extractCommonEnergyPattern(e,n){const t=e.split("・"),r=n.split("・");for(let s of t)for(let e of r)if(s.includes(e.substring(0,2))||e.includes(s.substring(0,2)))return s.substring(0,2)+"的志向";return"志向"}areEnergyConflicting(e,n){const t=[["積極","受動"],["陽的","陰的"],["外向","内向"],["上昇","下降"],["発散","収束"],["動的","静的"]];for(let[r,s]of t)if(e.includes(r)&&n.includes(s)||e.includes(s)&&n.includes(r))return!0;return!1}generateHumanRelatableDescription(e,n,t){e.keywords[0]||e.strength,n.keywords[0]||n.strength;const r=this.analyzeKeywordCombination(e,n);switch(t){case"engine-interface":return this.generateEngineInterfaceTension(e,n,r);case"engine-safe":return this.generateEngineSafeTension(e,n,r);case"interface-safe":return this.generateInterfaceSafeTension(e,n,r);default:return this.generateGeneralTension(e,n,r)}}analyzeKeywordCombination(e,n){try{if(this.keywordAnalyzer)return this.keywordAnalyzer.analyzeKeywordCombination(e,n);const t=`kwc_${e.name}_${n.name}`;if(this._keywordCombinationCache?.has(t))return this._keywordCombinationCache.get(t);const r=e.keywords||[],s=n.keywords||[],a={};return[[["喜び","楽しみ","楽観","希望","情熱","充実","優雅","栄光","刺激"],["困難","暗黒","動揺","不和","反目","矛盾","抑制","窮地","危険","極限"],"emotionConflict"],[["信頼","出会い","包容","婚姻","家族","温情","結合","親しみ","共鳴","相互影響","交流","邂逅","遭遇","追随","公明正大","協力","協調","受容性","包容力","同志","団結","結集","集合","親和","相互支援","調和"],["対立","偶然","争議","断絶","分離","疎外","誤解"],"relationshipConflict"],[["供給","利益","豊かさ","繁栄","豊富","増進","成功","力の貯蓄","源泉"],["困窮","減少","削減","制約","限界","我慢","制限"],"materialConflict"],[["啓発","学習","指導","探求","教育","観察","理解"],["洞察","客観性","危機管理","慎重さ","本質への集中","感応","深い洞察","内省"],"learningConflict"],[["品格","尊敬","文化","文明","礼儀","美化","美徳","装飾","秩序","正道"],["自然","純真","無邪気","天真","真心","内実","謙遜"],"culturalConflict"],[["回復","栄養","養育","復活","潜在力","活気","活動","積極性","威力","強大","勇猛"],["自制","潜伏","静止","瞑想","節制","衰退","剥落","侵食"],"vitalityConflict"],[["改革","再生","刷新","革命","変革","転換","変化","新秩序","革新","変化対応","変革の必要","解放","開放"],["蓄積","貯蔵","持続","継続","不変","永続","安定","完成","達成","完璧","恒常性","不動"],"changeConflict"],[["始動","決断","処断","衝撃","覚醒","突破"],["待機","忍耐","準備","慎重","漸進","段階的","着実","穏健","調節","微調整"],"actionConflict"],[["組織","統治","統率","規律","軍事","確立","法的解決","正義","統合"],["腐敗","閉塞","停滞","障害","過度","重荷"],"systemicConflict"],[["明晰性","照明","進歩","昇進","向上","発展","上昇","成長","発達","散開","分散","拡散","旅行","移動","接近","浸透"],["退避","戦略的撤退","保身","低姿勢"],"spatialConflict"],[["創造力","リーダーシップ","強い推進力","自由","影響","創業の苦労","困難克服","排除","除去","解決"],["柔軟性","適応","順応","柔軟","調整","緩和","無駄の排除"],"capabilityConflict"],[["大地の徳","天の力","時機到来","時機待ち","可能性","平和"],["小さな蓄積","小さな過ち","未完","永遠の挑戦","適度","感受性","絶頂"],"temporalConflict"]].forEach(([e,n,t])=>{const i=r.some(n=>e.includes(n)),o=r.some(e=>n.includes(e)),c=s.some(n=>e.includes(n)),h=s.some(e=>n.includes(e));(i&&h||o&&c)&&(a[t]=!0)}),{speedConflict:a.actionConflict||!1,valueConflict:a.relationshipConflict||a.capabilityConflict||!1,timeConflict:a.changeConflict||a.temporalConflict||!1,directionConflict:a.spatialConflict||!1,emotionConflict:a.emotionConflict||!1,relationshipConflict:a.relationshipConflict||!1,materialConflict:a.materialConflict||!1,learningConflict:a.learningConflict||!1,culturalConflict:a.culturalConflict||!1,vitalityConflict:a.vitalityConflict||!1,changeConflict:a.changeConflict||!1,actionConflict:a.actionConflict||!1,systemicConflict:a.systemicConflict||!1,spatialConflict:a.spatialConflict||!1,capabilityConflict:a.capabilityConflict||!1,temporalConflict:a.temporalConflict||!1}}catch(t){return console.error("❌ Keyword combination analysis error:",t),{emotionConflict:!1,relationshipConflict:!1,materialConflict:!1,learningConflict:!1,culturalConflict:!1,vitalityConflict:!1,changeConflict:!1,actionConflict:!1,systemicConflict:!1,spatialConflict:!1,capabilityConflict:!1,temporalConflict:!1}}}analyzeHarmoniousRelations(e,n,t=null){const r=e.hexagramId||this.getHexagramIdByName(e.name),s=n.hexagramId||this.getHexagramIdByName(n.name),a=t?t.hexagramId||this.getHexagramIdByName(t.name):null,i=e.keywords||[],o=n.keywords||[],c=t&&t.keywords||[],h=this.detectIChingRelations(r,s,a),g=this.detectSubtleDifferences(i,o,c);return{ichingRelations:h,subtleDifferences:g,hasSpecialMeaning:h.length>0||g.length>0}}detectIChingRelations(e,n,t){const r=[],s=Math.abs(e-n),a=(t&&Math.abs(n-t),t?Math.abs(e-t):0);1===s&&r.push({type:"adjacent",pair:[e,n],meaning:"隣接する両卦が自然な流れを作る",strength:"high"}),t&&a<=3&&r.push({type:"proximate",pair:[e,t],meaning:"近接した相互作用により微妙な調和を成す",strength:"medium"});const i=65-e;i===n&&r.push({type:"zong",pair:[e,n],meaning:"綜卦関係により完全な補完を成す",strength:"very_high"}),t&&i===t&&r.push({type:"zong",pair:[e,t],meaning:"綜卦関係により根本的な相互補完を実現",strength:"very_high"});const o=[1,2,63,64],c=[e,n,t].filter(e=>e&&o.includes(e));return c.includes(64)&&r.push({type:"terminal",hexagram:64,meaning:"未済の永遠の可能性が組み合わせに深みを与える",strength:"special"}),c.includes(1)&&r.push({type:"origin",hexagram:1,meaning:"乾為天の創造的根源力が最高の相乗効果を生む",strength:"special"}),r}detectSubtleDifferences(e,n,t=[]){const r=[],s=this.categorizeEmotionalTexture(e,n,t);s.size>1&&r.push({type:"emotional_texture",categories:Array.from(s),meaning:"異なる感情の質感が豊かな心理的調和を作る"});const a=this.categorizeCognitiveDirection(e,n,t);a.size>1&&r.push({type:"cognitive_direction",categories:Array.from(a),meaning:"内向と外向の認知アプローチが相互補完する"});const i=this.categorizeCompletionPhase(e,n,t);return i.size>1&&r.push({type:"completion_phase",categories:Array.from(i),meaning:"異なる完成段階が発展的な流れを形成する"}),r}categorizeEmotionalTexture(e,n,t){const r=[...e,...n,...t],s=new Set,a=["喜び","楽しみ","楽観","希望","活気"],i=["充実","栄光","情熱","豊満","成功"],o=["刺激","優雅","感応","共鳴","相互影響"];return r.some(e=>a.includes(e))&&s.add("brightJoyful"),r.some(e=>i.includes(e))&&s.add("deepFulfilled"),r.some(e=>o.includes(e))&&s.add("complexStimulated"),s}categorizeCognitiveDirection(e,n,t){const r=[...e,...n,...t],s=new Set,a=["観察","理解","教育","指導","探求","啓発"],i=["洞察","内省","瞑想","本質への集中","深い洞察"],o=["客観性","慎重さ","危機管理","調節","適度"];return r.some(e=>a.includes(e))&&s.add("outward"),r.some(e=>i.includes(e))&&s.add("inward"),r.some(e=>o.includes(e))&&s.add("balanced"),s}categorizeCompletionPhase(e,n,t){const r=[...e,...n,...t],s=new Set,a=["始動","創業の苦労","可能性","潜在力","出会い"],i=["未完","継続","段階的","漸進","変化対応","適応"],o=["完成","達成","完璧","永続","不変","確立"];return r.some(e=>a.includes(e))&&s.add("initiating"),r.some(e=>i.includes(e))&&s.add("processing"),r.some(e=>o.includes(e))&&s.add("completing"),s}getHexagramIdByName(e){return{"乾為天":1,"坤為地":2,"水雷屯":3,"山水蒙":4,"水天需":5,"天水訟":6,"地水師":7,"水地比":8,"風天小畜":9,"天沢履":10,"地天泰":11,"天地否":12,"天火同人":13,"火天大有":14,"地山謙":15,"雷地豫":16,"沢雷随":17,"山風蠱":18,"地沢臨":19,"風地観":20,"火雷噬嗑":21,"山火賁":22,"山地剝":23,"地雷復":24,"天雷无妄":25,"山天大畜":26,"山雷頤":27,"沢風大過":28,"坎為水":29,"離為火":30,"沢山咸":31,"雷風恒":32,"天山遯":33,"雷天大壮":34,"火地晋":35,"地火明夷":36,"風火家人":37,"火沢睽":38,"水山蹇":39,"雷水解":40,"山沢損":41,"風雷益":42,"沢天夬":43,"天風姤":44,"沢地萃":45,"地風升":46,"沢水困":47,"水風井":48,"沢火革":49,"火風鼎":50,"震為雷":51,"艮為山":52,"風山漸":53,"雷沢帰妹":54,"雷火豊":55,"火山旅":56,"巽為風":57,"兌為沢":58,"風水渙":59,"水沢節":60,"風沢中孚":61,"雷山小過":62,"水火既済":63,"火水未済":64}[e]||0}convertToFriendlyTerm(e){return{"喜び":"楽しい気持ち","楽しみ":"わくわくする気分","親しみ":"親近感","交流":"コミュニケーション","深い洞察":"物事を深く理解する力","危機管理":"用心深さ","慎重さ":"慎重に判断する姿勢","内省":"自分を見つめる時間","誠実":"正直で真面目な気持ち","信頼":"相手を信じる気持ち","真心":"本当の気持ち","内実":"中身の充実","創造力":"新しいことを生み出す力","リーダーシップ":"みんなを引っ張る力","強い推進力":"前に進む強いエネルギー","天の力":"大きなパワー","受容性":"相手を受け入れる優しさ","包容力":"包み込む温かさ","柔軟性":"変化に合わせる力","大地の徳":"母のような包容力","謙遜":"控えめで礼儀正しい態度","低姿勢":"相手を立てる姿勢","美徳":"良い人格","尊敬":"相手を大切に思う気持ち","家族":"チームワーク","調和":"仲良くやっていく力","秩序":"規律を大切にする心","親和":"親しみやすさ","対立":"意見の食い違い","反目":"ぶつかり合い","矛盾":"考えが合わないこと","不和":"うまくいかない状況","装飾":"美しく飾ること","美化":"きれいにする気持ち","文化":"センスの良さ","優雅":"上品で洗練された感じ","純真":"素直で純粋な心","自然":"ありのままの姿","無邪気":"邪心のない気持ち","天真":"生まれたままの純粋さ","未完":"完成していない状態","継続":"続けていく力","可能性":"未来への期待","永遠の挑戦":"終わりのない成長","遭遇":"思いがけない出会い","邂逅":"偶然の巡り合わせ","偶然":"たまたまの機会","出会い":"新しいつながり","教育":"学び育てる姿勢","学習":"新しいことを覚える力","啓発":"気づきを与える力","指導":"教え導く力","観察":"よく見て理解する力","洞察":"本質を見抜く力","理解":"相手の気持ちを分かる力","客観性":"冷静に判断する力","追随":"流れに合わせる力","適応":"状況に応じて変わる力","変化対応":"変化を受け入れる柔軟さ"}[e]||e}generateFriendlyRelationshipExpression(e,n,t){const r={adjacent:{pattern:"自分の中の{friendly1}と{friendly2}が自然な流れでつながって、内面がスムーズに成長していく",feeling:"まるで川の流れのように無理なく内的変化する"},zong:{pattern:"内なる{friendly1}と{friendly2}は正反対だけど、だからこそ完璧に補い合える心の中の最高の組み合わせ",feeling:"違いが内面の魅力になって、自分の異なる面を活かし合える"},terminal:{pattern:"心の中の{friendly1}と{friendly2}がいつまでも成長し続ける、終わりのない内的可能性を感じさせる",feeling:"常に内面に新鮮さがあって心が飽きることがない"},origin:{pattern:"自分の中の{friendly1}と{friendly2}が根源的なパワーを生み出して、他では得られない特別な内なる力になる",feeling:"すべての始まりとなる強い内的エネルギーを感じる"}};return(r[e]||r.adjacent).pattern.replace("{friendly1}",n).replace("{friendly2}",t)}generateFriendlyDifferenceExpression(e,n,t){const r={cognitive_direction:{pattern:"自分の中の{friendly1}と{friendly2}は考え方が違うけど、その違いが内面の視野を豊かにしてくれる",effect:"一つの視点では見えないことに気づける内的な成長"},emotional_texture:{pattern:"心の中の{friendly1}と{friendly2}は感じ方が違うけど、それが内面に豊かな感情のハーモニーを作る",effect:"より深くて繊細な内的体験ができる"},completion_phase:{pattern:"内なる{friendly1}と{friendly2}は成長のタイミングが違うけど、だから長期的な内面の発展ができる",effect:"段階的に自分自身が成長していける"}};return(r[e]||r.cognitive_direction).pattern.replace("{friendly1}",n).replace("{friendly2}",t)}getOSBunjinCharacteristics(e){try{if(this.expressionGenerator)return this.expressionGenerator.getOSBunjinCharacteristics(e);const n={engine:{bunjinNames:["積極的な一面","推進する自分","挑戦する側面","リーダー気質の部分","創造的な声"],role:"内なる推進力・創造力を担当する側面",voice:"「やってみよう」「進めよう」「作り出そう」という前向きな心の声"},interface:{bunjinNames:["社交的な面","協調する自分","人と繋がる側面","コミュニケーター気質","調和を大切にする声"],role:"内なる社会性・対人関係を担当する側面",voice:"「みんなで協力しよう」「関係を大切にしよう」という社会性を重視する心の声",stressBehavior:"過度な気遣い、他人に合わせすぎ、自分を抑制"},safe:{bunjinNames:["慎重な一面","守る自分","安定志向の側面","誠実な部分","心配する声"],role:"内なる安全性・信頼性を担当する側面",voice:"「慎重にいこう」「安全を確保しよう」という安定志向の心の声",stressBehavior:"過度な心配、行動制限、変化への抵抗、萎縮"}};return n[e]||n.engine}catch(n){return console.error("❌ OS characteristics error:",n),{bunjinNames:["側面"],role:"内なる側面",voice:"心の声"}}}inferOSType(e){const n=e.keywords||[],t=["創造力","リーダーシップ","積極","推進","挑戦","前向き","行動","喜び","楽しみ","衣撃","活動","動揺","強い推進力","明晰性","情熱","照明"],r=["理解","観察","洞察","調和","対話","客観","学習","交流","情報","親しみ","浸透","順応"],s=["安全","慎重","信頼","誠実","安定","保護","継続","責任","謙遜","受容性","包容力","柔軟性","静止","瞑想","不動","深い洞察","危機管理","慎重さ"];let a=0,i=0,o=0;return n.forEach(e=>{t.some(n=>e.includes(n))&&a++,r.some(n=>e.includes(n))&&i++,s.some(n=>e.includes(n))&&o++}),a>=i&&a>=o?"engine":i>=o?"interface":"safe"}generateBunjinHarmoniousExpression(e,n,t){const r=this.getOSBunjinCharacteristics(e),s=this.getOSBunjinCharacteristics(n),a=r.bunjinNames[Math.floor(Math.random()*r.bunjinNames.length)],i=s.bunjinNames[Math.floor(Math.random()*s.bunjinNames.length)],o=this.generateOSPairSpecificExpression(e,n,a,i);if(o)return console.log(`💪 OSペアテンプレート使用: ${e}-${n}`),o;if(console.log(`⚠️ OSペアテンプレートなし: ${e}-${n}`),t.ichingRelations&&t.ichingRelations.length>0){const e=t.ichingRelations[0];return this.generateBunjinRelationshipExpression(e.type,a,i)}if(t.subtleDifferences&&t.subtleDifferences.length>0){const e=t.subtleDifferences[0];return this.generateBunjinDifferenceExpression(e.type,a,i)}return`必要な時に自分の中の${a}と${i}が自然に現れ、柔軟でバランスの取れた行動ができる`}generateBunjinRelationshipExpression(e,n,t){const r={adjacent:`場面に応じて自分の中の${n}と${t}が自然に協力し、無理なく状況に適応していく`,zong:`自分の中の${n}と${t}がお互いに影響し合いながら、バランスの取れた行動ができる`,terminal:`心の中の${n}と${t}が相互に支え合って、継続的に成長していく力を発揮する`,origin:`内なる${n}と${t}が深く協調して、状況に応じた独自の判断力を生み出す`};return r[e]||r.adjacent}generateBunjinDifferenceExpression(e,n,t){const r={cognitive_direction:`自分の中の${n}と${t}の考え方の違いが、場面に応じて柔軟で多角的な判断力を生み出す`,emotional_texture:`心の中の${n}と${t}の感じ方の違いが、状況に応じて豊かで深みのある感情表現を可能にする`,completion_phase:`内なる${n}と${t}の異なる成長段階が、場面に応じて継続的で持続的な発展を実現する`};return r[e]||r.cognitive_direction}generateOSPairSpecificExpression(e,n,t,r){const s=[e,n].sort().join("-"),a={"engine-safe":[`場面に応じて自分の中の${t}と${r}が適切に現れ、積極性と慎重さのバランスの取れた行動ができる`,`心の中の${t}と${r}が状況によって自然に連携し、勇気と慎重さを併せ持った自分として行動する`,`必要な時に内なる${t}や${r}が前面に出て、状況に最適な推進力と安全性を発揮する`,`自分の中の${t}と${r}がお互いに影響し合いながら、チャレンジと安全の両立を実現する`,`内なる${t}と${r}が有機的に連動して、果敢でありながら賢明な判断ができる自分になる`],"interface-safe":[`場面に応じて自分の中の${t}と${r}が適切に現れ、人間関係の中で安心と信頼を両立できる`,`心の中の${t}と${r}が状況によって自然に連携し、社交的でありながら信頼できる関係を築く`,`必要な時に内なる${t}や${r}が前面に出て、状況に最適な対人関係と安定性を発揮する`,`自分の中の${t}と${r}がお互いに影響し合いながら、開放性と安定性の両立を実現する`,`内なる${t}と${r}が有機的に連動して、社会的でありながら誠実な人間関係を育む`],"engine-interface":[`場面に応じて自分の中の${t}と${r}が適切に現れ、行動力と社会性を両立した関係作りができる`,`心の中の${t}と${r}が状況によって自然に連携し、積極的でありながら協調的な自分として行動する`,`必要な時に内なる${t}や${r}が前面に出て、状況に最適な推進力とコミュニケーション力を発揮する`,`自分の中の${t}と${r}がお互いに影響し合いながら、リーダーシップと協調性の両立を実現する`,`内なる${t}と${r}が有機的に連動して、創造的でありながら調和を重視する行動ができる`]};if(a[s]){const e=a[s];return e[Math.floor(Math.random()*e.length)]}return null}generateEngineInterfaceTension(e,n,t){const r=e.name,s=n.name,a=e.keywords[0]||e.strength,i=n.keywords[0]||n.strength;if(t.speedConflict)return`${r}の${a}と${s}の${i}、どちらのペースを優先すべきか判断に迷いがち`;if(t.valueConflict)return`${r}の${a}重視と${s}の${i}重視、価値観の違いで方針決定に時間がかかる`;if(t.timeConflict)return`${r}の${a}と${s}の${i}、タイミングの見解が異なり調整が必要`;if(t.directionConflict)return`${r}の${a}と${s}の${i}、目指す方向性が違い戸惑うことがある`;{const e=this.getOSBunjinCharacteristics("engine"),n=this.getOSBunjinCharacteristics("interface"),t=e.bunjinNames[Math.floor(Math.random()*e.bunjinNames.length)],r=n.bunjinNames[Math.floor(Math.random()*n.bunjinNames.length)],s=this.generateOSPairSpecificExpression("engine","interface",t,r);return s||`必要な時に自分の中の${t}と${r}が自然に現れ、行動力と社会性を両立した関係作りができる`}}generateHarmoniousExpression(e,n,t){e.name,n.name,e.keywords[0]||e.strength,n.keywords[0]||n.strength;const r=this.inferOSType(e),s=this.inferOSType(n);return this.generateBunjinHarmoniousExpression(r,s,t)}generateEngineSafeTension(e,n,t){const r=e.name,s=n.name,a=e.keywords[0]||e.strength,i=n.keywords[0]||n.strength;if(t.speedConflict)return`${r}の${a}で進みたいが、${s}の${i}も大切で、スピード調整に悩む`;if(t.valueConflict)return`${r}の${a}への衝動と${s}の${i}への配慮、どちらも譲れず葛藤する`;if(t.timeConflict)return`${r}の${a}と${s}の${i}、長期的視点と短期的判断で板挟みになる`;if(t.directionConflict)return`${r}の${a}で攻めるか、${s}の${i}で守るか、選択に迷う`;{const e=this.getOSBunjinCharacteristics("engine"),n=this.getOSBunjinCharacteristics("safe"),t=e.bunjinNames[Math.floor(Math.random()*e.bunjinNames.length)],r=n.bunjinNames[Math.floor(Math.random()*n.bunjinNames.length)],s=this.generateOSPairSpecificExpression("engine","safe",t,r);return s||`必要な時に自分の中の${t}と${r}が自然に現れ、積極性と慎重さを両立した行動ができる`}}generateInterfaceSafeTension(e,n,t){const r=e.name,s=n.name,a=e.keywords[0]||e.strength,i=n.keywords[0]||n.strength;if(t.speedConflict)return`${r}の${a}での調整と${s}の${i}での安定化、どちらを優先するか悩ましい`;if(t.valueConflict)return`${r}の${a}と${s}の${i}、人間関係と安全性のバランスが難しい`;if(t.timeConflict)return`${r}の${a}による変化と${s}の${i}による維持、タイミングが合わない`;if(t.directionConflict)return`${r}の${a}と${s}の${i}、開放性と慎重さの使い分けに迷う`;{const e=this.getOSBunjinCharacteristics("interface"),n=this.getOSBunjinCharacteristics("safe"),t=e.bunjinNames[Math.floor(Math.random()*e.bunjinNames.length)],r=n.bunjinNames[Math.floor(Math.random()*n.bunjinNames.length)],s=this.generateOSPairSpecificExpression("interface","safe",t,r);return s||`必要な時に自分の中の${t}と${r}が自然に現れ、社会性と安定性を両立した関係作りができる`}}generateGeneralTension(e,n,t){const r=e.name,s=n.name,a=e.keywords[0]||e.strength,i=n.keywords[0]||n.strength;return t.speedConflict?`${r}の${a}と${s}の${i}、ペースの違いで調整に時間がかかる`:t.valueConflict?`${r}の${a}と${s}の${i}、異なる価値観で方向性に悩む`:t.timeConflict?`${r}の${a}と${s}の${i}、時間感覚の違いでタイミングが難しい`:t.directionConflict?`${r}の${a}と${s}の${i}、目標の違いで迷いが生じる`:"自分の中の異なる側面が必要な時に自然に現れ、柔軟でバランスの取れた行動ができる"}identifyTensionReason(e,n){return e.energy.includes("迅速")&&n.energy.includes("慎重")||e.energy.includes("慎重")&&n.energy.includes("迅速")?"スピード感の相違":e.energy.includes("未来")&&n.energy.includes("過去")||e.energy.includes("革新")&&n.energy.includes("伝統")?"時間軸の不一致":e.strength.includes("個人")&&n.strength.includes("集団")||e.keywords.some(e=>e.includes("独立"))&&n.keywords.some(e=>e.includes("協調"))?"価値観の相違":"本質的な方向性の違い"}areDirectlyOpposing(e,n){const t=[["創造","破壊"],["統合","分離"],["前進","後退"],["開放","閉塞"],["光明","暗黒"]];for(let[r,s]of t)for(let t of e.keywords)for(let e of n.keywords)if(t.includes(r)&&e.includes(s)||t.includes(s)&&e.includes(r))return!0;return!1}generateConflictTheme(e,n){return e.energy.includes("積極")&&n.energy.includes("受動")?"行動速度の根本的相違による葛藤":e.energy.includes("外向")&&n.energy.includes("内向")?"方向性の不一致による内的分裂":e.energy.includes("上昇")&&n.energy.includes("安定")?"成長と維持のバランス葛藤":"エネルギーの質的相違による調整困難"}generateSynergyNotes(e,n,t,r){const s=(r[0][1]+r[0][2]+r[1][2])/3;return s>.5?`全体的に調和的な構成。${e.name}を中心に、${n.name}が調整し、${t.name}が安定化させる好循環`:s>0?"バランスの取れた構成。各OSが適度な距離を保ちながら機能":"葛藤を含む構成。創造的緊張を活かすことで独自の強みを発揮可能"}suggestGrowthDirection(e,n,t){const r=(e.score+n.score+t.score)/3;return r>.7?"すでに高いバランス。各OSの特徴をより鮮明にすることで、さらなる個性化が可能では？":r>.4?"成長の余地あり。最も低いスコアのOSを意識的に活用する場面を増やしてみては？":"大きな成長ポテンシャル。まずは最も得意なOSを軸に、段階的に他のOSを統合していくアプローチを"}calculateKeywordSynergy(e,n){const t=[[["創造力","リーダーシップ"],["強大","威力","積極性"]],[["決断力","実行力"],["行動力","勇猛"]],[["教育","指導"],["学習","啓発"]],[["包容力","柔軟性"],["調和","協調"]],[["内省","慎重さ"],["深い洞察","瞑想"]],[["変革","革新"],["刷新","改革"]],[["豊かさ","繁栄"],["成功","統合"]],[["持続","継続"],["永続","恒常性"]],[["光明","照明"],["文明","知恵"]],[["活力","元気"],["刺激","動力"]]];let r=0;for(let[a,i]of t){const t=e.some(e=>a.some(n=>e.includes(n))),s=n.some(e=>i.some(n=>e.includes(n)));t&&s&&(r=Math.max(r,.7))}const s=e.filter(e=>n.some(n=>e===n||e.includes(n)||n.includes(e)));if(s.length>0){const e=Math.min(.5+.1*s.length,.7);r=Math.max(r,e)}return r}calculateEnergyCompatibility(e,n){const t=[["陽的","陽的"],["積極的","積極的"],["上昇志向","成長志向"],["学習的","成長的"],["発散的","照明的"],["流動的","適応的"],["陰的","陰的"],["受動的","安定志向"],["内向志向","深層志向"],["瞑想志向","静的"]];for(let[r,s]of t)if(e.includes(r)&&n.includes(s)||e.includes(s)&&n.includes(r))return.6;return e.includes("陽的")&&n.includes("陰的")||e.includes("陰的")&&n.includes("陽的")?.6:0}analyzeStrengthWeaknessInteraction(e,n){const t=[["決断力と実行力","主体性の欠如"],["調和と協調","傲慢になりやすい"],["知識の蓄積と伝授","経験不足による判断ミス"],["適切なタイミングを待つ力","勇み足による失敗"],["深い洞察力","行動の遅れによる機会損失"],["柔軟な対応力","完成への不安"]];for(let[s,a]of t)if(e.strength.includes(s.split("と")[0])&&n.weakness.includes(a)||n.strength.includes(s.split("と")[0])&&e.weakness.includes(a))return.5;const r=["不安","混乱","停滞","失敗","欠如"];for(let s of r)if(e.weakness.includes(s)&&n.weakness.includes(s))return-.3;return 0}haveSimilarDirection(e,n){const t=[[["創造力","リーダーシップ","決断力"],["強大","威力","行動力","積極性"]],[["教育","指導","学習"],["啓発","成長","発展"]],[["調和","協調","包容"],["柔軟","受容","適応"]],[["持続","継続","安定"],["恒常","永続","維持"]],[["変革","刷新","革新"],["改革","突破","開拓"]]];for(let[r,s]of t){const t=e.keywords.some(e=>r.some(n=>e.includes(n))),a=n.keywords.some(e=>s.some(n=>e.includes(n)));if(t&&a)return!0}return this.calculateEnergyCompatibility(e.energy,n.energy)>.6}isHealthyComplement(e,n){const t=[[["決断力","実行力"],["慎重","内省","深い洞察"]],[["積極的","外向"],["受動的","内向","静寂"]],[["創造","刷新"],["安定","維持","保守"]],[["速い","瞬間"],["遅い","持続","継続"]]];for(let[r,s]of t){const t=e.keywords.some(e=>r.some(n=>e.includes(n)))&&n.keywords.some(e=>s.some(n=>e.includes(n))),a=n.keywords.some(e=>r.some(n=>e.includes(n)))&&e.keywords.some(e=>s.some(n=>e.includes(n)));if(t||a)return this.analyzeStrengthWeaknessInteraction(e,n)>0}return!1}isStressfulComplement(e,n){const t=[[["決断力","実行力","創造力","完成"],["未完","継続","永遠","無限"]],[["安定","維持","保守","不動"],["変革","刷新","革命","破壊"]],[["内省","瞑想","静寂","孤独"],["交流","社交","開放","拡散"]],[["完璧","正確","厳格","規律"],["柔軟","適当","曖昧","自由"]]];for(let[s,a]of t){const t=e.keywords.some(e=>s.some(n=>e.includes(n)))&&n.keywords.some(e=>a.some(n=>e.includes(n))),r=n.keywords.some(e=>s.some(n=>e.includes(n)))&&e.keywords.some(e=>a.some(n=>e.includes(n)));if(t||r)return!0}if(e.strength===n.strength)return!0;const r=["不安","混乱","停滞","失敗","欠如"];for(let s of r)if(e.weakness.includes(s)&&n.weakness.includes(s))return!0;return!1}isWellBalanced(e,n){const t=[[["学習","成長","発展"],["安定","維持","保護"]],[["柔軟","適応","調整"],["規律","秩序","構造"]],[["開放","拡張","表現"],["収束","集中","内省"]],[["直感","感性","創造"],["論理","分析","慎重"]]];for(let[s,a]of t){const t=e.keywords.some(e=>s.some(n=>e.includes(n)))&&n.keywords.some(e=>a.some(n=>e.includes(n))),r=n.keywords.some(e=>s.some(n=>e.includes(n)))&&e.keywords.some(e=>a.some(n=>e.includes(n)));if(t||r)return!0}const r=this.calculateEnergyCompatibility(e.energy,n.energy);return r>.3&&r<.7}analyzeSameHexagram(e,n){switch(n){case"engine-interface":return e.keywords.some(e=>["決断力","実行力","積極性","強大","威力"].includes(e))?.6:e.keywords.some(e=>["内省","慎重","深い洞察","瞑想"].includes(e))?-.1:.4;case"engine-safe":return e.keywords.some(e=>["完璧","理想","絶頂"].includes(e))?-.2:e.keywords.some(e=>["調和","協調","安定","平和","受容性","包容力","柔軟性"].includes(e))?.3:e.keywords.some(e=>["決断力","実行力","積極性","強大","威力","創造力","リーダーシップ","推進力"].includes(e))?.2:.1;case"interface-safe":return e.keywords.some(e=>["柔軟性","適応","調整","バランス","包容力","受容性"].includes(e))?.4:e.keywords.some(e=>["極限","過度","激化"].includes(e))?-.3:.2;default:return.3}}_validateOSInput(e){try{return!!e&&(!("number"!=typeof e.hexagramId||e.hexagramId<1||e.hexagramId>64)||(console.warn("⚠️ Invalid hexagramId:",e.hexagramId),!1))}catch(n){return console.error("❌ OS validation error:",n),!1}}_getDefaultAnalysisResult(e,n,t){return{version:this.version,engine_os:{id:e&&e.hexagramId||1,name:e&&e.name||"乾為天",score:e&&e.score||.5},interface_os:{id:n&&n.hexagramId||2,name:n&&n.name||"坤為地",score:n&&n.score||.5},safe_mode_os:{id:t&&t.hexagramId||29,name:t&&t.name||"坎為水",score:t&&t.score||.5},synergy:[[0,0,0],[0,0,0],[0,0,0]],interactions:{engine_interface:"分析中にエラーが発生しました。一般的な表現を使用します。",engine_safemode:"分析中にエラーが発生しました。一般的な表現を使用します。",interface_safemode:"分析中にエラーが発生しました。一般的な表現を使用します。",triple_balance:"分析中にエラーが発生しました。システムを再起動してください。"},strengths:["データが不完全なため、詳細な分析ができませんでした"],risks:["データが不完全なため、リスク分析ができませんでした"],created_at:(new Date).toISOString()}}_initializeFallbackData(){this.interactionPatterns={},this.hexagramCharacteristics={};for(let e=1;e<=64;e++)this.hexagramCharacteristics[e]={name:`第${e}卦`,keywords:["変化","調整","発展"],strength:"適応力",weakness:"不安定性",energy:"流動的"}}_manageCacheSize(e){if(e.size>this._MAX_CACHE_SIZE){const n=e.keys().next().value;e.delete(n)}}clearCache(){try{this._synergyCache?.clear(),this._interactionCache?.clear(),this._strengthsCache?.clear(),this._risksCache?.clear(),this._keywordCombinationCache?.clear(),this._hexagramCharCache?.clear(),console.log("✅ Cache cleared successfully")}catch(e){console.error("❌ Error clearing cache:",e)}}getCacheStatistics(){return{synergyCache:this._synergyCache?.size||0,interactionCache:this._interactionCache?.size||0,strengthsCache:this._strengthsCache?.size||0,risksCache:this._risksCache?.size||0,keywordCombinationCache:this._keywordCombinationCache?.size||0,hexagramCharCache:this._hexagramCharCache?.size||0,totalCached:(this._synergyCache?.size||0)+(this._interactionCache?.size||0)+(this._strengthsCache?.size||0)+(this._risksCache?.size||0)+(this._keywordCombinationCache?.size||0)+(this._hexagramCharCache?.size||0)}}}"undefined"!=typeof module&&module.exports?module.exports=TripleOSInteractionAnalyzer:e.TripleOSInteractionAnalyzer=TripleOSInteractionAnalyzer}("undefined"!=typeof window?window:global);