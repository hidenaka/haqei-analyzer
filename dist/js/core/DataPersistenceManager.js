class DataPersistenceManager{constructor(e={}){this.version="3.0.0-haqei-ultimate",this.philosophyAlignment="haqei-multiplicity",this.dbName="HAQEI_HaQeiDatabase",this.dbVersion=7,this.db=null,this.initialized=!1,this.stores={engineOS:{name:"engine_os_data",keyPath:"id",autoIncrement:!0},interfaceOS:{name:"interface_os_data",keyPath:"id",autoIncrement:!0},safeModeOS:{name:"safe_mode_data",keyPath:"id",autoIncrement:!0},quickAnalysis:{name:"quick_analysis",keyPath:"sessionId"},osAnalysis:{name:"os_analysis",keyPath:"sessionId"},futureSimulation:{name:"future_simulation",keyPath:"sessionId"},strategicCockpit:{name:"strategic_cockpit",keyPath:"sessionId"},professionalReport:{name:"professional_report",keyPath:"sessionId"},dashboard:{name:"dashboard_data",keyPath:"userId"},library:{name:"library_resources",keyPath:"resourceId"},hexagramHistory:{name:"hexagram_history",keyPath:"id",autoIncrement:!0},iChingTransformations:{name:"iching_transformations",keyPath:"transformationId"},fiveElementsFlow:{name:"five_elements_flow",keyPath:"flowId"},sequenceLogic:{name:"sequence_logic",keyPath:"logicId"},personaProfiles:{name:"persona_profiles",keyPath:"personaId"},personaInteractions:{name:"persona_interactions",keyPath:"interactionId"},personaEvolution:{name:"persona_evolution",keyPath:"evolutionId"},sessions:{name:"user_sessions",keyPath:"sessionId"},userPreferences:{name:"user_preferences",keyPath:"userId"},systemMetadata:{name:"system_metadata",keyPath:"metaId"}},this.fallbackStorage={localStorage:"undefined"!=typeof localStorage,sessionStorage:"undefined"!=typeof sessionStorage},this.cache=new Map,this.cacheTimeout=3e5,this.maxCacheSize=1e3,this.initialize(e),console.log(`ðŸ§  HAQEI DataPersistenceManager v${this.version} - HaQeiå“²å­¦å¯¾å¿œåˆæœŸåŒ–é–‹å§‹`)}async initialize(e={}){try{if(!this.isIndexedDBSupported())return console.warn("âš ï¸ IndexedDBæœªã‚µãƒãƒ¼ãƒˆ - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œ"),void(this.initialized=!0);await this.connectDatabase(),this.validateHaQeiPhilosophy(),await this.initializeTripleOSStores(),await this.initializeNavigationStores(),await this.initializeIChingStores(),this.initialized=!0,console.log("âœ… HAQEI DataPersistenceManageråˆæœŸåŒ–å®Œäº† - åˆ†äººæ€æƒ³å®Œå…¨å¯¾å¿œ")}catch(t){throw console.error("âŒ DataPersistenceManageråˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:",t),this.initialized=!1,t}}isIndexedDBSupported(){return"indexedDB"in window&&void 0!==window.indexedDB&&null!==window.indexedDB}async connectDatabase(){return new Promise((e,t)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>{t(new Error(`IndexedDBæŽ¥ç¶šã‚¨ãƒ©ãƒ¼: ${a.error}`))},a.onsuccess=()=>{this.db=a.result,console.log("âœ… IndexedDBæŽ¥ç¶šæˆåŠŸ"),e(this.db)},a.onupgradeneeded=e=>{const t=e.target.result;console.log(`ðŸ”§ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒžæ›´æ–°ä¸­ (v${e.oldVersion} â†’ v${e.newVersion})`);for(const a of t.objectStoreNames)Object.values(this.stores).find(e=>e.name===a)||(t.deleteObjectStore(a),console.log(`ðŸ—‘ï¸ æ—§ã‚¹ãƒˆã‚¢å‰Šé™¤: ${a}`));Object.entries(this.stores).forEach(([e,a])=>{if(!t.objectStoreNames.contains(a.name)){const s=t.createObjectStore(a.name,{keyPath:a.keyPath,autoIncrement:a.autoIncrement||!1});this.createStoreIndexes(s,e),console.log(`âœ… ã‚¹ãƒˆã‚¢ä½œæˆ: ${a.name}`)}})}})}createStoreIndexes(e,t){const a={engineOS:[{name:"timestamp",keyPath:"timestamp"},{name:"hexagramId",keyPath:"hexagramId"},{name:"userId",keyPath:"userId"}],interfaceOS:[{name:"timestamp",keyPath:"timestamp"},{name:"hexagramId",keyPath:"hexagramId"},{name:"userId",keyPath:"userId"}],safeModeOS:[{name:"timestamp",keyPath:"timestamp"},{name:"hexagramId",keyPath:"hexagramId"},{name:"userId",keyPath:"userId"}],hexagramHistory:[{name:"timestamp",keyPath:"timestamp"},{name:"hexagramNumber",keyPath:"hexagramNumber"},{name:"userId",keyPath:"userId"}],personaProfiles:[{name:"createdAt",keyPath:"createdAt"},{name:"personaType",keyPath:"personaType"},{name:"userId",keyPath:"userId"}]}[t];a&&a.forEach(t=>{try{e.createIndex(t.name,t.keyPath,{unique:!1})}catch(a){console.warn(`âš ï¸ ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä½œæˆã‚¹ã‚­ãƒƒãƒ—: ${t.name}`)}})}validateHaQeiPhilosophy(){const e={rejectsUnifiedSelf:!0,supportsMultiplePersonas:!0,enablesContextualIdentity:!0,maintainsHaQeiAlignment:!0,timestamp:Date.now()};if(!e.rejectsUnifiedSelf)throw new Error("çµ±ä¸€selfæ¦‚å¿µãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚HaQeiå“²å­¦é•åã§ã™ã€‚");return console.log("âœ… HaQeiå“²å­¦æ¤œè¨¼å®Œäº† - åˆ†äººæ€æƒ³æº–æ‹ "),e}async initializeTripleOSStores(){const e=["engineOS","interfaceOS","safeModeOS"];for(const a of e)try{await this.save(a,{id:`${a}_metadata`,type:a,philosophy:"haqei-multiplicity",initialized:!0,timestamp:Date.now()}),console.log(`âœ… ${a}ã‚¹ãƒˆã‚¢åˆæœŸåŒ–å®Œäº†`)}catch(t){console.warn(`âš ï¸ ${a}åˆæœŸåŒ–è­¦å‘Š:`,t)}}async initializeNavigationStores(){const e=["quickAnalysis","osAnalysis","futureSimulation","strategicCockpit","professionalReport","dashboard","library"];for(const a of e)try{await this.save(a,{sessionId:`${a}_system_metadata`,stageName:a,stageNumber:e.indexOf(a)+1,philosophy:"haqei-navigation",initialized:!0,timestamp:Date.now()}),console.log(`âœ… Stage ${e.indexOf(a)+1} (${a})åˆæœŸåŒ–å®Œäº†`)}catch(t){console.warn(`âš ï¸ Stage ${a}åˆæœŸåŒ–è­¦å‘Š:`,t)}}async initializeIChingStores(){const e=["hexagramHistory","iChingTransformations","fiveElementsFlow","sequenceLogic"];for(const a of e)try{const e={[this.stores[a].keyPath]:`${a}_metadata`,storeName:a,philosophy:"iching-authentic",systemVersion:"5.0.0-comprehensive",initialized:!0,timestamp:Date.now()};await this.save(a,e),console.log(`âœ… æ˜“çµŒ${a}ã‚¹ãƒˆã‚¢åˆæœŸåŒ–å®Œäº†`)}catch(t){console.warn(`âš ï¸ æ˜“çµŒ${a}åˆæœŸåŒ–è­¦å‘Š:`,t)}}async save(e,t){if(!this.initialized)return console.warn("âš ï¸ æœªåˆæœŸåŒ– - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¿å­˜å®Ÿè¡Œ"),this.fallbackSave(e,t);try{if(t.unifiedSelf||t.singleIdentity)throw new Error("çµ±ä¸€selfæ¦‚å¿µãƒ‡ãƒ¼ã‚¿æ¤œå‡º - HaQeiå“²å­¦é•å");const a={...t,haqeiCompliant:!0,philosophy:"multiplicity",savedAt:Date.now(),version:this.version},s=await this.performIndexedDBOperation("put",e,a);return this.updateCache(e,a),console.log(`ðŸ’¾ ${e}ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†:`,t[this.stores[e]?.keyPath]||"IDä¸æ˜Ž"),s}catch(a){return console.error(`âŒ ${e}ä¿å­˜ã‚¨ãƒ©ãƒ¼:`,a),this.fallbackSave(e,t)}}async get(e,t){if(!this.initialized)return this.fallbackGet(e,t);try{const a=this.getFromCache(e,t);if(a)return console.log(`âš¡ ${e}ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ`),a;const s=await this.performIndexedDBOperation("get",e,t);return s&&(s.haqeiCompliant||console.warn("âš ï¸ éžHaQeiæº–æ‹ ãƒ‡ãƒ¼ã‚¿æ¤œå‡º"),this.updateCache(e,s)),s}catch(a){return console.error(`âŒ ${e}å–å¾—ã‚¨ãƒ©ãƒ¼:`,a),this.fallbackGet(e,t)}}async getAll(e,t=null){if(!this.initialized)return this.fallbackGetAll(e,t);try{let a=await this.performIndexedDBOperation("getAll",e)||[];return t&&(a=a.filter(t)),a=a.filter(e=>!e.unifiedSelf&&!e.singleIdentity),console.log(`ðŸ“‹ ${e}å…¨ãƒ‡ãƒ¼ã‚¿å–å¾—: ${a.length}ä»¶`),a}catch(a){return console.error(`âŒ ${e}å…¨å–å¾—ã‚¨ãƒ©ãƒ¼:`,a),this.fallbackGetAll(e,t)}}async delete(e,t){if(!this.initialized)return this.fallbackDelete(e,t);try{const a=await this.performIndexedDBOperation("delete",e,t);return this.removeFromCache(e,t),console.log(`ðŸ—‘ï¸ ${e}ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†: ${t}`),a}catch(a){return console.error(`âŒ ${e}å‰Šé™¤ã‚¨ãƒ©ãƒ¼:`,a),this.fallbackDelete(e,t)}}async performIndexedDBOperation(e,t,a=null){const s=this.stores[t];if(!s)throw new Error(`æœªçŸ¥ã®ã‚¹ãƒˆã‚¢: ${t}`);return new Promise((t,i)=>{const n=this.db.transaction([s.name],"readwrite").objectStore(s.name);let o;switch(e){case"put":o=n.put(a);break;case"get":o=n.get(a);break;case"getAll":o=n.getAll();break;case"delete":o=n.delete(a);break;default:return void i(new Error(`æœªå¯¾å¿œæ“ä½œ: ${e}`))}o.onsuccess=()=>{t(o.result)},o.onerror=()=>{i(o.error)}})}updateCache(e,t){if(this.cache.size>=this.maxCacheSize){const e=this.cache.keys().next().value;this.cache.delete(e)}const a=`${e}_${t[this.stores[e]?.keyPath]}`;this.cache.set(a,{data:t,timestamp:Date.now()})}getFromCache(e,t){const a=`${e}_${t}`,s=this.cache.get(a);return s&&Date.now()-s.timestamp<this.cacheTimeout?s.data:(s&&this.cache.delete(a),null)}removeFromCache(e,t){const a=`${e}_${t}`;this.cache.delete(a)}fallbackSave(e,t){if(!this.fallbackStorage.localStorage)return console.error("âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸æœªå¯¾å¿œ"),!1;try{const a=`haqei_${e}`,s=JSON.parse(localStorage.getItem(a)||"[]");return Array.isArray(s)?(s.push(t),localStorage.setItem(a,JSON.stringify(s))):localStorage.setItem(a,JSON.stringify(t)),console.log(`ðŸ’¾ ${e}ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¿å­˜å®Œäº†`),!0}catch(a){return console.error(`âŒ ${e}ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ä¿å­˜ã‚¨ãƒ©ãƒ¼:`,a),!1}}fallbackGet(e,t){if(!this.fallbackStorage.localStorage)return null;try{const t=`haqei_${e}`,a=localStorage.getItem(t);return a?JSON.parse(a):null}catch(a){return console.error(`âŒ ${e}ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å–å¾—ã‚¨ãƒ©ãƒ¼:`,a),null}}fallbackGetAll(e,t=null){const a=this.fallbackGet(e,null);if(!a)return[];const s=Array.isArray(a)?a:[a];return t?s.filter(t):s}fallbackDelete(e,t){if(!this.fallbackStorage.localStorage)return!1;try{return localStorage.removeItem(`haqei_${e}`),!0}catch(a){return console.error(`âŒ ${e}ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‰Šé™¤ã‚¨ãƒ©ãƒ¼:`,a),!1}}async cleanup(){try{const e=Date.now()-6048e5;for(const[t,a]of Object.entries(this.stores)){const s=await this.getAll(t);for(const i of s)i.savedAt&&i.savedAt<e&&await this.delete(t,i[a.keyPath])}this.cache.clear(),console.log("ðŸ§¹ ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—å®Œäº†")}catch(e){console.error("âŒ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼:",e)}}async getStatistics(){const e={version:this.version,philosophy:this.philosophyAlignment,initialized:this.initialized,databaseConnected:!!this.db,cacheSize:this.cache.size,stores:{}};for(const[a,s]of Object.entries(this.stores))try{const t=await this.getAll(a);e.stores[a]={count:t.length,size:JSON.stringify(t).length}}catch(t){e.stores[a]={count:0,error:t.message}}return e}async exportData(){const e={version:this.version,philosophy:"haqei-multiplicity",timestamp:Date.now(),data:{}};for(const[a,s]of Object.entries(this.stores))try{e.data[a]=await this.getAll(a)}catch(t){e.data[a]=[],console.warn(`âš ï¸ ${a}ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆè­¦å‘Š:`,t)}return e}async importData(e){if(!e.philosophy||"haqei-multiplicity"!==e.philosophy)throw new Error("éžHaQeiæº–æ‹ ãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆã¯æ‹’å¦ã•ã‚Œã¾ã™");let t=0,a=0;for(const[i,n]of Object.entries(e.data))try{for(const e of n)await this.save(i,e),t++}catch(s){a++,console.warn(`âš ï¸ ${i}ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:`,s)}return console.log(`ðŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: æˆåŠŸ${t}ä»¶, ã‚¨ãƒ©ãƒ¼${a}ä»¶`),{success:t,errors:a,total:t+a}}async destroy(){try{this.db&&(this.db.close(),this.db=null),this.cache.clear(),this.initialized=!1,console.log("ðŸ”š DataPersistenceManagerç ´æ£„å®Œäº†")}catch(e){console.error("âŒ ç ´æ£„ã‚¨ãƒ©ãƒ¼:",e)}}}"undefined"!=typeof window&&(window.DataPersistenceManager=DataPersistenceManager,window.haqeiPersistence||(window.haqeiPersistence=new DataPersistenceManager)),"undefined"!=typeof module&&module.exports&&(module.exports=DataPersistenceManager),console.log("ðŸ§  DataPersistenceManager.jsèª­ã¿è¾¼ã¿å®Œäº† - HaQeiå“²å­¦å®Œå…¨å¯¾å¿œIndexedDBã‚·ã‚¹ãƒ†ãƒ ");