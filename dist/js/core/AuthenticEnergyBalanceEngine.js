class AuthenticEnergyBalanceEngine{constructor(){console.log("🌟 Initializing Authentic I-Ching Energy Balance Engine"),this.initializeAuthenticTheory(),this.initializeOSOptimalPatterns(),this.initializeHexagramDatabase(),console.log("✅ Authentic Energy Balance Engine initialized successfully")}initializeAuthenticTheory(){this.polarPairs=[{yin:"坤",yang:"乾",relationship:"heaven_earth",weight:.3},{yin:"艮",yang:"兌",relationship:"mountain_lake",weight:.25},{yin:"坎",yang:"離",relationship:"water_fire",weight:.25},{yin:"巽",yang:"震",relationship:"wind_thunder",weight:.2}],this.elementalCycle={"震":{element:"wood",generates:"fire",destroys:"earth",generated_by:"water",destroyed_by:"metal"},"巽":{element:"wood",generates:"fire",destroys:"earth",generated_by:"water",destroyed_by:"metal"},"離":{element:"fire",generates:"earth",destroys:"metal",generated_by:"wood",destroyed_by:"water"},"艮":{element:"earth",generates:"metal",destroys:"water",generated_by:"fire",destroyed_by:"wood"},"坤":{element:"earth",generates:"metal",destroys:"water",generated_by:"fire",destroyed_by:"wood"},"乾":{element:"metal",generates:"water",destroys:"wood",generated_by:"earth",destroyed_by:"fire"},"兌":{element:"metal",generates:"water",destroys:"wood",generated_by:"earth",destroyed_by:"fire"},"坎":{element:"water",generates:"wood",destroys:"fire",generated_by:"metal",destroyed_by:"earth"}},this.familialStructure={father:"乾",mother:"坤",eldest_son:"震",middle_son:"坎",youngest_son:"艮",eldest_daughter:"巽",middle_daughter:"離",youngest_daughter:"兌"},this.spatialHarmony={"乾":{direction:"northwest",season:"late_autumn"},"兌":{direction:"west",season:"autumn"},"離":{direction:"south",season:"summer"},"震":{direction:"east",season:"spring"},"巽":{direction:"southeast",season:"late_spring"},"坎":{direction:"north",season:"winter"},"艮":{direction:"northeast",season:"late_winter"},"坤":{direction:"southwest",season:"late_summer"}}}initializeOSOptimalPatterns(){this.osOptimalPatterns={"Engine OS":{name:"Creative-Stable Harmony",primary_trigrams:["乾","艮"],supportive_trigrams:["震","坎"],ideal_ratios:{"乾":[.25,.3],"震":[.2,.25],"坎":[.15,.2],"艮":[.2,.25],"坤":[.15,.2],"巽":[.1,.15],"離":[.1,.15],"兌":[.08,.12]},balance_type:"yang_dominant",harmony_focus:"internal_consistency"},"Interface OS":{name:"Social-Expressive Harmony",primary_trigrams:["兌","離"],supportive_trigrams:["巽","坤"],ideal_ratios:{"兌":[.25,.3],"離":[.2,.25],"巽":[.2,.25],"坤":[.15,.2],"艮":[.1,.15],"坎":[.08,.12],"震":[.08,.12],"乾":[.1,.15]},balance_type:"yin_dominant",harmony_focus:"social_adaptation"},"Safe Mode OS":{name:"Defensive-Receptive Harmony",primary_trigrams:["艮","坤"],supportive_trigrams:["坎","巽"],ideal_ratios:{"艮":[.25,.3],"坤":[.2,.25],"坎":[.15,.2],"巽":[.15,.2],"兌":[.1,.15],"離":[.08,.12],"震":[.08,.12],"乾":[.08,.12]},balance_type:"balanced",harmony_focus:"protective_stability"}}}initializeHexagramDatabase(){this.authenticHexagramMatrix=[[1,43,14,34,9,5,26,11],[58,60,38,54,61,59,28,19],[50,64,56,62,55,63,35,8],[51,16,40,32,46,48,18,7],[57,20,53,42,37,45,22,36],[6,29,4,7,59,60,3,2],[33,52,39,15,53,56,31,12],[2,47,4,7,46,29,27,24]],this.trigramToIndex={"乾":0,"兌":1,"離":2,"震":3,"巽":4,"坎":5,"艮":6,"坤":7}}selectOptimalHexagramByEnergyBalance(e,t){console.log(`🌟 [${t}] Selecting optimal hexagram with authentic energy balance`),console.log("📊 Input energies:",e);try{const a=this.generateAllHexagramCandidates();console.log(`🔍 Generated ${a.length} hexagram candidates`);const r=a.map(a=>{const r=this.evaluateHexagramCandidate(a,e,t);return{...a,...r}});r.sort((e,t)=>t.totalHarmonyScore-e.totalHarmonyScore);const i=r[0],n=this.generateDetailedAnalysis(i,e,t);return console.log(`🏆 [${t}] Selected Hexagram ${i.hexagramId} (${i.name})`),console.log(`📈 Harmony Score: ${i.totalHarmonyScore.toFixed(2)}/100`),{hexagramId:i.hexagramId,hexagramName:i.name,upperTrigram:i.upperTrigram,lowerTrigram:i.lowerTrigram,harmonyScore:i.totalHarmonyScore,energyUtilization:i.energyUtilization,osCompatibility:i.osCompatibility,detailedAnalysis:n,alternativeCandidates:r.slice(1,4),improvementRecommendations:this.generateImprovementRecommendations(i,e,t)}}catch(a){return console.error(`❌ Error in energy balance selection for ${t}:`,a),this.getFallbackHexagram(e,t)}}generateAllHexagramCandidates(){const e=[],t=["乾","兌","離","震","巽","坎","艮","坤"];return t.forEach(a=>{t.forEach(t=>{const r=this.trigramToIndex[a],i=this.trigramToIndex[t],n=this.authenticHexagramMatrix[r][i],o=window.HEXAGRAMS?window.HEXAGRAMS.find(e=>e.hexagram_id===n):null;e.push({hexagramId:n,name:o?o.name_jp:`卦${n}`,upperTrigram:a,lowerTrigram:t,hexagramData:o})})}),e}evaluateHexagramCandidate(e,t,a){const r=this.calculatePolarHarmony(e,t),i=this.calculateElementalFlow(e,t),n=this.calculateFamilialBalance(e,t),o=this.calculateSpatialStability(e,t),l=this.calculateOSCompatibility(e,a,t),s=this.calculateEnergyUtilization(e,t),m=r*.25+i*.2+n*.15+o*.1+l*.25+s*.05;return{polarHarmony:r,elementalFlow:i,familialBalance:n,spatialStability:o,osCompatibility:l,energyUtilization:s,totalHarmonyScore:Math.max(0,Math.min(100,m))}}calculatePolarHarmony(e,t){const a=t[e.upperTrigram]||0,r=t[e.lowerTrigram]||0;let i=!1,n=1;if(this.polarPairs.forEach(t=>{(e.upperTrigram===t.yang&&e.lowerTrigram===t.yin||e.upperTrigram===t.yin&&e.lowerTrigram===t.yang)&&(i=!0,n=t.weight)}),i){const e=a>r?a/Math.max(r,1):r/Math.max(a,1),t=1.618,i=100-Math.abs(e-t)/t*50;return Math.max(0,i*n*100)}return 60*(a+r>0?Math.min(a,r)/Math.max(a,r):0)}calculateElementalFlow(e,t){const a=this.elementalCycle[e.upperTrigram],r=this.elementalCycle[e.lowerTrigram];if(!a||!r)return 50;const i=t[e.upperTrigram]||0,n=t[e.lowerTrigram]||0;let o=50;return a.element===r.generated_by&&(o+=25),r.element===a.generated_by&&(o+=25),a.element===r.destroyed_by&&i<1.5*n&&(o+=15),r.element===a.destroyed_by&&n<1.5*i&&(o+=15),a.destroys===r.element&&i>2*n&&(o-=20),r.destroys===a.element&&n>2*i&&(o-=20),Math.max(0,Math.min(100,o))}calculateFamilialBalance(e,t){const a=this.getFamilialRole(e.upperTrigram),r=this.getFamilialRole(e.lowerTrigram);let i=50;return("father"===a&&"mother"===r||"mother"===a&&"father"===r)&&(i+=30),"father"===a&&r.includes("son")&&(i+=20),"mother"===a&&r.includes("daughter")&&(i+=20),"father"===r&&a.includes("son")&&(i+=15),"mother"===r&&a.includes("daughter")&&(i+=15),a.includes("son")&&r.includes("son")&&(i+=10),a.includes("daughter")&&r.includes("daughter")&&(i+=10),Math.max(0,Math.min(100,i))}calculateSpatialStability(e,t){const a=this.spatialHarmony[e.upperTrigram],r=this.spatialHarmony[e.lowerTrigram];if(!a||!r)return 50;const i=["north","northeast","east","southeast","south","southwest","west","northwest"],n=i.indexOf(a.direction.replace("_","")),o=i.indexOf(r.direction.replace("_",""));let l=50;const s=Math.abs(n-o);return 4===s?l+=30:2===s||6===s?l+=20:1!==s&&7!==s&&3!==s&&5!==s||(l+=10),Math.max(0,Math.min(100,l))}calculateOSCompatibility(e,t,a){const r=this.osOptimalPatterns[t];if(!r)return 50;let i=0;r.primary_trigrams.includes(e.upperTrigram)&&(i+=30),r.primary_trigrams.includes(e.lowerTrigram)&&(i+=25),r.supportive_trigrams.includes(e.upperTrigram)&&(i+=20),r.supportive_trigrams.includes(e.lowerTrigram)&&(i+=15);const n=a[e.upperTrigram]||0,o=a[e.lowerTrigram]||0,l=Object.values(a).reduce((e,t)=>e+t,0);if(l>0){const t=n/l,a=o/l,s=r.ideal_ratios[e.upperTrigram],m=r.ideal_ratios[e.lowerTrigram];s&&t>=s[0]&&t<=s[1]&&(i+=10),m&&a>=m[0]&&a<=m[1]&&(i+=10)}return Math.max(0,Math.min(100,i))}calculateEnergyUtilization(e,t){const a=t[e.upperTrigram]||0,r=t[e.lowerTrigram]||0,i=Object.values(t).reduce((e,t)=>e+t,0);if(0===i)return 0;const n=(a+r)/i;return n>=.3&&n<=.7?100:n>=.2&&n<=.8?80:n>=.15&&n<=.85?60:Math.max(20,100*n)}getFamilialRole(e){return{"乾":"father","坤":"mother","震":"eldest_son","坎":"middle_son","艮":"youngest_son","巽":"eldest_daughter","離":"middle_daughter","兌":"youngest_daughter"}[e]||"unknown"}generateDetailedAnalysis(e,t,a){return{energyDistribution:{upper:t[e.upperTrigram]||0,lower:t[e.lowerTrigram]||0,utilization:e.energyUtilization,balance:this.analyzeEnergyBalance(e,t)},harmonyBreakdown:{polarHarmony:e.polarHarmony,elementalFlow:e.elementalFlow,familialBalance:e.familialBalance,spatialStability:e.spatialStability,osCompatibility:e.osCompatibility},authenticInterpretation:this.generateAuthenticInterpretation(e,a),improvedAspects:this.identifyImprovedAspects(e,t)}}generateAuthenticInterpretation(e,t){const a=e.upperTrigram,r=e.lowerTrigram;return{traditional_meaning:`${a}卦在上，${r}卦在下，象徴${this.getTrigramMeaning(a)}與${this.getTrigramMeaning(r)}的調和統一`,os_context:this.getOSContextInterpretation(e,t),practical_guidance:this.getPracticalGuidance(e,t),energy_wisdom:`您的${a}能量與${r}能量達成最佳平衡，體現了${t}系統的和諧運作`}}getTrigramMeaning(e){return{"乾":"純陽創造力","坤":"純陰包容力","震":"雷鳴行動力","巽":"風行滲透力","坎":"水流探索力","離":"火焰表現力","艮":"山嶽安定力","兌":"沼澤調和力"}[e]||"未知の力"}getOSContextInterpretation(e,t){return{"Engine OS":`內在價值系統以${e.upperTrigram}為主導，${e.lowerTrigram}為支援，形成穩定的核心人格架構`,"Interface OS":`社交互動系統通過${e.upperTrigram}的外在表現，結合${e.lowerTrigram}的內在調節，達成和諧的人際關係`,"Safe Mode OS":`防護系統以${e.upperTrigram}作為主要防線，${e.lowerTrigram}提供後備支援，確保心理安全與穩定`}[t]||"系統運作正常"}getPracticalGuidance(e,t){return`在${t}運作時，保持${e.upperTrigram}與${e.lowerTrigram}的動態平衡，順應自然變化的節奏`}generateImprovementRecommendations(e,t,a){const r=[],i=Object.values(t).reduce((e,t)=>e+t,0),n=i/8;Object.entries(t).forEach(([e,t])=>{t<.5*n&&r.push({type:"energy_boost",trigram:e,current:t,target:.7*n,suggestion:`${e}エネルギーの活性化を推奨します。${this.getTrigramMeaning(e)}を意識的に育成してください。`})});const o=this.osOptimalPatterns[a];return o&&o.primary_trigrams.forEach(e=>{const n=(t[e]||0)/i,l=o.ideal_ratios[e];l&&n<l[0]&&r.push({type:"os_optimization",trigram:e,currentRatio:n,targetRange:l,suggestion:`${a}の効果的運用のため、${e}エネルギーの増強が有効です。`})}),r}getFallbackHexagram(e,t){return console.warn(`🚨 Using fallback hexagram selection for ${t}`),{hexagramId:1,hexagramName:"乾為天",upperTrigram:"乾",lowerTrigram:"乾",harmonyScore:75,energyUtilization:50,osCompatibility:60,detailedAnalysis:{note:"フォールバック選択：安全で安定した創造的エネルギーパターン"},alternativeCandidates:[],improvementRecommendations:[]}}analyzeEnergyBalance(e,t){const a=t[e.upperTrigram]||0,r=t[e.lowerTrigram]||0;if(0===a+r)return"balanced";const i=a/r;return i>2?"upper_dominant":i<.5?"lower_dominant":i>=1.2&&i<=2?"upper_leaning":i>=.5&&i<=.8?"lower_leaning":"balanced"}identifyImprovedAspects(e,t){return{energyUtilization:e.energyUtilization>70?"excellent":"good",trigramSynergy:this.calculateTrigramSynergy(e),authenticAlignment:e.totalHarmonyScore>80?"high":"moderate",practicalApplicability:"enhanced"}}calculateTrigramSynergy(e){const t=this.elementalCycle[e.upperTrigram],a=this.elementalCycle[e.lowerTrigram];return t&&a?t.generates===a.element||a.generates===t.element?"generative":t.destroys===a.element||a.destroys===t.element?"challenging":"neutral":"neutral"}}window.AuthenticEnergyBalanceEngine=AuthenticEnergyBalanceEngine,console.log("✅ AuthenticEnergyBalanceEngine loaded successfully");