class AdaptiveIChingEngine{constructor(){console.log("🔯 適応的易経エンジン初期化開始"),this.transformationEngine=null,this.concernClassifier=new ConcernClassifier,this.displayManager=new AdaptiveDisplayManager,this.sequenceLogic=new SequenceLogic,this.classicalStandards=new ClassicalIChingStandards,this.transformationPatterns={line_progression:{name:"進（爻の推移）",description:"時間経過による自然な発展",applicability:["growth","process","gradual_change"],urgency:"low_to_medium",complexity:"simple"},line_change:{name:"変（爻変）",description:"条件による急激な変化",applicability:["decision","turning_point","immediate_change"],urgency:"medium_to_high",complexity:"medium"},hexagram_change:{name:"卦変（本卦→之卦）",description:"現状から理想への完全変化",applicability:["transformation","major_change","goal_achievement"],urgency:"high",complexity:"high"},mutual_hexagram:{name:"互卦（隠れた本質）",description:"潜在的性質や隠れた影響",applicability:["hidden_factors","unconscious","deep_analysis"],urgency:"low",complexity:"high"},reversed_hexagram:{name:"綜卦（視点転換）",description:"180度異なる視点からの解釈",applicability:["relationship","conflict","perspective_shift"],urgency:"medium",complexity:"medium"},opposite_hexagram:{name:"錯卦（完全対立）",description:"すべて反転した極端なアプローチ",applicability:["extreme_situation","radical_change","opposition"],urgency:"high",complexity:"high"},sequence_logic:{name:"序卦伝（系列関係）",description:"64卦の自然順序による長期的流れ",applicability:["life_journey","long_term_process","spiritual_growth"],urgency:"low",complexity:"very_high"}},this.initializeAsync()}async initializeAsync(){try{window.IChingTransformationEngine&&(this.transformationEngine=new window.IChingTransformationEngine,console.log("✅ IChingTransformationEngine統合完了")),await this.sequenceLogic.initialize(),console.log("✅ 適応的易経エンジン初期化完了")}catch(e){console.error("❌ 初期化エラー:",e)}}async performAdaptiveAnalysis(e,a=null){console.log("🎯 適応的易経分析開始");try{const n=await this.concernClassifier.classifyConcern(e.text,e.emotionalContext,e.contextualAnalysis);console.log("📊 悩み分類結果:",n);const t=this.determinePrimaryHexagram(e,n),i=this.selectOptimalPatterns(n,a);console.log("🔄 選択されたパターン:",i);const r=await this.executePatternAnalyses(t,i,n),s=this.generateIntegratedResult(t,r,n,a);return{primaryHexagram:t,concernAnalysis:n,patternAnalyses:r,integratedResult:s,adaptiveDisplay:this.displayManager.generateAdaptiveDisplay(s,a,n),metadata:{analysisType:"adaptive_iching",timestamp:(new Date).toISOString(),selectedPatterns:i.map(e=>e.name)}}}catch(n){return console.error("❌ 適応的分析エラー:",n),this.generateFallbackResult(e,n)}}selectOptimalPatterns(e,a){const n=[],{urgency:t,importance:i,nature:r,scope:s}=e;if("high"===t&&"high"===i?n.push(this.transformationPatterns.hexagram_change,this.transformationPatterns.line_change):"low"===t&&"high"===i?n.push(this.transformationPatterns.sequence_logic,this.transformationPatterns.line_progression):"high"===t&&"low"===i?n.push(this.transformationPatterns.line_change,this.transformationPatterns.opposite_hexagram):n.push(this.transformationPatterns.mutual_hexagram,this.transformationPatterns.line_progression),"relationship"===r&&n.push(this.transformationPatterns.reversed_hexagram),"anxiety"!==r&&"confusion"!==r||n.push(this.transformationPatterns.mutual_hexagram),"decision"===r&&n.push(this.transformationPatterns.hexagram_change,this.transformationPatterns.opposite_hexagram),a){if("beginner"===a.experienceLevel)return n.filter(e=>"very_high"!==e.complexity).slice(0,2);if("advanced"===a.experienceLevel)return[...new Set(n)]}return[...new Set(n)].sort((e,a)=>this.getComplexityScore(e)-this.getComplexityScore(a)).slice(0,3)}async executePatternAnalyses(e,a,n){const t={};for(const r of a)try{switch(r.name){case"進（爻の推移）":t.line_progression=await this.analyzeLineProgression(e,n);break;case"変（爻変）":t.line_change=await this.analyzeLineChange(e,n);break;case"卦変（本卦→之卦）":t.hexagram_change=await this.analyzeHexagramChange(e,n);break;case"互卦（隠れた本質）":t.mutual_hexagram=await this.analyzeMutualHexagram(e,n);break;case"綜卦（視点転換）":t.reversed_hexagram=await this.analyzeReversedHexagram(e,n);break;case"錯卦（完全対立）":t.opposite_hexagram=await this.analyzeOppositeHexagram(e,n);break;case"序卦伝（系列関係）":t.sequence_logic=await this.analyzeSequenceLogic(e,n)}}catch(i){console.warn(`⚠️ パターン分析エラー (${r.name}):`,i),t[this.getPatternKey(r)]={error:!0,message:`${r.name}の分析でエラーが発生しました`}}return t}async analyzeLineProgression(e,a){const n=this.determineCurrentLine(e,a),t=n<6?n+1:1,i={current:{line:n,meaning:this.getLineMeaning(e,n),stage:this.getLifeStage(n)},next:{line:t,meaning:this.getLineMeaning(e,t),stage:this.getLifeStage(t)},process:{duration:this.estimateTransitionDuration(n,t),requirements:this.getTransitionRequirements(n,t),obstacles:this.getTransitionObstacles(n,t)}};return{type:"line_progression",result:i,guidance:this.generateProgressionGuidance(i),confidence:.8}}async analyzeHexagramChange(e,a){const n=this.determineChangingLines(e,a),t=this.calculateTargetHexagram(e,n),i={current:{hexagram:e,name:this.getHexagramName(e),situation:this.analyzeCurrentSituation(e,a)},target:{hexagram:t,name:this.getHexagramName(t),potential:this.analyzeTargetPotential(t,a)},transformation:{changingLines:n,catalyst:this.identifyTransformationCatalyst(n),process:this.describeTransformationProcess(e,t),timeframe:this.estimateTransformationTime(n.length)}};return{type:"hexagram_change",result:i,guidance:this.generateTransformationGuidance(i),confidence:.9}}async analyzeMutualHexagram(e,a){if(!this.transformationEngine)throw new Error("TransformationEngine未初期化");const n=this.transformationEngine.calculateMutualHexagram(e),t={original:{hexagram:e,name:this.getHexagramName(e),surfaceLevel:this.analyzeSurfaceLevel(e,a)},hidden:{hexagram:n,name:this.getHexagramName(n),deepLevel:this.analyzeDeepLevel(n,a)},revelation:{hiddenFactors:this.identifyHiddenFactors(n,a),unconsciousInfluences:this.analyzeUnconsciousInfluences(n),potentialAwakening:this.describePotentialAwakening(e,n)}};return{type:"mutual_hexagram",result:t,guidance:this.generateMutualGuidance(t),confidence:.7}}async analyzeReversedHexagram(e,a){if(!this.transformationEngine)throw new Error("TransformationEngine未初期化");const n=this.transformationEngine.calculateReversedHexagram(e),t={yourPerspective:{hexagram:e,name:this.getHexagramName(e),viewpoint:this.analyzeCurrentViewpoint(e,a)},otherPerspective:{hexagram:n,name:this.getHexagramName(n),viewpoint:this.analyzeAlternativeViewpoint(n,a)},synthesis:{commonGround:this.findCommonGround(e,n),complementarity:this.analyzeComplementarity(e,n),integrationPath:this.suggestIntegrationPath(e,n)}};return{type:"reversed_hexagram",result:t,guidance:this.generateReversalGuidance(t),confidence:.8}}async analyzeSequenceLogic(e,a){const n=this.sequenceLogic.getHexagramSequence(e),t={currentPosition:{hexagram:e,name:this.getHexagramName(e),sequenceNumber:n.position,lifePhase:n.lifePhase},previousStage:n.previous?{hexagram:n.previous.hexagram,name:this.getHexagramName(n.previous.hexagram),lessonLearned:n.previous.lesson}:null,nextStage:n.next?{hexagram:n.next.hexagram,name:this.getHexagramName(n.next.hexagram),upcomingChallenge:n.next.challenge}:null,overallJourney:{theme:n.overallTheme,progress:n.progressPercentage,remainingPath:n.remainingChallenges}};return{type:"sequence_logic",result:t,guidance:this.generateSequenceGuidance(t),confidence:.85}}generateIntegratedResult(e,a,n,t){const i=this.calculatePatternWeights(a,n),r=this.synthesizeGuidance(a,i);return{primaryMessage:r.primary,actionSteps:r.actions,timeframe:r.timeframe,cautions:r.cautions,opportunities:r.opportunities,overallConfidence:this.calculateOverallConfidence(a,i),HaQeiIntegration:this.integrateHaQeiPhilosophy(r)}}integrateHaQeiPhilosophy(e){return{multipleViews:{description:"複数の視点を同時に保持することで、より豊かな理解を得られます",perspectives:e.perspectives||[]},dividedPerformance:{description:"矛盾する解釈も同時に受け入れることで、新たな洞察が生まれます",paradoxes:e.paradoxes||[]},tripleOSIntegration:{engineOS:"内的な変化と成長に焦点を当てる視点",interfaceOS:"他者との関係性と相互作用を重視する視点",safeModeOS:"リスクを避け、安定性を保つ防御的視点"}}}getComplexityScore(e){return{simple:1,medium:2,high:3,very_high:4}[e.complexity]||2}getPatternKey(e){return{"進（爻の推移）":"line_progression","変（爻変）":"line_change","卦変（本卦→之卦）":"hexagram_change","互卦（隠れた本質）":"mutual_hexagram","綜卦（視点転換）":"reversed_hexagram","錯卦（完全対立）":"opposite_hexagram","序卦伝（系列関係）":"sequence_logic"}[e.name]||"unknown"}generateFallbackResult(e,a){return{primaryHexagram:1,concernAnalysis:{urgency:"medium",importance:"medium",nature:"general",scope:"personal"},patternAnalyses:{fallback:{type:"fallback",result:{message:"基本的な指導を提供します"},guidance:"現在の状況を静かに観察し、内なる声に耳を傾けてください。",confidence:.5}},integratedResult:{primaryMessage:"システムエラーが発生しましたが、基本的な易経の知恵をお伝えします。",actionSteps:["現状を受け入れる","内省の時間を作る","次の行動を慎重に考える"],timeframe:"不明",overallConfidence:.3},metadata:{error:!0,errorMessage:a.message,fallbackMode:!0}}}}"undefined"!=typeof window&&(window.AdaptiveIChingEngine=AdaptiveIChingEngine);