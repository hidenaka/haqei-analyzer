class AdaptiveIChingEngine{constructor(){console.log("ğŸ”¯ é©å¿œçš„æ˜“çµŒã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–é–‹å§‹"),this.transformationEngine=null,this.concernClassifier=new ConcernClassifier,this.displayManager=new AdaptiveDisplayManager,this.sequenceLogic=new SequenceLogic,this.classicalStandards=new ClassicalIChingStandards,this.transformationPatterns={line_progression:{name:"é€²ï¼ˆçˆ»ã®æ¨ç§»ï¼‰",description:"æ™‚é–“çµŒéã«ã‚ˆã‚‹è‡ªç„¶ãªç™ºå±•",applicability:["growth","process","gradual_change"],urgency:"low_to_medium",complexity:"simple"},line_change:{name:"å¤‰ï¼ˆçˆ»å¤‰ï¼‰",description:"æ¡ä»¶ã«ã‚ˆã‚‹æ€¥æ¿€ãªå¤‰åŒ–",applicability:["decision","turning_point","immediate_change"],urgency:"medium_to_high",complexity:"medium"},hexagram_change:{name:"å¦å¤‰ï¼ˆæœ¬å¦â†’ä¹‹å¦ï¼‰",description:"ç¾çŠ¶ã‹ã‚‰ç†æƒ³ã¸ã®å®Œå…¨å¤‰åŒ–",applicability:["transformation","major_change","goal_achievement"],urgency:"high",complexity:"high"},mutual_hexagram:{name:"äº’å¦ï¼ˆéš ã‚ŒãŸæœ¬è³ªï¼‰",description:"æ½œåœ¨çš„æ€§è³ªã‚„éš ã‚ŒãŸå½±éŸ¿",applicability:["hidden_factors","unconscious","deep_analysis"],urgency:"low",complexity:"high"},reversed_hexagram:{name:"ç¶œå¦ï¼ˆè¦–ç‚¹è»¢æ›ï¼‰",description:"180åº¦ç•°ãªã‚‹è¦–ç‚¹ã‹ã‚‰ã®è§£é‡ˆ",applicability:["relationship","conflict","perspective_shift"],urgency:"medium",complexity:"medium"},opposite_hexagram:{name:"éŒ¯å¦ï¼ˆå®Œå…¨å¯¾ç«‹ï¼‰",description:"ã™ã¹ã¦åè»¢ã—ãŸæ¥µç«¯ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ",applicability:["extreme_situation","radical_change","opposition"],urgency:"high",complexity:"high"},sequence_logic:{name:"åºå¦ä¼ï¼ˆç³»åˆ—é–¢ä¿‚ï¼‰",description:"64å¦ã®è‡ªç„¶é †åºã«ã‚ˆã‚‹é•·æœŸçš„æµã‚Œ",applicability:["life_journey","long_term_process","spiritual_growth"],urgency:"low",complexity:"very_high"}},this.initializeAsync()}async initializeAsync(){try{window.IChingTransformationEngine&&(this.transformationEngine=new window.IChingTransformationEngine,console.log("âœ… IChingTransformationEngineçµ±åˆå®Œäº†")),await this.sequenceLogic.initialize(),console.log("âœ… é©å¿œçš„æ˜“çµŒã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–å®Œäº†")}catch(e){console.error("âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:",e)}}async performAdaptiveAnalysis(e,a=null){console.log("ğŸ¯ é©å¿œçš„æ˜“çµŒåˆ†æé–‹å§‹");try{const n=await this.concernClassifier.classifyConcern(e.text,e.emotionalContext,e.contextualAnalysis);console.log("ğŸ“Š æ‚©ã¿åˆ†é¡çµæœ:",n);const t=this.determinePrimaryHexagram(e,n),i=this.selectOptimalPatterns(n,a);console.log("ğŸ”„ é¸æŠã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³:",i);const r=await this.executePatternAnalyses(t,i,n),s=this.generateIntegratedResult(t,r,n,a);return{primaryHexagram:t,concernAnalysis:n,patternAnalyses:r,integratedResult:s,adaptiveDisplay:this.displayManager.generateAdaptiveDisplay(s,a,n),metadata:{analysisType:"adaptive_iching",timestamp:(new Date).toISOString(),selectedPatterns:i.map(e=>e.name)}}}catch(n){return console.error("âŒ é©å¿œçš„åˆ†æã‚¨ãƒ©ãƒ¼:",n),this.generateFallbackResult(e,n)}}selectOptimalPatterns(e,a){const n=[],{urgency:t,importance:i,nature:r,scope:s}=e;if("high"===t&&"high"===i?n.push(this.transformationPatterns.hexagram_change,this.transformationPatterns.line_change):"low"===t&&"high"===i?n.push(this.transformationPatterns.sequence_logic,this.transformationPatterns.line_progression):"high"===t&&"low"===i?n.push(this.transformationPatterns.line_change,this.transformationPatterns.opposite_hexagram):n.push(this.transformationPatterns.mutual_hexagram,this.transformationPatterns.line_progression),"relationship"===r&&n.push(this.transformationPatterns.reversed_hexagram),"anxiety"!==r&&"confusion"!==r||n.push(this.transformationPatterns.mutual_hexagram),"decision"===r&&n.push(this.transformationPatterns.hexagram_change,this.transformationPatterns.opposite_hexagram),a){if("beginner"===a.experienceLevel)return n.filter(e=>"very_high"!==e.complexity).slice(0,2);if("advanced"===a.experienceLevel)return[...new Set(n)]}return[...new Set(n)].sort((e,a)=>this.getComplexityScore(e)-this.getComplexityScore(a)).slice(0,3)}async executePatternAnalyses(e,a,n){const t={};for(const r of a)try{switch(r.name){case"é€²ï¼ˆçˆ»ã®æ¨ç§»ï¼‰":t.line_progression=await this.analyzeLineProgression(e,n);break;case"å¤‰ï¼ˆçˆ»å¤‰ï¼‰":t.line_change=await this.analyzeLineChange(e,n);break;case"å¦å¤‰ï¼ˆæœ¬å¦â†’ä¹‹å¦ï¼‰":t.hexagram_change=await this.analyzeHexagramChange(e,n);break;case"äº’å¦ï¼ˆéš ã‚ŒãŸæœ¬è³ªï¼‰":t.mutual_hexagram=await this.analyzeMutualHexagram(e,n);break;case"ç¶œå¦ï¼ˆè¦–ç‚¹è»¢æ›ï¼‰":t.reversed_hexagram=await this.analyzeReversedHexagram(e,n);break;case"éŒ¯å¦ï¼ˆå®Œå…¨å¯¾ç«‹ï¼‰":t.opposite_hexagram=await this.analyzeOppositeHexagram(e,n);break;case"åºå¦ä¼ï¼ˆç³»åˆ—é–¢ä¿‚ï¼‰":t.sequence_logic=await this.analyzeSequenceLogic(e,n)}}catch(i){console.warn(`âš ï¸ ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æã‚¨ãƒ©ãƒ¼ (${r.name}):`,i),t[this.getPatternKey(r)]={error:!0,message:`${r.name}ã®åˆ†æã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ`}}return t}async analyzeLineProgression(e,a){const n=this.determineCurrentLine(e,a),t=n<6?n+1:1,i={current:{line:n,meaning:this.getLineMeaning(e,n),stage:this.getLifeStage(n)},next:{line:t,meaning:this.getLineMeaning(e,t),stage:this.getLifeStage(t)},process:{duration:this.estimateTransitionDuration(n,t),requirements:this.getTransitionRequirements(n,t),obstacles:this.getTransitionObstacles(n,t)}};return{type:"line_progression",result:i,guidance:this.generateProgressionGuidance(i),confidence:.8}}async analyzeHexagramChange(e,a){const n=this.determineChangingLines(e,a),t=this.calculateTargetHexagram(e,n),i={current:{hexagram:e,name:this.getHexagramName(e),situation:this.analyzeCurrentSituation(e,a)},target:{hexagram:t,name:this.getHexagramName(t),potential:this.analyzeTargetPotential(t,a)},transformation:{changingLines:n,catalyst:this.identifyTransformationCatalyst(n),process:this.describeTransformationProcess(e,t),timeframe:this.estimateTransformationTime(n.length)}};return{type:"hexagram_change",result:i,guidance:this.generateTransformationGuidance(i),confidence:.9}}async analyzeMutualHexagram(e,a){if(!this.transformationEngine)throw new Error("TransformationEngineæœªåˆæœŸåŒ–");const n=this.transformationEngine.calculateMutualHexagram(e),t={original:{hexagram:e,name:this.getHexagramName(e),surfaceLevel:this.analyzeSurfaceLevel(e,a)},hidden:{hexagram:n,name:this.getHexagramName(n),deepLevel:this.analyzeDeepLevel(n,a)},revelation:{hiddenFactors:this.identifyHiddenFactors(n,a),unconsciousInfluences:this.analyzeUnconsciousInfluences(n),potentialAwakening:this.describePotentialAwakening(e,n)}};return{type:"mutual_hexagram",result:t,guidance:this.generateMutualGuidance(t),confidence:.7}}async analyzeReversedHexagram(e,a){if(!this.transformationEngine)throw new Error("TransformationEngineæœªåˆæœŸåŒ–");const n=this.transformationEngine.calculateReversedHexagram(e),t={yourPerspective:{hexagram:e,name:this.getHexagramName(e),viewpoint:this.analyzeCurrentViewpoint(e,a)},otherPerspective:{hexagram:n,name:this.getHexagramName(n),viewpoint:this.analyzeAlternativeViewpoint(n,a)},synthesis:{commonGround:this.findCommonGround(e,n),complementarity:this.analyzeComplementarity(e,n),integrationPath:this.suggestIntegrationPath(e,n)}};return{type:"reversed_hexagram",result:t,guidance:this.generateReversalGuidance(t),confidence:.8}}async analyzeSequenceLogic(e,a){const n=this.sequenceLogic.getHexagramSequence(e),t={currentPosition:{hexagram:e,name:this.getHexagramName(e),sequenceNumber:n.position,lifePhase:n.lifePhase},previousStage:n.previous?{hexagram:n.previous.hexagram,name:this.getHexagramName(n.previous.hexagram),lessonLearned:n.previous.lesson}:null,nextStage:n.next?{hexagram:n.next.hexagram,name:this.getHexagramName(n.next.hexagram),upcomingChallenge:n.next.challenge}:null,overallJourney:{theme:n.overallTheme,progress:n.progressPercentage,remainingPath:n.remainingChallenges}};return{type:"sequence_logic",result:t,guidance:this.generateSequenceGuidance(t),confidence:.85}}generateIntegratedResult(e,a,n,t){const i=this.calculatePatternWeights(a,n),r=this.synthesizeGuidance(a,i);return{primaryMessage:r.primary,actionSteps:r.actions,timeframe:r.timeframe,cautions:r.cautions,opportunities:r.opportunities,overallConfidence:this.calculateOverallConfidence(a,i),HaQeiIntegration:this.integrateHaQeiPhilosophy(r)}}integrateHaQeiPhilosophy(e){return{multipleViews:{description:"è¤‡æ•°ã®è¦–ç‚¹ã‚’åŒæ™‚ã«ä¿æŒã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šè±Šã‹ãªç†è§£ã‚’å¾—ã‚‰ã‚Œã¾ã™",perspectives:e.perspectives||[]},dividedPerformance:{description:"çŸ›ç›¾ã™ã‚‹è§£é‡ˆã‚‚åŒæ™‚ã«å—ã‘å…¥ã‚Œã‚‹ã“ã¨ã§ã€æ–°ãŸãªæ´å¯ŸãŒç”Ÿã¾ã‚Œã¾ã™",paradoxes:e.paradoxes||[]},tripleOSIntegration:{engineOS:"å†…çš„ãªå¤‰åŒ–ã¨æˆé•·ã«ç„¦ç‚¹ã‚’å½“ã¦ã‚‹è¦–ç‚¹",interfaceOS:"ä»–è€…ã¨ã®é–¢ä¿‚æ€§ã¨ç›¸äº’ä½œç”¨ã‚’é‡è¦–ã™ã‚‹è¦–ç‚¹",safeModeOS:"ãƒªã‚¹ã‚¯ã‚’é¿ã‘ã€å®‰å®šæ€§ã‚’ä¿ã¤é˜²å¾¡çš„è¦–ç‚¹"}}}getComplexityScore(e){return{simple:1,medium:2,high:3,very_high:4}[e.complexity]||2}getPatternKey(e){return{"é€²ï¼ˆçˆ»ã®æ¨ç§»ï¼‰":"line_progression","å¤‰ï¼ˆçˆ»å¤‰ï¼‰":"line_change","å¦å¤‰ï¼ˆæœ¬å¦â†’ä¹‹å¦ï¼‰":"hexagram_change","äº’å¦ï¼ˆéš ã‚ŒãŸæœ¬è³ªï¼‰":"mutual_hexagram","ç¶œå¦ï¼ˆè¦–ç‚¹è»¢æ›ï¼‰":"reversed_hexagram","éŒ¯å¦ï¼ˆå®Œå…¨å¯¾ç«‹ï¼‰":"opposite_hexagram","åºå¦ä¼ï¼ˆç³»åˆ—é–¢ä¿‚ï¼‰":"sequence_logic"}[e.name]||"unknown"}generateFallbackResult(e,a){return{primaryHexagram:1,concernAnalysis:{urgency:"medium",importance:"medium",nature:"general",scope:"personal"},patternAnalyses:{fallback:{type:"fallback",result:{message:"åŸºæœ¬çš„ãªæŒ‡å°ã‚’æä¾›ã—ã¾ã™"},guidance:"ç¾åœ¨ã®çŠ¶æ³ã‚’é™ã‹ã«è¦³å¯Ÿã—ã€å†…ãªã‚‹å£°ã«è€³ã‚’å‚¾ã‘ã¦ãã ã•ã„ã€‚",confidence:.5}},integratedResult:{primaryMessage:"ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸãŒã€åŸºæœ¬çš„ãªæ˜“çµŒã®çŸ¥æµã‚’ãŠä¼ãˆã—ã¾ã™ã€‚",actionSteps:["ç¾çŠ¶ã‚’å—ã‘å…¥ã‚Œã‚‹","å†…çœã®æ™‚é–“ã‚’ä½œã‚‹","æ¬¡ã®è¡Œå‹•ã‚’æ…é‡ã«è€ƒãˆã‚‹"],timeframe:"ä¸æ˜",overallConfidence:.3},metadata:{error:!0,errorMessage:a.message,fallbackMode:!0}}}}"undefined"!=typeof window&&(window.AdaptiveIChingEngine=AdaptiveIChingEngine);