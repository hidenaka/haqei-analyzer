!function(){"use strict";class OSAnalyzerIntegrationPatch{constructor(){this.version="1.0.0-os-analyzer-patch",this.integrated=!1,this.patchApplied=!1,this.targetScripts=["user-friendly-error-handler-fixed.js","performance-optimizer-fixed.js","app.js","virtual-question-flow-fix.js","screen-transition-fix.js"],this.existingHandlers=new Map,this.metrics={patchStartTime:0,patchEndTime:0,integratedScripts:0,preservedHandlers:0,enhancedElements:0},console.log(`🔧 OSAnalyzerIntegrationPatch v${this.version} ready`)}async applyPatch(){if(this.patchApplied)console.warn("⚠️ Patch already applied");else{this.metrics.patchStartTime=performance.now();try{console.log("🔧 Applying OS Analyzer integration patch..."),await this.preserveExistingSystems(),await this.initializeUnifiedErrorHandling(),await this.integrateWithExistingScripts(),await this.enhanceDOMElements(),await this.integrateWithHelpSystem(),await this.optimizePerformance(),this.patchApplied=!0,this.integrated=!0,this.metrics.patchEndTime=performance.now();const e=this.metrics.patchEndTime-this.metrics.patchStartTime;return console.log(`✅ OS Analyzer integration patch applied successfully in ${e.toFixed(2)}ms`),this.dispatchIntegrationEvent(),{success:!0,patchTime:e,metrics:this.metrics}}catch(e){return console.error("❌ OS Analyzer integration patch failed:",e),await this.rollbackPatch(),{success:!1,error:e.message}}}}async preserveExistingSystems(){console.log("💾 Phase 1: Preserving existing systems..."),window.onerror&&(this.existingHandlers.set("global-onerror",window.onerror),this.metrics.preservedHandlers++),window.onunhandledrejection&&(this.existingHandlers.set("global-unhandledrejection",window.onunhandledrejection),this.metrics.preservedHandlers++);["errorHandler","comprehensiveErrorHandler","performanceOptimizer","progressDisplayEnhancer","welcomeScreenCleaner"].forEach(e=>{window[e]&&(this.existingHandlers.set(e,window[e]),this.metrics.preservedHandlers++)}),console.log(`💾 Preserved ${this.metrics.preservedHandlers} existing handlers`)}async initializeUnifiedErrorHandling(){if(console.log("🎯 Phase 2: Initializing unified error handling..."),window.haqeiErrorBootstrap||await this.loadAndInitializeBootstrap(),!window.HAQEIErrorHandler)throw new Error("Unified error handler not available after bootstrap");console.log("✅ Unified error handler initialized")}async loadAndInitializeBootstrap(){try{if(await this.loadScript("/js/core/HAQEIErrorSystemBootstrap.js"),!window.HAQEIErrorSystemBootstrap)throw new Error("HAQEIErrorSystemBootstrap not available after loading");{const e=new window.HAQEIErrorSystemBootstrap,t=await e.bootstrap();if(!t.success)throw new Error(`Bootstrap initialization failed: ${t.error}`);window.haqeiErrorBootstrap=e,console.log("✅ Bootstrap loaded and initialized dynamically")}}catch(e){throw new Error(`Dynamic bootstrap loading failed: ${e.message}`)}}async loadScript(e){return new Promise((t,r)=>{const n=document.createElement("script");n.src=e,n.async=!0,n.onload=()=>t(),n.onerror=()=>r(new Error(`Failed to load script: ${e}`)),document.head.appendChild(n)})}async integrateWithExistingScripts(){console.log("🔌 Phase 3: Integrating with existing scripts..."),await this.integrateWithAppJS(),await this.integrateWithExistingErrorHandlers(),await this.integrateWithPerformanceOptimizer(),await this.integrateWithVirtualQuestionFlow(),console.log(`🔌 Integrated with ${this.metrics.integratedScripts} scripts`)}async integrateWithAppJS(){if(window.app)try{const e=window.app.handleError;window.app.handleError=async(t,r={})=>{if(await window.HAQEIErrorHandler.handleError(t,{...r,source:"app.js",originalHandler:e,timestamp:Date.now()}),e&&"function"==typeof e)try{await e.call(window.app,t,r)}catch(n){console.warn("⚠️ Legacy app.handleError failed:",n)}},this.metrics.integratedScripts++,console.log("✅ app.js integration completed")}catch(e){console.error("❌ app.js integration failed:",e)}else console.log("⏭️ app.js not found, skipping integration")}async integrateWithExistingErrorHandlers(){if(window.errorHandler&&window.errorHandler.handleError){const e=window.errorHandler.handleError.bind(window.errorHandler);window.errorHandler.handleError=async(t,r,n)=>(await window.HAQEIErrorHandler.handleError(t,{source:"user-friendly-error-handler",context:r,details:n,intercepted:!0}),e(t,r,n)),this.metrics.integratedScripts++,console.log("✅ user-friendly-error-handler integration completed")}if(window.errorHandler&&window.errorHandler.handleGlobalError){const e=window.errorHandler.handleGlobalError.bind(window.errorHandler);window.errorHandler.handleGlobalError=async t=>(await window.HAQEIErrorHandler.handleError(t.error||new Error(t.message),{source:"comprehensive-error-handler",event:t,intercepted:!0}),e(t)),console.log("✅ ComprehensiveErrorHandler integration completed")}}async integrateWithPerformanceOptimizer(){if(window.performanceOptimizer)try{const e=window.performanceOptimizer.optimize;e&&(window.performanceOptimizer.optimize=async function(){try{return await e.call(this)}catch(t){throw await window.HAQEIErrorHandler.handleError(t,{source:"performance-optimizer",method:"optimize"}),t}},this.metrics.integratedScripts++,console.log("✅ Performance optimizer integration completed"))}catch(e){console.warn("⚠️ Performance optimizer integration failed:",e)}}async integrateWithVirtualQuestionFlow(){if(window.VirtualQuestionFlow)try{["displayQuestion","handleAnswer","nextQuestion","calculateResults"].forEach(e=>{if(window.VirtualQuestionFlow.prototype[e]){const t=window.VirtualQuestionFlow.prototype[e];window.VirtualQuestionFlow.prototype[e]=async function(...r){try{return await t.apply(this,r)}catch(n){throw await window.HAQEIErrorHandler.handleError(n,{source:"VirtualQuestionFlow",method:e,args:r,instance:this}),n}}}}),this.metrics.integratedScripts++,console.log("✅ VirtualQuestionFlow integration completed")}catch(e){console.warn("⚠️ VirtualQuestionFlow integration failed:",e)}}async enhanceDOMElements(){console.log("🎨 Phase 4: Enhancing DOM elements..."),await this.ensureErrorContainers(),await this.enhanceInteractiveElements(),await this.enhanceAccessibility(),console.log(`🎨 Enhanced ${this.metrics.enhancedElements} DOM elements`)}async ensureErrorContainers(){if(0===document.querySelectorAll("#error-notifications, #data-manager-errors").length){const e=document.createElement("div");e.id="haqei-unified-error-container",e.className="haqei-error-container",e.style.cssText="\n          position: fixed;\n          top: 20px;\n          right: 20px;\n          z-index: 10000;\n          pointer-events: none;\n        ",document.body.appendChild(e),this.metrics.enhancedElements++}}async enhanceInteractiveElements(){document.querySelectorAll('button, .btn, [role="button"]').forEach(e=>{e.hasAttribute("data-haqei-enhanced")||(e.addEventListener("click",async e=>{}),e.setAttribute("data-haqei-enhanced","true"),this.metrics.enhancedElements++)});document.querySelectorAll("form").forEach(e=>{e.hasAttribute("data-haqei-enhanced")||(e.addEventListener("submit",async e=>{}),e.setAttribute("data-haqei-enhanced","true"),this.metrics.enhancedElements++)})}async enhanceAccessibility(){document.querySelectorAll("button:not([aria-label]), input:not([aria-label])").forEach(e=>{(e.textContent||e.value)&&(e.setAttribute("aria-label",e.textContent||e.value),this.metrics.enhancedElements++)})}async integrateWithHelpSystem(){if(console.log("🔗 Phase 5: Integrating with help system..."),window.haqeiHelpSystem)try{const e=window.haqeiHelpSystem.showHelp;e&&(window.haqeiHelpSystem.showHelp=async function(...t){try{return await e.apply(this,t)}catch(r){throw await window.HAQEIErrorHandler.handleError(r,{source:"haqei-help-system",method:"showHelp",args:t}),r}},console.log("✅ Help system integration completed"))}catch(e){console.warn("⚠️ Help system integration failed:",e)}else console.log("⏭️ Help system not found, skipping integration")}async optimizePerformance(){console.log("⚡ Phase 6: Optimizing performance..."),this.optimizeMemoryUsage(),this.optimizeEventListeners(),this.optimizePolling(),console.log("⚡ Performance optimization completed")}optimizeMemoryUsage(){setInterval(()=>{window.gc&&"function"==typeof window.gc&&window.gc()},3e5)}optimizeEventListeners(){["scroll","wheel","touchstart","touchmove"].forEach(e=>{document.querySelectorAll(`[on${e}]`).forEach(t=>{const r=t.getAttribute(`on${e}`);r&&(t.removeAttribute(`on${e}`),t.addEventListener(e,new Function(r),{passive:!0}),this.metrics.enhancedElements++)})})}optimizePolling(){}dispatchIntegrationEvent(){const e=new CustomEvent("haqei:osAnalyzerIntegrated",{detail:{version:this.version,metrics:this.metrics,timestamp:Date.now()}});document.dispatchEvent(e)}async rollbackPatch(){console.warn("🔄 Rolling back OS Analyzer integration patch...");try{this.existingHandlers.forEach((e,t)=>{if(t.startsWith("global-")){const r=t.split("-")[1];window[`on${r}`]=e}else window[t]=e});document.querySelectorAll("[data-haqei-enhanced]").forEach(e=>{e.removeAttribute("data-haqei-enhanced")}),this.patchApplied=!1,this.integrated=!1,console.log("✅ Rollback completed")}catch(e){console.error("❌ Rollback failed:",e)}}getIntegrationStatus(){return{version:this.version,integrated:this.integrated,patchApplied:this.patchApplied,metrics:this.metrics,targetScripts:this.targetScripts,preservedHandlers:Array.from(this.existingHandlers.keys())}}}window.OSAnalyzerIntegrationPatch=OSAnalyzerIntegrationPatch,document.addEventListener("DOMContentLoaded",async()=>{try{setTimeout(async()=>{const e=new OSAnalyzerIntegrationPatch,t=await e.applyPatch();t.success?(window.osAnalyzerPatch=e,console.log("✅ OS Analyzer integration patch auto-applied successfully")):console.error("❌ OS Analyzer integration patch auto-application failed:",t.error)},2e3)}catch(e){console.error("❌ OS Analyzer integration patch initialization failed:",e)}}),console.log("🔧 OSAnalyzerIntegrationPatch ready for auto-application")}();