console.log("☯️ IChingGuidanceEngine Loading..."),function(){"use strict";class IChingGuidanceEngine{constructor(){this.name="IChingGuidanceEngine",this.version="2.0.0",this.h384db=null,this.currentHexagram=null,this.currentYao=null,this.choiceHistory=[],this.isInitialized=!1}async initialize(){console.log("🔄 IChingGuidanceEngine initializing...");try{return await this.connectDatabase(),this.initializeChangePatterns(),this.initializeGuidanceSystem(),this.isInitialized=!0,console.log("✅ IChingGuidanceEngine initialized successfully"),!0}catch(e){return console.error("❌ IChingGuidanceEngine initialization failed:",e),!1}}async connectDatabase(){if(window.h384db&&window.h384db.isLoaded)this.h384db=window.h384db,console.log("✅ Connected to H384 Database");else{console.warn("⚠️ H384db not ready, using getDatabaseData()");const e=window.getDatabaseData?window.getDatabaseData():[];e.length>0&&(this.h384db={getDatabaseData:()=>e})}}initializeChangePatterns(){this.changePatterns={yangToYin:{name:"陽転陰",description:"積極的な状態から受容的な状態への変化",guidance:"力を抜いて、自然の流れに身を任せる時期"},yinToYang:{name:"陰転陽",description:"受動的な状態から能動的な状態への変化",guidance:"行動を起こし、主体的に動き出す時期"},oldYang:{name:"老陽",description:"陽が極まり、変化の時を迎える",guidance:"成功の頂点にあるが、謙虚さを忘れずに"},oldYin:{name:"老陰",description:"陰が極まり、転換点を迎える",guidance:"最も暗い時期を過ぎ、光が見え始める"}}}initializeGuidanceSystem(){this.guidancePatterns={stage1:{conservative:{name:"保守的選択",keywords:["安定","継続","忍耐"],description:"現状を維持し、内なる力を蓄える",iChingPrinciple:"潜龍勿用 - 力を秘めて時を待つ"},progressive:{name:"進歩的選択",keywords:["変革","挑戦","革新"],description:"新しい可能性に向かって一歩踏み出す",iChingPrinciple:"見龍在田 - 才能を世に現す時"}},stage2:{collaborative:{name:"協調的選択",keywords:["協力","調和","共生"],description:"他者との協力関係を重視する",iChingPrinciple:"群龍無首 - 皆が協力して進む"},independent:{name:"独立的選択",keywords:["自立","独創","個性"],description:"自分の道を独自に切り開く",iChingPrinciple:"飛龍在天 - 独自の道を行く"}},stage3:{cautious:{name:"慎重な選択",keywords:["熟慮","計画","準備"],description:"十分な準備と計画を重視",iChingPrinciple:"君子終日乾乾 - 慎重に努力を続ける"},decisive:{name:"決断的選択",keywords:["即断","直感","勇気"],description:"直感を信じて迅速に行動",iChingPrinciple:"或躍在淵 - 機を見て躍動する"}}}}calculateSituationHexagram(e){if(!this.h384db)return console.error("❌ Database not connected"),null;const i=this.h384db.getDatabaseData();if(!i||0===i.length)return console.error("❌ No database data available"),null;const t=this.analyzeText(e);let n=null,a=0;if(i.forEach(e=>{const i=this.calculateMatchScore(t,e);i>a&&(a=i,n=e)}),n){const e=n["卦番号"]||1,i=n["卦名"]||"乾為天",t=n["爻"]||"初九",a=n["通し番号"]||1;let o;if(this.currentHexagram=e,this.currentYao=t,console.log(`📍 状況卦: ${i} ${t}`),1===e)o=a;else if(2===e)o=a-7;else{o=a-(14+6*(e-3))+1}return(o<1||o>7)&&(o=1),{hexagramNumber:e,hexagramName:i,yaoPosition:o>6?6:o,yaoName:t,serialNumber:a,theme:n["テーマ"]||"初期状態",description:n["説明"]||"初期の状態です。",keywords:n["キーワード"]||["開始"],modernInterpretation:n["現代解釈の要約"]||"新しい始まり。","卦名":i,"爻":t,"キーワード":n["キーワード"]||["開始"],"現代解釈の要約":n["現代解釈の要約"]||"新しい始まり。","S1_基本スコア":n["S1_基本スコア"]||50,"S2_ポテンシャル":n["S2_ポテンシャル"]||50,"S3_安定性スコア":n["S3_安定性スコア"]||50,"S4_リスク":n["S4_リスク"]||-35,"S5_主体性推奨スタンス":n["S5_主体性推奨スタンス"]||"中立","S6_変動性スコア":n["S6_変動性スコア"]||50,"S7_総合評価スコア":n["S7_総合評価スコア"]||50,rawData:n}}return console.error("❌ No matching hexagram found for input"),null}analyzeText(e){const i={length:e.length,emotionScore:0,urgencyScore:0,complexityScore:0,keywords:[]};["希望","成功","良い","楽しい","嬉しい","前向き"].forEach(t=>{e.includes(t)&&(i.emotionScore+=10)}),["不安","心配","困難","問題","失敗","悩み"].forEach(t=>{e.includes(t)&&(i.emotionScore-=10)});return["急ぐ","至急","緊急","すぐ","今すぐ","締切"].forEach(t=>{e.includes(t)&&(i.urgencyScore+=15)}),i.complexityScore=Math.min(100,e.length/5),i}calculateMatchScore(e,i){let t=0;return t+=.3*i["S1_基本スコア"],(e.emotionScore>0&&"能動"===i["S5_主体性推奨スタンス"]||e.emotionScore<0&&"受動"===i["S5_主体性推奨スタンス"])&&(t+=20),e.urgencyScore>30&&i["S6_変動性スコア"]>50&&(t+=15),e.complexityScore>50&&i["S3_安定性スコア"]>50&&(t+=10),t+=.1*i["S4_リスク"],t+=.2*i["S7_総合評価スコア"],t}generateThreeStageProcess(e){console.log("🎯 generateThreeStageProcess called with hexagram:",e),this.guidancePatterns||(console.log("⚠️ guidancePatterns not initialized, emergency initialization..."),this.initializeGuidanceSystem());const i={currentSituation:e,progressTheme:e?e.卦名:"現状分析",changeTheme:e?`${e.卦名}からの変化`:"変化の道",stages:[]},t={stageNumber:1,title:"第一段階：基本方針の選択",description:"現在の状況に対する基本的な態度を決める",choices:[],iChingGuidance:this.getStageGuidance(e,1)},n=this.guidancePatterns?.stage1?.conservative||{name:"保守的選択",keywords:["安定","継続","忍耐"],description:"現状を維持し、内なる力を蓄える",iChingPrinciple:"潜龍勿用 - 力を秘めて時を待つ"};t.choices.push({id:"conservative",...n,compatibility:this.calculateChoiceCompatibility(e,"conservative"),outcome:this.predictOutcome(e,"conservative",1)});const a=this.guidancePatterns?.stage1?.progressive||{name:"進歩的選択",keywords:["前進","革新","改革"],description:"新しい道を切り開く",iChingPrinciple:"見龍在田 - 才能を開花させる時"};t.choices.push({id:"progressive",...a,compatibility:this.calculateChoiceCompatibility(e,"progressive"),outcome:this.predictOutcome(e,"progressive",1)}),i.stages.push(t);const o={stageNumber:2,title:"第二段階：実行方法の選択",description:"選んだ方針をどのように実行するか",choices:[],iChingGuidance:this.getStageGuidance(e,2)},c=this.guidancePatterns?.stage2?.collaborative||{name:"協調的選択",keywords:["協力","調和","共生"],description:"他者と共に歩む道",iChingPrinciple:"群龍無首 - 皆で力を合わせる"};o.choices.push({id:"collaborative",...c,compatibility:this.calculateChoiceCompatibility(e,"collaborative"),outcome:this.predictOutcome(e,"collaborative",2)});const s=this.guidancePatterns?.stage2?.independent||{name:"独立的選択",keywords:["自立","独創","主導"],description:"自らの力で道を切り開く",iChingPrinciple:"飛龍在天 - 高い志を持って行動する"};o.choices.push({id:"independent",...s,compatibility:this.calculateChoiceCompatibility(e,"independent"),outcome:this.predictOutcome(e,"independent",2)}),i.stages.push(o);const r={stageNumber:3,title:"第三段階：タイミングの選択",description:"行動のタイミングと速度を決める",choices:[],iChingGuidance:this.getStageGuidance(e,3)},l=this.guidancePatterns?.stage3?.cautious||{name:"慎重な選択",keywords:["慎重","準備","観察"],description:"時を見て確実に進む",iChingPrinciple:"潜龍勿用 - 時機を待つ知恵"};r.choices.push({id:"cautious",...l,compatibility:this.calculateChoiceCompatibility(e,"cautious"),outcome:this.predictOutcome(e,"cautious",3)});const d=this.guidancePatterns?.stage3?.decisive||{name:"決断的選択",keywords:["決断","迅速","行動"],description:"機を逃さず素早く行動",iChingPrinciple:"亢龍有悔 - 勇気ある決断"};return r.choices.push({id:"decisive",...d,compatibility:this.calculateChoiceCompatibility(e,"decisive"),outcome:this.predictOutcome(e,"decisive",3)}),i.stages.push(r),console.log("✅ ThreeStageProcess generated successfully:",i),i}getStageGuidance(e,i){const t={principle:"",advice:"",warning:""},n=e["S5_主体性推奨スタンス"],a=e["S3_安定性スコア"],o=Math.abs(e["S4_リスク"]);switch(i){case 1:"能動"===n?(t.principle="陽の気が強い - 積極的な行動が吉",t.advice="今は行動を起こす好機。自信を持って前進せよ。"):(t.principle="陰の気が強い - 受容と観察が吉",t.advice="今は静観の時。状況をよく見極めてから動くべし。"),t.warning=o>50?"大きなリスクあり。慎重に。":"リスクは管理可能。";break;case 2:a>60?(t.principle="安定の卦 - 着実な進歩を",t.advice="基盤は固い。計画的に進めることで成功する。"):(t.principle="変動の卦 - 柔軟な対応を",t.advice="状況は流動的。臨機応変に対応することが重要。"),t.warning="固執は避け、状況に応じて調整せよ。";break;case 3:e["S6_変動性スコア"]>50?(t.principle="変化激しき時 - 機を見て動け",t.advice="タイミングが重要。好機を逃さぬよう準備せよ。"):(t.principle="安定の時 - 着実に進め",t.advice="焦る必要なし。自分のペースで進めばよい。"),t.warning="時機を誤れば、努力も水泡に帰す。"}return t}calculateChoiceCompatibility(e,i){let t=50;const n=e["S5_主体性推奨スタンス"],a=e["S3_安定性スコア"],o=e["S2_ポテンシャル"];switch(i){case"conservative":"受動"===n&&(t+=30),a>60&&(t+=20);break;case"progressive":"能動"===n&&(t+=30),o>60&&(t+=20);break;case"collaborative":e["キーワード"].includes("協力")&&(t+=25),t+=.3*a;break;case"independent":e["キーワード"].includes("自立")&&(t+=25),t+=.3*o;break;case"cautious":Math.abs(e["S4_リスク"])>50&&(t+=30);break;case"decisive":e["S6_変動性スコア"]>50&&(t+=30)}return Math.min(100,Math.max(0,t))}predictOutcome(e,i,t){const n=.5*e["S7_総合評価スコア"]+.5*this.calculateChoiceCompatibility(e,i);let a={probability:Math.round(n),description:"",nextStep:""};return n>70?(a.description="非常に良い選択。高い確率で望む結果が得られる。",a.nextStep="自信を持って進め。"):n>50?(a.description="適切な選択。努力次第で良い結果が期待できる。",a.nextStep="着実に実行することが重要。"):n>30?(a.description="挑戦的な選択。困難はあるが不可能ではない。",a.nextStep="十分な準備と覚悟が必要。"):(a.description="困難な選択。別の道を検討することも視野に。",a.nextStep="慎重に再考することを勧める。"),a}generate8Scenarios(e){const i=[];return[["conservative","collaborative","cautious"],["conservative","collaborative","decisive"],["conservative","independent","cautious"],["conservative","independent","decisive"],["progressive","collaborative","cautious"],["progressive","collaborative","decisive"],["progressive","independent","cautious"],["progressive","independent","decisive"]].forEach((t,n)=>{const a={id:n+1,path:t,title:this.generateScenarioTitle(t),description:this.generateScenarioDescription(t,e.currentSituation),probability:this.calculateScenarioProbability(t,e),characteristics:this.getScenarioCharacteristics(t),iChingReference:this.getScenarioIChingReference(t,e.currentSituation),visualPath:this.createVisualPath(t)};i.push(a)}),i.sort((e,i)=>i.probability-e.probability),i}generateScenarioTitle(e){return{"conservative,collaborative,cautious":"堅実な協調路線","conservative,collaborative,decisive":"協調的現状改革","conservative,independent,cautious":"独立的現状維持","conservative,independent,decisive":"独自の保守革新","progressive,collaborative,cautious":"慎重な共同革新","progressive,collaborative,decisive":"迅速な協調変革","progressive,independent,cautious":"計画的独立革新","progressive,independent,decisive":"独創的即断革新"}[e.join(",")]||"未定義の道"}generateScenarioDescription(e,i){let t="";"conservative"===e[0]?t+="現状を基盤としながら、":t+="新しい可能性を追求し、","collaborative"===e[1]?t+="周囲との協力関係を重視して、":t+="独自の道を切り開きながら、","cautious"===e[2]?t+="慎重に計画を進める道。":t+="機を見て素早く行動する道。";const n=i["キーワード"]||[];return n.length>0&&(t+=`特に「${n[0]}」の要素が重要となる。`),t}calculateScenarioProbability(e,i){let t=0,n=0;return e.forEach((e,a)=>{const o=i.stages[a].choices.find(i=>i.id===e);o&&o.outcome&&(t+=o.outcome.probability,n++)}),n>0?Math.round(t/n):50}getScenarioCharacteristics(e){const i=[];return e.forEach(e=>{"conservative"===e&&i.push("安定重視"),"progressive"===e&&i.push("革新重視"),"collaborative"===e&&i.push("協調性"),"independent"===e&&i.push("独立性"),"cautious"===e&&i.push("慎重さ"),"decisive"===e&&i.push("決断力")}),i}getScenarioIChingReference(e,i){const t={"conservative,collaborative,cautious":"地山謙 - 謙虚に協力する","conservative,collaborative,decisive":"地天泰 - 安定の中の決断","conservative,independent,cautious":"山天大畜 - 内に力を蓄える","conservative,independent,decisive":"天山遯 - 退いて機を待つ","progressive,collaborative,cautious":"風天小畜 - 小さく蓄えて進む","progressive,collaborative,decisive":"天火同人 - 志を同じくする","progressive,independent,cautious":"火天大有 - 大いに保つ","progressive,independent,decisive":"乾為天 - 天の道を行く"}[e.join(",")]||i["卦名"];return{hexagram:t.split(" - ")[0],meaning:t.split(" - ")[1]||i["現代解釈の要約"]}}createVisualPath(e){return{stage1:{choice:e[0],position:"conservative"===e[0]?"left":"right",color:"conservative"===e[0]?"#3B82F6":"#10B981"},stage2:{choice:e[1],position:"collaborative"===e[1]?"left":"right",color:"collaborative"===e[1]?"#F59E0B":"#8B5CF6"},stage3:{choice:e[2],position:"cautious"===e[2]?"left":"right",color:"cautious"===e[2]?"#EF4444":"#06B6D4"}}}recordChoice(e,i){this.choiceHistory.push({stage:e,choice:i,timestamp:(new Date).toISOString()}),"undefined"!=typeof localStorage&&localStorage.setItem("iching_choice_history",JSON.stringify(this.choiceHistory))}getChoiceHistory(){if("undefined"!=typeof localStorage){const e=localStorage.getItem("iching_choice_history");e&&(this.choiceHistory=JSON.parse(e))}return this.choiceHistory}createEmergencyThreeStageProcess(e){console.log("🆘 Creating emergency threeStageProcess...");const i=e?.卦名||"現状分析";return{currentSituation:e,progressTheme:`${i}からの道筋`,changeTheme:`${i}からの変化`,stages:[{stageNumber:1,title:"第一段階：基本方針の選択",description:"現在の状況に対する基本的な態度を決める",choices:[{id:"conservative",name:"保守的選択",keywords:["安定","継続","忍耐"],description:"現状を維持し、内なる力を蓄える",iChingPrinciple:"潜龍勿用 - 力を秘めて時を待つ",compatibility:75,outcome:{probability:70,description:"着実な進歩が期待できる",nextStep:"慎重に準備を進める"}},{id:"progressive",name:"進歩的選択",keywords:["前進","革新","改革"],description:"新しい道を切り開く",iChingPrinciple:"見龍在田 - 才能を開花させる時",compatibility:65,outcome:{probability:60,description:"新しい可能性が開ける",nextStep:"勇気を持って前進する"}}],iChingGuidance:{principle:"時機を見極める",advice:"現状をよく観察してから行動せよ",warning:"焦りは禁物。準備を怠らず。"}},{stageNumber:2,title:"第二段階：実行方法の選択",description:"選んだ方針をどのように実行するか",choices:[{id:"collaborative",name:"協調的選択",keywords:["協力","調和","共生"],description:"他者と共に歩む道",iChingPrinciple:"群龍無首 - 皆で力を合わせる",compatibility:70,outcome:{probability:75,description:"協力により大きな成果が得られる",nextStep:"チームワークを重視する"}},{id:"independent",name:"独立的選択",keywords:["自立","独創","主導"],description:"自らの力で道を切り開く",iChingPrinciple:"飛龍在天 - 高い志を持って行動する",compatibility:60,outcome:{probability:65,description:"独自の道が開ける",nextStep:"自信を持って進む"}}],iChingGuidance:{principle:"調和と独立のバランス",advice:"他者との関係を大切にしながら、自分の道を歩め",warning:"孤立は避け、適切な協力関係を築くべし"}},{stageNumber:3,title:"第三段階：タイミングの選択",description:"行動のタイミングと速度を決める",choices:[{id:"cautious",name:"慎重な選択",keywords:["慎重","準備","観察"],description:"時を見て確実に進む",iChingPrinciple:"潜龍勿用 - 時機を待つ知恵",compatibility:80,outcome:{probability:80,description:"着実で確実な成果を得られる",nextStep:"十分な準備で臨む"}},{id:"decisive",name:"決断的選択",keywords:["決断","迅速","行動"],description:"機を逃さず素早く行動",iChingPrinciple:"亢龍有悔 - 勇気ある決断",compatibility:55,outcome:{probability:55,description:"迅速な行動で機会を掴む",nextStep:"決断力を発揮する"}}],iChingGuidance:{principle:"タイミングこそ全て",advice:"機を見るに敏であれ。しかし焦りは禁物。",warning:"時期を誤れば、良い計画も失敗に終わる"}}]}}async performCompleteAnalysis(e){this.isInitialized||await this.initialize();const i=this.calculateSituationHexagram(e);if(!i)return console.error("❌ Failed to calculate situation hexagram"),null;console.log("🎯 [CRITICAL DEBUG] Generating threeStageProcess...");let t=this.generateThreeStageProcess(i);console.log("🎯 [CRITICAL DEBUG] threeStageProcess generated:",{hasProcess:!!t,stagesCount:t?.stages?.length,processData:t}),t&&t.stages&&0!==t.stages.length||(console.warn("⚠️ threeStageProcess generation failed, creating emergency fallback data..."),t=this.createEmergencyThreeStageProcess(i),console.log("🆘 Emergency threeStageProcess created:",t)),console.log("🎯 [CRITICAL DEBUG] Generating 8 scenarios...");const n=this.generate8Scenarios(t);console.log("🎯 [CRITICAL DEBUG] Scenarios generated:",{hasScenarios:!!n,scenariosCount:n?.length});const a={inputText:e,currentSituation:i,threeStageProcess:t,eightScenarios:n,timestamp:(new Date).toISOString()};return console.log("✅ Complete analysis performed:",a),a}}"undefined"!=typeof window&&(window.IChingGuidanceEngine=IChingGuidanceEngine,window.iChingGuidance=new IChingGuidanceEngine,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.iChingGuidance.initialize()}):window.iChingGuidance.initialize()),console.log("✅ IChingGuidanceEngine loaded")}("undefined"!=typeof window&&window);