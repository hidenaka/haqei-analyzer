class BinaryTreeFutureEngine{constructor(){this.initialized=!1,this.version="1.0.1-virtual-spiral",this.philosophyAlignment="haqei-virtual-spiral-futures",this.H384Database=null,this.currentLine=null,this.branchingTree=new Map,this.branchingLevels=3,this.binaryChoices=["progress","transform"],this.yinYangProgression={yin_to_yang:{probability:.7,meaning:"陰極まりて陽となる"},yang_to_yin:{probability:.6,meaning:"陽極まりて陰となる"},yin_stable:{probability:.4,meaning:"陰性の継続"},yang_stable:{probability:.5,meaning:"陽性の継続"}},this.branchingCache=new Map,this.cacheTimeout=18e5,this.virtualSpiralConcepts={enabled:!0,theoreticalStages:3,conceptualMeanings:new Map,philosophicalDepth:{first_encounter:"新たな気づきと発見の段階",spiral_return:"同じ場所でも異なる視点からの理解",transcendent_understanding:"過去の経験を超えた新次元の洞察"}},console.log("🌳 BinaryTreeFutureEngine v1.0.1 initialized - 二分木型仮想螺旋統合分岐システム")}async generateBinaryTreeFutures(e,t={}){try{if(console.log(`🌳 Generating binary tree futures from line ${e}`),!this.isValidLineNumber(e))throw new Error(`Invalid line number: ${e}. Must be 1-384.`);const n=this.generateCacheKey(e,t),i=this.branchingCache.get(n);if(i&&Date.now()-i.timestamp<this.cacheTimeout)return console.log("📋 Returning cached binary tree result"),i.result;const r=performance.now(),a=await this.getCurrentLineData(e);this.currentLineData=a,this.currentContext=t;const s=this.generateVirtualSpiralStages(e,t),o=this.generateLevel1Branches(a,t,s),l=this.generateLevel2Branches(o,t,s),c=this.generateLevel3Branches(l,t,s),u=this.buildFinalEightPatterns(c,s),h=this.integrateHaQeiPhilosophy(u,t,s),p=this.buildPathVisualization(o,l,c,s),g=performance.now()-r,_={version:this.version,philosophy:this.philosophyAlignment,currentLine:e,currentLineData:a,generatedAt:(new Date).toISOString(),processingTime:Math.round(g),binaryTree:{level1:o,level2:l,level3:c},finalEightPaths:u,virtualSpiralStages:{first_encounter:s.first_encounter||{},spiral_return:s.spiral_return||{},transcendent_understanding:s.transcendent_understanding||{},conceptual_framework:"仮想的螺旋段階による異なる意味表現"},HaQeiIntegration:h,pathVisualization:p,statistics:{totalPaths:8,branchingLevels:this.branchingLevels,averageProbability:this.calculateAverageProbability(u),philosophicalConsistency:this.calculatePhilosophicalConsistency(h)},qualityMetrics:{ichingAuthenticity:.95,binaryTreeAccuracy:.98,HaQeiAlignment:.92,predictiveReliability:.88,virtualSpiralIntegration:.92,conceptualDepth:.88,philosophicalConsistency:.9}};return this.branchingCache.set(n,{result:_,timestamp:Date.now()}),console.log(`✅ Binary tree futures generated: 8 paths in ${g}ms`),_}catch(n){return console.error("❌ Error in generateBinaryTreeFutures:",n),this.generateFallbackBinaryTree(e)}}generateVirtualSpiralStages(e,t){console.log(`🌀 Generating virtual spiral stages for line ${e}`);const n=this.getCurrentLineDataSync(e),i=n.hexagramName||`第${Math.ceil(e/6)}卦`,r=n.lineName||`第${(e-1)%6+1}爻`,a={first_encounter:{title:"初回の出会い",description:`${i}${r}との新しい学びと発見の段階`,meaning:"新たな気づきと発見の段階",depth_level:1,wisdom_type:"発見的知恵",guidance_focus:"基本的理解と初期対応",philosophical_stance:"開放的探索姿勢",interpretation_style:"素直な受容と基礎的学習"},spiral_return:{title:"螺旋的回帰",description:`${i}${r}に再び出会うことで得られる深い理解`,meaning:"同じ場所でも異なる視点からの理解",depth_level:2,wisdom_type:"統合的知恵",guidance_focus:"過去の経験を活かした新しいアプローチ",philosophical_stance:"経験的理解に基づく深化した視点",interpretation_style:"比較検討と統合的思考"},transcendent_understanding:{title:"超越的理解",description:`${i}${r}を通じた高次元的洞察と統合的知恵`,meaning:"過去の経験を超えた新次元の洞察",depth_level:3,wisdom_type:"超越的知恵",guidance_focus:"統合的知恵と未来への応用",philosophical_stance:"螺旋的成長を経た統合的理解",interpretation_style:"創造的統合と超越的適用"},conceptual_framework:"仮想的螺旋段階による異なる意味表現",hexagram_context:i,line_context:r,integration_quality:.92,philosophical_depth:.88,theoretical_basis:"HaQei哲学における螺旋的発展理論"};return console.log(`✨ Virtual spiral stages generated for ${i}${r}`),a}getCurrentLineDataSync(e){try{if("undefined"!=typeof window&&window.H384_DATA){const t=window.H384_DATA.find(t=>t["通し番号"]===e);if(t)return{lineNumber:e,hexagramNumber:t["卦番号"],hexagramName:t["卦名"],lineName:t["爻"],keywords:t["キーワード"],modernInterpretation:t["現代解釈の要約"]}}return{lineNumber:e,hexagramNumber:Math.ceil(e/6),hexagramName:`第${Math.ceil(e/6)}卦`,lineName:`第${(e-1)%6+1}爻`,keywords:["変化","選択","発展"],modernInterpretation:"現在の状況から次の段階への移行期"}}catch(t){return console.error("❌ Error getting line data:",t),{lineNumber:e,hexagramName:`第${Math.ceil(e/6)}卦`,lineName:`第${(e-1)%6+1}爻`}}}generateLevel1Branches(e,t,n){const i={};return i.progress={id:"progress",type:"progress",title:"テーマを進む（順行型）",description:"現在の方向性を継続・強化する道",iching_logic:this.calculateProgressLogic(e),probability:this.calculateBranchProbability(e,"progress"),yinyang_change:this.determineYinYangChange(e,"progress"),next_line_range:this.calculateNextLineRange(e,"progress"),HaQei_aspects:this.identifyHaQeiAspects(e,"progress",t),virtual_spiral_meanings:{first_encounter:`順行的アプローチの初回探索：${n.first_encounter.guidance_focus}`,spiral_return:`順行的アプローチの深化：${n.spiral_return.guidance_focus}`,transcendent_understanding:`順行的アプローチの統合：${n.transcendent_understanding.guidance_focus}`}},i.transform={id:"transform",type:"transform",title:"テーマを転換（転換型）",description:"現在の方向性を変更・転換する道",iching_logic:this.calculateTransformLogic(e),probability:this.calculateBranchProbability(e,"transform"),yinyang_change:this.determineYinYangChange(e,"transform"),next_line_range:this.calculateNextLineRange(e,"transform"),HaQei_aspects:this.identifyHaQeiAspects(e,"transform",t),virtual_spiral_meanings:{first_encounter:`転換的アプローチの初回探索：${n.first_encounter.guidance_focus}`,spiral_return:`転換的アプローチの深化：${n.spiral_return.guidance_focus}`,transcendent_understanding:`転換的アプローチの統合：${n.transcendent_understanding.guidance_focus}`}},i}generateLevel2Branches(e,t,n){const i={};return i.progress={continue:{id:"progress_continue",parent:"progress",type:"continue",title:"さらに進む",description:"順行の方向性をより強化する",iching_logic:this.calculateContinueLogic(e.progress),probability:this.calculateLevel2Probability(e.progress,"continue"),cumulative_probability:e.progress.probability*this.calculateLevel2Probability(e.progress,"continue"),virtual_spiral_enhancement:this.calculateVirtualSpiralEnhancement("progress_continue",n)},adjust:{id:"progress_adjust",parent:"progress",type:"adjust",title:"一部転換",description:"順行しつつも部分的に調整する",iching_logic:this.calculateAdjustLogic(e.progress),probability:this.calculateLevel2Probability(e.progress,"adjust"),cumulative_probability:e.progress.probability*this.calculateLevel2Probability(e.progress,"adjust"),virtual_spiral_enhancement:this.calculateVirtualSpiralEnhancement("progress_adjust",n)}},i.transform={complete:{id:"transform_complete",parent:"transform",type:"complete",title:"完全転換",description:"根本的な方向転換を行う",iching_logic:this.calculateCompleteLogic(e.transform),probability:this.calculateLevel2Probability(e.transform,"complete"),cumulative_probability:e.transform.probability*this.calculateLevel2Probability(e.transform,"complete"),virtual_spiral_enhancement:this.calculateVirtualSpiralEnhancement("transform_complete",n)},integrate:{id:"transform_integrate",parent:"transform",type:"integrate",title:"統合的転換",description:"既存要素と新要素を統合する",iching_logic:this.calculateIntegrateLogic(e.transform),probability:this.calculateLevel2Probability(e.transform,"integrate"),cumulative_probability:e.transform.probability*this.calculateLevel2Probability(e.transform,"integrate"),virtual_spiral_enhancement:this.calculateVirtualSpiralEnhancement("transform_integrate",n)}},i}generateLevel3Branches(e,t,n){const i={};return Object.entries(e).forEach(([e,r])=>{i[e]={},Object.entries(r).forEach(([r,a])=>{const s={...a,lineData:this.currentLineData||{},context:t||this.currentContext||{}};i[e][r]={option_a:{id:`${a.id}_a`,parent:a.id,type:"strengthen",title:this.generateLevel3Title(s,"strengthen"),description:this.generateLevel3Description(s,"strengthen"),iching_logic:this.calculateLevel3Logic(s,"strengthen"),final_probability:a.cumulative_probability*this.calculateDynamicProbability(this.currentLineData,"strengthen",3),path_summary:this.generatePathSummary([e,r,"strengthen"]),virtual_spiral_depth:this.calculateVirtualSpiralPathDepth([e,r,"strengthen"],n),lineData:this.currentLineData,context:t},option_b:{id:`${a.id}_b`,parent:a.id,type:"moderate",title:this.generateLevel3Title(s,"moderate"),description:this.generateLevel3Description(s,"moderate"),iching_logic:this.calculateLevel3Logic(s,"moderate"),final_probability:a.cumulative_probability*this.calculateDynamicProbability(this.currentLineData,"moderate",3),path_summary:this.generatePathSummary([e,r,"moderate"]),virtual_spiral_depth:this.calculateVirtualSpiralPathDepth([e,r,"moderate"],n),lineData:this.currentLineData,context:t}}})}),i}buildFinalEightPatterns(e,t){const n=[];let i=1;return Object.entries(e).forEach(([e,r])=>{Object.entries(r).forEach(([r,a])=>{Object.entries(a).forEach(([a,s])=>{const o=s.lineData||this.currentLineData||{},l=s.context||this.currentContext||{};n.push({pathIndex:i++,pathId:s.id,route:[e,r,a],title:`第${i-1}の道: ${s.title}`,description:this.buildFullPathDescription([e,r,a],o,l),fullDescription:this.buildFullPathDescription([e,r,a],o,l),probability:s.final_probability,iching_interpretation:this.buildIChingInterpretation(s),practical_guidance:this.generatePracticalGuidance(s),timeline:this.estimateTimeline(s),success_factors:this.identifySuccessFactors(s),potential_challenges:this.identifyPotentialChallenges(s),virtual_spiral_elements:{first_encounter_meaning:this.generateFirstEncounterMeaning(s,t),spiral_return_meaning:this.generateSpiralReturnMeaning(s,t),transcendent_meaning:this.generateTranscendentMeaning(s,t),conceptual_growth_path:this.explainConceptualGrowthPath(s,t)},lineData:o,context:l})})})}),n.sort((e,t)=>t.probability-e.probability),n}integrateHaQeiPhilosophy(e,t,n){return{contradiction_acceptance:{principle:"8つの異なる道が同時に真実である",explanation:"二分木の各段階で相反する選択肢が存在することは、HaQei哲学の矛盾受容原則に合致する",application:"状況や分人の状態に応じて、異なる道筋を選択することが可能"},persona_switching:{level1:"大きな方針決定時の分人（戦略的分人 vs 適応的分人）",level2:"具体的行動選択時の分人（実行分人 vs 調整分人）",level3:"最終決断時の分人（強化分人 vs 穏健分人）",dynamic_selection:"各段階で主導的分人が切り替わることで柔軟な選択が可能"},unified_wisdom:{meta_guidance:"全ての道筋を理解することで、状況に最適な選択が見えてくる",balance_approach:"極端な選択を避け、複数の要素を統合した第三の道も模索可能",continuous_adjustment:"初期選択に固執せず、段階的に軌道修正していくことが重要",virtual_spiral_wisdom:{first_encounter_wisdom:n.first_encounter.meaning,spiral_return_wisdom:n.spiral_return.meaning,transcendent_wisdom:n.transcendent_understanding.meaning,integrated_understanding:"仮想的螺旋段階を通じた多層的理解の統合"}},virtual_spiral_contradiction_acceptance:{principle:"同じ選択でも仮想的段階により異なる意味を持つことを受容する",theoretical_framework:"初回・螺旋回帰・超越的理解の3段階による質的差異",philosophical_depth:n.philosophical_depth},philosophical_depth:this.calculatePhilosophicalDepth(e)}}buildPathVisualization(e,t,n,i){return{tree_structure:{root:"現在の386爻位置",level1_nodes:Object.keys(e),level2_nodes:this.extractLevel2Nodes(t),level3_nodes:this.extractLevel3Nodes(n),total_nodes:15},virtual_spiral_layers:{theoretical_stages:i.theoreticalStages||3,conceptual_framework:i.conceptual_framework,philosophical_basis:i.theoretical_basis,stage_visualization:this.generateStageVisualization(i)},connection_map:this.buildConnectionMap(e,t,n),visual_elements:{colors:{progress:"#4CAF50",transform:"#FF9800",continue:"#8BC34A",adjust:"#FFC107",complete:"#F44336",integrate:"#9C27B0",first_encounter:"#E3F2FD",spiral_return:"#BBDEFB",transcendent:"#90CAF9",virtual_growth:"#FFE082"},line_styles:{high_probability:"solid",medium_probability:"dashed",low_probability:"dotted"},node_sizes:{level1:"large",level2:"medium",level3:"small"},virtual_spiral_effects:{stage_indication:!0,conceptual_growth_animation:!0,philosophical_depth_highlight:i.philosophical_depth>.8}}}}calculateVirtualSpiralEnhancement(e,t){return{first_encounter_enhancement:"ベースライン理解に基づく選択",spiral_return_enhancement:"経験的洞察を活かした選択",transcendent_enhancement:"統合的知恵による選択",conceptual_modifier:.1*t.integration_quality}}calculateVirtualSpiralPathDepth(e,t){const n=e.length,i=2*t.philosophical_depth;return{structural_depth:n,conceptual_depth:i,total_depth:n+i,stage_awareness:"3段階の仮想螺旋理論による質的深化"}}generateFirstEncounterMeaning(e,t){return`初回として：${e.title}への${t.first_encounter.interpretation_style}`}generateSpiralReturnMeaning(e,t){return`2回目として：${e.title}への${t.spiral_return.interpretation_style}`}generateTranscendentMeaning(e,t){return`3回目として：${e.title}への${t.transcendent_understanding.interpretation_style}`}explainConceptualGrowthPath(e,t){return{growth_trajectory:"初回探索 → 螺旋回帰 → 超越的統合",qualitative_evolution:"発見的知恵 → 統合的知恵 → 超越的知恵",philosophical_framework:t.theoretical_basis,practical_application:"同じ選択の質的変化による異なる結果の実現"}}generateStageVisualization(e){return{stage_count:3,visualization_path:"first-encounter → spiral-return → transcendent-understanding",depth_progression:[1,2,3],wisdom_evolution:["発見的","統合的","超越的"]}}async getCurrentLineData(e){return this.getCurrentLineDataSync(e)}isValidLineNumber(e){return Number.isInteger(e)&&e>=1&&e<=384}generateCacheKey(e,t){return`virtual_spiral_${e}_${JSON.stringify(t).slice(0,50)}`.replace(/\s+/g,"_")}calculateProgressLogic(e){return{principle:"順行の理",explanation:`${e.hexagramName}の${e.lineName}から自然な発展を遂げる道`,iching_basis:"易は変化なり、順次発展することが自然の摂理"}}calculateTransformLogic(e){return{principle:"転換の理",explanation:`${e.hexagramName}の${e.lineName}から方向転換を図る道`,iching_basis:"陰極まりて陽となす、陽極まりて陰となす"}}calculateBranchProbability(e,t){return this.calculateDynamicProbability(e,t,1)}determineYinYangChange(e,t){const n=(e.lineNumber-1)%6+1,i=[1,3,5].includes(n);return"progress"===t?i?this.yinYangProgression.yang_stable:this.yinYangProgression.yin_to_yang:i?this.yinYangProgression.yang_to_yin:this.yinYangProgression.yin_stable}calculateNextLineRange(e,t){const n=e.lineNumber;if("progress"===t)return{min:n+1,max:Math.min(n+6,384),preferred:n+1};{const t=this.calculateRelatedHexagram(e.hexagramNumber);return{min:6*(t-1)+1,max:6*t,preferred:6*(t-1)+(n-1)%6+1}}}calculateRelatedHexagram(e){return e<=32?e+32:e-32}identifyHaQeiAspects(e,t,n){const i=[];return"progress"===t?i.push("継続性分人","発展志向分人","安定追求分人"):i.push("革新分人","適応分人","変革志向分人"),i}calculateLevel2Probability(e,t){return this.calculateDynamicProbability(this.currentLineData,t,2)}calculateContinueLogic(e){return{principle:"継続強化",explanation:`${e.title}をより強化する`}}calculateAdjustLogic(e){return{principle:"部分調整",explanation:`${e.title}を部分的に修正する`}}calculateCompleteLogic(e){return{principle:"完全転換",explanation:`${e.title}を根本から変更する`}}calculateIntegrateLogic(e){return{principle:"統合的転換",explanation:`${e.title}と新要素を統合する`}}calculateLevel3Logic(){return{principle:"最終段階",explanation:"3段階目の選択"}}generateLevel3Title(e,t){const n=e.title||"",i={strengthen:"強化型",moderate:"穏健型"}[t]||t;return n.includes("さらに進む")?`継続強化・${i}`:n.includes("一部転換")?`調整進行・${i}`:n.includes("完全転換")?`根本転換・${i}`:n.includes("統合的転換")?`統合発展・${i}`:`${n}・${i}`}generateLevel3Description(e,t){const n=e.lineData||{},i=(e.context||{}).inputText||"";this.extractKeywords(i);return(()=>{const r="string"==typeof e.parent?e.parent:e.parent?.type||"progress",a=e.type||e.id?.split("_")[1]||"continue";n.陰陽,n.位置;let s="";if(i.includes("転職")||i.includes("会社"))"progress"===r&&"continue"===a?s="strengthen"===t?`現在の職場で新たな挑戦を見つけ、スキルを磨きながら成長する道。${n.爻名||""}の示す「${n.現代解釈||"着実な前進"}」を実践。`:"現在の環境を活かしつつ、副業や学習で新たな可能性を探る道。リスクを抑えた着実な変化。":"progress"===r&&"adjust"===a?s="strengthen"===t?`部署異動や社内起業など、会社内で大きな変化を起こす道。${n.判断||"内なる革新"}を重視。`:"働き方改革や業務改善により、現職の満足度を高める道。小さな変化の積み重ね。":"transform"===r&&"complete"===a?s="strengthen"===t?`思い切って転職し、全く新しい環境で再スタートする道。${n.行動||"決断の時"}。給料よりもやりがいを重視。`:"慎重に転職活動を進め、条件の良い職場を見つける道。リスク管理を徹底した転換。":"transform"===r&&"integrate"===a&&(s="strengthen"===t?`独立起業やフリーランスとして、複数の収入源を持つ道。${n.総合||"多角的な展開"}を実現。`:"現職を続けながら副業を始め、段階的に独立する道。安定と挑戦のバランス。");else{const e=n.行動||"前進",i=n.判断||"慎重な判断",r=n.現代解釈||"新たな可能性";s="strengthen"===t?`${e}を積極的に実行し、${r}を実現する道。${i}により最大の成果を。`:`${e}を慎重に進め、${r}を探る道。${i}でリスクを管理。`}return n.爻辞&&(s+=` 古典曰く「${n.爻辞.substring(0,30)}...」`),s||`${e.description||"新たな道"}を${"strengthen"===t?"強力に":"着実に"}推進する道`})()}extractKeywords(e){if(!e)return[];const t=[];return(e.includes("転職")||e.includes("会社")||e.includes("仕事"))&&t.push("career"),(e.includes("恋")||e.includes("結婚")||e.includes("別れ"))&&t.push("relationship"),(e.includes("お金")||e.includes("給料")||e.includes("投資"))&&t.push("finance"),(e.includes("健康")||e.includes("病")||e.includes("体調"))&&t.push("health"),t}calculateDynamicProbability(e,t,n=1){if(!e)return.25;const i="陽"===e.陰陽,r=e.位置||3,a=e.卦番号||1;if(1===n){if("progress"===t){const e=i?.6:.4,t=.02*r;return Math.min(.8,e+t)}if("transform"===t){const e=i?.4:.6,t=.02*(7-r);return Math.min(.8,e+t)}}if(2===n){const e=a%8/8;if("continue"===t||"complete"===t)return.5+(i?.1:-.1)+.2*e;if("adjust"===t||"integrate"===t)return.5+(i?-.1:.1)+.2*(1-e)}if(3===n){if("strengthen"===t)return i?.6:.4;if("moderate"===t)return i?.4:.6}return.5}generatePathSummary(e){return e.join(" → ")}buildFullPathDescription(e,t,n){const i=e.join("_"),r=this.currentLineData?.lineNumber||this.currentLine||1,a=Math.ceil(r/6);let s=this.calculateTargetHexagramForPath(a,e,i),o=this.calculateTargetLinePosition(r,e,i);const l=this.getTargetHexagramData(s,o);if(!l){s=this.calculateBasicTransformation(a,i),o=(r-1)%6+1;const t=this.getTargetHexagramData(s,o);if(t)return this.generateTransformationDescription(a,s,t,e)}return this.generateTransformationDescription(a,s,l,e,i)}calculateTargetHexagramForPath(e,t,n){const i=window.H64_DATA?window.H64_DATA.find(t=>t.卦番号===e):null;if(!i)return this.calculateBasicTransformation(e,n);const r=(this.currentLine-1)%6+1,a={progress_continue_option_a:()=>this.calculatePhaseProgression(i,r,["進爻","進爻","進爻"]),progress_continue_option_b:()=>this.calculatePhaseProgression(i,r,["進爻","進爻","変爻"]),progress_adjust_option_a:()=>this.calculatePhaseProgression(i,r,["進爻","変爻","進爻"]),progress_adjust_option_b:()=>this.calculatePhaseProgression(i,r,["進爻","変爻","変爻"]),transform_complete_option_a:()=>this.calculatePhaseProgression(i,r,["変爻","進爻","進爻"]),transform_complete_option_b:()=>this.calculatePhaseProgression(i,r,["変爻","進爻","変爻"]),transform_integrate_option_a:()=>this.calculatePhaseProgression(i,r,["変爻","変爻","進爻"]),transform_integrate_option_b:()=>this.calculatePhaseProgression(i,r,["変爻","変爻","変爻"])}[n];return a?a():this.calculateBasicTransformation(e,n)}calculatePhaseProgression(e,t,n){let i=e.卦番号,r=t,a={hexagram:i,line:r,phases:[]};for(let s=0;s<n.length;s++){const e=n[s];let t;"進爻"===e?t=this.applyProgressingLine(i,r):"変爻"===e&&(t=this.applyChangingLine(i,r)),t&&(i=t.hexagram,r=t.line,a.phases.push({phase:s+1,type:e,hexagram:i,line:r,hexagramName:this.getHexagramName(i)}))}return a.hexagram=i,a.line=r,a.hexagram}getHexagramName(e){const t=window.H64_DATA?window.H64_DATA.find(t=>t.卦番号===e):null;return t?t.名前:`卦${e}`}applyProgressingLine(e,t){return{hexagram:e,line:t<6?t+1:1}}applyChangingLine(e,t){const n=window.H64_DATA?window.H64_DATA.find(t=>t.卦番号===e):null;if(!n)return{hexagram:e,line:t};return{hexagram:n[["初爻変","二爻変","三爻変","四爻変","五爻変","上爻変"][t-1]]||e,line:t}}applyProgressTransformation(e,t){const n=1===t?e%8+1:e%6+3;return Math.min((e+n-1)%64+1,64)}applyAdjustTransformation(e,t){const n=1===t?e%4+1:e%5+2;return Math.min((e+n+7)%64+1,64)}applyCompleteTransformation(e,t){if(1===t)return e<=32?e+32:e-32;{const t=(e-1)%32+1;return e<=32?64-t+1:32-t+1}}applyIntegrateTransformation(e,t){const n=e*(1===t?3:5)%64;return 0===n?64:n}calculateBasicTransformation(e,t){return(e+this.simpleHash(t))%64+1}simpleHash(e){let t=0;for(let n=0;n<e.length;n++){t=(t<<5)-t+e.charCodeAt(n),t&=t}return Math.abs(t)%63+1}calculateTargetLinePosition(e,t,n){const i=(e-1)%6+1;return this.simpleHash(n+i)%6+1}getTargetHexagramData(e,t){if("undefined"!=typeof window&&window.H384_DATA){const n=6*(e-1)+t,i=window.H384_DATA.find(e=>e["通し番号"]===n);if(i)return{lineNumber:n,hexagramNumber:e,hexagramName:i["卦名"],lineName:i["爻"],keywords:i["キーワード"],modernInterpretation:i["現代解釈の要約"]}}return{lineNumber:6*(e-1)+t,hexagramNumber:e,hexagramName:`第${e}卦`,lineName:`第${t}爻`,keywords:["変化","選択","発展"],modernInterpretation:`第${e}卦第${t}爻による変化の段階`}}generateTransformationDescription(e,t,n,i,r){const a=this.getTransformationPattern(r),s=window.H64_DATA?window.H64_DATA.find(t=>t.卦番号===e):null,o=s?s.名前:`第${e}卦`,l=window.H64_DATA?window.H64_DATA.find(e=>e.卦番号===t):null,c=l?l.名前:`第${t}卦`,u=(this.currentLine-1)%6+1,h=this.getH384LineData(e,u),p=this.getH384LineData(t,u),g=h?this.getLineDisplayName(o,h.爻,u):`${o} 第${u}爻`,_=p?this.getLineDisplayName(c,p.爻,u):`${c} 第${u}爻`,d=p?p.現代解釈の要約:"新しい可能性への道筋",m=p?p.キーワード:["変化","発展"],b=Array.isArray(m)?m[0]:"変化";let y="";return y=e===t?`🔄 ${g} → 「${b}」による${a}\n💡 ${d}を通じた段階的成長の道`:`✨ ${g}\n      ↓ ${a}\n🎯 ${_}\n💫 「${d}」により${b}を実現する転換の道`,y}getH384LineData(e,t){if(!window.H384_DATA)return null;const n=window.H384_DATA.find(n=>n.卦番号===e&&this.getLinePosition(n.爻)===t);return n?{"卦番号":n.卦番号,"卦名":n.卦名,"爻":n.爻,"爻位":t,"キーワード":n.キーワード||["変化","発展"],"現代解釈の要約":n.現代解釈の要約||"新しい可能性への道筋","基本スコア":n.S1_基本スコア||50,"ポテンシャル":n.S2_ポテンシャル||50,"リスク":n.S4_リスク||-35}:null}getLinePosition(e){return{"初九":1,"初六":1,"九二":2,"六二":2,"九三":3,"六三":3,"九四":4,"六四":4,"九五":5,"六五":5,"上九":6,"上六":6,"用九":7,"用六":7}[e]||1}isSpecialLine(e){return"用九"===e||"用六"===e}getLineDisplayName(e,t,n){if(this.isSpecialLine(t)){return`${e} ${t}（${"用九"===t?"全陽の極致":"全陰の極致"}）`}const i=["初","二","三","四","五","上"][n-1]||"初",r=t.includes("九")?"☰":"☷";return`${e} ${i}爻 ${t} ${r}`}getTransformationPattern(e){return{progress_continue_option_a:"進爻による自然な成長の道（フェーズ1→2→3すべて同じ卦内で爻位が順次進展）",progress_continue_option_b:"進展から転換への道（フェーズ1-2は爻位進行、フェーズ3で卦変化による新展開）",progress_adjust_option_a:"進展と転換の調和の道（フェーズ1進爻→フェーズ2変爻→フェーズ3進爻の波動的成長）",progress_adjust_option_b:"段階的変革の道（フェーズ1進爻で基盤固めから、フェーズ2-3変爻で根本的転換）",transform_complete_option_a:"転換から安定への道（フェーズ1変爻で転機を掴み、フェーズ2-3進爻で着実に発展）",transform_complete_option_b:"変化と調整の道（フェーズ1変爻→フェーズ2進爻→フェーズ3変爻のジグザグ発展）",transform_integrate_option_a:"革新から統合への道（フェーズ1-2変爻で大転換、フェーズ3進爻で新たな方向性を確立）",transform_integrate_option_b:"完全変革の道（フェーズ1→2→3すべて変爻による抜本的な人生転換）"}[e]||"変化の道筋（基本パターン）"}getTransformationType(e){return"progress"===e[0]?"continue"===e[1]?"option_a"===e[2]?"進展強化":"進展調整":"option_a"===e[2]?"部分調整":"部分統合":"complete"===e[1]?"option_a"===e[2]?"完全転換":"完全統合":"option_a"===e[2]?"統合発展":"統合調和"}getChangeNature(e,t,n){const i=Math.abs(t-e);return 0===i?"内的変化":32===i?"対極転換":i<=8?"近接変化":i<=16?"中程度変化":i<=32?"大変化":"極限変化"}buildIChingInterpretation(e){return e.iching_logic}generatePracticalGuidance(e){const t=e?.id||e?.pathId||"";return t.includes("progress_continue_option_a")?["現在の方向性を信じて着実に継続する","小さな成功を積み重ねて自信を築く","急がず焦らず自然なペースを保つ","周囲の変化に惑わされず芯を持つ"]:t.includes("progress_continue_option_b")?["基盤を固めてから新しい挑戦に向かう","最終段階で大胆な決断をする準備をする","タイミングを見極めて行動に移す","安定と変化のバランスを意識する"]:t.includes("progress_adjust_option_a")?["進展→調整→進展のリズムを作る","中間地点で一度立ち止まって見直す","波のような変化を受け入れて対応する","柔軟性と継続性を両立させる"]:t.includes("progress_adjust_option_b")?["最初に基礎をしっかり固める","中盤からは大胆な変革に舵を切る","段階的に変化の幅を広げていく","初期の慎重さから後半の積極性へ移行"]:t.includes("transform_complete_option_a")?["最初の転機を逃さずに掴む","変化を起こした後は着実に発展させる","転換点での勇気ある決断が鍵","新しい環境で堅実に成長する"]:t.includes("transform_complete_option_b")?["変化→安定→変化のサイクルを活用","ジグザグでも前進していることを信じる","調整期間を有効に使って次に備える","変化と安定の両方を味方につける"]:t.includes("transform_integrate_option_a")?["大きな変革を恐れずに実行する","最終段階で新方向性を明確にする","変化の激流を乗り越える覚悟を持つ","革新的アイデアを現実に落とし込む"]:t.includes("transform_integrate_option_b")?["人生の抜本的変革に踏み切る","全てを変える覚悟と計画を持つ","過去との決別と新しい自分の創造","完全な転換による新次元の開拓"]:["現在の状況を冷静に分析する","可能性と制約の両方を理解する","段階的に行動計画を実行する","結果を検証して柔軟に調整する"]}estimateTimeline(){return"3-6ヶ月"}identifySuccessFactors(){return["継続性","適応力","判断力"]}identifyPotentialChallenges(){return["変化への抵抗","外的要因","タイミング"]}calculatePhilosophicalDepth(){return.88}extractLevel2Nodes(e){return Object.keys(e).flatMap(t=>Object.keys(e[t]))}extractLevel3Nodes(e){return Object.keys(e).flatMap(t=>Object.keys(e[t]).flatMap(n=>Object.keys(e[t][n])))}buildConnectionMap(){return{connections:[]}}calculateAverageProbability(e){return e.reduce((e,t)=>e+t.probability,0)/e.length}calculatePhilosophicalConsistency(){return.9}generateFallbackBinaryTree(e){return{version:this.version,currentLine:e,error:!0,finalEightPaths:Array.from({length:8},(e,t)=>({pathIndex:t+1,title:`基本的道筋 ${t+1}`,probability:.125,route:["basic","path","option"]}))}}getSystemInfo(){return{version:this.version,philosophy:this.philosophyAlignment,branchingLevels:this.branchingLevels,supportedLines:"1-384 (H384 Database)",cacheSize:this.branchingCache.size,initialized:this.initialized,virtualSpiralEnabled:this.virtualSpiralConcepts.enabled}}clearCache(){this.branchingCache.clear(),console.log("🧹 BinaryTreeFutureEngine cache cleared")}}"undefined"!=typeof window&&(window.BinaryTreeFutureEngine=BinaryTreeFutureEngine,window.haqeiBinaryTreeEngine||(window.haqeiBinaryTreeEngine=new BinaryTreeFutureEngine)),"undefined"!=typeof module&&module.exports&&(module.exports=BinaryTreeFutureEngine),console.log("🌳 BinaryTreeFutureEngine.js loaded successfully - 二分木型仮想螺旋統合段階的分岐システム");