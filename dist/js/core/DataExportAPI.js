console.log("📊 DataExportAPI Loading..."),window.DataExportAPI={init(){console.log("🔧 DataExportAPI initializing..."),this.setupExportMethods(),this.validateStorageAccess(),console.log("✅ DataExportAPI initialized successfully")},setupExportMethods(){this.exportFormats={json:this.exportAsJSON.bind(this),csv:this.exportAsCSV.bind(this),text:this.exportAsText.bind(this),iching:this.exportAsIChingFormat.bind(this)}},validateStorageAccess(){try{const e="_dataexport_test";localStorage.setItem(e,"test"),localStorage.removeItem(e),this.storageAvailable=!0}catch(e){console.warn("⚠️ LocalStorage not available, using memory storage"),this.storageAvailable=!1,this.memoryStorage=new Map}},exportAsIChingFormat(e){const t={timestamp:(new Date).toISOString(),hexagram:e.hexagram||"乾",analysis:e.analysis||{},scenarios:e.scenarios||[],haqei_philosophy:{harmony:this.calculateHarmonyIndex(e),balance:this.calculateBalanceScore(e),wisdom:this.extractWisdomElements(e)}};return this.generateDownload(JSON.stringify(t,null,2),"haqei-iching-analysis.json","application/json")},exportAsJSON(e){const t={...e,exported_at:(new Date).toISOString(),format_version:"1.0",haqei_signature:this.generateHaQeiSignature(e)};return this.generateDownload(JSON.stringify(t,null,2),"haqei-analysis.json","application/json")},exportAsCSV(e){const t=this.convertToCSV(e);return this.generateDownload(t,"haqei-analysis.csv","text/csv")},exportAsText(e){const t=this.convertToText(e);return this.generateDownload(t,"haqei-analysis.txt","text/plain")},convertToCSV(e){let t="Category,Value,Timestamp\n";return e.hexagram&&(t+=`Hexagram,${e.hexagram},${(new Date).toISOString()}\n`),e.scenarios&&e.scenarios.forEach((e,a)=>{t+=`Scenario ${a+1},"${e.replace(/"/g,'""')}",${(new Date).toISOString()}\n`}),e.analysis&&Object.entries(e.analysis).forEach(([e,a])=>{t+=`${e},"${String(a).replace(/"/g,'""')}",${(new Date).toISOString()}\n`}),t},convertToText(e){let t="=== HAQEI Analysis Report ===\n\n";return t+=`Generated: ${(new Date).toLocaleString("ja-JP")}\n\n`,e.hexagram&&(t+=`易経卦象: ${e.hexagram}\n\n`),e.scenarios&&(t+="--- 8つのシナリオ ---\n",e.scenarios.forEach((e,a)=>{t+=`${a+1}. ${e}\n`}),t+="\n"),e.analysis&&(t+="--- 分析結果 ---\n",Object.entries(e.analysis).forEach(([e,a])=>{t+=`${e}: ${a}\n`})),t+="\n--- HaQei Philosophy Signature ---\n",t+=this.generateHaQeiSignature(e),t},generateDownload(e,t,a){try{const n=new Blob([e],{type:a}),o=URL.createObjectURL(n),r=document.createElement("a");return r.href=o,r.download=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(o),console.log(`✅ Data exported as ${t}`),!0}catch(n){return console.error("❌ Export failed:",n),!1}},generateHaQeiSignature(e){const t=this.calculateHarmonyIndex(e),a=this.calculateBalanceScore(e),n=this.extractWisdomElements(e);return`Harmony: ${t.toFixed(2)} | Balance: ${a.toFixed(2)} | Wisdom Elements: ${n.length}`},calculateHarmonyIndex(e){let t=.5;return e.scenarios&&8===e.scenarios.length&&(t+=.2),e.analysis&&Object.keys(e.analysis).length>0&&(t+=.2),e.hexagram&&(t+=.1),Math.min(t,1)},calculateBalanceScore(e){const t=[e.scenarios?.length||0,Object.keys(e.analysis||{}).length,e.hexagram?1:0],a=this.calculateVariance(t);return Math.max(0,1-a/10)},calculateVariance(e){const t=e.reduce((e,t)=>e+t,0)/e.length;return e.reduce((e,a)=>e+Math.pow(a-t,2),0)/e.length},extractWisdomElements(e){const t=[];return e.hexagram&&t.push("hexagram_wisdom"),e.scenarios?.length>=8&&t.push("complete_scenarios"),e.analysis?.depth>.7&&t.push("deep_analysis"),t},async exportData(e,t="json"){if(!this.exportFormats[t])return console.error(`❌ Unsupported format: ${t}`),!1;try{return await this.exportFormats[t](e)}catch(a){return console.error("❌ Export error:",a),!1}}},document.addEventListener("DOMContentLoaded",()=>{window.DataExportAPI.init()}),console.log("✅ DataExportAPI loaded successfully");