class MetricsCalculator{calculate(e){const n=this.extractVectors(e),t=this.normalizeVectors(n),s={EI:this.calculateSynergy(t.engine,t.interface),IS:this.calculateSynergy(t.interface,t.safe),ES:this.calculateSynergy(t.engine,t.safe)};return{synergy_edges:s,synergy:(s.EI+s.IS+s.ES)/3,tension:this.calculateTension(t),confidence:this.calculateConfidence(e),herfindahl:this.calculateHerfindahl(n),blindspots:this.detectBlindspots(e)}}extractVectors(e){const n=["乾","震","坎","兌","離","巽","艮","坤"],extractVector=e=>e&&e.baguaEnergies?n.map(n=>(e.baguaEnergies[n]||0)/100):n.map(()=>.125);return{engine:extractVector(e.engineOS),interface:extractVector(e.interfaceOS),safe:extractVector(e.safeModeOS)}}normalizeVectors(e){const normalize=e=>{const n=Math.sqrt(e.reduce((e,n)=>e+n*n,0));return n>0?e.map(e=>e/n):e};return{engine:normalize(e.engine),interface:normalize(e.interface),safe:normalize(e.safe)}}calculateSynergy(e,n){const t=e.reduce((e,t,s)=>e+t*n[s],0);return Math.max(0,t)}calculateTension(e){const n=[];[["engine","interface"],["interface","safe"],["engine","safe"]].forEach(([t,s])=>{const a=e[t].reduce((n,t,a)=>n+t*e[s][a],0),r=Math.max(0,-a),i=this.checkWuxingConflict(t,s)?.05:0;n.push(Math.min(1,r+i))});const t=n.reduce((e,n)=>e+n,0)/n.length,s=this.calculateElongation(e);return Math.min(1,t+.2*s)}calculateConfidence(e){const n=this.calculateHerfindahl(this.extractVectors(e)),t=1-(.19+.2*Math.abs(n-.3));return Math.max(0,Math.min(1,t))}calculateHerfindahl(e){const n=[...e.engine,...e.interface,...e.safe],t=n.reduce((e,n)=>e+n,0);return n.map(e=>e/t).reduce((e,n)=>e+n*n,0)}calculateElongation(e){const n=Object.values({engine:.33,interface:.33,safe:.34}),t=n.reduce((e,n)=>e+n,0)/n.length,s=n.reduce((e,n)=>e+Math.pow(n-t,2),0)/n.length;return Math.sqrt(s)}checkWuxingConflict(e,n){const t={"engine-interface":!1,"interface-safe":!1,"engine-safe":!0};return t[`${e}-${n}`]||t[`${n}-${e}`]||!1}detectBlindspots(e){const n=[];return(!e.engineOS||e.engineOS.strength<30)&&n.push("Engine OSの評価が不明確です"),Math.abs(e.interfaceOS?.strength-e.safeModeOS?.strength)<5&&n.push("Interface OSとSafe Mode OSの区別が曖昧です"),n}}class HeroGenerator{generate(e){const{scores:n,metrics:t}=e,s=this.findDominant(n),a=this.selectMetaphor(s,t);return{text:this.createHeroText(a,s),why:this.createWhyText(n,t),tags:this.generateTags(s,t),metaphor:a}}findDominant(e){const n=Object.entries(e),t=Math.max(...n.map(([e,n])=>n)),s=n.find(([e,n])=>n===t);return{type:s[0],score:s[1],balance:this.checkBalance(e)}}checkBalance(e){const n=Object.values(e),t=Math.max(...n),s=Math.min(...n);return t-s<.05?"balanced":t-s>.5?"specialized":"normal"}selectMetaphor(e,n){const t=n.synergy>.6?"high_synergy":n.synergy<.3?"low_synergy":"balanced";return{engine:{high_synergy:"創造の泉を持つ探索者",low_synergy:"内なる炎を守る思索者",balanced:"深層と表層を繋ぐ架け橋"},interface:{high_synergy:"調和を紡ぐコンダクター",low_synergy:"慎重な対話の設計者",balanced:"内と外を調整する翻訳者"},safe:{high_synergy:"安定の中に革新を見る",low_synergy:"嵐の中の静かな港",balanced:"リスクと安全の均衡点"}}[e.type]?.[t]||"独自の道を歩む探求者"}createHeroText(e,n){return e.length>28?e.substring(0,28):e.length<18?e+"タイプ":e}createWhyText(e,n){return`主導${Math.round(100*Math.max(...Object.values(e)))}%・協調度${Math.round(100*n.synergy)}%から導出`}generateTags(e,n){const t=[];return"engine"===e.type?t.push("創造型"):"interface"===e.type?t.push("調和型"):"safe"===e.type&&t.push("安定型"),"balanced"===e.balance?t.push("バランス"):"specialized"===e.balance&&t.push("特化型"),n.synergy>.6?t.push("高協調"):n.synergy<.3&&t.push("独立型"),n.tension>.5&&t.push("葛藤あり"),t.slice(0,4)}}class SwitchLensCalculator{constructor(e=null){this.baseScores=e,this.matrix=[[-.1,0,.1],[.12,-.08,-.04],[-.05,-.12,.17]],this.sensitivity=1.2}calculate(e,n,t,s=null){const a=s||this.baseScores||{engine:.5,interface:.5,safe:.5},r=[e,n,t],i=[0,0,0];for(let g=0;g<3;g++)for(let e=0;e<3;e++)i[e]+=r[g]*this.matrix[g][e];const c=[Math.log(a.engine+.01),Math.log(a.interface+.01),Math.log(a.safe+.01)].map((e,n)=>e+this.sensitivity*i[n]),o=Math.max(...c),h=c.map(e=>Math.exp(e-o)),l=h.reduce((e,n)=>e+n,0);return{engine:h[0]/l,interface:h[1]/l,safe:h[2]/l,dominant:this.getDominantMode(h[0],h[1],h[2])}}getDominantMode(e,n,t){const s=Math.max(e,n,t);return s===e?"Engine-led":s===n?"Interface-led":"Safe-led"}getPrediction(e,n){const t=n<.33?"low":n<.67?"medium":"high";return{uncertainty:{low:"情報が明確で、効率的に動けます",medium:"通常の不確実性では、バランスを保ちます",high:"不確実性が高く、慎重なアプローチが必要です"},timePressure:{low:"時間に余裕があり、丁寧な調整が可能です",medium:"適度な時間制約は、効率的な行動を促します",high:"締切が迫り、素早い決断が求められます"},socialRisk:{low:"親密な関係で、自然な表現ができます",medium:"一般的な社会場面では、適度な調整で対応します",high:"リスクの高い対人場面で、慎重さが必要です"}}[e]?.[t]||"分析中..."}}class PayloadGenerator{generate(e,n){const t=(new Date).toISOString(),s=this.generateUUID();switch(e){case"full":return this.generateFullPayload(n,t,s);case"lite":default:return this.generateLitePayload(n,t,s);case"min":return this.generateMinPayload(n,t,s)}}generateFullPayload(e,n,t){const s={schema_version:"1.1",generated_at:n,locale:"ja-JP",session_id:t,user_id_hash:this.hashUserId(),triple_os:{engine:{hex:e.tripleOS?.engineOS?.hexagramId||1,name:e.tripleOS?.engineOS?.hexagramName||"乾為天",score:e.scores.engine,vec8:e.tripleOS?.engineOS?.vec8||[.125,.125,.125,.125,.125,.125,.125,.125]},interface:{hex:e.tripleOS?.interfaceOS?.hexagramId||2,name:e.tripleOS?.interfaceOS?.hexagramName||"坤為地",score:e.scores.interface,vec8:e.tripleOS?.interfaceOS?.vec8||[.125,.125,.125,.125,.125,.125,.125,.125]},safe:{hex:e.tripleOS?.safeModeOS?.hexagramId||3,name:e.tripleOS?.safeModeOS?.hexagramName||"水雷屯",score:e.scores.safe,vec8:e.tripleOS?.safeModeOS?.vec8||[.125,.125,.125,.125,.125,.125,.125,.125]}},metrics:e.metrics,insight_primitives:this.generateInsights(e),switch_lenses:{sliders:{uncertainty:.5,time_pressure:.5,social_risk:.5},matrix:"v1-default",sensitivity_k:1.2,predicted_mode:"Balanced"},blindspots:e.metrics.blindspots||[],hypotheses_for_validation:["小集団ではInterface表現性が上昇する可能性","創造的課題でEngine-Safe葛藤が顕在化","時間無制限時のEngine暴走リスク"],user_overrides:{disagree_points:[],context_notes:"",additional_context:[]},raw_answers:{compressed:"base64_encoded_answer_pattern"}};return s.checksum=this.generateChecksum(s),s}generateLitePayload(e,n,t){return{version:"lite-1.1",size:"~2KB",usage:"クイック連携・表示用",triple_os:{engine:{hex:60,score:e.scores.engine},interface:{hex:38,score:e.scores.interface},safe:{hex:45,score:e.scores.safe}},metrics:{synergy:e.metrics.synergy,tension:e.metrics.tension,confidence:e.metrics.confidence},dominant_mode:this.findDominantMode(e.scores),session_id:t,checksum:this.generateChecksum(e)}}generateMinPayload(e,n,t){return{version:"min-1.1",size:"~500B",usage:"識別・参照用",os_scores:[e.scores.engine,e.scores.interface,e.scores.safe],confidence:e.metrics.confidence,session_id:t}}generateInsights(e){const n=[];return e.scores.engine>.6&&n.push("創造/探求が強く、対人表明が相対的に弱い"),e.scores.safe>.5&&e.scores.engine<.4&&n.push("安全確保が先行し、未知への初速が落ちやすい"),e.scores.interface>.6&&n.push("Interface優位時、本音表現が制限される"),n.slice(0,3)}findDominantMode(e){const n=Math.max(e.engine,e.interface,e.safe);return n===e.engine?"Engine-led":n===e.interface?"Interface-led":"Safe-led"}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){const n=16*Math.random()|0;return("x"===e?n:3&n|8).toString(16)})}hashUserId(){return"user_"+Math.random().toString(36).substr(2,9)}generateChecksum(e){return"checksum_"+JSON.stringify(e).length.toString(16)}}