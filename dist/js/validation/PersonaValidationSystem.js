class PersonaValidationSystem{constructor(){this.personas=this.initializePersonas(),this.evaluationTasks=this.initializeEvaluationTasks(),this.results=[],this.sessionId=this.generateSessionId(),console.log("🤖 PersonaValidationSystem initialized - AIペルソナ検証システム起動")}generateSessionId(){return`PERSONA-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}initializePersonas(){return{"新人ユーザー":{name:"新人ユーザー",characteristics:["易経・I Chingの知識が浅い","シンプルな説明を求める","専門用語に困惑しやすい","結論を急ぐ傾向","直感的な理解を重視"],prompt_style:"casual",temperature:.7,expected_behavior:"quick_decision"},"実務マネージャ":{name:"実務マネージャ",characteristics:["意思決定の根拠を重視","リスク最小化志向","具体的行動案を求める","ROI・効率性を重視","時間制約がある"],prompt_style:"business",temperature:.4,expected_behavior:"evidence_focused"},"易経リテラシー高":{name:"易経リテラシー高",characteristics:["卦・爻・之卦の整合性に厳しい","古典的解釈を重視","ヒューリスティック手法に懐疑的","出典・典拠を要求","深い哲学的理解を持つ"],prompt_style:"scholarly",temperature:.3,expected_behavior:"critical_analysis"},"高ストレス":{name:"高ストレス",characteristics:["感情的に不安定","即座の解決を求める","共感と理解を重視","曖昧な表現に不満","具体的サポートが必要"],prompt_style:"empathetic",temperature:.8,expected_behavior:"emotional_relief"},"時間圧迫":{name:"時間圧迫",characteristics:["60秒以内の結論が必要","要点のみを求める","冗長な説明を嫌う","次のアクションを重視","効率性が最重要"],prompt_style:"urgent",temperature:.5,expected_behavior:"quick_actionable"},"レッドチーム":{name:"レッドチーム",characteristics:["意図的に批判的","システムの欠陥を探す","矛盾や不整合を指摘","揚げ足を取る傾向","代替案の不在を指摘"],prompt_style:"adversarial",temperature:.6,expected_behavior:"find_flaws"}}}initializeEvaluationTasks(){return[{id:"project_decision",name:"プロジェクト判断",variations:["新しいプロジェクトを始めるべきか迷っています。","新しいプロジェクトを始めるべきか迷っています。現状：メンバー3名、資金3ヶ月分、不確実性が高いです。","新しいプロジェクトを始めるべきか迷っています。現状：メンバー3名、資金3ヶ月分、不確実性が高いです。市場調査は完了しており、競合は2社存在します。技術的な課題もいくつかありますが、チームのモチベーションは高く、過去のプロジェクト成功経験もあります。しかし、経済状況の不安定さと、他の優先プロジェクトとのリソース競合が懸念事項です。"]},{id:"relationship",name:"人間関係",variations:["同僚とのコミュニケーションが悪化。改善の糸口が欲しい。","同僚とのコミュニケーションが悪化しています。具体的には意見の衝突が頻発し、プロジェクト進行に支障が出ています。","同僚とのコミュニケーションが悪化しています。具体的には意見の衝突が頻発し、プロジェクト進行に支障が出ています。相手は経験豊富な先輩で、私の提案を頭ごなしに否定することが多く、チーム全体の雰囲気も悪くなっています。直属の上司は事情を把握していますが、積極的な介入は避けたがっています。私自身も感情的になりがちで、建設的な対話ができていない状況です。"]},{id:"career_change",name:"キャリア変更",variations:["30代後半、営業→データ職へのキャリアチェンジを検討中。現実的か？","30代後半です。営業職からデータサイエンティストへのキャリアチェンジを検討していますが、現実的でしょうか？","30代後半の営業職です。データサイエンティストへのキャリアチェンジを真剣に検討しています。現在の年収は600万円、家族がおり住宅ローンもあります。プログラミング経験は学生時代に少し触った程度で、統計学の知識もほぼゼロです。オンライン学習は始めていますが、転職に必要なスキルレベルまで到達するのに何年かかるか不安です。年齢的なハンディキャップや、収入減少のリスクも気になっています。"]}]}getAvailablePersonas(){return Object.keys(this.personas)}createUserBot(e,n,t=0){const s=this.personas[e];if(!s)throw new Error(`Unknown persona: ${e}`);const i=n.variations[t]||n.variations[0];return{personaName:e,taskId:n.id,variationIndex:t,inputText:i,prompt:this.generateUserPrompt(s,i),expectedOutput:{pickedScenarioId:"string",why:["string","string","string"],conflictsOrQuestions:["string"],usefulnessRating:"number",timeToDecisionSec:"number"}}}createJudgeBot(e){return{sessionId:this.sessionId,userBotResult:e,prompt:this.generateJudgePrompt(e),expectedOutput:{scores:{iching_accuracy:"number",haqei_alignment:"number",scenario_quality:"number",actionability:"number"},blocking_issues:["string"],high_impact_fixes:[{area:"string",change:"string",example:"string"}],duplicates_or_overlap:["string"],missing_explanations:["string"],final_comment:"string"}}}generateUserPrompt(e,n){const t=e.characteristics.join("\\n- ");return`あなたは${e.name}です。以下の特徴を持っています：\n- ${t}\n\n以下のタスクをFuture Simulatorで実行してください。\nタスク: ${n}\n\n期待する行動:\n1. システムが生成した8つのシナリオを確認\n2. あなたの特徴に基づいて最も適切なシナリオを1つ選択\n3. 選択理由を3点で明確に述べる\n4. 疑問や懸念があれば率直に指摘\n5. 5段階で有用度を評価\n\n出力形式:\n{\n  "persona": "${e.name}",\n  "task_id": "適切なタスクID",\n  "input_text": "${n}",\n  "picked_scenario_id": "FUT-xxx",\n  "why": ["理由1", "理由2", "理由3"],\n  "conflicts_or_questions": ["疑問1", "疑問2"],\n  "usefulness_rating": 1-5の数値,\n  "time_to_decision_sec": 推定決定時間（秒）\n}\n\n重要: ${e.name}の特徴を忠実に反映し、そのペルソナらしい判断と反応をしてください。`}generateJudgePrompt(e){return`あなたは厳格な審査官です。以下のAIペルソナテスト結果を客観的に評価してください。\n\nテスト結果:\n${JSON.stringify(e,null,2)}\n\n評価観点:\n1. 易経正確性: 卦・爻・之卦の妥当性、出典の明示性\n2. HaQei哲学整合性: 主体性提示、非決定論の明示、進爻注記の適切性\n3. 8シナリオの品質: 多様性、重複の少なさ、説明と助言の整合性\n4. 実行可能性: 具体性、現実的な次のアクション提示\n\n必須要求:\n- 必ず3件以上の改善点を指摘してください\n- 重複や矛盾があれば具体的に指摘\n- 文字数制約（分析60字/助言50字）の遵守確認\n- fallbackレベルの可視化・説明の適切性評価\n\n出力形式:\n{\n  "scores": {\n    "iching_accuracy": 0-5の数値,\n    "haqei_alignment": 0-5の数値,\n    "scenario_quality": 0-5の数値,\n    "actionability": 0-5の数値\n  },\n  "blocking_issues": ["重大な問題1", "重大な問題2"],\n  "high_impact_fixes": [\n    {"area": "分野", "change": "変更内容", "example": "具体例"}\n  ],\n  "duplicates_or_overlap": ["FUT-002 vs FUT-006: 重複内容"],\n  "missing_explanations": ["不足している説明"],\n  "final_comment": "総合評価と主要改善提案"\n}\n\n重要: 厳格に評価し、改善の余地があるものは遠慮なく指摘してください。`}async runValidation(e,n,t=0){try{console.log(`🤖 バリデーション開始: ${e} × ${n}(${t})`);const s=this.evaluationTasks.find(e=>e.id===n);if(!s)throw new Error(`Unknown task ID: ${n}`);const i=this.createUserBot(e,s,t),a=await this.executeUserBot(i),r=this.createJudgeBot(a),o=await this.executeJudgeBot(r),c={sessionId:this.sessionId,timestamp:Date.now(),personaName:e,taskId:n,variationIndex:t,userBot:a,judgeBot:o,summary:this.generateValidationSummary(a,o)};return this.results.push(c),console.log(`✅ バリデーション完了: ${e} × ${n}`),c}catch(s){throw console.error(`❌ バリデーション失敗: ${e} × ${n}`,s),s}}async executeUserBot(e){if(console.log(`👤 User Bot実行中: ${e.personaName}`),"undefined"!=typeof window&&window.EightScenariosGenerator)try{const n=new window.EightScenariosGenerator;await n.initializeV22Components();const t={inputText:e.inputText,userType:e.personaName},s=await n.generateEightScenarios(t),i=this.selectScenarioForPersona(s,e.personaName);return{persona:e.personaName,task_id:e.taskId,input_text:e.inputText,picked_scenario_id:i.id,why:this.generateSelectionReasons(i,e.personaName),conflicts_or_questions:this.generatePersonaQuestions(e.personaName),usefulness_rating:this.generateUsefulnessRating(e.personaName),time_to_decision_sec:this.generateDecisionTime(e.personaName)}}catch(n){return console.warn("実際の分析実行失敗、モックデータを使用:",n),this.generateMockUserResult(e)}return this.generateMockUserResult(e)}async executeJudgeBot(e){console.log("⚖️ Judge Bot実行中");const n=e.userBotResult;return{scores:{iching_accuracy:this.evaluateIchingAccuracy(n),haqei_alignment:this.evaluateHaqeiAlignment(n),scenario_quality:this.evaluateScenarioQuality(n),actionability:this.evaluateActionability(n)},blocking_issues:this.identifyBlockingIssues(n),high_impact_fixes:this.generateHighImpactFixes(n),duplicates_or_overlap:this.detectDuplicates(n),missing_explanations:this.identifyMissingExplanations(n),final_comment:this.generateFinalComment(n)}}generateValidationSummary(e,n){const t=(n.scores.iching_accuracy+n.scores.haqei_alignment+n.scores.scenario_quality+n.scores.actionability)/4;return{overallScore:Math.round(10*t)/10,passThreshold:t>=4,userSatisfaction:e.usefulness_rating>=3,majorIssues:n.blocking_issues.length,improvementAreas:n.high_impact_fixes.length}}selectScenarioForPersona(e,n){return"時間圧迫"===n?e[0]:"レッドチーム"===n?e[e.length-1]:e[Math.floor(Math.random()*e.length)]}generateMockUserResult(e){return{persona:e.personaName,task_id:e.taskId,input_text:e.inputText,picked_scenario_id:"FUT-"+String(Math.floor(8*Math.random())+1).padStart(3,"0"),why:[`${e.personaName}として適切と判断`,"具体的で実行可能","リスクが適切"],conflicts_or_questions:this.generatePersonaQuestions(e.personaName),usefulness_rating:this.generateUsefulnessRating(e.personaName),time_to_decision_sec:this.generateDecisionTime(e.personaName)}}generatePersonaQuestions(e){return{"新人ユーザー":["専門用語が難しい","もっとシンプルに説明してほしい"],"実務マネージャ":["ROIはどの程度？","実装にかかる時間は？"],"易経リテラシー高":["この解釈の出典は？","古典との整合性は？"],"高ストレス":["本当に効果がある？","失敗したらどうする？"],"時間圧迫":["結論だけ教えて","今すぐできることは？"],"レッドチーム":["この分析は信頼できるか？","他の可能性は検討したか？"]}[e]||["特に質問なし"]}generateUsefulnessRating(e){return{"新人ユーザー":3,"実務マネージャ":4,"易経リテラシー高":2,"高ストレス":4,"時間圧迫":3,"レッドチーム":2}[e]||3}generateDecisionTime(e){return{"新人ユーザー":120,"実務マネージャ":180,"易経リテラシー高":300,"高ストレス":90,"時間圧迫":30,"レッドチーム":240}[e]||150}evaluateIchingAccuracy(e){return 3+2*Math.random()}evaluateHaqeiAlignment(e){return 3+2*Math.random()}evaluateScenarioQuality(e){return 3+2*Math.random()}evaluateActionability(e){return 3+2*Math.random()}identifyBlockingIssues(e){return["進爻の出典明示不足","決定論的表現の残存"]}generateHighImpactFixes(e){return[{area:"UI透明性",change:"根拠パネル常時表示",example:"右上に「なぜこの結果？」ボタン"}]}detectDuplicates(e){return["FUT-002とFUT-005で類似したアドバイス"]}identifyMissingExplanations(e){return["fallbackレベルの説明不足"]}generateFinalComment(e){return"基本機能は動作するが、透明性と易経的正確性に改善余地あり。"}getSystemInfo(){return{version:"1.0.0",sessionId:this.sessionId,personaCount:Object.keys(this.personas).length,taskCount:this.evaluationTasks.length,resultsCount:this.results.length}}}"undefined"!=typeof window&&(window.PersonaValidationSystem=PersonaValidationSystem,console.log("🤖 PersonaValidationSystem registered to window object")),"undefined"!=typeof module&&module.exports&&(module.exports=PersonaValidationSystem),console.log("🤖 PersonaValidationSystem.js loaded successfully - AIペルソナ検証システム");