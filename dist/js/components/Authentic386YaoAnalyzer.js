window.Authentic386YaoAnalyzer=class{constructor(){this.hexagramData=null,this.initialized=!1,this.debugMode=!0,this.keywordHexagramMap=null,this.emotionHexagramMap=null,this.patternHexagramMap=null,this.timePhaseHexagramMap=null}async initialize(){console.log("üéã Initializing Authentic 386Áàª Analyzer...");try{const e=await fetch("/data/enhanced_hexagrams_complete.json");this.hexagramData=await e.json();const t=this.hexagramData.reduce((e,t)=>e+(t.six_lines?.length||0),0),n=this.hexagramData.filter(e=>e.special_yao).length;return console.log(`‚úÖ Loaded ${this.hexagramData.length} hexagrams`),console.log(`‚úÖ Total lines: ${t} regular + ${n} special = ${t+n}`),this.buildOptimizationMaps(),console.log("üöÄ Performance optimization maps built"),this.initialized=!0,!0}catch(e){return console.error("‚ùå Failed to initialize 386Áàª data:",e),!1}}buildOptimizationMaps(){this.keywordHexagramMap=new Map([["creation",[1,3]],["receptive",[2]],["difficulty",[3,39]],["learning",[4]],["waiting",[5]],["conflict",[6]],["harmony",[11,13]],["change",[49]],["completion",[63]],["continuation",[64]]]),this.emotionHexagramMap=new Map([["anxiety",[4,29]],["joy",[58,16]],["anger",[31,21]],["sadness",[45,47]],["calm",[52,60]]]),this.patternHexagramMap=new Map([["high-sensitivity",[31,61]],["seeking-balance",[60,15]],["self-improvement",[15,42]]]),this.timePhaseHexagramMap=new Map([["beginning",[3,1]],["developing",[46,53]],["completion",[63]],["transition",[49,17]]]),this.hexagramWeights=new Float32Array(65),this.hexagramWeights.fill(5),[1,2,31,15,60,49].forEach(e=>this.hexagramWeights[e]=8),this.contextualWeights=new Map([["emotional-high",new Map([[31,1.5],[21,1.3],[58,1.2]])],["emotional-calm",new Map([[52,1.5],[60,1.3],[2,1.2]])],["time-beginning",new Map([[1,1.4],[3,1.6],[4,1.3]])],["time-transition",new Map([[49,1.6],[17,1.3],[18,1.2]])],["time-completion",new Map([[63,1.5],[14,1.3],[11,1.2]])],["personality-sensitive",new Map([[31,1.6],[61,1.4],[37,1.2]])],["personality-balanced",new Map([[15,1.5],[60,1.4],[11,1.3]])],["personality-creative",new Map([[1,1.4],[42,1.3],[25,1.2]])],["wuxing-wood-peak",new Map([[1,1.3],[34,1.2],[51,1.1]])],["wuxing-fire-peak",new Map([[30,1.3],[14,1.2],[21,1.1]])],["wuxing-earth-stable",new Map([[2,1.3],[15,1.2],[52,1.1]])],["wuxing-metal-refined",new Map([[10,1.3],[58,1.2],[43,1.1]])],["wuxing-water-deep",new Map([[29,1.3],[5,1.2],[48,1.1]])]]),this.wuxingHexagramMap=new Map([["wood",[1,3,18,34,42,51,57]],["fire",[13,14,21,30,35,38,49,55,56]],["earth",[2,7,8,15,16,20,23,24,33,52]],["metal",[10,26,28,41,43,58]],["water",[5,6,29,39,47,48,60,63,64]]]),this.wuxingRelations=new Map([["wood",{generates:"fire",generatedBy:"water"}],["fire",{generates:"earth",generatedBy:"wood"}],["earth",{generates:"metal",generatedBy:"fire"}],["metal",{generates:"water",generatedBy:"earth"}],["water",{generates:"wood",generatedBy:"metal"}],["wood",{controls:"earth",controlledBy:"metal"}],["fire",{controls:"metal",controlledBy:"water"}],["earth",{controls:"water",controlledBy:"wood"}],["metal",{controls:"wood",controlledBy:"fire"}],["water",{controls:"fire",controlledBy:"earth"}]])}analyzeText(e){if(!this.initialized)return console.error("‚ùå Analyzer not initialized"),null;const t=this.validateAndCleanInput(e);if(!t)return null;console.log("üîç Analyzing text with 386Áàª system:",t.substring(0,50));const n=this.performDeepAnalysis(t),i=this.selectOptimalHexagram(n),a=this.selectOptimalYao(t,i,n);return{hexagram:i,yao:a,specialYao:this.checkSpecialYao(i,n),analysis:n,confidence:this.calculateConfidence(i,a,n)}}validateAndCleanInput(e){if(!e)return console.warn("‚ö†Ô∏è Empty or null input text"),null;"string"!=typeof e&&(console.warn("‚ö†Ô∏è Input is not a string, converting..."),e=String(e));const t=e.trim();if(0===t.length)return console.warn("‚ö†Ô∏è Input text is empty after trimming"),null;if(t.length>1e4)return console.warn("‚ö†Ô∏è Input text too long, truncating to 10000 characters"),t.substring(0,1e4);if(t.length<2)return console.warn("‚ö†Ô∏è Input text too short for meaningful analysis"),null;return t.replace(/[\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g,"").replace(/\s+/g," ")}performDeepAnalysis(e){const t={originalText:e,keywords:[],emotions:[],timePhase:null,intensity:0,patterns:[]},n={creation:/ÂâµÈÄ†|„É™„Éº„ÉÄ„Éº|Âßã„ÇÅ„Çã|ÈñãÊãì|Èù©Êñ∞/g,receptive:/ÂèóÂÆπ|ËÇ≤„ÇÄ|ÊîØ„Åà„Çã|ÂåÖÂÆπ|ÊØçÊÄß/g,difficulty:/Âõ∞Èõ£|Ëã¶Âä¥|ÂïèÈ°å|Â£Å|Ë©¶Á∑¥/g,learning:/Â≠¶„Å∂|ÊïôËÇ≤|ÊàêÈï∑|ÂïìËíô|Êú™ÁÜü/g,waiting:/ÂæÖ„Å§|Ê∫ñÂÇô|ÂøçËÄê|ÊôÇÊ©ü|„Çø„Ç§„Éü„É≥„Ç∞/g,conflict:/‰∫â„ÅÑ|ÂØæÁ´ã|Ë≠∞Ë´ñ|Ë°ùÁ™Å|Ë®¥Ë®ü/g,harmony:/Ë™øÂíå|ÂçîÂäõ|Ë¶™ÂØÜ|‰ª≤Èñì|„ÉÅ„Éº„É†/g,change:/Â§âÂåñ|Â§âÈù©|Èù©ÂëΩ|Ëª¢Êèõ|ÊîπÈù©/g,completion:/ÂÆåÊàê|ÈÅîÊàê|ÊàêÂäü|ÂÆå‰∫Ü|ÁµÇ‰∫Ü/g,continuation:/Á∂ôÁ∂ö|Êú™ÂÆå|ÈÄî‰∏≠|ÈÄ≤Ë°å|„Åæ„Å†/g};for(const[a,s]of Object.entries(n)){const n=e.match(s);n&&t.keywords.push({type:a,count:n.length,words:n})}const i={anxiety:/‰∏çÂÆâ|ÂøÉÈÖç|ÊÅê„Çå|ÊÄñ„ÅÑ/g,joy:/Âñú„Å≥|Â¨â„Åó„ÅÑ|Ê•Ω„Åó„ÅÑ|Âπ∏„Åõ/g,anger:/ÊÄí„Çä|„Ç§„É©„Ç§„É©|„ÇÄ„Åã„Å§„Åè|ËÖπÁ´ã„Å§/g,sadness:/ÊÇ≤„Åó„ÅÑ|ÂØÇ„Åó„ÅÑ|Ëæõ„ÅÑ|Ëã¶„Åó„ÅÑ/g,calm:/Èùô„Åã|ËêΩ„Å°ÁùÄ|Âπ≥Á©è|ÂÆâÂøÉ/g};for(const[a,s]of Object.entries(i)){const n=e.match(s);n&&t.emotions.push({type:a,intensity:n.length})}return/Âßã„ÇÅ|Âàù„ÇÅ|ÊúÄÂàù|„Çπ„Çø„Éº„Éà|Êñ∞„Åó„ÅÑ/.test(e)?t.timePhase="beginning":/ÈÄî‰∏≠|ÈÄ≤Ë°å‰∏≠|„Åæ„Å†|Á∂ôÁ∂ö/.test(e)?t.timePhase="developing":/ÂÆåÊàê|ÈÅîÊàê|ÁµÇ„Çè„Çä|ÂÆå‰∫Ü/.test(e)?t.timePhase="completion":/Ëª¢Êèõ|Â§âÂåñ|Â≤êË∑Ø|ÈÅ∏Êäû/.test(e)&&(t.timePhase="transition"),t.intensity=Math.min((t.keywords.reduce((e,t)=>e+t.count,0)+t.emotions.reduce((e,t)=>e+t.intensity,0))/10,1),e.includes("ÊïèÊÑü")&&e.includes("ÂΩ±Èüø")&&t.patterns.push("high-sensitivity"),/„Éã„É•„Éº„Éà„É©„É´|„Éê„É©„É≥„Çπ|‰∏≠Â∫∏/.test(e)&&t.patterns.push("seeking-balance"),/Ëá™ÂàÜ.*ÊÄßÊ†º|Ëá™Â∑±.*ÊîπÂñÑ/.test(e)&&t.patterns.push("self-improvement"),t.wuxing=this.analyzeWuxingCharacteristics(e),t}analyzeWuxingCharacteristics(e){const t={wood:0,fire:0,earth:0,metal:0,water:0};/ÊàêÈï∑|Áô∫Â±ï|ÂâµÈÄ†|ËäΩÁîü„Åà|‰º∏„Å≥„Çã|Êã°Â§ß|ÂâçÈÄ≤|Âêë‰∏ä/.test(e)&&(t.wood+=3),/Êò•|Èùí|Á∑ë|Êù±|Êúù|Êñ∞„Åó„ÅÑ|Âßã„Åæ„Çä/.test(e)&&(t.wood+=2),/ÊÄí„Çä|„Ç§„É©„Ç§„É©|ËÇù|ÁõÆ|Á≠ãËÇâ/.test(e)&&(t.wood+=1),/ÊÉÖÁÜ±|ÁÜ±ÊÑè|Êòé„Çã„ÅÑ|Ëºù„Åè|Áô∫Êï£|Ë°®Áèæ|Âñú„Å≥|ËààÂ•Æ/.test(e)&&(t.fire+=3),/Â§è|Ëµ§|Âçó|Êòº|Ê¥ªÁô∫|Á©çÊ•µÁöÑ/.test(e)&&(t.fire+=2),/ÂøÉ|Ë°Ä|Ëàå|Á¨ë/.test(e)&&(t.fire+=1),/ÂÆâÂÆö|‰∏≠Â∫∏|„Éê„É©„É≥„Çπ|Ë™øÂíå|ÂèóÂÆπ|ÂåÖÂÆπ|ÂúüÂè∞|Âü∫Áõ§/.test(e)&&(t.earth+=3),/Êô©Â§è|ÈªÑ|‰∏≠Â§Æ|Â§ïÊñπ|Á©è„ÇÑ„Åã|Ë¨ôËôö/.test(e)&&(t.earth+=2),/ËÑæ|ËÉÉ|Âè£|ÊÄùËÄÉ/.test(e)&&(t.earth+=1),/ÂèéÊùü|Ë¶èÂæã|Ê∏ÖÊµÑ|Êï¥ÁêÜ|ÊΩîÁôΩ|Ê≠£Áæ©|ÂÆåÊàê|ÁµÇ‰∫Ü/.test(e)&&(t.metal+=3),/Áßã|ÁôΩ|Ë•ø|Â§ú|ÂÜ∑Èùô|ÁêÜÊÄßÁöÑ/.test(e)&&(t.metal+=2),/ËÇ∫|Èºª|ÁöÆËÜö|ÊÇ≤„Åó„Åø/.test(e)&&(t.metal+=1),/ÊµÅÂãï|Êô∫ÊÅµ|ÊüîËªü|Ê∑±„ÅÑ|Èùô„Åã|ÂÜÖÂêë|ËìÑÁ©ç|ÂøçËÄê/.test(e)&&(t.water+=3),/ÂÜ¨|Èªí|Âåó|Ê∑±Â§ú|ÂØí„ÅÑ|Êöó„ÅÑ/.test(e)&&(t.water+=2),/ËÖé|ËÄ≥|È™®|ÊÅê„Çå/.test(e)&&(t.water+=1);const n=Object.entries(t).sort(([,e],[,t])=>t-e)[0];return{dominant:n[0],score:n[1],allScores:t}}applyDynamicWeights(e,t){this.determineActiveContexts(t).forEach(t=>{const n=this.contextualWeights.get(t);n&&n.forEach((t,n)=>{n<=64&&(e[n]*=t)})})}determineActiveContexts(e){const t=[];if(e.emotions.reduce((e,t)=>e+t.intensity,0)>=3?t.push("emotional-high"):e.emotions.some(e=>"calm"===e.type)&&t.push("emotional-calm"),e.timePhase)switch(e.timePhase){case"beginning":t.push("time-beginning");break;case"transition":t.push("time-transition");break;case"completion":t.push("time-completion")}if(e.patterns.forEach(e=>{switch(e){case"high-sensitivity":t.push("personality-sensitive");break;case"seeking-balance":t.push("personality-balanced");break;case"self-improvement":t.push("personality-creative")}}),e.wuxing&&e.wuxing.score>=3){e.wuxing.dominant;switch(e.wuxing.dominant){case"wood":t.push("wuxing-wood-peak");break;case"fire":t.push("wuxing-fire-peak");break;case"earth":t.push("wuxing-earth-stable");break;case"metal":t.push("wuxing-metal-refined");break;case"water":t.push("wuxing-water-deep")}}return t}selectOptimalHexagram(e){const t=new Float32Array(65);t.fill(0);for(let s=1;s<=64;s++)t[s]=this.hexagramWeights[s];if(this.applyDynamicWeights(t,e),e.keywords.forEach(e=>{const n=this.keywordHexagramMap.get(e.type);n&&n.forEach(n=>{n<=64&&(t[n]+=15*e.count)})}),e.emotions.forEach(e=>{const n=this.emotionHexagramMap.get(e.type);n&&n.forEach(n=>{n<=64&&(t[n]+=8*e.intensity)})}),e.timePhase){const n=this.timePhaseHexagramMap.get(e.timePhase);n&&n.forEach(e=>{e<=64&&(t[e]+=12)})}if(e.patterns.forEach(e=>{const n=this.patternHexagramMap.get(e);n&&n.forEach(e=>{e<=64&&(t[e]+=25)})}),e.wuxing&&e.wuxing.score>0){const n=e.wuxing.dominant,i=this.wuxingHexagramMap.get(n);if(i){i.forEach(n=>{n<=64&&(t[n]+=10*e.wuxing.score)});const a=this.wuxingRelations.get(n);if(a){const n=a.generates,i=this.wuxingHexagramMap.get(n);i&&i.forEach(n=>{n<=64&&(t[n]+=5*e.wuxing.score)});const s=a.controls,o=this.wuxingHexagramMap.get(s);o&&o.forEach(n=>{n<=64&&(t[n]-=3*e.wuxing.score)})}}}let n=0,i=1;for(let s=1;s<=64;s++)t[s]>n&&(n=t[s],i=s);const a=this.hexagramData.find(e=>e.hexagram_id===i);if(this.debugMode){console.log(`üéØ Selected hexagram: ${a.name_jp} (ID: ${i})`);const e=[];for(let n=1;n<=64;n++)if(t[n]>5){const i=this.hexagramData.find(e=>e.hexagram_id===n);i&&e.push({name:i.name_jp,id:n,score:t[n]})}e.sort((e,t)=>t.score-e.score),console.log("Top scores:",e.slice(0,3).map(e=>`${e.name}(${e.id}): ${e.score}`))}return a}selectOptimalYao(e,t,n){if(!t||!t.six_lines||!Array.isArray(t.six_lines)||0===t.six_lines.length)return console.warn(`‚ö†Ô∏è Invalid hexagram data for yao selection: ${t?.name_jp||"unknown"}`),null;if(!e||"string"!=typeof e)return console.warn("‚ö†Ô∏è Invalid text input for yao selection"),null;const i={};t.six_lines.forEach(a=>{if(!a||"object"!=typeof a||"number"!=typeof a.position)return void console.warn("‚ö†Ô∏è Invalid yao line data, skipping");let s=0;if(1===t.hexagram_id&&((e.includes("ÊΩú")||e.includes("Èö†")||e.includes("Ê∫ñÂÇô"))&&1===a.position&&(s+=20),(e.includes("Áèæ„Çå")||e.includes("Ë¶ã„Åà„Çã"))&&2===a.position&&(s+=20),(e.includes("Ë≠¶Êàí")||e.includes("Ê≥®ÊÑè"))&&3===a.position&&(s+=20),(e.includes("Ë∫ç")||e.includes("È£õË∫ç"))&&4===a.position&&(s+=20),(e.includes("È£õ")||e.includes("È†ÇÁÇπ")||e.includes("„É™„Éº„ÉÄ„Éº"))&&5===a.position&&(s+=25),(e.includes("È´òÊÖ¢")||e.includes("ÂÇ≤ÊÖ¢")||e.includes("ÈÅé„Åé"))&&6===a.position&&(s+=20)),5===t.hexagram_id&&(e.includes("ÈÖí")||e.includes("È£ü")||e.includes("Ê•Ω„Åó„Åø"))&&5===a.position&&(s+=25),49===t.hexagram_id&&(e.includes("Ëôé")||e.includes("Â§ßËÉÜ")||e.includes("Â§âÈù©"))&&5===a.position&&(s+=25),a.meaning){a.meaning.split(/[„ÄÅ„ÄÇ,]/).filter(e=>e.length>0).forEach(t=>{e.includes(t.trim())&&(s+=8)})}if(n.timePhase)switch(n.timePhase){case"beginning":1===a.position&&(s+=15),2===a.position&&(s+=10);break;case"developing":3===a.position&&(s+=15),4===a.position&&(s+=15);break;case"completion":5===a.position&&(s+=15),6===a.position&&(s+=10);break;case"transition":4===a.position&&(s+=15)}const o=n.emotions.reduce((e,t)=>e+t.intensity,0);o>2?a.position>=3&&a.position<=4&&(s+=10):0===o&&(1!==a.position&&6!==a.position||(s+=5)),n.patterns.includes("high-sensitivity")&&(2!==a.position&&5!==a.position||(s+=8)),n.patterns.includes("seeking-balance")&&(3!==a.position&&4!==a.position||(s+=8)),s+=3,i[a.position]=s});const a=Object.entries(i).sort(([,e],[,t])=>t-e),s=a[0]?.[0],o=t.six_lines.find(e=>e.position==s);return this.debugMode&&(console.log(`üìç Selected yao: Position ${s} - ${o?.name}`),console.log("Top yao scores:",a.slice(0,3).map(([e,t])=>`${e}Áàª: ${t}`))),o}checkSpecialYao(e,t){if(!e||!t)return null;if(1===e.hexagram_id&&e.special_yao){const n=this.checkYangPeakConditions(t);if(n.shouldUseYongJiu)return this.debugMode&&console.log("üêâ Áî®‰πù detected:",n.reason),e.special_yao}if(2===e.hexagram_id&&e.special_yao){const n=this.checkYinCompletionConditions(t);if(n.shouldUseYongLiu)return this.debugMode&&console.log("‚ò∑ Áî®ÂÖ≠ detected:",n.reason),e.special_yao}return null}checkYangPeakConditions(e){const t={shouldUseYongJiu:!1,reason:"",confidence:0};let n=0,i=0;["„Åô„Åπ„Å¶","ÂÆåÂÖ®","Ê•µ","È†ÇÁÇπ","ÊàêÂäü","ÈÅîÊàê"].some(t=>e.originalText.includes(t))&&(n+=3);["Ë¨ôËôö","Ë¨ôÈÅú","ÊÖé„ÇÄ","„Éê„É©„É≥„Çπ","Ë™øÂíå"].some(t=>e.originalText.includes(t))&&(i+=3),!e.wuxing||"wood"!==e.wuxing.dominant&&"fire"!==e.wuxing.dominant||e.wuxing.score>=3&&(n+=2);return e.emotions.some(e=>e.intensity>=3)&&(n+=1),"completion"!==e.timePhase&&"transition"!==e.timePhase||(n+=2),n>=4&&i>=2&&(t.shouldUseYongJiu=!0,t.reason=`ÈôΩ„ÅÆÊ•µËá¥Ôºà${n}ÁÇπÔºâ+ „Éê„É©„É≥„ÇπÊ±ÇÂøÉÔºà${i}ÁÇπÔºâ`,t.confidence=Math.min(10*(n+i),100)),t}checkYinCompletionConditions(e){const t={shouldUseYongLiu:!1,reason:"",confidence:0};let n=0,i=0;["Èùô„Åã","Ê∑±„ÅÑ","ÊåÅÁ∂ö","Á∂ôÁ∂ö","Ê∞∏Á∂ö","ÂÆâÂÆö"].some(t=>e.originalText.includes(t))&&(n+=3);["Ê≠£„Åó„ÅÑ","Ê≠£„Åó„Åè","Ë≤û","Á¥îÁ≤ã","Ê∏ÖÂªâ"].some(t=>e.originalText.includes(t))&&(i+=3),!e.wuxing||"metal"!==e.wuxing.dominant&&"water"!==e.wuxing.dominant||e.wuxing.score>=3&&(n+=2);return e.emotions.some(e=>"calm"===e.type)&&(n+=2),e.patterns.includes("seeking-balance")&&(i+=2),n>=4&&i>=2&&(t.shouldUseYongLiu=!0,t.reason=`Èô∞„ÅÆÂÆåÊàêÔºà${n}ÁÇπÔºâ+ ÊåÅÁ∂öÊÄßÔºà${i}ÁÇπÔºâ`,t.confidence=Math.min(10*(n+i),100)),t}calculateConfidence(e,t,n){let i=50;return e&&6===e.six_lines?.length&&(i+=10),t&&t.meaning&&(i+=10),n.keywords.length>0&&(i+=10),n.emotions.length>0&&(i+=10),n.timePhase&&(i+=10),n.patterns.length>0&&(i+=10),i+=20*n.intensity,Math.min(Math.max(i,0),100)}createFutureContext(e){return{currentHexagram:e.hexagram,currentYao:e.yao,specialYao:e.specialYao,keywords:e.analysis.keywords.map(e=>e.words).flat(),emotions:e.analysis.emotions,timePhase:e.analysis.timePhase,patterns:e.analysis.patterns,confidence:e.confidence}}};