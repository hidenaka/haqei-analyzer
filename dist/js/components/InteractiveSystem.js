class InteractiveSystem extends BaseComponent{constructor(t,e={}){super(t,e),this.expandedCards=new Set,this.activeTooltips=new Map,this.termsDatabase=null,this.tabStates=new Map,this.init()}get defaultOptions(){return{...super.defaultOptions,enableCardExpansion:!0,enableTooltips:!0,enableTabs:!0,animationDuration:300,tooltipDelay:500,maxExpandedCards:3}}init(){this.initializeTermsDatabase(),this.setupEventListeners(),this.initializeTooltipSystem()}initializeTermsDatabase(){this.termsDatabase={"乾為天":{reading:"けんいてん",category:"hexagram",description:"創造力と指導力を表す64卦の第1番。天の象徴で、積極的で創造的なエネルギーを意味します。",context:"エンジンOSとして現れると、強い意志力と革新性を持つ特徴があります。"},"火風鼎":{reading:"かふうてい",category:"hexagram",description:"変革と安定化を表す64卦の第50番。古い秩序を改革し、新しい安定を築く力を意味します。",context:"調和を重視しながら必要な変革を行う、バランス感覚に優れた特徴があります。"},"エンジンOS":{category:"system",description:"個人の根源的な価値観や動機を表すシステム。内面的な駆動力や創造性の源泉となります。",context:"診断では主に質問1-20の回答から分析され、その人の核となる志向性を示します。"},"インターフェースOS":{category:"system",description:"外面的な行動パターンや他者との関わり方を表すシステム。社会的な顔や表現方法を示します。",context:"質問21-40の回答から分析され、職場や社会での振る舞い方の特徴を表します。"},"セーフモードOS":{category:"system",description:"ストレスや困難な状況での防御機制を表すシステム。心の安全装置として機能します。",context:"質問41-60の回答から分析され、危機的状況での対処パターンを示します。"},"八卦":{reading:"はっけ",category:"concept",description:"易経の基本要素で、8つの基本的なエネルギーパターンを表します。乾・兌・離・震・巽・坎・艮・坤の8種類があります。",context:"64卦は2つの八卦の組み合わせで構成され、上卦と下卦という形で表現されます。"},"一貫性スコア":{category:"metric",description:"3つのOS間の調和度を0-100%で表したスコア。高いほど内面と外面が一致していることを意味します。",context:"70%以上は高い一貫性、50-69%は中程度、50%未満は多様性に富む複雑な人格を示します。"},"相性タイプ":{category:"compatibility",description:"OS間の関係性を5つのタイプで分類したもの。SYNERGY（相乗効果）、HARMONY（調和）、TENSION（緊張）、CONFLICT（葛藤）、CHAOS（混沌）があります。",context:"各タイプには特有の特徴と成長のヒントがあり、内的統合の指針となります。"},SYNERGY:{category:"compatibility_type",description:"相乗効果型。2つのOSが互いを高め合い、1+1が3以上になる関係性。",context:"この関係を活かすことで、個人の可能性を最大限に発揮できます。"},HARMONY:{category:"compatibility_type",description:"調和型。2つのOSが自然に溶け合い、安定した統合を示す関係性。",context:"ストレスが少なく、持続可能な成長パターンを築きやすい特徴があります。"},TENSION:{category:"compatibility_type",description:"緊張型。2つのOSに適度な緊張関係があり、創造的エネルギーを生み出す関係性。",context:"この緊張を建設的に活用することで、新しい発見や成長につながります。"},CONFLICT:{category:"compatibility_type",description:"葛藤型。2つのOSが対立的な関係にあり、内的な葛藤を生じさせる関係性。",context:"適切に統合することで、多様性に富んだ豊かな人格の形成が可能です。"},CHAOS:{category:"compatibility_type",description:"混沌型。2つのOSの関係性が予測困難で、変化に富んだダイナミックな関係性。",context:"柔軟性と適応力に優れ、変化の多い環境で力を発揮しやすい特徴があります。"}}}initializeCardExpansion(){this.container.querySelectorAll(".os-detail-card, .os-card").forEach(t=>{const e=t.dataset.cardId||t.className.split(" ").find(t=>t.includes("card"));if(!t.querySelector(".expand-button")){const i=document.createElement("button");i.className="expand-button",i.innerHTML='<span class="expand-icon">⬇</span> 詳細を表示',i.setAttribute("aria-label","カードの詳細情報を展開"),t.appendChild(i),i.addEventListener("click",i=>{i.stopPropagation(),this.toggleCardExpansion(t,e)})}})}toggleCardExpansion(t,e){if(this.expandedCards.has(e))this.collapseCard(t,e);else{if(this.expandedCards.size>=this.options.maxExpandedCards)return void this.showMessage("一度に展開できるカードは"+this.options.maxExpandedCards+"枚までです。","warning");this.expandCard(t,e)}}expandCard(t,e){this.expandedCards.add(e),t.style.transition=`all ${this.options.animationDuration}ms cubic-bezier(0.4, 0, 0.2, 1)`,t.classList.add("expanded"),this.showExpandedContent(t,e);const i=t.querySelector(".expand-button");i&&(i.innerHTML='<span class="expand-icon">⬆</span> 詳細を閉じる'),t.setAttribute("aria-expanded","true"),this.trackEvent("card_expanded",{cardId:e})}collapseCard(t,e){this.expandedCards.delete(e),t.style.transition=`all ${this.options.animationDuration}ms cubic-bezier(0.4, 0, 0.2, 1)`,t.classList.remove("expanded"),this.hideExpandedContent(t,e);const i=t.querySelector(".expand-button");i&&(i.innerHTML='<span class="expand-icon">⬇</span> 詳細を表示'),t.setAttribute("aria-expanded","false"),this.trackEvent("card_collapsed",{cardId:e})}showExpandedContent(t,e){let i=t.querySelector(".expanded-content");i||(i=document.createElement("div"),i.className="expanded-content",t.appendChild(i));const n=this.getCardContentType(t);i.innerHTML=this.generateExpandedContent(e,n),setTimeout(()=>{i.style.opacity="1",i.style.transform="translateY(0)"},50)}hideExpandedContent(t,e){const i=t.querySelector(".expanded-content");i&&(i.style.opacity="0",i.style.transform="translateY(-10px)",setTimeout(()=>{i.parentNode&&i.remove()},this.options.animationDuration))}getCardContentType(t){return t.classList.contains("os-detail-card-engine")?"engine":t.classList.contains("os-detail-card-interface")?"interface":t.classList.contains("os-detail-card-safemode")?"safemode":"general"}generateExpandedContent(t,e){const i=`\n            <div class="expanded-tabs">\n                <div class="tab-headers">\n                    <button class="tab-header active" data-tab="overview">概要</button>\n                    <button class="tab-header" data-tab="details">詳細</button>\n                    <button class="tab-header" data-tab="advice">アドバイス</button>\n                </div>\n                <div class="tab-contents">\n                    <div class="tab-content active" data-tab="overview">\n                        ${this.generateOverviewContent(e)}\n                    </div>\n                    <div class="tab-content" data-tab="details">\n                        ${this.generateDetailsContent(e)}\n                    </div>\n                    <div class="tab-content" data-tab="advice">\n                        ${this.generateAdviceContent(e)}\n                    </div>\n                </div>\n            </div>\n            <div class="expanded-actions">\n                <button class="btn btn-primary more-info-btn">\n                    📚 もっと詳しく\n                </button>\n                <button class="btn btn-secondary share-btn">\n                    📤 この情報を共有\n                </button>\n            </div>\n        `;return setTimeout(()=>this.initializeTabSystem(t),100),i}generateOverviewContent(t){const e={engine:"\n                <h4>🔧 エンジンOSの特徴</h4>\n                <p>あなたの根源的な価値観と動機を表すシステムです。創造性、情熱、そして内なる目標がここに現れます。</p>\n                <ul>\n                    <li>個人の核となる価値観</li>\n                    <li>創造的なエネルギーの源泉</li>\n                    <li>長期的な人生の方向性</li>\n                </ul>\n            ",interface:"\n                <h4>🖥️ インターフェースOSの特徴</h4>\n                <p>外部世界との関わり方を表すシステムです。コミュニケーション、行動パターン、社会的な顔がここに現れます。</p>\n                <ul>\n                    <li>他者との関わり方</li>\n                    <li>職場でのコミュニケーションスタイル</li>\n                    <li>社会的な表現方法</li>\n                </ul>\n            ",safemode:"\n                <h4>🛡️ セーフモードOSの特徴</h4>\n                <p>困難な状況での対処方法を表すシステムです。ストレス対応、防御機制、内面の安全装置がここに現れます。</p>\n                <ul>\n                    <li>ストレス状況での行動パターン</li>\n                    <li>心理的な防御メカニズム</li>\n                    <li>危機管理とリスク対応</li>\n                </ul>\n            "};return e[t]||e.engine}generateDetailsContent(t){return'\n            <h4>📊 詳細分析データ</h4>\n            <div class="detail-metrics">\n                <div class="metric-item">\n                    <span class="metric-label">主要特徴:</span>\n                    <span class="metric-value">創造性重視型</span>\n                </div>\n                <div class="metric-item">\n                    <span class="metric-label">エネルギー傾向:</span>\n                    <span class="metric-value">外向性 85%</span>\n                </div>\n                <div class="metric-item">\n                    <span class="metric-label">安定性:</span>\n                    <span class="metric-value">中程度</span>\n                </div>\n            </div>\n            <p>このOSは特に創造的な場面で力を発揮し、新しいアイデアや解決策を生み出すことに長けています。</p>\n        '}generateAdviceContent(t){return'\n            <h4>💡 実践的アドバイス</h4>\n            <div class="advice-sections">\n                <div class="advice-section">\n                    <h5>🎯 強みを活かすために</h5>\n                    <ul>\n                        <li>創造的なプロジェクトに積極的に参加する</li>\n                        <li>新しいアイデアを形にする機会を求める</li>\n                        <li>チームの発想力を向上させる役割を担う</li>\n                    </ul>\n                </div>\n                <div class="advice-section">\n                    <h5>⚠️ 注意すべきポイント</h5>\n                    <ul>\n                        <li>細かい作業への集中力不足に注意</li>\n                        <li>完璧主義に陥らないよう意識する</li>\n                        <li>他者の意見にも耳を傾ける</li>\n                    </ul>\n                </div>\n            </div>\n        '}initializeTooltipSystem(){this.addTooltipsToTerms(),this.setupDynamicTooltips()}addTooltipsToTerms(){const t=this.getAllTextNodes();Object.keys(this.termsDatabase).forEach(e=>{t.forEach(t=>{t.textContent.includes(e)&&this.wrapTermWithTooltip(t,e)})})}wrapTermWithTooltip(t,e){const i=t.parentNode;if(i.classList.contains("tooltip-term"))return;const n=t.textContent,a=n.indexOf(e);if(-1!==a){const s=n.substring(0,a),o=n.substring(a+e.length),d=document.createElement("span");d.className="tooltip-term",d.setAttribute("data-term",e),d.textContent=e,s&&i.insertBefore(document.createTextNode(s),t),i.insertBefore(d,t),o&&i.insertBefore(document.createTextNode(o),t),i.removeChild(t),this.attachTooltipEvents(d,e)}}attachTooltipEvents(t,e){let i,n;t.addEventListener("mouseenter",a=>{clearTimeout(n),i=setTimeout(()=>{this.showTooltip(t,e,a)},this.options.tooltipDelay)}),t.addEventListener("mouseleave",()=>{clearTimeout(i),n=setTimeout(()=>{this.hideTooltip(e)},100)}),t.addEventListener("focus",i=>{this.showTooltip(t,e,i)}),t.addEventListener("blur",()=>{this.hideTooltip(e)}),t.addEventListener("touchstart",i=>{i.preventDefault(),this.showTooltip(t,e,i)})}showTooltip(t,e,i){if(this.activeTooltips.has(e))return;const n=this.termsDatabase[e];if(!n)return;const a=document.createElement("div");a.className="tooltip-popup",a.innerHTML=`\n            <div class="tooltip-header">\n                <h4>${e}</h4>\n                ${n.reading?`<span class="tooltip-reading">(${n.reading})</span>`:""}\n                <span class="tooltip-category">${this.getCategoryLabel(n.category)}</span>\n            </div>\n            <div class="tooltip-content">\n                <p class="tooltip-description">${n.description}</p>\n                ${n.context?`<p class="tooltip-context"><strong>コンテキスト:</strong> ${n.context}</p>`:""}\n            </div>\n        `,document.body.appendChild(a),this.positionTooltip(a,t,i),setTimeout(()=>{a.classList.add("visible")},10),this.activeTooltips.set(e,a),this.trackEvent("tooltip_shown",{term:e})}hideTooltip(t){const e=this.activeTooltips.get(t);e&&(e.classList.remove("visible"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e),this.activeTooltips.delete(t)},200))}positionTooltip(t,e,i){const n=e.getBoundingClientRect(),a=t.getBoundingClientRect();let s=n.left+n.width/2-a.width/2,o=n.top-a.height-10;s<10&&(s=10),s+a.width>window.innerWidth-10&&(s=window.innerWidth-a.width-10),o<10&&(o=n.bottom+10,t.classList.add("bottom")),t.style.left=s+"px",t.style.top=o+"px"}getCategoryLabel(t){return{hexagram:"64卦",system:"システム",concept:"概念",metric:"指標",compatibility:"相性",compatibility_type:"相性タイプ"}[t]||"用語"}initializeTabSystem(t){const e=this.container.querySelectorAll(`[data-card-id="${t}"] .tab-header`),i=this.container.querySelectorAll(`[data-card-id="${t}"] .tab-content`);e.forEach(n=>{n.addEventListener("click",n=>{const a=n.target.dataset.tab;this.switchTab(t,a,e,i)})}),this.tabStates.set(t,"overview")}switchTab(t,e,i,n){i.forEach(t=>{t.classList.remove("active"),t.dataset.tab===e&&t.classList.add("active")}),n.forEach(t=>{t.classList.remove("active"),t.dataset.tab===e&&t.classList.add("active")}),this.tabStates.set(t,e),this.trackEvent("tab_switched",{cardId:t,targetTab:e})}setupDynamicTooltips(){new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{t.nodeType===Node.ELEMENT_NODE&&this.addTooltipsToElement(t)})})}).observe(this.container,{childList:!0,subtree:!0})}addTooltipsToElement(t){const e=this.getAllTextNodes(t);Object.keys(this.termsDatabase).forEach(t=>{e.forEach(e=>{e.textContent.includes(t)&&this.wrapTermWithTooltip(e,t)})})}getAllTextNodes(t=this.container){const e=[],i=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,null,!1);let n;for(;n=i.nextNode();)n.textContent.trim()&&e.push(n);return e}setupEventListeners(){document.addEventListener("keydown",t=>{"Escape"===t.key&&this.collapseAllCards()}),window.addEventListener("resize",()=>{this.activeTooltips.forEach((t,e)=>{this.hideTooltip(e)})})}collapseAllCards(){Array.from(this.expandedCards).forEach(t=>{const e=this.container.querySelector(`[data-card-id="${t}"]`);e&&this.collapseCard(e,t)})}showMessage(t,e="info"){const i=document.createElement("div");i.className=`interactive-message ${e}`,i.textContent=t,this.container.appendChild(i),setTimeout(()=>{i.classList.add("visible")},10),setTimeout(()=>{i.classList.remove("visible"),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},300)},3e3)}trackEvent(t,e={}){console.log(`📊 Event tracked: ${t}`,e)}activate(){this.options.enableCardExpansion&&this.initializeCardExpansion(),this.options.enableTooltips&&this.initializeTooltipSystem(),console.log("✅ Interactive System activated")}destroy(){this.activeTooltips.forEach((t,e)=>{this.hideTooltip(e)}),this.collapseAllCards(),super.destroy()}}export default InteractiveSystem;