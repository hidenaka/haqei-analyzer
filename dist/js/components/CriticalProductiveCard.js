class CriticalProductiveCard{constructor(i,e={}){this.containerId=i,this.container=document.getElementById(i),this.shadowAnalyzer=e.shadowAnalyzer||(window.ShadowAnalyzer?new window.ShadowAnalyzer:null),this.criticalThinkingEngine=e.criticalThinkingEngine||(window.CriticalThinkingEngine?new window.CriticalThinkingEngine:null),this.analysisResult=e.analysisResult,this.osData=e.osData,this.score=e.score,this.hexagramDetails=e.hexagramDetails,this.isInitialized=!1,this.cardData=null,console.log("🧠 [CriticalProductiveCard] 初期化完了",{containerId:i,hasShadowAnalyzer:!!this.shadowAnalyzer,hasCriticalEngine:!!this.criticalThinkingEngine,score:this.score})}async init(){try{if(console.log("🚀 [CriticalProductiveCard] レンダリング開始"),!this.container)throw new Error(`Container not found: ${this.containerId}`);await this._generateCardData(),await this._render(),this._setupEventListeners(),this.isInitialized=!0,console.log("✅ [CriticalProductiveCard] レンダリング完了")}catch(i){console.error("❌ [CriticalProductiveCard] 初期化エラー:",i),this._renderError(i.message)}}async _generateCardData(){console.log("🔄 [CriticalProductiveCard] データ生成開始"),this.cardData={osName:this.osData?.osName||"未特定OS",score:this.score||0,scoreRange:this._getScoreRange(this.score),critical:await this._generateCriticalContent(),productive:await this._generateProductiveContent(),dynamicInsights:await this._generateDynamicInsights()},console.log("✅ [CriticalProductiveCard] データ生成完了",this.cardData)}async _generateCriticalContent(){if(!this.shadowAnalyzer||!this.osData)return console.warn("⚠️ [CriticalProductiveCard] ShadowAnalyzer未利用または osData 不足"),this._getFallbackCriticalContent();try{const i=this.shadowAnalyzer.analyzeShadow(this.osData,this.score);return{shadowAspects:i.shadowAspects,blindSpotQuestions:i.selfInquiryQuestions||[],growthChallenges:i.growthChallenges,integrationGuidance:i.integrationGuidance}}catch(i){return console.error("❌ [CriticalProductiveCard] 批判的視点生成エラー:",i),this._getFallbackCriticalContent()}}async _generateProductiveContent(){if(!this.criticalThinkingEngine)return console.warn("⚠️ [CriticalProductiveCard] CriticalThinkingEngine未利用"),this._getFallbackProductiveContent();try{const i=this._generateScoreBasedQuestions(),e=this._generatePracticalSteps(),n=this._generateBiasRecognition();return{scoreBasedQuestions:i,practicalSteps:e,integrationGuidance:this._generateIntegrationGuidance(),biasRecognition:n}}catch(i){return console.error("❌ [CriticalProductiveCard] 生産的視点生成エラー:",i),this._getFallbackProductiveContent()}}async _generateDynamicInsights(){if(!this.hexagramDetails&&!window.HEXAGRAM_DETAILS)return console.warn("⚠️ [CriticalProductiveCard] hexagram_details未利用"),null;try{const i=this.osData?.hexagramId||this.osData?.osId,e=this.hexagramDetails||window.HEXAGRAM_DETAILS&&window.HEXAGRAM_DETAILS[i];return e?{engineWeaknesses:e.engine?.potential_weaknesses||[],triggerSituations:e.safe_mode?.trigger_situations||[],defensivePatterns:e.safe_mode?.defensive_patterns||[],strengthToShadowMapping:this._mapStrengthsToShadows(e.engine?.potential_strengths||[])}:(console.warn(`⚠️ [CriticalProductiveCard] 卦${i}の詳細データなし`),null)}catch(i){return console.error("❌ [CriticalProductiveCard] 動的インサイト生成エラー:",i),null}}async _render(){const i=`\n            <div class="critical-productive-card" data-score-range="${this.cardData.scoreRange}">\n                ${this._renderHeader()}\n                ${this._renderCriticalSection()}\n                ${this._renderProductiveSection()}\n                ${this._renderDynamicInsightsSection()}\n            </div>\n        `;this.container.innerHTML=i}_renderHeader(){return`\n            <div class="card-header">\n                <h3 class="card-title">🧠 批判的・生産的視点</h3>\n                <div class="score-indicator" data-score="${this.cardData.score}%">\n                    <span class="score-value">${this.cardData.score}%</span>\n                    <span class="score-label">${this.cardData.osName}</span>\n                </div>\n            </div>\n        `}_renderCriticalSection(){const i=this.cardData.critical;return`\n            <div class="critical-section collapsible" data-expanded="false">\n                <div class="section-header" onclick="window.criticalProductiveCard.toggleSection(this)">\n                    <h4>🌑 批判的視点 <span class="expand-indicator">▼</span></h4>\n                </div>\n                <div class="section-content">\n                    ${this._renderShadowAnalysis(i.shadowAspects)}\n                    ${this._renderBlindSpotQuestions(i.blindSpotQuestions)}\n                    ${this._renderGrowthChallenges(i.growthChallenges)}\n                </div>\n            </div>\n        `}_renderProductiveSection(){const i=this.cardData.productive;return`\n            <div class="productive-section collapsible" data-expanded="true">\n                <div class="section-header" onclick="window.criticalProductiveCard.toggleSection(this)">\n                    <h4>🌱 生産的視点 <span class="expand-indicator">▲</span></h4>\n                </div>\n                <div class="section-content">\n                    ${this._renderActionQuestions(i.scoreBasedQuestions)}\n                    ${this._renderPracticalSteps(i.practicalSteps)}\n                    ${this._renderIntegrationGuidance(i.integrationGuidance)}\n                </div>\n            </div>\n        `}_renderDynamicInsightsSection(){if(!this.cardData.dynamicInsights)return"";const i=this.cardData.dynamicInsights;return`\n            <div class="dynamic-insights-section collapsible" data-expanded="false">\n                <div class="section-header" onclick="window.criticalProductiveCard.toggleSection(this)">\n                    <h4>💡 動的インサイト <span class="expand-indicator">▼</span></h4>\n                </div>\n                <div class="section-content">\n                    ${this._renderHexagramInsights(i)}\n                </div>\n            </div>\n        `}_renderShadowAnalysis(i){if(!i)return"<p>シャドウ分析データがありません</p>";const e=i.intensity_level||"不明",n=i.likelihood||"0%";return`\n            <div class="shadow-analysis">\n                <h5>影の側面</h5>\n                <div class="shadow-item" data-intensity="${e}">\n                    <p class="primary-shadow">${i.primary_shadow||"影の側面を分析中..."}</p>\n                    <div class="behavioral-risks">${i.behavioral_risks||""}</div>\n                    <div class="likelihood-meter">\n                        <span class="likelihood-label">発現可能性</span>\n                        <div class="likelihood-bar-container">\n                            <div class="likelihood-bar" style="width: ${n}"></div>\n                        </div>\n                        <span class="likelihood-value">${n}</span>\n                    </div>\n                </div>\n            </div>\n        `}_renderBlindSpotQuestions(i){if(!i||0===i.length)return'<div class="blind-spot-questions"><h5>盲点への気づき</h5><p>質問データを準備中...</p></div>';return`\n            <div class="blind-spot-questions">\n                <h5>盲点への気づき</h5>\n                <div class="question-list">${i.map(i=>`\n            <div class="question-card">\n                <div class="question-text">${i.question}</div>\n                <div class="question-purpose">${i.purpose}</div>\n            </div>\n        `).join("")}</div>\n            </div>\n        `}_renderGrowthChallenges(i){return i?`\n            <div class="growth-challenges">\n                <h5>成長課題</h5>\n                <div class="primary-challenge">${i.primary_challenge||""}</div>\n                <div class="development-areas">\n                    ${(i.development_areas||[]).map(i=>`<span class="area-tag">${i}</span>`).join("")}\n                </div>\n            </div>\n        `:""}_renderActionQuestions(i){if(!i||0===i.length)return'<div class="action-questions"><h5>建設的な問いかけ</h5><p>質問を生成中...</p></div>';return`\n            <div class="action-questions">\n                <h5>建設的な問いかけ</h5>\n                <div class="question-cards">${i.map(i=>`\n            <div class="question-card">\n                <div class="question-category">${i.category}</div>\n                <div class="question-text">${i.question}</div>\n                <div class="question-purpose">${i.purpose}</div>\n            </div>\n        `).join("")}</div>\n            </div>\n        `}_renderPracticalSteps(i){if(!i||0===i.length)return'<div class="practical-steps"><h5>実践的ステップ</h5><p>ステップを準備中...</p></div>';return`\n            <div class="practical-steps">\n                <h5>実践的ステップ</h5>\n                <div class="steps-timeline">${i.map(i=>`\n            <div class="step-item">\n                <div class="step-number">${i.step}</div>\n                <div class="step-content">\n                    <div class="step-action">${i.action}</div>\n                    <div class="step-description">${i.description}</div>\n                </div>\n            </div>\n        `).join("")}</div>\n            </div>\n        `}_renderIntegrationGuidance(i){if(!i)return"";const e=this.cardData?.osName||this.osData?.osName||"未特定OS";return`\n            <div class="integration-guidance">\n                <h5>統合ガイダンス</h5>\n                <div class="mindset-shift">\n                    <div class="from-to-display">\n                        <div class="from">From: 「私は${e}だ」（固定的思考）</div>\n                        <div class="arrow">→</div>\n                        <div class="to">To: 「私は${e}の傾向があり、影も含めて成長できる」（成長的思考）</div>\n                    </div>\n                </div>\n            </div>\n        `}_renderHexagramInsights(i){return`\n            <div class="hexagram-insights">\n                <h5>易経からの洞察</h5>\n                <div class="insights-grid">\n                    <div class="insight-item">\n                        <h6>潜在的弱点</h6>\n                        <ul>${i.engineWeaknesses.map(i=>`<li>${i}</li>`).join("")}</ul>\n                    </div>\n                    <div class="insight-item">\n                        <h6>トリガー状況</h6>\n                        <ul>${i.triggerSituations.map(i=>`<li>${i}</li>`).join("")}</ul>\n                    </div>\n                    <div class="insight-item">\n                        <h6>防御パターン</h6>\n                        <ul>${i.defensivePatterns.map(i=>`<li>${i}</li>`).join("")}</ul>\n                    </div>\n                </div>\n            </div>\n        `}toggleSection(i){const e=i.parentElement,n="true"===e.getAttribute("data-expanded"),t=i.querySelector(".expand-indicator");e.setAttribute("data-expanded",(!n).toString()),t.textContent=n?"▼":"▲",console.log("🔄 [CriticalProductiveCard] セクション"+(n?"折りたたみ":"展開"))}_setupEventListeners(){window.criticalProductiveCard=this,console.log("🎧 [CriticalProductiveCard] イベントリスナー設定完了")}_getScoreRange(i){return i>=70?"high":i>=30?"medium":"low"}_generateScoreBasedQuestions(){const i=this._getScoreRange(this.score),e=this.cardData?.osName||this.osData?.osName||"未特定OS",n=this.score;return{high:[{category:"identity_fixation",question:`「私は${e}だから」という考えで、本来なら取るべき行動を避けた経験はありませんか？`,purpose:"アイデンティティ固着の検証"},{category:"environmental_limits",question:`この${e}の特性が通用しない環境や相手は、具体的にどのような場合でしょうか？`,purpose:"適用限界の理解"}],medium:[{category:"potential_expansion",question:`この${n}%という結果は、あなたの潜在的な可能性を適切に表していますか？`,purpose:"潜在可能性の探求"}],low:[{category:"hidden_potential",question:`この${n}%という低い数値は、本当にあなたの限界を示していますか？`,purpose:"隠れた可能性の発見"}]}[i]||[]}_generatePracticalSteps(){return[{step:1,action:"観察",description:"日常の行動パターンを意識的に観察する"},{step:2,action:"一時停止",description:"問題のパターンが出そうな時に、一度立ち止まって考える習慣をつける"},{step:3,action:"代替選択",description:"バランスを意識した別の選択肢を検討する"},{step:4,action:"小さな実験",description:"リスクの少ない場面で、新しい行動パターンを試してみる"},{step:5,action:"振り返り",description:"結果を振り返り、学びを次に活かす"}]}_generateBiasRecognition(){return{common_biases:["確証バイアス","自己奉仕バイアス","ダニング・クルーガー効果"],measurement_limits:"64通りのパターンで人間の複雑さを完全に捉えることの限界"}}_generateIntegrationGuidance(){const i=this.cardData?.osName||this.osData?.osName||"未特定OS";return{shadow_acceptance:"影の部分も「あなたの一部」として受け入れることから始まります",mindset_shift:{from:`「私は${i}だ」（固定的思考）`,to:`「私は${i}の傾向があり、影も含めて成長できる」（成長的思考）`},integration_timeline:"すぐに変わる必要はありません。まずは「気づき」から始めてください"}}_mapStrengthsToShadows(i){return i.map(i=>`${i} → 過度な依存や極端な表現による弊害`)}_getFallbackCriticalContent(){return{shadowAspects:{primary_shadow:`${this.cardData?.osName||this.osData?.osName||"未特定OS"}の特性の過度な表現や誤用`,behavioral_risks:"バランスを欠いた行動パターン",intensity_level:"中",likelihood:"50%"},blindSpotQuestions:[{type:"generic",question:"この特性に頼りすぎて、他の能力の発達を怠っていませんか？",purpose:"バランスの確認"}],growthChallenges:{primary_challenge:"バランスの取れた自己表現",development_areas:["自己観察","フィードバック収集"],recommended_practices:["日記による自己観察","他者からの意見収集"]}}}_getFallbackProductiveContent(){return{scoreBasedQuestions:this._generateScoreBasedQuestions(),practicalSteps:this._generatePracticalSteps(),integrationGuidance:this._generateIntegrationGuidance(),biasRecognition:this._generateBiasRecognition()}}_renderError(i){this.container.innerHTML=`\n            <div class="critical-productive-card error">\n                <div class="error-message">\n                    <h3>🧠 批判的・生産的視点</h3>\n                    <p>申し訳ございません。データの読み込みに失敗しました。</p>\n                    <p class="error-details">${i}</p>\n                </div>\n            </div>\n        `}}"undefined"!=typeof window&&(window.CriticalProductiveCard=CriticalProductiveCard,console.log("✅ [CriticalProductiveCard] グローバル登録完了")),"undefined"!=typeof module&&module.exports&&(module.exports=CriticalProductiveCard);