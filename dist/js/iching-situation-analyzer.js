class IChingSituationAnalyzer{constructor(){this.h384Data=null,this.hexagramMapping=this.initHexagramMapping(),this.keywordDatabase=this.initKeywordDatabase(),this.emotionDetector=new EmotionDetector,console.log("🎯 I Ching Situation Analyzer initialized")}async init(){try{return window.H384_DATA&&Array.isArray(window.H384_DATA)?(this.h384Data=window.H384_DATA,console.log("✅ H384_DATA loaded:",this.h384Data.length,"entries"),!0):(console.error("❌ H384_DATA not available"),!1)}catch(e){return console.error("❌ Failed to initialize:",e),!1}}analyzeSituation(e){console.log("🔍 [DEBUG] IChingSituationAnalyzer.analyzeSituation called with:",e.substring(0,50)+"..."),console.log("🔍 [DEBUG] H384 Data available:",!!this.h384Data,"entries:",this.h384Data?this.h384Data.length:0);try{const n=this.preprocessText(e),t=this.extractKeywords(n),a=this.emotionDetector.analyze(n),o=this.identifySituationPattern(n,t,a),r=this.selectHexagram(o,t,a),i=this.selectYao(r,o,a),s={hexagram:r,yao:i,confidence:this.calculateConfidence(t,a,o),analysis:{keywords:t,emotion:a,pattern:o,metaphor:this.generateMetaphor(r,i),currentTheme:this.getCurrentTheme(r,i)},h384Entry:this.getH384Entry(r.number,i.position)};return console.log("✅ [DEBUG] Analysis result generated:",{hexagramName:s.hexagram?.name,yaoName:s.yao?.name,confidence:s.confidence,h384Available:!!s.h384Entry}),s}catch(n){return console.error("❌ Analysis failed:",n),this.getFallbackResult(e)}}preprocessText(e){return e.toLowerCase().replace(/[「」『』（）\(\)]/g," ").replace(/[。、！？!?]/g," ").replace(/\s+/g," ").trim()}extractKeywords(e){const n=[],t={anxiety:["不安","心配","悩み","困っ","迷っ","やばい","まずい"],stress:["ストレス","疲れ","きつい","しんどい","限界","忙しい"],confusion:["分からない","どうし","わからん","混乱","迷子"],hope:["期待","希望","やる気","頑張","成功","成長"],fear:["怖い","恐れ","不安","リスク","危険","失敗"],anger:["腹立つ","怒り","ムカ","イライラ","許せな"]},a={career:["仕事","会社","転職","職場","キャリア","同僚","上司","部下"],love:["恋愛","彼氏","彼女","恋人","好き","別れ","結婚","デート"],family:["家族","親","子供","兄弟","姉妹","夫","妻","家庭"],health:["健康","病気","体調","疲労","医者","病院","薬"],money:["お金","金銭","給料","収入","支出","借金","投資","節約"],study:["勉強","学校","試験","受験","資格","学習","教育"],relationship:["人間関係","友達","友人","コミュニケーション","孤独"]};for(const[o,r]of Object.entries({...t,...a}))for(const t of r)e.includes(t)&&n.push({word:t,category:o,weight:this.calculateKeywordWeight(t,e)});return n.sort((e,n)=>n.weight-e.weight)}calculateKeywordWeight(e,n){return 2*(n.match(new RegExp(e,"g"))||[]).length+(1-n.indexOf(e)/n.length)+.5*e.length}identifySituationPattern(e,n,t){const a={beginning:["始まり","開始","スタート","初めて","新しい"],crisis:["危機","ピンチ","大変","緊急","切羽詰まっ"],stagnation:["停滞","進まない","変わらな","同じ","マンネリ"],growth:["成長","発展","進歩","向上","改善"],transformation:["変化","変わる","転換","変革","革命"],completion:["完成","終了","完了","ゴール","達成"],conflict:["対立","争い","喧嘩","問題","トラブル"],cooperation:["協力","チーム","一緒","協働","連携"]},o={};for(const[i,s]of Object.entries(a)){let n=0;for(const t of s)e.includes(t)&&(n+=this.calculateKeywordWeight(t,e));n>0&&(o[i]=n)}"anxiety"===t.dominant&&(o.crisis=(o.crisis||0)+3),"confusion"===t.dominant&&(o.stagnation=(o.stagnation||0)+3);const r=Object.entries(o).sort((e,n)=>n[1]-e[1])[0];return{primary:r?r[0]:"stagnation",scores:o,confidence:r?r[1]/10:.3}}selectHexagram(e,n,t){console.log("🎯 [DEBUG] selectHexagram called with pattern:",e.primary);const a=this.getHexagramByPattern(e.primary);console.log("🎯 [DEBUG] hexagramPriority array:",a.length,"entries");let o=a&&a.length>0?a[0]:this.hexagramMapping["乾"];if(console.log("🎯 [DEBUG] selectedHexagram before emotion adjustment:",o?.name),"anxiety"===t.dominant&&t.intensity>.7){const e=this.hexagramMapping["需"]||this.hexagramMapping["謙"];e&&(o=e,console.log("🎯 [DEBUG] Anxiety adjustment -> 需/謙"))}else if("hope"===t.dominant&&t.intensity>.6){const e=this.hexagramMapping["乾"];e&&(o=e,console.log("🎯 [DEBUG] Hope adjustment -> 乾"))}return o&&o.number&&o.name||(console.warn("⚠️ [DEBUG] Invalid hexagram selected, using fallback"),o=this.hexagramMapping["乾"]),console.log("🎯 [DEBUG] Final selected hexagram:",{name:o.name,number:o.number,symbol:o.symbol}),o}getHexagramByPattern(e){console.log("🎯 [DEBUG] getHexagramByPattern called with:",e);const n={beginning:["屯","蒙","需"],crisis:["坎","困","蹇"],stagnation:["否","遯","艮"],growth:["晋","升","漸"],transformation:["革","鼎","震"],completion:["既済","履","泰"],conflict:["訟","師","同人"],cooperation:["比","萃","豫"]}[e]||["屯","需","比"];console.log("🎯 [DEBUG] Pattern mapped to hexagram names:",n);const t=[];for(const a of n){const e=this.hexagramMapping[a];e&&e.number&&e.name?(t.push(e),console.log("🎯 [DEBUG] Valid hexagram added:",e.name)):console.warn("⚠️ [DEBUG] Invalid hexagram skipped:",a)}if(0===t.length){console.warn("⚠️ [DEBUG] No valid hexagrams found, adding fallback");const e=this.hexagramMapping["乾"];e&&t.push(e)}return console.log("🎯 [DEBUG] Final hexagrams array length:",t.length),t}selectYao(e,n,t){console.log("🎯 [DEBUG] selectYao called with pattern:",n.primary);let a=1;switch(n.primary){case"beginning":a=1,console.log("🎯 [DEBUG] Beginning pattern -> position 1");break;case"growth":a=2,console.log("🎯 [DEBUG] Growth pattern -> position 2");break;case"crisis":a=3,console.log("🎯 [DEBUG] Crisis pattern -> position 3");break;case"transformation":a=4,console.log("🎯 [DEBUG] Transformation pattern -> position 4");break;case"completion":a=5,console.log("🎯 [DEBUG] Completion pattern -> position 5");break;case"stagnation":a=6,console.log("🎯 [DEBUG] Stagnation pattern -> position 6");break;default:a=Math.floor(6*Math.random())+1,console.log("🎯 [DEBUG] Default/random pattern -> position",a)}t&&t.intensity>.8&&(a=Math.min(6,a+1),console.log("🎯 [DEBUG] High emotion intensity adjustment -> position",a)),a=Math.max(1,Math.min(6,a)),console.log("🎯 [DEBUG] Final position after range check:",a);const o={position:a,name:["初","二","三","四","五","上"][a-1],description:this.getYaoDescription(a)};return console.log("🎯 [DEBUG] Final yao object:",o),o}getH384Entry(e,n){if(console.log("🎯 [DEBUG] getH384Entry called with:",{hexagramNumber:e,yaoPosition:n}),!this.h384Data||!Array.isArray(this.h384Data))return console.warn("⚠️ [DEBUG] H384 data not available"),null;if(!e||!n||e<1||e>64||n<1||n>6)return console.warn("⚠️ [DEBUG] Invalid input values:",{hexagramNumber:e,yaoPosition:n}),null;const t=6*(e-1)+n;if(console.log("🎯 [DEBUG] Calculated sequence number:",t),t<1||t>384)return console.warn("⚠️ [DEBUG] Sequence number out of range:",t),null;const a=this.h384Data.find(e=>e["通し番号"]===t);if(a)console.log("🎯 [DEBUG] Found H384 entry:",{sequenceNumber:a["通し番号"],hexagramName:a["卦名"],keywords:a["キーワード"]?.slice(0,3)});else if(console.warn("⚠️ [DEBUG] H384 entry not found for sequence:",t),this.h384Data.length>0)return console.log("🎯 [DEBUG] Using fallback H384 entry"),this.h384Data[0];return a||null}calculateConfidence(e,n,t){let a=.5;const o=e.reduce((e,n)=>e+n.weight,0)/20;return a+=Math.min(.3,o),a+=.2*n.intensity,a+=.2*t.confidence,Math.min(1,Math.max(.3,a))}generateMetaphor(e,n){const t=this.getH384Entry(e.number,n.position);if(!t)return"変化の時";const a=t["キーワード"]||[],o=t["現代解釈の要約"]||"";return{primary:a[0]||"変化",keywords:a,situation:o,symbol:`${e.name}の${n.name}爻`}}getCurrentTheme(e,n){const t=this.getH384Entry(e.number,n.position);return t?{theme:t["キーワード"][0]||"変化",description:t["現代解釈の要約"]||"",stance:t["S5_主体性推奨スタンス"]||"中立",risk:t["S4_リスク"]||0,potential:t["S2_ポテンシャル"]||50}:"この時期のテーマ"}getFallbackResult(e){return{hexagram:{number:1,name:"乾為天"},yao:{position:1,name:"初",description:"始まりの時"},confidence:.3,analysis:{keywords:[{word:"状況",category:"general",weight:1}],emotion:{dominant:"neutral",intensity:.5},pattern:{primary:"beginning",confidence:.3},metaphor:{primary:"始まり",situation:e.substring(0,50)+"..."},currentTheme:{theme:"新しい展開",description:"現在は新しい始まりの時期です。"}},h384Entry:this.h384Data?this.h384Data[0]:null}}initHexagramMapping(){return{"乾":{number:1,name:"乾為天",symbol:"☰☰"},"坤":{number:2,name:"坤為地",symbol:"☷☷"},"屯":{number:3,name:"水雷屯",symbol:"☵☳"},"蒙":{number:4,name:"山水蒙",symbol:"☶☵"},"需":{number:5,name:"水天需",symbol:"☵☰"},"訟":{number:6,name:"天水訟",symbol:"☰☵"},"師":{number:7,name:"地水師",symbol:"☷☵"},"比":{number:8,name:"水地比",symbol:"☵☷"},"坎":{number:29,name:"坎為水",symbol:"☵☵"},"困":{number:47,name:"沢水困",symbol:"☱☵"},"蹇":{number:39,name:"水山蹇",symbol:"☵☶"},"否":{number:12,name:"天地否",symbol:"☰☷"},"遯":{number:33,name:"天山遯",symbol:"☰☶"},"艮":{number:52,name:"艮為山",symbol:"☶☶"},"晋":{number:35,name:"火地晋",symbol:"☲☷"},"升":{number:46,name:"地風升",symbol:"☷☴"},"漸":{number:53,name:"風山漸",symbol:"☴☶"},"革":{number:49,name:"沢火革",symbol:"☱☲"},"鼎":{number:50,name:"火風鼎",symbol:"☲☴"},"震":{number:51,name:"震為雷",symbol:"☳☳"},"既済":{number:63,name:"水火既済",symbol:"☵☲"},"履":{number:10,name:"天沢履",symbol:"☰☱"},"泰":{number:11,name:"地天泰",symbol:"☷☰"},"同人":{number:13,name:"天火同人",symbol:"☰☲"},"萃":{number:45,name:"沢地萃",symbol:"☱☷"},"豫":{number:16,name:"雷地豫",symbol:"☳☷"}}}initKeywordDatabase(){return{}}getYaoDescription(e){return{1:"物事の始まり、基礎を固める時",2:"発展の兆し、協力者との出会い",3:"試練の時、注意深い行動が必要",4:"転換点、重要な決断の時",5:"最高の時、リーダーシップを発揮",6:"行き過ぎ、謙虚さが必要"}[e]||"変化の時"}}class EmotionDetector{analyze(e){const n={anxiety:0,hope:0,anger:0,sadness:0,fear:0,confusion:0,excitement:0},t={anxiety:["不安","心配","悩み","迷っ","やばい"],hope:["期待","希望","やる気","楽しみ","嬉しい"],anger:["腹立つ","怒り","ムカ","イライラ"],sadness:["悲しい","寂しい","辛い","涙"],fear:["怖い","恐れ","不安","心配"],confusion:["分からない","混乱","どうして","なぜ"],excitement:["興奮","わくわく","楽しい","最高"]};let a=0;for(const[r,i]of Object.entries(t))for(const t of i){const o=(e.match(new RegExp(t,"g"))||[]).length;n[r]+=o,a+=o}if(a>0)for(const r in n)n[r]=n[r]/a;const o=Object.entries(n).sort((e,n)=>n[1]-e[1])[0];return{dominant:o[0],intensity:o[1],all:n}}}window.IChingSituationAnalyzer=IChingSituationAnalyzer;