class IChingSituationAnalyzer{constructor(){this.h384Data=null,this.hexagramMapping=this.initHexagramMapping(),this.keywordDatabase=this.initKeywordDatabase(),this.emotionDetector=new EmotionDetector,console.log("ğŸ¯ I Ching Situation Analyzer initialized")}async init(){try{return window.H384_DATA&&Array.isArray(window.H384_DATA)?(this.h384Data=window.H384_DATA,console.log("âœ… H384_DATA loaded:",this.h384Data.length,"entries"),!0):(console.error("âŒ H384_DATA not available"),!1)}catch(e){return console.error("âŒ Failed to initialize:",e),!1}}analyzeSituation(e){console.log("ğŸ” [DEBUG] IChingSituationAnalyzer.analyzeSituation called with:",e.substring(0,50)+"..."),console.log("ğŸ” [DEBUG] H384 Data available:",!!this.h384Data,"entries:",this.h384Data?this.h384Data.length:0);try{const n=this.preprocessText(e),t=this.extractKeywords(n),a=this.emotionDetector.analyze(n),o=this.identifySituationPattern(n,t,a),r=this.selectHexagram(o,t,a),i=this.selectYao(r,o,a),s={hexagram:r,yao:i,confidence:this.calculateConfidence(t,a,o),analysis:{keywords:t,emotion:a,pattern:o,metaphor:this.generateMetaphor(r,i),currentTheme:this.getCurrentTheme(r,i)},h384Entry:this.getH384Entry(r.number,i.position)};return console.log("âœ… [DEBUG] Analysis result generated:",{hexagramName:s.hexagram?.name,yaoName:s.yao?.name,confidence:s.confidence,h384Available:!!s.h384Entry}),s}catch(n){return console.error("âŒ Analysis failed:",n),this.getFallbackResult(e)}}preprocessText(e){return e.toLowerCase().replace(/[ã€Œã€ã€ã€ï¼ˆï¼‰\(\)]/g," ").replace(/[ã€‚ã€ï¼ï¼Ÿ!?]/g," ").replace(/\s+/g," ").trim()}extractKeywords(e){const n=[],t={anxiety:["ä¸å®‰","å¿ƒé…","æ‚©ã¿","å›°ã£","è¿·ã£","ã‚„ã°ã„","ã¾ãšã„"],stress:["ã‚¹ãƒˆãƒ¬ã‚¹","ç–²ã‚Œ","ãã¤ã„","ã—ã‚“ã©ã„","é™ç•Œ","å¿™ã—ã„"],confusion:["åˆ†ã‹ã‚‰ãªã„","ã©ã†ã—","ã‚ã‹ã‚‰ã‚“","æ··ä¹±","è¿·å­"],hope:["æœŸå¾…","å¸Œæœ›","ã‚„ã‚‹æ°—","é ‘å¼µ","æˆåŠŸ","æˆé•·"],fear:["æ€–ã„","æã‚Œ","ä¸å®‰","ãƒªã‚¹ã‚¯","å±é™º","å¤±æ•—"],anger:["è…¹ç«‹ã¤","æ€’ã‚Š","ãƒ ã‚«","ã‚¤ãƒ©ã‚¤ãƒ©","è¨±ã›ãª"]},a={career:["ä»•äº‹","ä¼šç¤¾","è»¢è·","è·å ´","ã‚­ãƒ£ãƒªã‚¢","åŒåƒš","ä¸Šå¸","éƒ¨ä¸‹"],love:["æ‹æ„›","å½¼æ°","å½¼å¥³","æ‹äºº","å¥½ã","åˆ¥ã‚Œ","çµå©š","ãƒ‡ãƒ¼ãƒˆ"],family:["å®¶æ—","è¦ª","å­ä¾›","å…„å¼Ÿ","å§‰å¦¹","å¤«","å¦»","å®¶åº­"],health:["å¥åº·","ç—…æ°—","ä½“èª¿","ç–²åŠ´","åŒ»è€…","ç—…é™¢","è–¬"],money:["ãŠé‡‘","é‡‘éŠ­","çµ¦æ–™","åå…¥","æ”¯å‡º","å€Ÿé‡‘","æŠ•è³‡","ç¯€ç´„"],study:["å‹‰å¼·","å­¦æ ¡","è©¦é¨“","å—é¨“","è³‡æ ¼","å­¦ç¿’","æ•™è‚²"],relationship:["äººé–“é–¢ä¿‚","å‹é”","å‹äºº","ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³","å­¤ç‹¬"]};for(const[o,r]of Object.entries({...t,...a}))for(const t of r)e.includes(t)&&n.push({word:t,category:o,weight:this.calculateKeywordWeight(t,e)});return n.sort((e,n)=>n.weight-e.weight)}calculateKeywordWeight(e,n){return 2*(n.match(new RegExp(e,"g"))||[]).length+(1-n.indexOf(e)/n.length)+.5*e.length}identifySituationPattern(e,n,t){const a={beginning:["å§‹ã¾ã‚Š","é–‹å§‹","ã‚¹ã‚¿ãƒ¼ãƒˆ","åˆã‚ã¦","æ–°ã—ã„"],crisis:["å±æ©Ÿ","ãƒ”ãƒ³ãƒ","å¤§å¤‰","ç·Šæ€¥","åˆ‡ç¾½è©°ã¾ã£"],stagnation:["åœæ»","é€²ã¾ãªã„","å¤‰ã‚ã‚‰ãª","åŒã˜","ãƒãƒ³ãƒãƒª"],growth:["æˆé•·","ç™ºå±•","é€²æ­©","å‘ä¸Š","æ”¹å–„"],transformation:["å¤‰åŒ–","å¤‰ã‚ã‚‹","è»¢æ›","å¤‰é©","é©å‘½"],completion:["å®Œæˆ","çµ‚äº†","å®Œäº†","ã‚´ãƒ¼ãƒ«","é”æˆ"],conflict:["å¯¾ç«‹","äº‰ã„","å–§å˜©","å•é¡Œ","ãƒˆãƒ©ãƒ–ãƒ«"],cooperation:["å”åŠ›","ãƒãƒ¼ãƒ ","ä¸€ç·’","å”åƒ","é€£æº"]},o={};for(const[i,s]of Object.entries(a)){let n=0;for(const t of s)e.includes(t)&&(n+=this.calculateKeywordWeight(t,e));n>0&&(o[i]=n)}"anxiety"===t.dominant&&(o.crisis=(o.crisis||0)+3),"confusion"===t.dominant&&(o.stagnation=(o.stagnation||0)+3);const r=Object.entries(o).sort((e,n)=>n[1]-e[1])[0];return{primary:r?r[0]:"stagnation",scores:o,confidence:r?r[1]/10:.3}}selectHexagram(e,n,t){console.log("ğŸ¯ [DEBUG] selectHexagram called with pattern:",e.primary);const a=this.getHexagramByPattern(e.primary);console.log("ğŸ¯ [DEBUG] hexagramPriority array:",a.length,"entries");let o=a&&a.length>0?a[0]:this.hexagramMapping["ä¹¾"];if(console.log("ğŸ¯ [DEBUG] selectedHexagram before emotion adjustment:",o?.name),"anxiety"===t.dominant&&t.intensity>.7){const e=this.hexagramMapping["éœ€"]||this.hexagramMapping["è¬™"];e&&(o=e,console.log("ğŸ¯ [DEBUG] Anxiety adjustment -> éœ€/è¬™"))}else if("hope"===t.dominant&&t.intensity>.6){const e=this.hexagramMapping["ä¹¾"];e&&(o=e,console.log("ğŸ¯ [DEBUG] Hope adjustment -> ä¹¾"))}return o&&o.number&&o.name||(console.warn("âš ï¸ [DEBUG] Invalid hexagram selected, using fallback"),o=this.hexagramMapping["ä¹¾"]),console.log("ğŸ¯ [DEBUG] Final selected hexagram:",{name:o.name,number:o.number,symbol:o.symbol}),o}getHexagramByPattern(e){console.log("ğŸ¯ [DEBUG] getHexagramByPattern called with:",e);const n={beginning:["å±¯","è’™","éœ€"],crisis:["å","å›°","è¹‡"],stagnation:["å¦","é¯","è‰®"],growth:["æ™‹","å‡","æ¼¸"],transformation:["é©","é¼","éœ‡"],completion:["æ—¢æ¸ˆ","å±¥","æ³°"],conflict:["è¨Ÿ","å¸«","åŒäºº"],cooperation:["æ¯”","èƒ","è±«"]}[e]||["å±¯","éœ€","æ¯”"];console.log("ğŸ¯ [DEBUG] Pattern mapped to hexagram names:",n);const t=[];for(const a of n){const e=this.hexagramMapping[a];e&&e.number&&e.name?(t.push(e),console.log("ğŸ¯ [DEBUG] Valid hexagram added:",e.name)):console.warn("âš ï¸ [DEBUG] Invalid hexagram skipped:",a)}if(0===t.length){console.warn("âš ï¸ [DEBUG] No valid hexagrams found, adding fallback");const e=this.hexagramMapping["ä¹¾"];e&&t.push(e)}return console.log("ğŸ¯ [DEBUG] Final hexagrams array length:",t.length),t}selectYao(e,n,t){console.log("ğŸ¯ [DEBUG] selectYao called with pattern:",n.primary);let a=1;switch(n.primary){case"beginning":a=1,console.log("ğŸ¯ [DEBUG] Beginning pattern -> position 1");break;case"growth":a=2,console.log("ğŸ¯ [DEBUG] Growth pattern -> position 2");break;case"crisis":a=3,console.log("ğŸ¯ [DEBUG] Crisis pattern -> position 3");break;case"transformation":a=4,console.log("ğŸ¯ [DEBUG] Transformation pattern -> position 4");break;case"completion":a=5,console.log("ğŸ¯ [DEBUG] Completion pattern -> position 5");break;case"stagnation":a=6,console.log("ğŸ¯ [DEBUG] Stagnation pattern -> position 6");break;default:a=Math.floor(6*Math.random())+1,console.log("ğŸ¯ [DEBUG] Default/random pattern -> position",a)}t&&t.intensity>.8&&(a=Math.min(6,a+1),console.log("ğŸ¯ [DEBUG] High emotion intensity adjustment -> position",a)),a=Math.max(1,Math.min(6,a)),console.log("ğŸ¯ [DEBUG] Final position after range check:",a);const o={position:a,name:["åˆ","äºŒ","ä¸‰","å››","äº”","ä¸Š"][a-1],description:this.getYaoDescription(a)};return console.log("ğŸ¯ [DEBUG] Final yao object:",o),o}getH384Entry(e,n){if(console.log("ğŸ¯ [DEBUG] getH384Entry called with:",{hexagramNumber:e,yaoPosition:n}),!this.h384Data||!Array.isArray(this.h384Data))return console.warn("âš ï¸ [DEBUG] H384 data not available"),null;if(!e||!n||e<1||e>64||n<1||n>6)return console.warn("âš ï¸ [DEBUG] Invalid input values:",{hexagramNumber:e,yaoPosition:n}),null;const t=6*(e-1)+n;if(console.log("ğŸ¯ [DEBUG] Calculated sequence number:",t),t<1||t>384)return console.warn("âš ï¸ [DEBUG] Sequence number out of range:",t),null;const a=this.h384Data.find(e=>e["é€šã—ç•ªå·"]===t);if(a)console.log("ğŸ¯ [DEBUG] Found H384 entry:",{sequenceNumber:a["é€šã—ç•ªå·"],hexagramName:a["å¦å"],keywords:a["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"]?.slice(0,3)});else if(console.warn("âš ï¸ [DEBUG] H384 entry not found for sequence:",t),this.h384Data.length>0)return console.log("ğŸ¯ [DEBUG] Using fallback H384 entry"),this.h384Data[0];return a||null}calculateConfidence(e,n,t){let a=.5;const o=e.reduce((e,n)=>e+n.weight,0)/20;return a+=Math.min(.3,o),a+=.2*n.intensity,a+=.2*t.confidence,Math.min(1,Math.max(.3,a))}generateMetaphor(e,n){const t=this.getH384Entry(e.number,n.position);if(!t)return"å¤‰åŒ–ã®æ™‚";const a=t["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"]||[],o=t["ç¾ä»£è§£é‡ˆã®è¦ç´„"]||"";return{primary:a[0]||"å¤‰åŒ–",keywords:a,situation:o,symbol:`${e.name}ã®${n.name}çˆ»`}}getCurrentTheme(e,n){const t=this.getH384Entry(e.number,n.position);return t?{theme:t["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰"][0]||"å¤‰åŒ–",description:t["ç¾ä»£è§£é‡ˆã®è¦ç´„"]||"",stance:t["S5_ä¸»ä½“æ€§æ¨å¥¨ã‚¹ã‚¿ãƒ³ã‚¹"]||"ä¸­ç«‹",risk:t["S4_ãƒªã‚¹ã‚¯"]||0,potential:t["S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«"]||50}:"ã“ã®æ™‚æœŸã®ãƒ†ãƒ¼ãƒ"}getFallbackResult(e){return{hexagram:{number:1,name:"ä¹¾ç‚ºå¤©"},yao:{position:1,name:"åˆ",description:"å§‹ã¾ã‚Šã®æ™‚"},confidence:.3,analysis:{keywords:[{word:"çŠ¶æ³",category:"general",weight:1}],emotion:{dominant:"neutral",intensity:.5},pattern:{primary:"beginning",confidence:.3},metaphor:{primary:"å§‹ã¾ã‚Š",situation:e.substring(0,50)+"..."},currentTheme:{theme:"æ–°ã—ã„å±•é–‹",description:"ç¾åœ¨ã¯æ–°ã—ã„å§‹ã¾ã‚Šã®æ™‚æœŸã§ã™ã€‚"}},h384Entry:this.h384Data?this.h384Data[0]:null}}initHexagramMapping(){return{"ä¹¾":{number:1,name:"ä¹¾ç‚ºå¤©",symbol:"â˜°â˜°"},"å¤":{number:2,name:"å¤ç‚ºåœ°",symbol:"â˜·â˜·"},"å±¯":{number:3,name:"æ°´é›·å±¯",symbol:"â˜µâ˜³"},"è’™":{number:4,name:"å±±æ°´è’™",symbol:"â˜¶â˜µ"},"éœ€":{number:5,name:"æ°´å¤©éœ€",symbol:"â˜µâ˜°"},"è¨Ÿ":{number:6,name:"å¤©æ°´è¨Ÿ",symbol:"â˜°â˜µ"},"å¸«":{number:7,name:"åœ°æ°´å¸«",symbol:"â˜·â˜µ"},"æ¯”":{number:8,name:"æ°´åœ°æ¯”",symbol:"â˜µâ˜·"},"å":{number:29,name:"åç‚ºæ°´",symbol:"â˜µâ˜µ"},"å›°":{number:47,name:"æ²¢æ°´å›°",symbol:"â˜±â˜µ"},"è¹‡":{number:39,name:"æ°´å±±è¹‡",symbol:"â˜µâ˜¶"},"å¦":{number:12,name:"å¤©åœ°å¦",symbol:"â˜°â˜·"},"é¯":{number:33,name:"å¤©å±±é¯",symbol:"â˜°â˜¶"},"è‰®":{number:52,name:"è‰®ç‚ºå±±",symbol:"â˜¶â˜¶"},"æ™‹":{number:35,name:"ç«åœ°æ™‹",symbol:"â˜²â˜·"},"å‡":{number:46,name:"åœ°é¢¨å‡",symbol:"â˜·â˜´"},"æ¼¸":{number:53,name:"é¢¨å±±æ¼¸",symbol:"â˜´â˜¶"},"é©":{number:49,name:"æ²¢ç«é©",symbol:"â˜±â˜²"},"é¼":{number:50,name:"ç«é¢¨é¼",symbol:"â˜²â˜´"},"éœ‡":{number:51,name:"éœ‡ç‚ºé›·",symbol:"â˜³â˜³"},"æ—¢æ¸ˆ":{number:63,name:"æ°´ç«æ—¢æ¸ˆ",symbol:"â˜µâ˜²"},"å±¥":{number:10,name:"å¤©æ²¢å±¥",symbol:"â˜°â˜±"},"æ³°":{number:11,name:"åœ°å¤©æ³°",symbol:"â˜·â˜°"},"åŒäºº":{number:13,name:"å¤©ç«åŒäºº",symbol:"â˜°â˜²"},"èƒ":{number:45,name:"æ²¢åœ°èƒ",symbol:"â˜±â˜·"},"è±«":{number:16,name:"é›·åœ°è±«",symbol:"â˜³â˜·"}}}initKeywordDatabase(){return{}}getYaoDescription(e){return{1:"ç‰©äº‹ã®å§‹ã¾ã‚Šã€åŸºç¤ã‚’å›ºã‚ã‚‹æ™‚",2:"ç™ºå±•ã®å…†ã—ã€å”åŠ›è€…ã¨ã®å‡ºä¼šã„",3:"è©¦ç·´ã®æ™‚ã€æ³¨æ„æ·±ã„è¡Œå‹•ãŒå¿…è¦",4:"è»¢æ›ç‚¹ã€é‡è¦ãªæ±ºæ–­ã®æ™‚",5:"æœ€é«˜ã®æ™‚ã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®",6:"è¡Œãéãã€è¬™è™šã•ãŒå¿…è¦"}[e]||"å¤‰åŒ–ã®æ™‚"}}class EmotionDetector{analyze(e){const n={anxiety:0,hope:0,anger:0,sadness:0,fear:0,confusion:0,excitement:0},t={anxiety:["ä¸å®‰","å¿ƒé…","æ‚©ã¿","è¿·ã£","ã‚„ã°ã„"],hope:["æœŸå¾…","å¸Œæœ›","ã‚„ã‚‹æ°—","æ¥½ã—ã¿","å¬‰ã—ã„"],anger:["è…¹ç«‹ã¤","æ€’ã‚Š","ãƒ ã‚«","ã‚¤ãƒ©ã‚¤ãƒ©"],sadness:["æ‚²ã—ã„","å¯‚ã—ã„","è¾›ã„","æ¶™"],fear:["æ€–ã„","æã‚Œ","ä¸å®‰","å¿ƒé…"],confusion:["åˆ†ã‹ã‚‰ãªã„","æ··ä¹±","ã©ã†ã—ã¦","ãªãœ"],excitement:["èˆˆå¥®","ã‚ãã‚ã","æ¥½ã—ã„","æœ€é«˜"]};let a=0;for(const[r,i]of Object.entries(t))for(const t of i){const o=(e.match(new RegExp(t,"g"))||[]).length;n[r]+=o,a+=o}if(a>0)for(const r in n)n[r]=n[r]/a;const o=Object.entries(n).sort((e,n)=>n[1]-e[1])[0];return{dominant:o[0],intensity:o[1],all:n}}}window.IChingSituationAnalyzer=IChingSituationAnalyzer;