class ZoneDIntegrator{constructor(){this.confidenceMeter=null,this.feedbackCollector=null,this.handoffManager=null,this.analysisData=null,this.isInitialized=!1,this.updateInterval=null,this.eventListeners=new Map,this.animationConfig={duration:800,easing:"cubic-bezier(0.4, 0, 0.2, 1)",stagger:200},this.init()}async init(){try{await this.loadComponents(),this.setupEventListeners(),this.startRealTimeUpdates(),this.isInitialized=!0,console.log("Zone D Integration initialized successfully")}catch(e){console.error("Zone D Integration initialization failed:",e)}}async loadComponents(){try{if("undefined"!=typeof ConfidenceMeter&&(this.confidenceMeter=new ConfidenceMeter),"undefined"!=typeof FeedbackCollector&&(this.feedbackCollector=new FeedbackCollector),"undefined"!=typeof HandoffManager&&(this.handoffManager=new HandoffManager),this.confidenceMeter&&this.feedbackCollector&&this.handoffManager||(console.log("Loading components dynamically..."),this.confidenceMeter||(await this.loadScript("public/js/zone-d/ConfidenceMeter.js"),this.confidenceMeter=new ConfidenceMeter),this.feedbackCollector||(await this.loadScript("public/js/zone-d/FeedbackCollector.js"),this.feedbackCollector=new FeedbackCollector),this.handoffManager||(await this.loadScript("public/js/zone-d/HandoffManager.js"),this.handoffManager=new HandoffManager)),!document.querySelector('link[href*="zone-d.css"]')){const e=document.createElement("link");e.rel="stylesheet",e.href="public/css/zone-d.css",document.head.appendChild(e)}console.log("Zone D components loaded successfully")}catch(e){throw console.error("Failed to load components:",e),e}}loadScript(e){return new Promise((t,n)=>{if(document.querySelector(`script[src="${e}"]`))return void t();const a=document.createElement("script");a.src=e,a.onload=t,a.onerror=n,document.head.appendChild(a)})}integrateWithResults(e,t){if(!this.isInitialized)return void console.warn("Zone D not initialized yet");this.analysisData=e;const n=this.createZoneDContainer();if(t)t.appendChild(n);else{(document.querySelector(".results-container")||document.querySelector("#results")||document.body).appendChild(n)}return this.animateZoneDReveal(n),this.updateAllComponents(e),n}createZoneDContainer(){const e=document.createElement("div");return e.id="zone-d-container",e.className="zone-d-integration",e.innerHTML='\n            <div class="zone-d-header">\n                <h2>🔍 診断の確実性と次のステップ</h2>\n                <p class="zone-d-description">\n                    この診断は「理解の器」です。確実性を確認し、疑問があれば反証を歓迎し、\n                    さらなる洞察のために次のAIに引き継ぐことができます。\n                </p>\n            </div>\n            \n            <div class="zone-d-components">\n                <div class="confidence-section" id="confidence-section">\n                    \x3c!-- ConfidenceMeter がここに表示 --\x3e\n                </div>\n                \n                <div class="feedback-section" id="feedback-section">\n                    \x3c!-- FeedbackCollector がここに表示 --\x3e\n                </div>\n                \n                <div class="handoff-section" id="handoff-section">\n                    \x3c!-- HandoffManager がここに表示 --\x3e\n                </div>\n            </div>\n            \n            <div class="zone-d-footer">\n                <div class="paradigm-shift-notice">\n                    <div class="notice-content">\n                        <span class="notice-icon">💡</span>\n                        <div class="notice-text">\n                            <strong>パラダイムシフト:</strong> \n                            この診断は「答えを与える」のではなく「理解の器を提供する」ツールです。\n                            不確実性を認識し、あなたの反証を歓迎します。\n                        </div>\n                    </div>\n                </div>\n            </div>\n        ',e}async animateZoneDReveal(e){const t=e.querySelectorAll(".confidence-section, .feedback-section, .handoff-section");t.forEach((e,t)=>{e.style.opacity="0",e.style.transform="translateY(40px)",e.style.transition=`all ${this.animationConfig.duration}ms ${this.animationConfig.easing}`});const n=e.querySelector(".zone-d-header");n.style.opacity="0",n.style.transform="translateY(-20px)",await this.delay(300),n.style.opacity="1",n.style.transform="translateY(0)";for(let i=0;i<t.length;i++)await this.delay(this.animationConfig.stagger),t[i].style.opacity="1",t[i].style.transform="translateY(0)";await this.delay(this.animationConfig.stagger);const a=e.querySelector(".zone-d-footer");a.style.opacity="0",a.style.transform="translateY(20px)",a.style.transition=`all ${this.animationConfig.duration}ms ${this.animationConfig.easing}`,await this.delay(100),a.style.opacity="1",a.style.transform="translateY(0)"}updateAllComponents(e){const t=this.calculateOverallConfidence(e),n=document.getElementById("confidence-section");n&&this.confidenceMeter&&(this.confidenceMeter.render(n),this.confidenceMeter.updateConfidence(e,t));const a=document.getElementById("feedback-section");a&&this.feedbackCollector&&(this.feedbackCollector.render(a),this.feedbackCollector.initializeFeedback(e,t));const i=document.getElementById("handoff-section");i&&this.handoffManager&&(this.handoffManager.render(i),this.handoffManager.setAnalysisData(e,t),this.handoffManager.setUserContext({language:"ja",device:this.detectDevice(),sessionId:this.generateSessionId()}))}calculateOverallConfidence(e){let t=70;if(e.tripleOS||(t-=20),e.hexagram||(t-=10),e.metrics||(t-=15),e.tripleOS){const n=Object.values(e.tripleOS),a=Math.max(...n)-Math.min(...n);a<.1&&(t-=5),a>.7&&(t-=10)}if(e.metrics){const{synergy:n,tension:a}=e.metrics;n&&a&&n+a>.9&&n+a<1.1&&(t+=5)}return Math.max(20,Math.min(95,t))}setupEventListeners(){this.addEventListener("analysisUpdate",e=>{this.updateAllComponents(e.detail)}),this.addEventListener("feedbackReceived",e=>{this.handleFeedbackReceived(e.detail)}),this.addEventListener("handoffCompleted",e=>{this.handleHandoffCompleted(e.detail)}),this.addEventListener("resize",this.debounce(()=>{this.handleResize()},300))}addEventListener(e,t){const n="resize"===e?window:document;n.addEventListener(e,t),this.eventListeners.has(e)||this.eventListeners.set(e,[]),this.eventListeners.get(e).push({target:n,handler:t})}handleFeedbackReceived(e){console.log("Feedback received:",e);let t=this.calculateOverallConfidence(this.analysisData);switch(e.type){case"disagree":t-=15;break;case"partial":t-=5;break;case"missing":t-=10;break;case"misunderstood":t-=8}this.confidenceMeter&&this.confidenceMeter.updateConfidence(this.analysisData,t),this.dispatchEvent("kpiUpdate",{type:"feedback",data:e,newConfidence:t})}handleHandoffCompleted(e){console.log("Handoff completed:",e),this.dispatchEvent("kpiUpdate",{type:"handoff",data:e}),setTimeout(()=>{this.showHandoffFollowUp(e)},3e3)}showHandoffFollowUp(e){const t=document.createElement("div");t.className="handoff-followup",t.innerHTML=`\n            <div class="followup-content">\n                <h4>🎯 ${e.destination.name}への準備が完了しました</h4>\n                <p>診断データが正常に準備されました。継続的な成長をサポートします。</p>\n                <div class="followup-actions">\n                    <button onclick="this.parentElement.parentElement.parentElement.remove()">\n                        了解\n                    </button>\n                </div>\n            </div>\n        `,document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t)},8e3)}startRealTimeUpdates(){this.updateInterval=setInterval(()=>{this.performDataIntegrityCheck()},5e3)}performDataIntegrityCheck(){if(!this.analysisData)return;const e=localStorage.getItem("haqei_latest_analysis");if(e)try{const t=JSON.parse(e);JSON.stringify(t)!==JSON.stringify(this.analysisData)&&(console.log("Data inconsistency detected, updating..."),this.updateAllComponents(t),this.analysisData=t)}catch(t){console.warn("Failed to parse stored analysis data")}}dispatchEvent(e,t){const n=new CustomEvent(e,{detail:t});document.dispatchEvent(n)}handleResize(){const e=document.getElementById("zone-d-container");if(e){const t=window.innerWidth<768;e.classList.toggle("mobile-layout",t)}}destroy(){this.updateInterval&&clearInterval(this.updateInterval),this.eventListeners.forEach((e,t)=>{e.forEach(({target:e,handler:n})=>{e.removeEventListener(t,n)})}),this.eventListeners.clear(),this.confidenceMeter?.destroy&&this.confidenceMeter.destroy(),this.feedbackCollector?.destroy&&this.feedbackCollector.destroy(),this.handoffManager?.destroy&&this.handoffManager.destroy(),console.log("Zone D Integration destroyed")}delay(e){return new Promise(t=>setTimeout(t,e))}debounce(e,t){let n;return function(...a){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),e(...a)},t)}}detectDevice(){const e=window.innerWidth;return e<768?"mobile":e<1024?"tablet":"desktop"}generateSessionId(){return`zd_session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}}window.zoneDIntegrator=new ZoneDIntegrator,"undefined"!=typeof module&&module.exports&&(module.exports=ZoneDIntegrator);