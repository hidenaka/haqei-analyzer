class HandoffManager{constructor(){this.payload=null,this.destination=null,this.handoffId=null,this.destinations={AI_CONSULTANT:{id:"ai-consultant",name:"AIç›¸è«‡ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ",description:"è¨ºæ–­çµæœã‚’åŸºã«å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’æä¾›",icon:"ğŸ¤–",url:"#ai-consultant",accepts:["json","summary"]},COACHING_AI:{id:"coaching-ai",name:"ã‚³ãƒ¼ãƒãƒ³ã‚°AI",description:"å€‹äººæˆé•·ã®ãŸã‚ã®ç¶™ç¶šçš„ã‚µãƒãƒ¼ãƒˆ",icon:"ğŸ¯",url:"#coaching",accepts:["json","detailed"]},ANALYTICS_AI:{id:"analytics-ai",name:"è©³ç´°åˆ†æAI",description:"ã‚ˆã‚Šæ·±ã„å¿ƒç†åˆ†æã¨æ´å¯Ÿ",icon:"ğŸ“Š",url:"#analytics",accepts:["json","raw"]},SHARE_EXPORT:{id:"share-export",name:"å…±æœ‰ãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ",description:"çµæœã‚’ä¿å­˜ã¾ãŸã¯å…±æœ‰",icon:"ğŸ“¤",url:"#export",accepts:["json","pdf","image"]}},this.formats={JSON:"json",SUMMARY:"summary",DETAILED:"detailed",RAW:"raw",PDF:"pdf",IMAGE:"image"},this.initializeHandoff()}initializeHandoff(){this.handoffId=this.generateHandoffId(),this.payload={version:"2.0.0",handoffId:this.handoffId,timestamp:(new Date).toISOString(),source:"os-analyzer",data:null,metadata:{},userContext:{}}}setAnalysisData(e,t,n=null){return!!e&&(this.payload.data={tripleOS:e.tripleOS||{},hexagram:e.hexagram||null,metrics:{synergy:e.synergy||0,tension:e.tension||0,confidence:t||0},insightPrimitives:this.generateInsightPrimitives(e),switchLenses:e.switchLenses||[],blindspots:this.identifyBlindspots(e,t)},n&&(this.payload.data.userFeedback=n),this.payload.metadata={analysisDate:(new Date).toISOString(),confidenceLevel:this.getConfidenceLevel(t),dataQuality:this.assessDataQuality(e),completeness:this.checkCompleteness(e)},!0)}setUserContext(e){this.payload.userContext={sessionId:e.sessionId||this.generateSessionId(),language:e.language||"ja",timezone:e.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,device:e.device||this.detectDevice(),preferences:e.preferences||{}}}generateInsightPrimitives(e){const t=[];if(!e.tripleOS)return t;const{engineOS:n,interfaceOS:a,safeModeOS:s}=e.tripleOS;return n>a&&n>s&&t.push({type:"dominance",os:"engine",statement:"ã€Œå‰µé€ â†’å®Ÿè£…ã€ã¯é€Ÿã„ãŒã€å¯¾äººã®æ…é‡ã•ãŒç™ºè¡¨ã®é…å»¶ã‚’ç”Ÿã‚€",confidence:.8}),a>n&&a>s&&t.push({type:"dominance",os:"interface",statement:"äººã¨ã®èª¿å’Œã‚’é‡è¦–ã—ã€è‡ªå·±ä¸»å¼µã‚’æ§ãˆã‚‹å‚¾å‘ãŒã‚ã‚‹",confidence:.75}),Math.abs(n-a)<.1&&Math.abs(n-s)<.1&&t.push({type:"balance",os:"all",statement:"çŠ¶æ³ã«å¿œã˜ã¦æŸ”è»Ÿã«ãƒ¢ãƒ¼ãƒ‰ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é©å¿œåŠ›ãŒã‚ã‚‹",confidence:.7}),t}identifyBlindspots(e,t){const n=[];if(t<50&&n.push({area:"measurement",description:"å›ç­”ã®ä¸€è²«æ€§ãŒä½ãã€æ­£ç¢ºãªæ¸¬å®šãŒå›°é›£",severity:"high"}),e.hexagram||n.push({area:"cultural",description:"æ˜“çµŒçš„è¦–ç‚¹ã§ã®è§£é‡ˆãŒä¸å®Œå…¨",severity:"medium"}),e.tripleOS){const t=Object.values(e.tripleOS);Math.max(...t)-Math.min(...t)>.6&&n.push({area:"balance",description:"ç‰¹å®šã®OSã«æ¥µç«¯ã«åã£ã¦ã„ã‚‹å¯èƒ½æ€§",severity:"medium"})}return n}formatPayload(e){switch(e){case this.formats.SUMMARY:return this.generateSummary();case this.formats.DETAILED:return this.generateDetailed();case this.formats.RAW:return this.payload;case this.formats.JSON:default:return JSON.stringify(this.payload,null,2)}}generateSummary(){if(!this.payload.data)return"";const{tripleOS:e,metrics:t,insightPrimitives:n}=this.payload.data;let a="ã€OS Analyzerè¨ºæ–­çµæœã‚µãƒãƒªãƒ¼ã€‘\n\n";return a+=`è¨ºæ–­ID: ${this.handoffId}\n`,a+=`æ—¥æ™‚: ${(new Date).toLocaleString("ja-JP")}\n\n`,a+="â–  Triple OS ã‚¹ã‚³ã‚¢\n",a+=`Engine OS: ${(100*e.engineOS).toFixed(0)}%\n`,a+=`Interface OS: ${(100*e.interfaceOS).toFixed(0)}%\n`,a+=`Safe Mode OS: ${(100*e.safeModeOS).toFixed(0)}%\n\n`,a+=`â–  ç¢ºä¿¡åº¦: ${t.confidence}%\n\n`,n.length>0&&(a+="â–  ä¸»è¦ãªæ´å¯Ÿ\n",n.forEach((e,t)=>{a+=`${t+1}. ${e.statement}\n`})),a}generateDetailed(){return{summary:this.generateSummary(),fullData:this.payload,recommendations:this.generateRecommendations(),nextSteps:this.suggestNextSteps()}}generateRecommendations(){const e=[];return this.payload.data?.metrics?.confidence<70&&e.push("ã‚ˆã‚Šæ­£ç¢ºãªè¨ºæ–­ã®ãŸã‚ã€è½ã¡ç€ã„ãŸç’°å¢ƒã§å†åº¦ãŠè©¦ã—ãã ã•ã„"),this.payload.data?.blindspots?.length>0&&e.push("ç‰¹å®šã•ã‚ŒãŸç›²ç‚¹ã«ã¤ã„ã¦ã€å°‚é–€å®¶ã¨ã®ç›¸è«‡ã‚’ãŠå‹§ã‚ã—ã¾ã™"),e}suggestNextSteps(){return["AIç›¸è«‡ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§å…·ä½“çš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å—ã‘ã‚‹","çµæœã‚’PDFã§ä¿å­˜ã—ã¦å¾Œã§è¦‹è¿”ã™","ä¿¡é ¼ã§ãã‚‹äººã¨çµæœã‚’å…±æœ‰ã—ã¦æ„è¦‹ã‚’èã"]}initiateHandoff(e,t=null){return this.executeHandoff(e,this.formats.JSON,t)}executeHandoff(e,t=this.formats.JSON,n=null){const a=Object.values(this.destinations).find(t=>t.id===e);if(!a)return console.error("Invalid destination:",e),!1;if(!a.accepts.includes(t))return console.error(`Destination ${e} does not accept format ${t}`),!1;this.destination=a;const s=this.formatPayload(t);this.saveHandoffData(s);const o=this.generateHandoffUrl(a,s);return console.log("Handoff executed:",{destination:a.name,format:t,url:o}),{success:!0,destination:a,url:o,payload:s}}generateHandoffUrl(e,t){const n=e.url,a=encodeURIComponent("string"==typeof t?t:JSON.stringify(t));return a.length>2e3?`${n}?handoffId=${this.handoffId}`:`${n}?data=${a}&handoffId=${this.handoffId}`}saveHandoffData(e){const t=`handoff_${this.handoffId}`;try{localStorage.setItem(t,JSON.stringify({timestamp:(new Date).toISOString(),destination:this.destination?.id,payload:e})),this.cleanupOldHandoffs()}catch(n){console.error("Failed to save handoff data:",n)}}cleanupOldHandoffs(){const e=Date.now()-2592e6;Object.keys(localStorage).forEach(t=>{if(t.startsWith("handoff_"))try{const n=JSON.parse(localStorage.getItem(t));new Date(n.timestamp).getTime()<e&&localStorage.removeItem(t)}catch(n){localStorage.removeItem(t)}})}render(e){const t=`\n            <div class="handoff-manager">\n                <h3>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¸</h3>\n                \n                <div class="handoff-prompt">\n                    <p>è¨ºæ–­çµæœã‚’æ´»ç”¨ã—ã¦ã€ã•ã‚‰ã«æ·±ã„æ´å¯Ÿã‚’å¾—ã¾ã—ã‚‡ã†ã€‚</p>\n                </div>\n                \n                <div class="destination-cards">\n                    ${Object.values(this.destinations).map(e=>`\n                        <div class="destination-card" data-destination="${e.id}">\n                            <div class="dest-icon">${e.icon}</div>\n                            <div class="dest-content">\n                                <h4>${e.name}</h4>\n                                <p>${e.description}</p>\n                            </div>\n                            <button class="handoff-btn" onclick="handoffManager.handleHandoff('${e.id}')">\n                                é¸æŠ\n                            </button>\n                        </div>\n                    `).join("")}\n                </div>\n                \n                <div class="payload-preview">\n                    <h4>å¼•ãç¶™ããƒ‡ãƒ¼ã‚¿ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h4>\n                    <div class="preview-content">\n                        <pre>${this.formatPayload(this.formats.SUMMARY)}</pre>\n                    </div>\n                    <div class="format-selector">\n                        <label>ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ:</label>\n                        <select id="payload-format" onchange="handoffManager.updatePreview(this.value)">\n                            <option value="summary">ã‚µãƒãƒªãƒ¼</option>\n                            <option value="json">JSON</option>\n                            <option value="detailed">è©³ç´°</option>\n                        </select>\n                    </div>\n                </div>\n                \n                <div class="handoff-actions">\n                    <button class="btn-copy" onclick="handoffManager.copyPayload()">\n                        ğŸ“‹ ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼\n                    </button>\n                    <button class="btn-download" onclick="handoffManager.downloadPayload()">\n                        ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰\n                    </button>\n                </div>\n                \n                <div class="handoff-notice">\n                    <p>\n                        â€» è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ã¯æš—å·åŒ–ã•ã‚Œã€é¸æŠã—ãŸå®›å…ˆã«ã®ã¿é€ä¿¡ã•ã‚Œã¾ã™ã€‚\n                        å€‹äººæƒ…å ±ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚\n                    </p>\n                </div>\n            </div>\n        `;return e&&(e.innerHTML=t),t}handleHandoff(e){const t=this.executeHandoff(e);t.success&&(this.showHandoffSuccess(t.destination),this.recordHandoffMetric(e),t.url.startsWith("#")?console.log("Navigate to:",t.url):window.open(t.url,"_blank"))}updatePreview(e){const t=document.querySelector(".preview-content pre");if(t){const n=this.formatPayload(e);t.textContent="string"==typeof n?n:JSON.stringify(n,null,2)}}copyPayload(){const e=document.getElementById("payload-format")?.value||"json",t=this.formatPayload(e),n="string"==typeof t?t:JSON.stringify(t,null,2);navigator.clipboard.writeText(n).then(()=>{this.showCopySuccess()}).catch(e=>{console.error("Copy failed:",e)})}downloadPayload(){const e=document.getElementById("payload-format")?.value||"json",t=this.formatPayload(e),n="string"==typeof t?t:JSON.stringify(t,null,2),a=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download=`os-analyzer-result-${this.handoffId}.json`,o.click(),URL.revokeObjectURL(s)}showHandoffSuccess(e){const t=document.createElement("div");t.className="handoff-success-message",t.innerHTML=`\n            <div class="success-content">\n                <span class="success-icon">${e.icon}</span>\n                <h3>${e.name}ã¸ã®å¼•ãç¶™ãæº–å‚™å®Œäº†</h3>\n                <p>è¨ºæ–­ãƒ‡ãƒ¼ã‚¿ãŒæ­£å¸¸ã«æº–å‚™ã•ã‚Œã¾ã—ãŸã€‚</p>\n            </div>\n        `,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),100),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>document.body.removeChild(t),300)},3e3)}showCopySuccess(){const e=document.createElement("div");e.className="copy-success",e.textContent="ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ",document.body.appendChild(e),setTimeout(()=>e.classList.add("show"),100),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>document.body.removeChild(e),300)},2e3)}recordHandoffMetric(e){const t=JSON.parse(localStorage.getItem("handoff_metrics")||"{}"),n=(new Date).toISOString().split("T")[0];t[n]||(t[n]={}),t[n][e]=(t[n][e]||0)+1,localStorage.setItem("handoff_metrics",JSON.stringify(t));const a=Object.values(t[n]).reduce((e,t)=>e+t,0);console.log(`KPI - Handoff Rate: ${a} handoffs today`)}generateHandoffId(){return`ho_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}detectDevice(){const e=window.innerWidth;return e<768?"mobile":e<1024?"tablet":"desktop"}getConfidenceLevel(e){return e>=75?"high":e>=50?"medium":"low"}assessDataQuality(e){let t=1;return e.tripleOS||(t-=.3),e.hexagram||(t-=.2),e.metrics||(t-=.2),Math.max(0,t)}checkCompleteness(e){const t=["tripleOS","hexagram","metrics"];return t.filter(t=>null!==e[t]&&void 0!==e[t]).length/t.length}}"undefined"!=typeof module&&module.exports&&(module.exports=HandoffManager);