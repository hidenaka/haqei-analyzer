class HandoffManager{constructor(){this.payload=null,this.destination=null,this.handoffId=null,this.destinations={AI_CONSULTANT:{id:"ai-consultant",name:"AI相談アシスタント",description:"診断結果を基に具体的なアドバイスを提供",icon:"🤖",url:"#ai-consultant",accepts:["json","summary"]},COACHING_AI:{id:"coaching-ai",name:"コーチングAI",description:"個人成長のための継続的サポート",icon:"🎯",url:"#coaching",accepts:["json","detailed"]},ANALYTICS_AI:{id:"analytics-ai",name:"詳細分析AI",description:"より深い心理分析と洞察",icon:"📊",url:"#analytics",accepts:["json","raw"]},SHARE_EXPORT:{id:"share-export",name:"共有・エクスポート",description:"結果を保存または共有",icon:"📤",url:"#export",accepts:["json","pdf","image"]}},this.formats={JSON:"json",SUMMARY:"summary",DETAILED:"detailed",RAW:"raw",PDF:"pdf",IMAGE:"image"},this.initializeHandoff()}initializeHandoff(){this.handoffId=this.generateHandoffId(),this.payload={version:"2.0.0",handoffId:this.handoffId,timestamp:(new Date).toISOString(),source:"os-analyzer",data:null,metadata:{},userContext:{}}}setAnalysisData(e,t,n=null){return!!e&&(this.payload.data={tripleOS:e.tripleOS||{},hexagram:e.hexagram||null,metrics:{synergy:e.synergy||0,tension:e.tension||0,confidence:t||0},insightPrimitives:this.generateInsightPrimitives(e),switchLenses:e.switchLenses||[],blindspots:this.identifyBlindspots(e,t)},n&&(this.payload.data.userFeedback=n),this.payload.metadata={analysisDate:(new Date).toISOString(),confidenceLevel:this.getConfidenceLevel(t),dataQuality:this.assessDataQuality(e),completeness:this.checkCompleteness(e)},!0)}setUserContext(e){this.payload.userContext={sessionId:e.sessionId||this.generateSessionId(),language:e.language||"ja",timezone:e.timezone||Intl.DateTimeFormat().resolvedOptions().timeZone,device:e.device||this.detectDevice(),preferences:e.preferences||{}}}generateInsightPrimitives(e){const t=[];if(!e.tripleOS)return t;const{engineOS:n,interfaceOS:a,safeModeOS:s}=e.tripleOS;return n>a&&n>s&&t.push({type:"dominance",os:"engine",statement:"「創造→実装」は速いが、対人の慎重さが発表の遅延を生む",confidence:.8}),a>n&&a>s&&t.push({type:"dominance",os:"interface",statement:"人との調和を重視し、自己主張を控える傾向がある",confidence:.75}),Math.abs(n-a)<.1&&Math.abs(n-s)<.1&&t.push({type:"balance",os:"all",statement:"状況に応じて柔軟にモードを切り替える適応力がある",confidence:.7}),t}identifyBlindspots(e,t){const n=[];if(t<50&&n.push({area:"measurement",description:"回答の一貫性が低く、正確な測定が困難",severity:"high"}),e.hexagram||n.push({area:"cultural",description:"易経的視点での解釈が不完全",severity:"medium"}),e.tripleOS){const t=Object.values(e.tripleOS);Math.max(...t)-Math.min(...t)>.6&&n.push({area:"balance",description:"特定のOSに極端に偏っている可能性",severity:"medium"})}return n}formatPayload(e){switch(e){case this.formats.SUMMARY:return this.generateSummary();case this.formats.DETAILED:return this.generateDetailed();case this.formats.RAW:return this.payload;case this.formats.JSON:default:return JSON.stringify(this.payload,null,2)}}generateSummary(){if(!this.payload.data)return"";const{tripleOS:e,metrics:t,insightPrimitives:n}=this.payload.data;let a="【OS Analyzer診断結果サマリー】\n\n";return a+=`診断ID: ${this.handoffId}\n`,a+=`日時: ${(new Date).toLocaleString("ja-JP")}\n\n`,a+="■ Triple OS スコア\n",a+=`Engine OS: ${(100*e.engineOS).toFixed(0)}%\n`,a+=`Interface OS: ${(100*e.interfaceOS).toFixed(0)}%\n`,a+=`Safe Mode OS: ${(100*e.safeModeOS).toFixed(0)}%\n\n`,a+=`■ 確信度: ${t.confidence}%\n\n`,n.length>0&&(a+="■ 主要な洞察\n",n.forEach((e,t)=>{a+=`${t+1}. ${e.statement}\n`})),a}generateDetailed(){return{summary:this.generateSummary(),fullData:this.payload,recommendations:this.generateRecommendations(),nextSteps:this.suggestNextSteps()}}generateRecommendations(){const e=[];return this.payload.data?.metrics?.confidence<70&&e.push("より正確な診断のため、落ち着いた環境で再度お試しください"),this.payload.data?.blindspots?.length>0&&e.push("特定された盲点について、専門家との相談をお勧めします"),e}suggestNextSteps(){return["AI相談アシスタントで具体的なアドバイスを受ける","結果をPDFで保存して後で見返す","信頼できる人と結果を共有して意見を聞く"]}initiateHandoff(e,t=null){return this.executeHandoff(e,this.formats.JSON,t)}executeHandoff(e,t=this.formats.JSON,n=null){const a=Object.values(this.destinations).find(t=>t.id===e);if(!a)return console.error("Invalid destination:",e),!1;if(!a.accepts.includes(t))return console.error(`Destination ${e} does not accept format ${t}`),!1;this.destination=a;const s=this.formatPayload(t);this.saveHandoffData(s);const o=this.generateHandoffUrl(a,s);return console.log("Handoff executed:",{destination:a.name,format:t,url:o}),{success:!0,destination:a,url:o,payload:s}}generateHandoffUrl(e,t){const n=e.url,a=encodeURIComponent("string"==typeof t?t:JSON.stringify(t));return a.length>2e3?`${n}?handoffId=${this.handoffId}`:`${n}?data=${a}&handoffId=${this.handoffId}`}saveHandoffData(e){const t=`handoff_${this.handoffId}`;try{localStorage.setItem(t,JSON.stringify({timestamp:(new Date).toISOString(),destination:this.destination?.id,payload:e})),this.cleanupOldHandoffs()}catch(n){console.error("Failed to save handoff data:",n)}}cleanupOldHandoffs(){const e=Date.now()-2592e6;Object.keys(localStorage).forEach(t=>{if(t.startsWith("handoff_"))try{const n=JSON.parse(localStorage.getItem(t));new Date(n.timestamp).getTime()<e&&localStorage.removeItem(t)}catch(n){localStorage.removeItem(t)}})}render(e){const t=`\n            <div class="handoff-manager">\n                <h3>次のステップへ</h3>\n                \n                <div class="handoff-prompt">\n                    <p>診断結果を活用して、さらに深い洞察を得ましょう。</p>\n                </div>\n                \n                <div class="destination-cards">\n                    ${Object.values(this.destinations).map(e=>`\n                        <div class="destination-card" data-destination="${e.id}">\n                            <div class="dest-icon">${e.icon}</div>\n                            <div class="dest-content">\n                                <h4>${e.name}</h4>\n                                <p>${e.description}</p>\n                            </div>\n                            <button class="handoff-btn" onclick="handoffManager.handleHandoff('${e.id}')">\n                                選択\n                            </button>\n                        </div>\n                    `).join("")}\n                </div>\n                \n                <div class="payload-preview">\n                    <h4>引き継ぎデータプレビュー</h4>\n                    <div class="preview-content">\n                        <pre>${this.formatPayload(this.formats.SUMMARY)}</pre>\n                    </div>\n                    <div class="format-selector">\n                        <label>フォーマット:</label>\n                        <select id="payload-format" onchange="handoffManager.updatePreview(this.value)">\n                            <option value="summary">サマリー</option>\n                            <option value="json">JSON</option>\n                            <option value="detailed">詳細</option>\n                        </select>\n                    </div>\n                </div>\n                \n                <div class="handoff-actions">\n                    <button class="btn-copy" onclick="handoffManager.copyPayload()">\n                        📋 クリップボードにコピー\n                    </button>\n                    <button class="btn-download" onclick="handoffManager.downloadPayload()">\n                        💾 ダウンロード\n                    </button>\n                </div>\n                \n                <div class="handoff-notice">\n                    <p>\n                        ※ 診断データは暗号化され、選択した宛先にのみ送信されます。\n                        個人情報は含まれません。\n                    </p>\n                </div>\n            </div>\n        `;return e&&(e.innerHTML=t),t}handleHandoff(e){const t=this.executeHandoff(e);t.success&&(this.showHandoffSuccess(t.destination),this.recordHandoffMetric(e),t.url.startsWith("#")?console.log("Navigate to:",t.url):window.open(t.url,"_blank"))}updatePreview(e){const t=document.querySelector(".preview-content pre");if(t){const n=this.formatPayload(e);t.textContent="string"==typeof n?n:JSON.stringify(n,null,2)}}copyPayload(){const e=document.getElementById("payload-format")?.value||"json",t=this.formatPayload(e),n="string"==typeof t?t:JSON.stringify(t,null,2);navigator.clipboard.writeText(n).then(()=>{this.showCopySuccess()}).catch(e=>{console.error("Copy failed:",e)})}downloadPayload(){const e=document.getElementById("payload-format")?.value||"json",t=this.formatPayload(e),n="string"==typeof t?t:JSON.stringify(t,null,2),a=new Blob([n],{type:"application/json"}),s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download=`os-analyzer-result-${this.handoffId}.json`,o.click(),URL.revokeObjectURL(s)}showHandoffSuccess(e){const t=document.createElement("div");t.className="handoff-success-message",t.innerHTML=`\n            <div class="success-content">\n                <span class="success-icon">${e.icon}</span>\n                <h3>${e.name}への引き継ぎ準備完了</h3>\n                <p>診断データが正常に準備されました。</p>\n            </div>\n        `,document.body.appendChild(t),setTimeout(()=>t.classList.add("show"),100),setTimeout(()=>{t.classList.remove("show"),setTimeout(()=>document.body.removeChild(t),300)},3e3)}showCopySuccess(){const e=document.createElement("div");e.className="copy-success",e.textContent="クリップボードにコピーしました",document.body.appendChild(e),setTimeout(()=>e.classList.add("show"),100),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>document.body.removeChild(e),300)},2e3)}recordHandoffMetric(e){const t=JSON.parse(localStorage.getItem("handoff_metrics")||"{}"),n=(new Date).toISOString().split("T")[0];t[n]||(t[n]={}),t[n][e]=(t[n][e]||0)+1,localStorage.setItem("handoff_metrics",JSON.stringify(t));const a=Object.values(t[n]).reduce((e,t)=>e+t,0);console.log(`KPI - Handoff Rate: ${a} handoffs today`)}generateHandoffId(){return`ho_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateSessionId(){return`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}detectDevice(){const e=window.innerWidth;return e<768?"mobile":e<1024?"tablet":"desktop"}getConfidenceLevel(e){return e>=75?"high":e>=50?"medium":"low"}assessDataQuality(e){let t=1;return e.tripleOS||(t-=.3),e.hexagram||(t-=.2),e.metrics||(t-=.2),Math.max(0,t)}checkCompleteness(e){const t=["tripleOS","hexagram","metrics"];return t.filter(t=>null!==e[t]&&void 0!==e[t]).length/t.length}}"undefined"!=typeof module&&module.exports&&(module.exports=HandoffManager);