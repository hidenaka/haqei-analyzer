class FeedbackCollector{constructor(){this.feedbacks=[],this.currentFeedback=null,this.storageKey="haqei_user_feedbacks",this.feedbackTypes={DISAGREE:"disagree",PARTIAL:"partial",MISSING:"missing",MISUNDERSTOOD:"misunderstood",OTHER:"other"},this.reactions={SURPRISED:"ğŸ˜²",CONFUSED:"ğŸ˜•",ENLIGHTENED:"ğŸ’¡",VALIDATED:"âœ…",SKEPTICAL:"ğŸ¤”"},this.loadFeedbacks()}startFeedback(e,t){return this.currentFeedback={id:this.generateId(),timestamp:(new Date).toISOString(),analysisResults:this.extractEssentials(e),confidence:t,type:null,reaction:null,specificFeedback:"",counterExample:"",suggestions:[],isCompleted:!1},this.currentFeedback.id}setFeedbackType(e){return!!this.currentFeedback&&(!!Object.values(this.feedbackTypes).includes(e)&&(this.currentFeedback.type=e,!0))}setReaction(e){if(!this.currentFeedback)return!1;const t=Object.keys(this.reactions).find(t=>this.reactions[t]===e);return!!t&&(this.currentFeedback.reaction=t,!0)}addSpecificFeedback(e){return!!this.currentFeedback&&(this.currentFeedback.specificFeedback=e.trim(),!0)}addCounterExample(e){return!!this.currentFeedback&&(this.currentFeedback.counterExample=e.trim(),!0)}addSuggestion(e){return!!this.currentFeedback&&(!(!e||!e.trim())&&(this.currentFeedback.suggestions.push(e.trim()),!0))}completeFeedback(){if(!this.currentFeedback)return null;this.currentFeedback.isCompleted=!0,this.feedbacks.push(this.currentFeedback),this.saveFeedbacks();const e=this.currentFeedback;return this.currentFeedback=null,e}cancelFeedback(){this.currentFeedback=null}extractEssentials(e){return e?{tripleOS:e.tripleOS||{},hexagram:e.hexagram||null,primaryPattern:e.pattern||null}:null}getStatistics(){const e={total:this.feedbacks.length,byType:{},byReaction:{},averageConfidence:0,disagreementRate:0};Object.values(this.feedbackTypes).forEach(t=>{e.byType[t]=0}),Object.keys(this.reactions).forEach(t=>{e.byReaction[t]=0});let t=0,a=0;return this.feedbacks.forEach(s=>{s.type&&(e.byType[s.type]++,s.type===this.feedbackTypes.DISAGREE&&a++),s.reaction&&e.byReaction[s.reaction]++,s.confidence&&(t+=s.confidence)}),e.total>0&&(e.averageConfidence=Math.round(t/e.total),e.disagreementRate=(a/e.total*100).toFixed(1)),e}render(e){const t=this.getStatistics(),a=`\n            <div class="feedback-collector">\n                <h3>è¨ºæ–­çµæœã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>\n                \n                <div class="feedback-prompt">\n                    <p>ã“ã®è¨ºæ–­çµæœã«ã¤ã„ã¦ã€ã‚ãªãŸã®æ„Ÿæƒ³ã‚’ãŠèã‹ã›ãã ã•ã„ã€‚</p>\n                </div>\n                \n                \x3c!-- æ„Ÿæƒ…çš„ãªåå¿œ --\x3e\n                <div class="reaction-selector">\n                    <h4>æœ€åˆã®å°è±¡ã¯ï¼Ÿ</h4>\n                    <div class="reaction-buttons">\n                        ${Object.entries(this.reactions).map(([e,t])=>`\n                            <button class="reaction-btn" data-reaction="${e}" title="${this.getReactionLabel(e)}">\n                                <span class="reaction-emoji">${t}</span>\n                                <span class="reaction-label">${this.getReactionLabel(e)}</span>\n                            </button>\n                        `).join("")}\n                    </div>\n                </div>\n                \n                \x3c!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ— --\x3e\n                <div class="feedback-type-selector">\n                    <h4>çµæœã«ã¤ã„ã¦ã©ã†æ€ã„ã¾ã™ã‹ï¼Ÿ</h4>\n                    <div class="feedback-types">\n                        ${Object.entries(this.feedbackTypes).map(([e,t])=>`\n                            <label class="feedback-type-option">\n                                <input type="radio" name="feedback-type" value="${t}">\n                                <span>${this.getFeedbackTypeLabel(t)}</span>\n                            </label>\n                        `).join("")}\n                    </div>\n                </div>\n                \n                \x3c!-- å…·ä½“çš„ãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ --\x3e\n                <div class="specific-feedback">\n                    <h4>å…·ä½“çš„ã«ãŠèã‹ã›ãã ã•ã„</h4>\n                    <textarea \n                        id="specific-feedback-text" \n                        placeholder="ä¾‹ï¼šEngine OSã®è©•ä¾¡ãŒé«˜ã™ãã‚‹æ°—ãŒã—ã¾ã™ã€‚å®Ÿéš›ã¯ã‚‚ã£ã¨æ…é‡ã«è¡Œå‹•ã™ã‚‹ã“ã¨ãŒå¤šã„ã§ã™ã€‚"\n                        rows="4"\n                    ></textarea>\n                </div>\n                \n                \x3c!-- åä¾‹å…¥åŠ› --\x3e\n                <div class="counter-example">\n                    <h4>åä¾‹ãŒã‚ã‚Œã°æ•™ãˆã¦ãã ã•ã„ï¼ˆä»»æ„ï¼‰</h4>\n                    <textarea \n                        id="counter-example-text" \n                        placeholder="ä¾‹ï¼šæœ€è¿‘ã®ä¼šè­°ã§ã¯ã€ææ¡ˆã•ã‚ŒãŸé€šã‚Šã§ã¯ãªãã€ãƒãƒ¼ãƒ ã®æ„è¦‹ã‚’é‡è¦–ã—ã¦æ±ºå®šã—ã¾ã—ãŸã€‚"\n                        rows="3"\n                    ></textarea>\n                </div>\n                \n                \x3c!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ --\x3e\n                <div class="feedback-actions">\n                    <button class="btn-cancel" onclick="feedbackCollector.cancelFeedback()">\n                        ã‚­ãƒ£ãƒ³ã‚»ãƒ«\n                    </button>\n                    <button class="btn-submit" onclick="feedbackCollector.submitFeedback()">\n                        ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ä¿¡\n                    </button>\n                </div>\n                \n                \x3c!-- çµ±è¨ˆè¡¨ç¤º --\x3e\n                ${t.total>0?`\n                    <div class="feedback-stats">\n                        <h4>ã“ã‚Œã¾ã§ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>\n                        <div class="stats-grid">\n                            <div class="stat-item">\n                                <span class="stat-value">${t.total}</span>\n                                <span class="stat-label">ä»¶ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</span>\n                            </div>\n                            <div class="stat-item">\n                                <span class="stat-value">${t.disagreementRate}%</span>\n                                <span class="stat-label">ä¸ä¸€è‡´ç‡</span>\n                            </div>\n                            <div class="stat-item">\n                                <span class="stat-value">${t.averageConfidence}%</span>\n                                <span class="stat-label">å¹³å‡ç¢ºä¿¡åº¦</span>\n                            </div>\n                        </div>\n                    </div>\n                `:""}\n                \n                \x3c!-- ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼é€šçŸ¥ --\x3e\n                <div class="privacy-notice">\n                    <p>\n                        â€» ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã¯è¨ºæ–­ç²¾åº¦å‘ä¸Šã®ãŸã‚ã«ä½¿ç”¨ã•ã‚Œã¾ã™ã€‚\n                        å€‹äººã‚’ç‰¹å®šã™ã‚‹æƒ…å ±ã¯å«ã¾ã‚Œã¾ã›ã‚“ã€‚\n                    </p>\n                </div>\n            </div>\n        `;return e&&(e.innerHTML=a,this.attachEventListeners(e)),a}attachEventListeners(e){e.querySelectorAll(".reaction-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.reaction;this.handleReactionClick(t,e.currentTarget)})}),e.querySelectorAll('input[name="feedback-type"]').forEach(e=>{e.addEventListener("change",e=>{this.setFeedbackType(e.target.value)})})}handleReactionClick(e,t){document.querySelectorAll(".reaction-btn").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),this.setReaction(this.reactions[e])}collectFeedback(e,t,a){this.createFeedback();return e&&this.setFeedbackType(e),t&&this.setReaction(t),a&&this.setSpecificFeedback(a),this.submitFeedback()}submitFeedback(){const e=document.getElementById("specific-feedback-text")?.value,t=document.getElementById("counter-example-text")?.value;if(!e||!this.currentFeedback?.type)return void alert("ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚¿ã‚¤ãƒ—ã¨å…·ä½“çš„ãªå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");this.addSpecificFeedback(e),t&&this.addCounterExample(t);const a=this.completeFeedback();if(a){this.showThankYouMessage(),console.log("Feedback submitted:",a);const e=this.getStatistics();console.log(`KPI - Disagreement Rate: ${e.disagreementRate}%`)}}showThankYouMessage(){const e=document.createElement("div");e.className="thank-you-message",e.innerHTML='\n            <div class="message-content">\n                <span class="message-icon">ğŸ™</span>\n                <h3>ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ</h3>\n                <p>ã‚ãªãŸã®ã”æ„è¦‹ã¯è¨ºæ–­ç²¾åº¦ã®å‘ä¸Šã«æ´»ç”¨ã•ã›ã¦ã„ãŸã ãã¾ã™ã€‚</p>\n            </div>\n        ',document.body.appendChild(e),setTimeout(()=>{e.classList.add("show")},100),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>{document.body.removeChild(e)},300)},3e3)}getReactionLabel(e){return{SURPRISED:"é©šã„ãŸ",CONFUSED:"å›°æƒ‘ã—ãŸ",ENLIGHTENED:"æ°—ã¥ããŒã‚ã£ãŸ",VALIDATED:"ç¢ºè¨¼ã‚’å¾—ãŸ",SKEPTICAL:"æ‡ç–‘çš„"}[e]||""}getFeedbackTypeLabel(e){return{disagree:"çµæœã«åŒæ„ã§ããªã„",partial:"éƒ¨åˆ†çš„ã«åŒæ„",missing:"é‡è¦ãªè¦ç´ ãŒæ¬ ã‘ã¦ã„ã‚‹",misunderstood:"èª¤è§£ã•ã‚Œã¦ã„ã‚‹",other:"ãã®ä»–"}[e]||""}loadFeedbacks(){try{const e=localStorage.getItem(this.storageKey);e&&(this.feedbacks=JSON.parse(e))}catch(e){console.error("Failed to load feedbacks:",e)}}saveFeedbacks(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.feedbacks))}catch(e){console.error("Failed to save feedbacks:",e)}}generateId(){return`fb_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}exportFeedbacks(){const e={exported:(new Date).toISOString(),feedbacks:this.feedbacks,statistics:this.getStatistics()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download=`feedbacks_${Date.now()}.json`,s.click()}}"undefined"!=typeof module&&module.exports&&(module.exports=FeedbackCollector);