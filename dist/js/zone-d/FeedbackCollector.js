class FeedbackCollector{constructor(){this.feedbacks=[],this.currentFeedback=null,this.storageKey="haqei_user_feedbacks",this.feedbackTypes={DISAGREE:"disagree",PARTIAL:"partial",MISSING:"missing",MISUNDERSTOOD:"misunderstood",OTHER:"other"},this.reactions={SURPRISED:"😲",CONFUSED:"😕",ENLIGHTENED:"💡",VALIDATED:"✅",SKEPTICAL:"🤔"},this.loadFeedbacks()}startFeedback(e,t){return this.currentFeedback={id:this.generateId(),timestamp:(new Date).toISOString(),analysisResults:this.extractEssentials(e),confidence:t,type:null,reaction:null,specificFeedback:"",counterExample:"",suggestions:[],isCompleted:!1},this.currentFeedback.id}setFeedbackType(e){return!!this.currentFeedback&&(!!Object.values(this.feedbackTypes).includes(e)&&(this.currentFeedback.type=e,!0))}setReaction(e){if(!this.currentFeedback)return!1;const t=Object.keys(this.reactions).find(t=>this.reactions[t]===e);return!!t&&(this.currentFeedback.reaction=t,!0)}addSpecificFeedback(e){return!!this.currentFeedback&&(this.currentFeedback.specificFeedback=e.trim(),!0)}addCounterExample(e){return!!this.currentFeedback&&(this.currentFeedback.counterExample=e.trim(),!0)}addSuggestion(e){return!!this.currentFeedback&&(!(!e||!e.trim())&&(this.currentFeedback.suggestions.push(e.trim()),!0))}completeFeedback(){if(!this.currentFeedback)return null;this.currentFeedback.isCompleted=!0,this.feedbacks.push(this.currentFeedback),this.saveFeedbacks();const e=this.currentFeedback;return this.currentFeedback=null,e}cancelFeedback(){this.currentFeedback=null}extractEssentials(e){return e?{tripleOS:e.tripleOS||{},hexagram:e.hexagram||null,primaryPattern:e.pattern||null}:null}getStatistics(){const e={total:this.feedbacks.length,byType:{},byReaction:{},averageConfidence:0,disagreementRate:0};Object.values(this.feedbackTypes).forEach(t=>{e.byType[t]=0}),Object.keys(this.reactions).forEach(t=>{e.byReaction[t]=0});let t=0,a=0;return this.feedbacks.forEach(s=>{s.type&&(e.byType[s.type]++,s.type===this.feedbackTypes.DISAGREE&&a++),s.reaction&&e.byReaction[s.reaction]++,s.confidence&&(t+=s.confidence)}),e.total>0&&(e.averageConfidence=Math.round(t/e.total),e.disagreementRate=(a/e.total*100).toFixed(1)),e}render(e){const t=this.getStatistics(),a=`\n            <div class="feedback-collector">\n                <h3>診断結果へのフィードバック</h3>\n                \n                <div class="feedback-prompt">\n                    <p>この診断結果について、あなたの感想をお聞かせください。</p>\n                </div>\n                \n                \x3c!-- 感情的な反応 --\x3e\n                <div class="reaction-selector">\n                    <h4>最初の印象は？</h4>\n                    <div class="reaction-buttons">\n                        ${Object.entries(this.reactions).map(([e,t])=>`\n                            <button class="reaction-btn" data-reaction="${e}" title="${this.getReactionLabel(e)}">\n                                <span class="reaction-emoji">${t}</span>\n                                <span class="reaction-label">${this.getReactionLabel(e)}</span>\n                            </button>\n                        `).join("")}\n                    </div>\n                </div>\n                \n                \x3c!-- フィードバックタイプ --\x3e\n                <div class="feedback-type-selector">\n                    <h4>結果についてどう思いますか？</h4>\n                    <div class="feedback-types">\n                        ${Object.entries(this.feedbackTypes).map(([e,t])=>`\n                            <label class="feedback-type-option">\n                                <input type="radio" name="feedback-type" value="${t}">\n                                <span>${this.getFeedbackTypeLabel(t)}</span>\n                            </label>\n                        `).join("")}\n                    </div>\n                </div>\n                \n                \x3c!-- 具体的なフィードバック --\x3e\n                <div class="specific-feedback">\n                    <h4>具体的にお聞かせください</h4>\n                    <textarea \n                        id="specific-feedback-text" \n                        placeholder="例：Engine OSの評価が高すぎる気がします。実際はもっと慎重に行動することが多いです。"\n                        rows="4"\n                    ></textarea>\n                </div>\n                \n                \x3c!-- 反例入力 --\x3e\n                <div class="counter-example">\n                    <h4>反例があれば教えてください（任意）</h4>\n                    <textarea \n                        id="counter-example-text" \n                        placeholder="例：最近の会議では、提案された通りではなく、チームの意見を重視して決定しました。"\n                        rows="3"\n                    ></textarea>\n                </div>\n                \n                \x3c!-- アクションボタン --\x3e\n                <div class="feedback-actions">\n                    <button class="btn-cancel" onclick="feedbackCollector.cancelFeedback()">\n                        キャンセル\n                    </button>\n                    <button class="btn-submit" onclick="feedbackCollector.submitFeedback()">\n                        フィードバックを送信\n                    </button>\n                </div>\n                \n                \x3c!-- 統計表示 --\x3e\n                ${t.total>0?`\n                    <div class="feedback-stats">\n                        <h4>これまでのフィードバック</h4>\n                        <div class="stats-grid">\n                            <div class="stat-item">\n                                <span class="stat-value">${t.total}</span>\n                                <span class="stat-label">件のフィードバック</span>\n                            </div>\n                            <div class="stat-item">\n                                <span class="stat-value">${t.disagreementRate}%</span>\n                                <span class="stat-label">不一致率</span>\n                            </div>\n                            <div class="stat-item">\n                                <span class="stat-value">${t.averageConfidence}%</span>\n                                <span class="stat-label">平均確信度</span>\n                            </div>\n                        </div>\n                    </div>\n                `:""}\n                \n                \x3c!-- プライバシー通知 --\x3e\n                <div class="privacy-notice">\n                    <p>\n                        ※ フィードバックは診断精度向上のために使用されます。\n                        個人を特定する情報は含まれません。\n                    </p>\n                </div>\n            </div>\n        `;return e&&(e.innerHTML=a,this.attachEventListeners(e)),a}attachEventListeners(e){e.querySelectorAll(".reaction-btn").forEach(e=>{e.addEventListener("click",e=>{const t=e.currentTarget.dataset.reaction;this.handleReactionClick(t,e.currentTarget)})}),e.querySelectorAll('input[name="feedback-type"]').forEach(e=>{e.addEventListener("change",e=>{this.setFeedbackType(e.target.value)})})}handleReactionClick(e,t){document.querySelectorAll(".reaction-btn").forEach(e=>{e.classList.remove("selected")}),t.classList.add("selected"),this.setReaction(this.reactions[e])}collectFeedback(e,t,a){this.createFeedback();return e&&this.setFeedbackType(e),t&&this.setReaction(t),a&&this.setSpecificFeedback(a),this.submitFeedback()}submitFeedback(){const e=document.getElementById("specific-feedback-text")?.value,t=document.getElementById("counter-example-text")?.value;if(!e||!this.currentFeedback?.type)return void alert("フィードバックタイプと具体的な内容を入力してください。");this.addSpecificFeedback(e),t&&this.addCounterExample(t);const a=this.completeFeedback();if(a){this.showThankYouMessage(),console.log("Feedback submitted:",a);const e=this.getStatistics();console.log(`KPI - Disagreement Rate: ${e.disagreementRate}%`)}}showThankYouMessage(){const e=document.createElement("div");e.className="thank-you-message",e.innerHTML='\n            <div class="message-content">\n                <span class="message-icon">🙏</span>\n                <h3>フィードバックありがとうございました</h3>\n                <p>あなたのご意見は診断精度の向上に活用させていただきます。</p>\n            </div>\n        ',document.body.appendChild(e),setTimeout(()=>{e.classList.add("show")},100),setTimeout(()=>{e.classList.remove("show"),setTimeout(()=>{document.body.removeChild(e)},300)},3e3)}getReactionLabel(e){return{SURPRISED:"驚いた",CONFUSED:"困惑した",ENLIGHTENED:"気づきがあった",VALIDATED:"確証を得た",SKEPTICAL:"懐疑的"}[e]||""}getFeedbackTypeLabel(e){return{disagree:"結果に同意できない",partial:"部分的に同意",missing:"重要な要素が欠けている",misunderstood:"誤解されている",other:"その他"}[e]||""}loadFeedbacks(){try{const e=localStorage.getItem(this.storageKey);e&&(this.feedbacks=JSON.parse(e))}catch(e){console.error("Failed to load feedbacks:",e)}}saveFeedbacks(){try{localStorage.setItem(this.storageKey,JSON.stringify(this.feedbacks))}catch(e){console.error("Failed to save feedbacks:",e)}}generateId(){return`fb_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}exportFeedbacks(){const e={exported:(new Date).toISOString(),feedbacks:this.feedbacks,statistics:this.getStatistics()},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(t),s=document.createElement("a");s.href=a,s.download=`feedbacks_${Date.now()}.json`,s.click()}}"undefined"!=typeof module&&module.exports&&(module.exports=FeedbackCollector);