class KPIAnalyzer{constructor(){this.sessionId=this.generateSessionId(),this.startTime=Date.now(),this.metrics=new Map,this.targets={completionRate:.75,disagreementRate:.2,handoffRate:.45,averageConfidence:70,mobileCompletionRate:.7,sessionDuration:300,touchTargetCompliance:.9,paradigmShiftScore:.6},this.trackingEvents=["session_start","question_start","question_answer","question_complete","analysis_start","analysis_complete","results_view","confidence_check","feedback_submit","handoff_complete","mobile_interaction","error_occurred","session_end"],this.storageKeys={sessions:"haqei_kpi_sessions",metrics:"haqei_kpi_metrics",goals:"haqei_kpi_goals",reports:"haqei_kpi_reports"},this.realtimeBuffer={events:[],maxSize:1e3,flushInterval:3e4},this.init()}init(){console.log("KPI Analyzer initializing..."),this.trackEvent("session_start",{sessionId:this.sessionId,timestamp:this.startTime,userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight},device:this.detectDevice(),referrer:document.referrer}),this.setupEventListeners(),this.cleanupOldData(),this.startRealtimeProcessing(),console.log("KPI Analyzer initialized for session:",this.sessionId)}trackEvent(e,t={}){const s={id:this.generateEventId(),sessionId:this.sessionId,type:e,timestamp:Date.now(),data:{...t},url:window.location.href,userAgent:navigator.userAgent};return this.realtimeBuffer.events.push(s),this.realtimeBuffer.events.length>this.realtimeBuffer.maxSize&&this.realtimeBuffer.events.shift(),this.persistEvent(s),this.processEventRealtime(s),console.log(`KPI Event: ${e}`,t),s}calculateUserExperienceKPIs(){const e=this.getStoredSessions();if(0===e.length)return this.getEmptyKPIs();const t=e.filter(e=>e.events.some(e=>"analysis_complete"===e.type)).length/e.length,s=e.map(e=>{const t=e.events.find(e=>"session_start"===e.type);return(e.events.find(e=>"session_end"===e.type)||e.events[e.events.length-1]).timestamp-t.timestamp}),a=s.reduce((e,t)=>e+t,0)/s.length,n=this.calculateDropoffRates(e),i=this.calculateQuestionCompletionRates(e);return{completionRate:{value:t,target:this.targets.completionRate,status:t>=this.targets.completionRate?"success":"warning"},avgSessionDuration:{value:a/1e3,target:this.targets.sessionDuration,status:a<=1e3*this.targets.sessionDuration?"success":"warning"},dropoffAnalysis:n,questionCompletionRates:i}}calculateZoneDKPIs(){const e=this.getStoredSessions().filter(e=>e.events.some(e=>"confidence_check"===e.type||"feedback_submit"===e.type||"handoff_complete"===e.type));if(0===e.length)return this.getEmptyZoneDKPIs();const t=this.getEventsByType("feedback_submit"),s=t.filter(e=>"disagree"===e.data.type||"partial"===e.data.type).length/Math.max(t.length,1),a=this.getEventsByType("handoff_complete"),n=a.length/Math.max(e.length,1),i=this.getEventsByType("confidence_check").map(e=>e.data.confidence||0),r=i.length>0?i.reduce((e,t)=>e+t,0)/i.length:0,o=this.analyzeFeedbackQuality(t),l=this.analyzeHandoffDestinations(a);return{disagreementRate:{value:s,target:this.targets.disagreementRate,status:s>=this.targets.disagreementRate?"success":"warning"},handoffRate:{value:n,target:this.targets.handoffRate,status:n>=this.targets.handoffRate?"success":"warning"},avgConfidence:{value:r,target:this.targets.averageConfidence,status:r>=this.targets.averageConfidence?"success":"warning"},feedbackQuality:o,handoffDestinations:l}}calculateMobileKPIs(){const e=this.getStoredSessions().filter(e=>this.isMobileSession(e));if(0===e.length)return this.getEmptyMobileKPIs();const t=e.filter(e=>e.events.some(e=>"analysis_complete"===e.type)).length/e.length,s=this.analyzeTouchInteractions(e),a=this.analyzeMobilePerformance(e),n=this.analyzeDeviceTypes(e);return{mobileCompletionRate:{value:t,target:this.targets.mobileCompletionRate,status:t>=this.targets.mobileCompletionRate?"success":"warning"},touchInteractions:s,performanceMetrics:a,deviceAnalysis:n}}calculateParadigmShiftKPIs(){const e=this.getStoredSessions(),t=this.getEventsByType("feedback_submit").filter(e=>e.data.specificFeedback&&e.data.specificFeedback.length>20).length/Math.max(e.length,1),s=this.getEventsByType("confidence_check"),a=s.filter(e=>e.data.confidence<70&&!e.data.userConcern).length/Math.max(s.length,1),n=this.calculateRepeatUsage(),i=this.getEventsByType("handoff_complete").length/Math.max(e.length,1),r=.3*t+.2*a+.25*n+.25*i;return{paradigmShiftScore:{value:r,target:this.targets.paradigmShiftScore,status:r>=this.targets.paradigmShiftScore?"success":"warning"},feedbackEngagement:{value:t,description:"積極的なフィードバック提供率"},lowConfidenceAcceptance:{value:a,description:"低確信度結果の受容率"},repeatUsage:{value:n,description:"リピート利用率"},handoffWillingness:{value:i,description:"AI引き継ぎ意欲"}}}generateDashboardData(){const e=this.calculateUserExperienceKPIs(),t=this.calculateZoneDKPIs(),s=this.calculateMobileKPIs(),a=this.calculateParadigmShiftKPIs(),n=this.calculateOverallScore({userExperience:e,zoneD:t,mobile:s,paradigmShift:a}),i=this.calculateTrends(),r=this.generateAlerts({userExperience:e,zoneD:t,mobile:s,paradigmShift:a});return{timestamp:(new Date).toISOString(),sessionId:this.sessionId,overallScore:n,categories:{userExperience:e,zoneD:t,mobile:s,paradigmShift:a},trends:i,alerts:r,summary:this.generateSummary({userExperience:e,zoneD:t,mobile:s,paradigmShift:a})}}updateDashboardRealtime(){const e=this.generateDashboardData(),t=new CustomEvent("kpiDashboardUpdate",{detail:e});return document.dispatchEvent(t),e}generateWeeklyReport(){const e=new Date,t=new Date(e.getTime()-6048e5),s=this.getDataByDateRange(t,e),a=this.getDataByDateRange(new Date(t.getTime()-6048e5),t);return{reportType:"weekly",period:{start:t.toISOString(),end:e.toISOString()},current:this.analyzeDataPeriod(s),previous:this.analyzeDataPeriod(a),comparison:this.compareDataPeriods(s,a),recommendations:this.generateRecommendations(s),charts:this.generateChartData(s)}}generateMonthlyReport(){const e=new Date,t=new Date(e.getFullYear(),e.getMonth(),1),s=this.getDataByDateRange(t,e),a=new Date(t.getTime()-1),n=new Date(a.getFullYear(),a.getMonth(),1),i=this.getDataByDateRange(n,a);return{reportType:"monthly",period:{start:t.toISOString(),end:e.toISOString()},current:this.analyzeDataPeriod(s),previous:this.analyzeDataPeriod(i),comparison:this.compareDataPeriods(s,i),recommendations:this.generateRecommendations(s),charts:this.generateChartData(s),goals:this.evaluateMonthlyGoals(s)}}analyzeABTest(e){const t=this.getEventsByType("ab_test").filter(t=>t.data.testId===e);if(0===t.length)return{error:"No A/B test data found for test ID: "+e};const s=t.filter(e=>"A"===e.data.variant),a=t.filter(e=>"B"===e.data.variant);return{testId:e,totalSessions:t.length,variants:{A:this.analyzeVariantPerformance(s),B:this.analyzeVariantPerformance(a)},significance:this.calculateStatisticalSignificance(s,a),recommendation:this.generateABTestRecommendation(s,a)}}setupAlerts(e){this.alertConfig={completionRateThreshold:.6,disagreementRateThreshold:.15,handoffRateThreshold:.3,errorRateThreshold:.05,...e},this.alertInterval=setInterval(()=>{this.checkAlerts()},6e4)}exportData(e="json",t=null){const s=t?this.getDataByDateRange(t.start,t.end):this.getAllStoredData();switch(e){case"csv":return this.convertToCSV(s);case"excel":return this.convertToExcel(s);default:return JSON.stringify(s,null,2)}}anonymizeData(){const e=this.getStoredSessions().map(e=>({...e,sessionId:this.hashSessionId(e.sessionId),events:e.events.map(e=>({...e,sessionId:this.hashSessionId(e.sessionId),userAgent:this.anonymizeUserAgent(e.userAgent),url:this.anonymizeUrl(e.url)}))}));return localStorage.setItem(this.storageKeys.sessions,JSON.stringify(e)),e}setupEventListeners(){window.addEventListener("beforeunload",()=>{this.trackEvent("session_end",{duration:Date.now()-this.startTime}),this.flushRealtimeBuffer()}),window.addEventListener("error",e=>{this.trackEvent("error_occurred",{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})}),"performance"in window&&window.addEventListener("load",()=>{setTimeout(()=>{const e=performance.getEntriesByType("navigation")[0];this.trackEvent("performance_metrics",{loadTime:e.loadEventEnd-e.loadEventStart,domContentLoaded:e.domContentLoadedEventEnd-e.domContentLoadedEventStart,firstPaint:performance.getEntriesByType("paint")[0]?.startTime||0})},0)})}isMobileSession(e){const t=e.events.find(e=>"session_start"===e.type);return t?.data?.device?.category?.includes("mobile")||t?.data?.viewport?.width<768}generateSessionId(){return`kpi_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateEventId(){return`evt_${Date.now()}_${Math.random().toString(36).substr(2,6)}`}detectDevice(){return{category:window.innerWidth<768?"mobile":"desktop",userAgent:navigator.userAgent,viewport:{width:window.innerWidth,height:window.innerHeight}}}persistEvent(e){try{const t=this.getStoredSessions();let s=t.find(e=>e.sessionId===this.sessionId);s||(s={sessionId:this.sessionId,startTime:this.startTime,events:[]},t.push(s)),s.events.push(e),t.length>100&&t.splice(0,t.length-100),localStorage.setItem(this.storageKeys.sessions,JSON.stringify(t))}catch(t){console.error("Failed to persist KPI event:",t)}}getStoredSessions(){try{return JSON.parse(localStorage.getItem(this.storageKeys.sessions)||"[]")}catch(e){return console.error("Failed to load KPI sessions:",e),[]}}getEventsByType(e){const t=this.getStoredSessions(),s=[];return t.forEach(t=>{s.push(...t.events.filter(t=>t.type===e))}),s}cleanupOldData(){const e=Date.now()-2592e6,t=this.getStoredSessions().filter(t=>t.startTime>=e);localStorage.setItem(this.storageKeys.sessions,JSON.stringify(t))}startRealtimeProcessing(){this.realtimeInterval=setInterval(()=>{this.flushRealtimeBuffer()},this.realtimeBuffer.flushInterval)}flushRealtimeBuffer(){this.realtimeBuffer.events.length>0&&(console.log(`Flushing ${this.realtimeBuffer.events.length} KPI events`),this.realtimeBuffer.events=[])}processEventRealtime(e){"error_occurred"===e.type&&console.warn("KPI Alert: Error occurred",e.data)}getEmptyKPIs(){return{completionRate:{value:0,target:this.targets.completionRate,status:"no-data"},avgSessionDuration:{value:0,target:this.targets.sessionDuration,status:"no-data"},dropoffAnalysis:{},questionCompletionRates:[]}}getEmptyZoneDKPIs(){return{disagreementRate:{value:0,target:this.targets.disagreementRate,status:"no-data"},handoffRate:{value:0,target:this.targets.handoffRate,status:"no-data"},avgConfidence:{value:0,target:this.targets.averageConfidence,status:"no-data"},feedbackQuality:{},handoffDestinations:{}}}getEmptyMobileKPIs(){return{mobileCompletionRate:{value:0,target:this.targets.mobileCompletionRate,status:"no-data"},touchInteractions:{},performanceMetrics:{},deviceAnalysis:{}}}calculateDropoffRates(e){return{analysis:"Detailed dropoff analysis would be implemented here"}}calculateQuestionCompletionRates(e){return[]}analyzeFeedbackQuality(e){return{analysis:"Feedback quality analysis would be implemented here"}}analyzeHandoffDestinations(e){return{analysis:"Handoff destination analysis would be implemented here"}}analyzeTouchInteractions(e){return{analysis:"Touch interaction analysis would be implemented here"}}analyzeMobilePerformance(e){return{analysis:"Mobile performance analysis would be implemented here"}}analyzeDeviceTypes(e){return{analysis:"Device type analysis would be implemented here"}}calculateRepeatUsage(){return 0}calculateOverallScore(e){return.75}calculateTrends(){return{trends:"Trend analysis would be implemented here"}}generateAlerts(e){return[]}generateSummary(e){return"KPI summary would be generated here"}destroy(){this.realtimeInterval&&clearInterval(this.realtimeInterval),this.alertInterval&&clearInterval(this.alertInterval),this.flushRealtimeBuffer(),this.trackEvent("session_end",{duration:Date.now()-this.startTime}),console.log("KPI Analyzer destroyed")}}"undefined"!=typeof window&&(window.kpiAnalyzer=new KPIAnalyzer),"undefined"!=typeof module&&module.exports&&(module.exports=KPIAnalyzer);