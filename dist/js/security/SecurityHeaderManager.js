class SecurityHeaderManager{constructor(){this.config=this.getSecurityConfig(),this.nonce=this.generateNonce(),this.violations=[],this.init()}getSecurityConfig(){return{csp:{defaultSrc:["'self'"],scriptSrc:["'self'","'nonce-{nonce}'","https://cdn.jsdelivr.net","https://cdnjs.cloudflare.com"],styleSrc:["'self'","'nonce-{nonce}'","'unsafe-inline'","https://fonts.googleapis.com","https://cdn.jsdelivr.net"],imgSrc:["'self'","data:","https:","blob:"],fontSrc:["'self'","https://fonts.gstatic.com","https://cdn.jsdelivr.net"],connectSrc:["'self'","https://api.haqei.com","https://*.haqei.com"],mediaSrc:["'self'"],objectSrc:["'none'"],frameSrc:["'none'"],frameAncestors:["'none'"],baseUri:["'self'"],formAction:["'self'"],upgradeInsecureRequests:!0,blockAllMixedContent:!0},headers:{strictTransportSecurity:{maxAge:31536e3,includeSubDomains:!0,preload:!0},xContentTypeOptions:"nosniff",xFrameOptions:"DENY",xXSSProtection:"1; mode=block",referrerPolicy:"strict-origin-when-cross-origin",permissionsPolicy:{geolocation:[],microphone:[],camera:[],payment:["self"],fullscreen:["self"]}},environment:{development:{reportOnly:!0,allowUnsafeInline:!0,allowUnsafeEval:!1},production:{reportOnly:!1,allowUnsafeInline:!1,allowUnsafeEval:!1}}}}init(){try{if(this.detectEnvironment(),window.HAQEI_CONFIG&&window.HAQEI_CONFIG.security&&!window.HAQEI_CONFIG.security.enableCSP)return void console.log("🔧 CSPは設定により無効化されています");if("development"===this.environment&&(window.DEV_MODE||window.DISABLE_CSP))return void console.log("🔧 開発環境: セキュリティヘッダーを無効化");this.applyClientSideHeaders(),this.setupCSPViolationReporting(),this.validateExistingHeaders(),this.monitorSecurityViolations(),console.log("🛡️ セキュリティヘッダー管理システム初期化完了")}catch(e){console.error("❌ セキュリティヘッダー初期化エラー:",e)}}detectEnvironment(){this.environment="localhost"===location.hostname||"127.0.0.1"===location.hostname||location.hostname.includes("dev")||"http:"===location.protocol?"development":"production",console.log(`🔍 検出環境: ${this.environment}`)}applyClientSideHeaders(){this.setCSPMetaTag(),this.setSecurityMetaTags(),this.applyNonceToScripts(),this.validateResourceIntegrity()}setCSPMetaTag(){if("development"===this.environment&&(window.DEV_MODE||window.DISABLE_CSP))return void console.log("🔧 開発環境: CSPメタタグをスキップ");if(document.querySelector('meta[http-equiv="Content-Security-Policy"]'))console.log("📋 既存CSPメタタグ検出");else{const e=document.createElement("meta");e.httpEquiv="Content-Security-Policy",e.content=this.buildCSPHeader(),document.head.appendChild(e),console.log("📋 CSPメタタグ設定完了")}}buildCSPHeader(){const e=this.config.environment[this.environment],t=this.config.csp,i=[];i.push(`default-src ${t.defaultSrc.join(" ")}`);let n=[...t.scriptSrc];return e.allowUnsafeInline&&n.push("'unsafe-inline'"),e.allowUnsafeEval&&n.push("'unsafe-eval'"),i.push(`script-src ${n.join(" ").replace(/{nonce}/g,this.nonce)}`),i.push(`style-src ${t.styleSrc.join(" ").replace(/{nonce}/g,this.nonce)}`),i.push(`img-src ${t.imgSrc.join(" ")}`),i.push(`font-src ${t.fontSrc.join(" ")}`),i.push(`connect-src ${t.connectSrc.join(" ")}`),i.push(`media-src ${t.mediaSrc.join(" ")}`),i.push(`object-src ${t.objectSrc.join(" ")}`),i.push(`frame-src ${t.frameSrc.join(" ")}`),i.push(`frame-ancestors ${t.frameAncestors.join(" ")}`),i.push(`base-uri ${t.baseUri.join(" ")}`),i.push(`form-action ${t.formAction.join(" ")}`),t.upgradeInsecureRequests&&i.push("upgrade-insecure-requests"),t.blockAllMixedContent&&i.push("block-all-mixed-content"),"development"===this.environment&&i.push("report-uri /csp-violation-report"),i.join("; ")}setSecurityMetaTags(){[{httpEquiv:"X-Content-Type-Options",content:this.config.headers.xContentTypeOptions},{httpEquiv:"X-Frame-Options",content:this.config.headers.xFrameOptions},{httpEquiv:"X-XSS-Protection",content:this.config.headers.xXSSProtection},{httpEquiv:"Referrer-Policy",content:this.config.headers.referrerPolicy},{httpEquiv:"Permissions-Policy",content:this.buildPermissionsPolicyHeader()}].forEach(e=>{if(!document.querySelector(`meta[http-equiv="${e.httpEquiv}"]`)){const t=document.createElement("meta");t.httpEquiv=e.httpEquiv,t.content=e.content,document.head.appendChild(t)}}),console.log("🔒 セキュリティメタタグ設定完了")}buildPermissionsPolicyHeader(){const e=this.config.headers.permissionsPolicy,t=[];return Object.entries(e).forEach(([e,i])=>{if(0===i.length)t.push(`${e}=()`);else{const n=i.map(e=>"self"===e?"self":`"${e}"`).join(" ");t.push(`${e}=(${n})`)}}),t.join(", ")}applyNonceToScripts(){const e=document.querySelectorAll("script[src]"),t=document.querySelectorAll("script:not([src])");e.forEach(e=>{e.hasAttribute("nonce")||e.setAttribute("nonce",this.nonce)}),t.forEach(e=>{!e.hasAttribute("nonce")&&e.textContent.trim()&&e.setAttribute("nonce",this.nonce)}),console.log(`🔑 ${e.length+t.length}個のスクリプトにNonce適用完了`)}validateResourceIntegrity(){const e=document.querySelectorAll('script[src], link[rel="stylesheet"][href]'),t=[];e.forEach(e=>{const i=e.src||e.href;this.isExternalCDN(i)&&!e.hasAttribute("integrity")&&(t.push(e),console.warn(`⚠️ SRI未設定リソース: ${i}`))}),t.length>0&&console.warn(`⚠️ ${t.length}個のリソースでSRIが未設定です`)}isExternalCDN(e){return[/cdn\.jsdelivr\.net/,/cdnjs\.cloudflare\.com/,/unpkg\.com/,/fonts\.googleapis\.com/,/fonts\.gstatic\.com/].some(t=>t.test(e))}setupCSPViolationReporting(){document.addEventListener("securitypolicyviolation",e=>{this.handleCSPViolation(e)}),window.addEventListener("error",e=>{e.message&&e.message.includes("Content Security Policy")&&this.handleCSPError(e)}),console.log("📊 CSP違反レポート設定完了")}handleCSPViolation(e){const t={timestamp:(new Date).toISOString(),documentURI:e.documentURI,referrer:e.referrer,violatedDirective:e.violatedDirective,effectiveDirective:e.effectiveDirective,originalPolicy:e.originalPolicy,blockedURI:e.blockedURI,lineNumber:e.lineNumber,columnNumber:e.columnNumber,sourceFile:e.sourceFile,statusCode:e.statusCode,disposition:e.disposition};this.violations.push(t),console.warn("🚨 CSP違反検出:",t),this.isCriticalViolation(t)&&this.handleCriticalViolation(t),this.updateViolationStats()}handleCSPError(e){const t={timestamp:(new Date).toISOString(),message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno,error:e.error?.toString(),type:"csp-error"};console.warn("⚠️ CSP関連エラー:",t),this.violations.push(t)}isCriticalViolation(e){return["script-src","object-src","base-uri","form-action"].includes(e.effectiveDirective)||e.blockedURI.includes("javascript:")||e.blockedURI.includes("data:")}handleCriticalViolation(e){console.error("🚨 重要なCSP違反:",e),window.SecurityLogger&&window.SecurityLogger.logCriticalViolation(e),window.AdminNotification&&window.AdminNotification.securityAlert({type:"CSP_VIOLATION",severity:"CRITICAL",details:e})}validateExistingHeaders(){const e={csp:this.validateCSP(),hsts:this.validateHSTS(),xContentTypeOptions:this.validateXContentTypeOptions(),xFrameOptions:this.validateXFrameOptions(),referrerPolicy:this.validateReferrerPolicy()};return console.log("📋 ヘッダー検証結果:",e),e}validateCSP(){const e=document.querySelector('meta[http-equiv="Content-Security-Policy"]');if(!e)return{status:"missing",message:"CSPメタタグが設定されていません"};const t=e.content,i=[];return t.includes("'unsafe-inline'")&&"production"===this.environment&&i.push("'unsafe-inline'が本番環境で使用されています"),t.includes("'unsafe-eval'")&&i.push("'unsafe-eval'が使用されています"),t.includes("object-src 'none'")||i.push("object-srcが適切に制限されていません"),{status:0===i.length?"valid":"warning",issues:i,policy:t}}validateHSTS(){return"https:"!==location.protocol&&"production"===this.environment?{status:"error",message:"本番環境でHTTPSが使用されていません"}:{status:"valid",message:"HTTPS使用中"}}validateXContentTypeOptions(){const e=document.querySelector('meta[http-equiv="X-Content-Type-Options"]');return e&&"nosniff"===e.content?{status:"valid"}:{status:"missing",message:"X-Content-Type-Optionsが適切に設定されていません"}}validateXFrameOptions(){const e=document.querySelector('meta[http-equiv="X-Frame-Options"]');return e&&["DENY","SAMEORIGIN"].includes(e.content)?{status:"valid"}:{status:"missing",message:"X-Frame-Optionsが適切に設定されていません"}}validateReferrerPolicy(){const e=document.querySelector('meta[http-equiv="Referrer-Policy"]');if(!e)return{status:"missing",message:"Referrer-Policyが設定されていません"};return["no-referrer","no-referrer-when-downgrade","origin","origin-when-cross-origin","same-origin","strict-origin","strict-origin-when-cross-origin"].includes(e.content)?{status:"valid"}:{status:"invalid",message:"無効なReferrer-Policyが設定されています"}}monitorSecurityViolations(){setInterval(()=>{this.analyzeViolationTrends()},3e5),window.addEventListener("beforeunload",()=>{this.sendViolationReport()})}analyzeViolationTrends(){const e=this.getRecentViolations(9e5);e.length>10&&(console.warn("🚨 異常な違反数を検出:",e.length),this.reportAnomalousActivity(e));const t=this.analyzeViolationPatterns(e);t.suspiciousPatterns.length>0&&console.warn("🔍 疑わしい違反パターン:",t)}getRecentViolations(e){const t=Date.now()-e;return this.violations.filter(e=>new Date(e.timestamp).getTime()>t)}analyzeViolationPatterns(e){const t={blockedURIs:{},violatedDirectives:{},suspiciousPatterns:[]};return e.forEach(e=>{e.blockedURI&&(t.blockedURIs[e.blockedURI]=(t.blockedURIs[e.blockedURI]||0)+1),e.violatedDirective&&(t.violatedDirectives[e.violatedDirective]=(t.violatedDirectives[e.violatedDirective]||0)+1),e.blockedURI&&(e.blockedURI.includes("javascript:")||e.blockedURI.includes("data:text/html"))&&t.suspiciousPatterns.push(e)}),t}sendViolationReport(){if(0===this.violations.length)return;const e={timestamp:(new Date).toISOString(),url:window.location.href,userAgent:navigator.userAgent,violations:this.violations,stats:this.getViolationStats()};window.SecurityReporter&&window.SecurityReporter.sendReport(e),console.log("📊 セキュリティ違反レポート送信:",e)}generateNonce(){if(window.crypto&&window.crypto.getRandomValues){const e=new Uint8Array(16);return window.crypto.getRandomValues(e),btoa(String.fromCharCode.apply(null,e))}return btoa(Math.random().toString(36).substring(2)+Date.now().toString(36))}updateViolationStats(){if("development"===this.environment){const e=this.getViolationStats();localStorage.setItem("csp-violation-stats",JSON.stringify(e))}}getViolationStats(){return{totalViolations:this.violations.length,recentViolations:this.getRecentViolations(36e5).length,violationsByDirective:this.getViolationsByDirective(),violationsByURI:this.getViolationsByURI(),environment:this.environment,currentNonce:this.nonce}}getViolationsByDirective(){const e={};return this.violations.forEach(t=>{t.violatedDirective&&(e[t.violatedDirective]=(e[t.violatedDirective]||0)+1)}),e}getViolationsByURI(){const e={};return this.violations.forEach(t=>{t.blockedURI&&(e[t.blockedURI]=(e[t.blockedURI]||0)+1)}),e}reportAnomalousActivity(e){const t={timestamp:(new Date).toISOString(),type:"ANOMALOUS_CSP_VIOLATIONS",violationCount:e.length,patterns:this.analyzeViolationPatterns(e),environment:this.environment};console.error("🚨 異常なCSP違反活動:",t),window.SecurityLogger&&window.SecurityLogger.logAnomalousActivity(t)}}"undefined"!=typeof window&&(window.SecurityHeaderManager=SecurityHeaderManager,window.securityHeaders=new SecurityHeaderManager),"undefined"!=typeof module&&module.exports&&(module.exports=SecurityHeaderManager),console.log("🛡️ SecurityHeaderManager.js 読み込み完了 - 企業レベルセキュリティヘッダー管理");