class InputValidationSystem{constructor(){this.config=this.getValidationConfig(),this.violations=[],this.patterns=this.getSecurityPatterns(),this.init()}getValidationConfig(){return{maxLength:{text:1e3,name:100,email:254,url:2048,password:128},minLength:{text:1,name:2,password:12},allowedCharacters:{name:/^[a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s_-]+$/,email:/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,alphanumeric:/^[a-zA-Z0-9]+$/,japanese:/^[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s]+$/},forbiddenPatterns:{sqlKeywords:/\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER|EXEC|UNION|SCRIPT)\b/gi,scriptTags:/<\s*script[^>]*>.*?<\s*\/\s*script\s*>/gi,htmlTags:/<[^>]+>/g,javascriptProtocol:/javascript\s*:/gi,controlChars:/[\x00-\x1F\x7F-\x9F]/g},rateLimits:{maxValidationsPerMinute:1e3,maxViolationsPerMinute:10}}}getSecurityPatterns(){return{sqlInjection:[/(\s*([\0\b\'\"\n\r\t\%\_\\]*\s*(((select\s*.+\s*from\s*.+)|(insert\s*.+\s*into\s*.+)|(update\s*.+\s*set\s*.+)|(delete\s*.+\s*from\s*.+)|(drop\s*.+)|(truncate\s*.+)|(alter\s*.+)|(exec\s*.+)|(\s*(all|any|not|and|between|in|like|or|some|contains|containsall|containskey)\s*.+[\=\>\<=\!\~]+.+)|(let\s+.+[\=]\s*.+)|(begin\s*[\s\w\preceq]+\s*end)|(\s*[\/\*]+\s*...\s*[\*\/]+)|(\s*(\-\-)\s*.*\s+)|(\s*(contains|containsall|containskey)\s*[\(].*[\)])))))/i,/'(\s*or\s*')/i,/exec(\s|\+)+(s|x)p\w+/i],xss:[/<script[^>]*>.*?<\/script>/gi,/javascript\s*:/gi,/on\w+\s*=\s*["'][^"']*["']/gi,/<iframe[^>]*>.*?<\/iframe>/gi,/<object[^>]*>.*?<\/object>/gi,/<embed[^>]*>/gi,/expression\s*\(/gi],pathTraversal:[/\.\.[\/\\]/g,/[\/\\]\.\.[\/\\]/g,/%2e%2e[\/\\]/gi,/\.\.%2f/gi,/\.\.%5c/gi],commandInjection:[/[;&|`$()]/g,/\bnc\s+-/i,/\bwget\s+/i,/\bcurl\s+/i,/\bpython\s+/i]}}init(){this.setupGlobalValidation(),this.setupFormValidation(),this.setupRealTimeValidation(),this.startViolationMonitoring(),console.log("âœ… å…¥åŠ›æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†")}setupGlobalValidation(){document.addEventListener("input",t=>{"INPUT"!==t.target.tagName&&"TEXTAREA"!==t.target.tagName||this.validateInput(t.target)}),document.addEventListener("submit",t=>{this.validateForm(t.target)||(t.preventDefault(),this.showValidationError("ãƒ•ã‚©ãƒ¼ãƒ ã«ç„¡åŠ¹ãªå…¥åŠ›ãŒå«ã¾ã‚Œã¦ã„ã¾ã™"))})}setupFormValidation(){document.querySelectorAll("form").forEach(t=>{t.setAttribute("data-validation-enabled","true");t.querySelectorAll("input, textarea, select").forEach(t=>{this.setupInputValidation(t)})})}setupInputValidation(t){const e=t.dataset.validation||"text",a=parseInt(t.dataset.maxLength)||this.config.maxLength[e],i=parseInt(t.dataset.minLength)||this.config.minLength[e];t.setAttribute("data-validation-type",e),a&&t.setAttribute("maxlength",a),i&&t.setAttribute("data-minlength",i),t.addEventListener("input",()=>this.validateInput(t)),t.addEventListener("blur",()=>this.validateInput(t,!0))}setupRealTimeValidation(){new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){const e=!t.tagName||"INPUT"!==t.tagName&&"TEXTAREA"!==t.tagName?t.querySelectorAll&&t.querySelectorAll("input, textarea"):[t];e&&e.forEach(t=>this.setupInputValidation(t))}})})}).observe(document.body,{childList:!0,subtree:!0})}validateInput(t,e=!1){if(!t||!t.value)return!0;const a=t.value,i=t.dataset.validationType||"text",s=[];try{s.push(this.validateLength(a,i)),s.push(this.validateCharacters(a,i)),s.push(this.validateSecurity(a)),"email"===i?s.push(this.validateEmail(a)):"url"===i?s.push(this.validateURL(a)):"password"===i&&s.push(this.validatePassword(a));const n=this.combineValidationResults(s);return this.updateInputValidationUI(t,n,e),n.isValid||this.logValidationViolation(t,n),n.isValid}catch(n){return console.error("âŒ å…¥åŠ›æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:",n),!1}}validateLength(t,e){const a=this.config.maxLength[e]||this.config.maxLength.text,i=this.config.minLength[e]||this.config.minLength.text,s=[];return t.length>a&&s.push(`æ–‡å­—æ•°ãŒåˆ¶é™ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆæœ€å¤§${a}æ–‡å­—ï¼‰`),t.length<i&&s.push(`æ–‡å­—æ•°ãŒä¸è¶³ã—ã¦ã„ã¾ã™ï¼ˆæœ€å°${i}æ–‡å­—ï¼‰`),{type:"length",isValid:0===s.length,errors:s}}validateCharacters(t,e){const a=this.config.allowedCharacters[e],i=[];return a&&!a.test(t)&&i.push("è¨±å¯ã•ã‚Œã¦ã„ãªã„æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™"),this.config.forbiddenPatterns.controlChars.test(t)&&i.push("åˆ¶å¾¡æ–‡å­—ãŒå«ã¾ã‚Œã¦ã„ã¾ã™"),{type:"characters",isValid:0===i.length,errors:i}}validateSecurity(t){const e=[],a=[];return this.patterns.sqlInjection.forEach((i,s)=>{i.test(t)&&(e.push("SQLã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"),a.push({type:"SQL_INJECTION",pattern:s}))}),this.patterns.xss.forEach((i,s)=>{i.test(t)&&(e.push("XSSæ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"),a.push({type:"XSS",pattern:s}))}),this.patterns.pathTraversal.forEach((i,s)=>{i.test(t)&&(e.push("ãƒ‘ã‚¹ãƒˆãƒ©ãƒãƒ¼ã‚µãƒ«æ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"),a.push({type:"PATH_TRAVERSAL",pattern:s}))}),this.patterns.commandInjection.forEach((i,s)=>{i.test(t)&&(e.push("ã‚³ãƒãƒ³ãƒ‰ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³æ”»æ’ƒã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"),a.push({type:"COMMAND_INJECTION",pattern:s}))}),{type:"security",isValid:0===e.length,errors:e,threats:a}}validateEmail(t){const e=[];this.config.allowedCharacters.email.test(t)||e.push("æœ‰åŠ¹ãªãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“");const a=t.split("@");if(2!==a.length)e.push("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“");else{const[t,i]=a;t.length>64&&e.push("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ­ãƒ¼ã‚«ãƒ«éƒ¨ãŒé•·ã™ãã¾ã™"),i.length>253&&e.push("ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®ãƒ‰ãƒ¡ã‚¤ãƒ³éƒ¨ãŒé•·ã™ãã¾ã™")}return{type:"email",isValid:0===e.length,errors:e}}validateURL(t){const e=[];try{const a=new URL(t);["http:","https:"].includes(a.protocol)||e.push("HTTPã¾ãŸã¯HTTPSãƒ—ãƒ­ãƒˆã‚³ãƒ«ã®ã¿è¨±å¯ã•ã‚Œã¦ã„ã¾ã™"),t.length>this.config.maxLength.url&&e.push(`URLé•·ãŒåˆ¶é™ã‚’è¶…ãˆã¦ã„ã¾ã™ï¼ˆæœ€å¤§${this.config.maxLength.url}æ–‡å­—ï¼‰`)}catch(a){e.push("æœ‰åŠ¹ãªURLå½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“")}return{type:"url",isValid:0===e.length,errors:e}}validatePassword(t){const e=[];return t.length<this.config.minLength.password&&e.push(`ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯${this.config.minLength.password}æ–‡å­—ä»¥ä¸Šå¿…è¦ã§ã™`),/[A-Z]/.test(t)||e.push("å¤§æ–‡å­—ã‚’1æ–‡å­—ä»¥ä¸Šå«ã‚ã¦ãã ã•ã„"),/[a-z]/.test(t)||e.push("å°æ–‡å­—ã‚’1æ–‡å­—ä»¥ä¸Šå«ã‚ã¦ãã ã•ã„"),/\d/.test(t)||e.push("æ•°å­—ã‚’1æ–‡å­—ä»¥ä¸Šå«ã‚ã¦ãã ã•ã„"),/[^a-zA-Z0-9]/.test(t)||e.push("è¨˜å·ã‚’1æ–‡å­—ä»¥ä¸Šå«ã‚ã¦ãã ã•ã„"),/(.)\1{2,}/.test(t)&&e.push("åŒã˜æ–‡å­—ã‚’3å›ä»¥ä¸Šç¹°ã‚Šè¿”ã™ã“ã¨ã¯ã§ãã¾ã›ã‚“"),{type:"password",isValid:0===e.length,errors:e}}combineValidationResults(t){const e=[],a=[];let i=!0;return t.forEach(t=>{t.isValid||(i=!1),t.errors&&e.push(...t.errors),t.threats&&a.push(...t.threats)}),{isValid:i,errors:e,threats:a}}validateForm(t){const e=t.querySelectorAll("input, textarea, select");let a=!0;return e.forEach(t=>{this.validateInput(t,!0)||(a=!1)}),a}sanitizeInput(t,e="text"){if("string"!=typeof t)return"";let a=t;switch(a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"),a=a.replace(this.config.forbiddenPatterns.controlChars,""),e){case"name":a=a.replace(/[^a-zA-Z0-9\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF\s_-]/g,"");break;case"alphanumeric":a=a.replace(/[^a-zA-Z0-9]/g,"")}return a.trim()}updateInputValidationUI(t,e,a){t.classList.toggle("validation-error",!e.isValid),t.classList.toggle("validation-success",e.isValid),a&&!e.isValid?this.displayValidationErrors(t,e.errors):this.clearValidationErrors(t)}displayValidationErrors(t,e){const a=this.getOrCreateErrorContainer(t);a.innerHTML="",e.forEach(t=>{const e=document.createElement("div");e.className="validation-error-message",e.textContent=t,a.appendChild(e)}),a.style.display="block"}clearValidationErrors(t){const e=t.parentNode.querySelector(".validation-errors");e&&(e.style.display="none")}getOrCreateErrorContainer(t){let e=t.parentNode.querySelector(".validation-errors");return e||(e=document.createElement("div"),e.className="validation-errors",t.parentNode.appendChild(e)),e}logValidationViolation(t,e){const a={timestamp:(new Date).toISOString(),inputName:t.name||t.id||"unknown",inputType:t.type||"unknown",validationType:t.dataset.validationType||"text",errors:e.errors,threats:e.threats,value:t.value.substring(0,100),url:window.location.href,userAgent:navigator.userAgent};this.violations.push(a),e.threats&&e.threats.length>0&&(console.warn("ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è„…å¨æ¤œå‡º:",a),this.reportSecurityThreat(a))}reportSecurityThreat(t){window.SecurityLogger&&window.SecurityLogger.logThreat(t),window.AdminNotification&&window.AdminNotification.securityAlert(t)}startViolationMonitoring(){setInterval(()=>{this.analyzeViolationTrends()},6e4)}analyzeViolationTrends(){const t=this.violations.filter(t=>Date.now()-new Date(t.timestamp).getTime()<6e4);t.length>this.config.rateLimits.maxViolationsPerMinute&&(console.warn("ğŸš¨ ç•°å¸¸ãªæ¤œè¨¼é•åç‡ã‚’æ¤œå‡º:",t.length),this.reportAnomalousActivity(t))}reportAnomalousActivity(t){const e={timestamp:(new Date).toISOString(),violationCount:t.length,threatTypes:[...new Set(t.flatMap(t=>t.threats?.map(t=>t.type)||[]))],affectedInputs:[...new Set(t.map(t=>t.inputName))],userAgent:navigator.userAgent,url:window.location.href};console.error("ğŸš¨ ç•°å¸¸æ´»å‹•æ¤œå‡ºãƒ¬ãƒãƒ¼ãƒˆ:",e)}showValidationError(t){console.error("âŒ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼:",t),window.notifications&&window.notifications.showError(t)}getValidationStats(){return{totalViolations:this.violations.length,recentViolations:this.violations.filter(t=>Date.now()-new Date(t.timestamp).getTime()<36e5).length,threatTypes:this.getTopThreatTypes(),validatedInputs:document.querySelectorAll("[data-validation-type]").length,protectedForms:document.querySelectorAll("form[data-validation-enabled]").length}}getTopThreatTypes(){const t={};return this.violations.forEach(e=>{e.threats&&e.threats.forEach(e=>{t[e.type]=(t[e.type]||0)+1})}),Object.entries(t).sort(([,t],[,e])=>e-t).slice(0,5)}}"undefined"!=typeof window&&(window.InputValidationSystem=InputValidationSystem,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.inputValidation=new InputValidationSystem}):window.inputValidation=new InputValidationSystem),"undefined"!=typeof module&&module.exports&&(module.exports=InputValidationSystem),console.log("ğŸ”’ InputValidationSystem.js èª­ã¿è¾¼ã¿å®Œäº† - ä¼æ¥­ãƒ¬ãƒ™ãƒ«å…¥åŠ›æ¤œè¨¼");