class SecurityManager{constructor(){this.securityLevel="high",this.policies={csp:{"default-src":["'self'"],"script-src":["'self'","'unsafe-inline'","https://cdn.jsdelivr.net"],"style-src":["'self'","'unsafe-inline'"],"img-src":["'self'","data:","blob:"],"connect-src":["'self'","https://api.haqei.com"],"font-src":["'self'","data:"],"object-src":["'none'"],"base-uri":["'self'"],"form-action":["'self'"]},xss:{enabled:!0,sanitizeInputs:!0,validateOutputs:!0,escapeHTML:!0},privacy:{localStorageOnly:!0,noExternalTracking:!0,encryptSensitiveData:!0,anonymizeUserData:!0}},this.threats=[],this.securityEvents=[],this.init()}init(){console.log("ğŸ›¡ï¸ Security Manager initializing..."),this.setupCSP(),this.setupXSSProtection(),this.setupPrivacyProtection(),this.startSecurityMonitoring(),this.setupDataEncryption(),console.log("âœ… Security Manager initialized")}setupCSP(){const e=Object.entries(this.policies.csp).map(([e,t])=>`${e} ${t.join(" ")}`).join("; "),t=document.createElement("meta");t.httpEquiv="Content-Security-Policy",t.content=e,document.head.appendChild(t),console.log("ğŸ›¡ï¸ CSP configured:",e),document.addEventListener("securitypolicyviolation",e=>{this.handleCSPViolation(e)})}setupXSSProtection(){const e=document.createElement("meta");e.httpEquiv="X-XSS-Protection",e.content="1; mode=block",document.head.appendChild(e);const t=document.createElement("meta");t.httpEquiv="X-Content-Type-Options",t.content="nosniff",document.head.appendChild(t),this.setupDOMSanitization(),console.log("ğŸ”’ XSS Protection enabled")}setupDOMSanitization(){const e=Element.prototype.__lookupSetter__("innerHTML"),t=this;Object.defineProperty(Element.prototype,"innerHTML",{set:function(i){const n=t.sanitizeHTML(i);e.call(this,n)},get:Element.prototype.__lookupGetter__("innerHTML")}),this.setupInputSanitization()}setupInputSanitization(){document.addEventListener("input",e=>{if("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName){const t=this.sanitizeInput(e.target.value);t!==e.target.value&&(e.target.value=t,this.logSecurityEvent("input_sanitized",{element:e.target.id||e.target.name,original_length:e.target.value.length,sanitized_length:t.length}))}})}sanitizeHTML(e){if("string"!=typeof e)return e;if(e.includes('class="option-text"')||e.includes('class="question-card"')||e.includes('class="result-')||e.includes("data-question-id")){const t=/<script[^>]*>.*?<\/script>/gis,i=/on\w+\s*=\s*["'][^"']*["']/gi,n=/javascript:|data:|vbscript:/gi;return e.replace(t,"").replace(i,"").replace(n,"")}let t=e.replace(/<script[^>]*>.*?<\/script>/gis,"").replace(/on\w+\s*=\s*["'][^"']*["']/gi,"").replace(/javascript:|data:|vbscript:/gi,"");const i={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;"};return e.length<1e3&&!e.includes("class=")&&(t=t.replace(/[&<>"'\/]/g,e=>i[e])),t}sanitizeInput(e){if("string"!=typeof e)return e;let t=e;return[/(\b(SELECT|INSERT|UPDATE|DELETE|DROP|CREATE|ALTER)\b)/gi,/(--|\#|\/\*|\*\/)/g,/('|(\\')|("|\\"))/g].forEach(e=>{t=t.replace(e,"")}),t=this.sanitizeHTML(t),t.length>1e3&&(t=t.substring(0,1e3)),t}setupPrivacyProtection(){const e=document.createElement("meta");e.name="referrer",e.content="strict-origin-when-cross-origin",document.head.appendChild(e),this.detectPrivateBrowsing(),this.encryptLocalStorage(),this.blockExternalTracking(),console.log("ğŸ” Privacy Protection enabled")}detectPrivateBrowsing(){return new Promise(e=>{const t=window.sessionStorage;try{t.setItem("private_test","1"),t.removeItem("private_test"),e(!1)}catch(i){e(!0)}}).then(e=>{this.isPrivateBrowsing=e,e&&(console.log("ğŸ•¶ï¸ Private browsing detected"),this.adjustForPrivateBrowsing())})}adjustForPrivateBrowsing(){this.policies.privacy.localStorageOnly=!1,window.tempStorage={},window.kpiAnalyzer&&window.kpiAnalyzer.setPrivateMode(!0)}encryptLocalStorage(){const e=localStorage.setItem.bind(localStorage),t=localStorage.getItem.bind(localStorage);localStorage.setItem=(t,i)=>{if(t.startsWith("haqei_")){const n=this.encrypt(i);e(`${t}_encrypted`,n)}else e(t,i)},localStorage.getItem=e=>{if(e.startsWith("haqei_")){const i=t(`${e}_encrypted`);return i?this.decrypt(i):null}return t(e)},console.log("ğŸ” LocalStorage encryption enabled")}encrypt(e){const t="haqei_security_key_2025";let i="";for(let n=0;n<e.length;n++){const s=t.charCodeAt(n%23),o=e.charCodeAt(n);i+=String.fromCharCode(o^s)}return btoa(i)}decrypt(e){try{const t="haqei_security_key_2025",i=atob(e);let n="";for(let e=0;e<i.length;e++){const s=t.charCodeAt(e%t.length),o=i.charCodeAt(e);n+=String.fromCharCode(o^s)}return n}catch(t){return console.warn("ğŸ”“ Decryption failed:",t),null}}blockExternalTracking(){const e=["google-analytics.com","googletagmanager.com","facebook.com","twitter.com","doubleclick.net"],t=window.fetch;window.fetch=function(i,n){if("string"==typeof i)for(const t of e)if(i.includes(t))return console.log("ğŸš« Blocked tracking request:",i),Promise.reject(new Error("Blocked by SecurityManager"));return t(i,n)},console.log("ğŸš« External tracking blocked")}startSecurityMonitoring(){this.monitorSuspiciousActivity(),this.startSecurityLogging(),this.scheduleSecurityChecks()}monitorSuspiciousActivity(){let e=0,t=0;document.addEventListener("click",i=>{const n=Date.now();n-t<50?(e++,e>5&&this.handleSuspiciousActivity("rapid_clicking",{count:e,target:i.target.tagName})):e=0,t=n}),this.detectDevTools()}detectDevTools(){let e=!1;const detectMethod1=()=>{const e=new Date;return new Date-e>100};setInterval(()=>{detectMethod1()||window.outerHeight-window.innerHeight>200?e||(e=!0,this.handleSuspiciousActivity("devtools_detected",{method:detectMethod1()?"debugger":"window_size",timestamp:(new Date).toISOString()})):e=!1},5e3)}handleSuspiciousActivity(e,t){console.warn("ğŸš¨ Suspicious activity detected:",e,t),this.logSecurityEvent("suspicious_activity",{type:e,details:t,userAgent:navigator.userAgent,timestamp:(new Date).toISOString()}),"rapid_clicking"===e&&t.count>10&&this.temporaryDisable(5e3)}temporaryDisable(e){const t=document.querySelectorAll('button, input[type="submit"]');t.forEach(e=>{e.disabled=!0,e.style.opacity="0.5"}),setTimeout(()=>{t.forEach(e=>{e.disabled=!1,e.style.opacity="1"})},e),console.log(`ğŸ”’ Functions temporarily disabled for ${e}ms`)}handleCSPViolation(e){this.logSecurityEvent("csp_violation",{blockedURI:e.blockedURI,violatedDirective:e.violatedDirective,sourceFile:e.sourceFile,lineNumber:e.lineNumber}),console.warn("ğŸš¨ CSP Violation:",e.violatedDirective,e.blockedURI)}logSecurityEvent(e,t){const i={id:this.generateEventId(),type:e,details:t,timestamp:(new Date).toISOString(),sessionId:window.kpiAnalyzer?.sessionId||"unknown"};this.securityEvents.push(i),["csp_violation","suspicious_activity"].includes(e)&&this.persistSecurityEvent(i),this.securityEvents.length>100&&this.securityEvents.shift()}persistSecurityEvent(e){try{const t=JSON.parse(localStorage.getItem("haqei_security_log")||"[]");t.push(e),t.length>100&&t.shift(),localStorage.setItem("haqei_security_log",JSON.stringify(t))}catch(t){console.warn("Failed to persist security event:",t)}}scheduleSecurityChecks(){setInterval(()=>{this.runSecurityCheck()},6e4)}runSecurityCheck(){const e=[this.checkCSPCompliance(),this.checkDataIntegrity(),this.checkPrivacySettings(),this.checkSuspiciousPatterns()];Promise.all(e).then(e=>{const t=e.reduce((e,t)=>e+t.score,0)/e.length;t<70?(console.warn("ğŸ”´ Security score low:",t),this.handleSecurityDegradation(e)):console.log("ğŸŸ¢ Security check passed:",t)})}checkCSPCompliance(){const e=document.querySelector('meta[http-equiv="Content-Security-Policy"]');return{name:"CSP Compliance",score:e?100:0,details:e?"CSP configured":"CSP missing"}}checkDataIntegrity(){try{const e=null===localStorage.getItem("haqei_test_integrity");return{name:"Data Integrity",score:e?100:0,details:e?"Data intact":"Data compromised"}}catch(e){return{name:"Data Integrity",score:0,details:"Check failed"}}}checkPrivacySettings(){return{name:"Privacy Settings",score:this.policies.privacy.localStorageOnly?100:50,details:"Privacy policies active"}}checkSuspiciousPatterns(){const e=this.securityEvents.filter(e=>Date.now()-new Date(e.timestamp).getTime()<3e5).filter(e=>"suspicious_activity"===e.type).length;return{name:"Suspicious Patterns",score:Math.max(0,100-20*e),details:`${e} suspicious events in last 5 minutes`}}handleSecurityDegradation(e){console.warn("ğŸš¨ Security degradation detected:",e),this.disableHighRiskFeatures(),this.showSecurityAlert(),this.notifyAdministrator(e)}disableHighRiskFeatures(){const e=document.getElementById("zone-d-container");e&&(e.style.display="none"),window.kpiAnalyzer&&window.kpiAnalyzer.pause&&window.kpiAnalyzer.pause(),console.log("ğŸ”’ High-risk features disabled")}showSecurityAlert(){const e=document.createElement("div");e.style.cssText="\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            background: #ef4444;\n            color: white;\n            padding: 1rem;\n            border-radius: 8px;\n            z-index: 10000;\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        ",e.innerHTML="\n            <strong>ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ</strong><br>\n            ä¸å¯©ãªæ´»å‹•ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸã€‚ä¸€éƒ¨æ©Ÿèƒ½ã‚’åˆ¶é™ã—ã¦ã„ã¾ã™ã€‚\n        ",document.body.appendChild(e),setTimeout(()=>{e.remove()},1e4)}notifyAdministrator(e){console.log("ğŸ“§ Administrator notification sent:",e)}generateEventId(){return`sec_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}generateSecurityReport(){const e={timestamp:(new Date).toISOString(),securityLevel:this.securityLevel,policies:this.policies,events:this.securityEvents.length,recentThreats:this.securityEvents.filter(e=>Date.now()-new Date(e.timestamp).getTime()<36e5).length,isPrivateBrowsing:this.isPrivateBrowsing||!1,recommendations:this.generateRecommendations()};return console.log("ğŸ›¡ï¸ Security Report:",e),e}generateRecommendations(){const e=[];return document.querySelector('meta[http-equiv="Content-Security-Policy"]')||e.push("CSPå¼·åŒ–ãŒå¿…è¦"),this.securityEvents.length>50&&e.push("ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¤ãƒ™ãƒ³ãƒˆãŒå¤šæ•°ç™ºç”Ÿ"),this.policies.privacy.encryptSensitiveData||e.push("æ©Ÿå¯†ãƒ‡ãƒ¼ã‚¿ã®æš—å·åŒ–ã‚’å¼·åŒ–"),e}}"undefined"!=typeof window&&(window.SecurityManager=SecurityManager,window.securityManager=new SecurityManager),"undefined"!=typeof module&&module.exports&&(module.exports=SecurityManager);