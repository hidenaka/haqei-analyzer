class SecurityIntegrationValidator{constructor(){this.components={},this.validationResults={},this.integrationStatus="initializing",this.init()}async init(){try{console.log("🔒 セキュリティ統合検証システム初期化開始"),await this.discoverSecurityComponents(),await this.validateComponentIntegration(),await this.runComprehensiveSecurityTests(),this.integrationStatus="operational",console.log("✅ セキュリティ統合検証システム初期化完了"),this.startContinuousValidation()}catch(t){console.error("❌ セキュリティ統合初期化エラー:",t),this.integrationStatus="error"}}async discoverSecurityComponents(){console.log("🔍 セキュリティコンポーネント検索中..."),this.components={headerManager:{instance:window.securityHeaders||null,class:window.SecurityHeaderManager||null,status:window.securityHeaders?"active":"missing"},domPurify:{instance:window.domPurifyIntegration||null,class:window.DOMPurifyIntegration||null,library:window.DOMPurify||null,status:window.domPurifyIntegration?"active":"missing"},csrfProtection:{instance:window.csrfProtection||null,class:window.CSRFProtectionSystem||null,status:window.csrfProtection?"active":"missing"},inputValidation:{instance:window.inputValidation||null,class:window.InputValidationSystem||null,status:window.inputValidation?"active":"missing"}};const t=Object.entries(this.components).map(([t,e])=>({component:t,status:e.status,hasInstance:!!e.instance,hasClass:!!e.class}));console.log("📊 セキュリティコンポーネント状態:",t);const e=t.filter(t=>"missing"===t.status);e.length>0&&console.warn("⚠️ 不足セキュリティコンポーネント:",e)}async validateComponentIntegration(){console.log("🔗 セキュリティコンポーネント統合検証中...");const t={headerCspIntegration:await this.testHeaderCSPIntegration(),domPurifyValidation:await this.testDOMPurifyValidation(),csrfTokenFlow:await this.testCSRFTokenFlow(),inputValidationChain:await this.testInputValidationChain(),crossComponentCommunication:await this.testCrossComponentCommunication()};this.validationResults.integration=t;const e=Object.values(t).filter(t=>t.passed).length,n=Object.keys(t).length;console.log(`📈 統合テスト結果: ${e}/${n} 合格`),e<n&&console.warn("⚠️ 一部の統合テストが失敗しました:",t)}async testHeaderCSPIntegration(){try{if(!this.components.headerManager.instance)return{passed:!1,error:"SecurityHeaderManager not found"};const t=document.querySelector('meta[http-equiv="Content-Security-Policy"]');if(!t)return{passed:!1,error:"CSP meta tag not found"};const e=t.content,n=["default-src","script-src","style-src","img-src","font-src","connect-src","object-src","frame-ancestors"],s=n.filter(t=>!e.includes(t));return s.length>0?{passed:!1,error:`Missing CSP directives: ${s.join(", ")}`,policy:e}:{passed:!0,policy:e,directives:n.length}}catch(t){return{passed:!1,error:t.message}}}async testDOMPurifyValidation(){try{const t=this.components.domPurify.instance;if(!t)return{passed:!1,error:"DOMPurifyIntegration not found"};const e=['<script>alert("XSS")<\/script>','<img src="x" onerror="alert(1)">',"javascript:alert(1)",'<iframe src="javascript:alert(1)"></iframe>','<object data="javascript:alert(1)"></object>'],n=e.map(e=>{const n=t.sanitizeHTML(e),s=!n.includes("<script>")&&!n.includes("javascript:")&&!n.includes("onerror=");return{payload:e.substring(0,50),sanitized:n.substring(0,50),safe:s}}),s=n.every(t=>t.safe);return{passed:s,testedPayloads:e.length,results:n,error:s?null:"Some XSS payloads were not properly sanitized"}}catch(t){return{passed:!1,error:t.message}}}async testCSRFTokenFlow(){try{const t=this.components.csrfProtection.instance;if(!t)return{passed:!1,error:"CSRFProtectionSystem not found"};const e=document.querySelector('meta[name="csrf-token"]');if(!e||!e.content)return{passed:!1,error:"CSRF token meta tag not found or empty"};const n=t.getCurrentToken();if(!n||n!==e.content)return{passed:!1,error:"CSRF token mismatch between meta tag and system",metaToken:e.content.substring(0,10)+"...",systemToken:n?n.substring(0,10)+"...":"null"};const s=t.getProtectionStats();return{passed:!0,tokenLength:n.length,stats:s,protectedForms:s.protectedForms}}catch(t){return{passed:!1,error:t.message}}}async testInputValidationChain(){try{const t=this.components.inputValidation.instance;if(!t)return{passed:!1,error:"InputValidationSystem not found"};const e=[{input:'<script>alert("XSS")<\/script>',type:"text"},{input:"'; DROP TABLE users; --",type:"text"},{input:"../../../etc/passwd",type:"text"},{input:"javascript:alert(1)",type:"text"},{input:"a".repeat(10001),type:"text"}],n=e.map(({input:e,type:n})=>{const s={value:e,dataset:{validationType:n}},o=t.validateInput(s);return{input:e.substring(0,50),type:n,valid:o,shouldBeInvalid:!0,testPassed:!o}}),s=n.every(t=>t.testPassed);return{passed:s,testedInputs:e.length,results:n,error:s?null:"Some malicious inputs were not properly rejected"}}catch(t){return{passed:!1,error:t.message}}}async testCrossComponentCommunication(){try{const t=[];if(this.components.domPurify.instance&&this.components.inputValidation.instance){const e='<script>alert("test")<\/script>',n=this.components.domPurify.instance.sanitizeHTML(e),s=this.components.inputValidation.instance.validateInput({value:n,dataset:{validationType:"text"}});t.push({name:"DOMPurify-InputValidation Chain",passed:!n.includes("<script>")&&s,details:{original:e,sanitized:n,validated:s}})}if(this.components.csrfProtection.instance&&this.components.inputValidation.instance){const e=this.components.csrfProtection.instance.getCurrentToken(),n=this.components.inputValidation.instance.validateInput({value:e,dataset:{validationType:"text"}});t.push({name:"CSRF-InputValidation Token Check",passed:!!e&&n,details:{hasToken:!!e,tokenValid:n}})}const e=t.every(t=>t.passed);return{passed:e,totalTests:t.length,results:t,error:e?null:"Some cross-component communication tests failed"}}catch(t){return{passed:!1,error:t.message}}}async runComprehensiveSecurityTests(){console.log("🧪 包括的セキュリティテスト実行中...");const t={xssProtection:await this.testXSSProtection(),csrfProtection:await this.testCSRFProtection(),inputSanitization:await this.testInputSanitization(),headerSecurity:await this.testHeaderSecurity(),performanceImpact:await this.testPerformanceImpact()};this.validationResults.security=t;const e=Object.values(t).filter(t=>t.passed).length,n=Object.keys(t).length;return console.log(`🛡️ セキュリティテスト結果: ${e}/${n} 合格`),t}async testXSSProtection(){const t=['<script>document.body.innerHTML="XSS"<\/script>','<img src="x" onerror="document.body.style.background=\'red\'">','<svg onload="alert(1)">',"javascript:void(0)",'<iframe src="javascript:alert(1)"></iframe>'];let e=0;const n=[];for(const o of t)try{const t=document.createElement("div");if(t.style.display="none",document.body.appendChild(t),this.components.domPurify.instance){const s=this.components.domPurify.instance.sanitizeHTML(o);t.innerHTML=s;const i=null!==t.querySelector("script"),a=t.innerHTML.includes("onerror="),r=t.innerHTML.includes("javascript:"),c=!i&&!a&&!r;c&&e++,n.push({payload:o.substring(0,50),protected:c,sanitized:s.substring(0,100)})}document.body.removeChild(t)}catch(s){n.push({payload:o.substring(0,50),protected:!1,error:s.message})}return{passed:e===t.length,protectedCount:e,totalCount:t.length,protectionRate:Math.round(e/t.length*100),results:n}}async testCSRFProtection(){try{if(!this.components.csrfProtection.instance)return{passed:!1,error:"CSRF protection not available"};const t=this.components.csrfProtection.instance,e=t.getCurrentToken(),n=t.getCurrentToken(),s=!!e,o=e===n,i=t.getProtectionStats();return{passed:s&&o&&"Active"===i.currentToken,hasToken:s,tokensConsistent:o,stats:i}}catch(t){return{passed:!1,error:t.message}}}async testInputSanitization(){const t=[{input:'<script>alert("test")<\/script>',expectEmpty:!0},{input:'< img src="x" onerror="alert(1)">',expectSanitized:!0},{input:"Normal text input",expectUnchanged:!0},{input:"Text with <b>bold</b> tags",expectSanitized:!0},{input:"",expectEmpty:!0}];let e=0;const n=[];for(const s of t)if(this.components.domPurify.instance){const t=this.components.domPurify.instance.sanitizeHTML(s.input);let o=!1;s.expectEmpty?o=""===t||t===s.input:s.expectUnchanged?o=t===s.input:s.expectSanitized&&(o=t!==s.input&&!t.includes("<script>")),o&&e++,n.push({input:s.input,sanitized:t,passed:o,expectation:Object.keys(s).find(t=>t.startsWith("expect"))})}return{passed:e===t.length,passedTests:e,totalTests:t.length,results:n}}async testHeaderSecurity(){const t=["X-Content-Type-Options","X-Frame-Options","X-XSS-Protection","Referrer-Policy"],e=t.map(t=>{const e=document.querySelector(`meta[http-equiv="${t}"]`);return{header:t,present:!!e,value:e?e.content:null}}),n=e.filter(t=>t.present).length;return{passed:n===t.length,presentHeaders:n,totalHeaders:t.length,results:e}}async testPerformanceImpact(){const t=performance.now(),e=[];if(this.components.domPurify.instance){const t=performance.now();this.components.domPurify.instance.sanitizeHTML("<p>Test content</p>");const n=performance.now()-t;e.push({operation:"DOMPurify",time:n})}if(this.components.inputValidation.instance){const t=performance.now();this.components.inputValidation.instance.validateInput({value:"test input",dataset:{validationType:"text"}});const n=performance.now()-t;e.push({operation:"InputValidation",time:n})}const n=performance.now()-t,s=e.length>0?e.reduce((t,e)=>t+e.time,0)/e.length:0;return{passed:n<100,totalTime:Math.round(100*n)/100,averageOperationTime:Math.round(100*s)/100,benchmarks:e,performanceGrade:n<50?"Excellent":n<100?"Good":"Poor"}}startContinuousValidation(){setInterval(()=>{this.runQuickSecurityCheck()},3e5),document.addEventListener("visibilitychange",()=>{document.hidden||this.runQuickSecurityCheck()}),console.log("⏰ 継続的セキュリティ検証開始")}async runQuickSecurityCheck(){try{const t={componentsActive:this.checkComponentsActive(),csrfTokenValid:this.checkCSRFTokenValid(),headersIntact:this.checkSecurityHeaders()};return Object.values(t).every(t=>t.passed)||(console.warn("⚠️ クイックセキュリティチェック失敗:",t),this.handleSecurityDegradation(t)),t}catch(t){console.error("❌ クイックセキュリティチェックエラー:",t)}}checkComponentsActive(){const t=Object.entries(this.components).filter(([t,e])=>e.instance&&"active"===e.status).length;return{passed:t>=3,activeComponents:t,totalComponents:Object.keys(this.components).length}}checkCSRFTokenValid(){try{const t=document.querySelector('meta[name="csrf-token"]');return{passed:t&&t.content&&t.content.length>10,hasMetaTag:!!t,tokenLength:t?t.content.length:0}}catch(t){return{passed:!1,error:t.message}}}checkSecurityHeaders(){const t=document.querySelector('meta[http-equiv="Content-Security-Policy"]'),e=document.querySelector('meta[http-equiv="X-Frame-Options"]');return{passed:!!t&&!!e,hasCSP:!!t,hasXFrameOptions:!!e}}handleSecurityDegradation(t){console.error("🚨 セキュリティ劣化検出:",t);const e={timestamp:(new Date).toISOString(),failedTests:t,currentComponents:this.components,integrationStatus:this.integrationStatus};window.SecurityLogger&&window.SecurityLogger.logSecurityDegradation(e),this.attemptSecurityRecovery()}async attemptSecurityRecovery(){console.log("🔧 セキュリティ自動復旧試行中...");try{await this.discoverSecurityComponents(),this.components.csrfProtection.instance&&this.components.csrfProtection.instance.rotateToken(),console.log("✅ セキュリティ復旧完了")}catch(t){console.error("❌ セキュリティ復旧失敗:",t)}}generateSecurityReport(){return{timestamp:(new Date).toISOString(),integrationStatus:this.integrationStatus,components:Object.entries(this.components).map(([t,e])=>({name:t,status:e.status,available:!!e.instance})),validationResults:this.validationResults,summary:{totalComponents:Object.keys(this.components).length,activeComponents:Object.values(this.components).filter(t=>"active"===t.status).length,integrationTestsPassed:this.validationResults.integration?Object.values(this.validationResults.integration).filter(t=>t.passed).length:0,securityTestsPassed:this.validationResults.security?Object.values(this.validationResults.security).filter(t=>t.passed).length:0}}}debug(){console.group("🔒 Security Integration Debug Info"),console.log("Integration Status:",this.integrationStatus),console.log("Components:",this.components),console.log("Validation Results:",this.validationResults),console.log("Security Report:",this.generateSecurityReport()),console.groupEnd()}}"undefined"!=typeof window&&(window.SecurityIntegrationValidator=SecurityIntegrationValidator,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",async()=>{window.securityValidator=new SecurityIntegrationValidator}):window.securityValidator=new SecurityIntegrationValidator),"undefined"!=typeof module&&module.exports&&(module.exports=SecurityIntegrationValidator),console.log("🛡️ SecurityIntegrationValidator.js 読み込み完了 - 包括的セキュリティ検証");