class DOMPurifyIntegration{constructor(){this.isInitialized=!1,this.config=this.getSecurityConfig(),this.initDOMPurify()}getSecurityConfig(){return{ALLOWED_TAGS:["b","i","em","strong","span","div","p","br","ul","ol","li","h1","h2","h3","h4","h5","h6"],ALLOWED_ATTR:["class","id","data-question-id","data-answer-id","data-hexagram-id","style"],ALLOWED_STYLE_PROPS:["color","background-color","font-size","font-weight","text-align","margin","padding","border"],ALLOWED_URI_REGEXP:/^(?:(?:https?|ftp|mailto):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,FORBID_TAGS:["script","object","embed","form","input","textarea","select","button","iframe","frame","frameset","meta","link","style","base","title"],FORBID_ATTR:["onclick","onload","onerror","onmouseover","onmouseout","onfocus","onblur","onchange","onsubmit","href","src"]}}async initDOMPurify(){try{"undefined"==typeof DOMPurify&&await this.loadDOMPurifyLibrary(),this.setupSecurityHooks(),this.isInitialized=!0,console.log("âœ… DOMPurify ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†")}catch(t){console.error("âŒ DOMPurifyåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:",t),this.isInitialized=!1}}async loadDOMPurifyLibrary(){return new Promise((t,e)=>{const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js",i.integrity="sha384-69eb1h/3FLKz1j3ChgOC6gH3+k0KvBfH7NrR+mOlKCl5vPnWRnNjB/LwEXxfKz0y",i.crossOrigin="anonymous",i.onload=()=>{"undefined"!=typeof DOMPurify?t():e(new Error("DOMPurify failed to load"))},i.onerror=()=>e(new Error("Failed to load DOMPurify script")),document.head.appendChild(i)})}setupSecurityHooks(){"undefined"!=typeof DOMPurify&&(DOMPurify.addHook("beforeSanitizeElements",(t,e)=>{if("script"===e.tagName)return this.logSecurityViolation("SCRIPT_TAG_DETECTED",t),!1;const i=["onclick","onload","onerror","href","src"];for(const r of i)t.hasAttribute&&t.hasAttribute(r)&&(this.logSecurityViolation("DANGEROUS_ATTRIBUTE_DETECTED",t,r),t.removeAttribute(r))}),DOMPurify.addHook("beforeSanitizeAttributes",t=>{if(t.hasAttributes()){Array.from(t.attributes).forEach(t=>{t.name.startsWith("data-")&&(t.value=this.sanitizeDataAttribute(t.value))})}}),console.log("ğŸ”’ DOMPurify ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ•ãƒƒã‚¯è¨­å®šå®Œäº†"))}sanitizeHTML(t,e={}){if(!this.isInitialized)return console.warn("âš ï¸ DOMPurifyæœªåˆæœŸåŒ– - ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†"),this.fallbackSanitize(t);try{const i={...this.config,...e,KEEP_CONTENT:!1,RETURN_DOM:!1,RETURN_DOM_FRAGMENT:!1,SANITIZE_DOM:!0},r=DOMPurify.sanitize(t,i);return this.validateSanitizedContent(r),r}catch(i){return console.error("âŒ HTML ã‚µãƒ‹ã‚¿ã‚¤ã‚¼ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼:",i),this.logSecurityViolation("SANITIZATION_ERROR",null,i.message),this.fallbackSanitize(t)}}safeSetTextContent(t,e){if(!t||"string"!=typeof e)return console.warn("âš ï¸ safeSetTextContent: ç„¡åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿"),!1;try{return t.textContent=e,!0}catch(i){return console.error("âŒ ãƒ†ã‚­ã‚¹ãƒˆæŒ¿å…¥ã‚¨ãƒ©ãƒ¼:",i),!1}}safeSetInnerHTML(t,e){if(!t||"string"!=typeof e)return console.warn("âš ï¸ safeSetInnerHTML: ç„¡åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿"),!1;try{const i=this.sanitizeHTML(e);return t.innerHTML=i,this.validateInsertedContent(t),!0}catch(i){return console.error("âŒ HTMLæŒ¿å…¥ã‚¨ãƒ©ãƒ¼:",i),!1}}safeSetAttribute(t,e,i){if(!t||"string"!=typeof e||"string"!=typeof i)return console.warn("âš ï¸ safeSetAttribute: ç„¡åŠ¹ãªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿"),!1;if(!this.config.ALLOWED_ATTR.includes(e))return console.warn(`âš ï¸ è¨±å¯ã•ã‚Œã¦ã„ãªã„å±æ€§: ${e}`),!1;try{const r=this.sanitizeAttributeValue(e,i);return t.setAttribute(e,r),!0}catch(r){return console.error("âŒ å±æ€§è¨­å®šã‚¨ãƒ©ãƒ¼:",r),!1}}sanitizeDataAttribute(t){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/&/g,"&amp;")}sanitizeAttributeValue(t,e){switch(t){case"class":return e.replace(/[^a-zA-Z0-9_-\s]/g,"");case"id":return e.replace(/[^a-zA-Z0-9_-]/g,"");case"style":return this.sanitizeStyleAttribute(e);default:return this.sanitizeDataAttribute(e)}}sanitizeStyleAttribute(t){return t.replace(/javascript:/gi,"").replace(/expression\s*\(/gi,"").replace.replace(/behavior\s*:/gi,"").split(";").filter(t=>{const[e]=t.split(":").map(t=>t.trim());return this.config.ALLOWED_STYLE_PROPS.includes(e)}).join("; ")}fallbackSanitize(t){return"string"!=typeof t?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/\//g,"&#x2F;")}validateSanitizedContent(t){const e=[/<script/i,/javascript:/i,/on\w+\s*=/i,/<iframe/i,/<object/i,/<embed/i];for(const i of e)if(i.test(t))throw this.logSecurityViolation("DANGEROUS_CONTENT_DETECTED",null,t),new Error("å±é™ºãªã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ")}validateInsertedContent(t){const e=t.querySelectorAll("script, object, embed, iframe");e.length>0&&(console.error("âŒ å±é™ºãªã‚¿ã‚°ãŒæŒ¿å…¥ã•ã‚Œã¾ã—ãŸ"),e.forEach(t=>t.remove()));t.querySelectorAll('[onclick], [onload], [onerror], [href^="javascript:"]').forEach(t=>{["onclick","onload","onerror"].forEach(e=>{t.hasAttribute(e)&&t.removeAttribute(e)}),t.hasAttribute("href")&&t.getAttribute("href").startsWith("javascript:")&&t.removeAttribute("href")})}logSecurityViolation(t,e,i){const r={timestamp:(new Date).toISOString(),type:t,url:window.location.href,userAgent:navigator.userAgent,element:e?e.outerHTML:null,details:i};console.warn("ğŸš¨ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é•åæ¤œå‡º:",r),window.SecurityLogger&&window.SecurityLogger.logViolation(r)}getSecurityStats(){return{isInitialized:this.isInitialized,libraryLoaded:"undefined"!=typeof DOMPurify,configuredRules:Object.keys(this.config).length,allowedTags:this.config.ALLOWED_TAGS.length,allowedAttributes:this.config.ALLOWED_ATTR.length,forbiddenTags:this.config.FORBID_TAGS.length,forbiddenAttributes:this.config.FORBID_ATTR.length}}}"undefined"!=typeof window&&(window.DOMPurifyIntegration=DOMPurifyIntegration,window.domPurifyIntegration=new DOMPurifyIntegration),"undefined"!=typeof module&&module.exports&&(module.exports=DOMPurifyIntegration),console.log("ğŸ”’ DOMPurifyIntegration.js èª­ã¿è¾¼ã¿å®Œäº† - ä¼æ¥­ãƒ¬ãƒ™ãƒ«XSSä¿è­·");