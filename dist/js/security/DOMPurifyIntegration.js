class DOMPurifyIntegration{constructor(){this.isInitialized=!1,this.config=this.getSecurityConfig(),this.initDOMPurify()}getSecurityConfig(){return{ALLOWED_TAGS:["b","i","em","strong","span","div","p","br","ul","ol","li","h1","h2","h3","h4","h5","h6"],ALLOWED_ATTR:["class","id","data-question-id","data-answer-id","data-hexagram-id","style"],ALLOWED_STYLE_PROPS:["color","background-color","font-size","font-weight","text-align","margin","padding","border"],ALLOWED_URI_REGEXP:/^(?:(?:https?|ftp|mailto):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,FORBID_TAGS:["script","object","embed","form","input","textarea","select","button","iframe","frame","frameset","meta","link","style","base","title"],FORBID_ATTR:["onclick","onload","onerror","onmouseover","onmouseout","onfocus","onblur","onchange","onsubmit","href","src"]}}async initDOMPurify(){try{"undefined"==typeof DOMPurify&&await this.loadDOMPurifyLibrary(),this.setupSecurityHooks(),this.isInitialized=!0,console.log("✅ DOMPurify セキュリティシステム初期化完了")}catch(t){console.error("❌ DOMPurify初期化エラー:",t),this.isInitialized=!1}}async loadDOMPurifyLibrary(){return new Promise((t,e)=>{const i=document.createElement("script");i.src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js",i.integrity="sha384-69eb1h/3FLKz1j3ChgOC6gH3+k0KvBfH7NrR+mOlKCl5vPnWRnNjB/LwEXxfKz0y",i.crossOrigin="anonymous",i.onload=()=>{"undefined"!=typeof DOMPurify?t():e(new Error("DOMPurify failed to load"))},i.onerror=()=>e(new Error("Failed to load DOMPurify script")),document.head.appendChild(i)})}setupSecurityHooks(){"undefined"!=typeof DOMPurify&&(DOMPurify.addHook("beforeSanitizeElements",(t,e)=>{if("script"===e.tagName)return this.logSecurityViolation("SCRIPT_TAG_DETECTED",t),!1;const i=["onclick","onload","onerror","href","src"];for(const r of i)t.hasAttribute&&t.hasAttribute(r)&&(this.logSecurityViolation("DANGEROUS_ATTRIBUTE_DETECTED",t,r),t.removeAttribute(r))}),DOMPurify.addHook("beforeSanitizeAttributes",t=>{if(t.hasAttributes()){Array.from(t.attributes).forEach(t=>{t.name.startsWith("data-")&&(t.value=this.sanitizeDataAttribute(t.value))})}}),console.log("🔒 DOMPurify セキュリティフック設定完了"))}sanitizeHTML(t,e={}){if(!this.isInitialized)return console.warn("⚠️ DOMPurify未初期化 - フォールバック処理"),this.fallbackSanitize(t);try{const i={...this.config,...e,KEEP_CONTENT:!1,RETURN_DOM:!1,RETURN_DOM_FRAGMENT:!1,SANITIZE_DOM:!0},r=DOMPurify.sanitize(t,i);return this.validateSanitizedContent(r),r}catch(i){return console.error("❌ HTML サニタイゼーションエラー:",i),this.logSecurityViolation("SANITIZATION_ERROR",null,i.message),this.fallbackSanitize(t)}}safeSetTextContent(t,e){if(!t||"string"!=typeof e)return console.warn("⚠️ safeSetTextContent: 無効なパラメータ"),!1;try{return t.textContent=e,!0}catch(i){return console.error("❌ テキスト挿入エラー:",i),!1}}safeSetInnerHTML(t,e){if(!t||"string"!=typeof e)return console.warn("⚠️ safeSetInnerHTML: 無効なパラメータ"),!1;try{const i=this.sanitizeHTML(e);return t.innerHTML=i,this.validateInsertedContent(t),!0}catch(i){return console.error("❌ HTML挿入エラー:",i),!1}}safeSetAttribute(t,e,i){if(!t||"string"!=typeof e||"string"!=typeof i)return console.warn("⚠️ safeSetAttribute: 無効なパラメータ"),!1;if(!this.config.ALLOWED_ATTR.includes(e))return console.warn(`⚠️ 許可されていない属性: ${e}`),!1;try{const r=this.sanitizeAttributeValue(e,i);return t.setAttribute(e,r),!0}catch(r){return console.error("❌ 属性設定エラー:",r),!1}}sanitizeDataAttribute(t){return t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/&/g,"&amp;")}sanitizeAttributeValue(t,e){switch(t){case"class":return e.replace(/[^a-zA-Z0-9_-\s]/g,"");case"id":return e.replace(/[^a-zA-Z0-9_-]/g,"");case"style":return this.sanitizeStyleAttribute(e);default:return this.sanitizeDataAttribute(e)}}sanitizeStyleAttribute(t){return t.replace(/javascript:/gi,"").replace(/expression\s*\(/gi,"").replace.replace(/behavior\s*:/gi,"").split(";").filter(t=>{const[e]=t.split(":").map(t=>t.trim());return this.config.ALLOWED_STYLE_PROPS.includes(e)}).join("; ")}fallbackSanitize(t){return"string"!=typeof t?"":t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/\//g,"&#x2F;")}validateSanitizedContent(t){const e=[/<script/i,/javascript:/i,/on\w+\s*=/i,/<iframe/i,/<object/i,/<embed/i];for(const i of e)if(i.test(t))throw this.logSecurityViolation("DANGEROUS_CONTENT_DETECTED",null,t),new Error("危険なコンテンツが検出されました")}validateInsertedContent(t){const e=t.querySelectorAll("script, object, embed, iframe");e.length>0&&(console.error("❌ 危険なタグが挿入されました"),e.forEach(t=>t.remove()));t.querySelectorAll('[onclick], [onload], [onerror], [href^="javascript:"]').forEach(t=>{["onclick","onload","onerror"].forEach(e=>{t.hasAttribute(e)&&t.removeAttribute(e)}),t.hasAttribute("href")&&t.getAttribute("href").startsWith("javascript:")&&t.removeAttribute("href")})}logSecurityViolation(t,e,i){const r={timestamp:(new Date).toISOString(),type:t,url:window.location.href,userAgent:navigator.userAgent,element:e?e.outerHTML:null,details:i};console.warn("🚨 セキュリティ違反検出:",r),window.SecurityLogger&&window.SecurityLogger.logViolation(r)}getSecurityStats(){return{isInitialized:this.isInitialized,libraryLoaded:"undefined"!=typeof DOMPurify,configuredRules:Object.keys(this.config).length,allowedTags:this.config.ALLOWED_TAGS.length,allowedAttributes:this.config.ALLOWED_ATTR.length,forbiddenTags:this.config.FORBID_TAGS.length,forbiddenAttributes:this.config.FORBID_ATTR.length}}}"undefined"!=typeof window&&(window.DOMPurifyIntegration=DOMPurifyIntegration,window.domPurifyIntegration=new DOMPurifyIntegration),"undefined"!=typeof module&&module.exports&&(module.exports=DOMPurifyIntegration),console.log("🔒 DOMPurifyIntegration.js 読み込み完了 - 企業レベルXSS保護");