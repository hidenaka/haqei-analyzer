class PerformanceManager{constructor(){this.metrics={loadTime:0,renderTime:0,memoryUsage:0,scriptLoadTime:0},this.optimizations={lazyLoading:!0,codesplitting:!0,imageOptimization:!0,cacheManagement:!0},this.performanceTargets={totalLoadTime:1500,firstPaint:800,interactive:1200,memoryLimit:50},this.init()}init(){console.log("🚀 Performance Manager initializing..."),this.startWebVitalsMonitoring(),this.optimizeResources(),this.startMemoryMonitoring(),this.implementLazyLoading(),console.log("✅ Performance Manager initialized")}startWebVitalsMonitoring(){new PerformanceObserver(e=>{for(const t of e.getEntries())console.log("📊 LCP:",Math.round(t.startTime),"ms"),this.metrics.renderTime=t.startTime,t.startTime>this.performanceTargets.firstPaint&&this.optimizeRendering()}).observe({entryTypes:["largest-contentful-paint"]}),new PerformanceObserver(e=>{for(const t of e.getEntries())console.log("⚡ FID:",Math.round(t.processingStart-t.startTime),"ms")}).observe({entryTypes:["first-input"]}),new PerformanceObserver(e=>{for(const t of e.getEntries())t.hadRecentInput||console.log("📐 CLS:",t.value)}).observe({entryTypes:["layout-shift"]})}optimizeResources(){this.inlineCriticalCSS(),this.preloadFonts(),this.optimizeScriptLoading(),this.optimizeImages()}inlineCriticalCSS(){const e=document.createElement("style");e.textContent="\n            /* Performance Critical CSS - Phase 4 */\n            body { \n                font-display: swap;\n                will-change: auto;\n            }\n            \n            .screen {\n                contain: layout style paint;\n            }\n            \n            .zone-d-integration {\n                content-visibility: auto;\n                contain-intrinsic-size: 0 400px;\n            }\n            \n            /* GPU加速最適化 */\n            .confidence-gauge, .mobile-component {\n                transform: translateZ(0);\n                backface-visibility: hidden;\n            }\n        ",document.head.insertBefore(e,document.head.firstChild)}preloadFonts(){["system-ui","-apple-system","BlinkMacSystemFont"].forEach(e=>{const t=document.createElement("link");t.rel="preconnect",t.href=e,document.head.appendChild(t)})}optimizeScriptLoading(){document.querySelectorAll("script[src]").forEach(e=>{(e.src.includes("zone-d")||e.src.includes("mobile")||e.src.includes("analytics"))&&(e.defer=!0),(e.src.includes("core")||e.src.includes("TripleOS"))&&(e.fetchPriority="high")})}optimizeImages(){document.querySelectorAll("img").forEach(e=>{if(e.loading="lazy",e.decoding="async","IntersectionObserver"in window){const t=new IntersectionObserver(e=>{e.forEach(e=>{if(e.isIntersecting){const n=e.target;n.classList.add("loaded"),t.unobserve(n)}})});t.observe(e)}})}implementLazyLoading(){window.loadZoneDWhenNeeded=()=>new Promise(e=>{window.zoneDIntegrator?e():setTimeout(()=>{console.log("📦 Zone D components loaded lazily"),e()},100)}),window.loadKPIDashboardWhenNeeded=()=>new Promise(e=>{window.KPIDashboard?e():setTimeout(()=>{console.log("📊 KPI Dashboard loaded lazily"),e()},50)})}startMemoryMonitoring(){"memory"in performance&&setInterval(()=>{const e=performance.memory,t=Math.round(e.usedJSHeapSize/1024/1024);this.metrics.memoryUsage=t,t>this.performanceTargets.memoryLimit&&(console.warn("⚠️ Memory usage high:",t,"MB"),this.performGarbageCollection())},1e4)}optimizeRendering(){console.log("🎨 Optimizing rendering..."),requestAnimationFrame(()=>{this.implementVirtualScrolling(),this.optimizeResizeHandlers(),this.applyCSSContainment()})}implementVirtualScrolling(){document.querySelectorAll(".question-list, .result-list").forEach(e=>{e.children.length>10&&(e.style.contain="layout style paint",e.style.contentVisibility="auto")})}optimizeResizeHandlers(){let e;window.addEventListener("resize",()=>{clearTimeout(e),e=setTimeout(()=>{window.mobileOptimizer&&window.mobileOptimizer.handleResize(),this.adjustZoneDLayout()},150)},{passive:!0})}applyCSSContainment(){[".zone-container",".zone-d-integration",".mobile-component",".kpi-dashboard"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.contain="layout style paint"})})}adjustZoneDLayout(){const e=document.querySelector(".zone-d-integration");e&&window.innerWidth<768?e.style.gridTemplateColumns="1fr":e&&(e.style.gridTemplateColumns="1fr 1fr 1fr")}performGarbageCollection(){this.clearUnusedListeners(),this.clearExpiredCache(),window.gc&&window.gc()}clearUnusedListeners(){window.zoneDIntegrator&&window.zoneDIntegrator.cleanup&&window.zoneDIntegrator.cleanup(),window.kpiAnalyzer&&window.kpiAnalyzer.flushRealtimeBuffer&&window.kpiAnalyzer.flushRealtimeBuffer()}clearExpiredCache(){const e=Date.now();Object.keys(localStorage).forEach(t=>{if(t.startsWith("haqei_cache_"))try{const n=JSON.parse(localStorage.getItem(t));n.timestamp&&e-n.timestamp>864e5&&localStorage.removeItem(t)}catch(n){localStorage.removeItem(t)}})}generatePerformanceReport(){const e=performance.getEntriesByType("navigation")[0],t={timestamp:(new Date).toISOString(),loadTime:Math.round(e.loadEventEnd-e.loadEventStart),domContentLoaded:Math.round(e.domContentLoadedEventEnd-e.domContentLoadedEventStart),firstPaint:Math.round(performance.getEntriesByType("paint")[0]?.startTime||0),metrics:this.metrics,targets:this.performanceTargets,optimizations:this.optimizations,score:this.calculatePerformanceScore()};return console.log("📈 Performance Report:",t),t}calculatePerformanceScore(){const e=performance.getEntriesByType("navigation")[0];let t=100;e.loadEventEnd-e.loadEventStart>this.performanceTargets.totalLoadTime&&(t-=30);return(performance.getEntriesByType("paint")[0]?.startTime||0)>this.performanceTargets.firstPaint&&(t-=20),this.metrics.memoryUsage>this.performanceTargets.memoryLimit&&(t-=25),this.metrics.renderTime>this.performanceTargets.firstPaint&&(t-=25),Math.max(0,Math.min(100,t))}}"undefined"!=typeof window&&(window.PerformanceManager=PerformanceManager,"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{window.performanceManager=new PerformanceManager}):window.performanceManager=new PerformanceManager),"undefined"!=typeof module&&module.exports&&(module.exports=PerformanceManager);