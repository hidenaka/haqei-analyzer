class EdgeCaseHandler{constructor(){this.validationRules={scores:{min:0,max:1,sumMin:.95,sumMax:1.05},vectors:{dimensionCount:8,minValue:0,maxValue:1,sumTolerance:.1},hexagram:{minId:1,maxId:64},confidence:{criticalThreshold:.3,warningThreshold:.5}},this.errorLog=[],this.recoveryStrategies=new Map,this.initializeRecoveryStrategies()}validateTripleOSResults(e){const r={isValid:!0,errors:[],warnings:[],corrections:{}},a=this.validateStructure(e);a.isValid||(r.isValid=!1,r.errors.push(...a.errors),e=this.applyStructureCorrections(e,a.corrections));const t=this.validateRanges(e);t.isValid||(r.warnings.push(...t.warnings),e=this.applyRangeCorrections(e,t.corrections));const s=this.validateConsistency(e);s.isValid||(r.warnings.push(...s.warnings),e=this.applyConsistencyCorrections(e,s.corrections));const n=this.detectExtremeValues(e);n.hasExtremes&&(r.warnings.push(...n.warnings),e=this.normalizeExtremeValues(e,n.extremes));const i=this.checkDataCompleteness(e);return i.isComplete||(e=this.fillMissingData(e,i.missing),r.warnings.push(...i.warnings)),{validation:r,correctedResults:e,requiresUserNotification:r.errors.length>0}}validateStructure(e){const r=[],a={};return["engineOS","interfaceOS","safeModeOS"].forEach(t=>{if(e&&e[t]){const s=e[t];s.hexagramId&&s.hexagramName||(r.push(`Incomplete data in ${t}`),a[t]={...s,hexagramId:s.hexagramId||1,hexagramName:s.hexagramName||"乾為天"}),s.baguaEnergies&&"object"==typeof s.baguaEnergies||(r.push(`Invalid baguaEnergies in ${t}`),a[t]={...s,baguaEnergies:this.getDefaultBaguaEnergies()})}else r.push(`Missing required field: ${t}`),a[t]=this.getDefaultOS(t)}),{isValid:0===r.length,errors:r,corrections:a}}validateRanges(e){const r=[],a={};return["engineOS","interfaceOS","safeModeOS"].forEach(t=>{const s=e[t];s&&((s.hexagramId<1||s.hexagramId>64)&&(r.push(`Invalid hexagram ID in ${t}: ${s.hexagramId}`),a[`${t}.hexagramId`]=Math.max(1,Math.min(64,s.hexagramId))),void 0!==s.strength&&(s.strength<0||s.strength>100)&&(r.push(`Invalid strength in ${t}: ${s.strength}`),a[`${t}.strength`]=Math.max(0,Math.min(100,s.strength))),s.baguaEnergies&&Object.entries(s.baguaEnergies).forEach(([e,n])=>{(n<0||n>100)&&(r.push(`Invalid bagua energy ${e} in ${t}: ${n}`),a[`${t}.baguaEnergies`]||(a[`${t}.baguaEnergies`]={...s.baguaEnergies}),a[`${t}.baguaEnergies`][e]=Math.max(0,Math.min(100,n)))}))}),{isValid:0===r.length,warnings:r,corrections:a}}validateConsistency(e){const r=[],a={},t=this.extractScores(e),s=t.engine+t.interface+t.safe;Math.abs(s-1)>this.validationRules.scores.sumTolerance&&(r.push(`Score sum inconsistency: ${s.toFixed(3)}`),a.normalizedScores={engine:t.engine/s,interface:t.interface/s,safe:t.safe/s});const n=[e.engineOS?.hexagramId,e.interfaceOS?.hexagramId,e.safeModeOS?.hexagramId].filter(Boolean);return new Set(n).size<n.length&&(r.push("Duplicate hexagrams detected across OS types"),a.hexagramDiversity=this.ensureHexagramDiversity(e)),["engineOS","interfaceOS","safeModeOS"].forEach(t=>{const s=e[t];if(!s?.baguaEnergies)return;const n=Object.values(s.baguaEnergies),i=n.reduce((e,r)=>e+r,0)/n.length,g=n.reduce((e,r)=>e+Math.pow(r-i,2),0)/n.length;g<1&&(r.push(`Suspicious uniform distribution in ${t}`),a[`${t}.redistributed`]=this.redistributeEnergies(s.baguaEnergies)),g>2e3&&(r.push(`Extreme variance in ${t} energies`),a[`${t}.smoothed`]=this.smoothEnergies(s.baguaEnergies))}),{isValid:0===r.length,warnings:r,corrections:a}}detectExtremeValues(e){const r=[],a=[];return["engineOS","interfaceOS","safeModeOS"].forEach(t=>{const s=e[t];if(!s?.baguaEnergies)return;Object.entries(s.baguaEnergies).forEach(([e,s])=>{s>95&&(r.push({osType:t,bagua:e,value:s,type:"high"}),a.push(`Extremely high value: ${t}.${e} = ${s}`)),s<5&&(r.push({osType:t,bagua:e,value:s,type:"low"}),a.push(`Extremely low value: ${t}.${e} = ${s}`))});const n=Object.values(s.baguaEnergies),i=n.filter(e=>e>80).length,g=n.filter(e=>e<20).length;i>6&&a.push(`Too many high values in ${t}`),g>6&&a.push(`Too many low values in ${t}`)}),{hasExtremes:r.length>0,extremes:r,warnings:a}}checkDataCompleteness(e){const r=[],a=[],t=["乾","震","坎","兌","離","巽","艮","坤"];return["engineOS","interfaceOS","safeModeOS"].forEach(s=>{const n=e[s];if(!n)return r.push({type:s,field:"entire"}),void a.push(`Entire ${s} is missing`);n.hexagramId||r.push({type:s,field:"hexagramId"}),n.hexagramName||r.push({type:s,field:"hexagramName"}),n.baguaEnergies?t.forEach(e=>{e in n.baguaEnergies||(r.push({type:s,field:`baguaEnergies.${e}`}),a.push(`Missing dimension ${e} in ${s}`))}):(r.push({type:s,field:"baguaEnergies"}),a.push(`Missing baguaEnergies in ${s}`))}),{isComplete:0===r.length,missing:r,warnings:a}}applyStructureCorrections(e,r){const a={...e};return Object.entries(r).forEach(([e,r])=>{a[e]=r}),a}applyRangeCorrections(e,r){const a=JSON.parse(JSON.stringify(e));return Object.entries(r).forEach(([e,r])=>{const t=e.split(".");let s=a;for(let a=0;a<t.length-1;a++)s=s[t[a]];s[t[t.length-1]]=r}),a}applyConsistencyCorrections(e,r){let a={...e};if(r.normalizedScores){const e=r.normalizedScores;a.engineOS&&(a.engineOS.normalizedScore=e.engine),a.interfaceOS&&(a.interfaceOS.normalizedScore=e.interface),a.safeModeOS&&(a.safeModeOS.normalizedScore=e.safe)}return r.hexagramDiversity&&(a=r.hexagramDiversity),["engineOS","interfaceOS","safeModeOS"].forEach(e=>{r[`${e}.redistributed`]&&(a[e].baguaEnergies=r[`${e}.redistributed`]),r[`${e}.smoothed`]&&(a[e].baguaEnergies=r[`${e}.smoothed`])}),a}normalizeExtremeValues(e,r){const a=JSON.parse(JSON.stringify(e));return r.forEach(e=>{const r=a[e.osType];r?.baguaEnergies&&("high"===e.type?r.baguaEnergies[e.bagua]=Math.min(90,e.value):"low"===e.type&&(r.baguaEnergies[e.bagua]=Math.max(10,e.value)))}),["engineOS","interfaceOS","safeModeOS"].forEach(e=>{const r=a[e];if(!r?.baguaEnergies)return;const t=Object.values(r.baguaEnergies).reduce((e,r)=>e+r,0);0!==t&&Math.abs(t-800)>10&&Object.keys(r.baguaEnergies).forEach(e=>{r.baguaEnergies[e]=r.baguaEnergies[e]/t*800})}),a}fillMissingData(e,r){const a=JSON.parse(JSON.stringify(e));return r.forEach(e=>{if("entire"===e.field)a[e.type]=this.getDefaultOS(e.type);else if("hexagramId"===e.field)a[e.type].hexagramId=this.getDefaultHexagramId(e.type);else if("hexagramName"===e.field)a[e.type].hexagramName=this.getHexagramName(a[e.type].hexagramId);else if("baguaEnergies"===e.field)a[e.type].baguaEnergies=this.getDefaultBaguaEnergies();else if(e.field.startsWith("baguaEnergies.")){const r=e.field.split(".")[1];a[e.type].baguaEnergies||(a[e.type].baguaEnergies={}),a[e.type].baguaEnergies[r]=50}}),a}initializeRecoveryStrategies(){this.recoveryStrategies.set("missingOS",e=>this.getDefaultOS(e)),this.recoveryStrategies.set("calculationError",e=>(this.logError("Calculation error",e),{synergy:.5,tension:.3,confidence:.4})),this.recoveryStrategies.set("renderError",e=>(this.logError("Render error",e),this.getFallbackDisplay()))}getDefaultOS(e){const r={engineOS:{hexagramId:1,hexagramName:"乾為天",strength:33,baguaEnergies:this.getDefaultBaguaEnergies()},interfaceOS:{hexagramId:2,hexagramName:"坤為地",strength:33,baguaEnergies:this.getDefaultBaguaEnergies()},safeModeOS:{hexagramId:52,hexagramName:"艮為山",strength:34,baguaEnergies:this.getDefaultBaguaEnergies()}};return r[e]||r.engineOS}getDefaultBaguaEnergies(){return{"乾":50,"震":50,"坎":50,"兌":50,"離":50,"巽":50,"艮":50,"坤":50}}ensureHexagramDiversity(e){const r={...e},a=new Set;return["engineOS","interfaceOS","safeModeOS"].forEach((e,t)=>{const s=r[e];if(s){if(a.has(s.hexagramId)){let e=s.hexagramId;for(;a.has(e);)e=e%64+1;s.hexagramId=e,s.hexagramName=this.getHexagramName(e)}a.add(s.hexagramId)}}),r}redistributeEnergies(e){const r=Object.keys(e),a={};return r.forEach((e,t)=>{const s=100/r.length,n=20*(Math.random()-.5);a[e]=Math.max(10,Math.min(90,s+n))}),a}smoothEnergies(e){const r=Object.values(e),a=r.reduce((e,r)=>e+r,0)/r.length,t={};return Object.entries(e).forEach(([e,r])=>{const s=r-a;t[e]=r-.5*s}),t}extractScores(e){const getScore=e=>e?void 0!==e.normalizedScore?e.normalizedScore:void 0!==e.strength?e.strength/100:.33:.33;return{engine:getScore(e.engineOS),interface:getScore(e.interfaceOS),safe:getScore(e.safeModeOS)}}getDefaultHexagramId(e){return{engineOS:1,interfaceOS:2,safeModeOS:52}[e]||1}getHexagramName(e){return{1:"乾為天",2:"坤為地",52:"艮為山"}[e]||`卦${e}`}getFallbackDisplay(){return'\n            <div class="error-fallback">\n                <h3>一時的な表示エラー</h3>\n                <p>データの表示中にエラーが発生しました。</p>\n                <p>ページを更新するか、もう一度お試しください。</p>\n            </div>\n        '}logError(e,r){const a={timestamp:(new Date).toISOString(),context:e,error:r.message||r,stack:r.stack};this.errorLog.push(a),"undefined"!=typeof console&&console.error(`[EdgeCaseHandler] ${e}:`,r),this.errorLog.length>100&&(this.errorLog=this.errorLog.slice(-50))}generateErrorReport(){return{totalErrors:this.errorLog.length,recentErrors:this.errorLog.slice(-10),errorsByContext:this.groupErrorsByContext(),timestamp:(new Date).toISOString()}}groupErrorsByContext(){const e={};return this.errorLog.forEach(r=>{e[r.context]||(e[r.context]=0),e[r.context]++}),e}}"undefined"!=typeof module&&module.exports&&(module.exports=EdgeCaseHandler);