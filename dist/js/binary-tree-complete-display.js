window.BinaryTreeCompleteDisplay={display:function(t){console.log("🌳 Binary Tree Complete Display v2.1 開始"),t||(t=this.generateDefaultResultWithH384Data()),this.loadChartJS(()=>{this.renderCompleteAnalysis(t)})},generateDefaultResultWithH384Data:function(){let t=null;window.H384_DATA&&window.H384_DATA.length>0&&(t=window.H384_DATA.find(t=>248===t.通し番号)||window.H384_DATA[247]);const n=t?{"継続強化":this.calculateProbabilityFromLine(t,"continue_strong"),"継続調整":this.calculateProbabilityFromLine(t,"continue_transform"),"転換統合":this.calculateProbabilityFromLine(t,"transform_integrate"),"転換段階":this.calculateProbabilityFromLine(t,"transform_step")}:{"継続強化":.27,"継続調整":.24,"転換統合":.27,"転換段階":.22},e=[{pathIndex:1,title:"継続強化・突破型",probability:.55*n.継続強化,route:["開始","継続選択","強化方向"],description:"現在の強みを最大限に活かす道"},{pathIndex:2,title:"継続強化・安定型",probability:.45*n.継続強化,route:["開始","継続選択","安定方向"],description:"着実な成長を重視する道"},{pathIndex:3,title:"継続調整・革新型",probability:.54*n.継続調整,route:["開始","継続選択","革新方向"],description:"既存の枠組みを革新する道"},{pathIndex:4,title:"継続調整・改善型",probability:.46*n.継続調整,route:["開始","継続選択","改善方向"],description:"段階的な改善を重ねる道"},{pathIndex:5,title:"転換統合・融合型",probability:.52*n.転換統合,route:["開始","転換選択","融合方向"],description:"新旧の要素を統合する道"},{pathIndex:6,title:"転換統合・創造型",probability:.48*n.転換統合,route:["開始","転換選択","創造方向"],description:"全く新しい価値を創造する道"},{pathIndex:7,title:"転換段階・飛躍型",probability:.55*n.転換段階,route:["開始","転換選択","飛躍方向"],description:"大きな飛躍を目指す道"},{pathIndex:8,title:"転換段階・探索型",probability:.45*n.転換段階,route:["開始","転換選択","探索方向"],description:"新たな可能性を探索する道"}],i=e.reduce((t,n)=>t+n.probability,0);return e.forEach(t=>t.probability=t.probability/i),{currentLine:248,lineData:t,finalEightPaths:e,branchingData:this.generateBranchingData(e)}},calculateProbabilityFromLine:function(t,n){if(!t)return.25;const e=t.位置||3,i="陽"===t.陰陽;switch(n){case"continue_strong":return i?.3+.02*e:.2+.01*e;case"continue_transform":return i?.25-.01*e:.25+.01*e;case"transform_integrate":return i?.2+.02*e:.3+.01*e;case"transform_step":return i?.2+.01*e:.25-.01*e;default:return.25}},generateBranchingData:function(t){const n={x:0,y:.5,label:"現在"},e=[{x:1,y:.3,probability:t.slice(0,4).reduce((t,n)=>t+n.probability,0),label:"継続路線",parent:0},{x:1,y:.7,probability:t.slice(4,8).reduce((t,n)=>t+n.probability,0),label:"転換路線",parent:0}],i=[{x:2,y:.15,probability:t[0].probability+t[1].probability,label:"継続強化",parent:0},{x:2,y:.35,probability:t[2].probability+t[3].probability,label:"継続調整",parent:0},{x:2,y:.55,probability:t[4].probability+t[5].probability,label:"転換統合",parent:1},{x:2,y:.75,probability:t[6].probability+t[7].probability,label:"転換段階",parent:1}],a=t.map((t,n)=>({x:3,y:.05+.125*n,probability:t.probability,label:`パス${n+1}`,title:t.title,parent:Math.floor(n/2)}));return{phase1:n,phase2:e,phase3:i,phase4:a,allPhases:[n,...e,...i,...a]}},loadChartJS:function(t){if(window.Chart)return void t();const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js",n.onload=t,document.head.appendChild(n)},renderCompleteAnalysis:function(t){const n=document.querySelector(".main-content")||document.querySelector("#results-container")||document.querySelector("#binary-tree-results")||document.body;n?(n.innerHTML=this.generateHTML(t),setTimeout(()=>{this.renderBranchingChart(t)},100),this.setupDownload(t)):console.error("No container found for results")},generateHTML:function(t){const n=t.finalEightPaths.slice(4,8).reduce((t,n)=>t+n.probability,0),e=t.finalEightPaths.slice(0,4).reduce((t,n)=>t+n.probability,0),i=t.finalEightPaths.reduce((t,n)=>n.probability>t.probability?n:t);return`\n            <div class="binary-tree-complete-analysis" style="padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; color: white; margin: 20px 0;">\n                \n                \x3c!-- タイトル --\x3e\n                <div style="text-align: center; margin-bottom: 40px;">\n                    <h2 style="font-size: 2em; margin-bottom: 10px; color: white;">🌳 Binary Tree 未来分岐分析</h2>\n                    <p style="font-size: 1.2em; opacity: 0.95;">8つの未来パスから統合的洞察を生成します</p>\n                    ${t.lineData?`<p style="font-size: 0.9em; opacity: 0.8;">基準: ${t.lineData.卦名} ${t.lineData.爻名}</p>`:""}\n                </div>\n\n                \x3c!-- 分岐型折れ線グラフ --\x3e\n                <div style="background: white; border-radius: 16px; padding: 30px; margin-bottom: 30px;">\n                    <h3 style="color: #4338ca; margin-bottom: 20px;">📈 未来分岐パスの可視化</h3>\n                    <div style="height: 400px; position: relative;">\n                        <canvas id="branchingChart"></canvas>\n                    </div>\n                    <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">\n                        <p style="color: #4b5563; margin: 0; font-size: 0.9em;">\n                            <strong>説明:</strong> 現在から始まり、2つ→4つ→最終的に8つのパスへ分岐する未来の可能性を示しています。\n                            線の太さは確率の高さを表しています。\n                        </p>\n                    </div>\n                </div>\n\n                \x3c!-- 8シナリオカード --\x3e\n                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 40px;">\n                    ${t.finalEightPaths.map((t,n)=>this.generatePathCard(t,n)).join("")}\n                </div>\n\n                \x3c!-- HaQei統合分析 --\x3e\n                ${this.generateInsightSection(t,n,e,i)}\n\n                \x3c!-- アクションボタン --\x3e\n                <div style="text-align: center; margin-top: 30px;">\n                    <button onclick="window.print()" style="background: white; color: #4338ca; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin: 0 10px;">\n                        📄 PDFで保存\n                    </button>\n                    <button onclick="window.BinaryTreeCompleteDisplay.downloadResults()" style="background: white; color: #4338ca; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin: 0 10px;">\n                        💾 データをダウンロード\n                    </button>\n                </div>\n            </div>\n        `},generatePathCard:function(t,n){return`\n            <div style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; color: #333; border-left: 4px solid ${["#22c55e","#3b82f6","#a855f7","#ec4899","#fb923c","#facc15","#0ea5e9","#6366f1"][n]};">\n                <div style="display: flex; align-items: center; margin-bottom: 15px;">\n                    <span style="font-size: 1.5em; margin-right: 10px;">${["🎯","🚀","💡","🌟","🔮","⚡","🌈","✨"][n]}</span>\n                    <span style="font-weight: bold;">パス${t.pathIndex}</span>\n                </div>\n                <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px; color: #4338ca;">\n                    ${t.title}\n                </div>\n                <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 8px 12px; border-radius: 8px; margin-bottom: 10px;">\n                    確率: ${(100*t.probability).toFixed(1)}%\n                </div>\n                <div style="font-size: 0.85em; color: #6b7280; margin-bottom: 10px;">\n                    経路: ${t.route.join(" → ")}\n                </div>\n                <div style="font-size: 0.9em; color: #666;">\n                    ${t.description||""}\n                </div>\n            </div>\n        `},generateInsightSection:function(t,n,e,i){const a=n>e?"転換":"継続";return`\n            <div style="background: rgba(255,255,255,0.98); border-radius: 16px; padding: 30px; color: #333;">\n                <h3 style="color: #4338ca; margin-bottom: 25px;">🔍 HaQei哲学による統合的洞察</h3>\n                \n                \x3c!-- 易経ベース分析 --\x3e\n                ${t.lineData?`\n                <div style="margin-bottom: 25px;">\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">📖 易経ベース分析</h4>\n                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; line-height: 1.8;">\n                        <p style="margin-bottom: 10px;">\n                            <strong>卦象:</strong> ${t.lineData.卦名} - ${t.lineData.爻名}\n                        </p>\n                        <p style="margin-bottom: 10px;">\n                            <strong>現代解釈:</strong> ${t.lineData.現代解釈||"変化の時期における新たな機会"}\n                        </p>\n                        <p>\n                            <strong>行動指針:</strong> ${t.lineData.行動||"状況を見極めて慎重に進む"}\n                        </p>\n                    </div>\n                </div>\n                `:""}\n                \n                \x3c!-- 未来傾向分析 --\x3e\n                <div style="margin-bottom: 25px;">\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">📊 あなたの未来傾向分析</h4>\n                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; line-height: 1.8;">\n                        <p style="margin-bottom: 15px;">\n                            <strong>主傾向:</strong> 「${a}」の流れが強まっています（${a}系パス計: ${(100*("転換"===a?n:e)).toFixed(0)}%）。\n                        </p>\n                        <p style="margin-bottom: 15px;">\n                            <strong>最有力シナリオ:</strong> 「${i.title}」（${(100*i.probability).toFixed(1)}%）\n                        </p>\n                        <p>\n                            <strong>バランス指標:</strong> 継続${(100*e).toFixed(0)}% vs 転換${(100*n).toFixed(0)}%\n                        </p>\n                    </div>\n                </div>\n\n                \x3c!-- 分岐選択ガイド --\x3e\n                <div style="margin-bottom: 25px;">\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">🧭 分岐選択における重要ポイント</h4>\n                    <div style="display: grid; gap: 15px;">\n                        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 15px; border-radius: 10px;">\n                            <strong>第1分岐:</strong> 現状維持か変革かの基本方針\n                        </div>\n                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px;">\n                            <strong>第2分岐:</strong> 積極性か慎重性かの行動様式\n                        </div>\n                        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px;">\n                            <strong>第3分岐:</strong> 個人最適か全体最適かの価値基準\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- 実践的アドバイス --\x3e\n                <div style="margin-bottom: 25px;">\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">💡 実践的アドバイス</h4>\n                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">\n                        <ol style="line-height: 2; margin: 0; padding-left: 20px;">\n                            <li><strong>短期（3ヶ月）:</strong> 現在の強みを認識し基盤を固める</li>\n                            <li><strong>中期（6ヶ月）:</strong> 選択した方向性への段階的移行</li>\n                            <li><strong>長期（1年）:</strong> 新たな状態での安定と次の成長準備</li>\n                        </ol>\n                    </div>\n                </div>\n\n                \x3c!-- HaQei哲学総括 --\x3e\n                <div>\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">🎯 HaQei哲学の核心メッセージ</h4>\n                    <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; font-size: 1.1em; line-height: 1.6;">\n                        「8つのパスは全て可能性です。重要なのは選択ではなく、選んだ道での実践です。」\n                    </div>\n                </div>\n            </div>\n        `},renderBranchingChart:function(t){const n=document.getElementById("branchingChart");if(!n||!window.Chart)return;const e=t.branchingData;if(!e)return;const i=this.generateBranchingDatasets(e);new Chart(n,{type:"line",data:{labels:["現在","フェーズ1","フェーズ2","フェーズ3"],datasets:i},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:function(t){const n=t.dataset;return`${n.label}: ${(100*n.probability).toFixed(1)}%`}}}},scales:{x:{title:{display:!0,text:"時間経過 →"}},y:{min:0,max:1,title:{display:!0,text:"分岐位置"},ticks:{display:!1}}},elements:{line:{tension:.4}}}}),console.log("✅ 分岐型折れ線グラフ描画完了")},generateBranchingDatasets:function(t){const n=[],e=["rgba(34, 197, 94, 0.8)","rgba(59, 130, 246, 0.8)","rgba(168, 85, 247, 0.8)","rgba(236, 72, 153, 0.8)","rgba(251, 146, 60, 0.8)","rgba(250, 204, 21, 0.8)","rgba(14, 165, 233, 0.8)","rgba(99, 102, 241, 0.8)"];return t.phase4.forEach((i,a)=>{const r=this.tracePath(t,a);n.push({label:i.title||`パス${a+1}`,data:r,borderColor:e[a],backgroundColor:e[a].replace("0.8","0.2"),borderWidth:2+10*i.probability,probability:i.probability,fill:!1})}),n},tracePath:function(t,n){const e=[],i=t.phase4[n];e.push({x:0,y:.5});const a=n<4?t.phase2[0]:t.phase2[1];e.push({x:1,y:a.y});const r=Math.floor(n/2),o=t.phase3[r];return e.push({x:2,y:o.y}),e.push({x:3,y:i.y}),e},setupDownload:function(t){window.BinaryTreeCompleteDisplay.downloadResults=function(){const n={timestamp:(new Date).toISOString(),analysis:t,insights:{generated:!0,version:"2.1.0-branching-graph",dataSource:"H384_DATABASE"}},e=new Blob([JSON.stringify(n,null,2)],{type:"application/json"}),i=URL.createObjectURL(e),a=document.createElement("a");a.href=i,a.download=`binary-tree-analysis-${Date.now()}.json`,a.click()}},downloadResults:function(){window.BinaryTreeCompleteDisplay.downloadResults&&window.BinaryTreeCompleteDisplay.downloadResults()}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{console.log("🌳 Binary Tree Complete Display System v2.1 Ready")}):console.log("🌳 Binary Tree Complete Display System v2.1 Loaded");