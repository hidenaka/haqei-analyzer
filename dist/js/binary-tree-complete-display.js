window.BinaryTreeCompleteDisplay={display:function(n){console.log("🌳 Binary Tree Complete Display v2.1 開始 - H384データベース統合版"),window.futureAnalysisCompleted?(n&&n.finalEightPaths?(console.log("🌳 Using provided result data"),n.branchingData||(n.branchingData=this.generateBranchingData(n.finalEightPaths))):(console.log("🌳 Generating H384-integrated result with advancing/changing line concepts"),n=this.generateDefaultResultWithH384Data()),this.loadChartJS(()=>{this.renderCompleteAnalysis(n)})):console.log("⏳ Binary Tree waiting for analysis completion")},generateDefaultResultWithH384Data:function(){if(console.log("🎯 GENUINE TEXT ANALYSIS: Starting authentic I Ching text analysis..."),!window.H384_DATA||0===window.H384_DATA.length)throw console.error("❌ H384データベースが存在しません。データロードを確認してください。"),new Error("H384 Database not loaded");if(!window.H64_DATA||0===window.H64_DATA.length)throw console.error("❌ H64データベースが存在しません。データロードを確認してください。"),new Error("H64 Database not loaded");const n=window.latestUserInput||"統合的な視点で未来の選択肢を探索したい。";console.log("📝 Analyzing user input:",n.substring(0,50)+"...");const e=this.analyzeTextToSelectHexagram(n);console.log("☯️ Selected hexagram based on text analysis:",e);const t=this.findAppropriateLineFromHexagram(e,n);if(console.log("📊 Selected appropriate line:",t),window.BinaryTreeFutureEngine||"undefined"!=typeof BinaryTreeFutureEngine)try{const a=new(window.BinaryTreeFutureEngine||BinaryTreeFutureEngine);console.log("✅ Using TEXT-BASED hexagram and line selection (NO RANDOM)");const r=a.generateBinaryTreeFutures(t,{inputText:n,useRealH384Data:!0,hexagramAnalysis:e,textAnalysisMode:!0});if(r&&r.finalEightPaths)return console.log("🌳 Using GENUINE TEXT ANALYSIS with H384 database integration"),{currentLine:r.currentLine||t,lineData:r.lineData,finalEightPaths:r.finalEightPaths,branchingData:this.generateBranchingData(r.finalEightPaths),textAnalysis:e}}catch(a){console.error("❌ BinaryTreeFutureEngine error:",a)}return console.warn("⚠️ BinaryTreeFutureEngine not available, using TEXT-BASED H384 database fallback"),this.generateTextBasedH384Result(n,e,t)},generateH384DatabaseOnlyResult:function(){console.log("🔄 Using H384 database-only fallback for scenario generation");const n=Math.floor(Math.random()*window.H384_DATA.length),e=window.H384_DATA[n].通し番号,t=this.getActualH384Data(e),a=[];return[{id:"progress_continue_a",name:"継続強化・強化型",prob:.078},{id:"progress_continue_b",name:"継続強化・穏健型",prob:.117},{id:"progress_adjust_a",name:"調整進行・強化型",prob:.143},{id:"progress_adjust_b",name:"調整進行・穏健型",prob:.214},{id:"transform_complete_a",name:"根本転換・強化型",prob:.116},{id:"transform_complete_b",name:"根本転換・穏健型",prob:.173},{id:"transform_integrate_a",name:"統合発展・強化型",prob:.211},{id:"transform_integrate_b",name:"統合発展・穏健型",prob:.316}].forEach((n,r)=>{const i=e+Math.floor(20*Math.random())-10,o=Math.max(1,Math.min(386,i)),s=this.getActualH384Data(o);a.push({pathIndex:r+1,pathId:n.id,name:n.name,probability:n.prob,currentLine:e,targetLine:o,lineData:s,score:Math.floor(50+50*Math.random()),keywords:s.キーワード||["進歩","調整","変化"],description:`第${r+1}の道: ${n.name}`,hexagramTransformation:{from:{number:t.卦番号,name:t.卦名,yao:t.爻},to:{number:s.卦番号,name:s.卦名,yao:s.爻}}})}),{currentLine:e,lineData:t,finalEightPaths:a,branchingData:this.generateBranchingData(a)}},getActualH384Data:function(n){if(!window.H384_DATA)throw new Error("H384 Database not available");const e=window.H384_DATA.find(e=>e.通し番号===n);if(!e){const e=window.H384_DATA.reduce((e,t)=>Math.abs(t.通し番号-n)<Math.abs(e.通し番号-n)?t:e);return console.warn(`Line ${n} not found, using closest: ${e.通し番号}`),e}return e},getActualH64Data:function(n){if(!window.H64_DATA)throw new Error("H64 Database not available");const e=window.H64_DATA.find(e=>e.卦番号===n);if(!e)throw new Error(`Hexagram ${n} not found in database`);return e},calculateProbabilityFromLine:function(n,e){if(!n)return.25;const t=n.位置||3,a="陽"===n.陰陽;n.通し番号;switch(e){case"advancing_continue":const n=t<=3?.35:.25;return a?n+.05:n;case"advancing_transform":const e=t>=2&&t<=4?.3:.2;return a?e:e+.06;case"changing_integrate":return(t>=4?.32:.22)+.02*Math.abs(t-3.5);case"changing_complete":return t>=4&&a?.28:t<=3&&!a?.26:.22;case"continue_strong":return a?.3+.02*t:.2+.01*t;case"continue_transform":return a?.25-.01*t:.25+.01*t;case"transform_integrate":return a?.2+.02*t:.3+.01*t;case"transform_step":return a?.2+.01*t:.25-.01*t;default:return.25}},generateBranchingData:function(n){const e={x:0,y:.5,label:"現在"},t=[{x:1,y:.3,probability:n.slice(0,4).reduce((n,e)=>n+e.probability,0),label:"継続路線",parent:0},{x:1,y:.7,probability:n.slice(4,8).reduce((n,e)=>n+e.probability,0),label:"転換路線",parent:0}],a=[{x:2,y:.15,probability:n[0].probability+n[1].probability,label:"継続強化",parent:0},{x:2,y:.35,probability:n[2].probability+n[3].probability,label:"継続調整",parent:0},{x:2,y:.55,probability:n[4].probability+n[5].probability,label:"転換統合",parent:1},{x:2,y:.75,probability:n[6].probability+n[7].probability,label:"転換段階",parent:1}],r=n.map((n,e)=>({x:3,y:.05+.125*e,probability:n.probability,label:`パス${e+1}`,title:n.title,parent:Math.floor(e/2)}));return{phase1:e,phase2:t,phase3:a,phase4:r,allPhases:[e,...t,...a,...r]}},loadChartJS:function(n){if(window.Chart)return void n();const e=document.createElement("script");e.src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js",e.onload=n,document.head.appendChild(e)},renderCompleteAnalysis:function(n){const e=document.getElementById("resultArea");e&&(e.style.display="block");const t=document.querySelector("#scenarioCardsContainer")||document.querySelector("#resultsContainer")||document.querySelector(".main-content")||document.querySelector("#results-container")||document.querySelector("#binary-tree-results")||document.body;if(t){if(console.log("✅ BinaryTreeCompleteDisplay container found:",t.id||t.className),"scenarioCardsContainer"===t.id){t.innerHTML=n.finalEightPaths.map((n,e)=>this.generatePathCard(n,e)).join(""),console.log("✅ Scenario cards generated directly in scenarioCardsContainer:",n.finalEightPaths.length,"cards"),this.integrateWithResultPageController(n);const e=document.getElementById("originalGraphsContainer");e&&(e.style.display="block",console.log("✅ Original graphs container restored and visible"))}else t.innerHTML=this.generateHTML(n);setTimeout(()=>{this.renderBranchingChart(n)},100),this.setupDownload(n)}else console.error("❌ No container found for BinaryTreeCompleteDisplay results")},generateHTML:function(n){if(!n||!n.finalEightPaths)throw console.error("❌ 分析結果がありません"),new Error("Analysis result required");const e=n.finalEightPaths.slice(4,8).reduce((n,e)=>n+e.probability,0),t=n.finalEightPaths.slice(0,4).reduce((n,e)=>n+e.probability,0),a=n.finalEightPaths.reduce((n,e)=>e.probability>n.probability?e:n);if(!n.lineData)throw new Error("Line data is required from database");const r=n.lineData.卦名,i=n.lineData.爻,o=n.lineData.卦番号;return`\n            <div class="binary-tree-complete-analysis" style="padding: 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; color: white; margin: 20px 0;">\n                \n                \x3c!-- タイトル --\x3e\n                <div style="text-align: center; margin-bottom: 40px;">\n                    <h2 style="font-size: 2em; margin-bottom: 10px; color: white; display: flex; align-items: center; justify-content: center; gap: 1rem;">\n                        ${this.generateHexagramVisual(o)}\n                        <span>🌳 あなたの現在地：${r} ${i}</span>\n                    </h2>\n                    <p style="font-size: 1.2em; opacity: 0.95;">易経の変化プロセス（進爻・変爻）による8つの未来パス</p>\n                    ${n.lineData?`<p style="font-size: 0.9em; opacity: 0.8;">基準: ${n.lineData.卦名} ${n.lineData.爻名}</p>`:""}\n                </div>\n\n                \x3c!-- ROOT CAUSE FIX: 現在の状況テーマ・キーワード特定表示 --\x3e\n                <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 25px; margin-bottom: 30px; border-left: 4px solid #fbbf24;">\n                    <h3 style="color: #fbbf24; margin-bottom: 15px;">🔍 現在の状況診断</h3>\n                    ${this.generateCurrentSituationAnalysis(n)}\n                </div>\n\n                \x3c!-- ROOT CAUSE FIX: 進爻・変爻の概念説明 --\x3e\n                <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 25px; margin-bottom: 30px; border-left: 4px solid #22c55e;">\n                    <h3 style="color: #22c55e; margin-bottom: 15px;">⚖️ 進爻・変爻による選択肢</h3>\n                    ${this.generateProgressChangeExplanation(n)}\n                </div>\n\n                \x3c!-- ROOT CAUSE FIX: 3段階フェーズ変化プロセス --\x3e\n                <div style="background: rgba(255,255,255,0.15); border-radius: 16px; padding: 25px; margin-bottom: 30px; border-left: 4px solid #3b82f6;">\n                    <h3 style="color: #3b82f6; margin-bottom: 15px;">📊 3段階変化プロセス</h3>\n                    ${this.generateThreePhaseProcess(n)}\n                </div>\n\n                \x3c!-- 分岐型折れ線グラフ --\x3e\n                <div style="background: white; border-radius: 16px; padding: 30px; margin-bottom: 30px;">\n                    <h3 style="color: #4338ca; margin-bottom: 20px;">📈 未来分岐パスの可視化</h3>\n                    <div style="height: 400px; position: relative;">\n                        <canvas id="branchingChart"></canvas>\n                    </div>\n                    <div style="margin-top: 20px; padding: 15px; background: #f3f4f6; border-radius: 8px;">\n                        <p style="color: #4b5563; margin: 0; font-size: 0.9em;">\n                            <strong>説明:</strong> 現在から始まり、2つ→4つ→最終的に8つのパスへ分岐する未来の可能性を示しています。\n                            線の太さは確率の高さを表しています。\n                        </p>\n                    </div>\n                </div>\n\n                \x3c!-- 8シナリオカード（Progressive Disclosure） --\x3e\n                <div id="scenariosSection" style="margin-bottom: 40px;">\n                    <div style="text-align: center; margin-bottom: 20px;">\n                        <button id="toggleScenariosBtn" onclick="window.BinaryTreeCompleteDisplay.toggleScenarios()" \n                                style="background: white; color: #4338ca; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">\n                            🔮 8つの未来シナリオを表示\n                        </button>\n                    </div>\n                    <div id="scenariosContainer" style="display: none; animation: fadeIn 0.5s;">\n                        <div style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px; text-align: center;">\n                            <p style="margin: 0; opacity: 0.9;">3段階の選択による8つの未来パスが表示されます</p>\n                        </div>\n                        <div id="scenariosGrid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">\n                            ${n.finalEightPaths.map((n,e)=>this.generatePathCard(n,e)).join("")}\n                        </div>\n                    </div>\n                </div>\n                \n                <style>\n                    @keyframes fadeIn {\n                        from { opacity: 0; transform: translateY(-10px); }\n                        to { opacity: 1; transform: translateY(0); }\n                    }\n                    @keyframes fadeOut {\n                        from { opacity: 1; transform: translateY(0); }\n                        to { opacity: 0; transform: translateY(-10px); }\n                    }\n                </style>\n\n                \x3c!-- HaQei統合分析 --\x3e\n                ${this.generateInsightSection(n,e,t,a)}\n\n                \x3c!-- アクションボタン --\x3e\n                <div style="text-align: center; margin-top: 30px;">\n                    <button onclick="window.print()" style="background: white; color: #4338ca; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin: 0 10px;">\n                        📄 PDFで保存\n                    </button>\n                    <button onclick="window.BinaryTreeCompleteDisplay.downloadResults()" style="background: white; color: #4338ca; padding: 12px 30px; border: none; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin: 0 10px;">\n                        💾 データをダウンロード\n                    </button>\n                </div>\n            </div>\n        `},generatePathCard:function(n,e){const t=n.probability||0,a=t>.13?"Sランク":t>.11?"Aランク":"Bランク",r=t>.13?"#22c55e":t>.11?"#3b82f6":"#f59e0b",i=n.pathIndex||e+1,o=n.title||`シナリオ ${i}`,s=["🎯","🚀","💡","🌟","🔮","⚡","🌈","✨"][e]||"🎯",l=["#22c55e","#3b82f6","#a855f7","#ec4899","#fb923c","#facc15","#0ea5e9","#6366f1"][e]||"#6366f1";n.transformationInfo&&(n.transformationInfo.hexagramChange,n.transformationInfo.lineChange,n.transformationInfo.type,n.transformationInfo.approach),n.targetHexagram&&(n.targetHexagram.name,n.targetHexagram.line,n.targetHexagram.interpretation,n.targetHexagram.keywords&&n.targetHexagram.keywords.join(", "),n.targetHexagram.score);return`\n            <div class="scenario-card scenario-item choice-card" style="background: rgba(255,255,255,0.95); border-radius: 12px; padding: 20px; color: #333; border-left: 4px solid ${l}; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s;"\n                 onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.15)';"\n                 onmouseout="this.style.transform='translateY(0px)'; this.style.boxShadow='0 4px 6px rgba(0,0,0,0.1)';"\n                 onclick="window.BinaryTreeCompleteDisplay.showPathTransformation(${i}, ${JSON.stringify(n).replace(/"/g,"&quot;")})">\n                \n                \x3c!-- ヘッダー部分 --\x3e\n                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">\n                    <div style="display: flex; align-items: center;">\n                        <span style="font-size: 1.5em; margin-right: 10px;">${s}</span>\n                        <span style="font-weight: bold; color: ${l};">パス${i}</span>\n                    </div>\n                    <span style="background: ${r}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.8em; font-weight: 600;">${a}</span>\n                </div>\n                \n                \x3c!-- タイトル --\x3e\n                <div style="font-size: 1.1em; font-weight: 600; margin-bottom: 10px; color: #4338ca;">\n                    ${o}\n                </div>\n                \n                \x3c!-- 経路表示 --\x3e\n                <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 8px 12px; border-radius: 8px; margin-bottom: 10px;">\n                    経路: ${n.route?n.route.join(" → "):"transform → integrate → option_b"}\n                </div>\n                \n                \x3c!-- 確率表示 --\x3e\n                <div style="background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); padding: 8px 12px; border-radius: 8px; margin-bottom: 10px;">\n                    確率: ${(100*t).toFixed(1)}%\n                </div>\n                \n                \x3c!-- 説明 --\x3e\n                <div style="font-size: 0.9em; color: #666; margin: 10px 0;">\n                    ${n.description||n.fullDescription||"現状を基盤としながら、慎重な協力関係を重視した道筋。"}\n                </div>\n                \n                \x3c!-- キーワード --\x3e\n                <div style="margin: 10px 0;">\n                    <div style="font-size: 0.8em; color: #888; margin-bottom: 5px;">キーワード:</div>\n                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">\n                        ${(n.lineData?.キーワード||n.targetHexagram?.keywords||["信念","堅持","忍耐"]).map(n=>`<span style="background: rgba(99, 102, 241, 0.1); color: #6366f1; padding: 2px 8px; border-radius: 12px; font-size: 0.8em;">${n}</span>`).join("")}\n                    </div>\n                </div>\n                \n                \x3c!-- 易経情報（H384データベース詳細） --\x3e\n                <div style="margin: 10px 0; padding: 12px; background: linear-gradient(135deg, rgba(79, 70, 229, 0.1) 0%, rgba(99, 102, 241, 0.05) 100%); border-radius: 8px; border-left: 3px solid #6366f1;">\n                    <div style="font-size: 0.9em; color: #4338ca; margin-bottom: 8px; font-weight: 600;">\n                        ☯ ${n.lineData?.卦名||n.targetHexagram?.name||"天山遯"} (第${n.lineData?.卦番号||n.targetHexagram?.number||"33"}卦)\n                    </div>\n                    <div style="font-size: 0.8em; color: #6366f1; margin-bottom: 5px;">\n                        <strong>爻位:</strong> ${n.lineData?.爻||n.targetHexagram?.line||"六二"}\n                    </div>\n                    <div style="font-size: 0.8em; color: #4f46e5; margin-bottom: 5px;">\n                        <strong>現代解釈:</strong> ${n.lineData?.現代解釈の要約||n.targetHexagram?.interpretation||"物理的に退けない状況で、自らの信念や原則を、丈夫な革のように固く守り抜く。外部の圧力や誘惑に屈しない、内なる強固な意志。"}\n                    </div>\n                    ${n.lineData?.S7_総合評価スコア?`<div style="font-size: 0.8em; color: #7c3aed;">\n                        <strong>H384スコア:</strong> ${n.lineData.S7_総合評価スコア}点\n                    </div>`:""}\n                </div>\n                \n                \x3c!-- 変化プロセス表示ボタン --\x3e\n                <div style="text-align: center; margin-top: 15px;">\n                    <div style="background: rgba(99, 102, 241, 0.2); color: #4338ca; padding: 8px 16px; border-radius: 6px; font-size: 0.9em;">\n                        🔮 変化のプロセスを見る\n                    </div>\n                </div>\n            </div>\n        `},generateInsightSection:function(n,e,t,a){const r=e>t?"転換":"継続";return`\n            <div style="background: rgba(255,255,255,0.98); border-radius: 16px; padding: 30px; color: #333;">\n                <h3 style="color: #4338ca; margin-bottom: 25px;">🔍 HaQei哲学による統合的洞察</h3>\n                \n                \x3c!-- 易経ベース分析 --\x3e\n                ${n.lineData?`\n                <div style="margin-bottom: 25px;">\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">📖 易経ベース分析</h4>\n                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; line-height: 1.8;">\n                        <p style="margin-bottom: 10px;">\n                            <strong>卦象:</strong> ${n.lineData.卦名} - ${n.lineData.爻名}\n                        </p>\n                        <p style="margin-bottom: 10px;">\n                            <strong>現代解釈:</strong> ${n.lineData.現代解釈||"変化の時期における新たな機会"}\n                        </p>\n                        <p>\n                            <strong>行動指針:</strong> ${n.lineData.行動||"状況を見極めて慎重に進む"}\n                        </p>\n                    </div>\n                </div>\n                `:""}\n                \n                \x3c!-- 未来傾向分析 --\x3e\n                <div style="margin-bottom: 25px;">\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">📊 あなたの未来傾向分析</h4>\n                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px; line-height: 1.8;">\n                        <p style="margin-bottom: 15px;">\n                            <strong>主傾向:</strong> 「${r}」の流れが強まっています（${r}系パス計: ${(100*("転換"===r?e:t)).toFixed(0)}%）。\n                        </p>\n                        <p style="margin-bottom: 15px;">\n                            <strong>最有力シナリオ:</strong> 「${a.title}」（${(100*a.probability).toFixed(1)}%）\n                        </p>\n                        <p>\n                            <strong>バランス指標:</strong> 継続${(100*t).toFixed(0)}% vs 転換${(100*e).toFixed(0)}%\n                        </p>\n                    </div>\n                </div>\n\n                \x3c!-- 分岐選択ガイド --\x3e\n                <div style="margin-bottom: 25px;">\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">🧭 分岐選択における重要ポイント</h4>\n                    <div style="display: grid; gap: 15px;">\n                        <div style="background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); padding: 15px; border-radius: 10px;">\n                            <strong>第1分岐:</strong> 現状維持か変革かの基本方針\n                        </div>\n                        <div style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); padding: 15px; border-radius: 10px;">\n                            <strong>第2分岐:</strong> 積極性か慎重性かの行動様式\n                        </div>\n                        <div style="background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); padding: 15px; border-radius: 10px;">\n                            <strong>第3分岐:</strong> 個人最適か全体最適かの価値基準\n                        </div>\n                    </div>\n                </div>\n\n                \x3c!-- 実践的アドバイス --\x3e\n                <div style="margin-bottom: 25px;">\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">💡 実践的アドバイス</h4>\n                    <div style="background: #f9fafb; padding: 20px; border-radius: 12px;">\n                        <ol style="line-height: 2; margin: 0; padding-left: 20px;">\n                            <li><strong>短期（3ヶ月）:</strong> 現在の強みを認識し基盤を固める</li>\n                            <li><strong>中期（6ヶ月）:</strong> 選択した方向性への段階的移行</li>\n                            <li><strong>長期（1年）:</strong> 新たな状態での安定と次の成長準備</li>\n                        </ol>\n                    </div>\n                </div>\n\n                \x3c!-- HaQei哲学総括 --\x3e\n                <div>\n                    <h4 style="color: #6366f1; margin-bottom: 15px;">🎯 HaQei哲学の核心メッセージ</h4>\n                    <div style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%); padding: 20px; border-radius: 12px; color: white; text-align: center; font-size: 1.1em; line-height: 1.6;">\n                        「8つのパスは全て可能性です。重要なのは選択ではなく、選んだ道での実践です。」\n                    </div>\n                </div>\n            </div>\n        `},renderBranchingChart:function(n){const e=document.getElementById("branchingChart");if(!e)return void console.warn("⚠️ branchingChart canvas element not found - skipping chart render");if(!window.Chart)return void console.warn("⚠️ Chart.js not available - skipping chart render");this.chartInstance&&(this.chartInstance.destroy(),this.chartInstance=null,console.log("🗑️ Previous Chart.js instance destroyed")),Chart.getChart(e)?.destroy();const t=e.getContext("2d");if(!t)return void console.error("Could not get 2D context from canvas");const a=n.branchingData;if(!a)return;const r=this.generateBranchingDatasets(a);this.chartInstance=new Chart(t,{type:"line",data:{labels:["現在","フェーズ1","フェーズ2","フェーズ3"],datasets:r},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:function(n){const e=n.dataset,t=n.parsed.y;return`${e.label}: ${t.toFixed(1)}点 (${(100*e.probability).toFixed(1)}%)`}}}},scales:{x:{title:{display:!0,text:"時間経過 →"}},y:{min:0,max:100,title:{display:!0,text:"基本スコア (点)"},ticks:{display:!0,callback:function(n){return n+"点"}}}},elements:{line:{tension:.4},point:{radius:6,hoverRadius:8}}}}),console.log("✅ 分岐型折れ線グラフ描画完了")},generateBranchingDatasets:function(n){const e=[],t=["rgba(34, 197, 94, 0.8)","rgba(59, 130, 246, 0.8)","rgba(168, 85, 247, 0.8)","rgba(236, 72, 153, 0.8)","rgba(251, 146, 60, 0.8)","rgba(250, 204, 21, 0.8)","rgba(14, 165, 233, 0.8)","rgba(99, 102, 241, 0.8)"];return n.phase4.forEach((a,r)=>{const i=this.tracePath(n,r);e.push({label:a.title||`パス${r+1}`,data:i,borderColor:t[r],backgroundColor:t[r].replace("0.8","0.2"),borderWidth:2+10*a.probability,probability:a.probability,fill:!1})}),e},tracePath:function(n,e){const t=[],a=n.phase4[e],calculateScore=n=>Math.max(10,Math.min(100,100*n+20*Math.random()-10));t.push({x:0,y:50});const r=calculateScore((e<4?n.phase2[0]:n.phase2[1]).probability);t.push({x:1,y:r});const i=Math.floor(e/2),o=calculateScore(n.phase3[i].probability);t.push({x:2,y:o});const s=calculateScore(a.probability);return t.push({x:3,y:s}),t},toggleScenarios:function(){const n=document.getElementById("scenariosContainer"),e=document.getElementById("toggleScenariosBtn");n&&("none"===n.style.display?(n.style.display="block",e.innerHTML="🔍 8つのシナリオを隠す",e.style.background="rgba(255,255,255,0.9)",setTimeout(()=>{n.scrollIntoView({behavior:"smooth",block:"nearest"})},100)):(n.style.animation="fadeOut 0.3s",setTimeout(()=>{n.style.display="none",n.style.animation="fadeIn 0.5s",e.innerHTML="🔮 8つの未来シナリオを表示",e.style.background="white"},300)))},togglePathDetails:function(n,e){const t=document.getElementById(n),a=document.getElementById(e);t&&a&&("none"===t.style.display?(t.style.display="block",a.innerHTML="🔼 詳細を閉じる",a.style.background="rgba(239, 68, 68, 0.2)",a.style.color="#dc2626"):(t.style.display="none",a.innerHTML="🔍 詳細を見る",a.style.background="rgba(99, 102, 241, 0.2)",a.style.color="#A5B4FC"))},showPathTransformation:function(n,e){console.log(`🔮 Showing transformation process for path ${n}:`,e);const t=document.createElement("div");t.id="transformation-modal-overlay",t.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.8);\n            z-index: 1000;\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            animation: fadeIn 0.3s ease-out;\n        ";const a=document.createElement("div");a.style.cssText="\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            border-radius: 20px;\n            padding: 30px;\n            max-width: 80%;\n            max-height: 80%;\n            overflow-y: auto;\n            color: white;\n            animation: slideInUp 0.4s ease-out;\n            position: relative;\n        ",a.innerHTML=this.generateTransformationProcessHTML(n,e),t.appendChild(a),document.body.appendChild(t),t.addEventListener("click",n=>{n.target===t&&this.closeTransformationModal()});const closeOnEscape=n=>{"Escape"===n.key&&(this.closeTransformationModal(),document.removeEventListener("keydown",closeOnEscape))};document.addEventListener("keydown",closeOnEscape),setTimeout(()=>this.animateTransformationProcess(),500)},closeTransformationModal:function(){const n=document.getElementById("transformation-modal-overlay");n&&(n.style.animation="fadeOut 0.3s ease-out",setTimeout(()=>{document.body.removeChild(n)},300))},generateTransformationProcessHTML:function(n,e){const t=["🎯","🚀","💡","🌟","🔮","⚡","🌈","✨"];return`\n            \x3c!-- 閉じるボタン --\x3e\n            <button onclick="window.BinaryTreeCompleteDisplay.closeTransformationModal()" \n                    style="position: absolute; top: 15px; right: 15px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; font-size: 1.2em;">\n                ✕\n            </button>\n            \n            \x3c!-- タイトル --\x3e\n            <div style="text-align: center; margin-bottom: 30px;">\n                <h2 style="font-size: 2em; margin-bottom: 10px; display: flex; align-items: center; justify-content: center; gap: 1rem;">\n                    ${t[(n-1)%t.length]} 変化のプロセス：パス${n}\n                </h2>\n                <p style="font-size: 1.1em; opacity: 0.9;">${e.title||`シナリオ ${n}`}</p>\n            </div>\n            \n            \x3c!-- 変化プロセスの段階表示 --\x3e\n            <div id="transformation-stages" style="margin-bottom: 30px;">\n                <div class="transformation-stage" data-stage="0" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; opacity: 0.3; transform: translateX(-20px); transition: all 0.6s ease-out;">\n                    <div style="display: flex; align-items: center; margin-bottom: 10px;">\n                        <span style="background: #22c55e; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">1</span>\n                        <h3 style="margin: 0; font-size: 1.2em;">現在の状況</h3>\n                    </div>\n                    <div style="margin-left: 45px;">\n                        <p style="margin: 5px 0;"><strong>卦:</strong> ${e.originalHexagram?.name||""}</p>\n                        <p style="margin: 5px 0;"><strong>爻:</strong> ${e.originalHexagram?.line||"六二"}</p>\n                        <p style="margin: 5px 0;"><strong>状況:</strong> ${e.originalHexagram?.interpretation||"現在の安定した基盤"}</p>\n                    </div>\n                </div>\n                \n                <div class="transformation-stage" data-stage="1" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; opacity: 0.3; transform: translateX(-20px); transition: all 0.6s ease-out;">\n                    <div style="display: flex; align-items: center; margin-bottom: 10px;">\n                        <span style="background: #3b82f6; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">2</span>\n                        <h3 style="margin: 0; font-size: 1.2em;">変化の開始</h3>\n                    </div>\n                    <div style="margin-left: 45px;">\n                        <p style="margin: 5px 0;"><strong>選択:</strong> ${(e.route||["保守的","協調的","慎重"])[0]}</p>\n                        <p style="margin: 5px 0;"><strong>アプローチ:</strong> ${e.transformationInfo?.approach||"段階的な変化"}</p>\n                        <p style="margin: 5px 0;"><strong>確率:</strong> ${(100*(e.probability||.12)).toFixed(1)}%</p>\n                    </div>\n                </div>\n                \n                <div class="transformation-stage" data-stage="2" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; opacity: 0.3; transform: translateX(-20px); transition: all 0.6s ease-out;">\n                    <div style="display: flex; align-items: center; margin-bottom: 10px;">\n                        <span style="background: #a855f7; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">3</span>\n                        <h3 style="margin: 0; font-size: 1.2em;">変化の深化</h3>\n                    </div>\n                    <div style="margin-left: 45px;">\n                        <p style="margin: 5px 0;"><strong>方向性:</strong> ${(e.route||["保守的","協調的","慎重"])[1]}</p>\n                        <p style="margin: 5px 0;"><strong>変化の種類:</strong> ${e.transformationInfo?.type||"進歩的変化"}</p>\n                        <p style="margin: 5px 0;"><strong>易経的意味:</strong> ${e.transformationInfo?.lineChange||"爻の変化による新展開"}</p>\n                    </div>\n                </div>\n                \n                <div class="transformation-stage" data-stage="3" style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px; opacity: 0.3; transform: translateX(-20px); transition: all 0.6s ease-out;">\n                    <div style="display: flex; align-items: center; margin-bottom: 10px;">\n                        <span style="background: #ec4899; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 15px;">4</span>\n                        <h3 style="margin: 0; font-size: 1.2em;">最終到達状態</h3>\n                    </div>\n                    <div style="margin-left: 45px;">\n                        <p style="margin: 5px 0;"><strong>到達卦:</strong> ${e.targetHexagram?.name||"天火同人"}</p>\n                        <p style="margin: 5px 0;"><strong>到達爻:</strong> ${e.targetHexagram?.line||"九三"}</p>\n                        <p style="margin: 5px 0;"><strong>結果:</strong> ${e.targetHexagram?.interpretation||"協調的な新しい関係性"}</p>\n                        <p style="margin: 5px 0;"><strong>スコア:</strong> ${e.targetHexagram?.score||75}点</p>\n                    </div>\n                </div>\n            </div>\n            \n            \x3c!-- キーワードと洞察 --\x3e\n            <div style="background: rgba(255,255,255,0.15); padding: 20px; border-radius: 12px; margin-bottom: 20px;">\n                <h3 style="margin-bottom: 15px; color: #fbbf24;">💡 この変化プロセスの洞察</h3>\n                <div style="margin-bottom: 10px;">\n                    <strong>キーワード:</strong>\n                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px;">\n                        ${(e.targetHexagram?.keywords||["協調性","安定性","慎重さ"]).map(n=>`<span style="background: rgba(251, 191, 36, 0.3); color: #fbbf24; padding: 4px 10px; border-radius: 15px; font-size: 0.9em;">${n}</span>`).join("")}\n                    </div>\n                </div>\n                <p style="line-height: 1.6; margin: 15px 0;">\n                    ${e.description||e.fullDescription||"この変化プロセスでは、現在の安定した基盤から出発し、慎重かつ協調的なアプローチを通じて、より良い状態への変化を実現します。"}\n                </p>\n            </div>\n            \n            \x3c!-- アクションボタン --\x3e\n            <div style="text-align: center; margin-top: 20px;">\n                <button onclick="window.BinaryTreeCompleteDisplay.closeTransformationModal()" \n                        style="background: rgba(255,255,255,0.2); color: white; border: 2px solid rgba(255,255,255,0.5); padding: 12px 30px; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin: 0 10px;">\n                    理解しました\n                </button>\n                <button onclick="window.BinaryTreeCompleteDisplay.exportPathDetails(${n}, ${JSON.stringify(e).replace(/"/g,"&quot;")})" \n                        style="background: rgba(34, 197, 94, 0.3); color: #22c55e; border: 2px solid rgba(34, 197, 94, 0.5); padding: 12px 30px; border-radius: 8px; font-size: 1.1em; cursor: pointer; margin: 0 10px;">\n                    📄 詳細をエクスポート\n                </button>\n            </div>\n        `},animateTransformationProcess:function(){document.querySelectorAll(".transformation-stage").forEach((n,e)=>{setTimeout(()=>{n.style.opacity="1",n.style.transform="translateX(0px)",setTimeout(()=>{n.style.boxShadow="0 8px 25px rgba(255,255,255,0.2)",setTimeout(()=>{n.style.boxShadow="none"},800)},200)},400*e)})},exportPathDetails:function(n,e){const t={path:n,title:e.title,probability:e.probability,route:e.route,transformation:e.transformationInfo,target:e.targetHexagram,description:e.description,exportedAt:(new Date).toISOString()},a=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),r=URL.createObjectURL(a),i=document.createElement("a");i.href=r,i.download=`future_path_${n}_details.json`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),console.log(`📄 Path ${n} details exported:`,t)},setupDownload:function(n){window.BinaryTreeCompleteDisplay.downloadResults=function(){const e={timestamp:(new Date).toISOString(),analysis:n,insights:{generated:!0,version:"2.1.0-branching-graph",dataSource:"H384_DATABASE"}},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),a=URL.createObjectURL(t),r=document.createElement("a");r.href=a,r.download=`binary-tree-analysis-${Date.now()}.json`,r.click()}},generateHexagramVisual:function(n){const e=({1:"111111",2:"000000",3:"010001",4:"100010",5:"010111",6:"111010",7:"000010",8:"010000",9:"110111",10:"111011",11:"000111",12:"111000",13:"111101",14:"101111",15:"000100",16:"001000",17:"011001",18:"100110",19:"000011",20:"110000",21:"101001",22:"100101",23:"100000",24:"000001",25:"111001",26:"100111",27:"100001",28:"011110",29:"010010",30:"101101",31:"011100",32:"001110",33:"111100",34:"001111",35:"101000",36:"000101",37:"110101",38:"101011",39:"010100",40:"001010",41:"100011",42:"110001",43:"011111",44:"111110",45:"011000",46:"000110",47:"011010",48:"010110",49:"011101",50:"101110",51:"001001",52:"100100",53:"110100",54:"001011",55:"001101",56:"101100",57:"110110",58:"011011",59:"110010",60:"010011",61:"110011",62:"001100",63:"010101",64:"101010"}[n]||"000000").split("").reverse();let t='<div style="display: inline-flex; flex-direction: column; gap: 3px; padding: 0 10px;">';return e.forEach(n=>{t+="1"===n?'<div style="width: 50px; height: 5px; background: #FFD700; border-radius: 1px; box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);"></div>':'<div style="display: flex; gap: 6px;"><div style="width: 20px; height: 5px; background: #87CEEB; border-radius: 1px; box-shadow: 0 0 3px rgba(135, 206, 235, 0.5);"></div><div style="width: 20px; height: 5px; background: #87CEEB; border-radius: 1px; box-shadow: 0 0 3px rgba(135, 206, 235, 0.5);"></div></div>'}),t+="</div>",t},getLinePosition:function(n){return{"初九":1,"初六":1,"九二":2,"六二":2,"九三":3,"六三":3,"九四":4,"六四":4,"九五":5,"六五":5,"上九":6,"上六":6}[n]||4},calculatePathTransformations:function(n,e){const t=window.H64_DATA?window.H64_DATA.find(e=>e.卦番号===n):{"卦番号":n,"名前":"不明","初爻変":n};return[{type:"進爻継続",approach:"積極的",title:"さらに進む・strengthen"},{type:"進爻継続",approach:"慎重",title:"さらに進む・moderate"},{type:"進爻変化",approach:"積極的",title:"一部転換・strengthen"},{type:"進爻変化",approach:"慎重",title:"一部転換・moderate"},{type:"変爻完全",approach:"積極的",title:"完全転換・strengthen"},{type:"変爻完全",approach:"慎重",title:"完全転換・moderate"},{type:"変爻統合",approach:"積極的",title:"統合的転換・strengthen"},{type:"変爻統合",approach:"慎重",title:"統合的転換・moderate"}].map((n,a)=>{const r=this.calculateTargetHexagram(t,e,n.type,a),i=window.H64_DATA?window.H64_DATA.find(n=>n.卦番号===r):{"卦番号":r,"名前":"変化卦"},o=this.getTargetLineData(r,e,a),s=this.calculateTransformationProbability(n.type,n.approach,e),l=this.generateRoute(n.type,n.approach);return{type:n.type,title:n.title,probability:s,route:l,transformationType:n.type,approach:n.approach,targetHexagram:i,targetLineData:o}})},calculateTargetHexagram:function(n,e,t,a){if(!n||!window.H64_DATA)throw new Error("Hexagram data and H64 database are required");let r=e;t.includes("進爻")?e>3&&(r=a%3+1):t.includes("変爻")&&e<=3&&(r=a%3+4);const i=a%3;return n[["初爻変","二爻変","三爻変","四爻変","五爻変","上爻変"][Math.max(1,Math.min(6,r+i))-1]]||n.卦番号},getTargetLineData:function(n,e,t){if(!window.H384_DATA)return null;const a=[e,Math.max(1,e-1),Math.min(6,e+1),e,Math.max(1,e-2),Math.min(6,e+2),Math.max(1,e%6+1),Math.max(1,(e+2)%6+1)][t%8];return window.H384_DATA.find(e=>e.卦番号===n&&this.getLinePosition(e.爻)===a)||window.H384_DATA.find(e=>e.卦番号===n)||null},generateTransformationDescription:function(n,e,t,a){if(!e)return`${t}による${a}なアプローチで、新しい可能性を探索する道。`;const r=n?.現代解釈||"現在の状況",i=e.現代解釈||e.現代解釈の要約||"変化の兆し",o=e.キーワード||["変化","適応"];return`${r}から、${i}への変化。${t}による${a}なアプローチで、${Array.isArray(o)?o.join("、"):"適応"}を重視した道筋。`},calculateTransformationProbability:function(n,e,t){let a=.125;return n.includes("進爻")?a+=t<=3?.05:-.02:n.includes("変爻")&&(a+=t>=4?.05:-.02),"積極的"===e?a+=.02:"慎重"===e&&(a+=.01),a+=.1*(Math.random()-.5),Math.max(.05,Math.min(.4,a))},generateRoute:function(n,e){return[...{"進爻継続":["progress","continue"],"進爻変化":["progress","adjust"],"変爻完全":["transform","complete"],"変爻統合":["transform","integrate"]}[n]||["progress","continue"],"積極的"===e?"option_a":"option_b"]},downloadResults:function(){window.BinaryTreeCompleteDisplay.downloadResults&&window.BinaryTreeCompleteDisplay.downloadResults()},generateCurrentSituationAnalysis:function(n){if(console.log("🔍 Generating current situation analysis with I Ching diagnosis..."),!n.lineData)throw new Error("Line data is required");const e=n.lineData,t=e.卦名,a=e.爻,r=e.現代解釈||e.現代解釈の要約,i=e.キーワード,o=e.S1_基本スコア,s=n.userInput||window.latestUserInput||"";return`\n            <div style="display: grid; gap: 20px;">\n                \x3c!-- 卦・爻の診断結果 --\x3e\n                <div style="background: rgba(255,200,0,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #fbbf24; margin-bottom: 10px;">📖 易経による診断</h4>\n                    <p style="margin: 5px 0;"><strong>現在の卦:</strong> ${t}</p>\n                    <p style="margin: 5px 0;"><strong>爻の位置:</strong> ${a}</p>\n                    <p style="margin: 10px 0; line-height: 1.6;">${r}</p>\n                    <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.2);">\n                        <strong>基本スコア:</strong> ${o}点\n                    </div>\n                </div>\n                \n                \x3c!-- テーマ・キーワード特定 --\x3e\n                <div style="background: rgba(255,200,0,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #fbbf24; margin-bottom: 10px;">🎯 特定されたテーマ</h4>\n                    <p style="margin: 5px 0;"><strong>悩みの内容:</strong> ${s}</p>\n                    <p style="margin: 5px 0;"><strong>中心テーマ:</strong> ${this.identifyThemeFromWorry(s)}</p>\n                    <div style="margin-top: 15px;">\n                        <strong>重要キーワード:</strong>\n                        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">\n                            ${i.map(n=>`\n                                <span style="background: rgba(255,255,255,0.2); padding: 5px 12px; border-radius: 20px; font-size: 0.9em;">\n                                    ${n}\n                                </span>\n                            `).join("")}\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- 具体例：乾為天の初爻の場合 --\x3e\n                ${"乾為天"===t&&a.includes("初")?'\n                <div style="background: rgba(255,200,0,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #fbbf24; margin-bottom: 10px;">💡 具体例：乾為天・初九</h4>\n                    <p style="line-height: 1.6;">\n                        乾為天の初爻「潜龍勿用」は、まだ時機が来ていない龍の状態を表します。\n                        今は力を蓄え、準備を整える時期です。\n                    </p>\n                </div>\n                ':""}\n            </div>\n        `},generateProgressChangeExplanation:function(n){if(console.log("⚖️ Generating progress/change concept explanation..."),!n.lineData)throw new Error("Line data is required");const e=n.lineData,t=e.爻,a=e.卦名,r=this.calculateProgressState(a,t),i=this.calculateChangeState(a,t);return`\n            <div style="display: grid; gap: 20px;">\n                \x3c!-- 進爻の説明 --\x3e\n                <div style="background: rgba(34,197,94,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #22c55e; margin-bottom: 10px;">➡️ 進爻（テーマに従う）</h4>\n                    <p style="line-height: 1.6;">\n                        現在の${a}・${t}のテーマに従って進む選択です。\n                        自然な流れに沿って、現在の方向性を強化・発展させます。\n                    </p>\n                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">\n                        <strong>次の状態:</strong> ${r.nextHexagram}・${r.nextLine}\n                        <p style="margin: 5px 0; font-size: 0.9em;">${r.description}</p>\n                    </div>\n                </div>\n                \n                \x3c!-- 変爻の説明 --\x3e\n                <div style="background: rgba(34,197,94,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #22c55e; margin-bottom: 10px;">🔄 変爻（違う選択）</h4>\n                    <p style="line-height: 1.6;">\n                        現在の${a}・${t}とは異なる方向を選ぶ道です。\n                        爻の陰陽を変えることで、新しい卦への変化を生み出します。\n                    </p>\n                    <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;">\n                        <strong>次の状態:</strong> ${i.nextHexagram}・${i.nextLine}\n                        <p style="margin: 5px 0; font-size: 0.9em;">${i.description}</p>\n                    </div>\n                </div>\n                \n                \x3c!-- 選択の意味 --\x3e\n                <div style="background: rgba(34,197,94,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #22c55e; margin-bottom: 10px;">🤔 どちらを選ぶべきか</h4>\n                    <ul style="line-height: 1.8; margin: 0; padding-left: 20px;">\n                        <li><strong>進爻を選ぶ場合:</strong> 現在の流れを信じ、既存の強みを活かしたい時</li>\n                        <li><strong>変爻を選ぶ場合:</strong> 現状を打破し、新しい可能性を開きたい時</li>\n                    </ul>\n                </div>\n            </div>\n        `},generateThreePhaseProcess:function(n){if(console.log("📊 Generating three-phase process visualization..."),!n.lineData)throw new Error("Line data is required");const e=n.lineData,t=e.卦名,a=e.爻,r=this.buildThreePhaseProcess(t,a);return`\n            <div style="display: grid; gap: 20px;">\n                \x3c!-- フェーズ説明 --\x3e\n                <div style="background: rgba(59,130,246,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #3b82f6; margin-bottom: 10px;">📈 3段階の変化プロセス</h4>\n                    <p style="line-height: 1.6;">\n                        各段階で「進爻」か「変爻」を選択することで、2→4→8つの未来パスが生成されます。\n                    </p>\n                </div>\n                \n                \x3c!-- Phase 1 --\x3e\n                <div style="background: rgba(59,130,246,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #3b82f6; margin-bottom: 10px;">Phase 1: 初期選択（2分岐）</h4>\n                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">\n                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">\n                            <strong>🟢 進爻選択:</strong> ${r.phase1.progress.hexagram}・${r.phase1.progress.line}\n                            <p style="margin: 5px 0; font-size: 0.9em;">${r.phase1.progress.description}</p>\n                        </div>\n                        <div style="background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px;">\n                            <strong>🔄 変爻選択:</strong> ${r.phase1.change.hexagram}・${r.phase1.change.line}\n                            <p style="margin: 5px 0; font-size: 0.9em;">${r.phase1.change.description}</p>\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- Phase 2 --\x3e\n                <div style="background: rgba(59,130,246,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #3b82f6; margin-bottom: 10px;">Phase 2: 中間選択（4分岐）</h4>\n                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">\n                        ${r.phase2.map((n,e)=>`\n                            <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px;">\n                                <strong>${n.type}:</strong> ${n.hexagram}・${n.line}\n                                <p style="margin: 3px 0; font-size: 0.85em;">${n.description}</p>\n                            </div>\n                        `).join("")}\n                    </div>\n                </div>\n                \n                \x3c!-- Phase 3 --\x3e\n                <div style="background: rgba(59,130,246,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #3b82f6; margin-bottom: 10px;">Phase 3: 最終分岐（8パス）</h4>\n                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 15px;">\n                        ${r.phase3.map((n,e)=>`\n                            <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; text-align: center;">\n                                <strong>Path ${e+1}</strong>\n                                <p style="margin: 3px 0; font-size: 0.8em;">${n.hexagram}</p>\n                                <p style="margin: 0; font-size: 0.75em; opacity: 0.8;">${n.type}</p>\n                            </div>\n                        `).join("")}\n                    </div>\n                </div>\n                \n                \x3c!-- 具体例：乾為天の場合 --\x3e\n                ${"乾為天"===t?'\n                <div style="background: rgba(59,130,246,0.1); padding: 20px; border-radius: 12px;">\n                    <h4 style="color: #3b82f6; margin-bottom: 10px;">💡 乾為天の初爻→二爻への変化例</h4>\n                    <p style="line-height: 1.6;">\n                        乾為天・初九「潜龍勿用」から二爻「見龍在田」への進爻は、\n                        潜んでいた龍が地上に現れる自然な成長プロセスを表します。\n                        一方、変爻を選ぶと「坤為地」への転換となり、\n                        剛から柔への大きな方向転換を意味します。\n                    </p>\n                </div>\n                ':""}\n            </div>\n        `},identifyThemeFromWorry:function(n){const e={"仕事":["仕事","転職","キャリア","職場","昇進"],"人間関係":["人間関係","友人","家族","恋愛","パートナー"],"健康":["健康","病気","体調","ストレス","疲労"],"金銭":["お金","経済","収入","投資","財務"],"成長":["成長","学習","勉強","スキル","向上"],"決断":["選択","決断","迷い","判断","方向性"]};for(const[t,a]of Object.entries(e))if(a.some(e=>n.includes(e)))return t;return"人生の選択"},calculateProgressState:function(n,e){const t=this.getLinePosition(e);return{nextHexagram:n,nextLine:["初","二","三","四","五","上"][Math.min(t+1,6)-1]+"爻",description:`現在の${n}の流れに従い、次の段階へ自然に進化します。`}},calculateChangeState:function(n,e){if(window.H64_DATA){const t=window.H64_DATA.find(e=>e.名前===n);if(t){const n=t[["初爻変","二爻変","三爻変","四爻変","五爻変","上爻変"][this.getLinePosition(e)-1]],a=window.H64_DATA.find(e=>e.卦番号===n);if(a)return{nextHexagram:a.名前,nextLine:e,description:`爻の陰陽を変えることで、${a.名前}への転換を生み出します。`}}}return{nextHexagram:"変化卦",nextLine:e,description:"現在とは異なる新しい方向への転換を表します。"}},buildThreePhaseProcess:function(n,e){const t={progress:this.calculateProgressState(n,e),change:this.calculateChangeState(n,e)},a=[{type:"進爻→進爻",...this.calculateProgressState(t.progress.nextHexagram,t.progress.nextLine)},{type:"進爻→変爻",...this.calculateChangeState(t.progress.nextHexagram,t.progress.nextLine)},{type:"変爻→進爻",...this.calculateProgressState(t.change.nextHexagram,t.change.nextLine)},{type:"変爻→変爻",...this.calculateChangeState(t.change.nextHexagram,t.change.nextLine)}],r=[];for(let i=0;i<4;i++){const n=a[i];r.push({type:"進爻継続",hexagram:this.calculateProgressState(n.hexagram,n.line).nextHexagram},{type:"変爻転換",hexagram:this.calculateChangeState(n.hexagram,n.line).nextHexagram})}return{phase1:t,phase2:a,phase3:r}},integrateWithResultPageController:function(n){this.updateAnalysisSummary(n),console.log("🔗 Integrating with existing ResultPageController system...");try{if(window.ResultPageController){console.log("✅ ResultPageController found, initiating integration...");const e=this.convertToControllerFormat(n);(new window.ResultPageController).displayResults(e),console.log("✅ ResultPageController integration complete")}else console.log("⚠️ ResultPageController not available, using fallback graph system"),this.renderBranchingChart(n)}catch(e){console.error("❌ ResultPageController integration error:",e),console.log("🔄 Falling back to internal graph system"),this.renderBranchingChart(n)}},updateAnalysisSummary:function(n){console.log("📊 Updating analysis summary section with H384 data");const e=document.getElementById("currentHexagramInfo");if(e&&n.lineData){const t=n.lineData.hexagramName||n.lineData.卦名||"",a=n.lineData.lineName||n.lineData.爻||"";t&&a&&(e.textContent=`${t} - ${a}`,console.log(`✅ Updated currentHexagramInfo: ${t} - ${a}`))}const t=this.calculateSummaryMetrics(n),a=document.querySelector(".summary-option:nth-child(1) .option-description");a&&(a.textContent=t.reconciliation.description);const r=document.querySelector(".summary-option:nth-child(2) .option-description");r&&(r.textContent=t.unity.description);const i=document.querySelector(".summary-section:nth-child(2) .section-content");i&&(i.textContent=t.challenge.description),console.log("✅ Analysis summary updated with real data")},calculateSummaryMetrics:function(n){const e=n.finalEightPaths||[],t=[...e].sort((n,e)=>e.probability-n.probability)[0]||{},a=e.filter(n=>n.route&&(n.route.includes("adjust")||n.route.includes("integrate"))),r=e.filter(n=>n.route&&(n.route.includes("continue")||n.route.includes("progress"))),i=e.filter(n=>n.route&&(n.route.includes("transform")||n.route.includes("complete")));return{reconciliation:{description:a.length>0?`深刻な対立や困難を乗り越え、最終的に真の和解と協力関係を築く。${a[0]?.description||""}`:"現状を維持しつつ、内なる力を蓄える"},unity:{description:r.length>0?`深い苦しみの後に、最高の喜びと結束が訪れる。${r[0]?.description||""}`:"段階的な発展と成長を遂げる"},challenge:{description:i.length>0?`積極的に行動を起こし、主体的に状況を切り開いていくことが推奨されます。${t.practical_guidance||t.description||""}`:"慎重に状況を見極め、適切なタイミングを待つ"}}},convertToControllerFormat:function(n){console.log("🔄 Converting BinaryTree result to ResultPageController format..."),console.log("🔍 [DEBUG] Input result:",n),console.log("🔍 [DEBUG] result.lineData:",n.lineData),console.log("🔍 [DEBUG] result.finalEightPaths:",n.finalEightPaths);const e=n.finalEightPaths.map((e,t)=>{const a=t<4;let r=n.lineData?.S1_基本スコア||n.currentScore||65;("number"!=typeof r||isNaN(r))&&(r=65);let i,o,s=e.targetHexagram?.score||e.score;if("number"!=typeof s||isNaN(s)){if(a){s=[75,82,68,71][t]||r+10}else{s=[58,91,45,76][t-4]||r+20}s=Math.max(10,Math.min(100,s))}if(console.log(`🔍 [DEBUG] Scenario ${t+1}: baseScore=${r}, finalScore=${s}, isContinue=${a}`),console.log("🔍 [DEBUG] path.targetHexagram:",e.targetHexagram),console.log("🔍 [DEBUG] path.probability:",e.probability),a){const n=s-r;i=Math.round(r+.25*n),o=Math.round(r+.6*n)}else{const n=s-r;n>0?(i=Math.round(r+.15*n),o=Math.round(r+.45*n)):(i=Math.round(r+.4*n),o=Math.round(r+.7*n))}("number"!=typeof i||isNaN(i))&&(i=Math.round(r+.3*(s-r))),("number"!=typeof o||isNaN(o))&&(o=Math.round(r+.65*(s-r)));const l=Math.max(10,Math.min(100,i)),g=Math.max(10,Math.min(100,o));return console.log(`🔍 [DEBUG] Final scores for scenario ${t+1}: phase1=${l}, phase2=${g}, phase3=${s}`),{title:e.title||e.description||`第${t+1}の道`,description:e.description||e.fullDescription||"統合的な変化のパス",score:s,probability:e.probability||.125,phase1Score:l,phase2Score:g,phase3Score:s,hexagramInfo:{number:e.targetHexagram?.number||e.originalHexagram?.number||15,name:e.targetHexagram?.name||e.originalHexagram?.name||"",line:e.targetHexagram?.line||e.originalHexagram?.line||"六四",interpretation:e.targetHexagram?.interpretation||e.originalHexagram?.interpretation||"謙虚な協力",keywords:e.targetHexagram?.keywords||["協調","慎重","発展"],modernInterpretation:e.description||"現代的な視点での解釈"},route:e.route||["保守的","協調的","慎重"],transformationInfo:e.transformationInfo||{type:"進歩的変化",approach:"段階的",lineChange:"現状 → 発展",hexagramChange:"現在 → 未来"}}}),t={scenarios:e,overallScore:Math.round(e.reduce((n,e)=>n+e.score,0)/e.length),currentPosition:{hexagram:n.lineData?.卦名||"",line:n.lineData?.爻||"六四",interpretation:n.lineData?.現代解釈||n.lineData?.現代解釈の要約||"現在の安定した状況",keywords:n.lineData?.キーワード||["謙虚","協力","発展"],score:n.lineData?.S1_基本スコア||65},continuePaths:e.slice(0,4),transformPaths:e.slice(4,8),topPath:e.reduce((n,e)=>e.score>n.score?e:n,e[0]),timestamp:(new Date).toISOString(),analysisVersion:"2.1.0-h384-integrated",dataSource:"H384_DATABASE"};return console.log("✅ Conversion complete:",t),t},downloadResults:function(){window.BinaryTreeCompleteDisplay.downloadResults&&window.BinaryTreeCompleteDisplay.downloadResults()},analyzeTextToSelectHexagram:function(n){if(console.log("🔍 Starting genuine text to hexagram analysis..."),!n||n.trim().length<3)return console.warn("⚠️ Input text too short, using default"),{hexagramNumber:15,confidence:.3,reason:"insufficient_input"};const e=this.analyzeEmotionalContent(n),t=this.analyzeSituationalContext(n),a=this.analyzeKeywords(n);console.log("📊 Analysis results:",{emotionAnalysis:e,situationAnalysis:t,keywordAnalysis:a});const r=this.selectHexagramFromAnalysis(e,t,a);return console.log("☯️ Selected hexagram:",r),r},analyzeEmotionalContent:function(n){const e={positive:{patterns:/嬉しい|楽しい|幸せ|成功|達成|満足|希望|愛|喜び|感謝|充実/g,score:0},negative:{patterns:/悩み|困る|不安|心配|問題|悲しい|辛い|苦しい|失敗|恐れ|怒り|孤独/g,score:0},seeking:{patterns:/したい|欲しい|願う|望む|求める|目指す|変わりたい|成長|学び|挑戦/g,score:0}};Object.entries(e).forEach(([e,t])=>{const a=n.match(t.patterns)||[];t.score=a.length});const t=e.positive.score+e.negative.score+e.seeking.score;return t>0?{positive:e.positive.score/t,negative:e.negative.score/t,seeking:e.seeking.score/t}:{positive:.33,negative:.33,seeking:.34}},analyzeSituationalContext:function(n){const e={};Object.entries({work:/仕事|会社|職場|転職|キャリア|上司|部下|同僚|業務|プロジェクト|昇進/g,relationship:/恋愛|恋人|パートナー|結婚|夫婦|彼氏|彼女|片思い|別れ|復縁/g,family:/家族|両親|父|母|兄弟|姉妹|子供|家庭|親戚/g,health:/健康|病気|体調|医療|治療|運動|ダイエット|精神|心|ストレス/g,learning:/勉強|学習|教育|資格|試験|スキル|成長|知識|習得/g,finance:/お金|収入|支出|投資|貯金|借金|経済|財務|年収/g,personal:/自分|個人|性格|価値観|将来|人生|目標|夢|趣味/g}).forEach(([t,a])=>{const r=n.match(a)||[];e[t]=r.length});const t=Math.max(...Object.values(e));return{primary:Object.entries(e).find(([n,e])=>e===t)?.[0]||"personal",scores:e}},analyzeKeywords:function(n){const e={};return Object.entries({action:/行動|実行|始める|やめる|変える|挑戦|決断|選択|進む|戻る/g,stability:/安定|維持|継続|保つ|守る|現状|そのまま|変わらない/g,change:/変化|変わる|新しい|革新|改革|転換|移行|進歩|発展/g,conflict:/対立|争い|競争|戦い|反対|抵抗|衝突|摩擦/g,harmony:/調和|協力|協調|合意|理解|受容|平和|バランス/g,growth:/成長|発達|向上|改善|進歩|学習|習得|深まる/g}).forEach(([t,a])=>{const r=n.match(a)||[];e[t]=r.length}),e},selectHexagramFromAnalysis:function(n,e,t){console.log("🎯 Selecting hexagram from comprehensive analysis...");const a={work:{positive:{high_action:1,high_stability:11,high_growth:42},negative:{high_conflict:6,high_change:16,high_harmony:15},seeking:{high_action:25,high_growth:32,high_stability:23}},relationship:{positive:{high_harmony:31,high_growth:54,high_stability:37},negative:{high_conflict:43,high_change:28,high_harmony:61},seeking:{high_action:31,high_growth:44,high_stability:37}},personal:{positive:{high_growth:35,high_action:51,high_harmony:14},negative:{high_change:18,high_conflict:33,high_harmony:20},seeking:{high_action:3,high_growth:4,high_stability:52}},health:{positive:{high_stability:27,high_growth:48,high_harmony:50},negative:{high_change:23,high_conflict:36,high_harmony:48},seeking:{high_action:26,high_growth:27,high_stability:52}}},r=Object.entries(n).sort(([,n],[,e])=>e-n)[0][0],i=Object.entries(t).sort(([,n],[,e])=>e-n)[0][0],o=e.primary,s=r,l=`high_${i}`;let g=15,d=.5,c="default_selection";if(a[o]&&a[o][s]&&a[o][s][l])g=a[o][s][l],d=.85,c=`${o}_${s}_${i}`;else if(a[o]&&a[o][s]){const n=a[o][s];g=Object.values(n)[0],d=.7,c=`${o}_${s}_fallback`}return{hexagramNumber:g,confidence:d,reason:c,analysis:{situation:o,emotion:s,keyword:i,emotionScores:n,keywordScores:t}}},findAppropriateLineFromHexagram:function(n,e){if(console.log("📍 Finding appropriate line from hexagram:",n.hexagramNumber),!window.H384_DATA||0===window.H384_DATA.length)return console.error("❌ H384データベースが利用できません"),248;const t=window.H384_DATA.filter(e=>e.卦番号===n.hexagramNumber);if(0===t.length){console.warn(`⚠️ Hexagram ${n.hexagramNumber} not found, using closest match`);const e=[...new Set(window.H384_DATA.map(n=>n.卦番号))].reduce((e,t)=>Math.abs(t-n.hexagramNumber)<Math.abs(e-n.hexagramNumber)?t:e);return window.H384_DATA.find(n=>n.卦番号===e)?.通し番号||248}const a=n.analysis.emotionScores;let r;return r=a.negative>.6?t.find(n=>n.爻.includes("初")||n.爻.includes("二"))||t[0]:a.seeking>.5?t.find(n=>n.爻.includes("三")||n.爻.includes("四"))||t[Math.floor(t.length/2)]:a.positive>.5?t.find(n=>n.爻.includes("五")||n.爻.includes("上"))||t[t.length-1]:t.find(n=>n.爻.includes("三")||n.爻.includes("四"))||t[Math.floor(t.length/2)],console.log("✅ Selected line based on emotional analysis:",r.通し番号,r.爻),r.通し番号},generateTextBasedH384Result:function(n,e,t){console.log("🎨 Generating text-based H384 result (fallback mode)");const a=this.getActualH384Data(t),r=(this.getActualH64Data(e.hexagramNumber),this.generateContextualPaths(n,e,a));return{currentLine:t,lineData:a,finalEightPaths:r,branchingData:this.generateBranchingData(r),textAnalysis:e,analysisMode:"TEXT_BASED_FALLBACK"}},generateContextualPaths:function(n,e,t){console.log("🛤️ Generating contextual paths based on text analysis");const a=e.analysis.situation,r=e.analysis.emotionScores,i={work:{positive:["継続発展・積極型","継続発展・安定型","部分改善・革新型","部分改善・協調型","完全転換・挑戦型","完全転換・慎重型","統合創造・リーダー型","統合創造・チーム型"],negative:["現状維持・安全型","現状維持・改善型","段階修正・慎重型","段階修正・協力型","根本見直し・大胆型","根本見直し・計画型","新天地開拓・独立型","新天地開拓・協力型"],seeking:["スキル強化・専門型","スキル強化・総合型","ポジション変更・昇進型","ポジション変更・転職型","環境一新・転職型","環境一新・起業型","統合成長・マルチ型","統合成長・専門型"]},relationship:{positive:["関係深化・積極型","関係深化・自然型","相互成長・協力型","相互成長・独立型","新段階・進展型","新段階・安定型","統合発展・結合型","統合発展・成熟型"],negative:["関係修復・対話型","関係修復・時間型","距離調整・冷却型","距離調整・理解型","根本見直し・別離型","根本見直し・再構築型","新出発・独立型","新出発・新縁型"],seeking:["相互理解・深化型","相互理解・表現型","関係改善・歩み寄り型","関係改善・変化型","新しい関係・発展型","新しい関係・探求型","理想実現・創造型","理想実現・自然型"]}},o=Object.entries(r).sort(([,n],[,e])=>e-n)[0][0],s=(i[a]?.[o]||i.work.seeking).map((n,i)=>{const o=Math.floor(15*(i-4)),s=Math.max(1,Math.min(386,t.通し番号+o)),l=this.getActualH384Data(s);return{pathIndex:i+1,pathId:`contextual_${a}_${i}`,name:n,probability:this.calculateContextualProbability(i,r),currentLine:t.通し番号,targetLine:s,lineData:l,score:this.calculateContextualScore(l,e),keywords:l.キーワード||["進歩","調整","発展"],description:`${n}: ${l.現代解釈の要約||l.現代解釈}`.substring(0,100),hexagramTransformation:{from:{number:t.卦番号,name:t.卦名,yao:t.爻},to:{number:l.卦番号,name:l.卦名,yao:l.爻}},textAnalysisBased:!0}});return console.log("✅ Generated contextual paths:",s.length),s},calculateContextualProbability:function(n,e){const t=1.2*e.positive+1.1*e.seeking-.8*e.negative;return Math.max(.05,Math.min(.35,[.078,.117,.143,.214,.116,.173,.211,.316][n]*(1+.3*t)))},calculateContextualScore:function(n,e){const t=n.S1_基本スコア||65,a=20*e.confidence,r=10*(e.analysis.emotionScores.positive-e.analysis.emotionScores.negative);return Math.max(30,Math.min(95,Math.round(t+a+r)))}},"undefined"!=typeof window&&(window.BinaryTreeCompleteDisplay=BinaryTreeCompleteDisplay,console.log("✅ BinaryTreeCompleteDisplay exported to global scope")),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{console.log("🌳 Binary Tree Complete Display System v2.1 Ready")}):console.log("🌳 Binary Tree Complete Display System v2.1 Loaded");