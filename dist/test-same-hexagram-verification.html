<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>同一卦Engine-Safe全件検証</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff; 
        }
        .result { 
            margin: 5px 0; 
            padding: 5px; 
            border-radius: 3px;
        }
        .harmony { background: rgba(59, 130, 246, 0.2); }
        .tension { background: rgba(245, 158, 11, 0.2); }
        .conflict { background: rgba(239, 68, 68, 0.2); }
        .synergy { background: rgba(16, 185, 129, 0.2); }
        .anomaly { 
            border: 2px solid #ef4444; 
            background: rgba(239, 68, 68, 0.3);
        }
        .summary { 
            margin: 20px 0;
            padding: 15px;
            background: rgba(30, 41, 59, 0.8);
            border-radius: 8px;
        }
    </style>
</head>
<body>
    <h1>🔍 同一卦Engine-Safe全件検証</h1>
    <button onclick="verifyAllSameHexagrams()">64卦すべてを検証</button>
    <div id="results"></div>
    <div id="summary"></div>

    <script src="./assets/H384H64database.js"></script>
    <script src="./js/core/TripleOSInteractionAnalyzer.js"></script>
    <script>
        function verifyAllSameHexagrams() {
            const analyzer = new TripleOSInteractionAnalyzer();
            const results = [];
            const anomalies = [];
            
            console.log('開始: 64卦すべてのengine-safe同一卦検証');
            
            for (let i = 1; i <= 64; i++) {
                const engineOS = { hexagramId: i, name: `第${i}卦`, score: 0.5 };
                const safeModeOS = { hexagramId: i, name: `第${i}卦`, score: 0.5 };
                const interfaceOS = { hexagramId: 30, name: '第30卦', score: 0.5 }; // 固定値
                
                try {
                    const analysis = analyzer.analyze(engineOS, interfaceOS, safeModeOS);
                    const engineSafePair = analysis.interactions.pair_insights.find(pair => 
                        pair.pair === 'Engine-Safe'
                    );
                    
                    if (engineSafePair) {
                        const hexagram = H384H64database.find(h => h.id === i);
                        const result = {
                            id: i,
                            name: hexagram?.name || `第${i}卦`,
                            keywords: hexagram?.keywords || [],
                            category: engineSafePair.category,
                            summary: engineSafePair.summary,
                            synergy: engineSafePair.synergy
                        };
                        
                        results.push(result);
                        
                        // 異常判定: 調和系卦がTENSIONやCONFLICTになっているケース
                        const harmonicKeywords = ['調和', '協調', '安定', '平和', '受容性', '包容力', '柔軟性', '慈悲', '母性'];
                        const isHarmonic = result.keywords.some(k => harmonicKeywords.includes(k));
                        
                        if (isHarmonic && (result.category === 'TENSION' || result.category === 'CONFLICT')) {
                            anomalies.push({
                                ...result,
                                reason: `調和系キーワード [${result.keywords.filter(k => harmonicKeywords.includes(k)).join(', ')}] なのに ${result.category}`
                            });
                        }
                        
                        // 反対に、競争系卦がHARMONYになっているケースもチェック
                        const competitiveKeywords = ['競争', '争い', '闘争', '対立', '衝突'];
                        const isCompetitive = result.keywords.some(k => competitiveKeywords.includes(k));
                        
                        if (isCompetitive && result.category === 'HARMONY') {
                            anomalies.push({
                                ...result,
                                reason: `競争系キーワード [${result.keywords.filter(k => competitiveKeywords.includes(k)).join(', ')}] なのに ${result.category}`
                            });
                        }
                    }
                } catch (error) {
                    console.error(`第${i}卦の分析でエラー:`, error);
                    results.push({
                        id: i,
                        name: `第${i}卦`,
                        category: 'ERROR',
                        summary: error.message,
                        synergy: null
                    });
                }
            }
            
            displayResults(results, anomalies);
        }
        
        function displayResults(results, anomalies) {
            const resultHtml = results.map(result => {
                const isAnomaly = anomalies.find(a => a.id === result.id);
                const className = `result ${result.category.toLowerCase()} ${isAnomaly ? 'anomaly' : ''}`;
                
                return `
                    <div class="${className}">
                        <strong>${result.id}. ${result.name}</strong>
                        [${result.category}] (${result.synergy?.toFixed(3)})
                        <br>
                        ${result.summary}
                        ${isAnomaly ? `<br><span style="color: #ef4444">⚠️ 異常: ${isAnomaly.reason}</span>` : ''}
                        <br>
                        <small>キーワード: ${result.keywords.join(', ')}</small>
                    </div>
                `;
            }).join('');
            
            document.getElementById('results').innerHTML = resultHtml;
            
            // 統計サマリー
            const categoryCount = {};
            results.forEach(r => {
                categoryCount[r.category] = (categoryCount[r.category] || 0) + 1;
            });
            
            const summaryHtml = `
                <div class="summary">
                    <h3>📊 検証結果サマリー</h3>
                    <p><strong>検証対象:</strong> 64卦すべてのengine-safe同一卦ペア</p>
                    <p><strong>異常ケース:</strong> ${anomalies.length}件</p>
                    
                    <h4>カテゴリ分布:</h4>
                    ${Object.entries(categoryCount).map(([cat, count]) => 
                        `<p>${cat}: ${count}件 (${(count/64*100).toFixed(1)}%)</p>`
                    ).join('')}
                    
                    ${anomalies.length > 0 ? `
                        <h4>🚨 発見された異常ケース:</h4>
                        ${anomalies.map(anomaly => `
                            <p style="color: #ef4444">
                                <strong>${anomaly.id}. ${anomaly.name}</strong>: ${anomaly.reason}
                            </p>
                        `).join('')}
                    ` : '<p style="color: #10b981">✅ 異常ケースはありませんでした</p>'}
                </div>
            `;
            
            document.getElementById('summary').innerHTML = summaryHtml;
            
            console.log('検証完了:', {
                total: results.length,
                anomalies: anomalies.length,
                categories: categoryCount
            });
        }
    </script>
</body>
</html>