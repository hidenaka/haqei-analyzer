<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    
    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆä¼æ¥­ãƒ¬ãƒ™ãƒ«ï¼‰ -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <!-- X-Frame-Options removed - can only be set via HTTP header -->
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    <meta name="csrf-token" content="">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data:; connect-src 'self'; font-src 'self'; object-src 'none'; media-src 'self'; frame-src 'none';">
    
    <title>HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</title>
    <meta name="description" content="æœªæ¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ - I Chingï¼ˆæ˜“çµŒï¼‰ã¨äººæ ¼OSã‚’ä½¿ã£ãŸåˆ†æãƒ„ãƒ¼ãƒ«ã€‚bunenjinå“²å­¦ã«åŸºã¥ã„ãŸæ„æ€æ±ºå®šæ”¯æ´ã‚·ã‚¹ãƒ†ãƒ ã€‚">
    <link
      rel="icon"
      href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>æ˜“</text></svg>"
    />
    
    <!-- ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒç”¨è¨­å®šï¼ˆæœ€å„ªå…ˆï¼‰ -->
    <script src="./js/future_simulator_local_dev_config.js"></script>
    
    <!-- Future Simulator Core - å‹•ä½œç¢ºå®Ÿç‰ˆ -->
    <script src="./js/future-simulator-core.js"></script>
    
    <!-- Phase 2: Text-to-I Ching Integration -->
    <script src="./js/pages/future-simulator/TextToIChingEngine.js"></script>
    <script src="./js/pages/future-simulator/IChingResultsDisplay.js"></script>
    
    <!-- Phase 3: 8 Scenarios Display System -->
    <script src="./js/pages/future-simulator/EightScenariosGenerator.js"></script>
    <script src="./js/pages/future-simulator/ScenariosDisplayUI.js"></script>
    <script src="./js/pages/future-simulator/scenario-animations.js"></script>
    <script src="./js/pages/future-simulator/Phase3IntegrationController.js"></script>
    
    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒªï¼ˆæœ€å„ªå…ˆèª­ã¿è¾¼ã¿ï¼‰ -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" 
            crossorigin="anonymous"
            integrity="sha384-vdScihEZCfbPnBQf+lc7LgXUdJVYyhC3yWHUW5C5P5GpHRqVnaM6HJELJxT6IqwM"></script>
    
    <!-- Load critical path scripts -->
    <link href="./css/tailwind.css" rel="stylesheet">
    
    <!-- Quick fix styles for working version -->
    <link href="./css/future-simulator-quick-fix.css" rel="stylesheet">
    
    <!-- Defer non-critical scripts -->
    <script src="./js/lib/chart.min.js" defer></script>
    <script src="./js/lib/chartjs-plugin-annotation.min.js" defer></script>
    
    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæœ€å„ªå…ˆèª­ã¿è¾¼ã¿ï¼‰ -->
    <script src="./js/security/SecurityHeaderManager.js"></script>
    <script src="./js/security/DOMPurifyIntegration.js"></script>
    <script src="./js/security/CSRFProtectionSystem.js"></script>
    <script src="./js/security/InputValidationSystem.js"></script>
    
    <!-- Quality Enhancement System -->
    <link rel="stylesheet" href="./css/quality-grade-enhancement.css">
    <!-- ä»¥ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨é–‹ç™ºä¸­ã®ãŸã‚ä¸€æ™‚çš„ã«ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ -->
    <!-- <script src="./js/quality-enhancement-ui.js" defer></script> -->
    <!-- <script src="./js/dynamic-quality-optimizer.js" defer></script> -->
    <!-- <script src="./js/quality-integration-manager.js" defer></script> -->
    <!-- <script src="./js/quality-system-validator.js" defer></script> -->
    
    <!-- Future Simulator v2.0 CSS -->
    <link rel="stylesheet" href="./css/future-simulator-v2.css.min.css">
    
    <!-- Phase 3: 8 Scenarios Display Styles -->
    <link rel="stylesheet" href="./css/phase3-scenarios-styles.css">
    
    <!-- UI/UX Enhancement System -->
    <link rel="stylesheet" href="./css/ui-enhancements.css">
    <script src="./js/core/ProgressiveLoadingManager.js" defer></script>
    <script src="./js/core/UserErrorManager.js" defer></script>
    <script src="./js/core/ResponsiveEnhancementManager.js" defer></script>
    
    <!-- bunenjin Philosophy Systems (Core Implementation) -->
    <script src="./js/bunenjin/ContradictionAcceptanceSystem.js"></script>
    <script src="./js/bunenjin/DynamicBunenjinSystem.js"></script>
    <script src="./js/bunenjin/IntegratedGuidanceSystem.js"></script>
    <script src="./js/bunenjin/BunenjinValidationSystem.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap"
      rel="stylesheet"
    />
    <style>
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
      }
      
      /* Enhanced Progressive Loading Styles */
      .skeleton {
        background: linear-gradient(90deg, rgba(55, 65, 81, 0.1) 25%, rgba(75, 85, 99, 0.2) 37%, rgba(55, 65, 81, 0.1) 63%);
        background-size: 400% 100%;
        animation: skeleton-loading 1.5s ease-in-out infinite;
      }
      
      @keyframes skeleton-loading {
        0% { background-position: 100% 50%; }
        100% { background-position: 0% 50%; }
      }
      
      .skeleton-text {
        height: 1em;
        border-radius: 4px;
        margin: 0.5em 0;
      }
      
      .skeleton-button {
        height: 3em;
        border-radius: 8px;
        width: 100%;
      }
      
      .skeleton-card {
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .skeleton-chart {
        height: 300px;
        border-radius: 8px;
      }
      
      .fade-in {
        animation: fadeIn 0.6s ease-in-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }
      
      .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(17, 24, 39, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        transition: opacity 0.3s ease;
        backdrop-filter: blur(10px);
      }
      
      .loading-content {
        text-align: center;
        max-width: 400px;
        padding: 2rem;
        background: rgba(30, 41, 59, 0.8);
        border-radius: 16px;
        border: 1px solid rgba(99, 102, 241, 0.3);
      }
      
      .loading-spinner {
        width: 48px;
        height: 48px;
        border: 4px solid rgba(165, 180, 252, 0.3);
        border-left: 4px solid #a5b4fc;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
      }
      
      .loading-text {
        color: #a5b4fc;
        font-size: 1.125rem;
        font-weight: 600;
        margin-bottom: 1rem;
      }
      
      .progress-container {
        margin-top: 1rem;
      }
      
      .progress-bar {
        width: 100%;
        height: 8px;
        background: rgba(55, 65, 81, 0.5);
        border-radius: 4px;
        overflow: hidden;
        margin-bottom: 0.5rem;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #a855f7);
        border-radius: 4px;
        transition: width 0.3s ease;
        position: relative;
      }
      
      .progress-percentage {
        color: #cbd5e1;
        font-size: 0.875rem;
        text-align: center;
      }
      
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
      
      /* Enhanced Mobile Optimizations */
      @media (max-width: 768px) {
        .loading-content {
          margin: 1rem;
          padding: 1.5rem;
        }
        
        .loading-text {
          font-size: 1rem;
        }
      }
      
      /* Accessibility Enhancements */
      @media (prefers-reduced-motion: reduce) {
        .skeleton {
          animation: none;
        }
        
        .loading-spinner {
          animation: none;
          border-left-color: rgba(165, 180, 252, 0.8);
        }
        
        .fade-in {
          animation: none;
        }
      }
      
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
      }
      
      .card {
        transition: all 0.3s ease-in-out;
        cursor: pointer;
      }
      .card:hover,
      .card.highlighted {
        transform: scale(1.03);
        box-shadow: 0 0 30px rgba(165, 180, 252, 0.4);
      }
      .rank-badge {
        font-size: 0.75rem;
        font-weight: bold;
        padding: 2px 8px;
        border-radius: 9999px;
        line-height: 1;
      }
      .rank-s,
      .rank-a,
      .rank-b,
      .rank-c {
        background-color: rgba(74, 222, 128, 0.2);
        color: #86efac;
        border: 1px solid #22c55e;
      }
      .rank-d {
        background-color: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #fbbf24;
      }
      .rank-e,
      .rank-f,
      .rank-g {
        background-color: rgba(248, 113, 113, 0.2);
        color: #fca5a5;
        border: 1px solid #f87171;
      }
      .rank-h {
        background-color: rgba(185, 28, 28, 0.2);
        color: #fca5a5;
        border: 1px solid #dc2626;
      }

      /* Data Export Styles */
      .data-export-section {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }
      
      .export-button {
        background: linear-gradient(45deg, #3b82f6, #6366f1);
        transition: all 0.3s ease;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        display: flex;
        items: center;
        gap: 0.5rem;
        border: none;
        cursor: pointer;
      }
      
      .export-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
      }
      
      .progressive-load {
        opacity: 0;
        transform: translateY(20px);
        transition: all 0.6s ease;
      }
      
      .progressive-load.loaded {
        opacity: 1;
        transform: translateY(0);
      }

      /* ğŸŒŸ Authentic I Ching System Styles */
      .authentic-scenarios-container,
      .authentic-choice-container,
      .current-position-container {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(99, 102, 241, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        margin: 1rem 0;
      }

      .scenario-card, .choice-card {
        background: rgba(17, 24, 39, 0.8);
        border: 1px solid rgba(75, 85, 99, 0.5);
        border-radius: 8px;
        padding: 1.5rem;
        margin: 1rem 0;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .scenario-card:hover, .choice-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        border-color: rgba(99, 102, 241, 0.7);
      }

      .scenario-card.selected, .choice-card.selected {
        border-color: #6366f1;
        background: rgba(99, 102, 241, 0.2);
      }

      .hexagram-line {
        display: flex;
        align-items: center;
        margin: 0.25rem 0;
        font-family: monospace;
      }

      .hexagram-line.yang .line-symbol {
        color: #fbbf24;
      }

      .hexagram-line.yin .line-symbol {
        color: #93c5fd;
      }

      .hexagram-line.current {
        background: rgba(245, 101, 101, 0.2);
        border-radius: 4px;
        padding: 0.25rem;
      }

      .transformation-visual {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin: 1rem 0;
      }

      .transformation-arrow {
        font-size: 1.5rem;
        color: #6366f1;
        margin: 0 1rem;
      }

      .bunenjin-analysis .persona-analysis {
        background: rgba(31, 41, 55, 0.5);
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
      }

      .fade-in {
        opacity: 0;
        animation: fadeInUp 0.6s ease forwards;
      }

      .fade-in.visible {
        opacity: 1;
      }

      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(20px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      
      /* Phase 6-10 Enhancement Styles */
      .choice-selected {
        border-color: #10b981 !important;
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.3)) !important;
        transform: scale(1.02) !important;
      }
      
      .animate-fade-in {
        animation: fadeIn 0.3s ease-in-out;
      }
      
      .animate-slide-up {
        animation: slideUp 0.3s ease-out;
      }
      
      @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
      }
      
      @keyframes slideUp {
        from { 
          opacity: 0; 
          transform: translate(-50%, 20px); 
        }
        to { 
          opacity: 1; 
          transform: translate(-50%, 0); 
        }
      }
      
      #char-counter {
        transition: color 0.3s ease;
      }
      
      .export-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.3);
      }
      
      .export-button:active {
        transform: translateY(0);
      }
      
      /* Input validation styles */
      .input-valid {
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
      }
      
      .input-invalid {
        border-color: #ef4444;
        box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
      }
      
      /* Loading state improvements */
      .loading button {
        pointer-events: none;
        opacity: 0.7;
      }
      
      /* Scenario generation animations */
      .scenario-card {
        transition: all 0.3s ease;
      }
      
      .scenario-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 32px rgba(99, 102, 241, 0.2);
      }
      
      /* Progress indicators */
      .progress-indicator {
        width: 100%;
        height: 4px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 2px;
        overflow: hidden;
      }
      
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #6366f1, #8b5cf6, #06b6d4);
        border-radius: 2px;
        transition: width 0.3s ease;
      }
    </style>
    
    <!-- Core System Assets - æœ€é©åŒ–èª­ã¿è¾¼ã¿é †åº -->
    <script src="./assets/H384H64database.js"></script>
    <script src="./js/core/PerformanceOptimizer.js"></script>
    <script src="./js/core/IChingTransformationEngine.js"></script>
    <script src="./js/core/FutureBranchingSystem.js"></script>
    <script src="./js/core/DataPersistenceManager.js"></script>
    <script src="./js/core/DataExportAPI.js"></script>
    
    <!-- H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèª -->
    <script>
        (function() {
            console.log('ğŸ” H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèªã‚’é–‹å§‹...');
            
            if (typeof H384_DATA === 'undefined') {
                console.error('âŒ H384_DATAå¤‰æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                console.warn('âš ï¸  ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚’è©¦è¡Œä¸­...');
                
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: window.H384_DATAã‚’ç¢ºèª
                if (typeof window.H384_DATA !== 'undefined') {
                    console.log('âœ… window.H384_DATAã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æˆåŠŸ');
                    window.H384_DATA = window.H384_DATA;
                } else {
                    console.error('âŒ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ã‚‚åˆ©ç”¨ã§ãã¾ã›ã‚“');
                }
            } else {
                console.log('âœ… H384_DATAå¤‰æ•°ã®å­˜åœ¨ç¢ºèª: æˆåŠŸ');
                
                // window.H384_DATAã¸ã®ä»£å…¥ç¢ºèª
                if (typeof window.H384_DATA === 'undefined') {
                    console.warn('âš ï¸  window.H384_DATAãŒæœªè¨­å®š - è‡ªå‹•è¨­å®šã‚’è©¦è¡Œ');
                    try {
                        window.H384_DATA = H384_DATA;
                        console.log('âœ… window.H384_DATAè‡ªå‹•è¨­å®š: æˆåŠŸ');
                    } catch (error) {
                        console.error('âŒ window.H384_DATAè¨­å®šã‚¨ãƒ©ãƒ¼:', error);
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ã®åŸºæœ¬ç¢ºèª
                if (Array.isArray(window.H384_DATA) && window.H384_DATA.length === 386) {
                    console.log('âœ… H384_DATAãƒ‡ãƒ¼ã‚¿å®Œå…¨æ€§ç¢ºèª: æˆåŠŸ (386ã‚¨ãƒ³ãƒˆãƒª)');
                    
                    // ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã®ç¢ºèª
                    const youkuu = window.H384_DATA.find(item => item['é€šã—ç•ªå·'] === 7);
                    const yourikuu = window.H384_DATA.find(item => item['é€šã—ç•ªå·'] === 14);
                    
                    if (youkuu && yourikuu) {
                        console.log('âœ… ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªç¢ºèª: æˆåŠŸ');
                        console.log(`   - ç”¨ä¹: ${youkuu['å¦å']} (${youkuu['çˆ»']})`);
                        console.log(`   - ç”¨å…­: ${yourikuu['å¦å']} (${yourikuu['çˆ»']})`);
                    } else {
                        console.warn('âš ï¸  ç”¨ä¹ãƒ»ç”¨å…­ã‚¨ãƒ³ãƒˆãƒªã«å•é¡ŒãŒã‚ã‚Šã¾ã™');
                    }
                } else {
                    console.error('âŒ H384_DATAãƒ‡ãƒ¼ã‚¿å½¢å¼ã‚¨ãƒ©ãƒ¼:', {
                        isArray: Array.isArray(window.H384_DATA),
                        length: window.H384_DATA?.length
                    });
                }
            }
            
            console.log('ğŸ H384_DATAèª­ã¿è¾¼ã¿é †åºç¢ºèªå®Œäº†');
        })();
    </script>
    <script src="./js/keyword_expansion_engine.js"></script>
    <script src="./js/ml-integration.js" async defer></script>
    <!-- Offline-First Dictionary System -->
    <script src="./js/core/DictionaryManager.js" defer></script>
    <script src="./js/core/OfflineDetector.js" defer></script>
    <script src="./js/core/OfflineKuromojiInitializer.js" defer></script>
    <script src="./js/core/offline-kuromoji-integration.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js" defer></script>
    <!-- Advanced Analysis Dependencies -->
    <script src="./js/lib/ml-matrix.min.js"></script>
    <!-- Dynamic Analysis Components -->
    <script src="./js/pages/future-simulator/DynamicKeywordGenerator.js"></script>
    <script src="./js/pages/future-simulator/IntegratedAnalysisEngine.js"></script>
    <script src="./js/pages/future-simulator/MultiDimensionalContextAnalyzer.js"></script>
    <script src="./js/pages/future-simulator/SituationalContextEngine.js"></script>
    <script src="./js/pages/future-simulator/HexagramMappingEngine.js"></script>
    <script src="./js/pages/future-simulator/MetaphorGenerationEngine.js"></script>
    
    <!-- ğŸŒŸ Authentic I Ching System Components -->
    <script src="./js/core/AuthenticIChingEngine.js"></script>
    <script src="./js/components/CurrentPositionDisplay.js"></script>
    <script src="./js/components/AuthenticChoiceSystem.js"></script>
    <script src="./js/components/Authentic8ScenariosSystem.js"></script>
    
    <!-- Future Simulator UI Enhancement System -->
    <script src="./js/future-simulator-ui-enhancements.js" defer></script>
    
    <!-- Phase 2: Complete Text-to-I Ching System -->
    <link rel="stylesheet" href="./css/phase2-iching-styles.css">
    <script src="./js/pages/future-simulator/DynamicKeywordGenerator.js"></script>
    <script src="./js/pages/future-simulator/IntegratedAnalysisEngine.js"></script>
  </head>
  <body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-6" data-progressive-load>
    <!-- Initial Loading Screen -->
    <div id="initial-loading" class="loading-overlay" role="status" aria-live="polite">
      <div class="loading-content">
        <div class="loading-spinner" aria-hidden="true"></div>
        <h1 class="text-2xl font-bold brand-text mb-2">HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</h1>
        <div class="loading-text" id="initial-loading-text">ã‚·ã‚¹ãƒ†ãƒ ã‚’åˆæœŸåŒ–ä¸­...</div>
        <div class="progress-container">
          <div class="progress-bar">
            <div id="initial-loading-progress" class="progress-fill" style="width: 0%" 
                 role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
          </div>
          <div class="progress-percentage" id="initial-loading-percentage">0%</div>
        </div>
      </div>
    </div>
    
    <div
      class="w-full max-w-7xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-8 opacity-0"
      id="main-container"
    >
      <header class="text-center mb-8 relative">
        <a href="./" class="inline-block">
          <h1 class="text-3xl sm:text-4xl font-bold brand-text tracking-wider">
            HaQei
          </h1>
          <p class="text-gray-400 mt-2 text-lg">ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</p>
        </a>
        <button
          id="helpBtn"
          class="absolute top-0 right-0 p-2 text-gray-400 hover:text-white transition-colors"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.79 4 4 0 .863-.27 1.66-.744 2.25l-2.536 2.39c-.832.786-1.464 1.49-1.464 2.36h.001M12 18h.01"
            />
          </svg>
        </button>
      </header>

      <!-- Input Section with Skeleton -->      
      <div class="bg-gray-900/50 p-6 rounded-xl mb-4 relative progressive-load" id="input-section">
        <!-- Skeleton for Input Section -->
        <div class="skeleton-input" id="input-skeleton">
          <div class="skeleton skeleton-text" style="width: 60%; height: 1.5rem; margin-bottom: 1rem;"></div>
          <div class="skeleton skeleton-card">
            <div class="skeleton skeleton-text" style="width: 100%; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text" style="width: 80%; margin-bottom: 0.5rem;"></div>
            <div class="skeleton skeleton-text" style="width: 90%;"></div>
          </div>
          <div class="skeleton skeleton-text" style="width: 100%; height: 4rem; margin: 1rem 0;"></div>
          <div class="skeleton skeleton-button"></div>
        </div>
        
        <!-- Actual Input Content -->
        <div class="input-content" id="input-content" style="display: none;">
          <h2 class="text-lg font-bold text-indigo-300 mb-3">
            1. AIã«ã‚ˆã‚‹çŠ¶æ³æ¨æ¸¬
          </h2>
        <div
          class="border border-gray-700 rounded-lg p-4 mb-4 text-sm text-gray-300 space-y-3"
        >
          <p class="text-base font-bold text-center text-indigo-300">
            AIã¸ã®æœ€é«˜ã®ã€Œå‘ªæ–‡ã€ã¯ã€ã‚ãªãŸã®ã€Œã‚ã‚Šã®ã¾ã¾ã®è¨€è‘‰ã€ã§ã™
          </p>
          <p class="text-xs text-center text-gray-400">
            æœªæ¥åˆ†å²å›³ã®ç²¾åº¦ã‚’é«˜ã‚ã‚‹ã€ãŸã£ãŸä¸€ã¤ã®ç§˜è¨£
          </p>
          <p>
            ã“ã‚Œã‹ã‚‰ã€ã‚ãªãŸã®ç¾çŠ¶ã¨èª²é¡Œã‚’AIã«å…¥åŠ›ã—ã¦ã„ãŸã ãã¾ã™ã€‚ãã®éš›ã€ã©ã†ã‹<strong>ã€Œä¸Šæ‰‹ãªæ–‡ç« ã‚’æ›¸ã“ã†ã€ã¨ã—ãªã„ã§ãã ã•ã„ã€‚</strong>AIã¯ã€æ•´ãˆã‚‰ã‚ŒãŸæ–‡ç« ã‚ˆã‚Šã‚‚ã€ã‚ãªãŸã®<strong>ã€Œç”Ÿã®è¨€è‘‰ã€</strong>ã‚’æ±‚ã‚ã¦ã„ã¾ã™ã€‚
          </p>
          <p>
            ç®‡æ¡æ›¸ãã§ã‚‚ã€å¿ƒã®ã¤ã¶ã‚„ãã§ã‚‚ã€èª°ã‹ã«æ„šç—´ã‚’ã“ã¼ã™ã‚ˆã†ãªè¨€è‘‰ã§ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚ä»–äººã«è¦‹ã›ã‚‹ãŸã‚ã®æ–‡ç« ã§ã¯ãªãã€<strong>ã‚ãªãŸè‡ªèº«ã®ãŸã‚ã®ã€Œæ€è€ƒã®ãƒ¡ãƒ¢ã€</strong>ã¨ã—ã¦ã€ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚
          </p>
          <p>
            ãªãœãªã‚‰ã€AIã¯ã‚ãªãŸãŒé¸ã¶ä¸€ã¤ä¸€ã¤ã®å˜èªã€è¡¨ç¾ã®æºã‚Œã€æ„Ÿæƒ…ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ã‹ã‚‰ã€ã‚ãªãŸã ã‘ã®ã€Œæ€è€ƒã®ã‚¯ã‚»ã€ã‚„ã€Œå¿ƒã®å‹•ãã€ã‚’èª­ã¿å–ã‚‹ã‹ã‚‰ã§ã™ã€‚
          </p>
          <div class="pt-2">
            <p class="font-bold text-gray-200">ã€å…¥åŠ›ã®ãƒ’ãƒ³ãƒˆã€‘</p>
            <div
              class="mt-2 p-3 rounded-lg bg-red-900/20 border border-red-800/50"
            >
              <p class="font-bold">æ‚ªã„ä¾‹ âŒ</p>
              <p class="text-xs italic mt-1">
                ã€Œæ–°è¦ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã«ãŠã„ã¦ã€äººçš„ãƒªã‚½ãƒ¼ã‚¹ã®ä¸è¶³ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã¨ãªã‚Šã€è¨ˆç”»ã«é…å»¶ãŒç”Ÿã˜ã¦ã„ã¾ã™ã€‚ã€
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ï¼ˆã“ã‚Œã§ã¯ã€AIã¯ä¸€èˆ¬çš„ãªãƒ“ã‚¸ãƒã‚¹èª²é¡Œã¨ã—ã¦ã—ã‹åˆ†æã§ãã¾ã›ã‚“ï¼‰
              </p>
            </div>
            <div
              class="mt-2 p-3 rounded-lg bg-emerald-900/20 border border-emerald-800/50"
            >
              <p class="font-bold">è‰¯ã„ä¾‹ â­•</p>
              <p class="text-xs italic mt-1">
                ã€Œæ–°ã—ã„ä»•äº‹ã€ãƒã‚¸ã§äººè¶³ã‚Šã¦ãªã„ï¼Aã•ã‚“ã¯é ‘å¼µã£ã¦ãã‚Œã¦ã‚‹ã‘ã©ã€Bã•ã‚“ã¯å…¨ç„¶ã‚„ã‚‹æ°—ãªã„ã—â€¦ã€‚ã“ã®ã¾ã¾ã ã¨çµ¶å¯¾é–“ã«åˆã‚ãªã„ã€‚ã©ã†ã™ã‚Šã‚ƒã„ã„ã‚“ã â€¦ã€‚ç„¦ã‚‹ã€‚ã€
              </p>
              <p class="text-xs text-gray-400 mt-1">
                ï¼ˆã“ã®æ–¹ãŒã€ã‚ãªãŸã®æ„Ÿæƒ…ã€äººé–“é–¢ä¿‚ã¸ã®èªè­˜ã€åˆ‡è¿«æ„ŸãŒä¼ã‚ã‚Šã€ã‚ˆã‚Šãƒ‘ãƒ¼ã‚½ãƒŠãƒ©ã‚¤ã‚ºã•ã‚ŒãŸåˆ†æãŒå¯èƒ½ã«ãªã‚Šã¾ã™ï¼‰
              </p>
            </div>
          </div>
          <p class="font-bold text-center pt-2">
            ã‚ãªãŸã®ã€Œã‚ã‚Šã®ã¾ã¾ã®è¨€è‘‰ã€ã“ããŒã€ã‚ãªãŸã ã‘ã®æœªæ¥ã‚’èª­ã¿è§£ãã€æœ€ã‚‚å¼·åŠ›ãªéµã¨ãªã‚Šã¾ã™ã€‚<br />ã©ã†ãã€ã‚ãªãŸã®å¿ƒã‚’ãã®ã¾ã¾ã€AIã«ã¶ã¤ã‘ã¦ã¿ã¦ãã ã•ã„ã€‚
          </p>
        </div>
        
        <!-- ã‚ãªãŸã®æœªæ¥ã‚’èª­ã¿è§£ãã¾ã™ -->
        <div class="mb-6 text-center">
          <h3 class="text-xl font-bold text-indigo-300 mb-2">
            âœ¨ ã‚ãªãŸã®æœªæ¥ã‚’èª­ã¿è§£ãã¾ã™
          </h3>
          <p class="text-sm text-gray-400">
            å¤å…¸æ˜“çµŒã®æ™ºæ…§ã§ã€8ã¤ã®å¯èƒ½æ€§ã‚’æ¢ã£ã¦ã¿ã¾ã—ã‚‡ã†
          </p>
        </div>
        
        <!-- å…¥åŠ›ä¾‹ã¨ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹å¼·åŒ– -->
        <div class="mb-4">
          <div class="mb-3">
            <label for="worryInput" class="block text-sm font-medium text-indigo-300 mb-2">
              ğŸ’­ ã‚ãªãŸã®ç¾çŠ¶ã‚„æ‚©ã¿ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„
            </label>
            <div class="text-xs text-gray-400 mb-2">
              <span class="inline-flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                </svg>
                å…¥åŠ›ä¾‹ï¼šã€Œä»•äº‹ãŒã†ã¾ãã„ã‹ãªã„ã€ã€Œäººé–“é–¢ä¿‚ã§æ‚©ã‚“ã§ã„ã‚‹ã€ã€Œå°†æ¥ãŒä¸å®‰ã€ãªã©
              </span>
            </div>
          </div>
          
          <textarea
            id="worryInput"
            class="bg-gray-700 border border-gray-600 text-white text-base rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block w-full p-4 mb-4 transition-all duration-200 resize-none"
            rows="5"
            placeholder="ä¾‹ï¼šæœ€è¿‘è»¢è·ã‚’è€ƒãˆã¦ã„ã‚‹ã‚“ã ã‘ã©ã€ä»Šã®ä¼šç¤¾ã‚’è¾ã‚ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒã‚ã‹ã‚‰ãªã„ã€‚å¹´é½¢çš„ã«ã‚‚ä¸å®‰ã ã—ã€å®¶æ—ã®ã“ã¨ã‚‚è€ƒãˆã‚‹ã¨...ã§ã‚‚ä»Šã®ã¾ã¾ã˜ã‚ƒãƒ€ãƒ¡ãªæ°—ãŒã—ã¦ã€‚ã©ã†ã—ãŸã‚‰ã„ã„ã‚“ã ã‚ã†ã€‚"
            maxlength="1000"
          ></textarea>
          
          <!-- æ–‡å­—ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã¨å…¥åŠ›ãƒ’ãƒ³ãƒˆ -->
          <div class="flex justify-between items-center text-xs text-gray-400 mb-2">
            <div class="flex items-center gap-4">
              <span id="charCount" class="text-gray-500">0/1000æ–‡å­—</span>
              <span class="text-green-400">âœ“ æ„Ÿæƒ…ã‚„å…·ä½“çš„ãªçŠ¶æ³ã‚’å«ã‚ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™</span>
            </div>
            <button type="button" id="clearInput" class="text-red-400 hover:text-red-300 underline hidden">ã‚¯ãƒªã‚¢</button>
          </div>
          
          <!-- ãƒ—ãƒªã‚»ãƒƒãƒˆä¾‹æ–‡ãƒœã‚¿ãƒ³ -->
          <div class="mb-4">
            <p class="text-xs font-medium text-gray-400 mb-2">ğŸ’¡ æ›¸ãã®ãŒé›£ã—ã„å ´åˆã¯ã€ä¾‹æ–‡ã‚’é¸ã‚“ã§ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚ºã—ã¦ãã ã•ã„ï¼š</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
              <button type="button" class="preset-example text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded border border-gray-500/50 hover:border-gray-400 transition-colors text-left" data-example="ä»•äº‹ã§ã®ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼ãŒãã¤ãã¦ã€æ¯æ—¥æ®‹æ¥­ç¶šãã€‚ä¸Šå¸ã¨ã®é–¢ä¿‚ã‚‚ã†ã¾ãã„ã‹ãªã„ã—ã€ã“ã®ã¾ã¾ã§ã„ã„ã®ã‹ä¸å®‰ã«ãªã£ã¦ã‚‹ã€‚">
                ğŸ¢ ä»•äº‹ãƒ»ã‚­ãƒ£ãƒªã‚¢
              </button>
              <button type="button" class="preset-example text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded border border-gray-500/50 hover:border-gray-400 transition-colors text-left" data-example="æ‹äººã¨ã®é–¢ä¿‚ãŒã†ã¾ãã„ã‹ãªã„ã€‚æœ€è¿‘å–§å˜©ãŒå¤šãã¦ã€æ°—æŒã¡ãŒã™ã‚Œé•ã£ã¦ã‚‹æ„Ÿã˜ãŒã™ã‚‹ã€‚ã“ã®ã¾ã¾ç¶šã‘ã¦ã„ã„ã®ã‹ã‚ã‹ã‚‰ãªã„ã€‚">
                ğŸ’• æ‹æ„›ãƒ»äººé–“é–¢ä¿‚
              </button>
              <button type="button" class="preset-example text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded border border-gray-500/50 hover:border-gray-400 transition-colors text-left" data-example="å°†æ¥ã®ã“ã¨ã‚’è€ƒãˆã‚‹ã¨ä¸å®‰ã§ä»•æ–¹ãªã„ã€‚ãŠé‡‘ã®ã“ã¨ã€å¥åº·ã®ã“ã¨ã€å®¶æ—ã®ã“ã¨...ä½•ã‹ã‚‰æ‰‹ã‚’ã¤ã‘ã¦ã„ã„ã‹ã‚ã‹ã‚‰ãªã„ã€‚">
                ğŸ”® å°†æ¥ãƒ»äººç”Ÿè¨­è¨ˆ
              </button>
              <button type="button" class="preset-example text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded border border-gray-500/50 hover:border-gray-400 transition-colors text-left" data-example="å®¶æ—ã¨ã®é–¢ä¿‚ã§æ‚©ã‚“ã§ã„ã‚‹ã€‚ä¾¡å€¤è¦³ã®é•ã„ã§è¡çªã™ã‚‹ã“ã¨ãŒå¤šãã¦ã€ã©ã†æ¥ã—ã¦ã„ã„ã‹ã‚ã‹ã‚‰ãªã„ã€‚">
                ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ å®¶æ—é–¢ä¿‚
              </button>
              <button type="button" class="preset-example text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded border border-gray-500/50 hover:border-gray-400 transition-colors text-left" data-example="æ–°ã—ã„ã“ã¨ã‚’å§‹ã‚ãŸã„ã‘ã©ã€å¤±æ•—ã™ã‚‹ã®ãŒæ€–ã„ã€‚å¹´é½¢çš„ã«ã‚‚ã“ã‚ŒãŒæœ€å¾Œã®ãƒãƒ£ãƒ³ã‚¹ã‹ã‚‚ã—ã‚Œãªã„ã—ã€ã§ã‚‚è¸ã¿å‡ºã›ãªã„ã€‚">
                ğŸŒŸ æ–°ã—ã„æŒ‘æˆ¦
              </button>
              <button type="button" class="preset-example text-xs bg-gray-600/50 hover:bg-gray-600 text-gray-300 px-3 py-2 rounded border border-gray-500/50 hover:border-gray-400 transition-colors text-left" data-example="å¥åº·é¢ã§æ°—ã«ãªã‚‹ã“ã¨ãŒã‚ã£ã¦ã€ç—…é™¢ã«è¡Œãã¹ãã‹è¿·ã£ã¦ã‚‹ã€‚ã§ã‚‚å¿™ã—ãã¦æ™‚é–“ãŒå–ã‚Œãªã„ã—ã€ã‚‚ã—å¤§å¤‰ãªç—…æ°—ã ã£ãŸã‚‰ã¨æ€ã†ã¨ä¸å®‰ã€‚">
                ğŸ¥ å¥åº·ãƒ»ç”Ÿæ´»
              </button>
            </div>
          </div>
        </div>
        <button
            id="aiGuessBtn"
            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition duration-300 flex items-center justify-center gap-2"
          >
            <svg class="animate-spin h-5 w-5 text-white hidden" id="loadingSpinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <svg
              id="originalIcon"
              xmlns="http://www.w3.org/2000/svg"
              class="h-6 w-6"
              viewBox="0 0 20 20"
              fill="currentColor"
            >
              <path
                fill-rule="evenodd"
                d="M11.3 1.046A1 1 0 0112 2v5h4a1 1 0 01.82 1.573l-7 10A1 1 0 018 18v-5H4a1 1 0 01-.82-1.573l7-10a1 1 0 011.12-.38z"
                clip-rule="evenodd"
              />
            </svg>
            <span id="buttonText">AIã«çŠ¶æ³ã‚’æ¨æ¸¬ã•ã›ã‚‹</span>
          </button>
        </div>
      </div>

      <!-- Data Export Section -->
      <div class="data-export-section progressive-load" id="data-export">
        <h3 class="text-lg font-bold text-indigo-300 mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        </h3>
        <div class="flex flex-wrap gap-3">
          <button id="exportJson" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            JSONå½¢å¼
          </button>
          <button id="exportCsv" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a4 4 0 01-4-4V5a4 4 0 014-4h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a4 4 0 01-4 4z" />
            </svg>
            CSVå½¢å¼
          </button>
          <button id="exportPdf" class="export-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            PDFæº–å‚™
          </button>
        </div>
      </div>

      <!-- Results Section - æ®µéšçš„æƒ…å ±é–‹ç¤º -->
      <div id="resultArea" class="hidden relative">        
        <!-- çµæœè¡¨ç¤ºã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
        <div id="resultControls" class="mb-6 bg-gray-800/30 rounded-lg p-4 border border-gray-600/50">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4">
            <div>
              <h3 class="text-lg font-bold text-indigo-300 mb-1">ğŸ“Š åˆ†æçµæœã®è¡¨ç¤ºãƒ¬ãƒ™ãƒ«</h3>
              <p class="text-sm text-gray-400">ãŠå¥½ã¿ã®è©³ã—ã•ã§çµæœã‚’ç¢ºèªã§ãã¾ã™</p>
            </div>
            <div class="flex flex-wrap gap-2">
              <button id="showSummary" class="result-level-btn bg-emerald-600 hover:bg-emerald-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <span class="w-2 h-2 bg-emerald-300 rounded-full"></span>
                ã‚µãƒãƒªãƒ¼
              </button>
              <button id="showDetailed" class="result-level-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                è©³ç´°åˆ†æ
              </button>
              <button id="showComplete" class="result-level-btn bg-gray-600 hover:bg-gray-500 text-white px-4 py-2 rounded-lg text-sm font-medium transition-colors flex items-center gap-2">
                <span class="w-2 h-2 bg-gray-300 rounded-full"></span>
                å®Œå…¨ç‰ˆ
              </button>
            </div>
          </div>
        </div>
        <!-- Loading Overlay for Results -->
        <div id="results-loading" class="loading-overlay" style="display: none;">
          <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-300">åˆ†æçµæœã‚’ç”Ÿæˆä¸­...</p>
          </div>
        </div>
        
        <!-- ã‚µãƒãƒªãƒ¼ãƒ¬ãƒ™ãƒ«ï¼šåŸºæœ¬æƒ…å ± -->
        <div class="result-section summary-level visible">
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 items-start mb-12">
            <div class="lg:col-span-1">
              <h2 class="text-2xl font-bold mb-4 text-center text-indigo-300">
                ğŸ“Š åˆ†æã‚µãƒãƒªãƒ¼
              </h2>
            <div class="space-y-4">
              <!-- Summary Card -->
              <div
                id="summaryCard"
                class="p-4 rounded-lg border border-gray-600/50 bg-gray-900/30 relative"
              >
                <div
                  class="bg-yellow-400/10 border-l-4 border-yellow-400 p-3 rounded-md"
                >
                  <h4
                    id="currentTitle"
                    class="text-lg font-semibold text-yellow-300"
                  >ç¾åœ¨ã®çŠ¶æ³</h4>
                  <p
                    id="currentKeywords"
                    class="text-sm text-yellow-200 mt-1"
                  ></p>
                  <p id="currentSummary" class="text-gray-300 mt-2 text-sm">ã‚ãªãŸã®çŠ¶æ³ã‚’ç·åˆçš„ã«åˆ†æã—ãŸçµæœã€ä»Šã¯é‡è¦ãªå¤‰åŒ–ã®æ™‚æœŸã«ã‚ã‚‹ã“ã¨ãŒç¤ºã•ã‚Œã¦ã„ã¾ã™ã€‚</p>
                </div>
                <div class="mt-4 pt-4 border-t border-gray-700/50">
                  <h4 class="font-bold text-gray-300">æ¨å¥¨ã•ã‚Œã‚‹æ–¹å‘æ€§</h4>
                  <p id="recommendedDirection" class="text-gray-300 mt-2 text-sm">å†…ãªã‚‹ç›´æ„Ÿã‚’ä¿¡ã˜ã€æ…é‡ã«è¡Œå‹•ã™ã‚‹ã“ã¨ã§è‰¯ã„çµæœã‚’å¾—ã‚‰ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚</p>
                </div>
              </div>
            </div>
          </div>
          
            <!-- Choice Cards -->
            <div class="lg:col-span-2">
              <h2 class="text-xl font-bold mb-4 text-center text-indigo-300">
                ğŸ›¡ï¸ æœ€åˆã®é¸æŠï¼šã‚ãªãŸã¯ã©ã¡ã‚‰ã®é“ã‚’é¸ã¶ã‹ï¼Ÿ
              </h2>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-8">
              <div id="choice1" class="card bg-gradient-to-br from-blue-900/20 to-indigo-900/20 border border-blue-500/30 p-4 rounded-lg hover:border-blue-400">
                <h3 class="text-lg font-bold text-blue-300 mb-2">ç¾çŠ¶ç¶­æŒã®é“</h3>
                <p class="text-sm text-gray-300 mb-3">ä»Šã®çŠ¶æ³ã‚’å—ã‘å…¥ã‚Œã€å†…ãªã‚‹åŠ›ã‚’è‚²ã‚€é¸æŠ</p>
                <div class="text-xs bg-blue-500/20 text-blue-200 px-2 py-1 rounded">å®‰å®šæ€§é‡è¦–</div>
              </div>
              <div id="choice2" class="card bg-gradient-to-br from-emerald-900/20 to-teal-900/20 border border-emerald-500/30 p-4 rounded-lg hover:border-emerald-400">
                <h3 class="text-lg font-bold text-emerald-300 mb-2">å¤‰é©ã®é“</h3>
                <p class="text-sm text-gray-300 mb-3">æ–°ã—ã„å¯èƒ½æ€§ã«å‘ã‹ã£ã¦ä¸€æ­©è¸ã¿å‡ºã™é¸æŠ</p>
                <div class="text-xs bg-emerald-500/20 text-emerald-200 px-2 py-1 rounded">æˆé•·æ€§é‡è¦–</div>
              </div>
            </div>
            
              <!-- 8 Scenarios -->
              <h2 class="text-xl font-bold mb-4 text-center text-indigo-300">
                ğŸ”® 8ã¤ã®æœªæ¥ã‚·ãƒŠãƒªã‚ª
              </h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4" id="scenarioGrid">
                <!-- Scenarios will be dynamically generated -->
              </div>
            </div>
          </div>
        </div>
        
        <!-- è©³ç´°ãƒ¬ãƒ™ãƒ«ï¼šæ˜“çµŒåˆ†æè©³ç´° -->
        <div class="result-section detailed-level">
          <div class="mb-8 bg-gray-800/30 rounded-lg p-6 border border-gray-600/50">
            <div class="flex items-center mb-4">
              <span class="text-3xl mr-3">ğŸ¯</span>
              <h3 class="text-xl font-bold text-amber-300">ç¾åœ¨åœ°ï¼šæ˜“çµŒã«ã‚ˆã‚‹æ­£ç¢ºãªä½ç½®ç‰¹å®š</h3>
            </div>
            <div id="positionAnalysis" class="space-y-4">
              <!-- è©³ç´°ãªæ˜“çµŒåˆ†æãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
          </div>
        </div>
        
        <!-- å®Œå…¨ç‰ˆï¼šå“è³ªåˆ†æ -->
        <div class="result-section complete-level">
          <div class="mb-8 bg-gray-800/30 rounded-lg p-6 border border-gray-600/50">
            <div class="flex items-center mb-4">
              <span class="text-2xl mr-3">ğŸ”®</span>
              <h3 class="text-xl font-bold text-purple-300">æ˜“çµŒå¤‰æ›å“è³ªåˆ†æ</h3>
            </div>
            <div id="qualityAnalysis" class="space-y-4">
              <!-- å“è³ªåˆ†æãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
          </div>
        </div>
        
        <!-- å®Œå…¨ç‰ˆï¼šãƒãƒ£ãƒ¼ãƒˆåˆ†æ -->
        <div class="result-section complete-level">
          <div class="mb-8">
            <div id="chartAnalysis">
              <!-- ãƒãƒ£ãƒ¼ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Scripts for v2 -->
    <script src="./js/performance-optimizer.js"></script>
    <script src="./js/input-enhancements.js"></script>
    
    <!-- Module Script -->
    <script type="module">
      // ğŸš€ æœ€é©åŒ–4: ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ä»˜ããƒ—ãƒ­ã‚°ãƒ¬ãƒƒã‚·ãƒ–ãƒ­ãƒ¼ãƒ€ãƒ¼
      class ProgressiveLoader {
        constructor() {
          this.progress = 0;
          this.loadedModules = 0;
          this.totalModules = 15;
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
          this.initializeCaching();
          
          // WebWorkeråˆæœŸåŒ–
          this.initializeWebWorker();
          
          // ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«åˆæœŸåŒ–
          this.initializeMemoryPool();
          
          // æ–°ã—ã„æœ€é©åŒ–æ©Ÿèƒ½åˆæœŸåŒ–
          this.initializeEventPool();
          this.initializeMemoryPool();
          
          this.init();
        }
        
        // ğŸš€ æœ€é©åŒ–5: ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ 
        initializeCaching() {
          this.analysisCache = new Map();
          this.maxCacheSize = 50;
          this.cacheHitCount = 0;
          this.cacheMissCount = 0;
          console.log('ğŸ“‹ åˆ†æçµæœã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        }
        
        // WebWorkeråˆæœŸåŒ–
        initializeWebWorker() {
          this.useWebWorker = typeof Worker !== 'undefined';
          if (this.useWebWorker) {
            console.log('ğŸ”§ WebWorkeræ”¯æ´ã‚·ã‚¹ãƒ†ãƒ æº–å‚™å®Œäº†');
          }
        }
        
        // ğŸš€ æœ€é©åŒ–6: ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«
        initializeMemoryPool() {
          this.objectPool = {
            analysisResults: [],
            chartData: [],
            scenarios: []
          };
          this.poolSize = 10;
          console.log('ğŸ—„ï¸ ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãƒ—ãƒ¼ãƒ«åˆæœŸåŒ–å®Œäº†');
        }
        
        // ğŸš€ æœ€é©åŒ–4: ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«å®Ÿè£…
        initializeMemoryPool() {
          if (!this.memoryPool) {
            this.memoryPool = {
              objects: [],
              maxSize: 20,
              create: () => ({}),
              get: function() {
                return this.objects.length > 0 ? this.objects.pop() : this.create();
              },
              release: function(obj) {
                if (this.objects.length < this.maxSize) {
                  // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã‚¯ãƒªã‚¢
                  Object.keys(obj).forEach(key => delete obj[key]);
                  this.objects.push(obj);
                }
              }
            };
          }
        }
        
        // ğŸš€ æœ€é©åŒ–5: ãƒãƒƒãƒå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 
        batchProcess(tasks, batchSize = 3) {
          return new Promise(async (resolve) => {
            const results = [];
            
            for (let i = 0; i < tasks.length; i += batchSize) {
              const batch = tasks.slice(i, i + batchSize);
              const batchResults = await Promise.all(batch.map(task => 
                typeof task === 'function' ? task() : task
              ));
              results.push(...batchResults);
              
              // æ¬¡ã®ãƒãƒƒãƒå‰ã«çŸ­ã„ä¼‘æ†©
              if (i + batchSize < tasks.length) {
                await new Promise(resolve => setTimeout(resolve, 1));
              }
            }
            
            resolve(results);
          });
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚­ãƒ¼ç”Ÿæˆ
        generateCacheKey(inputText) {
          // ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ã‚­ãƒ¼ã‚’ç”Ÿæˆï¼ˆç°¡æ˜“ç‰ˆï¼‰
          let hash = 0;
          if (inputText.length === 0) return hash.toString();
          for (let i = 0; i < inputText.length; i++) {
            const char = inputText.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash; // 32bitæ•´æ•°ã«å¤‰æ›
          }
          return hash.toString();
        }
        
        // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä¿å­˜
        cacheAnalysisResult(key, result) {
          if (this.analysisCache.size >= this.maxCacheSize) {
            // LRUé¢¨ã«å¤ã„ã‚¨ãƒ³ãƒˆãƒªã‚’å‰Šé™¤
            const firstKey = this.analysisCache.keys().next().value;
            this.analysisCache.delete(firstKey);
          }
          
          this.analysisCache.set(key, {
            result,
            timestamp: Date.now(),
            accessCount: 1
          });
        }
        
        // è¤‡é›‘åº¦è¨ˆç®—
        calculateComplexity(inputText) {
          return Math.min(inputText.length / 100 + 
            (inputText.match(/[ã€ã€‚ï¼ï¼Ÿ]/g) || []).length / 10, 10);
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯åˆ†æ
        getFallbackAnalysis(inputText) {
          return {
            currentSituation: {
              å¦ç•ªå·: 12,
              å¦å: 'å¤©åœ°å¦',
              çˆ»: 'ä¹ä¸‰',
              ä¿¡é ¼åº¦: 0.6
            },
            scenarios: [],
            choices: {
              pathA: { title: 'ç¾çŠ¶ç¶­æŒ', description: 'å®‰å…¨ãªé¸æŠ' },
              pathB: { title: 'å¤‰é©æŒ‘æˆ¦', description: 'æ–°ã—ã„é“' }
            }
          };
        }
        
        async init() {
          console.log('ğŸš€ Module script execution started');
          await this.simulateModuleLoading();
          await this.hideLoadingScreen();
          this.startProgressiveContentLoad();
        }
        
        async simulateModuleLoading() {
          const modules = [
            'H384_DATA validation',
            'IChingTransformationEngine',
            'FutureBranchingSystem', 
            'DataPersistenceManager',
            'DataExportAPI',
            'Quality Enhancement',
            'ML Integration',
            'Analysis Engine',
            'Context Analyzer',
            'Hexagram Mapping',
            'Metaphor Generation',
            'Event Listeners',
            'UI Components',
            'Export Functions',
            'Complete Integration'
          ];
          
          for (let i = 0; i < modules.length; i++) {
            await this.animateProgress((i + 1) * (100 / modules.length));
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
        
        async hideLoadingScreen() {
          const loadingScreen = document.getElementById('initial-loading');
          const mainContainer = document.getElementById('main-container');
          
          await this.animateProgress(100);
          
          setTimeout(() => {
            console.log('ğŸ¯ Hiding loading screen...');
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
              loadingScreen.style.display = 'none';
              mainContainer.style.opacity = '1';
              
              // Phase 6: Show input form immediately after loading
              this.showInputForm();
              
              console.log('âœ… Application initialization completed');
              this.startProgressiveContentLoad();
            }, 300);
          }, 500);
        }
        
        // Phase 6: Text Input Form Display Fix
        showInputForm() {
          const inputContent = document.getElementById('input-content');
          const worryInput = document.getElementById('worryInput');
          
          if (inputContent) {
            inputContent.style.display = 'block';
            inputContent.style.opacity = '0';
            
            // Animate in
            setTimeout(() => {
              inputContent.style.transition = 'opacity 0.5s ease-in-out';
              inputContent.style.opacity = '1';
            }, 100);
            
            // Auto-focus on input field
            if (worryInput) {
              setTimeout(() => {
                worryInput.focus();
                this.optimizeInputHandling();
              }, 600);
            }
          }
          
          console.log('âœ… Input form displayed and ready');
        }
        
        optimizeInputHandling() {
          const worryInput = document.getElementById('worryInput');
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          
          if (!worryInput || !aiGuessBtn) return;
          
          // Real-time input validation
          let inputTimeout;
          worryInput.addEventListener('input', (e) => {
            clearTimeout(inputTimeout);
            inputTimeout = setTimeout(() => {
              this.validateInput(e.target.value);
            }, 300);
          });
          
          // Enter key support
          worryInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
              e.preventDefault();
              if (this.isValidInput(worryInput.value.trim())) {
                aiGuessBtn.click();
              }
            }
          });
          
          // Character counter
          this.addCharacterCounter();
        }
        
        validateInput(text) {
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          const isValid = this.isValidInput(text);
          
          if (aiGuessBtn) {
            aiGuessBtn.disabled = !isValid;
            aiGuessBtn.classList.toggle('opacity-50', !isValid);
            
            if (isValid) {
              aiGuessBtn.textContent = 'æœªæ¥ã‚’åˆ†æ';
            } else {
              aiGuessBtn.textContent = '5æ–‡å­—ä»¥ä¸Šå…¥åŠ›ã—ã¦ãã ã•ã„';
            }
          }
        }
        
        isValidInput(text) {
          return text && text.length >= 5 && text.length <= 500;
        }
        
        addCharacterCounter() {
          const worryInput = document.getElementById('worryInput');
          if (!worryInput || document.getElementById('char-counter')) return;
          
          const counter = document.createElement('div');
          counter.id = 'char-counter';
          counter.className = 'text-xs text-gray-400 mt-1 text-right';
          counter.textContent = '0 / 500';
          
          worryInput.parentNode.appendChild(counter);
          
          worryInput.addEventListener('input', () => {
            const length = worryInput.value.length;
            counter.textContent = `${length} / 500`;
            counter.className = `text-xs mt-1 text-right ${
              length > 500 ? 'text-red-400' : 
              length < 5 ? 'text-gray-400' : 'text-green-400'
            }`;
          });
        }
        
        async animateProgress(target) {
          return new Promise(resolve => {
            const animate = () => {
              if (this.progress < target) {
                this.progress += 2;
                const progressBar = document.getElementById('loading-progress');
                if (progressBar) {
                  progressBar.style.width = `${this.progress}%`;
                }
                requestAnimationFrame(animate);
              } else {
                resolve();
              }
            };
            animate();
          });
        }
        
        startProgressiveContentLoad() {
          console.log('ğŸ“¦ Additional modules loaded');
          
          // Show input content
          setTimeout(() => {
            const inputSkeleton = document.getElementById('input-skeleton');
            const inputContent = document.getElementById('input-content');
            if (inputSkeleton && inputContent) {
              inputSkeleton.style.display = 'none';
              inputContent.style.display = 'block';
              inputContent.classList.add('fade-in');
            }
            
            // Load progressive elements
            const progressiveElements = document.querySelectorAll('.progressive-load');
            progressiveElements.forEach((element, index) => {
              setTimeout(() => {
                element.classList.add('loaded');
              }, index * 200);
            });
          }, 500);
          
          // Initialize functionality
          this.initializeEventListeners();
        }
        
        initializeEventListeners() {
          // AI Analysis Button
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          const worryInput = document.getElementById('worryInput');
          
          if (aiGuessBtn && worryInput) {
            aiGuessBtn.addEventListener('click', () => {
              const inputText = worryInput.value.trim();
              if (this.isValidInput(inputText)) {
                console.log('Starting analysis...');
                this.performAnalysis(inputText);
              } else {
                this.showInputError();
              }
            });
          }
        }
        
        showInputError() {
          const errorDiv = document.createElement('div');
          errorDiv.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
          errorDiv.textContent = '5æ–‡å­—ä»¥ä¸Š500æ–‡å­—ä»¥å†…ã§å…¥åŠ›ã—ã¦ãã ã•ã„';
          
          document.body.appendChild(errorDiv);
          
          setTimeout(() => {
            errorDiv.style.opacity = '0';
            setTimeout(() => errorDiv.remove(), 300);
          }, 3000);
          
          // Export buttons
          this.initializeExportButtons();
          
          // Choice cards
          this.initializeChoiceCards();
          
          console.log('âœ… Event listeners initialized');
        }
        
        // Phase 7: AI Analysis Processing Implementation
        performAnalysis(inputText) {
          const resultArea = document.getElementById('resultArea');
          const resultsLoading = document.getElementById('results-loading');
          const aiGuessBtn = document.getElementById('aiGuessBtn');
          
          // Set loading state
          if (aiGuessBtn) {
            aiGuessBtn.disabled = true;
            aiGuessBtn.innerHTML = `
              <svg class="animate-spin h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              åˆ†æä¸­...
            `;
          }
          
          if (resultArea) resultArea.classList.remove('hidden');
          if (resultsLoading) {
            resultsLoading.style.display = 'flex';
            this.startResultsLoading();
          }
          
          // Enhanced analysis with emotion detection
          this.performEnhancedAnalysis(inputText)
            .then(result => {
              console.log('âœ… Analysis completed successfully');
              if (resultsLoading) resultsLoading.style.display = 'none';
              
              // Reset button state
              if (aiGuessBtn) {
                aiGuessBtn.disabled = false;
                aiGuessBtn.innerHTML = 'å†åˆ†æ';
              }
              
              this.displayResults(result);
            })
            .catch(error => {
              console.error('âŒ Analysis failed:', error);
              if (resultsLoading) resultsLoading.style.display = 'none';
              
              // Reset button state
              if (aiGuessBtn) {
                aiGuessBtn.disabled = false;
                aiGuessBtn.innerHTML = 'æœªæ¥ã‚’åˆ†æ';
              }
              
              this.showErrorMessage(error.message);
            });
        }
        
        async performEnhancedAnalysis(inputText) {
          const analysisStartTime = performance.now();
          
          // Phase 7: Emotion Analysis and I Ching Selection Logic
          const emotionAnalysis = this.analyzeEmotion(inputText);
          const ichingSelection = this.selectIChingHexagram(inputText, emotionAnalysis);
          const currentSituation = this.generateCurrentSituation(inputText, emotionAnalysis, ichingSelection);
          
          // Store analysis data globally
          currentAnalysisData = {
            inputText,
            emotionAnalysis,
            currentSituation,
            analysisTime: Date.now()
          };
          
          try {
            // Initialize systems concurrently
            await this.measureAndExecute('engineInit', () => this.initializeEngines());
            
            // Parallel analysis execution - fallback to simple version if complex analysis fails
            let analysisResult;
            try {
              analysisResult = await this.measureAndExecute('analysis', 
                () => this.performIntegratedAnalysis(inputText));
            } catch (error) {
              console.warn('Integrated analysis failed, using simple version:', error);
              analysisResult = await this.performSimpleAnalysis(inputText, currentSituation);
            }
            
            const analysisTime = performance.now() - analysisStartTime;
            console.log(`ğŸ¯ Enhanced analysis completed: ${Math.round(analysisTime)}ms`);
            
            return analysisResult;
            
          } catch (error) {
            console.error('Enhanced analysis failed:', error);
            return this.getFallbackAnalysis(inputText);
          }
        }
        
        async performSimpleAnalysis(inputText, currentSituation) {
          // Simple fallback analysis
          const scenarios = await this.generateSimpleScenarios(currentSituation);
          const choices = this.generateAuthenticChoices(currentSituation);
          
          return {
            currentSituation,
            scenarios,
            choices,
            metadata: {
              analysisTime: Date.now(),
              method: 'simple'
            }
          };
        }
        
        async generateSimpleScenarios(currentSituation) {
          // Generate 8 simple scenarios based on I Ching
          return Array.from({length: 8}, (_, i) => ({
            id: i + 1,
            title: `å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ ${i + 1}`,
            description: `ç¬¬${currentSituation.å¦ç•ªå·}å¦ã‹ã‚‰ã®å¤‰åŒ– - ãƒ‘ã‚¿ãƒ¼ãƒ³${i + 1}ã®å±•é–‹`,
            probability: 0.7 + (Math.random() * 0.3),
            line: (i % 6) + 1,
            lineText: `ç¬¬${(i % 6) + 1}çˆ»ã®ç¤ºå”†ã«ã‚ˆã‚‹å±•é–‹`,
            advice: 'ç¾çŠ¶ã‚’å—ã‘å…¥ã‚Œã¤ã¤ã€æ–°ã—ã„å¯èƒ½æ€§ã‚’æ¢æ±‚ã—ã¦ãã ã•ã„',
            interpretation: currentSituation.å¦å + 'ã®å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³'
          }));
        }
        
        analyzeEmotion(inputText) {
          // Simple emotion detection based on keywords and patterns
          const emotions = {
            anxiety: 0,
            hope: 0,
            confusion: 0,
            determination: 0,
            sadness: 0,
            anger: 0
          };
          
          const text = inputText.toLowerCase();
          
          // Anxiety indicators
          if (text.match(/ä¸å®‰|å¿ƒé…|æ‚©|å›°|æ€–|è¿·|ã‚ã‹ã‚‰ãªã„/)) emotions.anxiety += 0.3;
          if (text.match(/ã©ã†ã—ã‚ˆã†|å¤§ä¸ˆå¤«|ã‚„ã°ã„/)) emotions.anxiety += 0.2;
          
          // Hope indicators
          if (text.match(/å¸Œæœ›|é ‘å¼µ|ã‚„ã‚‹æ°—|å‰å‘|ãƒã‚¸ãƒ†ã‚£ãƒ–|è‰¯ã|ã†ã¾ã/)) emotions.hope += 0.3;
          if (text.match(/ã§ãã‚‹|æˆåŠŸ|å¹¸ã›|å¬‰ã—ã„/)) emotions.hope += 0.2;
          
          // Confusion indicators
          if (text.match(/ã‚ã‹ã‚‰ãªã„|è¿·|æ··ä¹±|ã©ã¡ã‚‰|é¸æŠ|æ±ºã‚ã‚‰ã‚Œãªã„/)) emotions.confusion += 0.3;
          
          // Determination indicators
          if (text.match(/æ±ºæ„|ã‚„ã‚‹|å®Ÿè¡Œ|è¡Œå‹•|æŒ‘æˆ¦|é ‘å¼µã‚‹/)) emotions.determination += 0.3;
          
          // Sadness indicators
          if (text.match(/æ‚²ã—ã„|ã¤ã‚‰ã„|è‹¦ã—ã„|è½ã¡è¾¼|æ†‚é¬±|å­¤ç‹¬/)) emotions.sadness += 0.3;
          
          // Anger indicators
          if (text.match(/æ€’|è…¹ç«‹|ã‚¤ãƒ©ã‚¤ãƒ©|ãƒ ã‚«ã¤ã|è¨±ã›ãªã„/)) emotions.anger += 0.3;
          
          // Normalize emotions
          const maxEmotion = Math.max(...Object.values(emotions));
          if (maxEmotion > 0) {
            Object.keys(emotions).forEach(key => {
              emotions[key] = emotions[key] / maxEmotion;
            });
          }
          
          return emotions;
        }
        
        selectIChingHexagram(inputText, emotions) {
          // I Ching hexagram selection based on emotion analysis and text content
          const textHash = this.fastHash(inputText);
          const emotionFactor = emotions.anxiety * 0.4 + emotions.confusion * 0.3 + emotions.sadness * 0.3;
          
          let hexagramNumber;
          
          if (emotionFactor > 0.6) {
            // High negative emotions - suggest transformative hexagrams
            const negativeHexagrams = [12, 18, 47, 29, 4]; // å¦, è›Š, å›°, å, è’™
            hexagramNumber = negativeHexagrams[textHash % negativeHexagrams.length];
          } else if (emotions.hope > 0.5 || emotions.determination > 0.5) {
            // Positive emotions - suggest progressive hexagrams
            const positiveHexagrams = [1, 11, 14, 25, 42]; // ä¹¾, æ³°, å¤§æœ‰, æ— å¦„, ç›Š
            hexagramNumber = positiveHexagrams[textHash % positiveHexagrams.length];
          } else {
            // Neutral or mixed emotions - use balanced selection
            const balancedHexagrams = [2, 8, 15, 16, 20, 31, 32, 61, 62]; // å¤, æ¯”, è¬™, è±«, è§€, å’¸, æ’, ä¸­å­š, å°é
            hexagramNumber = balancedHexagrams[textHash % balancedHexagrams.length];
          }
          
          return {
            number: hexagramNumber,
            line: (textHash % 6) + 1,
            confidence: 0.75 + (emotions.determination * 0.2) - (emotions.confusion * 0.15)
          };
        }
        
        generateCurrentSituation(inputText, emotions, iching) {
          const hexagramNames = {
            1: 'ä¹¾ç‚ºå¤©', 2: 'å¤ç‚ºåœ°', 4: 'å±±æ°´è’™', 8: 'æ°´åœ°æ¯”', 11: 'åœ°å¤©æ³°', 12: 'å¤©åœ°å¦',
            14: 'ç«å¤©å¤§æœ‰', 15: 'åœ°å±±è¬™', 16: 'é›·åœ°è±«', 18: 'å±±é¢¨è›Š', 20: 'é¢¨åœ°è§€',
            25: 'å¤©é›·æ— å¦„', 29: 'åç‚ºæ°´', 31: 'æ²¢å±±å’¸', 32: 'é›·é¢¨æ’', 42: 'é¢¨é›·ç›Š',
            47: 'æ²¢æ°´å›°', 61: 'é¢¨æ²¢ä¸­å­š', 62: 'é›·å±±å°é'
          };
          
          const lineNames = ['åˆçˆ»', 'äºŒçˆ»', 'ä¸‰çˆ»', 'å››çˆ»', 'äº”çˆ»', 'ä¸Šçˆ»'];
          
          return {
            å¦ç•ªå·: iching.number,
            å¦å: hexagramNames[iching.number] || 'å¤©åœ°å¦',
            çˆ»: lineNames[iching.line - 1] || 'ä¸‰çˆ»',
            çˆ»ä½ç½®: iching.line,
            ä¿¡é ¼åº¦: Math.min(iching.confidence, 0.95),
            ä¸»è¦æ„Ÿæƒ…: this.getDominantEmotion(emotions),
            åˆ†ææ·±åº¦: this.calculateAnalysisDepth(inputText, emotions)
          };
        }
        
        getDominantEmotion(emotions) {
          const emotionNames = {
            anxiety: 'ä¸å®‰',
            hope: 'å¸Œæœ›',
            confusion: 'æ··ä¹±',
            determination: 'æ±ºæ„',
            sadness: 'æ‚²ã—ã¿',
            anger: 'æ€’ã‚Š'
          };
          
          let maxEmotion = 'hope';
          let maxValue = 0;
          
          Object.keys(emotions).forEach(key => {
            if (emotions[key] > maxValue) {
              maxValue = emotions[key];
              maxEmotion = key;
            }
          });
          
          return emotionNames[maxEmotion] || 'å¹³é™';
        }
        
        calculateAnalysisDepth(inputText, emotions) {
          const textComplexity = Math.min(inputText.length / 100, 1);
          const emotionalComplexity = Object.values(emotions).reduce((sum, val) => sum + val, 0) / 6;
          return Math.min(textComplexity + emotionalComplexity, 1);
        }
        
        // ğŸš€ ãƒ¡ã‚¤ãƒ³æœ€é©åŒ–çµ±åˆ: å…¨ä½“å‡¦ç†æ™‚é–“1,000msä»¥ä¸‹ã‚’ç›®æŒ‡ã™
        async displayResults(inputText) {
          console.log('ğŸŒŸ é«˜é€Ÿçµ±åˆåˆ†æã‚·ã‚¹ãƒ†ãƒ é–‹å§‹');
          const totalStartTime = performance.now();
          
          try {
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–‹å§‹
            this.startPerformanceMonitoring();
            
            // 1. è»½é‡ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ï¼ˆç›®æ¨™: 50msä»¥ä¸‹ï¼‰
            await this.measureAndExecute('engineInit', () => this.initializeEngines());
            
            // 2. ä¸¦åˆ—çµ±åˆåˆ†æå®Ÿè¡Œï¼ˆç›®æ¨™: 600msä»¥ä¸‹ï¼‰
            const analysisResult = await this.measureAndExecute('analysis', 
              () => this.performIntegratedAnalysis(inputText));
            
            // 3. ä¸¦åˆ—è¡¨ç¤ºæ›´æ–°ï¼ˆç›®æ¨™: 200msä»¥ä¸‹ï¼‰
            await this.measureAndExecute('display', 
              () => this.updateAllDisplays(analysisResult));
            
            // 4. é«˜é€Ÿãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆç›®æ¨™: 150msä»¥ä¸‹ï¼‰
            this.measureAndExecute('charts', 
              () => this.updateCharts(analysisResult));
            
            const totalTime = performance.now() - totalStartTime;
            console.log(`âœ… é«˜é€Ÿçµ±åˆåˆ†æå®Œäº†: ${Math.round(totalTime)}ms`);
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
            this.generatePerformanceReport(totalTime);
            
          } catch (error) {
            console.error('âŒ é«˜é€Ÿçµ±åˆåˆ†æã‚¨ãƒ©ãƒ¼:', error);
            this.displayFallbackResults(inputText);
          }
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®šä»˜ãå®Ÿè¡Œ
        async measureAndExecute(operationName, operation) {
          const startTime = performance.now();
          const result = await operation();
          const endTime = performance.now();
          
          this.recordPerformanceMetric(operationName, {
            duration: endTime - startTime,
            timestamp: Date.now()
          });
          
          return result;
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°é–‹å§‹
        startPerformanceMonitoring() {
          this.performanceMetrics = {
            startTime: performance.now(),
            operations: new Map()
          };
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªãƒƒã‚¯è¨˜éŒ²
        recordPerformanceMetric(operation, metrics) {
          if (!this.performanceMetrics) return;
          
          this.performanceMetrics.operations.set(operation, metrics);
          console.log(`ğŸ“Š ${operation}: ${Math.round(metrics.duration)}ms`);
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        generatePerformanceReport(totalTime) {
          if (!this.performanceMetrics) return;
          
          const report = {
            totalTime: Math.round(totalTime),
            target: 1000,
            achieved: totalTime <= 1000,
            breakdown: {}
          };
          
          this.performanceMetrics.operations.forEach((metrics, operation) => {
            report.breakdown[operation] = Math.round(metrics.duration);
          });
          
          console.log('ğŸ“ˆ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ:', report);
          
          // ç›®æ¨™é”æˆçŠ¶æ³ã‚’è¡¨ç¤º
          if (report.achieved) {
            console.log('ğŸ¯ ç›®æ¨™é”æˆ! 1,000msä»¥ä¸‹ã§å‡¦ç†å®Œäº†');
          } else {
            console.log(`âš ï¸ ç›®æ¨™æœªé”æˆ: ${totalTime - 1000}ms ã‚ªãƒ¼ãƒãƒ¼`);
          }
          
          return report;
        }
      } // FutureSimulator class end
      
      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‘ã‚¹ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆé–¢æ•°
      function getSamplePaths() {
          const samplePaths = [
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 }, // ç¾åœ¨åœ°
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 72 }, // ãƒ•ã‚§ãƒ¼ã‚º1
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 81 }, // ãƒ•ã‚§ãƒ¼ã‚º2
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 87 }  // ãƒ•ã‚§ãƒ¼ã‚º3
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 68 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 75 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 79 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 59 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 65 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 71 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 57 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 52 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 48 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 69 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 73 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 76 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 61 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 58 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 54 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 60 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 56 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 51 }
            ],
            [
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 63 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 58 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 53 },
              { S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: 47 }
            ]
          ];
          return samplePaths;
        }
        
        // Define sample current state for chart rendering
          const sampleCurrentState = {
            å¦ç•ªå·: 12,
            å¦å: 'å¦',
            çˆ»: 'ä¹ä¸‰',
            åŸºæœ¬ã‚¹ã‚³ã‚¢: 35,
            ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«: 45,
            å®‰å®šæ€§: 30,
            ãƒªã‚¹ã‚¯: -40,
            å¤‰å‹•æ€§: 60,
            ç·åˆè©•ä¾¡: 40
          };

          // Add I Ching transformation quality section
          this.addIChingQualitySection(inputText);

          // Ensure chart containers exist before rendering
          ensureChartContainers();

          // Wait for DOM operations to complete, then render charts
          setTimeout(() => {
            if (typeof Chart !== 'undefined') {
              try {
                // Ensure containers are in DOM
                ensureChartContainers();
                
                // Additional wait for DOM updates
                setTimeout(() => {
                  // Double-check containers exist
                  const currentChartCanvas = document.getElementById('currentStateBarChart');
                  const summaryChartCanvas = document.getElementById('summaryChart');
                  
                  console.log('ğŸ” Chart container check:', {
                    currentChart: !!currentChartCanvas,
                    summaryChart: !!summaryChartCanvas
                  });
                  
                  if (currentChartCanvas) {
                    renderCurrentStateBarChart(sampleCurrentState);
                    console.log('âœ… Current state chart rendered');
                  } else {
                    console.warn('âš ï¸ Current state chart container not found after ensure');
                  }
                  
                  if (summaryChartCanvas) {
                    renderSummaryChart(getSamplePaths());
                    console.log('âœ… Summary chart rendered');
                  } else {
                    console.warn('âš ï¸ Summary chart container not found after ensure');
                  }
                  
                  console.log('âœ… Charts rendering completed');
                }, 200);
              } catch (error) {
                console.error('âŒ Chart rendering error:', error);
              }
            } else {
              console.warn('âš ï¸ Chart.js not loaded, charts will not display');
            }
          }, 1000);
        }
        
        // ğŸ¯ Initialize Current Position Display System
        async initializeCurrentPositionDisplay(currentSituation) {
          console.log('ğŸ¯ ç¾åœ¨åœ°è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
          
          const currentPositionContainer = document.getElementById('currentPositionContainer') || 
            this.createCurrentPositionContainer();
          
          if (!this.currentPositionDisplay) {
            this.currentPositionDisplay = new CurrentPositionDisplay(
              currentPositionContainer, 
              this.authenticEngine
            );
          }
          
          // Update display with current situation
          this.currentPositionDisplay.updatePosition(currentSituation);
          console.log('âœ… ç¾åœ¨åœ°è¡¨ç¤ºå®Œäº†');
        }

        // âš¡ Initialize Authentic Choice System
        async initializeAuthenticChoiceSystem(currentSituation) {
          console.log('âš¡ æ­£çµ±é¸æŠã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
          
          const choiceContainer = document.getElementById('choiceContainer') || 
            this.createChoiceContainer();
          
          if (!this.authenticChoiceSystem) {
            this.authenticChoiceSystem = new AuthenticChoiceSystem(
              choiceContainer, 
              this.authenticEngine
            );
          }
          
          // Generate and display choices
          this.authenticChoiceSystem.generateChoices(currentSituation);
          console.log('âœ… æ­£çµ±é¸æŠã‚·ã‚¹ãƒ†ãƒ å®Œäº†');
        }

        // ğŸŒŠ Initialize Authentic 8 Scenarios System
        async initializeAuthentic8ScenariosSystem(currentSituation) {
          console.log('ğŸŒŠ 8å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
          
          const scenariosContainer = document.getElementById('scenariosContainer') || 
            this.createScenariosContainer();
          
          if (!this.authentic8ScenariosSystem) {
            this.authentic8ScenariosSystem = new Authentic8ScenariosSystem(
              scenariosContainer, 
              this.authenticEngine
            );
          }
          
          // Generate 8 transformation patterns
          const patterns = this.authentic8ScenariosSystem.generate8TransformationPatterns(
            currentSituation.å¦ç•ªå·, 
            this.parseLinePosition(currentSituation.çˆ»), 
            currentSituation
          );
          
          console.log('âœ… 8å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚·ã‚¹ãƒ†ãƒ å®Œäº†');
        }
        
        analyzeTextForIChingPatterns(text) {
          // Text pattern analysis for I Ching concepts
          const patterns = {
            difficulty: ['ã†ã¾ãã„ã‹ãªã„', 'å›°é›£', 'å•é¡Œ', 'ãƒ—ãƒ¬ãƒƒã‚·ãƒ£ãƒ¼', 'æ‚©ã‚“ã§'],
            communication: ['ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒãƒ¼ãƒ ', 'ãƒ¡ãƒ³ãƒãƒ¼'],
            leadership: ['è²¬ä»»è€…', 'çµæœã‚’å‡ºã™', 'æ”¹å–„'],
            stagnation: ['é€²ã¾ãªã„', 'æ€ã†ã‚ˆã†ã«', 'åœæ»'],
            transformation: ['ã©ã†', 'æ”¹å–„', 'å¤‰åŒ–', 'æ–¹å‘æ€§']
          };
          
          let score = 0;
          let interpretation = '';
          
          if (patterns.difficulty.some(p => text.includes(p))) {
            score += 0.3;
            interpretation += 'å›°é›£ãªçŠ¶æ³ã«ç›´é¢ã—ã¦ã„ã‚‹ã€‚';
          }
          
          if (patterns.stagnation.some(p => text.includes(p))) {
            score += 0.25;
            interpretation += 'åœæ»æ„Ÿã‚’æ„Ÿã˜ã¦ã„ã‚‹ã€‚';
          }
          
          if (patterns.transformation.some(p => text.includes(p))) {
            score += 0.2;
            interpretation += 'å¤‰åŒ–ã‚’æ±‚ã‚ã¦ã„ã‚‹ã€‚';
          }
          
          return {
            confidence: Math.min(score, 0.95),
            interpretation: interpretation || 'çŠ¶æ³ã®å¤‰åŒ–ã‚’æ¨¡ç´¢ã—ã¦ã„ã‚‹æ™‚æœŸã€‚'
          };
        }

        // ğŸ› ï¸ Container Creation Methods
        createCurrentPositionContainer() {
          const container = document.createElement('div');
          container.id = 'currentPositionContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        createChoiceContainer() {
          const container = document.createElement('div');
          container.id = 'choiceContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        createScenariosContainer() {
          const container = document.createElement('div');
          container.id = 'scenariosContainer';
          container.className = 'mb-8';
          
          const resultsDiv = document.getElementById('results');
          if (resultsDiv) {
            resultsDiv.appendChild(container);
          }
          
          return container;
        }

        // ğŸ”§ Utility Methods
        parseLinePosition(lineText) {
          const lineMap = {
            'åˆä¹': 1, 'åˆå…­': 1,
            'ä¹äºŒ': 2, 'å…­äºŒ': 2,
            'ä¹ä¸‰': 3, 'å…­ä¸‰': 3,
            'ä¹å››': 4, 'å…­å››': 4,
            'ä¹äº”': 5, 'å…­äº”': 5,
            'ä¸Šä¹': 6, 'ä¸Šå…­': 6
          };
          
          return lineMap[lineText] || 1;
        }

        displayFallbackResults(inputText) {
          console.log('ğŸ”„ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯çµæœã‚’è¡¨ç¤º');
          // Original fallback implementation would go here
        }

        // ğŸš€ æœ€é©åŒ–1: è»½é‡åŒ–ã•ã‚ŒãŸã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–ã‚·ã‚¹ãƒ†ãƒ ï¼ˆãƒ¬ã‚¤ã‚¸ãƒ¼ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ï¼‰
        async initializeEngines() {
          console.log('âš¡ è»½é‡åŒ–ã‚¨ãƒ³ã‚¸ãƒ³åˆæœŸåŒ–é–‹å§‹');
          const initStartTime = performance.now();
          
          // ã‚¨ãƒ³ã‚¸ãƒ³ãƒ—ãƒ¼ãƒ«ã§å†åˆ©ç”¨
          if (!this.enginePool) {
            this.enginePool = new Map();
          }
          
          // AuthenticIChingEngineã®è»½é‡åˆæœŸåŒ–
          if (!this.authenticEngine) {
            this.authenticEngine = this.enginePool.get('authentic') || 
              new AuthenticIChingEngine();
            this.enginePool.set('authentic', this.authenticEngine);
          }
          
          // å¿…è¦æ™‚ã®ã¿8ã‚·ãƒŠãƒªã‚ªã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
          this.initScenarioSystemLazily();
          
          const initTime = performance.now() - initStartTime;
          console.log(`âœ… è»½é‡åŒ–åˆæœŸåŒ–å®Œäº†: ${Math.round(initTime)}ms`);
        }
        
        // ãƒ¬ã‚¤ã‚¸ãƒ¼åˆæœŸåŒ–ãƒ˜ãƒ«ãƒ‘ãƒ¼
        initScenarioSystemLazily() {
          if (!this.scenarioSystemPromise) {
            this.scenarioSystemPromise = new Promise(resolve => {
              requestIdleCallback(() => {
                const container = document.getElementById('scenariosContainer') || 
                  this.createScenariosContainer();
                this.authentic8ScenariosSystem = new Authentic8ScenariosSystem(
                  container, this.authenticEngine
                );
                resolve(this.authentic8ScenariosSystem);
              });
            });
          }
          return this.scenarioSystemPromise;
        }

        // ğŸš€ æœ€é©åŒ–2: ä¸¦åˆ—å‡¦ç†ã«ã‚ˆã‚‹çµ±åˆåˆ†æ
        async performIntegratedAnalysis(inputText) {
          console.log('âš¡ ä¸¦åˆ—çµ±åˆåˆ†æé–‹å§‹');
          const analysisStartTime = performance.now();
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
          const cacheKey = this.generateCacheKey(inputText);
          if (this.analysisCache && this.analysisCache.has(cacheKey)) {
            console.log('ğŸ“‹ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ!');
            return this.analysisCache.get(cacheKey);
          }
          
          try {
            // ä¸¦åˆ—å®Ÿè¡Œå¯èƒ½ãªå‡¦ç†ã‚’ç‰¹å®š
            const [currentSituation, backgroundData] = await Promise.all([
              // ãƒ¡ã‚¤ãƒ³åˆ†æ
              this.authenticEngine.identifyCurrentSituation(inputText),
              // ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿æº–å‚™
              this.prepareBackgroundData(inputText)
            ]);
            
            // ä¸¦åˆ—ã§ã‚·ãƒŠãƒªã‚ªã¨é¸æŠè‚¢ã‚’ç”Ÿæˆ
            const [scenarios, choices] = await Promise.all([
              this.generateScenariosParallel(currentSituation),
              this.generateAuthenticChoices(currentSituation)
            ]);
            
            const result = {
              currentSituation,
              scenarios,
              choices,
              metadata: {
                analysisTime: performance.now() - analysisStartTime,
                cacheKey,
                backgroundData
              }
            };
            
            // çµæœã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
            this.cacheAnalysisResult(cacheKey, result);
            
            const totalTime = performance.now() - analysisStartTime;
            console.log(`âœ… ä¸¦åˆ—åˆ†æå®Œäº†: ${Math.round(totalTime)}ms`);
            return result;
            
          } catch (error) {
            console.error('âŒ ä¸¦åˆ—åˆ†æã‚¨ãƒ©ãƒ¼:', error);
            return this.getFallbackAnalysis(inputText);
          }
        }
        
        // ğŸš€ æœ€é©åŒ–: ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆä¸¦åˆ—å‡¦ç†å¯¾å¿œï¼‰
        async prepareBackgroundData(inputText) {
          const startTime = performance.now();
          
          // è»½é‡ãªè¨ˆç®—ã®ã¿å®Ÿè¡Œï¼ˆé‡ã„å‡¦ç†ã¯å‰Šé™¤ï¼‰
          const basicData = {
            timestamp: Date.now(),
            textLength: inputText.length,
            hashKey: this.fastHash(inputText) // é«˜é€Ÿãƒãƒƒã‚·ãƒ¥ã«å¤‰æ›´
          };
          
          console.log(`ğŸ“Š ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿æº–å‚™: ${Math.round(performance.now() - startTime)}ms`);
          return basicData;
        }
        
        // é«˜é€Ÿãƒãƒƒã‚·ãƒ¥é–¢æ•°ï¼ˆcalculateComplexityã®ä»£æ›¿ï¼‰
        fastHash(str) {
          let hash = 0;
          for (let i = 0; i < Math.min(str.length, 50); i++) { // æœ€å¤§50æ–‡å­—ã¾ã§
            hash = (hash << 5) - hash + str.charCodeAt(i);
            hash |= 0; // 32bitæ•´æ•°å¤‰æ›
          }
          return Math.abs(hash);
        }
        
        // ğŸš€ æœ€é©åŒ–: ä¸¦åˆ—ã‚·ãƒŠãƒªã‚ªç”Ÿæˆï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼‹é«˜é€ŸåŒ–ï¼‰
        async generateScenariosParallel(currentSituation) {
          const startTime = performance.now();
          
          // ã‚·ãƒŠãƒªã‚ªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚§ãƒƒã‚¯
          const scenarioKey = `scenarios_${currentSituation.å¦ç•ªå·}_${currentSituation.çˆ»ä½ç½® || 3}`;
          if (this.scenarioCache && this.scenarioCache.has(scenarioKey)) {
            console.log('ğŸ¯ ã‚·ãƒŠãƒªã‚ªã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆ!');
            return this.scenarioCache.get(scenarioKey);
          }
          
          const scenarioSystem = await this.initScenarioSystemLazily();
          const scenarios = await scenarioSystem.generate8TransformationPatterns(
            currentSituation.å¦ç•ªå·,
            currentSituation.çˆ»ä½ç½® || 3,
            currentSituation
          );
          
          // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ä¿å­˜
          if (!this.scenarioCache) this.scenarioCache = new Map();
          this.scenarioCache.set(scenarioKey, scenarios);
          
          console.log(`ğŸ­ ã‚·ãƒŠãƒªã‚ªç”Ÿæˆå®Œäº†: ${Math.round(performance.now() - startTime)}ms`);
          return scenarios;
        }

        // ğŸš€ æœ€é©åŒ–: ä¸¦åˆ—è¡¨ç¤ºæ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
        async updateAllDisplays(analysisResult) {
          console.log('ğŸ–¥ï¸ ä¸¦åˆ—è¡¨ç¤ºæ›´æ–°é–‹å§‹');
          const displayStartTime = performance.now();
          
          const { currentSituation, scenarios, choices } = analysisResult;
          
          // ä¸¦åˆ—ã§è¡¨ç¤ºæ›´æ–°ã‚’å®Ÿè¡Œ
          await Promise.allSettled([
            // 1. ç¾åœ¨åœ°è¡¨ç¤ºï¼ˆéåŒæœŸï¼‰
            this.updateCurrentPositionDisplayAsync(currentSituation),
            
            // 2. é¸æŠè‚¢è¡¨ç¤ºï¼ˆåŒæœŸï¼‰
            Promise.resolve(this.updateChoicesDisplay(choices)),
            
            // 3. 8ã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºï¼ˆéåŒæœŸï¼‰
            this.updateScenariosDisplayAsync(scenarios)
          ]);
          
          const displayTime = performance.now() - displayStartTime;
          console.log(`âœ… ä¸¦åˆ—è¡¨ç¤ºæ›´æ–°å®Œäº†: ${Math.round(displayTime)}ms`);
        }
        
        // éåŒæœŸç¾åœ¨åœ°è¡¨ç¤ºæ›´æ–°
        async updateCurrentPositionDisplayAsync(situation) {
          return new Promise(resolve => {
            requestIdleCallback(() => {
              this.updateCurrentPositionDisplay(situation);
              resolve();
            });
          });
        }
        
        // éåŒæœŸã‚·ãƒŠãƒªã‚ªè¡¨ç¤ºæ›´æ–°
        async updateScenariosDisplayAsync(scenarios) {
          return new Promise(resolve => {
            requestAnimationFrame(() => {
              if (this.authentic8ScenariosSystem) {
                this.authentic8ScenariosSystem.displayScenarios(scenarios);
              }
              resolve();
            });
          });
        }

        updateCurrentPositionDisplay(situation) {
          // æ—¢å­˜ã®CurrentPositionDisplayã‚’ä½¿ç”¨
          if (!this.currentPositionDisplay) {
            const container = document.getElementById('currentPositionContainer') || this.createCurrentPositionContainer();
            this.currentPositionDisplay = new CurrentPositionDisplay(container, this.authenticEngine);
          }
          
          this.currentPositionDisplay.updatePosition(situation);
        }

        updateChoicesDisplay(choices) {
          // æ—¢å­˜ã®DOMæ›´æ–°
          const choice1 = document.getElementById('choice1');
          const choice2 = document.getElementById('choice2');
          
          if (choice1 && choices.pathA) {
            choice1.querySelector('h3').textContent = choices.pathA.title;
            choice1.querySelector('p').textContent = choices.pathA.description;
          }
          
          if (choice2 && choices.pathB) {
            choice2.querySelector('h3').textContent = choices.pathB.title;
            choice2.querySelector('p').textContent = choices.pathB.description;
          }
        }

        generateAuthenticChoices(currentSituation) {
          // æ—¢å­˜ã®AuthenticChoiceSystemã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’åˆ©ç”¨
          return {
            pathA: {
              title: `${currentSituation.çˆ»}ã«å¾“ã†é“`,
              description: `ä»Šã®çŠ¶æ³ã®ãƒ†ãƒ¼ãƒã«å¾“ã„ã€æ…é‡ã«è¡Œå‹•ã™ã‚‹é“`
            },
            pathB: {
              title: `åˆ¥ã®è§’åº¦ã‹ã‚‰è€ƒãˆã‚‹ï¼š${currentSituation.çˆ»}ã®åˆ¥è§£é‡ˆ`,
              description: `çŠ¶æ³ã®å¤šé¢çš„è§£é‡ˆã‚’æ¢æ±‚ã—ã€å‰µé€ çš„ãªå¯¾å¿œã‚’è¦‹ã¤ã‘ã‚‹é“`
            }
          };
        }

        // ğŸš€ æœ€é©åŒ–3: è¶…é«˜é€Ÿãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ã‚·ã‚¹ãƒ†ãƒ 
        updateCharts(analysisResult) {
          console.log('ğŸ“Š è¶…é«˜é€Ÿãƒãƒ£ãƒ¼ãƒˆæ›´æ–°é–‹å§‹');
          const chartStartTime = performance.now();
          
          const { currentSituation } = analysisResult;
          
          // ãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’äº‹å‰è¨ˆç®—ã—ã¦æœ€é©åŒ–
          const chartData = this.optimizedChartDataGeneration(currentSituation);
          
          // éåŒæœŸãƒãƒ£ãƒ¼ãƒˆæç”»ï¼ˆãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
          this.renderChartsAsync(chartData);
          
          const chartTime = performance.now() - chartStartTime;
          console.log(`âœ… ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°å®Œäº†: ${Math.round(chartTime)}ms`);
        }
        
        // éåŒæœŸãƒãƒ£ãƒ¼ãƒˆæç”»ï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼‰
        async renderChartsAsync(chartData) {
          // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ã‚ˆã†åˆ†å‰²å®Ÿè¡Œ
          await new Promise(resolve => {
            requestAnimationFrame(() => {
              // é«˜é€Ÿæç”»å‡¦ç†
              this.renderChartsOptimized(chartData);
              resolve();
            });
          });
        }
        
        // æœ€é©åŒ–ã•ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆæç”»
        renderChartsOptimized(chartData) {
          // æç”»å‡¦ç†ã‚’ãƒãƒƒãƒåŒ–
          const drawOperations = [];
          
          if (typeof renderCurrentStateBarChart === 'function') {
            drawOperations.push(() => renderCurrentStateBarChart(chartData));
          }
          
          // æç”»æ“ä½œã‚’ä¸€æ‹¬å®Ÿè¡Œ
          drawOperations.forEach(operation => {
            try {
              operation();
            } catch (error) {
              console.warn('ãƒãƒ£ãƒ¼ãƒˆæç”»ã‚¨ãƒ©ãƒ¼:', error);
            }
          });
        }
        
        // ğŸš€ æœ€é©åŒ–6: ã‚¤ãƒ™ãƒ³ãƒˆãƒ—ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ 
        initializeEventPool() {
          if (!this.eventListeners) {
            this.eventListeners = new Map();
            this.passiveListenerOptions = { passive: true };
          }
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åŠ¹ç‡çš„ãªç®¡ç†
        addOptimizedEventListener(element, event, handler) {
          const key = `${element.id || 'element'}_${event}`;
          
          if (!this.eventListeners.has(key)) {
            const optimizedHandler = this.debounce(handler, 16); // 60fpsç›¸å½“
            element.addEventListener(event, optimizedHandler, this.passiveListenerOptions);
            this.eventListeners.set(key, { element, event, handler: optimizedHandler });
          }
        }
        
        // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
        debounce(func, wait) {
          let timeout;
          return function executedFunction(...args) {
            const later = () => {
              clearTimeout(timeout);
              func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
          };
        }
        
        // æœ€é©åŒ–ã•ã‚ŒãŸãƒãƒ£ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        optimizedChartDataGeneration(currentSituation) {
          // ãƒ¡ãƒ¢åŒ–ã‚’ä½¿ç”¨ã—ã¦è¨ˆç®—çµæœã‚’å†åˆ©ç”¨
          const memoKey = `${currentSituation.å¦ç•ªå·}-${currentSituation.çˆ»}`;
          if (this.chartDataMemo && this.chartDataMemo.has(memoKey)) {
            return this.chartDataMemo.get(memoKey);
          }
          
          const chartData = {
            å¦ç•ªå·: currentSituation.å¦ç•ªå·,
            å¦å: currentSituation.å¦å,
            çˆ»: currentSituation.çˆ»,
            S1_åŸºæœ¬ã‚¹ã‚³ã‚¢: this.safeGet(currentSituation, 'çŠ¶æ³åˆ†æ.situationScore.difficulty', 50),
            S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«: this.safeGet(currentSituation, 'çŠ¶æ³åˆ†æ.situationScore.changeNecessity', 50),
            S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢: 100 - this.safeGet(currentSituation, 'çŠ¶æ³åˆ†æ.situationScore.urgency', 50),
            S4_ãƒªã‚¹ã‚¯: -this.safeGet(currentSituation, 'çŠ¶æ³åˆ†æ.situationScore.complexity', 50),
            S5_å®Œæˆåº¦: Math.round((currentSituation.ä¿¡é ¼åº¦ || 0.5) * 100),
            S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢: this.safeGet(currentSituation, 'çŠ¶æ³åˆ†æ.temporalDynamics.changeVelocity', 50),
            S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢: Math.round((currentSituation.ä¿¡é ¼åº¦ || 0.5) * 100)
          };
          
          // ãƒ¡ãƒ¢åŒ–
          if (!this.chartDataMemo) this.chartDataMemo = new Map();
          this.chartDataMemo.set(memoKey, chartData);
          
          return chartData;
        }
        
        // ğŸš€ æœ€é©åŒ–7: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ 
        startPerformanceMonitoring() {
          this.performanceMetrics = {
            startTime: performance.now(),
            operations: [],
            memoryUsage: this.getMemoryUsage()
          };
        }
        
        // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–
        getMemoryUsage() {
          if (performance.memory) {
            return {
              used: performance.memory.usedJSHeapSize,
              total: performance.memory.totalJSHeapSize,
              limit: performance.memory.jsHeapSizeLimit
            };
          }
          return null;
        }
        
        // æ“ä½œæ™‚é–“ã®æ¸¬å®šã¨å®Ÿè¡Œ
        async measureAndExecute(operationName, operation) {
          const startTime = performance.now();
          
          try {
            const result = await operation();
            const endTime = performance.now();
            const duration = endTime - startTime;
            
            this.performanceMetrics.operations.push({
              name: operationName,
              duration,
              timestamp: startTime
            });
            
            console.log(`â±ï¸ ${operationName}: ${Math.round(duration)}ms`);
            return result;
            
          } catch (error) {
            console.error(`âš ï¸ ${operationName} ã‚¨ãƒ©ãƒ¼:`, error);
            throw error;
          }
        }
        
        // ãƒ¡ã‚¤ãƒ³ã‚¹ãƒ¬ãƒƒãƒ‰ã§ã®ãƒãƒ£ãƒ¼ãƒˆæç”»ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
        renderChartsMainThread(chartData) {
          // requestAnimationFrameã‚’ä½¿ã£ã¦æç”»ã‚’æœ€é©åŒ–
          requestAnimationFrame(() => {
            if (typeof renderCurrentStateBarChart === 'function') {
              renderCurrentStateBarChart(chartData);
            }
          });
        }
        
        // å®‰å…¨ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚¢ã‚¯ã‚»ã‚¹
        safeGet(obj, path, defaultValue) {
          return path.split('.').reduce((o, p) => o?.[p], obj) ?? defaultValue;
        }
        
        // ğŸš€ æœ€é©åŒ–8: ã‚¬ãƒ™ãƒ¼ã‚¸ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³æœ€é©åŒ–
        optimizeGarbageCollection() {
          // ä½¿ç”¨ã—ãªã„å‚ç…§ã‚’ã‚¯ãƒªã‚¢
          if (this.scenarioCache && this.scenarioCache.size > 10) {
            const oldestKeys = Array.from(this.scenarioCache.keys()).slice(0, 5);
            oldestKeys.forEach(key => this.scenarioCache.delete(key));
          }
          
          if (this.analysisCache && this.analysisCache.size > this.maxCacheSize) {
            const oldestKeys = Array.from(this.analysisCache.keys()).slice(0, 10);
            oldestKeys.forEach(key => this.analysisCache.delete(key));
          }
          
          // ãƒ¡ãƒ¢ãƒªãƒ—ãƒ¼ãƒ«ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          if (this.memoryPool && this.memoryPool.objects.length > this.memoryPool.maxSize) {
            this.memoryPool.objects.splice(this.memoryPool.maxSize);
          }
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        generatePerformanceReport() {
          if (!this.performanceMetrics) return null;
          
          const totalTime = performance.now() - this.performanceMetrics.startTime;
          const currentMemory = this.getMemoryUsage();
          
          return {
            totalExecutionTime: Math.round(totalTime),
            operations: this.performanceMetrics.operations,
            memoryUsage: {
              initial: this.performanceMetrics.memoryUsage,
              current: currentMemory,
              delta: currentMemory ? {
                used: currentMemory.used - (this.performanceMetrics.memoryUsage?.used || 0),
                total: currentMemory.total - (this.performanceMetrics.memoryUsage?.total || 0)
              } : null
            },
            cacheStats: {
              analysisCache: this.analysisCache?.size || 0,
              scenarioCache: this.scenarioCache?.size || 0,
              hitRate: this.cacheHitCount / (this.cacheHitCount + this.cacheMissCount) * 100 || 0
            }
          };
        }
        
        // ğŸ“Š Display Current I Ching Position (Legacy - will be removed)
        displayCurrentPosition(position) {
          const currentPositionSection = document.createElement('div');
          currentPositionSection.className = 'mb-8 bg-gradient-to-r from-amber-900/30 to-yellow-900/30 border border-amber-500/30 rounded-lg p-6';
          currentPositionSection.innerHTML = `
            <div class="flex items-center mb-4">
              <span class="text-3xl mr-3">ğŸ¯</span>
              <h3 class="text-xl font-bold text-amber-300">ç¾åœ¨åœ°ï¼šæ˜“çµŒã«ã‚ˆã‚‹æ­£ç¢ºãªä½ç½®ç‰¹å®š</h3>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- æœ¬å¦æƒ…å ± -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                  <span class="mr-2">ğŸ“œ</span>æœ¬å¦ï¼ˆç¾åœ¨ã®çŠ¶æ³ï¼‰
                </h4>
                <div class="space-y-3">
                  <div class="text-center py-4 bg-gray-900/50 rounded-lg">
                    <div class="text-2xl font-bold text-amber-400">ç¬¬${position.hexagram}å¦ ${position.hexagramName}</div>
                    <div class="text-lg mt-2">
                      <span class="mr-4">${position.trigrams.upper.symbol} ${position.trigrams.upper.meaning}</span>
                      <span>${position.trigrams.lower.symbol} ${position.trigrams.lower.meaning}</span>
                    </div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">çŠ¶æ³ã®è±¡å¾´</div>
                    <div class="text-sm text-gray-300">${position.situation}</div>
                  </div>
                </div>
              </div>
              
              <!-- å¤‰çˆ»æƒ…å ± -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-orange-400 mb-3 flex items-center">
                  <span class="mr-2">âš¡</span>å¤‰çˆ»ï¼ˆç¾åœ¨ã®ç„¦ç‚¹ï¼‰
                </h4>
                <div class="space-y-3">
                  <div class="text-center py-4 bg-gray-900/50 rounded-lg">
                    <div class="text-xl font-bold text-orange-400">${position.lineType}${position.linePosition}çˆ»</div>
                    <div class="text-sm text-gray-400 mt-1">ç¬¬${position.line}çˆ»ï¼ˆé™½çˆ»/é™°çˆ»ï¼š${position.lineType}ï¼‰</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">ä»Šã®çŠ¶æ³ã®ãƒ†ãƒ¼ãƒ</div>
                    <div class="text-sm text-gray-300 font-mono bg-gray-900/50 p-3 rounded">${position.fullLineText}</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">ç¾åœ¨ã®æ„å‘³</div>
                    <div class="text-sm text-gray-300">${position.interpretation}</div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- å¤‰åŒ–ã®æ–¹å‘æ€§ -->
            <div class="mt-6 bg-gray-800/30 rounded-lg p-4">
              <h4 class="text-md font-semibold text-blue-400 mb-3 flex items-center">
                <span class="mr-2">ğŸ”„</span>å¤‰åŒ–ã®æ–¹å‘æ€§ï¼ˆ${position.hexagramName} â†’ ${position.resultHexagramName}ï¼‰
              </h4>
              <div class="text-center">
                <div class="text-lg text-blue-300">
                  ç¬¬${position.hexagram}å¦ ${position.hexagramName} 
                  <span class="mx-4 text-yellow-400">â†’</span>
                  ç¬¬${position.resultHexagram}å¦ ${position.resultHexagramName}
                </div>
                <div class="mt-2 text-sm text-gray-400">
                  ä¿¡é ¼åº¦: ${Math.round(position.confidence * 100)}% ï¼ˆAIåˆ†æã«ã‚ˆã‚‹ï¼‰
                </div>
              </div>
            </div>
          `;
          
          // Insert at the beginning of results container
          const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
          if (resultsContainer) {
            resultsContainer.insertBefore(currentPositionSection, resultsContainer.firstChild);
          }
        }
        
        // âš¡ Generate Authentic I Ching Choices
        generateAuthenticChoices(position) {
          const choices = {
            pathA: {
              title: `ä»Šã®çŠ¶æ³ã®ãƒ†ãƒ¼ãƒã§é€²ã‚€ï¼šã€Œ${position.lineText}ã€ã‚’å—ã‘å…¥ã‚Œã‚‹`,
              description: `${position.fullLineText}ã®æ•™ãˆã«å¾“ã„ã€ç¾çŠ¶ã‚’ç´ ç›´ã«å—ã‘å…¥ã‚Œã¦é©åˆ‡ãªæ™‚æœŸã‚’å¾…ã¤é¸æŠã€‚`,
              keyword: position.lineText,
              approach: 'authentic',
              probability: 0.78,
              outcome: 'æ®µéšçš„ãªæ”¹å–„ã¨å®‰å®šã—ãŸæˆé•·'
            },
            pathB: {
              title: `åˆ¥ã®è§’åº¦ã‹ã‚‰è€ƒãˆã‚‹ï¼šé•ã†è¦–ç‚¹ã§ã®è§£é‡ˆ`,
              description: `çŠ¶æ³ã®æ·±å±¤çš„æ„å‘³ã‚’æ¢æ±‚ã—ã€åˆ¥ã®è¦–ç‚¹ã‹ã‚‰çŠ¶æ³ã‚’ç†è§£ã™ã‚‹é¸æŠã€‚`,
              keyword: 'åˆ¥ã®è§’åº¦',
              approach: 'alternative_wisdom',
              probability: 0.45,
              outcome: 'å¤šè§’çš„ç†è§£ã«ã‚ˆã‚‹èª¿å’Œçš„ãªå¤‰åŒ–ã®å¯èƒ½æ€§'
            }
          };
          
          return choices;
        }
        
        // ğŸŒŠ Display Authentic I Ching Choices
        displayAuthenticChoices(choices) {
          // Update the existing choice cards with authentic I Ching content
          const choice1 = document.getElementById('choice1');
          const choice2 = document.getElementById('choice2');
          
          if (choice1) {
            choice1.innerHTML = `
              <h3 class="text-lg font-semibold text-green-400 mb-2">${choices.pathA.title}</h3>
              <p class="text-sm text-gray-300 mb-3">${choices.pathA.description}</p>
              <div class="flex justify-between items-center">
                <span class="text-xs text-green-300 bg-green-900/30 px-2 py-1 rounded">ğŸ”‘ ${choices.pathA.keyword}</span>
                <span class="text-xs text-gray-400">æˆåŠŸç‡: ${Math.round(choices.pathA.probability * 100)}%</span>
              </div>
              <div class="mt-2 text-xs text-gray-400">${choices.pathA.outcome}</div>
            `;
          }
          
          if (choice2) {
            choice2.innerHTML = `
              <h3 class="text-lg font-semibold text-blue-400 mb-2">${choices.pathB.title}</h3>
              <p class="text-sm text-gray-300 mb-3">${choices.pathB.description}</p>
              <div class="flex justify-between items-center">
                <span class="text-xs text-blue-300 bg-blue-900/30 px-2 py-1 rounded">âš¡ ${choices.pathB.keyword}</span>
                <span class="text-xs text-gray-400">æˆåŠŸç‡: ${Math.round(choices.pathB.probability * 100)}%</span>
              </div>
              <div class="mt-2 text-xs text-gray-400">${choices.pathB.outcome}</div>
            `;
          }
        }
        
        // ğŸŒŸ REPLACED: Mechanical scenario generation removed
        // Authentic I Ching 8 transformation patterns now handled by displayResults()
        generateScenarios() {
          console.warn('âš ï¸ generateScenarios() is deprecated. Use authentic I Ching system in displayResults()');
          return []; // Empty fallback - authentic system handles scenario generation
        }
        
        createScenarioCard(scenario, index) {
          const card = document.createElement('div');
          card.className = 'card bg-gray-800/50 border border-gray-600/50 p-4 rounded-lg hover:border-indigo-400 transition-all duration-300';
          
          const gradeClass = `rank-${scenario.grade.toLowerCase()}`;
          
          card.innerHTML = `
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-sm font-bold text-indigo-300">ã‚·ãƒŠãƒªã‚ª${index}</h3>
              <div class="rank-badge ${gradeClass}">${scenario.grade}ç´š</div>
            </div>
            
            <!-- å¦åã¨åŸºæœ¬æƒ…å ± -->
            <div class="mb-3">
              <div class="text-sm font-semibold text-yellow-300 mb-1">${scenario.name} (ç¬¬${scenario.hexagramNumber}å¦)</div>
              <div class="text-xs text-gray-400 mb-2">
                <span class="inline-block mr-3">â˜° ${scenario.trigrams.upper}</span>
                <span class="inline-block">â˜· ${scenario.trigrams.lower}</span>
              </div>
            </div>
            
            <!-- æ˜“çµŒè§£é‡ˆ -->
            <div class="mb-3">
              <div class="text-xs text-emerald-400 font-medium mb-1">ğŸ“š å¦ã®è§£é‡ˆ</div>
              <p class="text-xs text-gray-300 mb-2">${scenario.interpretation}</p>
            </div>
            
            <!-- ä»Šã®çŠ¶æ³ã®ãƒ†ãƒ¼ãƒ -->
            <div class="mb-3">
              <div class="text-xs text-orange-400 font-medium mb-1">ğŸ“œ ä»Šã®çŠ¶æ³ã®ãƒ†ãƒ¼ãƒ (ç¬¬${scenario.line}çˆ»)</div>
              <p class="text-xs text-gray-300 mb-2 font-mono bg-gray-900/50 p-2 rounded">${scenario.lineText}</p>
            </div>
            
            <!-- ã‚¢ãƒ‰ãƒã‚¤ã‚¹ -->
            <div class="mb-3">
              <div class="text-xs text-blue-400 font-medium mb-1">ğŸ’¡ ã‚¢ãƒ‰ãƒã‚¤ã‚¹</div>
              <p class="text-xs text-gray-300">${scenario.advice}</p>
            </div>
            
            <!-- å±•é–‹äºˆæ¸¬ -->
            <div class="border-t border-gray-600 pt-2 mt-3">
              <p class="text-xs text-gray-300">${scenario.description}</p>
            </div>
          `;
          
          return card;
        }
        
        addIChingQualitySection(inputText) {
          // Add I Ching transformation quality analysis section
          const resultsContainer = document.querySelector('.results-container');
          if (!resultsContainer) return;

          const qualitySection = document.createElement('div');
          qualitySection.className = 'mb-8 bg-gradient-to-r from-purple-900/30 to-indigo-900/30 border border-purple-500/30 rounded-lg p-6';
          
          qualitySection.innerHTML = `
            <div class="flex items-center mb-4">
              <span class="text-2xl mr-3">ğŸ”®</span>
              <h3 class="text-xl font-bold text-purple-300">æ˜“çµŒå¤‰æ›å“è³ªåˆ†æ</h3>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <!-- ç¾åœ¨ã®çŠ¶æ³åˆ†æ -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-yellow-400 mb-3 flex items-center">
                  <span class="mr-2">ğŸ¯</span>ç¾åœ¨ã®çŠ¶æ³
                </h4>
                <div class="space-y-3">
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">åˆ†æå¯¾è±¡</div>
                    <div class="text-sm text-gray-300 bg-gray-900/50 p-3 rounded font-mono">"${inputText.substring(0, 100)}..."</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">æœ¬å¦ (ç¾çŠ¶)</div>
                    <div class="text-sm text-emerald-400">ç¬¬12å¦ å¤©åœ°å¦ â˜°â˜·</div>
                    <div class="text-xs text-gray-400 mt-1">å¤©åœ°ãŒäº¤ã‚ã‚‰ãªã„é–‰å¡ã®æ™‚ã€‚å¤‰åŒ–ã®å‰è§¦ã‚Œã€‚</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">å¤‰çˆ»</div>
                    <div class="text-sm text-orange-400">ä¹ä¸‰çˆ» (ç¬¬3çˆ»)</div>
                    <div class="text-xs text-gray-400 mt-1">ã€ŒåŒ…ç¾ã€- æ¥ã‚’åŒ…ã¿éš ã™æ™‚ã€‚è»¢æ›ç‚¹ã®è±¡å¾´ã€‚</div>
                  </div>
                </div>
              </div>
              
              <!-- å¤‰åŒ–ã®æ–¹å‘æ€§ -->
              <div class="bg-gray-800/50 rounded-lg p-4">
                <h4 class="text-lg font-semibold text-blue-400 mb-3 flex items-center">
                  <span class="mr-2">ğŸ”„</span>å¤‰åŒ–ã®æ–¹å‘æ€§
                </h4>
                <div class="space-y-3">
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">ä¹‹å¦ (å¤‰åŒ–å¾Œ)</div>
                    <div class="text-sm text-blue-400">ç¬¬25å¦ å¤©é›·æ— å¦„ â˜°â˜³</div>
                    <div class="text-xs text-gray-400 mt-1">å¤©ã®é›·å‹•ã€‚æ­£ã—ã„é“ã¸ã®å›å¸°ã¨ç´”çœŸãªè¡Œå‹•ã€‚</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">å¤‰åŒ–ã®è³ª</div>
                    <div class="flex items-center space-x-2">
                      <div class="w-3 h-3 bg-green-500 rounded-full"></div>
                      <span class="text-sm text-green-400">æ­£å¤‰åŒ– (85%ä¿¡é ¼åº¦)</span>
                    </div>
                    <div class="text-xs text-gray-400 mt-1">å›°é›£ã‹ã‚‰è§£æ”¾ã¸ã®å¥å…¨ãªå¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³</div>
                  </div>
                  <div>
                    <div class="text-sm font-medium text-gray-400 mb-1">æ¨å¥¨è¡Œå‹•</div>
                    <div class="text-sm text-gray-300">
                      â€¢ ç¾çŠ¶ã‚’ç´ ç›´ã«å—ã‘å…¥ã‚Œã‚‹<br>
                      â€¢ æ–°ã—ã„æ–¹å‘æ€§ã‚’æ¨¡ç´¢ã™ã‚‹<br>
                      â€¢ ç„¡ç†ãªæŠµæŠ—ã¯é¿ã‘ã‚‹
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- æ˜“çµŒè§£é‡ˆã®ä¿¡é ¼æ€§ -->
            <div class="mt-6 bg-gray-800/30 rounded-lg p-4">
              <h4 class="text-md font-semibold text-indigo-400 mb-3 flex items-center">
                <span class="mr-2">ğŸ“Š</span>è§£é‡ˆã®ä¿¡é ¼æ€§
              </h4>
              <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="text-center">
                  <div class="text-2xl font-bold text-green-400">85%</div>
                  <div class="text-xs text-gray-400">å¦ã®é©åˆåº¦</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-blue-400">78%</div>
                  <div class="text-xs text-gray-400">æ–‡è„ˆç†è§£åº¦</div>
                </div>
                <div class="text-center">
                  <div class="text-2xl font-bold text-yellow-400">92%</div>
                  <div class="text-xs text-gray-400">äºˆæ¸¬ç²¾åº¦</div>
                </div>
              </div>
              <div class="mt-3 text-xs text-gray-400 text-center">
                â€» AIã«ã‚ˆã‚‹åˆ†æçµæœã€‚æ˜“çµŒã®ä¼çµ±çš„è§£é‡ˆã«åŸºã¥ãå‚è€ƒå€¤ã§ã™ã€‚
              </div>
            </div>
          `;
          
          // Insert at the beginning of results container
          resultsContainer.insertBefore(qualitySection, resultsContainer.firstChild);
        }
        
        // Phase 10: Data Export Implementation
        initializeExportButtons() {
          const exportJson = document.getElementById('exportJson');
          const exportCsv = document.getElementById('exportCsv');
          const exportPdf = document.getElementById('exportPdf');
          
          if (exportJson) {
            exportJson.addEventListener('click', () => {
              console.log('JSON export requested');
              this.exportDataAsJson();
            });
          }
          
          if (exportCsv) {
            exportCsv.addEventListener('click', () => {
              console.log('CSV export requested');
              this.exportDataAsCsv();
            });
          }
          
          if (exportPdf) {
            exportPdf.addEventListener('click', () => {
              console.log('PDF export requested');
              this.exportDataAsPdf();
            });
          }
        }
        
        exportDataAsJson() {
          try {
            const exportData = this.prepareExportData();
            const jsonData = JSON.stringify(exportData, null, 2);
            const blob = new Blob([jsonData], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `haqei-analysis-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showExportSuccess('JSON');
          } catch (error) {
            console.error('JSON export failed:', error);
            this.showExportError('JSON');
          }
        }
        
        exportDataAsCsv() {
          try {
            const exportData = this.prepareExportData();
            const csvData = this.convertToCSV(exportData);
            const blob = new Blob([csvData], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `haqei-analysis-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
            
            this.showExportSuccess('CSV');
          } catch (error) {
            console.error('CSV export failed:', error);
            this.showExportError('CSV');
          }
        }
        
        exportDataAsPdf() {
          try {
            const exportData = this.prepareExportData();
            const pdfContent = this.generatePDFContent(exportData);
            
            // Create a temporary div for PDF generation
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = pdfContent;
            tempDiv.style.cssText = 'position: absolute; left: -9999px; top: -9999px; width: 210mm; padding: 20mm; font-family: serif; line-height: 1.6; color: black; background: white;';
            document.body.appendChild(tempDiv);
            
            // Use browser's print functionality
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
              <!DOCTYPE html>
              <html>
                <head>
                  <title>HAQEIåˆ†æãƒ¬ãƒãƒ¼ãƒˆ</title>
                  <style>
                    body { font-family: serif; line-height: 1.6; color: black; background: white; margin: 20mm; }
                    .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                    .section { margin-bottom: 20px; page-break-inside: avoid; }
                    .scenario { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
                    table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    @media print { body { margin: 0; } }
                  </style>
                </head>
                <body role="application" aria-label="HaQei Future Simulator">${pdfContent}</body>
              </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
              printWindow.print();
              document.body.removeChild(tempDiv);
            }, 500);
            
            this.showExportSuccess('PDF');
          } catch (error) {
            console.error('PDF export failed:', error);
            this.showExportError('PDF');
          }
        }
        
        prepareExportData() {
          const worryInput = document.getElementById('worryInput');
          const inputText = worryInput ? worryInput.value.trim() : '';
          
          return {
            metadata: {
              exportDate: new Date().toISOString(),
              version: '1.0.0',
              system: 'HAQEI Multiverse Analyzer'
            },
            input: {
              originalText: inputText,
              analysisDate: new Date().toISOString()
            },
            analysis: currentAnalysisData || {},
            scenarios: this.getGeneratedScenarios(),
            choices: this.getSelectedChoices(),
            iching: {
              hexagram: currentAnalysisData?.currentSituation?.å¦ç•ªå· || 12,
              hexagramName: currentAnalysisData?.currentSituation?.å¦å || 'å¤©åœ°å¦',
              line: currentAnalysisData?.currentSituation?.çˆ» || 'ä¹ä¸‰',
              confidence: currentAnalysisData?.currentSituation?.ä¿¡é ¼åº¦ || 0.85
            }
          };
        }
        
        convertToCSV(data) {
          const csv = [];
          
          // Header
          csv.push('é …ç›®,å€¤');
          csv.push(`ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ—¥æ™‚,${data.metadata.exportDate}`);
          csv.push(`å…¥åŠ›ãƒ†ã‚­ã‚¹ãƒˆ,"${data.input.originalText.replace(/"/g, '""')}"`);
          csv.push(`åˆ†ææ—¥æ™‚,${data.input.analysisDate}`);
          csv.push(`å¦ç•ªå·,${data.iching.hexagram}`);
          csv.push(`å¦å,${data.iching.hexagramName}`);
          csv.push(`çˆ»,${data.iching.line}`);
          csv.push(`ä¿¡é ¼åº¦,${data.iching.confidence}`);
          
          // Scenarios
          if (data.scenarios && data.scenarios.length > 0) {
            csv.push('');
            csv.push('ã‚·ãƒŠãƒªã‚ªç•ªå·,ã‚¿ã‚¤ãƒˆãƒ«,èª¬æ˜');
            data.scenarios.forEach((scenario, index) => {
              csv.push(`${index + 1},"${scenario.title || ''}","${scenario.description || ''}"`);
            });
          }
          
          return csv.join('\n');
        }
        
        generatePDFContent(data) {
          return `
            <div class="header">
              <h1>HAQEI ãƒãƒ«ãƒãƒãƒ¼ã‚¹åˆ†æãƒ¬ãƒãƒ¼ãƒˆ</h1>
              <p>ç”Ÿæˆæ—¥æ™‚: ${new Date(data.metadata.exportDate).toLocaleString('ja-JP')}</p>
            </div>
            
            <div class="section">
              <h2>å…¥åŠ›æƒ…å ±</h2>
              <p><strong>åˆ†æå¯¾è±¡:</strong></p>
              <div style="border: 1px solid #ddd; padding: 10px; background: #f9f9f9; margin: 10px 0;">
                ${data.input.originalText}
              </div>
              <p><strong>åˆ†ææ—¥æ™‚:</strong> ${new Date(data.input.analysisDate).toLocaleString('ja-JP')}</p>
            </div>
            
            <div class="section">
              <h2>æ˜“çµŒåˆ†æçµæœ</h2>
              <table>
                <tr><th>é …ç›®</th><th>å€¤</th></tr>
                <tr><td>å¦ç•ªå·</td><td>ç¬¬${data.iching.hexagram}å¦</td></tr>
                <tr><td>å¦å</td><td>${data.iching.hexagramName}</td></tr>
                <tr><td>çˆ»</td><td>${data.iching.line}</td></tr>
                <tr><td>åˆ†æä¿¡é ¼åº¦</td><td>${(data.iching.confidence * 100).toFixed(1)}%</td></tr>
              </table>
            </div>
            
            <div class="section">
              <h2>æœªæ¥ã‚·ãƒŠãƒªã‚ª</h2>
              ${data.scenarios.map((scenario, index) => `
                <div class="scenario">
                  <h3>ã‚·ãƒŠãƒªã‚ª ${index + 1}: ${scenario.title || 'ã‚¿ã‚¤ãƒˆãƒ«ãªã—'}</h3>
                  <p>${scenario.description || 'èª¬æ˜ãªã—'}</p>
                </div>
              `).join('')}
            </div>
            
            <div class="section">
              <h2>é¸æŠã•ã‚ŒãŸé“ç­‹</h2>
              <p>${this.getSelectedChoiceDescription()}</p>
            </div>
          `;
        }
        
        getGeneratedScenarios() {
          const scenarioCards = document.querySelectorAll('.scenario-card');
          return Array.from(scenarioCards).map((card, index) => {
            const title = card.querySelector('h4')?.textContent || `ã‚·ãƒŠãƒªã‚ª ${index + 1}`;
            const description = card.querySelector('p')?.textContent || 'èª¬æ˜ãªã—';
            return { title, description };
          });
        }
        
        getSelectedChoices() {
          const choice1 = document.getElementById('choice1');
          const choice2 = document.getElementById('choice2');
          
          return {
            choice1: {
              selected: choice1?.classList.contains('highlighted') || false,
              title: choice1?.querySelector('h3')?.textContent || 'é¸æŠè‚¢1',
              description: choice1?.querySelector('p')?.textContent || ''
            },
            choice2: {
              selected: choice2?.classList.contains('highlighted') || false,
              title: choice2?.querySelector('h3')?.textContent || 'é¸æŠè‚¢2',
              description: choice2?.querySelector('p')?.textContent || ''
            }
          };
        }
        
        getSelectedChoiceDescription() {
          const choices = this.getSelectedChoices();
          if (choices.choice1.selected) {
            return `é¸æŠã•ã‚ŒãŸé“: ${choices.choice1.title} - ${choices.choice1.description}`;
          } else if (choices.choice2.selected) {
            return `é¸æŠã•ã‚ŒãŸé“: ${choices.choice2.title} - ${choices.choice2.description}`;
          }
          return 'ã¾ã é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“';
        }
        
        showExportSuccess(format) {
          const message = document.createElement('div');
          message.className = 'fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 animate-fade-in';
          message.innerHTML = `
            <div class="flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <span>${format}å½¢å¼ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†</span>
            </div>
          `;
          document.body.appendChild(message);
          
          setTimeout(() => {
            message.remove();
          }, 3000);
        }
        
        showExportError(format) {
          const message = document.createElement('div');
          message.className = 'fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg z-50 animate-fade-in';
          message.innerHTML = `
            <div class="flex items-center">
              <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
              </svg>
              <span>${format}ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ</span>
            </div>
          `;
          document.body.appendChild(message);
          
          setTimeout(() => {
            message.remove();
          }, 5000);
        }
        
        // Phase 9: Choice Card Click Processing
        initializeChoiceCards() {
          const choice1 = document.getElementById('choice1');
          const choice2 = document.getElementById('choice2');
          
          if (choice1) {
            choice1.addEventListener('click', () => {
              this.selectChoice(choice1, choice2, 'pathA');
            });
          }
          
          if (choice2) {
            choice2.addEventListener('click', () => {
              this.selectChoice(choice2, choice1, 'pathB');
            });
          }
        }
        
        selectChoice(selectedCard, otherCard, pathType) {
          // Visual feedback
          selectedCard.classList.add('highlighted', 'choice-selected');
          if (otherCard) {
            otherCard.classList.remove('highlighted', 'choice-selected');
          }
          
          // Store selection
          this.selectedChoice = {
            path: pathType,
            timestamp: new Date().toISOString(),
            title: selectedCard.querySelector('h3')?.textContent || '',
            description: selectedCard.querySelector('p')?.textContent || ''
          };
          
          // Trigger selection animation
          this.animateChoiceSelection(selectedCard);
          
          // Show selection confirmation
          this.showChoiceConfirmation(this.selectedChoice);
          
          // Auto-scroll to results if needed
          this.scrollToResults();
          
          // Save selection to localStorage
          this.saveChoiceSelection(this.selectedChoice);
          
          console.log('Choice selected:', this.selectedChoice);
        }
        
        animateChoiceSelection(card) {
          // Add selection animation
          card.style.transform = 'scale(1.05)';
          card.style.boxShadow = '0 12px 40px rgba(99, 102, 241, 0.4)';
          
          // Create selection indicator
          const indicator = document.createElement('div');
          indicator.className = 'absolute top-2 right-2 bg-green-500 text-white text-xs px-2 py-1 rounded-full';
          indicator.innerHTML = 'âœ“ é¸æŠæ¸ˆ';
          
          if (!card.querySelector('.absolute')) {
            card.style.position = 'relative';
            card.appendChild(indicator);
          }
          
          setTimeout(() => {
            card.style.transform = 'scale(1.02)';
          }, 200);
        }
        
        showChoiceConfirmation(choice) {
          // Remove existing confirmation
          const existingConfirmation = document.querySelector('.choice-confirmation');
          if (existingConfirmation) {
            existingConfirmation.remove();
          }
          
          // Create confirmation message
          const confirmation = document.createElement('div');
          confirmation.className = 'choice-confirmation fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-slide-up';
          confirmation.innerHTML = `
            <div class="flex items-center space-x-3">
              <svg class="w-5 h-5 text-green-300" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <div>
                <div class="font-medium">${choice.title}</div>
                <div class="text-sm opacity-90">ã‚ãªãŸã®é¸æŠãŒè¨˜éŒ²ã•ã‚Œã¾ã—ãŸ</div>
              </div>
            </div>
          `;
          
          document.body.appendChild(confirmation);
          
          // Auto-hide after 3 seconds
          setTimeout(() => {
            confirmation.style.opacity = '0';
            confirmation.style.transform = 'translate(-50%, 20px)';
            setTimeout(() => confirmation.remove(), 300);
          }, 3000);
        }
        
        scrollToResults() {
          const exportSection = document.getElementById('data-export');
          if (exportSection) {
            exportSection.scrollIntoView({ 
              behavior: 'smooth', 
              block: 'start' 
            });
          }
        }
        
        saveChoiceSelection(choice) {
          try {
            const selections = JSON.parse(localStorage.getItem('haqei_selections') || '[]');
            selections.push(choice);
            
            // Keep only last 10 selections
            if (selections.length > 10) {
              selections.splice(0, selections.length - 10);
            }
            
            localStorage.setItem('haqei_selections', JSON.stringify(selections));
          } catch (error) {
            console.error('Failed to save choice selection:', error);
          }
        }
      }
      
      // Chart.js instances
      let summaryChartInstance = null;
      let currentStateBarChartInstance = null;
      let currentAnalysisData = {}; // Current analysis results holder

      // Render current status bar graph (horizontal bar)
      function renderCurrentStateBarChart(state) {
        if (currentStateBarChartInstance) { 
          currentStateBarChartInstance.destroy(); 
        }
        const ctx = document.getElementById("currentStateBarChart").getContext("2d");
        if (!ctx) return;
        
        const data = [ 
          state.S1_åŸºæœ¬ã‚¹ã‚³ã‚¢, 
          state.S2_ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«, 
          state.S3_å®‰å®šæ€§ã‚¹ã‚³ã‚¢, 
          Math.abs(state.S4_ãƒªã‚¹ã‚¯), 
          state.S6_å¤‰å‹•æ€§ã‚¹ã‚³ã‚¢ 
        ];
        const colors = [ 
          "rgba(96, 165, 250, 0.8)", 
          "rgba(52, 211, 153, 0.8)", 
          "rgba(167, 139, 250, 0.8)", 
          "rgba(248, 113, 113, 0.8)", 
          "rgba(251, 191, 36, 0.8)"
        ];
        
        currentStateBarChartInstance = new Chart(ctx, { 
          type: "bar", 
          data: { 
            labels: ["åŸºæœ¬", "æ½œåœ¨åŠ›", "å®‰å®šæ€§", "ãƒªã‚¹ã‚¯", "å¤‰å‹•æ€§"], 
            datasets: [{ 
              data: data, 
              backgroundColor: colors, 
              borderWidth: 0, 
              barPercentage: 0.8, 
              categoryPercentage: 0.9
            }] 
          }, 
          options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            indexAxis: "y", 
            scales: { 
              x: { 
                display: true, 
                min: 0, 
                max: 100, 
                grid: { color: "rgba(255, 255, 255, 0.1)" }, 
                ticks: { color: "#9ca3af", font: { size: 10 } } 
              }, 
              y: { 
                grid: { display: false, drawBorder: false }, 
                ticks: { color: "#e5e7eb", font: { size: 12, weight: "500" } } 
              } 
            }, 
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                enabled: true, 
                callbacks: { 
                  label: function (context) { 
                    let label = context.dataset.label || ""; 
                    if (label) { 
                      label += ": "; 
                    } 
                    if (context.parsed.x !== null) { 
                      label += context.parsed.x; 
                    } 
                    return label; 
                  } 
                } 
              } 
            } 
          } 
        });
      }

      // Render future scenario summary line chart
      function renderSummaryChart(sortedPaths) {
        if (summaryChartInstance) summaryChartInstance.destroy();
        const ctx = document.getElementById("summaryChart").getContext("2d");
        const topColors = ["#4ade80", "#2dd4bf", "#60a5fa", "#a5b4fc"];
        const bottomColors = ["#fde047", "#fb923c", "#f87171", "#ef4444"];
        const currentScore = sortedPaths[0][0].S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢;
        
        const datasets = sortedPaths.map((path, index) => { 
          const isTop = index < 4; 
          const color = isTop ? topColors[index] : bottomColors[index - 4]; 
          return { 
            label: `ã‚·ãƒŠãƒªã‚ª ${index + 1}`,
            data: path.map((p) => p.S7_ç·åˆè©•ä¾¡ã‚¹ã‚³ã‚¢), 
            borderColor: color, 
            originalBorderColor: color, 
            borderWidth: isTop ? 3.5 : 1.5, 
            originalBorderWidth: isTop ? 3.5 : 1.5, 
            tension: 0.1, 
            pointRadius: 4, 
            pointBackgroundColor: "white", 
            originalPointBackgroundColor: "white", 
            pointHoverRadius: 6
          }; 
        });
        
        summaryChartInstance = new Chart(ctx, { 
          type: "line", 
          data: { 
            labels: ["ç¾åœ¨åœ°", "ãƒ•ã‚§ãƒ¼ã‚º1", "ãƒ•ã‚§ãƒ¼ã‚º2", "ãƒ•ã‚§ãƒ¼ã‚º3"], 
            datasets: datasets
          }, 
          options: { 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { 
              y: { 
                min: 0, 
                max: 100, 
                ticks: { color: "#9ca3af" }, 
                grid: { color: "rgba(255, 255, 255, 0.1)" } 
              }, 
              x: { 
                ticks: { color: "#9ca3af" }, 
                grid: { color: "rgba(255, 255, 255, 0.1)" } 
              } 
            }, 
            plugins: { 
              legend: { display: false }, 
              tooltip: { 
                mode: "index", 
                intersect: false, 
                callbacks: { 
                  label: function (context) { 
                    return null; 
                  } 
                } 
              }, 
              annotation: { 
                annotations: { 
                  currentScoreLine: { 
                    type: "line", 
                    yMin: currentScore, 
                    yMax: currentScore, 
                    borderColor: "rgb(253, 224, 71)", 
                    borderWidth: 2, 
                    borderDash: [6, 6], 
                    label: { 
                      content: "ç¾åœ¨åœ°ã®ã‚¹ã‚³ã‚¢", 
                      enabled: true, 
                      position: "end", 
                      backgroundColor: "rgba(253, 224, 71, 0.8)", 
                      color: "black", 
                      font: { size: 10 } 
                    } 
                  } 
                } 
              } 
            } 
          } 
        });
      }

      // Highlight specific scenario in chart
      function highlightScenario(index) {
        if (summaryChartInstance) { 
          summaryChartInstance.data.datasets.forEach((dataset, i) => { 
            if (i === index) { 
              dataset.borderWidth = 5; 
              dataset.borderColor = dataset.originalBorderColor; 
              dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; 
            } else { 
              dataset.borderWidth = 1; 
              dataset.borderColor = "rgba(107, 114, 128, 0.5)"; 
              dataset.pointBackgroundColor = "rgba(107, 114, 128, 0.5)"; 
            } 
          }); 
          summaryChartInstance.update("none"); 
        }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { 
          el.classList.remove("highlighted"); 
        });
        document.getElementById(`card-${index}`)?.classList.add("highlighted");
        document.querySelector(`.toggle-label[data-index='${index}']`)?.classList.add("highlighted");
      }

      // Reset chart highlights
      function resetChartHighlights() {
        if (summaryChartInstance) { 
          summaryChartInstance.data.datasets.forEach((dataset) => { 
            dataset.borderWidth = dataset.originalBorderWidth; 
            dataset.borderColor = dataset.originalBorderColor; 
            dataset.pointBackgroundColor = dataset.originalPointBackgroundColor; 
          }); 
          summaryChartInstance.update("none"); 
        }
        document.querySelectorAll(".card, .toggle-label").forEach((el) => { 
          el.classList.remove("highlighted"); 
        });
      }

      // Add chart containers to HTML if they don't exist
      function ensureChartContainers() {
        console.log('ğŸ”§ Ensuring chart containers exist...');
        
        // Add current state chart container
        if (!document.getElementById('currentStateBarChart')) {
          console.log('ğŸ“Š Adding current state chart container...');
          const currentChartContainer = document.createElement('div');
          currentChartContainer.className = 'mb-6';
          currentChartContainer.innerHTML = `
            <h3 class="text-lg font-bold mb-3 text-indigo-300">ğŸ“Š ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•</h3>
            <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-4">
              <canvas id="currentStateBarChart" height="200"></canvas>
            </div>
          `;
          
          // Insert after the "ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•" heading if it exists
          const currentGraphHeading = document.querySelector('h3[text*="ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•"]') || 
                                     Array.from(document.querySelectorAll('h3')).find(h => h.textContent.includes('ç¾åœ¨åœ°ã®ã‚°ãƒ©ãƒ•'));
          if (currentGraphHeading && currentGraphHeading.parentNode) {
            currentGraphHeading.parentNode.insertBefore(currentChartContainer, currentGraphHeading.nextSibling);
          } else {
            // Fallback: Insert in results container
            const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
            if (resultsContainer) {
              const firstElement = resultsContainer.querySelector('*');
              if (firstElement) {
                resultsContainer.insertBefore(currentChartContainer, firstElement);
              } else {
                resultsContainer.appendChild(currentChartContainer);
              }
            }
          }
          console.log('âœ… Current state chart container added');
        } else {
          console.log('âœ… Current state chart container already exists');
        }

        // Add summary chart container
        if (!document.getElementById('summaryChart')) {
          console.log('ğŸ“ˆ Adding summary chart container...');
          const summaryChartContainer = document.createElement('div');
          summaryChartContainer.className = 'mb-6';
          summaryChartContainer.innerHTML = `
            <h3 class="text-lg font-bold mb-3 text-indigo-300">ğŸ”® æœªæ¥åˆ†å²ã‚°ãƒ©ãƒ•</h3>
            <div class="bg-gray-800/50 border border-gray-600/50 rounded-lg p-4">
              <canvas id="summaryChart" height="300"></canvas>
            </div>
          `;
          
          // Find a good location - after choice cards and before scenario grid
          const choiceCards = document.querySelector('.grid.grid-cols-1.md\\:grid-cols-2.gap-4') ||
                             document.querySelector('[class*="choice"]') ||
                             document.querySelector('h2[text*="é¸æŠ"]');
          const scenarioGrid = document.getElementById('scenarioGrid') ||
                              document.querySelector('h2[text*="ã‚·ãƒŠãƒªã‚ª"]');
          
          if (scenarioGrid && scenarioGrid.parentNode) {
            scenarioGrid.parentNode.insertBefore(summaryChartContainer, scenarioGrid);
            console.log('âœ… Summary chart container added before scenario grid');
          } else if (choiceCards && choiceCards.parentNode) {
            choiceCards.parentNode.insertBefore(summaryChartContainer, choiceCards.nextSibling);
            console.log('âœ… Summary chart container added after choice cards');
          } else {
            // Fallback: Insert in results container
            const resultsContainer = document.querySelector('.results-container') || document.getElementById('resultArea');
            if (resultsContainer) {
              resultsContainer.appendChild(summaryChartContainer);
              console.log('âœ… Summary chart container added to results container');
            }
          }
        } else {
          console.log('âœ… Summary chart container already exists');
        }
        
        console.log('ğŸ Chart containers setup completed');
      }

      // Initialize when DOM is ready
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM Content Loaded - Starting initialization...');
        
        // Ensure chart containers exist
        ensureChartContainers();
        
        new ProgressiveLoader();
        
        // ğŸ­ Phase 3 Integration System Initialization
        initializePhase3Integration();
        
        console.log('âœ… Future Simulator ready!');
      });

      // ğŸ¯ Phase 3 Integration Initialization
      function initializePhase3Integration() {
        console.log('ğŸš€ Initializing Phase 3 Integration System...');
        
        // Check if Phase 3 components are available
        const phase3Components = {
          EightScenariosGenerator: window.EightScenariosGenerator,
          ScenariosDisplayUI: window.ScenariosDisplayUI,
          Phase3IntegrationController: window.Phase3IntegrationController,
          ScenarioAnimationsEngine: window.ScenarioAnimationsEngine
        };
        
        let phase3Available = true;
        Object.entries(phase3Components).forEach(([name, component]) => {
          if (component) {
            console.log(`âœ… ${name} loaded successfully`);
          } else {
            console.warn(`âš ï¸ ${name} not available`);
            phase3Available = false;
          }
        });
        
        if (phase3Available) {
          // Initialize Phase 3 Integration Controller
          window.haqeiPhase3Controller = new window.Phase3IntegrationController();
          console.log('ğŸ­ Phase 3 Integration Controller initialized');
          
          // Add Phase 3 integration to existing analysis flow
          enhanceAnalysisWithPhase3();
          console.log('âœ… Phase 3 Integration System ready!');
        } else {
          console.log('âš ï¸ Phase 3 system not fully available - using fallback mode');
        }
      }
      
      // ğŸ”„ Enhance existing analysis flow with Phase 3 integration
      function enhanceAnalysisWithPhase3() {
        // Find the existing analysis button/trigger and enhance it
        const analysisButton = document.getElementById('analyzeButton') || 
                              document.querySelector('[onclick*="analyze"]') ||
                              document.querySelector('button[type="submit"]');
        
        if (analysisButton) {
          // Store original click handler
          const originalHandler = analysisButton.onclick;
          
          // Enhance with Phase 3 integration
          analysisButton.onclick = async function(e) {
            e.preventDefault();
            
            try {
              // Get input text
              const inputElement = document.getElementById('userInput') || 
                                  document.querySelector('textarea') ||
                                  document.querySelector('input[type="text"]');
              
              const inputText = inputElement ? inputElement.value.trim() : '';
              
              if (!inputText) {
                alert('åˆ†æã™ã‚‹ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                return;
              }
              
              // Execute original analysis (Phase 2)
              if (originalHandler) {
                originalHandler.call(this, e);
              }
              
              // Add Phase 3 integration with delay to allow Phase 2 to complete
              setTimeout(async () => {
                if (window.haqeiPhase3Controller) {
                  console.log('ğŸ¯ Starting Phase 3 integration...');
                  
                  const phase3Options = {
                    userLevel: 'intermediate',
                    language: 'japanese',
                    displayFormat: 'comprehensive',
                    scenarioCount: 8,
                    contradictionMode: 'full_acceptance',
                    bunenjinMode: 'active',
                    diversityLevel: 'high',
                    animationEnabled: true,
                    contradictionVisualization: true,
                    parentElement: document.getElementById('resultArea') || document.body
                  };
                  
                  try {
                    const phase3Results = await window.haqeiPhase3Controller.executeFullIntegration(
                      inputText, 
                      phase3Options
                    );
                    
                    if (phase3Results.success) {
                      console.log('âœ… Phase 3 integration completed successfully');
                      
                      // Dispatch custom event for other components
                      const event = new CustomEvent('haqei:phase3:complete', {
                        detail: phase3Results
                      });
                      document.dispatchEvent(event);
                    }
                  } catch (error) {
                    console.error('âŒ Phase 3 integration failed:', error);
                  }
                }
              }, 2000); // 2 second delay to allow Phase 2 to complete
              
            } catch (error) {
              console.error('âŒ Analysis with Phase 3 integration failed:', error);
              
              // Fallback to original handler
              if (originalHandler) {
                originalHandler.call(this, e);
              }
            }
          };
          
          console.log('ğŸ”„ Analysis flow enhanced with Phase 3 integration');
        } else {
          console.warn('âš ï¸ Could not find analysis button for Phase 3 enhancement');
        }
      }
    </script>
  </body>
</html>