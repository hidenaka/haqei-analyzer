<\!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triple OS Analysis Engine - Verification Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background: #1a1a1a; color: #fff; }
        .test-container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: #2a2a2a; padding: 20px; margin: 20px 0; border-radius: 8px; border: 1px solid #333; }
        .test-title { color: #4CAF50; font-size: 1.5em; margin-bottom: 15px; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: #1b5e20; border-left: 4px solid #4CAF50; }
        .fail { background: #b71c1c; border-left: 4px solid #f44336; }
        .info { background: #1a237e; border-left: 4px solid #2196F3; }
        .hexagram-result { background: #3e2723; border: 1px solid #8d6e63; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .hexagram-name { color: #ffab91; font-weight: bold; font-size: 1.1em; }
        .hexagram-id { color: #81c784; font-weight: bold; }
        button { background: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #45a049; }
        .progress { background: #333; height: 4px; border-radius: 2px; margin: 10px 0; overflow: hidden; }
        .progress-bar { background: #4CAF50; height: 100%; transition: width 0.3s; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🧪 HAQEI Triple OS Analysis Engine - 完全検証テスト</h1>
        
        <div class="test-section">
            <div class="test-title">📋 検証項目一覧</div>
            <div class="test-result info">
                <strong>検証項目:</strong>
                <ul>
                    <li>✅ UltraAnalysisEngine クラスの実装確認</li>
                    <li>✅ analyzeTripleOS メソッドの動作確認</li>
                    <li>✅ 64卦データベースの整合性確認</li>
                    <li>✅ Engine OS: 8次元ベクトル→64卦変換</li>
                    <li>✅ Interface OS: 社会的パターン→64卦変換</li>
                    <li>✅ Safe Mode OS: 防御パターン→64卦変換</li>
                    <li>✅ 3つのOSの独立性確認</li>
                    <li>✅ エラーハンドリング確認</li>
                </ul>
            </div>
        </div>

        <div class="test-section">
            <div class="test-title">🎯 テスト実行</div>
            <button onclick="runComprehensiveTest()">📊 包括的テスト実行</button>
            <button onclick="runMultipleAnalysis()">🔄 複数回分析テスト</button>
            <button onclick="runEdgeCaseTest()">⚠️ エッジケーステスト</button>
            <button onclick="clearResults()">🗑️ 結果クリア</button>
            
            <div id="progress-container" style="display: none;">
                <div class="progress">
                    <div class="progress-bar" id="progress-bar" style="width: 0%;"></div>
                </div>
                <p id="progress-text">テスト準備中...</p>
            </div>
        </div>

        <div id="results-container"></div>
    </div>

    <script>
        // Test framework
        let testResults = [];
        
        function log(message, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            resultDiv.innerHTML = message;
            
            let container = document.getElementById('results-container');
            if (\!container) {
                container = document.createElement('div');
                container.id = 'results-container';
                document.querySelector('.test-container').appendChild(container);
            }
            container.appendChild(resultDiv);
        }

        function updateProgress(percentage, text) {
            const progressContainer = document.getElementById('progress-container');
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressContainer) {
                progressContainer.style.display = percentage > 0 ? 'block' : 'none';
                if (progressBar) progressBar.style.width = percentage + '%';
                if (progressText) progressText.textContent = text;
            }
        }

        function clearResults() {
            const container = document.getElementById('results-container');
            if (container) {
                container.innerHTML = '';
            }
            testResults = [];
            updateProgress(0, '');
        }

        // Generate test answers
        function generateTestAnswers(pattern = 'balanced') {
            const answers = {};
            
            switch (pattern) {
                case 'creative':
                    // 創造性重視パターン
                    for (let i = 1; i <= 30; i++) {
                        if (i <= 3) answers[`q${i}`] = '5';      // 創造性高
                        else if (i <= 6) answers[`q${i}`] = '4'; // 行動性中高
                        else if (i <= 24) answers[`q${i}`] = '3'; // その他バランス
                        else answers[`q${i}`] = String(Math.floor(Math.random() * 3) + 3); // 社会的パターンランダム
                    }
                    break;
                case 'stable':
                    // 安定性重視パターン
                    for (let i = 1; i <= 30; i++) {
                        if (i >= 10 && i <= 12) answers[`q${i}`] = '5';  // 安定性高
                        else if (i >= 13 && i <= 15) answers[`q${i}`] = '4'; // 受容性中高
                        else if (i <= 24) answers[`q${i}`] = '3';
                        else answers[`q${i}`] = String(Math.floor(Math.random() * 3) + 2);
                    }
                    break;
                case 'social':
                    // 社会性重視パターン
                    for (let i = 1; i <= 30; i++) {
                        if (i <= 24) answers[`q${i}`] = '3';
                        else answers[`q${i}`] = String(Math.floor(Math.random() * 2) + 4); // 社会的パターン高
                    }
                    break;
                case 'defensive':
                    // 防御的パターン
                    for (let i = 1; i <= 30; i++) {
                        answers[`q${i}`] = String(Math.floor(Math.random() * 2) + 1); // 低スコア中心
                    }
                    break;
                default:
                    // バランス型
                    for (let i = 1; i <= 30; i++) {
                        answers[`q${i}`] = String(Math.floor(Math.random() * 5) + 1);
                    }
            }
            
            return answers;
        }

        // Main comprehensive test
        async function runComprehensiveTest() {
            clearResults();
            updateProgress(5, 'テスト開始...');
            
            log('<h2>🧪 包括的検証テスト開始</h2>', 'info');
            
            try {
                updateProgress(10, 'UltraAnalysisEngine の確認中...');
                
                // 1. Class existence check
                if (typeof UltraAnalysisEngine === 'undefined') {
                    log('❌ UltraAnalysisEngine クラスが見つかりません', 'fail');
                    return;
                } else {
                    log('✅ UltraAnalysisEngine クラスが正常に定義されています', 'pass');
                }
                
                updateProgress(20, 'エンジンインスタンスを作成中...');
                
                // 2. Create instance
                const engine = new UltraAnalysisEngine();
                log('✅ UltraAnalysisEngine インスタンスが正常に作成されました', 'pass');
                
                updateProgress(30, '64卦データベースを検証中...');
                
                // 3. Check hexagram database
                if (engine.H64_HEXAGRAMS && engine.H64_HEXAGRAMS.length === 64) {
                    log(`✅ 64卦データベースが正常に初期化されました (${engine.H64_HEXAGRAMS.length}卦)`, 'pass');
                } else {
                    log(`⚠️ 64卦データベースに問題があります (${engine.H64_HEXAGRAMS ? engine.H64_HEXAGRAMS.length : 0}卦)`, 'fail');
                }
                
                updateProgress(40, '三爻テーブルを検証中...');
                
                // 4. Check trigram table
                if (engine.trigramTable && Object.keys(engine.trigramTable).length === 8) {
                    log('✅ 三爻変換テーブルが正常に定義されています', 'pass');
                } else {
                    log('❌ 三爻変換テーブルに問題があります', 'fail');
                }
                
                updateProgress(50, 'テストデータで分析実行中...');
                
                // 5. Test analysis with various patterns
                const testPatterns = ['balanced', 'creative', 'stable', 'social', 'defensive'];
                let successCount = 0;
                
                for (let i = 0; i < testPatterns.length; i++) {
                    const pattern = testPatterns[i];
                    updateProgress(50 + (i * 8), `${pattern} パターンで分析中...`);
                    
                    try {
                        const testAnswers = generateTestAnswers(pattern);
                        const results = engine.analyzeTripleOS(testAnswers);
                        
                        if (results && results.engineOS && results.interfaceOS && results.safeModeOS) {
                            successCount++;
                            
                            // Validate hexagram IDs are within 1-64 range
                            const engineValid = results.engineOS.hexagramId >= 1 && results.engineOS.hexagramId <= 64;
                            const interfaceValid = results.interfaceOS.hexagramId >= 1 && results.interfaceOS.hexagramId <= 64;
                            const safeModeValid = results.safeModeOS.hexagramId >= 1 && results.safeModeOS.hexagramId <= 64;
                            
                            if (engineValid && interfaceValid && safeModeValid) {
                                log(`<div class="hexagram-result">
                                    <strong>✅ ${pattern} パターン分析成功</strong><br>
                                    <span class="hexagram-name">Engine OS:</span> <span class="hexagram-id">${results.engineOS.hexagramId}. ${results.engineOS.name}</span><br>
                                    <span class="hexagram-name">Interface OS:</span> <span class="hexagram-id">${results.interfaceOS.hexagramId}. ${results.interfaceOS.name}</span><br>
                                    <span class="hexagram-name">Safe Mode OS:</span> <span class="hexagram-id">${results.safeModeOS.hexagramId}. ${results.safeModeOS.name}</span>
                                </div>`, 'pass');
                            } else {
                                log(`❌ ${pattern} パターン: 卦番号が範囲外です (E:${results.engineOS.hexagramId}, I:${results.interfaceOS.hexagramId}, S:${results.safeModeOS.hexagramId})`, 'fail');
                            }
                            
                        } else {
                            log(`❌ ${pattern} パターンで分析に失敗しました`, 'fail');
                        }
                        
                    } catch (error) {
                        log(`❌ ${pattern} パターンでエラーが発生: ${error.message}`, 'fail');
                    }
                }
                
                updateProgress(90, '結果を評価中...');
                
                // 6. Overall assessment
                const successRate = (successCount / testPatterns.length) * 100;
                if (successRate >= 80) {
                    log(`<h3>🎉 総合評価: 優秀 (${successCount}/${testPatterns.length} パターン成功, ${successRate}%)</h3>`, 'pass');
                } else if (successRate >= 60) {
                    log(`<h3>⚠️ 総合評価: 良好 (${successCount}/${testPatterns.length} パターン成功, ${successRate}%)</h3>`, 'info');
                } else {
                    log(`<h3>❌ 総合評価: 要改善 (${successCount}/${testPatterns.length} パターン成功, ${successRate}%)</h3>`, 'fail');
                }
                
                updateProgress(100, 'テスト完了');
                
            } catch (error) {
                log(`❌ テスト実行中に重大エラー: ${error.message}`, 'fail');
                console.error('Test error:', error);
            }
        }

        // Multiple analysis test for consistency
        async function runMultipleAnalysis() {
            clearResults();
            log('<h2>🔄 複数回分析一貫性テスト</h2>', 'info');
            
            try {
                const engine = new UltraAnalysisEngine();
                const testAnswers = generateTestAnswers('balanced');
                const results = [];
                
                updateProgress(10, '同一データで複数回分析中...');
                
                // Run same analysis 5 times
                for (let i = 0; i < 5; i++) {
                    const result = engine.analyzeTripleOS(testAnswers);
                    results.push(result);
                    updateProgress(20 + (i * 15), `分析 ${i + 1}/5 完了`);
                }
                
                // Check consistency
                const firstResult = results[0];
                let consistent = true;
                
                for (let i = 1; i < results.length; i++) {
                    if (results[i].engineOS.hexagramId \!== firstResult.engineOS.hexagramId ||
                        results[i].interfaceOS.hexagramId \!== firstResult.interfaceOS.hexagramId ||
                        results[i].safeModeOS.hexagramId \!== firstResult.safeModeOS.hexagramId) {
                        consistent = false;
                        break;
                    }
                }
                
                updateProgress(100, 'テスト完了');
                
                if (consistent) {
                    log(`✅ 一貫性テスト成功: 同一入力で同一結果を出力`, 'pass');
                    log(`<div class="hexagram-result">
                        <strong>安定した結果:</strong><br>
                        Engine OS: ${firstResult.engineOS.hexagramId}. ${firstResult.engineOS.name}<br>
                        Interface OS: ${firstResult.interfaceOS.hexagramId}. ${firstResult.interfaceOS.name}<br>
                        Safe Mode OS: ${firstResult.safeModeOS.hexagramId}. ${firstResult.safeModeOS.name}
                    </div>`, 'pass');
                } else {
                    log('❌ 一貫性テスト失敗: 同一入力で異なる結果が出力されました', 'fail');
                }
                
            } catch (error) {
                log(`❌ 複数回分析テストでエラー: ${error.message}`, 'fail');
            }
        }

        // Edge case testing
        async function runEdgeCaseTest() {
            clearResults();
            log('<h2>⚠️ エッジケーステスト</h2>', 'info');
            
            try {
                const engine = new UltraAnalysisEngine();
                
                updateProgress(10, '空データテスト中...');
                
                // Test with empty answers
                try {
                    const result1 = engine.analyzeTripleOS({});
                    log('✅ 空データでもエラーなく処理されました', 'pass');
                } catch (error) {
                    log(`⚠️ 空データでエラー: ${error.message}`, 'fail');
                }
                
                updateProgress(30, '最小値テスト中...');
                
                // Test with all minimum values
                const minAnswers = {};
                for (let i = 1; i <= 30; i++) {
                    minAnswers[`q${i}`] = '1';
                }
                
                try {
                    const result2 = engine.analyzeTripleOS(minAnswers);
                    if (result2.engineOS.hexagramId >= 1 && result2.engineOS.hexagramId <= 64) {
                        log('✅ 最小値データで正常な64卦を出力', 'pass');
                    } else {
                        log(`❌ 最小値データで無効な卦番号: ${result2.engineOS.hexagramId}`, 'fail');
                    }
                } catch (error) {
                    log(`❌ 最小値データでエラー: ${error.message}`, 'fail');
                }
                
                updateProgress(60, '最大値テスト中...');
                
                // Test with all maximum values
                const maxAnswers = {};
                for (let i = 1; i <= 30; i++) {
                    maxAnswers[`q${i}`] = '5';
                }
                
                try {
                    const result3 = engine.analyzeTripleOS(maxAnswers);
                    if (result3.engineOS.hexagramId >= 1 && result3.engineOS.hexagramId <= 64) {
                        log('✅ 最大値データで正常な64卦を出力', 'pass');
                    } else {
                        log(`❌ 最大値データで無効な卦番号: ${result3.engineOS.hexagramId}`, 'fail');
                    }
                } catch (error) {
                    log(`❌ 最大値データでエラー: ${error.message}`, 'fail');
                }
                
                updateProgress(90, '無効データテスト中...');
                
                // Test with invalid values
                const invalidAnswers = {};
                for (let i = 1; i <= 30; i++) {
                    invalidAnswers[`q${i}`] = 'invalid';
                }
                
                try {
                    const result4 = engine.analyzeTripleOS(invalidAnswers);
                    log('✅ 無効データでもエラーなく処理されました', 'pass');
                } catch (error) {
                    log(`⚠️ 無効データでエラー: ${error.message}`, 'info');
                }
                
                updateProgress(100, 'エッジケーステスト完了');
                
            } catch (error) {
                log(`❌ エッジケーステストで重大エラー: ${error.message}`, 'fail');
            }
        }

        // Auto-load emergency_haqei.html script content
        window.onload = function() {
            log('🚀 Triple OS Analysis Engine 検証ツール準備完了', 'info');
            log('emergency_haqei.html から UltraAnalysisEngine を読み込んでください', 'info');
        };
    </script>
</body>
</html>
EOF < /dev/null