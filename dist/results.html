<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI - 仮想人格対話型自己理解プラットフォーム</title>
    <meta name="description" content="あなたの内なる3つのOS（価値観・社会的側面・防御的側面）との対話を通じて、深い自己理解を促進する革新的なプラットフォーム">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Existing Styles -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/interactive-ui.css">
    
    <!-- New Style for Virtual Persona -->
    <link rel="stylesheet" href="css/virtual-persona-results.css">
    
    <!-- Ultra-Sync Engaging Loading Experience -->
    <link rel="stylesheet" href="css/ultra-sync-engaging.css">
    
    <!-- VP Main Container Fix -->
    <link rel="stylesheet" href="css/vp-main-container-fix.css">
    
    <!-- Construction View Disable - 構築演出ビューを完全無効化 -->
    <link rel="stylesheet" href="css/construction-view-disable.css">
    
    <!-- Emergency CSS fixes for view display -->
    <style>
        /* Emergency fix for main content display */
        #virtual-persona-container {
            min-height: 100vh;
            background: #0F172A;
            color: #F1F5F9;
        }
        
        /* Ensure views are visible when active */
        .vp-view.active {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Force container visibility */
        .vp-main-content {
            display: block !important;
            min-height: 80vh;
        }
        
        /* Loading overlay fix */
        .loading-overlay:not(.active) {
            display: none !important;
        }
        
        /* Debug styles for troubleshooting */
        .debug-visible {
            border: 2px solid #ff00ff !important;
            background: rgba(255, 0, 255, 0.1) !important;
        }
    </style>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- 
    仮想人格対話型自己理解プラットフォーム
    
    概要：
    このページは、ユーザーの診断結果から構築された仮想人格（3つのOS）との
    対話を通じて、深い自己理解を促進するインタラクティブなプラットフォームです。
    
    主要機能：
    1. 仮想人格の段階的構築演出
    2. 3つのOS間の相互作用可視化
    3. 内部対話の再生・シミュレーション
    4. 易経メタファーによる深い洞察
    5. 実践的な自己理解ガイダンス
    -->
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay active">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2 class="loading-title">あなたの回答を分析中...</h2>
            <p class="loading-description">実際の回答データを使用して、最新の分析結果を生成しています</p>
        </div>
    </div>
    
    <!-- Main Container -->
    <div id="virtual-persona-container" class="virtual-persona-container">
        <!-- VirtualPersonaResultsViewがここに動的にコンテンツを生成 -->
    </div>
    
    <!-- Error Display -->
    <div id="error-container" class="error-container" style="display: none;">
        <div class="error-content">
            <h2>エラーが発生しました</h2>
            <p id="error-message"></p>
            <button onclick="location.reload()" class="error-retry-button">再読み込み</button>
        </div>
    </div>
    
    <!-- データファイル -->
    <script type="text/javascript" src="./js/shared/data/questions.js"></script>
    <script type="text/javascript" src="./js/shared/data/vectors.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagrams.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagram_details.js"></script>
    <script type="text/javascript" src="./js/data/data_box.js"></script>
    
    <!-- ユーティリティ -->
    <script type="text/javascript" src="./js/shared/utils/validators.js"></script>
    <script type="text/javascript" src="./js/shared/utils/animations.js"></script>
    
    <!-- 基盤ライブラリ -->
    <script type="text/javascript" src="./js/shared/core/BaseComponent.js"></script>
    <script type="text/javascript" src="./js/shared/core/StorageManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/SimpleStorageManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/DataManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/ErrorHandler.js"></script>
    
    <!-- 仮想人格関連エンジン -->
    <script type="text/javascript" src="./js/os-analyzer/core/Calculator.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/IChingUltraSyncLogic.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/TripleOSEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/UltraAnalysisEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/PersonalityOS.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/VirtualPersonality.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/OSRelationshipEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/IchingMetaphorEngine.js"></script>
    
    <!-- UI/UXコンポーネント -->
    <script type="text/javascript" src="./js/os-analyzer/components/PersonalityConstructionView.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/components/DialoguePlayer.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/components/OSVoiceSwitcher.js"></script>
    
    <!-- 新規作成：仮想人格結果表示ビュー -->
    <script type="text/javascript" src="./js/components/VirtualPersonaResultsView.js"></script>
    
    <!-- Ultra-Sync Performance Optimizer -->
    <script type="text/javascript" src="./js/performance-ultra-sync.js"></script>
    
    <script>
        /**
         * 仮想人格対話型自己理解プラットフォーム - 初期化スクリプト
         * 
         * 目的：
         * - 診断結果の読み込み
         * - 仮想人格の構築
         * - インタラクティブUIの初期化
         * 
         * 処理フロー：
         * 1. localStorageから診断結果を取得
         * 2. 必要なデータの検証
         * 3. VirtualPersonaResultsViewの初期化
         * 4. 仮想人格構築プロセスの開始
         */
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 仮想人格対話型自己理解プラットフォーム - 初期化開始');
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            
            try {
                // 🔧 修正: 実際の回答データを取得して分析を再実行
                const storageManager = new StorageManager();
                
                // DataManagerを最初に初期化
                const dataManager = new DataManager();
                await dataManager.loadData();
                console.log('✅ DataManager initialized');
                
                // 保存されている回答データを取得
                const userAnswers = storageManager.getAnswers() || [];
                console.log('📝 Retrieved user answers for re-analysis:', userAnswers.length);
                
                let analysisResult = null;
                let insights = null;
                
                // 回答データが存在する場合は再分析を実行
                if (userAnswers.length > 0) {
                    console.log('🔄 Running fresh analysis with actual user answers...');
                    
                    
                    // UltraAnalysisEngineを初期化（app.jsと同じ方式）
                    let analysisEngine = null;
                    
                    if (typeof UltraAnalysisEngine !== 'undefined') {
                        analysisEngine = new UltraAnalysisEngine(dataManager);
                        console.log('✅ UltraAnalysisEngine initialized');
                    } else {
                        console.warn('⚠️ UltraAnalysisEngine not available, using TripleOSEngine');
                        analysisEngine = new TripleOSEngine(dataManager);
                    }
                    
                    // 実際の回答データで分析実行
                    try {
                        // 🔍 デバッグ: 回答データの詳細確認
                        console.log('🔍 Detailed user answers analysis:');
                        userAnswers.forEach((answer, index) => {
                            console.log(`Answer ${index + 1}:`, {
                                questionId: answer.questionId,
                                selectedValue: answer.selectedValue,
                                innerChoice: answer.innerChoice,
                                outerChoice: answer.outerChoice,
                                scoring_tags: answer.scoring_tags
                            });
                        });
                        
                        analysisResult = await analysisEngine.analyzeTripleOS(userAnswers);
                        
                        // 🔍 デバッグ: 分析結果の詳細確認
                        console.log('🔍 Analysis result details:');
                        console.log('- Engine OS:', {
                            name: analysisResult.engineOS?.name,
                            hexagramId: analysisResult.engineOS?.hexagramId,
                            activation: analysisResult.engineOS?.activation,
                            similarity: analysisResult.engineOS?.similarity
                        });
                        console.log('- Interface OS:', {
                            name: analysisResult.interfaceOS?.name,
                            hexagramId: analysisResult.interfaceOS?.hexagramId,
                            activation: analysisResult.interfaceOS?.activation
                        });
                        console.log('- SafeMode OS:', {
                            name: analysisResult.safeModeOS?.name,
                            hexagramId: analysisResult.safeModeOS?.hexagramId,
                            activation: analysisResult.safeModeOS?.activation
                        });
                        console.log('- Consistency Score:', analysisResult.consistencyScore);
                        
                        if (typeof analysisEngine.generateInsights === 'function') {
                            insights = await analysisEngine.generateInsights(analysisResult);
                            console.log('🔍 Generated insights:', insights);
                        }
                        console.log('✅ Fresh analysis completed with user data');
                        
                        // 新しい分析結果を保存
                        storageManager.saveAnalysisResult(analysisResult);
                        if (insights) storageManager.saveInsights(insights);
                    } catch (analysisError) {
                        console.error('❌ Fresh analysis failed:', analysisError);
                        // フォールバック: 保存されている結果を使用
                        analysisResult = storageManager.getAnalysisResult();
                        insights = storageManager.getInsights();
                    }
                } else {
                    console.log('📚 No user answers found, using stored analysis result');
                    // フォールバック: 保存されている結果を使用
                    analysisResult = storageManager.getAnalysisResult();
                    insights = storageManager.getInsights();
                }
                
                // SimpleStorageManagerも初期化（フォールバック用）
                const simpleStorageManager = new SimpleStorageManager();
                
                console.log('📊 診断結果の取得完了:', {
                    hasAnalysisResult: !!analysisResult,
                    hasInsights: !!insights
                });
                
                // SimpleStorageManagerでの取得試行
                if (!analysisResult) {
                    console.log('🔄 StorageManagerで取得失敗 - SimpleStorageManagerで試行中...');
                    
                    analysisResult = simpleStorageManager.getAnalysisResult();
                    if (analysisResult) {
                        console.log('✅ SimpleStorageManagerで分析結果取得成功');
                        
                        // 文字列として保存されている場合のパース処理
                        if (typeof analysisResult === 'string') {
                            try {
                                analysisResult = JSON.parse(analysisResult);
                                console.log('🔄 文字列からパース成功');
                            } catch (e) {
                                console.warn('⚠️ パース失敗:', e);
                            }
                        }
                    }
                }
                
                if (!insights) {
                    console.log('🔄 インサイト不足 - SimpleStorageManagerで試行中...');
                    
                    insights = simpleStorageManager.getInsights();
                    if (insights) {
                        console.log('✅ SimpleStorageManagerでインサイト取得成功');
                    }
                }
                
                // 直接localStorageからのフォールバック取得
                if (!analysisResult) {
                    console.log('🔄 SimpleStorageManagerでも失敗 - 直接localStorage確認中...');
                    
                    // 様々なキーでの取得を試行
                    const keysToTry = [
                        'haqei_analyzer_analysis_result',
                        'haqei_analysis_result', 
                        'haqei_emergency_result',
                        'haqei_results_latest_result'
                    ];
                    
                    for (const key of keysToTry) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                console.log(`🔍 ${key} のデータ解析を試行中...`);
                                let parsed = JSON.parse(data);
                                
                                // valueプロパティがある場合の展開
                                if (parsed.value) {
                                    console.log('📦 valueプロパティを展開中...');
                                    // valueが文字列の場合、再度パース
                                    if (typeof parsed.value === 'string') {
                                        try {
                                            parsed = JSON.parse(parsed.value);
                                            console.log('✅ value文字列のパース成功');
                                        } catch (e) {
                                            console.log('⚠️ value文字列のパース失敗、そのまま使用');
                                            parsed = parsed.value;
                                        }
                                    } else {
                                        parsed = parsed.value;
                                    }
                                }
                                
                                // resultプロパティがある場合
                                if (parsed.result) {
                                    analysisResult = parsed.result;
                                    if (parsed.insights) insights = parsed.insights;
                                    console.log(`✅ ${key}のresultから取得成功`);
                                    break;
                                }
                                // 直接Triple OSデータがある場合
                                else if (parsed.engineOS && parsed.interfaceOS && parsed.safeModeOS) {
                                    analysisResult = parsed;
                                    console.log(`✅ ${key}から直接取得成功`);
                                    break;
                                }
                            } catch (parseError) {
                                console.warn(`⚠️ ${key}の解析失敗:`, parseError);
                            }
                        }
                    }
                }
                
                // インサイトが不足している場合のフォールバック
                if (!insights) {
                    console.log('🔄 インサイト不足 - 直接localStorage確認中...');
                    const directInsights = localStorage.getItem('haqei_insights');
                    
                    if (directInsights) {
                        try {
                            const parsed = JSON.parse(directInsights);
                            insights = parsed.insights || parsed;
                            console.log('✅ 直接localStorageインサイト取得成功');
                        } catch (parseError) {
                            console.warn('⚠️ インサイト解析失敗:', parseError);
                        }
                    }
                }
                
                // 診断結果の検証
                if (!analysisResult) {
                    // LocalStorageの状態をデバッグ
                    const storageKeys = Object.keys(localStorage).filter(k => k.includes('haqei'));
                    console.log('🔍 LocalStorage HAQEIキー:', storageKeys);
                    storageKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        console.log(`📋 ${key}:`, value?.substring(0, 100) + '...');
                        if (value) {
                            try {
                                const parsed = JSON.parse(value);
                                console.log(`  → Parsed type:`, typeof parsed);
                                console.log(`  → Keys:`, Object.keys(parsed).slice(0, 5));
                            } catch (e) {
                                console.log(`  → Parse error:`, e.message);
                            }
                        }
                    });
                    
                    throw new Error('診断結果が見つかりません。先に診断を完了してください。');
                }
                
                // Triple OSデータの検証
                console.log('📊 分析結果の詳細確認:');
                console.log('analysisResult:', analysisResult);
                console.log('analysisResult type:', typeof analysisResult);
                
                // 各OSプロパティの存在確認
                if (analysisResult) {
                    console.log('engineOS exists:', !!analysisResult.engineOS);
                    console.log('interfaceOS exists:', !!analysisResult.interfaceOS);
                    console.log('safeModeOS exists:', !!analysisResult.safeModeOS);
                    
                    // 各OSの詳細
                    if (analysisResult.engineOS) {
                        console.log('engineOS name:', analysisResult.engineOS.name);
                        console.log('engineOS description:', analysisResult.engineOS.description?.substring(0, 50) + '...');
                    }
                    if (analysisResult.interfaceOS) {
                        console.log('interfaceOS name:', analysisResult.interfaceOS.name);
                        console.log('interfaceOS description:', analysisResult.interfaceOS.description?.substring(0, 50) + '...');
                    }
                    if (analysisResult.safeModeOS) {
                        console.log('safeModeOS name:', analysisResult.safeModeOS.name);
                        console.log('safeModeOS description:', analysisResult.safeModeOS.description?.substring(0, 50) + '...');
                    }
                }
                
                // 文字列の場合はパースを試みる
                if (typeof analysisResult === 'string') {
                    try {
                        console.log('🔄 文字列として保存されているため、JSON.parseを実行');
                        analysisResult = JSON.parse(analysisResult);
                        console.log('✅ パース成功:', analysisResult);
                    } catch (e) {
                        console.error('❌ JSON.parse失敗:', e);
                    }
                }
                
                if (!analysisResult.engineOS || !analysisResult.interfaceOS || !analysisResult.safeModeOS) {
                    console.error('❌ Triple OSデータが不完全:', analysisResult);
                    throw new Error('Triple OSデータが不完全です。診断をやり直してください。');
                }
                
                // DataManager は上で初期化済み
                console.log('📚 DataManager already initialized above');
                
                // Ultra-Sync最適化の初期化
                console.log('🚀 HAQEI Ultra-Sync Mode - 高速化バージョンで初期化中...');
                
                // Ultra-Sync Optimizerの初期化
                const ultraSyncOptimizer = new HaqeiUltraSyncOptimizer();
                
                console.log('📊 初期化パラメータ:', {
                    hasAnalysisResult: !!analysisResult,
                    analysisResultType: typeof analysisResult,
                    hasInsights: !!insights,
                    hasDataManager: !!dataManager,
                    containerExists: !!document.getElementById('virtual-persona-container'),
                    ultraSyncEnabled: true
                });
                
                // コンテナの存在確認
                const container = document.getElementById('virtual-persona-container');
                if (!container) {
                    console.error('❌ コンテナ要素が見つかりません: virtual-persona-container');
                    throw new Error('表示コンテナが見つかりません');
                }
                
                // virtualPersonaViewを外側のスコープで宣言
                let virtualPersonaView;
                
                try {
                    // Ultra-Sync最適化処理を実行
                    console.log('⚡ Ultra-Sync最適化処理を開始...');
                    const optimizedResult = await ultraSyncOptimizer.optimizeVirtualPersonalityConstruction(
                        analysisResult, 
                        insights, 
                        dataManager
                    );
                    
                    // 最適化されたデータでVirtualPersonaResultsViewを初期化
                    virtualPersonaView = new VirtualPersonaResultsView('virtual-persona-container', {
                        analysisResult: optimizedResult.tripleOS || analysisResult,
                        insights: insights,
                        dataManager: dataManager,
                        enableAnimation: true,
                        animationSpeed: 2.0, // 高速化
                        optimizedData: optimizedResult,
                        ultraSyncMode: true
                    });
                    
                    console.log('✅ Ultra-Sync VirtualPersonaResultsView インスタンス作成成功');
                    
                    // 高速初期化と表示
                    await virtualPersonaView.init();
                    console.log('✅ Ultra-Sync VirtualPersonaResultsView 初期化完了');
                } catch (viewError) {
                    console.error('❌ VirtualPersonaResultsView 初期化エラー:', viewError);
                    console.error('エラースタック:', viewError.stack);
                    
                    // 必要なクラスが定義されているか確認
                    console.log('🔍 クラス存在チェック:');
                    console.log('- BaseComponent:', typeof BaseComponent);
                    console.log('- StorageManager:', typeof StorageManager);
                    console.log('- DataManager:', typeof DataManager);
                    console.log('- TripleOSEngine:', typeof TripleOSEngine);
                    console.log('- VirtualPersonality:', typeof VirtualPersonality);
                    console.log('- PersonalityConstructionView:', typeof PersonalityConstructionView);
                    console.log('- OSRelationshipEngine:', typeof OSRelationshipEngine);
                    console.log('- IchingMetaphorEngine:', typeof IchingMetaphorEngine);
                    console.log('- VirtualPersonaResultsView:', typeof VirtualPersonaResultsView);
                    
                    throw viewError;
                }
                
                // ローディング画面を非表示し、メインビューを表示
                setTimeout(async () => {
                    loadingOverlay.classList.remove('active');
                    loadingOverlay.style.display = 'none';
                    console.log('✅ ローディング画面を非表示にしました');
                    
                    // デバッグ: virtualPersonaViewの状態確認
                    console.log('🔍 virtualPersonaView state check:', {
                        exists: !!virtualPersonaView,
                        isInitialized: virtualPersonaView?.isInitialized,
                        currentView: virtualPersonaView?.currentView,
                        hasContainer: !!virtualPersonaView?.container,
                        containerHtml: virtualPersonaView?.container?.innerHTML?.substring(0, 200)
                    });
                    
                    // メインビューに切り替え
                    if (virtualPersonaView && typeof virtualPersonaView.switchToMainView === 'function') {
                        try {
                            await virtualPersonaView.switchToMainView();
                            console.log('✅ メインビューに切り替えました');
                            
                            // 追加デバッグ: ビュー切り替え後の状態
                            const mainView = document.querySelector('#main-view');
                            const activeViews = document.querySelectorAll('.vp-view.active');
                            console.log('🔍 View switch debug:', {
                                mainViewExists: !!mainView,
                                mainViewActive: mainView?.classList.contains('active'),
                                mainViewDisplay: window.getComputedStyle(mainView)?.display,
                                activeViewsCount: activeViews.length,
                                activeViewIds: Array.from(activeViews).map(v => v.id)
                            });
                            
                            // 強制的にメインビューを表示
                            if (mainView && !mainView.classList.contains('active')) {
                                console.log('🔧 Force activating main view...');
                                // 全ビューを非アクティブ化
                                document.querySelectorAll('.vp-view').forEach(v => v.classList.remove('active'));
                                // メインビューをアクティブ化
                                mainView.classList.add('active');
                                // メインビューの初期化を強制実行
                                if (virtualPersonaView.initializeMainView) {
                                    await virtualPersonaView.initializeMainView();
                                    console.log('✅ メインビュー初期化完了');
                                }
                            }
                            
                        } catch (error) {
                            console.error('❌ メインビュー切り替えエラー:', error);
                            
                            // エラー時のフォールバック: 直接メインビューを表示
                            console.log('🔧 Attempting fallback main view display...');
                            const mainView = document.querySelector('#main-view');
                            if (mainView) {
                                document.querySelectorAll('.vp-view').forEach(v => v.classList.remove('active'));
                                mainView.classList.add('active');
                                mainView.innerHTML = `
                                    <div class="vp-main-container" style="padding: 2rem; text-align: center;">
                                        <h2 style="color: #F1F5F9; margin-bottom: 1rem;">あなたの仮想人格</h2>
                                        <p style="color: #CBD5E1; margin-bottom: 2rem;">データの処理が完了しました。詳細な分析結果を準備中です...</p>
                                        <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 12px;">
                                            <p style="color: #94A3B8;">仮想人格の構築が完了しています。しばらくお待ちください。</p>
                                        </div>
                                    </div>
                                `;
                                console.log('✅ フォールバック表示完了');
                            }
                        }
                    } else {
                        console.error('❌ virtualPersonaView が無効または switchToMainView メソッドがありません');
                        
                        // virtualPersonaView が存在しない場合の緊急表示
                        const container = document.getElementById('virtual-persona-container');
                        if (container) {
                            container.innerHTML = `
                                <div style="min-height: 100vh; background: #0F172A; color: #F1F5F9; padding: 2rem;">
                                    <nav style="background: #1E293B; padding: 1rem; border-radius: 12px; margin-bottom: 2rem;">
                                        <h1 style="color: #F1F5F9; margin: 0;">HAQEI 仮想人格対話プラットフォーム</h1>
                                        <p style="color: #CBD5E1; margin: 0.5rem 0 0;">あなたの内なる3つのOSとの対話</p>
                                    </nav>
                                    <main style="background: #1E293B; padding: 2rem; border-radius: 12px; text-align: center;">
                                        <h2 style="color: #F1F5F9; margin-bottom: 1rem;">🎭 仮想人格構築完了</h2>
                                        <p style="color: #CBD5E1; margin-bottom: 2rem;">あなたの診断結果から仮想人格が構築されました。</p>
                                        <div style="background: rgba(107, 70, 193, 0.2); padding: 2rem; border-radius: 12px; border: 1px solid rgba(107, 70, 193, 0.3);">
                                            <h3 style="color: #9F7AEA; margin-bottom: 1rem;">💫 処理完了</h3>
                                            <p style="color: #CBD5E1;">Ultra-Sync システムにより高速処理が完了しました。<br>詳細な分析結果とインタラクティブな機能を準備しています。</p>
                                        </div>
                                    </main>
                                </div>
                            `;
                            console.log('✅ 緊急フォールバック表示完了');
                        }
                    }
                }, 1000); // タイミングを1秒に延長してvirtualPersonaViewの初期化を確実に待つ
                
                // グローバル参照の設定（アクションボタンから呼び出すため）
                window.virtualPersonaView = virtualPersonaView;
                
                console.log('✅ 仮想人格対話型プラットフォーム初期化完了');
                
            } catch (error) {
                console.error('❌ 初期化エラー:', error);
                
                // エラー表示
                loadingOverlay.classList.remove('active');
                errorContainer.style.display = 'flex';
                
                if (error.message.includes('診断結果が見つかりません')) {
                    errorMessage.innerHTML = `
                        <p>${error.message}</p>
                        <a href="os_analyzer.html" class="error-link">診断を開始する</a>
                    `;
                } else {
                    errorMessage.textContent = error.message;
                }
            }
        });
        
        // グローバルエラーハンドリング
        window.addEventListener('error', (event) => {
            console.error('❌ グローバルエラー:', event.error);
            // 必要に応じてエラー通知を表示
        });
    </script>
    
    <!-- VP View Fix - 根本的な表示問題の解決 -->
    <!-- VP view fix integrated into VirtualQuestionFlow v2.0 -->
</body>
</html>