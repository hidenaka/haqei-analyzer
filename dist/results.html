<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI - ä»®æƒ³äººæ ¼å¯¾è©±å‹è‡ªå·±ç†è§£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </title>
    <meta name="description" content="ã‚ãªãŸã®å†…ãªã‚‹3ã¤ã®OSï¼ˆä¾¡å€¤è¦³ãƒ»ç¤¾ä¼šçš„å´é¢ãƒ»é˜²å¾¡çš„å´é¢ï¼‰ã¨ã®å¯¾è©±ã‚’é€šã˜ã¦ã€æ·±ã„è‡ªå·±ç†è§£ã‚’ä¿ƒé€²ã™ã‚‹é©æ–°çš„ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ">
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Existing Styles -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/animations.css">
    <link rel="stylesheet" href="css/interactive-ui.css">
    
    <!-- New Style for Virtual Persona -->
    <link rel="stylesheet" href="css/virtual-persona-results.css">
    
    <!-- Ultra-Sync Engaging Loading Experience -->
    <link rel="stylesheet" href="css/ultra-sync-engaging.css">
    
    <!-- VP Main Container Fix -->
    <link rel="stylesheet" href="css/vp-main-container-fix.css">
    
    <!-- Construction View Disable - æ§‹ç¯‰æ¼”å‡ºãƒ“ãƒ¥ãƒ¼ã‚’å®Œå…¨ç„¡åŠ¹åŒ– -->
    <link rel="stylesheet" href="css/construction-view-disable.css">
    
    <!-- Emergency CSS fixes for view display -->
    <style>
        /* Emergency fix for main content display */
        #virtual-persona-container {
            min-height: 100vh;
            background: #0F172A;
            color: #F1F5F9;
        }
        
        /* Ensure views are visible when active */
        .vp-view.active {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Force container visibility */
        .vp-main-content {
            display: block !important;
            min-height: 80vh;
        }
        
        /* Loading overlay fix */
        .loading-overlay:not(.active) {
            display: none !important;
        }
        
        /* Debug styles for troubleshooting */
        .debug-visible {
            border: 2px solid #ff00ff !important;
            background: rgba(255, 0, 255, 0.1) !important;
        }
    </style>
    
    <!-- Chart.js for visualizations -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
</head>
<body>
    <!-- 
    ä»®æƒ³äººæ ¼å¯¾è©±å‹è‡ªå·±ç†è§£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ 
    
    æ¦‚è¦ï¼š
    ã“ã®ãƒšãƒ¼ã‚¸ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®è¨ºæ–­çµæœã‹ã‚‰æ§‹ç¯‰ã•ã‚ŒãŸä»®æƒ³äººæ ¼ï¼ˆ3ã¤ã®OSï¼‰ã¨ã®
    å¯¾è©±ã‚’é€šã˜ã¦ã€æ·±ã„è‡ªå·±ç†è§£ã‚’ä¿ƒé€²ã™ã‚‹ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã§ã™ã€‚
    
    ä¸»è¦æ©Ÿèƒ½ï¼š
    1. ä»®æƒ³äººæ ¼ã®æ®µéšçš„æ§‹ç¯‰æ¼”å‡º
    2. 3ã¤ã®OSé–“ã®ç›¸äº’ä½œç”¨å¯è¦–åŒ–
    3. å†…éƒ¨å¯¾è©±ã®å†ç”Ÿãƒ»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
    4. æ˜“çµŒãƒ¡ã‚¿ãƒ•ã‚¡ãƒ¼ã«ã‚ˆã‚‹æ·±ã„æ´å¯Ÿ
    5. å®Ÿè·µçš„ãªè‡ªå·±ç†è§£ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
    -->
    
    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay active">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <h2 class="loading-title">ã‚ãªãŸã®å›ç­”ã‚’åˆ†æä¸­...</h2>
            <p class="loading-description">å®Ÿéš›ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã€æœ€æ–°ã®åˆ†æçµæœã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™</p>
        </div>
    </div>
    
    <!-- Main Container -->
    <div id="virtual-persona-container" class="virtual-persona-container">
        <!-- VirtualPersonaResultsViewãŒã“ã“ã«å‹•çš„ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç”Ÿæˆ -->
    </div>
    
    <!-- Error Display -->
    <div id="error-container" class="error-container" style="display: none;">
        <div class="error-content">
            <h2>ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</h2>
            <p id="error-message"></p>
            <button onclick="location.reload()" class="error-retry-button">å†èª­ã¿è¾¼ã¿</button>
        </div>
    </div>
    
    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ« -->
    <script type="text/javascript" src="./js/shared/data/questions.js"></script>
    <script type="text/javascript" src="./js/shared/data/vectors.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagrams.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/data/hexagram_details.js"></script>
    <script type="text/javascript" src="./js/data/data_box.js"></script>
    
    <!-- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ -->
    <script type="text/javascript" src="./js/shared/utils/validators.js"></script>
    <script type="text/javascript" src="./js/shared/utils/animations.js"></script>
    
    <!-- åŸºç›¤ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
    <script type="text/javascript" src="./js/shared/core/BaseComponent.js"></script>
    <script type="text/javascript" src="./js/shared/core/StorageManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/SimpleStorageManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/DataManager.js"></script>
    <script type="text/javascript" src="./js/shared/core/ErrorHandler.js"></script>
    
    <!-- ä»®æƒ³äººæ ¼é–¢é€£ã‚¨ãƒ³ã‚¸ãƒ³ -->
    <script type="text/javascript" src="./js/os-analyzer/core/Calculator.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/IChingUltraSyncLogic.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/TripleOSEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/UltraAnalysisEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/PersonalityOS.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/VirtualPersonality.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/OSRelationshipEngine.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/core/IchingMetaphorEngine.js"></script>
    
    <!-- UI/UXã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ -->
    <script type="text/javascript" src="./js/os-analyzer/components/PersonalityConstructionView.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/components/DialoguePlayer.js"></script>
    <script type="text/javascript" src="./js/os-analyzer/components/OSVoiceSwitcher.js"></script>
    
    <!-- æ–°è¦ä½œæˆï¼šä»®æƒ³äººæ ¼çµæœè¡¨ç¤ºãƒ“ãƒ¥ãƒ¼ -->
    <script type="text/javascript" src="./js/components/VirtualPersonaResultsView.js"></script>
    
    <!-- Ultra-Sync Performance Optimizer -->
    <script type="text/javascript" src="./js/performance-ultra-sync.js"></script>
    
    <script>
        /**
         * ä»®æƒ³äººæ ¼å¯¾è©±å‹è‡ªå·±ç†è§£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  - åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
         * 
         * ç›®çš„ï¼š
         * - è¨ºæ–­çµæœã®èª­ã¿è¾¼ã¿
         * - ä»®æƒ³äººæ ¼ã®æ§‹ç¯‰
         * - ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–UIã®åˆæœŸåŒ–
         * 
         * å‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼š
         * 1. localStorageã‹ã‚‰è¨ºæ–­çµæœã‚’å–å¾—
         * 2. å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
         * 3. VirtualPersonaResultsViewã®åˆæœŸåŒ–
         * 4. ä»®æƒ³äººæ ¼æ§‹ç¯‰ãƒ—ãƒ­ã‚»ã‚¹ã®é–‹å§‹
         */
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ğŸš€ ä»®æƒ³äººæ ¼å¯¾è©±å‹è‡ªå·±ç†è§£ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ  - åˆæœŸåŒ–é–‹å§‹');
            
            const loadingOverlay = document.getElementById('loading-overlay');
            const errorContainer = document.getElementById('error-container');
            const errorMessage = document.getElementById('error-message');
            
            try {
                // ğŸ”§ ä¿®æ­£: å®Ÿéš›ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦åˆ†æã‚’å†å®Ÿè¡Œ
                const storageManager = new StorageManager();
                
                // DataManagerã‚’æœ€åˆã«åˆæœŸåŒ–
                const dataManager = new DataManager();
                await dataManager.loadData();
                console.log('âœ… DataManager initialized');
                
                // ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å›ç­”ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                const userAnswers = storageManager.getAnswers() || [];
                console.log('ğŸ“ Retrieved user answers for re-analysis:', userAnswers.length);
                
                let analysisResult = null;
                let insights = null;
                
                // å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å†åˆ†æã‚’å®Ÿè¡Œ
                if (userAnswers.length > 0) {
                    console.log('ğŸ”„ Running fresh analysis with actual user answers...');
                    
                    
                    // UltraAnalysisEngineã‚’åˆæœŸåŒ–ï¼ˆapp.jsã¨åŒã˜æ–¹å¼ï¼‰
                    let analysisEngine = null;
                    
                    if (typeof UltraAnalysisEngine !== 'undefined') {
                        analysisEngine = new UltraAnalysisEngine(dataManager);
                        console.log('âœ… UltraAnalysisEngine initialized');
                    } else {
                        console.warn('âš ï¸ UltraAnalysisEngine not available, using TripleOSEngine');
                        analysisEngine = new TripleOSEngine(dataManager);
                    }
                    
                    // å®Ÿéš›ã®å›ç­”ãƒ‡ãƒ¼ã‚¿ã§åˆ†æå®Ÿè¡Œ
                    try {
                        // ğŸ” ãƒ‡ãƒãƒƒã‚°: å›ç­”ãƒ‡ãƒ¼ã‚¿ã®è©³ç´°ç¢ºèª
                        console.log('ğŸ” Detailed user answers analysis:');
                        userAnswers.forEach((answer, index) => {
                            console.log(`Answer ${index + 1}:`, {
                                questionId: answer.questionId,
                                selectedValue: answer.selectedValue,
                                innerChoice: answer.innerChoice,
                                outerChoice: answer.outerChoice,
                                scoring_tags: answer.scoring_tags
                            });
                        });
                        
                        analysisResult = await analysisEngine.analyzeTripleOS(userAnswers);
                        
                        // ğŸ” ãƒ‡ãƒãƒƒã‚°: åˆ†æçµæœã®è©³ç´°ç¢ºèª
                        console.log('ğŸ” Analysis result details:');
                        console.log('- Engine OS:', {
                            name: analysisResult.engineOS?.name,
                            hexagramId: analysisResult.engineOS?.hexagramId,
                            activation: analysisResult.engineOS?.activation,
                            similarity: analysisResult.engineOS?.similarity
                        });
                        console.log('- Interface OS:', {
                            name: analysisResult.interfaceOS?.name,
                            hexagramId: analysisResult.interfaceOS?.hexagramId,
                            activation: analysisResult.interfaceOS?.activation
                        });
                        console.log('- SafeMode OS:', {
                            name: analysisResult.safeModeOS?.name,
                            hexagramId: analysisResult.safeModeOS?.hexagramId,
                            activation: analysisResult.safeModeOS?.activation
                        });
                        console.log('- Consistency Score:', analysisResult.consistencyScore);
                        
                        if (typeof analysisEngine.generateInsights === 'function') {
                            insights = await analysisEngine.generateInsights(analysisResult);
                            console.log('ğŸ” Generated insights:', insights);
                        }
                        console.log('âœ… Fresh analysis completed with user data');
                        
                        // æ–°ã—ã„åˆ†æçµæœã‚’ä¿å­˜
                        storageManager.saveAnalysisResult(analysisResult);
                        if (insights) storageManager.saveInsights(insights);
                    } catch (analysisError) {
                        console.error('âŒ Fresh analysis failed:', analysisError);
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ä¿å­˜ã•ã‚Œã¦ã„ã‚‹çµæœã‚’ä½¿ç”¨
                        analysisResult = storageManager.getAnalysisResult();
                        insights = storageManager.getInsights();
                    }
                } else {
                    console.log('ğŸ“š No user answers found, using stored analysis result');
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ä¿å­˜ã•ã‚Œã¦ã„ã‚‹çµæœã‚’ä½¿ç”¨
                    analysisResult = storageManager.getAnalysisResult();
                    insights = storageManager.getInsights();
                }
                
                // SimpleStorageManagerã‚‚åˆæœŸåŒ–ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
                const simpleStorageManager = new SimpleStorageManager();
                
                console.log('ğŸ“Š è¨ºæ–­çµæœã®å–å¾—å®Œäº†:', {
                    hasAnalysisResult: !!analysisResult,
                    hasInsights: !!insights
                });
                
                // SimpleStorageManagerã§ã®å–å¾—è©¦è¡Œ
                if (!analysisResult) {
                    console.log('ğŸ”„ StorageManagerã§å–å¾—å¤±æ•— - SimpleStorageManagerã§è©¦è¡Œä¸­...');
                    
                    analysisResult = simpleStorageManager.getAnalysisResult();
                    if (analysisResult) {
                        console.log('âœ… SimpleStorageManagerã§åˆ†æçµæœå–å¾—æˆåŠŸ');
                        
                        // æ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å ´åˆã®ãƒ‘ãƒ¼ã‚¹å‡¦ç†
                        if (typeof analysisResult === 'string') {
                            try {
                                analysisResult = JSON.parse(analysisResult);
                                console.log('ğŸ”„ æ–‡å­—åˆ—ã‹ã‚‰ãƒ‘ãƒ¼ã‚¹æˆåŠŸ');
                            } catch (e) {
                                console.warn('âš ï¸ ãƒ‘ãƒ¼ã‚¹å¤±æ•—:', e);
                            }
                        }
                    }
                }
                
                if (!insights) {
                    console.log('ğŸ”„ ã‚¤ãƒ³ã‚µã‚¤ãƒˆä¸è¶³ - SimpleStorageManagerã§è©¦è¡Œä¸­...');
                    
                    insights = simpleStorageManager.getInsights();
                    if (insights) {
                        console.log('âœ… SimpleStorageManagerã§ã‚¤ãƒ³ã‚µã‚¤ãƒˆå–å¾—æˆåŠŸ');
                    }
                }
                
                // ç›´æ¥localStorageã‹ã‚‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å–å¾—
                if (!analysisResult) {
                    console.log('ğŸ”„ SimpleStorageManagerã§ã‚‚å¤±æ•— - ç›´æ¥localStorageç¢ºèªä¸­...');
                    
                    // æ§˜ã€…ãªã‚­ãƒ¼ã§ã®å–å¾—ã‚’è©¦è¡Œ
                    const keysToTry = [
                        'haqei_analyzer_analysis_result',
                        'haqei_analysis_result', 
                        'haqei_emergency_result',
                        'haqei_results_latest_result'
                    ];
                    
                    for (const key of keysToTry) {
                        const data = localStorage.getItem(key);
                        if (data) {
                            try {
                                console.log(`ğŸ” ${key} ã®ãƒ‡ãƒ¼ã‚¿è§£æã‚’è©¦è¡Œä¸­...`);
                                let parsed = JSON.parse(data);
                                
                                // valueãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆã®å±•é–‹
                                if (parsed.value) {
                                    console.log('ğŸ“¦ valueãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’å±•é–‹ä¸­...');
                                    // valueãŒæ–‡å­—åˆ—ã®å ´åˆã€å†åº¦ãƒ‘ãƒ¼ã‚¹
                                    if (typeof parsed.value === 'string') {
                                        try {
                                            parsed = JSON.parse(parsed.value);
                                            console.log('âœ… valueæ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹æˆåŠŸ');
                                        } catch (e) {
                                            console.log('âš ï¸ valueæ–‡å­—åˆ—ã®ãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€ãã®ã¾ã¾ä½¿ç”¨');
                                            parsed = parsed.value;
                                        }
                                    } else {
                                        parsed = parsed.value;
                                    }
                                }
                                
                                // resultãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ãŒã‚ã‚‹å ´åˆ
                                if (parsed.result) {
                                    analysisResult = parsed.result;
                                    if (parsed.insights) insights = parsed.insights;
                                    console.log(`âœ… ${key}ã®resultã‹ã‚‰å–å¾—æˆåŠŸ`);
                                    break;
                                }
                                // ç›´æ¥Triple OSãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
                                else if (parsed.engineOS && parsed.interfaceOS && parsed.safeModeOS) {
                                    analysisResult = parsed;
                                    console.log(`âœ… ${key}ã‹ã‚‰ç›´æ¥å–å¾—æˆåŠŸ`);
                                    break;
                                }
                            } catch (parseError) {
                                console.warn(`âš ï¸ ${key}ã®è§£æå¤±æ•—:`, parseError);
                            }
                        }
                    }
                }
                
                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆãŒä¸è¶³ã—ã¦ã„ã‚‹å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                if (!insights) {
                    console.log('ğŸ”„ ã‚¤ãƒ³ã‚µã‚¤ãƒˆä¸è¶³ - ç›´æ¥localStorageç¢ºèªä¸­...');
                    const directInsights = localStorage.getItem('haqei_insights');
                    
                    if (directInsights) {
                        try {
                            const parsed = JSON.parse(directInsights);
                            insights = parsed.insights || parsed;
                            console.log('âœ… ç›´æ¥localStorageã‚¤ãƒ³ã‚µã‚¤ãƒˆå–å¾—æˆåŠŸ');
                        } catch (parseError) {
                            console.warn('âš ï¸ ã‚¤ãƒ³ã‚µã‚¤ãƒˆè§£æå¤±æ•—:', parseError);
                        }
                    }
                }
                
                // è¨ºæ–­çµæœã®æ¤œè¨¼
                if (!analysisResult) {
                    // LocalStorageã®çŠ¶æ…‹ã‚’ãƒ‡ãƒãƒƒã‚°
                    const storageKeys = Object.keys(localStorage).filter(k => k.includes('haqei'));
                    console.log('ğŸ” LocalStorage HAQEIã‚­ãƒ¼:', storageKeys);
                    storageKeys.forEach(key => {
                        const value = localStorage.getItem(key);
                        console.log(`ğŸ“‹ ${key}:`, value?.substring(0, 100) + '...');
                        if (value) {
                            try {
                                const parsed = JSON.parse(value);
                                console.log(`  â†’ Parsed type:`, typeof parsed);
                                console.log(`  â†’ Keys:`, Object.keys(parsed).slice(0, 5));
                            } catch (e) {
                                console.log(`  â†’ Parse error:`, e.message);
                            }
                        }
                    });
                    
                    throw new Error('è¨ºæ–­çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«è¨ºæ–­ã‚’å®Œäº†ã—ã¦ãã ã•ã„ã€‚');
                }
                
                // Triple OSãƒ‡ãƒ¼ã‚¿ã®æ¤œè¨¼
                console.log('ğŸ“Š åˆ†æçµæœã®è©³ç´°ç¢ºèª:');
                console.log('analysisResult:', analysisResult);
                console.log('analysisResult type:', typeof analysisResult);
                
                // å„OSãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å­˜åœ¨ç¢ºèª
                if (analysisResult) {
                    console.log('engineOS exists:', !!analysisResult.engineOS);
                    console.log('interfaceOS exists:', !!analysisResult.interfaceOS);
                    console.log('safeModeOS exists:', !!analysisResult.safeModeOS);
                    
                    // å„OSã®è©³ç´°
                    if (analysisResult.engineOS) {
                        console.log('engineOS name:', analysisResult.engineOS.name);
                        console.log('engineOS description:', analysisResult.engineOS.description?.substring(0, 50) + '...');
                    }
                    if (analysisResult.interfaceOS) {
                        console.log('interfaceOS name:', analysisResult.interfaceOS.name);
                        console.log('interfaceOS description:', analysisResult.interfaceOS.description?.substring(0, 50) + '...');
                    }
                    if (analysisResult.safeModeOS) {
                        console.log('safeModeOS name:', analysisResult.safeModeOS.name);
                        console.log('safeModeOS description:', analysisResult.safeModeOS.description?.substring(0, 50) + '...');
                    }
                }
                
                // æ–‡å­—åˆ—ã®å ´åˆã¯ãƒ‘ãƒ¼ã‚¹ã‚’è©¦ã¿ã‚‹
                if (typeof analysisResult === 'string') {
                    try {
                        console.log('ğŸ”„ æ–‡å­—åˆ—ã¨ã—ã¦ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€JSON.parseã‚’å®Ÿè¡Œ');
                        analysisResult = JSON.parse(analysisResult);
                        console.log('âœ… ãƒ‘ãƒ¼ã‚¹æˆåŠŸ:', analysisResult);
                    } catch (e) {
                        console.error('âŒ JSON.parseå¤±æ•—:', e);
                    }
                }
                
                if (!analysisResult.engineOS || !analysisResult.interfaceOS || !analysisResult.safeModeOS) {
                    console.error('âŒ Triple OSãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨:', analysisResult);
                    throw new Error('Triple OSãƒ‡ãƒ¼ã‚¿ãŒä¸å®Œå…¨ã§ã™ã€‚è¨ºæ–­ã‚’ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„ã€‚');
                }
                
                // DataManager ã¯ä¸Šã§åˆæœŸåŒ–æ¸ˆã¿
                console.log('ğŸ“š DataManager already initialized above');
                
                // Ultra-Syncæœ€é©åŒ–ã®åˆæœŸåŒ–
                console.log('ğŸš€ HAQEI Ultra-Sync Mode - é«˜é€ŸåŒ–ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§åˆæœŸåŒ–ä¸­...');
                
                // Ultra-Sync Optimizerã®åˆæœŸåŒ–
                const ultraSyncOptimizer = new HaqeiUltraSyncOptimizer();
                
                console.log('ğŸ“Š åˆæœŸåŒ–ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:', {
                    hasAnalysisResult: !!analysisResult,
                    analysisResultType: typeof analysisResult,
                    hasInsights: !!insights,
                    hasDataManager: !!dataManager,
                    containerExists: !!document.getElementById('virtual-persona-container'),
                    ultraSyncEnabled: true
                });
                
                // ã‚³ãƒ³ãƒ†ãƒŠã®å­˜åœ¨ç¢ºèª
                const container = document.getElementById('virtual-persona-container');
                if (!container) {
                    console.error('âŒ ã‚³ãƒ³ãƒ†ãƒŠè¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: virtual-persona-container');
                    throw new Error('è¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                // virtualPersonaViewã‚’å¤–å´ã®ã‚¹ã‚³ãƒ¼ãƒ—ã§å®£è¨€
                let virtualPersonaView;
                
                try {
                    // Ultra-Syncæœ€é©åŒ–å‡¦ç†ã‚’å®Ÿè¡Œ
                    console.log('âš¡ Ultra-Syncæœ€é©åŒ–å‡¦ç†ã‚’é–‹å§‹...');
                    const optimizedResult = await ultraSyncOptimizer.optimizeVirtualPersonalityConstruction(
                        analysisResult, 
                        insights, 
                        dataManager
                    );
                    
                    // æœ€é©åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ã§VirtualPersonaResultsViewã‚’åˆæœŸåŒ–
                    virtualPersonaView = new VirtualPersonaResultsView('virtual-persona-container', {
                        analysisResult: optimizedResult.tripleOS || analysisResult,
                        insights: insights,
                        dataManager: dataManager,
                        enableAnimation: true,
                        animationSpeed: 2.0, // é«˜é€ŸåŒ–
                        optimizedData: optimizedResult,
                        ultraSyncMode: true
                    });
                    
                    console.log('âœ… Ultra-Sync VirtualPersonaResultsView ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆæˆåŠŸ');
                    
                    // é«˜é€ŸåˆæœŸåŒ–ã¨è¡¨ç¤º
                    await virtualPersonaView.init();
                    console.log('âœ… Ultra-Sync VirtualPersonaResultsView åˆæœŸåŒ–å®Œäº†');
                } catch (viewError) {
                    console.error('âŒ VirtualPersonaResultsView åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', viewError);
                    console.error('ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¿ãƒƒã‚¯:', viewError.stack);
                    
                    // å¿…è¦ãªã‚¯ãƒ©ã‚¹ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
                    console.log('ğŸ” ã‚¯ãƒ©ã‚¹å­˜åœ¨ãƒã‚§ãƒƒã‚¯:');
                    console.log('- BaseComponent:', typeof BaseComponent);
                    console.log('- StorageManager:', typeof StorageManager);
                    console.log('- DataManager:', typeof DataManager);
                    console.log('- TripleOSEngine:', typeof TripleOSEngine);
                    console.log('- VirtualPersonality:', typeof VirtualPersonality);
                    console.log('- PersonalityConstructionView:', typeof PersonalityConstructionView);
                    console.log('- OSRelationshipEngine:', typeof OSRelationshipEngine);
                    console.log('- IchingMetaphorEngine:', typeof IchingMetaphorEngine);
                    console.log('- VirtualPersonaResultsView:', typeof VirtualPersonaResultsView);
                    
                    throw viewError;
                }
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºã—ã€ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                setTimeout(async () => {
                    loadingOverlay.classList.remove('active');
                    loadingOverlay.style.display = 'none';
                    console.log('âœ… ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’éè¡¨ç¤ºã«ã—ã¾ã—ãŸ');
                    
                    // ãƒ‡ãƒãƒƒã‚°: virtualPersonaViewã®çŠ¶æ…‹ç¢ºèª
                    console.log('ğŸ” virtualPersonaView state check:', {
                        exists: !!virtualPersonaView,
                        isInitialized: virtualPersonaView?.isInitialized,
                        currentView: virtualPersonaView?.currentView,
                        hasContainer: !!virtualPersonaView?.container,
                        containerHtml: virtualPersonaView?.container?.innerHTML?.substring(0, 200)
                    });
                    
                    // ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆ
                    if (virtualPersonaView && typeof virtualPersonaView.switchToMainView === 'function') {
                        try {
                            await virtualPersonaView.switchToMainView();
                            console.log('âœ… ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ');
                            
                            // è¿½åŠ ãƒ‡ãƒãƒƒã‚°: ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆå¾Œã®çŠ¶æ…‹
                            const mainView = document.querySelector('#main-view');
                            const activeViews = document.querySelectorAll('.vp-view.active');
                            console.log('ğŸ” View switch debug:', {
                                mainViewExists: !!mainView,
                                mainViewActive: mainView?.classList.contains('active'),
                                mainViewDisplay: window.getComputedStyle(mainView)?.display,
                                activeViewsCount: activeViews.length,
                                activeViewIds: Array.from(activeViews).map(v => v.id)
                            });
                            
                            // å¼·åˆ¶çš„ã«ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                            if (mainView && !mainView.classList.contains('active')) {
                                console.log('ğŸ”§ Force activating main view...');
                                // å…¨ãƒ“ãƒ¥ãƒ¼ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
                                document.querySelectorAll('.vp-view').forEach(v => v.classList.remove('active'));
                                // ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
                                mainView.classList.add('active');
                                // ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã®åˆæœŸåŒ–ã‚’å¼·åˆ¶å®Ÿè¡Œ
                                if (virtualPersonaView.initializeMainView) {
                                    await virtualPersonaView.initializeMainView();
                                    console.log('âœ… ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼åˆæœŸåŒ–å®Œäº†');
                                }
                            }
                            
                        } catch (error) {
                            console.error('âŒ ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆã‚¨ãƒ©ãƒ¼:', error);
                            
                            // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ç›´æ¥ãƒ¡ã‚¤ãƒ³ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤º
                            console.log('ğŸ”§ Attempting fallback main view display...');
                            const mainView = document.querySelector('#main-view');
                            if (mainView) {
                                document.querySelectorAll('.vp-view').forEach(v => v.classList.remove('active'));
                                mainView.classList.add('active');
                                mainView.innerHTML = `
                                    <div class="vp-main-container" style="padding: 2rem; text-align: center;">
                                        <h2 style="color: #F1F5F9; margin-bottom: 1rem;">ã‚ãªãŸã®ä»®æƒ³äººæ ¼</h2>
                                        <p style="color: #CBD5E1; margin-bottom: 2rem;">ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚è©³ç´°ãªåˆ†æçµæœã‚’æº–å‚™ä¸­ã§ã™...</p>
                                        <div style="background: rgba(255,255,255,0.1); padding: 2rem; border-radius: 12px;">
                                            <p style="color: #94A3B8;">ä»®æƒ³äººæ ¼ã®æ§‹ç¯‰ãŒå®Œäº†ã—ã¦ã„ã¾ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚</p>
                                        </div>
                                    </div>
                                `;
                                console.log('âœ… ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºå®Œäº†');
                            }
                        }
                    } else {
                        console.error('âŒ virtualPersonaView ãŒç„¡åŠ¹ã¾ãŸã¯ switchToMainView ãƒ¡ã‚½ãƒƒãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
                        
                        // virtualPersonaView ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ç·Šæ€¥è¡¨ç¤º
                        const container = document.getElementById('virtual-persona-container');
                        if (container) {
                            container.innerHTML = `
                                <div style="min-height: 100vh; background: #0F172A; color: #F1F5F9; padding: 2rem;">
                                    <nav style="background: #1E293B; padding: 1rem; border-radius: 12px; margin-bottom: 2rem;">
                                        <h1 style="color: #F1F5F9; margin: 0;">HAQEI ä»®æƒ³äººæ ¼å¯¾è©±ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ </h1>
                                        <p style="color: #CBD5E1; margin: 0.5rem 0 0;">ã‚ãªãŸã®å†…ãªã‚‹3ã¤ã®OSã¨ã®å¯¾è©±</p>
                                    </nav>
                                    <main style="background: #1E293B; padding: 2rem; border-radius: 12px; text-align: center;">
                                        <h2 style="color: #F1F5F9; margin-bottom: 1rem;">ğŸ­ ä»®æƒ³äººæ ¼æ§‹ç¯‰å®Œäº†</h2>
                                        <p style="color: #CBD5E1; margin-bottom: 2rem;">ã‚ãªãŸã®è¨ºæ–­çµæœã‹ã‚‰ä»®æƒ³äººæ ¼ãŒæ§‹ç¯‰ã•ã‚Œã¾ã—ãŸã€‚</p>
                                        <div style="background: rgba(107, 70, 193, 0.2); padding: 2rem; border-radius: 12px; border: 1px solid rgba(107, 70, 193, 0.3);">
                                            <h3 style="color: #9F7AEA; margin-bottom: 1rem;">ğŸ’« å‡¦ç†å®Œäº†</h3>
                                            <p style="color: #CBD5E1;">Ultra-Sync ã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šé«˜é€Ÿå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>è©³ç´°ãªåˆ†æçµæœã¨ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªæ©Ÿèƒ½ã‚’æº–å‚™ã—ã¦ã„ã¾ã™ã€‚</p>
                                        </div>
                                    </main>
                                </div>
                            `;
                            console.log('âœ… ç·Šæ€¥ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤ºå®Œäº†');
                        }
                    }
                }, 1000); // ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’1ç§’ã«å»¶é•·ã—ã¦virtualPersonaViewã®åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«å¾…ã¤
                
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å‚ç…§ã®è¨­å®šï¼ˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ã‹ã‚‰å‘¼ã³å‡ºã™ãŸã‚ï¼‰
                window.virtualPersonaView = virtualPersonaView;
                
                console.log('âœ… ä»®æƒ³äººæ ¼å¯¾è©±å‹ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆæœŸåŒ–å®Œäº†');
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                
                // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
                loadingOverlay.classList.remove('active');
                errorContainer.style.display = 'flex';
                
                if (error.message.includes('è¨ºæ–­çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“')) {
                    errorMessage.innerHTML = `
                        <p>${error.message}</p>
                        <a href="os_analyzer.html" class="error-link">è¨ºæ–­ã‚’é–‹å§‹ã™ã‚‹</a>
                    `;
                } else {
                    errorMessage.textContent = error.message;
                }
            }
        });
        
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        window.addEventListener('error', (event) => {
            console.error('âŒ ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼:', event.error);
            // å¿…è¦ã«å¿œã˜ã¦ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’è¡¨ç¤º
        });
    </script>
    
    <!-- VP View Fix - æ ¹æœ¬çš„ãªè¡¨ç¤ºå•é¡Œã®è§£æ±º -->
    <!-- VP view fix integrated into VirtualQuestionFlow v2.0 -->
</body>
</html>