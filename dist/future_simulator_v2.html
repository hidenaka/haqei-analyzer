<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- セキュリティヘッダー -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta name="csrf-token" content="">
  
  <title>HaQei マルチバース・アナライザー v2.0</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>易</text></svg>" />
  
  <!-- セキュリティライブラリ -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" 
          crossorigin="anonymous"
          integrity="sha384-vdScihEZCfbPnBQf+lc7LgXUdJVYyhC3yWHUW5C5P5GpHRqVnaM6HJELJxT6IqwM"></script>
  
  <!-- セキュリティシステム -->
  <script src="./js/security/SecurityHeaderManager.js"></script>
  <script src="./js/security/CSRFProtectionSystem.js"></script>
  
  <!-- Future Simulator v2.0 CSS -->
  <link rel="stylesheet" href="./css/future-simulator-v2.css">
  
  <!-- フォント -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet" />
  
  <!-- kuromoji.js -->
  <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.min.js" defer></script>
</head>
<body>
  <!-- ローディングスクリーン -->
  <div id="loadingScreen">
    <div class="loading-content">
      <div class="loading-logo">易</div>
      <h1 class="loading-title">HaQei マルチバース・アナライザー v2.0</h1>
      <div class="loading-progress">
        <div id="initProgress"></div>
      </div>
      <div id="initProgressText">システム初期化中...</div>
    </div>
  </div>

  <!-- メインアプリケーション -->
  <div class="app-container">
    <!-- ヘッダー -->
    <header class="app-header">
      <h1 class="app-title">HaQei マルチバース・アナライザー</h1>
      <p class="app-description">
        HaQei哲学とI Ching（易経）の知恵を統合した未来シミュレーションシステム
      </p>
    </header>

    <!-- 入力ビュー -->
    <section class="view view-input active">
      <div class="input-section">
        <div class="input-header">
          <h2 class="input-title">未来への扉を開く</h2>
          <p class="input-subtitle">現在の状況や悩みをお聞かせください</p>
        </div>
        
        <form class="input-form">
          <div class="text-input-container">
            <textarea 
              id="textInput" 
              placeholder="例：転職を考えているが、今のタイミングが適切かわからない。新しい挑戦をしたい気持ちと安定を求める気持ちの間で揺れている..."
              maxlength="1000"
              aria-label="分析したい状況や悩みを入力してください"
            ></textarea>
            <div class="char-counter">0 文字</div>
            <div class="validation-message"></div>
          </div>
          
          <div class="input-actions">
            <button type="button" id="analyzeButton" class="btn btn-primary btn-lg" disabled>
              未来を分析する
            </button>
            <button type="button" id="clearButton" class="btn btn-secondary">
              クリア
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- 結果ビュー -->
    <section class="view view-results">
      <div class="results-section">
        <div class="results-header">
          <h2 class="results-title">未来のシナリオ</h2>
          <p class="results-subtitle">あなたの状況から導き出された可能性のある未来</p>
        </div>
        
        <!-- シナリオコンテナ -->
        <div id="scenarioContainer"></div>
        
        <!-- 結果コンテナ -->
        <div id="resultContainer"></div>
        
        <!-- 戻るボタン -->
        <div class="text-center" style="margin-top: 2rem;">
          <button type="button" id="backToInputButton" class="btn btn-outline">
            新しい分析を開始
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- ローディングインジケーター -->
  <div id="loadingIndicator">
    <div class="loading-spinner"></div>
    <div class="loading-text">分析中...</div>
  </div>

  <!-- エラーコンテナ -->
  <div id="errorContainer"></div>

  <!-- 成功通知 -->
  <div id="successNotification"></div>

  <!-- エラースクリーン -->
  <div id="errorScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); color: white; display: flex; align-items: center; justify-content: center; z-index: 10000;">
    <div style="text-align: center; max-width: 500px; padding: 2rem;">
      <h2 style="margin-bottom: 1rem;">システムエラー</h2>
      <p id="errorMessage" style="margin-bottom: 2rem;">予期しないエラーが発生しました</p>
      <button onclick="window.location.reload()" style="padding: 0.75rem 1.5rem; background: #6366f1; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
        ページを再読み込み
      </button>
    </div>
  </div>

  <!-- Future Simulator v2.0 モジュールシステム -->
  <script type="module">
    // Future Simulator v2.0 起動
    import('./js/future-simulator-v2/app.js')
      .then(({ futureSimulatorApp }) => {
        console.log('🚀 Future Simulator v2.0 loaded successfully');
        
        // 既存のUI要素との統合
        setupLegacyIntegration();
        
        // 追加のUI設定
        setupAdditionalUI();
      })
      .catch(error => {
        console.error('❌ Failed to load Future Simulator v2.0:', error);
        
        // フォールバック: 既存システムの利用
        loadLegacySystem();
      });

    // レガシーシステム統合
    function setupLegacyIntegration() {
      // 戻るボタンの設定
      const backButton = document.getElementById('backToInputButton');
      if (backButton) {
        backButton.addEventListener('click', () => {
          const uiController = window.FutureSimulatorUI;
          if (uiController) {
            uiController.showView('input');
            uiController.handleClear({ preventDefault: () => {} });
          }
        });
      }
    }

    // 追加UI設定
    function setupAdditionalUI() {
      // エスケープキーでローディング画面を閉じる
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const loadingScreen = document.getElementById('loadingScreen');
          if (loadingScreen && loadingScreen.style.display !== 'none') {
            loadingScreen.style.display = 'none';
          }
        }
      });

      // パフォーマンス監視
      if (window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.name === 'first-contentful-paint') {
              console.log(`🎨 First Contentful Paint: ${entry.startTime.toFixed(2)}ms`);
            }
          }
        });
        
        try {
          observer.observe({entryTypes: ['paint']});
        } catch (e) {
          console.warn('Performance monitoring not supported');
        }
      }
    }

    // フォールバックシステム
    function loadLegacySystem() {
      console.log('🔄 Loading legacy system as fallback...');
      
      // 基本的なフォールバック機能
      const analyzeButton = document.getElementById('analyzeButton');
      const textInput = document.getElementById('textInput');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const resultContainer = document.getElementById('resultContainer');
      
      if (analyzeButton && textInput) {
        analyzeButton.addEventListener('click', () => {
          const text = textInput.value.trim();
          if (!text) return;
          
          // 簡易分析処理
          showLoading(true);
          
          setTimeout(() => {
            const result = generateBasicResult(text);
            displayBasicResult(result);
            showLoading(false);
            showView('results');
          }, 2000);
        });
      }
      
      function showLoading(show) {
        if (loadingIndicator) {
          loadingIndicator.style.display = show ? 'block' : 'none';
        }
      }
      
      function showView(viewName) {
        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });
        document.querySelector(`.view-${viewName}`)?.classList.add('active');
      }
      
      function generateBasicResult(text) {
        return {
          text,
          analysis: '簡易分析を実行しました。',
          scenarios: [
            {
              title: '現状維持シナリオ',
              description: '現在の状況を維持しながら慎重に進む可能性',
              probability: 65
            },
            {
              title: '変化追求シナリオ',
              description: '積極的に変化を求めて行動する可能性',
              probability: 45
            }
          ]
        };
      }
      
      function displayBasicResult(result) {
        if (!resultContainer) return;
        
        resultContainer.innerHTML = `
          <div class="basic-result">
            <h3>分析結果</h3>
            <p>${result.analysis}</p>
            <div class="basic-scenarios">
              ${result.scenarios.map(scenario => `
                <div class="basic-scenario-card">
                  <h4>${scenario.title}</h4>
                  <p>${scenario.description}</p>
                  <div class="probability">確率: ${scenario.probability}%</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    }
  </script>

  <!-- レガシーシステムサポート -->
  <script>
    // v1システムとの互換性確保
    window.addEventListener('load', () => {
      // UIエンハンスメントシステムの初期化
      if (window.FutureSimulatorUIEnhancements) {
        const enhancements = new window.FutureSimulatorUIEnhancements();
        enhancements.initialize().catch(console.warn);
      }
      
      // 文字数カウンター
      const textInput = document.getElementById('textInput');
      const charCounter = document.querySelector('.char-counter');
      
      if (textInput && charCounter) {
        textInput.addEventListener('input', () => {
          const count = textInput.value.length;
          charCounter.textContent = `${count} 文字`;
          
          // ボタン状態更新
          const analyzeButton = document.getElementById('analyzeButton');
          if (analyzeButton) {
            analyzeButton.disabled = count < 10 || count > 1000;
          }
        });
      }
      
      // クリアボタン
      const clearButton = document.getElementById('clearButton');
      if (clearButton && textInput) {
        clearButton.addEventListener('click', () => {
          textInput.value = '';
          textInput.dispatchEvent(new Event('input'));
          textInput.focus();
        });
      }
    });
  </script>

  <!-- パフォーマンス測定 -->
  <script>
    // 初期表示時間の測定
    window.addEventListener('load', () => {
      const loadTime = performance.now();
      console.log(`⚡ Page load time: ${loadTime.toFixed(2)}ms`);
      
      // 目標：1.5秒以内
      if (loadTime <= 1500) {
        console.log('🎯 Performance target achieved!');
      } else {
        console.log(`⚠️ Performance target missed by ${(loadTime - 1500).toFixed(2)}ms`);
      }
    });
  </script>
</body>
</html>