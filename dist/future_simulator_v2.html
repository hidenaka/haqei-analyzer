<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <meta http-equiv="X-Content-Type-Options" content="nosniff">
  <meta http-equiv="X-XSS-Protection" content="1; mode=block">
  <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
  <meta name="csrf-token" content="">
  
  <title>HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ v2.0</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>æ˜“</text></svg>" />
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js" 
          crossorigin="anonymous"
          integrity="sha384-vdScihEZCfbPnBQf+lc7LgXUdJVYyhC3yWHUW5C5P5GpHRqVnaM6HJELJxT6IqwM"></script>
  
  <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚·ã‚¹ãƒ†ãƒ  -->
  <script src="./js/security/SecurityHeaderManager.js"></script>
  <script src="./js/security/CSRFProtectionSystem.js"></script>
  
  <!-- Future Simulator v2.0 CSS -->
  <link rel="stylesheet" href="./css/future-simulator-v2.css">
  
  <!-- ãƒ•ã‚©ãƒ³ãƒˆ -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Noto+Sans+JP:wght@100..900&display=swap" rel="stylesheet" />
  
  <!-- kuromoji.js -->
  <script src="https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.min.js" defer></script>
</head>
<body>
  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
  <div id="loadingScreen">
    <div class="loading-content">
      <div class="loading-logo">æ˜“</div>
      <h1 class="loading-title">HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ v2.0</h1>
      <div class="loading-progress">
        <div id="initProgress"></div>
      </div>
      <div id="initProgressText">ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–ä¸­...</div>
    </div>
  </div>

  <!-- ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="app-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="app-header">
      <h1 class="app-title">HaQei ãƒãƒ«ãƒãƒãƒ¼ã‚¹ãƒ»ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼</h1>
      <p class="app-description">
        HaQeiå“²å­¦ã¨I Chingï¼ˆæ˜“çµŒï¼‰ã®çŸ¥æµã‚’çµ±åˆã—ãŸæœªæ¥ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚·ã‚¹ãƒ†ãƒ 
      </p>
    </header>

    <!-- å…¥åŠ›ãƒ“ãƒ¥ãƒ¼ -->
    <section class="view view-input active">
      <div class="input-section">
        <div class="input-header">
          <h2 class="input-title">æœªæ¥ã¸ã®æ‰‰ã‚’é–‹ã</h2>
          <p class="input-subtitle">ç¾åœ¨ã®çŠ¶æ³ã‚„æ‚©ã¿ã‚’ãŠèã‹ã›ãã ã•ã„</p>
        </div>
        
        <form class="input-form">
          <div class="text-input-container">
            <textarea 
              id="textInput" 
              placeholder="ä¾‹ï¼šè»¢è·ã‚’è€ƒãˆã¦ã„ã‚‹ãŒã€ä»Šã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒé©åˆ‡ã‹ã‚ã‹ã‚‰ãªã„ã€‚æ–°ã—ã„æŒ‘æˆ¦ã‚’ã—ãŸã„æ°—æŒã¡ã¨å®‰å®šã‚’æ±‚ã‚ã‚‹æ°—æŒã¡ã®é–“ã§æºã‚Œã¦ã„ã‚‹..."
              maxlength="1000"
              aria-label="åˆ†æã—ãŸã„çŠ¶æ³ã‚„æ‚©ã¿ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
            ></textarea>
            <div class="char-counter">0 æ–‡å­—</div>
            <div class="validation-message"></div>
          </div>
          
          <div class="input-actions">
            <button type="button" id="analyzeButton" class="btn btn-primary btn-lg" disabled>
              æœªæ¥ã‚’åˆ†æã™ã‚‹
            </button>
            <button type="button" id="clearButton" class="btn btn-secondary">
              ã‚¯ãƒªã‚¢
            </button>
          </div>
        </form>
      </div>
    </section>

    <!-- çµæœãƒ“ãƒ¥ãƒ¼ -->
    <section class="view view-results">
      <div class="results-section">
        <div class="results-header">
          <h2 class="results-title">æœªæ¥ã®ã‚·ãƒŠãƒªã‚ª</h2>
          <p class="results-subtitle">ã‚ãªãŸã®çŠ¶æ³ã‹ã‚‰å°ãå‡ºã•ã‚ŒãŸå¯èƒ½æ€§ã®ã‚ã‚‹æœªæ¥</p>
        </div>
        
        <!-- ã‚·ãƒŠãƒªã‚ªã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="scenarioContainer"></div>
        
        <!-- çµæœã‚³ãƒ³ãƒ†ãƒŠ -->
        <div id="resultContainer"></div>
        
        <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
        <div class="text-center" style="margin-top: 2rem;">
          <button type="button" id="backToInputButton" class="btn btn-outline">
            æ–°ã—ã„åˆ†æã‚’é–‹å§‹
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div id="loadingIndicator">
    <div class="loading-spinner"></div>
    <div class="loading-text">åˆ†æä¸­...</div>
  </div>

  <!-- ã‚¨ãƒ©ãƒ¼ã‚³ãƒ³ãƒ†ãƒŠ -->
  <div id="errorContainer"></div>

  <!-- æˆåŠŸé€šçŸ¥ -->
  <div id="successNotification"></div>

  <!-- ã‚¨ãƒ©ãƒ¼ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ -->
  <div id="errorScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); color: white; display: flex; align-items: center; justify-content: center; z-index: 10000;">
    <div style="text-align: center; max-width: 500px; padding: 2rem;">
      <h2 style="margin-bottom: 1rem;">ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼</h2>
      <p id="errorMessage" style="margin-bottom: 2rem;">äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p>
      <button onclick="window.location.reload()" style="padding: 0.75rem 1.5rem; background: #6366f1; color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
        ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿
      </button>
    </div>
  </div>

  <!-- Future Simulator v2.0 ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚·ã‚¹ãƒ†ãƒ  -->
  <script type="module">
    // Future Simulator v2.0 èµ·å‹•
    import('./js/future-simulator-v2/app.js')
      .then(({ futureSimulatorApp }) => {
        console.log('ğŸš€ Future Simulator v2.0 loaded successfully');
        
        // æ—¢å­˜ã®UIè¦ç´ ã¨ã®çµ±åˆ
        setupLegacyIntegration();
        
        // è¿½åŠ ã®UIè¨­å®š
        setupAdditionalUI();
      })
      .catch(error => {
        console.error('âŒ Failed to load Future Simulator v2.0:', error);
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®åˆ©ç”¨
        loadLegacySystem();
      });

    // ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
    function setupLegacyIntegration() {
      // æˆ»ã‚‹ãƒœã‚¿ãƒ³ã®è¨­å®š
      const backButton = document.getElementById('backToInputButton');
      if (backButton) {
        backButton.addEventListener('click', () => {
          const uiController = window.FutureSimulatorUI;
          if (uiController) {
            uiController.showView('input');
            uiController.handleClear({ preventDefault: () => {} });
          }
        });
      }
    }

    // è¿½åŠ UIè¨­å®š
    function setupAdditionalUI() {
      // ã‚¨ã‚¹ã‚±ãƒ¼ãƒ—ã‚­ãƒ¼ã§ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ç”»é¢ã‚’é–‰ã˜ã‚‹
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          const loadingScreen = document.getElementById('loadingScreen');
          if (loadingScreen && loadingScreen.style.display !== 'none') {
            loadingScreen.style.display = 'none';
          }
        }
      });

      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
      if (window.PerformanceObserver) {
        const observer = new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (entry.name === 'first-contentful-paint') {
              console.log(`ğŸ¨ First Contentful Paint: ${entry.startTime.toFixed(2)}ms`);
            }
          }
        });
        
        try {
          observer.observe({entryTypes: ['paint']});
        } catch (e) {
          console.warn('Performance monitoring not supported');
        }
      }
    }

    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚·ã‚¹ãƒ†ãƒ 
    function loadLegacySystem() {
      console.log('ğŸ”„ Loading legacy system as fallback...');
      
      // åŸºæœ¬çš„ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½
      const analyzeButton = document.getElementById('analyzeButton');
      const textInput = document.getElementById('textInput');
      const loadingIndicator = document.getElementById('loadingIndicator');
      const resultContainer = document.getElementById('resultContainer');
      
      if (analyzeButton && textInput) {
        analyzeButton.addEventListener('click', () => {
          const text = textInput.value.trim();
          if (!text) return;
          
          // ç°¡æ˜“åˆ†æå‡¦ç†
          showLoading(true);
          
          setTimeout(() => {
            const result = generateBasicResult(text);
            displayBasicResult(result);
            showLoading(false);
            showView('results');
          }, 2000);
        });
      }
      
      function showLoading(show) {
        if (loadingIndicator) {
          loadingIndicator.style.display = show ? 'block' : 'none';
        }
      }
      
      function showView(viewName) {
        document.querySelectorAll('.view').forEach(view => {
          view.classList.remove('active');
        });
        document.querySelector(`.view-${viewName}`)?.classList.add('active');
      }
      
      function generateBasicResult(text) {
        return {
          text,
          analysis: 'ç°¡æ˜“åˆ†æã‚’å®Ÿè¡Œã—ã¾ã—ãŸã€‚',
          scenarios: [
            {
              title: 'ç¾çŠ¶ç¶­æŒã‚·ãƒŠãƒªã‚ª',
              description: 'ç¾åœ¨ã®çŠ¶æ³ã‚’ç¶­æŒã—ãªãŒã‚‰æ…é‡ã«é€²ã‚€å¯èƒ½æ€§',
              probability: 65
            },
            {
              title: 'å¤‰åŒ–è¿½æ±‚ã‚·ãƒŠãƒªã‚ª',
              description: 'ç©æ¥µçš„ã«å¤‰åŒ–ã‚’æ±‚ã‚ã¦è¡Œå‹•ã™ã‚‹å¯èƒ½æ€§',
              probability: 45
            }
          ]
        };
      }
      
      function displayBasicResult(result) {
        if (!resultContainer) return;
        
        resultContainer.innerHTML = `
          <div class="basic-result">
            <h3>åˆ†æçµæœ</h3>
            <p>${result.analysis}</p>
            <div class="basic-scenarios">
              ${result.scenarios.map(scenario => `
                <div class="basic-scenario-card">
                  <h4>${scenario.title}</h4>
                  <p>${scenario.description}</p>
                  <div class="probability">ç¢ºç‡: ${scenario.probability}%</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }
    }
  </script>

  <!-- ãƒ¬ã‚¬ã‚·ãƒ¼ã‚·ã‚¹ãƒ†ãƒ ã‚µãƒãƒ¼ãƒˆ -->
  <script>
    // v1ã‚·ã‚¹ãƒ†ãƒ ã¨ã®äº’æ›æ€§ç¢ºä¿
    window.addEventListener('load', () => {
      // UIã‚¨ãƒ³ãƒãƒ³ã‚¹ãƒ¡ãƒ³ãƒˆã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–
      if (window.FutureSimulatorUIEnhancements) {
        const enhancements = new window.FutureSimulatorUIEnhancements();
        enhancements.initialize().catch(console.warn);
      }
      
      // æ–‡å­—æ•°ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼
      const textInput = document.getElementById('textInput');
      const charCounter = document.querySelector('.char-counter');
      
      if (textInput && charCounter) {
        textInput.addEventListener('input', () => {
          const count = textInput.value.length;
          charCounter.textContent = `${count} æ–‡å­—`;
          
          // ãƒœã‚¿ãƒ³çŠ¶æ…‹æ›´æ–°
          const analyzeButton = document.getElementById('analyzeButton');
          if (analyzeButton) {
            analyzeButton.disabled = count < 10 || count > 1000;
          }
        });
      }
      
      // ã‚¯ãƒªã‚¢ãƒœã‚¿ãƒ³
      const clearButton = document.getElementById('clearButton');
      if (clearButton && textInput) {
        clearButton.addEventListener('click', () => {
          textInput.value = '';
          textInput.dispatchEvent(new Event('input'));
          textInput.focus();
        });
      }
    });
  </script>

  <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¸¬å®š -->
  <script>
    // åˆæœŸè¡¨ç¤ºæ™‚é–“ã®æ¸¬å®š
    window.addEventListener('load', () => {
      const loadTime = performance.now();
      console.log(`âš¡ Page load time: ${loadTime.toFixed(2)}ms`);
      
      // ç›®æ¨™ï¼š1.5ç§’ä»¥å†…
      if (loadTime <= 1500) {
        console.log('ğŸ¯ Performance target achieved!');
      } else {
        console.log(`âš ï¸ Performance target missed by ${(loadTime - 1500).toFixed(2)}ms`);
      }
    });
  </script>
</body>
</html>