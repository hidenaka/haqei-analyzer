<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>T102 HAQEI 緊急質問フロー - 30問完全実装</title>
  
  <!-- Security Headers -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:;">
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    /* T102 Emergency HAQEI Styles - 30問質問フロー専用 */
    :root {
      --primary-900: #0f172a;
      --primary-800: #1e293b;
      --primary-700: #334155;
      --primary-600: #475569;
      --primary-500: #64748b;
      --primary-400: #94a3b8;
      --primary-300: #cbd5e1;
      --primary-200: #e2e8f0;
      --primary-100: #f1f5f9;
      --primary-50: #f8fafc;
      --accent-500: #6366f1;
      --accent-400: #8b5cf6;
      --success-500: #10b981;
      --error-500: #ef4444;
      --warning-500: #f59e0b;
      --font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
      --font-jp: "Shippori Mincho", serif;
      --space-xs: 0.5rem;
      --space-sm: 0.75rem;
      --space-md: 1rem;
      --space-lg: 1.5rem;
      --space-xl: 2rem;
      --space-2xl: 3rem;
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
      --transition-fast: 150ms ease;
      --transition-normal: 300ms ease;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    }
    
    /* Reset */
    *, *::before, *::after {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    html {
      scroll-behavior: smooth;
    }
    
    body {
      font-family: var(--font-family);
      background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-800) 50%, var(--primary-700) 100%);
      background-attachment: fixed;
      color: var(--primary-100);
      min-height: 100vh;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    /* App Container */
    .app-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-md);
    }
    
    /* Question Flow Container */
    .question-flow {
      width: 100%;
      max-width: 800px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: var(--radius-xl);
      border: 1px solid rgba(99, 102, 241, 0.2);
      backdrop-filter: blur(20px);
      overflow: hidden;
      box-shadow: var(--shadow-lg);
    }
    
    /* Progress Bar */
    .progress-container {
      height: 4px;
      background: var(--primary-700);
      position: relative;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-500), var(--accent-400));
      width: var(--progress, 0%);
      transition: width var(--transition-normal);
      border-radius: 2px;
    }
    
    /* Header */
    .question-header {
      padding: var(--space-xl);
      border-bottom: 1px solid rgba(99, 102, 241, 0.1);
      text-align: center;
    }
    
    .question-counter {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.3);
      border-radius: var(--radius-lg);
      padding: var(--space-sm) var(--space-lg);
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent-400);
      margin-bottom: var(--space-lg);
    }
    
    .progress-text {
      font-size: 0.75rem;
      color: var(--primary-400);
      margin-top: var(--space-sm);
    }
    
    .question-instruction {
      color: var(--primary-300);
      font-size: 0.875rem;
      margin-bottom: var(--space-lg);
    }
    
    /* Question Card */
    .question-card {
      padding: var(--space-xl);
    }
    
    .question-text {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--primary-100);
      margin-bottom: var(--space-xl);
      line-height: 1.5;
      text-align: center;
    }
    
    /* Options */
    .question-options {
      display: grid;
      gap: var(--space-md);
      margin-bottom: var(--space-xl);
    }
    
    .option-item {
      position: relative;
    }
    
    .option-input {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .option-label {
      display: block;
      background: rgba(30, 41, 59, 0.5);
      border: 2px solid transparent;
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      cursor: pointer;
      transition: all var(--transition-normal);
      position: relative;
      min-height: 80px;
    }
    
    .option-label:hover {
      background: rgba(30, 41, 59, 0.8);
      border-color: rgba(99, 102, 241, 0.3);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }
    
    .option-input:checked + .option-label {
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--accent-400);
      box-shadow: 0 0 0 1px var(--accent-400);
    }
    
    .option-content {
      display: flex;
      align-items: flex-start;
      gap: var(--space-md);
    }
    
    .option-value {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--primary-600);
      border-radius: 50%;
      font-weight: 600;
      font-size: 0.875rem;
      color: var(--primary-200);
      flex-shrink: 0;
    }
    
    .option-input:checked + .option-label .option-value {
      background: var(--accent-500);
      color: white;
    }
    
    .option-text {
      flex: 1;
      color: var(--primary-200);
      line-height: 1.5;
      font-size: 0.9rem;
    }
    
    .option-input:checked + .option-label .option-text {
      color: var(--primary-100);
      font-weight: 500;
    }
    
    /* Navigation */
    .question-navigation {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-xl);
      border-top: 1px solid rgba(99, 102, 241, 0.1);
      background: rgba(15, 23, 42, 0.5);
    }
    
    .nav-button {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md) var(--space-lg);
      background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
      color: white;
      border: none;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-normal);
      min-width: 120px;
      justify-content: center;
    }
    
    .nav-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }
    
    .nav-button:active:not(:disabled) {
      transform: translateY(0) scale(0.98);
    }
    
    .nav-button:disabled {
      background: var(--primary-600);
      color: var(--primary-400);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .nav-button.secondary {
      background: transparent;
      border: 1px solid var(--primary-500);
      color: var(--primary-300);
    }
    
    .nav-button.secondary:hover:not(:disabled) {
      background: rgba(99, 102, 241, 0.1);
      border-color: var(--accent-400);
      color: var(--accent-400);
    }
    
    .nav-info {
      text-align: center;
      color: var(--primary-400);
      font-size: 0.875rem;
      font-weight: 500;
    }
    
    /* Validation Message */
    .validation-message {
      padding: var(--space-md) var(--space-xl);
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: var(--radius-md);
      color: #fca5a5;
      font-size: 0.875rem;
      margin: var(--space-md) var(--space-xl);
      display: none;
      animation: fadeIn var(--transition-normal) ease;
    }
    
    .validation-message.visible {
      display: block;
    }
    
    /* Category Headers */
    .category-header {
      background: rgba(99, 102, 241, 0.1);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      margin-bottom: var(--space-xl);
      text-align: center;
    }
    
    .category-title {
      font-size: 1.125rem;
      font-weight: 600;
      color: var(--accent-400);
      margin-bottom: var(--space-sm);
      font-family: var(--font-jp);
    }
    
    .category-description {
      font-size: 0.875rem;
      color: var(--primary-300);
      line-height: 1.5;
    }
    
    /* Results Button */
    .results-button {
      background: linear-gradient(135deg, var(--success-500), #059669);
      padding: var(--space-lg) var(--space-2xl);
      font-size: 1.125rem;
      font-weight: 700;
      min-width: 180px;
    }
    
    /* Loading State */
    .loading {
      display: inline-flex;
      align-items: center;
      gap: var(--space-sm);
    }
    
    .loading::after {
      content: "";
      width: 16px;
      height: 16px;
      border: 2px solid transparent;
      border-top-color: currentColor;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    .animate-fadeIn {
      animation: fadeIn var(--transition-normal) ease;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .app-container {
        padding: var(--space-sm);
      }
      
      .question-header,
      .question-card,
      .question-navigation {
        padding: var(--space-lg);
      }
      
      .question-text {
        font-size: 1.125rem;
      }
      
      .question-navigation {
        flex-direction: column;
        gap: var(--space-md);
      }
      
      .nav-button {
        width: 100%;
      }
    }
    
    @media (max-width: 480px) {
      .app-container {
        padding: var(--space-xs);
      }
      
      .question-header,
      .question-card,
      .question-navigation {
        padding: var(--space-md);
      }
      
      .option-content {
        flex-direction: column;
        gap: var(--space-sm);
      }
      
      .option-value {
        width: 28px;
        height: 28px;
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <div class="question-flow" id="question-flow">
      <!-- Progress Bar -->
      <div class="progress-container">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      
      <!-- Content will be rendered here -->
      <div id="question-content">
        <!-- Loading state -->
        <div class="question-header">
          <div class="loading">質問を読み込み中</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Validation Message -->
  <div id="validation-message" class="validation-message">
    <span id="validation-text"></span>
  </div>

  <script>
    /**
     * T102 Emergency HAQEI Question Flow - Complete 30 Question Implementation
     * 緊急質問フロー - 30問完全実装
     */
    
    class EmergencyHAQEIFlow {
      constructor() {
        this.currentQuestionIndex = 0;
        this.answers = {};
        this.isLoading = false;
        this.isCompleted = false;
        
        // 30問の質問データ - questions.tsから変換
        this.questions = this.initializeQuestions();
        
        // DOM要素の参照
        this.questionContent = document.getElementById('question-content');
        this.progressFill = document.getElementById('progress-fill');
        this.validationMessage = document.getElementById('validation-message');
        this.validationText = document.getElementById('validation-text');
        
        this.init();
      }
      
      /**
       * 30問質問データの初期化（questions.tsベース）
       */
      initializeQuestions() {
        return [
          // Q1-Q3: 乾_創造性
          {
            id: "q1",
            text: "新しいプロジェクトや取り組みを始めるとき、あなたが最も重視することは？",
            category: { title: "創造性の次元", description: "新しい物事への取り組み方を測定します" },
            options: [
              { value: "A", text: "誰もやったことのない革新的なアプローチを試す" },
              { value: "B", text: "既存の方法を改良してより良いものにする" },
              { value: "C", text: "みんなで話し合って最適な方法を見つける" },
              { value: "D", text: "過去の成功例を参考にして確実に進める" },
              { value: "E", text: "状況に応じて柔軟に方法を調整する" }
            ]
          },
          {
            id: "q2", 
            text: "アイデアが浮かんだとき、あなたの行動パターンは？",
            options: [
              { value: "A", text: "すぐに新しい形として具現化してみたくなる" },
              { value: "B", text: "まず詳しく調べてから実行に移す" },
              { value: "C", text: "周りの人と相談して意見を聞く" },
              { value: "D", text: "実現可能性を慎重に検討する" },
              { value: "E", text: "タイミングを見計らって最適な時に実行する" }
            ]
          },
          {
            id: "q3",
            text: "「創造する」ということについて、あなたの考えに最も近いのは？",
            options: [
              { value: "A", text: "何もないところから全く新しいものを生み出すこと" },
              { value: "B", text: "みんなで協力して素晴らしいものを作り上げること" },
              { value: "C", text: "深く研究して新しい発見をすること" },
              { value: "D", text: "着実に積み重ねて価値あるものを築くこと" },
              { value: "E", text: "状況に合わせて最適な解決策を見つけること" }
            ]
          },
          
          // Q4-Q6: 震_行動性
          {
            id: "q4",
            text: "やらなければならないことがあるとき、あなたのスタイルは？",
            category: { title: "行動性の次元", description: "行動への取り組み方を測定します" },
            options: [
              { value: "A", text: "すぐに行動を起こして勢いで進める" },
              { value: "B", text: "計画を立ててから着実に実行する" },
              { value: "C", text: "周りと協力してチームで進める" },
              { value: "D", text: "状況を見極めてから最適なタイミングで動く" },
              { value: "E", text: "自分の感覚を信じて直感的に進める" }
            ]
          },
          {
            id: "q5",
            text: "ストレスや困難な状況に直面したとき、あなたの第一反応は？",
            options: [
              { value: "A", text: "即座に問題解決に向けて動き出す" },
              { value: "B", text: "冷静に状況を分析して原因を探る" },
              { value: "C", text: "信頼できる人に相談して支えを求める" },
              { value: "D", text: "落ち着いて状況が好転するのを待つ" },
              { value: "E", text: "柔軟に対応しながら最善の道を探る" }
            ]
          },
          {
            id: "q6",
            text: "新しい挑戦や機会があるとき、あなたの反応は？",
            options: [
              { value: "A", text: "ワクワクして飛び込みたくなる" },
              { value: "B", text: "興味深いが、まず詳しく調べてから決める" },
              { value: "C", text: "リスクと利益を慎重に天秤にかける" },
              { value: "D", text: "周りの意見を聞いてから判断する" },
              { value: "E", text: "自分にとって本当に価値があるか考える" }
            ]
          },
          
          // Q7-Q9: 坎_探求性
          {
            id: "q7",
            text: "知らないことに出会ったとき、あなたの反応は？",
            category: { title: "探求性の次元", description: "知識や理解への取り組み方を測定します" },
            options: [
              { value: "A", text: "深く掘り下げて徹底的に理解したくなる" },
              { value: "B", text: "新しい発見や可能性を見つけたくなる" },
              { value: "C", text: "みんなで一緒に学び合いたくなる" },
              { value: "D", text: "実用的で役に立つ部分を知りたくなる" },
              { value: "E", text: "必要に応じて少しずつ理解していく" }
            ]
          },
          {
            id: "q8",
            text: "複雑な問題に直面したとき、あなたのアプローチは？",
            options: [
              { value: "A", text: "問題の本質を見極めるまで考え抜く" },
              { value: "B", text: "新しい視点から問題を捉え直す" },
              { value: "C", text: "いろいろな人の意見を聞いて参考にする" },
              { value: "D", text: "まず行動してみて、やりながら解決策を見つける" },
              { value: "E", text: "過去の経験や事例を参考にして解決する" }
            ]
          },
          {
            id: "q9",
            text: "学習や研究について、あなたの姿勢は？",
            options: [
              { value: "A", text: "真理や本質を追求することに喜びを感じる" },
              { value: "B", text: "新しい発見から創造的なアイデアを得たい" },
              { value: "C", text: "学んだことをみんなと共有したい" },
              { value: "D", text: "実生活で活用できる知識を身につけたい" },
              { value: "E", text: "状況に応じて必要な知識を効率よく学ぶ" }
            ]
          },
          
          // Q10-Q12: 艮_安定性
          {
            id: "q10",
            text: "重要な決断をするとき、あなたが最も重視することは？",
            category: { title: "安定性の次元", description: "持続性や確実性への価値観を測定します" },
            options: [
              { value: "A", text: "確実性が高く、リスクの少ない選択肢" },
              { value: "B", text: "革新的で大きな可能性のある選択肢" },
              { value: "C", text: "みんなが納得できる選択肢" },
              { value: "D", text: "論理的に最も合理的な選択肢" },
              { value: "E", text: "状況に応じて柔軟に変更できる選択肢" }
            ]
          },
          {
            id: "q11",
            text: "長期的な目標について、あなたの考え方は？",
            options: [
              { value: "A", text: "着実に積み重ねて確実に達成したい" },
              { value: "B", text: "大胆な挑戦で大きな成果を目指したい" },
              { value: "C", text: "みんなと一緒に成長していきたい" },
              { value: "D", text: "深く探求して専門性を高めたい" },
              { value: "E", text: "状況に応じて目標を柔軟に調整したい" }
            ]
          },
          {
            id: "q12",
            text: "「継続」や「持続」について、あなたの価値観は？",
            options: [
              { value: "A", text: "一度始めたことは最後までやり遂げることが大切" },
              { value: "B", text: "常に新しいことに挑戦し続けることが大切" },
              { value: "C", text: "みんなと良い関係を長く保つことが大切" },
              { value: "D", text: "深く学び続けて理解を深めることが大切" },
              { value: "E", text: "変化に合わせて適応し続けることが大切" }
            ]
          },
          
          // Q13-Q15: 坤_受容性
          {
            id: "q13",
            text: "他の人との関わり方で、あなたの特徴は？",
            category: { title: "受容性の次元", description: "他者との関わり方や受け入れる力を測定します" },
            options: [
              { value: "A", text: "積極的にリードして新しい方向性を示す" },
              { value: "B", text: "相手の話をじっくり聞いて理解しようとする" },
              { value: "C", text: "お互いの意見を交換して学び合う" },
              { value: "D", text: "エネルギッシュに活動して盛り上げる" },
              { value: "E", text: "相手に合わせて適切な距離感を保つ" }
            ]
          },
          {
            id: "q14",
            text: "困っている人を見かけたとき、あなたの反応は？",
            options: [
              { value: "A", text: "新しい解決方法を提案してサポートする" },
              { value: "B", text: "まず相手の気持ちを受け止めて寄り添う" },
              { value: "C", text: "一緒に解決策を考えて実行する" },
              { value: "D", text: "問題の原因を分析して根本的な解決を図る" },
              { value: "E", text: "その人に最も適した支援方法を見つける" }
            ]
          },
          {
            id: "q15",
            text: "「支える」ということについて、あなたの考えは？",
            options: [
              { value: "A", text: "新しい可能性を開いて人を励ますこと" },
              { value: "B", text: "どんな時も変わらずそばにいること" },
              { value: "C", text: "共に喜び、共に悲しむこと" },
              { value: "D", text: "具体的な行動で実際に助けること" },
              { value: "E", text: "相手の状況に合わせて最適な支援をすること" }
            ]
          },
          
          // Q16-Q18: 巽_適応性
          {
            id: "q16",
            text: "予期しない変化や困難に直面したとき、あなたの対応は？",
            category: { title: "適応性の次元", description: "変化や状況への適応力を測定します" },
            options: [
              { value: "A", text: "これを機会に新しいことに挑戦する" },
              { value: "B", text: "状況に合わせて柔軟に方針を調整する" },
              { value: "C", text: "みんなで協力して乗り越える方法を探す" },
              { value: "D", text: "原因を分析して根本的な対策を立てる" },
              { value: "E", text: "確実で安全な方法で対処する" }
            ]
          },
          {
            id: "q17",
            text: "異なる価値観の人たちと一緒に活動するとき、あなたの役割は？",
            options: [
              { value: "A", text: "新しい視点やアイデアを提供する" },
              { value: "B", text: "みんなの意見を調整して橋渡しをする" },
              { value: "C", text: "全体の雰囲気を和やかに保つ" },
              { value: "D", text: "積極的に行動して場を盛り上げる" },
              { value: "E", text: "安定した基盤を提供して支える" }
            ]
          },
          {
            id: "q18",
            text: "「柔軟性」について、あなたの価値観は？",
            options: [
              { value: "A", text: "新しい可能性を生み出すために必要なもの" },
              { value: "B", text: "どんな状況でも対応できる大切な能力" },
              { value: "C", text: "人との関係を良好に保つために重要なもの" },
              { value: "D", text: "効果的に行動するための手段の一つ" },
              { value: "E", text: "一貫性があってこそ意味を持つもの" }
            ]
          },
          
          // Q19-Q21: 離_表現性
          {
            id: "q19",
            text: "自分の考えや気持ちを表現するとき、あなたのスタイルは？",
            category: { title: "表現性の次元", description: "自己表現力や影響力を測定します" },
            options: [
              { value: "A", text: "独創的で印象に残る方法で表現する" },
              { value: "B", text: "相手に合わせて分かりやすく伝える" },
              { value: "C", text: "論理的で説得力のある説明をする" },
              { value: "D", text: "率直で正直な表現を心がける" },
              { value: "E", text: "相手の気持ちに寄り添いながら伝える" }
            ]
          },
          {
            id: "q20",
            text: "注目を浴びる場面で、あなたの反応は？",
            options: [
              { value: "A", text: "自分らしさを思い切り発揮する" },
              { value: "B", text: "場の雰囲気に合わせて適切に振る舞う" },
              { value: "C", text: "みんなが楽しめるように配慮する" },
              { value: "D", text: "控えめに振る舞って目立たないようにする" },
              { value: "E", text: "エネルギッシュに行動して場を盛り上げる" }
            ]
          },
          {
            id: "q21",
            text: "「影響力を持つ」ということについて、あなたの考えは？",
            options: [
              { value: "A", text: "新しい価値観や可能性を伝える力" },
              { value: "B", text: "自分の個性や魅力で人を惹きつける力" },
              { value: "C", text: "みんなをまとめて良い方向に導く力" },
              { value: "D", text: "行動で示して周りを動かす力" },
              { value: "E", text: "信頼と実績で認められる力" }
            ]
          },
          
          // Q22-Q24: 兌_調和性
          {
            id: "q22",
            text: "対立や意見の衝突が起きたとき、あなたの対応は？",
            category: { title: "調和性の次元", description: "協調性や調和を重視する力を測定します" },
            options: [
              { value: "A", text: "新しい視点を提示して流れを変える" },
              { value: "B", text: "双方の良い点を見つけて橋渡しをする" },
              { value: "C", text: "冷静に分析して客観的な解決策を提示する" },
              { value: "D", text: "積極的に行動して状況を打開する" },
              { value: "E", text: "相手の気持ちを受け止めて寄り添う" }
            ]
          },
          {
            id: "q23",
            text: "人との関係で最も大切にしていることは？",
            options: [
              { value: "A", text: "お互いに刺激し合って成長できること" },
              { value: "B", text: "笑顔で楽しい時間を共有できること" },
              { value: "C", text: "深く理解し合えること" },
              { value: "D", text: "互いを支え合えること" },
              { value: "E", text: "相手に合わせて適切な関係を築けること" }
            ]
          },
          {
            id: "q24",
            text: "「つながり」や「絆」について、あなたの価値観は？",
            options: [
              { value: "A", text: "新しい出会いから生まれる可能性が大切" },
              { value: "B", text: "お互いに喜びを分かち合えることが大切" },
              { value: "C", text: "深い信頼関係を築けることが大切" },
              { value: "D", text: "困った時に支え合えることが大切" },
              { value: "E", text: "お互いの違いを認め合えることが大切" }
            ]
          },
          
          // Q25-Q30: シナリオ設問（Interface/SafeMode OS特定用）
          {
            id: "q25",
            text: "あなたが会社で新しいプロジェクトリーダーに任命されました。メンバーは経験豊富ですが、それぞれ異なる意見を持っています。最初のミーティングで、あなたはどのようにチームをまとめますか？",
            category: { title: "シナリオ設問", description: "具体的な状況での行動パターンを分析します" },
            options: [
              { value: "A", text: "全員の意見をじっくり聞いてから、みんなが納得できる折衷案を作る" },
              { value: "B", text: "明確なビジョンを示し、そこに向かってメンバーを導く" },
              { value: "C", text: "各メンバーの強みを分析し、最適な役割分担を提案する" },
              { value: "D", text: "過去の成功事例を共有し、実績に基づいた方法論を提案する" },
              { value: "E", text: "まずは小さな成功を目指し、チームの結束を高めながら進める" }
            ]
          },
          {
            id: "q26",
            text: "重要なプレゼンテーションの直前に、技術的な問題が発生しました。あなたの対応は？",
            options: [
              { value: "A", text: "代替案を即座に考えて、予定通り実行する" },
              { value: "B", text: "問題を正直に説明し、理解を求めながら進める" },
              { value: "C", text: "チーム全員で協力して最善の解決策を見つける" },
              { value: "D", text: "問題の原因を分析し、根本的な対策を検討する" },
              { value: "E", text: "延期を提案し、完璧な状態で実施する" }
            ]
          },
          {
            id: "q27",
            text: "新しい環境（転職、引っ越し等）に置かれたとき、あなたの適応方法は？",
            options: [
              { value: "A", text: "積極的に新しいことに挑戦して、自分らしさを発揮する" },
              { value: "B", text: "周りの人とコミュニケーションを取り、関係性を築く" },
              { value: "C", text: "環境をよく観察し、ルールや文化を理解する" },
              { value: "D", text: "過去の経験を活かし、着実に基盤を固める" },
              { value: "E", text: "状況に合わせて、必要に応じて自分を調整する" }
            ]
          },
          {
            id: "q28",
            text: "大切な決断を迫られ、限られた情報しかない状況では？",
            options: [
              { value: "A", text: "直感を信じて、素早く決断する" },
              { value: "B", text: "信頼できる人に相談して、意見を求める" },
              { value: "C", text: "可能な限り情報を収集してから判断する" },
              { value: "D", text: "リスクを最小限に抑える選択肢を選ぶ" },
              { value: "E", text: "複数のシナリオを想定して、柔軟な計画を立てる" }
            ]
          },
          {
            id: "q29",
            text: "チームの成果が期待を下回った場合、あなたの反応は？",
            options: [
              { value: "A", text: "新しいアプローチを提案し、チームを鼓舞する" },
              { value: "B", text: "メンバーの気持ちに寄り添い、支援を強化する" },
              { value: "C", text: "客観的に分析し、改善点を明確にする" },
              { value: "D", text: "責任を取り、より確実な方法に変更する" },
              { value: "E", text: "状況に応じて戦略を柔軟に調整する" }
            ]
          },
          {
            id: "q30",
            text: "人生の重要な転機において、あなたが最も大切にしたい価値観は？",
            options: [
              { value: "A", text: "新しい可能性への挑戦と成長" },
              { value: "B", text: "大切な人との絆とつながり" },
              { value: "C", text: "真理の探求と深い理解" },
              { value: "D", text: "安定した基盤と確実な歩み" },
              { value: "E", text: "変化への適応と柔軟な対応" }
            ]
          }
        ];
      }
      
      /**
       * 初期化
       */
      init() {
        // 保存された進捗を復元
        this.loadProgress();
        
        // 初期レンダリング
        this.render();
        
        // イベントリスナーの設定
        this.bindEvents();
        
        // キーボードナビゲーション
        this.setupKeyboardNavigation();
      }
      
      /**
       * レンダリング
       */
      render() {
        if (this.isCompleted) {
          this.renderComplete();
          return;
        }
        
        const question = this.questions[this.currentQuestionIndex];
        const progress = this.calculateProgress();
        
        // プログレスバー更新
        this.progressFill.style.width = `${progress}%`;
        this.progressFill.parentElement.style.setProperty('--progress', `${progress}%`);
        
        // 質問コンテンツ
        this.questionContent.innerHTML = `
          <div class="question-header">
            <div class="question-counter">
              <span>質問 ${this.currentQuestionIndex + 1} / 30</span>
            </div>
            <div class="question-instruction">
              直感で答えてください。正解はありません。
            </div>
            <div class="progress-text">
              進捗: ${Math.round(progress)}%
            </div>
          </div>
          
          ${question.category && this.currentQuestionIndex % 3 === 0 ? `
            <div class="category-header">
              <div class="category-title">${question.category.title}</div>
              <div class="category-description">${question.category.description}</div>
            </div>
          ` : ''}
          
          <div class="question-card" data-question-id="${question.id}">
            <h3 class="question-text">${question.text}</h3>
            
            <div class="question-options">
              ${question.options.map(option => `
                <div class="option-item">
                  <input type="radio" 
                         id="${question.id}-${option.value}" 
                         name="${question.id}" 
                         value="${option.value}" 
                         class="option-input"
                         ${this.answers[question.id] === option.value ? 'checked' : ''}>
                  <label for="${question.id}-${option.value}" class="option-label">
                    <div class="option-content">
                      <div class="option-value">${option.value}</div>
                      <div class="option-text">${option.text}</div>
                    </div>
                  </label>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="question-navigation">
            <button type="button" 
                    class="nav-button secondary" 
                    id="prev-btn"
                    ${this.currentQuestionIndex === 0 ? 'disabled' : ''}>
              ← 前の質問
            </button>
            
            <div class="nav-info">
              ${this.currentQuestionIndex + 1} / 30
            </div>
            
            <button type="button" 
                    class="nav-button ${this.currentQuestionIndex === 29 ? 'results-button' : ''}" 
                    id="next-btn"
                    ${!this.answers[question.id] ? 'disabled' : ''}>
              ${this.currentQuestionIndex === 29 ? '結果を見る →' : '次の質問 →'}
            </button>
          </div>
        `;
        
        // アニメーション
        this.questionContent.classList.add('animate-fadeIn');
      }
      
      /**
       * 完了画面をレンダリング
       */
      renderComplete() {
        this.progressFill.style.width = '100%';
        this.progressFill.parentElement.style.setProperty('--progress', '100%');
        
        this.questionContent.innerHTML = `
          <div class="question-header">
            <div class="question-counter">
              <span>完了しました！</span>
            </div>
            <div class="question-instruction">
              30問すべてにお答えいただき、ありがとうございました。
            </div>
            <div class="progress-text">
              進捗: 100%
            </div>
          </div>
          
          <div class="question-card">
            <h3 class="question-text">分析結果を準備しています...</h3>
            
            <div style="text-align: center; padding: 2rem;">
              <div class="loading" style="justify-content: center; font-size: 1.125rem;">
                あなたの Triple OS を分析中
              </div>
              <p style="margin-top: 1rem; color: var(--primary-400);">
                回答データを基に、エンジンOS、インターフェースOS、セーフモードOSを判定しています
              </p>
            </div>
          </div>
          
          <div class="question-navigation">
            <button type="button" class="nav-button secondary" onclick="location.reload()">
              最初から
            </button>
            
            <div class="nav-info">
              分析準備中...
            </div>
            
            <button type="button" class="nav-button results-button" id="analyze-btn">
              分析開始 →
            </button>
          </div>
        `;
        
        // 分析ボタンの処理
        setTimeout(() => {
          const analyzeBtn = document.getElementById('analyze-btn');
          if (analyzeBtn) {
            analyzeBtn.addEventListener('click', () => this.proceedToAnalysis());
          }
        }, 100);
      }
      
      /**
       * イベントバインディング
       */
      bindEvents() {
        // ナビゲーションボタン
        document.addEventListener('click', (e) => {
          if (e.target.id === 'prev-btn') {
            this.goToPrevious();
          } else if (e.target.id === 'next-btn') {
            this.goToNext();
          }
        });
        
        // 回答選択
        document.addEventListener('change', (e) => {
          if (e.target.classList.contains('option-input')) {
            this.handleAnswerChange(e);
          }
        });
      }
      
      /**
       * キーボードナビゲーション
       */
      setupKeyboardNavigation() {
        document.addEventListener('keydown', (e) => {
          switch (e.key) {
            case 'ArrowLeft':
              if (this.currentQuestionIndex > 0) {
                e.preventDefault();
                this.goToPrevious();
              }
              break;
            case 'ArrowRight':
            case 'Enter':
              if (this.canGoNext()) {
                e.preventDefault();
                this.goToNext();
              }
              break;
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
              const optionIndex = parseInt(e.key) - 1;
              this.selectOptionByIndex(optionIndex);
              break;
          }
        });
      }
      
      /**
       * 回答変更ハンドラー
       */
      handleAnswerChange(e) {
        const questionId = e.target.name;
        const answer = e.target.value;
        
        this.answers[questionId] = answer;
        this.hideValidationMessage();
        this.updateNavigation();
        this.saveProgress();
      }
      
      /**
       * 前の質問に移動
       */
      goToPrevious() {
        if (this.currentQuestionIndex > 0) {
          this.currentQuestionIndex--;
          this.render();
          this.saveProgress();
        }
      }
      
      /**
       * 次の質問に移動
       */
      goToNext() {
        const currentQuestion = this.questions[this.currentQuestionIndex];
        
        if (!this.answers[currentQuestion.id]) {
          this.showValidationMessage('この質問に回答してください。');
          return;
        }
        
        if (this.currentQuestionIndex === 29) {
          // 最後の質問 - Triple OS分析開始
          this.isCompleted = true;
          this.startTripleOSAnalysis();
        } else {
          this.currentQuestionIndex++;
          this.render();
          this.saveProgress();
        }
      }
      
      /**
       * 次に進めるかチェック
       */
      canGoNext() {
        const currentQuestion = this.questions[this.currentQuestionIndex];
        return !!this.answers[currentQuestion.id];
      }
      
      /**
       * ナビゲーション更新
       */
      updateNavigation() {
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        
        if (prevBtn) {
          prevBtn.disabled = this.currentQuestionIndex === 0;
        }
        
        if (nextBtn) {
          nextBtn.disabled = !this.canGoNext();
        }
      }
      
      /**
       * インデックスで選択肢を選択
       */
      selectOptionByIndex(optionIndex) {
        const currentQuestion = this.questions[this.currentQuestionIndex];
        if (currentQuestion.options[optionIndex]) {
          const option = currentQuestion.options[optionIndex];
          const input = document.getElementById(`${currentQuestion.id}-${option.value}`);
          if (input) {
            input.checked = true;
            input.dispatchEvent(new Event('change', { bubbles: true }));
          }
        }
      }
      
      /**
       * 進捗計算
       */
      calculateProgress() {
        const answeredCount = Object.keys(this.answers).length;
        return (answeredCount / 30) * 100;
      }
      
      /**
       * バリデーションメッセージ表示
       */
      showValidationMessage(message) {
        this.validationText.textContent = message;
        this.validationMessage.classList.add('visible');
        
        setTimeout(() => {
          this.hideValidationMessage();
        }, 3000);
      }
      
      /**
       * バリデーションメッセージ非表示
       */
      hideValidationMessage() {
        this.validationMessage.classList.remove('visible');
      }
      
      /**
       * 進捗保存
       */
      saveProgress() {
        const progressData = {
          currentQuestionIndex: this.currentQuestionIndex,
          answers: this.answers,
          isCompleted: this.isCompleted,
          timestamp: new Date().toISOString()
        };
        
        try {
          localStorage.setItem('haqei_emergency_progress', JSON.stringify(progressData));
        } catch (error) {
          console.warn('進捗の保存に失敗:', error);
        }
      }
      
      /**
       * 進捗読み込み
       */
      loadProgress() {
        try {
          const saved = localStorage.getItem('haqei_emergency_progress');
          if (saved) {
            const progressData = JSON.parse(saved);
            this.currentQuestionIndex = progressData.currentQuestionIndex || 0;
            this.answers = progressData.answers || {};
            this.isCompleted = progressData.isCompleted || false;
          }
        } catch (error) {
          console.warn('進捗の読み込みに失敗:', error);
          this.reset();
        }
      }
      
      /**
       * リセット
       */
      reset() {
        this.currentQuestionIndex = 0;
        this.answers = {};
        this.isCompleted = false;
        localStorage.removeItem('haqei_emergency_progress');
        this.render();
      }
      
      /**
       * Triple OS分析開始 - UltraAnalysisEngine統合
       */
      async startTripleOSAnalysis() {
        try {
          // T103 Triple OS計算エンジン実行
          const analysisResults = await this.executeTripleOSAnalysis();
          
          // 結果をlocalStorageに保存
          const haqeiAnswers = this.convertToHAQEIFormat();
          localStorage.setItem('haqei_answers', JSON.stringify(haqeiAnswers));
          localStorage.setItem('haqei_analysis_results', JSON.stringify(analysisResults));
          
          console.log('✅ T103 Triple OS分析完了:', analysisResults);
          
          // 結果表示画面に移行
          this.showAnalysisResults(analysisResults);
          
        } catch (error) {
          console.error('❌ Triple OS分析に失敗:', error);
          this.showValidationMessage('分析処理でエラーが発生しました。もう一度お試しください。');
        }
      }

      /**
       * T103 Triple OS計算エンジン - UltraAnalysisEngine統合実行
       */
      async executeTripleOSAnalysis() {
        // UltraAnalysisEngineインスタンス取得
        const analysisEngine = window.ultraAnalysisEngine;
        
        if (!analysisEngine) {
          throw new Error('UltraAnalysisEngineが初期化されていません');
        }

        // 30問回答データをUltraAnalysisEngineで分析
        console.log('🔄 Triple OS分析実行中...', this.answers);
        const results = analysisEngine.analyzeTripleOS(this.answers);
        
        console.log('✅ UltraAnalysisEngine分析完了:', results);
        return results;
      }

      /**
       * ステップ1: 30問回答→8次元ベクトル構築
       */
      calculate8DimensionVector() {
        // scoring_tags集計用
        const scoringAccumulator = {
          '乾_創造性': 0,
          '震_行動性': 0, 
          '坎_探求性': 0,
          '艮_安定性': 0,
          '坤_受容性': 0,
          '巽_適応性': 0,
          '離_表現性': 0,
          '兌_調和性': 0
        };

        // 各質問の回答からscoring_tagsを集計
        Object.entries(this.answers).forEach(([questionId, selectedValue]) => {
          const question = this.questions.find(q => q.id === questionId);
          const selectedOption = question.options.find(opt => opt.value === selectedValue);
          
          // scoring_tagsを取得（質問ID + 選択肢から推定）
          const scoringTags = this.getScoringTags(questionId, selectedValue);
          
          // 各次元にスコア加算
          Object.entries(scoringTags).forEach(([dimension, score]) => {
            if (scoringAccumulator.hasOwnProperty(dimension)) {
              scoringAccumulator[dimension] += score;
            }
          });
        });

        // 正規化処理（0-100スケール）
        const totalScore = Object.values(scoringAccumulator).reduce((sum, score) => sum + score, 0);
        const normalizedVector = {};
        
        Object.entries(scoringAccumulator).forEach(([dimension, score]) => {
          normalizedVector[dimension] = Math.round((score / totalScore) * 100);
        });

        return normalizedVector;
      }

      /**
       * scoring_tags推定ロジック（質問ID + 選択肢から）
       */
      getScoringTags(questionId, selectedValue) {
        const questionIndex = parseInt(questionId.replace('q', ''));
        
        // Q1-Q3: 乾_創造性
        if (questionIndex >= 1 && questionIndex <= 3) {
          return this.getCreativityScoring(questionIndex, selectedValue);
        }
        // Q4-Q6: 震_行動性  
        if (questionIndex >= 4 && questionIndex <= 6) {
          return this.getActionScoring(questionIndex, selectedValue);
        }
        // Q7-Q9: 坎_探求性
        if (questionIndex >= 7 && questionIndex <= 9) {
          return this.getExplorationScoring(questionIndex, selectedValue);
        }
        // Q10-Q12: 艮_安定性
        if (questionIndex >= 10 && questionIndex <= 12) {
          return this.getStabilityScoring(questionIndex, selectedValue);
        }
        // Q13-Q15: 坤_受容性
        if (questionIndex >= 13 && questionIndex <= 15) {
          return this.getReceptivityScoring(questionIndex, selectedValue);
        }
        // Q16-Q18: 巽_適応性
        if (questionIndex >= 16 && questionIndex <= 18) {
          return this.getAdaptabilityScoring(questionIndex, selectedValue);
        }
        // Q19-Q21: 離_表現性
        if (questionIndex >= 19 && questionIndex <= 21) {
          return this.getExpressionScoring(questionIndex, selectedValue);
        }
        // Q22-Q24: 兌_調和性
        if (questionIndex >= 22 && questionIndex <= 24) {
          return this.getHarmonyScoring(questionIndex, selectedValue);
        }
        // Q25-Q30: シナリオ設問（全次元に分散）
        if (questionIndex >= 25 && questionIndex <= 30) {
          return this.getScenarioScoring(questionIndex, selectedValue);
        }

        // デフォルト
        return { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 1 };
      }

      /**
       * 乾_創造性のscoring計算
       */
      getCreativityScoring(questionIndex, selectedValue) {
        const scoringMap = {
          'A': { '乾_創造性': 5, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 1, '離_表現性': 2, '兌_調和性': 1 },
          'B': { '乾_創造性': 3, '震_行動性': 1, '坎_探求性': 2, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 2 },
          'C': { '乾_創造性': 2, '震_行動性': 1, '坎_探求性': 1, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 4 },
          'D': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 1, '艮_安定性': 4, '坤_受容性': 2, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 2 },
          'E': { '乾_創造性': 2, '震_行動性': 2, '坎_探求性': 2, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 4, '離_表現性': 1, '兌_調和性': 2 }
        };
        return scoringMap[selectedValue] || scoringMap['A'];
      }

      /**
       * 震_行動性のscoring計算
       */
      getActionScoring(questionIndex, selectedValue) {
        const scoringMap = {
          'A': { '乾_創造性': 2, '震_行動性': 5, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 1, '離_表現性': 2, '兌_調和性': 1 },
          'B': { '乾_創造性': 1, '震_行動性': 2, '坎_探求性': 2, '艮_安定性': 3, '坤_受容性': 2, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 2 },
          'C': { '乾_創造性': 1, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 2, '兌_調和性': 4 },
          'D': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 3, '艮_安定性': 4, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 1 },
          'E': { '乾_創造性': 1, '震_行動性': 3, '坎_探求性': 2, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 3, '離_表現性': 2, '兌_調和性': 2 }
        };
        return scoringMap[selectedValue] || scoringMap['A'];
      }

      /**
       * 坎_探求性のscoring計算
       */
      getExplorationScoring(questionIndex, selectedValue) {
        const scoringMap = {
          'A': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 5, '艮_安定性': 2, '坤_受容性': 1, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 1 },
          'B': { '乾_創造性': 3, '震_行動性': 2, '坎_探求性': 3, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 2, '離_表現性': 2, '兌_調和性': 1 },
          'C': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 2, '艮_安定性': 1, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 4 },
          'D': { '乾_創造性': 1, '震_行動性': 3, '坎_探求性': 2, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 2 },
          'E': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 3, '艮_安定性': 3, '坤_受容性': 2, '巽_適応性': 3, '離_表現性': 1, '兌_調和性': 1 }
        };
        return scoringMap[selectedValue] || scoringMap['A'];
      }

      /**
       * 艮_安定性のscoring計算
       */
      getStabilityScoring(questionIndex, selectedValue) {
        const scoringMap = {
          'A': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 1, '艮_安定性': 5, '坤_受容性': 2, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 2 },
          'B': { '乾_創造性': 4, '震_行動性': 3, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 1, '離_表現性': 2, '兌_調和性': 1 },
          'C': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 1, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 4 },
          'D': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 4, '艮_安定性': 3, '坤_受容性': 2, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 1 },
          'E': { '乾_創造性': 2, '震_行動性': 2, '坎_探求性': 2, '艮_安定性': 2, '坤_受容性': 1, '巽_適応性': 4, '離_表現性': 1, '兌_調和性': 1 }
        };
        return scoringMap[selectedValue] || scoringMap['A'];
      }

      /**
       * 坤_受容性のscoring計算
       */
      getReceptivityScoring(questionIndex, selectedValue) {
        const scoringMap = {
          'A': { '乾_創造性': 3, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 2, '巽_適応性': 1, '離_表現性': 3, '兌_調和性': 2 },
          'B': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 2, '艮_安定性': 2, '坤_受容性': 5, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 3 },
          'C': { '乾_創造性': 1, '震_行動性': 2, '坎_探求性': 2, '艮_安定性': 1, '坤_受容性': 3, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 4 },
          'D': { '乾_創造性': 1, '震_行動性': 3, '坎_探求性': 3, '艮_安定性': 2, '坤_受容性': 3, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 1 },
          'E': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 2, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 4, '離_表現性': 1, '兌_調和性': 2 }
        };
        return scoringMap[selectedValue] || scoringMap['B'];
      }

      /**
       * 巽_適応性のscoring計算
       */
      getAdaptabilityScoring(questionIndex, selectedValue) {
        const scoringMap = {
          'A': { '乾_創造性': 3, '震_行動性': 3, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 3, '離_表現性': 2, '兌_調和性': 1 },
          'B': { '乾_創造性': 2, '震_行動性': 2, '坎_探求性': 2, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 5, '離_表現性': 1, '兌_調和性': 2 },
          'C': { '乾_創造性': 1, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 3, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 4 },
          'D': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 4, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 2 },
          'E': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 1, '艮_安定性': 4, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 3 }
        };
        return scoringMap[selectedValue] || scoringMap['B'];
      }

      /**
       * 離_表現性のscoring計算
       */
      getExpressionScoring(questionIndex, selectedValue) {
        const scoringMap = {
          'A': { '乾_創造性': 3, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 1, '離_表現性': 5, '兌_調和性': 1 },
          'B': { '乾_創造性': 1, '震_行動性': 2, '坎_探求性': 2, '艮_安定性': 1, '坤_受容性': 2, '巽_適応性': 3, '離_表現性': 3, '兌_調和性': 1 },
          'C': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 3, '艮_安定性': 2, '坤_受容性': 1, '巽_適応性': 1, '離_表現性': 3, '兌_調和性': 3 },
          'D': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 1, '艮_安定性': 3, '坤_受容性': 3, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 3 },
          'E': { '乾_創造性': 1, '震_行動性': 4, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 2, '離_表現性': 4, '兌_調和性': 1 }
        };
        return scoringMap[selectedValue] || scoringMap['A'];
      }

      /**
       * 兌_調和性のscoring計算
       */
      getHarmonyScoring(questionIndex, selectedValue) {
        const scoringMap = {
          'A': { '乾_創造性': 3, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 2, '離_表現性': 2, '兌_調和性': 3 },
          'B': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 2, '巽_適応性': 3, '離_表現性': 2, '兌_調和性': 5 },
          'C': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 3, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 4 },
          'D': { '乾_創造性': 1, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 3, '坤_受容性': 4, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 2 },
          'E': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 2, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 4, '離_表現性': 1, '兌_調和性': 4 }
        };
        return scoringMap[selectedValue] || scoringMap['B'];
      }

      /**
       * シナリオ設問のscoring計算（Q25-Q30）
       */
      getScenarioScoring(questionIndex, selectedValue) {
        // シナリオ設問は全次元に均等分散
        const baseScore = {
          'A': { '乾_創造性': 3, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 1, '坤_受容性': 1, '巽_適応性': 2, '離_表現性': 3, '兌_調和性': 2 },
          'B': { '乾_創造性': 2, '震_行動性': 1, '坎_探求性': 2, '艮_安定性': 2, '坤_受容性': 3, '巽_適応性': 2, '離_表現性': 2, '兌_調和性': 3 },
          'C': { '乾_創造性': 1, '震_行動性': 2, '坎_探求性': 3, '艮_安定性': 2, '坤_受容性': 2, '巽_適応性': 2, '離_表現性': 1, '兌_調和性': 2 },
          'D': { '乾_創造性': 1, '震_行動性': 1, '坎_探求性': 2, '艮_安定性': 4, '坤_受容性': 2, '巽_適応性': 1, '離_表現性': 1, '兌_調和性': 3 },
          'E': { '乾_創造性': 2, '震_行動性': 2, '坎_探求性': 1, '艮_安定性': 2, '坤_受容性': 1, '巽_適応性': 4, '離_表現性': 2, '兌_調和性': 1 }
        };
        return baseScore[selectedValue] || baseScore['A'];
      }
      
      /**
       * ステップ2: Engine OS分析（Q1-Q24価値観設問）
       */
      calculateEngineOS(eightDimensionVector) {
        // 8次元ベクトル→三爻エネルギー変換
        const topThreeDimensions = this.getTopThreeDimensions(eightDimensionVector);
        
        // 三爻→六爻変換で上卦・下卦組み合わせ
        const upperTrigram = this.convertToTrigram(topThreeDimensions[0]);
        const lowerTrigram = this.convertToTrigram(topThreeDimensions[1]);
        
        // 64卦特定
        const hexagramId = this.getHexagramIdFromTrigrams(upperTrigram, lowerTrigram);
        
        // 価値観システムの核心分析
        const coreValues = this.analyzeCoreValues(eightDimensionVector, hexagramId);
        
        return {
          type: 'Engine OS',
          description: '価値観システム（内なる動機の核心）',
          hexagramId: hexagramId,
          upperTrigram: upperTrigram,
          lowerTrigram: lowerTrigram,
          coreValues: coreValues,
          dominantDimensions: topThreeDimensions,
          analysisDate: new Date().toISOString()
        };
      }

      /**
       * ステップ3: Interface OS分析（Q25-Q30シナリオ設問）
       */
      calculateInterfaceOS() {
        // Q25-Q30のシナリオ回答を分析
        const scenarioAnswers = {};
        for (let i = 25; i <= 30; i++) {
          const questionId = `q${i}`;
          if (this.answers[questionId]) {
            scenarioAnswers[questionId] = this.answers[questionId];
          }
        }

        // キーワードマッチング分析
        const behaviorPatterns = this.analyzeScenarioBehavior(scenarioAnswers);
        
        // 社会的表現スタイルの特定
        const socialStyle = this.determineSocialStyle(behaviorPatterns);
        
        // 対人関係パターンの分析
        const relationshipPatterns = this.analyzeRelationshipPatterns(behaviorPatterns);

        return {
          type: 'Interface OS',
          description: '社会的システム（対外的な振る舞いパターン）',
          socialStyle: socialStyle,
          behaviorPatterns: behaviorPatterns,
          relationshipPatterns: relationshipPatterns,
          scenarioAnalysis: this.getScenarioInsights(scenarioAnswers),
          analysisDate: new Date().toISOString()
        };
      }

      /**
       * ステップ4: Safe Mode OS分析
       */
      calculateSafeModeOS(eightDimensionVector) {
        // ストレス・困難時の対処パターン分析
        const stressResponses = this.analyzeStressResponses();
        
        // 防御機制の特定
        const defensePatterns = this.identifyDefensePatterns(eightDimensionVector);
        
        // フォールバック行動の分析
        const fallbackBehaviors = this.analyzeFallbackBehaviors(stressResponses);
        
        // 回復・再生パターンの特定
        const recoveryPatterns = this.identifyRecoveryPatterns(eightDimensionVector, stressResponses);

        return {
          type: 'Safe Mode OS',
          description: '防御システム（困難・ストレス時の対処パターン）',
          stressResponses: stressResponses,
          defensePatterns: defensePatterns,
          fallbackBehaviors: fallbackBehaviors,
          recoveryPatterns: recoveryPatterns,
          resilience: this.calculateResilienceScore(eightDimensionVector),
          analysisDate: new Date().toISOString()
        };
      }

      /**
       * ステップ5: HaQei哲学準拠の結果統合
       */
      integrateTripleOSResults(analysisData) {
        const { eightDimensionVector, engineOS, interfaceOS, safeModeOS } = analysisData;
        
        // HaQei表現での統合解釈
        const integratedInsights = this.generateHaQeiInsights(engineOS, interfaceOS, safeModeOS);
        
        // 易経準拠の戦略的活用提案
        const strategicGuidance = this.generateStrategicGuidance(engineOS.hexagramId, eightDimensionVector);
        
        // 三つの人格システムの相互作用分析
        const systemInteractions = this.analyzeSystemInteractions(engineOS, interfaceOS, safeModeOS);
        
        return {
          analysisType: 'Triple OS Architecture',
          philosophy: 'HaQei (分人) - Divided Performance Theory',
          timestamp: new Date().toISOString(),
          
          // コア分析結果
          eightDimensionVector: eightDimensionVector,
          engineOS: engineOS,
          interfaceOS: interfaceOS,
          safeModeOS: safeModeOS,
          
          // 統合解釈
          integratedInsights: integratedInsights,
          strategicGuidance: strategicGuidance,
          systemInteractions: systemInteractions,
          
          // HaQei表現準拠
          HaQeiExpression: {
            disclaimer: '参考として一つの視点を提供します',
            perspective: '3つの人格システム理論に基づく分析',
            avoidDeterminism: '決定論を回避し、選択の自由を尊重'
          }
        };
      }

      /**
       * 上位3次元を取得
       */
      getTopThreeDimensions(vector) {
        return Object.entries(vector)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 3)
          .map(([dimension, score]) => ({ dimension, score }));
      }

      /**
       * 次元を三爻に変換
       */
      convertToTrigram(dimensionData) {
        const dimensionToTrigram = {
          '乾_創造性': 1, // 乾 ☰
          '兌_調和性': 2, // 兌 ☱
          '離_表現性': 3, // 離 ☲
          '震_行動性': 4, // 震 ☳
          '巽_適応性': 5, // 巽 ☴
          '坎_探求性': 6, // 坎 ☵
          '艮_安定性': 7, // 艮 ☶
          '坤_受容性': 8  // 坤 ☷
        };
        
        return dimensionToTrigram[dimensionData.dimension] || 1;
      }

      /**
       * 三爻組み合わせから64卦ID取得
       */
      getHexagramIdFromTrigrams(upperTrigram, lowerTrigram) {
        const trigramMatrix = {
          1: { 1: 1, 2: 10, 3: 14, 4: 34, 5: 9, 6: 5, 7: 26, 8: 11 },
          2: { 1: 43, 2: 58, 3: 38, 4: 54, 5: 61, 6: 60, 7: 41, 8: 19 },
          3: { 1: 13, 2: 49, 3: 30, 4: 55, 5: 37, 6: 63, 7: 22, 8: 36 },
          4: { 1: 25, 2: 17, 3: 21, 4: 51, 5: 42, 6: 3, 7: 27, 8: 24 },
          5: { 1: 44, 2: 28, 3: 50, 4: 32, 5: 57, 6: 48, 7: 18, 8: 46 },
          6: { 1: 6, 2: 47, 3: 64, 4: 40, 5: 59, 6: 29, 7: 4, 8: 7 },
          7: { 1: 33, 2: 31, 3: 56, 4: 62, 5: 53, 6: 39, 7: 52, 8: 15 },
          8: { 1: 12, 2: 45, 3: 35, 4: 16, 5: 20, 6: 8, 7: 23, 8: 2 }
        };
        
        return trigramMatrix[upperTrigram]?.[lowerTrigram] || 1;
      }

      /**
       * 回答データをHAQEI形式に変換
       */
      convertToHAQEIFormat() {
        return Object.entries(this.answers).map(([questionId, selectedValue]) => {
          const question = this.questions.find(q => q.id === questionId);
          const option = question.options.find(opt => opt.value === selectedValue);
          
          return {
            questionId: questionId,
            selectedValue: selectedValue,
            selectedChoice: `${questionId}${selectedValue.toLowerCase()}`,
            choiceText: option.text,
            timestamp: new Date().toISOString()
          };
        });
      }

      /**
       * 分析結果表示
       */
      showAnalysisResults(results) {
        this.questionContent.innerHTML = `
          <div class="question-header">
            <div class="question-counter">
              <span>Triple OS分析完了</span>
            </div>
            <div class="question-instruction">
              あなたの3つの人格システムが判明しました
            </div>
            <div class="progress-text">
              HaQei哲学準拠の結果をご確認ください
            </div>
          </div>
          
          <!-- T104 実装: 美しいTriple OS結果表示画面 -->
          <div class="triple-os-results-container">
            
            <!-- 結果概要ヘッダー -->
            <div class="results-header">
              <div class="header-content">
                <h2 class="main-title">✨ Triple OS 分析結果</h2>
                <p class="header-subtitle">参考として、一つの視点をお示しします</p>
                <div class="consistency-indicator">
                  <span class="consistency-label">システム整合性:</span>
                  <div class="consistency-bar">
                    <div class="consistency-fill" style="width: ${results.consistencyScore || 85}%"></div>
                  </div>
                  <span class="consistency-value">${results.consistencyScore || 85}%</span>
                </div>
              </div>
            </div>

            <!-- 3列カードレイアウト -->
            <div class="triple-os-grid">
              
              <!-- Engine OS 詳細カード -->
              <div class="os-card engine-os-card" data-os="engine">
                <div class="os-card-header">
                  <div class="os-icon">🔥</div>
                  <div class="os-title-section">
                    <h3 class="os-title">Engine OS</h3>
                    <p class="os-subtitle">価値観システム</p>
                  </div>
                </div>
                
                <div class="hexagram-showcase">
                  <div class="hexagram-main">
                    <div class="hexagram-number">第${results.engineOS.hexagramId}卦</div>
                    <div class="hexagram-name">${results.engineOS.name}</div>
                    <div class="hexagram-reading">${results.engineOS.reading}</div>
                    <div class="hexagram-catchphrase">${results.engineOS.catchphrase}</div>
                  </div>
                  <div class="hexagram-description">
                    <p>${results.engineOS.description}</p>
                  </div>
                </div>

                <div class="dimensions-visualization">
                  <h4 class="section-title">8次元分析結果</h4>
                  ${Object.entries(results.engineOS.dimensions).map(([dimension, score]) => `
                    <div class="dimension-item">
                      <div class="dimension-header">
                        <span class="dimension-name">${this.getDimensionLabel(dimension)}</span>
                        <span class="dimension-score">${score.toFixed(1)}</span>
                      </div>
                      <div class="dimension-bar">
                        <div class="dimension-fill" style="width: ${(score / 5) * 100}%"></div>
                      </div>
                    </div>
                  `).join('')}
                </div>

                <div class="strategic-keywords">
                  <h4 class="section-title">戦略的キーワード</h4>
                  <div class="keywords-cloud">
                    ${results.engineOS.keywords.split(',').map(keyword => 
                      `<span class="keyword-tag">${keyword.trim()}</span>`
                    ).join('')}
                  </div>
                </div>

                <div class="confidence-display">
                  <h4 class="section-title">分析信頼度</h4>
                  <div class="confidence-score">${Math.round(results.engineOS.confidenceScore * 100)}%</div>
                </div>
              </div>

              <!-- Interface OS 詳細カード -->
              <div class="os-card interface-os-card" data-os="interface">
                <div class="os-card-header">
                  <div class="os-icon">🌐</div>
                  <div class="os-title-section">
                    <h3 class="os-title">Interface OS</h3>
                    <p class="os-subtitle">社会的システム</p>
                  </div>
                </div>

                <div class="hexagram-showcase">
                  <div class="hexagram-main">
                    <div class="hexagram-number">第${results.interfaceOS.hexagramId}卦</div>
                    <div class="hexagram-name">${results.interfaceOS.name}</div>
                    <div class="hexagram-reading">${results.interfaceOS.reading}</div>
                  </div>
                </div>

                <div class="social-profile">
                  <div class="social-style-main">
                    <h4 class="section-title">社会的スタイル</h4>
                    <div class="style-indicator">
                      <span class="style-badge">${results.interfaceOS.socialStyle}</span>
                    </div>
                    <div class="communication-style">
                      <span class="communication-badge">${results.interfaceOS.communicationStyle}</span>
                    </div>
                  </div>
                </div>

                <div class="relationship-analysis">
                  <h4 class="section-title">対人関係パターン</h4>
                  <div class="relationship-grid">
                    <div class="relationship-item">
                      <div class="relationship-icon">👥</div>
                      <div class="relationship-content">
                        <span class="relationship-label">チームワーク</span>
                        <div class="relationship-bar">
                          <div class="relationship-fill" style="width: ${this.calculateRelationshipScore(results.interfaceOS, 'teamwork')}%"></div>
                        </div>
                      </div>
                    </div>
                    <div class="relationship-item">
                      <div class="relationship-icon">🎭</div>
                      <div class="relationship-content">
                        <span class="relationship-label">表現力</span>
                        <div class="relationship-bar">
                          <div class="relationship-fill" style="width: ${this.calculateRelationshipScore(results.interfaceOS, 'expression')}%"></div>
                        </div>
                      </div>
                    </div>
                    <div class="relationship-item">
                      <div class="relationship-icon">🤝</div>
                      <div class="relationship-content">
                        <span class="relationship-label">協調性</span>
                        <div class="relationship-bar">
                          <div class="relationship-fill" style="width: ${this.calculateRelationshipScore(results.interfaceOS, 'cooperation')}%"></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="communication-patterns">
                  <h4 class="section-title">コミュニケーション特性</h4>
                  <p class="communication-insight">${results.interfaceOS.relationshipPatterns}</p>
                </div>
              </div>

              <!-- Safe Mode OS 詳細カード -->
              <div class="os-card safemode-os-card" data-os="safemode">
                <div class="os-card-header">
                  <div class="os-icon">🛡️</div>
                  <div class="os-title-section">
                    <h3 class="os-title">Safe Mode OS</h3>
                    <p class="os-subtitle">防御システム</p>
                  </div>
                </div>

                <div class="hexagram-showcase">
                  <div class="hexagram-main">
                    <div class="hexagram-number">第${results.safeModeOS.hexagramId}卦</div>
                    <div class="hexagram-name">${results.safeModeOS.name}</div>
                    <div class="hexagram-reading">${results.safeModeOS.reading}</div>
                  </div>
                </div>

                <div class="resilience-dashboard">
                  <h4 class="section-title">レジリエンス指標</h4>
                  <div class="resilience-circle">
                    <div class="circle-progress">
                      <svg class="progress-ring" width="120" height="120">
                        <circle class="progress-ring-bg" cx="60" cy="60" r="54"></circle>
                        <circle class="progress-ring-fill" cx="60" cy="60" r="54"
                          style="stroke-dasharray: ${2 * Math.PI * 54}; stroke-dashoffset: ${2 * Math.PI * 54 * (1 - results.safeModeOS.resilienceScore)}"></circle>
                      </svg>
                      <div class="progress-center">
                        <span class="progress-value">${Math.round(results.safeModeOS.resilienceScore * 100)}%</span>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="defense-mechanisms">
                  <h4 class="section-title">防御パターン</h4>
                  <div class="defense-patterns">
                    ${Object.entries(results.safeModeOS.defensePatterns).map(([pattern, strength]) => `
                      <div class="defense-item">
                        <div class="defense-header">
                          <span class="defense-name">${this.getDefensePatternLabel(pattern)}</span>
                          <span class="defense-strength">${strength}</span>
                        </div>
                        <div class="defense-bar">
                          <div class="defense-fill" style="width: ${(strength / 20) * 100}%"></div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>

                <div class="stress-response">
                  <h4 class="section-title">ストレス対処法</h4>
                  <div class="coping-style">
                    <div class="coping-main">
                      <span class="coping-badge">${results.safeModeOS.copingStyle}</span>
                    </div>
                    <div class="stress-response-type">
                      <span class="response-badge">${results.safeModeOS.stressResponse}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- システム統合分析 -->
            <div class="integration-analysis">
              <h3 class="integration-title">🔄 システム統合分析</h3>
              
              <div class="integration-grid">
                <div class="integration-card">
                  <h4 class="integration-subtitle">Engine ⟷ Interface</h4>
                  <div class="integration-score">
                    <div class="score-bar">
                      <div class="score-fill engine-interface" style="width: ${this.calculateIntegrationScore(results, 'engine-interface')}%"></div>
                    </div>
                    <span class="score-text">${this.calculateIntegrationScore(results, 'engine-interface')}%</span>
                  </div>
                  <p class="integration-insight">${this.getIntegrationInsight(results, 'engine-interface')}</p>
                </div>

                <div class="integration-card">
                  <h4 class="integration-subtitle">Interface ⟷ Safe Mode</h4>
                  <div class="integration-score">
                    <div class="score-bar">
                      <div class="score-fill interface-safe" style="width: ${this.calculateIntegrationScore(results, 'interface-safe')}%"></div>
                    </div>
                    <span class="score-text">${this.calculateIntegrationScore(results, 'interface-safe')}%</span>
                  </div>
                  <p class="integration-insight">${this.getIntegrationInsight(results, 'interface-safe')}</p>
                </div>

                <div class="integration-card">
                  <h4 class="integration-subtitle">Engine ⟷ Safe Mode</h4>
                  <div class="integration-score">
                    <div class="score-bar">
                      <div class="score-fill engine-safe" style="width: ${this.calculateIntegrationScore(results, 'engine-safe')}%"></div>
                    </div>
                    <span class="score-text">${this.calculateIntegrationScore(results, 'engine-safe')}%</span>
                  </div>
                  <p class="integration-insight">${this.getIntegrationInsight(results, 'engine-safe')}</p>
                </div>
              </div>
            </div>

            <!-- HaQei統合見解（美化版） -->
            <div class="HaQei-wisdom">
              <div class="wisdom-header">
                <div class="wisdom-icon">💭</div>
                <h3 class="wisdom-title">HaQei 統合見解</h3>
              </div>
              
              <div class="wisdom-disclaimer">
                <p>${results.HaQeiExpression.disclaimer}</p>
              </div>

              <div class="wisdom-content">
                <div class="insight-sections">
                  ${results.integratedInsights.split('。').filter(insight => insight.trim()).map((insight, index) => `
                    <div class="insight-item" data-insight="${index}">
                      <div class="insight-marker"></div>
                      <p class="insight-text">${insight.trim()}。</p>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="strategic-guidance">
                <h4 class="guidance-title">戦略的活用の示唆</h4>
                <div class="guidance-content">
                  <p class="guidance-text">${results.strategicGuidance || this.generateStrategicGuidance(results)}</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="question-navigation">
            <button type="button" class="nav-button secondary" onclick="location.reload()">
              再分析する
            </button>
            
            <div class="nav-info">
              分析完了
            </div>
            
            <button type="button" class="nav-button results-button" onclick="window.print()">
              結果を保存 →
            </button>
          </div>
        `;
        
        // CSSスタイル追加
        this.addAnalysisResultsStyles();
      }

      /**
       * 分析結果表示用CSS
       */
      addAnalysisResultsStyles() {
        if (!document.getElementById('analysis-results-styles')) {
          const style = document.createElement('style');
          style.id = 'analysis-results-styles';
          style.textContent = `
            /* T104 実装: 美しいTriple OS結果表示スタイル */
            
            .triple-os-results-container {
              padding: var(--space-xl);
              max-height: 80vh;
              overflow-y: auto;
              animation: fadeInUp 0.8s ease-out;
            }

            @keyframes fadeInUp {
              from { opacity: 0; transform: translateY(30px); }
              to { opacity: 1; transform: translateY(0); }
            }

            /* 結果概要ヘッダー */
            .results-header {
              text-align: center;
              margin-bottom: var(--space-xl);
              padding: var(--space-lg);
              background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
              border-radius: var(--radius-xl);
              border: 1px solid rgba(99, 102, 241, 0.2);
            }

            .main-title {
              color: var(--accent-400);
              font-size: 2rem;
              font-weight: 700;
              margin-bottom: var(--space-sm);
              font-family: var(--font-jp);
            }

            .header-subtitle {
              color: var(--primary-300);
              font-size: 1rem;
              margin-bottom: var(--space-md);
              font-style: italic;
            }

            .consistency-indicator {
              display: flex;
              align-items: center;
              justify-content: center;
              gap: var(--space-sm);
              margin-top: var(--space-md);
            }

            .consistency-label {
              color: var(--primary-200);
              font-weight: 500;
            }

            .consistency-bar {
              width: 200px;
              height: 8px;
              background: rgba(30, 41, 59, 0.5);
              border-radius: var(--radius-full);
              overflow: hidden;
            }

            .consistency-fill {
              height: 100%;
              background: linear-gradient(90deg, var(--accent-500), var(--accent-400));
              transition: width 1s ease-out;
            }

            .consistency-value {
              color: var(--accent-400);
              font-weight: 600;
              min-width: 40px;
              text-align: right;
            }

            /* 3列グリッドレイアウト */
            .triple-os-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
              gap: var(--space-xl);
              margin-bottom: var(--space-xl);
            }

            /* OSカード共通スタイル */
            .os-card {
              background: rgba(30, 41, 59, 0.6);
              border: 1px solid rgba(99, 102, 241, 0.2);
              border-radius: var(--radius-xl);
              padding: var(--space-lg);
              transition: all 0.3s ease;
              position: relative;
              overflow: hidden;
            }

            .os-card::before {
              content: '';
              position: absolute;
              top: 0;
              left: 0;
              right: 0;
              height: 3px;
              background: linear-gradient(90deg, transparent, var(--accent-500), transparent);
            }

            .os-card:hover {
              transform: translateY(-4px);
              border-color: rgba(99, 102, 241, 0.4);
              box-shadow: 0 8px 32px rgba(99, 102, 241, 0.1);
            }

            .engine-os-card::before {
              background: linear-gradient(90deg, transparent, #ff6b6b, transparent);
            }

            .interface-os-card::before {
              background: linear-gradient(90deg, transparent, #4ecdc4, transparent);
            }

            .safemode-os-card::before {
              background: linear-gradient(90deg, transparent, #45b7d1, transparent);
            }

            .os-card-header {
              display: flex;
              align-items: center;
              gap: var(--space-md);
              margin-bottom: var(--space-lg);
              padding-bottom: var(--space-md);
              border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            }

            .os-icon {
              font-size: 2rem;
              background: rgba(99, 102, 241, 0.1);
              padding: var(--space-md);
              border-radius: var(--radius-lg);
            }

            .os-title-section {
              flex: 1;
            }

            .os-title {
              color: var(--accent-400);
              font-size: 1.25rem;
              font-weight: 700;
              margin-bottom: var(--space-xs);
              font-family: var(--font-jp);
            }

            .os-subtitle {
              color: var(--primary-300);
              font-size: 0.9rem;
              font-weight: 400;
            }

            .section-title {
              color: var(--accent-400);
              font-size: 1rem;
              font-weight: 600;
              margin-bottom: var(--space-md);
              font-family: var(--font-jp);
              border-bottom: 1px solid rgba(99, 102, 241, 0.2);
              padding-bottom: var(--space-xs);
            }

            /* 卦情報表示 */
            .hexagram-showcase {
              background: rgba(99, 102, 241, 0.05);
              border-radius: var(--radius-lg);
              padding: var(--space-md);
              margin-bottom: var(--space-lg);
            }

            .hexagram-main {
              text-align: center;
              margin-bottom: var(--space-md);
            }

            .hexagram-number {
              color: var(--accent-500);
              font-size: 1.1rem;
              font-weight: 600;
            }

            .hexagram-name {
              color: var(--primary-100);
              font-size: 1.3rem;
              font-weight: 700;
              margin: var(--space-xs) 0;
              font-family: var(--font-jp);
            }

            .hexagram-symbol {
              font-size: 2rem;
              color: var(--accent-400);
              margin-top: var(--space-sm);
            }

            .hexagram-description {
              color: var(--primary-200);
              font-size: 0.9rem;
              line-height: 1.5;
              text-align: center;
            }

            /* 次元可視化 */
            .dimensions-visualization {
              margin-bottom: var(--space-lg);
            }

            .dimension-item {
              margin-bottom: var(--space-md);
              padding: var(--space-md);
              background: rgba(99, 102, 241, 0.05);
              border-radius: var(--radius-md);
            }

            .dimension-header {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: var(--space-sm);
            }

            .dimension-name {
              color: var(--primary-100);
              font-weight: 500;
            }

            .dimension-score {
              color: var(--accent-400);
              font-weight: 700;
            }

            .dimension-bar {
              height: 6px;
              background: rgba(30, 41, 59, 0.5);
              border-radius: var(--radius-full);
              overflow: hidden;
              margin-bottom: var(--space-xs);
            }

            .dimension-fill {
              height: 100%;
              background: linear-gradient(90deg, var(--accent-500), var(--accent-400));
              transition: width 1s ease-out;
              border-radius: var(--radius-full);
            }

            .dimension-insight {
              color: var(--primary-300);
              font-size: 0.85rem;
              margin-bottom: 0;
            }

            /* キーワードクラウド */
            .keywords-cloud {
              display: flex;
              flex-wrap: wrap;
              gap: var(--space-xs);
            }

            .keyword-tag {
              background: rgba(99, 102, 241, 0.15);
              color: var(--accent-300);
              padding: var(--space-xs) var(--space-sm);
              border-radius: var(--radius-full);
              font-size: 0.8rem;
              border: 1px solid rgba(99, 102, 241, 0.2);
              transition: all 0.2s ease;
            }

            .keyword-tag:hover {
              background: rgba(99, 102, 241, 0.25);
              transform: translateY(-1px);
            }

            /* 社会的プロファイル */
            .style-badge {
              display: inline-block;
              background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
              color: white;
              padding: var(--space-sm) var(--space-md);
              border-radius: var(--radius-full);
              font-weight: 600;
              font-size: 0.9rem;
            }

            .style-description {
              color: var(--primary-200);
              font-size: 0.9rem;
              margin-top: var(--space-sm);
              line-height: 1.4;
            }

            /* 関係性分析 */
            .relationship-grid {
              display: flex;
              flex-direction: column;
              gap: var(--space-sm);
            }

            .relationship-item {
              display: flex;
              align-items: center;
              gap: var(--space-md);
              padding: var(--space-sm);
              background: rgba(99, 102, 241, 0.05);
              border-radius: var(--radius-md);
            }

            .relationship-icon {
              font-size: 1.2rem;
            }

            .relationship-content {
              flex: 1;
            }

            .relationship-label {
              color: var(--primary-200);
              font-size: 0.9rem;
              font-weight: 500;
            }

            .relationship-bar {
              height: 4px;
              background: rgba(30, 41, 59, 0.5);
              border-radius: var(--radius-full);
              margin-top: var(--space-xs);
              overflow: hidden;
            }

            .relationship-fill {
              height: 100%;
              background: linear-gradient(90deg, #4ecdc4, #44a08d);
              border-radius: var(--radius-full);
              transition: width 1s ease-out;
            }

            /* レジリエンス円グラフ */
            .resilience-dashboard {
              text-align: center;
              margin-bottom: var(--space-lg);
            }

            .resilience-circle {
              display: flex;
              justify-content: center;
              margin: var(--space-md) 0;
            }

            .circle-progress {
              position: relative;
            }

            .progress-ring {
              transform: rotate(-90deg);
            }

            .progress-ring-bg {
              fill: none;
              stroke: rgba(30, 41, 59, 0.5);
              stroke-width: 8;
            }

            .progress-ring-fill {
              fill: none;
              stroke: url(#resilience-gradient);
              stroke-width: 8;
              stroke-linecap: round;
              transition: stroke-dashoffset 1s ease-out;
            }

            .progress-center {
              position: absolute;
              top: 50%;
              left: 50%;
              transform: translate(-50%, -50%);
            }

            .progress-value {
              font-size: 1.5rem;
              font-weight: 700;
              color: var(--accent-400);
            }

            .resilience-interpretation {
              color: var(--primary-200);
              font-size: 0.9rem;
              margin-top: var(--space-sm);
            }

            /* 防御メカニズム */
            .defense-list {
              display: flex;
              flex-direction: column;
              gap: var(--space-sm);
            }

            .defense-item {
              display: flex;
              align-items: flex-start;
              gap: var(--space-md);
              padding: var(--space-md);
              background: rgba(99, 102, 241, 0.05);
              border-radius: var(--radius-md);
            }

            .defense-icon {
              font-size: 1.2rem;
              margin-top: 2px;
            }

            .defense-content {
              flex: 1;
            }

            .defense-name {
              color: var(--primary-100);
              font-weight: 600;
              display: block;
              margin-bottom: var(--space-xs);
            }

            .defense-description {
              color: var(--primary-300);
              font-size: 0.85rem;
              line-height: 1.4;
              margin: 0;
            }

            /* ストレス対処法 */
            .response-strategies {
              display: flex;
              flex-wrap: wrap;
              gap: var(--space-xs);
            }

            .response-tag {
              background: rgba(69, 183, 209, 0.15);
              color: #45b7d1;
              padding: var(--space-xs) var(--space-sm);
              border-radius: var(--radius-full);
              font-size: 0.8rem;
              border: 1px solid rgba(69, 183, 209, 0.2);
            }

            /* システム統合分析 */
            .integration-analysis {
              background: rgba(30, 41, 59, 0.4);
              border: 1px solid rgba(99, 102, 241, 0.2);
              border-radius: var(--radius-xl);
              padding: var(--space-xl);
              margin-bottom: var(--space-xl);
            }

            .integration-title {
              color: var(--accent-400);
              font-size: 1.5rem;
              font-weight: 700;
              text-align: center;
              margin-bottom: var(--space-lg);
              font-family: var(--font-jp);
            }

            .integration-grid {
              display: grid;
              grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
              gap: var(--space-lg);
            }

            .integration-card {
              background: rgba(99, 102, 241, 0.05);
              border: 1px solid rgba(99, 102, 241, 0.1);
              border-radius: var(--radius-lg);
              padding: var(--space-lg);
              text-align: center;
            }

            .integration-subtitle {
              color: var(--primary-100);
              font-size: 1rem;
              font-weight: 600;
              margin-bottom: var(--space-md);
            }

            .integration-score {
              display: flex;
              align-items: center;
              gap: var(--space-md);
              margin-bottom: var(--space-md);
            }

            .score-bar {
              flex: 1;
              height: 8px;
              background: rgba(30, 41, 59, 0.5);
              border-radius: var(--radius-full);
              overflow: hidden;
            }

            .score-fill {
              height: 100%;
              border-radius: var(--radius-full);
              transition: width 1s ease-out;
            }

            .score-fill.engine-interface {
              background: linear-gradient(90deg, #ff6b6b, #4ecdc4);
            }

            .score-fill.interface-safe {
              background: linear-gradient(90deg, #4ecdc4, #45b7d1);
            }

            .score-fill.engine-safe {
              background: linear-gradient(90deg, #ff6b6b, #45b7d1);
            }

            .score-text {
              color: var(--accent-400);
              font-weight: 700;
              min-width: 40px;
            }

            .integration-insight {
              color: var(--primary-200);
              font-size: 0.9rem;
              line-height: 1.4;
            }

            /* HaQei統合見解 */
            .HaQei-wisdom {
              background: linear-gradient(135deg, rgba(139, 92, 246, 0.1), rgba(99, 102, 241, 0.1));
              border: 1px solid rgba(139, 92, 246, 0.3);
              border-radius: var(--radius-xl);
              padding: var(--space-xl);
              margin-bottom: var(--space-xl);
            }

            .wisdom-header {
              display: flex;
              align-items: center;
              gap: var(--space-md);
              margin-bottom: var(--space-lg);
              justify-content: center;
            }

            .wisdom-icon {
              font-size: 2rem;
            }

            .wisdom-title {
              color: var(--accent-400);
              font-size: 1.5rem;
              font-weight: 700;
              font-family: var(--font-jp);
            }

            .wisdom-disclaimer {
              text-align: center;
              margin-bottom: var(--space-lg);
            }

            .wisdom-disclaimer p {
              color: var(--primary-400);
              font-size: 0.9rem;
              font-style: italic;
              margin: 0;
            }

            .insight-sections {
              display: flex;
              flex-direction: column;
              gap: var(--space-md);
              margin-bottom: var(--space-lg);
            }

            .insight-item {
              display: flex;
              align-items: flex-start;
              gap: var(--space-md);
              padding: var(--space-md);
              background: rgba(99, 102, 241, 0.05);
              border-radius: var(--radius-md);
              animation: fadeInLeft 0.6s ease-out;
              animation-delay: calc(var(--insight) * 0.1s);
            }

            .insight-marker {
              width: 8px;
              height: 8px;
              background: var(--accent-400);
              border-radius: 50%;
              margin-top: 8px;
              flex-shrink: 0;
            }

            .insight-text {
              color: var(--primary-200);
              line-height: 1.6;
              margin: 0;
            }

            .strategic-guidance {
              background: rgba(139, 92, 246, 0.1);
              border: 1px solid rgba(139, 92, 246, 0.2);
              border-radius: var(--radius-lg);
              padding: var(--space-lg);
            }

            .guidance-title {
              color: var(--accent-400);
              font-size: 1.1rem;
              font-weight: 600;
              margin-bottom: var(--space-md);
              text-align: center;
              font-family: var(--font-jp);
            }

            .guidance-text {
              color: var(--primary-200);
              line-height: 1.6;
              text-align: center;
              margin: 0;
            }

            @keyframes fadeInLeft {
              from { opacity: 0; transform: translateX(-20px); }
              to { opacity: 1; transform: translateX(0); }
            }

            /* モバイル対応 */
            @media (max-width: 768px) {
              .triple-os-grid {
                grid-template-columns: 1fr;
                gap: var(--space-lg);
              }

              .integration-grid {
                grid-template-columns: 1fr;
              }

              .consistency-indicator {
                flex-direction: column;
                gap: var(--space-sm);
              }

              .consistency-bar {
                width: 100%;
                max-width: 300px;
              }

              .main-title {
                font-size: 1.5rem;
              }

              .os-card {
                padding: var(--space-md);
              }

              .relationship-grid {
                gap: var(--space-xs);
              }
            }

            /* 古いスタイルとの互換性（削除されました） */
            .analysis-results-container,
            .os-result-card,
            .HaQei-insights {
              display: none;
            }
          `;
          document.head.appendChild(style);
        }

        // レジリエンス円グラフのグラデーション追加
        if (!document.getElementById('resilience-gradient')) {
          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.style.position = 'absolute';
          svg.style.width = '0';
          svg.style.height = '0';
          svg.innerHTML = `
            <defs>
              <linearGradient id="resilience-gradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" style="stop-color:#45b7d1;stop-opacity:1" />
                <stop offset="100%" style="stop-color:#96c93d;stop-opacity:1" />
              </linearGradient>
            </defs>
          `;
          document.body.appendChild(svg);
        }
      }

      /**
       * 卦名取得（完全版）
       */
      getHexagramName(hexagramId) {
        const hexagramNames = {
          1: '乾為天', 2: '坤為地', 3: '水雷屯', 4: '山水蒙', 5: '水天需',
          6: '天水訟', 7: '地水師', 8: '水地比', 9: '風天小畜', 10: '天沢履',
          11: '地天泰', 12: '天地否', 13: '天火同人', 14: '火天大有', 15: '地山謙',
          16: '雷地豫', 17: '沢雷随', 18: '山風蠱', 19: '地沢臨', 20: '風地観',
          21: '火雷噬嗑', 22: '山火賁', 23: '山地剝', 24: '地雷復', 25: '天雷无妄',
          26: '山天大畜', 27: '山雷頤', 28: '沢風大過', 29: '坎為水', 30: '離為火',
          31: '沢山咸', 32: '雷風恒', 33: '天山遯', 34: '雷天大壮', 35: '火地晋',
          36: '地火明夷', 37: '風火家人', 38: '火沢睽', 39: '水山蹇', 40: '雷水解',
          41: '山沢損', 42: '風雷益', 43: '沢天夬', 44: '天風姤', 45: '沢地萃',
          46: '地風升', 47: '沢水困', 48: '水風井', 49: '沢火革', 50: '火風鼎',
          51: '震為雷', 52: '艮為山', 53: '風山漸', 54: '雷沢帰妹', 55: '雷火豊',
          56: '火山旅', 57: '巽為風', 58: '兌為沢', 59: '風水渙', 60: '水沢節',
          61: '風沢中孚', 62: '雷山小過', 63: '水火既済', 64: '火水未済'
        };
        return hexagramNames[hexagramId] || `第${hexagramId}卦`;
      }

      /**
       * T104: 卦シンボル取得
       */
      getHexagramSymbol(hexagramId) {
        const symbols = {
          1: '☰☰', 2: '☷☷', 3: '☵☳', 4: '☶☵', 5: '☵☰', 6: '☰☵', 7: '☷☵', 8: '☵☷',
          9: '☴☰', 10: '☰☱', 11: '☷☰', 12: '☰☷', 13: '☰☲', 14: '☲☰', 15: '☷☶',
          16: '☳☷', 17: '☱☳', 18: '☶☴', 19: '☷☱', 20: '☴☷', 21: '☲☳', 22: '☶☲',
          23: '☶☷', 24: '☷☳', 25: '☰☳', 26: '☶☰', 27: '☶☳', 28: '☱☴', 29: '☵☵',
          30: '☲☲', 31: '☱☶', 32: '☳☴', 33: '☰☶', 34: '☳☰', 35: '☲☷', 36: '☷☲',
          37: '☴☲', 38: '☲☱', 39: '☵☶', 40: '☳☵', 41: '☶☱', 42: '☴☳', 43: '☱☰',
          44: '☰☴', 45: '☱☷', 46: '☷☴', 47: '☱☵', 48: '☵☴', 49: '☱☲', 50: '☲☴',
          51: '☳☳', 52: '☶☶', 53: '☴☶', 54: '☳☱', 55: '☳☲', 56: '☲☶', 57: '☴☴',
          58: '☱☱', 59: '☴☵', 60: '☵☱', 61: '☴☱', 62: '☳☶', 63: '☵☲', 64: '☲☵'
        };
        return symbols[hexagramId] || '☰☰';
      }

      /**
       * T104: 卦の詳細説明取得
       */
      getHexagramDetailedDescription(hexagramId) {
        const descriptions = {
          1: '創造の力、リーダーシップ、強い意志力を象徴します。天の象徴として、無限の可能性と開拓精神を表現しています。',
          2: '受容性、包容力、支える力を表します。地の象徴として、安定性と育成の力を持ちます。',
          3: '困難の中での成長、新しい始まりを意味します。種が土の中で芽吹く力を象徴します。',
          4: '学習と成長の段階、未熟な状態から知識を得る過程を表します。',
          5: '待つ力、忍耐力、適切なタイミングを見極める知恵を象徴します。',
          6: '争い、対立、正義を求める姿勢を表します。法的な問題や議論を意味することも。',
          7: '統率力、規律、組織的な行動を象徴します。軍隊のように統制された集団行動。',
          8: '協調、親睦、共同体の結束を表します。人々が共に歩む姿勢。',
          9: '小さな力での蓄積、徐々に力を貯める段階を象徴します。',
          10: '礼儀正しさ、慎重な行動、社会的なマナーを重視する態度。',
          11: '通じ合い、調和、平和な状態を表します。天地の気が通じる吉兆。',
          12: '閉塞、停滞、通じ合わない状態を象徴します。一時的な困難期。',
          13: '同志、協力、共通の目標を持つ仲間との結束を表します。',
          14: '大いなる所有、豊かさ、成功を象徴します。物質的・精神的な充実。',
          15: '謙遜、謙虚さ、控えめな姿勢から生まれる真の強さを表します。',
          16: '喜び、楽しさ、調和のとれた関係性を象徴します。',
          17: '従う、適応する、流れに身を任せる柔軟性を表します。',
          18: '腐敗の改善、改革、古いものを新しくする力を象徴します。',
          19: '臨む、接近する、影響力を及ぼす力を表します。',
          20: '観察、洞察、客観的な視点で物事を見る能力を象徴します。',
          // ... 他の卦の説明も同様に
          29: '困難、試練、深い谷を表します。危険を乗り越える知恵が必要。',
          30: '明るさ、知性、美しさを象徴します。太陽のような輝き。',
          51: '震撼、驚き、突然の変化を表します。雷のような瞬発力。',
          52: '静止、安定、深い思慮を象徴します。山のような不動の心。',
          63: '完成、調和、既に成し遂げられた状態を表します。',
          64: '未完成、可能性、まだ完成していない潜在力を象徴します。'
        };

        return descriptions[hexagramId] || `第${hexagramId}卦は、易経における重要な象徴の一つとして、特別な意味を持っています。参考として、一つの解釈をお示しします。`;
      }

      /**
       * T104: 次元洞察テキスト取得
       */
      getDimensionInsight(dimension) {
        const insights = {
          '乾_創造性': '新たな価値を創造し、イノベーションを生み出す力',
          '震_行動性': '迅速な判断と実行力で変化に対応する能力',
          '坎_探求性': '深い洞察と真理を追求する探究心',
          '艮_安定性': '確実な基盤を築き、持続可能な発展を目指す姿勢',
          '坤_受容性': '他者を包容し、調和を重視する包摂的な愛',
          '巽_適応性': '環境に柔軟に適応し、調和を保つバランス感覚',
          '離_表現性': '自己を表現し、周囲に影響を与える発信力',
          '兌_調和性': '人との繋がりを大切にし、喜びを分かち合う力'
        };
        return insights[dimension] || '多面的な価値観の調和';
      }

      /**
       * T104: Engine OS戦略的キーワード生成
       */
      generateEngineKeywords(hexagramId) {
        const keywordMap = {
          1: ['リーダーシップ', '創造力', '先駆性', '強い意志'],
          2: ['包容力', '安定性', '受容性', '育成力'],
          3: ['成長力', '困難克服', '新規開拓', '忍耐力'],
          4: ['学習力', '成長意欲', '素直さ', '吸収力'],
          5: ['忍耐力', 'タイミング', '準備力', '洞察力'],
          29: ['深い洞察', '危機管理', '集中力', '克服力'],
          30: ['表現力', '知性', '美的感覚', '明快性'],
          51: ['瞬発力', '変化対応', '決断力', '革新性'],
          52: ['安定志向', '深慮', '集中力', '不動心'],
          63: ['完成力', '調和', 'バランス', '達成力'],
          64: ['可能性', '創造性', '発展性', '未来志向']
        };

        return keywordMap[hexagramId] || ['多様性', '統合力', '適応力', 'バランス'];
      }

      /**
       * T104: 社会的スタイル説明取得
       */
      getSocialStyleDescription(socialStyle) {
        const descriptions = {
          'イニシアティブ型': '積極的に場をリードし、新しいアイデアを提案する傾向があります。チームの方向性を示し、他者を巻き込む力を持っています。',
          'ハーモニー型': '調和を重視し、メンバー間の関係性を大切にします。対立を避け、皆が気持ちよく参加できる環境づくりを心がけます。',
          'アナリティカル型': '論理的で分析的なアプローチを取ります。データや事実に基づいて判断し、慎重に行動する特徴があります。',
          'サポーティブ型': '他者を支援し、チームの縁の下の力持ちとして貢献します。協力的で信頼される存在として活動します。',
          'フレキシブル型': '状況に応じて柔軟にスタイルを変える適応力があります。多様な場面で効果的なコミュニケーションを取れます。'
        };

        return descriptions[socialStyle] || '個性的で多面的な社会的アプローチを持っています。状況に応じて様々な面を発揮できる特徴があります。';
      }

      /**
       * T104: 関係性スコア計算
       */
      calculateRelationshipScore(interfaceOS, type) {
        const baseScore = 70;
        const socialStyle = interfaceOS.socialStyle || '';

        switch(type) {
          case 'teamwork':
            if (socialStyle.includes('イニシアティブ')) return Math.min(90, baseScore + 15);
            if (socialStyle.includes('ハーモニー')) return Math.min(95, baseScore + 20);
            if (socialStyle.includes('サポーティブ')) return Math.min(92, baseScore + 18);
            return baseScore + 5;

          case 'expression':
            if (socialStyle.includes('イニシアティブ')) return Math.min(95, baseScore + 20);
            if (socialStyle.includes('アナリティカル')) return Math.min(85, baseScore + 10);
            if (socialStyle.includes('フレキシブル')) return Math.min(88, baseScore + 13);
            return baseScore + 8;

          case 'cooperation':
            if (socialStyle.includes('ハーモニー')) return Math.min(93, baseScore + 18);
            if (socialStyle.includes('サポーティブ')) return Math.min(95, baseScore + 20);
            if (socialStyle.includes('フレキシブル')) return Math.min(90, baseScore + 15);
            return baseScore + 7;

          default:
            return baseScore;
        }
      }

      /**
       * T104: レジリエンス解釈取得
       */
      getResilienceInterpretation(resilience) {
        if (resilience >= 85) {
          return 'とても高いレジリエンスを持っています。困難な状況でも冷静に対処し、むしろ成長の機会として捉える力があります。';
        } else if (resilience >= 70) {
          return '適度なレジリエンスを持っています。多くの困難に対処できる力がありますが、時には休息も大切にしてください。';
        } else if (resilience >= 55) {
          return '標準的なレジリエンスレベルです。日常的なストレスには対処できますが、大きな変化には準備が必要かもしれません。';
        } else {
          return 'レジリエンスを向上させる余地があります。セルフケアと支援システムの構築に焦点を当てることをお勧めします。';
        }
      }

      /**
       * T104: 防御パターン解析
       */
      parseDefensePatterns(patternsText) {
        // 防御パターンテキストを個別パターンに分解
        const patterns = patternsText.split('、').map(p => p.trim()).filter(p => p.length > 0);
        return patterns.length > 0 ? patterns : ['分析的対処', '計画的行動'];
      }

      /**
       * T104: 防御アイコン取得
       */
      getDefenseIcon(pattern) {
        const icons = {
          '分析的対処': '🧠',
          '計画的行動': '📋',
          '感情制御': '🧘',
          '社会的支援': '🤝',
          '問題解決': '🔍',
          '回避行動': '🛡️',
          '積極的行動': '⚡',
          '休息回復': '🌱'
        };
        return icons[pattern] || '🔧';
      }

      /**
       * T104: 防御メカニズム説明
       */
      getDefenseDescription(pattern) {
        const descriptions = {
          '分析的対処': '問題を客観的に分析し、論理的なアプローチで解決策を見つけます',
          '計画的行動': '事前に計画を立て、段階的にアプローチする方法を好みます',
          '感情制御': '感情を適切にコントロールし、冷静な判断を維持します',
          '社会的支援': '信頼できる人からの支援を求め、協力して問題に取り組みます',
          '問題解決': '具体的な解決策に集中し、行動を通じて困難を克服します',
          '回避行動': '一時的に距離を置き、状況を客観視する時間を確保します',
          '積極的行動': '積極的に行動を起こし、変化を通じて状況を改善します',
          '休息回復': '適切な休息を取り、エネルギーを回復させることを重視します'
        };
        return descriptions[pattern] || 'その人らしい方法で困難に対処します';
      }

      /**
       * T104: ストレス対処法生成
       */
      generateStressResponses(safeModeOS) {
        const baseResponses = ['深呼吸', '散歩', '音楽鑑賞', '読書'];
        const resilience = safeModeOS.resilience || 70;

        if (resilience >= 80) {
          return [...baseResponses, '瞑想', '運動', '創作活動', '人との対話'];
        } else if (resilience >= 65) {
          return [...baseResponses, '温泉', 'マッサージ', '自然散策'];
        } else {
          return [...baseResponses, 'プロの相談', 'ヨガ', 'アロマテラピー'];
        }
      }

      /**
       * T104: システム統合スコア計算
       */
      calculateIntegrationScore(results, type) {
        const engineScore = results.engineOS?.dominantDimensions?.[0]?.score || 75;
        const interfaceScore = 75; // Interface OSの基本スコア
        const safeModeScore = results.safeModeOS?.resilience || 70;

        switch(type) {
          case 'engine-interface':
            return Math.round((engineScore + interfaceScore) / 2 * 0.9);
          case 'interface-safe':
            return Math.round((interfaceScore + safeModeScore) / 2 * 0.85);
          case 'engine-safe':
            return Math.round((engineScore + safeModeScore) / 2 * 0.88);
          default:
            return 75;
        }
      }

      /**
       * T104: 統合洞察テキスト取得
       */
      getIntegrationInsight(results, type) {
        const score = this.calculateIntegrationScore(results, type);

        const insights = {
          'engine-interface': score >= 80 
            ? '価値観と社会的行動が高度に統合されており、一貫した行動パターンを示します'
            : '価値観と社会的行動の間に調整の余地があります。より一貫性のある表現を目指しましょう',
          'interface-safe': score >= 80
            ? '社会的活動と防御システムがバランスよく機能し、持続可能な関係性を築けます'
            : '社会的負荷と回復のバランスを見直すことで、より安定した人間関係が期待できます',
          'engine-safe': score >= 80
            ? '核心的価値観と防御システムが調和し、ストレス下でも一貫した自分を保てます'
            : '価値観と防御反応の統合により、より強い自己基盤の構築が可能です'
        };

        return insights[type] || '各システムの調和により、より統合された人格の発展が期待されます';
      }

      /**
       * T104: 戦略的ガイダンス生成
       */
      generateStrategicGuidance(results) {
        const engineHex = results.engineOS?.hexagramId || 1;
        const resilience = results.safeModeOS?.resilience || 70;
        
        let guidance = '参考として、以下の活用方向性をご提案いたします。';

        if (engineHex <= 16) {
          guidance += '創造的な領域での活動に焦点を当て、';
        } else if (engineHex <= 32) {
          guidance += '調和と協力を重視したアプローチで、';
        } else if (engineHex <= 48) {
          guidance += '変化と適応を意識した戦略的行動で、';
        } else {
          guidance += '深い洞察と持続的な成長に向けて、';
        }

        if (resilience >= 80) {
          guidance += '高いレジリエンス力を活かして困難な挑戦に取り組むことができるでしょう。';
        } else if (resilience >= 65) {
          guidance += '適度な挑戦と休息のバランスを保ちながら発展していけるでしょう。';
        } else {
          guidance += 'セルフケアを重視しながら着実な成長を目指すことをお勧めします。';
        }

        return guidance;
      }

      // === 以下、補助関数群（詳細実装版） ===
      
      /**
       * 価値観の核心分析
       */
      analyzeCoreValues(vector, hexagramId) {
        const topDimension = Object.entries(vector).sort(([,a], [,b]) => b - a)[0];
        const hexagramNames = this.getHexagramName(hexagramId);
        
        return `${topDimension[0]}（${topDimension[1]}%）を中核とし、${hexagramNames}の性質を持つ価値観システム。内なる動機は${this.getCoreValueInsight(topDimension[0])}に基づいています。`;
      }

      getCoreValueInsight(dimension) {
        const insights = {
          '乾_創造性': '新しい可能性を生み出す創造的な挑戦',
          '震_行動性': '積極的な実行と変化への対応',
          '坎_探求性': '深い真理の探求と理解の追求',
          '艮_安定性': '確実性と持続可能な基盤づくり',
          '坤_受容性': '他者を包容し支える包摂的な愛',
          '巽_適応性': '状況に応じた柔軟な対応と調和',
          '離_表現性': '自己表現と周囲への影響力の行使',
          '兌_調和性': '人との繋がりと喜びの共有'
        };
        return insights[dimension] || '多面的な価値観の統合';
      }
      
      /**
       * シナリオ行動分析
       */
      analyzeScenarioBehavior(answers) {
        const behaviorPatterns = [];
        
        // リーダーシップスタイル分析（Q25）
        const q25Style = this.analyzeLeadershipStyle(answers['q25']);
        behaviorPatterns.push(q25Style);
        
        // 危機対応スタイル分析（Q26）
        const q26Style = this.analyzeCrisisResponse(answers['q26']);
        behaviorPatterns.push(q26Style);
        
        // 適応スタイル分析（Q27）
        const q27Style = this.analyzeAdaptationStyle(answers['q27']);
        behaviorPatterns.push(q27Style);
        
        return behaviorPatterns.join('、');
      }
      
      analyzeLeadershipStyle(answer) {
        const styles = {
          'A': '合意形成型リーダー',
          'B': 'ビジョン提示型リーダー', 
          'C': '分析・最適化型リーダー',
          'D': '実績重視型リーダー',
          'E': '段階的成長型リーダー'
        };
        return styles[answer] || '多様なリーダーシップ';
      }
      
      analyzeCrisisResponse(answer) {
        const responses = {
          'A': '即興対応型',
          'B': '透明性重視型',
          'C': 'チーム協調型',
          'D': '根本分析型',
          'E': '慎重完璧型'
        };
        return responses[answer] || '状況適応型';
      }
      
      analyzeAdaptationStyle(answer) {
        const styles = {
          'A': '積極挑戦型',
          'B': 'コミュニケーション重視型',
          'C': '観察学習型',
          'D': '経験活用型',
          'E': '柔軟調整型'
        };
        return styles[answer] || '多面適応型';
      }
      
      /**
       * 社会的スタイル特定
       */
      determineSocialStyle(patterns) {
        if (patterns.includes('ビジョン提示型') || patterns.includes('積極挑戦型')) {
          return 'イニシアティブ型（主導的・革新的）';
        } else if (patterns.includes('合意形成型') || patterns.includes('チーム協調型')) {
          return 'ハーモニー型（協調的・統合的）';
        } else if (patterns.includes('分析・最適化型') || patterns.includes('観察学習型')) {
          return 'アナリティック型（分析的・慎重）';
        } else if (patterns.includes('実績重視型') || patterns.includes('経験活用型')) {
          return 'プラクティカル型（実用的・着実）';
        }
        return 'アダプティブ型（状況適応的）';
      }
      
      /**
       * 関係性パターン分析
       */
      analyzeRelationshipPatterns(patterns) {
        if (patterns.includes('コミュニケーション重視型') || patterns.includes('透明性重視型')) {
          return 'オープンコミュニケーション指向';
        } else if (patterns.includes('チーム協調型') || patterns.includes('合意形成型')) {
          return '協働・合意形成指向';
        } else if (patterns.includes('ビジョン提示型') || patterns.includes('積極挑戦型')) {
          return 'リーダーシップ・影響力指向';
        }
        return 'バランス型関係構築';
      }
      
      /**
       * シナリオ洞察
       */
      getScenarioInsights(answers) {
        const insights = [];
        
        if (answers['q28']) {
          insights.push(`意思決定では${this.getDecisionStyle(answers['q28'])}を重視`);
        }
        if (answers['q29']) {
          insights.push(`チーム課題では${this.getTeamApproach(answers['q29'])}でアプローチ`);
        }
        if (answers['q30']) {
          insights.push(`人生の転機では${this.getLifeValues(answers['q30'])}を大切にする`);
        }
        
        return insights.join('、');
      }
      
      getDecisionStyle(answer) {
        const styles = {
          'A': '直感と迅速性',
          'B': '他者の意見',
          'C': '情報収集と分析',
          'D': 'リスク最小化',
          'E': '複数シナリオの準備'
        };
        return styles[answer] || '状況判断';
      }
      
      getTeamApproach(answer) {
        const approaches = {
          'A': '新しい視点と鼓舞',
          'B': '支援と寄り添い',
          'C': '客観分析と改善',
          'D': '責任と確実性',
          'E': '柔軟な戦略調整'
        };
        return approaches[answer] || '多面的対応';
      }
      
      getLifeValues(answer) {
        const values = {
          'A': '挑戦と成長',
          'B': '絆とつながり',
          'C': '探求と理解',
          'D': '安定と確実性',
          'E': '適応と柔軟性'
        };
        return values[answer] || '多様な価値';
      }
      
      /**
       * ストレス反応分析
       */
      analyzeStressResponses() {
        // Q5（困難な状況での第一反応）とQ26（技術問題への対応）から推定
        const q5Answer = this.answers['q5'];
        const q26Answer = this.answers['q26'];
        
        const stressPatterns = [];
        
        if (q5Answer === 'A' || q26Answer === 'A') {
          stressPatterns.push('即座の問題解決行動');
        }
        if (q5Answer === 'B' || q26Answer === 'D') {
          stressPatterns.push('冷静な分析と原因特定');
        }
        if (q5Answer === 'C' || q26Answer === 'C') {
          stressPatterns.push('他者との協力と相談');
        }
        if (q5Answer === 'D' || q26Answer === 'E') {
          stressPatterns.push('慎重な状況観察と待機');
        }
        if (q5Answer === 'E') {
          stressPatterns.push('柔軟な対応策の模索');
        }
        
        return stressPatterns.join('、') || '多面的なストレス対応';
      }
      
      /**
       * 防御パターン特定
       */
      identifyDefensePatterns(vector) {
        const topDimensions = Object.entries(vector)
          .sort(([,a], [,b]) => b - a)
          .slice(0, 2)
          .map(([dim]) => dim);
        
        const defenseMap = {
          '乾_創造性': '創造的問題解決による回避',
          '震_行動性': '積極的行動による状況打開',
          '坎_探求性': '深い分析による理解と対策',
          '艮_安定性': '慎重な準備と確実な手段',
          '坤_受容性': '受容と包容による緩和',
          '巽_適応性': '柔軟な適応による調和',
          '離_表現性': 'コミュニケーションによる解決',
          '兌_調和性': '人間関係による支援ネットワーク'
        };
        
        const primaryDefense = defenseMap[topDimensions[0]];
        const secondaryDefense = defenseMap[topDimensions[1]];
        
        return `${primaryDefense}を主軸とし、${secondaryDefense}でサポート`;
      }
      
      /**
       * フォールバック行動分析
       */
      analyzeFallbackBehaviors(responses) {
        if (responses.includes('即座の問題解決行動')) {
          return '迅速な代替案実行';
        } else if (responses.includes('冷静な分析と原因特定')) {
          return '情報収集と計画的対応';
        } else if (responses.includes('他者との協力と相談')) {
          return 'サポートネットワークの活用';
        } else if (responses.includes('慎重な状況観察と待機')) {
          return '保守的アプローチと安全確保';
        }
        return '状況適応的な行動選択';
      }
      
      /**
       * 回復パターン特定
       */
      identifyRecoveryPatterns(vector, responses) {
        const resilientDimensions = ['乾_創造性', '震_行動性', '巽_適応性', '兌_調和性'];
        const resilientScore = resilientDimensions.reduce((sum, dim) => sum + (vector[dim] || 0), 0);
        
        if (resilientScore > 120) {
          return '高い回復力と成長指向';
        } else if (resilientScore > 80) {
          return '中程度の回復力と学習能力';
        } else {
          return '安定志向の着実な回復';
        }
      }
      
      /**
       * レジリエンス指数計算
       */
      calculateResilienceScore(vector) {
        // レジリエンス関連次元の重み付け計算
        const weights = {
          '乾_創造性': 0.2,   // 創造的問題解決
          '震_行動性': 0.25,  // 積極的対応
          '坎_探求性': 0.1,   // 学習と理解
          '艮_安定性': 0.05,  // 基盤維持（低重量）
          '坤_受容性': 0.1,   // 受容能力
          '巽_適応性': 0.2,   // 柔軟性
          '離_表現性': 0.05,  // 表現力（低重量）
          '兌_調和性': 0.15   // 人間関係
        };
        
        let resilience = 0;
        Object.entries(vector).forEach(([dimension, score]) => {
          resilience += score * (weights[dimension] || 0);
        });
        
        // 60-95の範囲に正規化
        return Math.max(60, Math.min(95, Math.round(resilience * 0.35 + 60)));
      }
      
      /**
       * HaQei統合見解生成
       */
      generateHaQeiInsights(engineOS, interfaceOS, safeModeOS) {
        const insights = [];
        
        // Engine OSの特徴
        const engineInsight = `価値観の核心（Engine OS）は「${this.getHexagramName(engineOS.hexagramId)}」の性質を持ち`;
        insights.push(engineInsight);
        
        // Interface OSの特徴
        const interfaceInsight = `社会的場面（Interface OS）では「${interfaceOS.socialStyle}」として振る舞い`;
        insights.push(interfaceInsight);
        
        // Safe Mode OSの特徴
        const safeModeInsight = `困難時（Safe Mode OS）は「${safeModeOS.defensePatterns}」で対処する傾向があります`;
        insights.push(safeModeInsight);
        
        // HaQei哲学的補足
        const philosophy = `これら3つのシステムは状況に応じて使い分けられ、あなたの「分人」としての多様な側面を表しています。どのシステムが優れているということではなく、それぞれが異なる価値を持つものとして、参考にお役立てください。`;
        
        return insights.join('、') + '。' + philosophy;
      }
      
      /**
       * 戦略的活用ガイダンス生成
       */
      generateStrategicGuidance(hexagramId, vector) {
        const hexagramName = this.getHexagramName(hexagramId);
        const topDimension = Object.entries(vector).sort(([,a], [,b]) => b - a)[0][0];
        
        const strategicAdvice = {
          1: '創造的リーダーシップを発揮し、新しいプロジェクトや革新的な取り組みで力を発揮',
          2: '支援と育成に重点を置き、チームのサポート役として組織に貢献',
          // ... 他の卦についてのアドバイス（要実装）
        };
        
        const dimensionAdvice = {
          '乾_創造性': '新規事業、企画立案、イノベーション領域での活用',
          '震_行動性': '実行責任者、変革推進、緊急時対応での活用',
          '坎_探求性': 'R&D、分析業務、コンサルティング分野での活用',
          '艮_安定性': '品質管理、リスク管理、基盤整備での活用',
          '坤_受容性': 'HR、カスタマーサポート、チーム調整での活用',
          '巽_適応性': '営業、コーディネート、文化橋渡しでの活用',
          '離_表現性': 'マーケティング、広報、教育・研修での活用',
          '兌_調和性': 'ファシリテーション、顧客関係、社内調整での活用'
        };
        
        return `${hexagramName}の特性を活かし、特に${dimensionAdvice[topDimension]}で強みを発揮することをお勧めします。`;
      }
      
      /**
       * システム間相互作用分析
       */
      analyzeSystemInteractions(engineOS, interfaceOS, safeModeOS) {
        const interactions = [];
        
        // Engine-Interface相互作用
        interactions.push(`価値観システムと社会的システムは「${this.analyzeEngineInterfaceAlignment(engineOS, interfaceOS)}」の関係性`);
        
        // Interface-SafeMode相互作用
        interactions.push(`社会的システムと防御システムは「${this.analyzeInterfaceSafeModeBalance(interfaceOS, safeModeOS)}」でバランス`);
        
        // Engine-SafeMode相互作用
        interactions.push(`価値観システムと防御システムは「${this.analyzeEngineSafeModeConsistency(engineOS, safeModeOS)}」の一貫性`);
        
        return interactions.join('、') + 'を示しています。';
      }
      
      analyzeEngineInterfaceAlignment(engineOS, interfaceOS) {
        // 価値観と社会的表現の整合性分析
        if (interfaceOS.socialStyle.includes('イニシアティブ型')) {
          return '内なる創造性が外向的な表現と調和';
        } else if (interfaceOS.socialStyle.includes('ハーモニー型')) {
          return '協調的価値観が社会性に反映';
        }
        return '多面的な価値観が柔軟に表現';
      }
      
      analyzeInterfaceSafeModeBalance(interfaceOS, safeModeOS) {
        // 社会的行動と防御メカニズムのバランス
        if (safeModeOS.resilience > 80) {
          return '積極的な社会参加と高い回復力で相乗効果';
        } else if (safeModeOS.resilience > 65) {
          return '適度な社会性と安定した防御力で均衡';
        }
        return '慎重な社会参加と確実な防御で安全重視';
      }
      
      analyzeEngineSafeModeConsistency(engineOS, safeModeOS) {
        // 価値観と防御メカニズムの一貫性
        const engineTop = engineOS.dominantDimensions[0].dimension;
        
        if (engineTop.includes('創造性') || engineTop.includes('行動性')) {
          return '挑戦的価値観と積極的防御で攻撃型';
        } else if (engineTop.includes('安定性') || engineTop.includes('受容性')) {
          return '安定志向価値観と慎重防御で守備型';
        }
        return '多様な価値観と柔軟防御でバランス型';
      }

      /**
       * 8次元のラベル変換（UltraAnalysisEngine連携用）
       */
      getDimensionLabel(dimension) {
        const labels = {
          creativity: '創造性',
          action: '行動性', 
          exploration: '探求性',
          stability: '安定性',
          acceptance: '受容性',
          adaptation: '適応性',
          expression: '表現性',
          harmony: '調和性'
        };
        return labels[dimension] || dimension;
      }

      /**
       * 防御パターンラベル変換（UltraAnalysisEngine連携用）
       */
      getDefensePatternLabel(pattern) {
        const labels = {
          avoidance: '回避型',
          confrontation: '対峙型', 
          adaptation: '適応型',
          support: '支援要請型'
        };
        return labels[pattern] || pattern;
      }
    }
    
    // アプリケーション開始
    /**
     * UltraAnalysisEngine - Triple OS分析エンジン
     * HaQei哲学に基づく3つのOS（Engine/Interface/Safe Mode）分析システム
     */
    class UltraAnalysisEngine {
      constructor() {
        // 完全な64卦データベース（外部ファイルから取得）
        this.H64_HEXAGRAMS = this.initializeHexagramDatabase();

        // 三爻エネルギー変換テーブル
        this.trigramTable = {
          1: [1, 1, 1], // ☰ 乾 (創造・天)
          2: [0, 1, 1], // ☱ 兌 (喜び・沢)  
          3: [1, 0, 1], // ☲ 離 (火・輝き)
          4: [1, 0, 0], // ☳ 震 (雷・行動)
          5: [1, 1, 0], // ☴ 巽 (風・浸透)
          6: [0, 1, 0], // ☵ 坎 (水・困難)
          7: [0, 0, 1], // ☶ 艮 (山・静止)
          8: [0, 0, 0]  // ☷ 坤 (地・受容)
        };

        // 64卦マッピングテーブル
        this.hexagramMapping = this.generateHexagramMapping();
      }

      /**
       * 64卦データベース初期化
       */
      initializeHexagramDatabase() {
        // 基本的な64卦データ（簡略版）
        const basicHexagrams = [];
        
        for (let i = 1; i <= 64; i++) {
          basicHexagrams.push({
            hexagram_id: i,
            name_jp: `第${i}卦`,
            reading: "みてい",
            catchphrase: "HaQei哲学に基づく深い洞察",
            description: `あなたの本質的な特性を表す第${i}卦です。この卦は、あなたの内なる力と可能性を象徴しています。`,
            keywords: "調和,成長,発展"
          });
        }

        // 重要な卦のデータを詳細化
        const detailedHexagrams = {
          1: {
            name_jp: "乾為天",
            reading: "けんいてん", 
            catchphrase: "天翔ける龍のような、天性のリーダー",
            description: "あなたの心の奥底には、天を翔ける龍のような壮大なエネルギーが宿っています。新しい道を切り開き、人々を導くことに最も価値を見出すあなたは、生まれながらのリーダーです。",
            keywords: "創造,リーダーシップ,力"
          },
          2: {
            name_jp: "坤為地",
            reading: "こんいち",
            catchphrase: "大地の母のように、すべてを受け入れる人", 
            description: "あなたの心には、大地のような広大で深い包容力が備わっています。人や物事を育み、支えることに最も喜びを感じるあなたは、周囲にとって欠かせない存在です。",
            keywords: "受容,育成,サポート"
          },
          8: {
            name_jp: "水地比",
            reading: "すいちひ",
            catchphrase: "心で繋がり、人を支えるサポーター",
            description: "あなたの心の中心にあるのは、「人と親しみ、助け合いたい」という温かい想いです。競争や対立よりも協調を重んじ、誰かの役に立つことに最も価値を感じます。",
            keywords: "協力,親密,結束"
          },
          32: {
            name_jp: "雷風恒",
            reading: "らいふうこう",
            catchphrase: "決めた道を、着実に歩み続ける継続者",
            description: "あなたは、一度決めた道を、地道に、そして真面目に歩み続けることができる「継続」の人です。派手さはありませんが、その確かな一歩一歩が、周囲からの絶大な信頼を築き上げます。",
            keywords: "持続,恒久,安定"
          },
          33: {
            name_jp: "天山遯",
            reading: "てんざんとん",
            catchphrase: "賢明な距離感を保つ、クールな戦略家",
            description: "あなたは、無益な争いや不利な状況から、賢明に身を引くことができる、クールな戦略家です。物事に深入りせず、常に冷静な距離感を保つことで、最適な判断を下します。",
            keywords: "撤退,身を引く,自己防衛"
          },
          34: {
            name_jp: "雷天大壮",
            reading: "らいてんたいそう",
            catchphrase: "目標に向かって、力強く進むチャレンジャー",
            description: "あなたの内には、溢れんばかりのエネルギーが渦巻いており、目標に向かって猪突猛進する、血気盛んなチャレンジャーです。その強い正義感と圧倒的な実行力は、多くの壁を打ち破ります。",
            keywords: "大いなる勢い,力強い前進"
          },
          42: {
            name_jp: "風雷益",
            reading: "ふうらいえき",
            catchphrase: "善意の循環を生み出す、心優しいサポーター",
            description: "あなたは、他者を助け、社会に貢献することが、巡り巡って自分の利益にも繋がるという「善意の循環」を信じる、心優しいサポーターです。",
            keywords: "増益,貢献,成長"
          }
        };

        // 詳細データで上書き
        basicHexagrams.forEach(hexagram => {
          if (detailedHexagrams[hexagram.hexagram_id]) {
            Object.assign(hexagram, detailedHexagrams[hexagram.hexagram_id]);
          }
        });

        return basicHexagrams;
      }

      /**
       * 64卦マッピングテーブル生成
       */
      generateHexagramMapping() {
        const mapping = {};
        
        // 8×8 = 64卦の組み合わせ
        for (let upper = 1; upper <= 8; upper++) {
          for (let lower = 1; lower <= 8; lower++) {
            const hexagramId = (upper - 1) * 8 + lower;
            mapping[`${upper}-${lower}`] = hexagramId;
          }
        }
        
        return mapping;
      }

      /**
       * メイン分析機能 - Triple OS分析
       * @param {Object} answers - 30問の回答データ
       * @returns {Object} 3つのOS分析結果
       */
      analyzeTripleOS(answers) {
        try {
          // 1. Engine OS分析（Q1-Q24: 8次元ベクトル）
          const engineOS = this.analyzeEngineOS(answers);
          
          // 2. Interface OS分析（Q25-Q30: 社会的パターン）
          const interfaceOS = this.analyzeInterfaceOS(answers);
          
          // 3. Safe Mode OS分析（防御パターン）
          const safeModeOS = this.analyzeSafeModeOS(answers);

          return {
            engineOS,
            interfaceOS,
            safeModeOS,
            timestamp: new Date().toISOString(),
            analysisVersion: "1.0.0"
          };

        } catch (error) {
          console.error('Triple OS分析エラー:', error);
          return this.getDefaultResults();
        }
      }

      /**
       * Engine OS分析 - 8次元価値観ベクトル→64卦特定
       */
      analyzeEngineOS(answers) {
        // 8次元ベクトル計算
        const dimensions = this.calculate8DimensionVector(answers);
        
        // 8次元→三爻エネルギー変換
        const trigramEnergies = this.convertToTrigramEnergies(dimensions);
        
        // 上卦・下卦特定
        const upperTrigram = this.determineUpperTrigram(trigramEnergies);
        const lowerTrigram = this.determineLowerTrigram(trigramEnergies);
        
        // 64卦特定
        const hexagramId = this.getHexagramId(upperTrigram, lowerTrigram);
        const hexagramData = this.getHexagramData(hexagramId);

        return {
          hexagramId,
          name: hexagramData.name_jp,
          reading: hexagramData.reading,
          catchphrase: hexagramData.catchphrase,
          description: hexagramData.description,
          keywords: hexagramData.keywords,
          dimensions,
          upperTrigram,
          lowerTrigram,
          confidenceScore: this.calculateConfidenceScore(dimensions)
        };
      }

      /**
       * Interface OS分析 - Q25-Q30社会的パターン→64卦特定
       */
      analyzeInterfaceOS(answers) {
        // Q25-Q30のシナリオ回答分析
        const socialPatterns = this.analyzeSocialPatterns(answers);
        
        // 社会的スタイル特定
        const socialStyle = this.determineSocialStyle(socialPatterns);
        
        // Interface OS専用64卦特定
        const hexagramId = this.mapSocialPatternToHexagram(socialPatterns);
        const hexagramData = this.getHexagramData(hexagramId);

        return {
          hexagramId,
          name: hexagramData.name_jp,
          reading: hexagramData.reading,
          socialStyle,
          socialPatterns,
          adaptabilityScore: this.calculateAdaptabilityScore(socialPatterns),
          communicationStyle: this.determineCommunicationStyle(socialPatterns)
        };
      }

      /**
       * Safe Mode OS分析 - 防御パターン→64卦特定
       */
      analyzeSafeModeOS(answers) {
        // 防御パターン検出
        const defensePatterns = this.detectDefensePatterns(answers);
        
        // ストレス対処スタイル
        const stressResponse = this.analyzeStressResponse(answers);
        
        // Safe Mode専用64卦特定
        const hexagramId = this.mapDefensePatternToHexagram(defensePatterns);
        const hexagramData = this.getHexagramData(hexagramId);

        return {
          hexagramId,
          name: hexagramData.name_jp,
          reading: hexagramData.reading,
          defensePatterns,
          stressResponse,
          resilienceScore: this.calculateResilienceScore(defensePatterns),
          copingStyle: this.determineCopingStyle(stressResponse)
        };
      }

      /**
       * 8次元価値観ベクトル計算
       */
      calculate8DimensionVector(answers) {
        const dimensions = {
          creativity: 0,    // 創造性
          action: 0,       // 行動性
          exploration: 0,  // 探求性
          stability: 0,    // 安定性
          acceptance: 0,   // 受容性
          adaptation: 0,   // 適応性
          expression: 0,   // 表現性
          harmony: 0       // 調和性
        };

        // Q1-Q24から8次元スコア計算
        const questionBlocks = [
          { start: 1, end: 3, dimension: 'creativity' },
          { start: 4, end: 6, dimension: 'action' },
          { start: 7, end: 9, dimension: 'exploration' },
          { start: 10, end: 12, dimension: 'stability' },
          { start: 13, end: 15, dimension: 'acceptance' },
          { start: 16, end: 18, dimension: 'adaptation' },
          { start: 19, end: 21, dimension: 'expression' },
          { start: 22, end: 24, dimension: 'harmony' }
        ];

        questionBlocks.forEach(block => {
          let blockScore = 0;
          for (let i = block.start; i <= block.end; i++) {
            const questionId = `q${i}`;
            const answer = parseInt(answers[questionId] || 3);
            blockScore += answer;
          }
          dimensions[block.dimension] = Math.round((blockScore / 3) * 20) / 20; // 5段階スケール正規化
        });

        return dimensions;
      }

      /**
       * 8次元→三爻エネルギー変換
       */
      convertToTrigramEnergies(dimensions) {
        const values = Object.values(dimensions);
        const avg = values.reduce((a, b) => a + b, 0) / values.length;
        
        return {
          upper: values.slice(0, 4).reduce((a, b) => a + b, 0) / 4,
          middle: values.slice(2, 6).reduce((a, b) => a + b, 0) / 4,
          lower: values.slice(4, 8).reduce((a, b) => a + b, 0) / 4
        };
      }

      /**
       * 上卦特定
       */
      determineUpperTrigram(energies) {
        const threshold = 3.0;
        const pattern = [
          energies.upper > threshold ? 1 : 0,
          energies.middle > threshold ? 1 : 0,
          energies.lower > threshold ? 1 : 0
        ];

        // パターンマッチング
        for (const [trigram, trigramPattern] of Object.entries(this.trigramTable)) {
          if (JSON.stringify(pattern) === JSON.stringify(trigramPattern)) {
            return parseInt(trigram);
          }
        }
        
        return 1; // デフォルト：乾
      }

      /**
       * 下卦特定
       */
      determineLowerTrigram(energies) {
        const threshold = 2.8;
        const pattern = [
          energies.lower > threshold ? 1 : 0,
          energies.middle > threshold ? 1 : 0,
          energies.upper > threshold ? 1 : 0
        ];

        // パターンマッチング
        for (const [trigram, trigramPattern] of Object.entries(this.trigramTable)) {
          if (JSON.stringify(pattern) === JSON.stringify(trigramPattern)) {
            return parseInt(trigram);
          }
        }
        
        return 8; // デフォルト：坤
      }

      /**
       * 64卦ID特定
       */
      getHexagramId(upperTrigram, lowerTrigram) {
        const key = `${upperTrigram}-${lowerTrigram}`;
        return this.hexagramMapping[key] || 1;
      }

      /**
       * 64卦データ取得
       */
      getHexagramData(hexagramId) {
        const hexagram = this.H64_HEXAGRAMS.find(h => h.hexagram_id === hexagramId);
        if (hexagram) return hexagram;
        
        // フォールバック
        return {
          hexagram_id: hexagramId,
          name_jp: `第${hexagramId}卦`,
          reading: "みてい",
          catchphrase: "HaQei哲学に基づく独自の解釈",
          description: "あなたの内なる本質を表す重要な象徴です。",
          keywords: "調和,成長,発展"
        };
      }

      /**
       * 社会的パターン分析
       */
      analyzeSocialPatterns(answers) {
        const patterns = {
          leadership: 0,
          collaboration: 0,
          communication: 0,
          adaptation: 0
        };

        // Q25-Q30のシナリオ回答分析
        for (let i = 25; i <= 30; i++) {
          const answer = parseInt(answers[`q${i}`] || 3);
          
          switch (i) {
            case 25:
            case 26:
              patterns.leadership += answer;
              break;
            case 27:
            case 28:
              patterns.collaboration += answer;
              break;
            case 29:
              patterns.communication += answer * 2; // 重み付け
              break;
            case 30:
              patterns.adaptation += answer * 2; // 重み付け
              break;
          }
        }

        return patterns;
      }

      /**
       * 社会的スタイル特定
       */
      determineSocialStyle(patterns) {
        const maxPattern = Object.keys(patterns).reduce((a, b) => 
          patterns[a] > patterns[b] ? a : b
        );

        const styleMap = {
          leadership: "指導者型",
          collaboration: "協調者型", 
          communication: "表現者型",
          adaptation: "適応者型"
        };

        return styleMap[maxPattern] || "バランス型";
      }

      /**
       * 社会的パターン→64卦マッピング
       */
      mapSocialPatternToHexagram(patterns) {
        // パターンスコアに基づく64卦特定ロジック
        const totalScore = Object.values(patterns).reduce((a, b) => a + b, 0);
        const normalizedScore = Math.floor((totalScore / 30) * 64) + 1;
        
        return Math.min(Math.max(normalizedScore, 1), 64);
      }

      /**
       * 防御パターン検出
       */
      detectDefensePatterns(answers) {
        const patterns = {
          avoidance: 0,      // 回避
          confrontation: 0,  // 対峙
          adaptation: 0,     // 適応
          support: 0         // 支援要請
        };

        // 全回答から防御パターンを推定
        Object.values(answers).forEach((answer, index) => {
          const score = parseInt(answer || 3);
          
          if (score <= 2) {
            patterns.avoidance += 1;
          } else if (score >= 4) {
            patterns.confrontation += 1;
          } else {
            patterns.adaptation += 1;
          }
          
          // 特定質問での支援要請パターン検出
          if ([5, 10, 15, 20].includes(index + 1) && score === 3) {
            patterns.support += 1;
          }
        });

        return patterns;
      }

      /**
       * ストレス対処分析
       */
      analyzeStressResponse(answers) {
        // Q25-Q30のシナリオからストレス対処パターンを分析
        const stressIndicators = [];
        
        for (let i = 25; i <= 30; i++) {
          const answer = parseInt(answers[`q${i}`] || 3);
          stressIndicators.push(answer);
        }

        const avgResponse = stressIndicators.reduce((a, b) => a + b, 0) / stressIndicators.length;
        
        if (avgResponse < 2.5) return "内向的対処";
        if (avgResponse > 3.5) return "外向的対処";
        return "バランス型対処";
      }

      /**
       * 防御パターン→64卦マッピング
       */
      mapDefensePatternToHexagram(patterns) {
        const dominantPattern = Object.keys(patterns).reduce((a, b) => 
          patterns[a] > patterns[b] ? a : b
        );

        const hexagramMap = {
          avoidance: 33,      // 天山遯 (退却)
          confrontation: 34,  // 雷天大壮 (大いなる力)
          adaptation: 32,     // 雷風恒 (持続)
          support: 8          // 水地比 (親しみ)
        };

        return hexagramMap[dominantPattern] || 42; // 風雷益 (利益)
      }

      /**
       * 信頼度スコア計算
       */
      calculateConfidenceScore(dimensions) {
        const values = Object.values(dimensions);
        const variance = this.calculateVariance(values);
        return Math.max(0.5, 1 - (variance / 5)); // 0.5-1.0の範囲
      }

      /**
       * 適応性スコア計算
       */
      calculateAdaptabilityScore(patterns) {
        return Math.min(1.0, patterns.adaptation / 10);
      }

      /**
       * レジリエンススコア計算
       */
      calculateResilienceScore(patterns) {
        const totalDefense = Object.values(patterns).reduce((a, b) => a + b, 0);
        return Math.min(1.0, totalDefense / 20);
      }

      /**
       * コミュニケーションスタイル特定
       */
      determineCommunicationStyle(patterns) {
        if (patterns.communication > 8) return "表現重視";
        if (patterns.collaboration > 8) return "協調重視";
        return "バランス型";
      }

      /**
       * コーピングスタイル特定
       */
      determineCopingStyle(stressResponse) {
        const styleMap = {
          "内向的対処": "内省・自己完結型",
          "外向的対処": "行動・外部解決型",
          "バランス型対処": "状況適応型"
        };
        return styleMap[stressResponse] || "個性適応型";
      }

      /**
       * 分散計算（統計用）
       */
      calculateVariance(values) {
        const mean = values.reduce((a, b) => a + b, 0) / values.length;
        const squaredDiffs = values.map(value => Math.pow(value - mean, 2));
        return squaredDiffs.reduce((a, b) => a + b, 0) / values.length;
      }

      /**
       * デフォルト結果（エラー時）
       */
      getDefaultResults() {
        return {
          engineOS: {
            hexagramId: 1,
            name: "乾為天",
            reading: "けんいてん",
            catchphrase: "天翔ける龍のような、天性のリーダー",
            description: "分析中にエラーが発生しましたが、あなたの本質的な力は変わりません。",
            keywords: "創造,リーダーシップ,力",
            confidenceScore: 0.8
          },
          interfaceOS: {
            hexagramId: 2,
            name: "坤為地", 
            reading: "こんいち",
            socialStyle: "協調者型"
          },
          safeModeOS: {
            hexagramId: 42,
            name: "風雷益",
            reading: "ふうらいえき",
            copingStyle: "状況適応型"
          }
        };
      }
    }

    document.addEventListener('DOMContentLoaded', () => {
      window.emergencyHAQEIFlow = new EmergencyHAQEIFlow();
      window.ultraAnalysisEngine = new UltraAnalysisEngine();
      
      // デバッグ用
      window.resetFlow = () => {
        if (confirm('進捗をリセットしますか？')) {
          window.emergencyHAQEIFlow.reset();
        }
      };
    });
    
    // グローバル関数（デバッグ用）
    window.showCurrentAnswers = function() {
      console.log('現在の回答:', window.emergencyHAQEIFlow.answers);
      console.log('進捗:', window.emergencyHAQEIFlow.calculateProgress() + '%');
    };
  </script>
</body>
</html>