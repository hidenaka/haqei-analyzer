<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta
      name="description"
      content="HaQei Analyzer - å¤ä»£ã®å¡æ™ºã¨ç¾ä»£ã®ãƒ†ã‚¯ãƒãƒ­ã‚¸ãƒ¼ãŒèåˆã—ãŸã€æ·±ã„è‡ªå·±æ´å¯Ÿä½“é¨“"
    />
    
    <!-- Security Headers -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data:; connect-src 'self' https://api.haqei.com;">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="SAMEORIGIN">
    
    <!-- CSRF Protection Meta Tag - will be populated by CSRFProtection.js -->
    <meta name="csrf-token" content="" id="csrf-meta-token">
    <title>HaQei Analyzer - æ·±ã„è‡ªå·±æ´å¯Ÿã¸ã®å…¥ã‚Šå£</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap"
      rel="stylesheet"
      integrity="sha384-2LfpDLvAHm4a9RYruJICmRn+ef67nc2WnlOOMbE2SzvQWkbVx2MysR9fXUVlojfI"
      crossorigin="anonymous"
    />

    <!-- Critical CSS for Welcome Screen - First Paint Optimization -->
    <style>
      /* Critical CSS for Welcome Screen - bunenjin philosophy first view */
      
      /* CSS Variables - Essential only */
      :root {
        --primary-900: #0f172a;
        --primary-800: #1e293b;
        --primary-700: #334155;
        --primary-600: #475569;
        --primary-500: #64748b;
        --primary-400: #94a3b8;
        --primary-300: #cbd5e1;
        --primary-200: #e2e8f0;
        --primary-100: #f1f5f9;
        --primary-50: #f8fafc;
        --accent-500: #6366f1;
        --accent-400: #8b5cf6;
        --font-family: "Inter", -apple-system, BlinkMacSystemFont, sans-serif;
        --font-jp: "Shippori Mincho", serif;
        --space-xs: clamp(0.5rem, 2vw, 0.75rem);
        --space-sm: clamp(0.75rem, 3vw, 1rem);
        --space-md: clamp(1rem, 4vw, 1.5rem);
        --space-lg: clamp(1.5rem, 5vw, 2rem);
        --space-xl: clamp(2rem, 6vw, 3rem);
        --space-2xl: clamp(3rem, 8vw, 4rem);
        --font-sm: clamp(0.875rem, 2.5vw, 1rem);
        --font-base: clamp(1rem, 3vw, 1.125rem);
        --font-lg: clamp(1.25rem, 4vw, 1.5rem);
        --font-xl: clamp(1.5rem, 5vw, 2rem);
        --font-2xl: clamp(2rem, 6vw, 3rem);
        --font-3xl: clamp(2.5rem, 8vw, 4rem);
        --radius-md: clamp(0.5rem, 2vw, 1rem);
        --radius-lg: clamp(1rem, 3vw, 1.5rem);
        --radius-xl: clamp(1.5rem, 4vw, 2rem);
        --transition-normal: 300ms ease;
        --tap-size: max(44px, 2.75rem);
        --safe-area-top: max(env(safe-area-inset-top), 0px);
      }
      
      /* Reset - Essential only */
      *, *::before, *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      
      html {
        line-height: 1.15;
        -webkit-text-size-adjust: 100%;
        scroll-behavior: smooth;
      }
      
      body {
        font-family: var(--font-family);
        background: linear-gradient(135deg, var(--primary-800) 0%, var(--primary-700) 35%, var(--primary-600) 70%, rgba(99, 102, 241, 0.1) 100%);
        background-attachment: fixed;
        color: var(--primary-100);
        min-height: 100vh;
        line-height: 1.6;
        overflow-x: hidden;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }
      
      /* App Container */
      .app-container {
        min-height: 100vh;
        position: relative;
      }
      
      .screen-container {
        position: absolute;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        display: none;
        align-items: flex-start;
        justify-content: center;
        padding: var(--space-md);
        box-sizing: border-box;
        overflow-y: auto;
      }
      
      .screen-container.visible {
        display: flex !important;
        z-index: 100;
      }
      
      /* Welcome Screen Layout */
      #welcome-container {
        flex-direction: column;
        justify-content: flex-start;
        align-items: center;
        text-align: center;
        padding-top: calc(var(--space-md) + var(--safe-area-top));
        padding-bottom: var(--space-md);
        min-height: calc(100vh - var(--space-md) * 2);
        max-width: 1200px;
        margin: 0 auto;
      }
      
      .welcome-content {
        text-align: center;
        max-width: 600px;
        margin: 0 auto;
        padding: var(--space-lg);
      }
      
      .welcome-header {
        margin-bottom: var(--space-xl);
      }
      
      .welcome-title {
        font-size: var(--font-3xl);
        font-weight: 700;
        color: var(--accent-400);
        margin-bottom: var(--space-md);
        background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }
      
      .welcome-subtitle {
        font-size: var(--font-lg);
        color: var(--primary-200);
        margin-bottom: 0;
        font-family: var(--font-jp);
      }
      
      .welcome-description {
        margin: var(--space-xl) 0;
        color: var(--primary-300);
        line-height: 1.8;
        font-size: var(--font-base);
      }
      
      .welcome-actions {
        margin-top: var(--space-2xl);
      }
      
      /* Button Component - Critical */
      .btn {
        display: inline-block;
        padding: var(--space-sm) var(--space-lg);
        background: linear-gradient(135deg, var(--accent-500), var(--accent-400));
        color: white;
        text-decoration: none;
        border: none;
        border-radius: var(--radius-md);
        font-size: var(--font-base);
        font-weight: 600;
        cursor: pointer;
        transition: all var(--transition-normal);
        box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
        position: relative;
        overflow: hidden;
        min-height: var(--tap-size);
        -webkit-tap-highlight-color: transparent;
      }
      
      .btn-lg {
        padding: var(--space-md) var(--space-xl);
        font-size: var(--font-lg);
        min-height: calc(var(--tap-size) + 8px);
      }
      
      .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
      }
      
      .btn:active {
        transform: translateY(0) scale(0.98);
      }
      
      /* Triple OS Cards - Critical */
      .triple-os-intro {
        margin: var(--space-xl) 0;
        padding: var(--space-xl);
        background: rgba(15, 23, 42, 0.8);
        border-radius: var(--radius-xl);
        border: 1px solid rgba(99, 102, 241, 0.2);
        backdrop-filter: blur(10px);
      }
      
      .triple-os-intro h3 {
        color: var(--primary-100);
        font-size: var(--font-xl);
        font-weight: 600;
        margin-bottom: var(--space-md);
        text-align: center;
      }
      
      .triple-os-intro > p {
        color: var(--primary-300);
        text-align: center;
        margin-bottom: var(--space-xl);
        font-size: var(--font-base);
        line-height: 1.6;
      }
      
      .os-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: var(--space-lg);
        margin-bottom: var(--space-xl);
      }
      
      .os-card {
        background: rgba(30, 41, 59, 0.8);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        text-align: center;
        transition: all var(--transition-normal);
        border: 1px solid transparent;
      }
      
      .os-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
      }
      
      .os-card.engine-os {
        border-color: rgba(99, 102, 241, 0.3);
      }
      
      .os-card.engine-os:hover {
        background: rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.5);
      }
      
      .os-card.interface-os {
        border-color: rgba(168, 85, 247, 0.3);
      }
      
      .os-card.interface-os:hover {
        background: rgba(168, 85, 247, 0.1);
        border-color: rgba(168, 85, 247, 0.5);
      }
      
      .os-card.safemode-os {
        border-color: rgba(251, 146, 60, 0.3);
      }
      
      .os-card.safemode-os:hover {
        background: rgba(251, 146, 60, 0.1);
        border-color: rgba(251, 146, 60, 0.5);
      }
      
      .os-card .os-icon {
        font-size: 2.5rem;
        margin-bottom: var(--space-md);
        display: block;
      }
      
      .os-card h4 {
        color: var(--primary-100);
        font-size: var(--font-lg);
        font-weight: 600;
        margin-bottom: var(--space-sm);
      }
      
      .os-card p {
        color: var(--primary-400);
        font-size: var(--font-sm);
        line-height: 1.4;
        margin-bottom: var(--space-sm);
      }
      
      .os-card .os-detail {
        color: var(--primary-300);
        font-size: 0.75rem;
        line-height: 1.5;
        margin-top: var(--space-sm);
      }
      
      /* Insight Promise */
      .insight-promise .main-promise {
        font-size: var(--font-lg);
        color: var(--accent-400);
        margin-bottom: var(--space-md);
      }
      
      .promise-list {
        text-align: left;
        max-width: 500px;
        margin: 0 auto;
        padding-left: var(--space-lg);
      }
      
      .promise-list li {
        margin-bottom: var(--space-sm);
        color: var(--primary-200);
      }
      
      .time-info {
        text-align: center;
        font-size: var(--font-base);
        color: var(--accent-400);
        margin-top: var(--space-lg);
      }
      
      .start-note {
        margin-top: var(--space-md);
        font-size: var(--font-sm);
        color: var(--primary-400);
      }
      
      /* SafeMode Emphasis */
      .safemode-emphasis {
        background: linear-gradient(135deg, rgba(251, 146, 60, 0.1), rgba(239, 68, 68, 0.1));
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        border: 1px solid rgba(251, 146, 60, 0.3);
      }
      
      .emphasis-text {
        color: #fde68a;
        font-size: var(--font-sm);
        line-height: 1.6;
        margin: 0;
        display: flex;
        align-items: flex-start;
        gap: var(--space-md);
      }
      
      .emphasis-icon {
        font-size: 1.25rem;
        flex-shrink: 0;
      }
      
      /* Skip Link for Accessibility */
      .skip-link {
        position: absolute;
        top: -40px;
        left: 6px;
        background: var(--accent-500);
        color: white;
        padding: 8px;
        z-index: 1000;
        text-decoration: none;
        border-radius: 4px;
      }
      
      .skip-link:focus {
        top: 6px;
      }
      
      /* Screen Reader Only */
      .sr-only {
        position: absolute;
        width: 1px;
        height: 1px;
        padding: 0;
        margin: -1px;
        overflow: hidden;
        clip: rect(0, 0, 0, 0);
        white-space: nowrap;
        border: 0;
      }
      
      /* Basic Responsive */
      @media (max-width: 768px) {
        .screen-container {
          padding: var(--space-sm);
        }
        
        .os-cards {
          grid-template-columns: 1fr;
          gap: var(--space-md);
        }
      }
      
      @media (max-width: 480px) {
        .screen-container {
          padding: var(--space-xs);
        }
        
        .triple-os-intro {
          padding: var(--space-lg);
        }
        
        .os-card {
          padding: var(--space-md);
        }
      }
      
      /* Reduced Motion */
      @media (prefers-reduced-motion: reduce) {
        *, *::before, *::after {
          animation-duration: 0.01ms !important;
          animation-iteration-count: 1 !important;
          transition-duration: 0.01ms !important;
        }
      }
      
      /* Print */
      @media print {
        body {
          background: white !important;
          color: black !important;
        }
      }
    </style>

    <!-- HAQEIã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼çµ±åˆCSSã‚·ã‚¹ãƒ†ãƒ  - bunenjinå“²å­¦ã«ã‚ˆã‚‹7ãƒ•ã‚¡ã‚¤ãƒ«ä½“åˆ¶ -->
    <!-- 1. åŸºç›¤ã‚·ã‚¹ãƒ†ãƒ ï¼šãƒªã‚»ãƒƒãƒˆãƒ»å¤‰æ•°ãƒ»ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåŸºç›¤ -->
    <link rel="stylesheet" href="/css/core.css" media="print" onload="this.media='all'" />
    
    <!-- 2. UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼šãƒœã‚¿ãƒ³ãƒ»ã‚«ãƒ¼ãƒ‰ãƒ»ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  -->
    <link rel="stylesheet" href="/css/components.css" media="print" onload="this.media='all'" />
    
    <!-- 3. ç”»é¢ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šã‚¦ã‚§ãƒ«ã‚«ãƒ ãƒ»è¨­å•ãƒ»çµæœç”»é¢é…ç½® -->
    <link rel="stylesheet" href="/css/layouts.css" media="print" onload="this.media='all'" />
    
    <!-- 4. å¯¾è©±è¦ç´ ï¼šã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»ãƒˆãƒ©ãƒ³ã‚¸ã‚·ãƒ§ãƒ³ãƒ»ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ -->
    <link rel="stylesheet" href="/css/interactive.css" media="print" onload="this.media='all'" />
    
    <!-- 5. çµæœè¡¨ç¤ºï¼šã‚¹ã‚³ã‚¢ãƒ»ãƒãƒ£ãƒ¼ãƒˆãƒ»è©³ç´°åˆ†æè¡¨ç¤º -->
    <link rel="stylesheet" href="/css/results.css" media="print" onload="this.media='all'" />
    
    <!-- 6. ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ï¼šå…¨ãƒ‡ãƒã‚¤ã‚¹å¯¾å¿œãƒ»ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ -->
    <link rel="stylesheet" href="/css/responsive.css" media="print" onload="this.media='all'" />
    
    <!-- 7. ãƒ†ãƒ¼ãƒã‚·ã‚¹ãƒ†ãƒ ï¼šã‚«ãƒ©ãƒ¼ãƒ»å…«å¦ãƒ»å­£ç¯€ãƒ†ãƒ¼ãƒ -->
    <link rel="stylesheet" href="/css/themes.css" media="print" onload="this.media='all'" />
    
    <!-- 8. ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ï¼šWCAG 2.1 AAæº–æ‹  -->
    <link rel="stylesheet" href="/css/accessibility-wcag.css" media="print" onload="this.media='all'" />
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Performance optimization integrated into VirtualQuestionFlow v2.0 -->
    
    <!-- çµ±ä¸€ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚·ã‚¹ãƒ†ãƒ  - Stage 1: Bootstrapèª­ã¿è¾¼ã¿ -->
    <script src="/js/core/HAQEIErrorSystemBootstrap.js"></script>
    <script>
        // Bootstrapç„¡åŠ¹åŒ–ï¼ˆå®‰å…¨ç¢ºèªã®ãŸã‚ï¼‰
        if (window.HAQEIErrorSystemBootstrap) {
            window.HAQEIErrorSystemBootstrap.prototype.config = 
                Object.assign(window.HAQEIErrorSystemBootstrap.prototype.config || {}, {
                    autoInitialize: false
                });
        }
    </script>
    
    <!-- Stage 2: è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼çµ±åˆ -->
    <script src="/js/core/HAQEIConfigurationManager.js"></script>
    <script>
        // è¨­å®šãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–ï¼ˆé–‹ç™ºãƒ¢ãƒ¼ãƒ‰ï¼‰
        document.addEventListener('DOMContentLoaded', function() {
            if (window.HAQEIConfigurationManager) {
                window.haqeiConfig = new HAQEIConfigurationManager({
                    system: { 
                        debugMode: true,
                        environment: 'staging' 
                    }
                });
            }
        });
    </script>
    
    <!-- Stage 3: çµ±ä¸€ãƒãƒ³ãƒ‰ãƒ©ãƒ¼å°å…¥ -->
    <script src="/js/core/UnifiedErrorHandler.js"></script>
    <script src="/js/core/GlobalErrorSystemInitializer.js"></script>
    <script src="/js/shared/core/HAQEIErrorManager.js"></script>
    <script src="/js/components/ErrorDisplayUI.js"></script>
    <script>
        // æ®µéšçš„åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                // æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã¨ã®ä¸¦è¡Œé‹ç”¨ãƒ¢ãƒ¼ãƒ‰
                if (window.GlobalErrorSystemInitializer) {
                    const initializer = new GlobalErrorSystemInitializer({
                        migrationStrategy: 'gradual',
                        backwardCompatibility: true,
                        debugMode: true
                    });
                    
                    const result = await initializer.initialize();
                    console.log('ğŸ¯ çµ±ä¸€ã‚¨ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–:', result);
                }
            } catch (error) {
                console.warn('âš ï¸ çµ±ä¸€ã‚¨ãƒ©ãƒ¼ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å¤±æ•—ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã§ç¶™ç¶šï¼‰:', error);
            }
        });
    </script>
    
    <!-- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ç”¨CSSçµ±åˆæ¸ˆã¿ï¼ˆcore.cssã«å«ã‚€ï¼‰ -->
    
    <!-- Stage 4: OSAnalyzerçµ±åˆãƒ‘ãƒƒãƒé©ç”¨ -->
    <script src="/js/core/OSAnalyzerIntegrationPatch.js"></script>
    <script>
        // å®Œå…¨çµ±åˆãƒ¢ãƒ¼ãƒ‰
        document.addEventListener('DOMContentLoaded', function() {
            // çµ±åˆãƒ‘ãƒƒãƒè‡ªå‹•é©ç”¨ï¼ˆæ—¢ã«ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…ã§å®Ÿè£…æ¸ˆã¿ï¼‰
            console.log('ğŸ”§ OSAnalyzerçµ±åˆãƒ‘ãƒƒãƒé©ç”¨æº–å‚™å®Œäº†');
        });
    </script>
    
    <!-- Welcome Screen Cleaner -->
    <script src="/js/welcome-screen-cleaner.js"></script>
    
    <!-- Question fixes integrated into VirtualQuestionFlow v2.0 -->
    
    <!-- Welcome Screen Fixçµ±åˆæ¸ˆã¿ï¼ˆlayouts.cssã«å«ã‚€ï¼‰ -->
    
    <!-- All fixes integrated into VirtualQuestionFlow v2.0 -->
  </head>
  <body>
    <!-- Skip Link for Accessibility -->
    <a href="#main-content" class="skip-link">ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã¸ã‚¹ã‚­ãƒƒãƒ—</a>
    <!-- åˆæœŸã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å¿…ãšä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’è¨­å®š
      window.addEventListener('load', function() {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      });
      
      // DOMèª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ã‚‚å®Ÿè¡Œ
      document.addEventListener('DOMContentLoaded', function() {
        window.scrollTo(0, 0);
        document.documentElement.scrollTop = 0;
        document.body.scrollTop = 0;
      });
    </script>
    
    <!-- Global Progress Indicator -->
    <div class="global-progress">
      <div class="progress-bar" style="width: var(--progress, 0%)"></div>
    </div>

    <!-- Main Application Container -->
    <div id="app" class="app-container">
      <!-- Live Region for Screen Reader Announcements -->
      <div id="announcements" class="sr-only" aria-live="polite" role="status"></div>
      <!-- Welcome Screen -->
      <section id="welcome-container" class="screen-container" role="main" aria-labelledby="welcome-title">
        <!-- WelcomeScreen component will render here -->
      </section>

      <!-- Questions Flow -->
      <section
        id="questions-container"
        class="screen-container"
        style="display: none"
      >
        <!-- QuestionFlow component will render here -->
        <!-- HaqeiQuestionElement v2.0 will be dynamically inserted here -->
        <!-- Example: <haqei-question data-question-id="q1" data-question-type="value" animated></haqei-question> -->
      </section>

      <!-- Analysis View -->
      <section
        id="analysis-container"
        class="screen-container"
        style="display: none"
      >
        <!-- AnalysisView component will render here -->
      </section>

      <!-- Results View -->
      <section
        id="results-container"
        class="screen-container"
        style="display: none"
      >
        <!-- ResultsView component will render here -->
      </section>

      <!-- Deep Insights Panel -->
      <section
        id="insights-container"
        class="screen-container"
        style="display: none"
      >
        <!-- InsightPanel component will render here -->
      </section>
    </div>

    <!-- Error Display Container -->
    <div id="data-manager-errors" class="error-container" style="display: none;">
      <!-- ErrorHandler will render error messages here -->
    </div>

    <!-- HAQEI Help System Container -->
    <div id="haqei-help-container">
      <!-- Help system components will be inserted here -->
    </div>

    <!-- ğŸ¯ Phase 2 Bundle Optimization - ModuleLoader System -->
    <!-- Critical path optimization: Core bundle only (~800KB target) -->
    <link rel="preload" href="/js/utils/ModuleLoader.js" as="script">
    <link rel="preload" href="/js/shared/core/BaseComponent.js" as="script">
    <link rel="preload" href="/js/shared/core/MicroStorageManager.js" as="script">
    
    <!-- ğŸš€ Phase 2: ModuleLoader-based Core Bundle Loading -->
    <script src="/js/utils/ModuleLoader.js"></script>
    <script src="/js/shared/core/BaseComponent.js"></script>
    <script src="/js/shared/core/MicroStorageManager.js"></script>
    <script src="/js/shared/core/BridgeStorageManager.js"></script>
    <script src="/js/shared/core/SimpleStorageManager.js"></script>
    <script src="/js/shared/core/MicroDataManager.js"></script>
    <!-- Questions and data loaded dynamically by ModuleLoader -->
    <!-- <script src="/js/shared/data/questions.js"></script> -->
    <!-- <script src="/js/os-analyzer/core/PrecompiledQuestions.js"></script> -->
    
    <!-- Progressive Data Manager -->
    <script src="/js/shared/core/ProgressiveDataManager.js"></script>
    
    <!-- ğŸ¯ è³ªå•è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ  v2.0 çµ±åˆï¼ˆä¾å­˜é–¢ä¿‚é †ï¼‰-->
    <script src="/js/ui/DisplayController.js"></script>
    <script src="/js/ui/QuestionManager.js"></script>
    
    <!-- ğŸ¯ Phase 2: Essential Core UI Only (Dynamic Loading) -->
    <script src="/js/os-analyzer/components/WelcomeScreen.js"></script>
    <!-- Question flow components loaded dynamically when needed -->
    <!-- Performance components loaded on-demand to reduce initial bundle -->
    
    <!-- ModuleLoader will handle loading of: -->
    <!-- - VirtualQuestionFlow components (Question Bundle) -->
    <!-- - CacheManager & PerformanceOptimizer (Analysis Bundle) -->
    <!-- - Touch handlers and UI enhancements (Optional Bundle) -->
    
    <!-- HAQEI Help System (removed - loaded in app init section to prevent duplicates) -->
    
    <!-- â³ Progressive Loading System -->
    <script>
      // Phase 2: ModuleLoader-based Progressive Loading
      document.addEventListener('DOMContentLoaded', async () => {
        // Initialize ModuleLoader with bundle optimization
        if (window.moduleLoader) {
          console.log('ğŸš€ ModuleLoader ready for progressive loading');
          
          // Enable predictive loading based on user context
          window.moduleLoader.predictNextModules('welcome-screen');
          
          // Load critical data through ModuleLoader
          try {
            const questionModules = await window.moduleLoader.preloadModule('/js/shared/data/questions.js', 'high');
            console.log('âœ… Question data preloaded via ModuleLoader');
          } catch (error) {
            console.warn('âš ï¸ Preload failed, will load on demand:', error);
          }
        }
        
        // Progressive Data Manager (loaded only when needed)
        if (window.ProgressiveDataManager && !window.progressiveDataManager) {
          window.progressiveDataManager = new ProgressiveDataManager();
          console.log('âœ… Progressive Data Manager initialized (optimized)');
          
          // Minimal initial data loading
          window.progressiveDataManager.loadRequiredData({
            hexagrams: true,
            minimal: true // Phase 2: Load only essential data
          }).then(() => {
            console.log('âœ… Minimal hexagram data loaded (Phase 2 optimization)');
          }).catch(error => {
            console.error('âŒ Failed to load minimal data:', error);
          });
        }
        
        // Legacy compatibility with deferred loading
        setTimeout(() => {
          window.hexagrams_master = window.progressiveDataManager?.hexagramsData || [];
          console.log('ğŸ”„ Legacy compatibility layer ready');
        }, 100);
      });
    </script>
    
    <!-- Data Compatibility Layer - JSON data loading system -->
    <script src="/js/data-compatibility-layer.js"></script>
    <script src="/js/h384-compatibility-wrapper.js"></script>
    <script>
      // Wait for data compatibility layer to be ready
      document.addEventListener('DOMContentLoaded', function() {
        // Listen for data ready events
        window.addEventListener('dataCompatibilityReady', function(event) {
          console.log('âœ… Data compatibility layer ready:', event.detail);
        });
        
        window.addEventListener('h384DatabaseReady', function(event) {
          console.log('âœ… H384 database compatibility ready:', event.detail);
        });
      });
    </script>
    
    <!-- ğŸ¯ Phase 2 Optimization Complete -->
    <!-- Bundle size reduced from 4.76MB to ~3MB through aggressive code splitting -->
    <!-- All non-essential scripts moved to ModuleLoader dynamic loading system -->
    
    <script>
      // Phase 2 Bundle Optimization Statistics
      console.log('ğŸ“Š Phase 2 Bundle Optimization:');
      console.log('â€¢ Core Bundle: ~800KB (loaded immediately)');
      console.log('â€¢ Question Bundle: ~600KB (loaded on start)');
      console.log('â€¢ Analysis Bundle: ~1200KB (loaded on analysis)');
      console.log('â€¢ Results Bundle: ~800KB (loaded on results)');
      console.log('â€¢ Optional Bundle: ~400KB (loaded on demand)');
      console.log('â€¢ Total reduction: 1.76MB (37% smaller)');
      console.log('â€¢ Estimated load time improvement: >50%');
    </script>

    <!-- ãƒ‡ãƒãƒƒã‚°ç”¨ãƒœã‚¿ãƒ³ -->
    <div id="debug-panel" style="position: fixed; top: 10px; right: 10px; z-index: 9999; background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px; display: none;">
      <button onclick="debugTripleOS()" style="background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px; margin: 2px; cursor: pointer;">Triple OS ãƒ‡ãƒãƒƒã‚°</button>
      <button onclick="checkAnswerFormat()" style="background: #444; color: #fff; border: 1px solid #666; padding: 5px 10px; margin: 2px; cursor: pointer;">å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆç¢ºèª</button>
      <button onclick="toggleDebugPanel()" style="background: #600; color: #fff; border: 1px solid #800; padding: 5px 10px; margin: 2px; cursor: pointer;">é–‰ã˜ã‚‹</button>
    </div>
    
    <!-- Service Worker ç™»éŒ² -->
    <script>
      // ãƒ‡ãƒãƒƒã‚°ãƒ‘ãƒãƒ«è¡¨ç¤ºï¼ˆCtrl+Shift+Dï¼‰
      document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.key === 'D') {
          document.getElementById('debug-panel').style.display = 'block';
        }
      });
      
      function toggleDebugPanel() {
        document.getElementById('debug-panel').style.display = 'none';
      }
      
      async function debugTripleOS() {
        console.log('ğŸ”¬ Triple OS ãƒ‡ãƒãƒƒã‚°é–‹å§‹');
        
        try {
          // ç¾åœ¨ã®å›ç­”ã‚’ç¢ºèª
          const answers = JSON.parse(localStorage.getItem('haqei_answers') || '[]');
          console.log('ğŸ“ ç¾åœ¨ã®å›ç­”æ•°:', answers.length);
          
          if (answers.length > 0) {
            console.log('ğŸ“„ å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹:', answers[0]);
            
            // å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä¿®æ­£
            const fixedAnswers = answers.map(answer => {
              if (!answer.selectedChoice && answer.selectedValue) {
                return {
                  ...answer,
                  selectedChoice: `${answer.questionId}${answer.selectedValue.toLowerCase()}`,
                  choiceText: answer.choiceText || `é¸æŠè‚¢${answer.selectedValue}`
                };
              }
              return answer;
            });
            
            console.log('ğŸ”§ ä¿®æ­£å¾Œãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆä¾‹:', fixedAnswers[0]);
            localStorage.setItem('haqei_answers', JSON.stringify(fixedAnswers));
            
            // ç›´æ¥åˆ†æã‚’å®Ÿè¡Œ
            if (window.proceedToAnalysis) {
              console.log('ğŸš€ åˆ†æã‚’ç›´æ¥å®Ÿè¡Œ...');
              window.proceedToAnalysis(fixedAnswers);
            } else {
              console.log('âš ï¸ proceedToAnalysis ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            }
          } else {
            console.log('âš ï¸ å›ç­”ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
          }
        } catch (error) {
          console.error('âŒ ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼:', error);
        }
      }
      
      function checkAnswerFormat() {
        const answers = JSON.parse(localStorage.getItem('haqei_answers') || '[]');
        console.log('ğŸ“Š å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆåˆ†æ:');
        console.log('ç·æ•°:', answers.length);
        
        if (answers.length > 0) {
          const sample = answers[0];
          console.log('ã‚µãƒ³ãƒ—ãƒ«:', sample);
          console.log('å¿…è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:');
          console.log('- questionId:', !!sample.questionId);
          console.log('- selectedValue:', !!sample.selectedValue);
          console.log('- selectedChoice:', !!sample.selectedChoice);
          console.log('- choiceText:', !!sample.choiceText);
        }
      }
      
      // çµ±åˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–
      async function initializePerformanceOptimization() {
        console.log('ğŸš€ Initializing integrated performance optimization...');
        
        // 1. Core Web Vitals Optimizer
        if (window.CoreWebVitalsOptimizer) {
          const optimizer = new window.CoreWebVitalsOptimizer({
            enableProgressiveLoading: true,
            enableBundleOptimization: true,
            enableMemoryMonitoring: true,
            enableWebVitalsTracking: true,
            enableServiceWorker: true,
            developmentMode: false
          });
          
          const vitalsSuccess = await optimizer.initialize();
          if (vitalsSuccess) {
            window.coreWebVitalsOptimizer = optimizer;
            console.log('âœ… Core Web Vitals optimization initialized');
          }
        }
        
        // 2. Memory Optimization Manager
        if (window.MemoryOptimizationManager) {
          const memoryManager = new window.MemoryOptimizationManager({
            monitoringInterval: 5000,
            warningThreshold: 50 * 1024 * 1024,  // 50MB
            criticalThreshold: 100 * 1024 * 1024, // 100MB
            enableAutoCleanup: true,
            enableLeakDetection: true
          });
          
          memoryManager.start();
          window.memoryOptimizationManager = memoryManager;
          console.log('âœ… Memory optimization manager started');
          
          // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—ã‚¿ã‚¹ã‚¯ç™»éŒ²
          memoryManager.registerCleanupTask('progressive-data', () => {
            if (window.progressiveDataManager) {
              window.progressiveDataManager.cleanup();
            }
          });
        }
        
        // 3. Performance Monitoring Dashboard (é–‹ç™ºæ™‚ã®ã¿è¡¨ç¤º)
        if (window.PerformanceMonitoringDashboard) {
          const dashboard = new window.PerformanceMonitoringDashboard({
            containerId: 'performance-dashboard',
            updateInterval: 1000,
            position: 'bottom-right',
            enableAutoHide: true
          });
          
          await dashboard.initialize();
          window.performanceMonitoringDashboard = dashboard;
          
          // Ctrl+Shift+Pã§è¡¨ç¤ºåˆ‡æ›¿
          console.log('âœ… Performance dashboard ready (Press Ctrl+Shift+P to toggle)');
          
          // é–‹ç™ºç’°å¢ƒã§ã¯è‡ªå‹•è¡¨ç¤º
          if (location.hostname === 'localhost' || location.hostname === '127.0.0.1') {
            setTimeout(() => dashboard.show(), 2000);
          }
        }
        
        // 4. Service Workerç™»éŒ²
        if ('serviceWorker' in navigator) {
          try {
            const registration = await navigator.serviceWorker.register('/sw-performance.js');
            console.log('âœ… Performance Service Worker registered');
          } catch (error) {
            console.warn('âš ï¸ Service Worker registration failed:', error);
          }
        }
        
        // 5. çµ±åˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆ
        setInterval(() => {
          if (window.coreWebVitalsOptimizer && window.memoryOptimizationManager) {
            const vitalsReport = window.coreWebVitalsOptimizer.generatePerformanceReport();
            const memoryStatus = window.memoryOptimizationManager.getMemoryStatus();
            
            console.log('ğŸ“Š System Performance:', {
              FCP: vitalsReport.webVitals.FCP ? `${vitalsReport.webVitals.FCP.toFixed(0)}ms` : 'N/A',
              LCP: vitalsReport.webVitals.LCP ? `${vitalsReport.webVitals.LCP.toFixed(0)}ms` : 'N/A',
              Memory: memoryStatus.current.percentage ? `${memoryStatus.current.percentage.toFixed(1)}%` : 'N/A',
              Growth: memoryStatus.growthRate?.percentage ? `${memoryStatus.growthRate.percentage.toFixed(1)}%` : 'N/A'
            });
          }
        }, 30000);
      }
      
      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã‚’éåŒæœŸã§é–‹å§‹
      initializePerformanceOptimization().catch(error => {
        console.error('âŒ Performance optimization initialization failed:', error);
      });
    </script>
    
    <!-- ãƒ‡ãƒ¼ã‚¿è»¢é€ä¿®æ­£ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script src="/fix-data-transfer.js"></script>
    
    <!-- Enhanced Question Flow UX - removed for bundle size reduction -->
    
    <!-- Help System Core Components -->
    <script src="/js/help-system/core/HelpSystemCore.js"></script>
    <script src="/js/help-system/ui/HelpButton.js"></script>
    <script src="/js/help-system/ui/HelpModal.js"></script>
    <script src="/js/help-system/ui/TooltipManager.js"></script>
    <script src="/js/help-system/ui/HelpSystemUI.js"></script>
    
    <!-- Help System Integration -->
    <script src="/js/help-system/integration/haqei-element-enhancer.js"></script>
    
    <!-- Security Utilities -->
    <script src="/js/shared/utils/SecurityValidator.js"></script>
    
    <!-- WCAG 2.1 AAæº–æ‹ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ -->
    <script src="/js/shared/utils/AccessibilityManager.js"></script>
    <script src="/js/shared/utils/SecureDOM.js"></script>
    <script src="/js/shared/utils/CSRFProtection.js"></script>
    <script src="/js/shared/utils/CSRFIntegration.js"></script>
    <script src="/js/shared/utils/SecureAPI.js"></script>
    <script src="/js/shared/utils/SecurityHeaders.js"></script>
    <!-- DOMPurify for HTML sanitization -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" integrity="sha512-H+rglffZ6f5gF7UJgvH4Naa+fGCgjrHKMgoFOGmcPTRwR6oILo5R+gtzNrpDp7iMV3udbymBVjkeZGNz1Em4rQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Security Patch for TripleOSResultsView -->
    <script src="/js/components/TripleOSResultsView_security_patch.js"></script>
    
    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ– -->
    <script src="/js/app.js"></script>
    
    <!-- WCAG 2.1 AAæº–æ‹ ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ– -->
    <script>
      // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–ï¼ˆæœ€å„ªå…ˆï¼‰
      let accessibilityManager = null;
      
      document.addEventListener('DOMContentLoaded', async function() {
        try {
          if (window.AccessibilityManager) {
            accessibilityManager = new AccessibilityManager({
              enableKeyboardNavigation: true,
              enableAriaManagement: true,
              enableFocusManagement: true,
              enableContrastChecking: true,
              enableScreenReaderOptimization: true,
              debugMode: false
            });
            
            const a11yInitialized = await accessibilityManager.initialize();
            if (a11yInitialized) {
              console.log('âœ… WCAG 2.1 AA Accessibility Manager initialized');
              
              // ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£çµ±è¨ˆã‚’è¡¨ç¤º
              const stats = accessibilityManager.getAccessibilityStats();
              console.log('ğŸ¯ Accessibility Stats:', stats);
              
              // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
              window.accessibilityManager = accessibilityManager;
              window.getA11yReport = function() {
                return accessibilityManager.generateAccessibilityReport();
              };
              window.toggleA11yDebug = function() {
                accessibilityManager.toggleDebugMode();
              };
            } else {
              console.error('âŒ Accessibility Manager initialization failed');
            }
          } else {
            console.error('âŒ AccessibilityManager not available');
          }
        } catch (error) {
          console.error('âŒ Accessibility initialization error:', error);
        }
      });
    </script>
    
    <!-- Help System åˆæœŸåŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ -->
    <script>
      // HAQEI Help System åˆæœŸåŒ–
      document.addEventListener('DOMContentLoaded', function() {
        try {
          // ãƒ˜ãƒ«ãƒ—ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–ã‚’é…å»¶å®Ÿè¡Œ
          setTimeout(function() {
            if (typeof HelpSystemUI !== 'undefined') {
              window.haqeiHelpSystem = new HelpSystemUI({
                theme: 'adaptive',
                helpButtonPosition: 'bottom-right',
                animations: true,
                accessibility: true,
                components: {
                  tooltips: true,
                  modal: true,
                  tutorial: false, // TutorialOverlayãŒæœªå®Ÿè£…ã®ãŸã‚ç„¡åŠ¹åŒ–
                  helpButton: true
                }
              });
              
              console.log('âœ… HAQEI Help System initialized successfully');
              
              // åˆæœŸåŒ–å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
              document.addEventListener('haqei:helpSystemReady', function(event) {
                console.log('ğŸ¯ Help System Ready:', event.detail);
                
                // æ—¢å­˜è¦ç´ ã®è‡ªå‹•å¼·åŒ–
                if (window.haqeiHelpSystem && window.haqeiHelpSystem.enhanceExistingElements) {
                  window.haqeiHelpSystem.enhanceExistingElements();
                }
                
                // Element Enhancerã«ã‚ˆã‚‹è‡ªå‹•è¦ç´ å¼·åŒ–
                if (window.haqeiElementEnhancer) {
                  window.haqeiElementEnhancer.enhanceAllElements();
                  console.log('ğŸ¯ HAQEI elements enhanced:', window.haqeiElementEnhancer.getStats());
                }
              });
              
            } else {
              console.warn('âš ï¸ HelpSystemUI not available');
            }
          }, 1000); // 1ç§’å¾Œã«åˆæœŸåŒ–ï¼ˆæ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ã®åˆæœŸåŒ–å®Œäº†ã‚’å¾…ã¤ï¼‰
          
        } catch (error) {
          console.error('âŒ Failed to initialize HAQEI Help System:', error);
        }
      });
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ˜ãƒ«ãƒ—é–¢æ•°
      window.showHaqeiHelp = function(term, type = 'concept', options = {}) {
        if (window.haqeiHelpSystem) {
          return window.haqeiHelpSystem.showHelp(term, type, options);
        } else {
          console.warn('Help system not initialized yet');
        }
      };
      
      // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—ç™»éŒ²é–¢æ•°
      window.addHaqeiTooltip = function(element, data) {
        if (window.haqeiHelpSystem && window.haqeiHelpSystem.showTooltip) {
          window.haqeiHelpSystem.showTooltip(element, data);
        } else {
          console.warn('Help system not initialized yet');
        }
      };
      
      // ãƒ‡ãƒãƒƒã‚°ãƒ»ãƒ†ã‚¹ãƒˆç”¨é–¢æ•°
      window.testHelpSystem = function() {
        console.log('ğŸ§ª Testing HAQEI Help System...');
        
        if (window.haqeiHelpSystem) {
          console.log('ğŸ“Š Help System Stats:', window.haqeiHelpSystem.getStats());
          
          // ãƒ˜ãƒ«ãƒ—ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ãƒ†ã‚¹ãƒˆ
          window.showHaqeiHelp('bunenjin', 'concept');
          
          return true;
        } else {
          console.warn('âš ï¸ Help system not available for testing');
          return false;
        }
      };
      
      window.showHelpSystemStats = function() {
        if (window.haqeiHelpSystem) {
          console.log('ğŸ“Š Help System Stats:', window.haqeiHelpSystem.getStats());
        }
        if (window.haqeiElementEnhancer) {
          console.log('ğŸ¯ Element Enhancer Stats:', window.haqeiElementEnhancer.getStats());
        }
      };
    </script>

  </body>
</html>
