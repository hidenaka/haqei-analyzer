<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Phase 1 V2検証</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a1a; color: #fff; }
        .test { margin: 20px 0; padding: 15px; border: 1px solid #444; }
        .pass { color: #4ade80; }
        .fail { color: #f87171; }
        .info { color: #60a5fa; }
        pre { background: #0a0a0a; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>HAQEI v2 要件準拠検証</h1>
    <div id="results"></div>

    <script src="./js/pages/future-simulator/EightScenariosGenerator.js"></script>
    <script>
        const results = document.getElementById('results');
        
        async function runTests() {
            const generator = new EightScenariosGenerator();
            
            // Test 1: 動的パターン生成確認
            results.innerHTML += '<div class="test"><h3>Test 1: 動的8パターン生成</h3>';
            
            const testContext = {
                inputText: 'テスト用の入力テキスト'
            };
            
            const patterns = generator.generateBasePatterns(
                { urgencyLevel: 0.5 },
                { number: 1 }
            );
            
            results.innerHTML += `<div class="info">生成パターン数: ${patterns.length}</div>`;
            
            // Test 2: mechanism確認（advance/transformのみ）
            const mechanisms = patterns.map(p => p.mechanism);
            const uniqueMechanisms = [...new Set(mechanisms)];
            const hasOnlyValidMechanisms = uniqueMechanisms.every(m => m === 'advance' || m === 'transform');
            
            results.innerHTML += `<div class="info">メカニズム種類: ${uniqueMechanisms.join(', ')}</div>`;
            results.innerHTML += `<div class="${hasOnlyValidMechanisms ? 'pass' : 'fail'}">✓ advance/transformのみ: ${hasOnlyValidMechanisms ? '準拠' : '不適合'}</div>`;
            
            // Test 3: changeChain確認
            let hasZeroStep = false;
            let hasMultiStep = false;
            
            patterns.forEach((p, i) => {
                const chainLength = p.changeChain?.length || 0;
                if (chainLength === 0) hasZeroStep = true;
                if (chainLength > 1) hasMultiStep = true;
                results.innerHTML += `<div>Pattern ${i+1}: ${p.mechanism} - chain length: ${chainLength}</div>`;
            });
            
            results.innerHTML += `<div class="${hasZeroStep ? 'pass' : 'fail'}">✓ 0ステップパターン: ${hasZeroStep ? 'あり' : 'なし'}</div>`;
            results.innerHTML += `<div class="${hasMultiStep ? 'pass' : 'fail'}">✓ 複数ステップパターン: ${hasMultiStep ? 'あり' : 'なし'}</div>`;
            
            // Test 4: 固定4基軸の削除確認
            const hasAxis = patterns.some(p => p.axis);
            results.innerHTML += `<div class="${!hasAxis ? 'pass' : 'fail'}">✓ 固定4基軸削除: ${!hasAxis ? '完了' : '残存'}</div>`;
            
            // Test 5: 契約B v2.0形式確認
            const scenarios = generator.buildScenarios(patterns.slice(0, 2), testContext);
            const firstScenario = scenarios[0];
            
            results.innerHTML += '<h3>Test 5: 契約B v2.0形式</h3>';
            
            // 必須フィールドチェック
            const hasRequiredFields = (
                firstScenario.id && 
                firstScenario.mechanism && 
                firstScenario.seed && 
                firstScenario.change_chain !== undefined &&
                firstScenario.narrative &&
                firstScenario.metrics
            );
            
            results.innerHTML += `<div class="${hasRequiredFields ? 'pass' : 'fail'}">✓ 必須フィールド: ${hasRequiredFields ? '完備' : '不足'}</div>`;
            
            // narrativeチェック
            if (firstScenario.narrative) {
                const hasAnalysis = firstScenario.narrative.analysis && firstScenario.narrative.analysis.length >= 60;
                const hasAdvice = firstScenario.narrative.advice && firstScenario.narrative.advice.length >= 50;
                const hasKeywords = firstScenario.narrative.keywords_used && firstScenario.narrative.keywords_used.length > 0;
                
                results.innerHTML += `<div class="${hasAnalysis ? 'pass' : 'fail'}">✓ analysis (60字以上): ${hasAnalysis ? '準拠' : '不足'}</div>`;
                results.innerHTML += `<div class="${hasAdvice ? 'pass' : 'fail'}">✓ advice (50字以上): ${hasAdvice ? '準拠' : '不足'}</div>`;
                results.innerHTML += `<div class="${hasKeywords ? 'pass' : 'fail'}">✓ keywords_used: ${hasKeywords ? 'あり' : 'なし'}</div>`;
            }
            
            results.innerHTML += `<pre>${JSON.stringify({
                id: firstScenario.id,
                mechanism: firstScenario.mechanism,
                seed: firstScenario.seed,
                change_chain_length: firstScenario.change_chain?.length || 0,
                narrative_keys: Object.keys(firstScenario.narrative || {}),
                metrics: firstScenario.metrics
            }, null, 2)}</pre>`;
            
            results.innerHTML += '</div>';
        }
        
        // テスト実行
        runTests().catch(err => {
            results.innerHTML += `<div class="fail">エラー: ${err.message}</div>`;
        });
    </script>
</body>
</html>