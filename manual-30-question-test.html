<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI 30問手動テスト</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            margin: 0;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #6366f1;
        }
        .test-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: background-color 0.3s;
        }
        .test-button:hover {
            background: #5855d6;
        }
        .status {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #6366f1;
        }
        .success { border-left-color: #10b981; }
        .warning { border-left-color: #f59e0b; }
        .error { border-left-color: #ef4444; }
        .log {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 2px solid #444;
            border-radius: 8px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🚀 HAQEI 30問手動テスト</h1>
        <p>この画面でHAQEIの30問回答フローをテストします。</p>
        
        <div class="test-controls">
            <button class="test-button" onclick="startTest()">🎯 テスト開始</button>
            <button class="test-button" onclick="checkElements()">🔍 要素確認</button>
            <button class="test-button" onclick="forceVisibility()">💪 要素強制表示</button>
            <button class="test-button" onclick="openInNewTab()">🔗 新しいタブで開く</button>
        </div>
        
        <div id="status" class="status">
            📋 テスト準備完了。「テスト開始」ボタンをクリックしてください。
        </div>
        
        <div id="log" class="log">テストログが表示されます...\n</div>
        
        <iframe id="testFrame" src="about:blank"></iframe>
    </div>

    <script>
        let testLog = '';
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = testLog;
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
            console.log(message);
        }
        
        function updateStatus(message, type = 'status') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }
        
        function startTest() {
            log('🚀 HAQEI 30問テスト開始...');
            updateStatus('📱 テストページを読み込み中...', 'warning');
            
            const iframe = document.getElementById('testFrame');
            iframe.src = 'http://localhost:8080/os_analyzer.html';
            
            iframe.onload = function() {
                log('✅ ページ読み込み完了');
                updateStatus('✅ ページ読み込み完了 - 手動で「分析を開始する」ボタンをクリックしてください', 'success');
                
                // iframeのコンテンツに緊急修正スクリプトを注入
                setTimeout(() => {
                    injectEmergencyFix();
                }, 2000);
            };
            
            iframe.onerror = function() {
                log('❌ ページ読み込みエラー');
                updateStatus('❌ ページ読み込みエラー', 'error');
            };
        }
        
        function injectEmergencyFix() {
            try {
                const iframe = document.getElementById('testFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                log('🔧 緊急修正スクリプトを注入中...');
                
                const script = iframeDoc.createElement('script');
                script.textContent = `
                    (function() {
                        console.log('🚨 緊急修正スクリプト実行');
                        
                        function forceQuestionVisibility() {
                            const haqeiQuestions = document.querySelectorAll('haqei-question');
                            console.log('📝 Found haqei-question elements:', haqeiQuestions.length);
                            
                            haqeiQuestions.forEach((element, index) => {
                                element.style.cssText = \`
                                    display: block !important;
                                    visibility: visible !important;
                                    opacity: 1 !important;
                                    position: relative !important;
                                    width: 100% !important;
                                    height: auto !important;
                                    min-height: 400px !important;
                                    margin: 20px auto !important;
                                    padding: 30px !important;
                                    background: #2a2a2a !important;
                                    border: 3px solid #6366f1 !important;
                                    border-radius: 12px !important;
                                    z-index: 9999 !important;
                                    pointer-events: auto !important;
                                \`;
                                
                                // ラジオボタンも修正
                                const radios = element.querySelectorAll('input[type="radio"]');
                                radios.forEach(radio => {
                                    radio.style.cssText = \`
                                        display: inline-block !important;
                                        visibility: visible !important;
                                        opacity: 1 !important;
                                        pointer-events: auto !important;
                                        z-index: 10000 !important;
                                    \`;
                                });
                                
                                // ラベルも修正
                                const labels = element.querySelectorAll('label');
                                labels.forEach(label => {
                                    label.style.cssText = \`
                                        display: flex !important;
                                        visibility: visible !important;
                                        opacity: 1 !important;
                                        pointer-events: auto !important;
                                        z-index: 10000 !important;
                                        padding: 15px !important;
                                        margin: 10px 0 !important;
                                        background: #3a3a3a !important;
                                        border: 2px solid #555 !important;
                                        border-radius: 8px !important;
                                        color: #ffffff !important;
                                        cursor: pointer !important;
                                    \`;
                                });
                                
                                console.log(\`✅ Fixed haqei-question \${index}\`);
                            });
                        }
                        
                        // 即座に実行
                        forceQuestionVisibility();
                        
                        // 定期的に実行
                        setInterval(forceQuestionVisibility, 1000);
                        
                        // DOMが変更されたら実行
                        const observer = new MutationObserver(forceQuestionVisibility);
                        observer.observe(document.body, {
                            childList: true,
                            subtree: true,
                            attributes: true
                        });
                        
                        console.log('🔍 緊急修正システム起動完了');
                    })();
                `;
                
                iframeDoc.head.appendChild(script);
                log('✅ 緊急修正スクリプト注入完了');
                updateStatus('✅ 緊急修正適用済み - 手動で質問に回答してください', 'success');
                
            } catch (error) {
                log(`❌ 緊急修正スクリプト注入エラー: ${error.message}`);
                updateStatus('⚠️ 緊急修正に失敗 - 直接ページで操作してください', 'warning');
            }
        }
        
        function checkElements() {
            try {
                const iframe = document.getElementById('testFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                const haqeiQuestions = iframeDoc.querySelectorAll('haqei-question');
                const radioButtons = iframeDoc.querySelectorAll('input[type="radio"]');
                const labels = iframeDoc.querySelectorAll('label');
                
                log(`🔍 要素確認結果:`);
                log(`  - haqei-question: ${haqeiQuestions.length}個`);
                log(`  - ラジオボタン: ${radioButtons.length}個`);
                log(`  - ラベル: ${labels.length}個`);
                
                haqeiQuestions.forEach((q, i) => {
                    const rect = q.getBoundingClientRect();
                    log(`  - 質問${i}: w=${rect.width}, h=${rect.height}, visible=${rect.width > 0 && rect.height > 0}`);
                });
                
                updateStatus(`📊 要素確認完了 - 質問:${haqeiQuestions.length}個, ボタン:${radioButtons.length}個`, 'success');
                
            } catch (error) {
                log(`❌ 要素確認エラー: ${error.message}`);
                updateStatus('❌ 要素確認に失敗', 'error');
            }
        }
        
        function forceVisibility() {
            try {
                const iframe = document.getElementById('testFrame');
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                
                // 緊急修正関数を再実行
                iframeDoc.defaultView.eval(`
                    const haqeiQuestions = document.querySelectorAll('haqei-question');
                    haqeiQuestions.forEach(element => {
                        element.style.cssText = 'display: block !important; visibility: visible !important; opacity: 1 !important; position: relative !important; width: 100% !important; height: auto !important; min-height: 400px !important; margin: 20px auto !important; padding: 30px !important; background: #2a2a2a !important; border: 3px solid #6366f1 !important; border-radius: 12px !important; z-index: 9999 !important; pointer-events: auto !important;';
                    });
                    
                    const radioButtons = document.querySelectorAll('input[type="radio"]');
                    radioButtons.forEach(radio => {
                        radio.style.cssText = 'display: inline-block !important; visibility: visible !important; opacity: 1 !important; pointer-events: auto !important; z-index: 10000 !important;';
                    });
                    
                    const labels = document.querySelectorAll('label');
                    labels.forEach(label => {
                        label.style.cssText = 'display: flex !important; visibility: visible !important; opacity: 1 !important; pointer-events: auto !important; z-index: 10000 !important; padding: 15px !important; margin: 10px 0 !important; background: #3a3a3a !important; border: 2px solid #555 !important; border-radius: 8px !important; color: #ffffff !important; cursor: pointer !important;';
                    });
                    
                    console.log('💪 強制表示実行完了');
                `);
                
                log('💪 要素強制表示を実行');
                updateStatus('💪 要素強制表示完了', 'success');
                
            } catch (error) {
                log(`❌ 強制表示エラー: ${error.message}`);
                updateStatus('❌ 強制表示に失敗', 'error');
            }
        }
        
        function openInNewTab() {
            window.open('http://localhost:8080/os_analyzer.html', '_blank');
            log('🔗 新しいタブでページを開きました');
            updateStatus('🔗 新しいタブで直接テストしてください', 'success');
        }
        
        // ページ読み込み時にテストを自動開始
        window.onload = function() {
            log('📋 手動テストページ準備完了');
            updateStatus('📋 準備完了 - テストを開始してください', 'success');
        };
    </script>
</body>
</html>