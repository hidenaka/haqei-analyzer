<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triple OS Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>🔬 Triple OS Data Generation Debug Test</h1>
    
    <div class="debug-section">
        <h2>システム状態確認</h2>
        <button onclick="checkSystemStatus()">システム状態をチェック</button>
        <pre id="system-status"></pre>
    </div>
    
    <div class="debug-section">
        <h2>分析エンジンテスト</h2>
        <button onclick="testAnalysisEngine()">分析エンジンをテスト</button>
        <pre id="analysis-result"></pre>
    </div>
    
    <div class="debug-section">
        <h2>実際のTripleOSEngine直接テスト</h2>
        <button onclick="testDirectTripleOSEngine()">TripleOSEngineを直接テスト</button>
        <pre id="direct-result"></pre>
    </div>

    <!-- 必要なJSファイルを読み込み -->
    <script src="js/shared/core/SimpleStorageManager.js"></script>
    <script src="js/shared/utils/DataFlowMonitor.js"></script>
    <script src="js/shared/utils/SimpleHooks.js"></script>
    <script src="js/shared/os-analyzer/DataManager.js"></script>
    <script src="js/shared/os-analyzer/Calculator.js"></script>
    <script src="js/shared/os-analyzer/IChingCompatibilityDataLoader.js"></script>
    <script src="js/os-analyzer/core/Engine.js"></script>
    <script src="js/os-analyzer/core/IChingUltraSyncLogic.js"></script>
    <script src="js/os-analyzer/core/TripleOSEngine.js"></script>
    <script src="js/os-analyzer/core/UltraAnalysisEngine.js"></script>

    <script>
        let dataManager = null;
        let ultraEngine = null;
        let tripleOSEngine = null;
        
        // テスト用の回答データ
        const testUserAnswers = [
            // 価値観設問（q1-q28）
            { questionId: 'q1', selectedChoice: 'q1a', choiceText: '個人の自由を重視する' },
            { questionId: 'q2', selectedChoice: 'q2b', choiceText: '安定した関係を築く' },
            { questionId: 'q3', selectedChoice: 'q3a', choiceText: '新しい挑戦をする' },
            { questionId: 'q4', selectedChoice: 'q4b', choiceText: 'チームで協力する' },
            { questionId: 'q5', selectedChoice: 'q5a', choiceText: '論理的に判断する' },
            // シナリオ設問（q29-q56）
            { questionId: 'q29', selectedChoice: 'q29a', choiceText: '積極的にアプローチする' },
            { questionId: 'q30', selectedChoice: 'q30b', choiceText: '慎重に様子を見る' },
            { questionId: 'q31', selectedChoice: 'q31a', choiceText: '直接話し合う' },
            { questionId: 'q32', selectedChoice: 'q32b', choiceText: '時間をかけて考える' }
        ];

        async function initializeSystem() {
            try {
                console.log('🔄 Initializing system...');
                
                // DataManagerの初期化
                dataManager = new DataManager();
                await dataManager.loadAllData();
                console.log('✅ DataManager initialized');
                
                // UltraAnalysisEngineの初期化
                ultraEngine = new UltraAnalysisEngine(dataManager);
                console.log('✅ UltraAnalysisEngine initialized');
                
                // TripleOSEngineの初期化
                tripleOSEngine = new TripleOSEngine(dataManager);
                console.log('✅ TripleOSEngine initialized');
                
                return true;
            } catch (error) {
                console.error('❌ System initialization failed:', error);
                return false;
            }
        }

        async function checkSystemStatus() {
            const statusEl = document.getElementById('system-status');
            statusEl.textContent = 'チェック中...';
            
            try {
                const initialized = await initializeSystem();
                
                const status = {
                    systemInitialized: initialized,
                    dataManager: dataManager ? 'initialized' : 'not initialized',
                    ultraEngine: ultraEngine ? 'initialized' : 'not initialized',
                    tripleOSEngine: tripleOSEngine ? 'initialized' : 'not initialized',
                    tripleOSEngineClass: typeof TripleOSEngine !== 'undefined' ? 'available' : 'not available',
                    testAnswers: testUserAnswers.length + ' test answers prepared'
                };
                
                statusEl.innerHTML = '<span class="success">✅ システム状態:</span>\n' + 
                                   JSON.stringify(status, null, 2);
            } catch (error) {
                statusEl.innerHTML = '<span class="error">❌ エラー:</span>\n' + error.message;
            }
        }

        async function testAnalysisEngine() {
            const resultEl = document.getElementById('analysis-result');
            resultEl.textContent = '分析実行中...';
            
            try {
                if (!ultraEngine) {
                    await initializeSystem();
                }
                
                console.log('🚀 Starting UltraAnalysisEngine test...');
                const startTime = performance.now();
                
                const result = await ultraEngine.analyzeTripleOS(testUserAnswers);
                
                const endTime = performance.now();
                const analysisTime = endTime - startTime;
                
                const summary = {
                    analysisTime: analysisTime.toFixed(2) + 'ms',
                    resultType: result?.analysisType || 'unknown',
                    hasEngineOS: !!result?.engineOS,
                    hasInterfaceOS: !!result?.interfaceOS,
                    hasSafeModeOS: !!result?.safeModeOS,
                    hasPrimaryOS: !!result?.primaryOS,
                    engineOSDetails: result?.engineOS ? {
                        name: result.engineOS.name,
                        strength: result.engineOS.strength,
                        hexagram: result.engineOS.hexagramInfo?.name
                    } : null,
                    interfaceOSDetails: result?.interfaceOS ? {
                        name: result.interfaceOS.name,
                        strength: result.interfaceOS.strength,
                        hexagram: result.interfaceOS.hexagramInfo?.name
                    } : null,
                    safeModeOSDetails: result?.safeModeOS ? {
                        name: result.safeModeOS.name,
                        strength: result.safeModeOS.strength,
                        hexagram: result.safeModeOS.hexagramInfo?.name
                    } : null
                };
                
                resultEl.innerHTML = '<span class="success">✅ UltraAnalysisEngine結果:</span>\n' + 
                                   JSON.stringify(summary, null, 2) + '\n\n' +
                                   '<span class="success">完全結果:</span>\n' +
                                   JSON.stringify(result, null, 2);
                
            } catch (error) {
                resultEl.innerHTML = '<span class="error">❌ エラー:</span>\n' + error.message + '\n\n' +
                                   '<span class="error">スタックトレース:</span>\n' + error.stack;
            }
        }

        async function testDirectTripleOSEngine() {
            const resultEl = document.getElementById('direct-result');
            resultEl.textContent = '直接分析実行中...';
            
            try {
                if (!tripleOSEngine) {
                    await initializeSystem();
                }
                
                console.log('🚀 Starting direct TripleOSEngine test...');
                const startTime = performance.now();
                
                const result = await tripleOSEngine.analyzeUser(testUserAnswers);
                
                const endTime = performance.now();
                const analysisTime = endTime - startTime;
                
                const summary = {
                    analysisTime: analysisTime.toFixed(2) + 'ms',
                    resultType: result?.analysisType || 'unknown',
                    hasEngineOS: !!result?.engineOS,
                    hasInterfaceOS: !!result?.interfaceOS,
                    hasSafeModeOS: !!result?.safeModeOS,
                    hasPrimaryOS: !!result?.primaryOS,
                    virtualPersonalityEnabled: tripleOSEngine.virtualPersonalitySystem?.enabled,
                    engineOSDetails: result?.engineOS ? {
                        name: result.engineOS.name,
                        strength: result.engineOS.strength,
                        hexagram: result.engineOS.hexagramInfo?.name
                    } : null
                };
                
                resultEl.innerHTML = '<span class="success">✅ 直接TripleOSEngine結果:</span>\n' + 
                                   JSON.stringify(summary, null, 2) + '\n\n' +
                                   '<span class="success">完全結果:</span>\n' +
                                   JSON.stringify(result, null, 2);
                
            } catch (error) {
                resultEl.innerHTML = '<span class="error">❌ エラー:</span>\n' + error.message + '\n\n' +
                                   '<span class="error">スタックトレース:</span>\n' + error.stack;
            }
        }

        // ページ読み込み時に初期化
        window.addEventListener('load', () => {
            console.log('🔍 Triple OS Debug Test page loaded');
        });
    </script>
</body>
</html>