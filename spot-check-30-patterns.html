<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>抜き打ち30パターン文脈チェック</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #fff; 
            line-height: 1.6;
        }
        .pattern-check {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #444;
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
        }
        .pattern-header {
            font-weight: bold;
            color: #22d3ee;
            margin-bottom: 10px;
        }
        .synergy-info {
            background: rgba(59, 130, 246, 0.1);
            padding: 8px;
            border-radius: 4px;
            margin: 8px 0;
        }
        .pair-analysis {
            margin: 8px 0;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-left: 3px solid #666;
        }
        .logical { border-left-color: #10b981; }
        .suspicious { 
            border-left-color: #f59e0b; 
            background: rgba(245, 158, 11, 0.1);
        }
        .problematic { 
            border-left-color: #ef4444; 
            background: rgba(239, 68, 68, 0.1);
        }
        button {
            padding: 12px 25px;
            background: linear-gradient(135deg, #dc2626, #ef4444);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            margin: 10px 0;
        }
        .summary {
            margin-top: 30px;
            padding: 20px;
            border: 2px solid #22d3ee;
            border-radius: 10px;
            background: rgba(34, 211, 238, 0.05);
        }
    </style>
</head>
<body>
    <h1>🔍 抜き打ち30パターン文脈チェック</h1>
    <p>ランダム選択した30パターンの実際の出力内容と論理的一貫性をチェック</p>
    
    <button onclick="runSpotCheck()">🎯 30パターン抜き打ちチェック実行</button>
    
    <div id="results"></div>
    <div id="summary"></div>

    <script src="./public/assets/H384H64database.js"></script>
    <script src="./public/js/core/TripleOSInteractionAnalyzer.js"></script>
    <script>
        function runSpotCheck() {
            const results = document.getElementById('results');
            const summary = document.getElementById('summary');
            
            results.innerHTML = '<div>🔄 30パターンチェック実行中...</div>';
            summary.innerHTML = '';
            
            try {
                const analyzer = new TripleOSInteractionAnalyzer();
                
                // ランダムに30パターン選択
                const spotCheckPatterns = [];
                const usedCombinations = new Set();
                
                while (spotCheckPatterns.length < 30) {
                    const e = Math.floor(Math.random() * 64) + 1;
                    const iface = Math.floor(Math.random() * 64) + 1;
                    const s = Math.floor(Math.random() * 64) + 1;
                    const key = `${e}-${iface}-${s}`;
                    
                    if (!usedCombinations.has(key)) {
                        usedCombinations.add(key);
                        spotCheckPatterns.push([e, iface, s]);
                    }
                }
                
                console.log('30パターン抜き打ちチェック開始');
                
                let logicalCount = 0;
                let suspiciousCount = 0;
                let problematicCount = 0;
                const issues = [];
                
                let html = '<h2>🔍 詳細チェック結果</h2>';
                
                spotCheckPatterns.forEach(([e, iface, s], index) => {
                    try {
                        const engineOS = { hexagramId: e, name: `第${e}卦`, score: 0.5 };
                        const interfaceOS = { hexagramId: iface, name: `第${iface}卦`, score: 0.5 };
                        const safeModeOS = { hexagramId: s, name: `第${s}卦`, score: 0.5 };
                        
                        // 個別ペア分析
                        const engineInterfaceAnalysis = analyzer.analyzePair('engine-interface', engineOS, interfaceOS);
                        const engineSafeAnalysis = analyzer.analyzePair('engine-safe', engineOS, safeModeOS);
                        const interfaceSafeAnalysis = analyzer.analyzePair('interface-safe', interfaceOS, safeModeOS);
                        
                        // 総合シナジー
                        const totalSynergy = (engineInterfaceAnalysis.synergy + engineSafeAnalysis.synergy + interfaceSafeAnalysis.synergy) / 3;
                        const overallCategory = getSynergyCategory(totalSynergy);
                        
                        // 文脈チェック
                        const contextCheck = checkContextualLogic(
                            e, iface, s,
                            engineInterfaceAnalysis,
                            engineSafeAnalysis, 
                            interfaceSafeAnalysis,
                            totalSynergy,
                            overallCategory
                        );
                        
                        // 結果分類
                        let cssClass = 'logical';
                        if (contextCheck.issues.length > 0) {
                            if (contextCheck.severity === 'problematic') {
                                cssClass = 'problematic';
                                problematicCount++;
                                issues.push(...contextCheck.issues);
                            } else {
                                cssClass = 'suspicious';
                                suspiciousCount++;
                            }
                        } else {
                            logicalCount++;
                        }
                        
                        html += `
                            <div class="pattern-check">
                                <div class="pattern-header">
                                    パターン ${index + 1}: Engine(${e}) × Interface(${iface}) × SafeMode(${s})
                                </div>
                                
                                <div class="synergy-info">
                                    総合シナジー: ${totalSynergy.toFixed(3)} → ${overallCategory}
                                </div>
                                
                                <div class="pair-analysis ${cssClass}">
                                    <strong>Engine-Interface:</strong> ${engineInterfaceAnalysis.category} (${engineInterfaceAnalysis.synergy?.toFixed(3)})<br>
                                    「${engineInterfaceAnalysis.summary}」
                                </div>
                                
                                <div class="pair-analysis ${cssClass}">
                                    <strong>Engine-Safe:</strong> ${engineSafeAnalysis.category} (${engineSafeAnalysis.synergy?.toFixed(3)})<br>
                                    「${engineSafeAnalysis.summary}」
                                </div>
                                
                                <div class="pair-analysis ${cssClass}">
                                    <strong>Interface-Safe:</strong> ${interfaceSafeAnalysis.category} (${interfaceSafeAnalysis.synergy?.toFixed(3)})<br>
                                    「${interfaceSafeAnalysis.summary}」
                                </div>
                                
                                ${contextCheck.issues.length > 0 ? 
                                    `<div style="color: #f59e0b; margin-top: 10px;">
                                        <strong>⚠️ 検出された問題:</strong><br>
                                        ${contextCheck.issues.map(issue => `• ${issue}`).join('<br>')}
                                    </div>` : 
                                    `<div style="color: #10b981;">✅ 文脈的に論理的</div>`
                                }
                            </div>
                        `;
                        
                    } catch (error) {
                        problematicCount++;
                        issues.push(`パターン${e}-${iface}-${s}: 実行エラー - ${error.message}`);
                        
                        html += `
                            <div class="pattern-check">
                                <div class="pattern-header">
                                    パターン ${index + 1}: Engine(${e}) × Interface(${iface}) × SafeMode(${s})
                                </div>
                                <div style="color: #ef4444;">
                                    ❌ 実行エラー: ${error.message}
                                </div>
                            </div>
                        `;
                    }
                });
                
                results.innerHTML = html;
                
                // サマリー生成
                summary.innerHTML = `
                    <div class="summary">
                        <h3>📊 30パターン抜き打ちチェック結果</h3>
                        <p><strong>✅ 論理的に正常:</strong> ${logicalCount}/30 (${(logicalCount/30*100).toFixed(1)}%)</p>
                        <p><strong>⚠️ 疑わしい:</strong> ${suspiciousCount}/30 (${(suspiciousCount/30*100).toFixed(1)}%)</p>
                        <p><strong>❌ 問題あり:</strong> ${problematicCount}/30 (${(problematicCount/30*100).toFixed(1)}%)</p>
                        
                        ${issues.length > 0 ? `
                            <h4>🚨 検出された主な問題パターン</h4>
                            ${issues.slice(0, 10).map(issue => `<p>• ${issue}</p>`).join('')}
                            ${issues.length > 10 ? `<p>...他 ${issues.length - 10} 件</p>` : ''}
                            
                            <h4>🔧 推奨修正対応</h4>
                            <p>類似パターンの修正が必要です。以下の観点で確認してください:</p>
                            <ul>
                                <li>同一卦ペアの表現一貫性</li>
                                <li>カテゴリと記述文の論理的整合性</li>
                                <li>卦の特性と表現内容の適合性</li>
                            </ul>
                        ` : `
                            <h4>🎉 結果</h4>
                            <p style="color: #10b981; font-weight: bold;">
                                全30パターンが文脈的に論理的です！システム品質は優秀です。
                            </p>
                        `}
                    </div>
                `;
                
            } catch (error) {
                results.innerHTML = `
                    <div style="color: #ef4444; padding: 20px;">
                        ❌ チェック実行エラー: ${error.message}
                    </div>
                `;
            }
        }
        
        function getSynergyCategory(synergy) {
            if (synergy >= 0.6) return 'SYNERGY';
            if (synergy >= 0.2) return 'HARMONY';
            if (synergy >= -0.2) return 'TENSION';
            return 'CONFLICT';
        }
        
        function checkContextualLogic(engineId, interfaceId, safeModeId, eiAnalysis, esAnalysis, isAnalysis, totalSynergy, overallCategory) {
            const issues = [];
            let severity = 'normal';
            
            // チェック1: 同一卦ペアの論理性
            if (engineId === interfaceId) {
                if (eiAnalysis.category === 'TENSION' && eiAnalysis.summary.includes('競合')) {
                    // 同一卦が競合というのは論理的におかしい
                    if (getHexagramCharacteristics(engineId).keywords.some(k => ['調和', '協調', '安定', '平和', '受容性', '包容力', '柔軟性'].includes(k))) {
                        issues.push(`同一卦${getHexagramName(engineId)}が「競合」「緊張」表現 - 調和系の卦なのに矛盾`);
                        severity = 'problematic';
                    }
                }
            }
            
            if (engineId === safeModeId) {
                if (esAnalysis.category === 'TENSION' && esAnalysis.summary.includes('競合')) {
                    if (getHexagramCharacteristics(engineId).keywords.some(k => ['調和', '協調', '安定', '平和', '受容性', '包容力', '柔軟性'].includes(k))) {
                        issues.push(`Engine-Safe同一卦${getHexagramName(engineId)}が「競合」表現 - 本来は安定すべき`);
                        severity = 'problematic';
                    }
                }
            }
            
            if (interfaceId === safeModeId) {
                if (isAnalysis.category === 'TENSION' && isAnalysis.summary.includes('競合')) {
                    if (getHexagramCharacteristics(interfaceId).keywords.some(k => ['調和', '協調', '安定', '平和', '受容性', '包容力', '柔軟性'].includes(k))) {
                        issues.push(`Interface-Safe同一卦${getHexagramName(interfaceId)}が「競合」表現 - 論理的に矛盾`);
                        severity = 'problematic';
                    }
                }
            }
            
            // チェック2: カテゴリと記述の整合性
            [eiAnalysis, esAnalysis, isAnalysis].forEach((analysis, idx) => {
                const pairNames = ['Engine-Interface', 'Engine-Safe', 'Interface-Safe'];
                const pairName = pairNames[idx];
                
                if (analysis.category === 'HARMONY' && analysis.summary.includes('衝突')) {
                    issues.push(`${pairName}: HARMONY判定なのに「衝突」表現`);
                    severity = 'suspicious';
                }
                
                if (analysis.category === 'SYNERGY' && analysis.summary.includes('緊張')) {
                    issues.push(`${pairName}: SYNERGY判定なのに「緊張」表現`);
                    severity = 'suspicious';
                }
                
                if (analysis.category === 'CONFLICT' && analysis.summary.includes('調和')) {
                    issues.push(`${pairName}: CONFLICT判定なのに「調和」表現`);
                    severity = 'suspicious';
                }
            });
            
            // チェック3: undefined値チェック
            if (eiAnalysis.summary.includes('undefined') || esAnalysis.summary.includes('undefined') || isAnalysis.summary.includes('undefined')) {
                issues.push('summary文にundefined値が含まれている');
                severity = 'problematic';
            }
            
            return { issues, severity };
        }
        
        function getHexagramName(id) {
            const names = {
                1: '乾為天', 2: '坤為地', 3: '水雷屯', 4: '山水蒙', 5: '水天需',
                6: '天水訟', 7: '地水師', 8: '水地比', 9: '風天小畜', 10: '天沢履',
                11: '地天泰', 12: '天地否', 13: '天火同人', 14: '火天大有', 15: '地山謙',
                16: '雷地豫', 17: '沢雷随', 18: '山風蠱', 19: '地沢臨', 20: '風地観'
            };
            return names[id] || `第${id}卦`;
        }
        
        function getHexagramCharacteristics(id) {
            // 簡易版 - 実際のH64_DATAから取得
            try {
                return window.H64_DATA[id] || { keywords: [], strength: '', weakness: '' };
            } catch {
                return { keywords: [], strength: '', weakness: '' };
            }
        }
    </script>
</body>
</html>