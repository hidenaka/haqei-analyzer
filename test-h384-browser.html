<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H384データベース動作確認テスト</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        .data-sample { 
            max-height: 200px; 
            overflow-y: auto; 
            background: #f8f9fa; 
            padding: 10px; 
            border-radius: 4px; 
        }
    </style>
</head>
<body>
    <h1>🔍 H384データベース動作確認テスト</h1>
    <p>HAQEI Analyzer H384データベース（386爻システム）のブラウザ環境での動作を確認します。</p>
    
    <div class="test-container">
        <h2>📊 テスト実行</h2>
        <button onclick="runAllTests()">🚀 全テスト実行</button>
        <button onclick="testDataIntegrity()">📋 データ完全性テスト</button>
        <button onclick="testYaoEntries()">🎯 用九・用六テスト</button>
        <button onclick="testDataAccess()">🔍 データアクセステスト</button>
        <button onclick="clearResults()">🧹 結果クリア</button>
        
        <div id="test-results"></div>
    </div>
    
    <div class="test-container">
        <h2>📈 テスト詳細結果</h2>
        <div id="detailed-results"></div>
    </div>
    
    <div class="test-container">
        <h2>📝 データサンプル</h2>
        <div id="data-samples"></div>
    </div>

    <!-- H384データベース読み込み -->
    <script src="./assets/H384H64database.js"></script>
    
    <script>
        let testResults = [];
        
        /**
         * テスト結果を表示エリアに追加
         */
        function addTestResult(type, title, message, details = null) {
            const result = {
                type: type,
                title: title,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            
            let content = `<strong>${title}</strong>: ${message}`;
            if (details) {
                content += `<pre>${details}</pre>`;
            }
            
            resultDiv.innerHTML = content;
            resultsDiv.appendChild(resultDiv);
            
            // 自動スクロール
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }
        
        /**
         * H384データベース基本チェック
         */
        function testBasicAvailability() {
            console.log('🔍 H384データベース基本チェック開始...');
            
            // window.H384_DATAの存在確認
            if (typeof window.H384_DATA === 'undefined') {
                addTestResult('error', 'データベース存在確認', 'window.H384_DATA が未定義です');
                return false;
            }
            
            // 配列かどうか確認
            if (!Array.isArray(window.H384_DATA)) {
                addTestResult('error', 'データ形式確認', 'H384_DATA は配列ではありません');
                return false;
            }
            
            // データ長確認
            const length = window.H384_DATA.length;
            if (length !== 386) {
                addTestResult('warning', 'データ長確認', `データ長: ${length} (期待値: 386)`);
            } else {
                addTestResult('success', 'データ長確認', `✅ 正確に386エントリが存在します`);
            }
            
            addTestResult('success', 'データベース存在確認', '✅ H384_DATA正常に読み込まれています');
            return true;
        }
        
        /**
         * データ完全性テスト
         */
        function testDataIntegrity() {
            console.log('📋 データ完全性テスト開始...');
            
            if (!testBasicAvailability()) {
                return;
            }
            
            const data = window.H384_DATA;
            const requiredFields = ['通し番号', '卦番号', '卦名', '爻', 'キーワード', '現代解釈の要約'];
            
            let validEntries = 0;
            let invalidEntries = [];
            
            data.forEach((entry, index) => {
                const missingFields = requiredFields.filter(field => !entry.hasOwnProperty(field));
                
                if (missingFields.length === 0) {
                    validEntries++;
                } else {
                    invalidEntries.push({
                        index: index,
                        entry: entry,
                        missingFields: missingFields
                    });
                }
            });
            
            if (invalidEntries.length === 0) {
                addTestResult('success', 'データ完全性', `✅ 全${data.length}エントリの必須フィールドが完全です`);
            } else {
                addTestResult('error', 'データ完全性', 
                    `❌ ${invalidEntries.length}個のエントリに問題があります`, 
                    `不正エントリの例:\n${JSON.stringify(invalidEntries.slice(0, 3), null, 2)}`
                );
            }
            
            // スコアフィールドの確認
            const scoreFields = ['S1_基本スコア', 'S2_ポテンシャル', 'S3_安定性スコア', 'S4_リスク', 'S7_総合評価スコア'];
            let scoreValidEntries = 0;
            
            data.forEach(entry => {
                const hasAllScores = scoreFields.every(field => 
                    entry.hasOwnProperty(field) && typeof entry[field] === 'number'
                );
                if (hasAllScores) scoreValidEntries++;
            });
            
            addTestResult('info', 'スコアデータ', 
                `📊 ${scoreValidEntries}/${data.length}エントリがスコアデータを持っています`
            );
        }
        
        /**
         * 用九・用六エントリテスト
         */
        function testYaoEntries() {
            console.log('🎯 用九・用六エントリテスト開始...');
            
            if (!testBasicAvailability()) {
                return;
            }
            
            const data = window.H384_DATA;
            
            // 用九エントリ検索 (通し番号7)
            const youkuu = data.find(entry => entry['通し番号'] === 7 && entry['爻'] === '用九');
            if (youkuu) {
                addTestResult('success', '用九エントリ', 
                    `✅ 用九エントリが正常に存在します (${youkuu['卦名']})`,
                    JSON.stringify(youkuu, null, 2)
                );
            } else {
                addTestResult('error', '用九エントリ', '❌ 用九エントリが見つかりません');
            }
            
            // 用六エントリ検索 (通し番号14)
            const yourikuu = data.find(entry => entry['通し番号'] === 14 && entry['爻'] === '用六');
            if (yourikuu) {
                addTestResult('success', '用六エントリ', 
                    `✅ 用六エントリが正常に存在します (${yourikuu['卦名']})`,
                    JSON.stringify(yourikuu, null, 2)
                );
            } else {
                addTestResult('error', '用六エントリ', '❌ 用六エントリが見つかりません');
            }
            
            // 64卦確認
            const hexagramCount = [...new Set(data.map(entry => entry['卦番号']))].length;
            addTestResult('info', '卦数確認', `📊 データベースには${hexagramCount}個の異なる卦が含まれています`);
        }
        
        /**
         * データアクセス・機能テスト
         */
        function testDataAccess() {
            console.log('🔍 データアクセステスト開始...');
            
            if (!testBasicAvailability()) {
                return;
            }
            
            const data = window.H384_DATA;
            
            // ランダムエントリアクセステスト
            const randomIndex = Math.floor(Math.random() * data.length);
            const randomEntry = data[randomIndex];
            
            addTestResult('success', 'ランダムアクセス', 
                `✅ インデックス${randomIndex}のデータに正常にアクセスできました`,
                `エントリ詳細:\n通し番号: ${randomEntry['通し番号']}\n卦名: ${randomEntry['卦名']}\n爻: ${randomEntry['爻']}`
            );
            
            // 検索機能テスト
            const searchResult = data.filter(entry => entry['卦名'].includes('乾'));
            addTestResult('info', '検索機能テスト', 
                `🔍 「乾」を含む卦: ${searchResult.length}個見つかりました`
            );
            
            // スコア計算テスト
            if (data.length > 0 && data[0]['S7_総合評価スコア'] !== undefined) {
                const avgScore = data.reduce((sum, entry) => 
                    sum + (entry['S7_総合評価スコア'] || 0), 0) / data.length;
                    
                addTestResult('info', 'スコア統計', 
                    `📈 総合評価スコア平均: ${avgScore.toFixed(2)}点`
                );
            }
            
            // グローバル関数テスト
            if (typeof window.validateH384DataIntegrity === 'function') {
                try {
                    const validationResult = window.validateH384DataIntegrity();
                    addTestResult('success', 'バリデーション関数', 
                        `✅ validateH384DataIntegrity関数が正常に動作しました`,
                        JSON.stringify(validationResult, null, 2)
                    );
                } catch (error) {
                    addTestResult('error', 'バリデーション関数', 
                        `❌ validateH384DataIntegrity関数でエラーが発生: ${error.message}`
                    );
                }
            } else {
                addTestResult('warning', 'バリデーション関数', 
                    '⚠️ validateH384DataIntegrity関数が見つかりません'
                );
            }
        }
        
        /**
         * データサンプル表示
         */
        function showDataSamples() {
            if (!window.H384_DATA || !Array.isArray(window.H384_DATA)) {
                return;
            }
            
            const samplesDiv = document.getElementById('data-samples');
            const data = window.H384_DATA;
            
            // 最初の3エントリを表示
            const samples = data.slice(0, 3);
            
            let html = '<h3>📝 データサンプル (最初の3エントリ)</h3>';
            samples.forEach((entry, index) => {
                html += `
                    <div class="data-sample">
                        <h4>エントリ ${index + 1}: ${entry['卦名']} ${entry['爻']}</h4>
                        <pre>${JSON.stringify(entry, null, 2)}</pre>
                    </div>
                `;
            });
            
            samplesDiv.innerHTML = html;
        }
        
        /**
         * 詳細結果表示
         */
        function showDetailedResults() {
            const detailedDiv = document.getElementById('detailed-results');
            
            if (testResults.length === 0) {
                detailedDiv.innerHTML = '<p>まだテストが実行されていません。</p>';
                return;
            }
            
            let html = '<h3>📈 詳細テスト結果</h3>';
            html += `<p>実行テスト数: ${testResults.length}</p>`;
            
            const successCount = testResults.filter(r => r.type === 'success').length;
            const errorCount = testResults.filter(r => r.type === 'error').length;
            const warningCount = testResults.filter(r => r.type === 'warning').length;
            
            html += `
                <div class="test-summary">
                    <span class="success">✅ 成功: ${successCount}</span>
                    <span class="error">❌ エラー: ${errorCount}</span>
                    <span class="warning">⚠️ 警告: ${warningCount}</span>
                </div>
            `;
            
            detailedDiv.innerHTML = html;
        }
        
        /**
         * 全テスト実行
         */
        function runAllTests() {
            clearResults();
            
            addTestResult('info', 'テスト開始', '🚀 H384データベース全テストを開始します...');
            
            setTimeout(() => {
                testDataIntegrity();
                setTimeout(() => {
                    testYaoEntries();
                    setTimeout(() => {
                        testDataAccess();
                        setTimeout(() => {
                            showDataSamples();
                            showDetailedResults();
                            addTestResult('info', 'テスト完了', '✅ 全テストが完了しました');
                        }, 500);
                    }, 500);
                }, 500);
            }, 500);
        }
        
        /**
         * 結果クリア
         */
        function clearResults() {
            testResults = [];
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('detailed-results').innerHTML = '';
            document.getElementById('data-samples').innerHTML = '';
        }
        
        // ページ読み込み時の初期チェック
        window.addEventListener('load', function() {
            console.log('H384データベーステストページ読み込み完了');
            
            // 基本可用性チェック
            setTimeout(() => {
                addTestResult('info', 'ページ読み込み完了', 'H384データベーステストページが読み込まれました');
                testBasicAvailability();
            }, 1000);
        });
    </script>
</body>
</html>