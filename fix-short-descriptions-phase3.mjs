import { readFile, writeFile } from 'fs/promises';

async function fixPhase3() {
  try {
    console.log('=== フェーズ3: 実用性向上（example, warning, tip, metaphor等） ===\n');
    
    // データベース読み込み
    let content = await readFile('./public/js/data/hexagram-human-traits-v3.js', 'utf-8');
    
    // フェーズ3-A: 矢印形式のexample修正（必須）
    const arrowExampleFixes = {
      '"危機 → 全員集合"': '"危機的状況では全員で協力して対処する"',
      '"問題 → 原点回帰"': '"問題に直面したら基本に立ち返って解決する"',
      '"問題 → 旅に出る"': '"問題から離れて旅に出ることで解決を図る"',
      '"辛い → でも笑顔"': '"辛い時でも笑顔を保って周りを明るくする"'
    };
    
    // フェーズ3-B: 短いwarning修正（29件）
    const warningFixes = {
      '"無謀になりすぎない"': '"無謀な挑戦で大きな失敗をしないよう注意"',
      '"停滞すると濁る"': '"停滞すると心が濁ってしまうので注意"',
      '"刺激過多に注意"': '"刺激が多すぎると疲れてしまうので注意"',
      '"マンネリに注意"': '"同じことの繰り返しでマンネリ化に注意"',
      '"頂点での孤独"': '"頂点に立つと孤独を感じやすいことに注意"',
      '"表現の機会も必要"': '"内に籠りすぎず表現の機会も必要"',
      '"孤立しないように"': '"独自性を追求しすぎて孤立しないよう注意"',
      '"我慢しすぎに注意"': '"我慢しすぎて心身を壊さないよう注意"',
      '"自由すぎて迷子に"': '"自由すぎて目的を見失わないよう注意"',
      '"自己犠牲しすぎない"': '"自己犠牲が過度にならないよう注意が必要"',
      '"拡大しすぎに注意"': '"拡大しすぎて収拾がつかなくなることに注意"',
      '"独断的にならない"': '"独断的な決定で周りを困らせないよう注意"',
      '"縁に振り回されない"': '"多すぎる縁に振り回されないよう注意"',
      '"集めすぎに注意"': '"物や人を集めすぎて混乱しないよう注意"',
      '"急ぎすぎない"': '"焦って急ぎすぎると失敗するので注意"',
      '"無理な困難は避ける"': '"無理な困難に挑んで消耗しないよう注意"',
      '"枯渇しないように"': '"与えすぎて自分が枯渇しないよう注意"',
      '"変革だけにならない"': '"変革ばかりで建設的でなくならないよう注意"',
      '"押し付けにならない"': '"自分の影響を押し付けないよう注意"',
      '"空元気に注意"': '"無理な明るさで本音を隠さないよう注意"',
      '"散漫になりすぎない"': '"分散しすぎて散漫にならないよう注意"',
      '"窮屈になりすぎない"': '"制限しすぎて窮屈にならないよう注意"',
      '"飛び級は危険"': '"段階を飛ばすと危険なので着実に進む"',
      '"おせっかいに注意"': '"過度なおせっかいで嫌われないよう注意"',
      '"豊作貧乏に注意"': '"豊かでも使い方を間違えないよう注意"',
      '"根無し草にならない"': '"旅ばかりで根無し草にならないよう注意"',
      '"完璧主義の罠"': '"完璧を求めすぎて前に進めなくなる罠に注意"',
      '"完成を恐れない"': '"完成を恐れて永遠に未完にしないよう注意"'
    };
    
    // フェーズ3-C: 短いtip修正（28件）
    const tipFixes = {
      '"時には熟考も必要"': '"素早い決断も良いが時には熟考も必要"',
      '"初心を忘れずに"': '"経験を積んでも初心を忘れずに保つこと"',
      '"心の健康も大切に"': '"体の健康だけでなく心の健康も大切に"',
      '"計算されたリスクを"': '"無謀ではなく計算されたリスクを取る"',
      '"常に流れ続けよう"': '"水のように常に流れ続けることが大切"',
      '"適度に燃料補給を"': '"燃え尽きないよう適度に燃料補給をする"',
      '"感度調整を学ぼう"': '"感受性の感度調整を学ぶことが大切"',
      '"撤退も戦略の一つ"': '"時には撤退も有効な戦略の一つである"',
      '"力と技のバランスを"': '"力だけでなく技術とのバランスが大切"',
      '"内と外のバランスを"': '"内面と外面のバランスを保つことが大切"',
      '"家族も大切に"': '"仕事だけでなく家族との時間も大切に"',
      '"最後は心で勝負"': '"論理だけでなく最後は心で勝負する"',
      '"時には逃げても良い"': '"無理して頑張らず時には逃げても良い"',
      '"与えることは受け取ること"': '"与えることで自分も豊かになれる"',
      '"決断は素早く、実行は丁寧に"': '"決断は素早く、でも実行は丁寧に"',
      '"必要な縁だけで十分"': '"多くの縁より必要な縁だけで十分"',
      '"みんなの力を信じよう"': '"一人で抱えずみんなの力を信じる"',
      '"成長は螺旋状"': '"成長は直線でなく螺旋状に進む"',
      '"基本が最も大切"': '"高度な技術より基本が最も大切"',
      '"共に乗り越える"': '"困難は一人でなく共に乗り越える"',
      '"枯れない工夫を"': '"源泉が枯れないような工夫が必要"',
      '"創造的な変革を"': '"破壊的でなく創造的な変革を心がける"',
      '"触媒になろう"': '"混ぜるのでなく触媒となって変化を促す"',
      '"緩急をつけて"': '"常に全力でなく緩急をつけて進む"',
      '"精度より速度の時も"': '"時には精度より速度を優先すべき"',
      '"完成と始まりは表裏一体"': '"物事の完成は新たな始まりでもある"',
      '"永遠の未完成も美しい"': '"完成しないことに美しさがある"'
    };
    
    // フェーズ3-D: 短いmetaphor修正（最短のもの）
    const metaphorFixes = {
      '"孤高の戦士"': '"孤高の道を行く一匹狼の戦士"',
      '"社交界の蝶"': '"社交界を華やかに舞う蝶のような存在"',
      '"優れた仲人"': '"人と人を結ぶ優れた仲人役"',
      '"永遠の旅人"': '"永遠に旅を続ける自由な魂"',
      '"心のレーダー"': '"相手の気持ちを感じ取る心のレーダー"',
      '"城を守る領主"': '"獲得した城を守り抜く領主のような存在"',
      '"解放の伝道師"': '"人々を束縛から解放する伝道師"',
      '"明確な判断力"': '"曇りのない明確な判断を下す刀"',
      '"根っこに戻る"': '"迷ったら根っこに戻って考え直す"',
      '"枯れない井戸"': '"どんな時も枯れない豊かな井戸"',
      '"革命のリーダー"': '"変革を導く革命のリーダー"',
      '"フィニッシャー"': '"物事を確実に完成させるフィニッシャー"',
      '"未来を見る予言者"': '"常に未来を見据える予言者のような存在"',
      '"永遠に未完成"': '"永遠に未完成のまま進化し続ける"',
      '"カリスマ的な存在感"': '"周りを圧倒するカリスマ的な存在感"',
      '"能ある鷹は爪を隠す"': '"実力を隠して謙虚に振る舞う"',
      '"保護色で隠れる"': '"保護色で環境に溶け込んで身を守る"',
      '"家という城に籠る"': '"家という安全な城に籠って守る"',
      '"壁に正面から向き合う"': '"困難という壁に正面から向き合う"',
      '"鎖を断ち切って逃走"': '"束縛の鎖を断ち切って自由になる"',
      '"身代わりになる"': '"他者のために身代わりになる覚悟"',
      '"不要なものを断つ"': '"不要なものを断ち切る決断力"',
      '"必要な縁だけ残す"': '"本当に必要な縁だけを大切に残す"',
      '"磁石のような求心力"': '"人を引き寄せる磁石のような求心力"',
      '"群れで身を守る"': '"一人でなく群れで身を守る知恵"',
      '"成長を見守る園丁"': '"植物の成長を見守る園丁のような存在"',
      '"戦友のような絆"': '"困難を共に乗り越えた戦友のような絆"',
      '"井戸に蓋をする"': '"必要な時は井戸に蓋をして守る"',
      '"備蓄で乗り切る"': '"蓄えた備蓄で困難を乗り切る"',
      '"実り豊かな大地"': '"常に実り豊かな大地のような存在"',
      '"世界を渡る自由人"': '"国境を越えて世界を渡る自由人"',
      '"問題から旅立つ"': '"問題から物理的に旅立って解決する"',
      '"隙間から逃げる風"': '"どんな隙間からも逃げられる風"',
      '"太陽のような明るさ"': '"周りを照らす太陽のような明るさ"',
      '"涙を笑顔で隠す"': '"内なる涙を笑顔で隠す強さ"',
      '"霧のように消える"': '"危険を感じたら霧のように消える"',
      '"アイスブレイカー"': '"固い雰囲気を溶かすアイスブレイカー"',
      '"ダムの水量調整"': '"感情をダムのように調整する能力"',
      '"優れた調停者"': '"対立を解決する優れた調停者"',
      '"安全弁のような働き"': '"圧力を逃がす安全弁のような存在"',
      '"心と心を繋ぐ橋"': '"人と人の心を繋ぐ大切な橋"',
      '"信頼の絆で守られる"': '"強い信頼の絆で守られている"',
      '"鍵を何度も確認"': '"不安で鍵を何度も確認してしまう"',
      '"未完成が許せない"': '"物事が未完成なことが許せない性質"'
    };
    
    // その他の短い説明の一般的な修正
    const generalFixes = {
      // howTo系の修正例
      '"自分を知る"': '"まず自分自身を深く知ることから始める"',
      '"相手を理解"': '"相手の立場や気持ちを理解するよう努める"',
      '"適度な距離"': '"相手との適度な距離感を保つことが大切"',
      '"正直に話す"': '"素直に正直に自分の気持ちを話す"',
      '"共感を示す"': '"相手の気持ちに共感を示すことが重要"',
      '"論理的に説明"': '"感情でなく論理的に説明することが効果的"',
      '"実績で示す"': '"言葉より実績で能力を示すことが大切"',
      '"静かに待つ"': '"焦らず静かに機会を待つことが重要"',
      '"段階的に進める"': '"一気にではなく段階的に進めることが大切"',
      '"バランスを取る"': '"極端にならずバランスを取ることが重要"'
    };
    
    // バックアップ作成
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    await writeFile(`./public/js/data/hexagram-human-traits-v3.backup.phase3.${timestamp}.js`, content);
    console.log(`📁 バックアップ作成: hexagram-human-traits-v3.backup.phase3.${timestamp}.js\n`);
    
    // 修正適用
    let totalFixCount = 0;
    
    // 各カテゴリの修正を適用
    const applyFixes = (fixes, category) => {
      console.log(`【${category}の修正】`);
      let count = 0;
      Object.entries(fixes).forEach(([old, newText]) => {
        const regex = new RegExp(old.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
        const originalContent = content;
        content = content.replace(regex, newText);
        if (originalContent !== content) {
          count++;
          console.log(`✅ ${old} → ${newText}`);
        }
      });
      console.log(`  小計: ${count}件\n`);
      return count;
    };
    
    totalFixCount += applyFixes(arrowExampleFixes, '矢印形式example');
    totalFixCount += applyFixes(warningFixes, 'warning');
    totalFixCount += applyFixes(tipFixes, 'tip');
    totalFixCount += applyFixes(metaphorFixes, 'metaphor');
    totalFixCount += applyFixes(generalFixes, '一般的な短い説明');
    
    // ファイル保存
    await writeFile('./public/js/data/hexagram-human-traits-v3.js', content);
    
    console.log(`=== フェーズ3完了 ===`);
    console.log(`総修正件数: ${totalFixCount}件`);
    console.log(`\n✅ 全フェーズ完了！`);
    console.log(`最終確認: node comprehensive-v3-review.mjs`);
    
  } catch (error) {
    console.error('エラー:', error);
  }
}

fixPhase3();