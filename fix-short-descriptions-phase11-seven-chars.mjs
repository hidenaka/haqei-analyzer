import { readFile, writeFile } from 'fs/promises';

async function fixPhase11SevenChars() {
  try {
    console.log('=== フェーズ11: 7文字の説明94件を一行一行修正 ===\n');
    
    // データベース読み込み
    let content = await readFile('./public/js/data/hexagram-human-traits-v3.js', 'utf-8');
    
    // 7文字の説明を一行一行丁寧に修正（94件）
    const sevenCharFixes = {
      // エネルギー・活動系
      '"エネルギー温存"': '"エネルギーを温存して備える"',
      '"力を蓄える時間"': '"力を蓄える大切な時間"',
      '"創造の準備期間"': '"創造のための準備期間"',
      '"内省と関係整理"': '"内省して関係を整理する時間"',
      
      // 場所・環境系
      '"その場を離れる"': '"その場を離れて距離を置く"',
      '"にぎやかな環境"': '"にぎやかで活気のある環境"',
      '"変化のある環境"': '"変化に富んだ刺激的な環境"',
      '"変化のない環境"': '"変化の少ない安定した環境"',
      '"安心できる場所"': '"心から安心できる場所"',
      '"完成できる環境"': '"物事を完成できる環境"',
      '"創作できる環境"': '"自由に創作できる環境"',
      
      // 人間関係系
      '"たくさんの仲間"': '"たくさんの仲間に囲まれる"',
      '"与えてくれる人"': '"惜しみなく与えてくれる人"',
      '"共に頑張る仲間"': '"共に頑張れる仲間たち"',
      '"みんなとの時間"': '"みんなと過ごす楽しい時間"',
      '"信頼できる相手"': '"深く信頼できる相手"',
      
      // 行動・対処系
      '"何が必要か聞く"': '"何が必要かを丁寧に聞く"',
      '"前の段階に戻る"': '"前の段階に戻って確認する"',
      '"問題から逃げる"': '"問題から逃げてしまいがち"',
      '"困難を克服する"': '"困難を着実に克服する"',
      '"完成させて満足"': '"物事を完成させて満足する"',
      '"作品完成で満足"': '"作品を完成させて満足する"',
      
      // リスク・問題系
      '"リスクが大きい"': '"リスクが大きくなりやすい"',
      '"何も完成しない"': '"何も完成できない状態"',
      '"周囲も巻き込む"': '"周囲も巻き込んでしまう"',
      
      // 能力・強み系
      '"ミスを防ぐ存在"': '"ミスを防ぐ頼れる存在"',
      '"場を和ませる力"': '"場を和ませる特別な力"',
      
      // 感情・喜び系
      '"信頼される喜び"': '"信頼される大きな喜び"',
      
      // コミュニケーション系
      '"中途半端、妥協"': '"中途半端や妥協が苦手"',
      
      // その他の対象系
      '"完成させる対象"': '"完成させるべき対象"',
      
      // 残りの7文字項目（metaphor以外）
      '"縁を紡ぐ織り手"': '"縁を紡ぐ織り手のような存在"',
      '"素困難な出会い"': '"素晴らしい出会いに恵まれる"',
      '"新しい縁で回復"': '"新しい縁を得て回復する"',
      '"拡大成長の喜び"': '"拡大成長を実感する喜び"',
      '"限定的、消極的"': '"限定的で消極的になりがち"',
      '"発展的な環境"': '"発展的で成長できる環境"',
      '"革命的な変化"': '"革命的な変化を起こす力"',
      '"保守的な傾向"': '"保守的になりやすい傾向"',
      '"破壊的になる"': '"破壊的になりすぎる危険"',
      '"革新的な人々"': '"革新的な発想を持つ人々"',
      '"新しい方法論"': '"新しい方法論を開発する"',
      '"知識の体系化"': '"知識を体系的に整理する"',
      '"論理的、教育的"': '"論理的で教育的な話し方"',
      '"理論派の人々"': '"理論を重視する人々"',
      '"実践力に欠ける"': '"実践力に欠ける傾向がある"',
      '"知的な刺激"': '"知的な刺激を受ける環境"',
      '"豊富な資源"': '"豊富な資源を活用する"',
      '"蓄積と管理"': '"資源の蓄積と管理が得意"',
      '"使い切れない"': '"資源を使い切れない傾向"',
      '"管理能力ある人"': '"優れた管理能力を持つ人"',
      '"栄養補給の喜び"': '"栄養を補給する喜び"',
      '"世話焼き、お節介"': '"世話焼きやお節介が苦手"',
      '"与える側の人々"': '"与える側に立つ人々"',
      '"過食の傾向"': '"過食になりやすい傾向"',
      '"栄養豊富な環境"': '"栄養豊富で健康的な環境"',
      '"共感と同調"': '"深い共感と同調を示す"',
      '"感覚的で直感的"': '"感覚的で直感的な話し方"',
      '"感受性の高い人々"': '"感受性の高い繊細な人々"',
      '"論理性に欠ける"': '"論理性に欠ける傾向がある"',
      '"着実な前進"': '"着実に前進し続ける力"',
      '"長期的、段階的"': '"長期的で段階的な計画が苦手"',
      '"継続力のある人々"': '"継続力を持つ人々"',
      '"即効性を求める"': '"即効性を求めすぎる傾向"',
      '"安定成長の環境"': '"安定的に成長できる環境"',
      '"突破と破壊"': '"突破と破壊を同時に行う"',
      '"攻撃的、破壊的"': '"攻撃的で破壊的な面が出やすい"',
      '"強烈な個性の人々"': '"強烈な個性を持つ人々"',
      '"周囲との衝突"': '"周囲と衝突しやすい"',
      '"自由な表現の場"': '"自由に表現できる場所"',
      '"過去の再現"': '"過去を再現しようとする"',
      '"懐古的、保守的"': '"懐古的で保守的な話し方"',
      '"歴史を重んじる人"': '"歴史を重んじる人々"',
      '"前進できない"': '"前に進めない状態になる"',
      '"位置の最適化"': '"位置を最適化する能力"',
      '"空間的、配置的"': '"空間的で配置を重視する話し方"',
      '"整理整頓の達人"': '"整理整頓が得意な人"',
      '"混乱しやすい"': '"状況が混乱しやすい"',
      '"整然とした環境"': '"整然と整理された環境"',
      '"内なる充実"': '"内なる充実感を得る"',
      '"控えめで謙虚"': '"控えめで謙虚な話し方"',
      '"内面重視の人々"': '"内面を重視する人々"',
      '"アピール不足"': '"自己アピールが不足しがち"',
      '"個性の発揮"': '"個性を存分に発揮する"',
      '"独特で個性的"': '"独特で個性的な話し方"',
      '"変わり者の集まり"': '"個性的な変わり者の集まり"',
      '"浮いてしまう"': '"周りから浮いてしまいやすい"',
      '"異質な統合"': '"異質なものを統合する力"',
      '"対比的、対照的"': '"対比的で対照的な話し方"',
      '"違いを認める人々"': '"違いを認め合える人々"',
      '"まとまらない"': '"意見がまとまらない傾向"'
    };
    
    // バックアップ作成
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    await writeFile(`./public/js/data/hexagram-human-traits-v3.backup.phase11.${timestamp}.js`, content);
    console.log(`📁 バックアップ作成: hexagram-human-traits-v3.backup.phase11.${timestamp}.js\n`);
    
    // 修正適用
    let totalFixCount = 0;
    let successfulFixes = [];
    
    console.log('7文字の修正を適用中...\n');
    
    Object.entries(sevenCharFixes).forEach(([old, newText]) => {
      const regex = new RegExp(old.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      const matches = content.match(regex);
      if (matches) {
        content = content.replace(regex, newText);
        totalFixCount += matches.length;
        successfulFixes.push(`${old} → ${newText} (${matches.length}箇所)`);
      }
    });
    
    // 成功した修正を表示（最初の20件）
    console.log('【修正成功項目】');
    successfulFixes.slice(0, 20).forEach(fix => {
      console.log(`✅ ${fix}`);
    });
    if (successfulFixes.length > 20) {
      console.log(`... 他 ${successfulFixes.length - 20}件`);
    }
    
    // ファイル保存
    await writeFile('./public/js/data/hexagram-human-traits-v3.js', content);
    
    console.log(`\n=== フェーズ11完了 ===`);
    console.log(`総修正件数: ${totalFixCount}件`);
    console.log(`修正成功項目: ${successfulFixes.length}種類`);
    console.log(`\n次のフェーズ: node fix-short-descriptions-phase12-eight-chars.mjs`);
    
  } catch (error) {
    console.error('エラー:', error);
  }
}

fixPhase11SevenChars();