# Triple OS 64卦分散ロジック改善記録
記録日: 2025年8月8日

## 改善内容

### 1. Engine OS改善
- **動的重み付け計算**: `calculateEngineDynamicWeights()`を追加
  - 創造性vs伝統性、行動性vs適応性のバランスで重み調整
  - 極端な偏りを防ぐバランス調整機能
- **確率的三爻選択**: `selectEngineTrigramsStochastic()`を実装
  - ソフトマックス関数による確率分布生成
  - 温度パラメータ0.4で適度なランダム性
  - 三爻間相互作用チェック機能
- **シグモイド変換**: 中間値を抑制し極値を強調

### 2. Interface OS改善
- **動的スケーリング**: 既存の実装を保持・強化
  - リーダーシップ、サポート性、コミュニケーション重視のコンテキスト適応
  - シグモイド変換（k=4）で差別化強化
- **確率的選択**: 既存実装済み（温度0.3）

### 3. SafeMode OS改善
- **確率的防御三爻選択**: `selectDefensiveTrigrams()`を改善
  - 温度パラメータ0.35で安定性重視
  - 防御パターンの妥当性チェック
- **動的重み付け**: `calculateSafeModeDynamicWeights()`を追加
  - 対抗性、回避性、境界性、撤退性に応じた重み調整

### 4. 64卦マトリックス修正
```javascript
const authenticHexagramMatrix = [
    [1,  43, 14, 34,  9,  5, 26, 11],  // 乾上
    [10, 58, 38, 54, 61, 60, 41, 19],  // 兌上
    [13, 49, 30, 55, 37, 63, 22, 36],  // 離上
    [25, 17, 21, 51, 42,  3, 27, 24],  // 震上
    [44, 28, 50, 32, 57, 48, 18, 46],  // 巽上
    [6,  47, 64, 40, 59, 29,  4,  7],  // 坎上
    [33, 31, 56, 62, 53, 39, 52, 15],  // 艮上
    [12, 45, 35, 16, 20,  8, 23,  2]   // 坤上
];
```
重複を排除し、64卦すべてをカバー可能に

### 5. 三爻間相互作用係数
`getTrigramInteraction()`関数を追加
- 易経の原理に基づく相互作用（例：乾-坤は1.5、坎-離は1.4）
- 弱い相互作用の組み合わせを自動調整

## 技術的改善点

1. **確率的選択の導入**
   - 決定論的な上位2つ選択から確率的選択へ
   - 同一回答パターンでも異なる結果が出る可能性

2. **動的重み付けシステム**
   - 静的な係数から文脈依存の動的係数へ
   - ユーザーの回答パターンに応じた適応的調整

3. **非線形変換の活用**
   - シグモイド関数による中間値抑制
   - エネルギー分布の差別化強化

## 期待効果

- **理論的カバレッジ**: 64卦の80%以上（51卦以上）
- **実用的分散**: 各OSで40種類以上の卦が出現
- **ユーザー体験**: 同じ回答でも異なる結果で再診断の価値向上

## 次回セッション向けメモ

改善実装は完了。テスト実行時の要注意点：
- セレクタの確認（#startButton等が存在しない可能性）
- 開発サーバー起動確認（localhost:3001）
- MCP Playwrightの複数インスタンス問題に注意

## ファイル変更箇所

`os_analyzer.html`:
- 2024-2052行: calculateTrigramEnergies改善
- 2054-2106行: calculateEngineDynamicWeights追加
- 2108-2161行: selectEngineTrigramsStochastic追加
- 2163-2171行: getTrigramInteraction追加
- 2190-2198行: authenticHexagramMatrix修正
- 2616-2659行: calculateDefensiveTrigramEnergies改善
- 2661-2696行: calculateSafeModeDynamicWeights追加
- 2668-2716行: selectDefensiveTrigrams改善
- 3150-3232行: Interface OS動的スケーリング（既存）
- 3276-3334行: Interface OS確率的選択（既存）