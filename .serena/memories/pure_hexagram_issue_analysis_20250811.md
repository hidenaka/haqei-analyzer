# 純卦出現率異常の分析と報告
## 実施日: 2025-01-11

## 🚨 発見された重要な問題

### ユーザーからの指摘
「純8卦ばっかりが出やすくなってないですか？」という重要な指摘を受けて、診断ロジック全体を詳細に分析。

### 問題の実態
理論値12.5%（8/64）に対して、実装上の問題により**純卦が17-25%出現**している可能性がある。

## 📊 問題の原因分析

### 1. ReLU活性化の最小値保証（主要因）
```javascript
// os_analyzer.html: 3507行
activated[key] = Math.max(0.01, value);  // すべての八卦に最低0.01を保証
```
- 負のZ-scoreを持つ八卦も必ず正の値を持つ
- 本来0になるべき八卦も候補に残る
- エネルギーが集中すべき時に分散してしまう

### 2. 均等分散フォールバック
```javascript
// os_analyzer.html: 3515行
normalized[key] = sum > 0 ? value / sum : 0.125;  // 全て均等12.5%
```
- 入力が平坦な場合、すべての八卦が均等値
- ランダムに近い選択となり、同一八卦選択の確率上昇

### 3. OS別重み付けの偏り
```javascript
// os_analyzer.html: 3519-3532行
const OS_WEIGHTS = {
    engine: {
        "乾": 1.2,  // 20%増幅
        "坤": 0.8   // 20%減衰
    }
};
```
- 特定の八卦（乾、離、坎）が構造的に優遇
- これらの純卦も出やすくなる

### 4. 上位2卦選択の単純性
```javascript
// os_analyzer.html: 3257-3265行
const sortedBagua = Object.entries(baguaEnergies)
    .sort(([, a], [, b]) => b - a)
    .slice(0, 2);

const topBagua1 = sortedBagua[0][0];
const topBagua2 = sortedBagua[1][0];  // 常に1位と2位
```
- エネルギーが1つの八卦に集中した場合の考慮なし
- 1位と2位が同じ八卦になる可能性を排除していない

## 🔧 作成した検証ツール

### 1. expert-consultation-diagnostic-logic-report.md
- 診断ロジック全体の詳細分析
- 問題点の技術的説明
- 修正案の提示
- 専門家への質問事項

### 2. pure-hexagram-test.html
- 純卦出現率の実測テストツール
- 100/1000/10000回のシミュレーション実行
- 統計的検定（Z検定、カイ二乗検定）
- リアルタイム可視化

## 📈 推定される影響

| 純卦 | 理論確率 | 推定実測確率 | 影響度 |
|------|---------|-------------|--------|
| 乾為天 | 1.56% | 3-5% | 2-3倍 |
| 坎為水 | 1.56% | 3-4% | 2倍 |
| 離為火 | 1.56% | 3-4% | 2倍 |
| **合計** | **12.5%** | **17-25%** | **1.5-2倍** |

## 🔧 提案した修正案

### 即時修正案
1. **ReLU活性化の削除**
   ```javascript
   // 修正前: activated[key] = Math.max(0.01, value);
   // 修正後: activated[key] = value;  // 負値を許容
   ```

2. **純卦ペナルティ**
   ```javascript
   if (upper === lower && Math.random() < 0.5) {
       lower = sortedBagua[2][0];  // 50%の確率で3位を選択
   }
   ```

### 根本的改善案
1. **確率的選択モデル**
   - Softmaxベースの重み付きサンプリング
   - 重複なし選択の保証

2. **閾値ベース選択**
   - 1位と2位の差が小さい場合は2位と3位を選択
   - エネルギー集中時の対応

## 📝 専門家への相談事項

1. **純卦の適正出現率**
   - ユーザー体験上の理想的な純卦率は？
   - 易経の伝統的解釈での位置づけ

2. **診断の一貫性vs多様性**
   - 同じ回答で異なる結果の許容度
   - 決定論的vs確率論的アプローチ

3. **正規化手法**
   - 最適な正規化手法の選択
   - 温度パラメータの理想値

## 🎯 次のアクション

1. **検証テストの実行**
   - pure-hexagram-test.htmlで実測値確認
   - 統計的有意性の確認

2. **修正実装**
   - ReLU活性化の見直し
   - 選択アルゴリズムの改善

3. **A/Bテストでの検証**
   - 修正前後の比較
   - ユーザー満足度への影響測定

## 所感
ユーザーの鋭い観察により、実装上の重要な問題が発見された。純卦が理論値より多く出現することは、診断の多様性を損ない、ユーザー体験を低下させる可能性がある。早急な修正が必要。