# 進爻・変爻実装ロジック詳細調査結果

**調査日**: 2025年8月13日  
**調査者**: I Ching Expert Agent (Claude Code)  
**対象**: HaQei Future Simulatorの進爻・変爻システム

## 🎯 ユーザー説明による正しいロジック

### 正確な進爻・変爻定義

**ユーザー提供の正しいロジック**：

1. **初期状態**: 状況の卦と爻が決定される（各卦・爻にはキーワードがある）

2. **各フェーズでの選択肢**：
   - **進爻**: 卦と爻のキーワードテーマに沿った行動 → 爻位が1つ上がる
   - **変爻**: 違うテーマを選ぶ → 卦が変わり、爻は元のまま

3. **3回の繰り返し**：
   - フェーズ1: 初期状況→進爻/変爻選択→新しい卦・爻
   - フェーズ2: フェーズ1結果→進爻/変爻選択→新しい卦・爻  
   - フェーズ3: フェーズ2結果→進爻/変爻選択→最終卦・爻

4. **結果**: 2³=8通りの最終状況（卦・爻の組み合わせ）

## 📋 セレナの記録から判明した実装状況

### 現在の実装（v2.2.0）

#### 1. 実装済みクラス構造
```
js/iching/
├── KingWenMapping.js - 変爻計算（正確な之卦計算）
├── LineSelector.js - 爻位選択ルール
├── AdvanceProcessor.js - 進爻処理
└── MultiLineInterpreter.js - 複数爻解釈
```

#### 2. 進爻ロジック（AdvanceProcessor.js）
- **定義**: 同一卦内での成熟・発展段階の進行
- **処理**: 爻位+1（例: 3爻→4爻）
- **制限**: 6爻到達で進爻不可
- **段階名**: 萌芽期→基礎形成期→実行開始期→展開期→成熟期→完成期

#### 3. 変爻ロジック（KingWenMapping.js）
- **定義**: 陰陽反転による之卦への変化
- **処理**: 指定爻の陰陽反転（0↔1）
- **計算**: King Wen順序による正確な64卦マッピング
- **結果**: 新しい卦番号と爻配列

#### 4. 8パターン生成（EightScenariosGenerator.js v2.2.0）
```javascript
const basePatterns = [
    { id: 1, approach: 'proactive', title: '積極的前進', type: 'advance' },
    { id: 2, approach: 'adaptive', title: '適応的前進', type: 'advance' },
    { id: 3, approach: 'transformative', title: '段階的変革', type: 'transform' },
    { id: 4, approach: 'decisive', title: '決断的変革', type: 'transform' },
    { id: 5, approach: 'strengthening', title: '強化安定化', type: 'advance' },
    { id: 6, approach: 'harmonizing', title: '調和安定化', type: 'advance' },
    { id: 7, approach: 'integrative', title: '統合的発展', type: 'transform' },
    { id: 8, approach: 'innovative', title: '革新的探索', type: 'transform' }
];
```

### v2要件との対比

#### ❌ 現在の問題点
1. **固定8パターン**: テンプレート化されたパターン
2. **3フェーズシステム未実装**: 一発生成のみ
3. **ユーザー選択なし**: 自動生成のみ
4. **2³=8通り未対応**: 進爻/変爻の選択による組み合わせ未実装

#### ✅ v2要件（セレナ記録より）
> 進爻（advance）と変爻（transform）を中心に、固定化されたプロセス定義に頼らず、その時点の本卦・爻位とH384のキーワードから動的に8パターンの未来を生成する

## 🔧 必要な実装作業

### 1. 3フェーズシステム実装
- **PhaseManager.js**: フェーズ管理クラス
- **ChoicePresenter.js**: 進爻・変爻選択UI
- **StateTracker.js**: 各フェーズの状態追跡

### 2. キーワードテーマシステム
- **H384データ連携**: 卦・爻のキーワード取得
- **ThemeGenerator.js**: キーワードベースの選択肢生成
- **ContextAnalyzer.js**: ユーザー入力との関連性分析

### 3. 8通り結果システム
- **CombinationGenerator.js**: 2³組み合わせ生成
- **ResultPresenter.js**: 8通りの結果表示
- **ComparisonView.js**: パス比較表示

### 4. データ整合性強化
- **H384DatabaseAdapter.js**: H384データベース統合
- **ValidationEngine.js**: 卦・爻番号検証
- **ErrorHandling.js**: エラー処理とフォールバック

## 📊 実装優先度

### 高優先度（即座実装）
1. **PhaseManager**: 3フェーズ管理システム
2. **H384連携**: キーワード取得システム
3. **基本的な進爻・変爻選択UI**

### 中優先度（次フェーズ）
1. **8通り結果表示**
2. **選択肢生成ロジック**
3. **状態遷移管理**

### 低優先度（改善・最適化）
1. **UI/UX改善**
2. **パフォーマンス最適化**
3. **エラーハンドリング**

## 💡 技術的考察

### 実装の核心問題
1. **フェーズ管理**: JavaScript状態管理の複雑性
2. **UI設計**: 3段階選択プロセスのユーザビリティ
3. **データ同期**: H384との整合性維持
4. **計算処理**: リアルタイムでの8通り計算

### 推奨アーキテクチャ
- **イベント駆動**: フェーズ遷移をイベントで管理
- **ステートマシン**: 明確な状態定義
- **コンポーネント分離**: UI・ロジック・データの分離
- **プログレッシブ実装**: 段階的機能追加

---

**結論**: 現在のv2.2.0実装は基礎は整っているが、ユーザーが説明した「3フェーズ×進爻/変爻選択→8通り結果」システムは未実装。セレナの記録からも固定テンプレートから動的生成への移行が必要であることが確認された。

**次のステップ**: PhaseManagerクラスの実装から着手し、段階的に3フェーズシステムを構築する必要がある。