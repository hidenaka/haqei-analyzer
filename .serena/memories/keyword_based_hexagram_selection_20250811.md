## キーワードベース64卦選択ロジック実装 - 2025-08-11

### 実装背景

#### ユーザーの指摘
- 現在の「上卦=外向き、下卦=内向き」という固定ロジックは易経の実際の意味と合致しない
- 上位2つの三爻の組み合わせから、キーワードを使って最適な卦を選ぶべき

### 実装したロジック

#### 1. 候補生成
```javascript
// 上位2つの三爻を取得
const topTrigram1 = sortedTrigrams[0][0];  // 例: "乾_創造性"
const topTrigram2 = sortedTrigrams[1][0];  // 例: "坎_探求性"

// 2つの可能な組み合わせ
候補1: 乾（上卦）+ 坎（下卦）= 卦6「天水訟」
候補2: 坎（上卦）+ 乾（下卦）= 卦5「水天需」
```

#### 2. キーワード抽出
各候補の卦番号からH384_DATAのキーワードを取得：
```javascript
卦6「天水訟」: ['葛藤', '知恵', '議論', '建設的', '学習', ...]
卦5「水天需」: ['待つ', '忍耐', 'タイミング', '準備', '機会', ...]
```

#### 3. 適合度計算 (calculateKeywordFitness)

##### OSタイプ別キーワードパターン

**Engine OS（内なる価値観）**
```javascript
high: ['創造', '探求', '成長', '学習', '目標', '意志', '価値', '潜在', '基礎', '発展']
medium: ['内省', '思索', '理想', '本質', '核心', '動機', '原点']
low: ['外交', '社交', '表面', '外観']  // ネガティブスコア
```

**Interface OS（対人関係）**
```javascript
high: ['調和', '協力', '信頼', '交流', '共感', '理解', '関係', 'コミュニケーション', '共同', '和合']
medium: ['柔軟', '適応', '対話', '交渉', '仲間', 'チーム']
low: ['孤立', '孤独', '内向', '閉鎖']  // ネガティブスコア
```

**Safe Mode OS（防御システム）**
```javascript
high: ['安定', '保護', '慎重', '忍耐', '回復', '防御', '休息', '内省', '静', '守り']
medium: ['抑制', '制御', '節度', 'バランス', '調整', '維持']
low: ['攻撃', '拡張', '冒険', '無謀']  // ネガティブスコア
```

##### スコア計算式
```javascript
// 各キーワードをマッチング
高優先度マッチ: +3点
中優先度マッチ: +2点
低優先度マッチ: -1点

// 正規化（キーワード数の影響を軽減）
normalizedScore = score / Math.sqrt(totalKeywords)

// 三爻エネルギーボーナス
finalScore = normalizedScore + (最強三爻エネルギー * 0.1)
```

#### 4. 選択ロジック
```javascript
if (score1 >= score2) {
    候補1を選択
} else {
    候補2を選択
}
```

### 実装の効果

#### Before（固定ロジック）
- Engine OS → 常に「内的動機」の組み合わせ
- Interface OS → 常に「調和的」な組み合わせ  
- Safe Mode OS → 常に「安定的」な組み合わせ

#### After（キーワードベース）
- 実際の卦の意味（H384_DATA）に基づいて選択
- OSタイプに最適なキーワードを持つ卦を選択
- 易経の実際の意味と一致する結果

### 具体例

**Engine OSの場合**
```
候補1: 天水訟（#6）
キーワード: ['葛藤', '知恵', '議論', '建設的', '学習']
スコア: 学習(+3) + 知恵(+2) = 5点

候補2: 水天需（#5）
キーワード: ['待つ', '忍耐', 'タイミング', '準備', '機会']
スコア: 忍耐(+0) + 準備(+2) = 2点

結果: 候補1（天水訟）を選択
```

### コンソールログ出力
```javascript
🎯 engine OS 卦選択: {
    候補1: "乾_創造性/坎_探求性 (#6)",
    キーワード1: ["葛藤", "知恵", "議論", "建設的", "学習"],
    スコア1: 5.2,
    候補2: "坎_探求性/乾_創造性 (#5)",
    キーワード2: ["待つ", "忍耐", "タイミング", "準備", "機会"],
    スコア2: 2.1,
    選択: "候補1"
}
```

### 今後の改善可能性
1. キーワードパターンの精緻化
2. 重み付けの調整（現在は3/2/-1）
3. 複数の卦候補（上位3つ以上）の検討
4. ユーザーの回答傾向を直接反映