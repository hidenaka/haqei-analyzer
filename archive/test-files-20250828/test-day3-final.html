<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 3 最終統合テスト - バランス改善</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4; 
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        .summary { 
            background: #2d2d30; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .excellent { color: #4ec9b0; font-weight: bold; }
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #cccccc;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th {
            background: #252526;
            color: #4ec9b0;
        }
        
        .balance-chart {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 5px;
        }
        
        .bar-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .bar-label {
            width: 80px;
            font-weight: bold;
        }
        
        .bar {
            height: 25px;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            margin: 0 10px;
            border-radius: 3px;
            position: relative;
        }
        
        .bar-value {
            position: absolute;
            right: 10px;
            line-height: 25px;
            color: #1e1e1e;
            font-weight: bold;
        }
        
        .ideal-line {
            position: absolute;
            left: 16.67%;
            height: 100%;
            border-left: 2px dashed #f48771;
        }
        
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #569cd6;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <h1>Day 3 最終統合テスト - バランス改善結果</h1>
    
    <div class="summary">
        <h2>📊 Day 3 実施内容まとめ</h2>
        <ul>
            <li>✅ 2爻: キーワード削減（25→15個）、重み調整（0.48→0.43）</li>
            <li>✅ 6爻: キーワード削減（26→15個）、重み調整（0.45→0.40）</li>
            <li>✅ 3爻: キーワード追加（+10個）、重み強化（0.52→0.58）</li>
            <li>✅ 4爻: キーワード追加（+10個）、重み強化（0.55→0.60）</li>
            <li>✅ 5爻: Day 2での改善維持（選択率6-8%）</li>
        </ul>
    </div>
    
    <div id="loading">テスト実行中... (200サンプル処理)</div>
    <div id="metrics" style="display: none;"></div>
    <div id="results" style="display: none;"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        async function loadTestData() {
            const response = await fetch('test-samples-200-categorized.json');
            return await response.json();
        }
        
        async function runFinalTest() {
            const testData = await loadTestData();
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                totalSamples: 0,
                positionCounts: [0, 0, 0, 0, 0, 0, 0],
                uniqueLines: new Set(),
                categoryBreakdown: {},
                improvements: {
                    day2: { yao5Rate: 0 },
                    day3: { balance: [] }
                }
            };
            
            // 全サンプルを処理
            for (const [category, samples] of Object.entries(testData.samples)) {
                results.categoryBreakdown[category] = {
                    total: 0,
                    positions: [0, 0, 0, 0, 0, 0, 0]
                };
                
                for (const text of samples) {
                    const result = await bridge.analyzeText(text);
                    const lineKey = `${result.hexagram_number}-${result.line_position}`;
                    
                    results.uniqueLines.add(lineKey);
                    results.positionCounts[result.line_position]++;
                    results.categoryBreakdown[category].total++;
                    results.categoryBreakdown[category].positions[result.line_position]++;
                    results.totalSamples++;
                }
            }
            
            // 統計計算
            const stats = calculateStatistics(results);
            
            // 表示
            displayResults(results, stats);
            
            console.log('Day 3最終結果:', { results, stats });
        }
        
        function calculateStatistics(results) {
            const total = results.totalSamples;
            const ideal = 16.67;
            
            const stats = {
                total: total,
                coverageRate: ((results.uniqueLines.size / 384) * 100).toFixed(2),
                uniqueLines: results.uniqueLines.size,
                positions: []
            };
            
            // 各位置の統計
            for (let i = 1; i <= 6; i++) {
                const count = results.positionCounts[i];
                const percent = (count / total * 100);
                const deviation = percent - ideal;
                
                stats.positions.push({
                    position: i,
                    count: count,
                    percent: percent.toFixed(1),
                    deviation: deviation.toFixed(1),
                    status: Math.abs(deviation) <= 3 ? 'excellent' : 
                           Math.abs(deviation) <= 5 ? 'good' : 
                           Math.abs(deviation) <= 8 ? 'warning' : 'bad'
                });
            }
            
            // χ²検定
            const expectedCount = total / 6;
            stats.chiSquare = stats.positions.reduce((sum, pos) => 
                sum + Math.pow(pos.count - expectedCount, 2) / expectedCount, 0).toFixed(2);
            
            // 5爻選択率
            stats.yao5Rate = ((results.positionCounts[5] / total) * 100).toFixed(1);
            
            return stats;
        }
        
        function displayResults(results, stats) {
            // ローディング非表示
            document.getElementById('loading').style.display = 'none';
            
            // メトリクス表示
            let metricsHtml = '<div class="metrics-grid">';
            
            // カバー率
            const coverageClass = parseFloat(stats.coverageRate) >= 10 ? 'excellent' : 
                                 parseFloat(stats.coverageRate) >= 8 ? 'good' : 'warning';
            metricsHtml += `
                <div class="metric-card">
                    <div class="metric-label">カバー率</div>
                    <div class="metric-value ${coverageClass}">${stats.coverageRate}%</div>
                    <div class="metric-label">目標: 10-15%</div>
                </div>`;
            
            // 5爻選択率
            const yao5Class = parseFloat(stats.yao5Rate) >= 5 ? 'excellent' : 
                             parseFloat(stats.yao5Rate) >= 3 ? 'good' : 'warning';
            metricsHtml += `
                <div class="metric-card">
                    <div class="metric-label">5爻選択率</div>
                    <div class="metric-value ${yao5Class}">${stats.yao5Rate}%</div>
                    <div class="metric-label">目標: 5-10%</div>
                </div>`;
            
            // χ²値（バランス指標）
            const chiClass = parseFloat(stats.chiSquare) <= 5 ? 'excellent' : 
                            parseFloat(stats.chiSquare) <= 10 ? 'good' : 'warning';
            metricsHtml += `
                <div class="metric-card">
                    <div class="metric-label">バランス指標(χ²)</div>
                    <div class="metric-value ${chiClass}">${stats.chiSquare}</div>
                    <div class="metric-label">理想: < 5.0</div>
                </div>`;
            
            metricsHtml += '</div>';
            document.getElementById('metrics').innerHTML = metricsHtml;
            document.getElementById('metrics').style.display = 'block';
            
            // 詳細結果
            let resultsHtml = '';
            
            // バランスチャート
            resultsHtml += '<div class="balance-chart">';
            resultsHtml += '<h2>📊 位置別分布バランス</h2>';
            
            for (const pos of stats.positions) {
                const barWidth = Math.min(parseFloat(pos.percent) * 4, 100);
                resultsHtml += `
                    <div class="bar-container">
                        <div class="bar-label">${pos.position}爻</div>
                        <div style="position: relative; width: 100%; background: #1e1e1e;">
                            <div class="bar" style="width: ${barWidth}%;">
                                <div class="bar-value">${pos.percent}%</div>
                            </div>
                            <div class="ideal-line" style="left: ${16.67 * 4}%;"></div>
                        </div>
                        <span class="${pos.status}" style="margin-left: 10px;">
                            ${pos.deviation > 0 ? '+' : ''}${pos.deviation}%
                        </span>
                    </div>`;
            }
            resultsHtml += '<p style="color: #f48771; text-align: center;">--- 理想値: 16.67% ---</p>';
            resultsHtml += '</div>';
            
            // 改善結果サマリー
            resultsHtml += '<div class="summary">';
            resultsHtml += '<h2>🎯 Day 3 達成状況</h2>';
            
            // 目標達成チェック
            const balanceAchieved = stats.positions.filter(p => Math.abs(parseFloat(p.deviation)) <= 5).length >= 5;
            const coverageProgress = parseFloat(stats.coverageRate) >= 8;
            const yao5Maintained = parseFloat(stats.yao5Rate) >= 5;
            
            if (balanceAchieved && coverageProgress && yao5Maintained) {
                resultsHtml += '<p class="excellent" style="font-size: 1.3em;">✅ Day 3の全目標を達成！</p>';
            }
            
            resultsHtml += '<ul>';
            resultsHtml += `<li class="${balanceAchieved ? 'good' : 'warning'}">
                            位置バランス: ${balanceAchieved ? '✅ 改善成功' : '⚠️ さらなる調整必要'}</li>`;
            resultsHtml += `<li class="${coverageProgress ? 'good' : 'warning'}">
                            カバー率: ${stats.coverageRate}% ${coverageProgress ? '✅' : '⚠️'}</li>`;
            resultsHtml += `<li class="${yao5Maintained ? 'good' : 'warning'}">
                            5爻選択率: ${stats.yao5Rate}% ${yao5Maintained ? '✅ 維持' : '⚠️ 低下'}</li>`;
            resultsHtml += '</ul>';
            resultsHtml += '</div>';
            
            // カテゴリ別詳細
            resultsHtml += '<div class="summary">';
            resultsHtml += '<h2>📋 カテゴリ別詳細</h2>';
            resultsHtml += '<table>';
            resultsHtml += '<tr><th>カテゴリ</th><th>1爻</th><th>2爻</th><th>3爻</th><th>4爻</th><th>5爻</th><th>6爻</th></tr>';
            
            for (const [category, data] of Object.entries(results.categoryBreakdown)) {
                resultsHtml += '<tr>';
                resultsHtml += `<td>${category}</td>`;
                for (let i = 1; i <= 6; i++) {
                    const count = data.positions[i];
                    const percent = (count / data.total * 100).toFixed(0);
                    resultsHtml += `<td>${count} (${percent}%)</td>`;
                }
                resultsHtml += '</tr>';
            }
            resultsHtml += '</table>';
            resultsHtml += '</div>';
            
            document.getElementById('results').innerHTML = resultsHtml;
            document.getElementById('results').style.display = 'block';
        }
        
        runFinalTest();
    </script>
</body>
</html>