<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 3 æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆ - ãƒãƒ©ãƒ³ã‚¹æ”¹å–„</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4; 
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        .summary { 
            background: #2d2d30; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .excellent { color: #4ec9b0; font-weight: bold; }
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #cccccc;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th {
            background: #252526;
            color: #4ec9b0;
        }
        
        .balance-chart {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 5px;
        }
        
        .bar-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .bar-label {
            width: 80px;
            font-weight: bold;
        }
        
        .bar {
            height: 25px;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            margin: 0 10px;
            border-radius: 3px;
            position: relative;
        }
        
        .bar-value {
            position: absolute;
            right: 10px;
            line-height: 25px;
            color: #1e1e1e;
            font-weight: bold;
        }
        
        .ideal-line {
            position: absolute;
            left: 16.67%;
            height: 100%;
            border-left: 2px dashed #f48771;
        }
        
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #569cd6;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <h1>Day 3 æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆ - ãƒãƒ©ãƒ³ã‚¹æ”¹å–„çµæœ</h1>
    
    <div class="summary">
        <h2>ğŸ“Š Day 3 å®Ÿæ–½å†…å®¹ã¾ã¨ã‚</h2>
        <ul>
            <li>âœ… 2çˆ»: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å‰Šæ¸›ï¼ˆ25â†’15å€‹ï¼‰ã€é‡ã¿èª¿æ•´ï¼ˆ0.48â†’0.43ï¼‰</li>
            <li>âœ… 6çˆ»: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰å‰Šæ¸›ï¼ˆ26â†’15å€‹ï¼‰ã€é‡ã¿èª¿æ•´ï¼ˆ0.45â†’0.40ï¼‰</li>
            <li>âœ… 3çˆ»: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¿½åŠ ï¼ˆ+10å€‹ï¼‰ã€é‡ã¿å¼·åŒ–ï¼ˆ0.52â†’0.58ï¼‰</li>
            <li>âœ… 4çˆ»: ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¿½åŠ ï¼ˆ+10å€‹ï¼‰ã€é‡ã¿å¼·åŒ–ï¼ˆ0.55â†’0.60ï¼‰</li>
            <li>âœ… 5çˆ»: Day 2ã§ã®æ”¹å–„ç¶­æŒï¼ˆé¸æŠç‡6-8%ï¼‰</li>
        </ul>
    </div>
    
    <div id="loading">ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­... (200ã‚µãƒ³ãƒ—ãƒ«å‡¦ç†)</div>
    <div id="metrics" style="display: none;"></div>
    <div id="results" style="display: none;"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        async function loadTestData() {
            const response = await fetch('test-samples-200-categorized.json');
            return await response.json();
        }
        
        async function runFinalTest() {
            const testData = await loadTestData();
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                totalSamples: 0,
                positionCounts: [0, 0, 0, 0, 0, 0, 0],
                uniqueLines: new Set(),
                categoryBreakdown: {},
                improvements: {
                    day2: { yao5Rate: 0 },
                    day3: { balance: [] }
                }
            };
            
            // å…¨ã‚µãƒ³ãƒ—ãƒ«ã‚’å‡¦ç†
            for (const [category, samples] of Object.entries(testData.samples)) {
                results.categoryBreakdown[category] = {
                    total: 0,
                    positions: [0, 0, 0, 0, 0, 0, 0]
                };
                
                for (const text of samples) {
                    const result = await bridge.analyzeText(text);
                    const lineKey = `${result.hexagram_number}-${result.line_position}`;
                    
                    results.uniqueLines.add(lineKey);
                    results.positionCounts[result.line_position]++;
                    results.categoryBreakdown[category].total++;
                    results.categoryBreakdown[category].positions[result.line_position]++;
                    results.totalSamples++;
                }
            }
            
            // çµ±è¨ˆè¨ˆç®—
            const stats = calculateStatistics(results);
            
            // è¡¨ç¤º
            displayResults(results, stats);
            
            console.log('Day 3æœ€çµ‚çµæœ:', { results, stats });
        }
        
        function calculateStatistics(results) {
            const total = results.totalSamples;
            const ideal = 16.67;
            
            const stats = {
                total: total,
                coverageRate: ((results.uniqueLines.size / 384) * 100).toFixed(2),
                uniqueLines: results.uniqueLines.size,
                positions: []
            };
            
            // å„ä½ç½®ã®çµ±è¨ˆ
            for (let i = 1; i <= 6; i++) {
                const count = results.positionCounts[i];
                const percent = (count / total * 100);
                const deviation = percent - ideal;
                
                stats.positions.push({
                    position: i,
                    count: count,
                    percent: percent.toFixed(1),
                    deviation: deviation.toFixed(1),
                    status: Math.abs(deviation) <= 3 ? 'excellent' : 
                           Math.abs(deviation) <= 5 ? 'good' : 
                           Math.abs(deviation) <= 8 ? 'warning' : 'bad'
                });
            }
            
            // Ï‡Â²æ¤œå®š
            const expectedCount = total / 6;
            stats.chiSquare = stats.positions.reduce((sum, pos) => 
                sum + Math.pow(pos.count - expectedCount, 2) / expectedCount, 0).toFixed(2);
            
            // 5çˆ»é¸æŠç‡
            stats.yao5Rate = ((results.positionCounts[5] / total) * 100).toFixed(1);
            
            return stats;
        }
        
        function displayResults(results, stats) {
            // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
            document.getElementById('loading').style.display = 'none';
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
            let metricsHtml = '<div class="metrics-grid">';
            
            // ã‚«ãƒãƒ¼ç‡
            const coverageClass = parseFloat(stats.coverageRate) >= 10 ? 'excellent' : 
                                 parseFloat(stats.coverageRate) >= 8 ? 'good' : 'warning';
            metricsHtml += `
                <div class="metric-card">
                    <div class="metric-label">ã‚«ãƒãƒ¼ç‡</div>
                    <div class="metric-value ${coverageClass}">${stats.coverageRate}%</div>
                    <div class="metric-label">ç›®æ¨™: 10-15%</div>
                </div>`;
            
            // 5çˆ»é¸æŠç‡
            const yao5Class = parseFloat(stats.yao5Rate) >= 5 ? 'excellent' : 
                             parseFloat(stats.yao5Rate) >= 3 ? 'good' : 'warning';
            metricsHtml += `
                <div class="metric-card">
                    <div class="metric-label">5çˆ»é¸æŠç‡</div>
                    <div class="metric-value ${yao5Class}">${stats.yao5Rate}%</div>
                    <div class="metric-label">ç›®æ¨™: 5-10%</div>
                </div>`;
            
            // Ï‡Â²å€¤ï¼ˆãƒãƒ©ãƒ³ã‚¹æŒ‡æ¨™ï¼‰
            const chiClass = parseFloat(stats.chiSquare) <= 5 ? 'excellent' : 
                            parseFloat(stats.chiSquare) <= 10 ? 'good' : 'warning';
            metricsHtml += `
                <div class="metric-card">
                    <div class="metric-label">ãƒãƒ©ãƒ³ã‚¹æŒ‡æ¨™(Ï‡Â²)</div>
                    <div class="metric-value ${chiClass}">${stats.chiSquare}</div>
                    <div class="metric-label">ç†æƒ³: < 5.0</div>
                </div>`;
            
            metricsHtml += '</div>';
            document.getElementById('metrics').innerHTML = metricsHtml;
            document.getElementById('metrics').style.display = 'block';
            
            // è©³ç´°çµæœ
            let resultsHtml = '';
            
            // ãƒãƒ©ãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆ
            resultsHtml += '<div class="balance-chart">';
            resultsHtml += '<h2>ğŸ“Š ä½ç½®åˆ¥åˆ†å¸ƒãƒãƒ©ãƒ³ã‚¹</h2>';
            
            for (const pos of stats.positions) {
                const barWidth = Math.min(parseFloat(pos.percent) * 4, 100);
                resultsHtml += `
                    <div class="bar-container">
                        <div class="bar-label">${pos.position}çˆ»</div>
                        <div style="position: relative; width: 100%; background: #1e1e1e;">
                            <div class="bar" style="width: ${barWidth}%;">
                                <div class="bar-value">${pos.percent}%</div>
                            </div>
                            <div class="ideal-line" style="left: ${16.67 * 4}%;"></div>
                        </div>
                        <span class="${pos.status}" style="margin-left: 10px;">
                            ${pos.deviation > 0 ? '+' : ''}${pos.deviation}%
                        </span>
                    </div>`;
            }
            resultsHtml += '<p style="color: #f48771; text-align: center;">--- ç†æƒ³å€¤: 16.67% ---</p>';
            resultsHtml += '</div>';
            
            // æ”¹å–„çµæœã‚µãƒãƒªãƒ¼
            resultsHtml += '<div class="summary">';
            resultsHtml += '<h2>ğŸ¯ Day 3 é”æˆçŠ¶æ³</h2>';
            
            // ç›®æ¨™é”æˆãƒã‚§ãƒƒã‚¯
            const balanceAchieved = stats.positions.filter(p => Math.abs(parseFloat(p.deviation)) <= 5).length >= 5;
            const coverageProgress = parseFloat(stats.coverageRate) >= 8;
            const yao5Maintained = parseFloat(stats.yao5Rate) >= 5;
            
            if (balanceAchieved && coverageProgress && yao5Maintained) {
                resultsHtml += '<p class="excellent" style="font-size: 1.3em;">âœ… Day 3ã®å…¨ç›®æ¨™ã‚’é”æˆï¼</p>';
            }
            
            resultsHtml += '<ul>';
            resultsHtml += `<li class="${balanceAchieved ? 'good' : 'warning'}">
                            ä½ç½®ãƒãƒ©ãƒ³ã‚¹: ${balanceAchieved ? 'âœ… æ”¹å–„æˆåŠŸ' : 'âš ï¸ ã•ã‚‰ãªã‚‹èª¿æ•´å¿…è¦'}</li>`;
            resultsHtml += `<li class="${coverageProgress ? 'good' : 'warning'}">
                            ã‚«ãƒãƒ¼ç‡: ${stats.coverageRate}% ${coverageProgress ? 'âœ…' : 'âš ï¸'}</li>`;
            resultsHtml += `<li class="${yao5Maintained ? 'good' : 'warning'}">
                            5çˆ»é¸æŠç‡: ${stats.yao5Rate}% ${yao5Maintained ? 'âœ… ç¶­æŒ' : 'âš ï¸ ä½ä¸‹'}</li>`;
            resultsHtml += '</ul>';
            resultsHtml += '</div>';
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥è©³ç´°
            resultsHtml += '<div class="summary">';
            resultsHtml += '<h2>ğŸ“‹ ã‚«ãƒ†ã‚´ãƒªåˆ¥è©³ç´°</h2>';
            resultsHtml += '<table>';
            resultsHtml += '<tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>1çˆ»</th><th>2çˆ»</th><th>3çˆ»</th><th>4çˆ»</th><th>5çˆ»</th><th>6çˆ»</th></tr>';
            
            for (const [category, data] of Object.entries(results.categoryBreakdown)) {
                resultsHtml += '<tr>';
                resultsHtml += `<td>${category}</td>`;
                for (let i = 1; i <= 6; i++) {
                    const count = data.positions[i];
                    const percent = (count / data.total * 100).toFixed(0);
                    resultsHtml += `<td>${count} (${percent}%)</td>`;
                }
                resultsHtml += '</tr>';
            }
            resultsHtml += '</table>';
            resultsHtml += '</div>';
            
            document.getElementById('results').innerHTML = resultsHtml;
            document.getElementById('results').style.display = 'block';
        }
        
        runFinalTest();
    </script>
</body>
</html>