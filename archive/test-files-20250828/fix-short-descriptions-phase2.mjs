import { readFile, writeFile } from 'fs/promises';

async function fixPhase2() {
  try {
    console.log('=== フェーズ2: 重要フィールド改善 開始 ===\n');
    console.log('対象: whatHappens + profile.description フィールド\n');
    
    // データベース読み込み
    let content = await readFile('./public/js/data/hexagram-human-traits-v3.js', 'utf-8');
    
    // フェーズ2の修正マッピング - whatHappens（状態説明）
    const whatHappensFixes = {
      // 6-7文字
      '"根本から変えて解決"': '"根本から問題を変革して解決する"',
      '"既存の枠組みを変える"': '"既存の枠組みを根本から変革する"',
      '"ひたすら耐える"': '"どんな困難もひたすら耐え抜く"',
      '"楽しいことを考える"': '"楽しいことを考えて気分を高める"',
      '"抵抗せず流れに乗る"': '"無理に抵抗せず自然の流れに任せる"',
      '"環境に完全に同化"': '"環境に完全に適応して溶け込む"',
      '"次の改善対象を探す"': '"次に改善すべき対象を探し続ける"',
      '"緊急修復モード起動"': '"緊急事態に修復モードで対応する"',
      '"完全に引きこもる"': '"外界から完全に身を引いて内省する"',
      
      // 8-9文字
      '"考える前に体が動く"': '"考えるより先に体が自然に動き出す"',
      '"次の行動の準備運動"': '"次の行動に向けて準備運動をしている"',
      '"とにかく動いて解決"': '"とにかく行動することで問題を解決する"',
      '"全力で動き回る"': '"全力で動き回って状況を打開する"',
      '"常に学ぶ姿勢を持つ"': '"常に謙虚に学ぶ姿勢を持ち続けている"',
      '"次の変革の種を探す"': '"次の変革の種を探し続けている状態"',
      '"どっしりと構える"': '"どっしりと構えて動じない姿勢を保つ"',
      '"完全に不動の構え"': '"完全に不動の構えで安定を保つ"',
      '"一段ずつ確実に上る"': '"一段ずつ確実にステップを上っていく"',
      '"計画的に段階を踏む"': '"計画的に一つずつ段階を踏んで進む"',
      '"次のレベルへ進化"': '"次のレベルへと着実に進化していく"',
      '"常に何かを生産"': '"常に何かを生み出し続けている"',
      '"常に次を求める"': '"常に次の目標を求め続けている"',
      '"更なる高みを目指す"': '"さらなる高みを目指して努力する"',
      '"全てを未完にする"': '"全てを未完のまま次へ進んでいく"',
      '"常に完成を目指す"': '"常に物事の完成を目指して努力する"',
      '"完成への執念"': '"物事を完成させることへの強い執念"',
      '"新しいことを始める"': '"困難な時こそ新しいことを始める"',
      
      // その他の短い whatHappens
      '"静かに内面を磨く"': '"静かに自分の内面を磨き続けている"',
      '"隠れた才能が開花"': '"隠れていた才能が開花する瞬間"',
      '"目立たないよう潜む"': '"目立たないように静かに潜んでいる"',
      '"完全に姿を消す"': '"完全に存在感を消して身を守る"',
      '"家族を守るため全力"': '"家族を守るために全力を尽くす"',
      '"職場も家族のように"': '"職場の人々も家族のように大切にする"',
      '"家族に相談、頼る"': '"困った時は家族に相談して頼る"',
      '"家族全員で対処"': '"家族全員で協力して問題に対処する"',
      '"個性を全開に発揮"': '"自分の個性を全開に発揮する"',
      '"独自の方法で対処"': '"独自の方法で問題に対処する"',
      '"完全に独立行動"': '"完全に独立して行動する"',
      '"黙って耐える"': '"どんな苦難も黙って耐え抜く"',
      '"石のように動かない"': '"石のように微動だにしない状態"',
      '"束縛から逃げ出す"': '"あらゆる束縛から逃げ出そうとする"',
      '"全てを捨てて逃げる"': '"全てを捨てて自由になろうとする"',
      '"全てを捧げて助ける"': '"全てを捧げて他者を助けようとする"',
      '"完全に自己犠牲"': '"完全に自己犠牲の精神で行動する"',
      '"危機を最大の機会に"': '"危機を最大の成長機会に変える"',
      '"問題を切り捨てる"': '"不要な問題を切り捨てて進む"',
      '"全てを断ち切る"': '"しがらみを全て断ち切って前進する"',
      '"人や物を集める"': '"必要な人や物を集めている状態"',
      '"強力な求心力を発揮"': '"強力な求心力を発揮して人を集める"',
      '"仲間を集めて対処"': '"仲間を集めて問題に対処する"',
      '"全員で立ち向かう"': '"全員で一丸となって立ち向かう"',
      '"毎日少しずつ成長"': '"毎日少しずつ着実に成長している"',
      '"急成長を遂げる"': '"短期間で急成長を遂げる"',
      '"基礎から見直す"': '"問題の基礎から丁寧に見直す"',
      '"成長を一時停止"': '"成長を一時停止して守りに入る"',
      '"困難を探して挑む"': '"あえて困難を探して挑戦する"',
      '"全力で困難と頑張る"': '"全力で困難に立ち向かっていく"',
      '"常に何かを提供"': '"常に何かを周りに提供している"',
      '"無限の供給力"': '"無限とも思える供給力を発揮する"',
      '"供給を制限"': '"必要に応じて供給を制限する"',
      '"完全に供給停止"': '"完全に供給を停止して守る"',
      '"常に変革の種を探す"': '"常に変革の種を探し続けている"',
      '"既存の体制を覆す"': '"既存の体制を根本から覆そうとする"',
      '"根本から変える"': '"問題を根本から変革しようとする"',
      '"革命的行動"': '"革命的な行動で変化を起こす"'
    };
    
    // profile.description（性質説明）の修正
    const profileDescriptionFixes = {
      // 短い説明
      '"動いて打開する"': '"行動することで問題を打開しようとする性質"',
      '"一歩ずつ確実に成長"': '"着実に一歩ずつ成長を重ねていく性質"',
      '"迷わず決めて実行"': '"迷うことなく決断して即座に実行する性質"',
      '"山のように動じない"': '"山のように動じない安定した性質"',
      '"一段ずつ確実に上る"': '"一段ずつ確実に階段を上っていく性質"',
      '"人と人を調和させる"': '"人と人の関係を調和させる特別な能力"',
      '"常に限界に挑戦する"': '"常に自分の限界に挑戦し続ける性質"',
      '"深い信頼関係を築く"': '"人と深い信頼関係を築ける特別な能力"',
      '"力強さで周りを圧倒"': '"力強さで周りを圧倒する存在感"',
      '"力で全てを解決"': '"強い力で全ての問題を解決しようとする"',
      '"獲得した地位を守る"': '"一度獲得した地位を守り抜く性質"',
      '"目立たないが実力者"': '"目立たないが確かな実力を持つ人"',
      '"目立たず身を守る"': '"目立たないことで自分を守る性質"',
      '"家族に守ってもらう"': '"困った時は家族に守ってもらう性質"',
      '"群れない一匹狼"': '"群れることなく独自の道を行く"',
      '"一人で立ち向かう"': '"どんな困難も一人で立ち向かう"',
      '"ひたすら耐えて守る"': '"どんな圧力もひたすら耐えて守る"',
      '"みんなを自由にする"': '"周りの人々を自由にする力を持つ"',
      '"みんなに変化を促す"': '"周りの人々に変化を促す影響力"',
      '"創造的な関わり方"': '"創造的な方法で人と関わる性質"',
      '"瞬発的な反応で自己防衛する"': '"瞬発的な反応で自己を防衛する能力"',
      '"動かないことで守る"': '"動かないことで自分を守る戦略"',
      '"関係性で身を守る"': '"人間関係を使って身を守る戦略"',
      '"豊かさで守る"': '"蓄えた豊かさで自分を守る"',
      '"旅立つことで守る"': '"その場を離れることで自分を守る"',
      '"笑顔で辛さを隠す"': '"笑顔で内面の辛さを隠す性質"',
      '"感じないことで守る"': '"感覚を遮断することで自分を守る"',
      '"制限をかけて守る"': '"活動を制限することで自分を守る"',
      '"信頼できる人に頼る"': '"信頼できる人にしっかりと頼る"',
      '"みんなで守る"': '"みんなで協力して守り合う"',
      '"基本に戻って守る"': '"基本に戻ることで自分を守る"',
      '"供給を止めて守る"': '"供給を止めることで資源を守る"',
      '"全てを変えて守る"': '"全てを変革することで守る"',
      '"悪縁を断つ"': '"悪い縁を断ち切る決断力"',
      '"困難から逃げない"': '"どんな困難からも逃げない勇気"',
      '"広い人脈を作る"': '"幅広い人脈を構築する能力"',
      '"みんなを集める"': '"人々を集める求心力を持つ"',
      '"場を明るくする"': '"どんな場も明るくする特別な力"',
      '"どこでも誰とでも"': '"どこでも誰とでも関われる柔軟性"',
      '"いつも同じ安心感"': '"いつも同じ安心感を与える存在"'
    };
    
    // バックアップ作成
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    await writeFile(`./public/js/data/hexagram-human-traits-v3.backup.phase2.${timestamp}.js`, content);
    console.log(`📁 バックアップ作成: hexagram-human-traits-v3.backup.phase2.${timestamp}.js`);
    
    // 修正適用
    let fixCount = 0;
    
    // whatHappens修正
    console.log('【whatHappens フィールドの修正】');
    Object.entries(whatHappensFixes).forEach(([old, newText]) => {
      const regex = new RegExp(old.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      const originalContent = content;
      content = content.replace(regex, newText);
      if (originalContent !== content) {
        fixCount++;
        console.log(`✅ ${old} → ${newText}`);
      }
    });
    
    console.log('\n【profile.description フィールドの修正】');
    Object.entries(profileDescriptionFixes).forEach(([old, newText]) => {
      const regex = new RegExp(old.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      const originalContent = content;
      content = content.replace(regex, newText);
      if (originalContent !== content) {
        fixCount++;
        console.log(`✅ ${old} → ${newText}`);
      }
    });
    
    // ファイル保存
    await writeFile('./public/js/data/hexagram-human-traits-v3.js', content);
    
    console.log(`\n=== フェーズ2完了 ===`);
    console.log(`修正件数: ${fixCount}件`);
    console.log(`\n次のステップ:`);
    console.log(`1. node comprehensive-v3-review.mjs で確認`);
    console.log(`2. node fix-short-descriptions-phase3.mjs でフェーズ3実行`);
    
  } catch (error) {
    console.error('エラー:', error);
  }
}

fixPhase2();