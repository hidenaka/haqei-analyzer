<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 6 - 使用頻度分析（Task 6-6）</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1600px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        h3 { color: #dcdcaa; }
        
        .frequency-section {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .frequency-grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 3px;
            margin: 20px 0;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 5px;
        }
        
        .line-cell {
            background: #252526;
            padding: 5px;
            text-align: center;
            border-radius: 2px;
            font-size: 0.8em;
            position: relative;
            min-height: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .line-cell.never { background: #5a1e1e; color: #f48771; }
        .line-cell.rare { background: #4a4a1e; color: #dcdcaa; }
        .line-cell.normal { background: #1a472a; color: #4ec9b0; }
        .line-cell.frequent { background: #2a5a7a; color: #569cd6; }
        
        .line-id { font-weight: bold; }
        .line-count { font-size: 0.9em; margin-top: 2px; }
        
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { background: #252526; }
        
        .histogram {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 2px;
            margin: 20px 0;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 5px;
        }
        
        .histogram-bar {
            flex: 1;
            background: linear-gradient(to top, #4ec9b0, #569cd6);
            border-radius: 2px 2px 0 0;
            position: relative;
            min-height: 5px;
        }
        
        .histogram-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.8em;
        }
        
        .distribution-chart {
            margin: 20px 0;
        }
        
        .hexagram-row {
            display: flex;
            align-items: center;
            margin: 5px 0;
        }
        
        .hexagram-label {
            width: 100px;
            font-size: 0.9em;
        }
        
        .hexagram-bar {
            height: 20px;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Day 6 - 使用頻度分析（Task 6-6）</h1>
    
    <div id="analysis"></div>
    
    <script type="module">
        // 384爻の詳細な使用頻度分析
        async function analyzeFrequencyDistribution() {
            // TextTo384LinesBridgeを動的にロード
            const script = document.createElement('script');
            script.src = './public/js/ai/TextTo384LinesBridge.js';
            await new Promise(resolve => {
                script.onload = resolve;
                document.head.appendChild(script);
            });
            
            const bridge = new window.TextTo384LinesBridge();
            await bridge.initialize();
            
            // 500サンプルで徹底的な分析
            const testSamples = generateExtensiveTestSamples(500);
            
            // 384爻それぞれの使用頻度を記録
            const lineFrequency = {};
            for (let i = 1; i <= 384; i++) {
                lineFrequency[i] = 0;
            }
            
            // 追加の統計情報
            const statistics = {
                hexagramFrequency: {},
                positionFrequency: [0, 0, 0, 0, 0, 0, 0],
                consecutiveSelections: {},
                patterns: {
                    sameHexagram: 0,
                    samePosition: 0,
                    ascending: 0,
                    descending: 0
                }
            };
            
            let html = '';
            html += '<div class="frequency-section">';
            html += '<h2>📊 500サンプル頻度分析実行中...</h2>';
            html += '<div id="progress">0/500 完了</div>';
            html += '</div>';
            
            document.getElementById('analysis').innerHTML = html;
            
            let previousResult = null;
            
            for (let i = 0; i < testSamples.length; i++) {
                const result = await bridge.analyzeText(testSamples[i]);
                const lineId = (result.hexagram_number - 1) * 6 + result.line_position;
                
                lineFrequency[lineId]++;
                
                // 卦頻度
                if (!statistics.hexagramFrequency[result.hexagram_number]) {
                    statistics.hexagramFrequency[result.hexagram_number] = 0;
                }
                statistics.hexagramFrequency[result.hexagram_number]++;
                
                // 位置頻度
                statistics.positionFrequency[result.line_position]++;
                
                // 連続選択パターンの検出
                if (previousResult) {
                    if (result.hexagram_number === previousResult.hexagram_number) {
                        statistics.patterns.sameHexagram++;
                    }
                    if (result.line_position === previousResult.line_position) {
                        statistics.patterns.samePosition++;
                    }
                    
                    const prevLineId = (previousResult.hexagram_number - 1) * 6 + previousResult.line_position;
                    if (lineId === prevLineId + 1) {
                        statistics.patterns.ascending++;
                    } else if (lineId === prevLineId - 1) {
                        statistics.patterns.descending++;
                    }
                }
                
                previousResult = result;
                
                // プログレス更新
                if ((i + 1) % 50 === 0) {
                    document.getElementById('progress').innerText = `${i + 1}/500 完了`;
                }
            }
            
            // 分析結果の表示
            displayFrequencyAnalysis(lineFrequency, statistics, testSamples.length);
        }
        
        function displayFrequencyAnalysis(lineFrequency, statistics, totalSamples) {
            let html = '';
            
            // 概要統計
            html += '<div class="frequency-section">';
            html += '<h2>📈 使用頻度分析結果サマリー</h2>';
            
            const usedLines = Object.values(lineFrequency).filter(f => f > 0).length;
            const neverUsedLines = Object.values(lineFrequency).filter(f => f === 0).length;
            const maxFrequency = Math.max(...Object.values(lineFrequency));
            const minFrequency = Math.min(...Object.values(lineFrequency).filter(f => f > 0));
            const avgFrequency = totalSamples / 384;
            
            html += '<div class="statistics-grid">';
            
            html += '<div class="stat-card">';
            html += '<div>使用された爻</div>';
            html += `<div class="stat-value ${usedLines >= 50 ? 'good' : 'warning'}">${usedLines}/384</div>`;
            html += `<div>カバー率: ${((usedLines / 384) * 100).toFixed(1)}%</div>`;
            html += '</div>';
            
            html += '<div class="stat-card">';
            html += '<div>未使用の爻</div>';
            html += `<div class="stat-value ${neverUsedLines <= 340 ? 'good' : 'bad'}">${neverUsedLines}個</div>`;
            html += `<div>${((neverUsedLines / 384) * 100).toFixed(1)}%が未使用</div>`;
            html += '</div>';
            
            html += '<div class="stat-card">';
            html += '<div>使用頻度の偏差</div>';
            html += `<div class="stat-value warning">${maxFrequency}回</div>`;
            html += `<div>最大 vs 平均${avgFrequency.toFixed(1)}回</div>`;
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            // 384爻のヒートマップ
            html += '<div class="frequency-section">';
            html += '<h2>🗺️ 384爻使用頻度ヒートマップ</h2>';
            html += '<p>各セルは1つの爻を表し、色が使用頻度を示します</p>';
            
            html += '<div style="margin-bottom: 10px;">';
            html += '<span style="display: inline-block; padding: 5px 10px; background: #5a1e1e; color: #f48771; margin-right: 10px;">未使用</span>';
            html += '<span style="display: inline-block; padding: 5px 10px; background: #4a4a1e; color: #dcdcaa; margin-right: 10px;">低頻度(1-2回)</span>';
            html += '<span style="display: inline-block; padding: 5px 10px; background: #1a472a; color: #4ec9b0; margin-right: 10px;">標準(3-5回)</span>';
            html += '<span style="display: inline-block; padding: 5px 10px; background: #2a5a7a; color: #569cd6;">高頻度(6回以上)</span>';
            html += '</div>';
            
            html += '<div class="frequency-grid">';
            
            for (let hexagram = 1; hexagram <= 64; hexagram++) {
                for (let position = 1; position <= 6; position++) {
                    const lineId = (hexagram - 1) * 6 + position;
                    const frequency = lineFrequency[lineId];
                    
                    let className = 'line-cell ';
                    if (frequency === 0) className += 'never';
                    else if (frequency <= 2) className += 'rare';
                    else if (frequency <= 5) className += 'normal';
                    else className += 'frequent';
                    
                    html += `<div class="${className}" title="${hexagram}卦${position}爻">`;
                    html += `<div class="line-id">${hexagram}-${position}</div>`;
                    html += `<div class="line-count">${frequency}回</div>`;
                    html += '</div>';
                }
            }
            
            html += '</div>';
            html += '</div>';
            
            // 頻度分布ヒストグラム
            html += '<div class="frequency-section">';
            html += '<h2>📊 頻度分布ヒストグラム</h2>';
            
            const frequencyBuckets = [0, 0, 0, 0, 0, 0, 0]; // 0, 1-2, 3-4, 5-6, 7-8, 9-10, 11+
            for (const freq of Object.values(lineFrequency)) {
                if (freq === 0) frequencyBuckets[0]++;
                else if (freq <= 2) frequencyBuckets[1]++;
                else if (freq <= 4) frequencyBuckets[2]++;
                else if (freq <= 6) frequencyBuckets[3]++;
                else if (freq <= 8) frequencyBuckets[4]++;
                else if (freq <= 10) frequencyBuckets[5]++;
                else frequencyBuckets[6]++;
            }
            
            html += '<div class="histogram">';
            const maxBucket = Math.max(...frequencyBuckets);
            const bucketLabels = ['0回', '1-2回', '3-4回', '5-6回', '7-8回', '9-10回', '11回+'];
            
            for (let i = 0; i < frequencyBuckets.length; i++) {
                const height = (frequencyBuckets[i] / maxBucket) * 100;
                html += `<div class="histogram-bar" style="height: ${height}%;" title="${frequencyBuckets[i]}個の爻">`;
                html += `<div class="histogram-label">${bucketLabels[i]}</div>`;
                html += '</div>';
            }
            html += '</div>';
            
            html += '<table>';
            html += '<tr><th>頻度範囲</th><th>爻の数</th><th>割合</th></tr>';
            for (let i = 0; i < frequencyBuckets.length; i++) {
                const percentage = ((frequencyBuckets[i] / 384) * 100).toFixed(1);
                html += '<tr>';
                html += `<td>${bucketLabels[i]}</td>`;
                html += `<td>${frequencyBuckets[i]}</td>`;
                html += `<td>${percentage}%</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            html += '</div>';
            
            // ホットスポット分析
            html += '<div class="frequency-section">';
            html += '<h2>🔥 ホットスポット（最頻出爻 TOP10）</h2>';
            
            const sortedLines = Object.entries(lineFrequency)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            html += '<table>';
            html += '<tr><th>順位</th><th>爻ID</th><th>卦・位置</th><th>使用回数</th><th>使用率</th></tr>';
            
            for (let i = 0; i < sortedLines.length; i++) {
                const [lineId, frequency] = sortedLines[i];
                const hexagram = Math.ceil(lineId / 6);
                const position = ((parseInt(lineId) - 1) % 6) + 1;
                const rate = ((frequency / totalSamples) * 100).toFixed(2);
                
                html += '<tr>';
                html += `<td>${i + 1}</td>`;
                html += `<td>#${lineId}</td>`;
                html += `<td>${hexagram}卦${position}爻</td>`;
                html += `<td class="${frequency > 10 ? 'bad' : 'warning'}">${frequency}回</td>`;
                html += `<td>${rate}%</td>`;
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            // コールドスポット分析
            const coldLines = Object.entries(lineFrequency)
                .filter(([id, freq]) => freq === 0)
                .slice(0, 20);
            
            html += '<div class="frequency-section">';
            html += '<h2>❄️ コールドスポット（完全未使用爻）</h2>';
            html += `<p>合計 ${neverUsedLines} 個の爻が一度も選択されていません</p>`;
            
            if (coldLines.length > 0) {
                html += '<div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px;">';
                for (const [lineId] of coldLines) {
                    const hexagram = Math.ceil(lineId / 6);
                    const position = ((parseInt(lineId) - 1) % 6) + 1;
                    
                    html += '<div style="background: #252526; padding: 10px; border-radius: 3px; text-align: center;">';
                    html += `<div style="color: #f48771;">${hexagram}卦${position}爻</div>`;
                    html += `<div style="font-size: 0.8em; color: #808080;">ID: ${lineId}</div>`;
                    html += '</div>';
                }
                html += '</div>';
                
                if (neverUsedLines > 20) {
                    html += `<p style="margin-top: 10px;">他 ${neverUsedLines - 20} 個の未使用爻...</p>`;
                }
            }
            
            html += '</div>';
            
            // パターン分析
            html += '<div class="frequency-section">';
            html += '<h2>🔍 選択パターン分析</h2>';
            
            html += '<table>';
            html += '<tr><th>パターン</th><th>発生回数</th><th>発生率</th></tr>';
            
            const patterns = [
                { name: '同じ卦の連続選択', count: statistics.patterns.sameHexagram },
                { name: '同じ位置の連続選択', count: statistics.patterns.samePosition },
                { name: '昇順選択', count: statistics.patterns.ascending },
                { name: '降順選択', count: statistics.patterns.descending }
            ];
            
            for (const pattern of patterns) {
                const rate = ((pattern.count / (totalSamples - 1)) * 100).toFixed(2);
                html += '<tr>';
                html += `<td>${pattern.name}</td>`;
                html += `<td>${pattern.count}</td>`;
                html += `<td>${rate}%</td>`;
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            // 改善提案
            html += '<div class="frequency-section">';
            html += '<h2>💡 頻度分散の改善提案</h2>';
            
            html += '<h3>主要な問題点</h3>';
            html += '<ul>';
            html += `<li class="bad">未使用爻が多すぎる: ${neverUsedLines}/384 (${((neverUsedLines / 384) * 100).toFixed(1)}%)</li>`;
            html += `<li class="warning">使用頻度の極端な偏り: 最大${maxFrequency}回 vs 平均${avgFrequency.toFixed(1)}回</li>`;
            html += `<li class="warning">特定の爻への集中: TOP10が全体の${((sortedLines.reduce((sum, [, freq]) => sum + freq, 0) / totalSamples) * 100).toFixed(1)}%を占める</li>`;
            html += '</ul>';
            
            html += '<h3>推奨される改善策</h3>';
            html += '<ol>';
            html += '<li><strong>未使用爻への強力なボーナス</strong>: 完全未使用爻に+0.25以上のボーナス</li>';
            html += '<li><strong>高頻度爻への追加ペナルティ</strong>: 10回以上使用で0.1倍まで減衰</li>';
            html += '<li><strong>爻レベルのキーワード再配分</strong>: 未使用爻に独自キーワード追加</li>';
            html += '<li><strong>セマンティックベクトルの個別調整</strong>: 未使用爻のベクトル強化</li>';
            html += '<li><strong>探索ノイズの爻別調整</strong>: コールドスポットに追加ノイズ</li>';
            html += '</ol>';
            
            html += '</div>';
            
            document.getElementById('analysis').innerHTML = html;
        }
        
        function generateExtensiveTestSamples(count) {
            const samples = [];
            
            // 基本カテゴリ
            const categories = [
                '新しい', '始まり', '開始', '協力', '関係', '困難', '問題', '変化',
                '転換', 'リーダー', '管理', '完成', '終了', '決断', '判断', '戦略',
                '計画', '実行', '分析', '評価', '改善', '成長', '発展', '安定',
                '調和', '創造', '革新', '挑戦', '機会', '危機', '成功', '失敗'
            ];
            
            // 動詞
            const verbs = [
                'する', 'なる', 'できる', '始める', '終わる', '続ける', '変える',
                '作る', '考える', '決める', '進める', '戻る', '待つ', '動く'
            ];
            
            // 修飾語
            const modifiers = [
                '新しい', '古い', '大きい', '小さい', '強い', '弱い', '早い', '遅い',
                '良い', '悪い', '多い', '少ない', '高い', '低い', '深い', '浅い'
            ];
            
            // ランダムな組み合わせで多様なサンプルを生成
            while (samples.length < count) {
                // 単純な単語
                if (samples.length % 5 === 0) {
                    samples.push(categories[samples.length % categories.length]);
                }
                // 修飾語 + 名詞
                else if (samples.length % 5 === 1) {
                    const mod = modifiers[samples.length % modifiers.length];
                    const cat = categories[samples.length % categories.length];
                    samples.push(`${mod}${cat}`);
                }
                // 名詞 + 動詞
                else if (samples.length % 5 === 2) {
                    const cat = categories[samples.length % categories.length];
                    const verb = verbs[samples.length % verbs.length];
                    samples.push(`${cat}を${verb}`);
                }
                // フレーズ
                else if (samples.length % 5 === 3) {
                    const cat = categories[samples.length % categories.length];
                    samples.push(`${cat}について考える`);
                }
                // 長文
                else {
                    const cat1 = categories[samples.length % categories.length];
                    const cat2 = categories[(samples.length + 7) % categories.length];
                    samples.push(`${cat1}から${cat2}への移行`);
                }
            }
            
            return samples;
        }
        
        analyzeFrequencyDistribution();
    </script>
</body>
</html>