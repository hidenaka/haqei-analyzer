<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 6 - 全パラメータレビュー（Task 6-1）</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1600px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        h3 { color: #dcdcaa; }
        
        .param-section {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .param-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }
        
        .param-card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
        }
        
        .param-value {
            font-size: 1.2em;
            color: #4ec9b0;
            font-weight: bold;
        }
        
        .param-change {
            color: #dcdcaa;
            font-size: 0.9em;
        }
        
        .improved { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .critical { color: #f48771; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { background: #252526; }
        
        .chart-container {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 5px;
        }
        
        .bar {
            height: 20px;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            margin: 5px 0;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Day 6 - 全パラメータレビュー（Task 6-1）</h1>
    
    <div id="analysis"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        async function analyzeAllParameters() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            // Day 1-5で調整されたパラメータの現状
            const currentParams = {
                positionWeights: {
                    name: '位置重み',
                    values: [
                        { position: 1, initial: 0.50, current: 0.50, change: '維持' },
                        { position: 2, initial: 0.48, current: 0.43, change: 'Day3: -0.05' },
                        { position: 3, initial: 0.52, current: 0.58, change: 'Day3: +0.06' },
                        { position: 4, initial: 0.55, current: 0.60, change: 'Day3: +0.05' },
                        { position: 5, initial: 0.50, current: 0.70, change: 'Day2: +0.20' },
                        { position: 6, initial: 0.45, current: 0.40, change: 'Day3: -0.05' }
                    ]
                },
                explorationNoise: {
                    name: '探索ノイズ',
                    values: [
                        { type: 'primaryNoise', range: '0-0.2', change: 'Day2: 増強' },
                        { type: 'secondaryNoise', range: '0-0.1', change: '追加' },
                        { type: 'tertiaryNoise', range: '0-0.05', change: '追加' },
                        { type: 'unusedBonus', value: 0.20, change: 'Day4: 0.15→0.20' },
                        { type: 'rareBonus', value: 0.10, change: 'Day4: 0.08→0.10' }
                    ]
                },
                semanticWeights: {
                    name: 'セマンティックセグメント重み',
                    values: [
                        { segment: 'hexagram', weight: 1.0, change: '維持' },
                        { segment: 'position', weight: 1.3, change: 'Day4: 1.5→1.3' },
                        { segment: 'text', weight: 2.0, change: 'Day4: 1.8→2.0' },
                        { segment: 'change', weight: 1.1, change: 'Day4: 1.0→1.1' },
                        { segment: 'temporal', weight: 0.8, change: '維持' },
                        { segment: 'context', weight: 1.5, change: 'Day4: 1.2→1.5' }
                    ]
                },
                penaltySystem: {
                    name: '使用頻度ペナルティ',
                    values: [
                        { usage: 1, penalty: 0.90, change: 'Day4: 0.95→0.90' },
                        { usage: 2, penalty: 0.75, change: 'Day4: 0.85→0.75' },
                        { usage: 3, penalty: 0.55, change: 'Day4: 0.70→0.55' },
                        { usage: 4, penalty: 0.35, change: 'Day4: 0.50→0.35' },
                        { usage: 5, penalty: 0.20, change: 'Day4: 新規追加' }
                    ]
                },
                keywordCounts: {
                    name: 'キーワード数',
                    values: [
                        { position: 1, count: 25, change: '維持' },
                        { position: 2, count: 15, change: 'Day3: 25→15' },
                        { position: 3, count: 35, change: 'Day3: 25→35（+10）' },
                        { position: 4, count: 35, change: 'Day3: 25→35（+10）' },
                        { position: 5, count: 45, change: 'Day2: 25→45（+20）' },
                        { position: 6, count: 15, change: 'Day3: 26→15' }
                    ]
                }
            };
            
            // テストサンプルで現状確認
            const testSamples = [
                '新しい挑戦', '協力関係', '困難克服', '変化対応',
                'リーダーシップ', '完成段階', '日常業務', '戦略立案'
            ];
            
            const testResults = {
                positionDistribution: [0, 0, 0, 0, 0, 0, 0],
                uniqueLines: new Set()
            };
            
            for (const sample of testSamples) {
                const result = await bridge.analyzeText(sample);
                testResults.positionDistribution[result.line_position]++;
                testResults.uniqueLines.add(`${result.hexagram_number}-${result.line_position}`);
            }
            
            displayAnalysis(currentParams, testResults);
        }
        
        function displayAnalysis(params, testResults) {
            let html = '';
            
            // サマリー
            html += '<div class="param-section">';
            html += '<h2>📊 Day 1-5 パラメータ調整サマリー</h2>';
            html += '<p>これまでに調整されたすべてのパラメータの現状と、その影響を分析します。</p>';
            html += '</div>';
            
            // 位置重み
            html += '<div class="param-section">';
            html += '<h2>1️⃣ 位置重み（Position Weights）</h2>';
            html += '<table>';
            html += '<tr><th>爻位置</th><th>初期値</th><th>現在値</th><th>変更</th><th>影響</th></tr>';
            
            for (const pw of params.positionWeights.values) {
                const changeClass = pw.change.includes('+') ? 'improved' : 
                                   pw.change.includes('-') ? 'warning' : '';
                const impact = analyzePositionWeightImpact(pw.position, pw.current);
                html += '<tr>';
                html += `<td>${pw.position}爻</td>`;
                html += `<td>${pw.initial.toFixed(2)}</td>`;
                html += `<td class="param-value">${pw.current.toFixed(2)}</td>`;
                html += `<td class="${changeClass}">${pw.change}</td>`;
                html += `<td>${impact}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // 探索ノイズ
            html += '<div class="param-section">';
            html += '<h2>2️⃣ 探索ノイズ（Exploration Noise）</h2>';
            html += '<div class="param-grid">';
            
            for (const noise of params.explorationNoise.values) {
                html += '<div class="param-card">';
                html += `<h3>${noise.type}</h3>`;
                if (noise.value !== undefined) {
                    html += `<div class="param-value">${noise.value}</div>`;
                } else {
                    html += `<div class="param-value">${noise.range}</div>`;
                }
                html += `<div class="param-change">${noise.change}</div>`;
                html += '</div>';
            }
            html += '</div>';
            html += '</div>';
            
            // セマンティック重み
            html += '<div class="param-section">';
            html += '<h2>3️⃣ セマンティックセグメント重み</h2>';
            html += '<div class="chart-container">';
            
            for (const seg of params.semanticWeights.values) {
                const width = seg.weight * 40;
                html += `<div style="margin: 10px 0;">`;
                html += `<div style="display: flex; align-items: center;">`;
                html += `<div style="width: 100px;">${seg.segment}</div>`;
                html += `<div class="bar" style="width: ${width}%;"></div>`;
                html += `<span style="margin-left: 10px;" class="param-value">${seg.weight}</span>`;
                html += `<span style="margin-left: 10px;" class="param-change">${seg.change}</span>`;
                html += `</div>`;
                html += `</div>`;
            }
            html += '</div>';
            html += '</div>';
            
            // ペナルティシステム
            html += '<div class="param-section">';
            html += '<h2>4️⃣ 使用頻度ペナルティ</h2>';
            html += '<table>';
            html += '<tr><th>使用回数</th><th>ペナルティ</th><th>変更</th></tr>';
            
            for (const penalty of params.penaltySystem.values) {
                html += '<tr>';
                html += `<td>${penalty.usage}回</td>`;
                html += `<td class="param-value">${penalty.penalty.toFixed(2)}</td>`;
                html += `<td class="param-change">${penalty.change}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // キーワード数
            html += '<div class="param-section">';
            html += '<h2>5️⃣ 位置別キーワード数</h2>';
            html += '<table>';
            html += '<tr><th>爻位置</th><th>キーワード数</th><th>変更</th></tr>';
            
            for (const kw of params.keywordCounts.values) {
                const changeClass = kw.change.includes('→15') ? 'warning' :
                                   kw.change.includes('+') ? 'improved' : '';
                html += '<tr>';
                html += `<td>${kw.position}爻</td>`;
                html += `<td class="param-value">${kw.count}個</td>`;
                html += `<td class="${changeClass}">${kw.change}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // 相互影響の分析
            html += '<div class="param-section">';
            html += '<h2>🔄 パラメータ相互影響分析</h2>';
            html += '<h3>強化された領域</h3>';
            html += '<ul>';
            html += '<li class="improved">5爻: 重み0.70 + キーワード45個 = 強力な選択バイアス</li>';
            html += '<li class="improved">3爻/4爻: 重み増加 + キーワード追加 = バランス改善</li>';
            html += '<li class="improved">未使用爻: 20%ボーナス + 段階的ペナルティ = 多様性促進</li>';
            html += '</ul>';
            
            html += '<h3>抑制された領域</h3>';
            html += '<ul>';
            html += '<li class="warning">2爻: 重み0.43 + キーワード15個 = 選択抑制</li>';
            html += '<li class="warning">6爻: 重み0.40 + キーワード15個 = 選択抑制</li>';
            html += '</ul>';
            
            html += '<h3>潜在的な問題点</h3>';
            html += '<ul>';
            html += '<li class="critical">5爻への過度な偏りリスク（要監視）</li>';
            html += '<li class="warning">ペナルティが急激すぎる可能性</li>';
            html += '<li class="warning">セマンティック重みのバランス</li>';
            html += '</ul>';
            html += '</div>';
            
            // 推奨調整
            html += '<div class="param-section">';
            html += '<h2>💡 Day 6 推奨調整案</h2>';
            html += '<h3>優先度高</h3>';
            html += '<ol>';
            html += '<li>5爻の重みを0.70→0.65に微調整（過度な偏り防止）</li>';
            html += '<li>1爻の重みを0.50→0.52に微増（バランス改善）</li>';
            html += '<li>ペナルティカーブを緩やかに（0.90→0.92, 0.75→0.80等）</li>';
            html += '</ol>';
            
            html += '<h3>優先度中</h3>';
            html += '<ul>';
            html += '<li>探索ノイズの全体的な見直し</li>';
            html += '<li>卦単位でのバランシング機能追加</li>';
            html += '</ul>';
            html += '</div>';
            
            document.getElementById('analysis').innerHTML = html;
        }
        
        function analyzePositionWeightImpact(position, weight) {
            if (position === 5 && weight >= 0.70) {
                return '非常に強い選択バイアス';
            } else if (weight >= 0.60) {
                return '強い選択傾向';
            } else if (weight >= 0.50) {
                return '標準的な選択';
            } else if (weight >= 0.40) {
                return '抑制された選択';
            } else {
                return '強く抑制';
            }
        }
        
        analyzeAllParameters();
    </script>
</body>
</html>