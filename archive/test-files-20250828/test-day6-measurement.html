<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 6 - æ¸¬å®šã¨åŠ¹æœç¢ºèªï¼ˆTask 6-5ï¼‰</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        h3 { color: #dcdcaa; }
        
        .measurement-section {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-box {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-title {
            font-size: 0.9em;
            color: #808080;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 1.8em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-change {
            font-size: 0.9em;
        }
        
        .improved { color: #4ec9b0; }
        .degraded { color: #f48771; }
        .maintained { color: #dcdcaa; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { 
            background: #252526;
            font-weight: bold;
        }
        
        .position-chart {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 10px;
            margin: 20px 0;
        }
        
        .position-bar {
            flex: 1;
            background: linear-gradient(to top, #4ec9b0, #569cd6);
            border-radius: 3px 3px 0 0;
            position: relative;
            min-height: 5px;
        }
        
        .position-label {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
        }
        
        .position-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
            font-weight: bold;
        }
        
        .chi-square-indicator {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1.2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .chi-good { background: #1a472a; color: #4ec9b0; }
        .chi-warning { background: #4a4a1e; color: #dcdcaa; }
        .chi-bad { background: #5a1e1e; color: #f48771; }
    </style>
</head>
<body>
    <h1>Day 6 - æ¸¬å®šã¨åŠ¹æœç¢ºèªï¼ˆTask 6-5ï¼‰</h1>
    
    <div id="results"></div>
    
    <script type="module">
        // Day 6-2ã®èª¿æ•´åŠ¹æœã‚’å®Ÿæ¸¬å®š
        async function measureAdjustmentEffects() {
            // TextTo384LinesBridgeã‚’å‹•çš„ã«ãƒ­ãƒ¼ãƒ‰
            const script = document.createElement('script');
            script.src = './public/js/ai/TextTo384LinesBridge.js';
            await new Promise(resolve => {
                script.onload = resolve;
                document.head.appendChild(script);
            });
            
            const bridge = new window.TextTo384LinesBridge();
            await bridge.initialize();
            
            let html = '';
            
            // 200ã‚µãƒ³ãƒ—ãƒ«ã§ã®å¤§è¦æ¨¡æ¸¬å®š
            const testSamples = generateComprehensiveTestSamples();
            
            // æ¸¬å®šçµæœã®åˆæœŸåŒ–
            const measurements = {
                positionDistribution: [0, 0, 0, 0, 0, 0, 0],
                hexagramUsage: {},
                uniqueLines: new Set(),
                processingTimes: [],
                categories: {
                    beginning: { total: 0, positions: [0,0,0,0,0,0,0] },
                    cooperation: { total: 0, positions: [0,0,0,0,0,0,0] },
                    challenge: { total: 0, positions: [0,0,0,0,0,0,0] },
                    change: { total: 0, positions: [0,0,0,0,0,0,0] },
                    leadership: { total: 0, positions: [0,0,0,0,0,0,0] },
                    completion: { total: 0, positions: [0,0,0,0,0,0,0] }
                }
            };
            
            // æ¸¬å®šå®Ÿè¡Œ
            html += '<div class="measurement-section">';
            html += '<h2>ğŸ“Š 200ã‚µãƒ³ãƒ—ãƒ«æ¸¬å®šå®Ÿè¡Œä¸­...</h2>';
            html += '<div id="progress">0/200 å®Œäº†</div>';
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
            
            for (let i = 0; i < testSamples.length; i++) {
                const sample = testSamples[i];
                const startTime = performance.now();
                const result = await bridge.analyzeText(sample.text);
                const endTime = performance.now();
                
                // ãƒ‡ãƒ¼ã‚¿åé›†
                measurements.positionDistribution[result.line_position]++;
                measurements.uniqueLines.add(`${result.hexagram_number}-${result.line_position}`);
                measurements.processingTimes.push(endTime - startTime);
                
                // å¦ä½¿ç”¨çµ±è¨ˆ
                if (!measurements.hexagramUsage[result.hexagram_number]) {
                    measurements.hexagramUsage[result.hexagram_number] = 0;
                }
                measurements.hexagramUsage[result.hexagram_number]++;
                
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµ±è¨ˆ
                if (sample.category && measurements.categories[sample.category]) {
                    measurements.categories[sample.category].total++;
                    measurements.categories[sample.category].positions[result.line_position]++;
                }
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                if ((i + 1) % 20 === 0) {
                    document.getElementById('progress').innerText = `${i + 1}/200 å®Œäº†`;
                }
            }
            
            // åˆ†æã¨è¡¨ç¤º
            displayMeasurementResults(measurements, testSamples.length);
        }
        
        function displayMeasurementResults(measurements, totalSamples) {
            let html = '';
            
            // ã‚µãƒãƒªãƒ¼
            html += '<div class="measurement-section">';
            html += '<h2>ğŸ“ˆ Day 6-2 èª¿æ•´åŠ¹æœã®å®Ÿæ¸¬å®šçµæœ</h2>';
            
            // ä¸»è¦æŒ‡æ¨™ã®æ¯”è¼ƒ
            html += '<div class="comparison-grid">';
            
            // ã‚«ãƒãƒ¼ç‡
            const coverageRate = (measurements.uniqueLines.size / 384) * 100;
            html += '<div class="metric-box">';
            html += '<div class="metric-title">ã‚«ãƒãƒ¼ç‡</div>';
            html += `<div class="metric-value ${coverageRate >= 12 ? 'improved' : 'maintained'}">${coverageRate.toFixed(1)}%</div>`;
            html += '<div class="metric-change">ç›®æ¨™: 12-13%</div>';
            html += '</div>';
            
            // ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°
            html += '<div class="metric-box">';
            html += '<div class="metric-title">ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°</div>';
            html += `<div class="metric-value ${measurements.uniqueLines.size >= 45 ? 'improved' : 'maintained'}">${measurements.uniqueLines.size}å€‹</div>`;
            html += '<div class="metric-change">ç›®æ¨™: 45-50å€‹</div>';
            html += '</div>';
            
            // å¹³å‡å‡¦ç†æ™‚é–“
            const avgTime = measurements.processingTimes.reduce((a, b) => a + b, 0) / measurements.processingTimes.length;
            html += '<div class="metric-box">';
            html += '<div class="metric-title">å¹³å‡å‡¦ç†æ™‚é–“</div>';
            html += `<div class="metric-value ${avgTime <= 15 ? 'improved' : 'maintained'}">${avgTime.toFixed(1)}ms</div>`;
            html += '<div class="metric-change">ç›®æ¨™: <15ms</div>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            // ä½ç½®åˆ†å¸ƒã®è©³ç´°
            html += '<div class="measurement-section">';
            html += '<h2>ğŸ¯ ä½ç½®åˆ†å¸ƒã®å®Ÿæ¸¬å®š</h2>';
            
            // ã‚°ãƒ©ãƒ•è¡¨ç¤º
            html += '<div class="position-chart">';
            const maxCount = Math.max(...measurements.positionDistribution.slice(1));
            for (let i = 1; i <= 6; i++) {
                const count = measurements.positionDistribution[i];
                const percentage = ((count / totalSamples) * 100).toFixed(1);
                const height = (count / maxCount) * 100;
                
                html += `<div class="position-bar" style="height: ${height}%;">`;
                html += `<div class="position-value">${percentage}%</div>`;
                html += `<div class="position-label">${i}çˆ»</div>`;
                html += '</div>';
            }
            html += '</div>';
            
            // è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
            html += '<table>';
            html += '<tr><th>çˆ»ä½ç½®</th><th>é¸æŠå›æ•°</th><th>é¸æŠç‡</th><th>Day5çµ‚äº†æ™‚</th><th>å¤‰åŒ–</th><th>è©•ä¾¡</th></tr>';
            
            const day5Rates = [0, 15, 16.5, 17, 17, 7.5, 15]; // Day5çµ‚äº†æ™‚ã®æ¨å®šå€¤
            
            for (let i = 1; i <= 6; i++) {
                const count = measurements.positionDistribution[i];
                const rate = ((count / totalSamples) * 100);
                const previousRate = day5Rates[i];
                const change = rate - previousRate;
                
                let evalClass = 'maintained';
                let evalText = 'ç¶­æŒ';
                
                if (i === 5) {
                    if (rate <= 7) {
                        evalClass = 'improved';
                        evalText = 'âœ… æ”¹å–„';
                    } else if (rate <= 8) {
                        evalClass = 'maintained';
                        evalText = 'âš ï¸ ã‚„ã‚„é«˜';
                    } else {
                        evalClass = 'degraded';
                        evalText = 'âŒ é«˜ã™ã';
                    }
                } else if (i === 1 || i === 6) {
                    if (change > 0.5) {
                        evalClass = 'improved';
                        evalText = 'âœ… æ”¹å–„';
                    }
                } else {
                    if (Math.abs(rate - 16.67) < 2) {
                        evalClass = 'improved';
                        evalText = 'âœ… è‰¯å¥½';
                    }
                }
                
                html += '<tr>';
                html += `<td>${i}çˆ»</td>`;
                html += `<td>${count}</td>`;
                html += `<td><strong>${rate.toFixed(1)}%</strong></td>`;
                html += `<td>${previousRate.toFixed(1)}%</td>`;
                html += `<td class="${change > 0 ? 'improved' : change < 0 ? 'degraded' : 'maintained'}">${change >= 0 ? '+' : ''}${change.toFixed(1)}%</td>`;
                html += `<td class="${evalClass}">${evalText}</td>`;
                html += '</tr>';
            }
            
            html += '</table>';
            
            // Ï‡Â²æ¤œå®š
            const chiSquare = calculateChiSquare(measurements.positionDistribution.slice(1), totalSamples);
            let chiClass = 'chi-bad';
            let chiEval = 'è¦æ”¹å–„';
            if (chiSquare < 6) {
                chiClass = 'chi-good';
                chiEval = 'âœ… è‰¯å¥½ãªãƒãƒ©ãƒ³ã‚¹';
            } else if (chiSquare < 8) {
                chiClass = 'chi-warning';
                chiEval = 'âš ï¸ ã‚„ã‚„åã‚Šã‚ã‚Š';
            }
            
            html += `<div class="chi-square-indicator ${chiClass}">`;
            html += `Ï‡Â²å€¤: ${chiSquare.toFixed(2)} - ${chiEval}`;
            html += '</div>';
            
            html += '</div>';
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥åˆ†æ
            html += '<div class="measurement-section">';
            html += '<h2>ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥ã®åŠ¹æœç¢ºèª</h2>';
            html += '<table>';
            html += '<tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>ã‚µãƒ³ãƒ—ãƒ«æ•°</th><th>ä¸»è¦çˆ»</th><th>5çˆ»é¸æŠç‡</th><th>è©•ä¾¡</th></tr>';
            
            for (const [category, data] of Object.entries(measurements.categories)) {
                if (data.total === 0) continue;
                
                const mainPosition = data.positions.indexOf(Math.max(...data.positions.slice(1))) || 1;
                const pos5Rate = ((data.positions[5] / data.total) * 100).toFixed(1);
                
                let evalClass = 'maintained';
                let evalText = 'æ¨™æº–';
                
                if (category === 'leadership' && parseFloat(pos5Rate) > 20) {
                    evalClass = 'improved';
                    evalText = 'âœ… é©åˆ‡';
                } else if (category === 'beginning' && mainPosition === 1) {
                    evalClass = 'improved';
                    evalText = 'âœ… é©åˆ‡';
                } else if (parseFloat(pos5Rate) > 15) {
                    evalClass = 'degraded';
                    evalText = 'âš ï¸ 5çˆ»åã‚Š';
                }
                
                html += '<tr>';
                html += `<td>${category}</td>`;
                html += `<td>${data.total}</td>`;
                html += `<td>${mainPosition}çˆ»</td>`;
                html += `<td>${pos5Rate}%</td>`;
                html += `<td class="${evalClass}">${evalText}</td>`;
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            // å¦ä½¿ç”¨ã®åˆ†æ•£åº¦
            html += '<div class="measurement-section">';
            html += '<h2>ğŸ—ºï¸ å¦ä½¿ç”¨ã®åˆ†æ•£åº¦</h2>';
            
            const usedHexagrams = Object.keys(measurements.hexagramUsage).length;
            const hexagramEntropy = calculateEntropy(measurements.hexagramUsage, totalSamples);
            
            html += `<p>ä½¿ç”¨ã•ã‚ŒãŸå¦æ•°: <span class="${usedHexagrams >= 40 ? 'improved' : 'maintained'}">${usedHexagrams}/64</span></p>`;
            html += `<p>ã‚¨ãƒ³ãƒˆãƒ­ãƒ”ãƒ¼: <span class="${hexagramEntropy >= 4.5 ? 'improved' : 'maintained'}">${hexagramEntropy.toFixed(2)}</span> (é«˜ã„ã»ã©åˆ†æ•£)</p>`;
            
            // æœ€ã‚‚ä½¿ç”¨ã•ã‚ŒãŸå¦TOP5
            const topHexagrams = Object.entries(measurements.hexagramUsage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            
            html += '<h3>ä½¿ç”¨é »åº¦TOP5</h3>';
            html += '<ol>';
            for (const [hexId, count] of topHexagrams) {
                const rate = ((count / totalSamples) * 100).toFixed(1);
                html += `<li>ç¬¬${hexId}å¦: ${count}å› (${rate}%)</li>`;
            }
            html += '</ol>';
            
            html += '</div>';
            
            // ç·åˆè©•ä¾¡
            html += '<div class="measurement-section">';
            html += '<h2>âœ… Day 6-2 èª¿æ•´ã®ç·åˆè©•ä¾¡</h2>';
            
            html += '<h3>æ”¹å–„ã•ã‚ŒãŸç‚¹</h3>';
            html += '<ul>';
            
            if (coverageRate >= 12) {
                html += '<li class="improved">ã‚«ãƒãƒ¼ç‡ãŒç›®æ¨™ã®12%ä»¥ä¸Šã‚’é”æˆ</li>';
            }
            if (measurements.uniqueLines.size >= 45) {
                html += '<li class="improved">ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°ãŒ45å€‹ä»¥ä¸Šã«å¢—åŠ </li>';
            }
            if (measurements.positionDistribution[5] / totalSamples <= 0.07) {
                html += '<li class="improved">5çˆ»ã®éåº¦ãªé¸æŠãŒæŠ‘åˆ¶ã•ã‚ŒãŸ</li>';
            }
            if (chiSquare < 8) {
                html += '<li class="improved">ä½ç½®ãƒãƒ©ãƒ³ã‚¹ãŒæ”¹å–„ï¼ˆÏ‡Â²å€¤æ¸›å°‘ï¼‰</li>';
            }
            
            html += '</ul>';
            
            html += '<h3>èª²é¡Œã¨æ¨å¥¨äº‹é …</h3>';
            html += '<ul>';
            
            if (usedHexagrams < 40) {
                html += '<li class="degraded">å¦ã®ä½¿ç”¨ãŒåã£ã¦ã„ã‚‹ï¼ˆ40å¦æœªæº€ï¼‰â†’ å¦ãƒ¬ãƒ™ãƒ«ã®èª¿æ•´ãŒå¿…è¦</li>';
            }
            if (measurements.positionDistribution[5] / totalSamples > 0.08) {
                html += '<li class="degraded">5çˆ»ãŒã¾ã ã‚„ã‚„é«˜ã‚ â†’ è¿½åŠ ã®å¾®èª¿æ•´ã‚’æ¤œè¨</li>';
            }
            
            html += '</ul>';
            
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        function generateComprehensiveTestSamples() {
            const samples = [];
            
            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã®ã‚µãƒ³ãƒ—ãƒ«
            const categories = {
                beginning: [
                    'æ–°ã—ã„å§‹ã¾ã‚Š', 'é–‹å§‹', 'ç€æ‰‹', 'ç«‹ã¡ä¸Šã’', 'å‰µå§‹',
                    'åˆã‚ã¦', 'ã‚¹ã‚¿ãƒ¼ãƒˆ', 'ç¬¬ä¸€æ­©', 'èµ·å‹•', 'å§‹å‹•'
                ],
                cooperation: [
                    'å”åŠ›é–¢ä¿‚', 'ãƒãƒ¼ãƒ ä½œæ¥­', 'é€£æº', 'å…±åŒä½œæ¥­', 'ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—',
                    'å”èª¿', 'æ”¯æ´', 'åŠ©ã‘åˆã„', 'å”åƒ', 'ã‚µãƒãƒ¼ãƒˆ'
                ],
                challenge: [
                    'å›°é›£å…‹æœ', 'å•é¡Œè§£æ±º', 'è©¦ç·´', 'éšœå®³', 'é€†å¢ƒ',
                    'è‹¦åŠ´', 'è‘›è—¤', 'å¯¾ç«‹', 'å±æ©Ÿ', 'ãƒˆãƒ©ãƒ–ãƒ«'
                ],
                change: [
                    'å¤‰åŒ–å¯¾å¿œ', 'è»¢æ›æœŸ', 'ç§»è¡Œ', 'èª¿æ•´', 'é©å¿œ',
                    'å¤‰æ›´', 'è»¢æ©Ÿ', 'å²è·¯', 'é¸æŠ', 'æ±ºæ–­'
                ],
                leadership: [
                    'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—', 'çµ±ç‡', 'æŒ‡å°', 'ç®¡ç†', 'è²¬ä»»',
                    'ä¸»å°', 'çµ±æ‹¬', 'ç›£ç£', 'çµŒå–¶', 'æˆ¦ç•¥'
                ],
                completion: [
                    'å®Œæˆæ®µéš', 'çµ‚äº†', 'é”æˆ', 'çµæœ', 'å®Œäº†',
                    'ç· çµ', 'å®Œçµ', 'æˆå°±', 'åˆ°é”', 'ã‚´ãƒ¼ãƒ«'
                ]
            };
            
            // å„ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰å‡ç­‰ã«ã‚µãƒ³ãƒ—ãƒªãƒ³ã‚°
            for (const [category, words] of Object.entries(categories)) {
                for (const word of words) {
                    samples.push({ text: word, category });
                    samples.push({ text: word + 'ã«ã¤ã„ã¦', category });
                    samples.push({ text: word + 'ã®æ™‚æœŸ', category });
                }
            }
            
            // è¿½åŠ ã®ãƒ©ãƒ³ãƒ€ãƒ ã‚µãƒ³ãƒ—ãƒ«
            const additionalPhrases = [
                'æˆé•·ã®æ©Ÿä¼š', 'ç™ºå±•ã®å¯èƒ½æ€§', 'å®‰å®šã‚’æ±‚ã‚ã‚‹', 'èª¿å’Œã‚’ä¿ã¤',
                'å‰µé€ çš„ãªæ´»å‹•', 'é©æ–°çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒ', 'æ”¹å–„ã®ä½™åœ°', 'æœ€é©åŒ–',
                'åˆ†æã¨è©•ä¾¡', 'å®Ÿè¡Œè¨ˆç”»', 'å±•é–‹æˆ¦ç•¥', 'æ¨é€²åŠ›',
                'æ—¥å¸¸æ¥­å‹™', 'å®šå¸¸ä½œæ¥­', 'é€šå¸¸é‹ç”¨', 'æ¨™æº–æ‰‹é †'
            ];
            
            for (const phrase of additionalPhrases) {
                samples.push({ text: phrase, category: null });
            }
            
            // 200ã‚µãƒ³ãƒ—ãƒ«ã«ãªã‚‹ã¾ã§èª¿æ•´
            return samples.slice(0, 200);
        }
        
        function calculateChiSquare(distribution, total) {
            const expected = total / 6;
            let chiSquare = 0;
            
            for (const observed of distribution) {
                chiSquare += Math.pow(observed - expected, 2) / expected;
            }
            
            return chiSquare;
        }
        
        function calculateEntropy(hexagramUsage, total) {
            let entropy = 0;
            
            for (const count of Object.values(hexagramUsage)) {
                if (count > 0) {
                    const p = count / total;
                    entropy -= p * Math.log2(p);
                }
            }
            
            return entropy;
        }
        
        measureAdjustmentEffects();
    </script>
</body>
</html>