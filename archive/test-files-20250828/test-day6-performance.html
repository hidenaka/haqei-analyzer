<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 6 - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆTask 6-3ï¼‰</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        h3 { color: #dcdcaa; }
        
        .performance-section {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { background: #252526; }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #1e1e1e;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            transition: width 0.3s ease;
        }
        
        .time-chart {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 5px;
            margin: 20px 0;
        }
        
        .time-bar {
            flex: 1;
            background: #4ec9b0;
            border-radius: 3px 3px 0 0;
            min-height: 10px;
        }
        
        .cache-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px;
        }
        
        .cache-hit { background: #1a472a; color: #4ec9b0; }
        .cache-miss { background: #5a1e1e; color: #f48771; }
    </style>
</head>
<body>
    <h1>Day 6 - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ï¼ˆTask 6-3ï¼‰</h1>
    
    <div id="results"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        async function testPerformance() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            let html = '';
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«
            const testSamples = [
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥ã‚µãƒ³ãƒ—ãƒ«
                { text: 'æ–°ã—ã„å§‹ã¾ã‚Š', category: 'beginning' },
                { text: 'å”åŠ›é–¢ä¿‚ã®æ§‹ç¯‰', category: 'cooperation' },
                { text: 'å›°é›£ã‚’ä¹—ã‚Šè¶Šãˆã‚‹', category: 'challenge' },
                { text: 'å¤‰åŒ–ã¸ã®å¯¾å¿œ', category: 'change' },
                { text: 'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ç™ºæ®', category: 'leadership' },
                { text: 'å®Œæˆã«å‘ã‘ã¦', category: 'completion' },
                // é•·æ–‡ã‚µãƒ³ãƒ—ãƒ«
                { text: 'ã“ã®åº¦ã€æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å§‹ã‚ã‚‹ã“ã¨ã«ãªã‚Šã¾ã—ãŸã€‚ãƒãƒ¼ãƒ å…¨ä½“ã§å”åŠ›ã—ã¦ã€å›°é›£ã‚’ä¹—ã‚Šè¶Šãˆã€å¤‰åŒ–ã«å¯¾å¿œã—ãªãŒã‚‰ã€ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã—ã¦å®Œæˆã‚’ç›®æŒ‡ã—ã¾ã™ã€‚', category: 'long' },
                // çŸ­æ–‡ã‚µãƒ³ãƒ—ãƒ«
                { text: 'å§‹', category: 'short' },
                { text: 'å”', category: 'short' },
                { text: 'å›°', category: 'short' }
            ];
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹
            const metrics = {
                totalTime: 0,
                averageTime: 0,
                minTime: Infinity,
                maxTime: 0,
                cacheHits: 0,
                cacheMisses: 0,
                samples: [],
                distribution: [0, 0, 0, 0, 0, 0, 0],
                uniqueLines: new Set()
            };
            
            // ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—å®Ÿè¡Œï¼ˆåˆå›ã®ã‚³ãƒ¼ãƒ«ãƒ‰ã‚¹ã‚¿ãƒ¼ãƒˆã‚’é™¤å¤–ï¼‰
            html += '<div class="performance-section">';
            html += '<h2>ğŸ”¥ ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—å®Ÿè¡Œ</h2>';
            html += '<p>ã‚·ã‚¹ãƒ†ãƒ ã®ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—ä¸­...</p>';
            await bridge.analyzeText('ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—');
            html += '<p class="good">âœ… ã‚¦ã‚©ãƒ¼ãƒ ã‚¢ãƒƒãƒ—å®Œäº†</p>';
            html += '</div>';
            
            // ãƒ¡ã‚¤ãƒ³ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            html += '<div class="performance-section">';
            html += '<h2>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>';
            html += '<div class="progress-bar"><div class="progress-fill" id="progress"></div></div>';
            html += '<table>';
            html += '<tr><th>#</th><th>ãƒ†ã‚­ã‚¹ãƒˆ</th><th>å‡¦ç†æ™‚é–“</th><th>ã‚­ãƒ£ãƒƒã‚·ãƒ¥</th><th>çµæœ</th></tr>';
            
            // å„ã‚µãƒ³ãƒ—ãƒ«ã‚’3å›å®Ÿè¡Œã—ã¦å¹³å‡ã‚’å–ã‚‹
            const totalTests = testSamples.length * 3;
            let testCount = 0;
            
            for (let round = 0; round < 3; round++) {
                for (const sample of testSamples) {
                    const startTime = performance.now();
                    const result = await bridge.analyzeText(sample.text);
                    const endTime = performance.now();
                    const processingTime = endTime - startTime;
                    
                    // ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
                    metrics.totalTime += processingTime;
                    metrics.minTime = Math.min(metrics.minTime, processingTime);
                    metrics.maxTime = Math.max(metrics.maxTime, processingTime);
                    
                    if (result.fromCache) {
                        metrics.cacheHits++;
                    } else {
                        metrics.cacheMisses++;
                    }
                    
                    metrics.samples.push({
                        text: sample.text,
                        time: processingTime,
                        cached: result.fromCache,
                        lineId: result.line_id,
                        position: result.line_position,
                        round: round + 1
                    });
                    
                    // åˆ†å¸ƒæ›´æ–°
                    if (result.line_position >= 1 && result.line_position <= 6) {
                        metrics.distribution[result.line_position]++;
                    }
                    metrics.uniqueLines.add(`${result.hexagram_number}-${result.line_position}`);
                    
                    // ãƒ†ãƒ¼ãƒ–ãƒ«è¡Œè¿½åŠ 
                    const timeClass = processingTime < 10 ? 'good' : processingTime < 20 ? 'warning' : 'bad';
                    html += '<tr>';
                    html += `<td>${testCount + 1}</td>`;
                    html += `<td>${sample.text.substring(0, 20)}...</td>`;
                    html += `<td class="${timeClass}">${processingTime.toFixed(2)}ms</td>`;
                    html += `<td>${result.fromCache ? '<span class="cache-hit">HIT</span>' : '<span class="cache-miss">MISS</span>'}</td>`;
                    html += `<td>${result.hexagram_number}å¦${result.line_position}çˆ»</td>`;
                    html += '</tr>';
                    
                    testCount++;
                    // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                    const progress = (testCount / totalTests) * 100;
                    document.getElementById('progress').style.width = progress + '%';
                }
            }
            
            html += '</table>';
            html += '</div>';
            
            // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼
            metrics.averageTime = metrics.totalTime / metrics.samples.length;
            
            html += '<div class="performance-section">';
            html += '<h2>ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚µãƒãƒªãƒ¼</h2>';
            
            html += '<div class="metric-grid">';
            
            // å¹³å‡å‡¦ç†æ™‚é–“
            const avgClass = metrics.averageTime < 15 ? 'good' : metrics.averageTime < 25 ? 'warning' : 'bad';
            html += '<div class="metric-card">';
            html += '<div>å¹³å‡å‡¦ç†æ™‚é–“</div>';
            html += `<div class="metric-value ${avgClass}">${metrics.averageTime.toFixed(2)}ms</div>`;
            html += '<div>ç›®æ¨™: < 15ms</div>';
            html += '</div>';
            
            // æœ€å°/æœ€å¤§æ™‚é–“
            html += '<div class="metric-card">';
            html += '<div>æœ€å°æ™‚é–“</div>';
            html += `<div class="metric-value good">${metrics.minTime.toFixed(2)}ms</div>`;
            html += '<div>æœ€é€Ÿå‡¦ç†</div>';
            html += '</div>';
            
            html += '<div class="metric-card">';
            html += '<div>æœ€å¤§æ™‚é–“</div>';
            html += `<div class="metric-value ${metrics.maxTime < 50 ? 'warning' : 'bad'}">${metrics.maxTime.toFixed(2)}ms</div>`;
            html += '<div>æœ€é…å‡¦ç†</div>';
            html += '</div>';
            
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡
            const hitRate = (metrics.cacheHits / (metrics.cacheHits + metrics.cacheMisses)) * 100;
            html += '<div class="metric-card">';
            html += '<div>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡</div>';
            html += `<div class="metric-value good">${hitRate.toFixed(1)}%</div>`;
            html += `<div>${metrics.cacheHits}/${metrics.cacheHits + metrics.cacheMisses}</div>`;
            html += '</div>';
            
            html += '</div>';
            
            // å‡¦ç†æ™‚é–“åˆ†å¸ƒ
            html += '<h3>å‡¦ç†æ™‚é–“åˆ†å¸ƒ</h3>';
            html += '<div class="time-chart">';
            
            // æ™‚é–“å¸¯åˆ¥ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
            const timeBuckets = [0, 0, 0, 0, 0]; // 0-10, 10-20, 20-30, 30-40, 40+
            for (const sample of metrics.samples) {
                if (sample.time < 10) timeBuckets[0]++;
                else if (sample.time < 20) timeBuckets[1]++;
                else if (sample.time < 30) timeBuckets[2]++;
                else if (sample.time < 40) timeBuckets[3]++;
                else timeBuckets[4]++;
            }
            
            const maxBucket = Math.max(...timeBuckets);
            for (let i = 0; i < timeBuckets.length; i++) {
                const height = (timeBuckets[i] / maxBucket) * 100;
                html += `<div class="time-bar" style="height: ${height}%;" title="${timeBuckets[i]}ä»¶"></div>`;
            }
            html += '</div>';
            html += '<div style="display: flex; gap: 5px;">';
            html += '<div style="flex: 1; text-align: center;">0-10ms</div>';
            html += '<div style="flex: 1; text-align: center;">10-20ms</div>';
            html += '<div style="flex: 1; text-align: center;">20-30ms</div>';
            html += '<div style="flex: 1; text-align: center;">30-40ms</div>';
            html += '<div style="flex: 1; text-align: center;">40ms+</div>';
            html += '</div>';
            
            html += '</div>';
            
            // Day 6-2èª¿æ•´ã®åŠ¹æœç¢ºèª
            html += '<div class="performance-section">';
            html += '<h2>ğŸ¯ Day 6-2 èª¿æ•´åŠ¹æœã®ç¢ºèª</h2>';
            
            // ä½ç½®åˆ†å¸ƒ
            html += '<h3>ä½ç½®åˆ†å¸ƒï¼ˆ3ãƒ©ã‚¦ãƒ³ãƒ‰è¨ˆï¼‰</h3>';
            html += '<table>';
            html += '<tr><th>çˆ»ä½ç½®</th><th>é¸æŠå›æ•°</th><th>é¸æŠç‡</th><th>è©•ä¾¡</th></tr>';
            
            const total = metrics.distribution.reduce((a, b) => a + b, 0);
            for (let i = 1; i <= 6; i++) {
                const count = metrics.distribution[i];
                const rate = ((count / total) * 100).toFixed(1);
                let evalClass = 'warning';
                let evalText = 'è¦è¦³å¯Ÿ';
                
                if (i === 5) {
                    evalClass = rate <= 7 ? 'good' : rate <= 8 ? 'warning' : 'bad';
                    evalText = rate <= 7 ? 'âœ… é©æ­£' : rate <= 8 ? 'âš ï¸ ã‚„ã‚„é«˜' : 'âŒ é«˜ã™ã';
                } else {
                    evalClass = rate >= 14 && rate <= 19 ? 'good' : 'warning';
                    evalText = rate >= 14 && rate <= 19 ? 'âœ… è‰¯å¥½' : 'âš ï¸ è¦èª¿æ•´';
                }
                
                html += '<tr>';
                html += `<td>${i}çˆ»</td>`;
                html += `<td>${count}</td>`;
                html += `<td class="${evalClass}">${rate}%</td>`;
                html += `<td>${evalText}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            // ã‚«ãƒãƒ¼ç‡
            const coverageRate = (metrics.uniqueLines.size / 384) * 100;
            html += `<p>ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°: <span class="good">${metrics.uniqueLines.size}å€‹</span> / ã‚«ãƒãƒ¼ç‡: <span class="good">${coverageRate.toFixed(2)}%</span></p>`;
            
            html += '</div>';
            
            // æœ€é©åŒ–æ¨å¥¨äº‹é …
            html += '<div class="performance-section">';
            html += '<h2>ğŸ’¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–ã®æ¨å¥¨äº‹é …</h2>';
            
            if (metrics.averageTime < 15) {
                html += '<p class="good">âœ… å‡¦ç†é€Ÿåº¦ã¯ç›®æ¨™å€¤ã‚’é”æˆã—ã¦ã„ã¾ã™</p>';
            } else {
                html += '<p class="warning">âš ï¸ å‡¦ç†é€Ÿåº¦ã®æ”¹å–„ä½™åœ°ãŒã‚ã‚Šã¾ã™</p>';
                html += '<ul>';
                html += '<li>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚ºã®æ‹¡å¤§ã‚’æ¤œè¨</li>';
                html += '<li>ãƒ™ã‚¯ãƒˆãƒ«è¨ˆç®—ã®æœ€é©åŒ–</li>';
                html += '<li>ä¸¦åˆ—å‡¦ç†ã®ãƒãƒƒãƒã‚µã‚¤ã‚ºèª¿æ•´</li>';
                html += '</ul>';
            }
            
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        testPerformance();
    </script>
</body>
</html>