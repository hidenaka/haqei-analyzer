<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 6 - パフォーマンス最適化（Task 6-3）</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        h3 { color: #dcdcaa; }
        
        .performance-section {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { background: #252526; }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #1e1e1e;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            transition: width 0.3s ease;
        }
        
        .time-chart {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 5px;
            margin: 20px 0;
        }
        
        .time-bar {
            flex: 1;
            background: #4ec9b0;
            border-radius: 3px 3px 0 0;
            min-height: 10px;
        }
        
        .cache-indicator {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 3px;
            margin: 5px;
        }
        
        .cache-hit { background: #1a472a; color: #4ec9b0; }
        .cache-miss { background: #5a1e1e; color: #f48771; }
    </style>
</head>
<body>
    <h1>Day 6 - パフォーマンス最適化（Task 6-3）</h1>
    
    <div id="results"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        async function testPerformance() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            let html = '';
            
            // パフォーマンステストサンプル
            const testSamples = [
                // カテゴリ別サンプル
                { text: '新しい始まり', category: 'beginning' },
                { text: '協力関係の構築', category: 'cooperation' },
                { text: '困難を乗り越える', category: 'challenge' },
                { text: '変化への対応', category: 'change' },
                { text: 'リーダーシップ発揮', category: 'leadership' },
                { text: '完成に向けて', category: 'completion' },
                // 長文サンプル
                { text: 'この度、新しいプロジェクトを始めることになりました。チーム全体で協力して、困難を乗り越え、変化に対応しながら、リーダーシップを発揮して完成を目指します。', category: 'long' },
                // 短文サンプル
                { text: '始', category: 'short' },
                { text: '協', category: 'short' },
                { text: '困', category: 'short' }
            ];
            
            // パフォーマンスメトリクス
            const metrics = {
                totalTime: 0,
                averageTime: 0,
                minTime: Infinity,
                maxTime: 0,
                cacheHits: 0,
                cacheMisses: 0,
                samples: [],
                distribution: [0, 0, 0, 0, 0, 0, 0],
                uniqueLines: new Set()
            };
            
            // ウォームアップ実行（初回のコールドスタートを除外）
            html += '<div class="performance-section">';
            html += '<h2>🔥 ウォームアップ実行</h2>';
            html += '<p>システムのウォームアップ中...</p>';
            await bridge.analyzeText('ウォームアップ');
            html += '<p class="good">✅ ウォームアップ完了</p>';
            html += '</div>';
            
            // メインテスト実行
            html += '<div class="performance-section">';
            html += '<h2>⚡ パフォーマンステスト実行</h2>';
            html += '<div class="progress-bar"><div class="progress-fill" id="progress"></div></div>';
            html += '<table>';
            html += '<tr><th>#</th><th>テキスト</th><th>処理時間</th><th>キャッシュ</th><th>結果</th></tr>';
            
            // 各サンプルを3回実行して平均を取る
            const totalTests = testSamples.length * 3;
            let testCount = 0;
            
            for (let round = 0; round < 3; round++) {
                for (const sample of testSamples) {
                    const startTime = performance.now();
                    const result = await bridge.analyzeText(sample.text);
                    const endTime = performance.now();
                    const processingTime = endTime - startTime;
                    
                    // メトリクス更新
                    metrics.totalTime += processingTime;
                    metrics.minTime = Math.min(metrics.minTime, processingTime);
                    metrics.maxTime = Math.max(metrics.maxTime, processingTime);
                    
                    if (result.fromCache) {
                        metrics.cacheHits++;
                    } else {
                        metrics.cacheMisses++;
                    }
                    
                    metrics.samples.push({
                        text: sample.text,
                        time: processingTime,
                        cached: result.fromCache,
                        lineId: result.line_id,
                        position: result.line_position,
                        round: round + 1
                    });
                    
                    // 分布更新
                    if (result.line_position >= 1 && result.line_position <= 6) {
                        metrics.distribution[result.line_position]++;
                    }
                    metrics.uniqueLines.add(`${result.hexagram_number}-${result.line_position}`);
                    
                    // テーブル行追加
                    const timeClass = processingTime < 10 ? 'good' : processingTime < 20 ? 'warning' : 'bad';
                    html += '<tr>';
                    html += `<td>${testCount + 1}</td>`;
                    html += `<td>${sample.text.substring(0, 20)}...</td>`;
                    html += `<td class="${timeClass}">${processingTime.toFixed(2)}ms</td>`;
                    html += `<td>${result.fromCache ? '<span class="cache-hit">HIT</span>' : '<span class="cache-miss">MISS</span>'}</td>`;
                    html += `<td>${result.hexagram_number}卦${result.line_position}爻</td>`;
                    html += '</tr>';
                    
                    testCount++;
                    // プログレスバー更新
                    const progress = (testCount / totalTests) * 100;
                    document.getElementById('progress').style.width = progress + '%';
                }
            }
            
            html += '</table>';
            html += '</div>';
            
            // パフォーマンスサマリー
            metrics.averageTime = metrics.totalTime / metrics.samples.length;
            
            html += '<div class="performance-section">';
            html += '<h2>📊 パフォーマンスサマリー</h2>';
            
            html += '<div class="metric-grid">';
            
            // 平均処理時間
            const avgClass = metrics.averageTime < 15 ? 'good' : metrics.averageTime < 25 ? 'warning' : 'bad';
            html += '<div class="metric-card">';
            html += '<div>平均処理時間</div>';
            html += `<div class="metric-value ${avgClass}">${metrics.averageTime.toFixed(2)}ms</div>`;
            html += '<div>目標: < 15ms</div>';
            html += '</div>';
            
            // 最小/最大時間
            html += '<div class="metric-card">';
            html += '<div>最小時間</div>';
            html += `<div class="metric-value good">${metrics.minTime.toFixed(2)}ms</div>`;
            html += '<div>最速処理</div>';
            html += '</div>';
            
            html += '<div class="metric-card">';
            html += '<div>最大時間</div>';
            html += `<div class="metric-value ${metrics.maxTime < 50 ? 'warning' : 'bad'}">${metrics.maxTime.toFixed(2)}ms</div>`;
            html += '<div>最遅処理</div>';
            html += '</div>';
            
            // キャッシュヒット率
            const hitRate = (metrics.cacheHits / (metrics.cacheHits + metrics.cacheMisses)) * 100;
            html += '<div class="metric-card">';
            html += '<div>キャッシュヒット率</div>';
            html += `<div class="metric-value good">${hitRate.toFixed(1)}%</div>`;
            html += `<div>${metrics.cacheHits}/${metrics.cacheHits + metrics.cacheMisses}</div>`;
            html += '</div>';
            
            html += '</div>';
            
            // 処理時間分布
            html += '<h3>処理時間分布</h3>';
            html += '<div class="time-chart">';
            
            // 時間帯別にグループ化
            const timeBuckets = [0, 0, 0, 0, 0]; // 0-10, 10-20, 20-30, 30-40, 40+
            for (const sample of metrics.samples) {
                if (sample.time < 10) timeBuckets[0]++;
                else if (sample.time < 20) timeBuckets[1]++;
                else if (sample.time < 30) timeBuckets[2]++;
                else if (sample.time < 40) timeBuckets[3]++;
                else timeBuckets[4]++;
            }
            
            const maxBucket = Math.max(...timeBuckets);
            for (let i = 0; i < timeBuckets.length; i++) {
                const height = (timeBuckets[i] / maxBucket) * 100;
                html += `<div class="time-bar" style="height: ${height}%;" title="${timeBuckets[i]}件"></div>`;
            }
            html += '</div>';
            html += '<div style="display: flex; gap: 5px;">';
            html += '<div style="flex: 1; text-align: center;">0-10ms</div>';
            html += '<div style="flex: 1; text-align: center;">10-20ms</div>';
            html += '<div style="flex: 1; text-align: center;">20-30ms</div>';
            html += '<div style="flex: 1; text-align: center;">30-40ms</div>';
            html += '<div style="flex: 1; text-align: center;">40ms+</div>';
            html += '</div>';
            
            html += '</div>';
            
            // Day 6-2調整の効果確認
            html += '<div class="performance-section">';
            html += '<h2>🎯 Day 6-2 調整効果の確認</h2>';
            
            // 位置分布
            html += '<h3>位置分布（3ラウンド計）</h3>';
            html += '<table>';
            html += '<tr><th>爻位置</th><th>選択回数</th><th>選択率</th><th>評価</th></tr>';
            
            const total = metrics.distribution.reduce((a, b) => a + b, 0);
            for (let i = 1; i <= 6; i++) {
                const count = metrics.distribution[i];
                const rate = ((count / total) * 100).toFixed(1);
                let evalClass = 'warning';
                let evalText = '要観察';
                
                if (i === 5) {
                    evalClass = rate <= 7 ? 'good' : rate <= 8 ? 'warning' : 'bad';
                    evalText = rate <= 7 ? '✅ 適正' : rate <= 8 ? '⚠️ やや高' : '❌ 高すぎ';
                } else {
                    evalClass = rate >= 14 && rate <= 19 ? 'good' : 'warning';
                    evalText = rate >= 14 && rate <= 19 ? '✅ 良好' : '⚠️ 要調整';
                }
                
                html += '<tr>';
                html += `<td>${i}爻</td>`;
                html += `<td>${count}</td>`;
                html += `<td class="${evalClass}">${rate}%</td>`;
                html += `<td>${evalText}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            // カバー率
            const coverageRate = (metrics.uniqueLines.size / 384) * 100;
            html += `<p>ユニーク爻数: <span class="good">${metrics.uniqueLines.size}個</span> / カバー率: <span class="good">${coverageRate.toFixed(2)}%</span></p>`;
            
            html += '</div>';
            
            // 最適化推奨事項
            html += '<div class="performance-section">';
            html += '<h2>💡 パフォーマンス最適化の推奨事項</h2>';
            
            if (metrics.averageTime < 15) {
                html += '<p class="good">✅ 処理速度は目標値を達成しています</p>';
            } else {
                html += '<p class="warning">⚠️ 処理速度の改善余地があります</p>';
                html += '<ul>';
                html += '<li>キャッシュサイズの拡大を検討</li>';
                html += '<li>ベクトル計算の最適化</li>';
                html += '<li>並列処理のバッチサイズ調整</li>';
                html += '</ul>';
            }
            
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        testPerformance();
    </script>
</body>
</html>