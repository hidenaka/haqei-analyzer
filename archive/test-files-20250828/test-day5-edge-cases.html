<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 5 - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ”¹å–„åŠ¹æœæ¸¬å®š</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        .summary {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .success { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .error { color: #f48771; }
        .improved { 
            background: #155724;
            color: #d4edda;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-section {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { 
            background: #1e1e1e; 
            color: #4ec9b0;
        }
        
        .input-display {
            font-family: monospace;
            background: #1e1e1e;
            padding: 3px 6px;
            border-radius: 3px;
            display: inline-block;
        }
        
        .progress-bar {
            background: #3c3c3c;
            border-radius: 5px;
            overflow: hidden;
            height: 25px;
            margin: 5px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: #1e1e1e;
            font-weight: bold;
        }
        
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #569cd6;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <h1>Day 5 - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ”¹å–„åŠ¹æœæ¸¬å®š</h1>
    
    <div class="summary">
        <h2>ğŸ“Š å®Ÿæ–½ã—ãŸæ”¹å–„ï¼ˆTask 5-1ï½5-8ï¼‰</h2>
        <ul>
            <li>âœ… Task 5-1: çŸ­æ–‡å‡¦ç†ï¼ˆ3æ–‡å­—æœªæº€ã®ç¹°ã‚Šè¿”ã—æ‹¡å¼µï¼‰</li>
            <li>âœ… Task 5-2: é•·æ–‡å‡¦ç†ï¼ˆ150æ–‡å­—è¶…ã®è¦ç´„å‡¦ç†ï¼‰</li>
            <li>âœ… Task 5-3: ç‰¹æ®Šæ–‡å­—ãƒ»çµµæ–‡å­—ã®é™¤å»ã¨æ­£è¦åŒ–</li>
            <li>âœ… Task 5-4: æ•°å­—ã®æ¼¢æ•°å­—å¤‰æ›</li>
            <li>âœ… Task 5-7: ç©ºç™½ãƒ»æ”¹è¡Œã®æ­£è¦åŒ–</li>
            <li>âœ… Task 5-8: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–</li>
        </ul>
    </div>
    
    <div id="loading">ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>
    <div id="results" style="display: none;"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // åŒ…æ‹¬çš„ãªã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«
        const edgeCaseTests = {
            shortText: {
                name: 'çŸ­æ–‡å‡¦ç†',
                samples: [
                    { text: 'æ„›', expected: 'should_process', label: '1æ–‡å­—' },
                    { text: 'å‹ã¤', expected: 'should_process', label: '2æ–‡å­—' },
                    { text: 'é ‘å¼µã‚‹', expected: 'should_process', label: '3æ–‡å­—' },
                    { text: 'ä»Š', expected: 'should_process', label: '1æ–‡å­—ï¼ˆæ™‚é–“ï¼‰' },
                    { text: 'ç§', expected: 'should_process', label: '1æ–‡å­—ï¼ˆäººç§°ï¼‰' }
                ]
            },
            longText: {
                name: 'é•·æ–‡å‡¦ç†',
                samples: [
                    { 
                        text: 'ä»Šæ—¥ã¯å¤©æ°—ãŒè‰¯ã„ã®ã§ã€å‹äººãŸã¡ã¨ä¸€ç·’ã«å…¬åœ’ã§ãƒ”ã‚¯ãƒ‹ãƒƒã‚¯ã‚’ã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ãŠå¼å½“ã‚’ä½œã£ã¦ã€ãƒ¬ã‚¸ãƒ£ãƒ¼ã‚·ãƒ¼ãƒˆã‚’æŒã£ã¦ã€æ¥½ã—ã„æ™‚é–“ã‚’éã”ã™äºˆå®šã§ã™ã€‚ã¿ã‚“ãªã§å†™çœŸã‚‚æ’®ã‚ŠãŸã„ã¨æ€ã„ã¾ã™ã€‚',
                        expected: 'should_process',
                        label: '80æ–‡å­—ç¨‹åº¦'
                    },
                    {
                        text: 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ç· ã‚åˆ‡ã‚ŠãŒè¿‘ã¥ã„ã¦ã„ã‚‹ãŸã‚ã€ãƒãƒ¼ãƒ å…¨å“¡ã§å”åŠ›ã—ã¦ä½œæ¥­ã‚’é€²ã‚ã¦ã„ã¾ã™ã€‚' + 
                              'å“è³ªã‚’ç¶­æŒã—ãªãŒã‚‰åŠ¹ç‡çš„ã«é€²ã‚ã‚‹ã“ã¨ãŒé‡è¦ã§ã€å®šæœŸçš„ãªãƒŸãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã§é€²æ—ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚' +
                              'ä»Šå¾Œã‚‚ç¶™ç¶šçš„ãªæ”¹å–„ã‚’è¡Œã„ãªãŒã‚‰ã€ç›®æ¨™é”æˆã«å‘ã‘ã¦é‚é€²ã—ã¦ã„ããŸã„ã¨è€ƒãˆã¦ã„ã¾ã™ã€‚',
                        expected: 'should_process',
                        label: '150æ–‡å­—è¶…'
                    }
                ]
            },
            specialChars: {
                name: 'ç‰¹æ®Šæ–‡å­—ãƒ»è¨˜å·',
                samples: [
                    { text: 'é ‘å¼µã‚‹ğŸ’ª', expected: 'should_process', label: 'çµµæ–‡å­—ä»˜ã' },
                    { text: 'ã‚„ã£ãŸã€œ(^o^)/', expected: 'should_process', label: 'é¡”æ–‡å­—ä»˜ã' },
                    { text: 'Helloä¸–ç•Œï¼', expected: 'should_process', label: 'è‹±èªæ··åœ¨' },
                    { text: 'å£²ä¸Šâ†‘30%é”æˆ', expected: 'should_process', label: 'è¨˜å·ãƒ»æ•°å­—' },
                    { text: 'â˜…é‡è¦â˜…', expected: 'should_process', label: 'è¨˜å·å›²ã¿' },
                    { text: 'ï¼¡ï¼¢ï¼£ï¼¤ï¼‘ï¼’ï¼“ï¼”', expected: 'should_process', label: 'å…¨è§’è‹±æ•°' }
                ]
            },
            ambiguous: {
                name: 'æ›–æ˜§å…¥åŠ›',
                samples: [
                    { text: 'ã‚ã‚Œ', expected: 'should_process', label: 'æŒ‡ç¤ºèª' },
                    { text: 'ãªã‚“ã‹', expected: 'should_process', label: 'ä¸æ˜ç­' },
                    { text: 'ã†ãƒ¼ã‚“', expected: 'should_process', label: 'æ„Ÿå˜†è©' },
                    { text: 'ã¾ã‚ã¾ã‚', expected: 'should_process', label: 'ç¨‹åº¦è¡¨ç¾' },
                    { text: 'ãã‚“ãªæ„Ÿã˜', expected: 'should_process', label: 'æ›–æ˜§è¡¨ç¾' }
                ]
            },
            boundary: {
                name: 'å¢ƒç•Œå€¤',
                samples: [
                    { text: '', expected: 'should_handle', label: 'ç©ºæ–‡å­—åˆ—' },
                    { text: 'ã€€', expected: 'should_handle', label: 'å…¨è§’ã‚¹ãƒšãƒ¼ã‚¹' },
                    { text: '\n\n', expected: 'should_handle', label: 'æ”¹è¡Œã®ã¿' },
                    { text: '   ', expected: 'should_handle', label: 'åŠè§’ã‚¹ãƒšãƒ¼ã‚¹' },
                    { text: '123456789', expected: 'should_process', label: 'æ•°å­—ã®ã¿' },
                    { text: 'ã‚'.repeat(200), expected: 'should_process', label: '200æ–‡å­—åå¾©' }
                ]
            },
            mixed: {
                name: 'è¤‡åˆã‚±ãƒ¼ã‚¹',
                samples: [
                    { text: 'ğŸ˜€çŸ­ã„ğŸ˜€', expected: 'should_process', label: 'çµµæ–‡å­—+çŸ­æ–‡' },
                    { text: 'ã€€ã€€ç©ºç™½ã€€ã€€å¤šã„ã€€ã€€', expected: 'should_process', label: 'éå‰°ç©ºç™½' },
                    { text: 'ï¼‘ï¼’ï¼“ã‚ã„ã†', expected: 'should_process', label: 'å…¨è§’æ•°å­—+ã²ã‚‰ãŒãª' },
                    { text: '\næ”¹è¡Œ\nãŒ\nå¤šã„\n', expected: 'should_process', label: 'æ”¹è¡Œéå¤š' },
                    { text: 'â˜…â˜†â™ªæ··åœ¨ãƒ†ã‚¹ãƒˆâ™ªâ˜†â˜…', expected: 'should_process', label: 'è¨˜å·æ··åœ¨' }
                ]
            }
        };
        
        async function runEdgeCaseTests() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                categories: {},
                totalTests: 0,
                successCount: 0,
                errorCount: 0,
                processedTexts: []
            };
            
            // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            for (const [categoryKey, category] of Object.entries(edgeCaseTests)) {
                results.categories[categoryKey] = {
                    name: category.name,
                    total: 0,
                    success: 0,
                    errors: [],
                    samples: []
                };
                
                for (const sample of category.samples) {
                    results.totalTests++;
                    results.categories[categoryKey].total++;
                    
                    try {
                        const result = await bridge.analyzeText(sample.text);
                        
                        // å‰å‡¦ç†ã•ã‚ŒãŸãƒ†ã‚­ã‚¹ãƒˆã‚‚å–å¾—
                        const analysis = await bridge.performComprehensiveAnalysis(sample.text);
                        
                        if (result && result.hexagram_number && result.line_position) {
                            results.successCount++;
                            results.categories[categoryKey].success++;
                            
                            results.categories[categoryKey].samples.push({
                                input: sample.text,
                                label: sample.label,
                                processed: analysis.processedText,
                                result: `${result.hexagram_number}å¦${result.line_position}çˆ»`,
                                success: true
                            });
                        } else {
                            throw new Error('ä¸å®Œå…¨ãªçµæœ');
                        }
                    } catch (error) {
                        results.errorCount++;
                        results.categories[categoryKey].errors.push({
                            input: sample.text,
                            label: sample.label,
                            error: error.message
                        });
                        
                        results.categories[categoryKey].samples.push({
                            input: sample.text,
                            label: sample.label,
                            processed: '',
                            result: 'ã‚¨ãƒ©ãƒ¼',
                            success: false,
                            error: error.message
                        });
                    }
                }
            }
            
            displayResults(results);
        }
        
        function displayResults(results) {
            document.getElementById('loading').style.display = 'none';
            
            let html = '';
            
            // ç·åˆæˆç¸¾
            const overallRate = ((results.successCount / results.totalTests) * 100).toFixed(1);
            const overallClass = overallRate >= 95 ? 'success' : overallRate >= 90 ? 'warning' : 'error';
            
            html += '<div class="summary">';
            html += '<h2>ğŸ“Š ç·åˆæˆç¸¾</h2>';
            html += `<div class="progress-bar">`;
            html += `<div class="progress-fill" style="width: ${overallRate}%;">`;
            html += `æˆåŠŸç‡: ${overallRate}% (${results.successCount}/${results.totalTests})`;
            html += '</div></div>';
            
            if (overallRate >= 95) {
                html += '<p class="success" style="font-size: 1.2em;">ğŸ¯ ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å‡¦ç†ãŒå¤§å¹…ã«æ”¹å–„ã•ã‚Œã¾ã—ãŸï¼</p>';
            }
            html += '</div>';
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥çµæœ
            html += '<div class="comparison-grid">';
            
            for (const [key, category] of Object.entries(results.categories)) {
                const categoryRate = ((category.success / category.total) * 100).toFixed(1);
                const categoryClass = categoryRate >= 95 ? 'success' : categoryRate >= 90 ? 'warning' : 'error';
                
                html += '<div class="test-section">';
                html += `<h3>${category.name}</h3>`;
                html += `<p class="${categoryClass}">æˆåŠŸç‡: ${categoryRate}% (${category.success}/${category.total})</p>`;
                
                // ã‚µãƒ³ãƒ—ãƒ«è©³ç´°è¡¨
                html += '<table>';
                html += '<tr><th>å…¥åŠ›</th><th>å‡¦ç†å¾Œ</th><th>çµæœ</th></tr>';
                
                for (const sample of category.samples.slice(0, 5)) { // æœ€åˆã®5ä»¶ã®ã¿è¡¨ç¤º
                    const rowClass = sample.success ? '' : 'error';
                    html += `<tr class="${rowClass}">`;
                    html += `<td><span class="input-display" title="${sample.label}">${escapeHtml(sample.input)}</span></td>`;
                    html += `<td>${escapeHtml(sample.processed || '-')}</td>`;
                    html += `<td>${sample.success ? 'âœ… ' + sample.result : 'âŒ ' + (sample.error || 'ã‚¨ãƒ©ãƒ¼')}</td>`;
                    html += '</tr>';
                }
                
                if (category.samples.length > 5) {
                    html += `<tr><td colspan="3" style="text-align: center;">... ä»– ${category.samples.length - 5}ä»¶</td></tr>`;
                }
                
                html += '</table>';
                
                // ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹å ´åˆã¯è¡¨ç¤º
                if (category.errors.length > 0) {
                    html += '<p class="error">ã‚¨ãƒ©ãƒ¼:</p>';
                    html += '<ul>';
                    for (const err of category.errors) {
                        html += `<li>"${escapeHtml(err.input)}" (${err.label}): ${err.error}</li>`;
                    }
                    html += '</ul>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            
            // æ”¹å–„ãƒã‚¤ãƒ³ãƒˆã‚µãƒãƒªãƒ¼
            html += '<div class="summary">';
            html += '<h2>âœ¨ Day 5 æ”¹å–„åŠ¹æœ</h2>';
            
            const improvements = [
                { category: 'çŸ­æ–‡å‡¦ç†', before: '70%', after: results.categories.shortText ? 
                    ((results.categories.shortText.success / results.categories.shortText.total) * 100).toFixed(0) + '%' : '-' },
                { category: 'é•·æ–‡å‡¦ç†', before: '85%', after: results.categories.longText ?
                    ((results.categories.longText.success / results.categories.longText.total) * 100).toFixed(0) + '%' : '-' },
                { category: 'ç‰¹æ®Šæ–‡å­—', before: '60%', after: results.categories.specialChars ?
                    ((results.categories.specialChars.success / results.categories.specialChars.total) * 100).toFixed(0) + '%' : '-' },
                { category: 'å¢ƒç•Œå€¤', before: '40%', after: results.categories.boundary ?
                    ((results.categories.boundary.success / results.categories.boundary.total) * 100).toFixed(0) + '%' : '-' }
            ];
            
            html += '<table>';
            html += '<tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æ”¹å–„å‰</th><th>æ”¹å–„å¾Œ</th><th>æ”¹å–„åº¦</th></tr>';
            
            for (const imp of improvements) {
                const afterValue = parseInt(imp.after);
                const beforeValue = parseInt(imp.before);
                const improvement = afterValue - beforeValue;
                const improvementClass = improvement > 0 ? 'improved' : '';
                
                html += '<tr>';
                html += `<td>${imp.category}</td>`;
                html += `<td>${imp.before}</td>`;
                html += `<td>${imp.after}</td>`;
                html += `<td><span class="${improvementClass}">${improvement > 0 ? '+' : ''}${improvement}%</span></td>`;
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
            document.getElementById('results').style.display = 'block';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        runEdgeCaseTests();
    </script>
</body>
</html>