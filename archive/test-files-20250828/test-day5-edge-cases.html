<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 5 - エッジケース改善効果測定</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        .summary {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .success { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .error { color: #f48771; }
        .improved { 
            background: #155724;
            color: #d4edda;
            padding: 2px 5px;
            border-radius: 3px;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .test-section {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { 
            background: #1e1e1e; 
            color: #4ec9b0;
        }
        
        .input-display {
            font-family: monospace;
            background: #1e1e1e;
            padding: 3px 6px;
            border-radius: 3px;
            display: inline-block;
        }
        
        .progress-bar {
            background: #3c3c3c;
            border-radius: 5px;
            overflow: hidden;
            height: 25px;
            margin: 5px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: #1e1e1e;
            font-weight: bold;
        }
        
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #569cd6;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <h1>Day 5 - エッジケース改善効果測定</h1>
    
    <div class="summary">
        <h2>📊 実施した改善（Task 5-1～5-8）</h2>
        <ul>
            <li>✅ Task 5-1: 短文処理（3文字未満の繰り返し拡張）</li>
            <li>✅ Task 5-2: 長文処理（150文字超の要約処理）</li>
            <li>✅ Task 5-3: 特殊文字・絵文字の除去と正規化</li>
            <li>✅ Task 5-4: 数字の漢数字変換</li>
            <li>✅ Task 5-7: 空白・改行の正規化</li>
            <li>✅ Task 5-8: エラーハンドリング強化</li>
        </ul>
    </div>
    
    <div id="loading">エッジケーステスト実行中...</div>
    <div id="results" style="display: none;"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // 包括的なエッジケーステストサンプル
        const edgeCaseTests = {
            shortText: {
                name: '短文処理',
                samples: [
                    { text: '愛', expected: 'should_process', label: '1文字' },
                    { text: '勝つ', expected: 'should_process', label: '2文字' },
                    { text: '頑張る', expected: 'should_process', label: '3文字' },
                    { text: '今', expected: 'should_process', label: '1文字（時間）' },
                    { text: '私', expected: 'should_process', label: '1文字（人称）' }
                ]
            },
            longText: {
                name: '長文処理',
                samples: [
                    { 
                        text: '今日は天気が良いので、友人たちと一緒に公園でピクニックをすることにしました。お弁当を作って、レジャーシートを持って、楽しい時間を過ごす予定です。みんなで写真も撮りたいと思います。',
                        expected: 'should_process',
                        label: '80文字程度'
                    },
                    {
                        text: 'プロジェクトの締め切りが近づいているため、チーム全員で協力して作業を進めています。' + 
                              '品質を維持しながら効率的に進めることが重要で、定期的なミーティングで進捗を確認しています。' +
                              '今後も継続的な改善を行いながら、目標達成に向けて邁進していきたいと考えています。',
                        expected: 'should_process',
                        label: '150文字超'
                    }
                ]
            },
            specialChars: {
                name: '特殊文字・記号',
                samples: [
                    { text: '頑張る💪', expected: 'should_process', label: '絵文字付き' },
                    { text: 'やった〜(^o^)/', expected: 'should_process', label: '顔文字付き' },
                    { text: 'Hello世界！', expected: 'should_process', label: '英語混在' },
                    { text: '売上↑30%達成', expected: 'should_process', label: '記号・数字' },
                    { text: '★重要★', expected: 'should_process', label: '記号囲み' },
                    { text: 'ＡＢＣＤ１２３４', expected: 'should_process', label: '全角英数' }
                ]
            },
            ambiguous: {
                name: '曖昧入力',
                samples: [
                    { text: 'あれ', expected: 'should_process', label: '指示語' },
                    { text: 'なんか', expected: 'should_process', label: '不明瞭' },
                    { text: 'うーん', expected: 'should_process', label: '感嘆詞' },
                    { text: 'まあまあ', expected: 'should_process', label: '程度表現' },
                    { text: 'そんな感じ', expected: 'should_process', label: '曖昧表現' }
                ]
            },
            boundary: {
                name: '境界値',
                samples: [
                    { text: '', expected: 'should_handle', label: '空文字列' },
                    { text: '　', expected: 'should_handle', label: '全角スペース' },
                    { text: '\n\n', expected: 'should_handle', label: '改行のみ' },
                    { text: '   ', expected: 'should_handle', label: '半角スペース' },
                    { text: '123456789', expected: 'should_process', label: '数字のみ' },
                    { text: 'あ'.repeat(200), expected: 'should_process', label: '200文字反復' }
                ]
            },
            mixed: {
                name: '複合ケース',
                samples: [
                    { text: '😀短い😀', expected: 'should_process', label: '絵文字+短文' },
                    { text: '　　空白　　多い　　', expected: 'should_process', label: '過剰空白' },
                    { text: '１２３あいう', expected: 'should_process', label: '全角数字+ひらがな' },
                    { text: '\n改行\nが\n多い\n', expected: 'should_process', label: '改行過多' },
                    { text: '★☆♪混在テスト♪☆★', expected: 'should_process', label: '記号混在' }
                ]
            }
        };
        
        async function runEdgeCaseTests() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                categories: {},
                totalTests: 0,
                successCount: 0,
                errorCount: 0,
                processedTexts: []
            };
            
            // カテゴリごとにテスト実行
            for (const [categoryKey, category] of Object.entries(edgeCaseTests)) {
                results.categories[categoryKey] = {
                    name: category.name,
                    total: 0,
                    success: 0,
                    errors: [],
                    samples: []
                };
                
                for (const sample of category.samples) {
                    results.totalTests++;
                    results.categories[categoryKey].total++;
                    
                    try {
                        const result = await bridge.analyzeText(sample.text);
                        
                        // 前処理されたテキストも取得
                        const analysis = await bridge.performComprehensiveAnalysis(sample.text);
                        
                        if (result && result.hexagram_number && result.line_position) {
                            results.successCount++;
                            results.categories[categoryKey].success++;
                            
                            results.categories[categoryKey].samples.push({
                                input: sample.text,
                                label: sample.label,
                                processed: analysis.processedText,
                                result: `${result.hexagram_number}卦${result.line_position}爻`,
                                success: true
                            });
                        } else {
                            throw new Error('不完全な結果');
                        }
                    } catch (error) {
                        results.errorCount++;
                        results.categories[categoryKey].errors.push({
                            input: sample.text,
                            label: sample.label,
                            error: error.message
                        });
                        
                        results.categories[categoryKey].samples.push({
                            input: sample.text,
                            label: sample.label,
                            processed: '',
                            result: 'エラー',
                            success: false,
                            error: error.message
                        });
                    }
                }
            }
            
            displayResults(results);
        }
        
        function displayResults(results) {
            document.getElementById('loading').style.display = 'none';
            
            let html = '';
            
            // 総合成績
            const overallRate = ((results.successCount / results.totalTests) * 100).toFixed(1);
            const overallClass = overallRate >= 95 ? 'success' : overallRate >= 90 ? 'warning' : 'error';
            
            html += '<div class="summary">';
            html += '<h2>📊 総合成績</h2>';
            html += `<div class="progress-bar">`;
            html += `<div class="progress-fill" style="width: ${overallRate}%;">`;
            html += `成功率: ${overallRate}% (${results.successCount}/${results.totalTests})`;
            html += '</div></div>';
            
            if (overallRate >= 95) {
                html += '<p class="success" style="font-size: 1.2em;">🎯 エッジケース処理が大幅に改善されました！</p>';
            }
            html += '</div>';
            
            // カテゴリ別結果
            html += '<div class="comparison-grid">';
            
            for (const [key, category] of Object.entries(results.categories)) {
                const categoryRate = ((category.success / category.total) * 100).toFixed(1);
                const categoryClass = categoryRate >= 95 ? 'success' : categoryRate >= 90 ? 'warning' : 'error';
                
                html += '<div class="test-section">';
                html += `<h3>${category.name}</h3>`;
                html += `<p class="${categoryClass}">成功率: ${categoryRate}% (${category.success}/${category.total})</p>`;
                
                // サンプル詳細表
                html += '<table>';
                html += '<tr><th>入力</th><th>処理後</th><th>結果</th></tr>';
                
                for (const sample of category.samples.slice(0, 5)) { // 最初の5件のみ表示
                    const rowClass = sample.success ? '' : 'error';
                    html += `<tr class="${rowClass}">`;
                    html += `<td><span class="input-display" title="${sample.label}">${escapeHtml(sample.input)}</span></td>`;
                    html += `<td>${escapeHtml(sample.processed || '-')}</td>`;
                    html += `<td>${sample.success ? '✅ ' + sample.result : '❌ ' + (sample.error || 'エラー')}</td>`;
                    html += '</tr>';
                }
                
                if (category.samples.length > 5) {
                    html += `<tr><td colspan="3" style="text-align: center;">... 他 ${category.samples.length - 5}件</td></tr>`;
                }
                
                html += '</table>';
                
                // エラーがある場合は表示
                if (category.errors.length > 0) {
                    html += '<p class="error">エラー:</p>';
                    html += '<ul>';
                    for (const err of category.errors) {
                        html += `<li>"${escapeHtml(err.input)}" (${err.label}): ${err.error}</li>`;
                    }
                    html += '</ul>';
                }
                
                html += '</div>';
            }
            
            html += '</div>';
            
            // 改善ポイントサマリー
            html += '<div class="summary">';
            html += '<h2>✨ Day 5 改善効果</h2>';
            
            const improvements = [
                { category: '短文処理', before: '70%', after: results.categories.shortText ? 
                    ((results.categories.shortText.success / results.categories.shortText.total) * 100).toFixed(0) + '%' : '-' },
                { category: '長文処理', before: '85%', after: results.categories.longText ?
                    ((results.categories.longText.success / results.categories.longText.total) * 100).toFixed(0) + '%' : '-' },
                { category: '特殊文字', before: '60%', after: results.categories.specialChars ?
                    ((results.categories.specialChars.success / results.categories.specialChars.total) * 100).toFixed(0) + '%' : '-' },
                { category: '境界値', before: '40%', after: results.categories.boundary ?
                    ((results.categories.boundary.success / results.categories.boundary.total) * 100).toFixed(0) + '%' : '-' }
            ];
            
            html += '<table>';
            html += '<tr><th>カテゴリ</th><th>改善前</th><th>改善後</th><th>改善度</th></tr>';
            
            for (const imp of improvements) {
                const afterValue = parseInt(imp.after);
                const beforeValue = parseInt(imp.before);
                const improvement = afterValue - beforeValue;
                const improvementClass = improvement > 0 ? 'improved' : '';
                
                html += '<tr>';
                html += `<td>${imp.category}</td>`;
                html += `<td>${imp.before}</td>`;
                html += `<td>${imp.after}</td>`;
                html += `<td><span class="${improvementClass}">${improvement > 0 ? '+' : ''}${improvement}%</span></td>`;
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
            document.getElementById('results').style.display = 'block';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        runEdgeCaseTests();
    </script>
</body>
</html>