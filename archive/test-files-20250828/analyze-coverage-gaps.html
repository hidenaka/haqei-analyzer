<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>E-1/2: カバー率詳細分析 - 未使用爻パターン特定</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .success { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .error { color: #f48771; }
        .info { color: #9cdcfe; }
        .result-box {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        pre { background: #1e1e1e; padding: 10px; border-radius: 3px; }
        .hexagram-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .hexagram-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .hexagram-lines {
            display: flex;
            justify-content: space-around;
            margin-top: 5px;
        }
        .line-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f48771;
        }
        .line-indicator.used { background: #4ec9b0; }
        .line-indicator.partial { background: #dcdcaa; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #3e3e42;
            padding: 8px;
            text-align: left;
        }
        th { background: #2d2d30; }
    </style>
</head>
<body>
    <h1>🔍 E-1/2: カバー率詳細分析 - 未使用爻パターン特定</h1>
    <div id="status">分析準備中...</div>
    <div id="results"></div>

    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // 500サンプルでの徹底分析
        function generateAnalysisSamples() {
            const samples = [];
            const patterns = [
                // 多様なパターン500個
                "新しい始まり", "協力関係", "困難な状況", "変化の時期", "リーダーシップ", "完成段階",
                "内面的成長", "外部との交渉", "試練を乗り越える", "決断の時", "最高の成果", "終了と再生",
                "基礎を固める", "関係性構築", "問題解決", "転換点", "成熟した判断", "最終決定",
                "初期段階", "チームワーク", "挑戦的課題", "岐路に立つ", "統率力", "完了報告",
                "スタート地点", "相互支援", "障害除去", "方向転換", "管理責任", "締結",
                "立ち上げ", "協調性", "葛藤解決", "選択肢", "権限行使", "到達点",
                "創始", "連携強化", "逆境克服", "環境変化", "指導的立場", "極致",
                "起動", "パートナーシップ", "苦労の末", "調整期間", "中心的役割", "最後の仕上げ",
                "第一歩", "内省", "壁を破る", "移行期", "決定権", "結果",
                "開始準備", "相談", "課題に向き合う", "分岐点", "戦略立案", "成就"
            ];
            
            // 各パターンを複数回、異なる文脈で使用
            for (let i = 0; i < 500; i++) {
                const pattern = patterns[i % patterns.length];
                const context = ["について", "の時期", "を考える", "に直面", "の段階"][Math.floor(i / 100)];
                samples.push(`${pattern}${context}`);
            }
            
            return samples;
        }
        
        async function analyzeCurrentCoverage() {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            
            try {
                statusEl.innerHTML = '<span class="warning">TextTo384LinesBridge初期化中...</span>';
                const bridge = new TextTo384LinesBridge();
                await bridge.initialize();
                
                // lineUsageCountをリセット
                bridge.lineUsageCount = {};
                
                statusEl.innerHTML = '<span class="info">500サンプル分析実行中...</span>';
                
                const samples = generateAnalysisSamples();
                const lineUsage = new Map();
                const hexagramCoverage = new Map();
                const positionPatterns = [0, 0, 0, 0, 0, 0];
                
                // 分析実行
                for (const text of samples) {
                    const result = await bridge.analyzeText(text);
                    const lineId = result.line_384_id;
                    const hexagramId = result.hexagram_id;
                    const position = result.line_position;
                    
                    lineUsage.set(lineId, (lineUsage.get(lineId) || 0) + 1);
                    
                    if (!hexagramCoverage.has(hexagramId)) {
                        hexagramCoverage.set(hexagramId, new Set());
                    }
                    hexagramCoverage.get(hexagramId).add(position);
                    
                    if (position <= 6) {
                        positionPatterns[position - 1]++;
                    }
                }
                
                // 分析結果
                const uniqueLines = lineUsage.size;
                const coverageRate = (uniqueLines / 384) * 100;
                const unusedLines = [];
                const rarelyUsedLines = [];
                const overusedLines = [];
                
                // 未使用・低使用・過使用爻の特定
                for (let i = 1; i <= 384; i++) {
                    const usage = lineUsage.get(i) || 0;
                    if (usage === 0) {
                        unusedLines.push(i);
                    } else if (usage === 1) {
                        rarelyUsedLines.push(i);
                    } else if (usage > 10) {
                        overusedLines.push({ id: i, count: usage });
                    }
                }
                
                // 結果表示
                let html = '';
                
                // サマリー
                html += '<div class="result-box">';
                html += '<h2>📊 E-1: 現状カバー率分析結果</h2>';
                html += '<pre>';
                html += `総サンプル数: 500\n`;
                html += `ユニーク爻数: <span class="${uniqueLines >= 50 ? 'success' : 'warning'}">${uniqueLines}/384</span>\n`;
                html += `カバー率: <span class="${coverageRate >= 13 ? 'success' : 'error'}">${coverageRate.toFixed(2)}%</span>\n`;
                html += `未使用爻数: <span class="error">${unusedLines.length}個</span>\n`;
                html += `低使用爻数（1回のみ）: <span class="warning">${rarelyUsedLines.length}個</span>\n`;
                html += `過使用爻数（10回超）: <span class="warning">${overusedLines.length}個</span>\n`;
                html += '</pre></div>';
                
                // E-2: 未使用爻のパターン分析
                html += '<div class="result-box">';
                html += '<h2>🔍 E-2: 未使用爻パターン分析</h2>';
                
                // 卦ごとの未使用パターン
                const unusedByHexagram = new Map();
                unusedLines.forEach(lineId => {
                    const hexagramId = Math.ceil(lineId / 6);
                    const position = ((lineId - 1) % 6) + 1;
                    if (!unusedByHexagram.has(hexagramId)) {
                        unusedByHexagram.set(hexagramId, []);
                    }
                    unusedByHexagram.get(hexagramId).push(position);
                });
                
                // 位置ごとの未使用数
                const unusedByPosition = [0, 0, 0, 0, 0, 0];
                unusedLines.forEach(lineId => {
                    const position = ((lineId - 1) % 6) + 1;
                    unusedByPosition[position - 1]++;
                });
                
                html += '<h3>位置別未使用爻数</h3>';
                html += '<table>';
                html += '<tr><th>爻位置</th><th>未使用数</th><th>未使用率</th><th>分析</th></tr>';
                unusedByPosition.forEach((count, idx) => {
                    const rate = (count / 64 * 100).toFixed(1);
                    const analysis = count > 40 ? '❌ 深刻な偏り' : 
                                    count > 20 ? '⚠️ 要改善' : 
                                    '✅ 許容範囲';
                    html += `<tr>
                        <td>${idx + 1}爻</td>
                        <td>${count}/64</td>
                        <td>${rate}%</td>
                        <td>${analysis}</td>
                    </tr>`;
                });
                html += '</table>';
                
                // 完全未使用の卦
                html += '<h3>完全未使用の卦（全6爻が未使用）</h3>';
                html += '<pre>';
                let completelyUnusedCount = 0;
                for (let hexId = 1; hexId <= 64; hexId++) {
                    const unusedPositions = unusedByHexagram.get(hexId) || [];
                    if (unusedPositions.length === 6) {
                        html += `卦${hexId}: 全爻未使用\n`;
                        completelyUnusedCount++;
                    }
                }
                if (completelyUnusedCount === 0) {
                    html += '<span class="success">なし（良好）</span>\n';
                }
                html += '</pre>';
                
                // 改善提案
                html += '<h3>📈 改善提案</h3>';
                html += '<pre>';
                
                const suggestions = [];
                
                // 位置別の問題を特定
                unusedByPosition.forEach((count, idx) => {
                    if (count > 30) {
                        suggestions.push(`${idx + 1}爻の選択率を大幅に向上させる必要があります（現在${count}個未使用）`);
                    }
                });
                
                if (overusedLines.length > 5) {
                    suggestions.push(`使用頻度ペナルティをさらに強化する必要があります（${overusedLines.length}個が過使用）`);
                }
                
                if (coverageRate < 13) {
                    const needed = Math.ceil(384 * 0.13) - uniqueLines;
                    suggestions.push(`あと${needed}個の新規爻を使用する必要があります`);
                }
                
                suggestions.push('探索ノイズをさらに増加させる');
                suggestions.push('セッション時間による多様性ボーナスを強化');
                suggestions.push('特定の卦への偏りを是正するバランシング機能を追加');
                
                suggestions.forEach((s, i) => {
                    html += `${i + 1}. ${s}\n`;
                });
                
                html += '</pre></div>';
                
                // 過使用爻トップ10
                if (overusedLines.length > 0) {
                    html += '<div class="result-box">';
                    html += '<h3>⚠️ 過使用爻トップ10</h3>';
                    html += '<table>';
                    html += '<tr><th>爻ID</th><th>卦</th><th>位置</th><th>使用回数</th></tr>';
                    overusedLines.sort((a, b) => b.count - a.count).slice(0, 10).forEach(item => {
                        const hexagramId = Math.ceil(item.id / 6);
                        const position = ((item.id - 1) % 6) + 1;
                        html += `<tr>
                            <td>${item.id}</td>
                            <td>${hexagramId}卦</td>
                            <td>${position}爻</td>
                            <td class="warning">${item.count}回</td>
                        </tr>`;
                    });
                    html += '</table></div>';
                }
                
                resultsEl.innerHTML = html;
                statusEl.innerHTML = '<span class="success">✅ 分析完了</span>';
                
            } catch (error) {
                statusEl.innerHTML = `<span class="error">エラー: ${error.message}</span>`;
                console.error(error);
            }
        }
        
        analyzeCurrentCoverage();
    </script>
</body>
</html>