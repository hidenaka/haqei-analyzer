<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>E-1/2: ã‚«ãƒãƒ¼ç‡è©³ç´°åˆ†æ - æœªä½¿ç”¨çˆ»ãƒ‘ã‚¿ãƒ¼ãƒ³ç‰¹å®š</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .success { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .error { color: #f48771; }
        .info { color: #9cdcfe; }
        .result-box {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        pre { background: #1e1e1e; padding: 10px; border-radius: 3px; }
        .hexagram-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .hexagram-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 10px;
            border-radius: 5px;
            text-align: center;
        }
        .hexagram-lines {
            display: flex;
            justify-content: space-around;
            margin-top: 5px;
        }
        .line-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #f48771;
        }
        .line-indicator.used { background: #4ec9b0; }
        .line-indicator.partial { background: #dcdcaa; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #3e3e42;
            padding: 8px;
            text-align: left;
        }
        th { background: #2d2d30; }
    </style>
</head>
<body>
    <h1>ğŸ” E-1/2: ã‚«ãƒãƒ¼ç‡è©³ç´°åˆ†æ - æœªä½¿ç”¨çˆ»ãƒ‘ã‚¿ãƒ¼ãƒ³ç‰¹å®š</h1>
    <div id="status">åˆ†ææº–å‚™ä¸­...</div>
    <div id="results"></div>

    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // 500ã‚µãƒ³ãƒ—ãƒ«ã§ã®å¾¹åº•åˆ†æ
        function generateAnalysisSamples() {
            const samples = [];
            const patterns = [
                // å¤šæ§˜ãªãƒ‘ã‚¿ãƒ¼ãƒ³500å€‹
                "æ–°ã—ã„å§‹ã¾ã‚Š", "å”åŠ›é–¢ä¿‚", "å›°é›£ãªçŠ¶æ³", "å¤‰åŒ–ã®æ™‚æœŸ", "ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—", "å®Œæˆæ®µéš",
                "å†…é¢çš„æˆé•·", "å¤–éƒ¨ã¨ã®äº¤æ¸‰", "è©¦ç·´ã‚’ä¹—ã‚Šè¶Šãˆã‚‹", "æ±ºæ–­ã®æ™‚", "æœ€é«˜ã®æˆæœ", "çµ‚äº†ã¨å†ç”Ÿ",
                "åŸºç¤ã‚’å›ºã‚ã‚‹", "é–¢ä¿‚æ€§æ§‹ç¯‰", "å•é¡Œè§£æ±º", "è»¢æ›ç‚¹", "æˆç†Ÿã—ãŸåˆ¤æ–­", "æœ€çµ‚æ±ºå®š",
                "åˆæœŸæ®µéš", "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯", "æŒ‘æˆ¦çš„èª²é¡Œ", "å²è·¯ã«ç«‹ã¤", "çµ±ç‡åŠ›", "å®Œäº†å ±å‘Š",
                "ã‚¹ã‚¿ãƒ¼ãƒˆåœ°ç‚¹", "ç›¸äº’æ”¯æ´", "éšœå®³é™¤å»", "æ–¹å‘è»¢æ›", "ç®¡ç†è²¬ä»»", "ç· çµ",
                "ç«‹ã¡ä¸Šã’", "å”èª¿æ€§", "è‘›è—¤è§£æ±º", "é¸æŠè‚¢", "æ¨©é™è¡Œä½¿", "åˆ°é”ç‚¹",
                "å‰µå§‹", "é€£æºå¼·åŒ–", "é€†å¢ƒå…‹æœ", "ç’°å¢ƒå¤‰åŒ–", "æŒ‡å°çš„ç«‹å ´", "æ¥µè‡´",
                "èµ·å‹•", "ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã‚·ãƒƒãƒ—", "è‹¦åŠ´ã®æœ«", "èª¿æ•´æœŸé–“", "ä¸­å¿ƒçš„å½¹å‰²", "æœ€å¾Œã®ä»•ä¸Šã’",
                "ç¬¬ä¸€æ­©", "å†…çœ", "å£ã‚’ç ´ã‚‹", "ç§»è¡ŒæœŸ", "æ±ºå®šæ¨©", "çµæœ",
                "é–‹å§‹æº–å‚™", "ç›¸è«‡", "èª²é¡Œã«å‘ãåˆã†", "åˆ†å²ç‚¹", "æˆ¦ç•¥ç«‹æ¡ˆ", "æˆå°±"
            ];
            
            // å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è¤‡æ•°å›ã€ç•°ãªã‚‹æ–‡è„ˆã§ä½¿ç”¨
            for (let i = 0; i < 500; i++) {
                const pattern = patterns[i % patterns.length];
                const context = ["ã«ã¤ã„ã¦", "ã®æ™‚æœŸ", "ã‚’è€ƒãˆã‚‹", "ã«ç›´é¢", "ã®æ®µéš"][Math.floor(i / 100)];
                samples.push(`${pattern}${context}`);
            }
            
            return samples;
        }
        
        async function analyzeCurrentCoverage() {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            
            try {
                statusEl.innerHTML = '<span class="warning">TextTo384LinesBridgeåˆæœŸåŒ–ä¸­...</span>';
                const bridge = new TextTo384LinesBridge();
                await bridge.initialize();
                
                // lineUsageCountã‚’ãƒªã‚»ãƒƒãƒˆ
                bridge.lineUsageCount = {};
                
                statusEl.innerHTML = '<span class="info">500ã‚µãƒ³ãƒ—ãƒ«åˆ†æå®Ÿè¡Œä¸­...</span>';
                
                const samples = generateAnalysisSamples();
                const lineUsage = new Map();
                const hexagramCoverage = new Map();
                const positionPatterns = [0, 0, 0, 0, 0, 0];
                
                // åˆ†æå®Ÿè¡Œ
                for (const text of samples) {
                    const result = await bridge.analyzeText(text);
                    const lineId = result.line_384_id;
                    const hexagramId = result.hexagram_id;
                    const position = result.line_position;
                    
                    lineUsage.set(lineId, (lineUsage.get(lineId) || 0) + 1);
                    
                    if (!hexagramCoverage.has(hexagramId)) {
                        hexagramCoverage.set(hexagramId, new Set());
                    }
                    hexagramCoverage.get(hexagramId).add(position);
                    
                    if (position <= 6) {
                        positionPatterns[position - 1]++;
                    }
                }
                
                // åˆ†æçµæœ
                const uniqueLines = lineUsage.size;
                const coverageRate = (uniqueLines / 384) * 100;
                const unusedLines = [];
                const rarelyUsedLines = [];
                const overusedLines = [];
                
                // æœªä½¿ç”¨ãƒ»ä½ä½¿ç”¨ãƒ»éä½¿ç”¨çˆ»ã®ç‰¹å®š
                for (let i = 1; i <= 384; i++) {
                    const usage = lineUsage.get(i) || 0;
                    if (usage === 0) {
                        unusedLines.push(i);
                    } else if (usage === 1) {
                        rarelyUsedLines.push(i);
                    } else if (usage > 10) {
                        overusedLines.push({ id: i, count: usage });
                    }
                }
                
                // çµæœè¡¨ç¤º
                let html = '';
                
                // ã‚µãƒãƒªãƒ¼
                html += '<div class="result-box">';
                html += '<h2>ğŸ“Š E-1: ç¾çŠ¶ã‚«ãƒãƒ¼ç‡åˆ†æçµæœ</h2>';
                html += '<pre>';
                html += `ç·ã‚µãƒ³ãƒ—ãƒ«æ•°: 500\n`;
                html += `ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°: <span class="${uniqueLines >= 50 ? 'success' : 'warning'}">${uniqueLines}/384</span>\n`;
                html += `ã‚«ãƒãƒ¼ç‡: <span class="${coverageRate >= 13 ? 'success' : 'error'}">${coverageRate.toFixed(2)}%</span>\n`;
                html += `æœªä½¿ç”¨çˆ»æ•°: <span class="error">${unusedLines.length}å€‹</span>\n`;
                html += `ä½ä½¿ç”¨çˆ»æ•°ï¼ˆ1å›ã®ã¿ï¼‰: <span class="warning">${rarelyUsedLines.length}å€‹</span>\n`;
                html += `éä½¿ç”¨çˆ»æ•°ï¼ˆ10å›è¶…ï¼‰: <span class="warning">${overusedLines.length}å€‹</span>\n`;
                html += '</pre></div>';
                
                // E-2: æœªä½¿ç”¨çˆ»ã®ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ
                html += '<div class="result-box">';
                html += '<h2>ğŸ” E-2: æœªä½¿ç”¨çˆ»ãƒ‘ã‚¿ãƒ¼ãƒ³åˆ†æ</h2>';
                
                // å¦ã”ã¨ã®æœªä½¿ç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³
                const unusedByHexagram = new Map();
                unusedLines.forEach(lineId => {
                    const hexagramId = Math.ceil(lineId / 6);
                    const position = ((lineId - 1) % 6) + 1;
                    if (!unusedByHexagram.has(hexagramId)) {
                        unusedByHexagram.set(hexagramId, []);
                    }
                    unusedByHexagram.get(hexagramId).push(position);
                });
                
                // ä½ç½®ã”ã¨ã®æœªä½¿ç”¨æ•°
                const unusedByPosition = [0, 0, 0, 0, 0, 0];
                unusedLines.forEach(lineId => {
                    const position = ((lineId - 1) % 6) + 1;
                    unusedByPosition[position - 1]++;
                });
                
                html += '<h3>ä½ç½®åˆ¥æœªä½¿ç”¨çˆ»æ•°</h3>';
                html += '<table>';
                html += '<tr><th>çˆ»ä½ç½®</th><th>æœªä½¿ç”¨æ•°</th><th>æœªä½¿ç”¨ç‡</th><th>åˆ†æ</th></tr>';
                unusedByPosition.forEach((count, idx) => {
                    const rate = (count / 64 * 100).toFixed(1);
                    const analysis = count > 40 ? 'âŒ æ·±åˆ»ãªåã‚Š' : 
                                    count > 20 ? 'âš ï¸ è¦æ”¹å–„' : 
                                    'âœ… è¨±å®¹ç¯„å›²';
                    html += `<tr>
                        <td>${idx + 1}çˆ»</td>
                        <td>${count}/64</td>
                        <td>${rate}%</td>
                        <td>${analysis}</td>
                    </tr>`;
                });
                html += '</table>';
                
                // å®Œå…¨æœªä½¿ç”¨ã®å¦
                html += '<h3>å®Œå…¨æœªä½¿ç”¨ã®å¦ï¼ˆå…¨6çˆ»ãŒæœªä½¿ç”¨ï¼‰</h3>';
                html += '<pre>';
                let completelyUnusedCount = 0;
                for (let hexId = 1; hexId <= 64; hexId++) {
                    const unusedPositions = unusedByHexagram.get(hexId) || [];
                    if (unusedPositions.length === 6) {
                        html += `å¦${hexId}: å…¨çˆ»æœªä½¿ç”¨\n`;
                        completelyUnusedCount++;
                    }
                }
                if (completelyUnusedCount === 0) {
                    html += '<span class="success">ãªã—ï¼ˆè‰¯å¥½ï¼‰</span>\n';
                }
                html += '</pre>';
                
                // æ”¹å–„ææ¡ˆ
                html += '<h3>ğŸ“ˆ æ”¹å–„ææ¡ˆ</h3>';
                html += '<pre>';
                
                const suggestions = [];
                
                // ä½ç½®åˆ¥ã®å•é¡Œã‚’ç‰¹å®š
                unusedByPosition.forEach((count, idx) => {
                    if (count > 30) {
                        suggestions.push(`${idx + 1}çˆ»ã®é¸æŠç‡ã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆç¾åœ¨${count}å€‹æœªä½¿ç”¨ï¼‰`);
                    }
                });
                
                if (overusedLines.length > 5) {
                    suggestions.push(`ä½¿ç”¨é »åº¦ãƒšãƒŠãƒ«ãƒ†ã‚£ã‚’ã•ã‚‰ã«å¼·åŒ–ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ${overusedLines.length}å€‹ãŒéä½¿ç”¨ï¼‰`);
                }
                
                if (coverageRate < 13) {
                    const needed = Math.ceil(384 * 0.13) - uniqueLines;
                    suggestions.push(`ã‚ã¨${needed}å€‹ã®æ–°è¦çˆ»ã‚’ä½¿ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™`);
                }
                
                suggestions.push('æ¢ç´¢ãƒã‚¤ã‚ºã‚’ã•ã‚‰ã«å¢—åŠ ã•ã›ã‚‹');
                suggestions.push('ã‚»ãƒƒã‚·ãƒ§ãƒ³æ™‚é–“ã«ã‚ˆã‚‹å¤šæ§˜æ€§ãƒœãƒ¼ãƒŠã‚¹ã‚’å¼·åŒ–');
                suggestions.push('ç‰¹å®šã®å¦ã¸ã®åã‚Šã‚’æ˜¯æ­£ã™ã‚‹ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°æ©Ÿèƒ½ã‚’è¿½åŠ ');
                
                suggestions.forEach((s, i) => {
                    html += `${i + 1}. ${s}\n`;
                });
                
                html += '</pre></div>';
                
                // éä½¿ç”¨çˆ»ãƒˆãƒƒãƒ—10
                if (overusedLines.length > 0) {
                    html += '<div class="result-box">';
                    html += '<h3>âš ï¸ éä½¿ç”¨çˆ»ãƒˆãƒƒãƒ—10</h3>';
                    html += '<table>';
                    html += '<tr><th>çˆ»ID</th><th>å¦</th><th>ä½ç½®</th><th>ä½¿ç”¨å›æ•°</th></tr>';
                    overusedLines.sort((a, b) => b.count - a.count).slice(0, 10).forEach(item => {
                        const hexagramId = Math.ceil(item.id / 6);
                        const position = ((item.id - 1) % 6) + 1;
                        html += `<tr>
                            <td>${item.id}</td>
                            <td>${hexagramId}å¦</td>
                            <td>${position}çˆ»</td>
                            <td class="warning">${item.count}å›</td>
                        </tr>`;
                    });
                    html += '</table></div>';
                }
                
                resultsEl.innerHTML = html;
                statusEl.innerHTML = '<span class="success">âœ… åˆ†æå®Œäº†</span>';
                
            } catch (error) {
                statusEl.innerHTML = `<span class="error">ã‚¨ãƒ©ãƒ¼: ${error.message}</span>`;
                console.error(error);
            }
        }
        
        analyzeCurrentCoverage();
    </script>
</body>
</html>