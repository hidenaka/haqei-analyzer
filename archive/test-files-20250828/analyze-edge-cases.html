<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 5 - エッジケース分析</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        .test-case {
            background: #2d2d30;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error { color: #f48771; }
        .success { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        th { background: #252526; }
        .input-sample {
            font-family: monospace;
            background: #1e1e1e;
            padding: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>Day 5 - エッジケース分析</h1>
    
    <div id="results"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        async function analyzeEdgeCases() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            // エッジケーステストサンプル
            const edgeCases = {
                shortText: [
                    { text: "愛", category: "超短文(1文字)" },
                    { text: "勝つ", category: "短文(2文字)" },
                    { text: "頑張る", category: "短文(3文字)" },
                    { text: "今日", category: "短文(2文字・時間)" },
                    { text: "私", category: "短文(1文字・主語)" }
                ],
                longText: [
                    { text: "今日は天気が良いので、友人たちと一緒に公園でピクニックをすることにしました。お弁当を作って、レジャーシートを持って、楽しい時間を過ごす予定です。", category: "長文(70文字)" },
                    { text: "プロジェクトの締め切りが近づいているため、チーム全員で協力して作業を進めています。品質を維持しながら効率的に進めることが重要で、定期的なミーティングで進捗を確認しています。", category: "長文(85文字)" }
                ],
                specialChars: [
                    { text: "頑張る💪", category: "絵文字混在" },
                    { text: "やった〜(^o^)/", category: "顔文字混在" },
                    { text: "Hello世界！", category: "英語混在" },
                    { text: "売上↑30%達成", category: "記号・数字混在" },
                    { text: "★重要★", category: "記号使用" }
                ],
                ambiguous: [
                    { text: "あれ", category: "曖昧（指示語）" },
                    { text: "なんか", category: "曖昧（不明瞭）" },
                    { text: "うーん", category: "曖昧（感嘆詞）" },
                    { text: "まあまあ", category: "曖昧（程度）" },
                    { text: "そんな感じ", category: "曖昧（表現）" }
                ],
                boundary: [
                    { text: "", category: "空文字列" },
                    { text: "　", category: "全角スペースのみ" },
                    { text: "\n\n", category: "改行のみ" },
                    { text: "あ" + "い".repeat(200), category: "超長文(201文字)" },
                    { text: "123456789", category: "数字のみ" }
                ]
            };
            
            let html = '';
            const results = {};
            
            // 各カテゴリのテスト
            for (const [category, samples] of Object.entries(edgeCases)) {
                html += `<div class="test-case">`;
                html += `<h2>${getCategoryName(category)}</h2>`;
                html += '<table>';
                html += '<tr><th>入力</th><th>カテゴリ</th><th>結果</th><th>エラー</th></tr>';
                
                results[category] = {
                    total: 0,
                    success: 0,
                    errors: []
                };
                
                for (const sample of samples) {
                    try {
                        const result = await bridge.analyzeText(sample.text || "");
                        results[category].total++;
                        
                        if (result && result.hexagram_number && result.line_position) {
                            results[category].success++;
                            html += '<tr>';
                            html += `<td class="input-sample">${escapeHtml(sample.text)}</td>`;
                            html += `<td>${sample.category}</td>`;
                            html += `<td class="success">✅ ${result.hexagram_number}卦${result.line_position}爻</td>`;
                            html += '<td>-</td>';
                            html += '</tr>';
                        } else {
                            throw new Error('不完全な結果');
                        }
                    } catch (error) {
                        results[category].errors.push({
                            sample: sample.text,
                            error: error.message
                        });
                        
                        html += '<tr>';
                        html += `<td class="input-sample">${escapeHtml(sample.text)}</td>`;
                        html += `<td>${sample.category}</td>`;
                        html += '<td class="error">❌ エラー</td>';
                        html += `<td class="error">${error.message}</td>`;
                        html += '</tr>';
                    }
                }
                
                html += '</table>';
                
                // カテゴリサマリー
                const successRate = ((results[category].success / results[category].total) * 100).toFixed(1);
                const statusClass = successRate >= 90 ? 'success' : successRate >= 70 ? 'warning' : 'error';
                html += `<p class="${statusClass}">成功率: ${successRate}% (${results[category].success}/${results[category].total})</p>`;
                
                if (results[category].errors.length > 0) {
                    html += '<p class="error">エラー詳細:</p>';
                    html += '<ul>';
                    for (const err of results[category].errors) {
                        html += `<li>"${escapeHtml(err.sample)}": ${err.error}</li>`;
                    }
                    html += '</ul>';
                }
                
                html += '</div>';
            }
            
            // 総合評価
            html += '<div class="test-case">';
            html += '<h2>📊 総合評価</h2>';
            
            let totalTests = 0;
            let totalSuccess = 0;
            
            for (const cat of Object.values(results)) {
                totalTests += cat.total;
                totalSuccess += cat.success;
            }
            
            const overallRate = ((totalSuccess / totalTests) * 100).toFixed(1);
            const overallClass = overallRate >= 90 ? 'success' : overallRate >= 70 ? 'warning' : 'error';
            
            html += `<p class="${overallClass}" style="font-size: 1.5em;">総合成功率: ${overallRate}% (${totalSuccess}/${totalTests})</p>`;
            
            html += '<h3>改善が必要な領域</h3>';
            html += '<ul>';
            for (const [category, data] of Object.entries(results)) {
                const rate = (data.success / data.total) * 100;
                if (rate < 90) {
                    html += `<li class="warning">${getCategoryName(category)}: ${rate.toFixed(1)}%</li>`;
                }
            }
            html += '</ul>';
            
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        function getCategoryName(key) {
            const names = {
                shortText: '短文処理',
                longText: '長文処理',
                specialChars: '特殊文字・記号',
                ambiguous: '曖昧入力',
                boundary: '境界値'
            };
            return names[key] || key;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        analyzeEdgeCases();
    </script>
</body>
</html>