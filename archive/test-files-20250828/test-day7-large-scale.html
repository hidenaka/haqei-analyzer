<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 7 - 500サンプル大規模テスト（Task 7-2）</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1600px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        h3 { color: #dcdcaa; }
        
        .test-section {
            background: #2d2d30;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .metrics-dashboard {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-tile {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .metric-label {
            font-size: 0.9em;
            color: #808080;
        }
        
        .achieved { color: #4ec9b0; }
        .partial { color: #dcdcaa; }
        .failed { color: #f48771; }
        
        .distribution-chart {
            display: flex;
            align-items: flex-end;
            height: 200px;
            gap: 10px;
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 5px;
        }
        
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #4ec9b0, #569cd6);
            border-radius: 3px 3px 0 0;
            position: relative;
            min-height: 10px;
        }
        
        .chart-label {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.9em;
        }
        
        .chart-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: bold;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { 
            background: #252526;
            font-weight: bold;
        }
        
        .heatmap-grid {
            display: grid;
            grid-template-columns: repeat(16, 1fr);
            gap: 2px;
            margin: 20px 0;
            padding: 10px;
            background: #1e1e1e;
            border-radius: 5px;
        }
        
        .heatmap-cell {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7em;
            border-radius: 2px;
        }
        
        .heat-0 { background: #5a1e1e; }
        .heat-1 { background: #4a4a1e; }
        .heat-2 { background: #3a3a2e; }
        .heat-3 { background: #2a4a3e; }
        .heat-4 { background: #1a5a4e; }
        .heat-5 { background: #0a6a5e; }
        
        .progress-container {
            margin: 20px 0;
            padding: 20px;
            background: #252526;
            border-radius: 5px;
        }
        
        .progress-bar {
            height: 40px;
            background: #1e1e1e;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            color: #fff;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Day 7 - 500サンプル大規模テスト（Task 7-2）</h1>
    
    <div id="results"></div>
    
    <script type="module">
        async function runLargeScaleTest() {
            // TextTo384LinesBridgeを動的にロード
            const script = document.createElement('script');
            script.src = './public/js/ai/TextTo384LinesBridge.js';
            await new Promise(resolve => {
                script.onload = resolve;
                document.head.appendChild(script);
            });
            
            const bridge = new window.TextTo384LinesBridge();
            await bridge.initialize();
            
            // 500サンプルの包括的なテストセット
            const testSamples = generateComprehensiveTestSet(500);
            
            // 統計データの初期化
            const statistics = {
                // 基本統計
                totalSamples: 500,
                uniqueLines: new Set(),
                positionDistribution: [0, 0, 0, 0, 0, 0, 0],
                hexagramUsage: {},
                lineUsage: {},
                
                // パフォーマンス
                processingTimes: [],
                cacheHits: 0,
                errors: [],
                
                // カテゴリ別統計
                categoryResults: {
                    basic: { total: 0, uniqueLines: new Set() },
                    business: { total: 0, uniqueLines: new Set() },
                    emotion: { total: 0, uniqueLines: new Set() },
                    action: { total: 0, uniqueLines: new Set() },
                    abstract: { total: 0, uniqueLines: new Set() }
                },
                
                // 時系列データ
                progressData: []
            };
            
            // 進捗表示
            let html = '<div class="progress-container">';
            html += '<h2>🚀 大規模テスト実行中...</h2>';
            html += '<div class="progress-bar"><div class="progress-fill" id="progress" style="width: 0%;">0/500</div></div>';
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
            
            // テスト実行
            for (let i = 0; i < testSamples.length; i++) {
                const sample = testSamples[i];
                
                try {
                    const startTime = performance.now();
                    const result = await bridge.analyzeText(sample.text);
                    const endTime = performance.now();
                    
                    // データ収集
                    const processingTime = endTime - startTime;
                    statistics.processingTimes.push(processingTime);
                    
                    const lineId = (result.hexagram_number - 1) * 6 + result.line_position;
                    statistics.uniqueLines.add(lineId);
                    statistics.positionDistribution[result.line_position]++;
                    
                    // 卦使用統計
                    if (!statistics.hexagramUsage[result.hexagram_number]) {
                        statistics.hexagramUsage[result.hexagram_number] = 0;
                    }
                    statistics.hexagramUsage[result.hexagram_number]++;
                    
                    // 爻使用統計
                    if (!statistics.lineUsage[lineId]) {
                        statistics.lineUsage[lineId] = 0;
                    }
                    statistics.lineUsage[lineId]++;
                    
                    // カテゴリ別統計
                    if (sample.category && statistics.categoryResults[sample.category]) {
                        statistics.categoryResults[sample.category].total++;
                        statistics.categoryResults[sample.category].uniqueLines.add(lineId);
                    }
                    
                    // キャッシュヒット
                    if (result.fromCache) {
                        statistics.cacheHits++;
                    }
                    
                    // 進捗データ（50サンプルごと）
                    if ((i + 1) % 50 === 0) {
                        statistics.progressData.push({
                            samples: i + 1,
                            coverage: (statistics.uniqueLines.size / 384) * 100,
                            avgTime: statistics.processingTimes.reduce((a, b) => a + b, 0) / statistics.processingTimes.length
                        });
                    }
                    
                } catch (error) {
                    statistics.errors.push({
                        sample: sample.text,
                        error: error.message
                    });
                }
                
                // 進捗更新
                if ((i + 1) % 25 === 0) {
                    const progress = ((i + 1) / 500) * 100;
                    document.getElementById('progress').style.width = progress + '%';
                    document.getElementById('progress').innerText = `${i + 1}/500`;
                }
            }
            
            // 結果の表示
            displayTestResults(statistics);
        }
        
        function displayTestResults(stats) {
            let html = '';
            
            // 主要メトリクスダッシュボード
            html += '<div class="test-section">';
            html += '<h2>📊 500サンプル大規模テスト結果</h2>';
            
            const coverageRate = (stats.uniqueLines.size / 384) * 100;
            const avgTime = stats.processingTimes.reduce((a, b) => a + b, 0) / stats.processingTimes.length;
            const errorRate = (stats.errors.length / stats.totalSamples) * 100;
            const cacheHitRate = (stats.cacheHits / stats.totalSamples) * 100;
            
            html += '<div class="metrics-dashboard">';
            
            html += '<div class="metric-tile">';
            html += '<div class="metric-label">カバー率</div>';
            html += `<div class="metric-value ${coverageRate >= 10 ? 'achieved' : 'partial'}">${coverageRate.toFixed(1)}%</div>`;
            html += '<div>目標: 10-15%</div>';
            html += '</div>';
            
            html += '<div class="metric-tile">';
            html += '<div class="metric-label">ユニーク爻数</div>';
            html += `<div class="metric-value ${stats.uniqueLines.size >= 40 ? 'achieved' : 'partial'}">${stats.uniqueLines.size}</div>`;
            html += '<div>目標: 40-60個</div>';
            html += '</div>';
            
            html += '<div class="metric-tile">';
            html += '<div class="metric-label">平均処理時間</div>';
            html += `<div class="metric-value ${avgTime <= 20 ? 'achieved' : 'partial'}">${avgTime.toFixed(1)}ms</div>`;
            html += '<div>目標: <15ms</div>';
            html += '</div>';
            
            html += '<div class="metric-tile">';
            html += '<div class="metric-label">エラー率</div>';
            html += `<div class="metric-value ${errorRate < 1 ? 'achieved' : 'failed'}">${errorRate.toFixed(2)}%</div>`;
            html += '<div>目標: <1%</div>';
            html += '</div>';
            
            html += '<div class="metric-tile">';
            html += '<div class="metric-label">使用された卦</div>';
            html += `<div class="metric-value partial">${Object.keys(stats.hexagramUsage).length}/64</div>`;
            html += '<div>全体の' + ((Object.keys(stats.hexagramUsage).length / 64) * 100).toFixed(0) + '%</div>';
            html += '</div>';
            
            html += '<div class="metric-tile">';
            html += '<div class="metric-label">キャッシュヒット率</div>';
            html += `<div class="metric-value achieved">${cacheHitRate.toFixed(1)}%</div>`;
            html += '<div>効率的</div>';
            html += '</div>';
            
            const pos5Rate = (stats.positionDistribution[5] / stats.totalSamples) * 100;
            html += '<div class="metric-tile">';
            html += '<div class="metric-label">5爻選択率</div>';
            html += `<div class="metric-value ${pos5Rate >= 5 && pos5Rate <= 10 ? 'achieved' : 'partial'}">${pos5Rate.toFixed(1)}%</div>`;
            html += '<div>目標: 5-10%</div>';
            html += '</div>';
            
            const chiSquare = calculateChiSquare(stats.positionDistribution.slice(1), stats.totalSamples);
            html += '<div class="metric-tile">';
            html += '<div class="metric-label">χ²値</div>';
            html += `<div class="metric-value ${chiSquare < 10 ? 'achieved' : 'partial'}">${chiSquare.toFixed(2)}</div>`;
            html += '<div>バランス指標</div>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            // 位置分布グラフ
            html += '<div class="test-section">';
            html += '<h2>📈 位置分布（500サンプル）</h2>';
            
            html += '<div class="distribution-chart">';
            const maxCount = Math.max(...stats.positionDistribution.slice(1));
            for (let i = 1; i <= 6; i++) {
                const count = stats.positionDistribution[i];
                const percentage = (count / stats.totalSamples) * 100;
                const height = (count / maxCount) * 100;
                
                html += `<div class="chart-bar" style="height: ${height}%;">`;
                html += `<div class="chart-value">${percentage.toFixed(1)}%</div>`;
                html += `<div class="chart-label">${i}爻</div>`;
                html += '</div>';
            }
            html += '</div>';
            
            html += '</div>';
            
            // カテゴリ別分析
            html += '<div class="test-section">';
            html += '<h2>🔍 カテゴリ別カバレッジ分析</h2>';
            
            html += '<table>';
            html += '<tr><th>カテゴリ</th><th>サンプル数</th><th>ユニーク爻</th><th>カバー率</th><th>多様性</th></tr>';
            
            for (const [category, data] of Object.entries(stats.categoryResults)) {
                if (data.total > 0) {
                    const categoryCoverage = (data.uniqueLines.size / 384) * 100;
                    const diversity = data.uniqueLines.size / data.total;
                    
                    html += '<tr>';
                    html += `<td>${getCategoryName(category)}</td>`;
                    html += `<td>${data.total}</td>`;
                    html += `<td>${data.uniqueLines.size}</td>`;
                    html += `<td>${categoryCoverage.toFixed(2)}%</td>`;
                    html += `<td class="${diversity >= 0.5 ? 'achieved' : diversity >= 0.3 ? 'partial' : 'failed'}">${(diversity * 100).toFixed(0)}%</td>`;
                    html += '</tr>';
                }
            }
            
            html += '</table>';
            html += '</div>';
            
            // 卦使用ヒートマップ
            html += '<div class="test-section">';
            html += '<h2>🗺️ 64卦使用ヒートマップ</h2>';
            
            html += '<div class="heatmap-grid">';
            for (let i = 1; i <= 64; i++) {
                const usage = stats.hexagramUsage[i] || 0;
                let heatClass = 'heat-0';
                if (usage >= 15) heatClass = 'heat-5';
                else if (usage >= 10) heatClass = 'heat-4';
                else if (usage >= 7) heatClass = 'heat-3';
                else if (usage >= 4) heatClass = 'heat-2';
                else if (usage >= 1) heatClass = 'heat-1';
                
                html += `<div class="heatmap-cell ${heatClass}" title="${i}卦: ${usage}回">${i}</div>`;
            }
            html += '</div>';
            
            const unusedHexagrams = [];
            for (let i = 1; i <= 64; i++) {
                if (!stats.hexagramUsage[i]) {
                    unusedHexagrams.push(i);
                }
            }
            
            if (unusedHexagrams.length > 0) {
                html += `<p class="failed">未使用の卦: ${unusedHexagrams.join(', ')} (${unusedHexagrams.length}個)</p>`;
            }
            
            html += '</div>';
            
            // 進捗トレンド
            html += '<div class="test-section">';
            html += '<h2>📊 カバレッジ進捗トレンド</h2>';
            
            html += '<table>';
            html += '<tr><th>サンプル数</th><th>カバー率</th><th>平均処理時間</th><th>トレンド</th></tr>';
            
            for (const point of stats.progressData) {
                const trend = point.coverage > 10 ? '↗️' : point.coverage > 8 ? '→' : '↘️';
                html += '<tr>';
                html += `<td>${point.samples}</td>`;
                html += `<td>${point.coverage.toFixed(2)}%</td>`;
                html += `<td>${point.avgTime.toFixed(1)}ms</td>`;
                html += `<td>${trend}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            html += '</div>';
            
            // 最頻出爻と未使用爻
            html += '<div class="test-section">';
            html += '<h2>🎯 使用頻度分析</h2>';
            
            // 最頻出TOP10
            const sortedLines = Object.entries(stats.lineUsage)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            html += '<h3>最頻出爻 TOP10</h3>';
            html += '<table>';
            html += '<tr><th>順位</th><th>爻ID</th><th>卦-位置</th><th>使用回数</th><th>占有率</th></tr>';
            
            for (let i = 0; i < sortedLines.length; i++) {
                const [lineId, count] = sortedLines[i];
                const hexagram = Math.ceil(lineId / 6);
                const position = ((parseInt(lineId) - 1) % 6) + 1;
                const rate = (count / stats.totalSamples) * 100;
                
                html += '<tr>';
                html += `<td>${i + 1}</td>`;
                html += `<td>#${lineId}</td>`;
                html += `<td>${hexagram}卦${position}爻</td>`;
                html += `<td>${count}</td>`;
                html += `<td>${rate.toFixed(2)}%</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            // 未使用爻の数
            const unusedLines = 384 - stats.uniqueLines.size;
            html += `<p>未使用爻: <span class="failed">${unusedLines}/384</span> (${((unusedLines / 384) * 100).toFixed(1)}%)</p>`;
            
            html += '</div>';
            
            // 総合評価
            html += '<div class="test-section" style="background: linear-gradient(135deg, #2d2d30, #3d3d40);">';
            html += '<h2>✅ 500サンプルテスト総合評価</h2>';
            
            const goals = [
                { name: 'カバー率 10-15%', achieved: coverageRate >= 10 },
                { name: 'ユニーク爻 40-60個', achieved: stats.uniqueLines.size >= 40 },
                { name: '5爻選択率 5-10%', achieved: pos5Rate >= 5 && pos5Rate <= 10 },
                { name: '処理速度 <15ms', achieved: avgTime <= 15 },
                { name: 'エラー率 <1%', achieved: errorRate < 1 }
            ];
            
            const achievedCount = goals.filter(g => g.achieved).length;
            
            html += `<h3>目標達成率: ${achievedCount}/${goals.length}</h3>`;
            html += '<ul>';
            for (const goal of goals) {
                html += `<li class="${goal.achieved ? 'achieved' : 'failed'}">${goal.achieved ? '✅' : '❌'} ${goal.name}</li>`;
            }
            html += '</ul>';
            
            if (achievedCount >= 4) {
                html += '<p class="achieved" style="font-size: 1.2em; text-align: center;">🎊 Week 1の目標を概ね達成しました！</p>';
            } else if (achievedCount >= 3) {
                html += '<p class="partial" style="font-size: 1.2em; text-align: center;">⚠️ 部分的な達成です。さらなる改善が必要です。</p>';
            } else {
                html += '<p class="failed" style="font-size: 1.2em; text-align: center;">❌ 追加の作業が必要です。</p>';
            }
            
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        function generateComprehensiveTestSet(count) {
            const samples = [];
            
            // カテゴリ定義
            const categories = {
                basic: [
                    '新しい', '始まり', '開始', '協力', '関係', '困難', '問題', '変化',
                    '転換', 'リーダー', '管理', '完成', '終了', '決断', '判断', '戦略'
                ],
                business: [
                    'プロジェクト', '会議', '提案', '契約', '交渉', '売上', '利益', '投資',
                    '経営', '組織', 'マーケティング', '開発', '製造', '品質', '改善', '効率'
                ],
                emotion: [
                    '喜び', '悲しみ', '怒り', '恐れ', '驚き', '期待', '不安', '希望',
                    '愛情', '憎しみ', '信頼', '疑い', '満足', '不満', '感謝', '後悔'
                ],
                action: [
                    '実行', '計画', '分析', '評価', '改善', '構築', '破壊', '創造',
                    '保存', '削除', '更新', '移動', '停止', '開始', '継続', '終了'
                ],
                abstract: [
                    '概念', '理論', '哲学', '真理', '正義', '自由', '平等', '調和',
                    '均衡', '対立', '統合', '分離', '進化', '退化', '循環', '永遠'
                ]
            };
            
            // 各カテゴリから均等にサンプリング
            const samplesPerCategory = Math.floor(count / Object.keys(categories).length);
            
            for (const [category, words] of Object.entries(categories)) {
                for (let i = 0; i < samplesPerCategory; i++) {
                    const word = words[i % words.length];
                    const variations = [
                        word,
                        `${word}について`,
                        `${word}の時期`,
                        `${word}を考える`,
                        `新しい${word}`,
                        `${word}の変化`
                    ];
                    
                    samples.push({
                        text: variations[i % variations.length],
                        category: category
                    });
                }
            }
            
            // 残りを基本カテゴリで埋める
            while (samples.length < count) {
                samples.push({
                    text: categories.basic[samples.length % categories.basic.length],
                    category: 'basic'
                });
            }
            
            return samples;
        }
        
        function calculateChiSquare(distribution, total) {
            const expected = total / 6;
            let chiSquare = 0;
            
            for (const observed of distribution) {
                chiSquare += Math.pow(observed - expected, 2) / expected;
            }
            
            return chiSquare;
        }
        
        function getCategoryName(category) {
            const names = {
                basic: '基本',
                business: 'ビジネス',
                emotion: '感情',
                action: '行動',
                abstract: '抽象'
            };
            return names[category] || category;
        }
        
        runLargeScaleTest();
    </script>
</body>
</html>