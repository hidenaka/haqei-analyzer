<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 2 æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆ</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4; 
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        .summary { 
            background: #2d2d30; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        .excellent { 
            color: #4ec9b0; 
            font-weight: bold;
            font-size: 1.2em;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        th {
            background: #252526;
            color: #4ec9b0;
        }
        .progress-bar {
            background: #252526;
            height: 30px;
            border-radius: 5px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            height: 100%;
            transition: width 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #1e1e1e;
            font-weight: bold;
        }
        .metric-card {
            display: inline-block;
            background: #252526;
            padding: 15px;
            margin: 10px;
            border-radius: 5px;
            min-width: 150px;
            text-align: center;
        }
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 5px 0;
        }
        .metric-label {
            font-size: 0.9em;
            color: #cccccc;
        }
    </style>
</head>
<body>
    <h1>Day 2 æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆ - 5çˆ»æ”¹å–„çµæœ</h1>
    
    <div class="summary">
        <h2>ğŸ“Š å®Ÿæ–½ã—ãŸæ”¹å–„å†…å®¹</h2>
        <ul>
            <li>âœ… ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰è¿½åŠ : 25å€‹ â†’ 45å€‹ï¼ˆ+20å€‹ï¼‰</li>
            <li>âœ… ä½ç½®é‡ã¿èª¿æ•´: 0.50 â†’ 0.70ï¼ˆ+0.20ï¼‰</li>
            <li>âœ… æ¢ç´¢ãƒã‚¤ã‚º: 0.06 â†’ 0.10ï¼ˆ+0.04ï¼‰</li>
        </ul>
    </div>
    
    <div id="metrics"></div>
    <div id="progress"></div>
    <div id="results"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // 200ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
        async function loadTestData() {
            const response = await fetch('test-samples-200-categorized.json');
            return await response.json();
        }
        
        async function runFinalTest() {
            const statusEl = document.getElementById('progress');
            statusEl.innerHTML = '<div class="progress-bar"><div class="progress-fill" style="width: 0%">0%</div></div>';
            
            const testData = await loadTestData();
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                totalSamples: 0,
                positionCounts: [0, 0, 0, 0, 0, 0, 0],
                uniqueLines: new Set(),
                categoryResults: {},
                yao5Samples: [],
                timestamp: new Date().toISOString()
            };
            
            let processedCount = 0;
            const allSamples = [];
            
            // ã™ã¹ã¦ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’åé›†
            for (const [category, samples] of Object.entries(testData.samples)) {
                for (const text of samples) {
                    allSamples.push({ text, category });
                }
            }
            
            // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            for (const sample of allSamples) {
                const result = await bridge.analyzeText(sample.text);
                const lineKey = `${result.hexagram_number}-${result.line_position}`;
                
                results.uniqueLines.add(lineKey);
                results.positionCounts[result.line_position]++;
                
                if (!results.categoryResults[sample.category]) {
                    results.categoryResults[sample.category] = {
                        total: 0,
                        positionDistribution: [0, 0, 0, 0, 0, 0, 0]
                    };
                }
                
                results.categoryResults[sample.category].total++;
                results.categoryResults[sample.category].positionDistribution[result.line_position]++;
                
                if (result.line_position === 5) {
                    results.yao5Samples.push({
                        text: sample.text,
                        category: sample.category,
                        line: lineKey
                    });
                }
                
                results.totalSamples++;
                processedCount++;
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼æ›´æ–°
                const progress = Math.floor((processedCount / allSamples.length) * 100);
                statusEl.innerHTML = `<div class="progress-bar"><div class="progress-fill" style="width: ${progress}%">${progress}%</div></div>`;
            }
            
            // çµ±è¨ˆè¨ˆç®—
            const stats = calculateStatistics(results);
            
            // çµæœè¡¨ç¤º
            displayMetrics(stats);
            displayResults(results, stats);
            
            // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
            console.log('Day 2æœ€çµ‚çµæœ:', { results, stats });
        }
        
        function calculateStatistics(results) {
            const total = results.totalSamples;
            const positions = results.positionCounts.slice(1);
            
            // å„ç¨®çµ±è¨ˆå€¤
            const stats = {
                coverageRate: ((results.uniqueLines.size / 384) * 100).toFixed(2),
                uniqueLines: results.uniqueLines.size,
                yao5Rate: ((results.positionCounts[5] / total) * 100).toFixed(2),
                positionPercentages: positions.map(count => ((count / total) * 100).toFixed(1)),
                totalSamples: total
            };
            
            // Ï‡Â²æ¤œå®š
            const expectedCount = total / 6;
            stats.chiSquare = positions.reduce((sum, count) => 
                sum + Math.pow(count - expectedCount, 2) / expectedCount, 0).toFixed(2);
            
            // åå·®
            const variance = positions.reduce((sum, count) => 
                sum + Math.pow(count - expectedCount, 2), 0) / 6;
            stats.stdDev = Math.sqrt(variance).toFixed(2);
            
            return stats;
        }
        
        function displayMetrics(stats) {
            let html = '<div style="text-align: center;">';
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚«ãƒ¼ãƒ‰
            const yao5Class = parseFloat(stats.yao5Rate) >= 5 ? 'good' : 
                             parseFloat(stats.yao5Rate) >= 3 ? 'warning' : 'bad';
            
            html += `<div class="metric-card">
                <div class="metric-label">5çˆ»é¸æŠç‡</div>
                <div class="metric-value ${yao5Class}">${stats.yao5Rate}%</div>
                <div class="metric-label">ç›®æ¨™: 5-10%</div>
            </div>`;
            
            const coverageClass = parseFloat(stats.coverageRate) >= 10 ? 'good' : 
                                 parseFloat(stats.coverageRate) >= 7 ? 'warning' : 'bad';
            
            html += `<div class="metric-card">
                <div class="metric-label">ã‚«ãƒãƒ¼ç‡</div>
                <div class="metric-value ${coverageClass}">${stats.coverageRate}%</div>
                <div class="metric-label">ç›®æ¨™: 10-15%</div>
            </div>`;
            
            const uniqueClass = stats.uniqueLines >= 40 ? 'good' : 
                               stats.uniqueLines >= 30 ? 'warning' : 'bad';
            
            html += `<div class="metric-card">
                <div class="metric-label">ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»</div>
                <div class="metric-value ${uniqueClass}">${stats.uniqueLines}</div>
                <div class="metric-label">ç›®æ¨™: 40-60</div>
            </div>`;
            
            html += '</div>';
            
            document.getElementById('metrics').innerHTML = html;
        }
        
        function displayResults(results, stats) {
            let html = '';
            
            // ä½ç½®åˆ¥åˆ†å¸ƒ
            html += '<div class="summary">';
            html += '<h2>ğŸ“ˆ ä½ç½®åˆ¥åˆ†å¸ƒ</h2>';
            html += '<table>';
            html += '<tr><th>ä½ç½®</th><th>å›æ•°</th><th>å‰²åˆ</th><th>ç†æƒ³å€¤ã¨ã®å·®</th><th>ã‚°ãƒ©ãƒ•</th></tr>';
            
            const ideal = 16.67;
            for (let i = 1; i <= 6; i++) {
                const count = results.positionCounts[i];
                const percent = parseFloat(stats.positionPercentages[i-1]);
                const diff = (percent - ideal).toFixed(1);
                const diffClass = Math.abs(diff) <= 5 ? 'good' : 
                                 Math.abs(diff) <= 10 ? 'warning' : 'bad';
                
                const barWidth = Math.min(percent * 3, 100);
                const rowClass = i === 5 ? 'style="background: #1e3a1e;"' : '';
                
                html += `<tr ${rowClass}>`;
                html += `<td>${i}çˆ»</td>`;
                html += `<td>${count}</td>`;
                html += `<td>${percent}%</td>`;
                html += `<td class="${diffClass}">${diff > 0 ? '+' : ''}${diff}%</td>`;
                html += `<td><div style="width: ${barWidth}px; height: 15px; background: #4ec9b0;"></div></td>`;
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // ã‚«ãƒ†ã‚´ãƒªåˆ¥5çˆ»é¸æŠç‡
            html += '<div class="summary">';
            html += '<h2>ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥5çˆ»é¸æŠç‡</h2>';
            html += '<table>';
            html += '<tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>ã‚µãƒ³ãƒ—ãƒ«æ•°</th><th>5çˆ»é¸æŠæ•°</th><th>é¸æŠç‡</th></tr>';
            
            for (const [category, data] of Object.entries(results.categoryResults)) {
                const yao5Count = data.positionDistribution[5];
                const rate = ((yao5Count / data.total) * 100).toFixed(1);
                const rateClass = parseFloat(rate) >= 10 ? 'good' : 
                                 parseFloat(rate) >= 5 ? 'warning' : '';
                
                html += '<tr>';
                html += `<td>${category}</td>`;
                html += `<td>${data.total}</td>`;
                html += `<td>${yao5Count}</td>`;
                html += `<td class="${rateClass}">${rate}%</td>`;
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // æœ€çµ‚è©•ä¾¡
            html += '<div class="summary">';
            html += '<h2>ğŸ¯ Day 2 æœ€çµ‚è©•ä¾¡</h2>';
            
            const yao5Achieved = parseFloat(stats.yao5Rate) >= 5;
            const coverageProgress = parseFloat(stats.coverageRate) >= 7;
            const uniqueProgress = stats.uniqueLines >= 30;
            
            if (yao5Achieved) {
                html += '<p class="excellent">âœ… 5çˆ»é¸æŠç‡ç›®æ¨™é”æˆï¼ ' + stats.yao5Rate + '% (ç›®æ¨™: 5-10%)</p>';
            } else {
                html += '<p class="warning">âš ï¸ 5çˆ»é¸æŠç‡: ' + stats.yao5Rate + '% (ç›®æ¨™æœªé”)</p>';
            }
            
            if (coverageProgress) {
                html += '<p class="good">ğŸ“ˆ ã‚«ãƒãƒ¼ç‡æ”¹å–„: ' + stats.coverageRate + '% (é †èª¿ã«å‘ä¸Šä¸­)</p>';
            }
            
            if (uniqueProgress) {
                html += '<p class="good">ğŸ“Š ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°: ' + stats.uniqueLines + 'å€‹ (ç€å®Ÿã«å¢—åŠ )</p>';
            }
            
            html += '<h3>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ— (Day 3)</h3>';
            html += '<ul>';
            html += '<li>2çˆ»/6çˆ»ã®åã‚Šæ˜¯æ­£</li>';
            html += '<li>ã‚«ãƒãƒ¼ç‡ã®ã•ã‚‰ãªã‚‹å‘ä¸Š</li>';
            html += '<li>å…¨ä½“çš„ãªãƒãƒ©ãƒ³ã‚¹èª¿æ•´</li>';
            html += '</ul>';
            
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        runFinalTest();
    </script>
</body>
</html>