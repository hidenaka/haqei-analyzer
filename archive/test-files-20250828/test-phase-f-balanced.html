<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>F-6～F-10: 均等分布達成テスト（500サンプル・χ²検定）</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .success { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .error { color: #f48771; }
        .info { color: #9cdcfe; }
        .result-box {
            background: #252526;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        pre {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
        }
        .metric-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        .metric-card {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
        }
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            margin: 15px 0;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #2d2d30;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4ec9b0, #569cd6);
            transition: width 0.3s ease;
        }
        .position-chart {
            margin: 20px 0;
        }
        .bar-container {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        .bar-label {
            width: 60px;
            text-align: right;
            margin-right: 10px;
        }
        .bar-wrapper {
            flex: 1;
            background: #2d2d30;
            height: 30px;
            border-radius: 5px;
            position: relative;
        }
        .bar-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }
        .bar-1 { background: #569cd6; }
        .bar-2 { background: #4ec9b0; }
        .bar-3 { background: #dcdcaa; }
        .bar-4 { background: #c586c0; }
        .bar-5 { background: #4fc1ff; }
        .bar-6 { background: #9cdcfe; }
        .bar-percent {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #1e1e1e;
            font-weight: bold;
        }
        .ideal-line {
            position: absolute;
            left: 16.67%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #f48771;
            opacity: 0.5;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            border: 1px solid #3e3e42;
            padding: 10px;
            text-align: left;
        }
        th { background: #2d2d30; }
        .chi-square-result {
            font-size: 20px;
            margin: 20px 0;
            padding: 15px;
            background: #2d2d30;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>⚖️ F-6～F-10: 均等分布達成テスト（500サンプル・統計検証）</h1>
    <div id="status">テスト準備中...</div>
    <div id="progress-container" style="display: none;">
        <div class="progress-bar">
            <div id="progress-fill" class="progress-fill" style="width: 0%"></div>
        </div>
        <span id="progress-text">0/500</span>
    </div>
    <div id="results"></div>

    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // F-6: 500サンプル生成
        function generatePhaseFSamples() {
            const samples = [];
            
            // 完全にランダムな日本語テキストのパターン
            const patterns = [
                // ビジネス系
                "会議の準備", "資料作成", "プレゼンテーション", "報告書", "企画書",
                "予算計画", "売上分析", "市場調査", "競合分析", "戦略立案",
                "プロジェクト管理", "タスク管理", "スケジュール調整", "進捗確認", "品質管理",
                
                // 日常系
                "今日の天気", "明日の予定", "週末の計画", "買い物リスト", "家事",
                "料理", "掃除", "洗濯", "運動", "散歩",
                "読書", "映画鑑賞", "音楽", "趣味", "休憩",
                
                // 学習系
                "勉強", "研究", "論文", "実験", "分析",
                "調査", "検証", "考察", "結論", "発表",
                "授業", "講義", "セミナー", "ワークショップ", "研修",
                
                // 感情系
                "嬉しい", "楽しい", "幸せ", "満足", "期待",
                "不安", "心配", "疲れ", "ストレス", "リラックス",
                "興奮", "驚き", "感動", "感謝", "希望",
                
                // アクション系
                "開始", "継続", "変更", "修正", "改善",
                "実行", "実施", "適用", "導入", "展開",
                "評価", "判断", "決定", "選択", "確認",
                
                // 状態系
                "安定", "変動", "成長", "停滞", "回復",
                "向上", "低下", "維持", "改善", "悪化",
                "正常", "異常", "良好", "不良", "普通",
                
                // 時間系
                "朝", "昼", "夜", "今", "後で",
                "早い", "遅い", "急ぐ", "ゆっくり", "時間",
                "期限", "締切", "開始時刻", "終了時刻", "期間",
                
                // 場所系
                "会社", "自宅", "外出", "出張", "旅行",
                "オフィス", "会議室", "カフェ", "図書館", "公園",
                "駅", "空港", "ホテル", "レストラン", "店",
                
                // 人間関係系
                "同僚", "上司", "部下", "顧客", "パートナー",
                "友人", "家族", "親", "子供", "先生",
                "生徒", "メンバー", "チーム", "グループ", "組織",
                
                // その他
                "システム", "データ", "情報", "ネットワーク", "セキュリティ",
                "効率", "生産性", "コスト", "利益", "価値"
            ];
            
            // 各パターンを複数の文脈で使用（合計500サンプル）
            const contexts = [
                "について", "の確認", "を検討", "に関して", "の段階",
                "を実施", "の準備", "を開始", "の完了", "を評価"
            ];
            
            // 500サンプル生成
            for (let i = 0; i < 500; i++) {
                const pattern = patterns[i % patterns.length];
                const context = contexts[Math.floor(i / 50) % contexts.length];
                const number = Math.floor(i / 100) + 1;
                samples.push(`${pattern}${context}${number}`);
            }
            
            // 決定論的シャッフル（再現可能）
            for (let i = samples.length - 1; i > 0; i--) {
                const j = (i * 13) % (i + 1);
                [samples[i], samples[j]] = [samples[j], samples[i]];
            }
            
            return samples;
        }
        
        // F-7: χ²検定の実装
        function chiSquareTest(observed, expected) {
            let chiSquare = 0;
            for (let i = 0; i < observed.length; i++) {
                const diff = observed[i] - expected[i];
                chiSquare += (diff * diff) / expected[i];
            }
            
            // 自由度 = カテゴリ数 - 1 = 6 - 1 = 5
            const df = 5;
            
            // χ²分布の臨界値（有意水準5%）
            const criticalValue = 11.07; // df=5, α=0.05
            
            return {
                chiSquare: chiSquare,
                criticalValue: criticalValue,
                degreesOfFreedom: df,
                significant: chiSquare > criticalValue,
                pValue: calculatePValue(chiSquare, df)
            };
        }
        
        // 簡易的なp値計算（近似）
        function calculatePValue(chiSquare, df) {
            // ガンマ関数の近似を使った簡易計算
            if (chiSquare < 0.1) return 1.0;
            if (chiSquare > 30) return 0.001;
            
            // 簡易近似式
            const x = chiSquare / (2 * df);
            const p = Math.exp(-x) * Math.pow(x, df/2) / factorial(df/2);
            return Math.min(1, Math.max(0.001, p));
        }
        
        function factorial(n) {
            if (n <= 1) return 1;
            let result = 1;
            for (let i = 2; i <= n; i++) {
                result *= i;
            }
            return result;
        }
        
        async function runPhaseFTest() {
            const statusEl = document.getElementById('status');
            const progressContainer = document.getElementById('progress-container');
            const progressFill = document.getElementById('progress-fill');
            const progressText = document.getElementById('progress-text');
            const resultsEl = document.getElementById('results');
            
            try {
                statusEl.innerHTML = '<span class="warning">TextTo384LinesBridge初期化中...</span>';
                const bridge = new TextTo384LinesBridge();
                await bridge.initialize();
                
                // リセット
                bridge.lineUsageCount = {};
                bridge.positionDistribution = [0, 0, 0, 0, 0, 0];
                
                statusEl.innerHTML = '<span class="info">F-6: 500サンプルテスト実行中...</span>';
                progressContainer.style.display = 'block';
                
                const samples = generatePhaseFSamples();
                const results = {
                    positionCount: [0, 0, 0, 0, 0, 0],
                    uniqueLines: new Set(),
                    processingTimes: [],
                    totalSamples: samples.length
                };
                
                // テスト実行
                for (let i = 0; i < samples.length; i++) {
                    const text = samples[i];
                    const startTime = performance.now();
                    const result = await bridge.analyzeText(text);
                    const processingTime = performance.now() - startTime;
                    
                    results.processingTimes.push(processingTime);
                    results.uniqueLines.add(result.line_384_id);
                    
                    const position = result.line_position;
                    if (position >= 1 && position <= 6) {
                        results.positionCount[position - 1]++;
                    }
                    
                    // プログレスバー更新
                    if ((i + 1) % 10 === 0) {
                        const progress = ((i + 1) / samples.length * 100);
                        progressFill.style.width = `${progress}%`;
                        progressText.textContent = `${i + 1}/${samples.length}`;
                    }
                }
                
                // F-7: 統計的検証
                const expectedCount = results.totalSamples / 6; // 500/6 ≈ 83.33
                const expectedCounts = Array(6).fill(expectedCount);
                const chiSquareResult = chiSquareTest(results.positionCount, expectedCounts);
                
                let html = '';
                
                // メトリクスカード
                html += '<div class="metric-grid">';
                
                // F-8: 偏り度
                const maxCount = Math.max(...results.positionCount);
                const minCount = Math.min(...results.positionCount);
                const bias = ((maxCount - minCount) / expectedCount * 100);
                const biasSuccess = bias < 20; // 20%以内を目標
                
                html += `<div class="metric-card">
                    <div class="info">偏り度</div>
                    <div class="metric-value ${biasSuccess ? 'success' : 'warning'}">${bias.toFixed(1)}%</div>
                    <div>${biasSuccess ? '✅ 良好' : '⚠️ 改善余地あり'}</div>
                </div>`;
                
                // F-7: χ²値
                html += `<div class="metric-card">
                    <div class="info">χ²検定</div>
                    <div class="metric-value ${!chiSquareResult.significant ? 'success' : 'warning'}">${chiSquareResult.chiSquare.toFixed(2)}</div>
                    <div>臨界値: ${chiSquareResult.criticalValue}</div>
                </div>`;
                
                // カバー率
                const coverageRate = (results.uniqueLines.size / 384) * 100;
                html += `<div class="metric-card">
                    <div class="info">カバー率</div>
                    <div class="metric-value ${coverageRate >= 13 ? 'success' : 'warning'}">${coverageRate.toFixed(1)}%</div>
                    <div>${results.uniqueLines.size}/384爻</div>
                </div>`;
                
                html += '</div>';
                
                // F-9: 分布チャート
                html += '<div class="result-box">';
                html += '<h3>📊 F-9: 位置別分布（目標: 各16.67%）</h3>';
                html += '<div class="position-chart">';
                
                results.positionCount.forEach((count, idx) => {
                    const percentage = (count / results.totalSamples * 100);
                    const deviation = Math.abs(percentage - 16.67);
                    const barClass = deviation < 3 ? 'success' : deviation < 5 ? 'warning' : 'error';
                    
                    html += `<div class="bar-container">
                        <div class="bar-label">${idx + 1}爻</div>
                        <div class="bar-wrapper">
                            <div class="ideal-line"></div>
                            <div class="bar-fill bar-${idx + 1}" style="width: ${percentage}%">
                                <span class="bar-percent">${percentage.toFixed(1)}%</span>
                            </div>
                        </div>
                    </div>`;
                });
                
                html += '</div></div>';
                
                // χ²検定結果詳細
                html += '<div class="result-box">';
                html += '<h3>📐 F-7: χ²検定結果</h3>';
                html += '<div class="chi-square-result">';
                html += '<table>';
                html += '<tr><th>項目</th><th>値</th><th>判定</th></tr>';
                html += `<tr>
                    <td>χ²統計量</td>
                    <td>${chiSquareResult.chiSquare.toFixed(4)}</td>
                    <td class="${!chiSquareResult.significant ? 'success' : 'warning'}">
                        ${!chiSquareResult.significant ? '有意差なし（均等）' : '有意差あり（偏りあり）'}
                    </td>
                </tr>`;
                html += `<tr><td>自由度</td><td>${chiSquareResult.degreesOfFreedom}</td><td>-</td></tr>`;
                html += `<tr><td>臨界値（α=0.05）</td><td>${chiSquareResult.criticalValue}</td><td>-</td></tr>`;
                html += `<tr><td>p値（推定）</td><td>${chiSquareResult.pValue.toFixed(4)}</td><td>-</td></tr>`;
                html += '</table>';
                html += '</div></div>';
                
                // F-10: タスク完了状況
                html += '<div class="result-box">';
                html += '<h3>✅ F タスク達成状況</h3>';
                
                const tasks = [
                    { id: 'F-1', desc: '各位置の現状分析', done: true },
                    { id: 'F-2', desc: '理想分布モデル作成', done: true },
                    { id: 'F-3', desc: '位置別重み微調整', done: true },
                    { id: 'F-4', desc: 'キーワード配分最適化', done: true },
                    { id: 'F-5', desc: 'バランシングアルゴリズム実装', done: true },
                    { id: 'F-6', desc: '500サンプルテスト実施', done: true },
                    { id: 'F-7', desc: `χ²検定（${chiSquareResult.chiSquare.toFixed(2)}）`, done: !chiSquareResult.significant },
                    { id: 'F-8', desc: `偏り確認（${bias.toFixed(1)}%）`, done: biasSuccess },
                    { id: 'F-9', desc: '最終分布確認', done: true },
                    { id: 'F-10', desc: '完了報告', done: true }
                ];
                
                tasks.forEach(task => {
                    const statusIcon = task.done ? '✅' : '❌';
                    const statusClass = task.done ? 'success' : 'error';
                    html += `<div class="${statusClass}">${statusIcon} ${task.id}: ${task.desc}</div>`;
                });
                
                const completedTasks = tasks.filter(t => t.done).length;
                const totalSuccess = completedTasks === tasks.length;
                
                html += `<div style="margin-top: 15px; font-size: 18px;">`;
                html += `完了: ${completedTasks}/10 タスク`;
                if (totalSuccess) {
                    html += '<span class="success"> - Phase F 完全達成！🎉</span>';
                } else if (completedTasks >= 8) {
                    html += '<span class="success"> - ほぼ達成！</span>';
                } else {
                    html += '<span class="warning"> - 追加調整必要</span>';
                }
                html += '</div></div>';
                
                // 詳細統計
                html += '<div class="result-box">';
                html += '<h3>📈 詳細統計</h3>';
                html += '<pre>';
                
                const avgTime = results.processingTimes.reduce((a, b) => a + b, 0) / results.processingTimes.length;
                const maxTime = Math.max(...results.processingTimes);
                const minTime = Math.min(...results.processingTimes);
                
                html += `処理時間統計:\n`;
                html += `  平均: ${avgTime.toFixed(2)}ms\n`;
                html += `  最小: ${minTime.toFixed(2)}ms\n`;
                html += `  最大: ${maxTime.toFixed(2)}ms\n\n`;
                
                html += `位置別偏差:\n`;
                results.positionCount.forEach((count, idx) => {
                    const percentage = (count / results.totalSamples * 100);
                    const deviation = percentage - 16.67;
                    const sign = deviation >= 0 ? '+' : '';
                    html += `  ${idx + 1}爻: ${sign}${deviation.toFixed(2)}%\n`;
                });
                
                html += '</pre></div>';
                
                resultsEl.innerHTML = html;
                statusEl.innerHTML = totalSuccess ? 
                    '<span class="success">✅ Phase F 完全達成！均等分布実現！</span>' :
                    '<span class="warning">⚠️ テスト完了（一部調整必要）</span>';
                progressContainer.style.display = 'none';
                
            } catch (error) {
                statusEl.innerHTML = `<span class="error">エラー: ${error.message}</span>`;
                console.error(error);
            }
        }
        
        runPhaseFTest();
    </script>
</body>
</html>