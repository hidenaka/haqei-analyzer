<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>緊急修正テスト - 300サンプル検証</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #00ff00;
        }
        .header {
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .metric-box {
            border: 1px solid #00ff00;
            padding: 10px;
            text-align: center;
        }
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        .success { color: #00ff00; }
        .warning { color: #ffff00; }
        .error { color: #ff0000; }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border: 1px solid #00ff00;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00ff99);
            transition: width 0.3s;
        }
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin: 20px 0;
        }
        .sample-cell {
            width: 30px;
            height: 30px;
            border: 1px solid #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .used { background: #00ff0033; }
        .position-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .position-box {
            border: 1px solid #00ff00;
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🚨 緊急修正検証システム</h1>
        <h2>300サンプルテスト - 2025年8月26日 緊急対応</h2>
        <p>目標: カバー率10%以上 | 5爻出現率1%以上</p>
    </div>

    <div class="test-section">
        <h3>⏱️ テスト進行状況</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        <div id="status">準備中...</div>
    </div>

    <div class="metrics">
        <div class="metric-box">
            <div>カバー率</div>
            <div class="metric-value" id="coverage">0%</div>
            <div id="coverage-status">目標: 10%</div>
        </div>
        <div class="metric-box">
            <div>5爻出現率</div>
            <div class="metric-value" id="position5">0%</div>
            <div id="position5-status">目標: 1%</div>
        </div>
        <div class="metric-box">
            <div>ユニーク爻数</div>
            <div class="metric-value" id="unique">0</div>
            <div>/ 384</div>
        </div>
    </div>

    <div class="test-section">
        <h3>📊 位置別出現率</h3>
        <div class="position-stats" id="position-stats"></div>
    </div>

    <div class="test-section">
        <h3>🎯 詳細統計</h3>
        <div id="detailed-stats"></div>
    </div>

    <div class="test-section">
        <h3>💾 テストサンプル進行</h3>
        <div class="sample-grid" id="sample-grid"></div>
    </div>

    <div class="test-section">
        <h3>📝 ログ</h3>
        <div id="log" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <!-- 384爻データ -->
    <script src="public/data/yao-base-characteristics.js"></script>
    <script src="public/data/enhanced-yao-characteristics.js"></script>
    <script src="public/js/data/hexagram-lines-data.js"></script>
    
    <!-- コアシステム -->
    <script src="public/js/ai/TextTo384LinesBridge.js"></script>

    <script>
        // Test samples (300 samples across different categories)
        const testSamples = [
            // Category 1: 決定・判断系 (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "どうすればよいか判断に迷っています",
                    "重要な決定を下す必要があります",
                    "これを選ぶべきか決めかねている",
                    "方針を決定する必要がある",
                    "判断基準が必要です",
                    "リーダーとして決断を迫られている",
                    "経営判断を下さなければならない",
                    "マネージャーとして選択を迫られる",
                    "戦略的な決定が必要だ",
                    "今後の方向性を決める時期"
                ][i % 10],
                category: "decision"
            })),

            // Category 2: 始まり・スタート系 (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "新しいプロジェクトを始める",
                    "今から開始する予定です",
                    "初めての挑戦に臨む",
                    "スタートラインに立っている",
                    "ゼロから始める覚悟",
                    "新規事業の立ち上げ",
                    "最初の一歩を踏み出す",
                    "起業を考えている",
                    "新天地でのスタート",
                    "初心に返って始める"
                ][i % 10],
                category: "beginning"
            })),

            // Category 3: 変化・転換系 (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "転職を考えています",
                    "人生の転換期にいる",
                    "変化が必要な時期",
                    "新しい環境に移る",
                    "方向転換を検討中",
                    "キャリアチェンジ",
                    "環境を変える必要がある",
                    "大きな変化の時",
                    "転機が訪れている",
                    "変革の必要性を感じる"
                ][i % 10],
                category: "change"
            })),

            // Category 4: 関係性・人間関係系 (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "人間関係に悩んでいる",
                    "チームワークを改善したい",
                    "パートナーとの関係",
                    "家族との向き合い方",
                    "職場の人間関係",
                    "友人関係の悩み",
                    "コミュニケーションの問題",
                    "信頼関係を築きたい",
                    "協力体制を作る",
                    "人との距離感"
                ][i % 10],
                category: "relationship"
            })),

            // Category 5: 成長・発展系 (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "成長したいと思っている",
                    "スキルアップを目指す",
                    "自己改善に取り組む",
                    "能力を高めたい",
                    "学習を続けている",
                    "発展の可能性を探る",
                    "成果を上げたい",
                    "レベルアップを図る",
                    "進化し続ける必要",
                    "自己実現への道"
                ][i % 10],
                category: "growth"
            }))
        ];

        // Statistics tracking
        let stats = {
            totalTests: 0,
            uniqueLines: new Set(),
            positionCounts: [0, 0, 0, 0, 0, 0],
            lineUsage: {},
            hexagramUsage: {}
        };

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            log.innerHTML = `<div class="${colorClass}">[${timestamp}] ${message}</div>` + log.innerHTML;
        }

        async function runTest() {
            addLog('テスト開始: 300サンプル処理中...', 'info');
            
            // Initialize TextTo384LinesBridge
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            // Process all samples
            for (let i = 0; i < testSamples.length; i++) {
                const sample = testSamples[i];
                
                try {
                    // Get line mapping
                    const result = await bridge.analyzeTextToSpecificLine(sample.text);
                    
                    if (result && result.line_384_id) {
                        stats.totalTests++;
                        
                        // Track unique lines
                        const lineId = result.line_384_id;
                        stats.uniqueLines.add(lineId);
                        
                        // Track position counts (1-based position)
                        const position = result.line_position;
                        if (position >= 1 && position <= 6) {
                            stats.positionCounts[position - 1]++;
                        }
                        
                        // Track line usage
                        stats.lineUsage[lineId] = (stats.lineUsage[lineId] || 0) + 1;
                        
                        // Track hexagram usage
                        const hexagramId = result.hexagram_id;
                        stats.hexagramUsage[hexagramId] = (stats.hexagramUsage[hexagramId] || 0) + 1;
                    }
                } catch (error) {
                    addLog(`Sample ${i + 1} error: ${error.message}`, 'error');
                }
                
                // Update progress
                const progress = ((i + 1) / testSamples.length) * 100;
                document.getElementById('progress').style.width = progress + '%';
                document.getElementById('status').textContent = `処理中: ${i + 1} / ${testSamples.length}`;
                
                // Update metrics every 10 samples
                if ((i + 1) % 10 === 0) {
                    updateMetrics();
                }
            }
            
            // Final update
            updateMetrics();
            generateFinalReport();
        }

        function updateMetrics() {
            // Coverage rate
            const coverage = (stats.uniqueLines.size / 384) * 100;
            const coverageEl = document.getElementById('coverage');
            coverageEl.textContent = coverage.toFixed(2) + '%';
            coverageEl.className = coverage >= 10 ? 'metric-value success' : 
                                   coverage >= 8 ? 'metric-value warning' : 
                                   'metric-value error';
            
            const coverageStatus = document.getElementById('coverage-status');
            coverageStatus.textContent = coverage >= 10 ? '✅ 目標達成!' : `目標: 10% (残り: ${(10 - coverage).toFixed(2)}%)`;
            coverageStatus.className = coverage >= 10 ? 'success' : 'warning';
            
            // Position 5 rate
            const total = stats.positionCounts.reduce((a, b) => a + b, 0);
            const pos5Rate = total > 0 ? (stats.positionCounts[4] / total) * 100 : 0;
            const pos5El = document.getElementById('position5');
            pos5El.textContent = pos5Rate.toFixed(2) + '%';
            pos5El.className = pos5Rate >= 1 ? 'metric-value success' : 
                               pos5Rate >= 0.5 ? 'metric-value warning' : 
                               'metric-value error';
            
            const pos5Status = document.getElementById('position5-status');
            pos5Status.textContent = pos5Rate >= 1 ? '✅ 目標達成!' : `目標: 1% (残り: ${(1 - pos5Rate).toFixed(2)}%)`;
            pos5Status.className = pos5Rate >= 1 ? 'success' : 'warning';
            
            // Unique lines count
            document.getElementById('unique').textContent = stats.uniqueLines.size;
            
            // Position statistics
            updatePositionStats();
        }

        function updatePositionStats() {
            const container = document.getElementById('position-stats');
            const total = stats.positionCounts.reduce((a, b) => a + b, 0);
            
            container.innerHTML = stats.positionCounts.map((count, i) => {
                const rate = total > 0 ? (count / total * 100).toFixed(1) : 0;
                const posName = ['初爻', '二爻', '三爻', '四爻', '五爻', '上爻'][i];
                const isPos5 = i === 4;
                const colorClass = isPos5 && rate >= 1 ? 'success' : 
                                  isPos5 && rate > 0 ? 'warning' : 
                                  isPos5 ? 'error' : '';
                
                return `
                    <div class="position-box ${colorClass}">
                        <div>${posName}</div>
                        <div style="font-size: 20px; font-weight: bold;">${rate}%</div>
                        <div style="font-size: 12px;">(${count}回)</div>
                    </div>
                `;
            }).join('');
        }

        function generateFinalReport() {
            const coverage = (stats.uniqueLines.size / 384) * 100;
            const total = stats.positionCounts.reduce((a, b) => a + b, 0);
            const pos5Rate = total > 0 ? (stats.positionCounts[4] / total) * 100 : 0;
            
            const detailedStats = document.getElementById('detailed-stats');
            
            // Calculate hexagram coverage
            const uniqueHexagrams = new Set(Object.keys(stats.hexagramUsage).map(id => Math.ceil(id / 6)));
            const hexagramCoverage = (uniqueHexagrams.size / 64) * 100;
            
            // Find most and least used lines
            const sortedLines = Object.entries(stats.lineUsage).sort((a, b) => b[1] - a[1]);
            const mostUsed = sortedLines.slice(0, 5);
            const neverUsed = [];
            for (let i = 1; i <= 384; i++) {
                if (!stats.lineUsage[i]) {
                    neverUsed.push(i);
                }
            }
            
            detailedStats.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>📊 総合結果</h4>
                        <ul>
                            <li>総テスト数: ${stats.totalTests}</li>
                            <li>カバー率: <span class="${coverage >= 10 ? 'success' : 'error'}">${coverage.toFixed(2)}%</span> ${coverage >= 10 ? '✅' : '❌'}</li>
                            <li>5爻出現率: <span class="${pos5Rate >= 1 ? 'success' : 'error'}">${pos5Rate.toFixed(2)}%</span> ${pos5Rate >= 1 ? '✅' : '❌'}</li>
                            <li>ユニーク爻数: ${stats.uniqueLines.size} / 384</li>
                            <li>卦カバー率: ${hexagramCoverage.toFixed(1)}% (${uniqueHexagrams.size}/64卦)</li>
                        </ul>
                    </div>
                    <div>
                        <h4>🎯 目標達成状況</h4>
                        <ul>
                            <li>カバー率目標 (10%): ${coverage >= 10 ? '✅ 達成' : `❌ 未達成 (残り ${(10 - coverage).toFixed(2)}%)`}</li>
                            <li>5爻出現率目標 (1%): ${pos5Rate >= 1 ? '✅ 達成' : `❌ 未達成 (残り ${(1 - pos5Rate).toFixed(2)}%)`}</li>
                            <li>総合判定: ${coverage >= 10 && pos5Rate >= 1 ? '✅ 合格' : '❌ 不合格'}</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>📈 最多使用爻 TOP5</h4>
                    <ol>
                        ${mostUsed.map(([lineId, count]) => `<li>爻ID ${lineId}: ${count}回</li>`).join('')}
                    </ol>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>⚠️ 未使用爻数</h4>
                    <p>${neverUsed.length}個 / 384個 (${((384 - neverUsed.length) / 384 * 100).toFixed(1)}%使用済み)</p>
                </div>
            `;
            
            // Final status
            const finalStatus = coverage >= 10 && pos5Rate >= 1 ? 
                '✅ 緊急修正成功！すべての目標を達成しました。' : 
                '❌ 緊急修正未完了。さらなる調整が必要です。';
            
            addLog(finalStatus, coverage >= 10 && pos5Rate >= 1 ? 'success' : 'error');
            document.getElementById('status').innerHTML = `<strong>${finalStatus}</strong>`;
        }

        // Start test when page loads
        window.onload = () => {
            setTimeout(runTest, 1000);
        };
    </script>
</body>
</html>