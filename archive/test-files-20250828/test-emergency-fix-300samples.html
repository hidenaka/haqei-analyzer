<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ç·Šæ€¥ä¿®æ­£ãƒ†ã‚¹ãƒˆ - 300ã‚µãƒ³ãƒ—ãƒ«æ¤œè¨¼</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #1a1a1a; 
            color: #00ff00;
        }
        .header {
            border: 2px solid #00ff00;
            padding: 20px;
            margin-bottom: 20px;
        }
        .test-section {
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 10px 0;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        .metric-box {
            border: 1px solid #00ff00;
            padding: 10px;
            text-align: center;
        }
        .metric-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }
        .success { color: #00ff00; }
        .warning { color: #ffff00; }
        .error { color: #ff0000; }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border: 1px solid #00ff00;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff00, #00ff99);
            transition: width 0.3s;
        }
        .sample-grid {
            display: grid;
            grid-template-columns: repeat(10, 1fr);
            gap: 5px;
            margin: 20px 0;
        }
        .sample-cell {
            width: 30px;
            height: 30px;
            border: 1px solid #00ff00;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
        }
        .used { background: #00ff0033; }
        .position-stats {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .position-box {
            border: 1px solid #00ff00;
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸš¨ ç·Šæ€¥ä¿®æ­£æ¤œè¨¼ã‚·ã‚¹ãƒ†ãƒ </h1>
        <h2>300ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆ - 2025å¹´8æœˆ26æ—¥ ç·Šæ€¥å¯¾å¿œ</h2>
        <p>ç›®æ¨™: ã‚«ãƒãƒ¼ç‡10%ä»¥ä¸Š | 5çˆ»å‡ºç¾ç‡1%ä»¥ä¸Š</p>
    </div>

    <div class="test-section">
        <h3>â±ï¸ ãƒ†ã‚¹ãƒˆé€²è¡ŒçŠ¶æ³</h3>
        <div class="progress-bar">
            <div class="progress-fill" id="progress"></div>
        </div>
        <div id="status">æº–å‚™ä¸­...</div>
    </div>

    <div class="metrics">
        <div class="metric-box">
            <div>ã‚«ãƒãƒ¼ç‡</div>
            <div class="metric-value" id="coverage">0%</div>
            <div id="coverage-status">ç›®æ¨™: 10%</div>
        </div>
        <div class="metric-box">
            <div>5çˆ»å‡ºç¾ç‡</div>
            <div class="metric-value" id="position5">0%</div>
            <div id="position5-status">ç›®æ¨™: 1%</div>
        </div>
        <div class="metric-box">
            <div>ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°</div>
            <div class="metric-value" id="unique">0</div>
            <div>/ 384</div>
        </div>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š ä½ç½®åˆ¥å‡ºç¾ç‡</h3>
        <div class="position-stats" id="position-stats"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ¯ è©³ç´°çµ±è¨ˆ</h3>
        <div id="detailed-stats"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ’¾ ãƒ†ã‚¹ãƒˆã‚µãƒ³ãƒ—ãƒ«é€²è¡Œ</h3>
        <div class="sample-grid" id="sample-grid"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ“ ãƒ­ã‚°</h3>
        <div id="log" style="max-height: 300px; overflow-y: auto;"></div>
    </div>

    <!-- 384çˆ»ãƒ‡ãƒ¼ã‚¿ -->
    <script src="public/data/yao-base-characteristics.js"></script>
    <script src="public/data/enhanced-yao-characteristics.js"></script>
    <script src="public/js/data/hexagram-lines-data.js"></script>
    
    <!-- ã‚³ã‚¢ã‚·ã‚¹ãƒ†ãƒ  -->
    <script src="public/js/ai/TextTo384LinesBridge.js"></script>

    <script>
        // Test samples (300 samples across different categories)
        const testSamples = [
            // Category 1: æ±ºå®šãƒ»åˆ¤æ–­ç³» (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "ã©ã†ã™ã‚Œã°ã‚ˆã„ã‹åˆ¤æ–­ã«è¿·ã£ã¦ã„ã¾ã™",
                    "é‡è¦ãªæ±ºå®šã‚’ä¸‹ã™å¿…è¦ãŒã‚ã‚Šã¾ã™",
                    "ã“ã‚Œã‚’é¸ã¶ã¹ãã‹æ±ºã‚ã‹ã­ã¦ã„ã‚‹",
                    "æ–¹é‡ã‚’æ±ºå®šã™ã‚‹å¿…è¦ãŒã‚ã‚‹",
                    "åˆ¤æ–­åŸºæº–ãŒå¿…è¦ã§ã™",
                    "ãƒªãƒ¼ãƒ€ãƒ¼ã¨ã—ã¦æ±ºæ–­ã‚’è¿«ã‚‰ã‚Œã¦ã„ã‚‹",
                    "çµŒå–¶åˆ¤æ–­ã‚’ä¸‹ã•ãªã‘ã‚Œã°ãªã‚‰ãªã„",
                    "ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨ã—ã¦é¸æŠã‚’è¿«ã‚‰ã‚Œã‚‹",
                    "æˆ¦ç•¥çš„ãªæ±ºå®šãŒå¿…è¦ã ",
                    "ä»Šå¾Œã®æ–¹å‘æ€§ã‚’æ±ºã‚ã‚‹æ™‚æœŸ"
                ][i % 10],
                category: "decision"
            })),

            // Category 2: å§‹ã¾ã‚Šãƒ»ã‚¹ã‚¿ãƒ¼ãƒˆç³» (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å§‹ã‚ã‚‹",
                    "ä»Šã‹ã‚‰é–‹å§‹ã™ã‚‹äºˆå®šã§ã™",
                    "åˆã‚ã¦ã®æŒ‘æˆ¦ã«è‡¨ã‚€",
                    "ã‚¹ã‚¿ãƒ¼ãƒˆãƒ©ã‚¤ãƒ³ã«ç«‹ã£ã¦ã„ã‚‹",
                    "ã‚¼ãƒ­ã‹ã‚‰å§‹ã‚ã‚‹è¦šæ‚Ÿ",
                    "æ–°è¦äº‹æ¥­ã®ç«‹ã¡ä¸Šã’",
                    "æœ€åˆã®ä¸€æ­©ã‚’è¸ã¿å‡ºã™",
                    "èµ·æ¥­ã‚’è€ƒãˆã¦ã„ã‚‹",
                    "æ–°å¤©åœ°ã§ã®ã‚¹ã‚¿ãƒ¼ãƒˆ",
                    "åˆå¿ƒã«è¿”ã£ã¦å§‹ã‚ã‚‹"
                ][i % 10],
                category: "beginning"
            })),

            // Category 3: å¤‰åŒ–ãƒ»è»¢æ›ç³» (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "è»¢è·ã‚’è€ƒãˆã¦ã„ã¾ã™",
                    "äººç”Ÿã®è»¢æ›æœŸã«ã„ã‚‹",
                    "å¤‰åŒ–ãŒå¿…è¦ãªæ™‚æœŸ",
                    "æ–°ã—ã„ç’°å¢ƒã«ç§»ã‚‹",
                    "æ–¹å‘è»¢æ›ã‚’æ¤œè¨ä¸­",
                    "ã‚­ãƒ£ãƒªã‚¢ãƒã‚§ãƒ³ã‚¸",
                    "ç’°å¢ƒã‚’å¤‰ãˆã‚‹å¿…è¦ãŒã‚ã‚‹",
                    "å¤§ããªå¤‰åŒ–ã®æ™‚",
                    "è»¢æ©ŸãŒè¨ªã‚Œã¦ã„ã‚‹",
                    "å¤‰é©ã®å¿…è¦æ€§ã‚’æ„Ÿã˜ã‚‹"
                ][i % 10],
                category: "change"
            })),

            // Category 4: é–¢ä¿‚æ€§ãƒ»äººé–“é–¢ä¿‚ç³» (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "äººé–“é–¢ä¿‚ã«æ‚©ã‚“ã§ã„ã‚‹",
                    "ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ”¹å–„ã—ãŸã„",
                    "ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼ã¨ã®é–¢ä¿‚",
                    "å®¶æ—ã¨ã®å‘ãåˆã„æ–¹",
                    "è·å ´ã®äººé–“é–¢ä¿‚",
                    "å‹äººé–¢ä¿‚ã®æ‚©ã¿",
                    "ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®å•é¡Œ",
                    "ä¿¡é ¼é–¢ä¿‚ã‚’ç¯‰ããŸã„",
                    "å”åŠ›ä½“åˆ¶ã‚’ä½œã‚‹",
                    "äººã¨ã®è·é›¢æ„Ÿ"
                ][i % 10],
                category: "relationship"
            })),

            // Category 5: æˆé•·ãƒ»ç™ºå±•ç³» (60 samples)
            ...Array(60).fill(null).map((_, i) => ({
                text: [
                    "æˆé•·ã—ãŸã„ã¨æ€ã£ã¦ã„ã‚‹",
                    "ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã‚’ç›®æŒ‡ã™",
                    "è‡ªå·±æ”¹å–„ã«å–ã‚Šçµ„ã‚€",
                    "èƒ½åŠ›ã‚’é«˜ã‚ãŸã„",
                    "å­¦ç¿’ã‚’ç¶šã‘ã¦ã„ã‚‹",
                    "ç™ºå±•ã®å¯èƒ½æ€§ã‚’æ¢ã‚‹",
                    "æˆæœã‚’ä¸Šã’ãŸã„",
                    "ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚’å›³ã‚‹",
                    "é€²åŒ–ã—ç¶šã‘ã‚‹å¿…è¦",
                    "è‡ªå·±å®Ÿç¾ã¸ã®é“"
                ][i % 10],
                category: "growth"
            }))
        ];

        // Statistics tracking
        let stats = {
            totalTests: 0,
            uniqueLines: new Set(),
            positionCounts: [0, 0, 0, 0, 0, 0],
            lineUsage: {},
            hexagramUsage: {}
        };

        function addLog(message, type = 'info') {
            const log = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const colorClass = type === 'error' ? 'error' : type === 'warning' ? 'warning' : 'success';
            log.innerHTML = `<div class="${colorClass}">[${timestamp}] ${message}</div>` + log.innerHTML;
        }

        async function runTest() {
            addLog('ãƒ†ã‚¹ãƒˆé–‹å§‹: 300ã‚µãƒ³ãƒ—ãƒ«å‡¦ç†ä¸­...', 'info');
            
            // Initialize TextTo384LinesBridge
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            // Process all samples
            for (let i = 0; i < testSamples.length; i++) {
                const sample = testSamples[i];
                
                try {
                    // Get line mapping
                    const result = await bridge.analyzeTextToSpecificLine(sample.text);
                    
                    if (result && result.line_384_id) {
                        stats.totalTests++;
                        
                        // Track unique lines
                        const lineId = result.line_384_id;
                        stats.uniqueLines.add(lineId);
                        
                        // Track position counts (1-based position)
                        const position = result.line_position;
                        if (position >= 1 && position <= 6) {
                            stats.positionCounts[position - 1]++;
                        }
                        
                        // Track line usage
                        stats.lineUsage[lineId] = (stats.lineUsage[lineId] || 0) + 1;
                        
                        // Track hexagram usage
                        const hexagramId = result.hexagram_id;
                        stats.hexagramUsage[hexagramId] = (stats.hexagramUsage[hexagramId] || 0) + 1;
                    }
                } catch (error) {
                    addLog(`Sample ${i + 1} error: ${error.message}`, 'error');
                }
                
                // Update progress
                const progress = ((i + 1) / testSamples.length) * 100;
                document.getElementById('progress').style.width = progress + '%';
                document.getElementById('status').textContent = `å‡¦ç†ä¸­: ${i + 1} / ${testSamples.length}`;
                
                // Update metrics every 10 samples
                if ((i + 1) % 10 === 0) {
                    updateMetrics();
                }
            }
            
            // Final update
            updateMetrics();
            generateFinalReport();
        }

        function updateMetrics() {
            // Coverage rate
            const coverage = (stats.uniqueLines.size / 384) * 100;
            const coverageEl = document.getElementById('coverage');
            coverageEl.textContent = coverage.toFixed(2) + '%';
            coverageEl.className = coverage >= 10 ? 'metric-value success' : 
                                   coverage >= 8 ? 'metric-value warning' : 
                                   'metric-value error';
            
            const coverageStatus = document.getElementById('coverage-status');
            coverageStatus.textContent = coverage >= 10 ? 'âœ… ç›®æ¨™é”æˆ!' : `ç›®æ¨™: 10% (æ®‹ã‚Š: ${(10 - coverage).toFixed(2)}%)`;
            coverageStatus.className = coverage >= 10 ? 'success' : 'warning';
            
            // Position 5 rate
            const total = stats.positionCounts.reduce((a, b) => a + b, 0);
            const pos5Rate = total > 0 ? (stats.positionCounts[4] / total) * 100 : 0;
            const pos5El = document.getElementById('position5');
            pos5El.textContent = pos5Rate.toFixed(2) + '%';
            pos5El.className = pos5Rate >= 1 ? 'metric-value success' : 
                               pos5Rate >= 0.5 ? 'metric-value warning' : 
                               'metric-value error';
            
            const pos5Status = document.getElementById('position5-status');
            pos5Status.textContent = pos5Rate >= 1 ? 'âœ… ç›®æ¨™é”æˆ!' : `ç›®æ¨™: 1% (æ®‹ã‚Š: ${(1 - pos5Rate).toFixed(2)}%)`;
            pos5Status.className = pos5Rate >= 1 ? 'success' : 'warning';
            
            // Unique lines count
            document.getElementById('unique').textContent = stats.uniqueLines.size;
            
            // Position statistics
            updatePositionStats();
        }

        function updatePositionStats() {
            const container = document.getElementById('position-stats');
            const total = stats.positionCounts.reduce((a, b) => a + b, 0);
            
            container.innerHTML = stats.positionCounts.map((count, i) => {
                const rate = total > 0 ? (count / total * 100).toFixed(1) : 0;
                const posName = ['åˆçˆ»', 'äºŒçˆ»', 'ä¸‰çˆ»', 'å››çˆ»', 'äº”çˆ»', 'ä¸Šçˆ»'][i];
                const isPos5 = i === 4;
                const colorClass = isPos5 && rate >= 1 ? 'success' : 
                                  isPos5 && rate > 0 ? 'warning' : 
                                  isPos5 ? 'error' : '';
                
                return `
                    <div class="position-box ${colorClass}">
                        <div>${posName}</div>
                        <div style="font-size: 20px; font-weight: bold;">${rate}%</div>
                        <div style="font-size: 12px;">(${count}å›)</div>
                    </div>
                `;
            }).join('');
        }

        function generateFinalReport() {
            const coverage = (stats.uniqueLines.size / 384) * 100;
            const total = stats.positionCounts.reduce((a, b) => a + b, 0);
            const pos5Rate = total > 0 ? (stats.positionCounts[4] / total) * 100 : 0;
            
            const detailedStats = document.getElementById('detailed-stats');
            
            // Calculate hexagram coverage
            const uniqueHexagrams = new Set(Object.keys(stats.hexagramUsage).map(id => Math.ceil(id / 6)));
            const hexagramCoverage = (uniqueHexagrams.size / 64) * 100;
            
            // Find most and least used lines
            const sortedLines = Object.entries(stats.lineUsage).sort((a, b) => b[1] - a[1]);
            const mostUsed = sortedLines.slice(0, 5);
            const neverUsed = [];
            for (let i = 1; i <= 384; i++) {
                if (!stats.lineUsage[i]) {
                    neverUsed.push(i);
                }
            }
            
            detailedStats.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <h4>ğŸ“Š ç·åˆçµæœ</h4>
                        <ul>
                            <li>ç·ãƒ†ã‚¹ãƒˆæ•°: ${stats.totalTests}</li>
                            <li>ã‚«ãƒãƒ¼ç‡: <span class="${coverage >= 10 ? 'success' : 'error'}">${coverage.toFixed(2)}%</span> ${coverage >= 10 ? 'âœ…' : 'âŒ'}</li>
                            <li>5çˆ»å‡ºç¾ç‡: <span class="${pos5Rate >= 1 ? 'success' : 'error'}">${pos5Rate.toFixed(2)}%</span> ${pos5Rate >= 1 ? 'âœ…' : 'âŒ'}</li>
                            <li>ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°: ${stats.uniqueLines.size} / 384</li>
                            <li>å¦ã‚«ãƒãƒ¼ç‡: ${hexagramCoverage.toFixed(1)}% (${uniqueHexagrams.size}/64å¦)</li>
                        </ul>
                    </div>
                    <div>
                        <h4>ğŸ¯ ç›®æ¨™é”æˆçŠ¶æ³</h4>
                        <ul>
                            <li>ã‚«ãƒãƒ¼ç‡ç›®æ¨™ (10%): ${coverage >= 10 ? 'âœ… é”æˆ' : `âŒ æœªé”æˆ (æ®‹ã‚Š ${(10 - coverage).toFixed(2)}%)`}</li>
                            <li>5çˆ»å‡ºç¾ç‡ç›®æ¨™ (1%): ${pos5Rate >= 1 ? 'âœ… é”æˆ' : `âŒ æœªé”æˆ (æ®‹ã‚Š ${(1 - pos5Rate).toFixed(2)}%)`}</li>
                            <li>ç·åˆåˆ¤å®š: ${coverage >= 10 && pos5Rate >= 1 ? 'âœ… åˆæ ¼' : 'âŒ ä¸åˆæ ¼'}</li>
                        </ul>
                    </div>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>ğŸ“ˆ æœ€å¤šä½¿ç”¨çˆ» TOP5</h4>
                    <ol>
                        ${mostUsed.map(([lineId, count]) => `<li>çˆ»ID ${lineId}: ${count}å›</li>`).join('')}
                    </ol>
                </div>
                
                <div style="margin-top: 20px;">
                    <h4>âš ï¸ æœªä½¿ç”¨çˆ»æ•°</h4>
                    <p>${neverUsed.length}å€‹ / 384å€‹ (${((384 - neverUsed.length) / 384 * 100).toFixed(1)}%ä½¿ç”¨æ¸ˆã¿)</p>
                </div>
            `;
            
            // Final status
            const finalStatus = coverage >= 10 && pos5Rate >= 1 ? 
                'âœ… ç·Šæ€¥ä¿®æ­£æˆåŠŸï¼ã™ã¹ã¦ã®ç›®æ¨™ã‚’é”æˆã—ã¾ã—ãŸã€‚' : 
                'âŒ ç·Šæ€¥ä¿®æ­£æœªå®Œäº†ã€‚ã•ã‚‰ãªã‚‹èª¿æ•´ãŒå¿…è¦ã§ã™ã€‚';
            
            addLog(finalStatus, coverage >= 10 && pos5Rate >= 1 ? 'success' : 'error');
            document.getElementById('status').innerHTML = `<strong>${finalStatus}</strong>`;
        }

        // Start test when page loads
        window.onload = () => {
            setTimeout(runTest, 1000);
        };
    </script>
</body>
</html>