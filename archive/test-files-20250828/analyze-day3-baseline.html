<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 3 - 現状偏り分析</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        .analysis { 
            background: #2d2d30; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .high { color: #f48771; font-weight: bold; }
        .low { color: #569cd6; font-weight: bold; }
        .normal { color: #4ec9b0; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        th { background: #252526; }
        .deviation-chart {
            margin: 20px 0;
        }
        .bar {
            display: inline-block;
            height: 20px;
            margin-right: 5px;
        }
        .bar-over { background: #f48771; }
        .bar-under { background: #569cd6; }
        .bar-normal { background: #4ec9b0; }
    </style>
</head>
<body>
    <h1>Day 3 - 現状偏り分析</h1>
    
    <div id="loading">分析中...</div>
    <div id="results"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        async function analyzeBaseline() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            // テストサンプル（各カテゴリから均等に）
            const testSamples = {
                neutral: [
                    "日常的な業務を進める",
                    "通常の作業を継続",
                    "平常心を保つ",
                    "標準的な対応",
                    "一般的な処理"
                ],
                position1: [
                    "新しい挑戦を始める",
                    "スタート地点に立つ",
                    "初心者として学ぶ",
                    "基礎から始める",
                    "第一歩を踏み出す"
                ],
                position2: [
                    "協力して進める",
                    "チームワークを発揮",
                    "内面と向き合う",
                    "サポートする立場",
                    "相談に乗る"
                ],
                position3: [
                    "困難に直面する",
                    "試練を乗り越える",
                    "問題解決に取り組む",
                    "挑戦的な課題",
                    "壁を突破する"
                ],
                position4: [
                    "変化の時期",
                    "転換点を迎える",
                    "決断が必要",
                    "方向転換する",
                    "移行期にある"
                ],
                position5: [
                    "リーダーシップを発揮",
                    "部長として判断",
                    "統括的に管理",
                    "責任者として決定",
                    "マネージャーの立場"
                ],
                position6: [
                    "完成に向けて",
                    "最終段階",
                    "仕上げの作業",
                    "終了間近",
                    "締めくくり"
                ]
            };
            
            // 分析実行
            const results = {
                total: 0,
                positions: [0, 0, 0, 0, 0, 0, 0], // index 0は未使用
                categoryAnalysis: {},
                keywords: {
                    1: [], 2: [], 3: [], 4: [], 5: [], 6: []
                }
            };
            
            for (const [category, samples] of Object.entries(testSamples)) {
                results.categoryAnalysis[category] = {
                    samples: [],
                    positionCounts: [0, 0, 0, 0, 0, 0, 0]
                };
                
                for (const text of samples) {
                    const result = await bridge.analyzeText(text);
                    results.total++;
                    results.positions[result.line_position]++;
                    results.categoryAnalysis[category].samples.push({
                        text: text,
                        position: result.line_position
                    });
                    results.categoryAnalysis[category].positionCounts[result.line_position]++;
                }
            }
            
            displayAnalysis(results);
        }
        
        function displayAnalysis(results) {
            const ideal = 100 / 6; // 16.67%
            let html = '';
            
            // 偏差分析
            html += '<div class="analysis">';
            html += '<h2>📊 位置別偏差分析</h2>';
            html += '<table>';
            html += '<tr><th>位置</th><th>回数</th><th>割合</th><th>理想値</th><th>偏差</th><th>判定</th></tr>';
            
            const positions = results.positions.slice(1);
            for (let i = 0; i < positions.length; i++) {
                const count = positions[i];
                const percent = ((count / results.total) * 100).toFixed(1);
                const deviation = (parseFloat(percent) - ideal).toFixed(1);
                
                let status = 'normal';
                let statusText = '正常';
                if (deviation > 5) {
                    status = 'high';
                    statusText = '過多 ⚠️';
                } else if (deviation < -5) {
                    status = 'low';
                    statusText = '不足 ⚠️';
                }
                
                html += '<tr>';
                html += `<td>${i + 1}爻</td>`;
                html += `<td>${count}</td>`;
                html += `<td class="${status}">${percent}%</td>`;
                html += `<td>${ideal.toFixed(1)}%</td>`;
                html += `<td class="${status}">${deviation > 0 ? '+' : ''}${deviation}%</td>`;
                html += `<td class="${status}">${statusText}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // 問題箇所の特定
            html += '<div class="analysis">';
            html += '<h2>🎯 改善必要箇所</h2>';
            
            const problems = [];
            for (let i = 0; i < positions.length; i++) {
                const percent = ((positions[i] / results.total) * 100);
                const deviation = percent - ideal;
                
                if (Math.abs(deviation) > 5) {
                    problems.push({
                        position: i + 1,
                        percent: percent.toFixed(1),
                        deviation: deviation.toFixed(1),
                        type: deviation > 0 ? 'over' : 'under'
                    });
                }
            }
            
            problems.sort((a, b) => Math.abs(b.deviation) - Math.abs(a.deviation));
            
            html += '<ol>';
            for (const problem of problems) {
                const className = problem.type === 'over' ? 'high' : 'low';
                const action = problem.type === 'over' ? '削減が必要' : '強化が必要';
                html += `<li class="${className}">`;
                html += `${problem.position}爻: ${problem.percent}% (${problem.deviation > 0 ? '+' : ''}${problem.deviation}%) - ${action}`;
                html += '</li>';
            }
            html += '</ol>';
            html += '</div>';
            
            // カテゴリ別反応
            html += '<div class="analysis">';
            html += '<h2>📋 カテゴリ別反応パターン</h2>';
            html += '<table>';
            html += '<tr><th>カテゴリ</th><th>最頻出位置</th><th>パターン</th></tr>';
            
            for (const [category, data] of Object.entries(results.categoryAnalysis)) {
                const maxPos = data.positionCounts.indexOf(Math.max(...data.positionCounts));
                const pattern = data.samples.map(s => s.position).join(', ');
                
                html += '<tr>';
                html += `<td>${category}</td>`;
                html += `<td>${maxPos}爻</td>`;
                html += `<td style="font-size: 0.9em">${pattern}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // 改善提案
            html += '<div class="analysis">';
            html += '<h2>💡 Day 3 改善提案</h2>';
            html += '<h3>優先度高（偏差 > 5%）</h3>';
            html += '<ul>';
            
            for (const problem of problems) {
                if (Math.abs(problem.deviation) > 5) {
                    if (problem.type === 'over') {
                        html += `<li class="high">${problem.position}爻: `;
                        html += `キーワード削減、重み減少（現在の重みから-0.05～-0.10）</li>`;
                    } else {
                        html += `<li class="low">${problem.position}爻: `;
                        html += `キーワード追加、重み増加（現在の重みから+0.05～+0.10）</li>`;
                    }
                }
            }
            
            html += '</ul>';
            html += '</div>';
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('results').innerHTML = html;
        }
        
        analyzeBaseline();
    </script>
</body>
</html>