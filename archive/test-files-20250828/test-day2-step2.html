<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 2 Step 2 - 位置重み調整効果測定</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4; 
        }
        h1 { color: #4ec9b0; }
        .summary { 
            background: #2d2d30; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        .improvement { color: #569cd6; font-weight: bold; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        th {
            background: #252526;
        }
        .yao5-row { background: #1e3a1e; }
    </style>
</head>
<body>
    <h1>Day 2 Step 2 - 位置重み調整効果測定</h1>
    <div class="summary">
        <p class="improvement">変更内容:</p>
        <ul>
            <li>5爻キーワード: 45個（第1弾10個 + 第2弾10個追加済み）</li>
            <li>位置重み: 0.50 → 0.60（+0.10）</li>
        </ul>
    </div>
    
    <div id="results"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // 拡張テストサンプル
        const testSamples = [
            // 基本的な5爻テスト
            "リーダーシップを発揮する時期",
            "経営判断を下す重要な局面",
            "統率力が求められる場面",
            "管理責任を全うする",
            "最終決定を下す段階",
            "戦略を立案し実行する",
            "指導的立場での決断",
            "トップとしての責任",
            
            // 新キーワードテスト（第1弾）
            "司令塔として指揮を執る",
            "総括的な視点で判断する",
            "采配を振るって進める",
            "裁量権を持って決定",
            "重要な決裁を行う",
            "新施策を運営する",
            "全体を制御する立場",
            "各部署を調整する",
            
            // 新キーワードテスト（第2弾）
            "部長として決断する",
            "課長の責任を果たす",
            "マネージャーとして統括",
            "責任者の立場から",
            "主任として指導する",
            "上司として判断を下す",
            "代表として発言する",
            "統率者として行動",
            "指導者の資質を発揮",
            "監査役として確認",
            
            // 混合テスト
            "部長がリーダーシップを発揮",
            "マネージャーとして采配を振るう",
            "責任者として最終決裁",
            "上司として戦略を立案",
            "指導者として統率する",
            
            // コントロール（他の爻）
            "新しい挑戦を始める",
            "協力して進める",
            "困難に直面する",
            "変化の時期を迎える",
            "完成に向けて仕上げる"
        ];
        
        async function runTest() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                total: testSamples.length,
                yao5Count: 0,
                positions: [0, 0, 0, 0, 0, 0, 0],
                details: [],
                uniqueLines: new Set()
            };
            
            for (const text of testSamples) {
                const result = await bridge.analyzeText(text);
                results.positions[result.line_position]++;
                if (result.line_position === 5) {
                    results.yao5Count++;
                }
                const lineKey = `${result.hexagram_number}-${result.line_position}`;
                results.uniqueLines.add(lineKey);
                
                results.details.push({
                    text: text,
                    position: result.line_position,
                    hexagram: result.hexagram_number,
                    line: lineKey
                });
            }
            
            displayResults(results);
        }
        
        function displayResults(results) {
            const rate = ((results.yao5Count / results.total) * 100).toFixed(1);
            const rateClass = parseFloat(rate) >= 5 ? 'good' : 
                             parseFloat(rate) >= 3 ? 'warning' : 'bad';
            
            let html = `<div class="summary">`;
            html += `<h2 class="${rateClass}">5爻選択率: ${rate}% (${results.yao5Count}/${results.total})</h2>`;
            html += `<p>目標: 4-5% → 実際: ${rate}%</p>`;
            html += `<p>ユニーク爻数: ${results.uniqueLines.size}個</p>`;
            html += `</div>`;
            
            // 位置別分布
            html += `<h3>位置別分布</h3>`;
            html += `<table>`;
            html += `<tr><th>位置</th><th>回数</th><th>割合</th><th>理想値との差</th></tr>`;
            const ideal = 100 / 6; // 16.67%
            for (let i = 1; i <= 6; i++) {
                const count = results.positions[i];
                const percent = ((count / results.total) * 100).toFixed(1);
                const diff = (parseFloat(percent) - ideal).toFixed(1);
                const diffClass = Math.abs(diff) <= 5 ? 'good' : 
                                 Math.abs(diff) <= 10 ? 'warning' : 'bad';
                const rowClass = i === 5 ? 'yao5-row' : '';
                
                html += `<tr class="${rowClass}">`;
                html += `<td>${i}爻</td>`;
                html += `<td>${count}</td>`;
                html += `<td>${percent}%</td>`;
                html += `<td class="${diffClass}">${diff > 0 ? '+' : ''}${diff}%</td>`;
                html += `</tr>`;
            }
            html += `</table>`;
            
            // 5爻選択された項目
            html += `<h3>5爻が選択された項目</h3>`;
            html += `<ul>`;
            for (const detail of results.details) {
                if (detail.position === 5) {
                    html += `<li class="good">${detail.text} → ${detail.line}</li>`;
                }
            }
            if (results.yao5Count === 0) {
                html += `<li class="bad">なし</li>`;
            }
            html += `</ul>`;
            
            // 評価と次のステップ
            html += `<div class="summary">`;
            html += `<h3>評価</h3>`;
            if (parseFloat(rate) >= 4) {
                html += `<p class="good">✅ Step 2完了: 目標達成（4-5%）</p>`;
                html += `<p>次のステップ: さらなる改善のため位置重み0.70へ</p>`;
            } else if (parseFloat(rate) >= 2) {
                html += `<p class="warning">⚠️ 改善は見られるが目標未達</p>`;
                html += `<p>次のステップ: 位置重みを0.70に追加調整</p>`;
            } else {
                html += `<p class="bad">❌ まだ改善が不十分</p>`;
                html += `<p>次のステップ: より大きな調整が必要</p>`;
            }
            html += `</div>`;
            
            document.getElementById('results').innerHTML = html;
            
            console.log('テスト結果:', results);
        }
        
        runTest();
    </script>
</body>
</html>