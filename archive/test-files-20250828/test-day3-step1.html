<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 3 Step 1 - 2爻/6爻偏り是正効果測定</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
        }
        h1 { color: #4ec9b0; }
        .summary { 
            background: #2d2d30; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .improved { color: #4ec9b0; font-weight: bold; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        th { background: #252526; }
        .comparison {
            display: flex;
            justify-content: space-between;
        }
        .before, .after {
            width: 48%;
        }
        .deviation-bar {
            display: inline-block;
            height: 15px;
            margin-left: 10px;
        }
        .deviation-positive { background: #f48771; }
        .deviation-negative { background: #569cd6; }
        .deviation-normal { background: #4ec9b0; }
    </style>
</head>
<body>
    <h1>Day 3 Step 1 - 2爻/6爻偏り是正効果測定</h1>
    
    <div class="summary">
        <h2>📋 実施内容</h2>
        <ul>
            <li>2爻キーワード: 25個 → 15個（-10個）</li>
            <li>2爻重み: 0.48 → 0.43（-0.05）</li>
            <li>6爻キーワード: 26個 → 15個（-11個）</li>
            <li>6爻重み: 0.45 → 0.40（-0.05）</li>
        </ul>
    </div>
    
    <div id="results"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // テストサンプル（バランス確認用）
        const testSamples = {
            neutral: [
                "日常的な業務を進める",
                "通常の作業を継続",
                "平常心を保つ",
                "標準的な対応を行う",
                "一般的な処理を実施"
            ],
            position1: [
                "新しい挑戦を始める時期",
                "スタート地点に立つ",
                "初心者として学び始める",
                "基礎から積み上げていく",
                "第一歩を踏み出す"
            ],
            position2: [
                "協力して進める段階",
                "チームワークを発揮",
                "内面と向き合う時間",
                "サポートする立場",
                "相談に乗る役割"
            ],
            position3: [
                "困難に直面する時",
                "試練を乗り越える",
                "問題解決に取り組む",
                "挑戦的な課題に対応",
                "壁を突破する必要"
            ],
            position4: [
                "変化の時期を迎える",
                "転換点での決断",
                "方向転換が必要",
                "移行期での対応",
                "選択を迫られる"
            ],
            position5: [
                "リーダーシップを発揮",
                "部長として判断する",
                "統括的に管理",
                "責任者として決定",
                "マネージャーの立場"
            ],
            position6: [
                "完成に向けた最終段階",
                "仕上げの作業",
                "終了間近の状態",
                "締めくくりの時期",
                "最終的な結果を出す"
            ]
        };
        
        async function runTest() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                total: 0,
                positions: [0, 0, 0, 0, 0, 0, 0],
                categoryBreakdown: {},
                improvements: {
                    position2: { before: 20, after: 0 },
                    position6: { before: 20, after: 0 }
                }
            };
            
            // カテゴリ別テスト
            for (const [category, samples] of Object.entries(testSamples)) {
                results.categoryBreakdown[category] = {
                    positions: [0, 0, 0, 0, 0, 0, 0],
                    samples: []
                };
                
                for (const text of samples) {
                    const result = await bridge.analyzeText(text);
                    results.total++;
                    results.positions[result.line_position]++;
                    results.categoryBreakdown[category].positions[result.line_position]++;
                    results.categoryBreakdown[category].samples.push({
                        text: text,
                        position: result.line_position
                    });
                }
            }
            
            // 改善率計算
            results.improvements.position2.after = 
                (results.positions[2] / results.total * 100).toFixed(1);
            results.improvements.position6.after = 
                (results.positions[6] / results.total * 100).toFixed(1);
            
            displayResults(results);
        }
        
        function displayResults(results) {
            let html = '';
            const ideal = 16.67;
            
            // 改善結果サマリー
            html += '<div class="summary">';
            html += '<h2>🎯 偏り是正結果</h2>';
            html += '<div class="comparison">';
            
            // Before/After比較
            html += '<div class="before">';
            html += '<h3>改善前（推定値）</h3>';
            html += '<p>2爻: 約20% (過多)</p>';
            html += '<p>6爻: 約20% (過多)</p>';
            html += '</div>';
            
            html += '<div class="after">';
            html += '<h3>改善後（実測値）</h3>';
            const pos2Class = Math.abs(parseFloat(results.improvements.position2.after) - ideal) <= 3 ? 'improved' : 'warning';
            const pos6Class = Math.abs(parseFloat(results.improvements.position6.after) - ideal) <= 3 ? 'improved' : 'warning';
            html += `<p class="${pos2Class}">2爻: ${results.improvements.position2.after}%</p>`;
            html += `<p class="${pos6Class}">6爻: ${results.improvements.position6.after}%</p>`;
            html += '</div>';
            html += '</div>';
            html += '</div>';
            
            // 全体分布
            html += '<div class="summary">';
            html += '<h2>📊 位置別分布（全体）</h2>';
            html += '<table>';
            html += '<tr><th>位置</th><th>回数</th><th>割合</th><th>理想値との差</th><th>評価</th></tr>';
            
            for (let i = 1; i <= 6; i++) {
                const count = results.positions[i];
                const percent = (count / results.total * 100).toFixed(1);
                const deviation = (parseFloat(percent) - ideal).toFixed(1);
                
                let evalClass = 'improved';
                let evalText = '良好';
                if (Math.abs(deviation) > 5) {
                    evalClass = 'warning';
                    evalText = '要調整';
                } else if (Math.abs(deviation) > 10) {
                    evalClass = 'bad';
                    evalText = '問題';
                }
                
                html += '<tr>';
                html += `<td>${i}爻</td>`;
                html += `<td>${count}</td>`;
                html += `<td>${percent}%</td>`;
                html += `<td>${deviation > 0 ? '+' : ''}${deviation}%</td>`;
                html += `<td class="${evalClass}">${evalText}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // カテゴリ別反応
            html += '<div class="summary">';
            html += '<h2>📋 カテゴリ別反応</h2>';
            html += '<table>';
            html += '<tr><th>カテゴリ</th><th>1爻</th><th>2爻</th><th>3爻</th><th>4爻</th><th>5爻</th><th>6爻</th></tr>';
            
            for (const [category, data] of Object.entries(results.categoryBreakdown)) {
                html += '<tr>';
                html += `<td>${category}</td>`;
                for (let i = 1; i <= 6; i++) {
                    const count = data.positions[i];
                    const cellClass = count > 2 ? 'warning' : count > 0 ? '' : '';
                    html += `<td class="${cellClass}">${count}</td>`;
                }
                html += '</tr>';
            }
            html += '</table>';
            html += '</div>';
            
            // 評価
            html += '<div class="summary">';
            html += '<h2>💡 評価と次のステップ</h2>';
            
            const pos2Improved = Math.abs(parseFloat(results.improvements.position2.after) - ideal) < 5;
            const pos6Improved = Math.abs(parseFloat(results.improvements.position6.after) - ideal) < 5;
            
            if (pos2Improved && pos6Improved) {
                html += '<p class="improved">✅ 2爻/6爻の偏り是正に成功！</p>';
            } else {
                html += '<p class="warning">⚠️ まだ調整が必要です</p>';
            }
            
            html += '<h3>次のタスク（3-7～3-9）</h3>';
            html += '<ul>';
            html += '<li>3爻キーワード追加（不足傾向改善）</li>';
            html += '<li>4爻キーワード追加（不足傾向改善）</li>';
            html += '<li>3爻/4爻重み調整（強化）</li>';
            html += '</ul>';
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
        }
        
        runTest();
    </script>
</body>
</html>