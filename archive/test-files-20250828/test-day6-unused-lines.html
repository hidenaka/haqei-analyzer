<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 6 - 未使用爻の特定（Task 6-7）</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1600px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        h3 { color: #dcdcaa; }
        
        .unused-section {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .hexagram-group {
            margin: 20px 0;
            padding: 15px;
            background: #252526;
            border-radius: 5px;
        }
        
        .hexagram-title {
            font-size: 1.1em;
            color: #569cd6;
            margin-bottom: 10px;
        }
        
        .lines-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
            margin: 10px 0;
        }
        
        .line-box {
            padding: 10px;
            text-align: center;
            border-radius: 3px;
            position: relative;
        }
        
        .line-box.used {
            background: #1a472a;
            color: #4ec9b0;
        }
        
        .line-box.unused {
            background: #5a1e1e;
            color: #f48771;
            border: 2px solid #f48771;
        }
        
        .line-box.rare {
            background: #4a4a1e;
            color: #dcdcaa;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { background: #252526; }
        
        .cause-analysis {
            background: #1e1e1e;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
        }
        
        .pattern-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .pattern-card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
        }
        
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        
        .recommendation {
            background: #1a472a;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4ec9b0;
        }
        
        .code-block {
            background: #1e1e1e;
            padding: 10px;
            margin: 10px 0;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>Day 6 - 未使用爻の特定（Task 6-7）</h1>
    
    <div id="analysis"></div>
    
    <script type="module">
        // 64卦の名前
        const hexagramNames = [
            '乾為天', '坤為地', '水雷屯', '山水蒙', '水天需', '天水訟', '地水師', '水地比',
            '風天小畜', '天澤履', '地天泰', '天地否', '天火同人', '火天大有', '地山謙', '雷地豫',
            '澤雷随', '山風蠱', '地澤臨', '風地観', '火雷噬嗑', '山火賁', '山地剝', '地雷復',
            '天雷無妄', '山天大畜', '山雷頤', '澤風大過', '坎為水', '離為火', '澤山咸', '雷風恒',
            '天山遯', '雷天大壮', '火地晋', '地火明夷', '風火家人', '火澤睽', '水山蹇', '雷水解',
            '山澤損', '風雷益', '澤天夬', '天風姤', '澤地萃', '地風升', '澤水困', '水風井',
            '澤火革', '火風鼎', '震為雷', '艮為山', '風山漸', '雷澤帰妹', '雷火豊', '火山旅',
            '巽為風', '兌為澤', '風水渙', '水澤節', '風澤中孚', '雷山小過', '水火既済', '火水未済'
        ];
        
        async function identifyUnusedLines() {
            // TextTo384LinesBridgeを動的にロード
            const script = document.createElement('script');
            script.src = './public/js/ai/TextTo384LinesBridge.js';
            await new Promise(resolve => {
                script.onload = resolve;
                document.head.appendChild(script);
            });
            
            const bridge = new window.TextTo384LinesBridge();
            await bridge.initialize();
            
            // 1000サンプルで徹底的に未使用爻を特定
            const testSamples = generateCompleteSampleSet(1000);
            
            // 全384爻の使用状況を記録
            const lineUsage = {};
            for (let i = 1; i <= 384; i++) {
                lineUsage[i] = {
                    count: 0,
                    samples: [],
                    hexagram: Math.ceil(i / 6),
                    position: ((i - 1) % 6) + 1
                };
            }
            
            let html = '';
            html += '<div class="unused-section">';
            html += '<h2>📊 1000サンプル分析実行中...</h2>';
            html += '<div id="progress">0/1000 完了</div>';
            html += '</div>';
            
            document.getElementById('analysis').innerHTML = html;
            
            // サンプル実行
            for (let i = 0; i < testSamples.length; i++) {
                const result = await bridge.analyzeText(testSamples[i]);
                const lineId = (result.hexagram_number - 1) * 6 + result.line_position;
                
                lineUsage[lineId].count++;
                if (lineUsage[lineId].samples.length < 3) {
                    lineUsage[lineId].samples.push(testSamples[i]);
                }
                
                // プログレス更新
                if ((i + 1) % 100 === 0) {
                    document.getElementById('progress').innerText = `${i + 1}/1000 完了`;
                }
            }
            
            // 分析結果の表示
            displayUnusedAnalysis(lineUsage, testSamples.length);
        }
        
        function displayUnusedAnalysis(lineUsage, totalSamples) {
            let html = '';
            
            // 統計情報
            const unusedLines = Object.entries(lineUsage).filter(([id, data]) => data.count === 0);
            const rareLines = Object.entries(lineUsage).filter(([id, data]) => data.count > 0 && data.count <= 2);
            const usedLines = Object.entries(lineUsage).filter(([id, data]) => data.count > 0);
            
            html += '<div class="unused-section">';
            html += '<h2>📈 未使用爻分析結果</h2>';
            
            html += `<p>総サンプル数: ${totalSamples}</p>`;
            html += `<p>未使用爻数: <span class="bad">${unusedLines.length}/384</span> (${((unusedLines.length / 384) * 100).toFixed(1)}%)</p>`;
            html += `<p>低頻度爻数(1-2回): <span class="warning">${rareLines.length}個</span></p>`;
            html += `<p>使用爻数: <span class="good">${usedLines.length}/384</span> (${((usedLines.length / 384) * 100).toFixed(1)}%)</p>`;
            
            html += '</div>';
            
            // 卦ごとの未使用爻分析
            html += '<div class="unused-section">';
            html += '<h2>🗺️ 卦別未使用爻マップ</h2>';
            
            // 卦ごとにグループ化
            const hexagramGroups = {};
            for (let hex = 1; hex <= 64; hex++) {
                hexagramGroups[hex] = {
                    name: hexagramNames[hex - 1],
                    lines: [],
                    unusedCount: 0,
                    totalUsage: 0
                };
                
                for (let pos = 1; pos <= 6; pos++) {
                    const lineId = (hex - 1) * 6 + pos;
                    hexagramGroups[hex].lines.push({
                        id: lineId,
                        position: pos,
                        count: lineUsage[lineId].count
                    });
                    if (lineUsage[lineId].count === 0) {
                        hexagramGroups[hex].unusedCount++;
                    }
                    hexagramGroups[hex].totalUsage += lineUsage[lineId].count;
                }
            }
            
            // 完全未使用の卦（6爻すべて未使用）
            const completelyUnusedHexagrams = Object.entries(hexagramGroups)
                .filter(([id, data]) => data.unusedCount === 6);
            
            if (completelyUnusedHexagrams.length > 0) {
                html += '<h3 class="bad">⚠️ 完全未使用の卦（全6爻が未使用）</h3>';
                html += '<div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">';
                
                for (const [hexId, data] of completelyUnusedHexagrams) {
                    html += '<div class="hexagram-group">';
                    html += `<div class="hexagram-title">#${hexId} ${data.name}</div>`;
                    html += '<div class="lines-grid">';
                    for (let pos = 1; pos <= 6; pos++) {
                        html += `<div class="line-box unused">${pos}爻<br>0回</div>`;
                    }
                    html += '</div>';
                    html += '</div>';
                }
                html += '</div>';
            }
            
            // 部分的に未使用の卦（1-5爻が未使用）
            const partiallyUnusedHexagrams = Object.entries(hexagramGroups)
                .filter(([id, data]) => data.unusedCount > 0 && data.unusedCount < 6)
                .sort((a, b) => b[1].unusedCount - a[1].unusedCount)
                .slice(0, 8);
            
            html += '<h3>部分的に未使用爻がある卦</h3>';
            html += '<div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">';
            
            for (const [hexId, data] of partiallyUnusedHexagrams) {
                html += '<div class="hexagram-group">';
                html += `<div class="hexagram-title">#${hexId} ${data.name} (${data.unusedCount}爻未使用)</div>`;
                html += '<div class="lines-grid">';
                
                for (const line of data.lines) {
                    let className = 'line-box ';
                    if (line.count === 0) className += 'unused';
                    else if (line.count <= 2) className += 'rare';
                    else className += 'used';
                    
                    html += `<div class="${className}">${line.position}爻<br>${line.count}回</div>`;
                }
                html += '</div>';
                html += '</div>';
            }
            html += '</div>';
            
            html += '</div>';
            
            // 未使用爻の位置パターン分析
            html += '<div class="unused-section">';
            html += '<h2>📊 未使用爻のパターン分析</h2>';
            
            // 位置別の未使用数
            const positionUnusedCount = [0, 0, 0, 0, 0, 0, 0];
            for (const [lineId, data] of Object.entries(lineUsage)) {
                if (data.count === 0) {
                    positionUnusedCount[data.position]++;
                }
            }
            
            html += '<h3>位置別未使用爻数</h3>';
            html += '<table>';
            html += '<tr><th>爻位置</th><th>未使用数</th><th>未使用率</th><th>評価</th></tr>';
            
            for (let pos = 1; pos <= 6; pos++) {
                const unusedCount = positionUnusedCount[pos];
                const rate = ((unusedCount / 64) * 100).toFixed(1);
                
                let evalClass = 'good';
                let evalText = '正常';
                if (unusedCount > 40) {
                    evalClass = 'bad';
                    evalText = '深刻';
                } else if (unusedCount > 30) {
                    evalClass = 'warning';
                    evalText = '要注意';
                }
                
                html += '<tr>';
                html += `<td>${pos}爻</td>`;
                html += `<td>${unusedCount}/64</td>`;
                html += `<td>${rate}%</td>`;
                html += `<td class="${evalClass}">${evalText}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            html += '</div>';
            
            // 原因分析
            html += '<div class="unused-section">';
            html += '<h2>🔍 未使用爻の原因分析</h2>';
            
            html += '<div class="pattern-grid">';
            
            // パターン1: 位置による偏り
            html += '<div class="pattern-card">';
            html += '<h3>1. 位置による偏り</h3>';
            html += '<ul>';
            
            const maxUnusedPos = positionUnusedCount.indexOf(Math.max(...positionUnusedCount.slice(1)));
            const minUnusedPos = positionUnusedCount.indexOf(Math.min(...positionUnusedCount.slice(1)));
            
            if (maxUnusedPos > 0) {
                html += `<li class="bad">${maxUnusedPos}爻が最も未使用 (${positionUnusedCount[maxUnusedPos]}個)</li>`;
            }
            if (minUnusedPos > 0) {
                html += `<li class="good">${minUnusedPos}爻が最も使用される (未使用${positionUnusedCount[minUnusedPos]}個)</li>`;
            }
            
            html += '</ul>';
            html += '</div>';
            
            // パターン2: 卦による偏り
            html += '<div class="pattern-card">';
            html += '<h3>2. 卦による偏り</h3>';
            html += '<ul>';
            html += `<li class="bad">完全未使用卦: ${completelyUnusedHexagrams.length}個</li>`;
            
            const avgUnusedPerHexagram = unusedLines.length / 64;
            html += `<li>平均未使用爻数/卦: ${avgUnusedPerHexagram.toFixed(1)}</li>`;
            
            html += '</ul>';
            html += '</div>';
            
            // パターン3: キーワード不足
            html += '<div class="pattern-card">';
            html += '<h3>3. 推定される原因</h3>';
            html += '<ul>';
            html += '<li>特定卦のキーワード不足</li>';
            html += '<li>セマンティックベクトルの偏り</li>';
            html += '<li>探索ノイズの不足</li>';
            html += '<li>位置重みの不均衡</li>';
            html += '</ul>';
            html += '</div>';
            
            // パターン4: 構造的問題
            html += '<div class="pattern-card">';
            html += '<h3>4. 構造的問題</h3>';
            html += '<ul>';
            
            // 特定の番号帯に偏りがあるか
            const firstHalf = unusedLines.filter(([id]) => parseInt(id) <= 192).length;
            const secondHalf = unusedLines.length - firstHalf;
            
            if (Math.abs(firstHalf - secondHalf) > 20) {
                html += `<li class="warning">前半/後半の偏り: ${firstHalf} vs ${secondHalf}</li>`;
            }
            
            html += '<li>卦間の連続性欠如</li>';
            html += '<li>初期化時のバイアス</li>';
            html += '</ul>';
            html += '</div>';
            
            html += '</div>';
            html += '</div>';
            
            // 改善提案
            html += '<div class="unused-section">';
            html += '<h2>💡 未使用爻解消のための改善提案</h2>';
            
            html += '<div class="recommendation">';
            html += '<h3>優先度：高</h3>';
            html += '<ol>';
            html += '<li><strong>完全未使用卦への特別処理</strong><br>';
            html += '完全未使用の卦に対して+0.3以上の強力なボーナス付与</li>';
            html += '<li><strong>未使用爻専用キーワード追加</strong><br>';
            html += '各未使用爻に独自のキーワードセットを定義</li>';
            html += '<li><strong>セマンティックベクトル再初期化</strong><br>';
            html += '未使用爻のベクトルを強化・差別化</li>';
            html += '</ol>';
            html += '</div>';
            
            html += '<div class="recommendation" style="background: #4a4a1e; border-color: #dcdcaa;">';
            html += '<h3>優先度：中</h3>';
            html += '<ul>';
            html += '<li>探索ノイズの爻別最適化</li>';
            html += '<li>使用履歴のリセット機能</li>';
            html += '<li>強制的な爻ローテーション</li>';
            html += '</ul>';
            html += '</div>';
            
            html += '<h3>実装例</h3>';
            html += '<div class="code-block">';
            html += `// 未使用爻への強力なボーナス
if (lineUsage[lineId] === undefined || lineUsage[lineId] === 0) {
    score += 0.30; // 30%ボーナス
}

// 完全未使用卦への追加ボーナス  
const hexagramId = Math.ceil(lineId / 6);
if (isCompletelyUnusedHexagram(hexagramId)) {
    score += 0.20; // さらに20%ボーナス
}`;
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('analysis').innerHTML = html;
        }
        
        function generateCompleteSampleSet(count) {
            const samples = [];
            
            // より包括的なテキストセット
            const comprehensiveTexts = [
                // 基本感情
                '喜び', '悲しみ', '怒り', '恐れ', '驚き', '嫌悪', '信頼', '期待',
                // 状態
                '安定', '不安定', '均衡', '変動', '静止', '活動', '停滞', '流動',
                // 行動
                '前進', '後退', '上昇', '下降', '拡大', '縮小', '集中', '分散',
                // 関係性
                '協調', '対立', '融合', '分離', '依存', '独立', '支配', '服従',
                // 時間
                '過去', '現在', '未来', '瞬間', '永遠', '開始', '継続', '終了',
                // 空間
                '内部', '外部', '中心', '周辺', '上', '下', '左', '右',
                // 価値
                '善', '悪', '美', '醜', '真', '偽', '正', '邪',
                // 自然
                '天', '地', '水', '火', '風', '雷', '山', '沢',
                // 社会
                '個人', '集団', '家族', '組織', '国家', '世界', '文化', '文明',
                // 思考
                '分析', '統合', '創造', '破壊', '保存', '変革', '継承', '革新'
            ];
            
            // 組み合わせパターン
            const patterns = [
                (text) => text,
                (text) => `${text}について`,
                (text) => `${text}の時`,
                (text) => `${text}を考える`,
                (text) => `${text}に向かう`,
                (text) => `${text}から離れる`,
                (text) => `新しい${text}`,
                (text) => `古い${text}`,
                (text) => `${text}の変化`,
                (text) => `${text}の安定`
            ];
            
            // サンプル生成
            let index = 0;
            while (samples.length < count) {
                const text = comprehensiveTexts[index % comprehensiveTexts.length];
                const pattern = patterns[Math.floor(index / comprehensiveTexts.length) % patterns.length];
                samples.push(pattern(text));
                index++;
            }
            
            return samples;
        }
        
        identifyUnusedLines();
    </script>
</body>
</html>