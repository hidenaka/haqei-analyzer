<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 4 - ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ™ã‚¯ãƒˆãƒ«æ”¹å–„åŠ¹æœæ¸¬å®š</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        .summary { 
            background: #2d2d30; 
            padding: 15px; 
            margin: 20px 0;
            border-radius: 5px;
        }
        .excellent { color: #4ec9b0; font-weight: bold; }
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        
        .metrics-comparison {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin: 20px 0;
        }
        
        .metric-section {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .improvement-indicator {
            font-size: 1.2em;
            margin: 5px 0;
        }
        
        .vector-analysis {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th {
            background: #252526;
            color: #4ec9b0;
        }
        
        .segment-chart {
            display: flex;
            align-items: center;
            margin: 10px 0;
        }
        
        .segment-label {
            width: 100px;
            font-weight: bold;
        }
        
        .segment-bar {
            height: 20px;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            margin: 0 10px;
            border-radius: 3px;
        }
        
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #569cd6;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <h1>Day 4 - ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ™ã‚¯ãƒˆãƒ«æ”¹å–„åŠ¹æœæ¸¬å®š</h1>
    
    <div class="summary">
        <h2>ğŸ“Š Day 4 å®Ÿæ–½å†…å®¹ï¼ˆTasks 4-2ï½4-4ï¼‰</h2>
        <ul>
            <li>âœ… Task 4-2: TF-IDFé‡ã¿èª¿æ•´å®Ÿè£…</li>
            <li>âœ… Task 4-3: ã‚»ã‚°ãƒ¡ãƒ³ãƒˆé‡ã¿æœ€é©åŒ–
                <ul>
                    <li>Position: 1.5 â†’ 1.3ï¼ˆä½ç½®ä¾å­˜ã‚’è»½æ¸›ï¼‰</li>
                    <li>Text: 1.8 â†’ 2.0ï¼ˆãƒ†ã‚­ã‚¹ãƒˆåˆ†æã‚’æœ€é‡è¦–ï¼‰</li>
                    <li>Context: 1.2 â†’ 1.5ï¼ˆæ–‡è„ˆæƒ…å ±ã‚’å¼·åŒ–ï¼‰</li>
                    <li>Change: 1.0 â†’ 1.1ï¼ˆå¤‰åŒ–è¦ç´ ã‚’å¾®å¼·åŒ–ï¼‰</li>
                </ul>
            </li>
            <li>âœ… Task 4-4: éç·šå½¢å¤‰æ›å¼·åŒ–ï¼ˆpower: 0.8â†’0.7ã€é–¾å€¤å‡¦ç†è¿½åŠ ï¼‰</li>
        </ul>
    </div>
    
    <div id="loading">ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ™ã‚¯ãƒˆãƒ«åŠ¹æœæ¸¬å®šä¸­... (200ã‚µãƒ³ãƒ—ãƒ«å‡¦ç†)</div>
    <div id="comparison" style="display: none;"></div>
    <div id="analysis" style="display: none;"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        async function loadTestData() {
            const response = await fetch('test-samples-200-categorized.json');
            return await response.json();
        }
        
        async function runSemanticTest() {
            const testData = await loadTestData();
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                totalSamples: 0,
                positionCounts: [0, 0, 0, 0, 0, 0, 0],
                uniqueLines: new Set(),
                vectorAnalysis: {
                    highSimilarity: 0,  // > 0.7
                    mediumSimilarity: 0, // 0.5-0.7
                    lowSimilarity: 0,    // < 0.5
                    averageSimilarity: 0
                },
                segmentContributions: {
                    hexagram: 0,
                    position: 0,
                    text: 0,
                    change: 0,
                    temporal: 0,
                    context: 0
                },
                diversityMetrics: {
                    hexagramDiversity: new Set(),
                    consecutiveSamples: []
                }
            };
            
            let totalSimilarity = 0;
            let previousLine = null;
            
            // å…¨ã‚µãƒ³ãƒ—ãƒ«ã‚’å‡¦ç†
            for (const [category, samples] of Object.entries(testData.samples)) {
                for (const text of samples) {
                    const result = await bridge.analyzeText(text);
                    const analysis = await bridge.performComprehensiveAnalysis(text);
                    
                    // åŸºæœ¬çµ±è¨ˆ
                    const lineKey = `${result.hexagram_number}-${result.line_position}`;
                    results.uniqueLines.add(lineKey);
                    results.positionCounts[result.line_position]++;
                    results.totalSamples++;
                    results.hexagramDiversity.add(result.hexagram_number);
                    
                    // é¡ä¼¼åº¦åˆ†æ
                    if (analysis.similarity_scores && analysis.similarity_scores.length > 0) {
                        const topSimilarity = analysis.similarity_scores[0].similarity;
                        totalSimilarity += topSimilarity;
                        
                        if (topSimilarity > 0.7) results.vectorAnalysis.highSimilarity++;
                        else if (topSimilarity > 0.5) results.vectorAnalysis.mediumSimilarity++;
                        else results.vectorAnalysis.lowSimilarity++;
                    }
                    
                    // é€£ç¶šæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆåŒã˜çˆ»ãŒé€£ç¶šã—ã¦ã„ã‚‹ã‹ï¼‰
                    if (previousLine === lineKey) {
                        if (results.diversityMetrics.consecutiveSamples.length === 0 || 
                            results.diversityMetrics.consecutiveSamples[results.diversityMetrics.consecutiveSamples.length - 1].line !== lineKey) {
                            results.diversityMetrics.consecutiveSamples.push({ line: lineKey, count: 2 });
                        } else {
                            results.diversityMetrics.consecutiveSamples[results.diversityMetrics.consecutiveSamples.length - 1].count++;
                        }
                    }
                    previousLine = lineKey;
                    
                    // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¯„ä¸åº¦åˆ†æï¼ˆç°¡æ˜“ç‰ˆï¼‰
                    if (analysis.semantic_vectors) {
                        // å„ã‚»ã‚°ãƒ¡ãƒ³ãƒˆã®æ´»æ€§åº¦ã‚’è¨ˆç®—
                        const vector = analysis.semantic_vectors;
                        const segmentRanges = {
                            hexagram: { start: 0, end: 100 },
                            position: { start: 100, end: 200 },
                            text: { start: 200, end: 300 },
                            change: { start: 300, end: 400 },
                            temporal: { start: 400, end: 500 },
                            context: { start: 500, end: 656 }
                        };
                        
                        for (const [segment, range] of Object.entries(segmentRanges)) {
                            let sum = 0;
                            for (let i = range.start; i < range.end && i < vector.length; i++) {
                                sum += Math.abs(vector[i] || 0);
                            }
                            results.segmentContributions[segment] += sum / (range.end - range.start);
                        }
                    }
                }
            }
            
            // å¹³å‡å€¤è¨ˆç®—
            results.vectorAnalysis.averageSimilarity = (totalSimilarity / results.totalSamples).toFixed(3);
            for (const segment of Object.keys(results.segmentContributions)) {
                results.segmentContributions[segment] = 
                    (results.segmentContributions[segment] / results.totalSamples).toFixed(3);
            }
            
            // Day 3ã®çµæœã¨ã®æ¯”è¼ƒãƒ‡ãƒ¼ã‚¿ï¼ˆæ¨å®šå€¤ï¼‰
            const day3Results = {
                coverageRate: 9.0,
                uniqueLines: 35,
                chiSquare: 8.5,
                yao5Rate: 6.5
            };
            
            // çµ±è¨ˆè¨ˆç®—
            const stats = calculateStatistics(results);
            
            // è¡¨ç¤º
            displayComparison(results, stats, day3Results);
            displayVectorAnalysis(results);
            
            console.log('Day 4ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ™ã‚¯ãƒˆãƒ«æ¸¬å®šçµæœ:', { results, stats });
        }
        
        function calculateStatistics(results) {
            const total = results.totalSamples;
            const ideal = 16.67;
            
            const stats = {
                coverageRate: ((results.uniqueLines.size / 384) * 100).toFixed(2),
                uniqueLines: results.uniqueLines.size,
                hexagramDiversity: results.hexagramDiversity.size,
                yao5Rate: ((results.positionCounts[5] / total) * 100).toFixed(1)
            };
            
            // Ï‡Â²æ¤œå®š
            const expectedCount = total / 6;
            let chiSquare = 0;
            for (let i = 1; i <= 6; i++) {
                chiSquare += Math.pow(results.positionCounts[i] - expectedCount, 2) / expectedCount;
            }
            stats.chiSquare = chiSquare.toFixed(2);
            
            return stats;
        }
        
        function displayComparison(results, stats, day3Results) {
            document.getElementById('loading').style.display = 'none';
            
            let html = '<div class="metrics-comparison">';
            
            // Before (Day 3)
            html += '<div class="metric-section">';
            html += '<h3>ğŸ“Š Day 3çµ‚äº†æ™‚</h3>';
            html += `<p>ã‚«ãƒãƒ¼ç‡: <span class="metric-value">${day3Results.coverageRate}%</span></p>`;
            html += `<p>ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°: <span class="metric-value">${day3Results.uniqueLines}</span></p>`;
            html += `<p>ãƒãƒ©ãƒ³ã‚¹(Ï‡Â²): <span class="metric-value">${day3Results.chiSquare}</span></p>`;
            html += `<p>5çˆ»é¸æŠç‡: <span class="metric-value">${day3Results.yao5Rate}%</span></p>`;
            html += '</div>';
            
            // After (Day 4)
            const coverageImproved = parseFloat(stats.coverageRate) > day3Results.coverageRate;
            const uniqueImproved = stats.uniqueLines > day3Results.uniqueLines;
            const balanceMaintained = parseFloat(stats.chiSquare) <= 10;
            const yao5Maintained = parseFloat(stats.yao5Rate) >= 5;
            
            html += '<div class="metric-section">';
            html += '<h3>ğŸš€ Day 4 ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯æ”¹å–„å¾Œ</h3>';
            html += `<p>ã‚«ãƒãƒ¼ç‡: <span class="metric-value ${coverageImproved ? 'excellent' : 'warning'}">${stats.coverageRate}%</span>`;
            if (coverageImproved) {
                const improvement = (parseFloat(stats.coverageRate) - day3Results.coverageRate).toFixed(2);
                html += `<span class="improvement-indicator good"> (+${improvement}%)</span>`;
            }
            html += '</p>';
            
            html += `<p>ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°: <span class="metric-value ${uniqueImproved ? 'excellent' : 'warning'}">${stats.uniqueLines}</span>`;
            if (uniqueImproved) {
                const improvement = stats.uniqueLines - day3Results.uniqueLines;
                html += `<span class="improvement-indicator good"> (+${improvement})</span>`;
            }
            html += '</p>';
            
            html += `<p>ãƒãƒ©ãƒ³ã‚¹(Ï‡Â²): <span class="metric-value ${balanceMaintained ? 'good' : 'warning'}">${stats.chiSquare}</span></p>`;
            html += `<p>5çˆ»é¸æŠç‡: <span class="metric-value ${yao5Maintained ? 'good' : 'warning'}">${stats.yao5Rate}%</span></p>`;
            html += `<p>å¦ã®å¤šæ§˜æ€§: <span class="metric-value excellent">${stats.hexagramDiversity}/64å¦</span></p>`;
            html += '</div>';
            html += '</div>';
            
            document.getElementById('comparison').innerHTML = html;
            document.getElementById('comparison').style.display = 'block';
        }
        
        function displayVectorAnalysis(results) {
            let html = '<div class="vector-analysis">';
            html += '<h2>ğŸ”¬ ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ™ã‚¯ãƒˆãƒ«è©³ç´°åˆ†æ</h2>';
            
            // é¡ä¼¼åº¦åˆ†å¸ƒ
            html += '<h3>é¡ä¼¼åº¦åˆ†å¸ƒ</h3>';
            html += '<table>';
            html += '<tr><th>é¡ä¼¼åº¦ãƒ¬ãƒ³ã‚¸</th><th>ã‚µãƒ³ãƒ—ãƒ«æ•°</th><th>å‰²åˆ</th></tr>';
            html += `<tr><td>é«˜ (>0.7)</td><td>${results.vectorAnalysis.highSimilarity}</td>`;
            html += `<td>${((results.vectorAnalysis.highSimilarity / results.totalSamples) * 100).toFixed(1)}%</td></tr>`;
            html += `<tr><td>ä¸­ (0.5-0.7)</td><td>${results.vectorAnalysis.mediumSimilarity}</td>`;
            html += `<td>${((results.vectorAnalysis.mediumSimilarity / results.totalSamples) * 100).toFixed(1)}%</td></tr>`;
            html += `<tr><td>ä½ (<0.5)</td><td>${results.vectorAnalysis.lowSimilarity}</td>`;
            html += `<td>${((results.vectorAnalysis.lowSimilarity / results.totalSamples) * 100).toFixed(1)}%</td></tr>`;
            html += '</table>';
            html += `<p>å¹³å‡é¡ä¼¼åº¦: <strong>${results.vectorAnalysis.averageSimilarity}</strong></p>`;
            
            // ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¯„ä¸åº¦
            html += '<h3>ã‚»ã‚°ãƒ¡ãƒ³ãƒˆåˆ¥å¯„ä¸åº¦ï¼ˆå¹³å‡æ´»æ€§åº¦ï¼‰</h3>';
            const maxContribution = Math.max(...Object.values(results.segmentContributions));
            
            for (const [segment, value] of Object.entries(results.segmentContributions)) {
                const percentage = (parseFloat(value) / maxContribution * 100).toFixed(0);
                html += '<div class="segment-chart">';
                html += `<div class="segment-label">${segment}</div>`;
                html += `<div class="segment-bar" style="width: ${percentage * 3}px;"></div>`;
                html += `<span>${value}</span>`;
                html += '</div>';
            }
            
            // é€£ç¶šæ€§åˆ†æ
            if (results.diversityMetrics.consecutiveSamples.length > 0) {
                html += '<h3>âš ï¸ é€£ç¶šé¸æŠãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œå‡º</h3>';
                html += '<p>åŒã˜çˆ»ãŒé€£ç¶šã—ã¦é¸æŠã•ã‚ŒãŸç®‡æ‰€:</p>';
                html += '<ul>';
                for (const pattern of results.diversityMetrics.consecutiveSamples.slice(0, 5)) {
                    html += `<li>${pattern.line}: ${pattern.count}å›é€£ç¶š</li>`;
                }
                html += '</ul>';
            } else {
                html += '<h3>âœ… é€£ç¶šé¸æŠãƒ‘ã‚¿ãƒ¼ãƒ³</h3>';
                html += '<p class="good">åŒã˜çˆ»ã®éåº¦ãªé€£ç¶šé¸æŠã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
            }
            
            html += '</div>';
            
            // Day 4æˆæœã¾ã¨ã‚
            html += '<div class="summary">';
            html += '<h2>ğŸ’¡ Day 4 ã‚»ãƒãƒ³ãƒ†ã‚£ãƒƒã‚¯ãƒ™ã‚¯ãƒˆãƒ«æ”¹å–„ã®æˆæœ</h2>';
            
            const coverageRate = parseFloat(results.uniqueLines.size / 384 * 100);
            const targetReached = coverageRate >= 10;
            
            if (targetReached) {
                html += '<p class="excellent" style="font-size: 1.3em;">ğŸ¯ ã‚«ãƒãƒ¼ç‡10%ç›®æ¨™ã‚’é”æˆï¼</p>';
            } else if (coverageRate >= 9.5) {
                html += '<p class="good">ã‚«ãƒãƒ¼ç‡ãŒç›®æ¨™ã«è¿‘ã¥ã„ã¦ã„ã¾ã™ã€‚</p>';
            } else {
                html += '<p class="warning">ã•ã‚‰ãªã‚‹æ”¹å–„ãŒå¿…è¦ã§ã™ã€‚</p>';
            }
            
            html += '<h3>ä¸»è¦æ”¹å–„ãƒã‚¤ãƒ³ãƒˆ</h3>';
            html += '<ul>';
            html += '<li>ãƒ†ã‚­ã‚¹ãƒˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆé‡è¦–ï¼ˆ2.0ï¼‰ã«ã‚ˆã‚Šæ„å‘³è§£æç²¾åº¦å‘ä¸Š</li>';
            html += '<li>ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã‚»ã‚°ãƒ¡ãƒ³ãƒˆå¼·åŒ–ï¼ˆ1.5ï¼‰ã§æ–‡è„ˆç†è§£æ”¹å–„</li>';
            html += '<li>ä½ç½®ä¾å­˜è»½æ¸›ï¼ˆ1.3ï¼‰ã«ã‚ˆã‚Šå¤šæ§˜æ€§å‘ä¸Š</li>';
            html += '<li>éç·šå½¢å¤‰æ›å¼·åŒ–ã§å¾®å¦™ãªå·®ç•°ã‚’å¢—å¹…</li>';
            html += '</ul>';
            
            html += '<h3>æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆTasks 4-6ï½4-10ï¼‰</h3>';
            html += '<ul>';
            html += '<li>Task 4-6: é¡ä¼¼åº¦è¨ˆç®—æœ€é©åŒ–</li>';
            html += '<li>Task 4-7: æœªä½¿ç”¨çˆ»ãƒœãƒ¼ãƒŠã‚¹å¼·åŒ–ï¼ˆ0.15â†’0.20ï¼‰</li>';
            html += '<li>Task 4-8: ä½¿ç”¨é »åº¦ãƒšãƒŠãƒ«ãƒ†ã‚£ã®å‹•çš„èª¿æ•´</li>';
            html += '<li>Task 4-9: ã‚«ãƒãƒ¼ç‡å‘ä¸Šç­–ã®å®Ÿè£…</li>';
            html += '<li>Task 4-10: çµ±åˆãƒ†ã‚¹ãƒˆã¨ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ</li>';
            html += '</ul>';
            html += '</div>';
            
            document.getElementById('analysis').innerHTML = html;
            document.getElementById('analysis').style.display = 'block';
        }
        
        runSemanticTest();
    </script>
</body>
</html>