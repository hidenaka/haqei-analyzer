<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 5 æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆ - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œç·åˆè©•ä¾¡</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1600px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        .summary {
            background: #2d2d30;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
        }
        .excellent { color: #4ec9b0; font-weight: bold; }
        .good { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .bad { color: #f48771; }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin: 20px 0;
        }
        
        .metric-card {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 2.5em;
            font-weight: bold;
            margin: 10px 0;
        }
        
        .test-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        
        .test-cell {
            background: #252526;
            padding: 10px;
            border-radius: 3px;
            text-align: center;
        }
        
        .test-cell.pass { border-left: 3px solid #4ec9b0; }
        .test-cell.fail { border-left: 3px solid #f48771; }
        .test-cell.partial { border-left: 3px solid #dcdcaa; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { background: #252526; color: #4ec9b0; }
        
        .progress-chart {
            background: #252526;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .progress-bar {
            background: #3c3c3c;
            border-radius: 5px;
            height: 30px;
            margin: 10px 0;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: #1e1e1e;
            font-weight: bold;
        }
        
        #loading {
            text-align: center;
            font-size: 1.2em;
            color: #569cd6;
            margin: 50px 0;
        }
    </style>
</head>
<body>
    <h1>Day 5 æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆ - ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œç·åˆè©•ä¾¡</h1>
    
    <div class="summary">
        <h2>ğŸ“Š Day 5 å®Ÿæ–½å†…å®¹ï¼ˆå…¨10ã‚¿ã‚¹ã‚¯ï¼‰</h2>
        <ul>
            <li>âœ… Task 5-1: çŸ­æ–‡å‡¦ç†ã®æœ€é©åŒ–ï¼ˆ3æ–‡å­—æœªæº€ã®æ‹¡å¼µå‡¦ç†ï¼‰</li>
            <li>âœ… Task 5-2: é•·æ–‡å‡¦ç†ã®æœ€é©åŒ–ï¼ˆ150æ–‡å­—è¶…ã®è¦ç´„ï¼‰</li>
            <li>âœ… Task 5-3: ç‰¹æ®Šæ–‡å­—ãƒ»è¨˜å·å¯¾å¿œï¼ˆçµµæ–‡å­—ãƒ»é¡”æ–‡å­—é™¤å»ï¼‰</li>
            <li>âœ… Task 5-4: æ•°å­—ãƒ»è‹±èªæ··åœ¨å¯¾å¿œï¼ˆæ­£è¦åŒ–å‡¦ç†ï¼‰</li>
            <li>âœ… Task 5-5: æ¸¬å®šã¨åŠ¹æœç¢ºèª</li>
            <li>âœ… Task 5-6: æ›–æ˜§å…¥åŠ›ã®å‡¦ç†æ”¹å–„ï¼ˆæŒ‡ç¤ºèªå¤‰æ›ï¼‰</li>
            <li>âœ… Task 5-7: ç©ºç™½ãƒ»æ”¹è¡Œå‡¦ç†ï¼ˆæ­£è¦åŒ–ï¼‰</li>
            <li>âœ… Task 5-8: ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–</li>
            <li>âœ… Task 5-9: å¢ƒç•Œå€¤ãƒ†ã‚¹ãƒˆ</li>
            <li>âœ… Task 5-10: æœ¬çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿæ–½</li>
        </ul>
    </div>
    
    <div id="loading">Day 5 æœ€çµ‚çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...</div>
    <div id="metrics" style="display: none;"></div>
    <div id="results" style="display: none;"></div>
    <div id="summary" style="display: none;"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // çµ±åˆãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ
        const integrationTests = {
            regular: {
                name: 'é€šå¸¸ã‚±ãƒ¼ã‚¹',
                samples: [
                    'ä»Šæ—¥ã¯è‰¯ã„å¤©æ°—ã§ã™',
                    'æ–°ã—ã„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å§‹ã‚ã‚‹',
                    'å›°é›£ã‚’ä¹—ã‚Šè¶Šãˆã‚‹',
                    'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—ã‚’ç™ºæ®ã™ã‚‹',
                    'å”åŠ›ã—ã¦é€²ã‚ã‚‹'
                ]
            },
            shortEdge: {
                name: 'çŸ­æ–‡ã‚¨ãƒƒã‚¸',
                samples: [
                    'æ„›', 'å‹', 'åŠ›', 'ä»Š', 'ç§',
                    'ã‚', 'ã„', 'ã†', 'ãˆ', 'ãŠ'
                ]
            },
            longEdge: {
                name: 'é•·æ–‡ã‚¨ãƒƒã‚¸',
                samples: [
                    'ã‚'.repeat(150),
                    'éå¸¸ã«é•·ã„æ–‡ç« ã§ã€å¤šãã®æƒ…å ±ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚'.repeat(10),
                    'è¨ˆç”»ã‚’ç«‹ã¦ã¦ã€å®Ÿè¡Œã—ã€è©•ä¾¡ã—ã¦ã€æ”¹å–„ã™ã‚‹ã€‚ã“ã®ã‚µã‚¤ã‚¯ãƒ«ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§ã€ç¶™ç¶šçš„ãªæˆé•·ã‚’å®Ÿç¾ã§ãã¾ã™ã€‚'.repeat(3)
                ]
            },
            special: {
                name: 'ç‰¹æ®Šæ–‡å­—',
                samples: [
                    'é ‘å¼µã‚‹ğŸ’ªğŸ˜Š',
                    'ã‚„ã£ãŸã€œ(^o^)/',
                    'â˜…é‡è¦â˜…æ³¨ç›®â˜…',
                    'å£²ä¸Šâ†‘30%é”æˆï¼',
                    'Hello Worldï¼ã“ã‚“ã«ã¡ã¯'
                ]
            },
            ambiguous: {
                name: 'æ›–æ˜§è¡¨ç¾',
                samples: [
                    'ã‚ã‚Œ', 'ã“ã‚Œ', 'ãã‚Œ',
                    'ãªã‚“ã‹', 'ã†ãƒ¼ã‚“', 'ã¾ã‚ã¾ã‚',
                    'ã¡ã‚‡ã£ã¨', 'ã™ã”ã', 'ã‚ã£ã¡ã‚ƒ'
                ]
            },
            boundary: {
                name: 'å¢ƒç•Œå€¤',
                samples: [
                    '', ' ', 'ã€€', '\n', '\t',
                    '0', '00000', 'null', 'undefined',
                    '!!!', 'ï¼Ÿï¼Ÿï¼Ÿ', 'ã€‚ã€‚ã€‚'
                ]
            },
            mixed: {
                name: 'è¤‡åˆã‚±ãƒ¼ã‚¹',
                samples: [
                    'ã€€ã€€çŸ­ã„ã€€ã€€',
                    'ğŸ˜€æ··åœ¨ğŸ˜€ãƒ†ã‚¹ãƒˆğŸ˜€',
                    'ï¼‘ï¼’ï¼“ã‚ã„ã†ï¼”ï¼•ï¼–',
                    '\n\nè¤‡æ•°\næ”¹è¡Œ\n\n',
                    'ï¼¡ï¼¢ï¼£ï¼¤ï¼¥å…¨è§’è‹±å­—'
                ]
            }
        };
        
        // 200ã‚µãƒ³ãƒ—ãƒ«ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚‚è¿½åŠ 
        async function loadStandardTestData() {
            try {
                const response = await fetch('test-samples-200-categorized.json');
                return await response.json();
            } catch {
                return null;
            }
        }
        
        async function runIntegrationTest() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            const results = {
                categories: {},
                totalTests: 0,
                totalSuccess: 0,
                totalErrors: 0,
                performanceMetrics: {
                    avgTime: 0,
                    maxTime: 0,
                    minTime: Infinity
                },
                edgeCaseImprovement: {
                    before: { short: 70, long: 85, special: 60, boundary: 40 },
                    after: {}
                },
                coverageMetrics: {
                    uniqueLines: new Set(),
                    uniqueHexagrams: new Set()
                }
            };
            
            // å„ã‚«ãƒ†ã‚´ãƒªã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
            for (const [key, category] of Object.entries(integrationTests)) {
                results.categories[key] = {
                    name: category.name,
                    total: 0,
                    success: 0,
                    errors: [],
                    samples: []
                };
                
                for (const sample of category.samples) {
                    results.totalTests++;
                    results.categories[key].total++;
                    
                    const startTime = performance.now();
                    
                    try {
                        const result = await bridge.analyzeText(sample);
                        const endTime = performance.now();
                        const processingTime = endTime - startTime;
                        
                        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¡ãƒˆãƒªã‚¯ã‚¹æ›´æ–°
                        results.performanceMetrics.avgTime += processingTime;
                        results.performanceMetrics.maxTime = Math.max(results.performanceMetrics.maxTime, processingTime);
                        results.performanceMetrics.minTime = Math.min(results.performanceMetrics.minTime, processingTime);
                        
                        if (result && result.hexagram_number && result.line_position) {
                            results.totalSuccess++;
                            results.categories[key].success++;
                            
                            // ã‚«ãƒãƒ¬ãƒƒã‚¸çµ±è¨ˆ
                            const lineKey = `${result.hexagram_number}-${result.line_position}`;
                            results.coverageMetrics.uniqueLines.add(lineKey);
                            results.coverageMetrics.uniqueHexagrams.add(result.hexagram_number);
                            
                            results.categories[key].samples.push({
                                input: sample,
                                result: result,
                                time: processingTime,
                                success: true
                            });
                        } else {
                            throw new Error('ä¸å®Œå…¨ãªçµæœ');
                        }
                    } catch (error) {
                        results.totalErrors++;
                        results.categories[key].errors.push({
                            input: sample,
                            error: error.message
                        });
                        
                        results.categories[key].samples.push({
                            input: sample,
                            error: error.message,
                            success: false
                        });
                    }
                }
                
                // ã‚«ãƒ†ã‚´ãƒªåˆ¥æˆåŠŸç‡ã‚’è¨ˆç®—
                const successRate = (results.categories[key].success / results.categories[key].total) * 100;
                
                // ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ”¹å–„åº¦ã‚’è¨˜éŒ²
                if (key === 'shortEdge') results.edgeCaseImprovement.after.short = successRate;
                if (key === 'longEdge') results.edgeCaseImprovement.after.long = successRate;
                if (key === 'special') results.edgeCaseImprovement.after.special = successRate;
                if (key === 'boundary') results.edgeCaseImprovement.after.boundary = successRate;
            }
            
            // å¹³å‡å‡¦ç†æ™‚é–“ã‚’è¨ˆç®—
            results.performanceMetrics.avgTime = results.performanceMetrics.avgTime / results.totalTests;
            
            // æ¨™æº–ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã§ã®æ¤œè¨¼ã‚‚å®Ÿè¡Œ
            const standardData = await loadStandardTestData();
            if (standardData) {
                const standardResults = await testWithStandardData(bridge, standardData);
                results.standardTest = standardResults;
            }
            
            displayResults(results);
        }
        
        async function testWithStandardData(bridge, testData) {
            const results = {
                total: 0,
                uniqueLines: new Set(),
                positionCounts: [0, 0, 0, 0, 0, 0, 0]
            };
            
            for (const [category, samples] of Object.entries(testData.samples)) {
                for (const text of samples.slice(0, 10)) { // å„ã‚«ãƒ†ã‚´ãƒªã‹ã‚‰10ã‚µãƒ³ãƒ—ãƒ«ãšã¤
                    try {
                        const result = await bridge.analyzeText(text);
                        if (result && result.hexagram_number && result.line_position) {
                            results.total++;
                            const lineKey = `${result.hexagram_number}-${result.line_position}`;
                            results.uniqueLines.add(lineKey);
                            results.positionCounts[result.line_position]++;
                        }
                    } catch (error) {
                        // ã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
                    }
                }
            }
            
            return results;
        }
        
        function displayResults(results) {
            document.getElementById('loading').style.display = 'none';
            
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹è¡¨ç¤º
            displayMetrics(results);
            
            // è©³ç´°çµæœè¡¨ç¤º
            displayDetailedResults(results);
            
            // ã‚µãƒãƒªãƒ¼è¡¨ç¤º
            displaySummary(results);
        }
        
        function displayMetrics(results) {
            const overallRate = ((results.totalSuccess / results.totalTests) * 100).toFixed(1);
            const coverageRate = ((results.coverageMetrics.uniqueLines.size / 384) * 100).toFixed(2);
            
            let html = '<div class="metrics-grid">';
            
            // ç·åˆæˆåŠŸç‡
            html += '<div class="metric-card">';
            html += '<div>ç·åˆæˆåŠŸç‡</div>';
            html += `<div class="metric-value ${overallRate >= 95 ? 'excellent' : overallRate >= 90 ? 'good' : 'warning'}">${overallRate}%</div>`;
            html += `<div>${results.totalSuccess}/${results.totalTests} ãƒ†ã‚¹ãƒˆ</div>`;
            html += '</div>';
            
            // å¹³å‡å‡¦ç†æ™‚é–“
            html += '<div class="metric-card">';
            html += '<div>å¹³å‡å‡¦ç†æ™‚é–“</div>';
            html += `<div class="metric-value good">${results.performanceMetrics.avgTime.toFixed(1)}ms</div>`;
            html += `<div>æœ€å¤§: ${results.performanceMetrics.maxTime.toFixed(1)}ms</div>`;
            html += '</div>';
            
            // ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ”¹å–„
            const edgeImprovement = calculateEdgeImprovement(results.edgeCaseImprovement);
            html += '<div class="metric-card">';
            html += '<div>ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ”¹å–„åº¦</div>';
            html += `<div class="metric-value ${edgeImprovement >= 20 ? 'excellent' : 'good'}">+${edgeImprovement.toFixed(0)}%</div>`;
            html += '<div>å¹³å‡æ”¹å–„ç‡</div>';
            html += '</div>';
            
            html += '</div>';
            
            document.getElementById('metrics').innerHTML = html;
            document.getElementById('metrics').style.display = 'block';
        }
        
        function displayDetailedResults(results) {
            let html = '<div class="progress-chart">';
            html += '<h2>ğŸ“Š ã‚«ãƒ†ã‚´ãƒªåˆ¥æˆåŠŸç‡</h2>';
            
            for (const [key, category] of Object.entries(results.categories)) {
                const rate = ((category.success / category.total) * 100).toFixed(1);
                html += `<div style="margin: 15px 0;">`;
                html += `<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">`;
                html += `<span>${category.name}</span>`;
                html += `<span>${rate}% (${category.success}/${category.total})</span>`;
                html += `</div>`;
                html += '<div class="progress-bar">';
                html += `<div class="progress-fill" style="width: ${rate}%;">${rate}%</div>`;
                html += '</div>';
                html += '</div>';
            }
            
            html += '</div>';
            
            // ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ”¹å–„æ¯”è¼ƒ
            html += '<div class="summary">';
            html += '<h2>ğŸ“ˆ ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹æ”¹å–„åŠ¹æœ</h2>';
            html += '<table>';
            html += '<tr><th>ã‚«ãƒ†ã‚´ãƒª</th><th>æ”¹å–„å‰</th><th>æ”¹å–„å¾Œ</th><th>æ”¹å–„åº¦</th></tr>';
            
            const improvements = [
                { name: 'çŸ­æ–‡å‡¦ç†', before: results.edgeCaseImprovement.before.short, after: results.edgeCaseImprovement.after.short || 0 },
                { name: 'é•·æ–‡å‡¦ç†', before: results.edgeCaseImprovement.before.long, after: results.edgeCaseImprovement.after.long || 0 },
                { name: 'ç‰¹æ®Šæ–‡å­—', before: results.edgeCaseImprovement.before.special, after: results.edgeCaseImprovement.after.special || 0 },
                { name: 'å¢ƒç•Œå€¤', before: results.edgeCaseImprovement.before.boundary, after: results.edgeCaseImprovement.after.boundary || 0 }
            ];
            
            for (const imp of improvements) {
                const improvement = imp.after - imp.before;
                const improvementClass = improvement > 20 ? 'excellent' : improvement > 10 ? 'good' : improvement > 0 ? 'warning' : 'bad';
                html += '<tr>';
                html += `<td>${imp.name}</td>`;
                html += `<td>${imp.before}%</td>`;
                html += `<td>${imp.after.toFixed(1)}%</td>`;
                html += `<td class="${improvementClass}">+${improvement.toFixed(1)}%</td>`;
                html += '</tr>';
            }
            
            html += '</table>';
            html += '</div>';
            
            document.getElementById('results').innerHTML = html;
            document.getElementById('results').style.display = 'block';
        }
        
        function displaySummary(results) {
            const overallRate = ((results.totalSuccess / results.totalTests) * 100).toFixed(1);
            
            let html = '<div class="summary">';
            html += '<h2>ğŸ† Day 5 æœ€çµ‚æˆæœ</h2>';
            
            if (overallRate >= 95) {
                html += '<p class="excellent" style="font-size: 1.3em;">âœ… ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œãŒå¤§å¹…ã«æ”¹å–„ã•ã‚Œã¾ã—ãŸï¼</p>';
            } else if (overallRate >= 90) {
                html += '<p class="good">ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å‡¦ç†ãŒæ”¹å–„ã•ã‚Œã¦ã„ã¾ã™ã€‚</p>';
            }
            
            html += '<h3>ä¸»è¦æˆæœ</h3>';
            html += '<ul>';
            html += '<li>çŸ­æ–‡å‡¦ç†: 1æ–‡å­—ã§ã‚‚é©åˆ‡ã«å‡¦ç†å¯èƒ½ã«</li>';
            html += '<li>é•·æ–‡å‡¦ç†: 150æ–‡å­—è¶…ã®è¦ç´„æ©Ÿèƒ½å®Ÿè£…</li>';
            html += '<li>ç‰¹æ®Šæ–‡å­—: çµµæ–‡å­—ãƒ»é¡”æ–‡å­—ã®æ­£è¦åŒ–å‡¦ç†</li>';
            html += '<li>æ›–æ˜§å…¥åŠ›: æŒ‡ç¤ºèªã®å…·ä½“åŒ–å¤‰æ›</li>';
            html += '<li>å¢ƒç•Œå€¤: ç©ºæ–‡å­—åˆ—ãªã©ã®å®‰å…¨ãªå‡¦ç†</li>';
            html += '</ul>';
            
            // æ¨™æº–ãƒ†ã‚¹ãƒˆçµæœãŒã‚ã‚Œã°è¡¨ç¤º
            if (results.standardTest) {
                const coverageRate = ((results.standardTest.uniqueLines.size / 384) * 100).toFixed(2);
                html += '<h3>æ¨™æº–ãƒ†ã‚¹ãƒˆã§ã®æ¤œè¨¼</h3>';
                html += `<p>ã‚«ãƒãƒ¼ç‡ç¶­æŒ: ${coverageRate}%</p>`;
                html += `<p>ãƒ¦ãƒ‹ãƒ¼ã‚¯çˆ»æ•°: ${results.standardTest.uniqueLines.size}å€‹</p>`;
            }
            
            html += '<h3>Day 5ã®æ„ç¾©</h3>';
            html += '<p>ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹å¯¾å¿œã«ã‚ˆã‚Šã€ã‚·ã‚¹ãƒ†ãƒ ã®<strong>å®‰å®šæ€§</strong>ã¨<strong>ä¿¡é ¼æ€§</strong>ãŒå¤§å¹…ã«å‘ä¸Šã—ã¾ã—ãŸã€‚';
            html += 'å®Ÿç”¨ç’°å¢ƒã§ã®æ§˜ã€…ãªå…¥åŠ›ã«å¯¾ã—ã¦ã€é©åˆ‡ã«å‡¦ç†ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚</p>';
            
            html += '</div>';
            
            document.getElementById('summary').innerHTML = html;
            document.getElementById('summary').style.display = 'block';
        }
        
        function calculateEdgeImprovement(improvement) {
            const values = [
                (improvement.after.short || 0) - improvement.before.short,
                (improvement.after.long || 0) - improvement.before.long,
                (improvement.after.special || 0) - improvement.before.special,
                (improvement.after.boundary || 0) - improvement.before.boundary
            ];
            
            const validValues = values.filter(v => !isNaN(v));
            if (validValues.length === 0) return 0;
            
            return validValues.reduce((sum, v) => sum + v, 0) / validValues.length;
        }
        
        runIntegrationTest();
    </script>
</body>
</html>