<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Day 6 - 微調整実施（Task 6-2）</title>
    <style>
        body { 
            font-family: 'Courier New', monospace; 
            padding: 20px; 
            background: #1e1e1e; 
            color: #d4d4d4;
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 { color: #4ec9b0; }
        h2 { color: #569cd6; }
        h3 { color: #dcdcaa; }
        
        .adjustment-section {
            background: #2d2d30;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
        }
        
        .before-after {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .box {
            background: #252526;
            padding: 15px;
            border-radius: 5px;
        }
        
        .improved { color: #4ec9b0; }
        .warning { color: #dcdcaa; }
        .normal { color: #d4d4d4; }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
        }
        
        th, td {
            padding: 8px;
            text-align: left;
            border: 1px solid #3c3c3c;
        }
        
        th { background: #252526; }
        
        .code-block {
            background: #1e1e1e;
            padding: 10px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            margin: 10px 0;
            overflow-x: auto;
        }
        
        .metric-card {
            background: #252526;
            padding: 10px;
            margin: 5px;
            border-radius: 3px;
            display: inline-block;
        }
        
        .metric-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #4ec9b0;
        }
        
        .chart-bar {
            height: 20px;
            background: linear-gradient(to right, #4ec9b0, #569cd6);
            border-radius: 3px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <h1>Day 6 - 微調整実施（Task 6-2）</h1>
    
    <div id="adjustments"></div>
    
    <script type="module">
        import { TextTo384LinesBridge } from './public/js/ai/TextTo384LinesBridge.js';
        
        // Task 6-2: 微調整の実装
        async function implementAdjustments() {
            const bridge = new TextTo384LinesBridge();
            await bridge.initialize();
            
            let html = '';
            
            // 調整内容の定義
            const adjustments = {
                positionWeights: {
                    title: '位置重み調整',
                    changes: [
                        { position: 1, before: 0.50, after: 0.52, reason: 'バランス改善' },
                        { position: 2, before: 0.43, after: 0.43, reason: '維持（適切）' },
                        { position: 3, before: 0.58, after: 0.58, reason: '維持（適切）' },
                        { position: 4, before: 0.60, after: 0.60, reason: '維持（適切）' },
                        { position: 5, before: 0.70, after: 0.65, reason: '過度な偏り防止' },
                        { position: 6, before: 0.40, after: 0.42, reason: '微増で均衡化' }
                    ]
                },
                penaltySystem: {
                    title: 'ペナルティカーブ調整',
                    changes: [
                        { usage: 1, before: 0.90, after: 0.92, reason: '緩和' },
                        { usage: 2, before: 0.75, after: 0.80, reason: '緩和' },
                        { usage: 3, before: 0.55, after: 0.65, reason: '緩和' },
                        { usage: 4, before: 0.35, after: 0.45, reason: '緩和' },
                        { usage: 5, before: 0.20, after: 0.30, reason: '緩和' }
                    ]
                },
                explorationNoise: {
                    title: '探索ノイズ調整',
                    changes: [
                        { type: 'unusedBonus', before: 0.20, after: 0.18, reason: '微調整' },
                        { type: 'rareBonus', before: 0.10, after: 0.12, reason: '低使用促進' },
                        { type: 'primaryNoise', before: '0-0.2', after: '0-0.15', reason: '範囲縮小' }
                    ]
                }
            };
            
            // 調整前後の比較表示
            html += '<div class="adjustment-section">';
            html += '<h2>📊 微調整の実装内容</h2>';
            
            // 位置重み調整
            html += '<h3>1️⃣ ' + adjustments.positionWeights.title + '</h3>';
            html += '<div class="before-after">';
            
            html += '<div class="box">';
            html += '<h4>調整前</h4>';
            html += '<table>';
            for (const change of adjustments.positionWeights.changes) {
                html += `<tr><td>${change.position}爻</td><td>${change.before.toFixed(2)}</td></tr>`;
            }
            html += '</table>';
            html += '</div>';
            
            html += '<div class="box">';
            html += '<h4>調整後</h4>';
            html += '<table>';
            for (const change of adjustments.positionWeights.changes) {
                const changeClass = change.before !== change.after ? 'improved' : 'normal';
                html += `<tr><td>${change.position}爻</td>`;
                html += `<td class="${changeClass}">${change.after.toFixed(2)}</td>`;
                html += `<td>${change.reason}</td></tr>`;
            }
            html += '</table>';
            html += '</div>';
            
            html += '</div>';
            
            // ペナルティシステム調整
            html += '<h3>2️⃣ ' + adjustments.penaltySystem.title + '</h3>';
            html += '<p>使用頻度ペナルティをより緩やかにして、多様性と安定性のバランスを改善</p>';
            html += '<table>';
            html += '<tr><th>使用回数</th><th>調整前</th><th>調整後</th><th>変化量</th></tr>';
            for (const change of adjustments.penaltySystem.changes) {
                const diff = change.after - change.before;
                html += '<tr>';
                html += `<td>${change.usage}回</td>`;
                html += `<td>${change.before.toFixed(2)}</td>`;
                html += `<td class="improved">${change.after.toFixed(2)}</td>`;
                html += `<td class="improved">+${diff.toFixed(2)}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            // 探索ノイズ調整
            html += '<h3>3️⃣ ' + adjustments.explorationNoise.title + '</h3>';
            html += '<table>';
            html += '<tr><th>パラメータ</th><th>調整前</th><th>調整後</th><th>理由</th></tr>';
            for (const change of adjustments.explorationNoise.changes) {
                html += '<tr>';
                html += `<td>${change.type}</td>`;
                html += `<td>${change.before}</td>`;
                html += `<td class="improved">${change.after}</td>`;
                html += `<td>${change.reason}</td>`;
                html += '</tr>';
            }
            html += '</table>';
            
            html += '</div>';
            
            // 実装コード表示
            html += '<div class="adjustment-section">';
            html += '<h2>🔧 実装コード（TextTo384LinesBridge.js の変更箇所）</h2>';
            
            html += '<h3>位置重み配列の更新</h3>';
            html += '<div class="code-block">';
            html += `const positionWeights = [
    0.52,  // 1爻: 0.50→0.52 バランス改善
    0.43,  // 2爻: 維持
    0.58,  // 3爻: 維持
    0.60,  // 4爻: 維持
    0.65,  // 5爻: 0.70→0.65 過度な偏り防止
    0.42   // 6爻: 0.40→0.42 微増で均衡化
];`;
            html += '</div>';
            
            html += '<h3>ペナルティ関数の更新</h3>';
            html += '<div class="code-block">';
            html += `const getPenalty = (usageCount) => {
    if (usageCount === 1) return 0.92;  // 0.90→0.92
    if (usageCount === 2) return 0.80;  // 0.75→0.80
    if (usageCount === 3) return 0.65;  // 0.55→0.65
    if (usageCount === 4) return 0.45;  // 0.35→0.45
    if (usageCount >= 5) return 0.30;   // 0.20→0.30
    return 1.0;
};`;
            html += '</div>';
            
            html += '<h3>探索ノイズの更新</h3>';
            html += '<div class="code-block">';
            html += `// 未使用爻ボーナス
const unusedBonus = (usageCount === 0) ? 0.18 : 0;  // 0.20→0.18
const rareBonus = (usageCount === 1) ? 0.12 : 0;    // 0.10→0.12

// プライマリノイズ範囲
const primaryNoise = ((lineId * noiseBase * 13) % 150) / 1000; // 0-0.15に縮小`;
            html += '</div>';
            html += '</div>';
            
            // 効果測定
            html += '<div class="adjustment-section">';
            html += '<h2>🎯 調整効果の予測</h2>';
            
            html += '<h3>期待される改善</h3>';
            html += '<ul>';
            html += '<li class="improved">✅ 5爻選択率: 7-8% → 6-7%（適正化）</li>';
            html += '<li class="improved">✅ 1爻選択率: 15% → 16-17%（改善）</li>';
            html += '<li class="improved">✅ 6爻選択率: 15% → 16%（微改善）</li>';
            html += '<li class="improved">✅ カバー率: 11% → 12-13%（向上）</li>';
            html += '<li class="improved">✅ χ²値: 7-8 → 5-6（バランス改善）</li>';
            html += '</ul>';
            
            html += '<h3>リスクと対策</h3>';
            html += '<ul>';
            html += '<li class="warning">⚠️ 5爻の調整が大きすぎる可能性 → 段階的に観察</li>';
            html += '<li class="warning">⚠️ ペナルティ緩和による多様性低下 → 探索ノイズで補償</li>';
            html += '<li class="warning">⚠️ 処理速度への影響 → Task 6-3で最適化</li>';
            html += '</ul>';
            html += '</div>';
            
            // テスト用サンプル
            html += '<div class="adjustment-section">';
            html += '<h2>📝 動作確認用テストサンプル</h2>';
            html += '<p>以下のサンプルで調整効果を確認：</p>';
            html += '<ol>';
            const testSamples = [
                '新しい始まり',
                '協力して進める',
                '困難を乗り越える',
                '変化に対応する',
                'リーダーシップを発揮',
                '完成に向けて',
                '決断の時',
                '内部調整',
                '外部環境',
                '戦略的判断'
            ];
            for (const sample of testSamples) {
                html += `<li>${sample}</li>`;
            }
            html += '</ol>';
            html += '</div>';
            
            document.getElementById('adjustments').innerHTML = html;
        }
        
        implementAdjustments();
    </script>
</body>
</html>