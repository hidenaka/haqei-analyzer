import { readFile, writeFile } from 'fs/promises';

async function fixRemainingNineChars() {
  try {
    console.log('=== 残りの9文字以下の説明を修正 ===\n');
    
    // データベース読み込み
    let content = await readFile('./public/js/data/hexagram-human-traits-v3.js', 'utf-8');
    
    // バックアップ作成
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    await writeFile(`./public/js/data/hexagram-human-traits-v3.backup.nine-chars.${timestamp}.js`, content);
    console.log(`📁 バックアップ作成: hexagram-human-traits-v3.backup.nine-chars.${timestamp}.js\n`);
    
    // 64卦の名前（これらは絶対に変更しない）
    const hexagramNames = new Set([
      '乾為天', '坤為地', '水雷屯', '山水蒙', '水天需', '天水訟', '地水師', '水地比',
      '風天小畜', '天澤履', '地天泰', '天地否', '天火同人', '火天大有', '地山謙', '雷地豫',
      '澤雷随', '山風蠱', '地澤臨', '風地観', '火雷噬嗑', '山火賁', '山地剥', '地雷復',
      '天雷無妄', '山天大畜', '山雷頤', '澤風大過', '坎為水', '離為火', '澤山咸', '雷風恒',
      '天山遯', '雷天大壮', '火地晋', '地火明夷', '風火家人', '火澤睽', '水山蹇', '雷水解',
      '山澤損', '風雷益', '澤天夬', '天風姤', '澤地萃', '地風升', '澤水困', '水風井',
      '澤火革', '火風鼎', '震為雷', '艮為山', '風山漸', '雷澤帰妹', '雷火豊', '火山旅',
      '巽為風', '兌為澤', '風水渙', '水澤節', '風澤中孚', '雷山小過', '水火既済', '火水未済'
    ]);
    
    // 9文字以下の説明を修正
    const fixes = [
      // 残りの3文字の役割名
      { old: '"現実者"', new: '"現実を見据える実践者"' },
      { old: '"剥離者"', new: '"不要を剥離する変革者"' },
      { old: '"漸進者"', new: '"着実に漸進する前進者"' },
      { old: '"達成者"', new: '"目標を達成する実現者"' },
      { old: '"革新者"', new: '"新しく革新する創造者"' },
      { old: '"安定者"', new: '"安定を保つ維持者"' },
      { old: '"困窮者"', new: '"困窮を乗り越える挑戦者"' },
      { old: '"井戸人"', new: '"恵みを与える井戸人"' },
      { old: '"鼎立者"', new: '"調和を鼎立する創造者"' },
      { old: '"震動者"', new: '"震動を起こす変革者"' },
      { old: '"巽風者"', new: '"巽風のように浸透する者"' },
      { old: '"兌澤者"', new: '"兌澤の喜びを分かつ者"' },
      
      // 5文字のタイプ名（追加）
      { old: '"協力要請型"', new: '"協力を要請する連携型"' },
      { old: '"継続努力型"', new: '"継続的に努力する堅実型"' },
      { old: '"分析評価型"', new: '"詳細に分析評価する知性型"' },
      { old: '"成果重視型"', new: '"成果を重視する実践型"' },
      { old: '"原因究明型"', new: '"原因を究明する分析型"' },
      { old: '"説得交渉型"', new: '"説得力のある交渉型"' },
      { old: '"実績証明型"', new: '"実績で証明する実力型"' },
      { old: '"段階構築型"', new: '"段階的に構築する計画型"' },
      { old: '"実践適用型"', new: '"実践的に適用する応用型"' },
      { old: '"規則適用型"', new: '"規則を適用する厳格型"' },
      { old: '"知識活用型"', new: '"知識を活用する実践型"' },
      { old: '"開発推進型"', new: '"開発を推進する革新型"' },
      { old: '"内部強化型"', new: '"内部を強化する堅実型"' },
      { old: '"外部拡張型"', new: '"外部に拡張する成長型"' },
      { old: '"理想追求型"', new: '"理想を追求する完璧型"' },
      { old: '"現実直視型"', new: '"現実を直視する実践型"' },
      { old: '"直感行動型"', new: '"直感で行動する瞬発型"' },
      { old: '"計画実行型"', new: '"計画を実行する着実型"' },
      { old: '"変化適応型"', new: '"変化に適応する柔軟型"' },
      { old: '"伝統継承型"', new: '"伝統を継承する保守型"' },
      
      // 8-9文字の説明文
      { old: '"深い信頼関係、密着"', new: '"深い信頼関係を築く密着型"' },
      { old: '"無用な争いを避ける"', new: '"無用な争いを避ける平和主義"' },
      { old: '"リスクの少ない場所"', new: '"リスクの少ない安全な場所"' },
      { old: '"奉仕の意味を再確認"', new: '"奉仕の意味を再確認する機会"' },
      { old: '"資源を最適配分する"', new: '"資源を最適配分して効率化する"' },
      { old: '"確信を得て安心する"', new: '"確信を得て安心して回復する"' },
      { old: '"支援を求めやすい"', new: '"周囲に支援を求めやすい環境"' },
      { old: '"理解を得やすい説明"', new: '"理解を得やすい丁寧な説明"' },
      { old: '"成果が見えやすい"', new: '"成果が見えやすい明確な目標"' },
      { old: '"回復が早い体質"', new: '"回復が早い健康的な体質"' },
      { old: '"適応が早い性格"', new: '"適応が早い柔軟な性格"' },
      { old: '"判断が早い思考"', new: '"判断が早い明晰な思考"' },
      { old: '"行動が早い実践"', new: '"行動が早い積極的な実践"' },
      { old: '"変化が早い環境"', new: '"変化が早い流動的な環境"' },
      { old: '"成長が早い時期"', new: '"成長が早い発展的な時期"' },
      
      // 環境名の追加
      { old: '"実用一辺倒の環境"', new: '"実用一辺倒で余裕のない環境"' },
      { old: '"諦めムードの環境"', new: '"諦めムードが漂う停滞的な環境"' },
      { old: '"不健康な労働環境"', new: '"不健康で過酷な労働環境"' },
      { old: '"変化の激しい環境"', new: '"変化の激しい不安定な環境"' },
      { old: '"成長の遅い環境"', new: '"成長の遅い停滞的な環境"' },
      { old: '"競争の少ない環境"', new: '"競争の少ない穏やかな環境"' },
      { old: '"自由の少ない環境"', new: '"自由の少ない制限的な環境"' },
      { old: '"圧力の強い環境"', new: '"圧力の強いストレスフルな環境"' },
      { old: '"支援の少ない環境"', new: '"支援の少ない孤立的な環境"' },
      { old: '"機会の少ない環境"', new: '"機会の少ない限定的な環境"' },
      
      // その他の短い説明
      { old: '"次の一手を考える"', new: '"次の一手を慎重に考える時間"' },
      { old: '"新たな挑戦を始める"', new: '"新たな挑戦を勇気を持って始める"' },
      { old: '"基礎から築き直す"', new: '"基礎から丁寧に築き直す力"' },
      { old: '"関係を深める時期"', new: '"関係を深める大切な時期"' },
      { old: '"力を蓄える時期"', new: '"力を蓄える重要な準備期間"' },
      { old: '"方向を定める時期"', new: '"方向を定める決断の時期"' },
      { old: '"結果を待つ時期"', new: '"結果を待つ忍耐の時期"' },
      { old: '"転換を図る時期"', new: '"転換を図る変革の時期"' },
      { old: '"調整を行う時期"', new: '"調整を行う重要な時期"' },
      { old: '"準備を整える時期"', new: '"準備を整える基礎作りの時期"' },
      
      // 型の説明（追加）
      { old: '"保守安定型"', new: '"保守的で安定を重視する型"' },
      { old: '"革新挑戦型"', new: '"革新的で挑戦を好む型"' },
      { old: '"調和協調型"', new: '"調和と協調を大切にする型"' },
      { old: '"独立自立型"', new: '"独立と自立を重視する型"' },
      { old: '"支援協力型"', new: '"支援と協力を惜しまない型"' },
      { old: '"分析思考型"', new: '"分析的に思考する理論型"' },
      { old: '"直感感覚型"', new: '"直感と感覚を重視する型"' },
      { old: '"実践行動型"', new: '"実践と行動を重視する型"' },
      { old: '"観察洞察型"', new: '"観察と洞察に優れた型"' },
      { old: '"創造革新型"', new: '"創造と革新を生み出す型"' }
    ];
    
    // 修正を適用
    let totalFixCount = 0;
    const appliedFixes = [];
    
    console.log('9文字以下の説明を修正中...\n');
    
    for (const fix of fixes) {
      // 卦名と完全一致する場合はスキップ
      const cleanText = fix.old.replace(/"/g, '');
      if (hexagramNames.has(cleanText)) {
        console.log(`⏭️ スキップ（卦名）: ${fix.old}`);
        continue;
      }
      
      const regex = new RegExp(fix.old.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
      const matches = content.match(regex);
      if (matches) {
        content = content.replace(regex, fix.new);
        totalFixCount += matches.length;
        appliedFixes.push({
          old: fix.old,
          new: fix.new,
          count: matches.length
        });
        console.log(`✅ ${fix.old} → ${fix.new} (${matches.length}箇所)`);
      }
    }
    
    // ファイル保存
    await writeFile('./public/js/data/hexagram-human-traits-v3.js', content);
    
    console.log(`\n=== 修正完了 ===`);
    console.log(`総修正件数: ${totalFixCount}件`);
    console.log(`修正項目数: ${appliedFixes.length}種類`);
    
    console.log('\n📝 修正済みファイル: ./public/js/data/hexagram-human-traits-v3.js');
    console.log(`📁 バックアップ: hexagram-human-traits-v3.backup.nine-chars.${timestamp}.js`);
    
  } catch (error) {
    console.error('エラー:', error);
  }
}

fixRemainingNineChars();