<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>力学データテスト</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border: 1px solid #ddd; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .score-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 10px 0; }
        .score-item { padding: 5px; background: #f8f9fa; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>HaQei Analyzer 力学データテスト</h1>
    
    <div id="test-results"></div>
    
    <!-- データファイル読み込み -->
    <script src="public/js/data/hexagrams.js"></script>
    <script src="public/js/data/hexagram_details.js"></script>
    <script src="public/new-analyzer/js/utils/hexagram-dynamics-calculator.js"></script>
    <script src="public/new-analyzer/js/utils/hexagram-details-fallback.js"></script>
    
    <script>
        function runTests() {
            const resultsDiv = document.getElementById('test-results');
            let results = [];
            
            // テスト1: hexagrams_masterデータの確認
            try {
                if (typeof hexagrams_master === 'undefined') {
                    throw new Error('hexagrams_master is not defined');
                }
                
                const hexagram1 = hexagrams_master.find(h => h.hexagram_id === 1);
                if (!hexagram1) {
                    throw new Error('第1卦が見つかりません');
                }
                
                // 力学スコアが追加されているかチェック
                const requiredScores = [
                    'innovation_score', 'stability_score', 'cooperation_score', 
                    'independence_score', 'intuition_score',
                    'resilience_score', 'adaptability_score', 'protection_score',
                    'support_seeking_score', 'introspection_score'
                ];
                
                const missingScores = requiredScores.filter(score => 
                    hexagram1[score] === undefined || hexagram1[score] === 0
                );
                
                if (missingScores.length > 0) {
                    throw new Error(`第1卦に不足しているスコア: ${missingScores.join(', ')}`);
                }
                
                results.push({
                    test: 'hexagrams_masterデータ読み込み',
                    status: 'success',
                    message: `✅ 64卦のデータが正常に読み込まれ、力学スコアが追加されています`,
                    details: {
                        '第1卦の力学スコア': {
                            'innovation_score': hexagram1.innovation_score,
                            'stability_score': hexagram1.stability_score,
                            'cooperation_score': hexagram1.cooperation_score,
                            'independence_score': hexagram1.independence_score,
                            'intuition_score': hexagram1.intuition_score,
                            'resilience_score': hexagram1.resilience_score,
                            'adaptability_score': hexagram1.adaptability_score,
                            'protection_score': hexagram1.protection_score,
                            'support_seeking_score': hexagram1.support_seeking_score,
                            'introspection_score': hexagram1.introspection_score
                        }
                    }
                });
            } catch (error) {
                results.push({
                    test: 'hexagrams_masterデータ読み込み',
                    status: 'error',
                    message: `❌ エラー: ${error.message}`
                });
            }
            
            // テスト2: HexagramDynamicsCalculatorの動作確認
            try {
                if (typeof HexagramDynamicsCalculator === 'undefined') {
                    throw new Error('HexagramDynamicsCalculator is not defined');
                }
                
                const calculator = new HexagramDynamicsCalculator();
                const testDynamics = calculator.calculateHexagramDynamics(1, 1); // 乾為天
                
                if (!testDynamics || typeof testDynamics !== 'object') {
                    throw new Error('力学データの計算結果が不正です');
                }
                
                results.push({
                    test: 'HexagramDynamicsCalculator動作テスト',
                    status: 'success',
                    message: '✅ 力学データ計算機能が正常に動作しています',
                    details: {
                        '乾為天(1,1)の計算結果': testDynamics
                    }
                });
            } catch (error) {
                results.push({
                    test: 'HexagramDynamicsCalculator動作テスト',
                    status: 'error',
                    message: `❌ エラー: ${error.message}`
                });
            }
            
            // テスト3: 複数の卦のスコア確認
            try {
                const testHexagrams = [1, 2, 10, 53]; // 乾為天、坤為地、天澤履、風山漸
                const hexagramScores = {};
                
                for (const hexagramId of testHexagrams) {
                    const hexagram = hexagrams_master.find(h => h.hexagram_id === hexagramId);
                    if (hexagram) {
                        hexagramScores[`第${hexagramId}卦 ${hexagram.name_jp}`] = {
                            innovation: hexagram.innovation_score,
                            stability: hexagram.stability_score,
                            cooperation: hexagram.cooperation_score,
                            independence: hexagram.independence_score,
                            intuition: hexagram.intuition_score
                        };
                    }
                }
                
                results.push({
                    test: '複数卦の力学スコア確認',
                    status: 'success',
                    message: '✅ 複数の卦で力学スコアが正常に設定されています',
                    details: hexagramScores
                });
            } catch (error) {
                results.push({
                    test: '複数卦の力学スコア確認',
                    status: 'error',
                    message: `❌ エラー: ${error.message}`
                });
            }
            
            // テスト4: HEXAGRAM_DETAILSデータ確認
            try {
                if (typeof HEXAGRAM_DETAILS === 'undefined') {
                    throw new Error('HEXAGRAM_DETAILS is not defined');
                }
                
                const detailsCount = Object.keys(HEXAGRAM_DETAILS).length;
                if (detailsCount !== 64) {
                    throw new Error(`期待される64卦ではなく${detailsCount}卦のデータが見つかりました`);
                }
                
                // 第1卦、第10卦、第53卦の詳細データを確認
                const testCases = [1, 10, 53];
                const detailsData = {};
                
                for (const hexagramId of testCases) {
                    const details = HEXAGRAM_DETAILS[hexagramId];
                    if (!details) {
                        throw new Error(`第${hexagramId}卦の詳細データが見つかりません`);
                    }
                    
                    // 必須フィールドのチェック
                    const requiredFields = ['name_jp', 'catchphrase', 'description', 'engine', 'interface', 'safe_mode'];
                    const missingFields = requiredFields.filter(field => !details[field]);
                    if (missingFields.length > 0) {
                        throw new Error(`第${hexagramId}卦に不足フィールド: ${missingFields.join(', ')}`);
                    }
                    
                    detailsData[`第${hexagramId}卦 ${details.name_jp}`] = {
                        catchphrase: details.catchphrase,
                        engine_strengths: details.engine?.potential_strengths?.slice(0, 2),
                        interface_behaviors: details.interface?.behavioral_patterns?.slice(0, 2),
                        safe_mode_triggers: details.safe_mode?.trigger_situations?.slice(0, 2)
                    };
                }
                
                results.push({
                    test: 'HEXAGRAM_DETAILSデータ確認',
                    status: 'success',
                    message: `✅ 全${detailsCount}卦の詳細データが正常に読み込まれています`,
                    details: detailsData
                });
            } catch (error) {
                results.push({
                    test: 'HEXAGRAM_DETAILSデータ確認',
                    status: 'error',
                    message: `❌ エラー: ${error.message}`
                });
            }
            
            // テスト5: フォールバック機能の動作確認
            try {
                if (typeof HexagramDetailsFallback === 'undefined') {
                    throw new Error('HexagramDetailsFallback is not defined');
                }
                
                const fallback = new HexagramDetailsFallback();
                
                // 第1卦でフォールバック機能をテスト
                const fallbackDetails = fallback.getHexagramDetails(1);
                if (!fallbackDetails || !fallbackDetails.engine) {
                    throw new Error('フォールバック機能が正常に動作していません');
                }
                
                results.push({
                    test: 'フォールバック機能動作確認',
                    status: 'success',
                    message: '✅ フォールバック機能が正常に動作しています',
                    details: {
                        '第1卦フォールバック結果': {
                            name: fallbackDetails.name_jp,
                            core_drive: fallbackDetails.engine?.core_drive,
                            strength_meter: fallbackDetails.engine?.strength_meter
                        }
                    }
                });
            } catch (error) {
                results.push({
                    test: 'フォールバック機能動作確認',
                    status: 'error',
                    message: `❌ エラー: ${error.message}`
                });
            }
            
            // 結果を表示
            displayResults(results);
        }
        
        function displayResults(results) {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '';
            
            results.forEach(result => {
                const div = document.createElement('div');
                div.className = `test-result ${result.status}`;
                
                let html = `<h3>${result.test}</h3><p>${result.message}</p>`;
                
                if (result.details) {
                    html += '<h4>詳細:</h4>';
                    for (const [key, value] of Object.entries(result.details)) {
                        html += `<strong>${key}:</strong><br>`;
                        if (typeof value === 'object') {
                            html += '<div class="score-grid">';
                            for (const [scoreKey, scoreValue] of Object.entries(value)) {
                                html += `<div class="score-item">${scoreKey}: ${scoreValue}</div>`;
                            }
                            html += '</div>';
                        } else {
                            html += `${value}<br>`;
                        }
                    }
                }
                
                div.innerHTML = html;
                resultsDiv.appendChild(div);
            });
        }
        
        // ページ読み込み時にテスト実行
        window.onload = runTests;
    </script>
</body>
</html>