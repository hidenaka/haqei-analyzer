<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>H384_DATA統合テスト</title>
    <style>
        body { font-family: 'Courier New', monospace; padding: 20px; background: #1a1a1a; color: #00ff41; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background: rgba(0, 255, 65, 0.1); border: 1px solid #00ff41; }
        .fail { background: rgba(255, 0, 0, 0.1); border: 1px solid #ff0000; color: #ff4444; }
        .info { background: rgba(255, 255, 0, 0.1); border: 1px solid #ffff00; color: #ffff44; }
        pre { background: rgba(0,0,0,0.3); padding: 10px; border-radius: 3px; font-size: 12px; }
    </style>
</head>
<body>
    <h1>🧪 H384_DATA統合問題 TDDテスト</h1>
    <div id="test-results"></div>

    <!-- H384データベース読み込み -->
    <script src="./assets/H384H64database.js"></script>
    
    <script>
        /**
         * TDDテストスイート: H384_DATA統合修正後検証
         * 
         * 目的：
         * - 修正後の動作を包括的に検証
         * - 統計的品質保証の確認
         * - Future Simulator互換性の確認
         */
        class H384DataIntegrationTest {
            constructor() {
                this.results = [];
                this.runTests();
            }

            /**
             * テスト実行: 修正後検証（GREEN段階）
             */
            runTests() {
                console.log('🟢 GREEN段階: 修正後の完全性検証');
                
                this.testH384DataExists();
                this.testWindowH384DataAccess();
                this.testDataIntegrity();
                this.testYoukuuYourikuuEntries();
                this.testLoadH384DataCompatibility();
                this.testAutoValidationFunction();
                this.testTripleOSCompatibility();
                
                this.displayResults();
            }

            /**
             * テスト1: H384_DATA変数の存在確認
             */
            testH384DataExists() {
                const testName = 'H384_DATA変数存在確認';
                try {
                    const exists = typeof H384_DATA !== 'undefined';
                    this.addResult(testName, exists, 
                        exists ? 'H384_DATA変数が定義されています' : 'H384_DATA変数が未定義です');
                } catch (error) {
                    this.addResult(testName, false, `エラー: ${error.message}`);
                }
            }

            /**
             * テスト2: window.H384_DATAアクセス確認（これが現在の問題）
             */
            testWindowH384DataAccess() {
                const testName = 'window.H384_DATAアクセス確認';
                try {
                    const windowAccess = typeof window.H384_DATA !== 'undefined';
                    this.addResult(testName, windowAccess, 
                        windowAccess 
                            ? 'window.H384_DATAでアクセス可能です' 
                            : '❌ window.H384_DATAが未定義です（これが現在の問題）');
                } catch (error) {
                    this.addResult(testName, false, `エラー: ${error.message}`);
                }
            }

            /**
             * テスト3: データ完全性確認（386爻）
             */
            testDataIntegrity() {
                const testName = 'データ完全性確認（386爻）';
                try {
                    if (typeof H384_DATA !== 'undefined' && Array.isArray(H384_DATA)) {
                        const length = H384_DATA.length;
                        const isValid = length === 386;
                        this.addResult(testName, isValid, 
                            `データ長: ${length}/386 ${isValid ? '✅' : '❌'}`);
                    } else {
                        this.addResult(testName, false, 'H384_DATAが配列ではありません');
                    }
                } catch (error) {
                    this.addResult(testName, false, `エラー: ${error.message}`);
                }
            }

            /**
             * テスト4: 用九・用六エントリ確認
             */
            testYoukuuYourikuuEntries() {
                const testName = '用九・用六エントリ確認';
                try {
                    if (typeof H384_DATA !== 'undefined' && Array.isArray(H384_DATA)) {
                        const youkuu = H384_DATA.find(item => item['通し番号'] === 7); // 用九
                        const yourikuu = H384_DATA.find(item => item['通し番号'] === 14); // 用六
                        
                        const hasYoukuu = youkuu && youkuu['爻'] === '用九';
                        const hasYourikuu = yourikuu && yourikuu['爻'] === '用六';
                        
                        this.addResult(testName, hasYoukuu && hasYourikuu, 
                            `用九: ${hasYoukuu ? '✅' : '❌'}, 用六: ${hasYourikuu ? '✅' : '❌'}`);
                    } else {
                        this.addResult(testName, false, 'H384_DATAが利用できません');
                    }
                } catch (error) {
                    this.addResult(testName, false, `エラー: ${error.message}`);
                }
            }

            /**
             * テスト5: LoadH384Data互換性確認
             */
            testLoadH384DataCompatibility() {
                const testName = 'LoadH384Data互換性確認';
                try {
                    // LoadH384Data.jsでのチェックをシミュレート
                    const localCompatible = typeof H384_DATA !== 'undefined';
                    const windowCompatible = typeof window.H384_DATA !== 'undefined';
                    const isCompatible = localCompatible && windowCompatible;
                    
                    this.addResult(testName, isCompatible, 
                        `ローカル: ${localCompatible ? '✅' : '❌'}, グローバル: ${windowCompatible ? '✅' : '❌'}`);
                } catch (error) {
                    this.addResult(testName, false, `エラー: ${error.message}`);
                }
            }

            /**
             * テスト6: 自動検証機能テスト
             */
            testAutoValidationFunction() {
                const testName = '自動検証機能テスト';
                try {
                    const hasValidationFunction = typeof validateH384DataIntegrity === 'function';
                    if (hasValidationFunction) {
                        const validationResult = validateH384DataIntegrity();
                        const allTestsPassed = validationResult.passed;
                        
                        this.addResult(testName, allTestsPassed, 
                            allTestsPassed 
                                ? '✅ 自動検証機能が正常動作し、全テスト合格' 
                                : `⚠️ 自動検証で問題検出: ${JSON.stringify(validationResult.tests)}`);
                    } else {
                        this.addResult(testName, false, '❌ validateH384DataIntegrity関数が存在しません');
                    }
                } catch (error) {
                    this.addResult(testName, false, `エラー: ${error.message}`);
                }
            }

            /**
             * テスト7: Triple OS互換性確認
             */
            testTripleOSCompatibility() {
                const testName = 'Triple OS互換性確認';
                try {
                    if (typeof window.H384_DATA !== 'undefined' && Array.isArray(window.H384_DATA)) {
                        // Triple OSスコアの存在確認
                        const sampleEntry = window.H384_DATA[0];
                        const hasEngineScore = 'S1_基本スコア' in sampleEntry;
                        const hasInterfaceScore = 'S5_主体性推奨スタンス' in sampleEntry;
                        const hasSafeModeScore = 'S3_安定性スコア' in sampleEntry;
                        
                        const isTripleOSCompatible = hasEngineScore && hasInterfaceScore && hasSafeModeScore;
                        
                        this.addResult(testName, isTripleOSCompatible, 
                            `Engine OS: ${hasEngineScore ? '✅' : '❌'}, Interface OS: ${hasInterfaceScore ? '✅' : '❌'}, Safe Mode OS: ${hasSafeModeScore ? '✅' : '❌'}`);
                    } else {
                        this.addResult(testName, false, 'window.H384_DATAが利用できません');
                    }
                } catch (error) {
                    this.addResult(testName, false, `エラー: ${error.message}`);
                }
            }

            /**
             * テスト結果を記録
             */
            addResult(testName, passed, message) {
                this.results.push({
                    name: testName,
                    passed,
                    message,
                    timestamp: new Date().toISOString()
                });
            }

            /**
             * テスト結果を表示
             */
            displayResults() {
                const container = document.getElementById('test-results');
                const passedTests = this.results.filter(r => r.passed).length;
                const totalTests = this.results.length;
                
                container.innerHTML = `
                    <div class="test-result info">
                        <h2>📊 テスト結果サマリー</h2>
                        <p>合格: ${passedTests}/${totalTests} (${Math.round(passedTests/totalTests*100)}%)</p>
                        <p>実行時刻: ${new Date().toLocaleString('ja-JP')}</p>
                    </div>
                `;

                this.results.forEach(result => {
                    const div = document.createElement('div');
                    div.className = `test-result ${result.passed ? 'pass' : 'fail'}`;
                    div.innerHTML = `
                        <h3>${result.passed ? '✅' : '❌'} ${result.name}</h3>
                        <p>${result.message}</p>
                        <small>実行時刻: ${new Date(result.timestamp).toLocaleString('ja-JP')}</small>
                    `;
                    container.appendChild(div);
                });

                // 現在の状態をコンソールにも出力
                console.log('🔍 現在のH384_DATA状態:');
                console.log('typeof H384_DATA:', typeof H384_DATA);
                console.log('typeof window.H384_DATA:', typeof window.H384_DATA);
                console.log('H384_DATA length:', typeof H384_DATA !== 'undefined' ? H384_DATA?.length : 'undefined');
                
                if (typeof H384_DATA !== 'undefined') {
                    console.log('Sample entry:', H384_DATA[0]);
                }
            }
        }

        // テスト実行
        document.addEventListener('DOMContentLoaded', () => {
            new H384DataIntegrationTest();
        });
    </script>
</body>
</html>