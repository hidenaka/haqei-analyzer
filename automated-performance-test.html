<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Analyzer Performance Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
            background: #0a0a0a;
        }
        .success { border-color: #00ff00; }
        .warning { border-color: #ffaa00; }
        .error { border-color: #ff0000; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .metric {
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #333;
            text-align: center;
        }
        .metric h4 {
            margin: 0 0 10px 0;
            color: #ffaa00;
        }
        .metric .value {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>ğŸš€ OS Analyzer Performance Test</h1>
    <p>è‡ªå‹•åŒ–ã•ã‚ŒãŸãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­...</p>
    
    <div id="results"></div>
    
    <div class="metrics">
        <div class="metric">
            <h4>åˆæœŸèª­ã¿è¾¼ã¿æ™‚é–“</h4>
            <div class="value" id="loadTime">æ¸¬å®šä¸­...</div>
        </div>
        <div class="metric">
            <h4>Critical Path ã‚µã‚¤ã‚º</h4>
            <div class="value" id="criticalSize">è¨ˆç®—ä¸­...</div>
        </div>
        <div class="metric">
            <h4>DOMè¦ç´ æ•°</h4>
            <div class="value" id="domCount">ã‚«ã‚¦ãƒ³ãƒˆä¸­...</div>
        </div>
        <div class="metric">
            <h4>ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</h4>
            <div class="value" id="memoryUsage">æ¸¬å®šä¸­...</div>
        </div>
    </div>

    <script>
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        class PerformanceTest {
            constructor() {
                this.startTime = performance.now();
                this.results = [];
                this.criticalFiles = [
                    './js/shared/core/BaseComponent.js',
                    './js/shared/core/MicroStorageManager.js',
                    './js/shared/core/MicroDataManager.js',
                    './js/shared/data/questions.js',
                    './js/os-analyzer/core/PrecompiledQuestions.js',
                    './js/os-analyzer/components/WelcomeScreen.js',
                    './js/os-analyzer/components/HaqeiQuestionElement.js',
                    './js/os-analyzer/components/VirtualQuestionFlow.js'
                ];
            }

            async runTests() {
                await this.testFileLoading();
                await this.testComponentInitialization();
                await this.testDOMPerformance();
                await this.measureMemoryUsage();
                this.generateReport();
            }

            async testFileLoading() {
                console.log('ğŸ”„ ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆé–‹å§‹...');
                
                const loadStartTime = performance.now();
                let totalSize = 0;
                let loadedFiles = 0;

                for (const file of this.criticalFiles) {
                    try {
                        const response = await fetch(file);
                        if (response.ok) {
                            const text = await response.text();
                            totalSize += text.length;
                            loadedFiles++;
                            this.addResult(`âœ… ${file.split('/').pop()}: ${(text.length/1024).toFixed(1)}KB`, 'success');
                        } else {
                            this.addResult(`âŒ ${file}: HTTP ${response.status}`, 'error');
                        }
                    } catch (error) {
                        this.addResult(`âŒ ${file}: ${error.message}`, 'error');
                    }
                }

                const loadTime = performance.now() - loadStartTime;
                const totalSizeKB = (totalSize / 1024).toFixed(1);

                document.getElementById('loadTime').textContent = `${loadTime.toFixed(0)}ms`;
                document.getElementById('criticalSize').textContent = `${totalSizeKB}KB`;

                // ç›®æ¨™ã¨ã®æ¯”è¼ƒ
                if (totalSize <= 121856) { // 119KB
                    this.addResult(`ğŸ¯ Critical Path ã‚µã‚¤ã‚º: ${totalSizeKB}KB (ç›®æ¨™é”æˆ!)`, 'success');
                } else {
                    this.addResult(`âš ï¸ Critical Path ã‚µã‚¤ã‚º: ${totalSizeKB}KB (ç›®æ¨™119KBè¶…é)`, 'warning');
                }

                if (loadTime <= 1000) {
                    this.addResult(`âš¡ èª­ã¿è¾¼ã¿æ™‚é–“: ${loadTime.toFixed(0)}ms (é«˜é€Ÿ!)`, 'success');
                } else {
                    this.addResult(`ğŸŒ èª­ã¿è¾¼ã¿æ™‚é–“: ${loadTime.toFixed(0)}ms (è¦æ”¹å–„)`, 'warning');
                }
            }

            async testComponentInitialization() {
                console.log('ğŸ”„ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ...');
                
                // BaseComponentã®ç¢ºèª
                if (typeof BaseComponent !== 'undefined') {
                    this.addResult('âœ… BaseComponent: æ­£å¸¸ã«èª­ã¿è¾¼ã¿', 'success');
                } else {
                    this.addResult('âŒ BaseComponent: èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                }

                // MicroStorageManagerã®ç¢ºèª
                if (typeof MicroStorageManager !== 'undefined') {
                    this.addResult('âœ… MicroStorageManager: æ­£å¸¸ã«èª­ã¿è¾¼ã¿', 'success');
                } else {
                    this.addResult('âŒ MicroStorageManager: èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                }

                // Web Componentã®ç¢ºèª
                if (typeof HaqeiQuestionElement !== 'undefined') {
                    this.addResult('âœ… HaqeiQuestionElement: æ­£å¸¸ã«èª­ã¿è¾¼ã¿', 'success');
                } else {
                    this.addResult('âŒ HaqeiQuestionElement: èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                }

                // ã‚«ã‚¹ã‚¿ãƒ è¦ç´ ã®ç™»éŒ²ç¢ºèª
                if (customElements.get('haqei-question')) {
                    this.addResult('âœ… <haqei-question>: Web Componentç™»éŒ²æ¸ˆã¿', 'success');
                } else {
                    this.addResult('âŒ <haqei-question>: Web Componentæœªç™»éŒ²', 'error');
                }
            }

            async testDOMPerformance() {
                console.log('ğŸ”„ DOM ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ...');
                
                const domElements = document.querySelectorAll('*').length;
                document.getElementById('domCount').textContent = domElements;

                if (domElements < 100) {
                    this.addResult(`âœ… DOMè¦ç´ æ•°: ${domElements} (è»½é‡)`, 'success');
                } else {
                    this.addResult(`âš ï¸ DOMè¦ç´ æ•°: ${domElements} (ã‚„ã‚„é‡ã„)`, 'warning');
                }

                // ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã®ãƒ†ã‚¹ãƒˆ
                if (typeof VirtualQuestionFlow !== 'undefined') {
                    this.addResult('âœ… VirtualQuestionFlow: ä»®æƒ³ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å¯¾å¿œ', 'success');
                } else {
                    this.addResult('âŒ VirtualQuestionFlow: èª­ã¿è¾¼ã¿å¤±æ•—', 'error');
                }
            }

            async measureMemoryUsage() {
                console.log('ğŸ”„ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¸¬å®š...');
                
                try {
                    if (performance.memory) {
                        const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                        document.getElementById('memoryUsage').textContent = `${memoryMB}MB`;
                        
                        if (memoryMB < 10) {
                            this.addResult(`âœ… ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ${memoryMB}MB (å„ªç§€)`, 'success');
                        } else {
                            this.addResult(`âš ï¸ ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: ${memoryMB}MB (è¦æ³¨æ„)`, 'warning');
                        }
                    } else {
                        document.getElementById('memoryUsage').textContent = 'N/A';
                        this.addResult('â„¹ï¸ ãƒ¡ãƒ¢ãƒªæƒ…å ±: ãƒ–ãƒ©ã‚¦ã‚¶ã§éå¯¾å¿œ', 'warning');
                    }
                } catch (error) {
                    this.addResult(`âŒ ãƒ¡ãƒ¢ãƒªæ¸¬å®šã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                }
            }

            addResult(message, type = 'success') {
                const resultsDiv = document.getElementById('results');
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${type}`;
                resultDiv.textContent = message;
                resultsDiv.appendChild(resultDiv);
                console.log(message);
            }

            generateReport() {
                const totalTime = performance.now() - this.startTime;
                this.addResult(`ğŸ“Š ç·å®Ÿè¡Œæ™‚é–“: ${totalTime.toFixed(0)}ms`, 'success');
                
                // æœ€çµ‚è©•ä¾¡
                const errorCount = document.querySelectorAll('.error').length;
                const warningCount = document.querySelectorAll('.warning').length;
                
                if (errorCount === 0 && warningCount === 0) {
                    this.addResult('ğŸ† ç·åˆè©•ä¾¡: Aç´š (å®Œç’§ãªæœ€é©åŒ–)', 'success');
                } else if (errorCount === 0) {
                    this.addResult('ğŸ¥ˆ ç·åˆè©•ä¾¡: Bç´š (è‰¯å¥½ãªæœ€é©åŒ–)', 'warning');
                } else {
                    this.addResult('ğŸ”§ ç·åˆè©•ä¾¡: Cç´š (è¦æ”¹å–„)', 'error');
                }
            }
        }

        // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        document.addEventListener('DOMContentLoaded', async () => {
            const test = new PerformanceTest();
            await test.runTests();
        });
    </script>
</body>
</html>