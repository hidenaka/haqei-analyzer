<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ 16åã‚Šå•é¡Œä¿®æ­£ç¢ºèª</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; margin: 10px 0; padding: 15px; border-radius: 5px; border-left: 4px solid #007acc; }
        .pass { border-left-color: #28a745; background: #d4edda; }
        .fail { border-left-color: #dc3545; background: #f8d7da; }
        .warning { border-left-color: #ffc107; background: #fff3cd; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
        button { background: #007acc; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
        button:hover { background: #005a9e; }
        .results { margin-top: 20px; }
        .simulation-result { margin: 5px 0; padding: 5px; border-radius: 3px; }
    </style>
</head>
<body>
    <h1>ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ 16åã‚Šå•é¡Œä¿®æ­£ç¢ºèª</h1>
    
    <div class="test-section">
        <h2>ğŸ”§ ä¿®æ­£å†…å®¹</h2>
        <ul>
            <li>DataManager.jsã«getVectorsData()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’è¿½åŠ </li>
            <li>Engine.jsã®ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã‚’å¼·åŒ–</li>
            <li>Calculator.jsã«è©³ç´°ãªæ¤œè¨¼ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ </li>
        </ul>
    </div>

    <div class="test-section">
        <h2>ğŸ§ª ä¿®æ­£åŠ¹æœãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testSingleDiagnosis()">å˜ä¸€è¨ºæ–­ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testMultipleDiagnoses()">å¤šæ§˜æ€§ãƒ†ã‚¹ãƒˆ (100å›)</button>
        <button onclick="testBiasAnalysis()">åã‚Šåˆ†æ (1000å›)</button>
        <div id="test-results" class="results"></div>
    </div>

    <!-- ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ -->
    <script src="js/shared/data/vectors.js"></script>
    <script src="js/shared/data/questions.js"></script>
    <script src="js/shared/core/DataManager.js"></script>
    <script src="js/os-analyzer/core/Calculator.js"></script>
    <script src="js/os-analyzer/core/Engine.js"></script>

    <script>
        console.log('ğŸ”¬ ä¿®æ­£åŠ¹æœæ¤œè¨¼ãƒ†ã‚¹ãƒˆé–‹å§‹');

        let dataManager, calculator, engine;

        async function initializeComponents() {
            try {
                dataManager = new DataManager();
                await dataManager.loadData();
                
                calculator = new Calculator();
                engine = new DiagnosisEngine(dataManager);
                
                console.log('âœ… ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–å®Œäº†');
                return true;
            } catch (error) {
                console.error('âŒ ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆåˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
                displayResult('fail', `åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                return false;
            }
        }

        function createRandomAnswers() {
            const dimensionKeys = [
                "ä¹¾_å‰µé€ æ€§", "éœ‡_è¡Œå‹•æ€§", "å_æ¢æ±‚æ€§", "è‰®_å®‰å®šæ€§",
                "å¤_å—å®¹æ€§", "å·½_é©å¿œæ€§", "é›¢_è¡¨ç¾æ€§", "å…Œ_èª¿å’Œæ€§"
            ];
            
            const answers = [];
            
            // ãƒ©ãƒ³ãƒ€ãƒ ãªå›ç­”ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ç”Ÿæˆ
            for (let i = 1; i <= 12; i++) {
                const randomDimension = dimensionKeys[Math.floor(Math.random() * dimensionKeys.length)];
                const randomValue = (Math.random() * 4) + 1; // 1-5ã®ç¯„å›²
                
                answers.push({
                    questionId: `q${i}`,
                    selectedValue: String.fromCharCode(65 + Math.floor(Math.random() * 3)), // A, B, C
                    scoring_tags: [
                        { key: randomDimension, value: randomValue },
                        { key: dimensionKeys[Math.floor(Math.random() * dimensionKeys.length)], value: Math.random() * 2 }
                    ]
                });
            }
            
            return answers;
        }

        async function testSingleDiagnosis() {
            displayResult('info', 'å˜ä¸€è¨ºæ–­ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...');
            
            if (!(await initializeComponents())) return;
            
            try {
                const testAnswers = createRandomAnswers();
                console.log('ğŸ“ ãƒ†ã‚¹ãƒˆç”¨å›ç­”:', testAnswers);
                
                const result = await engine.analyze(testAnswers);
                
                if (result && result.primaryOS) {
                    displayResult('pass', `è¨ºæ–­æˆåŠŸ: ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ ${result.primaryOS.osId} (ã‚¹ã‚³ã‚¢: ${result.primaryOS.score?.toFixed(3)})`);
                    
                    if (result.topCandidates && result.topCandidates.length > 0) {
                        const candidateIds = result.topCandidates.map(c => c.osId);
                        const uniqueCount = new Set(candidateIds).size;
                        displayResult(uniqueCount > 1 ? 'pass' : 'warning', 
                            `å€™è£œå¤šæ§˜æ€§: ${uniqueCount}/4 ãƒ¦ãƒ‹ãƒ¼ã‚¯ [${candidateIds.join(', ')}]`);
                    }
                } else {
                    displayResult('fail', 'è¨ºæ–­çµæœãŒç„¡åŠ¹ã§ã™');
                }
                
            } catch (error) {
                displayResult('fail', `è¨ºæ–­ã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function testMultipleDiagnoses() {
            displayResult('info', 'å¤šæ§˜æ€§ãƒ†ã‚¹ãƒˆ (100å›) å®Ÿè¡Œä¸­...');
            
            if (!(await initializeComponents())) return;
            
            const results = [];
            const hexagramCounts = {};
            
            try {
                for (let i = 0; i < 100; i++) {
                    const testAnswers = createRandomAnswers();
                    const result = await engine.analyze(testAnswers);
                    
                    if (result && result.primaryOS) {
                        const hexagramId = result.primaryOS.osId;
                        results.push(hexagramId);
                        hexagramCounts[hexagramId] = (hexagramCounts[hexagramId] || 0) + 1;
                    }
                }
                
                const uniqueHexagrams = Object.keys(hexagramCounts).length;
                const maxCount = Math.max(...Object.values(hexagramCounts));
                const mostFrequent = Object.entries(hexagramCounts)
                    .find(([id, count]) => count === maxCount)[0];
                const hex16Count = hexagramCounts[16] || 0;
                
                displayResult(uniqueHexagrams > 10 ? 'pass' : 'warning', 
                    `å¤šæ§˜æ€§çµæœ: ${uniqueHexagrams}ç¨®é¡ã®ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ ç”Ÿæˆ`);
                displayResult(maxCount < 20 ? 'pass' : 'warning',
                    `æœ€é »å‡º: ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ ${mostFrequent} (${maxCount}å›)`);
                displayResult(hex16Count < 20 ? 'pass' : 'warning',
                    `ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ 16: ${hex16Count}å› (${(hex16Count/100*100).toFixed(1)}%)`);
                
                // åˆ†å¸ƒè©³ç´°
                const distribution = Object.entries(hexagramCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10)
                    .map(([id, count]) => `${id}:${count}`)
                    .join(', ');
                displayResult('info', `ä¸Šä½10åˆ†å¸ƒ: ${distribution}`);
                
            } catch (error) {
                displayResult('fail', `å¤šæ§˜æ€§ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        async function testBiasAnalysis() {
            displayResult('info', 'åã‚Šåˆ†æ (1000å›) å®Ÿè¡Œä¸­...');
            
            if (!(await initializeComponents())) return;
            
            const hexagramCounts = {};
            let successCount = 0;
            let errorCount = 0;
            
            try {
                for (let i = 0; i < 1000; i++) {
                    try {
                        const testAnswers = createRandomAnswers();
                        const result = await engine.analyze(testAnswers);
                        
                        if (result && result.primaryOS) {
                            const hexagramId = result.primaryOS.osId;
                            hexagramCounts[hexagramId] = (hexagramCounts[hexagramId] || 0) + 1;
                            successCount++;
                        }
                    } catch (error) {
                        errorCount++;
                        if (errorCount <= 5) {
                            console.warn(`è¨ºæ–­ã‚¨ãƒ©ãƒ¼ ${i+1}:`, error.message);
                        }
                    }
                }
                
                const uniqueHexagrams = Object.keys(hexagramCounts).length;
                const totalResults = successCount;
                const hex16Count = hexagramCounts[16] || 0;
                const hex16Percentage = (hex16Count / totalResults * 100).toFixed(1);
                
                // çµ±è¨ˆè¨ˆç®—
                const expectedFreq = totalResults / 64;
                const variance = Object.values(hexagramCounts).reduce((sum, count) => {
                    const diff = count - expectedFreq;
                    return sum + diff * diff;
                }, 0) / uniqueHexagrams;
                const standardDeviation = Math.sqrt(variance);
                
                // çµæœåˆ¤å®š
                displayResult(successCount > 950 ? 'pass' : 'warning',
                    `æˆåŠŸç‡: ${successCount}/1000 (${(successCount/10).toFixed(1)}%), ã‚¨ãƒ©ãƒ¼: ${errorCount}`);
                displayResult(uniqueHexagrams > 30 ? 'pass' : 'fail',
                    `å¤šæ§˜æ€§: ${uniqueHexagrams}ç¨®é¡ã®ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ  (æœŸå¾…å€¤: 64)`);
                displayResult(hex16Percentage < 5 ? 'pass' : 'fail',
                    `ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ 16åã‚Š: ${hex16Count}å› (${hex16Percentage}%, æœŸå¾…å€¤: 1.56%)`);
                displayResult(standardDeviation < expectedFreq * 0.5 ? 'pass' : 'warning',
                    `åˆ†å¸ƒã®æ¨™æº–åå·®: ${standardDeviation.toFixed(2)} (æœŸå¾…å€¤: ${expectedFreq.toFixed(2)})`);
                
                // æœ€ã‚‚åã£ãŸãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ 
                const maxCount = Math.max(...Object.values(hexagramCounts));
                const mostBiased = Object.entries(hexagramCounts)
                    .find(([id, count]) => count === maxCount);
                displayResult(maxCount < totalResults * 0.05 ? 'pass' : 'warning',
                    `æœ€å¤§åã‚Š: ãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ ${mostBiased[0]} ${maxCount}å› (${(maxCount/totalResults*100).toFixed(1)}%)`);
                
                // ä¸Šä½åã‚Šãƒ˜ã‚­ã‚µã‚°ãƒ©ãƒ 
                const topBiased = Object.entries(hexagramCounts)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 5)
                    .map(([id, count]) => `${id}:${count}(${(count/totalResults*100).toFixed(1)}%)`)
                    .join(', ');
                displayResult('info', `ä¸Šä½5åã‚Š: ${topBiased}`);
                
            } catch (error) {
                displayResult('fail', `åã‚Šåˆ†æã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        }

        function displayResult(type, message) {
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `simulation-result ${type}`;
            resultDiv.innerHTML = `<strong>${type.toUpperCase()}:</strong> ${message}`;
            resultsDiv.appendChild(resultDiv);
            
            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        // åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
        window.addEventListener('DOMContentLoaded', async () => {
            displayResult('info', 'ä¿®æ­£åŠ¹æœæ¤œè¨¼ãƒ„ãƒ¼ãƒ«æº–å‚™å®Œäº†');
            
            // DataManagerã®getVectorsDataãƒ¡ã‚½ãƒƒãƒ‰ç¢ºèª
            try {
                const testDataManager = new DataManager();
                const hasMethod = typeof testDataManager.getVectorsData === 'function';
                displayResult(hasMethod ? 'pass' : 'fail', 
                    `getVectorsData()ãƒ¡ã‚½ãƒƒãƒ‰: ${hasMethod ? 'å­˜åœ¨ç¢ºèª' : 'ä¸å­˜åœ¨'}`);
            } catch (error) {
                displayResult('warning', `åˆæœŸç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`);
            }
        });
    </script>
</body>
</html>