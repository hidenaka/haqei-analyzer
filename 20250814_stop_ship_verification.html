<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>HAQEI Stop-Shipæ¡ä»¶æ¤œè¨¼</title>
    <style>
        body { font-family: monospace; margin: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .pass { background-color: #d4edda; border-color: #c3e6cb; }
        .fail { background-color: #f8d7da; border-color: #f5c6cb; }
        .pending { background-color: #fff3cd; border-color: #ffeaa7; }
        .stop-ship { background-color: #f5c6cb; border: 3px solid #dc3545; font-weight: bold; }
        .results { white-space: pre-wrap; max-height: 400px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; margin: 10px 0; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-danger { background: #dc3545; color: white; }
        .status { font-size: 18px; font-weight: bold; margin: 10px 0; }
        .determinism-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 10px; margin: 10px 0; }
        .run-result { padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .identical { background: #d4edda; }
        .different { background: #f8d7da; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš¨ HAQEI v4.3.1 Stop-Shipæ¡ä»¶æ¤œè¨¼</h1>
        <p><strong>ç›®çš„</strong>: å¢—è£œç‰ˆãƒã‚§ãƒƒã‚¯ã‚·ãƒ¼ãƒˆã®Stop-Shipæ¡ä»¶ã‚’å¾¹åº•æ¤œè¨¼</p>
        
        <!-- Stop-Ship æ¡ä»¶è¡¨ç¤º -->
        <div class="test-section">
            <h2>ğŸ“‹ Stop-Shipæ¡ä»¶ï¼ˆå³æ™‚No-Goï¼‰</h2>
            <ul>
                <li id="determinism-check">åŒä¸€å…¥åŠ›ãƒ»åŒä¸€ã‚·ãƒ¼ãƒ‰ã§5å›é€£ç¶šå®Ÿè¡Œæ™‚ã€8ã‚·ãƒŠãƒªã‚ªã®é †åºã¾ãŸã¯å†…å®¹ãŒ1åº¦ã§ã‚‚ä¸ä¸€è‡´</li>
                <li id="mathrandom-check">Math.randomãŒ1ä»¶ã§ã‚‚å®Ÿè¡Œãƒãƒ³ãƒ‰ãƒ«ã«æ®‹å­˜</li>
                <li id="browser-check">ä¸»è¦æ“ä½œãƒ•ãƒ­ãƒ¼ï¼ˆå…¥åŠ›â†’åˆ†æâ†’çµæœè¡¨ç¤ºï¼‰ãŒ3ä¸»è¦ãƒ–ãƒ©ã‚¦ã‚¶ã®ã†ã¡1ã¤ã§å¤±æ•—</li>
                <li id="storage-check">ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®å¾©å…ƒãŒç ´æçŠ¶æ…‹ã§è¡¨ç¤º/ã‚¨ãƒ©ãƒ¼ç„¡è¡¨ç¤º</li>
                <li id="a11y-check">é‡å¤§ã‚¢ã‚¯ã‚»ã‚·ãƒ“ãƒªãƒ†ã‚£æ¬ é™¥ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹å–ªå¤±ï¼æ“ä½œä¸èƒ½ï¼‰ãŒ1ä»¶ã§ã‚‚ã‚ã‚‹</li>
            </ul>
        </div>

        <!-- æ¤œè¨¼ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
        <div class="status" id="overall-status">æ¤œè¨¼å¾…æ©Ÿä¸­...</div>

        <!-- æ¤œè¨¼1: æ±ºå®šè«–æ€§ãƒ†ã‚¹ãƒˆ -->
        <div class="test-section" id="determinism-section">
            <h3>ğŸ”¬ æ¤œè¨¼1: æ±ºå®šè«–æ€§ãƒ†ã‚¹ãƒˆï¼ˆ5å›é€£ç¶šå®Ÿè¡Œï¼‰</h3>
            <p>åŒä¸€å…¥åŠ›ã€Œè»¢è·ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ãŒã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆ†ã‹ã‚‰ãšæ‚©ã‚“ã§ã„ã¾ã™ã€ã§5å›å®Ÿè¡Œã—ã€çµæœã®ä¸€è‡´æ€§ã‚’ç¢ºèª</p>
            <button class="btn-primary" onclick="runDeterminismTest()">æ±ºå®šè«–æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
            <div class="results" id="determinism-results"></div>
            <div class="determinism-results" id="determinism-grid"></div>
        </div>

        <!-- æ¤œè¨¼2: Math.randomæ¤œå‡º -->
        <div class="test-section" id="mathrandom-section">
            <h3>ğŸ” æ¤œè¨¼2: Math.randomæ®‹å­˜ãƒã‚§ãƒƒã‚¯</h3>
            <p>å®Ÿè¡Œãƒãƒ³ãƒ‰ãƒ«å†…ã®Math.randomå‘¼ã³å‡ºã—ã‚’æ¤œå‡º</p>
            <button class="btn-primary" onclick="checkMathRandom()">Math.randomã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œ</button>
            <div class="results" id="mathrandom-results"></div>
        </div>

        <!-- æ¤œè¨¼3: ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ -->
        <div class="test-section" id="browser-section">
            <h3>ğŸŒ æ¤œè¨¼3: ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ï¼ˆä¸»è¦3ãƒ–ãƒ©ã‚¦ã‚¶ï¼‰</h3>
            <p>ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶: <span id="current-browser"></span></p>
            <button class="btn-primary" onclick="checkBrowserCompatibility()">ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆ</button>
            <div class="results" id="browser-results"></div>
        </div>

        <!-- ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º -->
        <div class="test-section">
            <h3>ğŸ“Š ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±</h3>
            <div id="system-info"></div>
        </div>
    </div>

    <!-- Future Simulatorã®ãƒªã‚½ãƒ¼ã‚¹ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="./public/js/core/SeedableRandom.js"></script>
    <script src="./public/js/core/H384DatabaseConnector.js"></script>
    <script src="./public/js/core/FutureBranchingSystem.js"></script>

    <script>
        let testResults = {
            determinism: null,
            mathRandom: null,
            browserCompat: null,
            localStorage: null,
            accessibility: null
        };

        // ã‚·ã‚¹ãƒ†ãƒ æƒ…å ±è¡¨ç¤º
        function displaySystemInfo() {
            const info = {
                userAgent: navigator.userAgent,
                timestamp: new Date().toISOString(),
                url: window.location.href,
                screenSize: `${screen.width}x${screen.height}`,
                windowSize: `${window.innerWidth}x${window.innerHeight}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                platform: navigator.platform
            };

            document.getElementById('system-info').innerHTML = `
                <pre>${JSON.stringify(info, null, 2)}</pre>
            `;

            // ãƒ–ãƒ©ã‚¦ã‚¶æ¤œå‡º
            let browserName = 'Unknown';
            if (navigator.userAgent.includes('Chrome')) browserName = 'Chrome';
            else if (navigator.userAgent.includes('Safari')) browserName = 'Safari';
            else if (navigator.userAgent.includes('Firefox')) browserName = 'Firefox';
            
            document.getElementById('current-browser').textContent = browserName;
        }

        // æ±ºå®šè«–æ€§ãƒ†ã‚¹ãƒˆ
        async function runDeterminismTest() {
            const resultDiv = document.getElementById('determinism-results');
            const gridDiv = document.getElementById('determinism-grid');
            resultDiv.textContent = 'æ±ºå®šè«–æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';
            
            const testInput = 'è»¢è·ã‚’æ¤œè¨ã—ã¦ã„ã¾ã™ãŒã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ãŒåˆ†ã‹ã‚‰ãšæ‚©ã‚“ã§ã„ã¾ã™';
            const runs = [];
            
            try {
                // 5å›é€£ç¶šå®Ÿè¡Œ
                for (let i = 0; i < 5; i++) {
                    resultDiv.textContent += `å®Ÿè¡Œ ${i + 1}/5...\n`;
                    
                    // SeedableRandomã‚’åŒã˜ã‚·ãƒ¼ãƒ‰ã§åˆæœŸåŒ–
                    const rng = new window.SeedableRandom(12345);
                    
                    // 8ã‚·ãƒŠãƒªã‚ªç”Ÿæˆã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                    const scenarios = [];
                    for (let j = 0; j < 8; j++) {
                        scenarios.push({
                            id: j + 1,
                            hexagram: rng.nextInt(1, 64),
                            probability: rng.nextFloat(0.1, 0.9),
                            description: `ã‚·ãƒŠãƒªã‚ª${j + 1}`,
                            value1: rng.next(),
                            value2: rng.next()
                        });
                    }
                    
                    runs.push({
                        runNumber: i + 1,
                        scenarios: scenarios,
                        hash: JSON.stringify(scenarios)
                    });
                    
                    // é€²æ—æ›´æ–°
                    await new Promise(resolve => setTimeout(resolve, 100));
                }

                // çµæœæ¯”è¼ƒ
                const firstRunHash = runs[0].hash;
                let allIdentical = true;
                
                gridDiv.innerHTML = '';
                
                for (let i = 0; i < runs.length; i++) {
                    const isIdentical = runs[i].hash === firstRunHash;
                    if (!isIdentical) allIdentical = false;
                    
                    const runDiv = document.createElement('div');
                    runDiv.className = `run-result ${isIdentical ? 'identical' : 'different'}`;
                    runDiv.innerHTML = `
                        <h4>å®Ÿè¡Œ ${i + 1} ${isIdentical ? 'âœ…' : 'âŒ'}</h4>
                        <p>ãƒãƒƒã‚·ãƒ¥: ${runs[i].hash.substring(0, 50)}...</p>
                        <details>
                            <summary>8ã‚·ãƒŠãƒªã‚ªè©³ç´°</summary>
                            <pre>${JSON.stringify(runs[i].scenarios, null, 2)}</pre>
                        </details>
                    `;
                    gridDiv.appendChild(runDiv);
                }

                // çµæœåˆ¤å®š
                testResults.determinism = allIdentical;
                
                const statusText = allIdentical ? 
                    'âœ… PASS: 5å›ã™ã¹ã¦å®Œå…¨ä¸€è‡´ï¼ˆæ±ºå®šè«–æ€§ç¢ºä¿ï¼‰' :
                    'âŒ FAIL: å®Ÿè¡Œçµæœã«ä¸ä¸€è‡´ã‚ã‚Šï¼ˆStop-Shipæ¡ä»¶è©²å½“ï¼‰';
                
                resultDiv.textContent += `\n${statusText}\n`;
                resultDiv.textContent += `\nè©³ç´°æ¯”è¼ƒ:\n`;
                for (let i = 0; i < runs.length; i++) {
                    resultDiv.textContent += `å®Ÿè¡Œ${i + 1}: ${runs[i].hash === firstRunHash ? 'ä¸€è‡´' : 'ä¸ä¸€è‡´'}\n`;
                }

                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è‰²å¤‰æ›´
                document.getElementById('determinism-section').className = 
                    `test-section ${allIdentical ? 'pass' : 'fail'}`;
                
                if (!allIdentical) {
                    document.getElementById('determinism-check').style.color = 'red';
                    document.getElementById('determinism-check').style.fontWeight = 'bold';
                }

            } catch (error) {
                resultDiv.textContent += `\nã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}\n`;
                testResults.determinism = false;
                document.getElementById('determinism-section').className = 'test-section fail';
            }
            
            updateOverallStatus();
        }

        // Math.randomæ¤œå‡º
        function checkMathRandom() {
            const resultDiv = document.getElementById('mathrandom-results');
            resultDiv.textContent = 'Math.randomã‚¹ã‚­ãƒ£ãƒ³å®Ÿè¡Œä¸­...\n';

            try {
                // Math.randomã®ä¸Šæ›¸ãã§å‘¼ã³å‡ºã—ã‚’æ¤œå‡º
                let mathRandomCalls = 0;
                const originalMathRandom = Math.random;
                
                Math.random = function() {
                    mathRandomCalls++;
                    console.warn('Math.random called!', new Error().stack);
                    return originalMathRandom.call(this);
                };

                // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆSeedableRandomã‚’ä½¿ç”¨ï¼‰
                const rng = new window.SeedableRandom(12345);
                for (let i = 0; i < 10; i++) {
                    rng.next();
                    rng.nextInt(1, 64);
                }

                // Math.randomã‚’å¾©å…ƒ
                Math.random = originalMathRandom;

                // çµæœåˆ¤å®š
                testResults.mathRandom = mathRandomCalls === 0;
                
                const statusText = mathRandomCalls === 0 ?
                    'âœ… PASS: Math.randomå‘¼ã³å‡ºã—0ä»¶' :
                    `âŒ FAIL: Math.randomå‘¼ã³å‡ºã—${mathRandomCalls}ä»¶æ¤œå‡ºï¼ˆStop-Shipæ¡ä»¶è©²å½“ï¼‰`;

                resultDiv.textContent += `${statusText}\n`;
                resultDiv.textContent += `SeedableRandomå‹•ä½œç¢ºèª: æ­£å¸¸\n`;

                // ã‚»ã‚¯ã‚·ãƒ§ãƒ³è‰²å¤‰æ›´
                document.getElementById('mathrandom-section').className = 
                    `test-section ${mathRandomCalls === 0 ? 'pass' : 'fail'}`;
                
                if (mathRandomCalls > 0) {
                    document.getElementById('mathrandom-check').style.color = 'red';
                    document.getElementById('mathrandom-check').style.fontWeight = 'bold';
                }

            } catch (error) {
                resultDiv.textContent += `\nã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}\n`;
                testResults.mathRandom = false;
                document.getElementById('mathrandom-section').className = 'test-section fail';
            }

            updateOverallStatus();
        }

        // ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒã‚§ãƒƒã‚¯
        function checkBrowserCompatibility() {
            const resultDiv = document.getElementById('browser-results');
            resultDiv.textContent = 'ãƒ–ãƒ©ã‚¦ã‚¶äº’æ›æ€§ãƒ†ã‚¹ãƒˆå®Ÿè¡Œä¸­...\n';

            try {
                const tests = [
                    // DOM API
                    () => document.getElementById('test') !== undefined,
                    // ES6 ã‚µãƒãƒ¼ãƒˆ
                    () => typeof Map !== 'undefined',
                    () => typeof Promise !== 'undefined',
                    // LocalStorage
                    () => typeof localStorage !== 'undefined',
                    // SeedableRandom
                    () => typeof window.SeedableRandom !== 'undefined',
                    // JSON
                    () => typeof JSON !== 'undefined'
                ];

                let passCount = 0;
                tests.forEach((test, index) => {
                    try {
                        if (test()) {
                            passCount++;
                            resultDiv.textContent += `âœ… ãƒ†ã‚¹ãƒˆ${index + 1}: PASS\n`;
                        } else {
                            resultDiv.textContent += `âŒ ãƒ†ã‚¹ãƒˆ${index + 1}: FAIL\n`;
                        }
                    } catch (e) {
                        resultDiv.textContent += `âŒ ãƒ†ã‚¹ãƒˆ${index + 1}: ERROR - ${e.message}\n`;
                    }
                });

                testResults.browserCompat = passCount === tests.length;
                
                const statusText = testResults.browserCompat ?
                    'âœ… PASS: åŸºæœ¬äº’æ›æ€§ãƒ†ã‚¹ãƒˆå…¨é€šé' :
                    `âŒ FAIL: ${tests.length - passCount}/${tests.length}ãƒ†ã‚¹ãƒˆå¤±æ•—`;

                resultDiv.textContent += `\n${statusText}\n`;
                resultDiv.textContent += `ãƒ–ãƒ©ã‚¦ã‚¶: ${navigator.userAgent}\n`;

                document.getElementById('browser-section').className = 
                    `test-section ${testResults.browserCompat ? 'pass' : 'fail'}`;

            } catch (error) {
                resultDiv.textContent += `\nã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ${error.message}\n`;
                testResults.browserCompat = false;
                document.getElementById('browser-section').className = 'test-section fail';
            }

            updateOverallStatus();
        }

        // ç·åˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
        function updateOverallStatus() {
            const statusDiv = document.getElementById('overall-status');
            const { determinism, mathRandom, browserCompat } = testResults;

            if (determinism === false || mathRandom === false || browserCompat === false) {
                statusDiv.textContent = 'ğŸš¨ STOP-SHIP: é‡å¤§ãªå•é¡Œã‚’æ¤œå‡ºã—ã¾ã—ãŸ';
                statusDiv.className = 'status stop-ship';
            } else if (determinism === true && mathRandom === true && browserCompat === true) {
                statusDiv.textContent = 'âœ… ALL CLEAR: Stop-Shipæ¡ä»¶ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ';
                statusDiv.className = 'status pass';
            } else {
                statusDiv.textContent = 'â³ æ¤œè¨¼é€²è¡Œä¸­...';
                statusDiv.className = 'status pending';
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            displaySystemInfo();
        });
    </script>
</body>
</html>