<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Analyzer å¶æ•°ç•ªè¨­å•è¡¨ç¤ºãƒã‚° ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1e293b;
            color: #f1f5f9;
            font-family: Inter, sans-serif;
        }
        
        .test-container {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .test-header {
            background: rgba(30, 41, 59, 0.95);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        .test-controls {
            margin: 20px 0;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .test-button {
            padding: 10px 15px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .test-button:hover {
            background: #2563eb;
        }
        
        .debug-info {
            background: rgba(51, 65, 85, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        
        .question-test-area {
            min-height: 400px;
            border: 2px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }
        
        .visible-indicator {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #ef4444;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
            z-index: 1000;
        }
        
        .visible-indicator.visible {
            background: #10b981;
        }

        /* å¼·åˆ¶è¡¨ç¤ºç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .force-visible {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="test-header">
            <h1>ğŸ” OS Analyzer å¶æ•°ç•ªè¨­å•è¡¨ç¤ºãƒã‚°æ¤œè¨¼ãƒ†ã‚¹ãƒˆ</h1>
            <p>å¶æ•°ç•ªè¨­å•ï¼ˆq2, q4, q6ãªã©ï¼‰ã®è¡¨ç¤ºå•é¡Œã‚’è©³ç´°ã«æ¤œè¨¼ã—ã¾ã™ã€‚</p>
        </div>
        
        <div class="test-controls">
            <button class="test-button" onclick="testQuestion('q1')">q1 (å¥‡æ•°) ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testQuestion('q2')">q2 (å¶æ•°) ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testQuestion('q3')">q3 (å¥‡æ•°) ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testQuestion('q4')">q4 (å¶æ•°) ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="testAllQuestions()">å…¨è¨­å•é †æ¬¡ãƒ†ã‚¹ãƒˆ</button>
            <button class="test-button" onclick="clearDebugInfo()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        </div>
        
        <div id="questions-container" class="question-test-area">
            <!-- VirtualQuestionFlow component will render here -->
        </div>
        
        <div id="debug-info" class="debug-info">ãƒ‡ãƒãƒƒã‚°æƒ…å ±ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™...\n</div>
    </div>
    
    <div id="visible-indicator" class="visible-indicator">å¾…æ©Ÿä¸­</div>

    <!-- å¿…é ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆç¾¤ï¼ˆé †åºé‡è¦ï¼‰ -->
    <script src="./public/js/shared/core/BaseComponent.js"></script>
    <script src="./public/js/shared/core/MicroStorageManager.js"></script>
    <script src="./public/js/shared/core/MicroDataManager.js"></script>
    <script src="./public/js/shared/data/questions.js"></script>
    <script src="./public/js/os-analyzer/core/PrecompiledQuestions.js"></script>
    <script src="./public/js/os-analyzer/components/HaqeiQuestionElement.js"></script>
    <script src="./public/js/os-analyzer/components/VirtualQuestionFlow.js"></script>

    <script>
        let virtualFlow = null;
        let currentTestQuestion = null;
        
        // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°é–¢æ•°
        function logDebug(message) {
            const debugDiv = document.getElementById('debug-info');
            const timestamp = new Date().toLocaleTimeString();
            debugDiv.textContent += `[${timestamp}] ${message}\n`;
            debugDiv.scrollTop = debugDiv.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }
        
        function clearDebugInfo() {
            document.getElementById('debug-info').textContent = 'ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†\n';
        }
        
        // è¡¨ç¤ºçŠ¶æ…‹ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°
        function updateVisibilityIndicator(isVisible, questionId) {
            const indicator = document.getElementById('visible-indicator');
            if (isVisible) {
                indicator.textContent = `âœ… ${questionId} è¡¨ç¤ºä¸­`;
                indicator.className = 'visible-indicator visible';
            } else {
                indicator.textContent = `âŒ ${questionId} éè¡¨ç¤º`;
                indicator.className = 'visible-indicator';
            }
        }
        
        // ç‰¹å®šã®è¨­å•ã‚’ãƒ†ã‚¹ãƒˆ
        function testQuestion(questionId) {
            logDebug(`=== ${questionId} ãƒ†ã‚¹ãƒˆé–‹å§‹ ===`);
            currentTestQuestion = questionId;
            
            // æ—¢å­˜ã®ãƒ•ãƒ­ãƒ¼ã‚’å‰Šé™¤
            if (virtualFlow) {
                virtualFlow.cleanup();
            }
            
            // æ–°ã—ã„ãƒ•ãƒ­ãƒ¼ã‚’ä½œæˆ
            virtualFlow = new VirtualQuestionFlow('questions-container', {
                storageManager: new MicroStorageManager(),
                onProgress: (progress) => {
                    logDebug(`Progress: ${progress.toFixed(1)}%`);
                },
                onComplete: (answers) => {
                    logDebug(`Complete: ${answers.length} answers`);
                }
            });
            
            // åˆæœŸåŒ–
            virtualFlow.init();
            
            // ç‰¹å®šã®è¨­å•ã«ã‚¸ãƒ£ãƒ³ãƒ—
            const questionIndex = virtualFlow.questions.findIndex(q => q.id === questionId);
            if (questionIndex >= 0) {
                virtualFlow.currentQuestionIndex = questionIndex;
                virtualFlow.updateVisibleRange();
                
                // è©³ç´°ãªæ¤œè¨¼ã‚’å®Ÿè¡Œ
                setTimeout(() => {
                    validateQuestionDisplay(questionId, questionIndex);
                }, 100);
            } else {
                logDebug(`âŒ Question ${questionId} not found`);
            }
        }
        
        // è¨­å•è¡¨ç¤ºçŠ¶æ…‹ã®è©³ç´°æ¤œè¨¼
        function validateQuestionDisplay(questionId, questionIndex) {
            logDebug(`--- ${questionId} è¡¨ç¤ºçŠ¶æ…‹æ¤œè¨¼ ---`);
            
            // 1. VirtualQuestionFlow ã®çŠ¶æ…‹ç¢ºèª
            logDebug(`Current question index: ${virtualFlow.currentQuestionIndex}`);
            logDebug(`Active elements: ${virtualFlow.activeElements.size}`);
            logDebug(`Visible range: ${virtualFlow.visibleRange.start}-${virtualFlow.visibleRange.end}`);
            
            // 2. DOMè¦ç´ ã®å­˜åœ¨ç¢ºèª
            const viewport = document.querySelector('#questions-container #virtual-viewport');
            if (!viewport) {
                logDebug('âŒ Virtual viewport not found');
                updateVisibilityIndicator(false, questionId);
                return;
            }
            
            logDebug(`Virtual viewport children: ${viewport.children.length}`);
            
            // 3. è©²å½“è¨­å•è¦ç´ ã®ç¢ºèª
            const questionElement = Array.from(viewport.children).find(el => 
                el.dataset.questionId === questionId
            );
            
            if (!questionElement) {
                logDebug(`âŒ Question element ${questionId} not found in DOM`);
                updateVisibilityIndicator(false, questionId);
                return;
            }
            
            logDebug(`âœ… Question element ${questionId} found`);
            
            // 4. ã‚¹ã‚¿ã‚¤ãƒ«çŠ¶æ…‹ã®è©³ç´°ç¢ºèª
            const computedStyle = window.getComputedStyle(questionElement);
            const inlineStyle = questionElement.style;
            
            logDebug(`Computed styles:`);
            logDebug(`  display: ${computedStyle.display}`);
            logDebug(`  opacity: ${computedStyle.opacity}`);
            logDebug(`  visibility: ${computedStyle.visibility}`);
            logDebug(`  position: ${computedStyle.position}`);
            logDebug(`  z-index: ${computedStyle.zIndex}`);
            
            logDebug(`Inline styles:`);
            logDebug(`  display: ${inlineStyle.display}`);
            logDebug(`  opacity: ${inlineStyle.opacity}`);
            logDebug(`  visibility: ${inlineStyle.visibility}`);
            
            // 5. ã‚¯ãƒ©ã‚¹çŠ¶æ…‹ç¢ºèª
            logDebug(`Classes: ${questionElement.className}`);
            logDebug(`Has active-question class: ${questionElement.classList.contains('active-question')}`);
            
            // 6. è¦ç´ ã®ã‚µã‚¤ã‚ºã¨ä½ç½®ç¢ºèª
            const rect = questionElement.getBoundingClientRect();
            logDebug(`Dimensions: ${rect.width}x${rect.height}`);
            logDebug(`Position: (${rect.x}, ${rect.y})`);
            logDebug(`Is in viewport: ${rect.width > 0 && rect.height > 0}`);
            
            // 7. Shadow DOM ç¢ºèª
            if (questionElement.shadowRoot) {
                const shadowContent = questionElement.shadowRoot.querySelector('.question-container');
                if (shadowContent) {
                    const shadowStyle = window.getComputedStyle(shadowContent);
                    logDebug(`Shadow DOM content display: ${shadowStyle.display}`);
                    logDebug(`Shadow DOM content opacity: ${shadowStyle.opacity}`);
                } else {
                    logDebug('âŒ Shadow DOM content not found');
                }
            } else {
                logDebug('âŒ No shadow root found');
            }
            
            // 8. è¦ªè¦ç´ ã®ç¢ºèª
            const parent = questionElement.parentElement;
            if (parent) {
                const parentStyle = window.getComputedStyle(parent);
                logDebug(`Parent display: ${parentStyle.display}`);
                logDebug(`Parent opacity: ${parentStyle.opacity}`);
            }
            
            // 9. å¶æ•°/å¥‡æ•°åˆ¤å®š
            const questionNum = parseInt(questionId.replace('q', ''));
            const isEven = questionNum % 2 === 0;
            logDebug(`Question number: ${questionNum} (${isEven ? 'å¶æ•°' : 'å¥‡æ•°'})`);
            
            // 10. æœ€çµ‚çš„ãªè¡¨ç¤ºåˆ¤å®š
            const isVisible = computedStyle.display !== 'none' && 
                             computedStyle.opacity !== '0' && 
                             computedStyle.visibility !== 'hidden' &&
                             rect.width > 0 && rect.height > 0;
            
            logDebug(`Final visibility determination: ${isVisible ? 'âœ… VISIBLE' : 'âŒ HIDDEN'}`);
            updateVisibilityIndicator(isVisible, questionId);
            
            // 11. å¶æ•°ç•ªã§éè¡¨ç¤ºã®å ´åˆã€å¼·åˆ¶è¡¨ç¤ºã‚’è©¦è¡Œ
            if (isEven && !isVisible) {
                logDebug('ğŸ”§ å¶æ•°ç•ªè¨­å•ãŒéè¡¨ç¤º - å¼·åˆ¶è¡¨ç¤ºã‚’è©¦è¡Œ');
                attemptForceDisplay(questionElement, questionId);
            }
            
            logDebug(`--- ${questionId} æ¤œè¨¼å®Œäº† ---\n`);
        }
        
        // å¼·åˆ¶è¡¨ç¤ºã®è©¦è¡Œ
        function attemptForceDisplay(element, questionId) {
            logDebug('å¼·åˆ¶è¡¨ç¤ºå‡¦ç†é–‹å§‹...');
            
            // 1. ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«ã‚’ãƒªã‚»ãƒƒãƒˆ
            element.removeAttribute('style');
            
            // 2. å¼·åˆ¶è¡¨ç¤ºã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
            element.classList.add('force-visible');
            
            // 3. ç›´æ¥ã‚¹ã‚¿ã‚¤ãƒ«è¨­å®š
            element.style.setProperty('display', 'block', 'important');
            element.style.setProperty('opacity', '1', 'important');
            element.style.setProperty('visibility', 'visible', 'important');
            
            // 4. Shadow DOM ã‚‚å¼·åˆ¶è¡¨ç¤º
            if (element.shadowRoot) {
                const shadowContent = element.shadowRoot.querySelector('.question-container');
                if (shadowContent) {
                    shadowContent.style.setProperty('display', 'block', 'important');
                    shadowContent.style.setProperty('opacity', '1', 'important');
                    shadowContent.style.setProperty('visibility', 'visible', 'important');
                }
            }
            
            // 5. å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰å†æ¤œè¨¼
            setTimeout(() => {
                const newStyle = window.getComputedStyle(element);
                const newRect = element.getBoundingClientRect();
                const nowVisible = newStyle.display !== 'none' && 
                                 newStyle.opacity !== '0' && 
                                 newRect.width > 0 && newRect.height > 0;
                
                logDebug(`å¼·åˆ¶è¡¨ç¤ºå¾Œã®çŠ¶æ…‹: ${nowVisible ? 'âœ… SUCCESS' : 'âŒ FAILED'}`);
                if (nowVisible) {
                    logDebug(`New display: ${newStyle.display}, opacity: ${newStyle.opacity}`);
                    logDebug(`New dimensions: ${newRect.width}x${newRect.height}`);
                    updateVisibilityIndicator(true, questionId);
                }
            }, 50);
        }
        
        // å…¨è¨­å•ã‚’é †æ¬¡ãƒ†ã‚¹ãƒˆ
        function testAllQuestions() {
            logDebug('=== å…¨è¨­å•é †æ¬¡ãƒ†ã‚¹ãƒˆé–‹å§‹ ===');
            
            if (!window.WORLDVIEW_QUESTIONS || !window.SCENARIO_QUESTIONS) {
                logDebug('âŒ Question data not loaded');
                return;
            }
            
            const allQuestions = [...WORLDVIEW_QUESTIONS, ...SCENARIO_QUESTIONS];
            let currentIndex = 0;
            
            function testNext() {
                if (currentIndex >= allQuestions.length) {
                    logDebug('=== å…¨è¨­å•ãƒ†ã‚¹ãƒˆå®Œäº† ===');
                    return;
                }
                
                const question = allQuestions[currentIndex];
                testQuestion(question.id);
                
                setTimeout(() => {
                    currentIndex++;
                    testNext();
                }, 2000); // 2ç§’é–“éš”ã§ãƒ†ã‚¹ãƒˆ
            }
            
            testNext();
        }
        
        // åˆæœŸåŒ–
        window.addEventListener('load', () => {
            logDebug('ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–å®Œäº†');
            logDebug('åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ:');
            logDebug(`- BaseComponent: ${typeof BaseComponent !== 'undefined'}`);
            logDebug(`- MicroStorageManager: ${typeof MicroStorageManager !== 'undefined'}`);
            logDebug(`- VirtualQuestionFlow: ${typeof VirtualQuestionFlow !== 'undefined'}`);
            logDebug(`- HaqeiQuestionElement: ${typeof HaqeiQuestionElement !== 'undefined'}`);
            logDebug(`- WORLDVIEW_QUESTIONS: ${typeof WORLDVIEW_QUESTIONS !== 'undefined'}`);
            logDebug(`- SCENARIO_QUESTIONS: ${typeof SCENARIO_QUESTIONS !== 'undefined'}`);
            
            if (typeof WORLDVIEW_QUESTIONS !== 'undefined' && typeof SCENARIO_QUESTIONS !== 'undefined') {
                const totalQuestions = WORLDVIEW_QUESTIONS.length + SCENARIO_QUESTIONS.length;
                logDebug(`èª­ã¿è¾¼ã¿æ¸ˆã¿è¨­å•æ•°: ${totalQuestions}`);
                
                // å¶æ•°ç•ªè¨­å•ã®ä¸€è¦§ã‚’è¡¨ç¤º
                const allQuestions = [...WORLDVIEW_QUESTIONS, ...SCENARIO_QUESTIONS];
                const evenQuestions = allQuestions.filter(q => {
                    const num = parseInt(q.id.replace('q', ''));
                    return num % 2 === 0;
                });
                logDebug(`å¶æ•°ç•ªè¨­å•: ${evenQuestions.map(q => q.id).join(', ')}`);
            }
            
            logDebug('ãƒ†ã‚¹ãƒˆé–‹å§‹ã®æº–å‚™å®Œäº†ã€‚ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦æ¤œè¨¼ã‚’é–‹å§‹ã—ã¦ãã ã•ã„ã€‚');
        });
    </script>
</body>
</html>