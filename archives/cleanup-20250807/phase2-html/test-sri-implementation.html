<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRI Implementation Test - HAQEI Analyzer</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .resource-test {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        pre {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        h1, h2 {
            color: #333;
        }
        .hash-verification {
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
        }
    </style>
</head>
<body>
    <h1>üîí SRI (Subresource Integrity) Implementation Test</h1>
    <p>Testing all external resources for proper SRI implementation and security hardening.</p>

    <div class="test-container">
        <h2>üìä External Resources Analysis</h2>
        <div id="resources-analysis"></div>
    </div>

    <div class="test-container">
        <h2>üîê SRI Hash Verification</h2>
        <div id="sri-verification"></div>
    </div>

    <div class="test-container">
        <h2>‚ö° Resource Loading Test</h2>
        <div id="loading-test"></div>
    </div>

    <div class="test-container">
        <h2>üõ°Ô∏è Security Headers Analysis</h2>
        <div id="security-analysis"></div>
    </div>

    <!-- Test Resources with SRI -->
    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap"
        rel="stylesheet"
        integrity="sha384-2LfpDLvAHm4a9RYruJICmRn+ef67nc2WnlOOMbE2SzvQWkbVx2MysR9fXUVlojfI"
        crossorigin="anonymous"
        onload="reportResourceLoad('Google Fonts', true)"
        onerror="reportResourceLoad('Google Fonts', false)"
    />

    <!-- Chart.js -->
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" 
        integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"
        onload="reportResourceLoad('Chart.js', true)"
        onerror="reportResourceLoad('Chart.js', false)"
    ></script>

    <!-- DOMPurify -->
    <script 
        src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js" 
        integrity="sha512-H+rglffZ6f5gF7UJgvH4Naa+fGCgjrHKMgoFOGmcPTRwR6oILo5R+gtzNrpDp7iMV3udbymBVjkeZGNz1Em4rQ==" 
        crossorigin="anonymous" 
        referrerpolicy="no-referrer"
        onload="reportResourceLoad('DOMPurify', true)"
        onerror="reportResourceLoad('DOMPurify', false)"
    ></script>

    <script>
        // Test results storage
        const testResults = {
            resources: [],
            loadResults: {},
            securityFeatures: {}
        };

        // Resource loading reporter
        function reportResourceLoad(resourceName, success) {
            testResults.loadResults[resourceName] = success;
            updateLoadingTest();
        }

        // External resources configuration
        const externalResources = [
            {
                name: 'Google Fonts CSS',
                url: 'https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Shippori+Mincho:wght@400;500;600;700&display=swap',
                type: 'stylesheet',
                expectedHash: 'sha384-2LfpDLvAHm4a9RYruJICmRn+ef67nc2WnlOOMbE2SzvQWkbVx2MysR9fXUVlojfI',
                hasCrossorigin: true,
                hasReferrerPolicy: false
            },
            {
                name: 'Chart.js',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js',
                type: 'script',
                expectedHash: 'sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==',
                hasCrossorigin: true,
                hasReferrerPolicy: true
            },
            {
                name: 'DOMPurify',
                url: 'https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js',
                type: 'script',
                expectedHash: 'sha512-H+rglffZ6f5gF7UJgvH4Naa+fGCgjrHKMgoFOGmcPTRwR6oILo5R+gtzNrpDp7iMV3udbymBVjkeZGNz1Em4rQ==',
                hasCrossorigin: true,
                hasReferrerPolicy: true
            }
        ];

        // Initialize tests
        document.addEventListener('DOMContentLoaded', function() {
            runResourcesAnalysis();
            runSRIVerification();
            runSecurityAnalysis();
            
            // Set timeout to check loading results
            setTimeout(() => {
                updateLoadingTest();
                generateFinalReport();
            }, 3000);
        });

        function runResourcesAnalysis() {
            const container = document.getElementById('resources-analysis');
            let html = '<h3>External Resources Found:</h3>';
            
            externalResources.forEach(resource => {
                const hashType = resource.expectedHash.split('-')[0];
                html += `
                    <div class="resource-test">
                        <strong>${resource.name}</strong><br>
                        <small>URL: ${resource.url}</small><br>
                        <div class="status info">
                            ‚úì Type: ${resource.type}<br>
                            ‚úì Hash Algorithm: ${hashType}<br>
                            ‚úì Crossorigin: ${resource.hasCrossorigin ? 'Yes' : 'No'}<br>
                            ‚úì Referrer Policy: ${resource.hasReferrerPolicy ? 'Yes' : 'N/A'}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function runSRIVerification() {
            const container = document.getElementById('sri-verification');
            let html = '<h3>SRI Hash Verification:</h3>';
            
            externalResources.forEach(resource => {
                html += `
                    <div class="resource-test">
                        <strong>${resource.name}</strong><br>
                        <div class="status success">
                            ‚úì SRI Hash Present: ${resource.expectedHash}
                        </div>
                        <div class="hash-verification">
                            Expected: ${resource.expectedHash}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function updateLoadingTest() {
            const container = document.getElementById('loading-test');
            let html = '<h3>Resource Loading Results:</h3>';
            
            externalResources.forEach(resource => {
                const loadStatus = testResults.loadResults[resource.name];
                const statusClass = loadStatus === true ? 'success' : 
                                   loadStatus === false ? 'error' : 'warning';
                const statusText = loadStatus === true ? '‚úì Loaded Successfully' :
                                  loadStatus === false ? '‚úó Failed to Load' : '‚è≥ Loading...';
                
                html += `
                    <div class="resource-test">
                        <strong>${resource.name}</strong><br>
                        <div class="status ${statusClass}">
                            ${statusText}
                        </div>
                    </div>
                `;
            });
            
            // Test library availability
            html += '<h4>Library Availability Check:</h4>';
            html += `
                <div class="status ${typeof Chart !== 'undefined' ? 'success' : 'error'}">
                    Chart.js: ${typeof Chart !== 'undefined' ? '‚úì Available' : '‚úó Not Available'}
                </div>
                <div class="status ${typeof DOMPurify !== 'undefined' ? 'success' : 'error'}">
                    DOMPurify: ${typeof DOMPurify !== 'undefined' ? '‚úì Available' : '‚úó Not Available'}
                </div>
                <div class="status ${document.fonts && document.fonts.check('1em Inter') ? 'success' : 'warning'}">
                    Inter Font: ${document.fonts && document.fonts.check('1em Inter') ? '‚úì Loaded' : '? Loading/Unknown'}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function runSecurityAnalysis() {
            const container = document.getElementById('security-analysis');
            let html = '<h3>Security Features Analysis:</h3>';
            
            // Check CSP
            const metaTags = document.querySelectorAll('meta[http-equiv="Content-Security-Policy"]');
            html += `
                <div class="status ${metaTags.length > 0 ? 'success' : 'warning'}">
                    Content Security Policy: ${metaTags.length > 0 ? '‚úì Configured' : '‚ö† Not Found'}
                </div>
            `;
            
            // Check other security headers
            const xContentType = document.querySelectorAll('meta[http-equiv="X-Content-Type-Options"]');
            const xFrameOptions = document.querySelectorAll('meta[http-equiv="X-Frame-Options"]');
            
            html += `
                <div class="status ${xContentType.length > 0 ? 'success' : 'warning'}">
                    X-Content-Type-Options: ${xContentType.length > 0 ? '‚úì nosniff' : '‚ö† Not Set'}
                </div>
                <div class="status ${xFrameOptions.length > 0 ? 'success' : 'warning'}">
                    X-Frame-Options: ${xFrameOptions.length > 0 ? '‚úì SAMEORIGIN' : '‚ö† Not Set'}
                </div>
            `;
            
            // Check HTTPS usage
            const isHTTPS = location.protocol === 'https:';
            html += `
                <div class="status ${isHTTPS ? 'success' : 'error'}">
                    HTTPS: ${isHTTPS ? '‚úì Secure Connection' : '‚úó Insecure Connection'}
                </div>
            `;
            
            container.innerHTML = html;
        }

        function generateFinalReport() {
            const loadedCount = Object.values(testResults.loadResults).filter(result => result === true).length;
            const totalCount = externalResources.length;
            
            console.log('üîí SRI Implementation Test Results:');
            console.log('===================================');
            console.log(`External Resources: ${totalCount}`);
            console.log(`Successfully Loaded: ${loadedCount}`);
            console.log(`SRI Protection: ${totalCount}/${totalCount} (100%)`);
            console.log(`Libraries Available:`);
            console.log(`- Chart.js: ${typeof Chart !== 'undefined' ? 'Yes' : 'No'}`);
            console.log(`- DOMPurify: ${typeof DOMPurify !== 'undefined' ? 'Yes' : 'No'}`);
            console.log('===================================');
            
            if (loadedCount === totalCount) {
                console.log('‚úÖ All external resources loaded successfully with SRI protection!');
            } else {
                console.log('‚ö†Ô∏è Some resources failed to load. Check network or integrity hashes.');
            }
        }

        // Test Chart.js functionality
        function testChartJS() {
            if (typeof Chart !== 'undefined') {
                console.log('‚úÖ Chart.js is available and ready to use');
                console.log('Chart.js version:', Chart.version);
                return true;
            } else {
                console.log('‚ùå Chart.js is not available');
                return false;
            }
        }

        // Test DOMPurify functionality
        function testDOMPurify() {
            if (typeof DOMPurify !== 'undefined') {
                const testHTML = '<script>alert("test")</script><p>Safe content</p>';
                const sanitized = DOMPurify.sanitize(testHTML);
                console.log('‚úÖ DOMPurify is working correctly');
                console.log('Test sanitization:', sanitized);
                return true;
            } else {
                console.log('‚ùå DOMPurify is not available');
                return false;
            }
        }

        // Global test function
        window.runSRITests = function() {
            console.log('üß™ Running SRI Implementation Tests...');
            console.log('Chart.js Test:', testChartJS());
            console.log('DOMPurify Test:', testDOMPurify());
            generateFinalReport();
        };
    </script>
</body>
</html>