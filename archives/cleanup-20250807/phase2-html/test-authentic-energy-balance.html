<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Authentic Energy Balance Test - ユーザー指摘事例検証</title>
    <style>
        body { font-family: 'Noto Sans JP', sans-serif; margin: 20px; background: #f8fafc; }
        .container { max-width: 1200px; margin: 0 auto; }
        .test-section { background: white; margin: 20px 0; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .energy-input { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 15px 0; }
        .energy-item { text-align: center; }
        .energy-item label { display: block; margin-bottom: 5px; font-weight: bold; }
        .energy-item input { width: 80px; padding: 8px; text-align: center; border: 2px solid #e2e8f0; border-radius: 4px; }
        .high-energy { background: #fef5e7; border-color: #f59e0b !important; }
        .test-button { background: #6366f1; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; margin: 10px 5px; }
        .test-button:hover { background: #5855eb; }
        .results { margin-top: 20px; }
        .result-card { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; padding: 15px; margin: 10px 0; }
        .legacy-result { border-color: #ef4444; background: #fef2f2; }
        .improved-result { border-color: #10b981; background: #f0fdf4; }
        .comparison { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .score { font-size: 18px; font-weight: bold; color: #374151; }
        .highlight { background: #fbbf24; color: #92400e; padding: 2px 6px; border-radius: 3px; }
        code { background: #f1f5f9; padding: 2px 6px; border-radius: 3px; font-family: 'Courier New', monospace; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🌟 Authentic I-Ching Energy Balance Test</h1>
        <p><strong>目的:</strong> ユーザー指摘「巽エネルギー85高値→巽含有卦選択」問題の解決検証</p>
        
        <div class="test-section">
            <h2>📊 エネルギー分布設定</h2>
            <p>ユーザー指摘事例をベースに、巽エネルギーが高値の場合をテスト</p>
            
            <div class="energy-input">
                <div class="energy-item">
                    <label>乾 (創造)</label>
                    <input type="number" id="qian" value="45" min="0" max="100">
                </div>
                <div class="energy-item">
                    <label>兌 (調和)</label>
                    <input type="number" id="dui" value="30" min="0" max="100">
                </div>
                <div class="energy-item">
                    <label>離 (表現)</label>
                    <input type="number" id="li" value="25" min="0" max="100">
                </div>
                <div class="energy-item">
                    <label>震 (行動)</label>
                    <input type="number" id="zhen" value="35" min="0" max="100">
                </div>
                <div class="energy-item">
                    <label>巽 (適応)</label>
                    <input type="number" id="xun" value="85" min="0" max="100" class="high-energy">
                </div>
                <div class="energy-item">
                    <label>坎 (探求)</label>
                    <input type="number" id="kan" value="40" min="0" max="100">
                </div>
                <div class="energy-item">
                    <label>艮 (安定)</label>
                    <input type="number" id="gen" value="20" min="0" max="100">
                </div>
                <div class="energy-item">
                    <label>坤 (受容)</label>
                    <input type="number" id="kun" value="50" min="0" max="100">
                </div>
            </div>
            
            <button class="test-button" onclick="runComparison()">🔍 従来式 vs 改善式 比較テスト</button>
            <button class="test-button" onclick="runTripleOSTest()">🔯 Triple OS 総合テスト</button>
            <button class="test-button" onclick="resetToUserCase()">🔄 ユーザー事例にリセット</button>
        </div>
        
        <div id="results" class="results"></div>
    </div>

    <!-- 必要なスクリプト読み込み -->
    <script src="/assets/H384H64database.js"></script>
    <script src="/js/core/AuthenticEnergyBalanceEngine.js"></script>

    <script>
        // グローバル変数
        let authenticEngine;
        
        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            try {
                authenticEngine = new AuthenticEnergyBalanceEngine();
                console.log('✅ AuthenticEnergyBalanceEngine initialized for testing');
            } catch (error) {
                console.error('❌ Failed to initialize AuthenticEnergyBalanceEngine:', error);
                document.getElementById('results').innerHTML = `
                    <div class="result-card legacy-result">
                        <h3>❌ 初期化エラー</h3>
                        <p>AuthenticEnergyBalanceEngineの初期化に失敗しました: ${error.message}</p>
                    </div>
                `;
            }
        });

        // エネルギー値取得
        function getEnergyValues() {
            return {
                '乾': parseInt(document.getElementById('qian').value) || 0,
                '兌': parseInt(document.getElementById('dui').value) || 0,
                '離': parseInt(document.getElementById('li').value) || 0,
                '震': parseInt(document.getElementById('zhen').value) || 0,
                '巽': parseInt(document.getElementById('xun').value) || 0,
                '坎': parseInt(document.getElementById('kan').value) || 0,
                '艮': parseInt(document.getElementById('gen').value) || 0,
                '坤': parseInt(document.getElementById('kun').value) || 0
            };
        }
        
        // 従来式シミュレーション
        function simulateLegacyMethod(energies) {
            const sortedTrigrams = Object.entries(energies).sort(([, a], [, b]) => b - a);
            const upperTrigram = sortedTrigrams[0][0];
            const lowerTrigram = sortedTrigrams[1][0];
            
            // 簡易的な64卦マッピング（実際の実装に準拠）
            const trigramToNumber = {
                "乾": 1, "兌": 2, "離": 3, "震": 4,
                "巽": 5, "坎": 6, "艮": 7, "坤": 8
            };
            
            const authenticHexagramMatrix = [
                [1, 43, 14, 34, 9, 5, 26, 11],   // 乾上
                [58, 60, 38, 54, 61, 59, 28, 19], // 兌上
                [50, 64, 56, 62, 55, 63, 35, 8],  // 離上
                [51, 16, 40, 32, 46, 48, 18, 7],  // 震上
                [57, 20, 53, 42, 37, 45, 22, 36], // 巽上
                [6, 29, 4, 7, 59, 60, 3, 2],      // 坎上
                [33, 52, 39, 15, 53, 56, 31, 12], // 艮上
                [2, 47, 4, 7, 46, 29, 27, 24]     // 坤上
            ];
            
            const upper = trigramToNumber[upperTrigram] || 1;
            const lower = trigramToNumber[lowerTrigram] || 1;
            const hexagramId = authenticHexagramMatrix[upper - 1][lower - 1];
            
            // HEXAGRAMSから名前取得
            const hexagramName = window.HEXAGRAMS ? 
                (window.HEXAGRAMS.find(h => h.hexagram_id === hexagramId) || {}).name_jp || `卦${hexagramId}` :
                `卦${hexagramId}`;
            
            return {
                method: 'legacy_highest_two',
                upperTrigram,
                lowerTrigram,
                hexagramId,
                hexagramName,
                energyUtilization: ((energies[upperTrigram] + energies[lowerTrigram]) / Object.values(energies).reduce((a,b) => a+b, 0) * 100).toFixed(1),
                problem: energies['巽'] >= 80 && !hexagramName.includes('巽') && upperTrigram !== '巽' && lowerTrigram !== '巽'
            };
        }
        
        // 比較テスト実行
        function runComparison() {
            const energies = getEnergyValues();
            console.log('🔍 Running comparison test with energies:', energies);
            
            try {
                // 1. 従来式結果
                const legacyResult = simulateLegacyMethod(energies);
                
                // 2. 改善式結果（Engine OS用）
                const improvedResult = authenticEngine.selectOptimalHexagramByEnergyBalance(energies, 'Engine OS');
                
                // 3. 結果表示
                displayComparison(legacyResult, improvedResult, energies);
                
            } catch (error) {
                console.error('❌ Comparison test error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="result-card legacy-result">
                        <h3>❌ テストエラー</h3>
                        <p>比較テストの実行中にエラーが発生しました: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // 比較結果表示
        function displayComparison(legacy, improved, energies) {
            const xunsun = energies['巽'];
            const isHighXun = xunsun >= 80;
            
            const html = `
                <div class="test-section">
                    <h2>🔬 比較テスト結果</h2>
                    <div class="comparison">
                        <div class="result-card legacy-result">
                            <h3>❌ 従来式（問題のある方式）</h3>
                            <p><strong>手法:</strong> 最高値2三爻の単純選択</p>
                            <p><strong>選択:</strong> ${legacy.upperTrigram}(上) + ${legacy.lowerTrigram}(下)</p>
                            <p><strong>64卦:</strong> ${legacy.hexagramId}番 ${legacy.hexagramName}</p>
                            <p><strong>エネルギー活用度:</strong> ${legacy.energyUtilization}%</p>
                            ${legacy.problem ? '<p class="highlight">⚠️ 問題: 巽85高値なのに巽を含まない卦が選択</p>' : ''}
                        </div>
                        
                        <div class="result-card improved-result">
                            <h3>✅ 改善式（全体調和重視）</h3>
                            <p><strong>手法:</strong> 5次元調和度による64卦全評価</p>
                            <p><strong>選択:</strong> ${improved.upperTrigram}(上) + ${improved.lowerTrigram}(下)</p>
                            <p><strong>64卦:</strong> ${improved.hexagramId}番 ${improved.hexagramName}</p>
                            <div class="score">調和度: ${improved.harmonyScore.toFixed(1)}/100</div>
                            <p><strong>エネルギー活用度:</strong> ${improved.energyUtilization.toFixed(1)}%</p>
                            <p><strong>OS適合度:</strong> ${improved.osCompatibility.toFixed(1)}%</p>
                            ${isHighXun && (improved.upperTrigram === '巽' || improved.lowerTrigram === '巽') ? 
                                '<p class="highlight">✅ 改善: 巽高値エネルギーが適切に活用されました</p>' : ''}
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <h3>📊 エネルギー分布分析</h3>
                        <p><strong>入力エネルギー:</strong></p>
                        <code>${JSON.stringify(energies, null, 2)}</code>
                        
                        <h4>🔍 ユーザー指摘問題の検証結果:</h4>
                        <p><strong>巽エネルギー値:</strong> ${xunsun} ${isHighXun ? '(高値 ✅)' : '(低値)'}</p>
                        <p><strong>従来式での巽活用:</strong> ${legacy.upperTrigram === '巽' || legacy.lowerTrigram === '巽' ? 'あり ✅' : 'なし ❌'}</p>
                        <p><strong>改善式での巽活用:</strong> ${improved.upperTrigram === '巽' || improved.lowerTrigram === '巽' ? 'あり ✅' : 'なし'}</p>
                        
                        ${improved.improvementRecommendations && improved.improvementRecommendations.length > 0 ? `
                            <h4>💡 改善提案:</h4>
                            ${improved.improvementRecommendations.map(rec => `<p>• ${rec.suggestion}</p>`).join('')}
                        ` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('results').innerHTML = html;
        }
        
        // Triple OSテスト
        function runTripleOSTest() {
            const energies = getEnergyValues();
            console.log('🔯 Running Triple OS test with energies:', energies);
            
            try {
                const engineResult = authenticEngine.selectOptimalHexagramByEnergyBalance(energies, 'Engine OS');
                const interfaceResult = authenticEngine.selectOptimalHexagramByEnergyBalance(energies, 'Interface OS');
                const safeModeResult = authenticEngine.selectOptimalHexagramByEnergyBalance(energies, 'Safe Mode OS');
                
                const html = `
                    <div class="test-section">
                        <h2>🔯 Triple OS 総合テスト結果</h2>
                        
                        <div class="result-card improved-result">
                            <h3>🔥 Engine OS (内的価値観システム)</h3>
                            <p><strong>64卦:</strong> ${engineResult.hexagramId}番 ${engineResult.hexagramName}</p>
                            <p><strong>構成:</strong> ${engineResult.upperTrigram}(上) + ${engineResult.lowerTrigram}(下)</p>
                            <div class="score">調和度: ${engineResult.harmonyScore.toFixed(1)}/100</div>
                            <p><strong>特徴:</strong> 創造-安定重視型、内的一貫性を重視</p>
                        </div>
                        
                        <div class="result-card improved-result">
                            <h3>🌐 Interface OS (社会的システム)</h3>
                            <p><strong>64卦:</strong> ${interfaceResult.hexagramId}番 ${interfaceResult.hexagramName}</p>
                            <p><strong>構成:</strong> ${interfaceResult.upperTrigram}(上) + ${interfaceResult.lowerTrigram}(下)</p>
                            <div class="score">調和度: ${interfaceResult.harmonyScore.toFixed(1)}/100</div>
                            <p><strong>特徴:</strong> 調和-表現重視型、社会適応性を重視</p>
                        </div>
                        
                        <div class="result-card improved-result">
                            <h3>🛡️ Safe Mode OS (防御システム)</h3>
                            <p><strong>64卦:</strong> ${safeModeResult.hexagramId}番 ${safeModeResult.hexagramName}</p>
                            <p><strong>構成:</strong> ${safeModeResult.upperTrigram}(上) + ${safeModeResult.lowerTrigram}(下)</p>
                            <div class="score">調和度: ${safeModeResult.harmonyScore.toFixed(1)}/100</div>
                            <p><strong>特徴:</strong> 安定-受容重視型、防護的安定性を重視</p>
                        </div>
                        
                        <div class="result-card">
                            <h3>📈 Triple OS 比較分析</h3>
                            <p><strong>最高調和度:</strong> ${Math.max(engineResult.harmonyScore, interfaceResult.harmonyScore, safeModeResult.harmonyScore).toFixed(1)} 
                               (${engineResult.harmonyScore >= interfaceResult.harmonyScore && engineResult.harmonyScore >= safeModeResult.harmonyScore ? 'Engine OS' :
                                 interfaceResult.harmonyScore >= safeModeResult.harmonyScore ? 'Interface OS' : 'Safe Mode OS'})</p>
                            <p><strong>平均調和度:</strong> ${((engineResult.harmonyScore + interfaceResult.harmonyScore + safeModeResult.harmonyScore) / 3).toFixed(1)}/100</p>
                            <p><strong>全OS巽活用:</strong> 
                               ${[engineResult, interfaceResult, safeModeResult].filter(r => r.upperTrigram === '巽' || r.lowerTrigram === '巽').length}/3 OS</p>
                        </div>
                    </div>
                `;
                
                document.getElementById('results').innerHTML = html;
                
            } catch (error) {
                console.error('❌ Triple OS test error:', error);
                document.getElementById('results').innerHTML = `
                    <div class="result-card legacy-result">
                        <h3>❌ Triple OS テストエラー</h3>
                        <p>テストの実行中にエラーが発生しました: ${error.message}</p>
                    </div>
                `;
            }
        }
        
        // ユーザー事例リセット
        function resetToUserCase() {
            document.getElementById('qian').value = '45';
            document.getElementById('dui').value = '30';
            document.getElementById('li').value = '25';
            document.getElementById('zhen').value = '35';
            document.getElementById('xun').value = '85';
            document.getElementById('kan').value = '40';
            document.getElementById('gen').value = '20';
            document.getElementById('kun').value = '50';
            
            // 巽を強調
            document.getElementById('xun').focus();
        }
    </script>
</body>
</html>