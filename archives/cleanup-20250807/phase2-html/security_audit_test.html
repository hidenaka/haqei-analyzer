<\!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI Security Audit Test</title>
    <style>
        body { font-family: 'Courier New', monospace; background: #0a0a0a; color: #00ff00; margin: 20px; }
        .test-section { border: 1px solid #333; margin: 20px 0; padding: 15px; background: #111; }
        .pass { color: #00ff00; }
        .fail { color: #ff0000; }
        .warn { color: #ffff00; }
        .info { color: #00aaff; }
        pre { background: #222; padding: 10px; overflow: auto; white-space: pre-wrap; }
        button { background: #333; color: #fff; border: 1px solid #555; padding: 10px; margin: 5px; cursor: pointer; }
        button:hover { background: #555; }
        input { background: #222; color: #fff; border: 1px solid #555; padding: 5px; margin: 5px; }
        #results { max-height: 400px; overflow-y: auto; background: #000; padding: 10px; border: 1px solid #333; }
    </style>
</head>
<body>
    <h1>🔒 HAQEI Security Audit Dashboard</h1>
    
    <div class="test-section">
        <h2>🎯 Target URL</h2>
        <input type="text" id="targetUrl" value="http://localhost:8000/public/os_analyzer.html" style="width: 400px;">
        <button onclick="updateTarget()">Update Target</button>
    </div>

    <div class="test-section">
        <h2>🧪 Security Test Suite</h2>
        <button onclick="runAllTests()">🚀 Run All Security Tests</button>
        <button onclick="testXSS()">🕷️ XSS Vulnerability Test</button>
        <button onclick="testCSRF()">🛡️ CSRF Protection Test</button>
        <button onclick="testHeaders()">📋 Security Headers Test</button>
        <button onclick="testDOM()">🏗️ DOM Security Test</button>
        <button onclick="testInputValidation()">✅ Input Validation Test</button>
        <button onclick="testNetwork()">🌐 Network Security Test</button>
        <button onclick="clearResults()">🧹 Clear Results</button>
    </div>

    <div class="test-section">
        <h2>📊 Test Results</h2>
        <div id="results"></div>
    </div>

    <script>
        let targetUrl = "http://localhost:8000/public/os_analyzer.html";
        let testResults = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type;
            const icon = {
                'pass': '✅',
                'fail': '❌', 
                'warn': '⚠️',
                'info': 'ℹ️'
            }[type] || 'ℹ️';
            
            const logEntry = `[${timestamp}] ${icon} ${message}`;
            testResults.push({timestamp, type, message, logEntry});
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += `<div class="${className}">${logEntry}</div>`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function updateTarget() {
            targetUrl = document.getElementById('targetUrl').value;
            log(`Target updated to: ${targetUrl}`, 'info');
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            testResults = [];
            log('Results cleared', 'info');
        }

        async function runAllTests() {
            log('🚀 Starting comprehensive security audit...', 'info');
            
            await testHeaders();
            await testXSS();
            await testCSRF();
            await testDOM();
            await testInputValidation();
            await testNetwork();
            
            generateSummaryReport();
        }

        async function testHeaders() {
            log('📋 Testing Security Headers...', 'info');
            
            try {
                const response = await fetch(targetUrl, {method: 'HEAD'});
                const headers = response.headers;
                
                // Content Security Policy
                if (headers.has('content-security-policy')) {
                    log('✅ CSP header found: ' + headers.get('content-security-policy').substring(0, 100) + '...', 'pass');
                } else {
                    log('❌ Content-Security-Policy header missing - XSS risk', 'fail');
                }
                
                // X-Frame-Options
                if (headers.has('x-frame-options')) {
                    log('✅ X-Frame-Options: ' + headers.get('x-frame-options'), 'pass');
                } else {
                    log('⚠️ X-Frame-Options header missing - Clickjacking risk', 'warn');
                }
                
                // X-Content-Type-Options
                if (headers.has('x-content-type-options')) {
                    log('✅ X-Content-Type-Options: ' + headers.get('x-content-type-options'), 'pass');
                } else {
                    log('⚠️ X-Content-Type-Options header missing - MIME sniffing risk', 'warn');
                }
                
                // Strict-Transport-Security
                if (headers.has('strict-transport-security')) {
                    log('✅ HSTS header found', 'pass');
                } else {
                    log('⚠️ Strict-Transport-Security header missing - Protocol downgrade risk', 'warn');
                }
                
                // Referrer-Policy
                if (headers.has('referrer-policy')) {
                    log('✅ Referrer-Policy: ' + headers.get('referrer-policy'), 'pass');
                } else {
                    log('⚠️ Referrer-Policy header missing - Information leakage risk', 'warn');
                }
                
            } catch (error) {
                log('❌ Headers test failed: ' + error.message, 'fail');
            }
        }

        async function testXSS() {
            log('🕷️ Testing XSS Vulnerabilities...', 'info');
            
            // Load the target page in an iframe for testing
            const iframe = document.createElement('iframe');
            iframe.src = targetUrl;
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
            
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    
                    // Test 1: Check for inline scripts
                    const inlineScripts = iframeDoc.querySelectorAll('script:not([src])');
                    if (inlineScripts.length > 0) {
                        log(`⚠️ Found ${inlineScripts.length} inline scripts - Potential XSS risk`, 'warn');
                    } else {
                        log('✅ No inline scripts found', 'pass');
                    }
                    
                    // Test 2: Check for eval() usage
                    const allScripts = iframeDoc.querySelectorAll('script');
                    let evalFound = false;
                    allScripts.forEach(script => {
                        if (script.textContent && script.textContent.includes('eval(')) {
                            evalFound = true;
                        }
                    });
                    
                    if (evalFound) {
                        log('❌ eval() function usage detected - High XSS risk', 'fail');
                    } else {
                        log('✅ No eval() usage detected', 'pass');
                    }
                    
                    // Test 3: Check innerHTML usage in scripts
                    let innerHTMLRisk = false;
                    allScripts.forEach(script => {
                        if (script.textContent && script.textContent.includes('innerHTML') && 
                            \!script.textContent.includes('DOMPurify')) {
                            innerHTMLRisk = true;
                        }
                    });
                    
                    if (innerHTMLRisk) {
                        log('⚠️ innerHTML usage without sanitization detected', 'warn');
                    } else {
                        log('✅ Safe DOM manipulation practices', 'pass');
                    }
                    
                    // Test 4: Check for DOMPurify usage
                    const scripts = Array.from(allScripts).map(s => s.textContent || '').join(' ');
                    if (scripts.includes('DOMPurify') || scripts.includes('purify')) {
                        log('✅ DOMPurify sanitization library detected', 'pass');
                    } else {
                        log('⚠️ No HTML sanitization library detected', 'warn');
                    }
                    
                } catch (error) {
                    log('⚠️ XSS test limited by same-origin policy: ' + error.message, 'warn');
                    
                    // Alternative test: Check for XSS protection patterns
                    testXSSPatterns();
                }
                
                document.body.removeChild(iframe);
            };
            
            iframe.onerror = function() {
                log('❌ Failed to load target page for XSS testing', 'fail');
                document.body.removeChild(iframe);
            };
        }

        function testXSSPatterns() {
            // Test common XSS payloads
            const xssPayloads = [
                '<script>alert("XSS")</script>',
                'javascript:alert("XSS")',
                '<img src="x" onerror="alert(\'XSS\')">',
                '<svg onload="alert(\'XSS\')">',
                '"><script>alert("XSS")</script>'
            ];
            
            log('Testing XSS payload patterns...', 'info');
            
            // This would be done by actually submitting forms or inputs
            // For now, we just log the patterns we're checking for
            xssPayloads.forEach((payload, index) => {
                log(`XSS Pattern ${index + 1}: ${payload.substring(0, 50)}...`, 'info');
            });
            
            log('⚠️ Manual XSS testing required with actual form submissions', 'warn');
        }

        async function testCSRF() {
            log('🛡️ Testing CSRF Protection...', 'info');
            
            try {
                const response = await fetch(targetUrl);
                const html = await response.text();
                
                // Check for CSRF tokens in forms
                const formMatches = html.match(/<form[^>]*>/gi) || [];
                const tokenPatterns = [
                    /csrf[_-]?token/i,
                    /_token/i,
                    /authenticity[_-]?token/i,
                    /anti[_-]?forgery[_-]?token/i
                ];
                
                let csrfTokenFound = false;
                tokenPatterns.forEach(pattern => {
                    if (pattern.test(html)) {
                        csrfTokenFound = true;
                    }
                });
                
                if (formMatches.length > 0) {
                    if (csrfTokenFound) {
                        log('✅ CSRF tokens detected in forms', 'pass');
                    } else {
                        log('❌ Forms found without CSRF protection', 'fail');
                    }
                } else {
                    log('ℹ️ No forms detected for CSRF testing', 'info');
                }
                
                // Check for SameSite cookie settings
                const cookies = document.cookie;
                if (cookies.includes('SameSite')) {
                    log('✅ SameSite cookie attribute detected', 'pass');
                } else {
                    log('⚠️ SameSite cookie attribute not set - CSRF risk', 'warn');
                }
                
            } catch (error) {
                log('❌ CSRF test failed: ' + error.message, 'fail');
            }
        }

        async function testDOM() {
            log('🏗️ Testing DOM Security...', 'info');
            
            try {
                const response = await fetch(targetUrl);
                const html = await response.text();
                
                // Test 1: Check for dangerous DOM methods
                const dangerousPatterns = {
                    'document.write': 'document.write() usage - XSS risk',
                    'eval(': 'eval() usage - Code injection risk',
                    'innerHTML.*=.*[^"]': 'Unsafe innerHTML assignment',
                    'outerHTML.*=': 'outerHTML assignment - XSS risk',
                    'insertAdjacentHTML': 'insertAdjacentHTML without sanitization'
                };
                
                Object.entries(dangerousPatterns).forEach(([pattern, message]) => {
                    const regex = new RegExp(pattern, 'gi');
                    if (regex.test(html)) {
                        log(`⚠️ ${message}`, 'warn');
                    }
                });
                
                // Test 2: Check for safe practices
                if (html.includes('textContent') || html.includes('innerText')) {
                    log('✅ Safe text manipulation methods used', 'pass');
                }
                
                if (html.includes('addEventListener')) {
                    log('✅ Event listeners used instead of inline handlers', 'pass');
                }
                
                // Test 3: Check for Shadow DOM usage
                if (html.includes('attachShadow') || html.includes('shadowRoot')) {
                    log('✅ Shadow DOM isolation detected', 'pass');
                }
                
            } catch (error) {
                log('❌ DOM security test failed: ' + error.message, 'fail');
            }
        }

        async function testInputValidation() {
            log('✅ Testing Input Validation...', 'info');
            
            try {
                const response = await fetch(targetUrl);
                const html = await response.text();
                
                // Check for input validation patterns
                const validationPatterns = {
                    'required': 'Required field validation',
                    'pattern=': 'Regex pattern validation',
                    'minlength': 'Minimum length validation',
                    'maxlength': 'Maximum length validation',
                    'type=.*email': 'Email validation',
                    'type=.*number': 'Number validation'
                };
                
                let validationFound = false;
                Object.entries(validationPatterns).forEach(([pattern, message]) => {
                    const regex = new RegExp(pattern, 'gi');
                    if (regex.test(html)) {
                        log(`✅ ${message} found`, 'pass');
                        validationFound = true;
                    }
                });
                
                if (\!validationFound) {
                    log('⚠️ No HTML5 validation attributes found', 'warn');
                }
                
                // Check for sanitization libraries
                if (html.includes('DOMPurify') || html.includes('sanitize')) {
                    log('✅ Input sanitization library detected', 'pass');
                } else {
                    log('⚠️ No input sanitization library detected', 'warn');
                }
                
                // Check for data validation in JavaScript
                if (html.includes('JSON.parse') && html.includes('try') && html.includes('catch')) {
                    log('✅ JSON parsing with error handling', 'pass');
                }
                
            } catch (error) {
                log('❌ Input validation test failed: ' + error.message, 'fail');
            }
        }

        async function testNetwork() {
            log('🌐 Testing Network Security...', 'info');
            
            try {
                // Test HTTPS enforcement
                if (targetUrl.startsWith('https://')) {
                    log('✅ HTTPS protocol in use', 'pass');
                } else {
                    log('⚠️ HTTP protocol - Unencrypted connection risk', 'warn');
                }
                
                // Test for mixed content
                const response = await fetch(targetUrl);
                const html = await response.text();
                
                const httpResources = html.match(/http:\/\/[^"'\s>]+/gi) || [];
                if (httpResources.length > 0 && targetUrl.startsWith('https://')) {
                    log(`❌ Mixed content detected: ${httpResources.length} HTTP resources on HTTPS page`, 'fail');
                } else if (httpResources.length === 0) {
                    log('✅ No mixed content issues detected', 'pass');
                }
                
                // Test for external resource integrity
                const scriptTags = html.match(/<script[^>]*src=["'][^"']*["'][^>]*>/gi) || [];
                let integrityFound = false;
                scriptTags.forEach(tag => {
                    if (tag.includes('integrity=')) {
                        integrityFound = true;
                    }
                });
                
                if (integrityFound) {
                    log('✅ Subresource Integrity (SRI) detected', 'pass');
                } else {
                    log('⚠️ No Subresource Integrity - External script tampering risk', 'warn');
                }
                
                // Test for CDN security
                const cdnPatterns = ['cdnjs.cloudflare.com', 'cdn.jsdelivr.net', 'unpkg.com'];
                let cdnUsage = false;
                cdnPatterns.forEach(cdn => {
                    if (html.includes(cdn)) {
                        cdnUsage = true;
                        if (html.includes(`${cdn}`) && html.includes('integrity=')) {
                            log(`✅ Secure CDN usage with SRI: ${cdn}`, 'pass');
                        } else {
                            log(`⚠️ CDN usage without SRI: ${cdn}`, 'warn');
                        }
                    }
                });
                
            } catch (error) {
                log('❌ Network security test failed: ' + error.message, 'fail');
            }
        }

        function generateSummaryReport() {
            log('📊 Generating Security Audit Summary...', 'info');
            
            const summary = {
                total: testResults.length,
                pass: testResults.filter(r => r.type === 'pass').length,
                fail: testResults.filter(r => r.type === 'fail').length,
                warn: testResults.filter(r => r.type === 'warn').length,
                info: testResults.filter(r => r.type === 'info').length
            };
            
            const score = Math.round(((summary.pass) / (summary.pass + summary.fail + summary.warn * 0.5)) * 100);
            
            log('', 'info');
            log('=' * 50, 'info');
            log('🔒 SECURITY AUDIT SUMMARY', 'info');
            log('=' * 50, 'info');
            log(`Overall Security Score: ${score}%`, score >= 80 ? 'pass' : score >= 60 ? 'warn' : 'fail');
            log(`✅ Passed Tests: ${summary.pass}`, 'pass');
            log(`❌ Failed Tests: ${summary.fail}`, 'fail');
            log(`⚠️ Warnings: ${summary.warn}`, 'warn');
            log(`ℹ️ Info Messages: ${summary.info}`, 'info');
            log('', 'info');
            
            // Risk level assessment
            if (summary.fail === 0 && summary.warn <= 2) {
                log('🛡️ RISK LEVEL: LOW - Good security posture', 'pass');
            } else if (summary.fail <= 2 && summary.warn <= 5) {
                log('⚠️ RISK LEVEL: MEDIUM - Some security improvements needed', 'warn');
            } else {
                log('🚨 RISK LEVEL: HIGH - Immediate security attention required', 'fail');
            }
        }

        // Auto-run basic tests when page loads
        window.addEventListener('load', function() {
            log('🔒 HAQEI Security Audit Tool Initialized', 'info');
            log('Target: ' + targetUrl, 'info');
            log('Click "Run All Security Tests" to begin comprehensive audit', 'info');
        });
    </script>
</body>
</html>
EOF < /dev/null