<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A/Bテスト機能検証</title>
</head>
<body>
    <h1>HAQEI A/Bテスト機能検証ページ</h1>
    
    <div id="test-results">
        <h2>テスト結果</h2>
        <div id="variant-info"></div>
        <div id="metrics-info"></div>
        <div id="events-info"></div>
    </div>

    <div style="margin: 20px 0;">
        <button onclick="testStartAnalysis()">分析開始をシミュレート</button>
        <button onclick="testQuestionAnswered()">質問回答をシミュレート</button>
        <button onclick="testAnalysisComplete()">分析完了をシミュレート</button>
        <button onclick="testExport()">データエクスポート</button>
        <button onclick="clearTestData()">テストデータクリア</button>
    </div>

    <!-- A/Bテストとフィードバックの読み込み -->
    <script src="public/js/ab-testing.js"></script>
    <script src="public/js/feedback-widget.js"></script>

    <script>
        // ページ読み込み時の状態表示
        window.addEventListener('DOMContentLoaded', () => {
            updateDisplay();
            
            // フィードバックウィジェットの存在確認
            if (window.feedbackWidget) {
                console.log('✅ フィードバックウィジェット: 正常に読み込まれました');
            } else {
                console.error('❌ フィードバックウィジェット: 読み込みエラー');
            }
            
            if (window.haqeiABTest) {
                console.log('✅ A/Bテストフレームワーク: 正常に読み込まれました');
            } else {
                console.error('❌ A/Bテストフレームワーク: 読み込みエラー');
            }
        });

        function updateDisplay() {
            if (!window.haqeiABTest) {
                document.getElementById('variant-info').innerHTML = '<p style="color: red;">A/Bテストが読み込まれていません</p>';
                return;
            }

            // バリアント情報
            document.getElementById('variant-info').innerHTML = `
                <h3>バリアント情報</h3>
                <p>テストID: ${window.haqeiABTest.testId}</p>
                <p>割り当てバリアント: <strong>${window.haqeiABTest.variant}</strong></p>
            `;

            // メトリクス情報
            const metrics = window.haqeiABTest.getMetrics();
            document.getElementById('metrics-info').innerHTML = `
                <h3>メトリクス</h3>
                <p>完了率: ${metrics.conversionRate.toFixed(2)}%</p>
                <p>平均完了時間: ${(metrics.averageCompletionTime / 1000).toFixed(2)}秒</p>
                <p>総イベント数: ${metrics.totalEvents}</p>
            `;

            // イベント情報
            const events = window.haqeiABTest.events;
            let eventsList = '<h3>最新イベント (最新5件)</h3><ul>';
            events.slice(-5).reverse().forEach(event => {
                eventsList += `<li>${event.name} - ${new Date(event.timestamp).toLocaleTimeString()}</li>`;
            });
            eventsList += '</ul>';
            document.getElementById('events-info').innerHTML = eventsList;
        }

        function testStartAnalysis() {
            if (window.haqeiABTest) {
                window.haqeiABTest.trackAnalysisStart();
                console.log('✅ 分析開始イベントを記録しました');
                updateDisplay();
            }
        }

        function testQuestionAnswered() {
            if (window.haqeiABTest) {
                const questionNum = Math.floor(Math.random() * 30) + 1;
                const answer = Math.floor(Math.random() * 5) + 1;
                window.haqeiABTest.trackQuestionAnswered(questionNum, answer);
                console.log(`✅ 質問${questionNum}の回答を記録しました`);
                updateDisplay();
            }
        }

        function testAnalysisComplete() {
            if (window.haqeiABTest) {
                const mockResults = {
                    engineOS: '乾（けん）',
                    interfaceOS: '坤（こん）',
                    safeModeOS: '震（しん）'
                };
                window.haqeiABTest.trackAnalysisComplete(mockResults);
                console.log('✅ 分析完了イベントを記録しました');
                
                // フィードバックウィジェットも表示
                if (window.feedbackWidget) {
                    window.feedbackWidget.showAfterAnalysis(1000);
                }
                
                updateDisplay();
            }
        }

        function testExport() {
            if (window.haqeiABTest) {
                window.haqeiABTest.exportTestData();
                console.log('✅ テストデータをエクスポートしました');
            }
        }

        function clearTestData() {
            localStorage.removeItem('haqei_test_id');
            localStorage.removeItem('haqei_test_variant');
            localStorage.removeItem('haqei_ab_events');
            localStorage.removeItem('haqei_feedback');
            console.log('✅ テストデータをクリアしました。ページをリロードしてください。');
            location.reload();
        }
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        
        button {
            padding: 10px 20px;
            margin: 5px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background: #357abd;
        }
        
        #test-results {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        h3 {
            color: #333;
            margin-top: 20px;
        }
    </style>
</body>
</html>