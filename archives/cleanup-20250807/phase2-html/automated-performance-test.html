<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Analyzer Performance Test</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border: 1px solid #333;
            background: #0a0a0a;
        }
        .success { border-color: #00ff00; }
        .warning { border-color: #ffaa00; }
        .error { border-color: #ff0000; }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin: 20px 0;
        }
        .metric {
            padding: 15px;
            background: #0a0a0a;
            border: 1px solid #333;
            text-align: center;
        }
        .metric h4 {
            margin: 0 0 10px 0;
            color: #ffaa00;
        }
        .metric .value {
            font-size: 24px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>🚀 OS Analyzer Performance Test</h1>
    <p>自動化されたパフォーマンステストを実行中...</p>
    
    <div id="results"></div>
    
    <div class="metrics">
        <div class="metric">
            <h4>初期読み込み時間</h4>
            <div class="value" id="loadTime">測定中...</div>
        </div>
        <div class="metric">
            <h4>Critical Path サイズ</h4>
            <div class="value" id="criticalSize">計算中...</div>
        </div>
        <div class="metric">
            <h4>DOM要素数</h4>
            <div class="value" id="domCount">カウント中...</div>
        </div>
        <div class="metric">
            <h4>メモリ使用量</h4>
            <div class="value" id="memoryUsage">測定中...</div>
        </div>
    </div>

    <script>
        // パフォーマンステストの実行
        class PerformanceTest {
            constructor() {
                this.startTime = performance.now();
                this.results = [];
                this.criticalFiles = [
                    './js/shared/core/BaseComponent.js',
                    './js/shared/core/MicroStorageManager.js',
                    './js/shared/core/MicroDataManager.js',
                    './js/shared/data/questions.js',
                    './js/os-analyzer/core/PrecompiledQuestions.js',
                    './js/os-analyzer/components/WelcomeScreen.js',
                    './js/os-analyzer/components/HaqeiQuestionElement.js',
                    './js/os-analyzer/components/VirtualQuestionFlow.js'
                ];
            }

            async runTests() {
                await this.testFileLoading();
                await this.testComponentInitialization();
                await this.testDOMPerformance();
                await this.measureMemoryUsage();
                this.generateReport();
            }

            async testFileLoading() {
                console.log('🔄 ファイル読み込みテスト開始...');
                
                const loadStartTime = performance.now();
                let totalSize = 0;
                let loadedFiles = 0;

                for (const file of this.criticalFiles) {
                    try {
                        const response = await fetch(file);
                        if (response.ok) {
                            const text = await response.text();
                            totalSize += text.length;
                            loadedFiles++;
                            this.addResult(`✅ ${file.split('/').pop()}: ${(text.length/1024).toFixed(1)}KB`, 'success');
                        } else {
                            this.addResult(`❌ ${file}: HTTP ${response.status}`, 'error');
                        }
                    } catch (error) {
                        this.addResult(`❌ ${file}: ${error.message}`, 'error');
                    }
                }

                const loadTime = performance.now() - loadStartTime;
                const totalSizeKB = (totalSize / 1024).toFixed(1);

                document.getElementById('loadTime').textContent = `${loadTime.toFixed(0)}ms`;
                document.getElementById('criticalSize').textContent = `${totalSizeKB}KB`;

                // 目標との比較
                if (totalSize <= 121856) { // 119KB
                    this.addResult(`🎯 Critical Path サイズ: ${totalSizeKB}KB (目標達成!)`, 'success');
                } else {
                    this.addResult(`⚠️ Critical Path サイズ: ${totalSizeKB}KB (目標119KB超過)`, 'warning');
                }

                if (loadTime <= 1000) {
                    this.addResult(`⚡ 読み込み時間: ${loadTime.toFixed(0)}ms (高速!)`, 'success');
                } else {
                    this.addResult(`🐌 読み込み時間: ${loadTime.toFixed(0)}ms (要改善)`, 'warning');
                }
            }

            async testComponentInitialization() {
                console.log('🔄 コンポーネント初期化テスト...');
                
                // BaseComponentの確認
                if (typeof BaseComponent !== 'undefined') {
                    this.addResult('✅ BaseComponent: 正常に読み込み', 'success');
                } else {
                    this.addResult('❌ BaseComponent: 読み込み失敗', 'error');
                }

                // MicroStorageManagerの確認
                if (typeof MicroStorageManager !== 'undefined') {
                    this.addResult('✅ MicroStorageManager: 正常に読み込み', 'success');
                } else {
                    this.addResult('❌ MicroStorageManager: 読み込み失敗', 'error');
                }

                // Web Componentの確認
                if (typeof HaqeiQuestionElement !== 'undefined') {
                    this.addResult('✅ HaqeiQuestionElement: 正常に読み込み', 'success');
                } else {
                    this.addResult('❌ HaqeiQuestionElement: 読み込み失敗', 'error');
                }

                // カスタム要素の登録確認
                if (customElements.get('haqei-question')) {
                    this.addResult('✅ <haqei-question>: Web Component登録済み', 'success');
                } else {
                    this.addResult('❌ <haqei-question>: Web Component未登録', 'error');
                }
            }

            async testDOMPerformance() {
                console.log('🔄 DOM パフォーマンステスト...');
                
                const domElements = document.querySelectorAll('*').length;
                document.getElementById('domCount').textContent = domElements;

                if (domElements < 100) {
                    this.addResult(`✅ DOM要素数: ${domElements} (軽量)`, 'success');
                } else {
                    this.addResult(`⚠️ DOM要素数: ${domElements} (やや重い)`, 'warning');
                }

                // 仮想スクロールのテスト
                if (typeof VirtualQuestionFlow !== 'undefined') {
                    this.addResult('✅ VirtualQuestionFlow: 仮想スクロール対応', 'success');
                } else {
                    this.addResult('❌ VirtualQuestionFlow: 読み込み失敗', 'error');
                }
            }

            async measureMemoryUsage() {
                console.log('🔄 メモリ使用量測定...');
                
                try {
                    if (performance.memory) {
                        const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(1);
                        document.getElementById('memoryUsage').textContent = `${memoryMB}MB`;
                        
                        if (memoryMB < 10) {
                            this.addResult(`✅ メモリ使用量: ${memoryMB}MB (優秀)`, 'success');
                        } else {
                            this.addResult(`⚠️ メモリ使用量: ${memoryMB}MB (要注意)`, 'warning');
                        }
                    } else {
                        document.getElementById('memoryUsage').textContent = 'N/A';
                        this.addResult('ℹ️ メモリ情報: ブラウザで非対応', 'warning');
                    }
                } catch (error) {
                    this.addResult(`❌ メモリ測定エラー: ${error.message}`, 'error');
                }
            }

            addResult(message, type = 'success') {
                const resultsDiv = document.getElementById('results');
                const resultDiv = document.createElement('div');
                resultDiv.className = `test-result ${type}`;
                resultDiv.textContent = message;
                resultsDiv.appendChild(resultDiv);
                console.log(message);
            }

            generateReport() {
                const totalTime = performance.now() - this.startTime;
                this.addResult(`📊 総実行時間: ${totalTime.toFixed(0)}ms`, 'success');
                
                // 最終評価
                const errorCount = document.querySelectorAll('.error').length;
                const warningCount = document.querySelectorAll('.warning').length;
                
                if (errorCount === 0 && warningCount === 0) {
                    this.addResult('🏆 総合評価: A級 (完璧な最適化)', 'success');
                } else if (errorCount === 0) {
                    this.addResult('🥈 総合評価: B級 (良好な最適化)', 'warning');
                } else {
                    this.addResult('🔧 総合評価: C級 (要改善)', 'error');
                }
            }
        }

        // テスト実行
        document.addEventListener('DOMContentLoaded', async () => {
            const test = new PerformanceTest();
            await test.runTests();
        });
    </script>
</body>
</html>