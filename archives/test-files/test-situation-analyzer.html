<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data:; font-src 'self'; connect-src 'self'; object-src 'none'; base-uri 'self'; form-action 'self'; frame-ancestors 'none';">
    <title>超高度状況分析システム - 統合テスト</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        textarea {
            width: 100%;
            min-height: 150px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
            resize: vertical;
        }
        
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 10px;
        }
        
        button:hover {
            background-color: #45a049;
        }
        
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        .results-container {
            margin-top: 30px;
        }
        
        .result-section {
            background: #f9f9f9;
            border-left: 4px solid #4CAF50;
            padding: 15px;
            margin-bottom: 15px;
        }
        
        .result-section h3 {
            margin-top: 0;
            color: #333;
        }
        
        .hexagram-info {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .confidence {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .confidence.high {
            background: #4CAF50;
            color: white;
        }
        
        .confidence.medium {
            background: #FF9800;
            color: white;
        }
        
        .confidence.low {
            background: #f44336;
            color: white;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .feature-item {
            background: white;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
        }
        
        .insight-card {
            background: #fff3e0;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .recommendation-card {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }
        
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        
        .test-cases {
            margin-top: 20px;
        }
        
        .test-case-button {
            background-color: #2196F3;
            margin: 5px;
            font-size: 14px;
            padding: 8px 16px;
        }
        
        .performance-stats {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 4px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>🔮 超高度状況分析システム - 統合テスト</h1>
    
    <div class="test-container">
        <h2>テキスト入力</h2>
        <textarea id="inputText" placeholder="あなたの状況や悩みを入力してください...">最近、長年勤めた会社でタクシードライバーとして働きながら、AI開発の勉強を始めました。将来への不安もありますが、新しい挑戦にワクワクしています。家族は心配していますが、自分の可能性を信じて進みたいと思っています。</textarea>
        
        <button onclick="analyzeText()" id="analyzeButton">分析開始</button>
        
        <div class="test-cases">
            <h3>テストケース：</h3>
            <button class="test-case-button" onclick="loadTestCase('creation')">創始期の例</button>
            <button class="test-case-button" onclick="loadTestCase('development')">発展期の例</button>
            <button class="test-case-button" onclick="loadTestCase('transformation')">変革期の例</button>
            <button class="test-case-button" onclick="loadTestCase('maturity')">成熟期の例</button>
        </div>
    </div>
    
    <div class="results-container" id="results" style="display: none;">
        <!-- 結果がここに表示されます -->
    </div>
    
    <div class="performance-stats" id="performanceStats" style="display: none;">
        <h3>パフォーマンス統計</h3>
        <div id="statsContent"></div>
    </div>

    <!-- スクリプトの読み込み -->
    <script src="public/js/situation-analyzer/ErrorHandler.js"></script>
    <script src="public/js/situation-analyzer/HexagramDatabase.js"></script>
    <script src="public/js/situation-analyzer/TextVectorizer.js"></script>
    <script src="public/js/situation-analyzer/SituationClassifier.js"></script>
    <script src="public/js/situation-analyzer/DynamicIChingMapper.js"></script>
    <script src="public/js/situation-analyzer/UltraSituationAnalyzer.js"></script>
    
    <script>
        // グローバル変数
        let analyzer = null;
        
        // 入力検証
        function validateInput(text) {
            // 基本的な長さチェック
            if (text.length > 5000) {
                return false;
            }
            
            // 危険な文字パターンのチェック
            const dangerousPatterns = [
                /<script/i,
                /<iframe/i,
                /javascript:/i,
                /on\w+\s*=/i,
                /<img.*?onerror/i
            ];
            
            for (const pattern of dangerousPatterns) {
                if (pattern.test(text)) {
                    return false;
                }
            }
            
            return true;
        }
        
        // 初期化
        function initialize() {
            try {
                analyzer = new UltraSituationAnalyzer();
                console.log('超高度状況分析システム初期化完了');
            } catch (error) {
                console.error('初期化エラー:', error);
                alert('システムの初期化に失敗しました。コンソールを確認してください。');
            }
        }
        
        // テキスト分析
        async function analyzeText() {
            const inputText = document.getElementById('inputText').value.trim();
            
            if (!inputText) {
                alert('テキストを入力してください');
                return;
            }
            
            // 入力検証
            if (!validateInput(inputText)) {
                alert('入力に不正な文字が含まれています');
                return;
            }
            
            const button = document.getElementById('analyzeButton');
            const resultsContainer = document.getElementById('results');
            
            // UI更新
            button.disabled = true;
            button.textContent = '分析中...';
            resultsContainer.style.display = 'none';
            resultsContainer.innerHTML = '';
            
            try {
                // 分析実行
                const result = await analyzer.analyze(inputText, {
                    includeVector: false,
                    saveHistory: true
                });
                
                console.log('分析結果:', result);
                
                // 結果表示
                displayResults(result);
                
                // パフォーマンス統計表示
                updatePerformanceStats();
                
            } catch (error) {
                console.error('分析エラー:', error);
                displayError(error);
            } finally {
                button.disabled = false;
                button.textContent = '分析開始';
                resultsContainer.style.display = 'block';
            }
        }
        
        // 結果表示（セキュリティ強化版）
        function displayResults(result) {
            const container = document.getElementById('results');
            
            // 安全にDOMをクリア
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            // セキュアなDOM要素作成
            const sections = [
                createSituationElement(result.situation),
                createIChingElement(result.iching),
                createInsightsElement(result.insights),
                createRecommendationsElement(result.recommendations),
                createFeaturesElement(result.vectorization)
            ];
            
            // 各セクションを安全に追加
            sections.forEach(section => {
                if (section) container.appendChild(section);
            });
        }
        
        // テキストを安全にエスケープ
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 安全な要素作成ヘルパー
        function createElement(tag, className, textContent) {
            const element = document.createElement(tag);
            if (className) element.className = className;
            if (textContent) element.textContent = textContent;
            return element;
        }
        
        // 状況分析要素作成（XSS対策版）
        function createSituationElement(situation) {
            const section = createElement('div', 'result-section');
            
            const title = createElement('h3', null, '📊 状況分析');
            section.appendChild(title);
            
            // 状況タイプ
            const typeP = createElement('p');
            const typeStrong = createElement('strong', null, '状況タイプ:');
            typeP.appendChild(typeStrong);
            typeP.appendChild(document.createTextNode(` ${situation.archetype.name}（スコア: ${situation.archetype.score.toFixed(1)}）`));
            section.appendChild(typeP);
            
            // 時間的状態
            const temporalP = createElement('p');
            const temporalStrong = createElement('strong', null, '時間的状態:');
            temporalP.appendChild(temporalStrong);
            temporalP.appendChild(document.createTextNode(
                ` 過去: ${situation.temporal.past}, ` +
                `現在: ${situation.temporal.present}, ` +
                `未来: ${situation.temporal.future}` +
                `${situation.temporal.transition ? ' (移行期)' : ''}`
            ));
            section.appendChild(temporalP);
            
            // 感情状態
            const emotionP = createElement('p');
            const emotionStrong = createElement('strong', null, '感情状態:');
            emotionP.appendChild(emotionStrong);
            emotionP.appendChild(document.createTextNode(
                ` ポジティブ: ${situation.emotions.positive}, ` +
                `ネガティブ: ${situation.emotions.negative}, ` +
                `強度: ${situation.emotions.intensity}`
            ));
            section.appendChild(emotionP);
            
            // 信頼度
            const confidenceP = createElement('p');
            const confidenceStrong = createElement('strong', null, '信頼度:');
            confidenceP.appendChild(confidenceStrong);
            
            const confidenceClass = situation.confidence > 0.7 ? 'high' : 
                                  situation.confidence > 0.4 ? 'medium' : 'low';
            const confidenceSpan = createElement('span', `confidence ${confidenceClass}`, 
                                               `${(situation.confidence * 100).toFixed(0)}%`);
            confidenceP.appendChild(document.createTextNode(' '));
            confidenceP.appendChild(confidenceSpan);
            section.appendChild(confidenceP);
            
            return section;
        }
        
        // 易経解釈要素作成（XSS対策版）
        function createIChingElement(iching) {
            const section = createElement('div', 'result-section');
            
            const title = createElement('h3', null, '☯️ 易経解釈');
            section.appendChild(title);
            
            // 卦情報
            const hexagramInfo = createElement('div', 'hexagram-info');
            const hexagramTitle = createElement('h4', null, 
                `${iching.hexagram.number}. ${iching.hexagram.name}`);
            hexagramInfo.appendChild(hexagramTitle);
            
            const essenceP = createElement('p');
            const essenceStrong = createElement('strong', null, '本質:');
            essenceP.appendChild(essenceStrong);
            essenceP.appendChild(document.createTextNode(` ${iching.hexagram.essence.essence}`));
            hexagramInfo.appendChild(essenceP);
            
            const lineP = createElement('p');
            const lineStrong = createElement('strong', null, '爻位置:');
            lineP.appendChild(lineStrong);
            lineP.appendChild(document.createTextNode(` ${iching.line.name} - ${iching.line.meaning}`));
            hexagramInfo.appendChild(lineP);
            
            section.appendChild(hexagramInfo);
            
            // 代替候補
            const altTitle = createElement('h4', null, '代替候補:');
            section.appendChild(altTitle);
            
            const altList = createElement('ul');
            iching.alternatives.forEach(alt => {
                const li = createElement('li', null, 
                    `${alt.name}（スコア: ${alt.score.toFixed(1)}）`);
                altList.appendChild(li);
            });
            section.appendChild(altList);
            
            // タイミング
            const timingP = createElement('p');
            const timingStrong = createElement('strong', null, 'タイミング:');
            timingP.appendChild(timingStrong);
            timingP.appendChild(document.createTextNode(` ${iching.interpretation.timing.description}`));
            section.appendChild(timingP);
            
            // 信頼度
            const confidenceP = createElement('p');
            const confidenceStrong = createElement('strong', null, '信頼度:');
            confidenceP.appendChild(confidenceStrong);
            
            const confidenceClass = iching.confidence > 0.7 ? 'high' : 
                                  iching.confidence > 0.4 ? 'medium' : 'low';
            const confidenceSpan = createElement('span', `confidence ${confidenceClass}`, 
                                               `${(iching.confidence * 100).toFixed(0)}%`);
            confidenceP.appendChild(document.createTextNode(' '));
            confidenceP.appendChild(confidenceSpan);
            section.appendChild(confidenceP);
            
            return section;
        }
        
        // 洞察要素作成（XSS対策版）
        function createInsightsElement(insights) {
            const section = createElement('div', 'result-section');
            const title = createElement('h3', null, '💡 洞察');
            section.appendChild(title);
            
            insights.forEach(insight => {
                const card = createElement('div', 'insight-card');
                const cardTitle = createElement('h4', null, insight.title);
                const cardContent = createElement('p', null, insight.content);
                card.appendChild(cardTitle);
                card.appendChild(cardContent);
                section.appendChild(card);
            });
            
            return section;
        }
        
        // 推奨事項要素作成（XSS対策版）
        function createRecommendationsElement(recommendations) {
            const section = createElement('div', 'result-section');
            const title = createElement('h3', null, '🎯 推奨事項');
            section.appendChild(title);
            
            recommendations.forEach(rec => {
                const card = createElement('div', 'recommendation-card');
                
                const categoryText = rec.category === 'strategic' ? '戦略' : 
                                   rec.category === 'caution' ? '注意' : '機会';
                const cardTitle = createElement('h4', null, `優先度 ${rec.priority}: ${categoryText}`);
                const cardAction = createElement('p', null, rec.action);
                const cardTiming = createElement('p');
                const timingSmall = createElement('small', null, `タイミング: ${rec.timeframe}`);
                cardTiming.appendChild(timingSmall);
                
                card.appendChild(cardTitle);
                card.appendChild(cardAction);
                card.appendChild(cardTiming);
                section.appendChild(card);
            });
            
            return section;
        }
        
        // 特徴分析要素作成（XSS対策版）
        function createFeaturesElement(vectorization) {
            const section = createElement('div', 'result-section');
            const title = createElement('h3', null, '📈 特徴分析');
            const subtitle = createElement('h4', null, '重要度分布:');
            section.appendChild(title);
            section.appendChild(subtitle);
            
            const grid = createElement('div', 'feature-grid');
            
            Object.entries(vectorization.featureImportance).forEach(([key, value]) => {
                const item = createElement('div', 'feature-item');
                const strong = createElement('strong', null, `${key}:`);
                item.appendChild(strong);
                item.appendChild(document.createTextNode(` ${(value * 100).toFixed(0)}%`));
                grid.appendChild(item);
            });
            
            section.appendChild(grid);
            return section;
        }
        
        // エラー表示（XSS対策版）
        function displayError(error) {
            const container = document.getElementById('results');
            
            // 安全にDOMをクリア
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            const errorDiv = createElement('div', 'error-message');
            const errorTitle = createElement('h3', null, 'エラーが発生しました');
            const errorMsg = createElement('p', null, error.message);
            const errorStack = createElement('pre', null, error.stack || 'Stack trace not available');
            
            errorDiv.appendChild(errorTitle);
            errorDiv.appendChild(errorMsg);
            errorDiv.appendChild(errorStack);
            container.appendChild(errorDiv);
        }
        
        // パフォーマンス統計更新
        function updatePerformanceStats() {
            if (!analyzer) return;
            
            const stats = analyzer.getPerformanceStats();
            const statsContainer = document.getElementById('performanceStats');
            const statsContent = document.getElementById('statsContent');
            
            statsContainer.style.display = 'block';
            
            const archetypesHtml = Object.entries(stats.recentArchetypes || {})
                .map(([key, value]) => `${key}: ${value}`).join(', ');
            
            const hexagramsHtml = Object.entries(stats.recentHexagrams || {})
                .map(([key, value]) => `第${key}卦: ${value}`).join(', ');
            
            statsContent.innerHTML = `
                <p><strong>総分析数:</strong> ${stats.totalAnalyses}</p>
                <p><strong>平均信頼度:</strong> ${(stats.averageConfidence * 100).toFixed(1)}%</p>
                <p><strong>平均処理時間:</strong> ${stats.averageProcessingTime.toFixed(0)}ms</p>
                <p><strong>最近のアーキタイプ:</strong> ${archetypesHtml || 'なし'}</p>
                <p><strong>最近の卦:</strong> ${hexagramsHtml || 'なし'}</p>
            `;
        }
        
        // テストケース読み込み
        function loadTestCase(type) {
            const testCases = {
                creation: '新しいプロジェクトを始めようと思っています。まだ何も決まっていませんが、わくわくする気持ちと不安が入り混じっています。周りの人は応援してくれていますが、本当にうまくいくか心配です。',
                
                development: 'プロジェクトを始めて3ヶ月が経ちました。少しずつ成果が出始めていますが、まだまだ課題は山積みです。チームメンバーとの協力関係も良好で、着実に前進している実感があります。',
                
                transformation: '今の仕事を辞めて、全く新しい分野に挑戦することを決意しました。これまでの経験を捨てることになりますが、自分の本当にやりたいことを追求する時が来たと感じています。',
                
                maturity: '長年取り組んできたプロジェクトがついに完成しました。達成感はありますが、同時に次は何をすべきか考えています。これまでの経験を活かして、新たな挑戦を始める準備をしています。'
            };
            
            document.getElementById('inputText').value = testCases[type];
        }
        
        // ページ読み込み時に初期化
        window.addEventListener('DOMContentLoaded', initialize);
    </script>
</body>
</html>