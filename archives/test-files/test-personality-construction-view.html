<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PersonalityConstructionView Test - Phase 3 UI/UX Enhancement</title>
    
    <!-- PersonalityConstructionView専用CSS -->
    <link rel="stylesheet" href="./css/components/personality-construction.css">
    
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .test-controls {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .test-button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 8px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .test-button:hover {
            transform: translateY(-1px);
        }
        
        .test-log {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 50000;
            background: rgba(0, 0, 0, 0.9);
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 11px;
            max-width: 300px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }
    </style>
</head>
<body>
    <!-- PersonalityConstructionView テストコンテナ -->
    <div id="personality-construction-container"></div>
    
    <!-- テストコントロール -->
    <div class="test-controls">
        <button class="test-button" onclick="testBasicConstruction()">基本構築テスト</button>
        <button class="test-button" onclick="testFullConstruction()">完全構築テスト</button>
        <button class="test-button" onclick="testQuickConstruction()">高速構築テスト</button>
        <button class="test-button" onclick="testErrorHandling()">エラーハンドリングテスト</button>
        <button class="test-button" onclick="clearTest()">テストクリア</button>
        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #444;">
            <button class="test-button" onclick="toggleTestLog()">ログ表示切替</button>
        </div>
    </div>
    
    <!-- テストログ -->
    <div id="test-log" class="test-log"></div>

    <!-- JavaScript Dependencies -->
    <script src="./js/shared/core/BaseComponent.js"></script>
    <script src="./js/os-analyzer/components/PersonalityConstructionView.js"></script>
    
    <script>
        // グローバル変数
        let personalityConstructionView = null;
        let testLog = document.getElementById('test-log');
        
        // テストログ機能
        function log(message) {
            console.log(message);
            if (testLog) {
                const timestamp = new Date().toLocaleTimeString();
                testLog.innerHTML += `[${timestamp}] ${message}\n`;
                testLog.scrollTop = testLog.scrollHeight;
            }
        }
    
        function toggleTestLog() {
            if (testLog.style.display === 'none' || !testLog.style.display) {
                testLog.style.display = 'block';
            } else {
                testLog.style.display = 'none';
            }
        }
        
        // テストデータ生成
        function generateTestVirtualPersonality() {
            return {
                id: `test_personality_${Date.now()}`,
                createdAt: new Date(),
                
                engineOS: {
                    osType: 'engine',
                    osName: 'Engine OS (価値観OS)',
                    hexagramId: 1,
                    hexagramName: '第1卦（乾）',
                    activation: 0.85,
                    characteristics: {
                        primary_traits: ['創造的', '理想主義的', '独立志向']
                    },
                    personality: {
                        voice: '情熱的で理想主義的な語り口',
                        priorities: ['真実の追求', '創造的表現', '理想の実現'],
                        strengths: ['創造力', '情熱', '信念の強さ']
                    }
                },
                
                interfaceOS: {
                    osType: 'interface',
                    osName: 'Interface OS (社会的OS)',
                    hexagramId: 19,
                    hexagramName: '第19卦（臨）',
                    activation: 0.72,
                    characteristics: {
                        primary_traits: ['協調的', '思いやり深い', '適応力がある']
                    },
                    personality: {
                        voice: '温かく配慮深い話し方',
                        priorities: ['人間関係の維持', '調和の創造', '他者への貢献'],
                        strengths: ['共感力', '協調性', '思いやり']
                    }
                },
                
                safeModeOS: {
                    osType: 'safemode',
                    osName: 'SafeMode OS (防御OS)',
                    hexagramId: 52,
                    hexagramName: '第52卦（艮）',
                    activation: 0.63,
                    characteristics: {
                        primary_traits: ['慎重', '安定志向', '分析的']
                    },
                    personality: {
                        voice: '慎重で分析的な表現',
                        priorities: ['安全の確保', 'リスクの回避', '安定の維持'],
                        strengths: ['慎重さ', '分析力', '危機管理能力']
                    }
                },
                
                personalityState: {
                    currentDominantOS: 'engine',
                    osBalance: {
                        engine: 0.85 / 3,
                        interface: 0.72 / 3,
                        safemode: 0.63 / 3
                    },
                    overallCoherence: 0.78,
                    internalHarmony: 0.82,
                    adaptabilityIndex: 0.74
                },
                
                personalityMetadata: {
                    personalityType: '創造的思考型',
                    tags: ['創造的', '協調的', '慎重', '情熱的', '思いやり深い']
                }
            };
        }
        
        // 基本構築テスト
        async function testBasicConstruction() {
            try {
                log('🧪 基本構築テスト開始');
                
                // PersonalityConstructionView初期化
                if (personalityConstructionView) {
                    personalityConstructionView.destroy();
                }
                
                personalityConstructionView = new PersonalityConstructionView('personality-construction-container');
                log('✅ PersonalityConstructionView初期化完了');
                
                // テストデータ生成
                const testPersonality = generateTestVirtualPersonality();
                log('✅ テスト用仮想人格データ生成完了');
                
                // 構築プロセス実行
                await personalityConstructionView.showConstructionProcess(testPersonality, {
                    speed: 2.0 // 2倍速でテスト
                });
                
                log('🎉 基本構築テスト完了');
                
            } catch (error) {
                log(`❌ 基本構築テストエラー: ${error.message}`);
                console.error('Basic construction test error:', error);
            }
        }
        
        // 完全構築テスト
        async function testFullConstruction() {
            try {
                log('🚀 完全構築テスト開始（実速度）');
                
                if (personalityConstructionView) {
                    personalityConstructionView.destroy();
                }
                
                personalityConstructionView = new PersonalityConstructionView('personality-construction-container');
                const testPersonality = generateTestVirtualPersonality();
                
                // リアル速度で実行
                await personalityConstructionView.showConstructionProcess(testPersonality, {
                    speed: 1.0 // 等倍速
                });
                
                log('🎉 完全構築テスト完了');
                
            } catch (error) {
                log(`❌ 完全構築テストエラー: ${error.message}`);
                console.error('Full construction test error:', error);
            }
        }
        
        // 高速構築テスト
        async function testQuickConstruction() {
            try {
                log('⚡ 高速構築テスト開始');
                
                if (personalityConstructionView) {
                    personalityConstructionView.destroy();
                }
                
                personalityConstructionView = new PersonalityConstructionView('personality-construction-container');
                const testPersonality = generateTestVirtualPersonality();
                
                // 5倍速で実行
                await personalityConstructionView.showConstructionProcess(testPersonality, {
                    speed: 5.0 // 5倍速
                });
                
                log('🎉 高速構築テスト完了');
                
            } catch (error) {
                log(`❌ 高速構築テストエラー: ${error.message}`);
                console.error('Quick construction test error:', error);
            }
        }
        
        // エラーハンドリングテスト
        async function testErrorHandling() {
            try {
                log('🛠️ エラーハンドリングテスト開始');
                
                if (personalityConstructionView) {
                    personalityConstructionView.destroy();
                }
                
                personalityConstructionView = new PersonalityConstructionView('personality-construction-container');
                
                // 不正なデータでテスト
                const invalidPersonality = null;
                
                await personalityConstructionView.showConstructionProcess(invalidPersonality, {
                    speed: 3.0
                });
                
                log('🎉 エラーハンドリングテスト完了');
                
            } catch (error) {
                log(`✅ 期待されたエラーをキャッチ: ${error.message}`);
                console.log('Expected error handling test passed:', error);
            }
        }
        
        // テストクリア
        function clearTest() {
            try {
                log('🧹 テストクリア開始');
                
                if (personalityConstructionView) {
                    personalityConstructionView.destroy();
                    personalityConstructionView = null;
                }
                
                const container = document.getElementById('personality-construction-container');
                if (container) {
                    container.innerHTML = '';
                }
                
                log('✅ テストクリア完了');
                
            } catch (error) {
                log(`❌ テストクリアエラー: ${error.message}`);
                console.error('Clear test error:', error);
            }
        }
        
        // イベントリスナー設定
        document.addEventListener('DOMContentLoaded', function() {
            log('🎭 PersonalityConstructionView テストページ読み込み完了');
            log('📝 テストボタンをクリックして機能を確認してください');
            
            // PersonalityConstructionViewのイベントリスナー
            const container = document.getElementById('personality-construction-container');
            if (container) {
                container.addEventListener('constructionComplete', (event) => {
                    log(`🎉 構築完了イベント受信: ${event.detail.duration}ms`);
                });
            }
        });
        
        // キーボードショートカット
        document.addEventListener('keydown', function(event) {
            if (event.altKey) {
                switch(event.key) {
                    case '1':
                        testBasicConstruction();
                        break;
                    case '2':
                        testFullConstruction(); 
                        break;
                    case '3':
                        testQuickConstruction();
                        break;
                    case '4':
                        testErrorHandling();
                        break;
                    case '0':
                        clearTest();
                        break;
                    case 'l':
                        toggleTestLog();
                        break;
                }
            }
        });
    </script>
</body>
</html>