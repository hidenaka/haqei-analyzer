<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataManager ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #3498db;
        }
        .test-section h2 {
            margin-top: 0;
            color: #34495e;
        }
        .button-group {
            margin: 20px 0;
            text-align: center;
        }
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #2980b9;
        }
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
        }
        .results {
            margin: 20px 0;
            padding: 15px;
            background: #ffffff;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .metric {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 8px;
            background: #ecf0f1;
            border-radius: 4px;
        }
        .metric-label {
            font-weight: bold;
            color: #2c3e50;
        }
        .metric-value {
            color: #27ae60;
            font-family: monospace;
        }
        .improvement {
            background: #d5f4e6;
            border: 1px solid #27ae60;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .improvement h3 {
            color: #27ae60;
            margin-top: 0;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .console-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .progress {
            background: #ecf0f1;
            border-radius: 10px;
            height: 20px;
            margin: 10px 0;
            overflow: hidden;
        }
        .progress-bar {
            background: #3498db;
            height: 100%;
            width: 0%;
            transition: width 0.3s;
            border-radius: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ DataManager ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h1>
        
        <div class="test-section">
            <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆè¨­å®š</h2>
            <div class="button-group">
                <button class="btn" onclick="initializeTest()">åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" onclick="runBasicPerformanceTest()">åŸºæœ¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" onclick="runStressTest()">ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" onclick="runMemoryTest()">ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆ</button>
                <button class="btn" onclick="clearResults()">çµæœã‚¯ãƒªã‚¢</button>
            </div>
            
            <div class="warning">
                <strong>æ³¨æ„:</strong> ã“ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€HAQEI_DATAãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
                ã¾ãšåˆæœŸåŒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
            </div>
        </div>

        <div class="test-section">
            <h2>ğŸ“ˆ ãƒ†ã‚¹ãƒˆé€²æ—</h2>
            <div class="progress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div id="progressText">ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...</div>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆçµæœ</h2>
            <div id="testResults"></div>
        </div>

        <div class="test-section">
            <h2>ğŸ–¥ï¸ ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›</h2>
            <div class="console-output" id="consoleOutput"></div>
        </div>
    </div>

    <!-- DataManagerã‚’èª­ã¿è¾¼ã¿ï¼ˆå®Ÿéš›ã®ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«èª¿æ•´ï¼‰ -->
    <script src="js/shared/core/DataManager.js"></script>
    
    <script>
        let dataManager = null;
        let testResults = {};
        
        // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«å‡ºåŠ›ã‚’ã‚­ãƒ£ãƒ—ãƒãƒ£
        const originalLog = console.log;
        const consoleOutput = document.getElementById('consoleOutput');
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.map(arg => 
                typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
            ).join(' ');
            consoleOutput.innerHTML += message + '\n';
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        };

        // é€²æ—æ›´æ–°
        function updateProgress(percent, text) {
            document.getElementById('progressBar').style.width = percent + '%';
            document.getElementById('progressText').textContent = text;
        }

        // çµæœè¡¨ç¤º
        function displayResults(results) {
            const resultsDiv = document.getElementById('testResults');
            
            let html = '';
            for (const [testName, result] of Object.entries(results)) {
                html += `
                    <div class="results">
                        <h3>${testName}</h3>
                        ${Object.entries(result).map(([key, value]) => 
                            `<div class="metric">
                                <span class="metric-label">${key}:</span>
                                <span class="metric-value">${value}</span>
                            </div>`
                        ).join('')}
                    </div>
                `;
            }
            resultsDiv.innerHTML = html;
        }

        // åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
        async function initializeTest() {
            updateProgress(0, 'åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            console.log('ğŸš€ DataManageråˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹');
            
            try {
                // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ç¢ºèª
                const globals = {
                    HAQEI_DATA: typeof window.HAQEI_DATA !== 'undefined',
                    WORLDVIEW_QUESTIONS: typeof window.WORLDVIEW_QUESTIONS !== 'undefined',
                    SCENARIO_QUESTIONS: typeof window.SCENARIO_QUESTIONS !== 'undefined',
                    H64_8D_VECTORS: typeof window.H64_8D_VECTORS !== 'undefined'
                };
                
                console.log('ğŸ“Š ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°çŠ¶æ…‹:', globals);
                
                updateProgress(25, 'DataManagerä½œæˆä¸­...');
                dataManager = new DataManager();
                
                updateProgress(50, 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...');
                await dataManager.loadData();
                
                updateProgress(75, 'ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ä¸­...');
                const stats = dataManager.getDataStats();
                console.log('ğŸ“ˆ ãƒ‡ãƒ¼ã‚¿çµ±è¨ˆ:', stats);
                
                updateProgress(100, 'åˆæœŸåŒ–å®Œäº†ï¼');
                
                testResults['åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ'] = {
                    'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿': dataManager.loaded ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—',
                    'hexagramä»¶æ•°': stats.dataStructure.hexagrams + 'ä»¶',
                    'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º': dataManager.hexagramIndex?.size + 'ä»¶' || 'N/A',
                    'ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡': '~' + (dataManager.hexagramIndex?.size * 100 / 1024).toFixed(1) + 'KB' || 'N/A'
                };
                
                displayResults(testResults);
                console.log('âœ… åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆå®Œäº†');
                
            } catch (error) {
                console.error('âŒ åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                updateProgress(0, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // åŸºæœ¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
        async function runBasicPerformanceTest() {
            if (!dataManager || !dataManager.loaded) {
                alert('å…ˆã«åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }

            updateProgress(0, 'åŸºæœ¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            console.log('ğŸ“Š åŸºæœ¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹');

            const iterations = 1000;
            const testIds = [1, 15, 32, 47, 64, 5, 23, 41, 58, 12];

            try {
                updateProgress(25, 'findHexagramByIdãƒ†ã‚¹ãƒˆä¸­...');
                
                // findHexagramByIdãƒ†ã‚¹ãƒˆ
                const findByIdStart = performance.now();
                for (let i = 0; i < iterations; i++) {
                    for (const id of testIds) {
                        dataManager.findHexagramById(id);
                    }
                }
                const findByIdTime = performance.now() - findByIdStart;

                updateProgress(50, 'getAllHexagramDataãƒ†ã‚¹ãƒˆä¸­...');
                
                // getAllHexagramDataãƒ†ã‚¹ãƒˆ
                const getAllStart = performance.now();
                for (let i = 0; i < iterations; i++) {
                    dataManager.getAllHexagramData();
                }
                const getAllTime = performance.now() - getAllStart;

                updateProgress(75, 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹çµ±è¨ˆè¨ˆç®—ä¸­...');
                
                const performanceStats = dataManager.getPerformanceStats();
                
                updateProgress(100, 'åŸºæœ¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†ï¼');

                testResults['åŸºæœ¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ'] = {
                    'findHexagramByIdç·æ™‚é–“': findByIdTime.toFixed(2) + 'ms',
                    'findHexagramByIdå¹³å‡': (findByIdTime / iterations).toFixed(4) + 'ms/å›',
                    'getAllHexagramDataç·æ™‚é–“': getAllTime.toFixed(2) + 'ms',
                    'getAllHexagramDataå¹³å‡': (getAllTime / iterations).toFixed(4) + 'ms/å›',
                    'ç·æ“ä½œå›æ•°': performanceStats.operationCount + 'å›',
                    'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡': performanceStats.cacheHitRate.toFixed(1) + '%'
                };

                displayResults(testResults);
                console.log('âœ… åŸºæœ¬ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†');

            } catch (error) {
                console.error('âŒ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                updateProgress(0, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ
        async function runStressTest() {
            if (!dataManager || !dataManager.loaded) {
                alert('å…ˆã«åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }

            updateProgress(0, 'ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            console.log('ğŸ”¥ ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹');

            const heavyIterations = 10000;
            const allIds = Array.from({length: 64}, (_, i) => i + 1);

            try {
                updateProgress(25, 'å¤§é‡æ¤œç´¢ãƒ†ã‚¹ãƒˆä¸­...');
                
                const stressStart = performance.now();
                for (let i = 0; i < heavyIterations; i++) {
                    const randomId = allIds[Math.floor(Math.random() * allIds.length)];
                    dataManager.findHexagramById(randomId);
                    
                    if (i % 1000 === 0) {
                        updateProgress(25 + (i / heavyIterations) * 50, `${i}/${heavyIterations} å‡¦ç†ä¸­...`);
                        await new Promise(resolve => setTimeout(resolve, 1));
                    }
                }
                const stressTime = performance.now() - stressStart;

                updateProgress(75, 'ä¸€æ‹¬æ¤œç´¢ãƒ†ã‚¹ãƒˆä¸­...');
                
                // ä¸€æ‹¬æ¤œç´¢ãƒ†ã‚¹ãƒˆ
                const batchStart = performance.now();
                for (let i = 0; i < 100; i++) {
                    dataManager.findHexagramsByIds(allIds);
                }
                const batchTime = performance.now() - batchStart;

                updateProgress(100, 'ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†ï¼');

                testResults['ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆ'] = {
                    'å¤§é‡æ¤œç´¢æ™‚é–“': stressTime.toFixed(2) + 'ms',
                    'å¤§é‡æ¤œç´¢ãƒ¬ãƒ¼ãƒˆ': Math.round(heavyIterations / (stressTime / 1000)) + ' req/sec',
                    'ä¸€æ‹¬æ¤œç´¢æ™‚é–“': batchTime.toFixed(2) + 'ms',
                    'ä¸€æ‹¬æ¤œç´¢å¹³å‡': (batchTime / 100).toFixed(2) + 'ms/å›',
                    'ãƒ¡ãƒ¢ãƒªå®‰å®šæ€§': 'OK'
                };

                displayResults(testResults);
                console.log('âœ… ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆå®Œäº†');

            } catch (error) {
                console.error('âŒ ã‚¹ãƒˆãƒ¬ã‚¹ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                updateProgress(0, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆ
        async function runMemoryTest() {
            if (!dataManager || !dataManager.loaded) {
                alert('å…ˆã«åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„');
                return;
            }

            updateProgress(0, 'ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆé–‹å§‹...');
            console.log('ğŸ’¾ ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆé–‹å§‹');

            try {
                const memoryBefore = performance.memory ? performance.memory.usedJSHeapSize : 'N/A';
                
                updateProgress(25, 'ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡æ¸¬å®šä¸­...');
                
                // å¤§é‡ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ“ä½œ
                for (let i = 0; i < 1000; i++) {
                    dataManager.findHexagramById(1 + (i % 64));
                }
                
                updateProgress(50, 'ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–å®Ÿè¡Œä¸­...');
                
                // ãƒ¡ãƒ¢ãƒªæœ€é©åŒ–
                if (dataManager.optimizeMemoryUsage) {
                    dataManager.optimizeMemoryUsage();
                }
                
                updateProgress(75, 'ãƒ¡ãƒ¢ãƒªçµ±è¨ˆè¨ˆç®—ä¸­...');
                
                const memoryAfter = performance.memory ? performance.memory.usedJSHeapSize : 'N/A';
                const cacheSize = dataManager.cache?.size || 0;
                const indexSize = dataManager.hexagramIndex?.size || 0;
                
                updateProgress(100, 'ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆå®Œäº†ï¼');

                testResults['ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆ'] = {
                    'ä½¿ç”¨å‰ãƒ¡ãƒ¢ãƒª': memoryBefore !== 'N/A' ? Math.round(memoryBefore / 1024) + 'KB' : 'N/A',
                    'ä½¿ç”¨å¾Œãƒ¡ãƒ¢ãƒª': memoryAfter !== 'N/A' ? Math.round(memoryAfter / 1024) + 'KB' : 'N/A',
                    'ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º': cacheSize + 'ä»¶',
                    'ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚µã‚¤ã‚º': indexSize + 'ä»¶',
                    'æ¨å®šãƒ¡ãƒ¢ãƒªåŠ¹ç‡': 'è‰¯å¥½'
                };

                displayResults(testResults);
                console.log('âœ… ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆå®Œäº†');

            } catch (error) {
                console.error('âŒ ãƒ¡ãƒ¢ãƒªãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼:', error);
                updateProgress(0, 'ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // çµæœã‚¯ãƒªã‚¢
        function clearResults() {
            testResults = {};
            document.getElementById('testResults').innerHTML = '';
            document.getElementById('consoleOutput').innerHTML = '';
            updateProgress(0, 'ãƒ†ã‚¹ãƒˆå¾…æ©Ÿä¸­...');
            console.log('ğŸ§¹ çµæœã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã®è‡ªå‹•ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', function() {
            console.log('ğŸŒ ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            console.log('ğŸ“‹ åˆ©ç”¨å¯èƒ½ãªã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°:');
            console.log('- HAQEI_DATA:', typeof window.HAQEI_DATA !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('- WORLDVIEW_QUESTIONS:', typeof window.WORLDVIEW_QUESTIONS !== 'undefined' ? 'âœ…' : 'âŒ');
            console.log('- DataManager:', typeof window.DataManager !== 'undefined' ? 'âœ…' : 'âŒ');
            
            if (typeof window.DataManager === 'undefined') {
                console.warn('âš ï¸ DataManagerãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ‘ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            }
        });
    </script>
</body>
</html>