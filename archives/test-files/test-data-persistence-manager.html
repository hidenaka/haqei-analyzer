<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DataPersistenceManager ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ - HAQEI Future Simulator</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      min-height: 100vh;
    }
    
    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 30px;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .test-section {
      margin: 20px 0;
      padding: 20px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: #f8f9fa;
    }
    
    .test-section h2 {
      color: #34495e;
      border-bottom: 2px solid #3498db;
      padding-bottom: 10px;
      margin-bottom: 15px;
    }
    
    .button-group {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin: 15px 0;
    }
    
    button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    
    .btn-primary {
      background: linear-gradient(45deg, #3498db, #2980b9);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(52, 152, 219, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(45deg, #27ae60, #229954);
      color: white;
    }
    
    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(39, 174, 96, 0.3);
    }
    
    .btn-warning {
      background: linear-gradient(45deg, #f39c12, #e67e22);
      color: white;
    }
    
    .btn-warning:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(243, 156, 18, 0.3);
    }
    
    .btn-danger {
      background: linear-gradient(45deg, #e74c3c, #c0392b);
      color: white;
    }
    
    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3);
    }
    
    .results {
      margin-top: 20px;
      padding: 15px;
      border-radius: 8px;
      background: #ffffff;
      border-left: 4px solid #3498db;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      max-height: 400px;
      overflow-y: auto;
      white-space: pre-wrap;
      line-height: 1.4;
    }
    
    .success {
      border-left-color: #27ae60;
      background: #d5f4e6;
    }
    
    .error {
      border-left-color: #e74c3c;
      background: #fdf2f2;
    }
    
    .warning {
      border-left-color: #f39c12;
      background: #fef9e7;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .stat-card {
      background: white;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      border-left: 4px solid #3498db;
    }
    
    .stat-card h3 {
      margin: 0 0 10px 0;
      color: #2c3e50;
      font-size: 16px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: bold;
      color: #3498db;
    }
    
    .progress-bar {
      width: 100%;
      height: 20px;
      background: #ecf0f1;
      border-radius: 10px;
      overflow: hidden;
      margin: 10px 0;
    }
    
    .progress-fill {
      height: 100%;
      background: linear-gradient(45deg, #3498db, #2980b9);
      width: 0%;
      transition: width 0.3s ease;
    }
    
    .log-entry {
      padding: 8px 12px;
      margin: 5px 0;
      border-radius: 5px;
      border-left: 3px solid #bdc3c7;
      background: #f8f9fa;
    }
    
    .log-success {
      border-left-color: #27ae60;
      background: #d5f4e6;
    }
    
    .log-error {
      border-left-color: #e74c3c;
      background: #fdf2f2;
    }
    
    .log-info {
      border-left-color: #3498db;
      background: #e8f4f8;
    }
    
    .log-warning {
      border-left-color: #f39c12;
      background: #fef9e7;
    }
    
    #performanceChart {
      margin: 20px 0;
      height: 300px;
      background: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ—„ï¸ DataPersistenceManager ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆ</h1>
    
    <!-- åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <h2>ğŸš€ åˆæœŸåŒ–ãƒ»åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ</h2>
      <div class="button-group">
        <button class="btn-primary" onclick="testInitialization()">åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-primary" onclick="testEncryption()">æš—å·åŒ–ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-primary" onclick="testDatabase()">ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-success" onclick="runBasicTests()">åŸºæœ¬ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</button>
      </div>
      <div id="initResults" class="results"></div>
    </div>
    
    <!-- CRUDæ“ä½œãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <h2>ğŸ“ CRUDæ“ä½œãƒ†ã‚¹ãƒˆ</h2>
      <div class="button-group">
        <button class="btn-success" onclick="testCreate()">ä½œæˆãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-primary" onclick="testRead()">èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-warning" onclick="testUpdate()">æ›´æ–°ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-danger" onclick="testDelete()">å‰Šé™¤ãƒ†ã‚¹ãƒˆ</button>
        <button class="btn-success" onclick="runCRUDTests()">CRUDç·åˆãƒ†ã‚¹ãƒˆ</button>
      </div>
      <div id="crudResults" class="results"></div>
    </div>
    
    <!-- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <h2>âš¡ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ</h2>
      <div class="button-group">
        <button class="btn-primary" onclick="testBulkInsert()">å¤§é‡ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥</button>
        <button class="btn-primary" onclick="testBulkQuery()">å¤§é‡ãƒ‡ãƒ¼ã‚¿æ¤œç´¢</button>
        <button class="btn-warning" onclick="testCachePerformance()">ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ€§èƒ½</button>
        <button class="btn-danger" onclick="testMemoryUsage()">ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡</button>
        <button class="btn-success" onclick="runPerformanceTests()">æ€§èƒ½ç·åˆãƒ†ã‚¹ãƒˆ</button>
      </div>
      <div id="performanceResults" class="results"></div>
      <div id="performanceChart"></div>
    </div>
    
    <!-- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ -->
    <div class="test-section">
      <h2>ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ</h2>
      <div class="button-group">
        <button class="btn-primary" onclick="testDataEncryption()">ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–</button>
        <button class="btn-primary" onclick="testDataAnonymization()">ãƒ‡ãƒ¼ã‚¿åŒ¿ååŒ–</button>
        <button class="btn-warning" onclick="testAutoCleanup()">è‡ªå‹•å‰Šé™¤</button>
        <button class="btn-success" onclick="runSecurityTests()">ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç·åˆãƒ†ã‚¹ãƒˆ</button>
      </div>
      <div id="securityResults" class="results"></div>
    </div>
    
    <!-- çµ±è¨ˆãƒ»ç›£è¦– -->
    <div class="test-section">
      <h2>ğŸ“Š çµ±è¨ˆãƒ»ç›£è¦–</h2>
      <div class="button-group">
        <button class="btn-primary" onclick="showStatistics()">çµ±è¨ˆè¡¨ç¤º</button>
        <button class="btn-primary" onclick="showDatabaseInfo()">DBæƒ…å ±è¡¨ç¤º</button>
        <button class="btn-warning" onclick="clearAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        <button class="btn-success" onclick="createBackup()">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ</button>
      </div>
      
      <div class="stats-grid" id="statsGrid">
        <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ãŒå‹•çš„ã«ç”Ÿæˆã•ã‚Œã‚‹ -->
      </div>
      
      <div id="monitoringResults" class="results"></div>
    </div>
    
    <!-- ãƒ†ã‚¹ãƒˆãƒ­ã‚° -->
    <div class="test-section">
      <h2>ğŸ“‹ ãƒ†ã‚¹ãƒˆãƒ­ã‚°</h2>
      <div class="button-group">
        <button class="btn-warning" onclick="clearLogs()">ãƒ­ã‚°ã‚¯ãƒªã‚¢</button>
        <button class="btn-success" onclick="exportTestResults()">çµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</button>
      </div>
      <div id="testLogs" class="results"></div>
    </div>
  </div>

  <!-- DataPersistenceManagerã®èª­ã¿è¾¼ã¿ -->
  <script src="./public/js/core/DataPersistenceManager.js"></script>
  
  <script>
    // ãƒ†ã‚¹ãƒˆç’°å¢ƒã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
    let persistenceManager = null;
    let testResults = [];
    let testStartTime = null;
    let performanceMetrics = [];
    
    // ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logEntry = `[${timestamp}] ${message}`;
      
      const testLogs = document.getElementById('testLogs');
      const logDiv = document.createElement('div');
      logDiv.className = `log-entry log-${type}`;
      logDiv.textContent = logEntry;
      testLogs.appendChild(logDiv);
      
      // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
      testLogs.scrollTop = testLogs.scrollHeight;
      
      console.log(logEntry);
    }
    
    // çµæœè¡¨ç¤ºé–¢æ•°
    function showResults(elementId, results, type = '') {
      const element = document.getElementById(elementId);
      element.innerHTML = JSON.stringify(results, null, 2);
      if (type) {
        element.className = `results ${type}`;
      }
    }
    
    // ãƒ†ã‚¹ãƒˆå®Ÿè¡Œæ™‚é–“æ¸¬å®š
    function startTimer() {
      testStartTime = performance.now();
    }
    
    function endTimer() {
      return testStartTime ? performance.now() - testStartTime : 0;
    }
    
    // åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ
    async function testInitialization() {
      log('åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        persistenceManager = new DataPersistenceManager();
        const result = await persistenceManager.initialize();
        
        const testTime = endTimer();
        
        testResults.push({
          test: 'initialization',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('initResults', result, result.success ? 'success' : 'error');
        log(`åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆ ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'error');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        testResults.push({
          test: 'initialization',
          success: false,
          time: testTime,
          error: error.message
        });
        
        showResults('initResults', errorResult, 'error');
        log(`åˆæœŸåŒ–ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // æš—å·åŒ–ãƒ†ã‚¹ãƒˆ
    async function testEncryption() {
      log('æš—å·åŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const testData = 'HAQEIæš—å·åŒ–ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ - å€‹äººæƒ…å ±ã‚µãƒ³ãƒ—ãƒ«';
        
        // æš—å·åŒ–
        const encrypted = await persistenceManager.encryptData(testData);
        log(`ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–å®Œäº†: ${encrypted.substring(0, 50)}...`, 'info');
        
        // å¾©å·åŒ–
        const decrypted = await persistenceManager.decryptData(encrypted);
        log(`ãƒ‡ãƒ¼ã‚¿å¾©å·åŒ–å®Œäº†: ${decrypted}`, 'info');
        
        // æ¤œè¨¼
        const isValid = decrypted === testData;
        const testTime = endTimer();
        
        const result = {
          success: isValid,
          originalData: testData,
          encryptedData: encrypted,
          decryptedData: decrypted,
          testTime: testTime
        };
        
        testResults.push({
          test: 'encryption',
          success: isValid,
          time: testTime,
          details: result
        });
        
        showResults('initResults', result, isValid ? 'success' : 'error');
        log(`æš—å·åŒ–ãƒ†ã‚¹ãƒˆ ${isValid ? 'æˆåŠŸ' : 'å¤±æ•—'} (${testTime.toFixed(2)}ms)`, 
            isValid ? 'success' : 'error');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('initResults', errorResult, 'error');
        log(`æš—å·åŒ–ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ
    async function testDatabase() {
      log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±å–å¾—
        const stats = persistenceManager.getPerformanceStatistics();
        const testTime = endTimer();
        
        const result = {
          success: stats.database.initialized,
          databaseInfo: stats.database,
          operations: stats.operations,
          testTime: testTime
        };
        
        testResults.push({
          test: 'database',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('initResults', result, result.success ? 'success' : 'error');
        log(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆ ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'error');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('initResults', errorResult, 'error');
        log(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // åŸºæœ¬ãƒ†ã‚¹ãƒˆç·åˆå®Ÿè¡Œ
    async function runBasicTests() {
      log('åŸºæœ¬ãƒ†ã‚¹ãƒˆç·åˆå®Ÿè¡Œé–‹å§‹', 'info');
      
      const results = {
        initialization: await testInitialization(),
        encryption: await testEncryption(),
        database: await testDatabase()
      };
      
      const allSuccessful = Object.values(results).every(r => r.success);
      
      showResults('initResults', results, allSuccessful ? 'success' : 'warning');
      log(`åŸºæœ¬ãƒ†ã‚¹ãƒˆç·åˆçµæœ: ${allSuccessful ? 'å…¨ã¦æˆåŠŸ' : 'ä¸€éƒ¨å¤±æ•—'}`, 
          allSuccessful ? 'success' : 'warning');
      
      return results;
    }
    
    // åˆ†æçµæœã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    function generateSampleAnalysisData(index = 0) {
      return {
        inputAnalysis: {
          originalText: `ãƒ†ã‚¹ãƒˆãƒ†ã‚­ã‚¹ãƒˆ${index}: ä»•äº‹ã§ã®ã‚¹ãƒˆãƒ¬ã‚¹ã¨äººé–“é–¢ä¿‚ã«ã¤ã„ã¦æ‚©ã‚“ã§ã„ã¾ã™ã€‚`,
          textLength: 30,
          complexity: 'medium'
        },
        finalResult: {
          hexagram: Math.floor(Math.random() * 64) + 1,
          line: Math.floor(Math.random() * 6) + 1,
          confidence: 0.7 + Math.random() * 0.3,
          reasoning: `åˆ†æçµæœ${index}: ã“ã®çŠ¶æ³ã§ã¯æ…é‡ãªåˆ¤æ–­ãŒå¿…è¦ã§ã™ã€‚`,
          tripleOSIntegration: {
            engineOS: Math.random(),
            interfaceOS: Math.random(),
            safeModeOS: Math.random()
          }
        },
        stageResults: {
          stage1: { normalizedText: `æ­£è¦åŒ–ãƒ†ã‚­ã‚¹ãƒˆ${index}` },
          stage2: { tokens: [], analysis: {} },
          stage3: { keywords: [], confidence: 0.8 },
          stage4: { emotionalAnalysis: {} },
          stage5: { osImpacts: {} },
          stage6: { hexagram: Math.floor(Math.random() * 64) + 1 },
          stage7: { finalResult: {} }
        },
        qualityMetrics: {
          overallConfidence: 0.8,
          stageCompletionRate: 1.0,
          errorCount: 0,
          processingTime: 150,
          qualityGrade: 'A'
        },
        systemInfo: {
          engineVersion: '2.1',
          timestamp: new Date().toISOString()
        }
      };
    }
    
    // 7å¤‰åŒ–ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
    function generateSamplePatterns(count = 7) {
      const patterns = [];
      const patternTypes = [
        'transformation', 'evolution', 'adaptation', 'innovation',
        'integration', 'optimization', 'realization'
      ];
      
      for (let i = 0; i < count; i++) {
        patterns.push({
          type: patternTypes[i] || `pattern_${i}`,
          data: {
            description: `ãƒ‘ã‚¿ãƒ¼ãƒ³${i + 1}ã®è©³ç´°ãƒ‡ãƒ¼ã‚¿`,
            intensity: Math.random(),
            probability: Math.random(),
            timeframe: ['short', 'medium', 'long'][Math.floor(Math.random() * 3)]
          }
        });
      }
      
      return patterns;
    }
    
    // ä½œæˆãƒ†ã‚¹ãƒˆ
    async function testCreate() {
      log('ä½œæˆãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const analysisData = generateSampleAnalysisData(1);
        const patterns = generateSamplePatterns();
        const userProfile = {
          age: 30,
          location: { prefecture: 'æ±äº¬éƒ½' },
          interests: ['philosophy', 'self-development']
        };
        
        const result = await persistenceManager.saveAnalysisResult(analysisData, patterns, userProfile);
        const testTime = endTimer();
        
        testResults.push({
          test: 'create',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('crudResults', result, result.success ? 'success' : 'error');
        log(`ä½œæˆãƒ†ã‚¹ãƒˆ ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'error');
        
        // ä½œæˆã—ãŸIDã‚’ä¿å­˜ï¼ˆä»–ã®ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ï¼‰
        if (result.success) {
          window.testAnalysisId = result.analysisId;
        }
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('crudResults', errorResult, 'error');
        log(`ä½œæˆãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ
    async function testRead() {
      log('èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        // äº‹å‰ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
        if (!window.testAnalysisId) {
          const createResult = await testCreate();
          if (!createResult.success) {
            throw new Error('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆå¤±æ•—');
          }
        }
        
        const result = await persistenceManager.getAnalysisResult(window.testAnalysisId);
        const testTime = endTimer();
        
        testResults.push({
          test: 'read',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('crudResults', result, result.success ? 'success' : 'error');
        log(`èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆ ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'error');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('crudResults', errorResult, 'error');
        log(`èª­ã¿å–ã‚Šãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // æ›´æ–°ãƒ†ã‚¹ãƒˆï¼ˆç¾åœ¨ã®å®Ÿè£…ã§ã¯æ›´æ–°æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€å†ä¿å­˜ãƒ†ã‚¹ãƒˆï¼‰
    async function testUpdate() {
      log('æ›´æ–°ãƒ†ã‚¹ãƒˆé–‹å§‹ï¼ˆå†ä¿å­˜ï¼‰', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const analysisData = generateSampleAnalysisData(999); // ç•°ãªã‚‹ãƒ‡ãƒ¼ã‚¿
        const patterns = generateSamplePatterns();
        
        const result = await persistenceManager.saveAnalysisResult(analysisData, patterns);
        const testTime = endTimer();
        
        testResults.push({
          test: 'update',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('crudResults', result, result.success ? 'success' : 'error');
        log(`æ›´æ–°ãƒ†ã‚¹ãƒˆ ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'error');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('crudResults', errorResult, 'error');
        log(`æ›´æ–°ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // å‰Šé™¤ãƒ†ã‚¹ãƒˆ
    async function testDelete() {
      log('å‰Šé™¤ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        // å‰Šé™¤ç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        const analysisData = generateSampleAnalysisData(777);
        const patterns = generateSamplePatterns();
        const createResult = await persistenceManager.saveAnalysisResult(analysisData, patterns);
        
        if (!createResult.success) {
          throw new Error('å‰Šé™¤ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆå¤±æ•—');
        }
        
        // å‰Šé™¤å®Ÿè¡Œ
        const result = await persistenceManager.deleteAnalysisResult(createResult.analysisId);
        const testTime = endTimer();
        
        testResults.push({
          test: 'delete',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('crudResults', result, result.success ? 'success' : 'error');
        log(`å‰Šé™¤ãƒ†ã‚¹ãƒˆ ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'} (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'error');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('crudResults', errorResult, 'error');
        log(`å‰Šé™¤ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // CRUDç·åˆãƒ†ã‚¹ãƒˆ
    async function runCRUDTests() {
      log('CRUDç·åˆãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      
      const results = {
        create: await testCreate(),
        read: await testRead(),
        update: await testUpdate(),
        delete: await testDelete()
      };
      
      const allSuccessful = Object.values(results).every(r => r.success);
      
      showResults('crudResults', results, allSuccessful ? 'success' : 'warning');
      log(`CRUDç·åˆãƒ†ã‚¹ãƒˆçµæœ: ${allSuccessful ? 'å…¨ã¦æˆåŠŸ' : 'ä¸€éƒ¨å¤±æ•—'}`, 
          allSuccessful ? 'success' : 'warning');
      
      return results;
    }
    
    // å¤§é‡ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ãƒ†ã‚¹ãƒˆ
    async function testBulkInsert() {
      log('å¤§é‡ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const testCount = 100; // 100ä»¶ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿
        const promises = [];
        
        log(`${testCount}ä»¶ã®ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥é–‹å§‹...`, 'info');
        
        for (let i = 0; i < testCount; i++) {
          const analysisData = generateSampleAnalysisData(i);
          const patterns = generateSamplePatterns();
          promises.push(persistenceManager.saveAnalysisResult(analysisData, patterns));
          
          // é€²æ—è¡¨ç¤º
          if (i % 20 === 0) {
            log(`é€²æ—: ${i}/${testCount} (${(i/testCount*100).toFixed(1)}%)`, 'info');
          }
        }
        
        const results = await Promise.all(promises);
        const testTime = endTimer();
        
        const successCount = results.filter(r => r.success).length;
        const successRate = successCount / testCount * 100;
        
        const result = {
          success: successRate > 90,
          totalInserted: testCount,
          successfulInserted: successCount,
          successRate: successRate,
          testTime: testTime,
          averageTimePerRecord: testTime / testCount
        };
        
        performanceMetrics.push({
          test: 'bulkInsert',
          totalRecords: testCount,
          timeMs: testTime,
          recordsPerSecond: testCount / (testTime / 1000)
        });
        
        testResults.push({
          test: 'bulkInsert',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('performanceResults', result, result.success ? 'success' : 'warning');
        log(`å¤§é‡ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ãƒ†ã‚¹ãƒˆå®Œäº†: ${successCount}/${testCount}ä»¶æˆåŠŸ (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'warning');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('performanceResults', errorResult, 'error');
        log(`å¤§é‡ãƒ‡ãƒ¼ã‚¿æŒ¿å…¥ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // å¤§é‡ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ†ã‚¹ãƒˆ
    async function testBulkQuery() {
      log('å¤§é‡ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        // æ§˜ã€…ãªæ¤œç´¢æ¡ä»¶ã§ãƒ†ã‚¹ãƒˆ
        const searchTests = [
          { name: 'å…¨ä»¶æ¤œç´¢', criteria: {} },
          { name: 'ä¿¡é ¼åº¦ç¯„å›²æ¤œç´¢', criteria: { confidenceRange: { min: 0.8, max: 1.0 } } },
          { name: 'æ—¥ä»˜ç¯„å›²æ¤œç´¢', criteria: { dateRange: { start: Date.now() - 86400000, end: Date.now() } } },
          { name: 'åˆ¶é™ä»˜ãæ¤œç´¢', criteria: { limit: 50 } }
        ];
        
        const results = [];
        
        for (const test of searchTests) {
          const searchStartTime = performance.now();
          const searchResult = await persistenceManager.searchAnalysisResults(test.criteria);
          const searchTime = performance.now() - searchStartTime;
          
          results.push({
            testName: test.name,
            success: searchResult.success,
            resultCount: searchResult.results?.length || 0,
            searchTime: searchTime
          });
          
          log(`${test.name}: ${searchResult.results?.length || 0}ä»¶ (${searchTime.toFixed(2)}ms)`, 'info');
        }
        
        const testTime = endTimer();
        const allSuccessful = results.every(r => r.success);
        
        const result = {
          success: allSuccessful,
          searchTests: results,
          totalTestTime: testTime,
          averageSearchTime: results.reduce((sum, r) => sum + r.searchTime, 0) / results.length
        };
        
        performanceMetrics.push({
          test: 'bulkQuery',
          totalQueries: results.length,
          timeMs: testTime,
          averageQueryTime: result.averageSearchTime
        });
        
        testResults.push({
          test: 'bulkQuery',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('performanceResults', result, result.success ? 'success' : 'warning');
        log(`å¤§é‡ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ†ã‚¹ãƒˆå®Œäº†: ${results.length}ç¨®é¡ã®æ¤œç´¢å®Ÿè¡Œ (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'warning');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('performanceResults', errorResult, 'error');
        log(`å¤§é‡ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ€§èƒ½ãƒ†ã‚¹ãƒˆ
    async function testCachePerformance() {
      log('ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ€§èƒ½ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ä½œæˆ
        const analysisData = generateSampleAnalysisData(888);
        const patterns = generateSamplePatterns();
        const createResult = await persistenceManager.saveAnalysisResult(analysisData, patterns);
        
        if (!createResult.success) {
          throw new Error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ä½œæˆå¤±æ•—');
        }
        
        const analysisId = createResult.analysisId;
        
        // åˆå›èª­ã¿å–ã‚Šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãªã—ï¼‰
        const firstReadStart = performance.now();
        const firstRead = await persistenceManager.getAnalysisResult(analysisId);
        const firstReadTime = performance.now() - firstReadStart;
        
        // 2å›ç›®èª­ã¿å–ã‚Šï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚ã‚Šï¼‰
        const secondReadStart = performance.now();
        const secondRead = await persistenceManager.getAnalysisResult(analysisId);
        const secondReadTime = performance.now() - secondReadStart;
        
        const testTime = endTimer();
        const speedup = firstReadTime / secondReadTime;
        
        const result = {
          success: firstRead.success && secondRead.success,
          firstReadTime: firstReadTime,
          secondReadTime: secondReadTime,
          speedup: speedup,
          cacheEffective: speedup > 1.5,
          testTime: testTime
        };
        
        testResults.push({
          test: 'cachePerformance',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('performanceResults', result, result.success ? 'success' : 'warning');
        log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ€§èƒ½ãƒ†ã‚¹ãƒˆå®Œäº†: ${speedup.toFixed(2)}å€é«˜é€ŸåŒ– (${testTime.toFixed(2)}ms)`, 
            result.cacheEffective ? 'success' : 'warning');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('performanceResults', errorResult, 'error');
        log(`ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ€§èƒ½ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆ
    async function testMemoryUsage() {
      log('ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        const initialMemory = performance.memory ? {
          used: performance.memory.usedJSHeapSize,
          total: performance.memory.totalJSHeapSize,
          limit: performance.memory.jsHeapSizeLimit
        } : null;
        
        if (!persistenceManager) {
          await testInitialization();
        }
        
        // å¤§é‡ãƒ‡ãƒ¼ã‚¿ä½œæˆ
        const testCount = 50;
        const promises = [];
        
        for (let i = 0; i < testCount; i++) {
          const analysisData = generateSampleAnalysisData(i);
          const patterns = generateSamplePatterns();
          promises.push(persistenceManager.saveAnalysisResult(analysisData, patterns));
        }
        
        await Promise.all(promises);
        
        const finalMemory = performance.memory ? {
          used: performance.memory.usedJSHeapSize,
          total: performance.memory.totalJSHeapSize,
          limit: performance.memory.jsHeapSizeLimit
        } : null;
        
        const testTime = endTimer();
        
        const result = {
          success: true,
          initialMemory: initialMemory,
          finalMemory: finalMemory,
          memoryIncrease: finalMemory && initialMemory ? 
            finalMemory.used - initialMemory.used : null,
          testRecords: testCount,
          testTime: testTime,
          memoryPerRecord: finalMemory && initialMemory ? 
            (finalMemory.used - initialMemory.used) / testCount : null
        };
        
        testResults.push({
          test: 'memoryUsage',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('performanceResults', result, 'success');
        log(`ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆå®Œäº†: ${result.memoryIncrease ? 
          `${(result.memoryIncrease / 1024 / 1024).toFixed(2)}MBå¢—åŠ ` : 
          'ãƒ¡ãƒ¢ãƒªæƒ…å ±ä¸æ˜'} (${testTime.toFixed(2)}ms)`, 'info');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('performanceResults', errorResult, 'error');
        log(`ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç·åˆãƒ†ã‚¹ãƒˆ
    async function runPerformanceTests() {
      log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç·åˆãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      
      const results = {
        bulkInsert: await testBulkInsert(),
        bulkQuery: await testBulkQuery(),
        cachePerformance: await testCachePerformance(),
        memoryUsage: await testMemoryUsage()
      };
      
      const allSuccessful = Object.values(results).every(r => r.success);
      
      showResults('performanceResults', results, allSuccessful ? 'success' : 'warning');
      log(`ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç·åˆãƒ†ã‚¹ãƒˆçµæœ: ${allSuccessful ? 'å…¨ã¦æˆåŠŸ' : 'ä¸€éƒ¨å¤±æ•—'}`, 
          allSuccessful ? 'success' : 'warning');
      
      // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
      updatePerformanceChart();
      
      return results;
    }
    
    // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
    function updatePerformanceChart() {
      const chartDiv = document.getElementById('performanceChart');
      if (performanceMetrics.length === 0) {
        chartDiv.innerHTML = '<p>ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p>';
        return;
      }
      
      let html = '<h3>ğŸ“Š ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æŒ‡æ¨™</h3>';
      html += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">';
      
      performanceMetrics.forEach(metric => {
        html += `
          <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
            <h4>${metric.test}</h4>
            <p><strong>å®Ÿè¡Œæ™‚é–“:</strong> ${metric.timeMs.toFixed(2)}ms</p>
            ${metric.totalRecords ? `<p><strong>ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°:</strong> ${metric.totalRecords}</p>` : ''}
            ${metric.recordsPerSecond ? `<p><strong>1ç§’ã‚ãŸã‚Š:</strong> ${metric.recordsPerSecond.toFixed(2)}ãƒ¬ã‚³ãƒ¼ãƒ‰</p>` : ''}
            ${metric.averageQueryTime ? `<p><strong>å¹³å‡ã‚¯ã‚¨ãƒªæ™‚é–“:</strong> ${metric.averageQueryTime.toFixed(2)}ms</p>` : ''}
          </div>
        `;
      });
      
      html += '</div>';
      chartDiv.innerHTML = html;
    }
    
    // ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ãƒ†ã‚¹ãƒˆ
    async function testDataEncryption() {
      log('ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const sensitiveData = [
          'ç”°ä¸­å¤ªéƒã•ã‚“ã®å€‹äººæƒ…å ±',
          'ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: test@example.com',
          'ä½æ‰€: æ±äº¬éƒ½æ¸‹è°·åŒº',
          'é›»è©±ç•ªå·: 090-1234-5678'
        ];
        
        const results = [];
        
        for (const data of sensitiveData) {
          const encrypted = await persistenceManager.encryptData(data);
          const decrypted = await persistenceManager.decryptData(encrypted);
          
          results.push({
            original: data,
            encrypted: encrypted,
            decrypted: decrypted,
            success: decrypted === data,
            encryptedLength: encrypted.length
          });
        }
        
        const testTime = endTimer();
        const allSuccessful = results.every(r => r.success);
        
        const result = {
          success: allSuccessful,
          testResults: results,
          testTime: testTime,
          encryptionEnabled: !!persistenceManager.encryptionKey
        };
        
        testResults.push({
          test: 'dataEncryption',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('securityResults', result, result.success ? 'success' : 'error');
        log(`ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ãƒ†ã‚¹ãƒˆ ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}: ${results.length}ä»¶ãƒ†ã‚¹ãƒˆ (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'error');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('securityResults', errorResult, 'error');
        log(`ãƒ‡ãƒ¼ã‚¿æš—å·åŒ–ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿åŒ¿ååŒ–ãƒ†ã‚¹ãƒˆ
    async function testDataAnonymization() {
      log('ãƒ‡ãƒ¼ã‚¿åŒ¿ååŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const userData = {
          name: 'ç”°ä¸­å¤ªéƒ',
          email: 'tanaka@example.com',
          phone: '090-1234-5678',
          address: 'æ±äº¬éƒ½æ¸‹è°·åŒº1-2-3',
          age: 35,
          userId: 'user123',
          location: {
            prefecture: 'æ±äº¬éƒ½',
            city: 'æ¸‹è°·åŒº'
          },
          ipAddress: '192.168.1.1'
        };
        
        const anonymized = persistenceManager.anonymizeUserData(userData);
        const testTime = endTimer();
        
        // åŒ¿ååŒ–ãƒã‚§ãƒƒã‚¯
        const hasPersonalInfo = [
          'name', 'email', 'phone', 'address', 'ipAddress'
        ].some(field => anonymized.hasOwnProperty(field));
        
        const result = {
          success: !hasPersonalInfo,
          originalData: userData,
          anonymizedData: anonymized,
          removedFields: Object.keys(userData).filter(key => !anonymized.hasOwnProperty(key)),
          testTime: testTime
        };
        
        testResults.push({
          test: 'dataAnonymization',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('securityResults', result, result.success ? 'success' : 'error');
        log(`ãƒ‡ãƒ¼ã‚¿åŒ¿ååŒ–ãƒ†ã‚¹ãƒˆ ${result.success ? 'æˆåŠŸ' : 'å¤±æ•—'}: ${result.removedFields.length}é …ç›®å‰Šé™¤ (${testTime.toFixed(2)}ms)`, 
            result.success ? 'success' : 'error');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('securityResults', errorResult, 'error');
        log(`ãƒ‡ãƒ¼ã‚¿åŒ¿ååŒ–ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // è‡ªå‹•å‰Šé™¤ãƒ†ã‚¹ãƒˆ
    async function testAutoCleanup() {
      log('è‡ªå‹•å‰Šé™¤ãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      startTimer();
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        // æ‰‹å‹•ã§è‡ªå‹•å‰Šé™¤ã‚’å®Ÿè¡Œ
        await persistenceManager.performAutoCleanup();
        const testTime = endTimer();
        
        const stats = persistenceManager.getPerformanceStatistics();
        
        const result = {
          success: true,
          deletedRecords: stats.maintenance.deletedRecords,
          retentionDays: stats.maintenance.retentionDays,
          testTime: testTime,
          maintenanceInfo: stats.maintenance
        };
        
        testResults.push({
          test: 'autoCleanup',
          success: result.success,
          time: testTime,
          details: result
        });
        
        showResults('securityResults', result, 'success');
        log(`è‡ªå‹•å‰Šé™¤ãƒ†ã‚¹ãƒˆå®Œäº†: ${result.deletedRecords}ä»¶å‰Šé™¤ (${testTime.toFixed(2)}ms)`, 'success');
        
        return result;
        
      } catch (error) {
        const testTime = endTimer();
        const errorResult = { success: false, error: error.message };
        
        showResults('securityResults', errorResult, 'error');
        log(`è‡ªå‹•å‰Šé™¤ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`, 'error');
        
        return errorResult;
      }
    }
    
    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç·åˆãƒ†ã‚¹ãƒˆ
    async function runSecurityTests() {
      log('ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç·åˆãƒ†ã‚¹ãƒˆé–‹å§‹', 'info');
      
      const results = {
        dataEncryption: await testDataEncryption(),
        dataAnonymization: await testDataAnonymization(),
        autoCleanup: await testAutoCleanup()
      };
      
      const allSuccessful = Object.values(results).every(r => r.success);
      
      showResults('securityResults', results, allSuccessful ? 'success' : 'warning');
      log(`ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç·åˆãƒ†ã‚¹ãƒˆçµæœ: ${allSuccessful ? 'å…¨ã¦æˆåŠŸ' : 'ä¸€éƒ¨å¤±æ•—'}`, 
          allSuccessful ? 'success' : 'warning');
      
      return results;
    }
    
    // çµ±è¨ˆè¡¨ç¤º
    async function showStatistics() {
      log('çµ±è¨ˆæƒ…å ±å–å¾—ä¸­', 'info');
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const stats = persistenceManager.getPerformanceStatistics();
        
        // çµ±è¨ˆã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        const statsGrid = document.getElementById('statsGrid');
        statsGrid.innerHTML = `
          <div class="stat-card">
            <h3>ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹</h3>
            <div class="stat-value">${stats.database.name}</div>
            <p>ãƒãƒ¼ã‚¸ãƒ§ãƒ³: ${stats.database.version}</p>
            <p>åˆæœŸåŒ–çŠ¶æ…‹: ${stats.database.initialized ? 'å®Œäº†' : 'æœªå®Œäº†'}</p>
          </div>
          
          <div class="stat-card">
            <h3>âš¡ æ“ä½œçµ±è¨ˆ</h3>
            <div class="stat-value">${stats.operations.total}</div>
            <p>æˆåŠŸç‡: ${stats.operations.successRate.toFixed(1)}%</p>
            <p>å¹³å‡æ™‚é–“: ${stats.operations.averageTime.toFixed(2)}ms</p>
          </div>
          
          <div class="stat-card">
            <h3>ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£</h3>
            <div class="stat-value">${stats.security.encryptionEnabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</div>
            <p>æš—å·åŒ–ãƒ¬ã‚³ãƒ¼ãƒ‰: ${stats.security.encryptedRecords}ä»¶</p>
          </div>
          
          <div class="stat-card">
            <h3>ğŸ§¹ ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹</h3>
            <div class="stat-value">${stats.maintenance.deletedRecords}</div>
            <p>å‰Šé™¤ã•ã‚ŒãŸãƒ¬ã‚³ãƒ¼ãƒ‰æ•°</p>
            <p>ä¿æŒæœŸé–“: ${stats.maintenance.retentionDays}æ—¥</p>
          </div>
          
          <div class="stat-card">
            <h3>ğŸ’¾ ã‚­ãƒ£ãƒƒã‚·ãƒ¥</h3>
            <div class="stat-value">${stats.cache.currentSize}/${stats.cache.maxSize}</div>
            <p>ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½¿ç”¨ç‡</p>
            <p>çŠ¶æ…‹: ${stats.cache.enabled ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</p>
          </div>
          
          <div class="stat-card">
            <h3>ğŸ§ª ãƒ†ã‚¹ãƒˆçµæœ</h3>
            <div class="stat-value">${testResults.length}</div>
            <p>å®Ÿè¡Œæ¸ˆã¿ãƒ†ã‚¹ãƒˆæ•°</p>
            <p>æˆåŠŸç‡: ${testResults.length > 0 ? 
              (testResults.filter(t => t.success).length / testResults.length * 100).toFixed(1) : 0}%</p>
          </div>
        `;
        
        showResults('monitoringResults', stats, 'success');
        log('çµ±è¨ˆæƒ…å ±è¡¨ç¤ºå®Œäº†', 'success');
        
      } catch (error) {
        log(`çµ±è¨ˆæƒ…å ±å–å¾—å¤±æ•—: ${error.message}`, 'error');
      }
    }
    
    // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±è¡¨ç¤º
    async function showDatabaseInfo() {
      log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±å–å¾—ä¸­', 'info');
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const stats = persistenceManager.getPerformanceStatistics();
        const info = {
          database: stats.database,
          schema: persistenceManager.dbSchema,
          config: {
            retentionDays: persistenceManager.dataRetentionDays,
            maxRecords: persistenceManager.maxRecords,
            batchSize: persistenceManager.batchSize,
            cacheEnabled: persistenceManager.cacheEnabled,
            maxCacheSize: persistenceManager.maxCacheSize
          }
        };
        
        showResults('monitoringResults', info, 'success');
        log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±è¡¨ç¤ºå®Œäº†', 'success');
        
      } catch (error) {
        showResults('monitoringResults', { error: error.message }, 'error');
        log(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æƒ…å ±å–å¾—å¤±æ•—: ${error.message}`, 'error');
      }
    }
    
    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
    async function clearAllData() {
      if (!confirm('å…¨ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        return;
      }
      
      log('å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢é–‹å§‹', 'warning');
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’é–‰ã˜ã¦å†åˆæœŸåŒ–
        persistenceManager.close();
        
        // IndexedDBã‚’å‰Šé™¤
        const deleteRequest = indexedDB.deleteDatabase(persistenceManager.dbName);
        
        deleteRequest.onsuccess = async () => {
          log('ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‰Šé™¤å®Œäº†', 'success');
          
          // å†åˆæœŸåŒ–
          persistenceManager = new DataPersistenceManager();
          await persistenceManager.initialize();
          
          // çµ±è¨ˆãƒªã‚»ãƒƒãƒˆ
          testResults.length = 0;
          performanceMetrics.length = 0;
          window.testAnalysisId = null;
          
          showResults('monitoringResults', { message: 'å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†' }, 'success');
          log('å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Œäº†', 'success');
        };
        
        deleteRequest.onerror = () => {
          log(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å‰Šé™¤ã‚¨ãƒ©ãƒ¼: ${deleteRequest.error}`, 'error');
        };
        
      } catch (error) {
        log(`å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å¤±æ•—: ${error.message}`, 'error');
      }
    }
    
    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆ
    async function createBackup() {
      log('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆé–‹å§‹', 'info');
      
      try {
        if (!persistenceManager) {
          await testInitialization();
        }
        
        const backupResult = await persistenceManager.createBackup();
        
        if (backupResult.success) {
          // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ãªå½¢å¼ã§æä¾›
          const backupJson = JSON.stringify(backupResult.backup, null, 2);
          const blob = new Blob([backupJson], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          
          const a = document.createElement('a');
          a.href = url;
          a.download = `haqei_backup_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          
          showResults('monitoringResults', backupResult, 'success');
          log(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå®Œäº†: ${backupResult.totalRecords}ä»¶ (${backupResult.backupTime.toFixed(2)}ms)`, 'success');
        } else {
          showResults('monitoringResults', backupResult, 'error');
          log(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆå¤±æ•—: ${backupResult.error}`, 'error');
        }
        
      } catch (error) {
        log(`ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä½œæˆã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
      }
    }
    
    // ãƒ­ã‚°ã‚¯ãƒªã‚¢
    function clearLogs() {
      document.getElementById('testLogs').innerHTML = '';
      log('ãƒ­ã‚°ã‚¯ãƒªã‚¢å®Œäº†', 'info');
    }
    
    // ãƒ†ã‚¹ãƒˆçµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
    function exportTestResults() {
      const exportData = {
        timestamp: new Date().toISOString(),
        testResults: testResults,
        performanceMetrics: performanceMetrics,
        summary: {
          totalTests: testResults.length,
          successfulTests: testResults.filter(t => t.success).length,
          failedTests: testResults.filter(t => !t.success).length,
          totalTime: testResults.reduce((sum, t) => sum + t.time, 0)
        }
      };
      
      const json = JSON.stringify(exportData, null, 2);
      const blob = new Blob([json], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const a = document.createElement('a');
      a.href = url;
      a.download = `haqei_test_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      log('ãƒ†ã‚¹ãƒˆçµæœã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†', 'success');
    }
    
    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('load', function() {
      log('DataPersistenceManager ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆé–‹å§‹', 'info');
      log('å„ãƒ†ã‚¹ãƒˆãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„', 'info');
    });
  </script>
</body>
</html>