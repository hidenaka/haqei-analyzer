<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Triple OS Debug</title>
    <style>
        body { 
            background: #222; 
            color: #fff; 
            font-family: monospace; 
            padding: 20px;
        }
        button { 
            background: #444; 
            color: #fff; 
            border: 1px solid #666; 
            padding: 10px 20px; 
            margin: 5px;
            cursor: pointer;
        }
        button:hover { background: #555; }
        pre { 
            background: #111; 
            padding: 10px; 
            border: 1px solid #444; 
            overflow: auto;
            max-height: 400px;
        }
        .success { color: #4f0; }
        .error { color: #f44; }
        .info { color: #4af; }
    </style>
</head>
<body>
    <h1>Triple OS デバッグツール</h1>
    
    <div>
        <button onclick="runDirectTripleOSTest()">TripleOSEngine直接テスト</button>
        <button onclick="runUltraAnalysisTest()">UltraAnalysisEngineテスト</button>
        <button onclick="checkLocalStorage()">LocalStorage確認</button>
        <button onclick="clearAll()">全データクリア</button>
    </div>
    
    <pre id="output"></pre>

    <!-- 必要なスクリプトを読み込み -->
    <script src="js/shared/core/SimpleStorageManager.js"></script>
    <script src="js/shared/utils/DataFlowMonitor.js"></script>
    <script src="js/shared/utils/SimpleHooks.js"></script>
    <script src="js/shared/core/DataManager.js"></script>
    <script src="js/shared/os-analyzer/Calculator.js"></script>
    <script src="js/shared/os-analyzer/IChingCompatibilityDataLoader.js"></script>
    <script src="js/os-analyzer/core/Engine.js"></script>
    <script src="js/os-analyzer/core/IChingUltraSyncLogic.js"></script>
    <script src="js/os-analyzer/core/TripleOSEngine.js"></script>
    <script src="js/os-analyzer/core/UltraAnalysisEngine.js"></script>
    <script src="js/shared/core/MicroStorageManager.js"></script>
    <script src="js/shared/core/StorageManager.js"></script>

    <script>
        const output = document.getElementById('output');
        
        function log(msg, type = 'info') {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            output.innerHTML += `<span class="${className}">${msg}</span>\n`;
            console.log(msg);
        }
        
        function clearOutput() {
            output.innerHTML = '';
        }
        
        // テスト用回答データ（正しいフォーマット）
        function generateTestAnswers() {
            const answers = [];
            for (let i = 1; i <= 30; i++) {
                const choices = ['a', 'b', 'c', 'd'];
                const choice = choices[Math.floor(Math.random() * 4)];
                answers.push({
                    questionId: `q${i}`,
                    selectedChoice: `q${i}${choice}`,
                    choiceText: `選択肢${choice.toUpperCase()}のテキスト`,
                    selectedValue: choice.toUpperCase(),
                    timestamp: new Date().toISOString()
                });
            }
            return answers;
        }
        
        async function runDirectTripleOSTest() {
            clearOutput();
            log('=== TripleOSEngine 直接テスト開始 ===', 'info');
            
            try {
                // DataManager初期化
                log('DataManager初期化中...', 'info');
                const dataManager = new DataManager();
                await dataManager.loadAllData();
                log('DataManager初期化完了', 'success');
                
                // TripleOSEngine初期化
                log('TripleOSEngine初期化中...', 'info');
                const tripleOSEngine = new TripleOSEngine(dataManager);
                log('TripleOSEngine初期化完了', 'success');
                
                // テスト回答生成
                const testAnswers = generateTestAnswers();
                log(`テスト回答生成: ${testAnswers.length}問`, 'info');
                log('回答フォーマット例:', 'info');
                log(JSON.stringify(testAnswers[0], null, 2), 'info');
                
                // 分析実行
                log('\n分析実行中...', 'info');
                const startTime = Date.now();
                const result = await tripleOSEngine.analyzeUser(testAnswers);
                const endTime = Date.now();
                
                log(`分析完了 (${endTime - startTime}ms)`, 'success');
                
                // 結果確認
                log('\n=== 分析結果 ===', 'info');
                log(`analysisType: ${result?.analysisType || 'なし'}`, 'info');
                log(`engineOS: ${result?.engineOS ? '✅' : '❌'}`, result?.engineOS ? 'success' : 'error');
                log(`interfaceOS: ${result?.interfaceOS ? '✅' : '❌'}`, result?.interfaceOS ? 'success' : 'error');
                log(`safeModeOS: ${result?.safeModeOS ? '✅' : '❌'}`, result?.safeModeOS ? 'success' : 'error');
                log(`primaryOS: ${result?.primaryOS ? '✅' : '❌'}`, result?.primaryOS ? 'success' : 'error');
                
                if (result?.engineOS) {
                    log('\nEngine OS詳細:', 'info');
                    log(JSON.stringify(result.engineOS, null, 2), 'info');
                }
                
                // StorageManagerで保存
                log('\n保存テスト...', 'info');
                const storageManager = new StorageManager();
                const saveSuccess = storageManager.saveAnalysisResult(result);
                log(`保存結果: ${saveSuccess ? '成功' : '失敗'}`, saveSuccess ? 'success' : 'error');
                
                // 保存確認
                const saved = storageManager.getAnalysisResult();
                log(`読み取り確認: ${saved ? '成功' : '失敗'}`, saved ? 'success' : 'error');
                
            } catch (error) {
                log(`エラー: ${error.message}`, 'error');
                log(error.stack, 'error');
            }
        }
        
        async function runUltraAnalysisTest() {
            clearOutput();
            log('=== UltraAnalysisEngine テスト開始 ===', 'info');
            
            try {
                // DataManager初期化
                log('DataManager初期化中...', 'info');
                const dataManager = new DataManager();
                await dataManager.loadAllData();
                log('DataManager初期化完了', 'success');
                
                // UltraAnalysisEngine初期化
                log('UltraAnalysisEngine初期化中...', 'info');
                const ultraEngine = new UltraAnalysisEngine(dataManager);
                log('UltraAnalysisEngine初期化完了', 'success');
                
                // テスト回答生成
                const testAnswers = generateTestAnswers();
                log(`テスト回答生成: ${testAnswers.length}問`, 'info');
                
                // analyzeTripleOS実行
                log('\nanalyzeTripleOS実行中...', 'info');
                const startTime = Date.now();
                const result = await ultraEngine.analyzeTripleOS(testAnswers);
                const endTime = Date.now();
                
                log(`分析完了 (${endTime - startTime}ms)`, 'success');
                
                // 結果確認
                log('\n=== 分析結果 ===', 'info');
                log(`analysisType: ${result?.analysisType || 'なし'}`, 'info');
                log(`engineOS: ${result?.engineOS ? '✅' : '❌'}`, result?.engineOS ? 'success' : 'error');
                log(`interfaceOS: ${result?.interfaceOS ? '✅' : '❌'}`, result?.interfaceOS ? 'success' : 'error');
                log(`safeModeOS: ${result?.safeModeOS ? '✅' : '❌'}`, result?.safeModeOS ? 'success' : 'error');
                
                log('\n完全な結果:', 'info');
                log(JSON.stringify(result, null, 2), 'info');
                
            } catch (error) {
                log(`エラー: ${error.message}`, 'error');
                log(error.stack, 'error');
            }
        }
        
        function checkLocalStorage() {
            clearOutput();
            log('=== LocalStorage 確認 ===', 'info');
            
            const keys = [
                'haqei_analysis_result',
                'haqei_diagnosis_result',
                'haqei_simple_analysis_result',
                'haqei_answers',
                'haqei_session'
            ];
            
            keys.forEach(key => {
                const value = localStorage.getItem(key);
                if (value) {
                    try {
                        const parsed = JSON.parse(value);
                        log(`\n${key}:`, 'success');
                        
                        // Triple OSデータの確認
                        if (parsed.engineOS || parsed.interfaceOS || parsed.safeModeOS) {
                            log('  Triple OSデータ: あり', 'success');
                            log(`  - engineOS: ${parsed.engineOS ? '✅' : '❌'}`, 'info');
                            log(`  - interfaceOS: ${parsed.interfaceOS ? '✅' : '❌'}`, 'info');
                            log(`  - safeModeOS: ${parsed.safeModeOS ? '✅' : '❌'}`, 'info');
                        }
                        
                        // データサイズ
                        log(`  サイズ: ${value.length} bytes`, 'info');
                        log(`  キー数: ${Object.keys(parsed).length}`, 'info');
                        
                        // 最初の100文字を表示
                        log(`  データ: ${JSON.stringify(parsed).substring(0, 200)}...`, 'info');
                        
                    } catch (e) {
                        log(`${key}: JSONパースエラー`, 'error');
                    }
                } else {
                    log(`${key}: なし`, 'error');
                }
            });
        }
        
        function clearAll() {
            if (confirm('すべてのデータを削除しますか？')) {
                localStorage.clear();
                sessionStorage.clear();
                clearOutput();
                log('すべてのデータを削除しました', 'success');
            }
        }
    </script>
</body>
</html>