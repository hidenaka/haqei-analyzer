<!DOCTYPE html>\n<html lang=\"ja\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>Offline Dictionary System Test - HAQEI Analyzer</title>\n    <style>\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            margin: 0;\n            padding: 20px;\n            min-height: 100vh;\n        }\n        .container {\n            max-width: 1200px;\n            margin: 0 auto;\n        }\n        .header {\n            text-align: center;\n            margin-bottom: 40px;\n        }\n        .test-section {\n            background: rgba(255, 255, 255, 0.1);\n            border-radius: 12px;\n            padding: 20px;\n            margin-bottom: 20px;\n            backdrop-filter: blur(10px);\n        }\n        .test-grid {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));\n            gap: 20px;\n        }\n        .test-card {\n            background: rgba(255, 255, 255, 0.05);\n            border-radius: 8px;\n            padding: 16px;\n            border: 1px solid rgba(255, 255, 255, 0.2);\n        }\n        .status {\n            display: inline-block;\n            padding: 4px 8px;\n            border-radius: 4px;\n            font-size: 12px;\n            font-weight: 600;\n            text-transform: uppercase;\n        }\n        .status.success { background: #10b981; }\n        .status.error { background: #ef4444; }\n        .status.warning { background: #f59e0b; }\n        .status.info { background: #3b82f6; }\n        .button {\n            background: linear-gradient(135deg, #6366f1, #8b5cf6);\n            color: white;\n            border: none;\n            padding: 10px 20px;\n            border-radius: 6px;\n            cursor: pointer;\n            font-weight: 600;\n            margin: 5px;\n        }\n        .button:hover {\n            transform: translateY(-1px);\n            box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n        }\n        .log {\n            background: rgba(0, 0, 0, 0.3);\n            border-radius: 6px;\n            padding: 12px;\n            font-family: 'Monaco', 'Consolas', monospace;\n            font-size: 12px;\n            max-height: 200px;\n            overflow-y: auto;\n            margin-top: 10px;\n        }\n        .progress-bar {\n            background: rgba(255, 255, 255, 0.2);\n            border-radius: 10px;\n            height: 20px;\n            overflow: hidden;\n            margin: 10px 0;\n        }\n        .progress-fill {\n            background: linear-gradient(90deg, #10b981, #059669);\n            height: 100%;\n            transition: width 0.3s ease;\n        }\n        .metrics {\n            display: grid;\n            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));\n            gap: 10px;\n            margin-top: 15px;\n        }\n        .metric {\n            text-align: center;\n            padding: 10px;\n            background: rgba(255, 255, 255, 0.1);\n            border-radius: 6px;\n        }\n        .metric-value {\n            font-size: 24px;\n            font-weight: 700;\n            color: #10b981;\n        }\n        .metric-label {\n            font-size: 12px;\n            opacity: 0.8;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1>🧪 オフライン辞書システム テスト</h1>\n            <p>HAQEI Analyzer - Offline Dictionary Test Suite</p>\n        </div>\n\n        <!-- System Status -->\n        <div class=\"test-section\">\n            <h2>📊 システム状態</h2>\n            <div class=\"test-grid\">\n                <div class=\"test-card\">\n                    <h3>接続状態</h3>\n                    <div id=\"connectionStatus\">チェック中...</div>\n                    <div class=\"metrics\">\n                        <div class=\"metric\">\n                            <div class=\"metric-value\" id=\"connectionQuality\">-</div>\n                            <div class=\"metric-label\">接続品質</div>\n                        </div>\n                        <div class=\"metric\">\n                            <div class=\"metric-value\" id=\"onlineStatus\">-</div>\n                            <div class=\"metric-label\">オンライン</div>\n                        </div>\n                    </div>\n                </div>\n                <div class=\"test-card\">\n                    <h3>辞書システム</h3>\n                    <div id=\"dictionaryStatus\">初期化中...</div>\n                    <div class=\"metrics\">\n                        <div class=\"metric\">\n                            <div class=\"metric-value\" id=\"tokenizerType\">-</div>\n                            <div class=\"metric-label\">トークナイザー</div>\n                        </div>\n                        <div class=\"metric\">\n                            <div class=\"metric-value\" id=\"dictionarySource\">-</div>\n                            <div class=\"metric-label\">辞書ソース</div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Dictionary Tests -->\n        <div class=\"test-section\">\n            <h2>📚 辞書機能テスト</h2>\n            <div class=\"test-grid\">\n                <div class=\"test-card\">\n                    <h3>ローカル辞書テスト</h3>\n                    <button class=\"button\" onclick=\"testLocalDictionary()\">ローカル辞書をテスト</button>\n                    <div id=\"localDictResult\">未実行</div>\n                </div>\n                <div class=\"test-card\">\n                    <h3>CDN辞書テスト</h3>\n                    <button class=\"button\" onclick=\"testCDNDictionary()\">CDN辞書をテスト</button>\n                    <div id=\"cdnDictResult\">未実行</div>\n                </div>\n                <div class=\"test-card\">\n                    <h3>フォールバックテスト</h3>\n                    <button class=\"button\" onclick=\"testFallbackSystem()\">フォールバックをテスト</button>\n                    <div id=\"fallbackResult\">未実行</div>\n                </div>\n                <div class=\"test-card\">\n                    <h3>オフライン切り替えテスト</h3>\n                    <button class=\"button\" onclick=\"simulateOffline()\">オフライン状態をシミュレート</button>\n                    <div id=\"offlineResult\">未実行</div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Performance Tests -->\n        <div class=\"test-section\">\n            <h2>⚡ パフォーマンステスト</h2>\n            <div class=\"test-grid\">\n                <div class=\"test-card\">\n                    <h3>初期化速度テスト</h3>\n                    <button class=\"button\" onclick=\"testInitializationSpeed()\">初期化速度を測定</button>\n                    <div class=\"progress-bar\">\n                        <div class=\"progress-fill\" id=\"initProgress\" style=\"width: 0%\"></div>\n                    </div>\n                    <div id=\"initSpeedResult\">未実行</div>\n                </div>\n                <div class=\"test-card\">\n                    <h3>トークナイズ速度テスト</h3>\n                    <button class=\"button\" onclick=\"testTokenizationSpeed()\">トークナイズ速度を測定</button>\n                    <div class=\"progress-bar\">\n                        <div class=\"progress-fill\" id=\"tokenizeProgress\" style=\"width: 0%\"></div>\n                    </div>\n                    <div id=\"tokenizeSpeedResult\">未実行</div>\n                </div>\n            </div>\n        </div>\n\n        <!-- Text Analysis Test -->\n        <div class=\"test-section\">\n            <h2>📝 テキスト解析テスト</h2>\n            <div class=\"test-card\">\n                <h3>実際のテキスト解析</h3>\n                <textarea id=\"testText\" placeholder=\"解析するテキストを入力してください...\" \n                         style=\"width: 100%; height: 100px; padding: 10px; border-radius: 6px; border: none; background: rgba(255,255,255,0.1); color: white; resize: vertical;\">私は今日、美しい桜の花を見ながら公園を散歩しました。春の暖かな陽気に包まれて、とても幸せな気分になりました。</textarea>\n                <button class=\"button\" onclick=\"analyzeTestText()\">テキストを解析</button>\n                <div id=\"analysisResult\"></div>\n            </div>\n        </div>\n\n        <!-- System Log -->\n        <div class=\"test-section\">\n            <h2>📋 システムログ</h2>\n            <div class=\"log\" id=\"systemLog\"></div>\n            <div style=\"margin-top: 10px;\">\n                <button class=\"button\" onclick=\"clearLog()\">ログをクリア</button>\n                <button class=\"button\" onclick=\"exportLog()\">ログをエクスポート</button>\n            </div>\n        </div>\n    </div>\n\n    <!-- Scripts -->\n    <script src=\"./js/core/DictionaryManager.js\"></script>\n    <script src=\"./js/core/OfflineDetector.js\"></script>\n    <script src=\"./js/core/OfflineKuromojiInitializer.js\"></script>\n    <script src=\"./js/core/offline-kuromoji-integration.js\"></script>\n    <script src=\"https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/build/kuromoji.js\"></script>\n\n    <script>\n        let testResults = {};\n        let offlineDetector = null;\n        let dictionaryManager = null;\n        let offlineInitializer = null;\n\n        // Initialize test environment\n        window.addEventListener('load', async () => {\n            log('🚀 Test environment initializing...');\n            \n            try {\n                // Initialize offline detector\n                if (typeof OfflineDetector !== 'undefined') {\n                    offlineDetector = new OfflineDetector();\n                    log('✅ OfflineDetector initialized');\n                } else {\n                    log('❌ OfflineDetector not available');\n                }\n\n                // Initialize dictionary manager\n                if (typeof DictionaryManager !== 'undefined') {\n                    dictionaryManager = new DictionaryManager();\n                    log('✅ DictionaryManager initialized');\n                } else {\n                    log('❌ DictionaryManager not available');\n                }\n\n                // Initialize offline kuromoji initializer\n                if (typeof OfflineKuromojiInitializer !== 'undefined') {\n                    offlineInitializer = new OfflineKuromojiInitializer();\n                    log('✅ OfflineKuromojiInitializer initialized');\n                } else {\n                    log('❌ OfflineKuromojiInitializer not available');\n                }\n\n                // Update system status\n                updateSystemStatus();\n                \n                log('✅ Test environment ready');\n            } catch (error) {\n                log(`❌ Test environment initialization failed: ${error.message}`);\n            }\n        });\n\n        function log(message) {\n            const timestamp = new Date().toLocaleTimeString();\n            const logElement = document.getElementById('systemLog');\n            logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;\n            logElement.scrollTop = logElement.scrollHeight;\n            console.log(message);\n        }\n\n        function clearLog() {\n            document.getElementById('systemLog').innerHTML = '';\n        }\n\n        function exportLog() {\n            const logContent = document.getElementById('systemLog').textContent;\n            const blob = new Blob([logContent], { type: 'text/plain' });\n            const url = URL.createObjectURL(blob);\n            const a = document.createElement('a');\n            a.href = url;\n            a.download = `offline-dictionary-test-${new Date().toISOString().slice(0,19)}.log`;\n            a.click();\n            URL.revokeObjectURL(url);\n        }\n\n        async function updateSystemStatus() {\n            // Update connection status\n            if (offlineDetector) {\n                const status = offlineDetector.getStatus();\n                const statusMsg = offlineDetector.getStatusMessage();\n                \n                document.getElementById('connectionStatus').innerHTML = `\n                    <span class=\"status ${status.isOnline ? 'success' : 'error'}\">\n                        ${status.isOnline ? 'オンライン' : 'オフライン'}\n                    </span>\n                    <p>${statusMsg.message}</p>\n                `;\n                \n                document.getElementById('connectionQuality').textContent = status.connectionQuality || '-';\n                document.getElementById('onlineStatus').textContent = status.isOnline ? 'YES' : 'NO';\n            }\n\n            // Update dictionary status\n            if (offlineInitializer) {\n                const status = offlineInitializer.getStatus();\n                \n                document.getElementById('dictionaryStatus').innerHTML = `\n                    <span class=\"status ${status.isInitialized ? 'success' : 'warning'}\">\n                        ${status.isInitialized ? '初期化済み' : '未初期化'}\n                    </span>\n                `;\n                \n                document.getElementById('tokenizerType').textContent = status.tokenizerSource || '-';\n                document.getElementById('dictionarySource').textContent = status.isLocal ? 'ローカル' : 'CDN';\n            }\n        }\n\n        async function testLocalDictionary() {\n            log('📁 Testing local dictionary...');\n            const resultElement = document.getElementById('localDictResult');\n            \n            try {\n                const startTime = Date.now();\n                \n                if (!dictionaryManager) {\n                    throw new Error('DictionaryManager not available');\n                }\n                \n                const tokenizer = await dictionaryManager.tryLocalDictionary();\n                const duration = Date.now() - startTime;\n                \n                if (tokenizer) {\n                    resultElement.innerHTML = `\n                        <span class=\"status success\">成功</span>\n                        <p>読み込み時間: ${duration}ms</p>\n                    `;\n                    log(`✅ Local dictionary test successful (${duration}ms)`);\n                } else {\n                    throw new Error('Local dictionary initialization failed');\n                }\n                \n            } catch (error) {\n                resultElement.innerHTML = `\n                    <span class=\"status error\">失敗</span>\n                    <p>${error.message}</p>\n                `;\n                log(`❌ Local dictionary test failed: ${error.message}`);\n            }\n        }\n\n        async function testCDNDictionary() {\n            log('🌐 Testing CDN dictionary...');\n            const resultElement = document.getElementById('cdnDictResult');\n            \n            try {\n                const startTime = Date.now();\n                \n                if (!dictionaryManager) {\n                    throw new Error('DictionaryManager not available');\n                }\n                \n                const success = await dictionaryManager.tryCDNDictionary();\n                const duration = Date.now() - startTime;\n                \n                if (success) {\n                    resultElement.innerHTML = `\n                        <span class=\"status success\">成功</span>\n                        <p>読み込み時間: ${duration}ms</p>\n                    `;\n                    log(`✅ CDN dictionary test successful (${duration}ms)`);\n                } else {\n                    throw new Error('CDN dictionary initialization failed');\n                }\n                \n            } catch (error) {\n                resultElement.innerHTML = `\n                    <span class=\"status error\">失敗</span>\n                    <p>${error.message}</p>\n                `;\n                log(`❌ CDN dictionary test failed: ${error.message}`);\n            }\n        }\n\n        async function testFallbackSystem() {\n            log('🔄 Testing fallback system...');\n            const resultElement = document.getElementById('fallbackResult');\n            \n            try {\n                const startTime = Date.now();\n                \n                if (!offlineInitializer) {\n                    throw new Error('OfflineKuromojiInitializer not available');\n                }\n                \n                const tokenizer = await offlineInitializer.createEmergencyFallback();\n                const duration = Date.now() - startTime;\n                \n                if (tokenizer && tokenizer.isEmergency) {\n                    resultElement.innerHTML = `\n                        <span class=\"status success\">成功</span>\n                        <p>フォールバック時間: ${duration}ms</p>\n                        <p>緊急トークナイザー作成完了</p>\n                    `;\n                    log(`✅ Fallback system test successful (${duration}ms)`);\n                } else {\n                    throw new Error('Emergency fallback creation failed');\n                }\n                \n            } catch (error) {\n                resultElement.innerHTML = `\n                    <span class=\"status error\">失敗</span>\n                    <p>${error.message}</p>\n                `;\n                log(`❌ Fallback system test failed: ${error.message}`);\n            }\n        }\n\n        function simulateOffline() {\n            log('📴 Simulating offline mode...');\n            const resultElement = document.getElementById('offlineResult');\n            \n            try {\n                // Simulate offline by overriding navigator.onLine\n                Object.defineProperty(navigator, 'onLine', {\n                    writable: true,\n                    value: false\n                });\n                \n                // Trigger offline event\n                const offlineEvent = new Event('offline');\n                window.dispatchEvent(offlineEvent);\n                \n                setTimeout(() => {\n                    updateSystemStatus();\n                    \n                    resultElement.innerHTML = `\n                        <span class=\"status warning\">オフライン</span>\n                        <p>オフラインモードをシミュレート中</p>\n                        <button class=\"button\" onclick=\"restoreOnline()\">オンラインに戻す</button>\n                    `;\n                    \n                    log('⚠️ Offline mode simulated');\n                }, 1000);\n                \n            } catch (error) {\n                resultElement.innerHTML = `\n                    <span class=\"status error\">失敗</span>\n                    <p>${error.message}</p>\n                `;\n                log(`❌ Offline simulation failed: ${error.message}`);\n            }\n        }\n\n        function restoreOnline() {\n            log('🌐 Restoring online mode...');\n            \n            Object.defineProperty(navigator, 'onLine', {\n                writable: true,\n                value: true\n            });\n            \n            const onlineEvent = new Event('online');\n            window.dispatchEvent(onlineEvent);\n            \n            setTimeout(() => {\n                updateSystemStatus();\n                document.getElementById('offlineResult').innerHTML = `\n                    <span class=\"status success\">オンライン復帰</span>\n                    <p>オンラインモードに復帰しました</p>\n                `;\n                log('✅ Online mode restored');\n            }, 1000);\n        }\n\n        async function testInitializationSpeed() {\n            log('⏱️ Testing initialization speed...');\n            const resultElement = document.getElementById('initSpeedResult');\n            const progressBar = document.getElementById('initProgress');\n            \n            try {\n                progressBar.style.width = '0%';\n                const startTime = Date.now();\n                \n                // Create new initializer for fresh test\n                const testInitializer = new OfflineKuromojiInitializer();\n                \n                // Set progress callback\n                testInitializer.setProgressCallback(({ message, progress }) => {\n                    if (progress !== null) {\n                        progressBar.style.width = `${progress}%`;\n                    }\n                });\n                \n                const tokenizer = await testInitializer.initialize({ showProgress: false });\n                const duration = Date.now() - startTime;\n                \n                progressBar.style.width = '100%';\n                \n                if (tokenizer) {\n                    resultElement.innerHTML = `\n                        <span class=\"status success\">成功</span>\n                        <p>初期化時間: ${duration}ms</p>\n                        <p>ソース: ${tokenizer.source || 'unknown'}</p>\n                    `;\n                    log(`✅ Initialization speed test: ${duration}ms`);\n                } else {\n                    throw new Error('Initialization failed');\n                }\n                \n            } catch (error) {\n                progressBar.style.width = '0%';\n                resultElement.innerHTML = `\n                    <span class=\"status error\">失敗</span>\n                    <p>${error.message}</p>\n                `;\n                log(`❌ Initialization speed test failed: ${error.message}`);\n            }\n        }\n\n        async function testTokenizationSpeed() {\n            log('⚡ Testing tokenization speed...');\n            const resultElement = document.getElementById('tokenizeSpeedResult');\n            const progressBar = document.getElementById('tokenizeProgress');\n            \n            try {\n                if (!window.kuromojiTokenizer) {\n                    throw new Error('Tokenizer not available');\n                }\n                \n                const testTexts = [\n                    '私は今日、美しい桜の花を見ながら公園を散歩しました。',\n                    '人工知能の発達により、様々な分野で自動化が進んでいます。',\n                    '日本の伝統的な文化と現代技術の融合は興味深い現象です。',\n                    'この文章は日本語の自然言語処理の性能をテストするために作成されました。',\n                    '機械学習とディープラーニングの技術は急速に進歩しています。'\n                ];\n                \n                let totalTime = 0;\n                let totalTokens = 0;\n                \n                for (let i = 0; i < testTexts.length; i++) {\n                    const startTime = Date.now();\n                    const tokens = window.kuromojiTokenizer.tokenize(testTexts[i]);\n                    const duration = Date.now() - startTime;\n                    \n                    totalTime += duration;\n                    totalTokens += tokens.length;\n                    \n                    const progress = ((i + 1) / testTexts.length) * 100;\n                    progressBar.style.width = `${progress}%`;\n                    \n                    await new Promise(resolve => setTimeout(resolve, 50)); // Small delay for UI\n                }\n                \n                const avgTime = totalTime / testTexts.length;\n                const tokensPerSecond = (totalTokens / totalTime) * 1000;\n                \n                resultElement.innerHTML = `\n                    <span class=\"status success\">成功</span>\n                    <p>平均処理時間: ${avgTime.toFixed(2)}ms</p>\n                    <p>総トークン数: ${totalTokens}</p>\n                    <p>処理速度: ${tokensPerSecond.toFixed(0)} tokens/sec</p>\n                `;\n                \n                log(`✅ Tokenization speed test: ${avgTime.toFixed(2)}ms avg, ${tokensPerSecond.toFixed(0)} tokens/sec`);\n                \n            } catch (error) {\n                progressBar.style.width = '0%';\n                resultElement.innerHTML = `\n                    <span class=\"status error\">失敗</span>\n                    <p>${error.message}</p>\n                `;\n                log(`❌ Tokenization speed test failed: ${error.message}`);\n            }\n        }\n\n        async function analyzeTestText() {\n            log('📝 Analyzing test text...');\n            const resultElement = document.getElementById('analysisResult');\n            const testText = document.getElementById('testText').value;\n            \n            if (!testText.trim()) {\n                alert('テキストを入力してください');\n                return;\n            }\n            \n            try {\n                if (!window.kuromojiTokenizer) {\n                    throw new Error('Tokenizer not available');\n                }\n                \n                const startTime = Date.now();\n                const tokens = window.kuromojiTokenizer.tokenize(testText);\n                const duration = Date.now() - startTime;\n                \n                const posCount = {};\n                tokens.forEach(token => {\n                    posCount[token.pos] = (posCount[token.pos] || 0) + 1;\n                });\n                \n                const posStats = Object.entries(posCount)\n                    .sort((a, b) => b[1] - a[1])\n                    .slice(0, 5)\n                    .map(([pos, count]) => `${pos}: ${count}個`)\n                    .join(', ');\n                \n                resultElement.innerHTML = `\n                    <div class=\"status success\">解析完了</div>\n                    <div class=\"metrics\">\n                        <div class=\"metric\">\n                            <div class=\"metric-value\">${tokens.length}</div>\n                            <div class=\"metric-label\">総トークン数</div>\n                        </div>\n                        <div class=\"metric\">\n                            <div class=\"metric-value\">${duration}</div>\n                            <div class=\"metric-label\">処理時間(ms)</div>\n                        </div>\n                        <div class=\"metric\">\n                            <div class=\"metric-value\">${Object.keys(posCount).length}</div>\n                            <div class=\"metric-label\">品詞種類</div>\n                        </div>\n                    </div>\n                    <p><strong>主要品詞:</strong> ${posStats}</p>\n                    <details>\n                        <summary>詳細なトークン情報</summary>\n                        <div class=\"log\">\n                            ${tokens.map(token => \n                                `${token.surface_form} (${token.pos}${token.pos_detail_1 !== '*' ? '/' + token.pos_detail_1 : ''})`\n                            ).join(', ')}\n                        </div>\n                    </details>\n                `;\n                \n                log(`✅ Text analysis completed: ${tokens.length} tokens, ${duration}ms`);\n                \n            } catch (error) {\n                resultElement.innerHTML = `\n                    <span class=\"status error\">失敗</span>\n                    <p>${error.message}</p>\n                `;\n                log(`❌ Text analysis failed: ${error.message}`);\n            }\n        }\n\n        // Auto-update system status every 30 seconds\n        setInterval(updateSystemStatus, 30000);\n    </script>\n</body>\n</html>"