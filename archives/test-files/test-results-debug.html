<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Results Debug Test</title>
    
    <!-- Base CSS -->
    <link rel="stylesheet" href="./css/main.css">
    <link rel="stylesheet" href="./css/components.css">
    
    <style>
        body {
            margin: 0;
            padding: 2rem;
            background: #111827;
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        
        .debug-section {
            background: rgba(31, 41, 55, 0.8);
            border: 1px solid rgba(75, 85, 99, 0.5);
            border-radius: 0.5rem;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .debug-title {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 1rem;
            color: #60a5fa;
        }
        
        .debug-item {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: rgba(17, 24, 39, 0.5);
            border-radius: 0.25rem;
            font-family: monospace;
            font-size: 0.875rem;
            overflow-x: auto;
        }
        
        .status-ok {
            color: #4ade80;
        }
        
        .status-error {
            color: #f87171;
        }
        
        .status-warning {
            color: #fbbf24;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        button:hover {
            background: #2563eb;
        }
        
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <h1>Results.html デバッグツール</h1>
    
    <div class="debug-section">
        <h2 class="debug-title">🔍 LocalStorage 診断</h2>
        <div id="storage-check"></div>
    </div>
    
    <div class="debug-section">
        <h2 class="debug-title">📊 分析結果データ構造</h2>
        <div id="data-structure"></div>
    </div>
    
    <div class="debug-section">
        <h2 class="debug-title">🧪 テストアクション</h2>
        <button onclick="createMockData()">モックデータ作成</button>
        <button onclick="testVirtualPersonaView()">VirtualPersonaView テスト</button>
        <button onclick="clearAllData()">全データクリア</button>
        <button onclick="goToAnalyzer()">診断ページへ</button>
        <button onclick="goToResults()">結果ページへ</button>
    </div>
    
    <div class="debug-section">
        <h2 class="debug-title">📝 ログ出力</h2>
        <div id="log-output" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
    
    <!-- 必要なスクリプトの読み込み -->
    <script src="./js/shared/core/BaseComponent.js"></script>
    <script src="./js/shared/core/StorageManager.js"></script>
    <script src="./js/shared/core/SimpleStorageManager.js"></script>
    
    <script>
        const logOutput = document.getElementById('log-output');
        
        function log(message, type = 'info') {
            const colors = {
                info: '#60a5fa',
                success: '#4ade80',
                error: '#f87171',
                warning: '#fbbf24'
            };
            
            const logItem = document.createElement('div');
            logItem.className = 'debug-item';
            logItem.style.color = colors[type] || colors.info;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logOutput.appendChild(logItem);
            logOutput.scrollTop = logOutput.scrollHeight;
        }
        
        function checkLocalStorage() {
            const storageCheck = document.getElementById('storage-check');
            storageCheck.innerHTML = '';
            
            const haqeiKeys = Object.keys(localStorage).filter(k => k.includes('haqei'));
            
            if (haqeiKeys.length === 0) {
                storageCheck.innerHTML = '<div class="debug-item status-error">❌ HAQEIデータが見つかりません</div>';
                log('LocalStorageにHAQEIデータがありません', 'error');
                return;
            }
            
            log(`LocalStorageに${haqeiKeys.length}個のHAQEIキーを発見`, 'info');
            
            haqeiKeys.forEach(key => {
                const value = localStorage.getItem(key);
                const itemDiv = document.createElement('div');
                itemDiv.className = 'debug-item';
                
                let status = '✅';
                let info = '';
                
                try {
                    if (value) {
                        const parsed = JSON.parse(value);
                        if (key === 'haqei_analysis_result') {
                            const hasTripleOS = !!(parsed.engineOS && parsed.interfaceOS && parsed.safeModeOS);
                            const hasResult = !!parsed.result;
                            
                            if (hasTripleOS) {
                                status = '✅';
                                info = 'Triple OS データ検出';
                            } else if (hasResult && parsed.result.engineOS) {
                                status = '✅';
                                info = 'result内にTriple OS データ検出';
                            } else {
                                status = '⚠️';
                                info = 'Triple OS データ不完全';
                            }
                        }
                        
                        const size = new Blob([value]).size;
                        itemDiv.innerHTML = `
                            <strong>${status} ${key}</strong><br>
                            タイプ: ${typeof parsed}<br>
                            サイズ: ${(size / 1024).toFixed(2)} KB<br>
                            ${info ? `状態: ${info}<br>` : ''}
                            キー: ${Object.keys(parsed).slice(0, 5).join(', ')}...
                        `;
                    } else {
                        itemDiv.innerHTML = `<strong>❌ ${key}</strong><br>値: null`;
                    }
                } catch (e) {
                    itemDiv.innerHTML = `<strong>⚠️ ${key}</strong><br>JSONパースエラー: ${e.message}`;
                }
                
                storageCheck.appendChild(itemDiv);
            });
        }
        
        function analyzeDataStructure() {
            const dataStructure = document.getElementById('data-structure');
            dataStructure.innerHTML = '';
            
            try {
                // StorageManagerで取得を試みる
                const storageManager = new StorageManager();
                const analysisResult = storageManager.getAnalysisResult();
                
                if (analysisResult) {
                    log('StorageManagerで分析結果を取得成功', 'success');
                    
                    const structureDiv = document.createElement('div');
                    structureDiv.className = 'debug-item';
                    
                    // データ構造の詳細分析
                    let html = '<strong>分析結果データ構造:</strong><br>';
                    
                    if (analysisResult.engineOS) {
                        html += '<span class="status-ok">✅ engineOS が存在</span><br>';
                        html += `  - name: ${analysisResult.engineOS.name || '未設定'}<br>`;
                        html += `  - description: ${analysisResult.engineOS.description?.substring(0, 50) || '未設定'}...<br>`;
                    } else {
                        html += '<span class="status-error">❌ engineOS が不足</span><br>';
                    }
                    
                    if (analysisResult.interfaceOS) {
                        html += '<span class="status-ok">✅ interfaceOS が存在</span><br>';
                        html += `  - name: ${analysisResult.interfaceOS.name || '未設定'}<br>`;
                        html += `  - description: ${analysisResult.interfaceOS.description?.substring(0, 50) || '未設定'}...<br>`;
                    } else {
                        html += '<span class="status-error">❌ interfaceOS が不足</span><br>';
                    }
                    
                    if (analysisResult.safeModeOS) {
                        html += '<span class="status-ok">✅ safeModeOS が存在</span><br>';
                        html += `  - name: ${analysisResult.safeModeOS.name || '未設定'}<br>`;
                        html += `  - description: ${analysisResult.safeModeOS.description?.substring(0, 50) || '未設定'}...<br>`;
                    } else {
                        html += '<span class="status-error">❌ safeModeOS が不足</span><br>';
                    }
                    
                    structureDiv.innerHTML = html;
                    dataStructure.appendChild(structureDiv);
                    
                    // 詳細なJSONビュー
                    const detailDiv = document.createElement('div');
                    detailDiv.className = 'debug-item';
                    detailDiv.innerHTML = '<strong>JSON構造（最初の100文字）:</strong><br><pre>' + 
                        JSON.stringify(analysisResult, null, 2).substring(0, 500) + '...</pre>';
                    dataStructure.appendChild(detailDiv);
                    
                } else {
                    dataStructure.innerHTML = '<div class="debug-item status-error">❌ 分析結果が取得できません</div>';
                    log('StorageManagerで分析結果を取得できませんでした', 'error');
                }
                
            } catch (error) {
                dataStructure.innerHTML = `<div class="debug-item status-error">❌ エラー: ${error.message}</div>`;
                log(`データ構造分析エラー: ${error.message}`, 'error');
            }
        }
        
        function createMockData() {
            log('モックデータ作成開始...', 'info');
            
            const mockAnalysisResult = {
                engineOS: {
                    name: "革新的エンジンOS",
                    description: "新しいアイデアと可能性を追求する創造的なOS",
                    traits: ["創造性", "革新性", "柔軟性"],
                    hexagram: 1
                },
                interfaceOS: {
                    name: "調和的インターフェースOS",
                    description: "人との繋がりと調和を重視する社会的なOS",
                    traits: ["共感性", "協調性", "コミュニケーション"],
                    hexagram: 2
                },
                safeModeOS: {
                    name: "守護的セーフモードOS",
                    description: "安全と安定を確保する防御的なOS",
                    traits: ["慎重さ", "分析力", "リスク管理"],
                    hexagram: 3
                },
                timestamp: new Date().toISOString()
            };
            
            const mockInsights = {
                overall: "あなたの3つのOSはバランスの取れた関係にあります。",
                relationships: [
                    "エンジンOSとインターフェースOSの調和",
                    "セーフモードOSによる適切な制御"
                ],
                recommendations: [
                    "創造性を活かしつつ、人との調和を大切に",
                    "リスク管理を忘れずに新しい挑戦を"
                ]
            };
            
            // 両方の形式で保存（互換性のため）
            localStorage.setItem('haqei_analysis_result', JSON.stringify(mockAnalysisResult));
            localStorage.setItem('haqei_emergency_result', JSON.stringify({
                result: mockAnalysisResult,
                insights: mockInsights
            }));
            localStorage.setItem('haqei_insights', JSON.stringify({ insights: mockInsights }));
            
            log('モックデータ作成完了', 'success');
            
            // 画面を更新
            checkLocalStorage();
            analyzeDataStructure();
        }
        
        function testVirtualPersonaView() {
            log('VirtualPersonaView テスト開始...', 'info');
            window.open('results.html', '_blank');
        }
        
        function clearAllData() {
            if (confirm('本当に全てのHAQEIデータを削除しますか？')) {
                const keys = Object.keys(localStorage).filter(k => k.includes('haqei'));
                keys.forEach(key => {
                    localStorage.removeItem(key);
                    log(`削除: ${key}`, 'warning');
                });
                log('全データクリア完了', 'success');
                checkLocalStorage();
                analyzeDataStructure();
            }
        }
        
        function goToAnalyzer() {
            window.location.href = 'os_analyzer.html';
        }
        
        function goToResults() {
            window.location.href = 'results.html';
        }
        
        // 初期化
        document.addEventListener('DOMContentLoaded', () => {
            log('デバッグツール起動', 'info');
            checkLocalStorage();
            analyzeDataStructure();
        });
    </script>
</body>
</html>