<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Analyzer â†’ Results ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f8f9fa;
        }
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 12px 0;
            padding: 12px;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }
        .success { background-color: #d4edda; border-left-color: #28a745; }
        .error { background-color: #f8d7da; border-left-color: #dc3545; }
        .warning { background-color: #fff3cd; border-left-color: #ffc107; }
        .info { background-color: #d1ecf1; border-left-color: #17a2b8; }
        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 8px;
            font-weight: 500;
        }
        button:hover { transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,123,255,0.3); }
        pre { background: #f8f9fa; padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 14px; }
        .navigation-flow {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 16px;
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            border-radius: 8px;
        }
        .flow-step {
            text-align: center;
            flex: 1;
        }
        .flow-arrow {
            font-size: 24px;
            color: #1976d2;
            margin: 0 10px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” OS Analyzer â†’ Results ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³çµ±åˆãƒ†ã‚¹ãƒˆ</h1>
    <p>OS Analyzerã‹ã‚‰Resultsãƒšãƒ¼ã‚¸ã¸ã®é·ç§»å•é¡Œã‚’è¨ºæ–­ãƒ»æ¤œè¨¼ã—ã€ä¿®æ­£ã•ã‚ŒãŸå‹•ä½œã‚’ç¢ºèªã—ã¾ã™ã€‚</p>
    
    <div class="navigation-flow">
        <div class="flow-step">
            <strong>ğŸ“ OS Analyzer</strong><br>
            åˆ†æå®Ÿè¡Œ
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-step">
            <strong>ğŸ’¾ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</strong><br>
            localStorage
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-step">
            <strong>ğŸ”„ ãƒšãƒ¼ã‚¸é·ç§»</strong><br>
            results.html
        </div>
        <div class="flow-arrow">â†’</div>
        <div class="flow-step">
            <strong>âœ… çµæœè¡¨ç¤º</strong><br>
            VirtualPersona
        </div>
    </div>
    
    <div class="test-section">
        <h2>ğŸ§ª çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
        <button onclick="testCompleteFlow()">ğŸš€ å®Œå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Ÿè¡Œ</button>
        <button onclick="testStoragePersistence()">ğŸ’¾ ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testNavigationStability()">ğŸ”„ é·ç§»å®‰å®šæ€§ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearAllTestData()">ğŸ§¹ ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        
        <div id="test-results"></div>
    </div>

    <!-- StorageManagerèª­ã¿è¾¼ã¿ -->
    <script src="./js/shared/core/StorageManager.js"></script>
    <script src="./js/shared/core/BridgeStorageManager.js"></script>
    
    <script>
        let testResults = [];
        
        function addTestResult(type, title, message, details = null) {
            const result = {
                type: type,
                title: title,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            
            let content = `<strong>${title}</strong>: ${message}`;
            if (details) {
                content += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = content;
            resultsDiv.appendChild(resultDiv);
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * å®Œå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Ÿè¡Œ
         * OS Analyzer â†’ åˆ†æå®Ÿè¡Œ â†’ ãƒ‡ãƒ¼ã‚¿ä¿å­˜ â†’ Resultsé·ç§»ã®å…¨ãƒ•ãƒ­ãƒ¼ã‚’ãƒ†ã‚¹ãƒˆ
         */
        async function testCompleteFlow() {
            console.log('ğŸš€ å®Œå…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Ÿè¡Œé–‹å§‹...');
            
            try {
                addTestResult('info', 'ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆé–‹å§‹', 'ğŸš€ OS Analyzer â†’ Results å®Œå…¨ãƒ•ãƒ­ãƒ¼ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆä¸­');
                
                // Step 1: æ¨¡æ“¬åˆ†æçµæœä½œæˆ
                const mockAnalysisResult = {
                    engineOS: {
                        score: 78,
                        traits: ['å‰µé€ æ€§', 'ç‹¬ç«‹æ€è€ƒ', 'é©æ–°æ€§'],
                        description: 'å‰µé€ çš„ã§ç‹¬ç«‹ã—ãŸEngine OS',
                        confidence: 0.89
                    },
                    interfaceOS: {
                        score: 65,
                        traits: ['å”èª¿æ€§', 'å…±æ„ŸåŠ›', 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³'],
                        description: 'å”èª¿çš„ãªInterface OS',
                        confidence: 0.82
                    },
                    safeModeOS: {
                        score: 85,
                        traits: ['æ…é‡æ€§', 'åˆ†æåŠ›', 'ãƒªã‚¹ã‚¯ç®¡ç†'],
                        description: 'æ…é‡ã§åˆ†æçš„ãªSafe Mode OS',
                        confidence: 0.91
                    },
                    analysisType: 'triple_os',
                    timestamp: new Date().toISOString(),
                    testMode: true
                };
                
                const mockInsights = {
                    summary: 'ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸTriple OSæ§‹æˆã€‚å‰µé€ æ€§ã¨æ…é‡æ€§ã®ãƒãƒ¼ãƒ¢ãƒ‹ãƒ¼ã€‚',
                    recommendations: [
                        'å‰µé€ çš„ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ç©æ¥µçš„ã«å–ã‚Šçµ„ã‚€',
                        'ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’æ´»ã‹ã—ãŸå”èª¿ä½œæ¥­ã‚’å¿ƒãŒã‘ã‚‹',
                        'ãƒªã‚¹ã‚¯ã‚’æ…é‡ã«è©•ä¾¡ã—ã¦è¡Œå‹•ã™ã‚‹'
                    ],
                    keyStrengths: ['å‰µé€ æ€§', 'ãƒãƒ©ãƒ³ã‚¹æ„Ÿè¦š', 'åˆ†æåŠ›'],
                    developmentAreas: ['ç¤¾äº¤æ€§ã®å‘ä¸Š', 'ãƒãƒ£ãƒ¬ãƒ³ã‚¸ç²¾ç¥'],
                    timestamp: new Date().toISOString()
                };
                
                addTestResult('success', 'Step 1: ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ', 'âœ… æ¨¡æ“¬åˆ†æçµæœã¨ã‚¤ãƒ³ã‚µã‚¤ãƒˆã‚’ç”Ÿæˆã—ã¾ã—ãŸ');
                
                // Step 2: ä¿®æ­£ã•ã‚ŒãŸshowResultsViewæ©Ÿèƒ½ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
                console.log('ğŸ’¾ ä¿®æ­£ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ—ãƒ­ã‚»ã‚¹ã‚’ãƒ†ã‚¹ãƒˆä¸­...');
                
                // StorageManageråˆæœŸåŒ–
                const storageManager = new StorageManager();
                
                // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ†ã‚¹ãƒˆï¼ˆä¿®æ­£ç‰ˆã®ãƒ­ã‚¸ãƒƒã‚¯ã‚’å†ç¾ï¼‰
                const saveSuccess1 = storageManager.saveAnalysisResult(mockAnalysisResult);
                const saveSuccess2 = storageManager.saveInsights(mockInsights);
                
                addTestResult('success', 'Step 2: ãƒ‡ãƒ¼ã‚¿ä¿å­˜', `âœ… ä¿å­˜çµæœ: åˆ†æçµæœ=${saveSuccess1}, ã‚¤ãƒ³ã‚µã‚¤ãƒˆ=${saveSuccess2}`);
                
                // Step 3: ä¿å­˜ç¢ºèªï¼ˆèª­ã¿æˆ»ã—ãƒ†ã‚¹ãƒˆï¼‰
                const verifyResult = storageManager.getAnalysisResult();
                const verifyInsights = storageManager.getInsights();
                
                if (!verifyResult || !verifyInsights) {
                    addTestResult('warning', 'Step 3: ä¿å­˜ç¢ºèªå¤±æ•—', 'âš ï¸ é€šå¸¸ä¿å­˜ã§èª­ã¿æˆ»ã—å¤±æ•— - ç·Šæ€¥ä¿å­˜å®Ÿè¡Œä¸­');
                    
                    // ç·Šæ€¥ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ãƒ†ã‚¹ãƒˆ
                    localStorage.setItem('haqei_analysis_result', JSON.stringify({
                        result: mockAnalysisResult,
                        timestamp: Date.now(),
                        version: '2025.08.01'
                    }));
                    
                    localStorage.setItem('haqei_insights', JSON.stringify({
                        insights: mockInsights,
                        timestamp: Date.now(),
                        version: '2025.08.01'
                    }));
                    
                    addTestResult('success', 'Step 3: ç·Šæ€¥ä¿å­˜', 'âœ… ç·Šæ€¥ä¿å­˜ãƒ¢ãƒ¼ãƒ‰ã§ãƒ‡ãƒ¼ã‚¿ä¿å­˜å®Œäº†');
                } else {
                    addTestResult('success', 'Step 3: ä¿å­˜ç¢ºèª', 'âœ… ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿æˆ»ã—ç¢ºèªæˆåŠŸ');
                }
                
                // Step 4: LocalStorageæœ€çµ‚ç¢ºèª
                const storageCheck = {
                    hasAnalysisResult: !!localStorage.getItem('haqei_analysis_result'),
                    hasInsights: !!localStorage.getItem('haqei_insights'),
                    hasSession: !!localStorage.getItem('haqei_session'),
                    storageKeys: Object.keys(localStorage).filter(k => k.includes('haqei')).length
                };
                
                addTestResult('info', 'Step 4: Storageç¢ºèª', 'ğŸ“Š LocalStorageçŠ¶æ…‹ç¢ºèªå®Œäº†', storageCheck);
                
                // Step 5: Results.htmlé·ç§»æº–å‚™ç¢ºèª
                fetch('/results')
                    .then(response => {
                        if (response.ok) {
                            addTestResult('success', 'Step 5: é·ç§»æº–å‚™', 'âœ… results.htmlã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ç¢ºèª');
                            
                            // å®Ÿéš›ã®é·ç§»ãƒ†ã‚¹ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³æä¾›
                            setTimeout(() => {
                                const navigateBtn = document.createElement('button');
                                navigateBtn.textContent = 'ğŸš€ å®Ÿéš›ã«results.htmlã«é·ç§»ã—ã¦ãƒ†ã‚¹ãƒˆ';
                                navigateBtn.onclick = () => {
                                    addTestResult('info', 'é·ç§»å®Ÿè¡Œ', 'ğŸ”„ results.htmlã«é·ç§»ä¸­...');
                                    setTimeout(() => {
                                        window.location.href = '/results';
                                    }, 1000);
                                };
                                document.getElementById('test-results').appendChild(navigateBtn);
                            }, 500);
                            
                        } else {
                            addTestResult('error', 'Step 5: é·ç§»æº–å‚™', `âŒ results.html ã‚¢ã‚¯ã‚»ã‚¹ä¸å¯: ${response.status}`);
                        }
                    })
                    .catch(error => {
                        addTestResult('error', 'Step 5: é·ç§»æº–å‚™', `âŒ results.html ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                    });
                
                addTestResult('success', 'å®Œå…¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆ', 'ğŸ¯ å…¨ã‚¹ãƒ†ãƒƒãƒ—ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼ä¿®æ­£ãŒæœ‰åŠ¹ã«å‹•ä½œã—ã¦ã„ã¾ã™ã€‚');
                
            } catch (error) {
                addTestResult('error', 'ãƒ•ãƒ­ãƒ¼ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, {
                    stack: error.stack
                });
            }
        }

        /**
         * ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆ
         */
        function testStoragePersistence() {
            console.log('ğŸ’¾ ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                const testData = {
                    testId: 'persistence-test-' + Date.now(),
                    engineOS: { score: 75 },
                    interfaceOS: { score: 68 },
                    safeModeOS: { score: 82 }
                };
                
                // é€šå¸¸ä¿å­˜ãƒ†ã‚¹ãƒˆ
                const storageManager = new StorageManager();
                const saveResult = storageManager.saveAnalysisResult(testData);
                
                addTestResult(saveResult ? 'success' : 'error', 
                    'ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–', 
                    saveResult ? 'âœ… é€šå¸¸ä¿å­˜æˆåŠŸ' : 'âŒ é€šå¸¸ä¿å­˜å¤±æ•—');
                
                // èª­ã¿æˆ»ã—ãƒ†ã‚¹ãƒˆ
                const retrievedData = storageManager.getAnalysisResult();
                const dataMatches = retrievedData && retrievedData.testId === testData.testId;
                
                addTestResult(dataMatches ? 'success' : 'warning', 
                    'èª­ã¿æˆ»ã—ãƒ†ã‚¹ãƒˆ', 
                    dataMatches ? 'âœ… ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ç¢ºèª' : 'âš ï¸ ãƒ‡ãƒ¼ã‚¿ä¸ä¸€è‡´æ¤œå‡º');
                
                // ç›´æ¥localStorageç¢ºèª
                const directData = localStorage.getItem('haqei_analysis_result');
                addTestResult(directData ? 'success' : 'error', 
                    'ç›´æ¥Storageç¢ºèª', 
                    directData ? 'âœ… localStorageç›´æ¥ç¢ºèªOK' : 'âŒ localStorageç•°å¸¸');
                
            } catch (error) {
                addTestResult('error', 'æ°¸ç¶šåŒ–ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', `âŒ ${error.message}`);
            }
        }

        /**
         * é·ç§»å®‰å®šæ€§ãƒ†ã‚¹ãƒˆ
         */
        function testNavigationStability() {
            console.log('ğŸ”„ é·ç§»å®‰å®šæ€§ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                // è¤‡æ•°å›ã®ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ»èª­ã¿å–ã‚Šã‚µã‚¤ã‚¯ãƒ«ãƒ†ã‚¹ãƒˆ
                const cycles = 5;
                let successCount = 0;
                
                for (let i = 0; i < cycles; i++) {
                    const testData = {
                        cycle: i + 1,
                        timestamp: Date.now(),
                        engineOS: { score: 70 + i },
                        interfaceOS: { score: 65 + i },
                        safeModeOS: { score: 80 + i }
                    };
                    
                    // ä¿å­˜â†’èª­ã¿å–ã‚Šã‚µã‚¤ã‚¯ãƒ«
                    localStorage.setItem('haqei_analysis_result', JSON.stringify({
                        result: testData,
                        timestamp: Date.now(),
                        version: '2025.08.01'
                    }));
                    
                    const retrieved = localStorage.getItem('haqei_analysis_result');
                    if (retrieved) {
                        try {
                            const parsed = JSON.parse(retrieved);
                            if (parsed.result.cycle === testData.cycle) {
                                successCount++;
                            }
                        } catch (e) {
                            console.warn(`ã‚µã‚¤ã‚¯ãƒ« ${i + 1} è§£æå¤±æ•—:`, e);
                        }
                    }
                }
                
                const stabilityRate = (successCount / cycles) * 100;
                addTestResult(
                    stabilityRate >= 100 ? 'success' : stabilityRate >= 80 ? 'warning' : 'error',
                    'é·ç§»å®‰å®šæ€§',
                    `ğŸ“Š å®‰å®šæ€§ç‡: ${stabilityRate}% (${successCount}/${cycles} ã‚µã‚¤ã‚¯ãƒ«æˆåŠŸ)`,
                    { successCount, totalCycles: cycles, stabilityRate }
                );
                
                // URLã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
                Promise.all([
                    fetch('/os_analyzer').then(r => ({ endpoint: 'os_analyzer', status: r.status, ok: r.ok })),
                    fetch('/results').then(r => ({ endpoint: 'results', status: r.status, ok: r.ok }))
                ]).then(results => {
                    const allOk = results.every(r => r.ok);
                    addTestResult(
                        allOk ? 'success' : 'warning',
                        'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚¢ã‚¯ã‚»ã‚¹',
                        allOk ? 'âœ… å…¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆæ­£å¸¸' : 'âš ï¸ ä¸€éƒ¨ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆç•°å¸¸',
                        results
                    );
                }).catch(error => {
                    addTestResult('error', 'ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆãƒ†ã‚¹ãƒˆ', `âŒ ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆå¤±æ•—: ${error.message}`);
                });
                
            } catch (error) {
                addTestResult('error', 'å®‰å®šæ€§ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', `âŒ ${error.message}`);
            }
        }

        /**
         * ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
         */
        function clearAllTestData() {
            try {
                const keys = Object.keys(localStorage).filter(key => key.includes('haqei'));
                keys.forEach(key => localStorage.removeItem(key));
                
                // ãƒ†ã‚¹ãƒˆçµæœã‚‚ã‚¯ãƒªã‚¢
                document.getElementById('test-results').innerHTML = '';
                testResults = [];
                
                addTestResult('success', 'ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢', `âœ… ${keys.length}å€‹ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
            } catch (error) {
                addTestResult('error', 'ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼', `âŒ ${error.message}`);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸæƒ…å ±è¡¨ç¤º
        window.addEventListener('load', function() {
            addTestResult('info', 'ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸åˆæœŸåŒ–', 
                'ğŸ” OS Analyzer â†’ Results ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ä¿®æ­£ç‰ˆã®çµ±åˆãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¾ã™');
        });
    </script>
</body>
</html>