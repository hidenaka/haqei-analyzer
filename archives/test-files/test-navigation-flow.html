<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OS Analyzerâ†’Results é·ç§»ãƒ†ã‚¹ãƒˆ</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-container {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        button { 
            background: #007bff; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” OS Analyzer â†’ Results é·ç§»å•é¡Œè¨ºæ–­</h1>
    <p>OS Analyzerã‹ã‚‰Resultsãƒšãƒ¼ã‚¸ã¸ã®é·ç§»ã§ç™ºç”Ÿã—ã¦ã„ã‚‹ä¸å®‰å®šãªæŒ™å‹•ã‚’è¨ºæ–­ã—ã¾ã™ã€‚</p>
    
    <div class="test-container">
        <h2>ğŸ“Š ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ</h2>
        <button onclick="testStorageSystem()">ğŸ—„ï¸ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testDataTransfer()">ğŸ“¤ ãƒ‡ãƒ¼ã‚¿è»¢é€ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="testNavigation()">ğŸš€ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ</button>
        <button onclick="simulateUserFlow()">ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Ÿè¡Œ</button>
        <button onclick="clearAllData()">ğŸ§¹ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        
        <div id="test-results"></div>
    </div>

    <!-- StorageManagerã¨BridgeStorageManagerã‚’èª­ã¿è¾¼ã¿ -->
    <script src="./js/shared/core/StorageManager.js"></script>
    <script src="./js/shared/core/BridgeStorageManager.js"></script>
    
    <script>
        let testResults = [];
        
        /**
         * ãƒ†ã‚¹ãƒˆçµæœã‚’è¡¨ç¤ºã‚¨ãƒªã‚¢ã«è¿½åŠ 
         */
        function addTestResult(type, title, message, details = null) {
            const result = {
                type: type,
                title: title,
                message: message,
                details: details,
                timestamp: new Date().toISOString()
            };
            
            testResults.push(result);
            
            const resultsDiv = document.getElementById('test-results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${type}`;
            
            let content = `<strong>${title}</strong>: ${message}`;
            if (details) {
                content += `<pre>${JSON.stringify(details, null, 2)}</pre>`;
            }
            
            resultDiv.innerHTML = content;
            resultsDiv.appendChild(resultDiv);
            
            // è‡ªå‹•ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            resultDiv.scrollIntoView({ behavior: 'smooth' });
        }

        /**
         * ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆ
         */
        function testStorageSystem() {
            console.log('ğŸ—„ï¸ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                // StorageManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const storageManager = new StorageManager();
                addTestResult('success', 'StorageManageråˆæœŸåŒ–', 'âœ… StorageManagerãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ');
                
                // BridgeStorageManagerã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
                const bridgeStorageManager = new BridgeStorageManager(storageManager);
                addTestResult('success', 'BridgeStorageManageråˆæœŸåŒ–', 'âœ… BridgeStorageManagerãŒæ­£å¸¸ã«ä½œæˆã•ã‚Œã¾ã—ãŸ');
                
                // åŸºæœ¬æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆ
                const testData = {
                    engineOS: { score: 75, traits: ['å‰µé€ æ€§', 'ç‹¬ç«‹æ€§'] },
                    interfaceOS: { score: 68, traits: ['å”èª¿æ€§', 'å…±æ„ŸåŠ›'] },
                    safeModeOS: { score: 82, traits: ['æ…é‡æ€§', 'åˆ†æåŠ›'] },
                    analysisType: 'triple_os',
                    timestamp: new Date().toISOString()
                };
                
                // ãƒ‡ãƒ¼ã‚¿ä¿å­˜ãƒ†ã‚¹ãƒˆ
                const saveSuccess = bridgeStorageManager.saveAnalysisResult(testData);
                if (saveSuccess) {
                    addTestResult('success', 'ãƒ‡ãƒ¼ã‚¿ä¿å­˜', 'âœ… åˆ†æçµæœãŒæ­£å¸¸ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸ');
                } else {
                    addTestResult('error', 'ãƒ‡ãƒ¼ã‚¿ä¿å­˜', 'âŒ åˆ†æçµæœã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ãƒ†ã‚¹ãƒˆ
                const retrievedData = bridgeStorageManager.getAnalysisResult();
                if (retrievedData && retrievedData.engineOS) {
                    addTestResult('success', 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿', 'âœ… åˆ†æçµæœãŒæ­£å¸¸ã«èª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ', {
                        engineScore: retrievedData.engineOS.score,
                        interfaceScore: retrievedData.interfaceOS?.score,
                        safeModeScore: retrievedData.safeModeOS?.score
                    });
                } else {
                    addTestResult('error', 'ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿', 'âŒ åˆ†æçµæœã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', retrievedData);
                }
                
                // ã‚¤ãƒ³ã‚µã‚¤ãƒˆãƒ†ã‚¹ãƒˆ
                const testInsights = {
                    summary: 'ãƒ†ã‚¹ãƒˆç”¨ã‚¤ãƒ³ã‚µã‚¤ãƒˆ',
                    recommendations: ['æ¨å¥¨äº‹é …1', 'æ¨å¥¨äº‹é …2'],
                    timestamp: new Date().toISOString()
                };
                
                bridgeStorageManager.saveInsights(testInsights);
                const retrievedInsights = bridgeStorageManager.getInsights();
                
                if (retrievedInsights && retrievedInsights.summary) {
                    addTestResult('success', 'ã‚¤ãƒ³ã‚µã‚¤ãƒˆå‡¦ç†', 'âœ… ã‚¤ãƒ³ã‚µã‚¤ãƒˆãŒæ­£å¸¸ã«å‡¦ç†ã•ã‚Œã¾ã—ãŸ');
                } else {
                    addTestResult('warning', 'ã‚¤ãƒ³ã‚µã‚¤ãƒˆå‡¦ç†', 'âš ï¸ ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®å‡¦ç†ã§å•é¡ŒãŒç™ºç”Ÿã—ã¾ã—ãŸ', retrievedInsights);
                }
                
            } catch (error) {
                addTestResult('error', 'ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚·ã‚¹ãƒ†ãƒ ã‚¨ãƒ©ãƒ¼', `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`, {
                    stack: error.stack
                });
            }
        }

        /**
         * ãƒ‡ãƒ¼ã‚¿è»¢é€ãƒ†ã‚¹ãƒˆ
         */
        function testDataTransfer() {
            console.log('ğŸ“¤ ãƒ‡ãƒ¼ã‚¿è»¢é€ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            try {
                // localStorageç›´æ¥ç¢ºèª
                const keys = Object.keys(localStorage).filter(key => key.includes('haqei'));
                addTestResult('info', 'localStorageç¢ºèª', `ğŸ“Š HAQEIãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼æ•°: ${keys.length}å€‹`, keys);
                
                // å„ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚ºç¢ºèª
                keys.forEach(key => {
                    const data = localStorage.getItem(key);
                    const size = new Blob([data]).size;
                    
                    if (size > 1024) {
                        addTestResult('info', `ãƒ‡ãƒ¼ã‚¿ã‚µã‚¤ã‚º: ${key}`, `ğŸ“ ${(size / 1024).toFixed(2)}KB`);
                    }
                });
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ç¢ºèª
                const storageManager = new StorageManager();
                const session = storageManager.getSession();
                
                if (session) {
                    addTestResult('success', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±', 'âœ… ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒå­˜åœ¨ã—ã¾ã™', {
                        stage: session.stage,
                        sessionId: session.sessionId,
                        lastActivity: session.lastActivity
                    });
                } else {
                    addTestResult('warning', 'ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±', 'âš ï¸ ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
            } catch (error) {
                addTestResult('error', 'ãƒ‡ãƒ¼ã‚¿è»¢é€ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼', `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        /**
         * ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆ
         */
        function testNavigation() {
            console.log('ğŸš€ ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒ†ã‚¹ãƒˆé–‹å§‹...');
            
            // ç¾åœ¨ã®URLç¢ºèª
            addTestResult('info', 'ç¾åœ¨ã®URL', `ğŸ“ ${window.location.href}`);
            
            // OS Analyzerã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
            fetch('/os_analyzer')
                .then(response => {
                    if (response.ok) {
                        addTestResult('success', 'OS Analyzerã‚¢ã‚¯ã‚»ã‚¹', 'âœ… OS Analyzerãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™');
                    } else {
                        addTestResult('error', 'OS Analyzerã‚¢ã‚¯ã‚»ã‚¹', `âŒ HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    addTestResult('error', 'OS Analyzerã‚¢ã‚¯ã‚»ã‚¹', `âŒ ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                });
            
            // Resultsãƒšãƒ¼ã‚¸ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒ†ã‚¹ãƒˆ
            fetch('/results')
                .then(response => {
                    if (response.ok) {
                        addTestResult('success', 'Resultsã‚¢ã‚¯ã‚»ã‚¹', 'âœ… Resultsãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½ã§ã™');
                    } else {
                        addTestResult('error', 'Resultsã‚¢ã‚¯ã‚»ã‚¹', `âŒ HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    addTestResult('error', 'Resultsã‚¢ã‚¯ã‚»ã‚¹', `âŒ ã‚¢ã‚¯ã‚»ã‚¹ã‚¨ãƒ©ãƒ¼: ${error.message}`);
                });
        }

        /**
         * ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Ÿè¡Œ
         */
        function simulateUserFlow() {
            console.log('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Ÿè¡Œé–‹å§‹...');
            
            try {
                // Step 1: åˆ†æçµæœã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                const mockAnalysisResult = {
                    engineOS: {
                        score: 75,
                        traits: ['å‰µé€ æ€§', 'ç‹¬ç«‹æ€§', 'ç†æƒ³ä¸»ç¾©'],
                        description: 'ã‚¨ãƒ³ã‚¸ãƒ³OSãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿'
                    },
                    interfaceOS: {
                        score: 68,
                        traits: ['å”èª¿æ€§', 'å…±æ„ŸåŠ›', 'é©å¿œæ€§'],
                        description: 'ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹OSãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿'
                    },
                    safeModeOS: {
                        score: 82,
                        traits: ['æ…é‡æ€§', 'åˆ†æåŠ›', 'é˜²å¾¡æ€§'],
                        description: 'ã‚»ãƒ¼ãƒ•ãƒ¢ãƒ¼ãƒ‰OSãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿'
                    },
                    analysisType: 'triple_os',
                    timestamp: new Date().toISOString(),
                    userFlow: 'simulated'
                };
                
                const mockInsights = {
                    summary: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼æ¨¡æ“¬å®Ÿè¡Œã§ç”Ÿæˆã•ã‚ŒãŸã‚¤ãƒ³ã‚µã‚¤ãƒˆ',
                    recommendations: [
                        'å‰µé€ æ€§ã‚’æ´»ã‹ã—ãŸæ´»å‹•ã«å–ã‚Šçµ„ã‚€',
                        'ä»–è€…ã¨ã®å”èª¿ã‚’å¤§åˆ‡ã«ã™ã‚‹',
                        'æ…é‡ãªåˆ¤æ–­ã‚’å¿ƒãŒã‘ã‚‹'
                    ],
                    timestamp: new Date().toISOString()
                };
                
                // Step 2: ãƒ‡ãƒ¼ã‚¿ä¿å­˜ï¼ˆOS Analyzerã§ã®å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
                const storageManager = new StorageManager();
                const bridgeStorageManager = new BridgeStorageManager(storageManager);
                
                bridgeStorageManager.saveAnalysisResult(mockAnalysisResult);
                bridgeStorageManager.saveInsights(mockInsights);
                bridgeStorageManager.updateSession({ stage: 'results' });
                
                addTestResult('success', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ Step 1-2', 'âœ… åˆ†æçµæœã¨ã‚¤ãƒ³ã‚µã‚¤ãƒˆã®ä¿å­˜ãŒå®Œäº†ã—ã¾ã—ãŸ');
                
                // Step 3: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ï¼ˆResultsãƒšãƒ¼ã‚¸ã§ã®å‡¦ç†ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
                setTimeout(() => {
                    const retrievedResult = bridgeStorageManager.getAnalysisResult();
                    const retrievedInsights = bridgeStorageManager.getInsights();
                    
                    if (retrievedResult && retrievedResult.engineOS && 
                        retrievedInsights && retrievedInsights.summary) {
                        
                        addTestResult('success', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ Step 3', 'âœ… Resultsãƒšãƒ¼ã‚¸ã§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ãŒæˆåŠŸã—ã¾ã—ãŸ', {
                            analysisDataPresent: true,
                            insightsDataPresent: true,
                            engineScore: retrievedResult.engineOS.score,
                            recommendationsCount: retrievedInsights.recommendations?.length || 0
                        });
                        
                        // Step 4: é·ç§»ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
                        setTimeout(() => {
                            addTestResult('info', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼å®Œäº†', 
                                'ğŸ¯ æ¨¡æ“¬ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚å®Ÿéš›ã®results.htmlã¸ã®é·ç§»ã‚’ãƒ†ã‚¹ãƒˆã—ã¾ã™ã‹ï¼Ÿ');
                            
                            // å®Ÿéš›ã®é·ç§»ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›
                            const navigateBtn = document.createElement('button');
                            navigateBtn.textContent = 'ğŸš€ results.htmlã«å®Ÿéš›ã«é·ç§»ã™ã‚‹';
                            navigateBtn.onclick = () => {
                                addTestResult('info', 'é·ç§»å®Ÿè¡Œ', 'results.htmlã«é·ç§»ã—ã¦ã„ã¾ã™...');
                                setTimeout(() => {
                                    window.location.href = '/results';
                                }, 1000);
                            };
                            
                            document.getElementById('test-results').appendChild(navigateBtn);
                            
                        }, 1000);
                        
                    } else {
                        addTestResult('error', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ Step 3', 'âŒ Resultsãƒšãƒ¼ã‚¸ã§ã®ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', {
                            analysisResult: !!retrievedResult,
                            insights: !!retrievedInsights
                        });
                    }
                }, 500);
                
            } catch (error) {
                addTestResult('error', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ãƒ­ãƒ¼ã‚¨ãƒ©ãƒ¼', `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        /**
         * å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢
         */
        function clearAllData() {
            try {
                const keys = Object.keys(localStorage).filter(key => key.includes('haqei'));
                keys.forEach(key => localStorage.removeItem(key));
                
                // ãƒ†ã‚¹ãƒˆçµæœã‚‚ã‚¯ãƒªã‚¢
                document.getElementById('test-results').innerHTML = '';
                testResults = [];
                
                addTestResult('success', 'ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢', `âœ… ${keys.length}å€‹ã®ãƒ‡ãƒ¼ã‚¿ã‚­ãƒ¼ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
            } catch (error) {
                addTestResult('error', 'ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼', `âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸæƒ…å ±è¡¨ç¤º
        window.addEventListener('load', function() {
            addTestResult('info', 'ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†', 
                'OS Analyzer â†’ Results é·ç§»å•é¡Œã®è¨ºæ–­ã‚’é–‹å§‹ã—ã¾ã™');
        });
    </script>
</body>
</html>