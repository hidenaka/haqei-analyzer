<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triple OS Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        pre { background: #f5f5f5; padding: 10px; overflow-x: auto; }
        button { padding: 10px 20px; margin: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
    </style>
</head>
<body>
    <h1>ğŸ”¬ Triple OS Data Generation Debug Test</h1>
    
    <div class="debug-section">
        <h2>ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ç¢ºèª</h2>
        <button onclick="checkSystemStatus()">ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯</button>
        <pre id="system-status"></pre>
    </div>
    
    <div class="debug-section">
        <h2>åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testAnalysisEngine()">åˆ†æã‚¨ãƒ³ã‚¸ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ</button>
        <pre id="analysis-result"></pre>
    </div>
    
    <div class="debug-section">
        <h2>å®Ÿéš›ã®TripleOSEngineç›´æ¥ãƒ†ã‚¹ãƒˆ</h2>
        <button onclick="testDirectTripleOSEngine()">TripleOSEngineã‚’ç›´æ¥ãƒ†ã‚¹ãƒˆ</button>
        <pre id="direct-result"></pre>
    </div>

    <!-- å¿…è¦ãªJSãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="js/shared/core/SimpleStorageManager.js"></script>
    <script src="js/shared/utils/DataFlowMonitor.js"></script>
    <script src="js/shared/utils/SimpleHooks.js"></script>
    <script src="js/shared/os-analyzer/DataManager.js"></script>
    <script src="js/shared/os-analyzer/Calculator.js"></script>
    <script src="js/shared/os-analyzer/IChingCompatibilityDataLoader.js"></script>
    <script src="js/os-analyzer/core/Engine.js"></script>
    <script src="js/os-analyzer/core/IChingUltraSyncLogic.js"></script>
    <script src="js/os-analyzer/core/TripleOSEngine.js"></script>
    <script src="js/os-analyzer/core/UltraAnalysisEngine.js"></script>

    <script>
        let dataManager = null;
        let ultraEngine = null;
        let tripleOSEngine = null;
        
        // ãƒ†ã‚¹ãƒˆç”¨ã®å›ç­”ãƒ‡ãƒ¼ã‚¿
        const testUserAnswers = [
            // ä¾¡å€¤è¦³è¨­å•ï¼ˆq1-q28ï¼‰
            { questionId: 'q1', selectedChoice: 'q1a', choiceText: 'å€‹äººã®è‡ªç”±ã‚’é‡è¦–ã™ã‚‹' },
            { questionId: 'q2', selectedChoice: 'q2b', choiceText: 'å®‰å®šã—ãŸé–¢ä¿‚ã‚’ç¯‰ã' },
            { questionId: 'q3', selectedChoice: 'q3a', choiceText: 'æ–°ã—ã„æŒ‘æˆ¦ã‚’ã™ã‚‹' },
            { questionId: 'q4', selectedChoice: 'q4b', choiceText: 'ãƒãƒ¼ãƒ ã§å”åŠ›ã™ã‚‹' },
            { questionId: 'q5', selectedChoice: 'q5a', choiceText: 'è«–ç†çš„ã«åˆ¤æ–­ã™ã‚‹' },
            // ã‚·ãƒŠãƒªã‚ªè¨­å•ï¼ˆq29-q56ï¼‰
            { questionId: 'q29', selectedChoice: 'q29a', choiceText: 'ç©æ¥µçš„ã«ã‚¢ãƒ—ãƒ­ãƒ¼ãƒã™ã‚‹' },
            { questionId: 'q30', selectedChoice: 'q30b', choiceText: 'æ…é‡ã«æ§˜å­ã‚’è¦‹ã‚‹' },
            { questionId: 'q31', selectedChoice: 'q31a', choiceText: 'ç›´æ¥è©±ã—åˆã†' },
            { questionId: 'q32', selectedChoice: 'q32b', choiceText: 'æ™‚é–“ã‚’ã‹ã‘ã¦è€ƒãˆã‚‹' }
        ];

        async function initializeSystem() {
            try {
                console.log('ğŸ”„ Initializing system...');
                
                // DataManagerã®åˆæœŸåŒ–
                dataManager = new DataManager();
                await dataManager.loadAllData();
                console.log('âœ… DataManager initialized');
                
                // UltraAnalysisEngineã®åˆæœŸåŒ–
                ultraEngine = new UltraAnalysisEngine(dataManager);
                console.log('âœ… UltraAnalysisEngine initialized');
                
                // TripleOSEngineã®åˆæœŸåŒ–
                tripleOSEngine = new TripleOSEngine(dataManager);
                console.log('âœ… TripleOSEngine initialized');
                
                return true;
            } catch (error) {
                console.error('âŒ System initialization failed:', error);
                return false;
            }
        }

        async function checkSystemStatus() {
            const statusEl = document.getElementById('system-status');
            statusEl.textContent = 'ãƒã‚§ãƒƒã‚¯ä¸­...';
            
            try {
                const initialized = await initializeSystem();
                
                const status = {
                    systemInitialized: initialized,
                    dataManager: dataManager ? 'initialized' : 'not initialized',
                    ultraEngine: ultraEngine ? 'initialized' : 'not initialized',
                    tripleOSEngine: tripleOSEngine ? 'initialized' : 'not initialized',
                    tripleOSEngineClass: typeof TripleOSEngine !== 'undefined' ? 'available' : 'not available',
                    testAnswers: testUserAnswers.length + ' test answers prepared'
                };
                
                statusEl.innerHTML = '<span class="success">âœ… ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹:</span>\n' + 
                                   JSON.stringify(status, null, 2);
            } catch (error) {
                statusEl.innerHTML = '<span class="error">âŒ ã‚¨ãƒ©ãƒ¼:</span>\n' + error.message;
            }
        }

        async function testAnalysisEngine() {
            const resultEl = document.getElementById('analysis-result');
            resultEl.textContent = 'åˆ†æå®Ÿè¡Œä¸­...';
            
            try {
                if (!ultraEngine) {
                    await initializeSystem();
                }
                
                console.log('ğŸš€ Starting UltraAnalysisEngine test...');
                const startTime = performance.now();
                
                const result = await ultraEngine.analyzeTripleOS(testUserAnswers);
                
                const endTime = performance.now();
                const analysisTime = endTime - startTime;
                
                const summary = {
                    analysisTime: analysisTime.toFixed(2) + 'ms',
                    resultType: result?.analysisType || 'unknown',
                    hasEngineOS: !!result?.engineOS,
                    hasInterfaceOS: !!result?.interfaceOS,
                    hasSafeModeOS: !!result?.safeModeOS,
                    hasPrimaryOS: !!result?.primaryOS,
                    engineOSDetails: result?.engineOS ? {
                        name: result.engineOS.name,
                        strength: result.engineOS.strength,
                        hexagram: result.engineOS.hexagramInfo?.name
                    } : null,
                    interfaceOSDetails: result?.interfaceOS ? {
                        name: result.interfaceOS.name,
                        strength: result.interfaceOS.strength,
                        hexagram: result.interfaceOS.hexagramInfo?.name
                    } : null,
                    safeModeOSDetails: result?.safeModeOS ? {
                        name: result.safeModeOS.name,
                        strength: result.safeModeOS.strength,
                        hexagram: result.safeModeOS.hexagramInfo?.name
                    } : null
                };
                
                resultEl.innerHTML = '<span class="success">âœ… UltraAnalysisEngineçµæœ:</span>\n' + 
                                   JSON.stringify(summary, null, 2) + '\n\n' +
                                   '<span class="success">å®Œå…¨çµæœ:</span>\n' +
                                   JSON.stringify(result, null, 2);
                
            } catch (error) {
                resultEl.innerHTML = '<span class="error">âŒ ã‚¨ãƒ©ãƒ¼:</span>\n' + error.message + '\n\n' +
                                   '<span class="error">ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:</span>\n' + error.stack;
            }
        }

        async function testDirectTripleOSEngine() {
            const resultEl = document.getElementById('direct-result');
            resultEl.textContent = 'ç›´æ¥åˆ†æå®Ÿè¡Œä¸­...';
            
            try {
                if (!tripleOSEngine) {
                    await initializeSystem();
                }
                
                console.log('ğŸš€ Starting direct TripleOSEngine test...');
                const startTime = performance.now();
                
                const result = await tripleOSEngine.analyzeUser(testUserAnswers);
                
                const endTime = performance.now();
                const analysisTime = endTime - startTime;
                
                const summary = {
                    analysisTime: analysisTime.toFixed(2) + 'ms',
                    resultType: result?.analysisType || 'unknown',
                    hasEngineOS: !!result?.engineOS,
                    hasInterfaceOS: !!result?.interfaceOS,
                    hasSafeModeOS: !!result?.safeModeOS,
                    hasPrimaryOS: !!result?.primaryOS,
                    virtualPersonalityEnabled: tripleOSEngine.virtualPersonalitySystem?.enabled,
                    engineOSDetails: result?.engineOS ? {
                        name: result.engineOS.name,
                        strength: result.engineOS.strength,
                        hexagram: result.engineOS.hexagramInfo?.name
                    } : null
                };
                
                resultEl.innerHTML = '<span class="success">âœ… ç›´æ¥TripleOSEngineçµæœ:</span>\n' + 
                                   JSON.stringify(summary, null, 2) + '\n\n' +
                                   '<span class="success">å®Œå…¨çµæœ:</span>\n' +
                                   JSON.stringify(result, null, 2);
                
            } catch (error) {
                resultEl.innerHTML = '<span class="error">âŒ ã‚¨ãƒ©ãƒ¼:</span>\n' + error.message + '\n\n' +
                                   '<span class="error">ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:</span>\n' + error.stack;
            }
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«åˆæœŸåŒ–
        window.addEventListener('load', () => {
            console.log('ğŸ” Triple OS Debug Test page loaded');
        });
    </script>
</body>
</html>