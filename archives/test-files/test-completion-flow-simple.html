<\!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HAQEI 30å•å®Œäº†ãƒ•ãƒ­ãƒ¼æ¤œè¨¼</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
            line-height: 1.6;
        }
        .test-container {
            max-width: 900px;
            margin: 0 auto;
            background: #2a2a2a;
            padding: 30px;
            border-radius: 12px;
            border: 2px solid #6366f1;
        }
        .test-button {
            background: #6366f1;
            color: white;
            border: none;
            padding: 12px 24px;
            margin: 8px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        .test-button:hover { background: #5855d6; }
        .status {
            background: #3a3a3a;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #6366f1;
        }
        .success { border-left-color: #10b981; }
        .warning { border-left-color: #f59e0b; }
        .error { border-left-color: #ef4444; }
        .log {
            background: #1f1f1f;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .progress {
            background: #3a3a3a;
            border-radius: 4px;
            overflow: hidden;
            margin: 15px 0;
        }
        .progress-bar {
            background: #6366f1;
            height: 20px;
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>ğŸ” HAQEI 30å•å®Œäº†ãƒ•ãƒ­ãƒ¼æ¤œè¨¼</h1>
        
        <div class="status">
            <h3>ğŸ“‹ ãƒ†ã‚¹ãƒˆé …ç›®</h3>
            <ul>
                <li>1. åˆæœŸãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿</li>
                <li>2. è¨­å•ãƒ•ãƒ­ãƒ¼é–‹å§‹</li>
                <li>3. 30å•è‡ªå‹•å›ç­”</li>
                <li>4. å®Œäº†å¾Œé·ç§»ç¢ºèª</li>
                <li>5. çµæœãƒšãƒ¼ã‚¸è¡¨ç¤º</li>
                <li>6. ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§</li>
                <li>7. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°</li>
            </ul>
        </div>

        <div class="progress">
            <div class="progress-bar" id="progress-bar">0%</div>
        </div>

        <div>
            <button class="test-button" onclick="openHAQEI()">HAQEI ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã‚’é–‹ã</button>
            <button class="test-button" onclick="checkCurrentStatus()">ç¾åœ¨çŠ¶æ³ç¢ºèª</button>
            <button class="test-button" onclick="clearStorage()">ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢</button>
            <button class="test-button" onclick="startAutoTest()">è‡ªå‹•ãƒ†ã‚¹ãƒˆé–‹å§‹</button>
        </div>

        <div id="status-display" class="status">
            <h4>ğŸ“Š ç¾åœ¨ã®çŠ¶æ³</h4>
            <div id="status-content">åˆæœŸçŠ¶æ…‹</div>
        </div>

        <div class="log" id="log-container">
            <div>ğŸ” ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢</div>
        </div>

        <div class="status">
            <h4>ğŸ“ æ‰‹å‹•ãƒ†ã‚¹ãƒˆæ‰‹é †</h4>
            <ol>
                <li>ã€ŒHAQEI ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã‚’é–‹ãã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯</li>
                <li>æ–°ã—ã„ã‚¿ãƒ–ã§è¨ºæ–­ã‚’é–‹å§‹</li>
                <li>30å•ã«é †æ¬¡å›ç­”</li>
                <li>å®Œäº†å¾Œã®é·ç§»ã‚’è¦³å¯Ÿ</li>
                <li>ã€Œç¾åœ¨çŠ¶æ³ç¢ºèªã€ã§çµæœã‚’ç¢ºèª</li>
            </ol>
        </div>
    </div>

    <script>
        let testWindow = null;
        let currentTest = 0;
        let totalTests = 7;

        function log(message, type = 'info') {
            const logContainer = document.getElementById('log-container');
            const timestamp = new Date().toLocaleTimeString();
            const colorMap = {
                'info': '#6366f1',
                'success': '#10b981',
                'warning': '#f59e0b',
                'error': '#ef4444'
            };
            
            logContainer.innerHTML += `
                <div style="color: ${colorMap[type] || '#fff'}">
                    [${timestamp}] ${message}
                </div>
            `;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function updateProgress(current, total) {
            const percentage = Math.round((current / total) * 100);
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = percentage + '%';
            progressBar.textContent = `${current}/${total} (${percentage}%)`;
        }

        function openHAQEI() {
            log('HAQEI ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ã‚’é–‹ã„ã¦ã„ã¾ã™...', 'info');
            testWindow = window.open(
                'http://localhost:8788/public/os_analyzer.html',
                'haqei-test',
                'width=1200,height=800,scrollbars=yes,resizable=yes'
            );
            
            if (testWindow) {
                log('âœ… HAQEI ã‚¢ãƒŠãƒ©ã‚¤ã‚¶ãƒ¼ãŒæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãã¾ã—ãŸ', 'success');
                
                // 5ç§’å¾Œã«çŠ¶æ³ã‚’ç¢ºèª
                setTimeout(() => {
                    checkCurrentStatus();
                }, 5000);
            } else {
                log('âŒ ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã—ãŸã€‚æ‰‹å‹•ã§é–‹ã„ã¦ãã ã•ã„', 'error');
            }
        }

        function checkCurrentStatus() {
            try {
                log('ğŸ“Š ç¾åœ¨ã®çŠ¶æ³ã‚’ç¢ºèªä¸­...', 'info');
                
                // LocalStorageã‹ã‚‰ç¾åœ¨ã®çŠ¶æ³ã‚’å–å¾—
                const answers = JSON.parse(localStorage.getItem('haqei_answers') || '[]');
                const session = JSON.parse(localStorage.getItem('haqei_session') || '{}');
                const analysisResult = JSON.parse(localStorage.getItem('haqei_analysis_result') || 'null');
                
                const status = {
                    answers: answers.length,
                    sessionActive: \!\!session.id,
                    analysisComplete: \!\!analysisResult,
                    currentStage: session.stage || 'unknown'
                };
                
                const statusContent = document.getElementById('status-content');
                statusContent.innerHTML = `
                    <div><strong>å›ç­”æ•°:</strong> ${status.answers}/30</div>
                    <div><strong>ã‚»ãƒƒã‚·ãƒ§ãƒ³:</strong> ${status.sessionActive ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'}</div>
                    <div><strong>åˆ†æçµæœ:</strong> ${status.analysisComplete ? 'å®Œäº†' : 'æœªå®Œäº†'}</div>
                    <div><strong>ç¾åœ¨ã‚¹ãƒ†ãƒ¼ã‚¸:</strong> ${status.currentStage}</div>
                `;
                
                // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹æ›´æ–°
                const progress = Math.max(
                    status.answers / 30 * 0.5,  // å›ç­”é€²æ—ï¼ˆ50%ã¾ã§ï¼‰
                    status.analysisComplete ? 1.0 : 0.5  // åˆ†æå®Œäº†ï¼ˆ100%ï¼‰
                );
                updateProgress(Math.round(progress * totalTests), totalTests);
                
                log(`ğŸ“Š ç¾åœ¨ã®çŠ¶æ³: ${status.answers}/30å•å›ç­”, ã‚¹ãƒ†ãƒ¼ã‚¸: ${status.currentStage}`, 'info');
                
                // å®Œäº†ãƒã‚§ãƒƒã‚¯
                if (status.answers === 30 && status.analysisComplete) {
                    log('ğŸ‰ 30å•å®Œäº†ã¨åˆ†æãŒå®Œäº†ã—ã¦ã„ã¾ã™ï¼', 'success');
                    validateCompletionFlow(status);
                } else if (status.answers === 30) {
                    log('âš ï¸ 30å•ã¯å®Œäº†ã—ã¦ã„ã¾ã™ãŒã€åˆ†æãŒæœªå®Œäº†ã§ã™', 'warning');
                } else if (status.answers > 0) {
                    log(`ğŸ“ ${status.answers}å•å›ç­”æ¸ˆã¿ã€ç¶™ç¶šä¸­...`, 'info');
                }
                
            } catch (error) {
                log(`âŒ çŠ¶æ³ç¢ºèªã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function validateCompletionFlow(status) {
            log('ğŸ” å®Œäº†ãƒ•ãƒ­ãƒ¼ã®è©³ç´°æ¤œè¨¼ã‚’é–‹å§‹...', 'info');
            
            try {
                const answers = JSON.parse(localStorage.getItem('haqei_answers') || '[]');
                const analysisResult = JSON.parse(localStorage.getItem('haqei_analysis_result') || 'null');
                
                // ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯
                const dataIntegrity = {
                    answersCount: answers.length === 30,
                    analysisStructure: analysisResult && 
                                     analysisResult.engineOS && 
                                     analysisResult.interfaceOS && 
                                     analysisResult.safeModeOS,
                    answerFormat: answers.every(answer => 
                        answer.questionId && 
                        answer.selectedValue && 
                        answer.selectedChoice
                    )
                };
                
                log('ğŸ” ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§æ¤œè¨¼:', 'info');
                log(`  - å›ç­”æ•°: ${dataIntegrity.answersCount ? 'âœ…' : 'âŒ'} (${answers.length}/30)`, 
                    dataIntegrity.answersCount ? 'success' : 'error');
                log(`  - åˆ†ææ§‹é€ : ${dataIntegrity.analysisStructure ? 'âœ…' : 'âŒ'}`, 
                    dataIntegrity.analysisStructure ? 'success' : 'error');
                log(`  - å›ç­”ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ${dataIntegrity.answerFormat ? 'âœ…' : 'âŒ'}`, 
                    dataIntegrity.answerFormat ? 'success' : 'error');
                
                if (Object.values(dataIntegrity).every(v => v)) {
                    log('ğŸ¯ 30å•å®Œäº†ãƒ•ãƒ­ãƒ¼æ¤œè¨¼: å®Œå…¨æˆåŠŸï¼', 'success');
                    updateProgress(totalTests, totalTests);
                } else {
                    log('âš ï¸ 30å•å®Œäº†ãƒ•ãƒ­ãƒ¼ã§å•é¡ŒãŒç™ºè¦‹ã•ã‚Œã¾ã—ãŸ', 'warning');
                }
                
            } catch (error) {
                log(`âŒ å®Œäº†ãƒ•ãƒ­ãƒ¼æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function clearStorage() {
            try {
                localStorage.removeItem('haqei_answers');
                localStorage.removeItem('haqei_session');
                localStorage.removeItem('haqei_analysis_result');
                
                log('ğŸ—‘ï¸ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ', 'success');
                
                // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒªã‚»ãƒƒãƒˆ
                document.getElementById('status-content').innerHTML = 'åˆæœŸçŠ¶æ…‹ï¼ˆã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢æ¸ˆã¿ï¼‰';
                updateProgress(0, totalTests);
                
            } catch (error) {
                log(`âŒ ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
            }
        }

        function startAutoTest() {
            // è‡ªå‹•ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ï¼ˆä»Šå¾Œå®Ÿè£…äºˆå®šï¼‰
            log('ğŸ¤– è‡ªå‹•ãƒ†ã‚¹ãƒˆæ©Ÿèƒ½ã¯é–‹ç™ºä¸­ã§ã™', 'warning');
            log('ç¾åœ¨ã¯æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚’ã”åˆ©ç”¨ãã ã•ã„', 'info');
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ HAQEI 30å•å®Œäº†ãƒ•ãƒ­ãƒ¼æ¤œè¨¼ãƒ„ãƒ¼ãƒ«é–‹å§‹', 'success');
            log('æ‰‹å‹•ãƒ†ã‚¹ãƒˆã‚’é–‹å§‹ã—ã¦ãã ã•ã„', 'info');
            
            // å®šæœŸçš„ãªçŠ¶æ³ãƒã‚§ãƒƒã‚¯
            setInterval(checkCurrentStatus, 10000); // 10ç§’ã”ã¨
        });

        // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹å‰ã®è­¦å‘Š
        window.addEventListener('beforeunload', function(e) {
            if (testWindow && \!testWindow.closed) {
                testWindow.close();
            }
        });
    </script>
</body>
</html>
EOF < /dev/null