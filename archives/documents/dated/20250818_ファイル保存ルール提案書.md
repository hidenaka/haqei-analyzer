# ファイル保存ルール提案書

**作成日**: 2025年8月18日  
**目的**: 重複ファイル問題の根本解決

## 🚨 現在の問題

### 根本原因分析（5WHY）
```
問題: 同名ファイルが複数箇所に作成される
Why1: なぜ？ → 保存場所のルールが不明確
Why2: なぜ？ → ディレクトリ構造の定義がない
Why3: なぜ？ → CLAUDE.mdに具体的な保存ルールがない
Why4: なぜ？ → 開発時に場当たり的に作成してきた
Why5: なぜ？ → 最初に構造設計をしなかった
対策: 明確なファイル保存ルールを定義し、CLAUDE.mdに追記
```

## 📁 提案するディレクトリ構造とルール

### 1. JavaScriptファイルの保存場所

```
public/
  assets/js/           # ビルド済み・外部ライブラリ
    app.js            # メインアプリケーション（統合済み）
    questions-*.js    # 質問データ
    
  js/                 # 開発用JavaScriptファイル
    ├── *.js          # メインモジュール（単一責任）
    │   QuestionManager.js
    │   ScreenManager.js
    │   os-analyzer-main.js
    │
    ├── core/         # コア機能（システム基盤）
    │   ├── PerformanceOptimizer.js
    │   ├── DataPersistenceManager.js
    │   └── [基盤系モジュール]
    │
    ├── iching/       # I-Ching関連（易経専門）
    │   ├── KingWenMapping.js
    │   ├── LineSelector.js
    │   └── [易経関連モジュール]
    │
    ├── components/   # UIコンポーネント
    │   └── [UI部品]
    │
    └── utils/        # ユーティリティ
        └── [汎用関数]
```

### 2. 保存ルール

#### ❌ 禁止事項
1. **同名ファイルの作成禁止**
   - 作成前に必ず `find . -name "ファイル名.js"` で確認
   - 既存があれば修正、なければ新規作成

2. **階層の重複禁止**
   - `js/ファイル.js` と `js/フォルダ/同じファイル.js` の共存禁止

3. **ルート直下へのJS配置禁止**
   - `public/emergency-bypass.js` のような配置は禁止

#### ✅ 必須事項
1. **カテゴリ別フォルダ使用**
   - I-Ching関連 → `js/iching/`
   - コア機能 → `js/core/`
   - UIコンポーネント → `js/components/`

2. **ファイル作成前の確認**
   ```bash
   # 必ず実行
   find public -name "作成予定のファイル名.js"
   # 結果が0件なら作成可能
   ```

3. **既存ファイルの修正優先**
   - 新規作成より既存修正を優先
   - 機能追加は既存ファイルに統合

### 3. HTMLでの読み込み順序

```html
<!-- 1. 外部ライブラリ -->
<script src="lib/external.js"></script>

<!-- 2. コア機能 -->
<script src="js/core/DataPersistenceManager.js"></script>

<!-- 3. I-Ching機能 -->
<script src="js/iching/KingWenMapping.js"></script>

<!-- 4. メインモジュール -->
<script src="js/ScreenManager.js"></script>
<script src="js/QuestionManager.js"></script>

<!-- 5. アプリケーション -->
<script src="assets/js/app.js"></script>
```

## 📝 CLAUDE.mdへの追記提案

```markdown
## 📂 ファイル保存ルール（必須）

### JSファイル作成時の確認
```bash
# 1. 既存ファイルの確認（必須）
find public -name "ファイル名.js"

# 2. 既存があれば修正、なければ適切な場所に新規作成
# 場所の判断基準:
# - I-Ching関連: js/iching/
# - コア機能: js/core/
# - UI部品: js/components/
# - その他: js/直下
```

### 禁止事項
- 同名ファイルの作成
- public/直下へのJS配置
- "ついでに"別の場所にコピー

### クラス名の一意性
- 1クラス = 1ファイル
- クラス名の重複禁止
- export/importで明示的に管理
```

## 🎯 期待される効果

1. **重複ファイルの防止**
   - 作成前チェックで重複を防ぐ
   - 明確な配置ルールで迷わない

2. **メンテナンス性向上**
   - どこに何があるか明確
   - 修正箇所が一意に決まる

3. **初期化エラーの防止**
   - クラスの重複定義がなくなる
   - 読み込み順序が明確

## 📋 実装チェックリスト

新しいファイルを作成する前に：

- [ ] `find public -name "ファイル名.js"` を実行した
- [ ] 既存ファイルがないことを確認した
- [ ] 適切なフォルダを選択した
- [ ] クラス名の重複を確認した
- [ ] HTMLでの読み込み順序を考慮した

## 結論

**ファイル保存ルールの明確化**が根本解決の鍵です。
このルールをCLAUDE.mdに追記し、厳守することで、今回のような重複ファイル問題を防げます。