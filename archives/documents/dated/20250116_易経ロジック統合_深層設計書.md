# 易経ロジック統合 深層設計書
作成日: 2025年1月16日

## 🎯 設計理念
**表層はシンプルに、深層は易経の智慧で**

ユーザーには分かりやすい日常的な質問を提示しながら、背後では易経の深遠な哲学的ロジックで計算を行う二層構造システムを構築する。

## 📐 アーキテクチャ設計

### 1. 二層構造モデル

```
┌─────────────────────────────────────┐
│         表層（ユーザー層）            │
│   - 平易な日常言語での質問文         │
│   - 具体的な状況や行動の選択肢       │
│   - 直感的に選べる5つの回答          │
└─────────────────────────────────────┘
                ↓↑ 変換層
┌─────────────────────────────────────┐
│         深層（易経計算層）            │
│   - 八卦の相互作用計算              │
│   - 陰陽五行の動的バランス          │
│   - 64卦の変化パターン分析          │
│   - 時節と方位の影響計算            │
└─────────────────────────────────────┘
```

### 2. 質問設計の革新的アプローチ

#### 2.1 表層質問の設計原則
```javascript
// 悪い例（専門的すぎる）
"乾為天の創造原理における陽の発動をどう表現しますか？"

// 良い例（日常的で分かりやすい）
"新しいプロジェクトを始めるとき、どんな気持ちになりますか？"
```

#### 2.2 深層マッピングシステム
```javascript
const questionMapping = {
    surface: {
        text: "新しいプロジェクトを始めるとき、どんな気持ちになりますか？",
        options: [
            "ワクワクして今すぐ始めたい",
            "じっくり計画を立ててから始めたい",
            "仲間と一緒に始めたい",
            "確実な方法で着実に始めたい",
            "状況を見ながら柔軟に始めたい"
        ]
    },
    
    yijingLogic: {
        // 質問の易経的本質
        essence: "乾（天）の創造性発動における個人の傾向性測定",
        
        // 各選択肢の易経的意味
        optionMeanings: {
            A: {
                trigram: "乾",
                nature: "純陽",
                movement: "上昇",
                element: "金",
                season: "秋末",
                time: "戌亥",
                yinyang: { yang: 100, yin: 0 }
            },
            B: {
                trigram: "坎",
                nature: "険中求通",
                movement: "下降浸透",
                element: "水",
                season: "冬",
                time: "子",
                yinyang: { yang: 50, yin: 50 }
            },
            C: {
                trigram: "兌",
                nature: "説悦",
                movement: "内収",
                element: "金",
                season: "秋",
                time: "酉",
                yinyang: { yang: 25, yin: 75 }
            },
            D: {
                trigram: "艮",
                nature: "止静",
                movement: "不動",
                element: "土",
                season: "冬春之交",
                time: "丑寅",
                yinyang: { yang: 75, yin: 25 }
            },
            E: {
                trigram: "巽",
                nature: "入順",
                movement: "浸透",
                element: "木",
                season: "春夏之交",
                time: "辰巳",
                yinyang: { yang: 25, yin: 75 }
            }
        }
    }
};
```

## 🔮 易経計算ロジックの深層実装

### 3. 八卦相互作用マトリックス

```javascript
class YijingCalculationEngine {
    constructor() {
        // 八卦の相生相剋関係を定義
        this.trigramInteractions = {
            相生: {
                "乾": ["兌", "離"],  // 金生水、創造が調和と表現を生む
                "兌": ["坎", "坤"],  // 沢が水を蓄え、地を潤す
                "離": ["巽", "震"],  // 火が風を起こし、雷を呼ぶ
                "震": ["巽", "離"],  // 雷が風を伴い、光を放つ
                "巽": ["震", "坎"],  // 風が雷を運び、水を動かす
                "坎": ["巽", "艮"],  // 水が風に乗り、山を潤す
                "艮": ["坤", "乾"],  // 山が地を支え、天に至る
                "坤": ["艮", "兌"]   // 地が山を生み、沢を作る
            },
            
            相剋: {
                "乾": ["巽", "坤"],  // 天が風を抑え、地を圧する
                "兌": ["離", "震"],  // 沢が火を消し、雷を静める
                "離": ["坎", "艮"],  // 火が水と争い、山を焼く
                "震": ["艮", "坤"],  // 雷が山を砕き、地を震わす
                "巽": ["艮", "乾"],  // 風が山に阻まれ、天に届かず
                "坎": ["離", "兌"],  // 水が火を消し、沢に流れる
                "艮": ["震", "巽"],  // 山が雷を止め、風を防ぐ
                "坤": ["乾", "震"]   // 地が天に対し、雷を吸収する
            }
        };
        
        // 時節による影響係数
        this.seasonalCoefficients = {
            春: { "震": 1.3, "巽": 1.2, "離": 1.1 },
            夏: { "離": 1.3, "坤": 1.2, "兌": 1.1 },
            秋: { "兌": 1.3, "乾": 1.2, "艮": 1.1 },
            冬: { "坎": 1.3, "艮": 1.2, "乾": 1.1 }
        };
    }
    
    calculateTrigramScore(answer, context) {
        const base = answer.yijingLogic.optionMeanings[answer.value];
        let score = 1.0;
        
        // 1. 基本的な卦の強さ
        score *= this.getTrigramStrength(base.trigram);
        
        // 2. 陰陽バランスによる調整
        score *= this.calculateYinYangHarmony(base.yinyang, context.currentBalance);
        
        // 3. 五行の相生相剋
        score *= this.calculateWuxingInteraction(base.element, context.dominantElement);
        
        // 4. 時節との調和
        score *= this.getSeasonalAlignment(base.season, context.currentSeason);
        
        // 5. 前の回答との関係性（相生相剋）
        if (context.previousTrigram) {
            score *= this.calculateTrigramInteraction(
                context.previousTrigram, 
                base.trigram
            );
        }
        
        // 6. 64卦への発展可能性
        score *= this.calculate64GuaPotential(base.trigram, context);
        
        return score;
    }
    
    calculateYinYangHarmony(answerBalance, currentBalance) {
        // 陰陽の調和を求める計算
        const targetBalance = { yang: 50, yin: 50 };
        const newBalance = {
            yang: (currentBalance.yang * 0.7 + answerBalance.yang * 0.3),
            yin: (currentBalance.yin * 0.7 + answerBalance.yin * 0.3)
        };
        
        // 理想的なバランスに近いほど高スコア
        const deviation = Math.abs(newBalance.yang - targetBalance.yang);
        return 1.0 + (50 - deviation) / 100; // 0.5 ~ 1.5の範囲
    }
    
    calculateWuxingInteraction(element, dominantElement) {
        const wuxing = {
            相生: {
                "木": "火", "火": "土", "土": "金", 
                "金": "水", "水": "木"
            },
            相剋: {
                "木": "土", "土": "水", "水": "火",
                "火": "金", "金": "木"
            }
        };
        
        if (wuxing.相生[dominantElement] === element) {
            return 1.3; // 相生関係でブースト
        } else if (wuxing.相剋[dominantElement] === element) {
            return 0.7; // 相剋関係で減衰
        }
        return 1.0; // 中立
    }
    
    calculate64GuaPotential(trigram, context) {
        // 現在の卦から発展可能な64卦のパターンを分析
        const upperTrigram = context.dominantUpperTrigram || trigram;
        const lowerTrigram = trigram;
        
        // 64卦のインデックスを計算
        const guaIndex = this.getGuaIndex(upperTrigram, lowerTrigram);
        
        // 吉卦への発展可能性を評価
        const potential = this.evaluateGuaDevelopment(guaIndex);
        
        return 0.8 + (potential * 0.4); // 0.8 ~ 1.2の範囲
    }
    
    getGuaIndex(upper, lower) {
        const trigramIndex = {
            "乾": 0, "兌": 1, "離": 2, "震": 3,
            "巽": 4, "坎": 5, "艮": 6, "坤": 7
        };
        return trigramIndex[upper] * 8 + trigramIndex[lower];
    }
    
    evaluateGuaDevelopment(guaIndex) {
        // 64卦の吉凶と発展性を評価
        const guaQualities = {
            0: 1.0,   // 乾為天 - 最大の創造力
            1: 0.9,   // 天沢履 - 礼を踏む
            11: 0.95, // 地天泰 - 泰平
            14: 0.85, // 火天大有 - 大いに有る
            // ... 他の60卦
            63: 0.7   // 水火既済 - 既に済む
        };
        
        return guaQualities[guaIndex] || 0.5;
    }
}
```

### 4. 動的スコアリングシステム

```javascript
class DynamicScoringSystem {
    constructor() {
        this.yijingEngine = new YijingCalculationEngine();
        this.context = {
            currentBalance: { yang: 50, yin: 50 },
            dominantElement: null,
            currentSeason: this.getCurrentSeason(),
            previousTrigram: null,
            answeredQuestions: [],
            dominantUpperTrigram: null
        };
    }
    
    scoreAnswer(questionId, answer) {
        // 表層のシンプルな点数（ユーザーに見える）
        const surfaceScore = this.getSimplifiedScore(answer);
        
        // 深層の易経計算（内部ロジック）
        const yijingScore = this.yijingEngine.calculateTrigramScore(
            answer, 
            this.context
        );
        
        // コンテキストの更新
        this.updateContext(answer);
        
        // 最終スコアの計算
        const finalScore = {
            display: surfaceScore,  // ユーザーに表示
            actual: this.integrateScores(surfaceScore, yijingScore), // 実際の計算
            interpretation: this.generateInterpretation(answer, yijingScore)
        };
        
        return finalScore;
    }
    
    getSimplifiedScore(answer) {
        // ユーザーに見せるシンプルなスコア（6点満点維持）
        const distribution = {
            A: { engine: 3, interface: 2, safe: 1 },
            B: { engine: 3, interface: 1, safe: 2 },
            C: { engine: 2, interface: 2, safe: 2 },
            D: { engine: 1, interface: 3, safe: 2 },
            E: { engine: 1, interface: 2, safe: 3 }
        };
        return distribution[answer.value];
    }
    
    integrateScores(surface, yijing) {
        // 表層スコアに易経係数を掛ける
        return {
            engine: surface.engine * yijing,
            interface: surface.interface * yijing,
            safe: surface.safe * yijing,
            normalized: this.normalizeToSix(surface, yijing)
        };
    }
    
    normalizeToSix(surface, coefficient) {
        // 合計が6になるように正規化
        const total = (surface.engine + surface.interface + surface.safe) * coefficient;
        const ratio = 6 / total;
        
        return {
            engine: surface.engine * coefficient * ratio,
            interface: surface.interface * coefficient * ratio,
            safe: surface.safe * coefficient * ratio
        };
    }
    
    updateContext(answer) {
        const trigram = answer.yijingLogic.optionMeanings[answer.value].trigram;
        const element = answer.yijingLogic.optionMeanings[answer.value].element;
        const yinyang = answer.yijingLogic.optionMeanings[answer.value].yinyang;
        
        // コンテキストを更新
        this.context.previousTrigram = trigram;
        this.context.answeredQuestions.push(answer);
        
        // 陰陽バランスを更新
        this.context.currentBalance = {
            yang: (this.context.currentBalance.yang * 0.8 + yinyang.yang * 0.2),
            yin: (this.context.currentBalance.yin * 0.8 + yinyang.yin * 0.2)
        };
        
        // 支配的な元素を更新
        this.updateDominantElement(element);
        
        // 上卦の傾向を分析
        if (this.context.answeredQuestions.length % 3 === 0) {
            this.analyzeDominantUpperTrigram();
        }
    }
    
    getCurrentSeason() {
        const month = new Date().getMonth();
        if (month >= 2 && month <= 4) return "春";
        if (month >= 5 && month <= 7) return "夏";
        if (month >= 8 && month <= 10) return "秋";
        return "冬";
    }
}
```

### 5. 質問文の変換システム

```javascript
class QuestionTransformer {
    constructor() {
        this.transformationRules = {
            // 易経用語を日常語に変換
            "創造性": ["新しいこと", "スタート", "始まり"],
            "調和性": ["みんなとの関係", "チームワーク", "協力"],
            "探求性": ["深く知りたい", "理解したい", "学びたい"],
            "行動性": ["動き出す", "実行する", "アクション"],
            "表現性": ["自分を出す", "伝える", "見せる"],
            "適応性": ["変化に対応", "柔軟に", "調整"],
            "安定性": ["しっかりと", "確実に", "着実に"],
            "受容性": ["受け入れる", "包み込む", "優しく"]
        };
    }
    
    transformQuestion(originalQuestion) {
        // 専門的な質問を平易に変換
        const transformed = {
            original: originalQuestion.text,
            simplified: this.simplifyText(originalQuestion.text),
            context: this.addContextualHint(originalQuestion.category),
            options: originalQuestion.options.map(opt => 
                this.simplifyOption(opt)
            )
        };
        
        return transformed;
    }
    
    simplifyText(text) {
        // 例: "乾為天の創造原理における..." → "新しいことを始めるとき..."
        let simplified = text;
        
        // 易経専門用語を除去
        simplified = simplified.replace(/乾為天|坤為地|震為雷|巽為風|坎為水|離為火|艮為山|兌為沢/g, "");
        simplified = simplified.replace(/八卦|六爻|陰陽|五行/g, "");
        
        // より具体的な表現に変換
        simplified = simplified.replace(/創造原理/g, "新しいスタート");
        simplified = simplified.replace(/調和的関係性/g, "良い関係");
        
        return simplified;
    }
    
    addContextualHint(category) {
        // カテゴリーに応じた文脈的ヒントを追加
        const hints = {
            "創造性": "💡 アイデアや新しい挑戦について",
            "調和性": "🤝 人との関わり方について",
            "探求性": "🔍 学びや理解について",
            "行動性": "🏃 実行力や決断について",
            "表現性": "🎨 自己表現について",
            "適応性": "🌊 変化への対応について",
            "安定性": "⛰️ 確実性や継続性について",
            "受容性": "🤗 受け入れる姿勢について"
        };
        
        return hints[category.title] || "";
    }
}
```

## 📊 統合実装計画

### Phase 1: 基礎構築（4時間）

#### 1.1 易経計算エンジンの実装
```javascript
// yijing-core-engine.js
export class YijingCoreEngine {
    constructor() {
        this.initializeTrigramRelations();
        this.initializeWuxingCycles();
        this.initialize64Gua();
    }
    
    // 八卦関係の初期化
    initializeTrigramRelations() {
        // 相生、相剋、相合、相沖の関係を定義
    }
    
    // 五行循環の初期化
    initializeWuxingCycles() {
        // 木火土金水の循環と相互作用を定義
    }
    
    // 64卦システムの初期化
    initialize64Gua() {
        // 全64卦のパターンと意味を定義
    }
}
```

#### 1.2 質問変換システムの実装
```javascript
// question-transformer.js
export class QuestionTransformer {
    transformToUserFriendly(yijingQuestion) {
        // 易経的質問を平易な表現に変換
    }
    
    maintainYijingLogic(simplifiedQuestion) {
        // 簡略化された質問に易経ロジックを保持
    }
}
```

### Phase 2: スコアリング統合（4時間）

#### 2.1 二層スコアリングシステム
```javascript
// dual-layer-scoring.js
export class DualLayerScoring {
    constructor() {
        this.surfaceScoring = new SurfaceScoring();  // ユーザー向け
        this.yijingScoring = new YijingScoring();    // 内部計算
    }
    
    calculateScore(answer, context) {
        // 表層スコア（固定6点）
        const surface = this.surfaceScoring.calculate(answer);
        
        // 深層スコア（易経ロジック）
        const yijing = this.yijingScoring.calculate(answer, context);
        
        // 統合と正規化
        return this.integrate(surface, yijing);
    }
}
```

#### 2.2 コンテキスト管理システム
```javascript
// context-manager.js
export class ContextManager {
    constructor() {
        this.userContext = {};    // ユーザーの回答履歴
        this.yijingContext = {};  // 易経的文脈
        this.temporalContext = {}; // 時節的文脈
    }
    
    updateWithAnswer(answer) {
        this.updateUserContext(answer);
        this.updateYijingContext(answer);
        this.updateTemporalContext();
    }
}
```

### Phase 3: UI実装（3時間）

#### 3.1 質問表示の最適化
```html
<!-- 質問表示コンポーネント -->
<div class="question-container">
    <div class="question-text">
        <!-- 平易な質問文 -->
        <h3>新しいプロジェクトを始めるとき、どんな気持ちになりますか？</h3>
        
        <!-- オプション：易経ヒントの表示/非表示 -->
        <button class="yijing-hint-toggle" aria-label="詳細を見る">
            <span class="icon">💭</span>
        </button>
        
        <!-- 易経的背景（デフォルト非表示） -->
        <div class="yijing-context hidden">
            <small>この質問は創造性（乾卦）の発現を測定します</small>
        </div>
    </div>
    
    <div class="options">
        <!-- シンプルな選択肢 -->
    </div>
</div>
```

#### 3.2 結果表示の多層化
```javascript
// result-display.js
class ResultDisplay {
    displayResults(results) {
        // レベル1: 基本結果（全員に表示）
        this.showBasicResults(results.surface);
        
        // レベル2: 易経解釈（オプション）
        if (settings.showYijing) {
            this.showYijingInterpretation(results.yijing);
        }
        
        // レベル3: 詳細分析（上級者向け）
        if (settings.expertMode) {
            this.showDetailedAnalysis(results.detailed);
        }
    }
}
```

### Phase 4: テストと検証（3時間）

#### 4.1 ロジック検証テスト
```javascript
describe('易経ロジック検証', () => {
    test('陰陽バランス計算が正確', () => {
        // 各回答パターンで陰陽バランスが適切に計算されるか
    });
    
    test('五行相生相剋が正しく機能', () => {
        // 五行の関係性が正しく反映されるか
    });
    
    test('64卦への発展が論理的', () => {
        // 回答から64卦への展開が易経理論に沿っているか
    });
});
```

#### 4.2 ユーザビリティテスト
```javascript
describe('ユーザビリティ検証', () => {
    test('質問文が平易で理解しやすい', () => {
        // 専門用語が除去されているか
        // 日常的な表現になっているか
    });
    
    test('スコアの合計が常に6点', () => {
        // 数学的健全性の維持
    });
    
    test('易経モードの切り替えがスムーズ', () => {
        // UIの反応性とモード切り替え
    });
});
```

## 🎯 成功指標

### 技術的指標
1. **計算精度**: 易経理論との一致率 > 95%
2. **パフォーマンス**: 全計算 < 50ms
3. **正規化精度**: スコア合計の誤差 < 0.01
4. **コンテキスト保持**: セッション間での一貫性 100%

### ユーザー体験指標
1. **理解度**: 質問の理解しやすさ評価 > 4.5/5
2. **選択容易性**: 回答選択の迷い < 10秒/問
3. **結果納得度**: 結果への納得感 > 4.0/5
4. **再利用意向**: リピート率 > 60%

## 📋 実装優先順位

### 必須実装（MVP）
1. ✅ 易経計算エンジンのコア部分
2. ✅ 質問文の平易化
3. ✅ 二層スコアリングシステム
4. ✅ 基本的な結果表示

### 追加機能（Phase 2）
1. ⏸ 詳細な易経解釈表示
2. ⏸ 時節による動的調整
3. ⏸ 個人化された成長アドバイス
4. ⏸ 過去データとの比較分析

### 将来拡張（Phase 3）
1. 🔮 AI による個別カスタマイズ
2. 🔮 他の東洋哲学との統合
3. 🔮 コミュニティ機能
4. 🔮 専門家による解釈サービス

## ✅ 実装チェックリスト

### Day 1（8時間）
- [ ] 易経計算エンジンの基本実装
- [ ] 八卦相互作用マトリックスの構築
- [ ] 五行循環システムの実装
- [ ] 質問変換システムの基本実装

### Day 2（6時間）
- [ ] 二層スコアリングシステムの実装
- [ ] コンテキスト管理システムの構築
- [ ] UI コンポーネントの実装
- [ ] 基本的な結果表示機能

### Day 3（4時間）
- [ ] 統合テストの実施
- [ ] パフォーマンス最適化
- [ ] ユーザビリティテスト
- [ ] ドキュメント作成

## 🔑 核心的な差別化要因

### 1. **透明性のあるデュアルシステム**
- ユーザーには分かりやすさを提供
- 専門家には深い洞察を提供
- 両方のニーズを同時に満たす

### 2. **動的コンテキスト計算**
- 回答の順序と関係性を考慮
- 時節と個人の状態を反映
- 真に個別化された分析

### 3. **易経理論の完全実装**
- 64卦すべての関係性
- 五行と八卦の相互作用
- 変爻による未来予測

これにより、表面的にはシンプルで使いやすく、内部では易経の深遠な智慧が働く、革新的なシステムが実現します。