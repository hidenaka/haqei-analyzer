# ğŸ¨ HaQei Triple OS Analyzer è¨­è¨ˆæ›¸

**ä½œæˆæ—¥**: 2025å¹´8æœˆ16æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**: HaQei OSAnalyzer å®Œå…¨å†æ§‹ç¯‰  

---

## 1. ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­è¨ˆ

### 1.1 ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Presentation Layer (HTML/CSS)                  â”‚
â”‚  â”œâ”€â”€ index.html (ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ)               â”‚
â”‚  â”œâ”€â”€ styles.css (çµ±ä¸€ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆ)              â”‚
â”‚  â””â”€â”€ components/ (UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Application Layer (JavaScript)                 â”‚
â”‚  â”œâ”€â”€ app.js (ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼)                â”‚
â”‚  â”œâ”€â”€ screens/ (ç”»é¢åˆ¶å¾¡)                        â”‚
â”‚  â”œâ”€â”€ analyzers/ (åˆ†æã‚¨ãƒ³ã‚¸ãƒ³)                  â”‚
â”‚  â””â”€â”€ utils/ (ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Data Layer                                     â”‚
â”‚  â”œâ”€â”€ questions.json (è³ªå•ãƒ‡ãƒ¼ã‚¿)                 â”‚
â”‚  â”œâ”€â”€ hexagrams.json (æ˜“å¦ãƒ‡ãƒ¼ã‚¿)                â”‚
â”‚  â””â”€â”€ localStorage (ä¸€æ™‚ä¿å­˜)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 
```
haqei-analyzer/
â”œâ”€â”€ index.html                    # ãƒ¡ã‚¤ãƒ³HTML
â”œâ”€â”€ styles.css                    # çµ±ä¸€CSS
â”œâ”€â”€ js/
â”‚   â”œâ”€â”€ app.js                   # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ
â”‚   â”œâ”€â”€ core/
â”‚   â”‚   â”œâ”€â”€ StateManager.js      # çŠ¶æ…‹ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ EventBus.js          # ã‚¤ãƒ™ãƒ³ãƒˆç®¡ç†
â”‚   â”‚   â””â”€â”€ Router.js            # ç”»é¢é·ç§»ç®¡ç†
â”‚   â”œâ”€â”€ screens/
â”‚   â”‚   â”œâ”€â”€ WelcomeScreen.js     # ã‚¦ã‚§ãƒ«ã‚«ãƒ ç”»é¢
â”‚   â”‚   â”œâ”€â”€ QuestionScreen.js    # è³ªå•ç”»é¢
â”‚   â”‚   â””â”€â”€ ResultScreen.js      # çµæœç”»é¢
â”‚   â”œâ”€â”€ analyzers/
â”‚   â”‚   â”œâ”€â”€ TripleOSAnalyzer.js  # Triple OSåˆ†æ
â”‚   â”‚   â”œâ”€â”€ HexagramMapper.js    # æ˜“å¦ãƒãƒƒãƒ”ãƒ³ã‚°
â”‚   â”‚   â””â”€â”€ InteractionAnalyzer.js # ç›¸äº’ä½œç”¨åˆ†æ
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ DataValidator.js     # ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
â”‚       â”œâ”€â”€ Calculator.js        # è¨ˆç®—ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
â”‚       â””â”€â”€ DOMHelper.js         # DOMæ“ä½œãƒ˜ãƒ«ãƒ‘ãƒ¼
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ questions.json           # 36å•ã®è³ªå•ãƒ‡ãƒ¼ã‚¿
â”‚   â””â”€â”€ hexagrams.json          # 64å¦ãƒ‡ãƒ¼ã‚¿
â””â”€â”€ assets/
    â””â”€â”€ images/                  # ç”»åƒãƒªã‚½ãƒ¼ã‚¹
```

---

## 2. ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

### 2.1 çŠ¶æ…‹ç®¡ç†
```javascript
// ã‚°ãƒ­ãƒ¼ãƒãƒ«çŠ¶æ…‹æ§‹é€ 
const AppState = {
  currentScreen: 'welcome' | 'question' | 'result',
  questionIndex: 0,  // 0-35
  answers: [],       // ['A', 'B', 'C', 'D', 'E']ã®é…åˆ—
  analysisResult: null,
  settings: {
    language: 'ja',
    theme: 'light'
  }
};
```

### 2.2 ã‚¤ãƒ™ãƒ³ãƒˆãƒ•ãƒ­ãƒ¼
```
[ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ] â†’ [Event] â†’ [Handler] â†’ [Stateæ›´æ–°] â†’ [Viewæ›´æ–°]

ä¾‹ï¼šè³ªå•å›ç­”ãƒ•ãƒ­ãƒ¼
1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒé¸æŠè‚¢ã‚¯ãƒªãƒƒã‚¯
2. 'answer:selected' ã‚¤ãƒ™ãƒ³ãƒˆç™ºç«
3. QuestionHandler ãŒå‡¦ç†
4. State.answers[index] æ›´æ–°
5. QuestionScreen.render() å®Ÿè¡Œ
```

### 2.3 ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³
```javascript
// å›ç­” â†’ ã‚¹ã‚³ã‚¢ â†’ æ˜“å¦ â†’ çµæœ
[Raw Answers] 
    â†“ calculateScores()
[OS Scores: {engine: 0.7, interface: 0.6, safe: 0.8}]
    â†“ mapToHexagrams()
[Hexagram IDs: {engine: 1, interface: 11, safe: 2}]
    â†“ generateDescriptions()
[Final Result: Complete TripleOS Analysis]
```

---

## 3. ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆè¨­è¨ˆ

### 3.1 HTMLãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ 
```html
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaQei Triple OS Analyzer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒˆ -->
    <div id="app">
        <!-- å‹•çš„ã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ãŒæŒ¿å…¥ã•ã‚Œã‚‹ -->
    </div>
    
    <!-- JavaScriptãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ« -->
    <script type="module" src="js/app.js"></script>
</body>
</html>
```

### 3.2 ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

#### WelcomeScreen
```javascript
class WelcomeScreen {
    constructor() {
        this.template = `
            <section class="screen welcome-screen">
                <header class="hero">
                    <h1>HaQei Triple OS Analyzer</h1>
                    <p class="subtitle">ã‚ãªãŸã®3ã¤ã®ä»®æƒ³äººæ ¼ã‚’ç™ºè¦‹ã™ã‚‹</p>
                </header>
                
                <div class="os-cards">
                    <article class="os-card engine">
                        <h2>Engine OS</h2>
                        <p>å‰µé€ ã¨æ¨é€²ã®äººæ ¼</p>
                    </article>
                    <article class="os-card interface">
                        <h2>Interface OS</h2>
                        <p>èª¿å’Œã¨å”èª¿ã®äººæ ¼</p>
                    </article>
                    <article class="os-card safe">
                        <h2>Safe Mode OS</h2>
                        <p>å®‰å…¨ã¨æ…é‡ã®äººæ ¼</p>
                    </article>
                </div>
                
                <button class="btn-primary" id="start-btn">
                    åˆ†æã‚’é–‹å§‹ã™ã‚‹
                </button>
            </section>
        `;
    }
}
```

#### QuestionScreen
```javascript
class QuestionScreen {
    constructor() {
        this.currentQuestion = 0;
    }
    
    render(questionData) {
        return `
            <section class="screen question-screen">
                <header class="progress-header">
                    <div class="progress-bar">
                        <div class="progress-fill" 
                             style="width: ${(this.currentQuestion/36)*100}%">
                        </div>
                    </div>
                    <span class="progress-text">
                        ${this.currentQuestion + 1} / 36
                    </span>
                </header>
                
                <main class="question-content">
                    <h2 class="question-text">
                        ${questionData.text}
                    </h2>
                    
                    <div class="options-list">
                        ${this.renderOptions(questionData.options)}
                    </div>
                </main>
                
                <footer class="question-footer">
                    <button class="btn-secondary" 
                            id="prev-btn" 
                            ${this.currentQuestion === 0 ? 'disabled' : ''}>
                        å‰ã¸
                    </button>
                    <button class="btn-primary" 
                            id="next-btn" 
                            disabled>
                        æ¬¡ã¸
                    </button>
                </footer>
            </section>
        `;
    }
}
```

#### ResultScreen
```javascript
class ResultScreen {
    render(analysisResult) {
        return `
            <section class="screen result-screen">
                <header class="result-header">
                    <h1>ã‚ãªãŸã®Triple OSåˆ†æçµæœ</h1>
                </header>
                
                <div class="os-results">
                    ${this.renderOSCard('engine', analysisResult.engine)}
                    ${this.renderOSCard('interface', analysisResult.interface)}
                    ${this.renderOSCard('safe', analysisResult.safeMode)}
                </div>
                
                <div class="interaction-analysis">
                    <h2>OSé–“ã®ç›¸äº’ä½œç”¨</h2>
                    <canvas id="radar-chart"></canvas>
                    <p>${analysisResult.interactions.description}</p>
                </div>
                
                <footer class="result-footer">
                    <button class="btn-primary" id="restart-btn">
                        ã‚‚ã†ä¸€åº¦åˆ†æã™ã‚‹
                    </button>
                </footer>
            </section>
        `;
    }
}
```

---

## 4. åˆ†æã‚¨ãƒ³ã‚¸ãƒ³è¨­è¨ˆ

### 4.1 TripleOSAnalyzer
```javascript
class TripleOSAnalyzer {
    constructor() {
        this.categories = {
            engine: [0, 3, 6, 9, 12, 15, 18, 21, 24, 27, 30, 33],
            interface: [1, 4, 7, 10, 13, 16, 19, 22, 25, 28, 31, 34],
            safe: [2, 5, 8, 11, 14, 17, 20, 23, 26, 29, 32, 35]
        };
    }
    
    analyze(answers) {
        const scores = this.calculateScores(answers);
        const hexagrams = this.mapToHexagrams(scores);
        const interactions = this.analyzeInteractions(scores);
        
        return {
            engine: {
                score: scores.engine,
                hexagramId: hexagrams.engine,
                ...this.generateOSData('engine', scores.engine, hexagrams.engine)
            },
            interface: { /* åŒæ§˜ */ },
            safeMode: { /* åŒæ§˜ */ },
            interactions
        };
    }
    
    calculateScores(answers) {
        const scoreMap = { A: 5, B: 4, C: 3, D: 2, E: 1 };
        
        return {
            engine: this.calculateCategoryScore(answers, 'engine', scoreMap),
            interface: this.calculateCategoryScore(answers, 'interface', scoreMap),
            safe: this.calculateCategoryScore(answers, 'safe', scoreMap)
        };
    }
}
```

### 4.2 HexagramMapper
```javascript
class HexagramMapper {
    constructor(hexagramData) {
        this.hexagrams = hexagramData;
    }
    
    mapScoreToHexagram(score, pattern) {
        // ã‚¹ã‚³ã‚¢ï¼ˆ0-1ï¼‰ã‚’64åˆ†å‰²ã—ã¦æ˜“å¦ã«ãƒãƒƒãƒ”ãƒ³ã‚°
        const index = Math.floor(score * 64);
        return this.hexagrams[Math.min(index, 63)];
    }
    
    getTrigramPair(hexagramId) {
        const hexagram = this.hexagrams.find(h => h.id === hexagramId);
        return {
            upper: hexagram.trigrams.upper,
            lower: hexagram.trigrams.lower
        };
    }
}
```

---

## 5. ã‚¹ã‚¿ã‚¤ãƒ«è¨­è¨ˆ

### 5.1 CSSå¤‰æ•°å®šç¾©
```css
:root {
    /* ã‚«ãƒ©ãƒ¼ãƒ‘ãƒ¬ãƒƒãƒˆ */
    --color-primary: #4F7CAC;
    --color-secondary: #162447;
    --color-accent: #E43F6F;
    --color-success: #22C55E;
    --color-warning: #F59E0B;
    --color-error: #EF4444;
    
    /* ã‚¹ãƒšãƒ¼ã‚·ãƒ³ã‚° */
    --spacing-xs: 0.25rem;
    --spacing-sm: 0.5rem;
    --spacing-md: 1rem;
    --spacing-lg: 1.5rem;
    --spacing-xl: 2rem;
    
    /* ã‚¿ã‚¤ãƒã‚°ãƒ©ãƒ•ã‚£ */
    --font-family-base: 'Noto Sans JP', sans-serif;
    --font-family-mono: 'Roboto Mono', monospace;
    
    /* ãƒ–ãƒ¬ãƒ¼ã‚¯ãƒã‚¤ãƒ³ãƒˆ */
    --breakpoint-mobile: 320px;
    --breakpoint-tablet: 768px;
    --breakpoint-desktop: 1024px;
}
```

### 5.2 ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–ã‚°ãƒªãƒƒãƒ‰
```css
.container {
    width: 100%;
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--spacing-md);
}

.grid {
    display: grid;
    gap: var(--spacing-md);
}

/* ãƒ¢ãƒã‚¤ãƒ« */
@media (max-width: 767px) {
    .grid { grid-template-columns: 1fr; }
}

/* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆ */
@media (min-width: 768px) and (max-width: 1023px) {
    .grid { grid-template-columns: repeat(2, 1fr); }
}

/* ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ— */
@media (min-width: 1024px) {
    .grid { grid-template-columns: repeat(3, 1fr); }
}
```

---

## 6. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­è¨ˆ

### 6.1 å…¥åŠ›æ¤œè¨¼
```javascript
class DataValidator {
    static validateAnswer(answer) {
        const validAnswers = ['A', 'B', 'C', 'D', 'E'];
        return validAnswers.includes(answer);
    }
    
    static sanitizeInput(input) {
        return input
            .replace(/[<>]/g, '')
            .trim()
            .substring(0, 1000);
    }
}
```

### 6.2 CSPè¨­å®š
```html
<meta http-equiv="Content-Security-Policy" 
      content="default-src 'self'; 
               script-src 'self' 'unsafe-inline'; 
               style-src 'self' 'unsafe-inline'; 
               img-src 'self' data:;">
```

---

## 7. ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–

### 7.1 é…å»¶èª­ã¿è¾¼ã¿
```javascript
// çµæœç”»é¢ã§å¿…è¦ãªChart.jsã‚’é…å»¶èª­ã¿è¾¼ã¿
async function loadChartLibrary() {
    if (!window.Chart) {
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
        document.head.appendChild(script);
        
        return new Promise(resolve => {
            script.onload = resolve;
        });
    }
}
```

### 7.2 ãƒ¡ãƒ¢åŒ–
```javascript
const memoize = (fn) => {
    const cache = new Map();
    return (...args) => {
        const key = JSON.stringify(args);
        if (!cache.has(key)) {
            cache.set(key, fn(...args));
        }
        return cache.get(key);
    };
};

const calculateScores = memoize(originalCalculateScores);
```

---

## 8. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

### 8.1 ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼
```javascript
class ErrorHandler {
    static init() {
        window.addEventListener('error', (event) => {
            console.error('Global error:', event.error);
            this.showUserFriendlyError();
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            console.error('Unhandled promise rejection:', event.reason);
            this.showUserFriendlyError();
        });
    }
    
    static showUserFriendlyError() {
        const errorUI = document.createElement('div');
        errorUI.className = 'error-notification';
        errorUI.textContent = 'äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
        document.body.appendChild(errorUI);
    }
}
```

---

## 9. ãƒ†ã‚¹ãƒˆæˆ¦ç•¥

### 9.1 å˜ä½“ãƒ†ã‚¹ãƒˆæ§‹é€ 
```javascript
// __tests__/analyzers/TripleOSAnalyzer.test.js
describe('TripleOSAnalyzer', () => {
    test('æ­£ã—ãã‚¹ã‚³ã‚¢ã‚’è¨ˆç®—ã™ã‚‹', () => {
        const analyzer = new TripleOSAnalyzer();
        const answers = Array(36).fill('C'); // ã™ã¹ã¦ä¸­é–“å€¤
        const scores = analyzer.calculateScores(answers);
        
        expect(scores.engine).toBe(0.5);
        expect(scores.interface).toBe(0.5);
        expect(scores.safe).toBe(0.5);
    });
});
```

### 9.2 E2Eãƒ†ã‚¹ãƒˆ
```javascript
// e2e/complete-flow.test.js
describe('å®Œå…¨ãƒ•ãƒ­ãƒ¼', () => {
    test('36å•å›ç­”ã—ã¦çµæœãŒè¡¨ç¤ºã•ã‚Œã‚‹', async () => {
        await page.goto('http://localhost:8788');
        await page.click('#start-btn');
        
        // 36å•å›ç­”
        for (let i = 0; i < 36; i++) {
            await page.click('[data-answer="C"]');
            await page.click('#next-btn');
        }
        
        // çµæœç¢ºèª
        await expect(page).toHaveSelector('.result-screen');
        await expect(page).toHaveText('Engine OS');
    });
});
```

---

## 10. ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¡ãƒ³ãƒˆè¨­è¨ˆ

### 10.1 ãƒ“ãƒ«ãƒ‰ãƒ—ãƒ­ã‚»ã‚¹
```bash
# ãƒ“ãƒ«ãƒ‰ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
npm run build
# 1. JSãƒ•ã‚¡ã‚¤ãƒ«çµåˆãƒ»æœ€å°åŒ–
# 2. CSSæœ€å°åŒ–
# 3. ç”»åƒæœ€é©åŒ–
# 4. dist/ãƒ•ã‚©ãƒ«ãƒ€ã«å‡ºåŠ›
```

### 10.2 é…ä¿¡æ§‹æˆ
```
dist/
â”œâ”€â”€ index.html          # æœ€å°åŒ–æ¸ˆã¿
â”œâ”€â”€ app.min.js         # çµåˆãƒ»æœ€å°åŒ–æ¸ˆã¿
â”œâ”€â”€ styles.min.css     # æœ€å°åŒ–æ¸ˆã¿
â””â”€â”€ data/
    â””â”€â”€ combined.json  # è³ªå•ï¼‹æ˜“å¦ãƒ‡ãƒ¼ã‚¿çµåˆ
```

---

**æ‰¿èªè€…**: HaQei ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒãƒ¼ãƒ   
**æœ€çµ‚æ›´æ–°**: 2025å¹´8æœˆ16æ—¥