# 20250116_UI実装指示書

結論: コア機能は既に安定しており、UI層の4点を修正すれば完全動作します。易経統合の前に本ドキュメントのUI修正を実施してください。

- 対象主ファイル:
  - <mcfile name="os-analyzer-main.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/os-analyzer-main.js"></mcfile>
  - <mcfile name="ScreenManager.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/ScreenManager.js"></mcfile>
  - <mcfile name="QuestionManager.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/QuestionManager.js"></mcfile>
  - <mcfile name="VirtualPersonaEnhancer.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/VirtualPersonaEnhancer.js"></mcfile>
  - <mcfile name="app.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/assets/js/app.js"></mcfile>
  - <mcfile name="os_analyzer.html" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/os_analyzer.html"></mcfile>


1. 具体的な修正箇所と方法

1-1) VirtualPersonaEnhancer 初期化の堅牢化（セーフモードフォールバック）
- 目的: 初期化例外時でも UI を止めず、安全に続行する。
- 対応: DOMContentLoaded での初期化を try/catch で保護し、失敗時に initializeSafeMode() を実行。
- 変更対象: <mcfile name="os-analyzer-main.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/os-analyzer-main.js"></mcfile>
- 参考: <mcfile name="VirtualPersonaEnhancer.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/VirtualPersonaEnhancer.js"></mcfile> の initializeSafeMode 実装あり。

1-2) ScreenManager の showError 強化（画面要素存在チェック＋安全なフォールバック）
- 目的: 結果画面またはウェルカム画面で、エラーを必ず表示できるようにする。
- 対応: .results-screen が無い場合は .welcome-screen にインラインで表示、最終手段として alert。
- 変更対象: <mcfile name="ScreenManager.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/ScreenManager.js"></mcfile>

1-3) QuestionManager の DOM 取得の null チェック強化
- 目的: 質問文や選択肢コンテナが取得できない場合に、安全に停止しエラーを表示。
- 対応: コンストラクタおよび displayQuestion/saveAnswer 前に DOM 要素存在を検証、なければ ScreenManager.showError を呼ぶ。
- 変更対象: <mcfile name="QuestionManager.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/QuestionManager.js"></mcfile>

1-4) イベント重複バインドの抑止
- 目的: start/prev/next/restart の多重クリック処理・二重進行を防止。
- 対応: CriticalCSSAnalyzer.bindEvents に idempotent ガード（this._eventsBound）を追加。必要に応じて app.js 側の UI バインドは抑止。
- 変更対象: <mcfile name="os-analyzer-main.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/os-analyzer-main.js"></mcfile>、（必要時）<mcfile name="app.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/assets/js/app.js"></mcfile>
- 備考: <mcfile name="os_analyzer.html" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/os_analyzer.html"></mcfile> に app.js/emergency-bypass.js の <script> が無い場合は影響なし。将来読み込む場合に備えた防御的実装。


2. コピペ可能な修正コード

2-1) os-analyzer-main.js: VPE 初期化フォールバック（await不要・安全なPromise処理）

```js
// DOMContentLoaded 内の VPE 初期化部に貼り付け（既存初期化を置き換え）
(function(){
  function enterSafeMode() {
    try {
      if (!window.virtualPersonaEnhancer) {
        window.virtualPersonaEnhancer = new window.VirtualPersonaEnhancer();
      }
      if (typeof window.virtualPersonaEnhancer.initializeSafeMode === 'function') {
        window.virtualPersonaEnhancer.initializeSafeMode();
        window.__VPE_READY__ = true;
        window.__VPE_SAFE_MODE__ = true;
        console.log('🛡️ VPE safe mode initialized');
      } else {
        window.__VPE_READY__ = false;
      }
    } catch (e2) {
      console.error('❌ VPE safe mode failed:', e2);
      window.__VPE_READY__ = false;
    }
  }

  try {
    window.virtualPersonaEnhancer = new window.VirtualPersonaEnhancer();
  } catch (e) {
    console.error('❌ VPE construction failed, entering safe mode:', e);
    return enterSafeMode();
  }

  const init = window.virtualPersonaEnhancer && window.virtualPersonaEnhancer.initialize && window.virtualPersonaEnhancer.initialize.bind(window.virtualPersonaEnhancer);
  if (typeof init === 'function') {
    Promise.resolve(init())
      .then(() => {
        window.__VPE_READY__ = true;
        console.log('🎭 VPE ready');
      })
      .catch((e) => {
        console.error('❌ VPE init failed, entering safe mode:', e);
        enterSafeMode();
      });
  } else {
    window.__VPE_READY__ = true;
    console.log('🎭 VPE ready (no async init)');
  }
})();
```

2-2) ScreenManager.js: showError の強化

```js
showError(message) {
  try {
    console.error('ScreenManager.showError:', message);
    const resultsScreen = document.querySelector('.results-screen');
    if (resultsScreen) {
      const slot = resultsScreen.querySelector('.error-message')
        || resultsScreen.querySelector('.result-title')
        || resultsScreen;
      if (slot) slot.textContent = `エラー: ${message}`;
      this.switchTo && this.switchTo('results');
      return;
    }

    const welcome = document.querySelector('.welcome-screen');
    if (welcome) {
      const box = document.createElement('div');
      box.className = 'error-inline';
      box.textContent = `エラー: ${message}`;
      welcome.appendChild(box);
      this.switchTo && this.switchTo('welcome');
      return;
    }

    alert(`エラー: ${message}`);
  } catch (err) {
    console.error('showError fallback failed:', err);
    alert(`エラー: ${message}`);
  }
}
```

2-3) QuestionManager.js: DOM 要素の存在チェック

```js
// コンストラクタ末尾に追加
this._domReady = true;
this._questionTextEl = document.getElementById('question-text');
this._optionsContainer = document.getElementById('options-container');
if (!this._questionTextEl || !this._optionsContainer) {
  this._domReady = false;
  console.error('❌ QuestionManager init: Missing #question-text or #options-container');
  if (window.ScreenManager && typeof window.ScreenManager.showError === 'function') {
    window.ScreenManager.showError('質問UIのDOM要素が見つかりません。');
  }
}

// displayQuestion の先頭に追加
if (!this._domReady) return;

// saveAnswer の先頭に追加
if (!this._domReady) return;
```

2-4) os-analyzer-main.js: イベント重複バインドの抑止

```js
// CriticalCSSAnalyzer.prototype.bindEvents 内を以下のようにガード
bindEvents() {
  if (this._eventsBound) {
    console.warn('[UI] bindEvents skipped (already bound)');
    return;
  }
  this._eventsBound = true;

  const byId = (id) => document.getElementById(id);
  const on = (el, type, handler, opts) => el && el.addEventListener(type, handler, opts || false);

  on(byId('start-btn'), 'click', () => this.startAnalysis());
  on(byId('prev-btn'), 'click', () => this.previousQuestion());
  on(byId('next-btn'), 'click', () => this.nextQuestion());
  on(byId('restart-btn'), 'click', () => this.restart());
  on(byId('retry-btn'), 'click', () => this.restart());

  window.__UI_BINDER__ = 'CriticalCSSAnalyzer';
  console.log(`[UI] Events bound by ${window.__UI_BINDER__}`);
}
```

2-5) （必要時）assets/js/app.js 側の UI バインド抑止

```js
// setupEventHandlers の先頭に追加（os-analyzer-main.js が既にバインド済みならスキップ）
if (window.criticalCSSAnalyzer && window.criticalCSSAnalyzer._eventsBound) {
  console.warn('[UI] app.js: skip setupEventHandlers (CriticalCSSAnalyzer already bound)');
  return;
}
```


3. デバッグ用コード（必要時のみ貼り付け）

3-1) イベントバインド回数の可視化

```js
window.__BIND_COUNT__ = (window.__BIND_COUNT__ || 0) + 1;
console.log('🔧 UI bind count:', window.__BIND_COUNT__, 'by', window.__UI_BINDER__ || 'unknown');
```

3-2) 重要 UI ボタンの存在確認

```js
['start-btn','prev-btn','next-btn','restart-btn','retry-btn'].forEach(id => {
  console.log(`[chk] #${id}:`, !!document.getElementById(id));
});
```

3-3) VPE 強制セーフモードテスト（開発時のみ）

```js
// 仮に初期化箇所の try 内で以下を入れて throw を発生させると、セーフモードに入ることを確認できます。
if (window.__forceVPEFail__) { throw new Error('force vpe fail'); }
```

3-4) エラー表示の動作確認用

```js
if (window.ScreenManager && typeof window.ScreenManager.showError === 'function') {
  window.ScreenManager.showError('テストエラー: 表示パス確認');
}
```


4. 動作確認チェックリスト（手順）

- 初期表示
  - コンソールに「VPE ready」または「VPE safe mode initialized」が表示される
  - ボタン存在チェックログ（[chk] #start-btn: true 等）が想定どおり

- スタート操作
  - Start を1回クリック → 質問画面へ遷移し、二重遷移しない（bind count が1のまま）
  - Prev/Next で1問ずつ正しく移動する（スキップや二重進行がない）

- 結果表示
  - 最終質問の回答後に結果画面へ遷移し、例外が出ない
  - エラー発生時（DOM を一時的に改名する等）でも showError が結果 or ウェルカム画面にメッセージを表示する

- 回帰テスト
  - ページ再読み込み後もイベント多重バインドが起きない（ログで確認）
  - 将来 app.js を読み込んだ場合でも、片側が自動的にバインド抑止される

- レイテンシ/UX
  - 初回スクロール（start-btn への誘導）が意図どおり行われる（必要に応じて）


補足
- emergency-bypass.js でも #start-btn を参照する実装が存在しますが、現行の os_analyzer.html では読み込まれていません。将来読み込む場合は、同様に多重バインド抑止ガードを導入してください。
- unified 質問セット（36問）は <mcfile name="questions-unified-complete.js" path="/Users/hideakimacbookair/Desktop/haqei-analyzer/public/js/questions-unified-complete.js"></mcfile> で window.QUESTIONS に公開されています。8問システムで上書きされないことを確認してください。