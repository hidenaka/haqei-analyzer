name: HAQEI Release Gates
on:
  pull_request:
    branches: [ main, develop ]
  push:
    branches: [ main, develop ]

jobs:
  release-gates:
    runs-on: ubuntu-latest
    name: ğŸšª Production Release Gates
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with: 
          node-version: 20
          cache: 'npm'

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      # Gate 1: é‡è¤‡HTMLæ¤œå‡º
      - name: ğŸ” Assert Single os_analyzer.html
        run: |
          echo "::group::HTML File Duplication Check"
          bash scripts/assert-single-html.sh
          echo "::endgroup::"

      # Gate 2: ãƒ—ãƒ­ãƒ™ãƒŠãƒ³ã‚¹ç…§åˆï¼ˆãƒ‡ãƒ¼ã‚¿æ”¹å¤‰æ¤œå‡ºï¼‰
      - name: ğŸ” Provenance Hash Check
        run: |
          echo "::group::Data Provenance Verification"
          if [ ! -f "data/source_manifest.json" ]; then
            echo "âŒ source_manifest.json not found"
            exit 1
          fi
          
          # Multi-layer verification: hash + bytes + lines
          EXPECTED_HASH=$(jq -r '.palace_mapping.sha256' data/source_manifest.json)
          EXPECTED_BYTES=$(jq -r '.palace_mapping.bytes' data/source_manifest.json)
          EXPECTED_LINES=$(jq -r '.palace_mapping.lines' data/source_manifest.json)
          
          ACTUAL_HASH=$(sha256sum data/eight_palaces.v1.json | cut -d' ' -f1)
          ACTUAL_BYTES=$(wc -c < data/eight_palaces.v1.json)
          ACTUAL_LINES=$(wc -l < data/eight_palaces.v1.json)
          
          echo "Verification matrix:"
          echo "  Hash:  Expected=$EXPECTED_HASH | Actual=$ACTUAL_HASH"
          echo "  Bytes: Expected=$EXPECTED_BYTES | Actual=$ACTUAL_BYTES"  
          echo "  Lines: Expected=$EXPECTED_LINES | Actual=$ACTUAL_LINES"
          
          if [ "$EXPECTED_HASH" != "$ACTUAL_HASH" ]; then
            echo "âŒ Hash verification failed"
            exit 1
          fi
          
          if [ "$EXPECTED_BYTES" != "$ACTUAL_BYTES" ]; then
            echo "âŒ File size verification failed"
            exit 1
          fi
          
          if [ "$EXPECTED_LINES" != "$ACTUAL_LINES" ]; then
            echo "âŒ Line count verification failed" 
            exit 1
          fi
          
          echo "âœ… Multi-layer data integrity verified"
          echo "::endgroup::"

      # Gate 3: Build & Server Start
      - name: ğŸ—ï¸ Build Application
        run: |
          echo "::group::Application Build"
          npm run build
          echo "âœ… Build completed"
          echo "::endgroup::"

      - name: ğŸš€ Start Test Server
        run: |
          echo "::group::Server Startup"
          npm run preview &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          echo "âœ… Server started (PID: $SERVER_PID)"
          echo "::endgroup::"

      - name: â³ Wait for Server Health
        run: |
          echo "::group::Health Check Wait"
          for i in {1..30}; do
            if curl -s http://localhost:8788/health > /dev/null; then
              echo "âœ… Server is healthy"
              break
            fi
            echo "â³ Waiting for server... (attempt $i/30)"
            sleep 2
          done
          
          # Final health verification
          HEALTH_RESPONSE=$(curl -s http://localhost:8788/health)
          echo "Health response: $HEALTH_RESPONSE"
          
          if ! echo "$HEALTH_RESPONSE" | jq -e '.ok == true' > /dev/null; then
            echo "âŒ Server health check failed"
            exit 1
          fi
          echo "::endgroup::"

      - name: ğŸ¯ Readiness Check
        run: |
          echo "::group::Application Readiness"
          READY_RESPONSE=$(curl -s http://localhost:8788/ready)
          echo "Readiness response: $READY_RESPONSE"
          
          if ! echo "$READY_RESPONSE" | jq -e '.ready == true' > /dev/null; then
            echo "âŒ Application readiness check failed"
            echo "$READY_RESPONSE" | jq '.error // empty' || true
            exit 1
          fi
          
          echo "âœ… Application is ready"
          echo "::endgroup::"

      # Gate 4: E2E ã‚¹ãƒ¢ãƒ¼ã‚¯ãƒ†ã‚¹ãƒˆ
      - name: ğŸ§ª E2E Smoke Tests
        run: |
          echo "::group::End-to-End Smoke Tests"
          node test/smoke.e2e.spec.cjs
          echo "::endgroup::"

      # Gate 5: å…«å®®ã‚¤ãƒ³ãƒãƒªã‚¢ãƒ³ãƒˆ
      - name: ğŸ›ï¸ Eight Palaces Invariants
        run: |
          echo "::group::Eight Palaces Data Invariants"
          node test/eight-palaces.invariant.test.cjs
          echo "::endgroup::"

      # Gate 6: ã‚´ãƒ¼ãƒ«ãƒ‡ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒ†ã‚¹ãƒˆ
      - name: ğŸ† Golden Pattern Test
        run: |
          echo "::group::Pattern ID Golden Test (064/52)"
          node test/pattern-id.golden.test.cjs
          echo "::endgroup::"

      # Gate 6: ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
      - name: ğŸŒ Application Access Verification
        run: |
          echo "::group::Application Access Test"
          
          # Test main app access
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8788/os_analyzer.html)
          if [ "$STATUS" != "200" ]; then
            echo "âŒ Main application access failed (HTTP $STATUS)"
            exit 1
          fi
          echo "âœ… Main application accessible (HTTP 200)"
          
          # Test root redirect
          STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8788/)
          if [ "$STATUS" != "302" ]; then
            echo "âŒ Root redirect failed (HTTP $STATUS)"
            exit 1
          fi
          echo "âœ… Root redirect working (HTTP 302)"
          
          echo "::endgroup::"

      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            kill $SERVER_PID || true
            echo "ğŸ›‘ Server stopped"
          fi

  security-gates:
    runs-on: ubuntu-latest
    name: ğŸ”’ Security Gates
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ” Sensitive File Check
        run: |
          echo "::group::Sensitive Files Detection"
          
          # Check for common sensitive files
          SENSITIVE_FILES=(
            ".env"
            ".env.local" 
            ".env.production"
            "config/secrets.json"
            "private_key.pem"
            "id_rsa"
          )
          
          for file in "${SENSITIVE_FILES[@]}"; do
            if [ -f "$file" ]; then
              echo "âŒ Sensitive file detected: $file"
              exit 1
            fi
          done
          
          # Check for API keys in tracked files
          if git ls-files | xargs grep -l "ANTHROPIC_API_KEY\|OPENAI_API_KEY\|sk-" 2>/dev/null; then
            echo "âŒ Potential API keys found in tracked files"
            exit 1
          fi
          
          echo "âœ… No sensitive files detected"
          echo "::endgroup::"

      - name: ğŸ” Configuration Security Check
        run: |
          echo "::group::Configuration Security"
          
          # Check cipher.config.yaml for security issues
          if [ -f "cipher.config.yaml" ]; then
            if grep -i "password\|secret\|key" cipher.config.yaml | grep -v "# Environment variable"; then
              echo "âŒ Hardcoded secrets found in cipher.config.yaml"
              exit 1
            fi
          fi
          
          echo "âœ… Configuration security verified"
          echo "::endgroup::"