# HAQEI OS Analyzer 運用・更新手順書

## 📋 ドキュメント情報
- **作成日**: 2025年1月14日
- **対象システム**: HAQEI OS Analyzer v2.2
- **対象者**: 開発者、運用担当者

---

## 🚀 システム起動手順

### 1. ローカル開発環境

```bash
# 1. プロジェクトディレクトリへ移動
cd /Users/hideakimacbookair/Desktop/haqei-analyzer

# 2. 依存関係の確認
npm install

# 3. 開発サーバー起動
npm run dev

# 4. ブラウザでアクセス
open http://localhost:8788
```

### 2. ファイル直接実行

```bash
# HTMLファイルを直接開く
open public/os_analyzer.html
```

### 3. テスト環境での確認

```bash
# Playwright MCPで動作確認
npx @playwright/mcp

# または、Playwright経由でブラウザ起動
mcp__playwright__browser_navigate
# URL: file:///Users/hideakimacbookair/Desktop/haqei-analyzer/public/os_analyzer.html
```

---

## 🔧 システム更新手順

### 1. コード更新時の確認事項

#### 更新前チェックリスト
- [ ] CLAUDE.mdの確認（開発ルール遵守）
- [ ] .serena/memoriesで過去の作業履歴確認
- [ ] 現在のブランチ確認（develop or main）

#### 更新手順

```bash
# 1. 現在の状態を保存
git add .
git commit -m "WIP: 作業中の変更を保存"

# 2. 更新対象ファイルの編集
# 主要ファイル:
# - /public/os_analyzer.html (メインHTML)
# - /public/assets/js/app.js (メインロジック)
# - /public/assets/js/questions-full.js (36問データ)

# 3. 更新後の検証
npm run lint  # ESLintチェック

# 4. ブラウザでの動作確認（必須）
# - ウェルカム画面表示
# - 36問の質問フロー
# - 結果画面の表示
```

### 2. 質問データの更新

```javascript
// /public/assets/js/questions-full.js の構造
window.QUESTIONS = [
  {
    id: "q1",
    text: "質問文",
    category: { title: "カテゴリ", description: "説明" },
    options: [
      {
        value: "A",
        text: "選択肢テキスト",
        scoring: {
          "乾_創造性": 3.0,
          "兌_調和性": 1.5,
          // 他の八卦スコア
        }
      }
    ]
  }
  // ... 36問続く
];
```

### 3. OS表現の更新

```javascript
// /public/assets/js/app.js 内の表現定義
// 正しい表現（必ず守る）：
engineOS.title = '内発的動機';    // Engine OS
interfaceOS.title = '社会的側面';  // Interface OS  
safeModeOS.title = '危機時人格';   // Safe Mode OS

// ❌ 使わない表現：
// - 旅人メタファー
// - ファンタジー的表現
```

---

## 📊 運用監視

### 1. Health Beaconによる監視

```javascript
// ブラウザコンソールで状態確認
HealthBeacon.checkHealth()

// 返却される情報：
{
  status: "healthy|fair|warning|critical",
  errorCount: 数値,
  warningCount: 数値,
  currentScreen: "welcome|questions|analysis|results",
  progress: "回答数/36",
  performance: { /* パフォーマンスデータ */ }
}
```

### 2. エラー発生時の対処

#### よくあるエラーと対処法

| エラー | 原因 | 対処法 |
|--------|------|--------|
| questions-full.js not loaded | ファイル読み込みエラー | パスとファイル存在確認 |
| userAnswers undefined | 回答保存の失敗 | app.js line 231-233確認 |
| 結果画面が表示されない | 分析処理のエラー | performTripleOSAnalysis関数確認 |

### 3. LocalStorageデータ

```javascript
// 保存されるデータ
localStorage.getItem('haqei_health_metrics')  // Health Beacon監視データ
localStorage.getItem('haqei_health_alerts')   // アラート履歴

// データクリア（必要時）
HealthBeacon.clearMetrics()
```

---

## 🔄 定期メンテナンス

### 毎週実施項目
1. エラーログの確認
2. パフォーマンスメトリクスの確認
3. ユーザーフィードバックの収集

### 毎月実施項目
1. 依存パッケージの更新確認
2. セキュリティ脆弱性スキャン
3. バックアップの作成

```bash
# バックアップ作成
tar -czf backup_$(date +%Y%m%d).tar.gz public/ .serena/

# 依存関係の更新確認
npm outdated
npm audit
```

---

## 🚨 緊急時対応

### システム停止時

```bash
# 1. プロセス確認
ps aux | grep node

# 2. プロセス停止（必要時）
killall node

# 3. キャッシュクリア
rm -rf node_modules/.cache

# 4. 再起動
npm run dev
```

### データ破損時

```bash
# 1. GitHubから最新版取得
git fetch origin
git reset --hard origin/develop

# 2. クリーンインストール
rm -rf node_modules
npm install

# 3. 動作確認
npm run dev
```

---

## 📝 変更履歴の記録

### 必須記録事項

```markdown
# .serena/memories/作業内容_$(date "+%Y%m%d").md

## 実施日時
2025年1月14日 HH:MM

## 変更内容
- 何を変更したか
- なぜ変更したか
- どのファイルを修正したか

## 影響範囲
- ユーザー体験への影響
- システムパフォーマンスへの影響

## テスト結果
- [ ] ウェルカム画面
- [ ] 36問の質問フロー
- [ ] 結果画面表示
- [ ] エラーなし確認
```

---

## 🔗 関連ドキュメント

- [CLAUDE.md](./CLAUDE.md) - 開発ルール
- [20250814_動的診断テキスト生成システム_専門家相談用.md](./20250814_動的診断テキスト生成システム_専門家相談用.md) - システム設計
- [correct_os_expression_20250814.md](./.serena/memories/correct_os_expression_20250814.md) - 正しい表現定義

---

## ⚠️ 重要な注意事項

1. **表現の統一性**
   - 内発的動機、社会的側面、危機時人格の表現を必ず守る
   - 分人思想に基づくが「分人」という言葉は使わない

2. **データ保護**
   - 既存データの削除は必ずユーザー確認を取る
   - package.json削除時は `git restore package.json`

3. **テスト必須**
   - 変更後は必ず36問すべての動作確認
   - 結果画面まで到達することを確認

4. **記録の徹底**
   - すべての変更を.serena/memoriesに記録
   - ファイル名は `作業内容_$(date "+%Y%m%d").md`