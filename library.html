<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HaQei ãƒ©ã‚¤ãƒ–ãƒ©ãƒª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; }
        .brand-text { background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; color: transparent; }
        .mincho-font { font-family: 'Shippori Mincho', serif; }
        .tab-btn { transition: all 0.2s ease-in-out; }
        .tab-btn.active { background-color: #4f46e5; color: #fff; }
        .tab-btn:not(.active):hover { background-color: #374151; }
        .content-section { display: none; }
        .content-section.active { display: block; }
        .timeline { position: relative; padding-left: 3rem; margin: 2rem 0; }
        .timeline::before { content: ''; position: absolute; left: 0.5rem; top: 0; bottom: 0; width: 4px; background-color: #374151; border-radius: 2px; }
        .timeline-item { position: relative; margin-bottom: 2rem; }
        .timeline-item:last-child { margin-bottom: 0; }
        .timeline-dot { position: absolute; left: -2.75rem; top: 0.3rem; height: 1.5rem; width: 1.5rem; background-color: #4f46e5; border-radius: 9999px; border: 4px solid #1f2937; }
        .timeline-content { cursor: pointer; }
        .timeline-content:hover h4 { color: #a5b4fc; }
        .accordion-item summary { cursor: pointer; padding: 1rem; background-color: #1f2937; border-radius: 0.5rem; transition: background-color 0.2s; }
        .accordion-item summary:hover { background-color: #374151; }
        .accordion-item-content { padding: 1rem; border-top: 1px solid #374151; }
        .accordion-item[open] summary { background-color: #4338ca; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
    </style>
</head>
<body class="bg-gray-900 text-gray-200 min-h-screen p-4 sm:p-8">
    <div class="w-full max-w-5xl mx-auto bg-gray-800 shadow-2xl rounded-2xl p-6 sm:p-10">
        <header class="text-center mb-10">
            <a href="index.html" class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block">â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a>
            <h1 class="text-4xl sm:text-5xl font-bold brand-text tracking-wider mincho-font">HaQei Library</h1>
            <p class="text-gray-400 mt-3 text-xl">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ ¹å¹¹ã‚’æˆã™ã€æ˜“çµŒã€Œåç¿¼ã€ã®çŸ¥è­˜ä½“ç³»</p>
        </header>

        <div id="tab-container" class="flex flex-wrap items-center justify-center gap-2 sm:gap-4 mb-8 bg-gray-900/50 p-3 rounded-lg">
            <button class="tab-btn px-4 py-2 rounded-md font-semibold" data-tab="analyzer">å¦ã®åˆ†æ (Analyzer)</button>
            <button class="tab-btn px-4 py-2 rounded-md font-semibold" data-tab="tuan">å½–ä¼ (å…¨ä½“ãƒ†ãƒ¼ãƒ)</button>
            <button class="tab-btn px-4 py-2 rounded-md font-semibold" data-tab="sho">å°è±¡ä¼ (å„çˆ»ã®ç†ç”±)</button>
            <button class="tab-btn px-4 py-2 rounded-md font-semibold" data-tab="zatsu">é›‘å¦ä¼ (äºŒå…ƒè«–)</button>
            <button class="tab-btn px-4 py-2 rounded-md font-semibold" data-tab="jo">åºå¦ä¼ (ç‰©èªã®æµã‚Œ)</button>
        </div>

        <main id="content-area">
            <section id="analyzer-content" class="content-section">
                <div id="radar-container">
                    <h2 class="text-3xl font-bold text-white mb-2 mincho-font border-b-2 border-indigo-500 pb-2">
                        <span>64å¦ ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãƒ¬ãƒ¼ãƒ€ãƒ¼</span>
                        <span id="help-icon" class="cursor-pointer text-sm bg-gray-600 hover:bg-gray-500 text-white rounded-full w-6 h-6 flex items-center justify-center">?</span>
                    </h2>
                    <p class="text-gray-400 my-4">å„å¦ãŒæŒã¤ã€Œå¤‰åŒ–ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼çŠ¶æ…‹ã€ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚ã‚¹ã‚³ã‚¢ãŒé«˜ã„ã»ã©æŒ‘æˆ¦çš„ã§é£›èºã®å¯èƒ½æ€§ã‚’ã€ä½ã„ã»ã©å®‰å®šã—ç‰©äº‹ã‚’å›ºã‚ã‚‹å¥½æ©Ÿã‚’ç¤ºã—ã¾ã™ã€‚ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°åˆ†æã‚’è¡¨ç¤ºã—ã¾ã™ã€‚</p>
                        <div class="my-4 flex items-center gap-4">
                        <label for="sortOrder" class="mr-2">ä¸¦ã³é †:</label>
                        <select id="sortOrder" class="bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 p-2">
                            <option value="potential_desc">ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒé«˜ã„é †</option>
                            <option value="potential_asc">ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒä½ã„é †</option>
                            <option value="id_asc" selected>å¦ã®ç•ªå·é †</option>
                        </select>
                    </div>
                    <div id="radar-chart" class="space-y-2">
                        </div>
                </div>
                
                <div id="structure-analyzer" class="hidden mt-12">
                    <button id="backToRadarBtn" class="mb-4 text-indigo-400 hover:text-indigo-300">â† ãƒ¬ãƒ¼ãƒ€ãƒ¼ã«æˆ»ã‚‹</button>
                    <div id="analyzer-header" class="text-center mb-6 flex items-center justify-between">
                        <button id="prev-hex-btn" class="p-2 rounded-full hover:bg-gray-700 disabled:opacity-20 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <div id="analyzer-title-container">
                            </div>
                        <button id="next-hex-btn" class="p-2 rounded-full hover:bg-gray-700 disabled:opacity-20 disabled:cursor-not-allowed">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 items-center">
                        <div id="analyzer-chart-container" class="w-full h-96 bg-gray-900/50 rounded-lg p-4">
                             <canvas id="analyzer-chart"></canvas>
                        </div>
                        <div id="analyzer-text" class="h-96 overflow-y-auto bg-gray-900/50 rounded-lg p-6">
                            </div>
                    </div>
                </div>
            </section>
            
            <section id="tuan-content" class="content-section prose prose-invert max-w-none">
                <h2 class="text-3xl font-bold text-white mb-4 mincho-font border-b-2 border-indigo-500 pb-2">å½–ä¼ <span class="text-base text-gray-400 ml-2">- å¦å…¨ä½“ã®ãƒ†ãƒ¼ãƒè§£èª¬</span></h2>
                <div class="mb-4">
                    <input type="text" id="tuan-search" class="w-full p-4 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
                </div>
                <div id="tuan-list" class="space-y-6"></div>
            </section>
            <section id="sho-content" class="content-section">
                <h2 class="text-3xl font-bold text-white mb-4 mincho-font border-b-2 border-indigo-500 pb-2">å°è±¡ä¼ <span class="text-base text-gray-400 ml-2">- å„çˆ»ã®è¡Œå‹•ç†ç”±</span></h2>
                <div class="mb-4">
                    <input type="text" id="sho-search" class="w-full p-4 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
                </div>
                <div id="sho-list" class="space-y-2"></div>
            </section>
            <section id="zatsu-content" class="content-section">
                <h2 class="text-3xl font-bold text-white mb-4 mincho-font border-b-2 border-indigo-500 pb-2">é›‘å¦ä¼ <span class="text-base text-gray-400 ml-2">- äºŒå…ƒè«–ã«ã‚ˆã‚‹æœ¬è³ªè§£èª¬</span></h2>
                 <div class="mb-4">
                    <input type="text" id="zatsu-search" class="w-full p-4 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
                </div>
                <div id="zatsu-list" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
            </section>
            <section id="jo-content" class="content-section">
                <h2 class="text-3xl font-bold text-white mb-4 mincho-font border-b-2 border-indigo-500 pb-2">åºå¦ä¼ <span class="text-base text-gray-400 ml-2">- 64å¦ã®ç‰©èª</span></h2>
                <p class="mb-6 text-gray-300">64å¦ãŒãªãœã“ã®é †ç•ªã§ä¸¦ã‚“ã§ã„ã‚‹ã®ã‹ã€ãã®å£®å¤§ãªç‰©èªã®æµã‚Œã‚’ç¤ºã—ã¾ã™ã€‚å„é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å¦ã®è§£èª¬ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
                 <div class="mb-4">
                    <input type="text" id="jo-search" class="w-full p-4 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢...">
                </div>
                <div id="jo-list" class="timeline"></div>
            </section>
        </main>
    </div>

    <div id="modalContainer" class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden">
        <div id="modalOverlay" class="absolute inset-0 bg-black/70 modal-overlay opacity-0"></div>
        <div id="modalContent" class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-y-auto p-8 relative transform scale-95">
            <button id="modalCloseBtn" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
            </button>
            <div id="modalBody"></div>
        </div>
    </div>

    <script src="assets/haqei_main_database.js"></script>
    <script>
    // â–¼â–¼â–¼ ã“ã®è¡Œã‹ã‚‰ã‚³ãƒ”ãƒ¼ã—ã¦ã€<script>ã‚¿ã‚°ã®ä¸­èº«ã‚’ã™ã¹ã¦ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã“ã®è¡Œã‹ã‚‰<script>ã‚¿ã‚°ã®ä¸­èº«ã‚’ã™ã¹ã¦ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã“ã®è¡Œã‹ã‚‰<script>ã‚¿ã‚°ã®ä¸­èº«ã‚’ã™ã¹ã¦ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
window.onload = () => {
    // --- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¨ã‚¹ã‚³ã‚¢ã®èª­ã¿è¾¼ã¿ ---
    const HDB = HAQEI_DATA;
    const SCORES = typeof haqei_potential_scores !== 'undefined' ? haqei_potential_scores : [];

    if (!HDB || !HDB.bible || SCORES.length < 387) {
        console.error(`ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¾ãŸã¯ã‚¹ã‚³ã‚¢ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ã‚¹ã‚³ã‚¢é…åˆ—ã®è¦ç´ æ•°: ${SCORES.length}ã€‚387ä»¥ä¸Šã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚`);
        const contentArea = document.getElementById('content-area');
        if(contentArea) contentArea.innerHTML = '<p class="text-red-400 p-4">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã€Œhaqei_main_database.jsã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã”ç¢ºèªãã ã•ã„ã€‚</p>';
        return;
    }

    // --- DOMè¦ç´ ã®å–å¾— ---
    const tabs = document.querySelectorAll('.tab-btn');
    const contents = document.querySelectorAll('.content-section');
    const sortOrderSelect = document.getElementById('sortOrder');
    const radarContainer = document.getElementById('radar-container');
    const structureAnalyzer = document.getElementById('structure-analyzer');
    const backToRadarBtn = document.getElementById('backToRadarBtn');
    const helpIcon = document.getElementById('help-icon');
    const modalContainer = document.getElementById('modalContainer');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalCloseBtn = document.getElementById('modalCloseBtn');
    const modalBody = document.getElementById('modalBody');
    const searchInputs = {
        tuan: document.getElementById('tuan-search'),
        sho: document.getElementById('sho-search'),
        zatsu: document.getElementById('zatsu-search'),
        jo: document.getElementById('jo-search')
    };

    let lineChartInstance = null;
    
    // --- â˜…â˜…â˜… [æœ€é‡è¦ä¿®æ­£] ãƒ‡ãƒ¼ã‚¿ã®ã‚ºãƒ¬ã‚’å®Œå…¨ã«è§£æ¶ˆã™ã‚‹ãƒ­ã‚¸ãƒƒã‚¯ â˜…â˜…â˜… ---
    // å„å¦ã®é–‹å§‹é€šã—ç•ªå·ã‚’äº‹å‰ã«è¨ˆç®—ã—ã¦ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
    const hexStartIndices = [0]; // index 0 ã¯ãƒ€ãƒŸãƒ¼
    let currentIndex = 1;
    for (let i = 1; i <= 64; i++) {
        hexStartIndices.push(currentIndex);
        currentIndex += (i === 1 || i === 2) ? 7 : 6;
    }

    // --- å¦ã®ç·åˆã‚¹ã‚³ã‚¢ã‚’è¨ˆç®— ---
    const hexagramScores = HDB.hexagrams_master.map(hex => {
        if (!hex || !hex.hexagram_id) return null;
        const startNum = hexStartIndices[hex.hexagram_id];
        if (!startNum) return null;
        
        const lineScores = SCORES.slice(startNum, startNum + 6).filter(s => typeof s === 'number');
        if (lineScores.length < 6) return null;
        
        const average = lineScores.reduce((a, b) => a + b, 0) / lineScores.length;
        return { id: hex.hexagram_id, name: hex.name_jp, keywords: hex.keywords, score: parseFloat(average.toFixed(2)) };
    }).filter(Boolean);
    
    const escapeHTML = (str) => str ? str.toString().replace(/[&<>"']/g, match => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match])) : '';
    const nl2br = (str) => str ? escapeHTML(str).split('\n').join('<br>') : '';
    const helpContentHtml = `<div class="space-y-4 text-gray-300"><p>ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚³ã‚¢ã¯ã€ãã®çŠ¶æ³ãŒæŒã¤ã€Œå¤‰åŒ–ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼çŠ¶æ…‹ã€ã‚’ç¤ºã™å®¢è¦³çš„ãªæŒ‡æ¨™ã§ã™ã€‚ã‚¹ã‚³ã‚¢ã‚’å¤©æ°—ã®ã‚ˆã†ã«æ‰ãˆã‚‹ã¨ã€æˆ¦ç•¥ãŒç«‹ã¦ã‚„ã™ããªã‚Šã¾ã™ã€‚</p><div class="p-4 bg-gray-900 rounded-lg"><h4 class="font-bold text-lg text-indigo-300">ã‚¹ã‚³ã‚¢ãŒä½ã„æ™‚ (1-2)ï¼šæ™´ã‚Œã®æ—¥ â˜€ï¸</h4><p class="mt-1">çŠ¶æ³ã¯å®‰å®šã—ã¦ãŠã‚Šã€å¤‰åŒ–ã®ä¸»å°æ¨©ã¯ã‚ãªãŸã«ã‚ã‚Šã¾ã™ã€‚ã“ã®å®‰å®šã‚’æ´»ã‹ã—ã¦â€¦</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong class="text-white">ç¾çŠ¶ã‚’ç¶­æŒã—ã€åŠ›ã‚’è“„ãˆã‚‹ã€‚</strong></li><li><strong class="text-white">å®‰å…¨åœ°å¸¯ã‹ã‚‰ã€æ–°ã—ã„æŒ‘æˆ¦ã‚’å§‹ã‚ã‚‹ã€‚</strong></li></ul></div><div class="p-4 bg-gray-900 rounded-lg"><h4 class="font-bold text-lg text-yellow-300">ã‚¹ã‚³ã‚¢ãŒä¸­é–“ã®æ™‚ (3)ï¼šæ›‡ã‚Šã®ã¡æ™´ã‚Œ/é›¨ ğŸŒ¥ï¸</h4><p class="mt-1">å®‰å®šã¨ä¸å®‰å®šã®å¢ƒç›®ã§ã‚ã‚Šã€ã‚ãªãŸã®è¡Œå‹•ã‚„é¸æŠãŒæœªæ¥ã‚’å·¦å³ã™ã‚‹ã€Œå²è·¯ã€ã§ã™ã€‚ã“ã®ä¸­ç«‹çš„ãªçŠ¶æ…‹ã‚’æ´»ã‹ã—ã¦â€¦</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong class="text-white">èƒ½å‹•çš„ã«ä»•æ›ã‘ã€æœ›ã‚€æœªæ¥ã¸çŠ¶æ³ã‚’å‚¾ã‘ã‚‹ã€‚</strong></li><li><strong class="text-white">åµã«å‚™ãˆã¦å®ˆã‚Šã‚’å›ºã‚ã‚‹ã€ã‚ã‚‹ã„ã¯å¥½æ©Ÿã‚’å¾…ã¤ã€‚</strong></li></ul></div><div class="p-4 bg-gray-900 rounded-lg"><h4 class="font-bold text-lg text-red-300">ã‚¹ã‚³ã‚¢ãŒé«˜ã„æ™‚ (4-5)ï¼šåµã®æ—¥ âš¡ï¸</h4><p class="mt-1">çŠ¶æ³ã¯æµå‹•çš„ã§ã€å¤–éƒ¨ã‹ã‚‰ã®å¤‰åŒ–ã¸ã®å¯¾å¿œã‚’è¿«ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’åˆ©ç”¨ã—ã¦â€¦</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong class="text-white">å¤‰åŒ–ã®æ³¢ã«ä¹—ã‚Šã€é£›èºã‚’ç‹™ã†ã€‚</strong></li><li><strong class="text-white">é˜²å¾¡ã«å¾¹ã—ã€è¢«å®³ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã€‚</strong></li></ul></div><p class="pt-2">ã“ã®ã‚¹ã‚³ã‚¢ã§<strong class="text-white">ã€Œä»Šã®ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ã€</strong>ã‚’å®¢è¦³çš„ã«ç†è§£ã—ã€ã‚ãªãŸè‡ªèº«ã®æ„å¿—ã§<strong class="text-white">ã€Œã©ã†ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‹ã€</strong>ã‚’æ±ºã‚ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p></div>`;

    function showModal(title, content) {
        modalBody.innerHTML = `<h3 class="text-2xl font-bold text-indigo-300 mb-4">${title}</h3><div class="prose prose-invert max-w-none">${content}</div>`;
        modalContainer.classList.remove('hidden');
    }
    function hideModal() { modalContainer.classList.add('hidden'); }

    function renderRadarChart() {
        const sortOrder = sortOrderSelect.value;
        const sortedHexagrams = [...hexagramScores].sort((a, b) => {
            switch (sortOrder) {
                case 'potential_asc': return a.score - b.score;
                case 'id_asc': return a.id - b.id;
                default: return b.score - a.score;
            }
        });
        const chartContainer = document.getElementById('radar-chart');
        chartContainer.innerHTML = sortedHexagrams.map(hex => {
            const scorePercentage = (hex.score / 5) * 100;
            const color = `hsl(${240 - (hex.score - 1) * 60}, 70%, 60%)`;
            return `<div class="flex items-center group cursor-pointer p-1 rounded-md hover:bg-gray-700" data-hex-id="${hex.id}"><div class="w-28 sm:w-32 text-sm truncate pr-2 text-right">${hex.id}. ${escapeHTML(hex.name)}</div><div class="flex-1 bg-gray-600 rounded-full h-6 p-0.5"><div class="h-full rounded-full transition-all duration-300" style="width: ${scorePercentage}%; background-color: ${color};"></div></div><div class="w-12 text-left pl-3 font-bold text-base">${hex.score}</div></div>`;
        }).join('');
        chartContainer.querySelectorAll('.group').forEach(el => {
            el.addEventListener('click', () => showStructureAnalyzer(parseInt(el.dataset.hexId, 10)));
        });
    }
    
    // â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
// â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚’ä¸¸ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
function showStructureAnalyzer(hexId) {
    radarContainer.classList.add('hidden');
    structureAnalyzer.classList.remove('hidden');

    const prevBtn = document.getElementById('prev-hex-btn');
    const nextBtn = document.getElementById('next-hex-btn');
    prevBtn.disabled = (hexId === 1);
    nextBtn.disabled = (hexId === 64);
    
    const newPrevBtn = prevBtn.cloneNode(true);
    const newNextBtn = nextBtn.cloneNode(true);
    prevBtn.parentNode.replaceChild(newPrevBtn, prevBtn);
    nextBtn.parentNode.replaceChild(newNextBtn, nextBtn);

    newPrevBtn.addEventListener('click', () => showStructureAnalyzer(hexId - 1));
    newNextBtn.addEventListener('click', () => showStructureAnalyzer(hexId + 1));

    const hexData = HDB.hexagrams_master.find(h => h.hexagram_id === hexId);
    const tuanData = HDB.bible.tuan_den[hexId];
    document.getElementById('analyzer-title-container').innerHTML = `<h3 class="text-3xl font-bold text-white mincho-font">${hexData.hexagram_id}. ${escapeHTML(tuanData.title)}</h3><p class="text-indigo-300 font-semibold mt-2">${escapeHTML(tuanData.summary)}</p>`;
    
    const isSpecialHex = (hexId === 1 || hexId === 2);
    const numLines = isSpecialHex ? 7 : 6;
    const labels = ['åˆçˆ»', 'äºŒçˆ»', 'ä¸‰çˆ»', 'å››çˆ»', 'äº”çˆ»', 'ä¸Šçˆ»'];
    if (isSpecialHex) { labels.push(hexId === 1 ? 'ç”¨ä¹' : 'ç”¨å…­'); }
    
    const startNum = hexStartIndices[hexId];
    const lineScores = Array.from({ length: numLines }, (_, i) => SCORES[startNum + i]);
    const plotLineScores = lineScores.map(score => score === 99 ? 5.5 : score);
    
    // â˜…â˜…â˜… [ã“ã“ã‹ã‚‰ä¿®æ­£] ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†ã‚’å¼·åŒ– â˜…â˜…â˜…
    const setActiveLine = (index) => {
        const activeColor = '#facc15'; // é®®ã‚„ã‹ãªé»„è‰² (Amber 400)
        const defaultColor = '#fff';

        // è‰²ã®é…åˆ—ã‚’ä½œæˆ
        const pointBackgroundColors = Array(numLines).fill(defaultColor);
        pointBackgroundColors[index] = activeColor;
        
        // ã‚µã‚¤ã‚ºã®é…åˆ—ã‚’ä½œæˆ
        const pointRadii = Array(numLines).fill(5);
        pointRadii[index] = 10; // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç‚¹ã‚’å¤§ãã

        // æ ç·šã®å¤ªã•ã®é…åˆ—ã‚’ä½œæˆ
        const pointBorderWidths = Array(numLines).fill(2);
        pointBorderWidths[index] = 4; // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç‚¹ã®æ ç·šã‚’å¤ªã

        // ã‚°ãƒ©ãƒ•ã«ã‚¹ã‚¿ã‚¤ãƒ«ã‚’é©ç”¨
        lineChartInstance.data.datasets[0].pointBackgroundColor = pointBackgroundColors;
        lineChartInstance.data.datasets[0].pointRadius = pointRadii;
        lineChartInstance.data.datasets[0].pointBorderWidth = pointBorderWidths;
        lineChartInstance.update('none'); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãªã—ã§æ›´æ–°

        updateAnalyzerText(hexId, index);
    };
    // â˜…â˜…â˜… [ã“ã“ã¾ã§ä¿®æ­£] â˜…â˜…â˜…

    const ctx = document.getElementById('analyzer-chart').getContext('2d');
    if (lineChartInstance) lineChartInstance.destroy();
    
    lineChartInstance = new Chart(ctx, {
        type: 'line', 
        data: { 
            labels: labels, 
            datasets: [{ 
                label: 'ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚³ã‚¢', 
                data: plotLineScores,
                borderColor: 'rgba(165, 180, 252, 1)', 
                backgroundColor: 'rgba(129, 140, 248, 0.2)', 
                pointBorderColor: 'rgba(165, 180, 252, 1)',
                pointHoverRadius: 7, 
                tension: 0.1, 
                fill: true 
            }] 
        },
        options: {
            responsive: true, maintainAspectRatio: false,
            scales: { y: { min: 0.5, max: 5.5, ticks: { stepSize: 1, color: '#9ca3af' }}, x: { ticks: { color: '#9ca3af' }}},
            plugins: { legend: { display: false }, tooltip: { enabled: false }},
            onHover: (event, chartElement) => {
                event.native.target.style.cursor = chartElement.length ? 'pointer' : 'default';
            },
            onClick: (event, chartElement) => {
                if (chartElement.length > 0) {
                    setActiveLine(chartElement[0].index);
                }
            }
        }
    });
    
    setActiveLine(0);
}

    // â–¼â–¼â–¼ ã“ã®é–¢æ•°ã‚‚ä¸¸ã”ã¨ç½®ãæ›ãˆã¦ãã ã•ã„ â–¼â–¼â–¼
function updateAnalyzerText(hexId, lineIndex) {
    const textContainer = document.getElementById('analyzer-text');
    const startNum = hexStartIndices[hexId];
    const lineNum = startNum + lineIndex;
    
    const shoData = HDB.bible.sho_den[lineNum];
    const h384Data = HDB['384'].find(h => h.é€šã—ç•ªå· === lineNum);
    const score = SCORES[lineNum];
    const scoreLevels = {1: 'å¹³ç©', 2: 'é †é¢¨', 3: 'å²è·¯', 4: 'é€†é¢¨', 5: 'åµ'};
    const isSpecialLine = (hexId === 1 || hexId === 2) && lineIndex === 6;

    if (shoData && h384Data && typeof score !== 'undefined') {
        // â˜…â˜…â˜… [ä¿®æ­£ç®‡æ‰€] ã‚¹ã‚³ã‚¢99ã®åˆ¤å®šã‚’ãªãã—ã€ã‚·ãƒ³ãƒ—ãƒ«ã«ã™ã‚‹ â˜…â˜…â˜…
        const scoreText = isSpecialLine 
            ? `ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚³ã‚¢: ${score} <span class="text-yellow-300">- ${scoreLevels[score]} (ç‰¹åˆ¥) -</span>`
            : `ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚³ã‚¢: ${score} <span class="text-gray-400">- ${scoreLevels[score]} -</span>`;

        textContainer.innerHTML = `<h4 class="text-xl font-bold text-indigo-300 mb-2">${escapeHTML(h384Data.çˆ»å)}ï¼š${escapeHTML(shoData.title)}</h4><p class="mb-4 font-semibold">${scoreText}</p><div class="prose prose-invert max-w-none text-gray-300"><strong>ã€æ¨å¥¨ã•ã‚Œã‚‹è¡Œå‹•ç†ç”±ã€‘</strong><br>${nl2br(shoData.reason)}</div>`;
    } else {
        textContainer.innerHTML = `<p class="text-gray-400">ã“ã®çˆ»ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>`;
    }
}
    
    function renderLegacyViews() {
        const tuanContainer = document.getElementById('tuan-list');
        tuanContainer.innerHTML = HDB.hexagrams_master.map(hex => {
            const tuan = HDB.bible.tuan_den[hex.hexagram_id]; if (!tuan) return '';
            const searchText = `${hex.hexagram_id} ${hex.name_jp} ${tuan.title} ${tuan.summary} ${tuan.haqei_interpretation} ${hex.keywords}`;
            return `<div class="filterable-item py-4 border-b border-gray-700" data-search-text="${searchText}"><h3 class="text-2xl font-bold text-white mb-2 mincho-font">${hex.hexagram_id}. ${escapeHTML(tuan.title)}</h3><p class="text-indigo-300 font-semibold mb-3">${escapeHTML(tuan.summary)}</p><div class="pl-4 border-l-2 border-gray-600"><p class="text-gray-300 italic">"${nl2br(tuan.points.join('"<br>"'))}"</p><p class="mt-4 text-gray-400">${nl2br(tuan.haqei_interpretation)}</p></div></div>`;
        }).join('');
        const shoContainer = document.getElementById('sho-list');
        shoContainer.innerHTML = HDB['384'].map(h384 => {
            const sho = HDB.bible.sho_den[h384.é€šã—ç•ªå·]; if (!sho) return '';
            const searchText = `${h384.çˆ»å} ${sho.title} ${sho.reason}`;
            return `<details class="accordion-item filterable-item" data-search-text="${searchText}"><summary class="flex justify-between items-center"><span class="font-semibold text-lg">${escapeHTML(h384.çˆ»å)}ï¼š<span class="text-indigo-300">${escapeHTML(sho.title)}</span></span><span class="text-gray-400 text-sm">â–¼</span></summary><div class="accordion-item-content bg-gray-900/50 rounded-b-lg"><p><strong>ã€ãªãœã€ãã®è¡Œå‹•ãŒæ¨å¥¨ã•ã‚Œã‚‹ã®ã‹ï¼Ÿã€‘</strong><br>${nl2br(sho.reason)}</p></div></details>`;
        }).join('');
        const zatsuContainer = document.getElementById('zatsu-list');
        let zatsuHtml = ''; const processedPairs = new Set();
        HDB.hexagrams_master.forEach(hex1 => {
            if (processedPairs.has(hex1.hexagram_id)) return;
            const zatsu = HDB.bible.zatsu_ka_den[hex1.hexagram_id]; if (!zatsu) return;
            const hex2 = HDB.hexagrams_master.find(h => h.hexagram_id === zatsu.pair_id); if (!hex2) return;
            const searchText = `${hex1.name_jp} ${hex2.name_jp} ${zatsu.contrast_theme} ${zatsu.explanation}`;
            zatsuHtml += `<div class="filterable-item bg-gray-900/50 rounded-lg p-6" data-search-text="${searchText}"><h3 class="text-center text-xl font-bold text-indigo-300 mb-3">${escapeHTML(zatsu.contrast_theme)}</h3><div class="grid grid-cols-2 gap-4 text-center"><div class="border-r border-gray-600 pr-4"><p class="font-bold text-lg">${hex1.hexagram_id}. ${escapeHTML(hex1.name_jp)}</p></div><div><p class="font-bold text-lg">${hex2.hexagram_id}. ${escapeHTML(hex2.name_jp)}</p></div></div><p class="mt-4 text-center text-gray-400 text-sm">${nl2br(zatsu.explanation)}</p></div>`;
            processedPairs.add(hex1.hexagram_id); processedPairs.add(zatsu.pair_id);
        });
        zatsuContainer.innerHTML = zatsuHtml;
        const joContainer = document.getElementById('jo-list');
        joContainer.innerHTML = Object.keys(HDB.bible.jo_ka_den).sort((a, b) => parseInt(a, 10) - parseInt(b, 10)).map(key => {
            const [start] = key.split('-').map(Number);
            const hex = HDB.hexagrams_master.find(h => h.hexagram_id === start);
            const explanation = HDB.bible.jo_ka_den[key].explanation; if (!hex || !explanation) return '';
            const searchText = `${start} ${hex.name_jp} ${explanation}`;
            return `<div class="timeline-item filterable-item" data-search-text="${searchText}"><div class="timeline-dot"></div><div class="timeline-content" data-hex-id="${start}"><h4 class="text-xl font-bold">${start}. ${escapeHTML(hex.name_jp)}</h4><p class="text-sm text-gray-400">${nl2br(explanation)}</p></div></div>`;
        }).join('');
        joContainer.querySelectorAll('.timeline-content').forEach(item => {
            item.addEventListener('click', () => {
                const hexId = parseInt(item.dataset.hexId, 10);
                const tuan = HDB.bible.tuan_den[hexId]; const daisho = HDB.bible.tai_sho_den[hexId];
                if (!tuan || !daisho) return;
                const daishoHtml = nl2br(daisho.explanation).replace(/ã€è±¡å¾´ã€‘|ã€æˆ¦ç•¥ã€‘/g, '<strong>$&</strong>');
                showModal(`${hexId}. ${tuan.title}`, `<p class="mb-4">${nl2br(tuan.summary)}</p><p class="text-indigo-300 font-semibold mt-6 mb-2">ã€åŸºæœ¬æˆ¦ç•¥ / å¤§è±¡ä¼ã€‘</p><p>${daishoHtml}</p>`);
            });
        });
    }

    function filterContent(tabName, query) {
        const normalizedQuery = query.toLowerCase().trim();
        document.querySelectorAll(`#${tabName}-content .filterable-item`).forEach(item => {
            const text = item.dataset.searchText ? item.dataset.searchText.toLowerCase() : '';
            item.style.display = text.includes(normalizedQuery) ? '' : 'none';
        });
    }

    function switchTab(tabName) {
        tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.tab === tabName));
        contents.forEach(content => content.classList.toggle('active', content.id === `${tabName}-content`));
    }

    function initialize() {
        renderRadarChart();
        renderLegacyViews();
        modalOverlay.addEventListener('click', hideModal);
        modalCloseBtn.addEventListener('click', hideModal);
        sortOrderSelect.addEventListener('change', renderRadarChart);
        backToRadarBtn.addEventListener('click', () => {
            structureAnalyzer.classList.add('hidden');
            radarContainer.classList.remove('hidden');
        });
        helpIcon.addEventListener('click', () => showModal('ã€Œãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚³ã‚¢ã€ã®è¦‹æ–¹', helpContentHtml));
        tabs.forEach(tab => {
            tab.addEventListener('click', () => switchTab(tab.dataset.tab));
        });
        Object.keys(searchInputs).forEach(key => {
            if (searchInputs[key]) searchInputs[key].addEventListener('keyup', e => filterContent(key, e.target.value));
        });
        switchTab('analyzer');
    }

    initialize();
};
// â–²â–²â–² ã“ã®è¡Œã¾ã§ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ â–²â–²â–²
</script>
</body>
</html>