<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>HaQei Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&family=Shippori+Mincho:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* --- ãƒ‡ã‚¶ã‚¤ãƒ³èª¿æ•´ --- */
      body {
        font-family: "Inter", "Noto Sans JP", sans-serif;
        background-color: #111827; /* bg-gray-900 */
        line-height: 1.75; /* è¡Œé–“ã‚’åºƒã’ã‚‹ */
      }
      .brand-text {
        background: -webkit-linear-gradient(45deg, #a5b4fc, #e0e7ff);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        color: transparent;
      }
      .mincho-font {
        font-family: "Shippori Mincho", serif;
      }
      .card {
        background-color: #1f2937; /* bg-gray-800 */
        border: 1px solid #374151; /* border-gray-700 */
        border-radius: 0.75rem; /* rounded-lg */
      }
      .section-title {
        font-family: "Shippori Mincho", serif;
        border-bottom: 1px solid #4a5568; /* border-gray-600 */
        padding-bottom: 0.75rem;
        margin-bottom: 1.5rem;
      }
      .tab-btn {
        transition: all 0.2s ease-in-out;
      }
      .tab-btn.active {
        background-color: #4f46e5;
        color: #fff;
      }
      .tab-btn:not(.active):hover {
        background-color: #374151;
      }
      .content-section {
        display: none;
      }
      .content-section.active {
        display: block;
      }
      .timeline {
        position: relative;
        padding-left: 3rem;
        margin: 2rem 0;
      }
      .timeline::before {
        content: "";
        position: absolute;
        left: 0.5rem;
        top: 0;
        bottom: 0;
        width: 2px;
        background-color: #4a5568;
      }
      .timeline-item {
        position: relative;
        margin-bottom: 2.5rem;
      }
      .timeline-item:last-child {
        margin-bottom: 0;
      }
      .timeline-dot {
        position: absolute;
        left: -2.75rem;
        top: 0.3rem;
        height: 1.5rem;
        width: 1.5rem;
        background-color: #4f46e5;
        border-radius: 9999px;
        border: 4px solid #1f2937;
      }
      .timeline-content {
        cursor: pointer;
      }
      .timeline-content:hover h4 {
        color: #a5b4fc;
      }
      .accordion-item summary {
        cursor: pointer;
        padding: 1rem;
        background-color: #374151;
        border-radius: 0.5rem;
        transition: background-color 0.2s;
      }
      .accordion-item summary:hover {
        background-color: #4b5563;
      }
      .accordion-item[open] summary {
        background-color: #4338ca;
      }
      .modal-overlay {
        transition: opacity 0.3s ease;
      }
      .modal-content {
        transition: transform 0.3s ease;
      }
      .clickable-hex {
        cursor: pointer;
        transition: color 0.2s;
      }
      .clickable-hex:hover {
        color: #a5b4fc;
        text-decoration: underline;
      }
    </style>
  </head>
  <body class="text-gray-300 min-h-screen p-4 sm:p-8">
    <div class="w-full max-w-5xl mx-auto space-y-10">
      <header class="text-center">
        <a
          href="index.html"
          class="text-indigo-400 hover:text-indigo-300 mb-4 inline-block"
          >â† ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</a
        >
        <h1
          class="text-4xl sm:text-5xl font-bold brand-text tracking-wider mincho-font"
        >
          HaQei Library
        </h1>
        <p class="text-gray-400 mt-3 text-lg">
          ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ ¹å¹¹ã‚’æˆã™ã€æ˜“çµŒã€Œåç¿¼ã€ã®çŸ¥è­˜ä½“ç³»
        </p>
      </header>

      <div class="card p-3">
        <div
          id="tab-container"
          class="flex flex-wrap items-center justify-center gap-2 sm:gap-4"
        >
          <button
            class="tab-btn px-4 py-2 rounded-md font-semibold"
            data-tab="analyzer"
          >
            å¦ã®åˆ†æ (Analyzer)
          </button>
          <button
            class="tab-btn px-4 py-2 rounded-md font-semibold"
            data-tab="tuan"
          >
            å½–ä¼ (å…¨ä½“ãƒ†ãƒ¼ãƒ)
          </button>
          <button
            class="tab-btn px-4 py-2 rounded-md font-semibold"
            data-tab="sho"
          >
            å°è±¡ä¼ (å„çˆ»ã®ç†ç”±)
          </button>
          <button
            class="tab-btn px-4 py-2 rounded-md font-semibold"
            data-tab="zatsu"
          >
            é›‘å¦ä¼ (äºŒå…ƒè«–)
          </button>
          <button
            class="tab-btn px-4 py-2 rounded-md font-semibold"
            data-tab="jo"
          >
            åºå¦ä¼ (ç‰©èªã®æµã‚Œ)
          </button>
        </div>
      </div>

      <main id="content-area">
        <section id="analyzer-content" class="content-section card p-6 sm:p-8">
          <div id="radar-container">
            <h2
              class="section-title text-3xl font-bold flex items-center gap-3"
            >
              <span>64å¦ ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãƒ¬ãƒ¼ãƒ€ãƒ¼</span>
              <span
                id="help-icon"
                class="cursor-pointer text-sm bg-gray-600 hover:bg-gray-500 text-white rounded-full w-6 h-6 flex items-center justify-center flex-shrink-0"
                >?</span
              >
            </h2>
            <p class="text-gray-400 mb-6">
              å„å¦ãŒæŒã¤ã€Œå¤‰åŒ–ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼çŠ¶æ…‹ã€ã‚’å¯è¦–åŒ–ã—ã¾ã™ã€‚ã‚¹ã‚³ã‚¢ãŒé«˜ã„ã»ã©æŒ‘æˆ¦çš„ã§é£›èºã®å¯èƒ½æ€§ã‚’ã€ä½ã„ã»ã©å®‰å®šã—ç‰©äº‹ã‚’å›ºã‚ã‚‹å¥½æ©Ÿã‚’ç¤ºã—ã¾ã™ã€‚ãƒãƒ¼ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨è©³ç´°åˆ†æã‚’è¡¨ç¤ºã—ã¾ã™ã€‚
            </p>
            <div class="my-4 flex items-center gap-4">
              <label for="sortOrder" class="mr-2 text-gray-400">ä¸¦ã³é †:</label>
              <select
                id="sortOrder"
                class="bg-gray-700 border border-gray-600 rounded-lg text-white focus:outline-none focus:ring-2 focus:ring-indigo-500 p-2"
              >
                <option value="potential_desc">ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒé«˜ã„é †</option>
                <option value="potential_asc">ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒä½ã„é †</option>
                <option value="id_asc" selected>å¦ã®ç•ªå·é †</option>
              </select>
            </div>
            <div id="radar-chart" class="space-y-2 mt-6"></div>
          </div>

          <div id="structure-analyzer" class="hidden">
            <button
              id="backToRadarBtn"
              class="mb-6 text-indigo-400 hover:text-indigo-300"
            >
              â† ãƒ¬ãƒ¼ãƒ€ãƒ¼ã«æˆ»ã‚‹
            </button>
            <div
              id="analyzer-header"
              class="text-center mb-8 flex items-center justify-between"
            >
              <button
                id="prev-hex-btn"
                class="p-2 rounded-full hover:bg-gray-700"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M15 19l-7-7 7-7"
                  />
                </svg>
              </button>
              <div id="analyzer-title-container" class="px-4"></div>
              <button
                id="next-hex-btn"
                class="p-2 rounded-full hover:bg-gray-700"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  class="h-6 w-6"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke="currentColor"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M9 5l7 7-7 7"
                  />
                </svg>
              </button>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
              <div
                id="analyzer-chart-container"
                class="w-full h-96 bg-gray-900/50 rounded-lg p-4"
              >
                <canvas id="analyzer-chart"></canvas>
              </div>
              <div
                id="analyzer-text"
                class="h-96 overflow-y-auto bg-gray-900/50 rounded-lg p-6 space-y-4"
              ></div>
            </div>

            <div class="mt-8 space-y-8">
              <div
                id="additional-info-container"
                class="bg-gray-900/50 rounded-lg p-6 border border-gray-700"
              >
                <h3
                  class="text-xl font-bold text-gray-100 mb-6 border-b border-gray-700 pb-3"
                >
                  å¦ã®æ§‹é€ åˆ†æ
                </h3>
                <div
                  class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-x-6 gap-y-8"
                >
                  <div id="basic-char-container">
                    <h4 class="font-bold text-lg text-indigo-300">
                      åŸºæœ¬çš„ãªç‰¹å¾´
                    </h4>
                    <p id="basic-description" class="mt-2 text-gray-300"></p>
                    <p class="mt-2 text-sm">
                      <strong class="text-gray-400">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:</strong>
                      <span id="basic-keywords"></span>
                    </p>
                  </div>
                  <div id="goka-container">
                    <h4 class="font-bold text-lg text-indigo-300">
                      äº’å¦ (ã”ã‹)
                    </h4>
                    <p class="text-sm text-gray-500">å†…ãªã‚‹æœ¬è³ª</p>
                    <a
                      id="goka-link"
                      class="mt-1 text-gray-200 text-lg font-semibold clickable-hex"
                    ></a>
                    <p
                      id="goka-description"
                      class="mt-2 text-sm text-gray-400"
                    ></p>
                  </div>
                  <div id="sakka-container">
                    <h4 class="font-bold text-lg text-indigo-300">
                      éŒ¯å¦ (ã•ã£ã‹)
                    </h4>
                    <p class="text-sm text-gray-500">é€†ã®è¦–ç‚¹</p>
                    <a
                      id="sakka-link"
                      class="mt-1 text-gray-200 text-lg font-semibold clickable-hex"
                    ></a>
                    <p
                      id="sakka-description"
                      class="mt-2 text-sm text-gray-400"
                    ></p>
                  </div>
                  <div id="souka-container">
                    <h4 class="font-bold text-lg text-indigo-300">
                      ç¶œå¦ (ãã†ã‹)
                    </h4>
                    <p class="text-sm text-gray-500">è£ã‹ã‚‰ã®è¦–ç‚¹</p>
                    <a
                      id="souka-link"
                      class="mt-1 text-gray-200 text-lg font-semibold clickable-hex"
                    ></a>
                    <p
                      id="souka-description"
                      class="mt-2 text-sm text-gray-400"
                    ></p>
                  </div>
                </div>
              </div>

              <div
                id="modern-interpretation-container"
                class="bg-gray-900/50 rounded-lg p-6 border border-gray-700"
              >
                <h3
                  class="text-xl font-bold text-gray-100 mb-6 border-b border-gray-700 pb-3"
                >
                  ç¾ä»£çš„ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                  <div>
                    <h4 class="font-bold text-lg text-indigo-300">
                      ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼ˆåŸå‹ï¼‰
                    </h4>
                    <p id="archetype" class="mt-1 text-gray-300"></p>
                  </div>
                  <div>
                    <h4 class="font-bold text-lg text-indigo-300">
                      ç¾ä»£è§£é‡ˆã®è¦ç´„
                    </h4>
                    <p id="summary-modern" class="mt-1 text-gray-300"></p>
                  </div>
                  <div class="md:col-span-2">
                    <h4 class="font-bold text-lg text-indigo-300">
                      å‡ºãŸæ™‚ã®æ°—æŒã¡
                    </h4>
                    <p id="feeling" class="mt-1 text-gray-300"></p>
                  </div>
                  <div class="md:col-span-2">
                    <h4 class="font-bold text-lg text-indigo-300">
                      ã©ã†ã™ã‚Œã°ã„ã„ï¼Ÿï¼ˆè¡Œå‹•æŒ‡é‡ï¼‰
                    </h4>
                    <p id="action-guideline" class="mt-1 text-gray-300"></p>
                  </div>
                  <div class="md:col-span-2">
                    <h4 class="font-bold text-lg text-indigo-300">
                      ç›¸è«‡ã™ã¹ãäºº
                    </h4>
                    <p id="consultant" class="mt-1 text-gray-300"></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

        <section
          id="tuan-content"
          class="content-section card p-6 sm:p-8 space-y-6"
        >
          <h2 class="section-title text-3xl font-bold">
            å½–ä¼
            <span class="text-base text-gray-400 ml-2"
              >- å¦å…¨ä½“ã®ãƒ†ãƒ¼ãƒè§£èª¬</span
            >
          </h2>
          <input
            type="text"
            id="tuan-search"
            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..."
          />
          <div id="tuan-list" class="space-y-8"></div>
        </section>

        <section
          id="sho-content"
          class="content-section card p-6 sm:p-8 space-y-6"
        >
          <h2 class="section-title text-3xl font-bold">
            å°è±¡ä¼
            <span class="text-base text-gray-400 ml-2">- å„çˆ»ã®è¡Œå‹•ç†ç”±</span>
          </h2>
          <input
            type="text"
            id="sho-search"
            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..."
          />
          <div id="sho-list" class="space-y-4"></div>
        </section>

        <section
          id="zatsu-content"
          class="content-section card p-6 sm:p-8 space-y-6"
        >
          <h2 class="section-title text-3xl font-bold">
            é›‘å¦ä¼
            <span class="text-base text-gray-400 ml-2"
              >- äºŒå…ƒè«–ã«ã‚ˆã‚‹æœ¬è³ªè§£èª¬</span
            >
          </h2>
          <input
            type="text"
            id="zatsu-search"
            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..."
          />
          <div
            id="zatsu-list"
            class="grid grid-cols-1 md:grid-cols-2 gap-6"
          ></div>
        </section>

        <section
          id="jo-content"
          class="content-section card p-6 sm:p-8 space-y-6"
        >
          <h2 class="section-title text-3xl font-bold">
            åºå¦ä¼
            <span class="text-base text-gray-400 ml-2">- 64å¦ã®ç‰©èª</span>
          </h2>
          <p class="text-gray-400">
            64å¦ãŒãªãœã“ã®é †ç•ªã§ä¸¦ã‚“ã§ã„ã‚‹ã®ã‹ã€ãã®å£®å¤§ãªç‰©èªã®æµã‚Œã‚’ç¤ºã—ã¾ã™ã€‚å„é …ç›®ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€ãã®å¦ã®è§£èª¬ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
          </p>
          <input
            type="text"
            id="jo-search"
            class="w-full p-3 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
            placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢..."
          />
          <div id="jo-list" class="timeline"></div>
        </section>
      </main>
    </div>

    <div
      id="modalContainer"
      class="fixed inset-0 z-50 flex items-center justify-center p-4 hidden"
    >
      <div
        id="modalOverlay"
        class="absolute inset-0 bg-black/70 modal-overlay opacity-0"
      ></div>
      <div
        id="modalContent"
        class="modal-content bg-gray-800 rounded-2xl shadow-2xl w-full max-w-3xl max-h-[85vh] overflow-y-auto p-8 relative transform scale-95"
      >
        <button
          id="modalCloseBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-white"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-6 w-6"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
        <div id="modalBody"></div>
      </div>
    </div>

    <script src="assets/haqei_main_database.js"></script>
    <script>
      window.onload = () => {
        if (
          typeof HAQEI_DATA === "undefined" ||
          typeof haqei_potential_scores === "undefined" ||
          typeof haqeiMainDatabase === "undefined"
        ) {
          document.getElementById("content-area").innerHTML =
            '<p class="text-red-400 p-4 text-center">ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹(HAQEI_DATA, haqei_potential_scores, haqeiMainDatabase)ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚</p>';
          return;
        }
        const HDB = HAQEI_DATA;
        const SCORES = haqei_potential_scores;
        const MAIN_DB = haqeiMainDatabase;

        const tabs = document.querySelectorAll(".tab-btn");
        const contents = document.querySelectorAll(".content-section");
        const sortOrderSelect = document.getElementById("sortOrder");
        const radarContainer = document.getElementById("radar-container");
        const structureAnalyzer = document.getElementById("structure-analyzer");
        const helpIcon = document.getElementById("help-icon");
        let lineChartInstance = null;

        const hexStartIndices = (() => {
          const indices = [0];
          let currentIndex = 1;
          for (let i = 1; i <= 64; i++) {
            indices.push(currentIndex);
            currentIndex += i === 1 || i === 2 ? 7 : 6;
          }
          return indices;
        })();

        const hexagramScores = HDB.hexagrams_master.map((hex) => {
          if (!hex || typeof hex.hexagram_id === "undefined")
            return { id: 0, name: "ä¸æ˜", score: null };
          const startNum = hexStartIndices[hex.hexagram_id];
          if (typeof startNum === "undefined" || SCORES.length <= startNum)
            return {
              id: hex.hexagram_id,
              name: hex.name_jp,
              keywords: hex.keywords,
              score: null,
            };
          const lineScores = SCORES.slice(startNum, startNum + 6).filter(
            (s) => typeof s === "number"
          );
          if (lineScores.length < 6)
            return {
              id: hex.hexagram_id,
              name: hex.name_jp,
              keywords: hex.keywords,
              score: null,
            };
          const average =
            lineScores.reduce((a, b) => a + b, 0) / lineScores.length;
          return {
            id: hex.hexagram_id,
            name: hex.name_jp,
            keywords: hex.keywords,
            score: parseFloat(average.toFixed(2)),
          };
        });

        const escapeHTML = (str) =>
          str
            ? str.toString().replace(
                /[&<>"']/g,
                (match) =>
                  ({
                    "&": "&amp;",
                    "<": "&lt;",
                    ">": "&gt;",
                    '"': "&quot;",
                    "'": "&#39;",
                  }[match])
              )
            : "";
        const nl2br = (str) =>
          str ? escapeHTML(str).replace(/\n/g, "<br>") : "";
        const helpContentHtml = `<div class="space-y-4 text-gray-300"><p>ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚³ã‚¢ã¯ã€ãã®çŠ¶æ³ãŒæŒã¤ã€Œå¤‰åŒ–ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼çŠ¶æ…‹ã€ã‚’ç¤ºã™å®¢è¦³çš„ãªæŒ‡æ¨™ã§ã™ã€‚ã‚¹ã‚³ã‚¢ã‚’å¤©æ°—ã®ã‚ˆã†ã«æ‰ãˆã‚‹ã¨ã€æˆ¦ç•¥ãŒç«‹ã¦ã‚„ã™ããªã‚Šã¾ã™ã€‚</p><div class="p-4 bg-gray-900 rounded-lg"><h4 class="font-bold text-lg text-indigo-300">ã‚¹ã‚³ã‚¢ãŒä½ã„æ™‚ (1-2)ï¼šæ™´ã‚Œã®æ—¥ â˜€ï¸</h4><p class="mt-1">çŠ¶æ³ã¯å®‰å®šã—ã¦ãŠã‚Šã€å¤‰åŒ–ã®ä¸»å°æ¨©ã¯ã‚ãªãŸã«ã‚ã‚Šã¾ã™ã€‚ã“ã®å®‰å®šã‚’æ´»ã‹ã—ã¦â€¦</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong class="text-white">ç¾çŠ¶ã‚’ç¶­æŒã—ã€åŠ›ã‚’è“„ãˆã‚‹ã€‚</strong></li><li><strong class="text-white">å®‰å…¨åœ°å¸¯ã‹ã‚‰ã€æ–°ã—ã„æŒ‘æˆ¦ã‚’å§‹ã‚ã‚‹ã€‚</strong></li></ul></div><div class="p-4 bg-gray-900 rounded-lg"><h4 class="font-bold text-lg text-yellow-300">ã‚¹ã‚³ã‚¢ãŒä¸­é–“ã®æ™‚ (3)ï¼šæ›‡ã‚Šã®ã¡æ™´ã‚Œ/é›¨ ğŸŒ¥ï¸</h4><p class="mt-1">å®‰å®šã¨ä¸å®‰å®šã®å¢ƒç›®ã§ã‚ã‚Šã€ã‚ãªãŸã®è¡Œå‹•ã‚„é¸æŠãŒæœªæ¥ã‚’å·¦å³ã™ã‚‹ã€Œå²è·¯ã€ã§ã™ã€‚ã“ã®ä¸­ç«‹çš„ãªçŠ¶æ…‹ã‚’æ´»ã‹ã—ã¦â€¦</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong class="text-white">èƒ½å‹•çš„ã«ä»•æ›ã‘ã€æœ›ã‚€æœªæ¥ã¸çŠ¶æ³ã‚’å‚¾ã‘ã‚‹ã€‚</strong></li><li><strong class="text-white">åµã«å‚™ãˆã¦å®ˆã‚Šã‚’å›ºã‚ã‚‹ã€ã‚ã‚‹ã„ã¯å¥½æ©Ÿã‚’å¾…ã¤ã€‚</strong></li></ul></div><div class="p-4 bg-gray-900 rounded-lg"><h4 class="font-bold text-lg text-red-300">ã‚¹ã‚³ã‚¢ãŒé«˜ã„æ™‚ (4-5)ï¼šåµã®æ—¥ âš¡ï¸</h4><p class="mt-1">çŠ¶æ³ã¯æµå‹•çš„ã§ã€å¤–éƒ¨ã‹ã‚‰ã®å¤‰åŒ–ã¸ã®å¯¾å¿œã‚’è¿«ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚ã“ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’åˆ©ç”¨ã—ã¦â€¦</p><ul class="list-disc list-inside mt-2 space-y-1"><li><strong class="text-white">å¤‰åŒ–ã®æ³¢ã«ä¹—ã‚Šã€é£›èºã‚’ç‹™ã†ã€‚</strong></li><li><strong class="text-white">é˜²å¾¡ã«å¾¹ã—ã€è¢«å®³ã‚’æœ€å°é™ã«æŠ‘ãˆã‚‹ã€‚</strong></li></ul></div><p class="pt-2">ã“ã®ã‚¹ã‚³ã‚¢ã§<strong class="text-white">ã€Œä»Šã®ã‚²ãƒ¼ãƒ ã®ãƒ«ãƒ¼ãƒ«ã€</strong>ã‚’å®¢è¦³çš„ã«ç†è§£ã—ã€ã‚ãªãŸè‡ªèº«ã®æ„å¿—ã§<strong class="text-white">ã€Œã©ã†ãƒ—ãƒ¬ã‚¤ã™ã‚‹ã‹ã€</strong>ã‚’æ±ºã‚ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚</p></div>`;

        const trigramToLines = {
          1: [1, 1, 1],
          2: [0, 1, 1],
          3: [1, 0, 1],
          4: [0, 0, 1],
          5: [1, 1, 0],
          6: [0, 1, 0],
          7: [1, 0, 0],
          8: [0, 0, 0],
        };
        const linesToTrigram = Object.fromEntries(
          Object.entries(trigramToLines).map(([k, v]) => [
            v.join(""),
            parseInt(k),
          ])
        );
        const oppositeTrigram = {
          1: 8,
          2: 7,
          3: 6,
          4: 5,
          5: 4,
          6: 3,
          7: 2,
          8: 1,
        };

        const getLines = (hex) => {
          if (
            !hex ||
            !trigramToLines[hex.upper_trigram_id] ||
            !trigramToLines[hex.lower_trigram_id]
          )
            return null;
          return [
            ...trigramToLines[hex.upper_trigram_id],
            ...trigramToLines[hex.lower_trigram_id],
          ];
        };

        const findGoka = (hex) => {
          const allLines = getLines(hex);
          if (!allLines) return null;
          const newLowerLines = [allLines[2], allLines[3], allLines[4]].join(
            ""
          );
          const newUpperLines = [allLines[1], allLines[2], allLines[3]].join(
            ""
          );
          const newLowerId = linesToTrigram[newLowerLines];
          const newUpperId = linesToTrigram[newUpperLines];
          return HDB.hexagrams_master.find(
            (h) =>
              h.upper_trigram_id === newUpperId &&
              h.lower_trigram_id === newLowerId
          );
        };

        const findSakka = (hex) => {
          if (!hex) return null;
          const newUpperId = oppositeTrigram[hex.upper_trigram_id];
          const newLowerId = oppositeTrigram[hex.lower_trigram_id];
          return HDB.hexagrams_master.find(
            (h) =>
              h.upper_trigram_id === newUpperId &&
              h.lower_trigram_id === newLowerId
          );
        };

        const findSouka = (hex) => {
          if (!hex) return null;
          return HDB.hexagrams_master.find(
            (h) =>
              h.upper_trigram_id === hex.lower_trigram_id &&
              h.lower_trigram_id === hex.upper_trigram_id
          );
        };

        const findHenko = (hex, lineIndex) => {
          const allLines = getLines(hex);
          if (!allLines) return null;
          const changedLines = [...allLines];
          changedLines[5 - lineIndex] = 1 - changedLines[5 - lineIndex];
          const newUpperLines = changedLines.slice(0, 3).join("");
          const newLowerLines = changedLines.slice(3, 6).join("");
          const newUpperId = linesToTrigram[newUpperLines];
          const newLowerId = linesToTrigram[newLowerLines];
          return HDB.hexagrams_master.find(
            (h) =>
              h.upper_trigram_id === newUpperId &&
              h.lower_trigram_id === newLowerId
          );
        };

        function showModal(title, content) {
          document.getElementById(
            "modalBody"
          ).innerHTML = `<h3 class="text-2xl font-bold text-indigo-300 mb-4">${title}</h3><div class="prose prose-invert max-w-none">${content}</div>`;
          document.getElementById("modalContainer").classList.remove("hidden");
        }
        function hideModal() {
          document.getElementById("modalContainer").classList.add("hidden");
        }

        function renderRadarChart() {
          const sortedHexagrams = [...hexagramScores].sort((a, b) => {
            const scoreA = a && typeof a.score === "number" ? a.score : -1;
            const scoreB = b && typeof b.score === "number" ? b.score : -1;
            switch (sortOrderSelect.value) {
              case "potential_asc":
                return scoreA - scoreB;
              case "id_asc":
                return (a ? a.id : 0) - (b ? b.id : 0);
              default:
                return scoreB - scoreA;
            }
          });
          const chartContainer = document.getElementById("radar-chart");
          chartContainer.innerHTML = sortedHexagrams
            .map((hex) => {
              if (!hex || hex.score === null) {
                return `<div class="flex items-center group p-1 rounded-md" data-hex-id="${
                  hex ? hex.id : ""
                }"><div class="w-28 sm:w-32 text-sm truncate pr-2 text-right text-gray-500">${
                  hex ? hex.id : ""
                }. ${
                  hex ? escapeHTML(hex.name) : "ãƒ‡ãƒ¼ã‚¿ã‚¨ãƒ©ãƒ¼"
                }</div><div class="flex-1 text-gray-500">ã‚¹ã‚³ã‚¢è¨ˆç®—ä¸èƒ½</div></div>`;
              }
              const scorePercentage = (hex.score / 5) * 100;
              const color = `hsl(${240 - (hex.score - 1) * 60}, 70%, 60%)`;
              return `<div class="flex items-center group cursor-pointer p-1 rounded-md hover:bg-gray-700" data-hex-id="${
                hex.id
              }"><div class="w-28 sm:w-32 text-sm truncate pr-2 text-right text-gray-200">${
                hex.id
              }. ${escapeHTML(
                hex.name
              )}</div><div class="flex-1 bg-gray-600 rounded-full h-6 p-0.5"><div class="h-full rounded-full transition-all duration-300" style="width: ${scorePercentage}%; background-color: ${color};"></div></div><div class="w-12 text-left pl-3 font-bold text-base text-gray-200">${hex.score.toFixed(
                2
              )}</div></div>`;
            })
            .join("");
          chartContainer
            .querySelectorAll(".group[data-hex-id]")
            .forEach((el) => {
              const hexScore = hexagramScores.find(
                (h) => h && h.id == el.dataset.hexId
              );
              if (hexScore && hexScore.score !== null) {
                el.addEventListener("click", () =>
                  showStructureAnalyzer(parseInt(el.dataset.hexId, 10))
                );
              }
            });
        }

        // --- â–¼â–¼â–¼ å¾ªç’°ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè£… â–¼â–¼â–¼ ---
        function showStructureAnalyzer(hexId) {
          radarContainer.classList.add("hidden");
          structureAnalyzer.classList.remove("hidden");

          const setupNavButton = (id, currentHexId, direction) => {
            let newHexId = currentHexId + direction;
            if (newHexId < 1) newHexId = 64;
            if (newHexId > 64) newHexId = 1;

            const btn = document.getElementById(id);
            // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’æ¯å›ãƒªã‚»ãƒƒãƒˆã—ã¦å†è¨­å®š
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener("click", () =>
              showStructureAnalyzer(newHexId)
            );
          };

          setupNavButton("prev-hex-btn", hexId, -1);
          setupNavButton("next-hex-btn", hexId, 1);

          const hexData = HDB.hexagrams_master.find(
            (h) => h.hexagram_id === hexId
          );
          const tuanData = HDB.bible.tuan_den[hexId];
          if (!hexData || !tuanData) {
            document.getElementById(
              "analyzer-title-container"
            ).innerHTML = `<h3 class="text-3xl font-bold text-red-400">ã‚¨ãƒ©ãƒ¼</h3>`;
            document.getElementById(
              "analyzer-text"
            ).innerHTML = `<p>å¦(ID: ${hexId})ã®åŸºæœ¬ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
            if (lineChartInstance) {
              lineChartInstance.destroy();
              lineChartInstance = null;
            }
            return;
          }
          document.getElementById(
            "analyzer-title-container"
          ).innerHTML = `<h3 class="text-3xl lg:text-4xl font-bold text-gray-100 mincho-font">${
            hexData.hexagram_id
          }. ${escapeHTML(
            tuanData.title
          )}</h3><p class="text-indigo-300 font-semibold mt-2">${escapeHTML(
            tuanData.summary
          )}</p>`;
          document.getElementById("basic-description").textContent =
            hexData.description;
          document.getElementById("basic-keywords").textContent =
            hexData.keywords;

          const setupRelatedHexLink = (linkId, relatedHex) => {
            const linkEl = document.getElementById(linkId);
            if (relatedHex) {
              linkEl.textContent = `${relatedHex.hexagram_id}. ${escapeHTML(
                relatedHex.name_jp
              )}`;
              const newLinkEl = linkEl.cloneNode(true);
              linkEl.parentNode.replaceChild(newLinkEl, linkEl);
              newLinkEl.addEventListener("click", () =>
                showStructureAnalyzer(relatedHex.hexagram_id)
              );
            } else {
              linkEl.textContent = "ãªã—";
            }
          };

          setupRelatedHexLink("goka-link", findGoka(hexData));
          setupRelatedHexLink("sakka-link", findSakka(hexData));
          setupRelatedHexLink("souka-link", findSouka(hexData));

          const mainData = MAIN_DB.find((d) => d.å¦ç•ªå· === hexId);
          const modernContainer = document.getElementById(
            "modern-interpretation-container"
          );

          if (mainData) {
            document.getElementById("goka-description").textContent =
              mainData["äº’å¦ã¨ã®é–¢ä¿‚æ€§"] || "";
            document.getElementById("sakka-description").textContent =
              mainData["éŒ¯å¦ã¨ã®é–¢ä¿‚æ€§ï¼ˆå¯¾æ¥µã®ä¸–ç•Œï¼‰"] || "";
            document.getElementById("souka-description").textContent =
              mainData["ç¶œå¦ã¨ã®é–¢ä¿‚æ€§ï¼ˆè£ã®è¦–ç‚¹ï¼‰"] || "";
            if (modernContainer) {
              modernContainer.style.display = "block";
              document.getElementById("archetype").textContent =
                mainData["ã‚¢ãƒ¼ã‚­ã‚¿ã‚¤ãƒ—ï¼ˆåŸå‹ï¼‰"] || "---";
              document.getElementById("summary-modern").textContent =
                mainData["ç¾ä»£è§£é‡ˆã®è¦ç´„"] || "---";
              document.getElementById("feeling").textContent =
                mainData["å‡ºãŸæ™‚ã®æ°—æŒã¡"] || "---";
              document.getElementById("action-guideline").textContent =
                mainData["ã©ã†ã™ã‚Œã°ã„ã„"] || "---";
              document.getElementById("consultant").textContent =
                mainData["ç›¸è«‡ã™ã¹ãäºº"] || "---";
            }
          } else {
            document.getElementById("goka-description").textContent = "";
            document.getElementById("sakka-description").textContent = "";
            document.getElementById("souka-description").textContent = "";
            if (modernContainer) {
              modernContainer.style.display = "none";
            }
          }

          const isSpecialHex = hexId === 1 || hexId === 2;
          const numLines = isSpecialHex ? 7 : 6;
          const labels = ["åˆçˆ»", "äºŒçˆ»", "ä¸‰çˆ»", "å››çˆ»", "äº”çˆ»", "ä¸Šçˆ»"];
          if (isSpecialHex) labels.push(hexId === 1 ? "ç”¨ä¹" : "ç”¨å…­");
          const startNum = hexStartIndices[hexId];
          const lineScores = Array.from(
            { length: numLines },
            (_, i) => SCORES[startNum + i]
          );
          const setActiveLine = (index) => {
            lineChartInstance.data.datasets[0].pointBackgroundColor = Array(
              numLines
            )
              .fill("#fff")
              .map((c, i) => (i === index ? "#facc15" : c));
            lineChartInstance.data.datasets[0].pointRadius = Array(numLines)
              .fill(5)
              .map((r, i) => (i === index ? 10 : r));
            lineChartInstance.update("none");
            updateAnalyzerText(hexData, index);
          };
          const ctx = document
            .getElementById("analyzer-chart")
            .getContext("2d");
          if (lineChartInstance) lineChartInstance.destroy();
          lineChartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels,
              datasets: [
                {
                  data: lineScores,
                  borderColor: "#a5b4fc",
                  pointBorderColor: "#a5b4fc",
                  tension: 0.1,
                  fill: true,
                  backgroundColor: "rgba(129, 140, 248, 0.2)",
                },
              ],
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                y: {
                  min: 0.5,
                  max: 5.5,
                  ticks: { stepSize: 1, color: "#9ca3af" },
                  grid: { color: "#374151" },
                },
                x: {
                  ticks: { color: "#9ca3af" },
                  grid: { color: "#374151" },
                },
              },
              plugins: {
                legend: { display: false },
                tooltip: { enabled: false },
              },
              onHover: (e, el) =>
                (e.native.target.style.cursor = el.length
                  ? "pointer"
                  : "default"),
              onClick: (e, el) => el.length > 0 && setActiveLine(el[0].index),
            },
          });
          setActiveLine(0);
        }

        function updateAnalyzerText(currentHex, lineIndex) {
          const textContainer = document.getElementById("analyzer-text");
          const startNum = hexStartIndices[currentHex.hexagram_id];
          const lineNum = startNum + lineIndex;
          const shoData = HDB.bible.sho_den[lineNum];
          const h384Data = HDB["384"].find((h) => h.é€šã—ç•ªå· === lineNum);
          const score = SCORES[lineNum];
          const scoreLevels = {
            1: "å¹³ç©",
            2: "é †é¢¨",
            3: "å²è·¯",
            4: "é€†é¢¨",
            5: "åµ",
          };

          let henkoHtml = "";
          const mainData = MAIN_DB.find(
            (d) => d.å¦ç•ªå· === currentHex.hexagram_id
          );

          if (lineIndex < 6) {
            const henkoHex = findHenko(currentHex, lineIndex);
            if (henkoHex) {
              const henkoLinkHtml = `<a class="font-bold text-lg text-green-300 clickable-hex" data-hex-id="${
                henkoHex.hexagram_id
              }">${henkoHex.hexagram_id}. ${escapeHTML(
                henkoHex.name_jp
              )}</a><p class="text-sm text-gray-400">ã«å¤‰ã‚ã‚Šã¾ã™ã€‚ï¼ˆä¹‹å¦ï¼‰</p>`;

              const lineNames = ["åˆ", "äºŒ", "ä¸‰", "å››", "äº”", "ä¸Š"];
              const relationKey = `${lineNames[lineIndex]}çˆ»å¤‰ã¨ã®é–¢ä¿‚æ€§`;
              let relationText = "";
              if (mainData && mainData[relationKey]) {
                relationText = `<div class="mt-2 text-sm text-gray-300">${nl2br(
                  mainData[relationKey]
                )}</div>`;
              }

              henkoHtml = `<div class="mt-4 pt-4 border-t border-gray-700"><p class="text-sm text-gray-400">ã“ã®çˆ»ãŒå¤‰åŒ–ã™ã‚‹ã¨...</p>${henkoLinkHtml}${relationText}</div>`;
            }
          } else if (lineIndex === 6) {
            let relationKey = "";
            if (currentHex.hexagram_id === 1) relationKey = "ç”¨ä¹å¤‰ã¨ã®é–¢ä¿‚æ€§";
            if (currentHex.hexagram_id === 2) relationKey = "ç”¨å…­å¤‰ã¨ã®é–¢ä¿‚æ€§";

            let relationText = "";
            if (mainData && mainData[relationKey]) {
              relationText = `<div class="mt-2 text-sm text-gray-300">${nl2br(
                mainData[relationKey]
              )}</div>`;
            }
            if (relationText) {
              henkoHtml = `<div class="mt-4 pt-4 border-t border-gray-700">${relationText}</div>`;
            }
          }

          if (shoData && h384Data && typeof score !== "undefined") {
            textContainer.innerHTML = `<h4 class="text-xl font-bold text-indigo-300 mb-2">${escapeHTML(
              h384Data.çˆ»å
            )}ï¼š${escapeHTML(
              shoData.title
            )}</h4><p class="mb-4 font-semibold text-gray-200">ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚³ã‚¢: ${score} <span class="text-gray-400">- ${
              scoreLevels[score] || "ç‰¹åˆ¥"
            } -</span></p><div><strong class="text-gray-200">ã€æ¨å¥¨ã•ã‚Œã‚‹è¡Œå‹•ç†ç”±ã€‘</strong><br>${nl2br(
              shoData.reason
            )}</div>${henkoHtml}`;

            const henkoLink = textContainer.querySelector(".clickable-hex");
            if (henkoLink) {
              henkoLink.addEventListener("click", (e) => {
                const hexId = parseInt(e.target.dataset.hexId, 10);
                showStructureAnalyzer(hexId);
              });
            }
          } else {
            textContainer.innerHTML = `<p class="text-gray-400">ã“ã®çˆ»ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ï¼ˆé€šã—ç•ªå·: ${lineNum}ï¼‰</p>`;
          }
        }

        function renderJuyokuContent() {
          const tuanContainer = document.getElementById("tuan-list");
          tuanContainer.innerHTML = HDB.hexagrams_master
            .map((hex) => {
              const tuan = HDB.bible.tuan_den[hex.hexagram_id];
              if (!tuan) return "";
              const searchText = `${hex.hexagram_id} ${hex.name_jp} ${tuan.title} ${tuan.summary} ${tuan.haqei_interpretation} ${hex.keywords}`;
              return `<div class="filterable-item py-6 border-b border-gray-700" data-search-text="${searchText.toLowerCase()}"><h3 class="text-2xl font-bold text-gray-100 mb-2 mincho-font">${
                hex.hexagram_id
              }. ${escapeHTML(
                tuan.title
              )}</h3><p class="text-indigo-300 font-semibold mb-3">${escapeHTML(
                tuan.summary
              )}</p><div class="pl-4 border-l-2 border-gray-600 space-y-4"><p class="text-gray-300 italic">"${nl2br(
                tuan.points.join('"<br>"')
              )}"</p><p class="text-gray-400">${nl2br(
                tuan.haqei_interpretation
              )}</p></div></div>`;
            })
            .join("");
        }

        function filterContent(tabName, query) {
          const normalizedQuery = query.toLowerCase().trim();
          document
            .querySelectorAll(`#${tabName}-content .filterable-item`)
            .forEach((item) => {
              item.style.display = (item.dataset.searchText || "")
                .toLowerCase()
                .includes(normalizedQuery)
                ? ""
                : "none";
            });
        }
        function switchTab(tabName) {
          tabs.forEach((tab) =>
            tab.classList.toggle("active", tab.dataset.tab === tabName)
          );
          contents.forEach((content) =>
            content.classList.toggle(
              "active",
              content.id === `${tabName}-content`
            )
          );
        }

        (function main() {
          renderRadarChart();
          renderJuyokuContent(); // ä»–ã®ã‚¿ãƒ–ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚‚æœ€åˆã«ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã—ã¦ãŠã
          document
            .getElementById("modalOverlay")
            .addEventListener("click", hideModal);
          document
            .getElementById("modalCloseBtn")
            .addEventListener("click", hideModal);
          document
            .getElementById("backToRadarBtn")
            .addEventListener("click", () => {
              structureAnalyzer.classList.add("hidden");
              radarContainer.classList.remove("hidden");
            });
          sortOrderSelect.addEventListener("change", renderRadarChart);
          helpIcon.addEventListener("click", () =>
            showModal("ã€Œãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚¹ã‚³ã‚¢ã€ã®è¦‹æ–¹", helpContentHtml)
          );
          tabs.forEach((tab) =>
            tab.addEventListener("click", () => switchTab(tab.dataset.tab))
          );
          const searchInputs = {
            tuan: document.getElementById("tuan-search"),
            sho: document.getElementById("sho-search"),
            zatsu: document.getElementById("zatsu-search"),
            jo: document.getElementById("jo-search"),
          };
          Object.keys(searchInputs).forEach(
            (key) =>
              searchInputs[key] &&
              searchInputs[key].addEventListener(
                "input",
                (
                  e // keyupã‹ã‚‰inputã¸å¤‰æ›´
                ) => filterContent(key, e.target.value)
              )
          );
          switchTab("analyzer");
        })();
      };
    </script>
  </body>
</html>
